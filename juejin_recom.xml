<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[AI（原生）产品中如何平衡自然语言交互与GUI交互？（第二讲）]]></title>    <link>https://juejin.cn/post/7595873251164602409</link>    <guid>https://juejin.cn/post/7595873251164602409</guid>    <pubDate>2026-01-17T01:30:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595873251164602409" data-draft-id="7595873251164569641" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI（原生）产品中如何平衡自然语言交互与GUI交互？（第二讲）"/> <meta itemprop="keywords" content="人工智能,AIGC,产品经理"/> <meta itemprop="datePublished" content="2026-01-17T01:30:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序新视界"/> <meta itemprop="url" content="https://juejin.cn/user/3368559359568696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI（原生）产品中如何平衡自然语言交互与GUI交互？（第二讲）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3368559359568696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序新视界
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T01:30:21.000Z" title="Sat Jan 17 2026 01:30:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在写完《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FiU3eah_m5PCsojgyCwCOVQ" target="_blank" title="https://mp.weixin.qq.com/s/iU3eah_m5PCsojgyCwCOVQ" ref="nofollow noopener noreferrer">“提供溢出的情绪价值”是AI产品极具可能性的方向</a>》这篇文章之后，感觉有必要针对“AI产品”从产品视角写一个系列。目的和初衷也很简单，那就是倒逼自己去发现、思考、梳理、探索和输出，同时，也希望能够与同行进行交流，为AI的发展留下一些声音和贡献。</p>
<p>今天这篇文章就暂且作为这个AI产品系列的第二讲，一起聊聊在AI（原生）产品设计当中涉及到的一个考量：如何平衡基于AI（LLM）的自然语言交互与基于图形用户界面（GUI）的交互的关系。</p>
<p>无论是AI原生的APP或者是由AI驱动的机器人硬件（准确来说是软硬件相结合），在进行产品设计时，我们都要有一个考量，那就是产品是基于纯自然语言交互产品，还是基于传统GUI进行交互，还是两者兼具？</p>
<p>这个问题看似简单，却极大的决定的产品发展的方向以及内置功能的技术实现。比如，市面上有这样一款机器人，它没有图形化界面输入输出，只有基于语音的输入和音频的输出，最多再配合一些机器人的表情和简单的肢体动作。</p>
<p>对于这类产品，输入和输出就限制了它的使用场景和功能，比如只能是对话，可以提供音频输出的知识，可以倾向于提供情绪价值的聊天，可以提供陪伴，可以提供其他设备的指令入口等。至于其他更复杂、更确定性的功能，是很难支持的。</p>
<p>再往上层走，就是像豆包、DeepSeek、腾讯元宝这类偏向于ChatBot的产品，往往都提供了多模态输入输出。在这类产品中，根据不同的场景和形态，是有不同的选择的。</p>
<p>以豆包为例，有几种常规的技术实现和产品方案：</p>
<ul>
<li>文字对文字的对话：这个实现最简单，通过用户输入的文字内容，封装一层Prompt，传输给模型，再将模型的内容以文本的形式输出。当然，这期间还会经过文本内容安全审查、RAG增强等等处理。</li>
<li>语音对文字：就是用户发语音，模型回复文字。这类功能是在前面的功能上添加了一层ASR（自动语言识别）的处理，其他的保持不变。</li>
<li>语音/文字对语音：这种交互形式是在对输出的内容做了一层TTS（文本转语音）的处理。</li>
<li>通话模式：基于ASR进行语音识别，基于RTC（实时通信）技术进行语音的采集和输出，基于TTS技术将模型返回的文本转换为语音。</li>
</ul>
<p>至于其他的延伸功能也都是基于上述技术进一步场景化组合而成。同样是对话，豆包之所以提供了多模态的交互，最核心的就是为了满足用户不同场景下的交互方式，做到最大的用户使用场景的覆盖。</p>
<p>像豆包提供的这一系列的交互形式，虽然只是针对一个简单的Chatbot的场景或其他同类的工具性产品，但这个设计的核心理念其实是可以延伸的其他产品的。</p>
<p>由于本人做的是教育类的AI产品，以教育中一个更复杂的场景来说，比如通过一堂AI课做到教、学、练等环节，这些环节穿插了AI老师的教学视频、AI老师的实时引导、学生与AI实时问答、以及基于学生的回答或AI老师的引导驱动等流程。类似这样的场景下，我们就需要权衡是基于自然语言交互为主，还是基于GUI交互为主的问题。</p>
<p>在真实实践中得出的一些基本的心得：</p>
<p>第一，对准确性要求没那么高，更倾向与“聊”和沟通的场景，使用自然语言交互。这样让用户感觉到更轻松，更方便，更自然，也不用受限于键盘的输入。特别是针对小学生，打字是比较困难的，针对老人的产品也是一样。</p>
<p>第二，针对驱动流程流转的关键环境，尽量采用GUI交互，让用户快速的点选，而不是通过说。一是因为用户很可能不知道说要什么指令，还有可能说了半天AI识别错了，还有语音识别错误，环境音干扰等干扰因素，这会导致原本非常简单明确的交互，变得让人“气恼”。当然，在这类交互流转中，也是可以配合模型的识别来驱动流程流转的，但要避免让用户感觉莫名其妙或者“不可控”，所以建议此场景尽量明确采用GUI交互。</p>
<p>第三，对于常规的点选、查看等类型操作，特别是在移动端设备，毫无疑问，通过GUI操作简单、直接方便、明确、高效。当然，也可以配合一些语音指令去打开或操作某些功能，但像教育场景，完全没必要。</p>
<p>第四，对于有明确操作，比如选择题、下一步、开启/结束等类型的操作，建议就是GUI操作。就拿做选择题为例，用户通过点击，可能只需要几百毫秒就可以完成，但如果通过自然语言沟通，很可能需要几秒，还有判断失败的风险，即增加成本，又损失用户体验。</p>
<p>其实，说了这么多，想表达的核心观点就是：不要为了AI而AI，不要为了单纯炫技而使用自然语言交互。在大多数情况，传统的点选、拖拽比“说”更快，更便捷，更稳定，更准确，更高效，性能更好。当然，针对特定的环境，“懒得动手”或“不方便动手”或“单纯就是在聊”，那么基于自然语言表达就再合适不过了。</p>
<p>有一条真理永远不变，那就是“适合的就是最好的”，在AI原生产品的交互设计中也同样适用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vuex 核心概念全解析：构建优雅的 Vue 应用状态管理]]></title>    <link>https://juejin.cn/post/7595841630676189235</link>    <guid>https://juejin.cn/post/7595841630676189235</guid>    <pubDate>2026-01-17T01:37:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595841630676189235" data-draft-id="7595847940620632114" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vuex 核心概念全解析：构建优雅的 Vue 应用状态管理"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-17T01:37:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vuex 核心概念全解析：构建优雅的 Vue 应用状态管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T01:37:31.000Z" title="Sat Jan 17 2026 01:37:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vuex 核心概念全解析：构建优雅的 Vue 应用状态管理</h2>
<p>你是否曾在 Vue 项目中遇到过这样的困扰：</p>
<ul>
<li>• 组件间数据传递像“击鼓传花”，层层 props 透传令人头疼</li>
<li>• 兄弟组件通信需要借助父组件做“中转站”</li>
<li>• 多个组件依赖同一份数据，一处修改处处需要同步</li>
</ul>
<p>今天我们就来聊聊 Vue 的官方状态管理库——Vuex，帮你彻底解决这些痛点！</p>
<h3 data-id="heading-1">一、为什么需要 Vuex？</h3>
<p>想象一下，如果每个组件都有自己的“小账本”，当应用复杂时，数据就像散落的珍珠，难以统一管理。Vuex 就是一个“中央账本”，把数据集中存储，让状态变化变得可预测、可追踪。</p>
<h3 data-id="heading-2">二、Vuex 五大核心概念详解</h3>
<h4 data-id="heading-3">1. <strong>State（状态）—— 数据仓库</strong></h4>
<p>State 是 Vuex 的“数据库”，存储所有需要共享的数据。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">store </span>= <span class="hljs-keyword">new</span> Vuex.<span class="hljs-title function_ invoke__">Store</span>({
<span class="hljs-attr">  state</span>: {
<span class="hljs-attr">    user</span>: {
<span class="hljs-attr">      name</span>: <span class="hljs-string">'小明'</span>,
<span class="hljs-attr">      age</span>: <span class="hljs-number">25</span>
    },
<span class="hljs-attr">    cart</span>: []
  }
})
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>• 响应式：State 变化，依赖它的组件自动更新</li>
<li>• 单一数据源：整个应用只有一个 store</li>
<li>• 在组件中使用：<code>this.$store.state.user</code></li>
</ul>
<h4 data-id="heading-4">2. <strong>Getters（计算属性）—— 数据的“加工厂”</strong></h4>
<p>Getters 就像 Vue 中的 computed，用于从 state 派生出新数据。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">getters</span>: {
  <span class="hljs-comment">// 获取购物车商品总数</span>
  <span class="hljs-attr">cartItemCount</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> state.<span class="hljs-property">cart</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">total, item</span>) =&gt;</span> total + item.<span class="hljs-property">quantity</span>, <span class="hljs-number">0</span>)
  },
  
  <span class="hljs-comment">// 获取折扣后的价格</span>
  <span class="hljs-attr">discountedPrice</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params">productId</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> product = state.<span class="hljs-property">products</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-property">id</span> === productId)
    <span class="hljs-keyword">return</span> product.<span class="hljs-property">price</span> * <span class="hljs-number">0.8</span>
  }
}
</code></pre>
<p><strong>使用场景：</strong></p>
<ul>
<li>• 数据过滤、格式化</li>
<li>• 复杂计算逻辑封装</li>
<li>• 组件中调用：<code>this.$store.getters.cartItemCount</code></li>
</ul>
<h4 data-id="heading-5">3. <strong>Mutations（变更）—— 唯一的状态修改者</strong></h4>
<p>Mutations 是修改 state 的<strong>唯一途径</strong>，每个 mutation 都有一个字符串类型的“事件类型”和一个回调函数。</p>
<pre><code class="hljs language-scss" lang="scss">mutations: {
  <span class="hljs-comment">// 添加商品到购物车</span>
  <span class="hljs-built_in">ADD_TO_CART</span>(state, product) {
    const existingItem = state<span class="hljs-selector-class">.cart</span><span class="hljs-selector-class">.find</span>(item =&gt; item.id === product.id)
    if (existingItem) {
      existingItem<span class="hljs-selector-class">.quantity</span>++
    } else {
      state<span class="hljs-selector-class">.cart</span><span class="hljs-selector-class">.push</span>({ ...product, quantity: <span class="hljs-number">1</span> })
    }
  },
  
  <span class="hljs-comment">// 清空购物车</span>
  <span class="hljs-built_in">CLEAR_CART</span>(state) {
    state<span class="hljs-selector-class">.cart</span> = <span class="hljs-selector-attr">[]</span>
  }
}
</code></pre>
<p><strong>重要原则：</strong></p>
<ul>
<li>• 必须是同步函数</li>
<li>• 通过 <code>store.commit('mutation名', payload)</code> 调用</li>
<li>• 让每次状态变化都可追踪</li>
</ul>
<h4 data-id="heading-6">4. <strong>Actions（动作）—— 处理异步操作的“指挥官”</strong></h4>
<p>Actions 可以包含任意异步操作，最终通过提交 mutation 来修改状态。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">actions</span>: {
  <span class="hljs-comment">// 异步获取用户信息</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params">{ commit }, userId</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getUser</span>(userId)
      <span class="hljs-title function_">commit</span>(<span class="hljs-string">'SET_USER'</span>, response.<span class="hljs-property">data</span>) <span class="hljs-comment">// 调用 mutation</span>
      <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title function_">commit</span>(<span class="hljs-string">'SET_ERROR'</span>, error.<span class="hljs-property">message</span>)
      <span class="hljs-keyword">throw</span> error
    }
  },
  
  <span class="hljs-comment">// 组合多个 mutation</span>
  <span class="hljs-title function_">checkout</span>(<span class="hljs-params">{ commit, state }</span>) {
    <span class="hljs-comment">// 保存订单</span>
    <span class="hljs-title function_">commit</span>(<span class="hljs-string">'CREATE_ORDER'</span>, state.<span class="hljs-property">cart</span>)
    <span class="hljs-comment">// 清空购物车</span>
    <span class="hljs-title function_">commit</span>(<span class="hljs-string">'CLEAR_CART'</span>)
    <span class="hljs-comment">// 显示成功提示</span>
    <span class="hljs-title function_">commit</span>(<span class="hljs-string">'SHOW_MESSAGE'</span>, <span class="hljs-string">'订单提交成功！'</span>)
  }
}
</code></pre>
<p><strong>与 Mutation 的区别：</strong></p>
<ul>
<li>• Action 提交的是 mutation，而不是直接变更状态</li>
<li>• Action 可以包含任意异步操作</li>
<li>• 通过 <code>store.dispatch('action名', payload)</code> 调用</li>
</ul>
<h4 data-id="heading-7">5. <strong>Modules（模块）—— 大型应用的“分治策略”</strong></h4>
<p>当应用复杂时，可以将 store 分割成模块，每个模块拥有自己的 state、mutations、actions、getters。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">userModule </span>= {
  namespaced: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启命名空间</span>
  state: () =&gt; ({ userInfo: <span class="hljs-literal">null</span> }),
  mutations: { <span class="hljs-comment">/* ... */</span> },
  actions: { <span class="hljs-comment">/* ... */</span> }
}

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">productModule </span>= {
  namespaced: <span class="hljs-literal">true</span>,
  state: () =&gt; ({ products: [] }),
  mutations: { <span class="hljs-comment">/* ... */</span> }
}

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">store </span>= <span class="hljs-keyword">new</span> Vuex.<span class="hljs-title function_ invoke__">Store</span>({
<span class="hljs-attr">  modules</span>: {
<span class="hljs-attr">    user</span>: userModule,
<span class="hljs-attr">    product</span>: productModule
  }
})
</code></pre>
<p><strong>模块化的好处：</strong></p>
<ul>
<li>• 避免 state 对象过于臃肿</li>
<li>• 让相关功能组织在一起</li>
<li>• 调用方式：<code>this.$store.dispatch('user/login', credentials)</code></li>
</ul>
<h3 data-id="heading-8">三、实战：购物车完整示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// store.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vuex</span>.<span class="hljs-title class_">Store</span>({
  <span class="hljs-attr">state</span>: {
    <span class="hljs-attr">cart</span>: [],
    <span class="hljs-attr">products</span>: []
  },
  
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">totalPrice</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> state.<span class="hljs-property">cart</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, item</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> sum + (item.<span class="hljs-property">price</span> * item.<span class="hljs-property">quantity</span>)
      }, <span class="hljs-number">0</span>)
    }
  },
  
  <span class="hljs-attr">mutations</span>: {
    <span class="hljs-title function_">ADD_ITEM</span>(<span class="hljs-params">state, product</span>) {
      <span class="hljs-comment">// ... 添加商品逻辑</span>
    }
  },
  
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">loadProducts</span>(<span class="hljs-params">{ commit }</span>) {
      <span class="hljs-keyword">const</span> products = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getProducts</span>()
      <span class="hljs-title function_">commit</span>(<span class="hljs-string">'SET_PRODUCTS'</span>, products)
    }
  }
})
</code></pre>
<h3 data-id="heading-9">四、最佳实践建议</h3>
<ol>
<li>
<p>1. <strong>遵循单向数据流</strong>：</p>
<pre><code class="hljs">组件 → Actions → Mutations → State → 组件更新
</code></pre>
</li>
<li>
<p>2. <strong>合理划分模块</strong>：</p>
</li>
<li>
<ul>
<li>• 按功能领域划分（user、product、order等）</li>
<li>• 大型项目考虑动态注册模块</li>
</ul>
</li>
<li>
<p>3. <strong>使用辅助函数</strong>简化代码：</p>
<pre><code class="hljs language-css" lang="css">import { mapState, mapActions } <span class="hljs-selector-tag">from</span> 'vuex'

export default {
  computed: {
    ..<span class="hljs-selector-class">.mapState</span>(<span class="hljs-selector-attr">[<span class="hljs-string">'user'</span>, <span class="hljs-string">'cart'</span>]</span>),
    ..<span class="hljs-selector-class">.mapGetters</span>(<span class="hljs-selector-attr">[<span class="hljs-string">'totalPrice'</span>]</span>)
  },
  methods: {
    ..<span class="hljs-selector-class">.mapActions</span>(<span class="hljs-selector-attr">[<span class="hljs-string">'fetchUser'</span>, <span class="hljs-string">'addToCart'</span>]</span>)
  }
}
</code></pre>
</li>
<li>
<p>4. <strong>TypeScript 支持</strong>：<br/>
Vuex 4 对 TypeScript 有更好的类型支持</p>
</li>
</ol>
<h3 data-id="heading-10">五、总结</h3>
<p>Vuex 的五员大将各司其职：</p>
<ul>
<li>• <strong>State</strong>：数据存储中心</li>
<li>• <strong>Getters</strong>：数据的计算加工</li>
<li>• <strong>Mutations</strong>：同步修改状态</li>
<li>• <strong>Actions</strong>：处理异步和复杂逻辑</li>
<li>• <strong>Modules</strong>：模块化管理</li>
</ul>
<p>记住这个简单的比喻：State 是仓库，Getters 是包装部，Mutations 是仓库管理员，Actions 是采购员，Modules 是分公司。</p>
<p>Vuex 的学习曲线可能有点陡峭，但一旦掌握，你将拥有管理复杂应用状态的超能力！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 项目打包后最终生成的文件全解析]]></title>    <link>https://juejin.cn/post/7595831738233864201</link>    <guid>https://juejin.cn/post/7595831738233864201</guid>    <pubDate>2026-01-17T01:44:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595831738233864201" data-draft-id="7595847940620648498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Vue 项目打包后最终生成的文件全解析"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-17T01:44:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Vue 项目打包后最终生成的文件全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T01:44:20.000Z" title="Sat Jan 17 2026 01:44:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue 项目打包后最终生成的文件全解析</h2>
<p>大家好！作为一名 Vue 开发者，你是否曾好奇：当我们运行 <code>npm run build</code> 后，Vue 项目到底被打包成了什么？今天我们就来深入探索 Vue 项目打包后的神秘世界！</p>
<h3 data-id="heading-1">一、打包命令与基础配置</h3>
<p>首先，让我们看看典型的打包命令：</p>
<pre><code class="hljs language-bash" lang="bash">npm run build
<span class="hljs-comment"># 或</span>
yarn build
</code></pre>
<p>在 Vue CLI 创建的 Vue 2/3 项目中，这通常对应着 <code>vue-cli-service build</code> 命令。打包后，默认会在项目根目录生成一个 <code>dist</code> 文件夹，里面存放着所有最终生成的文件。</p>
<h3 data-id="heading-2">二、打包后的文件结构（典型示例）</h3>
<p>让我们先看一个完整的 dist 目录结构：</p>
<pre><code class="hljs language-bash" lang="bash">dist/
├── index.html                    <span class="hljs-comment"># 入口HTML文件</span>
├── favicon.ico                   <span class="hljs-comment"># 网站图标</span>
├── robots.txt                    <span class="hljs-comment"># 搜索引擎爬虫协议</span>
├── manifest.json                 <span class="hljs-comment"># PWA 应用清单</span>
│
├── css/                          <span class="hljs-comment"># 样式文件目录</span>
│   ├── app.xxxxxxxx.css          <span class="hljs-comment"># 主样式文件（带哈希）</span>
│   ├── chunk-xxxxxxx.css         <span class="hljs-comment"># 异步组件的样式文件</span>
│   └── vendor.xxxxxxxx.css       <span class="hljs-comment"># 第三方库样式（如Element-UI）</span>
│
├── js/                           <span class="hljs-comment"># JavaScript 文件目录</span>
│   ├── app.xxxxxxxx.js           <span class="hljs-comment"># 主应用代码（含哈希）</span>
│   ├── chunk-xxxxxxxx.js         <span class="hljs-comment"># 异步组件/路由代码块</span>
│   ├── vendor.xxxxxxxx.js        <span class="hljs-comment"># 第三方依赖库</span>
│   └── runtime.xxxxxxxx.js       <span class="hljs-comment"># Webpack 运行时代码</span>
│
├── fonts/                        <span class="hljs-comment"># 字体文件目录（如有）</span>
│   ├── fontawesome-xxxx.woff2
│   └── custom-font.woff
│
└── img/                          <span class="hljs-comment"># 图片资源目录（如有）</span>
    ├── logo.png
    └── bg.jpg
</code></pre>
<h3 data-id="heading-3">三、核心文件详解</h3>
<h4 data-id="heading-4">1. <strong>入口 HTML 文件 (index.html)</strong></h4>
<p>这是应用的唯一入口点，所有其他资源都被这个文件引用。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width,initial-scale=1"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>我的Vue应用<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 自动注入的CSS文件 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/css/app.8a1b2c3d.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/css/chunk-vendors.4e5f6a7b.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 自动注入的JS文件 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/js/runtime.1a2b3c4d.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/js/chunk-vendors.5e6f7a8b.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/js/app.9a0b1c2d.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">2. <strong>JavaScript 文件分类</strong></h4>
<h5 data-id="heading-6"><strong>a) 运行时代码 (runtime.xxxxxxxx.js)</strong></h5>
<ul>
<li><strong>大小</strong>: 通常很小（约10KB）</li>
<li><strong>作用</strong>: 包含 Webpack 的运行时代码，负责模块加载、代码分割等功能</li>
<li><strong>特点</strong>: 没有业务逻辑，只包含框架运行所需的最小代码</li>
</ul>
<h5 data-id="heading-7"><strong>b) 主应用代码 (app.xxxxxxxx.js)</strong></h5>
<ul>
<li><strong>包含内容</strong>: 你的 Vue 组件、业务逻辑、路由配置、状态管理等</li>
<li><strong>特点</strong>: 文件名中的哈希值确保缓存更新，内容变更时哈希值会变</li>
</ul>
<h5 data-id="heading-8"><strong>c) 第三方依赖 (vendor/chunk-vendors.xxxxxxxx.js)</strong></h5>
<ul>
<li><strong>包含内容</strong>: Vue.js、Vuex、Vue Router、Axios、Element-UI 等第三方库</li>
<li><strong>优化策略</strong>: 单独打包，可以利用浏览器缓存（这些库不常更新）</li>
</ul>
<h5 data-id="heading-9"><strong>d) 异步代码块 (chunk-xxxxxxxx.js)</strong></h5>
<p>当使用路由懒加载或动态导入时，会产生这些文件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue Router 懒加载</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/Home.vue'</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">About</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/About.vue'</span>)
</code></pre>
<p>打包后生成：</p>
<ul>
<li><code>chunk-home.xxxxxxxx.js</code></li>
<li><code>chunk-about.xxxxxxxx.js</code></li>
</ul>
<h4 data-id="heading-10">3. <strong>CSS 样式文件</strong></h4>
<ul>
<li><strong>主样式文件</strong>: 全局样式和组件样式</li>
<li><strong>vendor 样式</strong>: 第三方 UI 库的样式</li>
<li><strong>异步组件样式</strong>: 代码分割的组件对应的样式</li>
</ul>
<h3 data-id="heading-11">四、文件名中的哈希值</h3>
<p>你可能会注意到文件名中的奇怪后缀（如 <code>app.8a1b2c3d.js</code>），这是 Webpack 的<strong>内容哈希</strong>策略：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vue.config.js 中的配置</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">filenameHashing</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 默认开启</span>
  <span class="hljs-attr">configureWebpack</span>: {
    <span class="hljs-attr">output</span>: {
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].[contenthash:8].js'</span>,
      <span class="hljs-attr">chunkFilename</span>: <span class="hljs-string">'[name].[contenthash:8].js'</span>
    }
  }
}
</code></pre>
<p><strong>哈希值的作用：</strong></p>
<ol>
<li><strong>缓存控制</strong>: 文件内容不变，哈希值不变，浏览器可长期缓存</li>
<li><strong>强制更新</strong>: 内容变化时哈希值变化，用户自动获取最新版本</li>
<li><strong>避免冲突</strong>: 防止不同版本的文件名冲突</li>
</ol>
<h3 data-id="heading-12">五、打包配置与优化</h3>
<h4 data-id="heading-13">1. <strong>基础配置 (vue.config.js)</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// 输出目录</span>
  <span class="hljs-attr">outputDir</span>: <span class="hljs-string">'dist'</span>,
  
  <span class="hljs-comment">// 静态资源目录</span>
  <span class="hljs-attr">assetsDir</span>: <span class="hljs-string">'static'</span>,
  
  <span class="hljs-comment">// 生产环境的 source map</span>
  <span class="hljs-attr">productionSourceMap</span>: <span class="hljs-literal">false</span>,
  
  <span class="hljs-comment">// 资源文件小于此值会内联（base64）</span>
  <span class="hljs-attr">chainWebpack</span>: <span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
    config.<span class="hljs-property">module</span>
      .<span class="hljs-title function_">rule</span>(<span class="hljs-string">'images'</span>)
      .<span class="hljs-title function_">use</span>(<span class="hljs-string">'url-loader'</span>)
      .<span class="hljs-title function_">loader</span>(<span class="hljs-string">'url-loader'</span>)
      .<span class="hljs-title function_">tap</span>(<span class="hljs-function"><span class="hljs-params">options</span> =&gt;</span> ({
        ...options,
        <span class="hljs-attr">limit</span>: <span class="hljs-number">10240</span> <span class="hljs-comment">// 10KB</span>
      }))
  }
}
</code></pre>
<h4 data-id="heading-14">2. <strong>代码分割策略</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 按路由分割</span>
<span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VueRouter</span>({
  <span class="hljs-attr">routes</span>: [
    { <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/Home.vue'</span>) },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/About.vue'</span>) }
  ]
})
</code></pre>
<h4 data-id="heading-15">3. <strong>第三方库分离</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 手动配置哪些库单独打包</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">configureWebpack</span>: {
    <span class="hljs-attr">optimization</span>: {
      <span class="hljs-attr">splitChunks</span>: {
        <span class="hljs-attr">cacheGroups</span>: {
          <span class="hljs-attr">vendor</span>: {
            <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>,
            <span class="hljs-attr">name</span>: <span class="hljs-string">'vendors'</span>,
            <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>
          }
        }
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-16">六、不同构建模式的文件差异</h3>
<h4 data-id="heading-17">1. <strong>开发模式 vs 生产模式</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开发模式</span>
npm run serve  <span class="hljs-comment"># 生成内存中的文件，用于热重载</span>

<span class="hljs-comment"># 生产模式</span>
npm run build  <span class="hljs-comment"># 生成优化后的 dist 文件</span>
</code></pre>
<h4 data-id="heading-18">2. <strong>分析打包体积</strong></h4>
<p>使用 <code>@vue/cli-service</code> 的构建分析功能：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成分析报告</span>
vue-cli-service build --report

<span class="hljs-comment"># 或查看可视化图表</span>
vue-cli-service build --report-json
</code></pre>
<p>这会在 <code>dist</code> 目录生成 <code>report.html</code>，可视化展示各个模块的大小。</p>
<h3 data-id="heading-19">七、现代构建工具 Vite 的差异</h3>
<p>如果你的项目使用 Vite 而不是 Webpack，打包结果会有所不同：</p>
<p><strong>Vite 打包特点：</strong></p>
<pre><code class="hljs language-bash" lang="bash">dist/
├── index.html
├── assets/
│   ├── index.xxxxxxxx.js        <span class="hljs-comment"># 主入口</span>
│   ├── vendor.xxxxxxxx.js       <span class="hljs-comment"># 依赖</span>
│   └── xxx.xxxxxxxx.css         <span class="hljs-comment"># 样式</span>
└── *.module.xxxxxxxx.js         <span class="hljs-comment"># 动态导入的模块</span>
</code></pre>
<p><strong>Vite 优势：</strong></p>
<ul>
<li>基于原生 ES 模块，更快的构建速度</li>
<li>更小的打包体积</li>
<li>更简单的配置</li>
</ul>
<h3 data-id="heading-20">八、最佳实践与优化建议</h3>
<h4 data-id="heading-21">1. <strong>文件压缩与优化</strong></h4>
<ul>
<li><strong>JavaScript</strong>: 使用 Terser 压缩</li>
<li><strong>CSS</strong>: 使用 CSSNano 压缩</li>
<li><strong>图片</strong>: 使用 imagemin 压缩</li>
<li><strong>Gzip/Brotli</strong>: 服务器开启压缩</li>
</ul>
<h4 data-id="heading-22">2. <strong>CDN 加速</strong></h4>
<p>将第三方库通过 CDN 引入，减小打包体积：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 在 index.html 中 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/vuex@3.6.2/dist/vuex.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 告诉 Vue CLI 这些库外部化</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">configureWebpack</span>: {
    <span class="hljs-attr">externals</span>: {
      <span class="hljs-attr">vue</span>: <span class="hljs-string">'Vue'</span>,
      <span class="hljs-attr">vuex</span>: <span class="hljs-string">'Vuex'</span>,
      <span class="hljs-string">'vue-router'</span>: <span class="hljs-string">'VueRouter'</span>
    }
  }
}
</code></pre>
<h4 data-id="heading-23">3. <strong>预渲染/SSR</strong></h4>
<p>对于 SEO 要求高的页面：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 @vue/cli-plugin-prerender-spa</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">pluginOptions</span>: {
    <span class="hljs-attr">prerenderSpa</span>: {
      <span class="hljs-attr">registry</span>: <span class="hljs-literal">undefined</span>,
      <span class="hljs-attr">renderRoutes</span>: [<span class="hljs-string">'/'</span>, <span class="hljs-string">'/about'</span>],
      <span class="hljs-attr">useRenderEvent</span>: <span class="hljs-literal">true</span>
    }
  }
}
</code></pre>
<h3 data-id="heading-24">九、总结</h3>
<p>Vue 项目打包后主要生成以下核心文件：</p>



































<table><thead><tr><th>文件类型</th><th>作用</th><th>优化建议</th></tr></thead><tbody><tr><td>index.html</td><td>应用入口</td><td>开启 Gzip 压缩</td></tr><tr><td>app.js</td><td>业务代码</td><td>代码分割、懒加载</td></tr><tr><td>vendor.js</td><td>第三方库</td><td>CDN 引入、单独打包</td></tr><tr><td>runtime.js</td><td>运行时代码</td><td>几乎不需要优化</td></tr><tr><td>CSS 文件</td><td>样式</td><td>压缩、提取公共样式</td></tr></tbody></table>
<p><strong>记住这三个关键点：</strong></p>
<ol>
<li><strong>哈希命名</strong>确保缓存有效性</li>
<li><strong>代码分割</strong>提升加载性能</li>
<li><strong>按需加载</strong>减少首屏体积</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入浅出 TinyEditor 富文本编辑器系列3：安装与配置]]></title>    <link>https://juejin.cn/post/7595847940620664882</link>    <guid>https://juejin.cn/post/7595847940620664882</guid>    <pubDate>2026-01-17T01:50:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595847940620664882" data-draft-id="7596065628243558446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入浅出 TinyEditor 富文本编辑器系列3：安装与配置"/> <meta itemprop="keywords" content="前端,开源,TypeScript"/> <meta itemprop="datePublished" content="2026-01-17T01:50:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端开源星球"/> <meta itemprop="url" content="https://juejin.cn/user/1504599026445150"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入浅出 TinyEditor 富文本编辑器系列3：安装与配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1504599026445150/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端开源星球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T01:50:06.000Z" title="Sat Jan 17 2026 01:50:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你好，我是 Kagol，个人公众号：<code>前端开源星球</code>。</p>
<p>TinyEditor 是一个基于 Quill 2.0 的富文本编辑器，在 Quill 基础上扩展了丰富的模块和格式，功能强大、开箱即用。</p>
<ul>
<li>源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-editor%2F" target="_blank" title="https://github.com/opentiny/tiny-editor/" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a>（欢迎 Star ⭐）</li>
<li>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor%2F" target="_blank" title="https://opentiny.github.io/tiny-editor/" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editor…</a></li>
</ul>
<p>本文是《深入浅出 TinyEditor 富文本编辑器系列》文章的第3篇，主要介绍 TinyEditor 的完整安装和设置过程。</p>
<ul>
<li><a href="https://juejin.cn/post/7593261984189218866" target="_blank" title="https://juejin.cn/post/7593261984189218866">深入浅出 TinyEditor 富文本编辑器系列1：TinyEditor 是什么</a></li>
<li><a href="https://juejin.cn/post/7593600903249625114" target="_blank" title="https://juejin.cn/post/7593600903249625114">深入浅出 TinyEditor 富文本编辑器系列2：快速开始</a></li>
</ul>
<h2 data-id="heading-0">系统要求</h2>
<p>安装 TinyEditor 前，请确保你的开发环境满足以下要求：</p>
<ul>
<li><strong>Node.js</strong>: 16.0 版本或更高版本</li>
<li><strong>包管理器</strong>: pnpm（推荐）、npm 或 yarn</li>
<li><strong>浏览器</strong>: 支持 ES6+ 特性的现代浏览器</li>
</ul>
<h2 data-id="heading-1">安装方法</h2>
<h3 data-id="heading-2">1. NPM 包安装</h3>
<p>将 TinyEditor 添加到项目的最简单方法是通过 npm：</p>
<pre><code class="hljs language-bash" lang="bash">npm i @opentiny/fluent-editor
</code></pre>
<p>这将安装 TinyEditor 的最新稳定版本及其所有核心模块和格式。</p>
<h3 data-id="heading-3">2. 开发环境设置</h3>
<p>对于希望贡献或修改 TinyEditor 的开发者：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> git@github.com:opentiny/tiny-editor.git
<span class="hljs-built_in">cd</span> tiny-editor
pnpm i
pnpm dev
</code></pre>
<p>开发服务器将在 <code>http://localhost:5173/tiny-editor/</code> 启动。</p>
<h2 data-id="heading-4">项目架构</h2>
<p>TinyEditor 采用多包 monorepo 结构：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9315c67178e407386300e9103357859~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5byA5rqQ5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769219481&amp;x-signature=zOK4f3ZJzGPRWQrkAqwGVHjXdJ4%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">包结构</h3>

























<table><thead><tr><th>包</th><th>用途</th></tr></thead><tbody><tr><td><code>fluent-editor</code></td><td>核心编辑器库</td></tr><tr><td><code>docs</code></td><td>文档和示例</td></tr><tr><td><code>projects</code></td><td>演示应用</td></tr><tr><td><code>collaborative-editing-backend</code></td><td>实时协作服务器</td></tr></tbody></table>
<h2 data-id="heading-6">基础集成</h2>
<h3 data-id="heading-7">HTML 设置</h3>
<p>为你的编辑器创建容器元素：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello TinyEditor!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-8">CSS 导入</h3>
<p>在你的 CSS 或 SCSS 文件中导入 TinyEditor 样式：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@import</span> <span class="hljs-string">'@opentiny/fluent-editor/style.css'</span>;
</code></pre>
<blockquote>
<p>style.css 文件在构建过程中自动生成，包含编辑器及其模块的所有必要样式。</p>
</blockquote>
<h3 data-id="heading-9">JavaScript 初始化</h3>
<p>导入并初始化 TinyEditor：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">TinyEditor</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@opentiny/fluent-editor'</span>
<span class="hljs-keyword">const</span> editor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TinyEditor</span>(<span class="hljs-string">'#editor'</span>, {
  <span class="hljs-attr">theme</span>: <span class="hljs-string">'snow'</span>
})
</code></pre>
<h2 data-id="heading-10">模块注册</h2>
<p>TinyEditor 在初始化期间自动注册所有可用模块：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">FluentEditor</span>.<span class="hljs-title function_">register</span>({
  <span class="hljs-string">'formats/emoji'</span>: <span class="hljs-title class_">EmojiBlot</span>,
  <span class="hljs-string">'formats/divider'</span>: <span class="hljs-title class_">DividerBlot</span>,
  <span class="hljs-string">'modules/clipboard'</span>: <span class="hljs-title class_">CustomClipboard</span>,
  <span class="hljs-string">'modules/counter'</span>: <span class="hljs-title class_">Counter</span>,
  <span class="hljs-string">'modules/emoji'</span>: <span class="hljs-title class_">EmojiModule</span>,
  <span class="hljs-string">'modules/file'</span>: <span class="hljs-title class_">FileModule</span>,
  <span class="hljs-string">'modules/i18n'</span>: <span class="hljs-variable constant_">I18N</span>,
  <span class="hljs-string">'modules/image'</span>: <span class="hljs-title class_">BlotFormatter</span>,
  <span class="hljs-string">'modules/mathlive'</span>: <span class="hljs-title class_">MathliveModule</span>,
  <span class="hljs-string">'modules/ai'</span>: <span class="hljs-variable constant_">AI</span>,
  <span class="hljs-string">'modules/mention'</span>: <span class="hljs-title class_">Mention</span>,
  <span class="hljs-string">'modules/syntax'</span>: <span class="hljs-title class_">Syntax</span>,
  <span class="hljs-string">'modules/toolbar'</span>: <span class="hljs-title class_">BetterToolbar</span>,
  <span class="hljs-string">'modules/uploader'</span>: <span class="hljs-title class_">FileUploader</span>,
  <span class="hljs-string">'modules/shortcut-key'</span>: <span class="hljs-title class_">ShortCutKey</span>,
  <span class="hljs-string">'modules/mind-map'</span>: <span class="hljs-title class_">MindMapModule</span>,
  <span class="hljs-string">'modules/flow-chart'</span>: <span class="hljs-title class_">FlowChartModule</span>,
  <span class="hljs-string">'themes/snow'</span>: <span class="hljs-title class_">SnowTheme</span>,
  <span class="hljs-string">'ui/icons'</span>: <span class="hljs-title class_">Icons</span>,
  <span class="hljs-string">'ui/picker'</span>: <span class="hljs-title class_">Picker</span>,
  <span class="hljs-string">'ui/color-picker'</span>: <span class="hljs-title class_">ColorPicker</span>,
}, <span class="hljs-literal">true</span>)
</code></pre>
<h2 data-id="heading-11">构建配置</h2>
<h3 data-id="heading-12">本地启动</h3>
<p>用于热重载的开发：</p>
<pre><code class="hljs">pnpm dev
</code></pre>
<h3 data-id="heading-13">生产构建</h3>
<p>构建用于分发的库：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">pnpm build:<span class="hljs-keyword">lib</span>
</code></pre>
<p>构建过程创建多种格式：</p>
<ul>
<li><strong>ES 模块</strong>: <code>dist/es/</code> 目录</li>
<li><strong>CommonJS</strong>: <code>dist/lib/</code> 目录</li>
<li><strong>类型定义</strong>: <code>dist/types/</code> 目录</li>
<li><strong>样式</strong>: <code>dist/style.css</code></li>
</ul>
<h2 data-id="heading-14">工作区管理</h2>
<p>TinyEditor 使用 pnpm workspaces 进行包管理：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">packages:  - packages/*</span>
</code></pre>
<p>可用工作区脚本：</p>

































<table><thead><tr><th>脚本</th><th>描述</th></tr></thead><tbody><tr><td><code>pnpm dev</code></td><td>启动文档站点</td></tr><tr><td><code>pnpm watch</code></td><td>监听库的变更</td></tr><tr><td><code>pnpm dev:projects</code></td><td>启动示例项目</td></tr><tr><td><code>pnpm build</code></td><td>构建文档</td></tr><tr><td><code>pnpm build:lib</code></td><td>构建用于分发的库</td></tr><tr><td><code>pnpm pub</code></td><td>发布库到 npm</td></tr></tbody></table>
<h2 data-id="heading-15">依赖</h2>
<h3 data-id="heading-16">核心依赖</h3>
<p>TinyEditor 通过附加模块扩展 Quill：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"lodash-es"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.17.15"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"quill"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^2.0.0"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"quill-easy-color"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.0.10"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"quill-shortcut-key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^0.0.5"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-17">开发依赖</h3>
<p>构建系统包含用于 TypeScript、测试和打包的综合工具。</p>
<p>后续将全面介绍 TinyEditor 如何使用、设计架构、实现原理、二次开发等内容，点个关注，不迷路。</p>
<h2 data-id="heading-18">联系我们</h2>
<p>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-editor" target="_blank" title="https://github.com/opentiny/tiny-editor" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a>（欢迎 Star ⭐）</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.github.io%2Ftiny-editor" target="_blank" title="https://opentiny.github.io/tiny-editor" ref="nofollow noopener noreferrer">opentiny.github.io/tiny-editor</a></p>
<p>个人博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fkagol.github.io%2Fblogs%2F" target="_blank" title="https://kagol.github.io/blogs/" ref="nofollow noopener noreferrer">kagol.github.io/blogs/</a></p>
<p>小助手微信：opentiny-official</p>
<p>公众号：OpenTiny</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重构即时IM系统1：现状与目标]]></title>    <link>https://juejin.cn/post/7595502583269589028</link>    <guid>https://juejin.cn/post/7595502583269589028</guid>    <pubDate>2026-01-16T10:30:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595502583269589028" data-draft-id="7595615310181089334" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重构即时IM系统1：现状与目标"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T10:30:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QZQ54188"/> <meta itemprop="url" content="https://juejin.cn/user/666776045362473"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重构即时IM系统1：现状与目标
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/666776045362473/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QZQ54188
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T10:30:22.000Z" title="Fri Jan 16 2026 10:30:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>笔者之前在网上参考了一个IM即时通讯的项目，但是在看完DDIA之后发现这个项目还是太玩具了，虽然支持IM系统中的互发消息，群聊，好友功能和会话功能，但实际实现上相当暴力，就是单机的CRUD加上简单的reids缓存。下面解释一下这个IM系统目前的缺陷。</p>
<h2 data-id="heading-0">目前IM好友，会话功能的缺陷</h2>
<p>那个玩具IM的好友，会话功能基本上就是CRUD再加上简单的reids缓存，如果数据量太大的话肯定承受不住，没有做分库分表的处理。比如说单机情况下应该先尝试分表，比如说按照时间拆分表，将不同月份或者季度的聊天，好友和群聊表拆分，这样可以减少单个表的数据量，缓解数据量大，索引过深，维护困难的问题。</p>
<p>如果数据量大到mysql也承受不住了就可以尝试部署多个mysql实例，再在每个实例上进行分库，这样可以避免单机瓶颈，还可以每个分库有多太机器做单主复制，但是mysql是binlog的异步复制，会有一致性问题，这里可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fddia.vonng.com%2Fch6%2F" target="_blank" title="https://ddia.vonng.com/ch6/" ref="nofollow noopener noreferrer">DDIA的第6章：复制</a>。还有部署多mysql做分库的话就涉及到了分片问题，这里可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fddia.vonng.com%2Fch7%2F" target="_blank" title="https://ddia.vonng.com/ch7/" ref="nofollow noopener noreferrer">DDIA的第7章：分片</a>。</p>
<p>如果多台mysql也承受不住的话，就可以尝试使用数据仓库，将冷数据比如说半年前的数据放到数据仓库中，做冷热分离，还可以实现离线报表功能，下面给出AI的回答进行参考：</p>
<blockquote>
<p>而当分片后的 MySQL 集群也逐渐触及运维复杂度的红线，或者业务产生了强烈的全量数据分析需求时，我们往往需要引入 <strong>HDFS</strong> 这种分布式文件系统来构建数据湖。这种演进背后的核心逻辑是将“在线交易（OLTP）”与“离线分析（OLAP）”从物理上彻底解耦。在具体实践中，我们可以利用 CDC（变更数据捕获）技术，通过 Canal 或 Debezium 实时监听 binlog 变更并将其推送到 Kafka，再由 Flink 异步地以列式存储格式（如 Parquet 或 ORC）写入 HDFS；或者采用更传统的定时批处理（如 DataX）在业务低峰期将历史快照搬运到 Hadoop 集群。</p>
<p>这样做的好处在于，MySQL 可以只保留最近几个月甚至几周的“热数据”，从而确保索引精简、B+ 树深度受控，维持极高的查询响应速度。而海量的历史“冷数据”则在 HDFS 中以极低的存储成本安家，并配合 Hive、Trino 或 Spark 等计算引擎进行深度价值挖掘。这其实是更高阶的架构思考：不再试图让一个数据库解决所有问题，而是根据数据的生命周期和访问模式，构建一个多层次、多范式的存储体系，从而在性能、成本和复杂性之间达成新的平衡。这同样呼应了 DDIA 中关于衍生数据系统的讨论，即如何通过数据流将不同的存储技术组合成一个功能强大的整体。</p>
</blockquote>
<h2 data-id="heading-1">目前IM聊天功能的缺陷</h2>
<p>这个IM的聊天功能也十分暴力，主要就是客户端注册的话直接升级为websocket长连接，前端检测到登录成功之后就会直接调用<code>NewClientInit</code>方法在服务器的<code>Clients ( map[string]*Client )</code>中注册了一个<code>client</code>对象。这个<code>client</code>对象不仅维护了刚刚升级的底层<code>websocket</code>的连接<code>Conn</code>，还维护了两个核心的<code>Channel</code>： <code>SendTo</code> 和 <code>SendBack</code> 。</p>
<p>用户发送上行消息时，<code>Client.Read</code>协程从<code>WebSocket</code> 读取数据，经过简单的反序列化后，直接将消息塞入全局单例 <code>ChatServer</code> 的 <code>Transmit</code> 通道（一个所有用户共享的消息总线）。<code>ChatServer</code> 有一个专门的后台协程持续监听 <code>Transmit</code> 通道。一旦拿到消息，它会解析出 <code>ReceiveId</code> ，然后直接去全局的 <code>Clients Map</code> 中进行查找。</p>
<p>如果找到了的话，直接把消息塞入对方<code>Client</code>对象的<code>SendBack</code>通道，如果没找到的话就把消息存入数据库，不做实时推送（听起来就很暴力是吧，离线用户登录查看消息时需要进行大量查数据库操作......）。接收方的<code>Client.Write</code>协程一直阻塞监听自己的<code>SendBack</code>通道，一旦路由逻辑把消息塞进来，它就立即醒来，通过 <code>WebSocket</code> 将消息推送到接收方的前端。</p>
<p>这种设计是典型的**“单进程内存路由”**模型，代码逻辑及其简单，但缺点也显而易见： 它假设所有用户都在同一台机器的同一个进程内存里 。一旦需要部署两台服务器，连接在 Server A 的用户发出的消息，Server A 根本无法在自己的内存 Map 里找到连接在 Server B 的用户，导致消息无法送达。</p>
<p>而且目前是单体架构设计，只有一台服务器，挂了就全部挂了，但是部署多态服务器就会出现上述找不到发送者的问题，解决这个问题的办法也很简单，就是业务服务器做无状态处理，客户端状态记录在基础层（reids或者etcd之类的分布式kv），发现消息时查基础层的路由表得知哪个用户在哪台机器上就可以。</p>
<p>离线用户拉取历史消息也十分复杂，每次查询时都进行<code>dao.GormDB.Where("(send_id = ? AND receive_id = ?) OR (send_id = ? AND receive_id = ?)", userOneId, userTwoId, userTwoId, userOneId).Order("created_at ASC").Find(&amp;messageList)</code>这一串查询，而且这个查询还不可以依赖索引，因为区分度不高，随着聊天记录增加，查询速度会越来越慢，且极其消耗带宽和内存。解决这个问题也简单，就是客户端连接服务器时发送一个上次接收到的最后一条消息的序号，服务器再按需推送，整体思路就是这样，后续重构到那一步了再进行代码实现。</p>
<p>消息逻辑还有一个问题，收发消息的可靠性，这里可以使用端到端原则讲解：如果一个功能（比如“确保消息可靠送达”）必须由通信系统的端点（即发送方 A 和接收方 B 的应用程序）来完成，那么底层网络（TCP/IP）提供的部分可靠性是不够的，也不应该依赖底层来解决所有问题。</p>
<p>很多人误以为：“我用了 TCP 连接，TCP 保证不丢包，所以我应用层发消息就不会丢。” 这是错误的 。TCP 只能保证 传输层 的可靠性，它保证的是“数据包从 A 的网卡发到了 B 的网卡，并且在内核缓冲区里拼装好了”。比如在下面的场景中，B的内核收到了TCP包，但是还没来得及给 App，App 就闪退了。或者是应用程序中的错误，比如说 B 的 App 收到了消息，但在解析 JSON 时报错了，或者写入本地数据库失败了。</p>
<p>在这些情况下， 从 TCP 的视角看，数据已经“送达”了；但从用户的视角（业务层）看，消息就是“丢了”。正是因为底层（网络层、传输层）无法感知上层（应用层）的“业务成功”，所以根据端到端原则， 必须在最高层（应用层）实现确认机制 。如果不做这个的话客户端就不知道自己的消息是否成功发送到了服务器中，就会出现A觉得自己消息发送成功了，但是对方没有收到消息，造成使用上的严重问题。还可能同时发送多条消息的时候会由于网络包的乱序到达，丢失消息的有序性，造成理解上的问题。</p>
<p>所以我们需要业务层实现的可靠传输机制，业务层的 ACK ：只有当接收方 B 的 App 成功接收、解析并落库 后，主动发一个业务层的 ACK 包给服务器，服务器才敢确认“这条消息真的到了”。超时重传 ：如果服务器发了消息，过了一段时间（比如 5秒）没收到 B 的 ACK，服务器就必须 应用层重传 ，而不能指望 TCP 重传。还需要一个客户端的序列号，有了这个序列号就可以给消息排序，避免消息乱序的问题。</p>
<h2 data-id="heading-2">总结</h2>
<p>本次对 IM 系统架构的深度剖析，揭示了从“能用”到“好用”，从“单机 Demo”到“分布式系统”之间巨大的技术鸿沟。现有的系统虽然实现了基础的聊天功能，但其本质是一个建立在 单机内存路由 和 粗暴数据库查询 之上的玩具项目，在高并发、高可用和弱网环境下的表现几乎为零。</p>
<p>我们的重构之路将围绕 DDIA（设计数据密集型应用）的核心理念展开，旨在解决以下三大痛点：</p>
<ol>
<li>打破单机瓶颈，分布式扩展。目前用户只能连同一台机器，无法水平扩展。我们应该在多台服务器上部署服务去做水平拓展，分担单机压力，将有状态的 WebSocket 连接与无状态的业务逻辑解耦，利用分布式kv存储用户在线状态（路由表），实现多台网关服务器的协同工作，让消息在集群中自由流转。</li>
<li>优化存储模型来应对海量数据。目前是全量查询 MySQL，无索引优化，群成员 JSON 存储反范式，读写效率随数据量指数级下降。我们应该实施分库分表策略，按时间维度拆分消息表，降低单表压力。还可以实现收件箱和发件箱模式去适配单聊和群聊，保证读写速度。</li>
<li>构建应用层可靠性，保障消息一致性。目前缺乏应用层可靠性保证，可以说目前这个IM就是不可靠的，存在丢消息、乱序、黑洞等严重隐患。我们可以在业务层实现 ACK 确认机制 、 超时重传 和 全局序列号 (Sequence ID) 。确保在网络抖动、应用崩溃等极端情况下，消息依然能够 不丢、不重、有序 地送达用户手中。</li>
</ol>
<p>这次重构不仅是对代码的修补，更是对分布式系统设计思维的一次实战演练。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GLM-4.7 模型上线企业版]]></title>    <link>https://juejin.cn/post/7595603381664186374</link>    <guid>https://juejin.cn/post/7595603381664186374</guid>    <pubDate>2026-01-16T12:58:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595603381664186374" data-draft-id="7595552420048388139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GLM-4.7 模型上线企业版"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T12:58:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火山引擎开发者社区"/> <meta itemprop="url" content="https://juejin.cn/user/3307770588439422"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GLM-4.7 模型上线企业版
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3307770588439422/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火山引擎开发者社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T12:58:44.000Z" title="Fri Jan 16 2026 12:58:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>TRAE 企业版本周再次更新！提供全新内置模型 GLM-4.7，支持灵活添加单个问题到侧边问答，对话流支持展示消息发送时间，旨在为用户提供更强大的模型能力和更高效的使用体验，下面是本次升级的内容详情：</p>
<p>企业内置模型新增 GLM-4.7</p>
<p>本次更新引入 <strong>GLM-4.7</strong> 模型，该模型支持 <strong>Max</strong> 模式，用户可开启体验更高模型配置。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1775230661ea4de6b297dddb453dbd2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5bGx5byV5pOO5byA5Y-R6ICF56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769173124&amp;x-signature=35D1mSqDVtc8K6q%2BQMHNqu3fYnw%3D" alt="" loading="lazy"/></p>
<p><strong>模型特点：</strong></p>
<p>GLM-4.7 面向 Agentic Coding 场景强化了编码能力、长程任务规划与工具协同，在前端生成质量方面明显进步，在复杂任务上有更稳定的表现。该模型在代码生成、任务规划以及多工具协同等场景下表现出更强的专业性和稳定性。</p>
<p>支持灵活添加单个问题到侧边问答</p>
<p>本次新增<strong>单个问题灵活添加功能</strong>，优化控制台问题管理体验。用户可在控制台中自主选择单个问题添加至侧边对话，针对该问题单独发起 AI 问答，提升问题处理的精准度与效率。相比批量操作，该功能让用户能够更精准地控制问答范围，确保每个问题都得到针对性的回复。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa5eb47dc5784c129577ada9a0a0f87e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5bGx5byV5pOO5byA5Y-R6ICF56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769173124&amp;x-signature=%2Boq4nzZlqwpncYjgcoc%2BpmdsU2w%3D" alt="" loading="lazy"/></p>
<p>对话流支持展示消息发送时间</p>
<p>产品新增<strong>对话时间展示功能</strong>，便于用户管理和回溯对话记录。</p>
<p>用户在信息检索、问题排查时，可以按时间维度快速定位内容。在多轮对话场景中，时间信息能够帮助用户快速定位关键对话节点，提高工作回顾和信息检索的效率。</p>
<p><strong>操作路径：</strong></p>
<p>将鼠标悬浮在对话流头像旁边，即可显示该条消息的发送时间。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9268edd12927490f98e0a15a5773b3ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5bGx5byV5pOO5byA5Y-R6ICF56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769173124&amp;x-signature=ljOpT8ARbAib%2F%2BeWWq%2BfJ3Q1Azg%3D" alt="" loading="lazy"/></p>
<p>本次升级的所有功能现已上线，欢迎升级至最新版本立即体验。</p>
<p>TRAE 企业版持续优化产品体验，让 AI 工具更好地服务企业研发场景。欢迎关注TRAE 企业版服务号，持续获取最新产品资讯动态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PostgreSQL数据库设计学习笔记]]></title>    <link>https://juejin.cn/post/7595815509234597928</link>    <guid>https://juejin.cn/post/7595815509234597928</guid>    <pubDate>2026-01-16T13:04:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595815509234597928" data-draft-id="7595815509234434088" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PostgreSQL数据库设计学习笔记"/> <meta itemprop="keywords" content="PostgreSQL,数据库"/> <meta itemprop="datePublished" content="2026-01-16T13:04:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="UIUV"/> <meta itemprop="url" content="https://juejin.cn/user/1036168457093483"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PostgreSQL数据库设计学习笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1036168457093483/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    UIUV
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T13:04:38.000Z" title="Fri Jan 16 2026 13:04:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在后端开发体系中，数据库设计是承载业务逻辑、保障数据安全与高效访问的核心环节。PostgreSQL作为功能强大的开源关系型数据库，兼具兼容性、扩展性与可靠性，被广泛应用于各类复杂业务场景。本次学习围绕关系型数据库基础、PostgreSQL核心特性、表结构设计、关联查询及事务机制展开，结合文章系统实操案例，深入掌握数据库设计的核心思路与实操技巧，现将学习内容整理如下。</p>
<h2 data-id="heading-0">一、关系型数据库基础认知</h2>
<h3 data-id="heading-1">1.1 核心定义与特性</h3>
<p>关系型数据库（如MySQL、PostgreSQL）以二维表格为数据组织载体，通过行（row）存储单个实例数据，列（column）定义数据属性，形成清晰的结构化数据模型。其核心优势在于通过约束机制与事务特性，保障数据的一致性、完整性与可靠性，适用于对数据准确性要求较高的业务场景（如电商、社交、办公系统等）。</p>
<p>关系型数据库的核心特性可概括为“结构化存储+关联能力+事务保障”：结构化存储使数据组织有序，便于理解与维护；通过主键、外键建立表间关联，实现数据的逻辑联动；遵循ACID事务原则，确保复杂操作的原子性与可靠性，这也是关系型数据库区别于非关系型数据库的核心标志。</p>
<h3 data-id="heading-2">1.2 核心概念对应关系</h3>
<p>在面向对象编程与数据库设计的对应关系中，表（Table）可类比为类（Class），代表某一类数据的集合；行（Row）对应类的实例（Instance），存储单个对象的具体数据；列（Column）对应类的属性（Attribute），定义数据的类型与约束。以文章系统为例，users表对应“用户”类，每一行数据是一个具体用户实例，id、name等列则是用户的核心属性。</p>
<h2 data-id="heading-3">二、数据库设计核心约束与索引</h2>
<p>约束机制是保障数据完整性的关键，索引则是提升查询效率的核心手段。合理设计约束与索引，既能避免无效数据录入，又能优化数据访问性能，是数据库设计的核心环节。</p>
<h3 data-id="heading-4">2.1 主键（Primary Key）</h3>
<p>主键是用于唯一标识表中每一行数据的字段，相当于数据的“身份证”，其设计直接影响数据的访问效率与一致性。</p>
<ul>
<li><strong>核心特性</strong>：唯一性（表中无重复主键值）、非空性（不可为NULL），通常结合自增特性使用，避免手动分配主键导致的冲突问题。</li>
<li><strong>功能类比</strong>：主键如同书籍的索引目录，通过唯一标识快速定位目标数据，避免全表扫描，大幅提升查询效率。</li>
<li><strong>实操建议</strong>：在PostgreSQL中，优先使用BIGINT类型搭配自增机制作为主键。INT类型上限为21亿，面对大规模数据场景易出现溢出问题；而BIGINT（8字节存储）支持更大数值范围，适配业务增长需求。同时，采用SQL标准的IDENTITY自增方式，相较于传统SERIAL类型，兼容性更强、可控性更高。</li>
</ul>
<h3 data-id="heading-5">2.2 唯一索引（Unique Index）</h3>
<p>唯一索引是对字段施加的唯一性约束，确保该字段值在表中无重复，同时自动为字段建立索引，兼顾数据完整性与查询效率。</p>
<p>以users表的name字段为例，设置唯一索引后，无法插入重复用户名，有效避免用户注册时的名称冲突。需要注意的是，唯一索引允许字段值为NULL（但仅允许一个NULL值），若需同时限制非空，需额外添加NOT NULL约束。在PostgreSQL中，为字段添加UNIQUE约束时，数据库会自动创建对应的唯一索引，无需手动创建，简化操作流程。</p>
<h3 data-id="heading-6">2.3 外键（Foreign Key）</h3>
<p>外键是用于建立表间关联的字段，通过引用另一张表的主键，实现数据的逻辑联动，确保表间数据的一致性。外键约束是关系型数据库实现关联查询与数据完整性的核心手段。</p>
<ul>
<li><strong>关联逻辑</strong>：以文章系统为例，posts表的userId字段作为外键，引用users表的id主键，确保每篇文章都对应一个存在的用户（posts.userId = users.id）。若尝试插入不存在的userId值，数据库会直接拒绝该操作，避免数据孤立。</li>
<li><strong>删除/更新策略</strong>：在定义外键时，需指定ON DELETE与ON UPDATE策略，控制主表数据变更时从表的行为。常用策略为ON DELETE CASCADE（主表记录删除时，从表关联记录同步删除），如删除用户时，同步删除该用户发布的所有文章，避免残留无效数据。</li>
<li><strong>实操注意</strong>：外键字段类型必须与引用的主键字段类型完全一致（如均为BIGINT），否则会导致约束创建失败。同时，外键会引入一定的性能开销，需避免过度使用，仅在必要的表间关联中设置。</li>
</ul>
<h3 data-id="heading-7">2.4 普通索引（Key）</h3>
<p>普通索引仅用于提升查询效率，无数据完整性约束作用。其设计需基于业务查询场景，避免盲目创建——过多的索引会增加数据插入、更新、删除的开销（每次数据变更需同步维护索引）。</p>
<p>设计原则：仅对查询频繁的字段创建普通索引，如文章系统中若经常根据title查询文章，可对posts表的title字段创建普通索引；对于更新频繁但查询较少的字段，应避免创建索引。在PostgreSQL中，可通过CREATE INDEX语句创建普通索引，语法为：CREATE INDEX idx_posts_title ON posts(title);</p>
<h2 data-id="heading-8">三、文章系统表结构设计实操</h2>
<p>文章系统是典型的多表关联场景，需设计用户、文章、评论、点赞、标签、收藏等核心表，通过外键建立关联，实现完整的业务逻辑。结合PostgreSQL特性，以下为各表设计思路与实操SQL。</p>
<h3 data-id="heading-9">3.1 核心表结构设计</h3>
<p>文章系统的核心业务逻辑围绕“用户发布文章、评论文章、点赞收藏文章、给文章打标签”展开，需设计6张核心表，各表职责与关联关系如下：</p>
<ul>
<li><strong>用户表（users）</strong> ：存储用户核心信息，作为基础表被其他表引用，主键为id。</li>
<li><strong>文章表（posts）</strong> ：存储文章内容，通过userId外键关联users表，主键为id。</li>
<li><strong>评论表（comments）</strong> ：存储用户对文章的评论，通过userId关联users表、postId关联posts表，主键为id。</li>
<li><strong>点赞表（likes）</strong> ：存储用户对文章/评论的点赞记录，通过userId、关联id（postId/commentId）建立关联，需设置联合唯一索引避免重复点赞。</li>
<li><strong>标签表（tags）</strong> ：存储文章标签信息，主键为id；同时需设计标签关联表（post_tags），实现文章与标签的多对多关联（一篇文章可多个标签，一个标签可对应多篇文章）。</li>
<li><strong>收藏表（favorites）</strong> ：存储用户收藏文章的记录，通过userId关联users表、postId关联posts表，设置联合唯一索引避免重复收藏。</li>
</ul>
<h3 data-id="heading-10">3.2 建表SQL实操（PostgreSQL）</h3>
<p>结合前文约束与索引设计原则，以下为文章系统各核心表的建表SQL，包含审计字段、约束与索引设计，适配生产级场景需求。</p>
<h4 data-id="heading-11">3.2.1 用户表（users）</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> GENERATED <span class="hljs-keyword">BY</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">IDENTITY</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>, <span class="hljs-comment">-- 用户名唯一且非空</span>
    password <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- 存储加密后的密码</span>
    created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>, <span class="hljs-comment">-- 创建时间（带时区）</span>
    updated_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-comment">-- 更新时间（带时区）</span>
);
<span class="hljs-comment">-- 为updated_at字段添加自动更新触发器（生产级必备）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">FUNCTION</span> update_modified_column()
<span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TRIGGER</span> <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
    NEW.updated_at <span class="hljs-operator">=</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>;
    <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">NEW</span>;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> trigger_update_users_updated_at
BEFORE <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> users
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-type">ROW</span>
<span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">FUNCTION</span> update_modified_column();
</code></pre>
<p>说明：添加created_at与updated_at审计字段，记录数据创建与更新时间，便于数据追溯；通过触发器实现updated_at字段自动更新，无需手动维护。密码字段设为VARCHAR(255)，适配bcrypt等哈希加密算法的结果存储（加密后密码长度通常不超过100，预留足够空间避免截断）。</p>
<h4 data-id="heading-12">3.2.2 文章表（posts）</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> posts (
    id <span class="hljs-type">BIGINT</span> GENERATED <span class="hljs-keyword">BY</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">IDENTITY</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- 文章标题非空，长度限制255字符</span>
    content TEXT, <span class="hljs-comment">-- 长文本存储文章内容，无长度限制</span>
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- 关联用户表的外键字段（统一小写命名规范）</span>
    created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-comment">-- 外键约束，关联users表主键</span>
    <span class="hljs-keyword">CONSTRAINT</span> fk_posts_user <span class="hljs-keyword">FOREIGN</span> KEY (user_id) <span class="hljs-keyword">REFERENCES</span> users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
    <span class="hljs-comment">-- 为查询频繁字段创建普通索引</span>
    <span class="hljs-keyword">CONSTRAINT</span> idx_posts_user_id <span class="hljs-keyword">FOREIGN</span> KEY (user_id) <span class="hljs-keyword">REFERENCES</span> users(id)
);
<span class="hljs-comment">-- 为updated_at添加自动更新触发器</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> trigger_update_posts_updated_at
BEFORE <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> posts
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-type">ROW</span>
<span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">FUNCTION</span> update_modified_column();
<span class="hljs-comment">-- 为title字段创建普通索引，优化按标题查询的效率</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_posts_title <span class="hljs-keyword">ON</span> posts(title);
</code></pre>
<p>说明：采用小写字段名（user_id）符合数据库命名规范，避免大小写敏感问题；content字段使用TEXT类型，支持无限长度文本存储，适配长文场景；通过ON DELETE CASCADE策略，确保用户删除时同步清理其发布的文章。</p>
<h4 data-id="heading-13">3.2.3 其他核心表建表SQL</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 评论表（comments）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> comments (
    id <span class="hljs-type">BIGINT</span> GENERATED <span class="hljs-keyword">BY</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">IDENTITY</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    content <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">1000</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- 评论内容，限制1000字符</span>
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    post_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    updated_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">CONSTRAINT</span> fk_comments_user <span class="hljs-keyword">FOREIGN</span> KEY (user_id) <span class="hljs-keyword">REFERENCES</span> users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
    <span class="hljs-keyword">CONSTRAINT</span> fk_comments_post <span class="hljs-keyword">FOREIGN</span> KEY (post_id) <span class="hljs-keyword">REFERENCES</span> posts(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE
);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TRIGGER</span> trigger_update_comments_updated_at
BEFORE <span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">ON</span> comments
<span class="hljs-keyword">FOR</span> <span class="hljs-keyword">EACH</span> <span class="hljs-type">ROW</span>
<span class="hljs-keyword">EXECUTE</span> <span class="hljs-keyword">FUNCTION</span> update_modified_column();

<span class="hljs-comment">-- 点赞表（likes）：支持文章与评论点赞，用type区分</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> likes (
    id <span class="hljs-type">BIGINT</span> GENERATED <span class="hljs-keyword">BY</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">IDENTITY</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    target_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- 关联文章/评论的ID</span>
    target_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- 类型：post（文章）、comment（评论）</span>
    created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">CONSTRAINT</span> fk_likes_user <span class="hljs-keyword">FOREIGN</span> KEY (user_id) <span class="hljs-keyword">REFERENCES</span> users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
    <span class="hljs-comment">-- 联合唯一索引，避免同一用户对同一目标重复点赞</span>
    <span class="hljs-keyword">CONSTRAINT</span> uk_likes_user_target <span class="hljs-keyword">UNIQUE</span> (user_id, target_id, target_type)
);

<span class="hljs-comment">-- 标签表（tags）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tags (
    id <span class="hljs-type">BIGINT</span> GENERATED <span class="hljs-keyword">BY</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">IDENTITY</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>, <span class="hljs-comment">-- 标签名唯一</span>
    created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 文章-标签关联表（post_tags）：实现多对多关联</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> post_tags (
    post_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    tag_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (post_id, tag_id), <span class="hljs-comment">-- 联合主键，避免重复关联</span>
    <span class="hljs-keyword">CONSTRAINT</span> fk_post_tags_post <span class="hljs-keyword">FOREIGN</span> KEY (post_id) <span class="hljs-keyword">REFERENCES</span> posts(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
    <span class="hljs-keyword">CONSTRAINT</span> fk_post_tags_tag <span class="hljs-keyword">FOREIGN</span> KEY (tag_id) <span class="hljs-keyword">REFERENCES</span> tags(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE
);

<span class="hljs-comment">-- 收藏表（favorites）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> favorites (
    id <span class="hljs-type">BIGINT</span> GENERATED <span class="hljs-keyword">BY</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">AS</span> <span class="hljs-keyword">IDENTITY</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    post_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    created_at TIMESTAMPTZ <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">CONSTRAINT</span> fk_favorites_user <span class="hljs-keyword">FOREIGN</span> KEY (user_id) <span class="hljs-keyword">REFERENCES</span> users(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
    <span class="hljs-keyword">CONSTRAINT</span> fk_favorites_post <span class="hljs-keyword">FOREIGN</span> KEY (post_id) <span class="hljs-keyword">REFERENCES</span> posts(id) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE,
    <span class="hljs-comment">-- 联合唯一索引，避免重复收藏</span>
    <span class="hljs-keyword">CONSTRAINT</span> uk_favorites_user_post <span class="hljs-keyword">UNIQUE</span> (user_id, post_id)
);
</code></pre>
<h3 data-id="heading-14">3.3 初始化数据（Seeds）</h3>
<p>建表完成后，需插入测试数据验证表结构与关联逻辑的正确性。以下为users表与posts表的初始化SQL，包含加密后的密码（示例密码加密算法为bcrypt，明文均为123456）。</p>
<pre><code class="hljs language-dart" lang="dart">-- 用户表初始化数据
INSERT INTO <span class="hljs-string">"users"</span> (<span class="hljs-string">"name"</span>, <span class="hljs-string">"password"</span>) VALUES
  (<span class="hljs-string">'王皓'</span>, <span class="hljs-string">'<span class="hljs-subst">$2b</span><span class="hljs-subst">$10</span><span class="hljs-subst">$CsO</span>/ykedPpuxqUETBZTYm.F2U4TXDdo01rLmoRPwjKBv3pIL5pnWq'</span>),
  (<span class="hljs-string">'小雪'</span>, <span class="hljs-string">'<span class="hljs-subst">$2b</span><span class="hljs-subst">$10</span><span class="hljs-subst">$CsO</span>/ykedPpuxqUETBZTYm.F2U4TXDdo01rLmoRPwjKBv3pIL5pnWq'</span>),
  (<span class="hljs-string">'李白'</span>, <span class="hljs-string">'<span class="hljs-subst">$2b</span><span class="hljs-subst">$10</span><span class="hljs-subst">$CsO</span>/ykedPpuxqUETBZTYm.F2U4TXDdo01rLmoRPwjKBv3pIL5pnWq'</span>),
  (<span class="hljs-string">'杜甫'</span>, <span class="hljs-string">'<span class="hljs-subst">$2b</span><span class="hljs-subst">$10</span><span class="hljs-subst">$CsO</span>/ykedPpuxqUETBZTYm.F2U4TXDdo01rLmoRPwjKBv3pIL5pnWq'</span>),
  (<span class="hljs-string">'白居易'</span>, <span class="hljs-string">'<span class="hljs-subst">$2b</span><span class="hljs-subst">$10</span><span class="hljs-subst">$CsO</span>/ykedPpuxqUETBZTYm.F2U4TXDdo01rLmoRPwjKBv3pIL5pnWq'</span>),
  (<span class="hljs-string">'张三'</span>, <span class="hljs-string">'<span class="hljs-subst">$2b</span><span class="hljs-subst">$10</span><span class="hljs-subst">$CsO</span>/ykedPpuxqUETBZTYm.F2U4TXDdo01rLmoRPwjKBv3pIL5pnWq'</span>);

-- 文章表初始化数据
INSERT INTO <span class="hljs-string">"posts"</span> (<span class="hljs-string">"title"</span>, <span class="hljs-string">"content"</span>, <span class="hljs-string">"user_id"</span>) VALUES 
(<span class="hljs-string">'黄鹤楼送孟浩然之广陵'</span>, <span class="hljs-string">'故人西辞黄鹤楼，烟花三月下扬州。孤帆远影碧空尽，唯见长江天际流。'</span>, <span class="hljs-number">3</span>),
(<span class="hljs-string">'春夜喜雨'</span>, <span class="hljs-string">'好雨知时节，当春乃发生。随风潜入夜，润物细无声。野径云俱黑，江船火独明。晓看红湿处，花重锦官城。'</span>, <span class="hljs-number">4</span>),
(<span class="hljs-string">'琵琶行'</span>, <span class="hljs-string">'浔阳江头夜送客，枫叶荻花秋瑟瑟。主人下马客在船，举酒欲饮无管弦。醉不成欢惨将别，别时茫茫江浸月。'</span>, <span class="hljs-number">5</span>),
(<span class="hljs-string">'静夜思'</span>, <span class="hljs-string">'床前明月光，疑是地上霜。举头望明月，低头思故乡。'</span>, <span class="hljs-number">3</span>),
(<span class="hljs-string">'望岳'</span>, <span class="hljs-string">'岱宗夫如何？齐鲁青未了。造化钟神秀，阴阳割昏晓。荡胸生曾云，决眦入归鸟。会当凌绝顶，一览众山小。'</span>, <span class="hljs-number">4</span>),
(<span class="hljs-string">'浪淘沙'</span>, <span class="hljs-string">'白浪茫茫与海连，平沙浩浩四无边。暮去朝来淘不住，遂令东海变桑田。'</span>, <span class="hljs-number">5</span>),
(<span class="hljs-string">'将进酒'</span>, <span class="hljs-string">'君不见黄河之水天上来，奔流到海不复回。君不见高堂明镜悲白发，朝如青丝暮成雪。'</span>, <span class="hljs-number">3</span>),
(<span class="hljs-string">'天末怀李白'</span>, <span class="hljs-string">'凉风起天末，君子意如何？鸿雁几时到？江湖秋水多。文章憎命达，魑魅喜人过。应共冤魂语，投诗赠汨罗。'</span>, <span class="hljs-number">4</span>),
(<span class="hljs-string">'花非花'</span>, <span class="hljs-string">'花非花，雾非雾，夜半来，天明去。来如春梦几多时？去似朝云无觅处。'</span>, <span class="hljs-number">5</span>),
(<span class="hljs-string">'望庐山瀑布'</span>, <span class="hljs-string">'日照香炉生紫烟，遥看瀑布挂前川。飞流直下三千尺，疑是银河落九天。'</span>, <span class="hljs-number">3</span>),
(<span class="hljs-string">'绝句二首'</span>, <span class="hljs-string">'迟日江山丽，春风花草香。泥融飞燕子，沙暖睡鸳鸯。'</span>, <span class="hljs-number">4</span>),
(<span class="hljs-string">'秋思'</span>, <span class="hljs-string">'夕照红于烧，晴空碧胜蓝。兽形云不一，弓势月初三。雁思来天北，砧愁满水南。萧条秋气味，未老已深谙。'</span>, <span class="hljs-number">5</span>),
(<span class="hljs-string">'早发白帝城'</span>, <span class="hljs-string">'朝辞白帝彩云间，千里江陵一日还。两岸猿声啼不住，轻舟已过万重山。'</span>, <span class="hljs-number">3</span>),
(<span class="hljs-string">'龙门镇'</span>, <span class="hljs-string">'细泉兼轻冰，沮洳栈道湿。不辞辛苦行，迫此短景急。石门雪云隘，古镇峰峦集。旌竿暮惨澹，风水白刃涩。'</span>, <span class="hljs-number">4</span>),
(<span class="hljs-string">'采莲曲'</span>, <span class="hljs-string">'菱叶萦波荷飐风，荷花深处小船通。逢郎欲语低头笑，碧玉搔头落水中。'</span>, <span class="hljs-number">5</span>),
(<span class="hljs-string">'独坐敬亭山'</span>, <span class="hljs-string">'众鸟高飞尽，孤云独去闲。相看两不厌，只有敬亭山。'</span>, <span class="hljs-number">3</span>),
(<span class="hljs-string">'三绝句'</span>, <span class="hljs-string">'楸树馨香倚钓矶，斩新花蕊未应飞。不如醉里风吹尽，可忍醒时雨打稀。'</span>, <span class="hljs-number">4</span>),
(<span class="hljs-string">'江南春'</span>, <span class="hljs-string">'青门柳枝软无力，东风吹作黄金色。街前酒薄醉易醒，满眼春愁消不得。'</span>, <span class="hljs-number">5</span>),
(<span class="hljs-string">'白云泉'</span>, <span class="hljs-string">'天平山上白云泉，云自无心水自闲。何必奔冲山下去，更添波浪向人间。'</span>, <span class="hljs-number">5</span>),
(<span class="hljs-string">'叶子的肖像'</span>, <span class="hljs-string">'叶子的肖像，每张都不一样。脉络里藏着阳光，边缘染着风霜。'</span>, <span class="hljs-number">1</span>),
(<span class="hljs-string">'月下独酌'</span>, <span class="hljs-string">'花间一壶酒，独酌无相亲。举杯邀明月，对影成三人。月既不解饮，影徒随我身。'</span>, <span class="hljs-number">3</span>),
(<span class="hljs-string">'登楼'</span>, <span class="hljs-string">'花近高楼伤客心，万方多难此登临。锦江春色来天地，玉垒浮云变古今。'</span>, <span class="hljs-number">4</span>),
(<span class="hljs-string">'大明湖的荷花'</span>, <span class="hljs-string">'大明湖里没青蛙，大明湖里有荷花。清风拂过香满袖，落日余晖映碧霞。'</span>, <span class="hljs-number">1</span>),
(<span class="hljs-string">'关山月'</span>, <span class="hljs-string">'明月出天山，苍茫云海间。长风几万里，吹度玉门关。汉下白登道，胡窥青海湾。'</span>, <span class="hljs-number">3</span>);
</code></pre>
<p>说明：插入数据时，若主键采用自增机制，无需手动指定id字段，数据库会自动分配唯一自增值；外键字段需对应主表已存在的主键值，否则插入失败，可通过该特性验证外键约束有效性。</p>
<h2 data-id="heading-15">四、PostgreSQL关联查询（JOIN）详解</h2>
<p>关联查询是多表场景下的核心查询方式，通过JOIN语句组合多张表的数据，根据表间关联关系筛选出目标结果。PostgreSQL支持左连接、右连接、内连接、外连接四种常用关联方式，适用于不同业务查询需求。</p>
<h3 data-id="heading-16">4.1 左连接（LEFT JOIN）</h3>
<p>左连接以左表为基准，展示左表所有数据，同时匹配右表中符合条件的数据；若右表无匹配数据，对应字段填充为NULL。</p>
<p>应用场景：查询所有用户及其发布的文章，包括未发布文章的用户。SQL示例：</p>
<pre><code class="hljs language-css" lang="css">SELECT u<span class="hljs-selector-class">.name</span>, <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.title</span> 
<span class="hljs-selector-tag">FROM</span> users u
<span class="hljs-attribute">LEFT</span> JOIN posts <span class="hljs-selector-tag">p</span> ON u<span class="hljs-selector-class">.id</span> = <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.user_id</span>
<span class="hljs-attribute">ORDER</span> BY u<span class="hljs-selector-class">.id</span>;
</code></pre>
<p>结果说明：左表为users，右表为posts，查询结果中会包含“张三”“小雪”等未发布文章的用户，其title字段值为NULL。</p>
<h3 data-id="heading-17">4.2 右连接（RIGHT JOIN）</h3>
<p>右连接以右表为基准，展示右表所有数据，同时匹配左表中符合条件的数据；若左表无匹配数据，对应字段填充为NULL。</p>
<p>应用场景：查询所有文章及其作者信息，若存在异常文章（无对应用户，理论上因外键约束不存在此类数据），仍可展示文章内容。SQL示例：</p>
<pre><code class="hljs language-css" lang="css">SELECT <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.title</span>, u<span class="hljs-selector-class">.name</span> 
<span class="hljs-selector-tag">FROM</span> users u
<span class="hljs-attribute">RIGHT</span> JOIN posts <span class="hljs-selector-tag">p</span> ON u<span class="hljs-selector-class">.id</span> = <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.user_id</span>
<span class="hljs-attribute">ORDER</span> BY <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.id</span>;
</code></pre>
<p>结果说明：右表为posts，左表为users，因外键约束确保每篇文章都有对应用户，故结果与内连接一致；若移除外键约束并插入无效user_id的文章，该文章会被展示，name字段为NULL。</p>
<h3 data-id="heading-18">4.3 内连接（INNER JOIN）</h3>
<p>内连接仅展示左表与右表中匹配的数据，无匹配的数据均不展示，是实际业务中最常用的关联方式。</p>
<p>应用场景：查询已发布文章的用户及其文章信息，过滤未发布文章的用户与无对应作者的文章。SQL示例：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> u.name, p.title, p.created_at 
<span class="hljs-keyword">FROM</span> users u
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> posts p <span class="hljs-keyword">ON</span> u.id <span class="hljs-operator">=</span> p.user_id
<span class="hljs-keyword">WHERE</span> u.name <span class="hljs-operator">=</span> <span class="hljs-string">'李白'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> p.created_at <span class="hljs-keyword">DESC</span>;
</code></pre>
<p>结果说明：仅展示李白发布的所有文章，按创建时间倒序排列，无匹配数据的记录被过滤。</p>
<h3 data-id="heading-19">4.4 外连接（FULL OUTER JOIN）</h3>
<p>外连接展示左表与右表的所有数据，两表中无匹配的数据对应字段均填充为NULL，相当于左连接与右连接的合集。</p>
<p>应用场景：查询所有用户与所有文章，包括未发布文章的用户和无对应作者的文章（理论上极少使用，因外键约束避免此类数据）。SQL示例：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> u.name, p.title 
<span class="hljs-keyword">FROM</span> users u
<span class="hljs-keyword">FULL</span> <span class="hljs-keyword">OUTER</span> <span class="hljs-keyword">JOIN</span> posts p <span class="hljs-keyword">ON</span> u.id <span class="hljs-operator">=</span> p.user_id;
</code></pre>
<h3 data-id="heading-20">4.5 关联查询优化建议</h3>
<ul>
<li>关联字段必须建立索引（主键、外键默认已建索引），避免全表扫描导致的性能问题。</li>
<li>尽量减少关联表数量，多表关联会大幅增加查询开销，必要时可通过冗余字段或缓存优化。</li>
<li>使用表别名（如u代表users，p代表posts）简化SQL语句，提升可读性。</li>
</ul>
<h2 data-id="heading-21">五、ACID事务特性详解</h2>
<p>事务（Transaction）是数据库操作的最小不可分割单位，通过ACID特性确保复杂操作的一致性与可靠性。在转账、订单创建等场景中，事务是避免数据异常的核心保障。</p>
<h3 data-id="heading-22">5.1 原子性（Atomicity）</h3>
<p>原子性指事务中的所有操作要么全部成功执行，要么全部失败回滚，无部分执行的中间状态。如同“要么全做，要么全不做”，确保数据不会因部分操作失败导致异常。</p>
<p>示例：转账业务中，“扣除用户A账户100元”与“增加用户B账户100元”构成一个事务。若扣除A账户金额成功，但增加B账户金额失败，事务会自动回滚，恢复A账户的100元，避免出现“钱扣了但没到账”的异常。</p>
<p>PostgreSQL中，通过BEGIN开启事务，COMMIT提交事务，ROLLBACK手动回滚事务，确保原子性。</p>
<h3 data-id="heading-23">5.2 一致性（Consistency）</h3>
<p>一致性指事务执行前后，数据库从一个一致状态转换到另一个一致状态，数据完整性约束不被破坏。</p>
<p>示例：转账事务执行前，A与B账户总金额为2000元；事务执行后（A扣100，B加100），总金额仍为2000元，保持数据一致性。若事务执行过程中出现异常回滚，总金额也不会发生变化，确保约束条件不被破坏。</p>
<p>一致性依赖于数据库的约束机制（主键、外键、唯一索引等）与业务逻辑设计，是事务的核心目标。</p>
<h3 data-id="heading-24">5.3 隔离性（Isolation）</h3>
<p>隔离性指多个事务并发执行时，每个事务都感觉不到其他事务的存在，事务之间互不干扰，避免并发操作导致的数据异常。</p>
<p>示例：用户A向B转账的同时，B向C转账，两个事务并发执行。隔离性确保A-B转账事务不会读取到B-C转账事务的中间状态（如B账户已扣除但C账户未增加的状态），避免数据计算错误。</p>
<p>PostgreSQL支持四种事务隔离级别（读未提交、读已提交、可重复读、串行化），默认隔离级别为“读已提交”，可根据业务需求调整，平衡一致性与并发性能。</p>
<h3 data-id="heading-25">5.4 持久性（Durability）</h3>
<p>持久性指事务一旦提交，对数据库的修改会永久保存，即使发生系统崩溃、断电等故障，数据也不会丢失。</p>
<p>示例：转账事务提交后，A与B账户的金额变更会被永久写入数据库，即使此时系统突然断电，重启后数据仍保持提交后的状态。PostgreSQL通过写前日志（WAL）机制实现持久性，事务提交时先将修改写入WAL日志，再同步到数据文件，确保故障后可通过日志恢复数据。</p>
<h3 data-id="heading-26">5.5 事务实操示例（PostgreSQL）</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 开启事务</span>
<span class="hljs-keyword">BEGIN</span>;
<span class="hljs-comment">-- 扣除A账户100元（假设A的id为1，账户余额字段为balance）</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">-</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-comment">-- 增加B账户100元（B的id为2）</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> balance <span class="hljs-operator">=</span> balance <span class="hljs-operator">+</span> <span class="hljs-number">100</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-comment">-- 提交事务（无异常时执行）</span>
<span class="hljs-keyword">COMMIT</span>;
<span class="hljs-comment">-- 若出现异常，执行回滚</span>
<span class="hljs-comment">-- ROLLBACK;</span>
</code></pre>
<h2 data-id="heading-27">六、PostgreSQL基础操作指令</h2>
<p>熟练掌握PostgreSQL命令行操作，是数据库设计与维护的基础。以下为常用基础操作指令，适配前文实操场景。</p>
<h3 data-id="heading-28">6.1 数据库管理</h3>
<ul>
<li>列出所有数据库：\list 或 \l</li>
<li>创建数据库：CREATE DATABASE xuebi WITH OWNER=postgres ENCODING='UTF8';（指定所有者为postgres，编码为UTF8，避免中文乱码）</li>
<li>进入数据库：\c xuebi（切换至xuebi数据库）</li>
<li>删除数据库：DROP DATABASE IF EXISTS xuebi;（IF EXISTS避免数据库不存在时报错）</li>
</ul>
<h3 data-id="heading-29">6.2 表管理</h3>
<ul>
<li>查看所有表：\dt;（仅显示当前数据库中的表）</li>
<li>查看表结构：\d 表名;（如\d posts;，展示表字段、类型、约束、索引等信息）</li>
<li>删除表：DROP TABLE IF EXISTS posts;（删除表时，若存在外键关联，需先删除引用该表的外键约束或表）</li>
<li>修改表结构：ALTER TABLE 表名 操作;（如ALTER TABLE users ADD COLUMN balance INT DEFAULT 0;为用户表添加余额字段）</li>
</ul>
<h3 data-id="heading-30">6.3 数据查询与操作</h3>
<ul>
<li>查询数据：SELECT 字段名 FROM 表名 WHERE 条件;（支持排序、分组、关联查询等）</li>
<li>插入数据：INSERT INTO 表名 (字段1, 字段2) VALUES (值1, 值2);（字段顺序需与值顺序一致）</li>
<li>更新数据：UPDATE 表名 SET 字段=值 WHERE 条件;（务必添加WHERE条件，否则更新全表数据）</li>
<li>删除数据：DELETE FROM 表名 WHERE 条件;（同样需添加WHERE条件，避免误删全表数据）</li>
</ul>
<h2 data-id="heading-31">七、学习总结与实践感悟</h2>
<p>本次学习围绕PostgreSQL数据库设计展开，从基础概念、约束索引、表结构设计、关联查询到事务机制，结合文章系统实操案例，构建了完整的数据库设计知识体系。关系型数据库的核心价值在于结构化存储与数据一致性保障，而PostgreSQL的强大特性的则为这些价值提供了坚实支撑。</p>
<p>在实操过程中，深刻认识到以下几点关键原则：一是约束设计要精准，主键、外键、唯一索引的合理运用是数据完整性的核心，过度或缺失约束都会导致问题；二是索引设计要适配业务，避免盲目创建索引，平衡查询效率与数据变更开销；三是事务机制要熟练运用，尤其是在并发场景中，通过ACID特性避免数据异常；四是命名与规范要统一，小写字段名、清晰的表别名、完整的审计字段，能大幅提升代码可读性与可维护性。</p>
<p>数据库设计并非一成不变，需结合业务场景动态优化。例如，随着文章系统用户量增长，可对大表进行分表处理，优化查询性能；针对高频查询场景，可通过缓存减少数据库压力。后续需进一步深入学习PostgreSQL的高级特性（如分区表、触发器、存储过程），结合实际业务场景不断实践，提升数据库设计与优化能力，为后端系统构建高效、可靠的数据支撑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 8.5 闭包和一等可调用对象进入常量表达式]]></title>    <link>https://juejin.cn/post/7595842144906051634</link>    <guid>https://juejin.cn/post/7595842144906051634</guid>    <pubDate>2026-01-17T00:08:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595842144906051634" data-draft-id="7595683968684785710" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 8.5 闭包和一等可调用对象进入常量表达式"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-01-17T00:08:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 8.5 闭包和一等可调用对象进入常量表达式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T00:08:26.000Z" title="Sat Jan 17 2026 00:08:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 8.5 闭包和一等可调用对象进入常量表达式</h2>
<h3 data-id="heading-1">当"配置"变成运行时胶水代码</h3>
<p>PHP 配置一直有个矛盾：</p>
<ul>
<li>你想要声明式配置：简单的数组、常量值、属性。</li>
<li>但你也需要一点逻辑："验证这个字段"、"选择这个处理器"、"格式化这个值"、"过滤这个列表"。</li>
</ul>
<p>以前，一旦你需要在"配置类"的地方加逻辑，就会碰壁。PHP 故意把很多结构限制在常量表达式——基本上就是不可变的值。属性参数是最明显的例子：你可以放整数、字符串、标量数组……但不能放闭包。</p>
<p>所以我们用各种变通方案：</p>
<ul>
<li>存字符串如 <code>"App\\Handler::handle"</code>，然后用 <code>call_user_func</code> 调用。</li>
<li>在属性里用"迷你语言"，比如表达式字符串。</li>
<li>用可空回调，在运行时设置默认值。</li>
<li>在引导文件里建注册表，而不是直接在该放的地方表达。</li>
</ul>
<p>PHP 8.5 改变了这个局面：静态闭包和一等可调用对象现在可以出现在常量表达式中，包括：</p>
<ul>
<li>属性参数</li>
<li>属性和参数的默认值</li>
<li>常量和类常量</li>
</ul>
<p>这听起来像编译器特性。实际上是个"生活质量"升级：让你把配置放在它配置的代码旁边，不用魔术字符串或运行时初始化 hack。</p>
<p>这篇文章会讲"为什么"、具体规则（有重要限制），然后深入实际模式：路由映射、处理器注册表、策略/格式化器注册表。也会讲哪些场景不适合——因为如果不小心，可调用配置确实能搞出一团乱。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fphp85-closures-callables-constant-expressions" target="_blank" title="https://catchadmin.com/post/2026-01/php85-closures-callables-constant-expressions" ref="nofollow noopener noreferrer">原文 PHP 8.5 闭包和一等可调用对象进入常量表达式</a></p>
<h3 data-id="heading-2">旧痛点：常量太受限，逻辑只能塞进运行时初始化</h3>
<p>PHP 8.5 之前，限制不是你不能创建闭包——而是你不能在某些"配置槽"里用它们。</p>
<p>三个常见痛点：</p>
<h4 data-id="heading-3">痛点 A："回调默认值"参数强制运行时初始化</h4>
<p>如果你想写一个接受可选回调的函数，并且想要一个合理的默认回调，通常这样做：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">my_filter</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$items</span>, ?<span class="hljs-built_in">Closure</span> <span class="hljs-variable">$predicate</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-title">array</span>
</span>{
    <span class="hljs-variable">$predicate</span> ??= <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable">$v</span></span>): <span class="hljs-title">bool</span> </span>{ <span class="hljs-keyword">return</span> !<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$v</span>); };
    <span class="hljs-variable">$out</span> = [];
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$items</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$item</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$predicate</span>(<span class="hljs-variable">$item</span>)) {
            <span class="hljs-variable">$out</span>[] = <span class="hljs-variable">$item</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;
}
</code></pre>
<p>这能用……但是样板代码，而且不是"声明式"的。</p>
<p>PHP 8.5 的 RFC 明确提到这个用例：允许直接声明默认回调闭包，不用可空参数的变通方案。</p>
<h4 data-id="heading-4">痛点 B：属性参数不能包含真正的逻辑</h4>
<p>属性是表达规则的自然场所：</p>
<ul>
<li>授权检查</li>
<li>验证</li>
<li>序列化行为</li>
<li>测试用例生成</li>
</ul>
<p>但属性参数只能是常量表达式，所以人们用字符串或表达式对象。</p>
<p>PHP 8.5 发布公告展示了一个典型的"之前"模式，访问控制属性接受字符串表达式。在 PHP 8.5 中你可以直接传静态闭包。</p>
<h4 data-id="heading-5">痛点 C：注册表和路由映射变成运行时引导</h4>
<p>任何时候你想要从"键"到"处理器"的映射，你可能在运行时构建它：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$handlers</span> = [
    <span class="hljs-string">'json'</span> =&gt; [<span class="hljs-title class_">JsonFormatter</span>::<span class="hljs-variable language_">class</span>, <span class="hljs-string">'format'</span>],
    <span class="hljs-string">'text'</span> =&gt; [<span class="hljs-title class_">TextFormatter</span>::<span class="hljs-variable language_">class</span>, <span class="hljs-string">'format'</span>],
];
</code></pre>
<p>这能用，但很脆弱：</p>
<ul>
<li>IDE 重命名重构不能可靠地跟踪字符串方法名。</li>
<li>静态分析更难理解什么是可调用的。</li>
<li>你需要运行时代码来组装概念上是静态配置的东西。</li>
</ul>
<p>PHP 8.5 的常量表达式改进让你可以把这些注册表表达为常量——并且让处理器重构安全。</p>
<h3 data-id="heading-6">什么是常量表达式，为什么重要</h3>
<p>"常量表达式"是 PHP 内部术语，指在必须不依赖运行时状态就能计算的上下文中允许的表达式——可以理解为"不可变值"。</p>
<p>这些上下文包括：</p>
<ul>
<li>属性参数</li>
<li>参数和属性的默认值</li>
<li>（类）常量</li>
</ul>
<p>闭包 RFC 总结旧规则为：常量表达式被限制在实际上是"不可变值"的操作，闭包不包括在内——尽管闭包本质上是编译后的代码（操作码），在约束下可以被视为不可变。</p>
<p>为什么这很重要？</p>
<p>因为这些上下文是你想放配置的地方：</p>
<ul>
<li>属性是你的元数据/配置层。</li>
<li>默认参数/属性值表达预期行为，不需要样板代码。</li>
<li>常量表达"这个映射不会变"。</li>
</ul>
<p>换句话说：常量表达式是 PHP 引导你走向声明式代码的地方。PHP 8.5 扩展了"声明式"的含义。</p>
<h3 data-id="heading-7">常量中的闭包：安全可读的模式（和硬性规则）</h3>
<p>PHP 8.5 允许常量表达式中的闭包——但有严格约束：</p>
<ul>
<li>必须是静态的（没有 <code>$this</code>）。</li>
<li>不能通过 <code>use(...)</code> 捕获外部变量。</li>
<li>箭头函数在常量表达式中不支持，因为它们隐式捕获变量。</li>
</ul>
<p>这些规则是编译时强制的。</p>
<p>这听起来有限制，但实际上这正是这个特性安全的原因：它防止意外把"运行时状态"偷渡进常量。</p>
<h4 data-id="heading-8">默认回调参数，不需要可空样板</h4>
<p>这是之前过滤器示例的干净 PHP 8.5 版本：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">my_filter</span>(<span class="hljs-params">
    <span class="hljs-keyword">array</span> <span class="hljs-variable">$items</span>,
    <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$predicate</span> = <span class="hljs-built_in">static</span> function (<span class="hljs-params"><span class="hljs-variable">$v</span></span>): <span class="hljs-keyword">bool</span> { <span class="hljs-keyword">return</span> !<span class="hljs-keyword">empty</span>(<span class="hljs-params"><span class="hljs-variable">$v</span></span>); },
</span>): <span class="hljs-title">array</span> </span>{
    <span class="hljs-variable">$out</span> = [];
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$items</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$item</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$predicate</span>(<span class="hljs-variable">$item</span>)) {
            <span class="hljs-variable">$out</span>[] = <span class="hljs-variable">$item</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$out</span>;
}
</code></pre>
<p>这正是闭包 RFC 强调的动机：你可以声明一个真正的默认回调，不需要"可空 + 运行时默认"。</p>
<p>实际上，这也改善了工具支持：</p>
<ul>
<li>参数正确地类型化为 <code>Closure</code>，不是 <code>?Closure</code></li>
<li>调用者不需要猜测 <code>null</code> 是否有特殊含义</li>
<li>你去掉了一个分支和一行初始化噪音</li>
</ul>
<h4 data-id="heading-9">包含可调用行为的类常量</h4>
<p>你可以在常量或类常量中存储闭包，把它们当作"可调用配置"。</p>
<p>一个简单例子：格式化器注册表。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Formatters</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAP</span> = [
        <span class="hljs-string">'trim_lower'</span> =&gt; <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$s</span></span>): <span class="hljs-title">string</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$s</span>));
        },
        <span class="hljs-string">'digits_only'</span> =&gt; <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$s</span></span>): <span class="hljs-title">string</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">'/\D+/'</span>, <span class="hljs-string">''</span>, <span class="hljs-variable">$s</span>) ?? <span class="hljs-string">''</span>;
        },
    ];
}
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$input</span> = <span class="hljs-string">"  +62 (812) 345-678  "</span>;
<span class="hljs-variable">$normalized</span> = (<span class="hljs-title class_">Formatters</span>::<span class="hljs-variable constant_">MAP</span>[<span class="hljs-string">'digits_only'</span>])(<span class="hljs-variable">$input</span>);
</code></pre>
<p>这读起来像配置，但不是"字符串类型"。它是真正的 PHP，编译过的，有类型的，可重构的。</p>
<h4 data-id="heading-10">属性默认值：可调用行为作为默认策略</h4>
<p>因为常量表达式中的闭包可以用作属性默认值，你可以在属性声明处定义默认策略——同样不需要运行时初始化。</p>
<p>例子：可配置的规范化器。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Normalizer</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">Closure</span> <span class="hljs-variable">$normalize</span> = <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$s</span></span>): <span class="hljs-title">string</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">trim</span>(<span class="hljs-variable">$s</span>);
    };

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$value</span></span>): <span class="hljs-title">string</span>
    </span>{
        <span class="hljs-keyword">return</span> (<span class="hljs-variable language_">$this</span>-&gt;normalize)(<span class="hljs-variable">$value</span>);
    }
}
</code></pre>
<p><strong>重要细节</strong>：常量表达式中的闭包必须是静态的，这意味着闭包本身不能用 <code>$this</code>。</p>
<p>这是故意的权衡：常量表达式只求值一次，而 <code>$this</code> 只有在闭包为每个对象实例重新创建时才有意义（这不是常量表达式的行为方式）。</p>
<h4 data-id="heading-11">作用域：闭包在正确的上下文中仍然能看到私有成员</h4>
<p>尽管闭包必须是静态的（没有 <code>$this</code>），在这些常量上下文中创建的闭包仍然遵循正常的作用域规则。RFC 说明：</p>
<ul>
<li>属性默认值中的闭包可以访问所在类的私有属性/方法/常量</li>
<li>属性参数中的闭包可以访问所在类的私有成员</li>
</ul>
<p>这启用了一个好模式：把复杂逻辑放在私有静态辅助方法中，把闭包作为配置暴露出来。</p>
<h3 data-id="heading-12">常量中的一等可调用对象：重构安全的引用，不用字符串</h3>
<p>闭包适合"内联逻辑"。但有时候你不想要内联逻辑——你想指向一个现有的函数或静态方法。</p>
<p>这就是一等可调用对象（FCC）的用武之地。</p>
<p>一等可调用对象看起来像：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">strrev</span>(...)
<span class="hljs-title class_">MyClass</span>::<span class="hljs-title function_ invoke__">myMethod</span>(...)
</code></pre>
<p>它们产生一个转发到函数/方法的 <code>Closure</code>。</p>
<p>PHP 8.5 现在允许常量表达式中的 FCC 语法，旨在"完善"常量中闭包的特性。</p>
<h4 data-id="heading-13">为什么 FCC 比字符串可调用更好</h4>
<p>比较这两个：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 旧方式</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HANDLERS</span> = [
    <span class="hljs-string">'reverse'</span> =&gt; <span class="hljs-string">'strrev'</span>,
    <span class="hljs-string">'slug'</span> =&gt; <span class="hljs-string">'App\\Slugger::slugify'</span>,
];
</code></pre>
<p>对比：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// PHP 8.5</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HANDLERS</span> = [
    <span class="hljs-string">'reverse'</span> =&gt; <span class="hljs-title function_ invoke__">strrev</span>(...),
    <span class="hljs-string">'slug'</span> =&gt; <span class="hljs-title class_">Slugger</span>::<span class="hljs-title function_ invoke__">slugify</span>(...),
];
</code></pre>
<p>第二个版本更好，因为：</p>
<ul>
<li>可重构：重命名和移动更可靠</li>
<li>静态分析可以理解它是可调用的</li>
<li>你避免了魔术字符串和运行时可调用解析</li>
</ul>
<h4 data-id="heading-14">常量表达式中 FCC 的约束</h4>
<p>FCC RFC 添加了一些重要限制（除了正常的 FCC 规则）：</p>
<ul>
<li>只支持独立函数和静态方法（<code>::</code>）。</li>
<li>只支持 <code>function_name(...)</code> 和 <code>ClassName::methodName(...)</code> 语法。</li>
<li>你不能用表达式构建名称（<code>($fn)(...)</code>）、数组（<code>[ClassName::class, 'method'](...)</code>），或依赖 <code>__callStatic()</code> 魔术方法。</li>
</ul>
<p>这是好事：它让常量表达式中的 FCC 用法清晰且可分析。</p>
<h3 data-id="heading-15">实际用例</h3>
<h4 data-id="heading-16">用例：路由映射作为常量</h4>
<p>传统方式，路由映射是运行时构建的：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$routes</span> = [
    <span class="hljs-string">'GET /health'</span> =&gt; [<span class="hljs-title class_">HealthController</span>::<span class="hljs-variable language_">class</span>, <span class="hljs-string">'check'</span>],
    <span class="hljs-string">'GET /posts'</span>  =&gt; [<span class="hljs-title class_">PostsController</span>::<span class="hljs-variable language_">class</span>, <span class="hljs-string">'index'</span>],
];
</code></pre>
<p>这能用，但不是重构安全的。</p>
<p>在 PHP 8.5 中你可以用 FCC 或静态闭包定义路由映射，作为常量：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);

<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Routes</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAP</span> = [
        <span class="hljs-string">'GET /health'</span> =&gt; <span class="hljs-title class_">HealthController</span>::<span class="hljs-title function_ invoke__">check</span>(...),
        <span class="hljs-string">'GET /posts'</span>  =&gt; <span class="hljs-title class_">PostsController</span>::<span class="hljs-title function_ invoke__">index</span>(...),
        <span class="hljs-comment">// 快速端点的内联处理器</span>
        <span class="hljs-string">'GET /version'</span> =&gt; <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">Request <span class="hljs-variable">$req</span></span>): <span class="hljs-title">Response</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">text</span>(<span class="hljs-string">'ok'</span>);
        },
    ];
}
</code></pre>
<p>现在你可以实现一个简单的分发器：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dispatcher</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dispatch</span>(<span class="hljs-params">Request <span class="hljs-variable">$req</span></span>): <span class="hljs-title">Response</span>
    </span>{
        <span class="hljs-variable">$key</span> = <span class="hljs-variable">$req</span>-&gt;method . <span class="hljs-string">' '</span> . <span class="hljs-variable">$req</span>-&gt;path;
        <span class="hljs-variable">$handler</span> = <span class="hljs-title class_">Routes</span>::<span class="hljs-variable constant_">MAP</span>[<span class="hljs-variable">$key</span>] ?? <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$handler</span> === <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>::<span class="hljs-title function_ invoke__">text</span>(<span class="hljs-string">'Not found'</span>, <span class="hljs-number">404</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$handler</span>(<span class="hljs-variable">$req</span>);
    }
}
</code></pre>
<p>这个模式有几个好处：</p>
<ul>
<li>路由映射是真正的常量配置。</li>
<li>处理器是真正的可调用对象，不是字符串。</li>
<li>重构更安全（特别是静态方法处理器）。</li>
</ul>
<p>实际的路由器需要路径参数；但即使这样，"处理器注册表"部分通常保持静态。</p>
<h4 data-id="heading-17">用例：消息总线的处理器注册表</h4>
<p>想象一个简单的消息总线：消息类映射到处理器。</p>
<p>旧方式：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$handlers</span> = [
    <span class="hljs-title class_">UserRegistered</span>::<span class="hljs-variable language_">class</span> =&gt; <span class="hljs-string">'App\\Handlers\\SendWelcomeEmail::handle'</span>,
];
</code></pre>
<p>现在，用 PHP 8.5 FCC：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MessageHandlers</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAP</span> = [
        <span class="hljs-title class_">UserRegistered</span>::<span class="hljs-variable language_">class</span> =&gt; <span class="hljs-title class_">SendWelcomeEmail</span>::<span class="hljs-title function_ invoke__">handle</span>(...),
        <span class="hljs-title class_">OrderPaid</span>::<span class="hljs-variable language_">class</span>      =&gt; <span class="hljs-title class_">CreateInvoice</span>::<span class="hljs-title function_ invoke__">handle</span>(...),
    ];
}
</code></pre>
<p>分发器：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bus</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> Container <span class="hljs-variable">$container</span></span>) </span>{}

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> <span class="hljs-variable">$message</span></span>): <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-variable">$handler</span> = <span class="hljs-title class_">MessageHandlers</span>::<span class="hljs-variable constant_">MAP</span>[<span class="hljs-variable">$message</span>::<span class="hljs-variable language_">class</span>] ?? <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$handler</span> === <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">'No handler registered for '</span> . <span class="hljs-variable">$message</span>::<span class="hljs-variable language_">class</span>);
        }
        <span class="hljs-comment">// 如果处理器是静态的，它们可以显式接受依赖，</span>
        <span class="hljs-comment">// 或者你可以调整这个模式（见下面的 DI 说明）。</span>
        <span class="hljs-variable">$handler</span>(<span class="hljs-variable">$message</span>, <span class="hljs-variable language_">$this</span>-&gt;container);
    }
}
</code></pre>
<p>关键概念：常量表达式让你把映射保持在常量中，但你仍然控制依赖如何注入——通过签名设计。</p>
<h4 data-id="heading-18">用例：策略/格式化器注册表（switch 语句的干净替代）</h4>
<p>这是我最喜欢的实际用途：替换一个不断增长的 switch。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">format</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$type</span>, <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$value</span></span>): <span class="hljs-title">string</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">match</span> (<span class="hljs-variable">$type</span>) {
        <span class="hljs-string">'json'</span> =&gt; <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$value</span>),
        <span class="hljs-string">'text'</span> =&gt; (<span class="hljs-keyword">string</span>) <span class="hljs-variable">$value</span>,
        <span class="hljs-string">'upper'</span> =&gt; <span class="hljs-title function_ invoke__">strtoupper</span>((<span class="hljs-keyword">string</span>) <span class="hljs-variable">$value</span>),
        <span class="hljs-keyword">default</span> =&gt; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">'Unknown formatter'</span>),
    };
}
</code></pre>
<p>现在想象这增长到 15-30 个策略。你最终得到一个大 match 和一个 diff 磁铁。</p>
<p>用可调用常量：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FormatterRegistry</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FORMATTERS</span> = [
        <span class="hljs-string">'json'</span> =&gt; <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">mixed</span> <span class="hljs-variable">$v</span></span>): <span class="hljs-title">string</span> </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$v</span>, JSON_THROW_ON_ERROR);
        },
        <span class="hljs-string">'text'</span> =&gt; <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">mixed</span> <span class="hljs-variable">$v</span></span>): <span class="hljs-title">string</span> </span>{
            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">string</span>) <span class="hljs-variable">$v</span>;
        },
        <span class="hljs-comment">// FCC 到原生函数</span>
        <span class="hljs-string">'reverse'</span> =&gt; <span class="hljs-title function_ invoke__">strrev</span>(...),
    ];

    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">format</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$type</span>, <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$value</span></span>): <span class="hljs-title">string</span>
    </span>{
        <span class="hljs-variable">$fn</span> = <span class="hljs-built_in">self</span>::<span class="hljs-variable constant_">FORMATTERS</span>[<span class="hljs-variable">$type</span>] ?? <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$fn</span> === <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">InvalidArgumentException</span>(<span class="hljs-string">"Unknown formatter: <span class="hljs-subst">{$type}</span>"</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$fn</span>(<span class="hljs-variable">$value</span>);
    }
}
</code></pre>
<p>现在添加策略只需要改一行。</p>
<h3 data-id="heading-19">测试和依赖注入：什么该放常量，什么该放容器</h3>
<p>这个特性引导你走向"代码即配置"。这很好——直到你开始把运行时状态注入到应该是静态的东西里。</p>
<p>一个好的心智模型：</p>
<ul>
<li><strong>常量应该包含稳定的接线</strong>：映射、策略、不依赖运行时状态的小逻辑片段。</li>
<li><strong>DI 容器应该包含运行时组装</strong>：需要环境相关接线的对象、IO 资源、凭证、连接等。</li>
</ul>
<h4 data-id="heading-20">好的常量可调用用法：纯粹的转换和策略</h4>
<p>这些在常量表达式中是安全的：</p>
<ul>
<li>规范化函数（trim、canonicalize）</li>
<li>路由/分发选择逻辑</li>
<li>只依赖输入值的验证器</li>
<li>格式化器和映射器</li>
</ul>
<h4 data-id="heading-21">DI 的用武之地：当你需要依赖时</h4>
<p>你仍然可以通过设计可调用对象显式接受依赖来混合可调用配置和 DI。</p>
<p>例子：注册表返回一个接受 <code>(Message $m, Container $c)</code> 的可调用对象：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Handlers</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAP</span> = [
        <span class="hljs-title class_">UserRegistered</span>::<span class="hljs-variable language_">class</span> =&gt; <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">UserRegistered <span class="hljs-variable">$m</span>, Container <span class="hljs-variable">$c</span></span>): <span class="hljs-title">void</span> </span>{
            <span class="hljs-variable">$mailer</span> = <span class="hljs-variable">$c</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-title class_">Mailer</span>::<span class="hljs-variable language_">class</span>);
            <span class="hljs-variable">$mailer</span>-&gt;<span class="hljs-title function_ invoke__">sendWelcome</span>(<span class="hljs-variable">$m</span>-&gt;email);
        },
    ];
}
</code></pre>
<p>这保持在约束内，因为闭包是静态的且不捕获状态。"依赖解析"在调用时发生，容器被传入。</p>
<p>这总是理想的吗？不是。但它是一个干净、显式的桥梁。</p>
<h4 data-id="heading-22">测试影响：更好的默认值，更容易覆盖</h4>
<p>常量表达式闭包让默认值更干净：</p>
<ul>
<li>函数可以有默认闭包参数（不用可空）。</li>
<li>属性可以有默认闭包策略。</li>
</ul>
<p>对于测试，你仍然可以通过传递不同的闭包参数或给对象属性赋值不同的策略来覆盖行为（如果该属性设计上是可变的）。主要改进是默认行为在它该在的地方表达，你不需要运行时初始化胶水代码来创建默认闭包。</p>
<h3 data-id="heading-23">陷阱：捕获状态、副作用和团队可读性</h3>
<p>这个特性给你在"配置上下文"中更多能力。能力带来新的搬起石头砸自己脚的方式。</p>
<h4 data-id="heading-24">陷阱 A：试图捕获状态（不会编译——这是好事）</h4>
<p>你不能这样做：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$prefix</span> = <span class="hljs-string">"prod_"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FN</span> = <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$s</span></span>) <span class="hljs-keyword">use</span> (<span class="hljs-params"><span class="hljs-variable">$prefix</span></span>): <span class="hljs-title">string</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$prefix</span> . <span class="hljs-variable">$s</span>;
};
</code></pre>
<p>常量表达式中的闭包不能通过 <code>use(...)</code> 捕获变量。</p>
<p>这是硬性约束，它强迫你采用更好的设计：</p>
<ul>
<li>把值作为参数传递</li>
<li>使用常量/类常量</li>
<li>或者做运行时配置，而不是假装它是常量</li>
</ul>
<p>类似地，箭头函数在常量表达式中被阻止，因为它们隐式捕获变量。</p>
<h4 data-id="heading-25">陷阱 B：在"配置"里隐藏副作用</h4>
<p>如果你的"注册表"闭包开始做 IO、访问数据库、读取环境变量等，你就让配置变得不可预测了。</p>
<p>一个好规则：</p>
<p>如果可调用对象做的不只是"计算并返回"，考虑把它移到真正的服务中，通过静态方法引用它（或容器接线）。</p>
<h4 data-id="heading-26">陷阱 C：在纯数据更清晰的地方用可调用配置</h4>
<p>仅仅因为你能在属性里放代码，不意味着你应该这样做。</p>
<p>如果你的规则可以表达为简单数据——用数据。例子：</p>
<ul>
<li>允许的角色</li>
<li>数字范围</li>
<li>枚举集合</li>
</ul>
<p>可调用配置应该是你的工具，用于数据本身变得笨拙的情况（或者你否则会发明一个字符串表达式 DSL）。</p>
<h4 data-id="heading-27">陷阱 D：团队间的可读性和一致性</h4>
<p>可调用配置仍然是代码。如果你的团队经验水平不一，你需要约定：</p>
<ul>
<li>保持常量表达式闭包简短。</li>
<li>当闭包超过约 10 行时，倾向于命名逻辑并通过 FCC 引用它（<code>SomeClass::somePolicy(...)</code>）。</li>
<li>避免花哨写法（特别是嵌套匿名函数）。</li>
</ul>
<h3 data-id="heading-28">指南：什么时候配置应该保持"数据"，什么时候"可调用配置"是合理的</h3>
<p>这是一套在实际代码库中通常效果不错的实用指南。</p>
<p><strong>在以下情况倾向于纯数据配置：</strong></p>
<ul>
<li>规则是静态且小的（标志、列表、阈值）</li>
<li>你想要容易序列化（比如导出配置）</li>
<li>你想让非开发者可以编辑配置（在某些组织中）</li>
</ul>
<p>例子：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Limits</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_TITLE_LENGTH</span> = <span class="hljs-number">120</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ALLOWED_SORTS</span> = [<span class="hljs-string">'newest'</span>, <span class="hljs-string">'popular'</span>, <span class="hljs-string">'discussed'</span>];
}
</code></pre>
<p><strong>在以下情况使用可调用配置：</strong></p>
<ul>
<li>规则简单但不能很好地映射到数据（比如谓词）</li>
<li>使用数据会把你推向自定义 DSL</li>
<li>你想通过属性让配置靠近类/方法</li>
<li>你想要重构安全的可调用对象而不是字符串</li>
</ul>
<p>这正是 PHP 8.5 在属性、默认值和常量中启用的。</p>
<p><strong>保持可调用配置安全且可维护：</strong></p>
<ul>
<li>让闭包静态（反正是必须的）。</li>
<li>不要试图捕获外部变量（<code>use(...)</code> 不允许）。</li>
<li>当逻辑增长时：把它移到命名的静态方法并用 FCC 引用它，PHP 8.5 现在在常量表达式中允许这样做。</li>
<li>只在支持的形式中使用 FCC：<code>function_name(...)</code> 和 <code>ClassName::methodName(...)</code>（不支持数组可调用语法）。</li>
</ul>
<h4 data-id="heading-29">关于性能和 opcache 的说明</h4>
<p>如果你想知道这是否"免费"，两个 RFC 都提到 opcache 需要调整才能正确地在共享内存中存储这些闭包/可调用对象。</p>
<p>换句话说：这个特性的实现考虑了真实世界的运行时环境（opcache/JIT）。目标不是微优化——而是表达力和安全性。</p>
<h3 data-id="heading-30">小结</h3>
<p>PHP 8.5 支持常量表达式中的静态闭包和一等可调用对象，这是那种在更新日志上看起来很小、然后悄悄改善你设计 API 方式的特性：</p>
<ul>
<li>默认回调变得干净且类型正确（不用可空样板）。</li>
<li>属性可以携带真正的可执行策略逻辑——不用字符串 DSL。</li>
<li>注册表和路由映射可以定义为常量，使用重构安全的可调用对象。</li>
</ul>
<p>约束就是护栏：不能捕获变量、没有 <code>$this</code>、常量表达式中没有箭头函数。</p>
<p>如果你接受这些护栏，你会得到一个真正更好的"编译时风格"配置层——接线是静态的、可读的、重构更安全。</p>
<p>用它来移除胶水代码，而不是隐藏复杂性。保持可调用配置简短，给重的东西命名，让你的常量描述"发生什么"，而不是把它们变成迷你应用程序。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript调试效率翻倍的5个隐藏技巧，90%开发者都不知道！]]></title>    <link>https://juejin.cn/post/7595815509235138600</link>    <guid>https://juejin.cn/post/7595815509235138600</guid>    <pubDate>2026-01-17T00:17:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595815509235138600" data-draft-id="7595858063501885474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript调试效率翻倍的5个隐藏技巧，90%开发者都不知道！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-17T00:17:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript调试效率翻倍的5个隐藏技巧，90%开发者都不知道！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-17T00:17:26.000Z" title="Sat Jan 17 2026 00:17:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript调试效率翻倍的5个隐藏技巧，90%开发者都不知道！</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>调试是开发过程中不可避免的一部分，而JavaScript作为一门动态、灵活的语言，调试起来往往更具挑战性。尽管大多数开发者熟悉<code>console.log</code>和浏览器的开发者工具，但许多隐藏的高级技巧却鲜为人知。这些技巧可以显著提升调试效率，减少排查问题的时间。本文将深入探讨5个被低估的JavaScript调试技巧，帮助你成为更高效的开发者。</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 使用<code>console.table</code>格式化输出复杂数据</h3>
<p>大多数开发者习惯用<code>console.log</code>打印对象或数组，但当数据结构复杂时（如嵌套对象或多维数组），阅读起来非常困难。这时，<code>console.table</code>可以派上用场。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> users = [
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">"Admin"</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">"User"</span> },
];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">table</span>(users);
</code></pre>
<p><strong>效果：</strong><br/>
浏览器会以表格形式展示数据，支持排序和过滤，极大提升了可读性。</p>
<p><strong>进阶用法：</strong></p>
<ul>
<li>对大型数据集可以指定显示的列：
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">table</span>(users, [<span class="hljs-string">"name"</span>, <span class="hljs-string">"role"</span>]);
</code></pre>
</li>
<li>支持嵌套对象的展开查看。</li>
</ul>
<hr/>
<h3 data-id="heading-4">2. <code>debugger</code>语句与条件断点</h3>
<p>虽然断点是调试的常见手段，但很多人不知道可以设置条件断点或通过代码动态触发断点。</p>
<h4 data-id="heading-5"><code>debugger</code>语句</h4>
<p>在代码中直接插入<code>debugger</code>语句，当开发者工具打开时会自动暂停执行：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTotal</span>(<span class="hljs-params">items</span>) {
  <span class="hljs-keyword">debugger</span>; <span class="hljs-comment">// 执行到此处会自动暂停</span>
  <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, item</span>) =&gt;</span> sum + item.<span class="hljs-property">price</span>, <span class="hljs-number">0</span>);
}
</code></pre>
<h4 data-id="heading-6">条件断点</h4>
<p>在Chrome DevTools中，右键点击行号选择“Add conditional breakpoint”，输入条件表达式（如<code>x &gt; 100</code>），只有满足条件时才会暂停。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>循环中特定条件的调试。</li>
<li>仅在特定数据状态下触发断点。</li>
</ul>
<hr/>
<h3 data-id="heading-7">3. <code>console.time</code>与性能分析</h3>
<p>性能问题是JavaScript开发中的常见痛点，而<code>console.time</code>和<code>console.timeEnd</code>可以帮助快速定位耗时操作。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">"API Call"</span>);
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">"https://api.example.com/data"</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">"API Call"</span>); <span class="hljs-comment">// 输出执行时间</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
  });
</code></pre>
<p><strong>进阶技巧：</strong></p>
<ul>
<li><strong>标记时间点：</strong> <code>console.timeLog(label)</code>可以在不结束计时的情况下打印当前时间。</li>
<li><strong>嵌套计时：</strong> 支持多个独立的计时器标签。</li>
</ul>
<hr/>
<h3 data-id="heading-8">4. <code>Proxy</code>对象监听属性变化</h3>
<p>对于需要追踪对象属性变化的场景（如状态管理库），直接修改代码添加日志可能很繁琐。ES6的<code>Proxy</code>可以无侵入式地监听对象操作。</p>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> target = { <span class="hljs-attr">value</span>: <span class="hljs-number">10</span> };
<span class="hljs-keyword">const</span> handler = {
  <span class="hljs-title function_">set</span>(<span class="hljs-params">obj, prop, value</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Property "<span class="hljs-subst">${prop}</span>" changed from <span class="hljs-subst">${obj[prop]}</span> to <span class="hljs-subst">${value}</span>`</span>);
    obj[prop] = value;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
};
<span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, handler);
proxy.<span class="hljs-property">value</span> = <span class="hljs-number">20</span>; <span class="hljs-comment">// Console: "Property "value" changed from 10 to 20"</span>
</code></pre>
<p><strong>适用场景：</strong></p>
<ul>
<li>Vue/React状态变化的调试。</li>
<li>API响应数据的变更追踪。</li>
</ul>
<hr/>
<h3 data-id="heading-9">5. Source Map与异常捕获增强</h3>
<p>生产环境的代码通常是压缩后的，直接调试极为困难。Source Map可以将压缩代码映射回原始源代码，而结合全局异常捕获可以获取更多上下文信息。</p>
<h4 data-id="heading-10">Source Map配置</h4>
<p>在Webpack/Rollup等构建工具中启用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
<span class="hljs-attr">devtool</span>: <span class="hljs-string">'source-map'</span>, <span class="hljs-comment">// 生成独立的.map文件</span>
};
</code></pre>
<h4 data-id="heading-11"><code>window.onerror</code>增强错误信息</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">message, source, lineno, colno, error</span>) {
 <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Error: <span class="hljs-subst">${message}</span> at <span class="hljs-subst">${lineno}</span>:<span class="hljs-subst">${colno}</span>`</span>);
 <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Stack Trace:"</span>, error.<span class="hljs-property">stack</span>);
 <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">//阻止默认错误提示</span>
};
</code></pre>
<p><strong>最佳实践：</strong></p>
<ul>
<li>**生产环境按需加载Source Map：**避免暴露源代码。</li>
<li>**Sentry/Bugsnag集成：**自动化错误收集与分析。</li>
</ul>
<hr/>
<h2 data-id="heading-12">总结</h2>
<p>掌握这些隐藏的调试技巧不仅能提升效率，还能让你更深入地理解JavaScript的运行机制。从格式化输出到高级断点设置，再到性能分析和运行时监听，每一项技能都能在实际开发中发挥巨大作用。建议将这些方法纳入你的日常工具箱，逐步培养更专业的调试习惯。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（47）Hibernate的会话范围（Scope）如何控制？]]></title>    <link>https://juejin.cn/post/7595769731200122886</link>    <guid>https://juejin.cn/post/7595769731200122886</guid>    <pubDate>2026-01-16T23:33:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595769731200122886" data-draft-id="7595785828134027300" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（47）Hibernate的会话范围（Scope）如何控制？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T23:33:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（47）Hibernate的会话范围（Scope）如何控制？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T23:33:49.000Z" title="Fri Jan 16 2026 23:33:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Hibernate中，会话范围（Scope）是指Hibernate <code>Session</code> 对象的生命周期，它决定了会话在应用程序中的存活时间。控制会话范围对于保证数据库操作的一致性和性能是至关重要的。常见的会话范围包括：</p>
<ol>
<li><strong>短会话（短生命周期）</strong>：每次数据库操作都创建一个新的会话。</li>
<li><strong>长会话（长生命周期）</strong>：会话在一个较长的上下文中存活，例如在整个事务或用户会话期间。</li>
</ol>
<h3 data-id="heading-0">短会话（短生命周期）</h3>
<p>短生命周期的会话通常用于单个数据库操作或Http请求，这种方式非常适合简单的、无状态的操作。</p>
<h4 data-id="heading-1">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateShortSessionExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 每次操作都创建一个新的会话</span>
        insertCategory(<span class="hljs-string">"Electronics"</span>);
        insertCategory(<span class="hljs-string">"Books"</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertCategory</span><span class="hljs-params">(String categoryName)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Category</span>();
            category.setName(categoryName);
            session.save(category);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Category "</span> + categoryName + <span class="hljs-string">" inserted"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<p>在这个例子中，每次调用<code>insertCategory</code>方法都会创建一个新的<code>Session</code>，并在操作完成后关闭。这种短会话方式适合无状态的单次操作。</p>
<h3 data-id="heading-2">长会话（长生命周期）</h3>
<p>长生命周期的会话通常用于需要在多个数据库操作之间保持状态的情况，例如在整个事务或用户会话期间。</p>
<h4 data-id="heading-3">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateLongSessionExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Session session;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 启动一个长会话</span>
        startSession();

        <span class="hljs-comment">// 在同一个会话中执行多个操作</span>
        insertCategory(<span class="hljs-string">"Electronics"</span>);
        insertCategory(<span class="hljs-string">"Books"</span>);

        <span class="hljs-comment">// 结束长会话</span>
        endSession();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startSession</span><span class="hljs-params">()</span> {
        session = sessionFactory.openSession();
        session.beginTransaction();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertCategory</span><span class="hljs-params">(String categoryName)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Category</span>();
            category.setName(categoryName);
            session.save(category);
            System.out.println(<span class="hljs-string">"Category "</span> + categoryName + <span class="hljs-string">" inserted"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (session.getTransaction() != <span class="hljs-literal">null</span>) {
                session.getTransaction().rollback();
            }
            e.printStackTrace();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">endSession</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            session.getTransaction().commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (session.getTransaction() != <span class="hljs-literal">null</span>) {
                session.getTransaction().rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<p>在这个例子中，<code>startSession</code>方法启动一个长会话，并在多个操作之间保持同一个会话。最后，通过<code>endSession</code>方法提交事务并关闭会话。这样的设计适合需要持久化多个相关操作的场景。</p>
<h3 data-id="heading-4">会话范围选择的指导原则</h3>
<ol>
<li>
<p><strong>短会话</strong>：</p>
<ul>
<li>适用于简单的、无状态的操作。</li>
<li>每个数据库操作都创建和关闭一个会话。</li>
<li>易于管理和实现。</li>
<li>对于高并发的Web应用程序特别有用。</li>
</ul>
</li>
<li>
<p><strong>长会话</strong>：</p>
<ul>
<li>适用于需要在多个操作之间保持状态的情况，例如复杂的事务或会话范围的缓存。</li>
<li>需要更复杂的事务管理和异常处理。</li>
<li>可减少数据库连接的频繁创建和销毁，从而提高性能。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">高级配置和最佳实践</h3>
<ol>
<li>
<p><strong>使用Spring事务管理</strong>：</p>
<ul>
<li>使用Spring框架的事务管理可以更方便地控制Hibernate会话的范围和事务的一致性。</li>
<li>Spring的<code>@Transactional</code>注解可以在方法级别控制事务范围。</li>
</ul>
</li>
<li>
<p><strong>会话上下文</strong>：</p>
<ul>
<li>Hibernate提供了不同的会话上下文策略（如<code>thread</code>、<code>managed</code>、<code>jta</code>等），可以根据应用需求来选择。</li>
<li>使用<code>thread</code>上下文策略可以在每个线程中保持一个会话实例。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-6">示例代码使用Spring事务管理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CategoryService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SessionFactory sessionFactory;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertCategory</span><span class="hljs-params">(String categoryName)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.getCurrentSession();
        <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Category</span>();
        category.setName(categoryName);
        session.save(category);
        System.out.println(<span class="hljs-string">"Category "</span> + categoryName + <span class="hljs-string">" inserted"</span>);
    }
}
</code></pre>
<p>在这个例子中，<code>CategoryService</code>使用Spring的<code>@Transactional</code>注解来管理事务和会话范围。这样可以更方便地控制事务的一致性，并简化异常处理。</p>
<p>通过合理选择和控制Hibernate的会话范围，可以有效地提高应用程序的性能和一致性。希望这些详细的解释和代码示例能帮助您更好地理解和应用Hibernate的会话管理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（48）Hibernate的乐观锁和悲观锁有什么区别？]]></title>    <link>https://juejin.cn/post/7595800938709008420</link>    <guid>https://juejin.cn/post/7595800938709008420</guid>    <pubDate>2026-01-16T23:34:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595800938709008420" data-draft-id="7595800938708992036" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（48）Hibernate的乐观锁和悲观锁有什么区别？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T23:34:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（48）Hibernate的乐观锁和悲观锁有什么区别？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T23:34:40.000Z" title="Fri Jan 16 2026 23:34:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据库并发控制中，乐观锁和悲观锁是两种处理并发访问的策略。Hibernate支持这两种锁机制，用于确保数据的一致性和完整性。以下是对这两种锁机制的详细解释及其代码示例。</p>
<h3 data-id="heading-0">乐观锁（Optimistic Locking）</h3>
<p>乐观锁假设数据并发冲突的概率较低，因此不会在数据库层面上锁住数据，而是通过版本号或时间戳等机制来检测并发冲突。如果在提交更新时发现数据已被其他事务修改，则会报错并回滚当前事务。</p>
<h4 data-id="heading-1">使用版本号实现乐观锁</h4>
<h5 data-id="heading-2">示例代码</h5>
<ol>
<li><strong>实体类</strong></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-meta">@Version</span>
    <span class="hljs-meta">@Column(name = "version")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> version;

    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<p>在这个例子中，<code>@Version</code>注解用于指定版本字段。每次更新该实体时，Hibernate会自动增加版本号，从而检测并发冲突。</p>
<ol start="2">
<li><strong>测试乐观锁</strong></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimisticLockingTest</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 插入一个产品</span>
        insertProduct(<span class="hljs-string">"Laptop"</span>, <span class="hljs-number">1000.0</span>);

        <span class="hljs-comment">// 开始两个并发事务</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; updatePrice(<span class="hljs-number">1L</span>, <span class="hljs-number">1200.0</span>)).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; updatePrice(<span class="hljs-number">1L</span>, <span class="hljs-number">1300.0</span>)).start();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertProduct</span><span class="hljs-params">(String name, Double price)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product.setName(name);
            product.setPrice(price);
            session.save(product);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Product "</span> + name + <span class="hljs-string">" inserted"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updatePrice</span><span class="hljs-params">(Long productId, Double newPrice)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> session.get(Product.class, productId);
            product.setPrice(newPrice);
            session.update(product);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Product price updated to "</span> + newPrice);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<p>在这个示例中，两条线程尝试同时更新产品的价格。如果其中一个线程在提交时发现产品的版本号已被另一线程更新，将会抛出<code>OptimisticLockException</code>，并回滚事务。</p>
<h3 data-id="heading-3">悲观锁（Pessimistic Locking）</h3>
<p>悲观锁假设数据并发冲突的概率较高，因此会在读取数据时就锁住数据，防止其他事务修改。悲观锁通常在数据库层面上实现，通过锁表或锁行来实现。</p>
<h4 data-id="heading-4">使用悲观锁</h4>
<h5 data-id="heading-5">示例代码</h5>
<ol>
<li><strong>实体类</strong></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<ol start="2">
<li><strong>测试悲观锁</strong></li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.LockMode;
<span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PessimisticLockingTest</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 插入一个产品</span>
        insertProduct(<span class="hljs-string">"Laptop"</span>, <span class="hljs-number">1000.0</span>);

        <span class="hljs-comment">// 开始两个并发事务</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; updatePricePessimistically(<span class="hljs-number">1L</span>, <span class="hljs-number">1200.0</span>)).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; updatePricePessimistically(<span class="hljs-number">1L</span>, <span class="hljs-number">1300.0</span>)).start();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertProduct</span><span class="hljs-params">(String name, Double price)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product.setName(name);
            product.setPrice(price);
            session.save(product);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Product "</span> + name + <span class="hljs-string">" inserted"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updatePricePessimistically</span><span class="hljs-params">(Long productId, Double newPrice)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用悲观锁锁定产品行</span>
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> session.get(Product.class, productId, LockMode.PESSIMISTIC_WRITE);
            System.out.println(<span class="hljs-string">"Product "</span> + productId + <span class="hljs-string">" locked"</span>);

            product.setPrice(newPrice);
            session.update(product);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Product price updated to "</span> + newPrice);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<p>在这个示例中，两条线程同时尝试锁定和更新产品的价格。由于使用了悲观锁，一条线程会在另一条线程释放锁之前被阻塞，从而确保数据的一致性。</p>
<h3 data-id="heading-6">乐观锁和悲观锁的选择</h3>
<ul>
<li><strong>乐观锁</strong>：
<ul>
<li>优点：
<ul>
<li>性能较高，因为不会在数据上加锁。</li>
<li>适用于读多写少的场景。</li>
</ul>
</li>
<li>缺点：
<ul>
<li>可能会导致较多的重试和失败。</li>
</ul>
</li>
</ul>
</li>
<li><strong>悲观锁</strong>：
<ul>
<li>优点：
<ul>
<li>可以确保数据的一致性，防止并发修改。</li>
<li>适用于写多的场景。</li>
</ul>
</li>
<li>缺点：
<ul>
<li>性能较低，因为会阻塞其他事务访问被锁定的数据。</li>
<li>可能会导致死锁。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">总结</h3>
<ol>
<li><strong>乐观锁</strong>通过版本号或时间戳等机制检测并发冲突，适合读多写少的应用场景。</li>
<li><strong>悲观锁</strong>通过数据库层面的锁来防止并发修改，适合写多的应用场景。</li>
</ol>
<p>根据应用的具体需求和并发访问模式，选择合适的锁机制可以有效地提高性能并确保数据的一致性。希望这些详细的解释和代码示例能帮助您更好地理解和应用Hibernate的乐观锁和悲观锁。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Logoly:几秒钟做出「P站 风格」Logo 的开源小工具]]></title>    <link>https://juejin.cn/post/7595800938708025380</link>    <guid>https://juejin.cn/post/7595800938708025380</guid>    <pubDate>2026-01-16T15:15:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595800938708025380" data-draft-id="7595800938708008996" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Logoly:几秒钟做出「P站 风格」Logo 的开源小工具"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-16T15:15:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Logoly:几秒钟做出「P站 风格」Logo 的开源小工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T15:15:35.000Z" title="Fri Jan 16 2026 15:15:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多人做个人主页、公众号封面、技术分享 PPT，都会遇到一个共同问题：<br/>
<strong>想要一个眼前一亮的 Logo，但又不会设计，也懒得打开 PS / Figma。</strong></p>
<p>Logoly 就是为这种场景而生的一个开源项目：<br/>
一个可以在线生成 <strong>Pornhub / OnlyFans 风格 Logo</strong> 的小工具，只需要改几个字、调调颜色，几秒钟就能导出一张“似曾相识”的趣味 Logo。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5551ea19d3884c61b1d84584da5291e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769181335&amp;x-signature=mRxSenzy0Crc236JPFQRUiQwtZM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">👁️‍🗨️ Logoly 是什么？</h2>
<p>Logoly 的作者给它的定义是：</p>
<blockquote>
<p><strong>A Simple Online Logo Generator for People Who Want to Design Logos Easily.</strong><br/>
—— 让任何人都能轻松做 Logo 的在线生成器。</p>
</blockquote>
<p>它最早因为可以生成类似 p站 风格的 Logo 在社区火了一把，后来又加入了 OnlyFans 风格的样式，逐渐变成一个 <strong>“恶搞 / 表情包 / 个人小品牌”</strong> 都能用的小工具。</p>
<p>特点概括一下：</p>
<ul>
<li>在线使用，无需安装，打开网页就能玩</li>
<li>生成 P站 / OnlyFans 风格的 Logo</li>
<li>支持自定义文字内容</li>
<li>支持自定义颜色和字体大小</li>
<li>一键导出 PNG / SVG 两种格式</li>
<li>开源，基于 WTFPL 2 授权，几乎「想怎么玩就怎么玩」</li>
</ul>
<p>github地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbestony%2Flogoly" target="_blank" title="https://github.com/bestony/logoly" ref="nofollow noopener noreferrer">github.com/bestony/log…</a> 在线体验：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.logoly.pro%2F" target="_blank" title="https://www.logoly.pro/" ref="nofollow noopener noreferrer">www.logoly.pro/</a></p>
<p>该项目目前在github 上已有 7.9k ⭐️star</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3ef9f213d474b26bd08edaef9d45802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769181335&amp;x-signature=xFjer0NASxOrqKirv7IXXBJ3s5A%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">🎯 功能一览</h2>
<h3 data-id="heading-2">1. 两种经典风格：P站风格 &amp; OnlyFans</h3>
<p>你可以一键做出这两种在互联网上辨识度极高的 Logo 风格，用来做：</p>
<ul>
<li>朋友圈/微博的整活配图</li>
<li>技术分享 PPT 中的彩蛋</li>
<li>团队内部的梗图或文化海报</li>
<li>个人主页 / 博客上的趣味 Logo 等</li>
</ul>
<p>风格本身非常强烈，但文字是你自定义的，可以天马行空。</p>
<blockquote>
<p>注意：Logoly 本身不涉及任何成人内容，只是借鉴了这些品牌 Logo 的视觉风格。</p>
</blockquote>
<h3 data-id="heading-3">2. 自定义文字内容</h3>
<p>页面中有一个文本输入框，只需要：</p>
<ol>
<li>把默认的文字改成你想要的（英文、数字、甚至中文都可以尝试）</li>
<li>实时预览 Logo 效果</li>
</ol>
<p>很适合搞一些有梗、容易被记住的短词。</p>
<h3 data-id="heading-4">3. 自定义颜色和字体大小</h3>
<p>你可以自由调整：</p>
<ul>
<li>左右两段文字的颜色</li>
<li>中间色块的背景色（具体视当前主题而定）</li>
<li>整体字号大小，用来适配不同场景（比如头像 vs 横幅）</li>
</ul>
<p>简单几下滑动/点选，就能做出风格迥异的变体。</p>
<h3 data-id="heading-5">4. 导出 PNG / SVG</h3>
<p>完成之后，点击 <strong>Export</strong> 按钮可以导出两种格式：</p>
<ul>
<li><strong>PNG</strong>：适合直接作为图片使用（社交头像、封面图、PPT、聊天表情等）</li>
<li><strong>SVG</strong>：矢量格式，放大不会糊，适合用在网页、印刷、再加工设计中</li>
</ul>
<p>对于前端开发者来说，SVG 的可编辑性也很友好，可以进一步嵌入到自己的项目里。</p>
<h2 data-id="heading-6">在线使用教程：4 步搞定一个 Logo</h2>
<p>作者已经把使用流程总结成 4 步，实际体验下来也确实非常简单：</p>
<ol>
<li>
<p>打开网站：<br/>
访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Flogoly.pro%2F" target="_blank" title="https://logoly.pro/" ref="nofollow noopener noreferrer">logoly.pro/</a></p>
</li>
<li>
<p>编辑文字：<br/>
把默认的文本替换成你想要的单词/短句</p>
</li>
<li>
<p>调整样式：</p>
<ul>
<li>修改颜色</li>
<li>调整字体大小</li>
</ul>
</li>
<li>
<p>导出图片：<br/>
点击 <strong>Export</strong> 按钮，选择 PNG 或 SVG 导出</p>
</li>
</ol>
<p>整个过程基本不需要学习成本，几乎是「一看就会」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3117fe70eccc47a1a84a3d341863f489~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769181335&amp;x-signature=6OGRALXpEX58pokDqm%2FU6svKP%2Bw%3D" alt="" loading="lazy"/></p>
<p>以下是我生成的一些案例</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fea6db8021594edc8596966791e0ad39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769181335&amp;x-signature=wcGVTrQxZy8%2FQAFUl%2FBNmR83ol8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56bef629d4554df2aca2f09f9a2d1bab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769181335&amp;x-signature=poMgEmOlrBJo%2FZCqzmkQ2qP7uys%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8042146e18ba47f492d7c218b7f08ae3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769181335&amp;x-signature=4MtFvzzE62HuAOLSLAwVhcE880o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">✏️ 面向开发者：如何在本地运行 Logoly？</h2>
<h3 data-id="heading-8">环境要求</h3>
<p>项目对 Node / npm 版本有明确要求：</p>
<ul>
<li>Node.js <strong>18+</strong></li>
<li>npm <strong>10+</strong><br/>
（官方说明：<strong>只支持 npm 作为包管理器</strong>，请不要提交其他管理器生成的 lockfile）</li>
</ul>
<p>也就是说：</p>
<ul>
<li>不建议使用 yarn / pnpm / Bun 来跑这个项目，以免锁文件不一致、CI 失败。</li>
<li>CI 流水线里也是基于 npm 的脚本执行。</li>
</ul>
<h3 data-id="heading-9">本地跑起来的步骤</h3>
<p>在命令行中依次执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/bestony/logoly.git
<span class="hljs-built_in">cd</span> logoly

<span class="hljs-comment"># 2. 安装依赖</span>
npm install

<span class="hljs-comment"># 3. 启动开发服务器</span>
npm run dev
</code></pre>
<p>启动成功后，在浏览器里访问提示的本地地址（通常是 <code>http://localhost:xxxx</code>），就能看到 Logoly 的开发版界面。</p>
<p>修改源码后即可实时看到效果。<br/>
开发完成后，可以进行构建：</p>
<pre><code class="hljs language-arduino" lang="arduino">npm run build
</code></pre>
<h3 data-id="heading-10">docker部署</h3>
<p>如果你想使用docker部署，则只需要启动一个nginx 容器，将构建后的dist目录下的文件及文件夹挂载到容器中即可,不会部署nginx的家人们可以搜索下博主的历史文章，有介绍docker 部署nginx 及配置的博文。</p>
<h2 data-id="heading-11">🦆 总结</h2>
<p>如果你：</p>
<ul>
<li>需要一个有辨识度的 Logo，又不想折腾复杂设计工具</li>
<li>想给项目、团队或朋友做一个带梗的图标</li>
<li>想找一个小而美的前端开源项目学习 / 贡献</li>
</ul>
<p>那么 Logoly 非常值得收藏一下。</p>
<ul>
<li>在线生成：<a href="https://link.juejin.cn?target=https%3A%2F%2Flogoly.pro%2F" target="_blank" title="https://logoly.pro/" ref="nofollow noopener noreferrer">logoly.pro/</a></li>
<li>源码仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbestony%2Flogoly" target="_blank" title="https://github.com/bestony/logoly" ref="nofollow noopener noreferrer">github.com/bestony/log…</a></li>
</ul>
<p>你可以先用线上版做几个 Logo 玩玩。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别堆叠，拥抱统一：金仓数据库“多模一体”开启文档处理新范式]]></title>    <link>https://juejin.cn/post/7595769731199483910</link>    <guid>https://juejin.cn/post/7595769731199483910</guid>    <pubDate>2026-01-16T15:19:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595769731199483910" data-draft-id="7595801647247949843" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别堆叠，拥抱统一：金仓数据库“多模一体”开启文档处理新范式"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T15:19:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别堆叠，拥抱统一：金仓数据库“多模一体”开启文档处理新范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T15:19:11.000Z" title="Fri Jan 16 2026 15:19:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>金仓数据库 MongoDB 兼容版通过“多模融合”架构重塑文档数据库新范式，其核心在于将文档模型深度集成于统一的企业级数据库内核中，实现关系型与文档型数据的统一处理与管理。以下从使用示例、性能对比、内核特性、迁移与高可用、实践案例等方面展开说明，最后附原文整理版。</p>
<hr/>
<h3 data-id="heading-0">一、金仓数据库 MongoDB 兼容版使用示例</h3>
<p>金仓数据库 MongoDB 兼容版支持 MongoDB 协议与常用语法，以下为基本操作示例：</p>
<h4 data-id="heading-1">1. 连接数据库（使用 Python pymongo 驱动）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pymongo <span class="hljs-keyword">import</span> MongoClient

<span class="hljs-comment"># 连接金仓数据库 MongoDB 兼容版</span>
client = MongoClient(<span class="hljs-string">'mongodb://username:password@host:port/admin'</span>)
db = client[<span class="hljs-string">'testdb'</span>]
collection = db[<span class="hljs-string">'testcol'</span>]
</code></pre>
<h4 data-id="heading-2">2. 插入与查询文档</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 插入文档</span>
db.<span class="hljs-property">testcol</span>.<span class="hljs-title function_">insertOne</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>,
  <span class="hljs-attr">address</span>: { <span class="hljs-attr">city</span>: <span class="hljs-string">"北京"</span>, <span class="hljs-attr">street</span>: <span class="hljs-string">"海淀区"</span> }
});

<span class="hljs-comment">// 查询嵌套字段</span>
db.<span class="hljs-property">testcol</span>.<span class="hljs-title function_">find</span>({ <span class="hljs-string">"address.city"</span>: <span class="hljs-string">"北京"</span> });
</code></pre>
<h4 data-id="heading-3">3. 创建索引</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建单字段索引</span>
db.<span class="hljs-property">testcol</span>.<span class="hljs-title function_">createIndex</span>({ <span class="hljs-attr">age</span>: <span class="hljs-number">1</span> });

<span class="hljs-comment">// 创建复合索引</span>
db.<span class="hljs-property">testcol</span>.<span class="hljs-title function_">createIndex</span>({ <span class="hljs-attr">name</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">age</span>: -<span class="hljs-number">1</span> });
</code></pre>
<h4 data-id="heading-4">4. 使用聚合管道</h4>
<pre><code class="hljs language-javascript" lang="javascript">db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">aggregate</span>([
  { <span class="hljs-attr">$match</span>: { <span class="hljs-attr">status</span>: <span class="hljs-string">"completed"</span> } },
  { <span class="hljs-attr">$group</span>: { <span class="hljs-attr">_id</span>: <span class="hljs-string">"$product"</span>, <span class="hljs-attr">total</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-string">"$amount"</span> } } }
]);
</code></pre>
<hr/>
<h3 data-id="heading-5">二、性能对比实测（基于 YCSB 与 Oracle 对比）</h3>
<ul>
<li><strong>vs MongoDB 7.0</strong>：在 YCSB 六种负载模型中，金仓数据库在读写混合、插入后读取等场景性能更优。</li>
<li><strong>vs Oracle 21.3</strong>：处理两层嵌套的轻量 JSON 数据时，金仓 BSON 引擎速度可达 Oracle OSON 的两倍。</li>
</ul>
<hr/>
<h3 data-id="heading-6">三、内核特性：多模融合架构</h3>
<ol>
<li><strong>统一查询优化层</strong>：支持关系、文档、向量等模型的代价评估与执行计划优化。</li>
<li><strong>统一索引框架</strong>：复用 B-Tree、RUM、HASH 等索引，支持自定义索引方法。</li>
<li><strong>企业级能力继承</strong>：原生支持强事务、高可用、高安全特性。</li>
</ol>
<hr/>
<h3 data-id="heading-7">四、无缝迁移与高可用保障</h3>
<ul>
<li><strong>协议兼容</strong>：兼容 MongoDB 5.0+ 协议及常用命令，支持 GridFS 大对象存储。</li>
<li><strong>高可用架构</strong>：读写分离集群（RWC）支持秒级故障切换（RTO&lt;30s）、数据零丢失（RPO=0），支持同城双活、两地三中心容灾。</li>
<li><strong>统一运维</strong>：通过 KEMCC 平台实现多模数据库的统一管控。</li>
</ul>
<hr/>
<h3 data-id="heading-8">五、实践案例：电子证照系统替代</h3>
<ul>
<li><strong>场景</strong>：福建某地市电子证照系统，原使用 MongoDB，数据量 2TB+，并发 1000+。</li>
<li><strong>迁移效果</strong>：平滑替代后稳定运行超 6 个月，并发能力提升，复杂查询响应从秒级降至毫秒级。</li>
</ul>
<hr/>
<h3 data-id="heading-9">六、结语</h3>
<p>金仓数据库 MongoDB 兼容版以多模融合、企业级内核、高兼容性与高性能，为文档数据库国产化替代与升级提供了新范式，助力企业构建统一、安全、高效的数据底座。</p>
<hr/>
<h3 data-id="heading-10">【原文整理版】</h3>
<p><strong>金仓数据库如何以“多模融合”重塑文档数据库新范式</strong></p>
<p>在数字化转型的深水区，企业对数据处理的期待已不止于存储与调用。文档数据库以其对半结构化数据的天然亲和力，成为现代应用开发的重要支柱。然而，当企业面临技术自主可控、供应链安全以及多模数据融合处理的新要求时，传统开源文档数据库在性能、可靠性与企业级服务能力上的局限逐渐显现。</p>
<p>电科金仓推出的金仓数据库 MongoDB 兼容版，正是为回应这一时代挑战而生。它并非简单的功能复刻，而是基于成熟的企业级内核，深度融合文档模型能力，为企业提供一条更安全、更强大、更易管理的国产化升级路径。</p>
<p><strong>性能实测：直面行业标杆，展现硬核底气</strong></p>
<p>性能是数据库的立身之本。金仓数据库 MongoDB 兼容版在权威的 YCSB(Yahoo! Cloud System Benchmark)基准测试中，与文档数据库的标杆 MongoDB 7.0展开了全面较量。测试覆盖了从读写均衡、读多写少到只读、读最近写入等六种典型业务负载模型。结果显示，在绝大多数场景下，金仓数据库的性能表现均优于或与 MongoDB 7.0持平，尤其在代表混合读写和插入后读取的场景中优势更为明显。这意味着，迁移至金仓数据库不仅能实现业务的无缝承接，更能在同等资源下为应用带来更优的吞吐与响应体验。</p>
<p>[图片]<br/>
图1-金仓数据库 MongoDB 兼容版 vs MongoDB7.0 性能对比</p>
<p>与此同时，在面对以处理复杂 JSON 数据著称的关系型数据库巨头 Oracle 时，金仓数据库的 BSON 格式处理引擎同样展现了竞争力。在更新嵌套两层的文档数据测试中，当 JSON 数据长度较小时，金仓数据库的处理速度可达 Oracle OSON 格式的两倍左右。这证明了其在处理轻量级至中等复杂度文档数据时的高效性，能够满足绝大多数业务系统对文档数据实时操作的需求，为从 Oracle 生态迁移或融合提供了有力的性能支撑。</p>
<p>[图片]<br/>
图2-金仓数据库 MongoDB 兼容版 (BSON) vs Oracle 21.3 (OSON) 性能对比</p>
<p><strong>内核筑基：企业级能力的原生继承</strong></p>
<p>金仓数据库 MongoDB 兼容版的强大，根植于其多年锤炼的企业级内核。它采用独特的原生扩展路径，将文档模型能力深度集成到统一的数据库内核中。这使得它天生继承了金仓数据库在强事务一致性、高可用、高安全等方面的完整基因。</p>
<p>在扩展性方面，金仓数据库的统一查询优化层能够为关系、文档、向量等数据模型定制代价评估，生成最优执行计划。其统一的索引框架则允许用户复用成熟的 B-Tree、RUM、HASH 等索引类型，甚至为自定义索引方法留出接口，为复杂查询提供了强大的加速引擎。这种“多模一体”的架构，意味着企业无需为不同数据类型维护多套独立的数据库系统，极大地简化了技术栈，降低了总体拥有成本和运维复杂度。</p>
<p><strong>无缝迁移与极致可用：平滑过渡与业务永续的保障</strong></p>
<p>降低迁移成本是技术替代成功的关键。当前，金仓数据库对 MongoDB 的常用命令和操作符兼容度接近 100%，支持对 MongoDB 5.0+ 版本通信协议的原生兼容。这意味着，现有的 MongoDB 应用程序几乎无需修改业务代码，仅需调整数据库连接地址，即可实现“零代码”迁移，为开发者提供平滑的过渡体验。同时，针对文档数据库典型的大对象存储需求，金仓数据库通过原生支持 GridFS 协议提供支撑。</p>
<p>在关乎业务连续性的高可用方面，继承了金仓数据库从实例、集群到多中心的完整保障体系。金仓数据库读写分离集群（RWC）支持故障秒级自动切换（RTO&lt;30s）且保证数据零丢失（RPO=0），支持同城双活、两地三中心等高级容灾部署，实现跨数据中心的数据实时同步与故障应急切换，满足金融、政务等关键业务对服务永续的严苛要求。</p>
<p>在运维管理层面，统一的管控平台 KEMCC 让数据库管理员无需为文档数据单独部署和学习新的运维系统，在一个界面内即可完成对多种数据库实例的统一监控、管理和智能调优。</p>
<p><strong>实践验证：电子证照系统的平滑替代</strong></p>
<p>理论的优越性需要实践的检验。金仓数据库为福建某地市电子证照共享服务系统，提供了国产化升级改造方案。原系统长期依赖 MongoDB，面临 2TB+ 数据量、1000+ 并发压力等挑战。通过金仓数据库 MongoDB 兼容版的协议级兼容能力，实现了从 MongoDB 到国产数据库的平滑升级。</p>
<p>迁移后系统已稳定运行超 6 个月，有效支撑了当地 500 余家单位的证照共享服务。其读写分离集群架构将系统并发承载能力显著提升，并通过针对性的场景化优化，将部分复杂查询的响应时间从数秒缩短至毫秒级。</p>
<p>这一成功案例并非孤例，在金融、能源、运营商等多个行业的核心业务系统中，金仓数据库凭借其高兼容、高性能和高可靠的特性，已成功实现对原有架构的替代与升级，验证了其承载关键业务的成熟能力。</p>
<p><strong>结语：面向未来的多模智慧底座</strong></p>
<p>金仓数据库 MongoDB 兼容版的推出，并非一场简单的功能复刻。它代表了一种以企业级需求为出发点，以技术自主为根基，以多模融合为方向的数据库发展新思路。在性能上对标乃至超越主流产品，在兼容性上最大限度保护用户现有投资，在能力上提供更完整、更可靠的企业级服务。</p>
<p>对于正在寻求文档数据库国产化替代，或希望构建统一、高效、安全数据底座的企业而言，金仓数据库 MongoDB 兼容版提供了一个兼具前瞻性与实用性的坚实选择。它不仅是 MongoDB 的替代品，更是企业迈向下一代多模融合数据管理平台的桥梁，助力企业在数智化转型中行稳致远。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose GPU加速特效：带缩放的故障效果]]></title>    <link>https://juejin.cn/post/7595764380472868914</link>    <guid>https://juejin.cn/post/7595764380472868914</guid>    <pubDate>2026-01-16T15:06:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595764380472868914" data-draft-id="7594662879201935386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose GPU加速特效：带缩放的故障效果"/> <meta itemprop="keywords" content="Android,Android Jetpack,Kotlin"/> <meta itemprop="datePublished" content="2026-01-16T15:06:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="稀有猿诉"/> <meta itemprop="url" content="https://juejin.cn/user/2788017216685784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose GPU加速特效：带缩放的故障效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017216685784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    稀有猿诉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T15:06:33.000Z" title="Fri Jan 16 2026 15:06:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文译自「GPU-Accelerated Effects: Glitch at Scale」，原文链接<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40konstantinzolotov%2Fgpu-accelerated-effects-glitch-at-scale-e59216afd1e8" target="_blank" title="https://medium.com/@konstantinzolotov/gpu-accelerated-effects-glitch-at-scale-e59216afd1e8" ref="nofollow noopener noreferrer">medium.com/@konstantin…</a>，由Konstantin Zolotov发布于2025年11月9日。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65a0322db637408e8f7cf292b6ec0c5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=Ec7gzeJetDlHHCcU4UZQpKPMKUY%3D" alt="0.gif" loading="lazy"/></p>
<p>几周前，我看到了Sina Samaki撰写的一篇关于使用Jetpack Compose制作故障效果的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sinasamaki.com%2Fglitch-effect-in-jetpack-compose%2F" target="_blank" title="https://www.sinasamaki.com/glitch-effect-in-jetpack-compose/" ref="nofollow noopener noreferrer">精彩文章</a>。作为一个喜欢钻研底层技术的人，我看到了使用Android AGSL着色器重现这种效果并比较两种实现方式的绝佳机会。</p>
<p>在图形处理方面，选择合适的工具至关重要，因为很容易达到性能瓶颈，而扩展解决方案则变得困难。这里的情况是否如此呢？让我们一探究竟！</p>
<p>做好准备，我们将深入底层。</p>
<h2 data-id="heading-0">着色器(Shader)的本质</h2>
<p>那么，着色器究竟是什么？</p>
<p>着色器是一种直接在 GPU 上执行的程序，并且可以并行执行。</p>
<p>着色器通常使用一种特殊的类 C 语言编写，在 Android Compose 中，这种语言是 AGSL——Android 图形着色语言。</p>
<p>我不会重复<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fdevelop%2Fui%2Fviews%2Fgraphics%2Fagsl" target="_blank" title="https://developer.android.com/develop/ui/views/graphics/agsl" ref="nofollow noopener noreferrer">官方指南</a>的内容，而是会简单介绍一下 GPU 以及一种新的着色器编程思维模型。</p>
<p>那么，它与 CPU 有什么区别呢？ CPU 和 GPU 的主要区别基本上如下：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e285ce1c68548e2aa4d9f732913d3bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=PF%2Fyamhz8ivuBhmoU98gGZcDIEM%3D" alt="https://developer.nvidia.com/blog/cuda-refresher-reviewing-the-origins-of-gpu-computing/" width="70%" loading="lazy"/></p>
<p>CPU：</p>
<ul>
<li>更复杂</li>
<li>专为执行大量不同任务的大型程序而设计</li>
<li>MIMD（多指令多数据流）</li>
</ul>
<p>GPU：</p>
<ul>
<li>简单得多（没有分支预测，缓存更小）</li>
<li>专为对各种数据执行完全相同操作的小型程序而设计</li>
<li>更多核心 = 更高的并行性</li>
<li>SIMD（单指令多数据流）</li>
</ul>
<p>当然，CPU 也有 SIMD 扩展，但规模远不及 GPU。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e9351f0a2384c549682901f1186cde7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=BErs9%2F4p6Bu65NygscbUO%2Bel4nY%3D" alt="https://developer.nvidia.com/blog/cuda-refresher-reviewing-the-origins-of-gpu-computing/" width="70%" loading="lazy"/></p>
<blockquote>
<p>GPU 非常适合对数百万像素执行相同的操作</p>
</blockquote>
<p>这里存在一个非常重要的<strong>思维模型转变</strong>：以前你可以在画布的任意位置绘制，而现在你面对的是一幅图像，你可以对图像的任何部分进行采样（读取），但输出结果始终是一个像素。每个目标像素都会执行相同的着色器。这类似于一个纯函数，不会产生任何副作用，因此像素仅取决于其坐标和提供的 uniform 变量。</p>
<p>让我们开始实现吧，但首先，分析<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sinasamaki.com%2Fglitch-effect%2F" target="_blank" title="https://www.sinasamaki.com/glitch-effect/" ref="nofollow noopener noreferrer">原始合成版本</a>中的关键点，并将这些想法转化为着色器思维模型。</p>
<p>关键的动画驱动因素是步长。动画器会在 500 毫秒的周期内，将浮点数值从 10 递减到 0。步长状态为整数，由于浮点数会被转换为整数，因此共有 11 个步长。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">var</span> step <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
LaunchedEffect(key) {
   Animatable(<span class="hljs-number">10f</span>)
       .animateTo(
           targetValue = <span class="hljs-number">0f</span>,
           animationSpec = tween(
               durationMillis = <span class="hljs-number">500</span>,
               easing = LinearEasing,
           )
       ) {
           step = <span class="hljs-keyword">this</span>.value.roundToInt()
       }
}
</code></pre>
<p>此外，还有一个名为强度的参数，它基于步长计算：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> intensity = step / <span class="hljs-number">10f</span>
</code></pre>
<p>因此，强度是一个数值序列 [1.0, 0.9, …, 0.0]。</p>
<p>下一个关键点是切片：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until slices) {
    translate(
        left = <span class="hljs-keyword">if</span> (Random.nextInt(<span class="hljs-number">5</span>) &lt; step)
            Random.nextInt(-<span class="hljs-number">20.</span><span class="hljs-number">.20</span>).toFloat() * intensity
        <span class="hljs-keyword">else</span>
            <span class="hljs-number">0f</span>,
    ) {
        scale(
            scaleY = <span class="hljs-number">1f</span>,
            scaleX = <span class="hljs-keyword">if</span> (Random.nextInt(<span class="hljs-number">10</span>) &lt; step)
                <span class="hljs-number">1f</span> + (<span class="hljs-number">1f</span> * Random.nextFloat() * intensity)
            <span class="hljs-keyword">else</span>
                <span class="hljs-number">1f</span>,
        ) {
            clipRect(
                top = (i / slices.toFloat()) * size.height,
                bottom = (((i + <span class="hljs-number">1</span>) / slices.toFloat()) * size.height) + <span class="hljs-number">1f</span>,
            ) {
                layer {
                    drawLayer(graphicsLayer)
                    <span class="hljs-keyword">if</span> (Random.nextInt(<span class="hljs-number">5</span>, <span class="hljs-number">30</span>) &lt; step) {
                        drawRect(
                            color = glitchColors.random(),
                            blendMode = BlendMode.SrcAtop,
                        )
                    }
                }
            }
        }
    }
}
</code></pre>
<p>对于每个切片，都会应用以下变换：</p>
<p><strong>1. 平移</strong></p>
<ul>
<li>在步骤 10 到 5 期间，每个切片会随机移动 -20 到 20 范围内的像素。请注意，每一步操作都会使该范围缩小，因为它会乘以强度。</li>
<li>在步骤 4 到 0 中也会发生类似的情况，但并非每个切片都会移动，有些切片不会被移动。</li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a63effe943b490d83775525c9c5e87e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=SnxyTQoCoDfASaULdYpExnQ%2Fo5o%3D" alt="" width="70%" loading="lazy"/></p>
<p><strong>2. 水平缩放</strong> 每个切片都会根据强度乘以 1.0 到 2.0 范围内的随机数进行缩放，每一步操作都会降低缩放的概率和大小。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6f9f6c2df594f55b6e2be50035ee28c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=l99ooXrZzH%2FZ1%2F6fIkmDQdn4m7I%3D" alt="4.gif" width="70%" loading="lazy"/></p>
<p><strong>3.彩色条纹</strong></p>
<ul>
<li>在步骤 10 到 5 中，在每个切片上绘制一条随机彩色条纹，初始概率为 0.2，到步骤 5 时降至 0。</li>
<li>步骤 5 之后不再绘制条纹。</li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5ae93039de648c58c7e9c103bd96a06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=cZkPhqPS7Duc7%2FUuqu2qziLS0n0%3D" alt="5.gif" width="70%" loading="lazy"/></p>
<p>因此，总体而言，动画在前几个步骤中最具表现力，并在后半部分逐渐趋于稳定。</p>
<p>对于着色器而言，强度应该足以驱动动画，而无需使用步骤。在 Kotlin 代码中，我仍然会使用步骤 + 强度，仅仅是为了尽可能地复现动画效果，并用于未来的性能测试。</p>
<p><strong>思维模型转变：</strong> 着色器是逐像素执行的，但动画会将相同的变换应用于像素组（在本例中为切片）。为了在着色器中实现这一点，我们需要对整个切片进行完全相同的计算。还记得纯函数的相似性吗？它在这里非常有用，因为要得到相同的结果，我们只需要应用相同的参数！</p>
<p>具有相同变换的像素组就是一个切片：</p>
<pre><code class="hljs language-glsl" lang="glsl">uniform shader image;
uniform float2 imageSize; // Shader area size in pixels
uniform float intensity;
uniform int slices;// fragCoord — pixel coordinates
half4 main(float2 fragCoord) {
    // Create horizontal slices
    float sliceHeight = imageSize.y / float(slices); // Height of each slice in pixels
    float sliceY = floor(fragCoord.y / sliceHeight) * sliceHeight; // Start coordinates for each slice

    // ...
}
</code></pre>
<p>让我们一步一步来，从平移开始。</p>
<h2 data-id="heading-1">平移</h2>
<p>步骤 10 到 5 等价于强度从 1.0 到 0.5，每次递减 0.1。因此，我们将以此为基础来移动切片：</p>
<pre><code class="hljs language-glsl" lang="glsl">// Simple random functions
float random(float seed) {
  return fract(sin(seed) * 100000.0);
}

float random(float2 st) {
    return fract(sin(dot(st.xy, float2(12.9898, 78.233))) * 43758.5453123);
}

// Determine how much this slice should be displaced
float displace(float sliceY, float intensity) {
    float rnd = random(float2(sliceY, intensity));

    float shouldDisplace;
    if (intensity &lt; 0.5 &amp;&amp; intensity &gt; rnd * 0.4) {
        shouldDisplace = 0.0;
    } else {
        shouldDisplace = 1.0;
    }

    return (rnd - 0.5) * 40.0 * intensity * shouldDisplace
}
</code></pre>
<p>这里发生了什么？</p>
<p>首先，是随机性。由于着色器本身没有随机性，因此通常使用一些函数来模拟随机性。这两个函数都会返回一个介于 0（含）和 1（不含）之间的浮点值。在这种情况下，“随机”值对于每个切片-帧组合都是唯一的。对于给定帧，均匀强度对于所有调用（= 输出像素）都是相同的，同一组像素的切片坐标也相同。结合切片起始坐标，这个值对于每一帧的每个切片都是不同的。</p>
<p>接下来，如果强度超过 0.5，<code>shouldDisplace</code> 因子会立即设置为 1.0，这意味着切片需要进行位移。否则，<code>intensity &gt; rnd * 0.4</code> 会导致执行位移的概率下降，类似于原始实现中的 <code>Random.nextInt(5) &lt; step</code>。</p>
<p>最后一行只是简单的算术运算。这里我将 0 到 1 的伪随机值转换为 -20 到 20，然后像原始实现一样乘以强度，并在发生位移时应用该因子。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f54da4ab1aa482986be4f61a74efdfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=LeOJg7C5Ts4HZtOfo5kdcv0ddfE%3D" alt="6.gif" width="70%" loading="lazy"/></p>
<h2 data-id="heading-2">缩放</h2>
<p>屏幕空间缩放本质上是指相对于枢轴点（本例中为水平中心）调整像素采样坐标。由于我们是从源图像读取数据，因此实际上是移动了采样视口。</p>
<pre><code class="hljs language-glsl" lang="glsl">float2 scale(float2 coord, float yMin, float yMax, float screenWidth, float intensity) {
   float rnd = random(float2(yMin, intensity));
   
   if (coord.y &gt;= yMin &amp;&amp; coord.y &lt;= yMax &amp;&amp; rnd &lt; intensity) {
       float centerX = screenWidth * 0.5;

       float localX = coord.x - centerX;
       float scaleFactor = 1f + (intensity * rnd);
       localX /= scaleFactor;

       float scaledX = localX + centerX;

       return float2(scaledX, coord.y);
   }

   return coord;
}
</code></pre>
<blockquote>
<p>附注：为了演示，我尽量简化了逻辑。生产环境中的着色器代码通常会使用更高级的技术来避免分支，因为像上面示例中那样的不平衡分支会迫使 GPU 串行执行两条路径，从而破坏并行性。要以优化的方式实现缩放函数并非易事，所以我采用了一种简单的方法。</p>
</blockquote>
<p>再次强调，对于每一帧的每个切片，随机数都是唯一的，这意味着特定切片中的每个像素都会获得相同的值。因此，<code>rnd &lt; intensity</code> 会降低概率，类似于 <code>Random.nextInt(10) &lt; step</code>。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e76e4a1522434e0a8bd1d5d813534ef5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=Ujnd3xypHpb%2FUxnQavkBTiu1mXk%3D" alt="7.gif" width="70%" loading="lazy"/></p>
<h2 data-id="heading-3">彩色条纹</h2>
<p>最简单的部分。类似地，如果应用了色带，则创建相同的概率，然后选择 3 种颜色中的一种。可以使用非硬编码值，但这需要一些额外的工作，因此 Compose 版本在这方面更灵活。</p>
<pre><code class="hljs language-glsl" lang="glsl">float rnd = random(float2(intensity, sliceY));
if ((rnd * 2.5 + 0.5) &lt; intensity) {
   if (rnd &gt; 0.67) {
       return yellow;
   } else if (rnd &gt; 0.33) {
       return red;
   } else {
       return cyan;
   }
} else {
   float2 scaled = scale(displaced, sliceY, sliceY + sliceHeight, imageSize.y, intensity);
   return image.eval(scaled);
}
</code></pre>
<p>将所有内容组合在一起后，结果如下：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/611368bd9ec8468b91b5e809b372aa6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=4sLQOrSxreHd5dL%2FPOIuyFFTw1g%3D" alt="8.gif" width="70%" loading="lazy"/></p>
<p>存在一个明显的问题：叠加层的颜色始终为青色。这是因为伪随机函数对相同的输入返回相同的值——这是设计上的确定性行为。解决方案：在 Kotlin 端生成真正的随机数，并将其作为 uniform 变量传递。</p>
<pre><code class="hljs language-glsl" lang="glsl">-float rnd = random(float2(intensity, sliceY));
+float rnd = random(float2(intensity * realRandom, sliceY));
 if ((rnd * 2.5 + 0.5) &lt; intensity) {
-if (rnd &gt; 0.67) {
+if (realRandom &gt; 0.67) {
         return yellow;
-} else if (rnd &gt; 0.33) {
+} else if (realRandom &gt; 0.33) {
         return red;
     } else {
         return cyan;
     }
} else {
    float2 scaled = scale(displaced, sliceY, sliceY + sliceHeight, imageSize.y, intensity);
    return image.eval(scaled);
}
</code></pre>
<p>应用适当的随机性后，整个过程与原始行为非常接近：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1bc4708dedf420f89e3462c62a8e79a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=I2MxOg0KsjZN9Dc9fKYxPZaTDWo%3D" alt="9.gif" loading="lazy"/></p>
<p>完整代码发布于<a href="https://link.juejin.cn?target=https%3A%2F%2Fgist.github.com%2FMightySeal%2F97687eaaf5eeeb1322a9f6f837dc5c35" target="_blank" title="https://gist.github.com/MightySeal/97687eaaf5eeeb1322a9f6f837dc5c35" ref="nofollow noopener noreferrer">此处</a>。</p>
<p>当然，在进行图形编程时，至少需要进行一些粗略的性能观察。为此，我将使用我的 Pixel 7，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftopic%2Fperformance%2Frendering%2Finspect-gpu-rendering" target="_blank" title="https://developer.android.com/topic/performance/rendering/inspect-gpu-rendering" ref="nofollow noopener noreferrer">启用 HWUI 渲染图表</a>，并稍作修改代码：使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fkotlin%2Fandroidx%2Fcompose%2Fanimation%2Fcore%2Fpackage-summary%23infiniteRepeatable(androidx.compose.animation.core.DurationBasedAnimationSpec%2Candroidx.compose.animation.core.RepeatMode%2Candroidx.compose.animation.core.StartOffset)" target="_blank" title="https://developer.android.com/reference/kotlin/androidx/compose/animation/core/package-summary#infiniteRepeatable(androidx.compose.animation.core.DurationBasedAnimationSpec,androidx.compose.animation.core.RepeatMode,androidx.compose.animation.core.StartOffset)" ref="nofollow noopener noreferrer">infiniteRepeatable</a> 规范实现循环动画，并使用发布版本。Pixel 7 实际上非常适合这项任务，因为它并非高端设备，如果它在 Pixel 7 上有效，那么在性能更高的设备上也应该有效。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea845c1277924ecca74b295419e9e4d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=elo7wrn8Tasdh8bNNKStnI2hHRg%3D" alt="10.gif" width="50%" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a899e3c0039a40fea0714f41f98104d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=Kc4kaNZD89xrR93QCkGlO4FFIE4%3D" alt="11.gif" width="50%" loading="lazy"/></p>
<p><strong/></p><p align="center"><strong>左侧为着色器，右侧为Compose</strong></p><p/>
<p>乍一看，这两个图表似乎很相似，但实际上存在一个问题：当前的实现方式隐式地限制了帧速率。动画会将浮点数值从 10 递减到 0，但状态更新时会使用四舍五入为整数的值。这意味着在 500 毫秒内只有 11 帧动画。这对于故障着色器来说非常方便，因为较低的帧速率也会增强故障效果。要消除这个限制，我们只需要将步长类型从整数 (Int) 更改为浮点数 (Float)，并使用不进行四舍五入的可动画值即可。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">-<span class="hljs-keyword">var</span> step <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
+<span class="hljs-keyword">var</span> step <span class="hljs-keyword">by</span> remember { mutableFloatStateOf(<span class="hljs-number">0f</span>) }
LaunchedEffect(key) {
   Animatable(<span class="hljs-number">10f</span>)
       .animateTo(
           targetValue = <span class="hljs-number">0f</span>,
           animationSpec = tween(
               durationMillis = <span class="hljs-number">500</span>,
               easing = LinearEasing,
           )
       ) {
-          step = <span class="hljs-keyword">this</span>.value.roundToInt()
+          step = <span class="hljs-keyword">this</span>.value
       }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f54e38c764641faa0aac3c65f5a5095~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=YVA%2Bach4KXvKyGwlkFf6aO0b8%2Fg%3D" alt="12.gif" width="50%" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da1193a4b9914963815fb3924e741d57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=%2Bw0O5sC9X7ylXPKEn3sG8f0ncQ8%3D" alt="13.gif" width="50%" loading="lazy"/>
<strong/></p><p align="center"><strong>左侧为着色器，右侧为Compose，无帧数限制</strong></p><p/>
<p>移除帧数限制后，性能提升已经非常明显。我们来做个压力测试。如果将动画应用于整个列表会发生什么？或者切片数量增加会发生什么？让我们拭目以待！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67871597bfb142b7b071597bf6871836~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=Tu7eRjGTnfZvKI8F2FT7yFFF%2BmU%3D" alt="14-opt.gif" width="50%" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8d44eb4e3cf43c8bb37bbf1132c0712~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=Y6ACo3eVIaByJy4fEJl4zpZzD7o%3D" alt="15-opt.gif" width="50%" loading="lazy"/>
<strong/></p><p align="center"><strong>左侧着色器，右侧Compose，无帧数限制，应用于整个列表</strong></p><p/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c4f4e130b20482cac776f71d9f3dead~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=uXcjAmmBNbOw9Xa4iklxod0apEY%3D" alt="16-opt.gif" width="50%" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd3d106180f943e88618ef705974cbb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=AmH4sFENHIr5Hg8ztx97SNR1l28%3D" alt="17-opt.gif" width="50%" loading="lazy"/>
<strong/></p><p align="center"><strong>左侧着色器，右侧Compose，无帧数限制，应用于整个列表100 个切片</strong></p><p/>
<h2 data-id="heading-4">结论</h2>
<p>Jetpack Compose非常适合用于复杂动画的原型设计，因为它可以使用熟悉的工具轻松实现。此外，值得一提的是，它适用于所有设备。</p>
<p>另一方面，着色器提供了性能更高、更稳定的渲染。在这种情况下，使用的切片数量无关紧要——无论是 20 个还是 500 个，计算量都没有区别，而纯 Compose 版本对此非常敏感，并且会随着切片数量的增加而线性增长。</p>
<p>此外，由于 AGSL 着色器只是在运行时临时编译的文本，因此理论上可以从后端更新这些动画。</p>
<p>但是，还有一个很大的问题：着色器从 Android 13 开始可用，因此根据 Android Studio 操作系统的发行情况，大约一半的设备将能够支持这种方法。当然，这种情况会随着时间的推移而改变，我希望我们能够利用着色器充分发挥图形编程的强大功能！</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f283fa306ded4e6eba6f6178b5186213~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769180793&amp;x-signature=XXn%2FpJQ%2BVgjIVKaSzGEvSBeQGvY%3D" alt="" width="70%" loading="lazy"/></p>
<p>这是我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fbento.me%2Fmightyseal" target="_blank" title="https://bento.me/mightyseal" ref="nofollow noopener noreferrer">bento</a>，如果你想联系我、聊天或讨论，欢迎来找我！</p>
<blockquote>
<p>欢迎搜索并关注 <em>公众号<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fqrcode%3Fscene%3D10000004%26size%3D512%26__biz%3DMzU1MDg0NDczNA%3D%3D%26mid%3D2247484417%26idx%3D1%26sn%3D60c15f0d3c4be75e37748c2472a74102" target="_blank" title="https://mp.weixin.qq.com/mp/qrcode?scene=10000004&amp;size=512&amp;__biz=MzU1MDg0NDczNA==&amp;mid=2247484417&amp;idx=1&amp;sn=60c15f0d3c4be75e37748c2472a74102" ref="nofollow noopener noreferrer">「稀有猿诉」</a></em> 获取更多的优质文章！</p>
<p>保护原创，请勿转载！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[图解DeepSeek最新论文，人人都能看得懂！]]></title>    <link>https://juejin.cn/post/7595815509234909224</link>    <guid>https://juejin.cn/post/7595815509234909224</guid>    <pubDate>2026-01-16T15:26:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595815509234909224" data-draft-id="7595831648825229352" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="图解DeepSeek最新论文，人人都能看得懂！"/> <meta itemprop="keywords" content="AIGC,DeepSeek"/> <meta itemprop="datePublished" content="2026-01-16T15:26:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="饼干哥哥"/> <meta itemprop="url" content="https://juejin.cn/user/2001569972490973"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            图解DeepSeek最新论文，人人都能看得懂！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2001569972490973/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    饼干哥哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T15:26:15.000Z" title="Fri Jan 16 2026 15:26:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>DeepSeek 又发论文了。</p>
<p>这一次，没有惊天动地的参数军备竞赛，没有万卡集群的暴力美学。</p>
<p>他们只是冷静地指出了当前 AI 届一个“皇帝的新衣”：</p>
<p>我们最顶尖的大模型，其实都在做着极其愚蠢的事情。</p>
<p>在这篇名为《Conditional Memory via Scalable Lookup》（基于可扩展查找的条件记忆）的论文中，DeepSeek 创始人梁文锋亲自署名，揭示了下一代大模型架构（V4？）的核心秘密：与其让模型更努力地“思考”，不如教它学会“作弊”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/073d6b9f665441a5881bc4ed328c3a68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aW85bmy5ZOl5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769181975&amp;x-signature=CLPHstth0HMtSfS%2BM95C8E0%2B1a8%3D" alt="Image" loading="lazy"/></p>
<h3 data-id="heading-0">01.愚蠢的天才：为什么要用算力去模拟查表？</h3>
<p>想象一下，你面前坐着爱因斯坦。你问他：“1+1 等于几？”</p>
<p>正常的爱因斯坦会直接脱口而出：“2”。</p>
<p>但现在的大模型（LLM）是这么做的：他满头大汗地拿起粉笔，从皮亚诺公理开始推导，证明自然数的定义，消耗了巨大的脑力，最后告诉你：“答案是 2。”</p>
<p>这就是当前 Transformer 架构的痛点。</p>
<p>DeepSeek 在论文中指出：大模型缺乏原生的“查字典”能力。当它遇到“亚历山大大帝是谁”或者“水的化学式是什么”这种静态知识时，它不得不动用昂贵的神经网络层，一层一层地去“计算”出这个答案。</p>
<p>研究显示，模型为了认出“戴安娜王妃”这个实体，竟然要消耗掉整整 6 层网络的深度。</p>
<p>这不叫智能，这叫算力的极大浪费。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ff816f560f24c44ae2fa2c47f885902~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aW85bmy5ZOl5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769181975&amp;x-signature=qh%2BdY9mTSsJwEwRe3GBZ3wT8wQM%3D" alt="Image" loading="lazy"/></p>
<p>图中的水滴，不是水，是这个大脑汗颜💧了哈哈哈笑死</p>
<h3 data-id="heading-1">02. 给爱因斯坦发一本字典：Engram 机制</h3>
<p>DeepSeek 的解决方案非常优雅，他们提出了一个叫 Engram（印迹） 的模块。</p>
<p>Engram 的核心逻辑很简单：查算分离。</p>
<p>既然“亚历山大大帝”是一个固定的知识点，为什么不把它做成一张小抄？</p>
<p>DeepSeek 给模型外挂了一个巨大的、可学习的 N-gram 嵌入表（Embedding Table）。</p>
<p>当模型读到“Alexander the Great”这几个词时，它不再需要动用大脑去推理，而是直接触发 O(1)的查表操作。</p>
<p>系统会瞬间定位到字典的这一页，把预存好的知识向量直接提取出来，注入到网络中。整个过程不需要“思考”，只需要“翻页”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a164fe5e7b54d5e9558b7c0d22c15e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aW85bmy5ZOl5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769181975&amp;x-signature=Kcsr%2Bz5fpAa5rQxJYqc6XN7ZFW0%3D" alt="Image" loading="lazy"/></p>
<p>这就是论文标题中 “Conditional Memory”（条件记忆） 的含义：把死记硬背的工作从计算流中剥离出来，变成极低成本的查表操作。</p>
<h3 data-id="heading-2">03. 博尔赫斯的诅咒与 75%定律</h3>
<p>那么问题来了：既然查表这么快，我们能不能把所有东西都存进字典里，做一个“纯记忆”的模型？</p>
<p>博尔赫斯在小说《博闻强记的富内斯》中早就给出了答案：那个记住了每一片树叶形状的富内斯，最终失去了思考的能力。完美的记忆会杀死抽象的思考。</p>
<p>DeepSeek 在论文中做了一个非常硬核的实验：如果总参数量（预算）固定，我们应该分多少给“大脑”（MoE 专家），分多少给“字典”（Engram 表）？</p>
<p>结果画出了一条完美的 U 型曲线 ：</p>
<ul>
<li>纯 MoE（全靠算）： 累死，效果不是最优。</li>
<li>纯 Engram（全靠记）： 变傻，缺乏逻辑推理能力。</li>
<li>黄金比例：约 75% 的参数给 MoE 负责思考，20%-25% 的参数给 Engram 负责记忆。</li>
</ul>
<p>这就是 DeepSeek 算出的“上帝配方”：记忆与计算，必须在架构层面实现完美的平衡。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b0ee1dbf61c4df384f97bb1de15360a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aW85bmy5ZOl5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769181975&amp;x-signature=xkhEfQtC%2Bep7mI04UFa3iSL9I3E%3D" alt="Image" loading="lazy"/></p>
<h3 data-id="heading-3">04. 腾笼换鸟：当第 5 层变成了第 12 层</h3>
<p>这篇论文最反直觉的发现来了。</p>
<p>你可能认为：加了“记忆外挂”，模型应该只是知识更渊博（文科更好）对吧？</p>
<p>错。DeepSeek 发现，加了 Engram 之后，模型的理科成绩（数学、代码、逻辑推理）暴涨！</p>
<ul>
<li>MATH（数学）： 提升 2.4 分</li>
<li>HumanEval（代码）： 提升 3.0 分</li>
<li>BBH（通用推理）： 提升 5.0 分</li>
</ul>
<p>为什么？这就是 “腾笼换鸟” 的效应。</p>
<p>在普通模型中，前几层网络都在忙着做“名词解释”和“背景调查” 。而在 Engram 模型中，因为第 2 层就通过查表搞定了这些基础工作，后续的深层网络被彻底解放了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8efd42ca8dbc4b7c9fd47e9811954ddd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aW85bmy5ZOl5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769181975&amp;x-signature=JAXg%2Fdvgj12Afg91GFCcnTFMNI8%3D" alt="Image" loading="lazy"/></p>
<p>DeepSeek 的分析显示：Engram 模型在第 5 层达到的“思考深度”，相当于普通模型第 12 层的水平。</p>
<p>这相当于免费给大楼加盖了楼层！省下来的算力，全部被用来处理那些真正需要智商的高难度逻辑。</p>
<h3 data-id="heading-4">05. 把大象装进抽屉里：一场硬件的突围</h3>
<p>最后，也是这篇论文最让工程界沸腾的一点：它打破了 GPU 的显存霸权。</p>
<p>众所周知，英伟达的 GPU 显存（HBM）比金子还贵。如果 Engram 的字典表高达 1000 亿参数，显卡根本装不下怎么办？</p>
<p>DeepSeek 说：谁让你装在显卡里了？</p>
<p>不同于 MoE 必须在计算时动态路由，Engram 的查表是 确定性（Deterministic） 的。</p>
<p>这意味着，模型刚看到输入，还没开始算第 1 层，系统就已经知道第 2 层需要查字典的哪一页了。</p>
<p>于是，DeepSeek 设计了一套 异步预取（Async Prefetch） 机制。他们把巨大的字典存放在廉价、海量的 CPU 内存（RAM） 里。当 GPU 在计算前一层时，数据就已经通过 PCIe 通道，悄悄从内存传输到了显存里。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/311dc9b5e1d34309a871622fbbc23c1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aW85bmy5ZOl5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769181975&amp;x-signature=Ua%2BTeOvv1z%2FRUMaem0bKmwtYecA%3D" alt="Image" loading="lazy"/></p>
<p>实验数据炸裂：哪怕外挂 1000 亿参数的字典，推理速度只慢了不到 3%</p>
<p>这是一场极致的 硬件-算法协同设计。在算力受限的当下，DeepSeek 用廉价的内存换取了昂贵的模型容量，走出了一条属于自己的路。</p>
<h3 data-id="heading-5">论文本质上是在讲 “取舍”</h3>
<p>在摩尔定律放缓、显卡供不应求的今天，继续暴力堆叠参数已经不够性感了。真正的智能，不仅仅是算得更快，而是知道 什么该算，什么该记。</p>
<p>正如论文结尾所说：“我们预见，条件记忆（Conditional Memory）将成为下一代稀疏模型的必选组件。”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[刷屏全网的“nano-banana”API接入指南！0.1元/张量产高清创意图，开发者必藏]]></title>    <link>https://juejin.cn/post/7595683968684720174</link>    <guid>https://juejin.cn/post/7595683968684720174</guid>    <pubDate>2026-01-16T15:31:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595683968684720174" data-draft-id="7595831738233569289" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="刷屏全网的“nano-banana”API接入指南！0.1元/张量产高清创意图，开发者必藏"/> <meta itemprop="keywords" content="API"/> <meta itemprop="datePublished" content="2026-01-16T15:31:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="崔庆才丨静觅"/> <meta itemprop="url" content="https://juejin.cn/user/1521379821230269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            刷屏全网的“nano-banana”API接入指南！0.1元/张量产高清创意图，开发者必藏
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379821230269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    崔庆才丨静觅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T15:31:23.000Z" title="Fri Jan 16 2026 15:31:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、nano-banana 爆火背景与核心优势</h2>
<p>最近 AI 圈彻底被“纳米香蕉”承包！X 平台 16 万浏览量的 3D 手办生成图、网友复刻的《黑神话·钟馗》周边、老照片修复、跨时空合照等玩法刷屏全网。其本质是谷歌 Gemini 2.5 Flash Image 模型的“隐藏款”，通过 API 调用可将“创意超能力”植入自有产品或工作流。</p>
<h3 data-id="heading-1">官方API痛点</h3>
<p>官方 API 存在两大核心问题：① 成本高，0.039 美元/张（约0.28元）；② 受网络限制，大规模调用成本压力大。</p>
<h3 data-id="heading-2">ACE Data Platform 生态加持优势</h3>
<p>推荐 ACE Data Platform的nano-banana API 接入方案（专属对接链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.acedata.cloud%2Fdocuments%2F23985a11-d713-41d1-ad84-24b021805b3d" target="_blank" title="https://platform.acedata.cloud/documents/23985a11-d713-41d1-ad84-24b021805b3d" ref="nofollow noopener noreferrer">ACE Data Platform nano-banana API专属对接页面</a>），核心优势：兼顾低成本（0.1 元/张量产）、高稳定、强扩展性，适配个人创作与商业部署全场景。</p>
<h2 data-id="heading-3">二、4 大核心能力（碾压同类的硬实力）</h2>
<p>nano-banana API 凭以下 4 大功能成为开发者“生产力利器”：</p>
<ol>
<li><strong>角色一致性拉满</strong>：多次编辑可精准保留人物脸部特征、发型与服装风格，更换场景、调整姿势后主体辨识度仍在线；适配虚拟试衣 APP、连贯故事分镜生成等场景，无需反复调整参数。</li>
<li><strong>多图融合自然到离谱</strong>：支持一次性上传 13 张素材图，智能整合光线、阴影、透视关系，实现“原生融合”而非简单拼接；电商商家可合成产品场景图，设计师可快速组合创意元素，效率提升 10 倍以上。</li>
<li><strong>多轮编辑像“聊天”一样简单</strong>：支持基于上一轮结果持续微调，如为空房间逐步添加家具、粉刷墙壁，或给生成图换风格、改细节；无需每次重新描述全部需求，对话式操作堪比真人设计师协作。</li>
<li><strong>生成速度快到飞起</strong>：“Flash”命名名副其实，复杂指令下13秒可生成5张风格各异的高清图，单张生成耗时不足3秒，完全满足商业场景高并发需求。</li>
</ol>
<h2 data-id="heading-4">三、4 大落地场景（覆盖从创意到商业的全需求）</h2>
<p>nano-banana API 适配性极强，个人创作者与企业开发均能找到核心价值：</p>
<ol>
<li><strong>内容创作领域</strong>：自媒体人生成短视频封面、故事板；设计师借助风格迁移功能快速尝试不同创意方向，将 1 天工作量压缩至 1 小时。</li>
<li><strong>电商营销场景</strong>：生成多角度产品展示图、将商品自然植入生活场景；无需搭建实景拍摄，即可产出高质量营销素材，大幅降低推广成本。</li>
<li><strong>娱乐应用开发</strong>：开发虚拟试衣、宠物变装、老照片修复等趣味功能；依托强互动性提升产品用户留存率。</li>
<li><strong>企业级创意生产</strong>：品牌方批量生成品牌一致的广告素材，游戏公司制作角色周边可视化图；借助API实现“创意量产”，缩短项目周期。</li>
</ol>
<h2 data-id="heading-5">四、2 套接入方案（避坑指南：成本直降+稳定翻倍）</h2>
<p>针对不同需求提供适配方案，规避官方API网络波动、高成本、失败计费等问题：</p>
<h3 data-id="heading-6">1. 个人学习/小规模测试</h3>
<ul>
<li>方案：直接使用网页版（链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.acedata.cloud%2Fnanobanana" target="_blank" title="https://hub.acedata.cloud/nanobanana" ref="nofollow noopener noreferrer">nano-banana 网页版（无需配置，即开即用）</a>）</li>
<li>优势：无需任何网络配置，联网即可使用，操作便捷。</li>
</ul>
<h3 data-id="heading-7">2. 商业部署/大规模调用（推荐方案）</h3>
<ul>
<li>方案：通过 ACE Data Platform接入nano-banana API（专属通道：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.acedata.cloud%2Fdocuments%2F23985a11-d713-41d1-ad84-24b021805b3d" target="_blank" title="https://platform.acedata.cloud/documents/23985a11-d713-41d1-ad84-24b021805b3d" ref="nofollow noopener noreferrer">ACE Data Platform nano-banana API 专属对接页面</a>）</li>
<li>3大核心优势：
① 成本更友好：生态协同降低中转成本，大规模调用享阶梯价，失败调用不计费，比直接对接官方节省 30% 以上成本；
② 网络更稳定：国内直连节点，无需额外配置代理，API可用性高达 99.9%，避免网络波动导致创作或开发中断；
③ 生态更完整：可直接联动 ACE Data Platform 的其他 API 和编排系统，实现进一步自动化。</li>
</ul>
<h2 data-id="heading-8">五、3 步快速接入流程（即刻解锁创意超能力）</h2>
<ol>
<li>注册 ACE Data Platform 账号，进入 nano-banana API 专属对接页面（链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.acedata.cloud%2Fdocuments%2F23985a11-d713-41d1-ad84-24b021805b3d" target="_blank" title="https://platform.acedata.cloud/documents/23985a11-d713-41d1-ad84-24b021805b3d" ref="nofollow noopener noreferrer">ACE Data Platform nano-banana API专属对接页面</a>），获取专属API Key；</li>
<li>参考平台提供的开发文档（含Python、JavaScript等多语言示例代码），根据需求配置参数（支持图像生成、编辑、风格迁移等多种指令）；</li>
<li>发起调用并对接自有系统，生成的图像可直接存储至 ACE Data Platform 平台云空间。</li>
</ol>
<h2 data-id="heading-9">六、总结号召</h2>
<p>从网友整活的趣味工具，到开发者追捧的生产力 API，nano-banana 的爆发绝非偶然。借助 ACE Data Platform的生态加持，不仅能低成本接入，更能通过数据联动实现价值升级。无论你是想做创意工具、电商产品，还是企业级营销系统，nano-banana API 都是不可错过的核心能力，赶紧领取免费额度，开启创意爆发之旅！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【swift开发基础】34丨访问和操作数组：查找操作]]></title>    <link>https://juejin.cn/post/7595831738233618441</link>    <guid>https://juejin.cn/post/7595831738233618441</guid>    <pubDate>2026-01-16T15:34:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595831738233618441" data-draft-id="7595841630675877939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【swift开发基础】34丨访问和操作数组：查找操作"/> <meta itemprop="keywords" content="前端,Swift"/> <meta itemprop="datePublished" content="2026-01-16T15:34:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="这什么玩意"/> <meta itemprop="url" content="https://juejin.cn/user/1169536102963917"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【swift开发基础】34丨访问和操作数组：查找操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1169536102963917/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    这什么玩意
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T15:34:38.000Z" title="Fri Jan 16 2026 15:34:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、访问和操作数组</h3>
<h4 data-id="heading-1">1. 在末尾添加</h4>
<ul>
<li>可变性要求：数组必须是变量（用var定义），常量数组不可修改</li>
<li>append方法：
<ul>
<li>append(:)：在数组末尾添加单个元素</li>
<li>append(contentsOf:)：在末尾添加多个元素（接受序列）</li>
</ul>
</li>
<li>示例：
<ul>
<li>numbers.append(100)：在[2,3,4,5,6,7]后添加100 → [2,3,4,5,6,7,100]</li>
<li>numbers.append(contentsOf: 100...105)：添加100到105区间 → [2,3,4,5,6,7,100,101,102,103,104,105]</li>
</ul>
</li>
</ul>
<h4 data-id="heading-2">2. 在任意位置添加</h4>
<ul>
<li>insert方法：
<ul>
<li>insert(_:at:)：在指定位置插入单个元素</li>
<li>insert(contentsOf:at:)：在指定位置插入多个元素</li>
</ul>
</li>
<li>示例：
<ul>
<li>numbers.insert(-1, at: 0)：在0位置插入-1 → [-1,2,3,4,5,6,7]</li>
<li>numbers.insert(contentsOf: -2...0, at: 0)：在0位置插入-2到0 → [-2,-1,0,2,3,4,5,6,7]</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">3. 字符串也是Collection</h4>
<ul>
<li>
<p>特性：字符串是Character类型的集合，可直接作为内容插入字符数组</p>
</li>
<li>
<p>示例：</p>
<ul>
<li>chars.insert(contentsOf: "hello", at: 0)：将"hello"分解为字符插入 → ["h","e","l","l","o","a","b","c"]</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">4. 移除单个元素</h4>
<ul>
<li>
<p>remove(at:)：移除并返回指定位置元素（非空数组必须）</p>
</li>
<li>
<p>removeFirst()：移除并返回首元素（数组为空会崩溃）</p>
</li>
<li>
<p>popFirst()：安全移除首元素（返回Optional，数组为空返回nil）</p>
</li>
<li>
<p>示例：</p>
<ul>
<li>chars.remove(at: 1)：移除索引1的元素"b" → ["a","c","d"]</li>
<li>chars.removeFirst()：移除"a" → ["b","c","d"]</li>
<li>chars.popFirst()：安全移除首元素（推荐使用）</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">5. 移除多个元素</h4>
<ul>
<li>
<p>带参数版本：</p>
<ul>
<li>removeFirst(_:)：移除前N个元素</li>
<li>removeLast(_:)：移除后N个元素</li>
</ul>
</li>
<li>
<p>示例：</p>
<ul>
<li>chars.removeFirst(2)：移除前两个 → ["c","d"]</li>
<li>chars.removeLast(2)：移除后两个 → ["a","b"]</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">6. 移除多个元素</h4>
<ul>
<li>
<p>removeSubrange(_:)：移除指定范围内的元素</p>
</li>
<li>
<p>removeAll()：清空数组（释放内存）</p>
</li>
<li>
<p>removeAll(keepingCapacity:)：清空但保留容量</p>
</li>
<li>
<p>容量优化：建议后续需要插入操作时使用keepingCapacity:true</p>
</li>
<li>
<p>示例：</p>
<ul>
<li>chars.removeSubrange(1...2)：移除索引1-2 → ["a","d"]</li>
<li>chars.removeAll(keepingCapacity: true)：清空但容量保持4</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">7. 应用案例</h3>
<h5 data-id="heading-8">1）例题:数组的添加和删除操作</h5>
<ul>
<li>
<p>实践要点：</p>
<ul>
<li>添加操作必须使用变量数组</li>
<li>popLast()比removeLast()更安全</li>
<li>批量操作时注意索引范围有效性</li>
<li>频繁增删时建议使用keepingCapacity保持性能</li>
</ul>
</li>
</ul>
<h3 data-id="heading-9">二、知识小结</h3>















































<table><thead><tr><th>知识点</th><th>核心内容</th><th>易混淆点</th><th>难度系数</th></tr></thead><tbody><tr><td>Swift数组添加元素</td><td>使用append在末尾添加单个元素，append(contentsOf:)添加多个元素</td><td>必须使用var定义可变数组</td><td>⭐⭐</td></tr><tr><td>Swift数组插入元素</td><td>使用insert(_:at:)在指定位置插入单个元素，insert(contentsOf:at:)插入多个元素</td><td>插入位置索引越界会引发运行时错误</td><td>⭐⭐⭐</td></tr><tr><td>Swift数组移除元素</td><td>remove(at:)移除指定位置元素，removeFirst()/removeLast()移除首尾元素，popLast()安全移除尾元素</td><td>removeFirst/removeLast在空数组调用会崩溃，而popLast返回可选值</td><td>⭐⭐⭐⭐</td></tr><tr><td>Swift数组批量移除</td><td>removeSubrange(_:)移除范围元素，removeAll(keepingCapacity:)保留容量清空数组</td><td>keepingCapacity参数对性能优化的作用</td><td>⭐⭐⭐</td></tr><tr><td>OC与Swift数组对比</td><td>OC中NSArray不可变，只有NSMutableArray可修改；Swift用let/var区分</td><td>OC需要显式使用可变类，Swift通过变量声明控制</td><td>⭐⭐</td></tr><tr><td>字符串作为集合处理</td><td>字符串可分解为字符插入字符数组，体现Swift的Collection协议统一性</td><td>字符串与字符数组的类型转换机制</td><td>⭐⭐⭐</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Django 踩坑记：OceanBase 4012 Timeout 两条红线，语句超时 vs 事务超时一次讲透]]></title>    <link>https://juejin.cn/post/7595801647248031763</link>    <guid>https://juejin.cn/post/7595801647248031763</guid>    <pubDate>2026-01-16T15:47:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595801647248031763" data-draft-id="7595801647248015379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Django 踩坑记：OceanBase 4012 Timeout 两条红线，语句超时 vs 事务超时一次讲透"/> <meta itemprop="keywords" content="Django"/> <meta itemprop="datePublished" content="2026-01-16T15:47:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Django 踩坑记：OceanBase 4012 Timeout 两条红线，语句超时 vs 事务超时一次讲透
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T15:47:59.000Z" title="Fri Jan 16 2026 15:47:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、4012 是谁抛的？</h2>
<p>Django 本身没有 4012 错误码，它是 <strong>OceanBase</strong> 的“杀手”信号：</p>
<blockquote>
<p>当前 SQL <strong>或</strong> 当前事务累计执行时间 ≥ 系统阈值，直接返回 4012。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、两条红线长啥样？</h2>























<table><thead><tr><th>变量名</th><th>默认阈值</th><th>计时对象</th><th>触发后果</th></tr></thead><tbody><tr><td><code>ob_query_timeout</code></td><td>10 000 000 µs = <strong>10 s</strong></td><td><strong>单条 SQL</strong> 执行时长</td><td>这条语句被杀，事务可继续</td></tr><tr><td><code>ob_trx_timeout</code></td><td>100 000 000 µs = <strong>100 s</strong></td><td><strong>事务 begin→commit</strong> 总时长</td><td>下一条语句必 4012，事务必须回滚</td></tr></tbody></table>
<p><strong>谁先撞线谁动手</strong>，互不插队。</p>
<hr/>
<h2 data-id="heading-2">三、Django 视角看区别</h2>
<h3 data-id="heading-3">1. 语句超时——只掐“这一条 SQL”</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 视图里甚至没开事务</span>
<span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> connection

<span class="hljs-keyword">def</span> <span class="hljs-title function_">stmt_timeout_demo</span>(<span class="hljs-params">request</span>):
    <span class="hljs-keyword">with</span> connection.cursor() <span class="hljs-keyword">as</span> c:
        c.execute(<span class="hljs-string">"SET SESSION ob_query_timeout = 1_000_000"</span>)  <span class="hljs-comment"># 1 s</span>
        c.execute(<span class="hljs-string">"SELECT SLEEP(3)"</span>)        <span class="hljs-comment"># 单条 SQL 执行 3 s → 4012</span>
    <span class="hljs-keyword">return</span> HttpResponse(<span class="hljs-string">"ok"</span>)
</code></pre>
<p><strong>现象</strong>：<code>SLEEP(3)</code> 还没跑完，OceanBase 直接返回 4012，Django 抛 <code>OperationalError</code>，事务不存在，照样杀。</p>
<h3 data-id="heading-4">2. 事务超时——掐“begin 到 commit”的总时长</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> transaction
<span class="hljs-keyword">import</span> time

<span class="hljs-meta">@transaction.atomic</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">trx_timeout_demo</span>(<span class="hljs-params">request</span>):
    <span class="hljs-keyword">from</span> app.models <span class="hljs-keyword">import</span> Order
    Order.objects.<span class="hljs-built_in">filter</span>(<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>).update(status=<span class="hljs-number">1</span>)  <span class="hljs-comment"># 0.1 s</span>
    time.sleep(<span class="hljs-number">11</span>)                               <span class="hljs-comment"># 业务睡了 11 s</span>
    Order.objects.<span class="hljs-built_in">filter</span>(<span class="hljs-built_in">id</span>=<span class="hljs-number">2</span>).update(status=<span class="hljs-number">1</span>)  <span class="hljs-comment"># 事务已存活 &gt; 10 s → 4012</span>
</code></pre>
<p><strong>现象</strong>：第 2 条 <code>update</code> 刚发出去就收到 4012，Django 自动回滚整个事务，再抛 <code>OperationalError</code>。</p>
<hr/>
<h2 data-id="heading-5">四、本地复现完整脚本</h2>
<p>把下面代码保存为 <code>test_4012.py</code>，<code>python manage.py shell</code> 里直接跑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os, django
os.environ.setdefault(<span class="hljs-string">'DJANGO_SETTINGS_MODULE'</span>, <span class="hljs-string">'your_project.settings'</span>)
django.setup()

<span class="hljs-keyword">from</span> django.db <span class="hljs-keyword">import</span> connection

<span class="hljs-keyword">def</span> <span class="hljs-title function_">trigger_4012</span>():
    <span class="hljs-keyword">with</span> connection.cursor() <span class="hljs-keyword">as</span> cur:
        <span class="hljs-comment"># 1. 把两条阈值都改成 1 s（单位 µs）</span>
        cur.execute(<span class="hljs-string">"SET SESSION ob_query_timeout = 1_000_000"</span>)
        cur.execute(<span class="hljs-string">"SET SESSION ob_trx_timeout   = 1_000_000"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"阈值已设为 1 s"</span>)

        <span class="hljs-comment"># 2. 开启事务</span>
        cur.execute(<span class="hljs-string">"BEGIN"</span>)

        <span class="hljs-comment"># 3. 故意跑 3 s，触发语句超时</span>
        <span class="hljs-keyword">try</span>:
            cur.execute(<span class="hljs-string">"SELECT SLEEP(3)"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"语句超时 →"</span>, e)

        <span class="hljs-comment"># 4. 再试一次，触发事务超时</span>
        <span class="hljs-keyword">try</span>:
            cur.execute(<span class="hljs-string">"SELECT 1"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"事务超时 →"</span>, e)
        <span class="hljs-keyword">finally</span>:
            cur.execute(<span class="hljs-string">"ROLLBACK"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    trigger_4012()
</code></pre>
<p>运行结果示例</p>
<pre><code class="hljs language-arduino" lang="arduino">阈值已设为 <span class="hljs-number">1</span> s
语句超时 → (<span class="hljs-number">4012</span>, <span class="hljs-string">'Timeout'</span>)
事务超时 → (<span class="hljs-number">4012</span>, <span class="hljs-string">'Timeout'</span>)
</code></pre>
<p>两条红线一次体验齐活。</p>
<hr/>
<h2 data-id="heading-6">五、如何调大阈值</h2>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 全局生效（需 OB 超管）</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> ob_query_timeout <span class="hljs-operator">=</span> <span class="hljs-number">60</span>_000_000;   <span class="hljs-comment">-- 60 s</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> ob_trx_timeout   <span class="hljs-operator">=</span> <span class="hljs-number">86400</span>_000_000; <span class="hljs-comment">-- 24 h</span>
</code></pre>
<p>或者只在 Django 当前连接生效：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">'OPTIONS'</span>: {
    <span class="hljs-string">'init_command'</span>: <span class="hljs-string">"SET ob_query_timeout=60_000_000, ob_trx_timeout=86400_000_000"</span>,
}
</code></pre>
<hr/>
<h2 data-id="heading-7">六、一句话总结</h2>
<p>4012 不是 Django 的锅，而是 OceanBase 的两条“红线”：</p>
<ul>
<li><strong>语句超时</strong>掐单条 SQL 执行时长；</li>
<li><strong>事务超时</strong>掐 begin→commit 总时长。<br/>
搞清谁先撞线，定位改阈值还是拆事务，下次再见到 4012 就能秒解。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【swift开发基础】33 | 访问和操作数组 - 遍历和索引]]></title>    <link>https://juejin.cn/post/7595683968684736558</link>    <guid>https://juejin.cn/post/7595683968684736558</guid>    <pubDate>2026-01-16T15:55:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595683968684736558" data-draft-id="7595966038471180326" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【swift开发基础】33 | 访问和操作数组 - 遍历和索引"/> <meta itemprop="keywords" content="前端,Swift"/> <meta itemprop="datePublished" content="2026-01-16T15:55:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="这什么玩意"/> <meta itemprop="url" content="https://juejin.cn/user/1169536102963917"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【swift开发基础】33 | 访问和操作数组 - 遍历和索引
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1169536102963917/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    这什么玩意
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T15:55:56.000Z" title="Fri Jan 16 2026 15:55:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、访问和操作数组</h2>
<h3 data-id="heading-1">1. 数组遍历</h3>
<h4 data-id="heading-2">1）for-in循环</h4>
<ul>
<li>基本用法：通过for num in numbers形式遍历数组元素，是Swift中最基础的遍历方式</li>
<li>控制流支持：完整支持break和continue控制语句，可以灵活控制循环流程</li>
</ul>
<h4 data-id="heading-3">2）forEach方法</h4>
<ul>
<li>
<p>语法特点：采用闭包形式numbers.forEach { num in ... }进行遍历</p>
</li>
<li>
<p>控制限制：</p>
<ul>
<li>break/continue：无法使用这两个控制语句跳出或跳过循环</li>
<li>return行为：仅退出当前闭包执行体，不会终止整个遍历过程</li>
</ul>
</li>
<li>
<p>示例说明：当尝试在num == 3时执行break会导致编译错误，改为return则只会跳过数字3的输出</p>
</li>
</ul>
<h4 data-id="heading-4">3）同时得到索引和值</h4>
<ul>
<li>
<p>enumerated()方法：</p>
<ul>
<li>返回(index, value)元组序列</li>
<li>示例：for (index, num) in numbers.enumerated()</li>
</ul>
</li>
<li>
<p>替代方案：可通过0..&lt;numbers.count区间遍历索引，再通过下标访问值</p>
</li>
<li>
<p>推荐实践：相比手动索引访问，更推荐使用enumerated()方法，代码更简洁清晰</p>
</li>
</ul>
<h4 data-id="heading-5">4）使用Iterator遍历数组</h4>
<ul>
<li>
<p>实现步骤：</p>
<ul>
<li>通过makeIterator()获取迭代器</li>
<li>使用while let配合next()方法遍历</li>
</ul>
</li>
<li>
<p>终止条件：当next()返回nil时循环自动结束</p>
</li>
<li>
<p>适用场景：适合需要自定义遍历逻辑的情况，但日常开发中使用频率较低</p>
</li>
</ul>
<h3 data-id="heading-6">2. 索引</h3>
<h4 data-id="heading-7">1）startIndex</h4>
<ul>
<li>特性：始终返回0，表示数组第一个元素的位置</li>
<li>空数组情况：当数组为空时，startIndex等于endIndex</li>
</ul>
<h4 data-id="heading-8">2）endIndex</h4>
<ul>
<li>定义：返回最后一个元素索引+1的位置</li>
<li>等价关系：对于数组而言等同于count属性值</li>
<li>特殊说明：与String不同，数组的索引都是Int类型</li>
</ul>
<h4 data-id="heading-9">3）indices</h4>
<ul>
<li>功能：返回数组的有效索引区间（Range）</li>
<li>遍历应用：可通过for i in numbers.indices形式遍历所有有效索引</li>
<li>优势：比手动指定0..&lt;count更安全可靠</li>
</ul>
<h3 data-id="heading-10">3. 代码示例</h3>
<h4 data-id="heading-11">1）forEach方法应用</h4>
<ul>
<li>
<p>基础输出：成功输出数组[2,3,4,5,6,7]所有元素</p>
</li>
<li>
<p>控制尝试：</p>
<ul>
<li>break/continue会导致编译错误</li>
<li>return仅跳过当前元素（如跳过数字3）</li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">2）enumerated方法应用</h4>
<ul>
<li>输出格式：同时打印索引和元素值（如"the index is: 0 2"）</li>
<li>数值处理：示例中将元素值乘以10后输出</li>
</ul>
<h4 data-id="heading-13">3）使用iterator遍历数组</h4>
<ul>
<li>迭代过程：通过while let num = it.next()持续获取下一个元素</li>
<li>终止机制：当next()返回nil时自动结束循环</li>
</ul>
<h4 data-id="heading-14">4）使用索引区间遍历</h4>
<ul>
<li>实现方式：for i in numbers.indices配合下标访问</li>
<li>输出效果：与enumerated()方法输出结果相同</li>
</ul>
<h3 data-id="heading-15">4. 最佳实践建议</h3>
<ul>
<li>简单遍历：仅需元素值时优先使用for-in循环</li>
<li>索引需求：需要同时访问索引和值时推荐使用enumerated()方法</li>
<li>性能考虑：避免在循环体内进行不必要的数组操作，保持遍历高效性</li>
</ul>
<h3 data-id="heading-16">二、知识小结</h3>















































<table><thead><tr><th>知识点</th><th>核心内容</th><th>易混淆点/注意事项</th><th>代码示例</th></tr></thead><tbody><tr><td>for-in循环</td><td>基础遍历方式，可配合break/continue控制流程</td><td>与forEach方法的关键区别在于流程控制</td><td>for number in numbers { ... }</td></tr><tr><td>forEach方法</td><td>闭包式遍历，语法简洁</td><td>不支持break/continue，return仅退出当前闭包</td><td>numbers.forEach { if$0 == 3 { return } }</td></tr><tr><td>enumerated()</td><td>同时获取索引(index)和值(value)</td><td>等效于for i in 0..&lt;count但更优雅</td><td>for (index, num) in numbers.enumerated()</td></tr><tr><td>迭代器遍历</td><td>通过makeIterator()和while let组合实现</td><td>需手动处理迭代终止条件(nil)</td><td>while let num = numbers.makeIterator().next()</td></tr><tr><td>索引属性</td><td>startIndex=0，endIndex=count</td><td>空数组时startIndex == endIndex</td><td>numbers.indices返回索引区间</td></tr><tr><td>索引区间遍历</td><td>使用indices属性获取合法索引范围</td><td>与显式写0..&lt;count效果相同</td><td>for i in numbers.indices { numbers[i] }</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂监督学习中的集成学习！]]></title>    <link>https://juejin.cn/post/7595772638881660979</link>    <guid>https://juejin.cn/post/7595772638881660979</guid>    <pubDate>2026-01-16T14:08:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595772638881660979" data-draft-id="7595772638881546291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂监督学习中的集成学习！"/> <meta itemprop="keywords" content="面试,算法"/> <meta itemprop="datePublished" content="2026-01-16T14:08:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aicoting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂监督学习中的集成学习！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aicoting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T14:08:50.000Z" title="Fri Jan 16 2026 14:08:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>推荐直接网站在线阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Faicoting.cn%2F" target="_blank" title="https://aicoting.cn/" ref="nofollow noopener noreferrer">aicoting AI算法面试学习在线网站</a></p>
</blockquote>
<p>树模型与集成模型是机器学习中非常重要的一类方法。树模型（如决策树）通过逐层划分特征空间，把复杂的预测问题转化为一系列“如果-那么”的规则，具有直观、可解释性强的特点。</p>
<p>单棵决策树往往容易过拟合，但当多个树结合在一起，就能形成更强大的 集成模型。常见的集成方法包括 Bagging（如随机森林），它通过多棵树投票减少方差；Boosting（如 AdaBoost、GBDT、XGBoost、LightGBM、CatBoost），它通过迭代训练不断纠正错误，提高精度；还有 Stacking，通过多层模型组合提升泛化能力。集成模型通常比单一模型更稳定、更准确，是工业界大规模应用的主力方法之一。</p>
<h2 data-id="heading-0">Bagging方法</h2>
<h3 data-id="heading-1">Bagging 方法概述</h3>
<p>Bagging（Bootstrap Aggregating） 是一种 集成学习方法，通过训练多个基学习器并进行投票（分类）或平均（回归）来提高模型稳定性和预测精度。</p>
<p>核心思想：</p>
<ol>
<li>自助采样（Bootstrap Sampling）：从原始训练集随机采样（允许重复），生成多个子训练集。</li>
<li>并行训练基模型：在每个子训练集上训练同类型基学习器（如决策树）。</li>
<li>结果集成：对分类任务采用多数表决（Majority Voting），对回归任务采用平均（Averaging）。</li>
</ol>
<p>Bagging 的优势在于降低模型方差，尤其适合容易过拟合的模型，如决策树。</p>
<p>公式表示： 假设有 M 个基模型 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>h</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>h</mi><mi>M</mi></msub></mrow><annotation encoding="application/x-tex">h_1, h_2, \dots, h_M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> ，Bagging 的集成预测为：</p>
<ul>
<li>分类任务：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><mtext>mode</mtext><mo stretchy="false">{</mo><msub><mi>h</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>h</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>h</mi><mi>M</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\hat{y} = \text{mode}\{h_1(x), h_2(x), \dots, h_M(x)\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">mode</span></span><span class="mopen">{</span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)}</span></span></span></span></span></li>
<li>回归任务：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><mfrac><mn>1</mn><mi>M</mi></mfrac><msubsup><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></msubsup><msub><mi>h</mi><mi>m</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\hat{y} = \frac{1}{M} \sum_{m=1}^{M} h_m(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3262em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></li>
</ul>
<h3 data-id="heading-2">随机森林（Random Forest）</h3>
<p>随机森林 是 Bagging 的改进版本，专门针对决策树基模型提出。</p>
<p>随机森林的主要改进包括以下两点：</p>
<ol>
<li>随机特征选择：在每个节点划分时，只从随机选取的部分特征中选择最优特征，这样可以减少树之间的相关性，提高整体泛化能力。</li>
<li>多棵树投票：训练多棵决策树，然后对分类结果进行投票。</li>
</ol>
<p>通过多棵树的投票能平滑单棵树的噪声，减少过拟合，并且相比单棵树通常性能更好，实现更高的准确率，同时通过观察特征在树中的分裂贡献，可评估其重要性。</p>
<h3 data-id="heading-3">随机森林的工作流程</h3>
<ol>
<li>生成训练子集</li>
</ol>
<ul>
<li>从原始数据集中使用自助采样生成 B 个训练子集。</li>
</ul>
<ol start="2">
<li>训练基模型</li>
</ol>
<ul>
<li>对每个训练子集训练一棵决策树</li>
<li>节点划分时只从随机选择的 m 个特征中选取最优分裂</li>
</ul>
<ol start="3">
<li>集成预测</li>
</ol>
<ul>
<li>分类：多数表决</li>
<li>回归：取平均</li>
</ul>
<ol start="4">
<li>模型评估与特征重要性</li>
</ol>
<ul>
<li>使用 OOB（Out-of-Bag）样本评估性能</li>
<li>计算特征重要性指标（如 Gini Importance）</li>
</ul>
<p>下面用 Python 的 scikit-learn 演示 Bagging 与随机森林分类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> BaggingClassifier, RandomForestClassifier
<span class="hljs-keyword">from</span> sklearn.tree <span class="hljs-keyword">import</span> DecisionTreeClassifier
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score

<span class="hljs-comment"># 1. 加载数据</span>
iris = load_iris()
X, y = iris.data, iris.target

<span class="hljs-comment"># 2. 划分训练/测试集</span>
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=<span class="hljs-number">0.3</span>, random_state=<span class="hljs-number">42</span>)

<span class="hljs-comment"># 3. Bagging（基于决策树）</span>
bagging_clf = BaggingClassifier(
    base_estimator=DecisionTreeClassifier(),
    n_estimators=<span class="hljs-number">100</span>,
    max_samples=<span class="hljs-number">0.8</span>,
    max_features=<span class="hljs-number">1.0</span>,
    random_state=<span class="hljs-number">42</span>
)
bagging_clf.fit(X_train, y_train)
y_pred_bag = bagging_clf.predict(X_test)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Bagging Accuracy:"</span>, accuracy_score(y_test, y_pred_bag))

<span class="hljs-comment"># 4. 随机森林</span>
rf_clf = RandomForestClassifier(
    n_estimators=<span class="hljs-number">100</span>,
    max_depth=<span class="hljs-literal">None</span>,
    max_features=<span class="hljs-string">'sqrt'</span>,
    random_state=<span class="hljs-number">42</span>
)
rf_clf.fit(X_train, y_train)
y_pred_rf = rf_clf.predict(X_test)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Random Forest Accuracy:"</span>, accuracy_score(y_test, y_pred_rf))

<span class="hljs-comment"># 5. 特征重要性</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Feature Importances:"</span>, rf_clf.feature_importances_)
</code></pre>
<p>输出结果如下，可以看到Iris（鸢尾花）数据集中 sepal length（萼片长度）、sepal width（萼片宽度）、petal length（花瓣长度）、petal width（花瓣宽度） 四个特征的重要程度。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec44d62e313843b999eb9515ac5dabe3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769177330&amp;x-signature=1YL1AjgD%2FUjdk22avssTfhnCjBw%3D" alt="" loading="lazy"/></p>
<p>总结一下哈，Bagging 是集成学习的基础，通过随机采样和并行训练降低模型方差；随机森林在此基础上加入随机特征选择，进一步减少树之间相关性，使模型更强大且稳定。随机森林相比于决策树有可以提高模型准确率与鲁棒性，减少过拟合风险，并且可以处理高维数据，提供特征重要性评估。但是缺点是模型复杂，难以解释，训练和预测时间较单棵树更长，对异常值仍然敏感。</p>
<h2 data-id="heading-4">Boosting方法</h2>
<h3 data-id="heading-5">Boosting 概述</h3>
<p>Boosting 是一种 集成学习方法，它通过 顺序训练一系列弱学习器，每一轮都尝试修正前一轮模型的错误，从而得到一个强大的预测模型。</p>
<p>核心思想：</p>
<ol>
<li>弱学习器：单个基模型预测能力略优于随机猜测即可，例如深度为1或2的决策树（即决策桩）。</li>
<li>迭代训练：每个新模型关注前一轮模型预测错误的样本，提高整体准确率。</li>
<li>权重更新：错误样本被赋予更高权重，促使下一轮学习器重点学习困难样本。</li>
</ol>
<p>Boosting 的优势是能显著提高准确率，尤其适合中小规模数据集，但训练是顺序执行，无法并行，因此计算成本较高。</p>
<h3 data-id="heading-6">Boosting 的基本流程</h3>
<p>假设有训练数据 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mo stretchy="false">(</mo><msub><mi>x</mi><mi>n</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_1, y_1), \dots, (x_n, y_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，分类问题中 Boosting 的工作流程：</p>
<ol>
<li>
<p>初始化样本权重：每个样本权重相等<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub><mo>=</mo><mfrac><mn>1</mn><mi>n</mi></mfrac></mrow><annotation encoding="application/x-tex">w_i = \frac{1}{n}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span> 。</p>
</li>
<li>
<p>对<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">m = 1, 2, \dots, M</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span></span></span></span> 轮迭代：</p>
</li>
</ol>
<ul>
<li>在加权数据集上训练弱学习器<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>h</mi><mi>m</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">h_m(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span></li>
<li>计算弱学习器误差率<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ϵ</mi><mi>m</mi></msub><mo>=</mo><mfrac><mrow><msub><mo>∑</mo><mi>i</mi></msub><msub><mi>w</mi><mi>i</mi></msub><mi>I</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo mathvariant="normal">≠</mo><msub><mi>h</mi><mi>m</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><mrow><msub><mo>∑</mo><mi>i</mi></msub><msub><mi>w</mi><mi>i</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">\epsilon_m = \frac{\sum_i w_i I(y_i \neq h_m(x_i))}{\sum_i w_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.63em;vertical-align:-0.57em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.06em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1496em;"><span style="top:-2.1786em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3214em;"><span/></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.1952em;"/><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.535em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1496em;"><span style="top:-2.1786em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3214em;"><span/></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.1952em;"/><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0269em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mord mathnormal mtight" style="margin-right:0.07847em;">I</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0359em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="inner"><span class="mord mtight"><span class="mrel mtight"></span></span></span><span class="fix"/></span></span></span></span><span class="mrel mtight">=</span></span><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mclose mtight">))</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.57em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></li>
<li>计算弱学习器权重<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>m</mi></msub><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>ln</mi><mo>⁡</mo><mfrac><mrow><mn>1</mn><mo>−</mo><msub><mi>ϵ</mi><mi>m</mi></msub></mrow><msub><mi>ϵ</mi><mi>m</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">\alpha_m = \frac{1}{2} \ln \frac{1 - \epsilon_m}{\epsilon_m}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3063em;vertical-align:-0.4451em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">ln</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8612em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4101em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></li>
<li>更新样本权重：错误样本权重增加，正确样本权重降低<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub><mo>←</mo><msub><mi>w</mi><mi>i</mi></msub><mo>⋅</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>α</mi><mi>m</mi></msub><mo>⋅</mo><mi>I</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo mathvariant="normal">≠</mo><msub><mi>h</mi><mi>m</mi></msub><mo stretchy="false">(</mo><msub><mi>x</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">w_i \leftarrow w_i \cdot \exp(\alpha_m \cdot I(y_i \neq h_m(x_i)))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">exp</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel"><span class="mrel"><span class="mord vbox"><span class="thinbox"><span class="rlap"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="inner"><span class="mord"><span class="mrel"></span></span></span><span class="fix"/></span></span></span></span><span class="mrel">=</span></span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)))</span></span></span></span></span></li>
<li>归一化权重，使总和为1</li>
</ul>
<ol start="3">
<li>最终预测：
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>sign</mtext><mo fence="false" stretchy="true" minsize="1.8em" maxsize="1.8em">(</mo><msubsup><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>M</mi></msubsup><msub><mi>α</mi><mi>m</mi></msub><msub><mi>h</mi><mi>m</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.8em" maxsize="1.8em">)</mo></mrow><annotation encoding="application/x-tex">H(x) = \text{sign}\Big(\sum_{m=1}^M \alpha_m h_m(x)\Big)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mord text"><span class="mord">sign</span></span><span class="mord"><span class="delimsizing size2">(</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">M</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">h</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">m</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord"><span class="delimsizing size2">)</span></span></span></span></span></span></li>
</ol>
<h3 data-id="heading-7">常见 Boosting 算法</h3>
<ol>
<li>AdaBoost（Adaptive Boosting）：AdaBoost是经典的 Boosting 算法，它按错误率调整样本权重，弱学习器通常使用决策桩，对噪声敏感，但在干净数据上效果非常好。</li>
<li>GBDT（Gradient Boosting Decision Tree）：GBDT每一轮拟合前一轮残差（负梯度），而不是直接拟合错误，可以处理回归与分类任务，同时损失函数灵活，可选择平方误差、对数损失、Huber 等</li>
<li>XGBoost：XGBoost是基于 GBDT 的优化版本，支持正则化、列抽样、缺失值处理，它采用二阶梯度提升，提高收敛速度与预测精度，在 Kaggle 竞赛中非常流行。</li>
<li>LightGBM：LightGBM基于 XGBoost 的改进，采用 基于直方图的叶子生长策略（Leaf-wise），对大规模数据和高维稀疏特征非常高效</li>
<li>CatBoost：CatBoost天然处理类别特征，无需独热编码，采用 有序Boosting 避免预测偏差，在分类问题中对类别变量效果尤为突出</li>
</ol>
<p>下面用 Python 的 scikit-learn 和 xgboost 实现 AdaBoost 和 XGBoost 分类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> AdaBoostClassifier
<span class="hljs-keyword">from</span> xgboost <span class="hljs-keyword">import</span> XGBClassifier
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score

<span class="hljs-comment"># 1. 加载数据</span>
iris = load_iris()
X, y = iris.data, iris.target

<span class="hljs-comment"># 2. 划分训练/测试集</span>
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=<span class="hljs-number">0.3</span>, random_state=<span class="hljs-number">42</span>)

<span class="hljs-comment"># 3. AdaBoost</span>
adaboost_clf = AdaBoostClassifier(n_estimators=<span class="hljs-number">50</span>, learning_rate=<span class="hljs-number">1.0</span>, random_state=<span class="hljs-number">42</span>)
adaboost_clf.fit(X_train, y_train)
y_pred_ada = adaboost_clf.predict(X_test)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"AdaBoost Accuracy:"</span>, accuracy_score(y_test, y_pred_ada))

<span class="hljs-comment"># 4. XGBoost</span>
xgb_clf = XGBClassifier(n_estimators=<span class="hljs-number">100</span>, learning_rate=<span class="hljs-number">0.1</span>, use_label_encoder=<span class="hljs-literal">False</span>, eval_metric=<span class="hljs-string">'mlogloss'</span>)
xgb_clf.fit(X_train, y_train)
y_pred_xgb = xgb_clf.predict(X_test)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"XGBoost Accuracy:"</span>, accuracy_score(y_test, y_pred_xgb))
</code></pre>
<p>输出结果如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b969193d6db642eda3282fa07dc00da8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769177330&amp;x-signature=W8aGZOxoCAD51rwF%2Bn6T829HAQs%3D" alt="" loading="lazy"/></p>
<p>下面的图第一张图对比了 AdaBoost 和 XGBoost 的特征重要性，我们可以看到哪些特征对分类最关键。第二张图是每个测试样本的真实标签和预测标签对比。</p>
<p>总结一下，Boosting 是一种强大的集成方法，通过顺序训练弱学习器、关注困难样本，实现 弱变强。Boosting能够处理复杂的非线性关系，显著提升模型准确率，同时可计算特征重要性，但是训练顺序依赖，无法完全并行，对噪声敏感，尤其是 AdaBoost。并且参数较多，需要调参优化，模型解释性相对弱于单棵树。</p>
<h2 data-id="heading-8">Stacking与集成策略</h2>
<h3 data-id="heading-9">集成策略概述</h3>
<p>在机器学习中，单一模型通常无法在所有数据和任务上达到最优性能。集成策略（Ensemble Methods） 的核心思想是群体智慧：将多个模型的预测结果组合起来，使最终模型比单个模型更稳健、更准确。</p>
<p>主要集成策略包括：</p>
<ol>
<li>Bagging（Bootstrap Aggregating）：通过并行训练多个基模型，降低方差（如随机森林）。</li>
<li>Boosting：通过顺序训练弱学习器，提高偏差-方差权衡（如 AdaBoost、GBDT）。</li>
<li>Stacking（堆叠泛化）：通过多层模型融合，将不同类型模型的预测结果作为输入训练一个“元模型”，提升整体性能。</li>
</ol>
<h3 data-id="heading-10">Stacking 原理</h3>
<p>Stacking 的核心思想：</p>
<ul>
<li>不同模型对数据的偏差不同</li>
<li>将这些模型的预测结果作为新特征，训练一个元模型（Meta-model），学习如何组合这些预测</li>
</ul>
<p>假设有三个基模型<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>M</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>M</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">M_1, M_2, M_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和一个元模型<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>M</mi><mrow><mi>m</mi><mi>e</mi><mi>t</mi><mi>a</mi></mrow></msub></mrow><annotation encoding="application/x-tex">M_{meta}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> ，Stacking 流程为：</p>
<ol>
<li>训练基模型</li>
</ol>
<ul>
<li>将训练集X 分成 k 个折（K-fold）</li>
<li>在每个折上训练基模型并对未见数据进行预测，得到基模型预测特征</li>
</ul>
<ol start="2">
<li>构建元训练集</li>
</ol>
<ul>
<li>将基模型对训练集的预测结果组成新的训练集 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>X</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">X'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>标签<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">y'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> 与原训练集标签相同</li>
</ul>
<ol start="3">
<li>训练元模型</li>
</ol>
<ul>
<li>在<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>X</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">X'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span> 上训练元模型，学习如何组合基模型预测</li>
</ul>
<ol start="4">
<li>预测新样本</li>
</ol>
<ul>
<li>基模型对新样本进行预测</li>
<li>将预测结果输入元模型，得到最终预测</li>
</ul>
<p>表示成公式就是：
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>X</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mo stretchy="false">[</mo><msub><mi>M</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>M</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>M</mi><mn>3</mn></msub><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">X' = [M_1(X), M_2(X), M_3(X)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mclose">)]</span></span></span></span></span>
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo>=</mo><msub><mi>M</mi><mrow><mi>m</mi><mi>e</mi><mi>t</mi><mi>a</mi></mrow></msub><mo stretchy="false">(</mo><msup><mi>X</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\hat{y} = M_{meta}(X')</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>Stacking 流程</p>
<ol>
<li>原始训练集 → 分成 k 折</li>
<li>基模型交叉验证预测 → 得到基模型预测特征</li>
<li>构建元训练集 → 训练元模型</li>
<li>基模型预测新样本 → 元模型输出最终预测</li>
</ol>
<p>Stacking 可以结合不同类型的基模型，例如：决策树 + 逻辑回归 + KNN，然后使用线性回归或梯度提升树作为元模型。</p>
<p>下面我们用 Python scikit-learn 实现一个简单的 Stacking 分类示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.ensemble <span class="hljs-keyword">import</span> StackingClassifier
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression
<span class="hljs-keyword">from</span> sklearn.tree <span class="hljs-keyword">import</span> DecisionTreeClassifier
<span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score

<span class="hljs-comment"># 1. 加载数据</span>
iris = load_iris()
X, y = iris.data, iris.target

<span class="hljs-comment"># 2. 划分训练/测试集</span>
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=<span class="hljs-number">0.3</span>, random_state=<span class="hljs-number">42</span>)

<span class="hljs-comment"># 3. 构建基模型和元模型</span>
base_models = [
    (<span class="hljs-string">'dt'</span>, DecisionTreeClassifier(max_depth=<span class="hljs-number">3</span>)),
    (<span class="hljs-string">'knn'</span>, KNeighborsClassifier(n_neighbors=<span class="hljs-number">3</span>))
]
meta_model = LogisticRegression()

<span class="hljs-comment"># 4. 构建 Stacking 模型</span>
stacking_clf = StackingClassifier(estimators=base_models, final_estimator=meta_model)
stacking_clf.fit(X_train, y_train)

<span class="hljs-comment"># 5. 预测与评估</span>
y_pred = stacking_clf.predict(X_test)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Stacking Accuracy:"</span>, accuracy_score(y_test, y_pred))
</code></pre>
<p>输出为：</p>
<pre><code class="hljs language-python" lang="python">Stacking Accuracy: <span class="hljs-number">1.0</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf61fbec33f24dd98da3e656a557db82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769177330&amp;x-signature=E3Li6gKXglTDdy9QWXdY2nQa5Hc%3D" alt="" loading="lazy"/></p>
<p>可以看到，Stacking 结合了不同模型的优势，通常性能优于单一模型。</p>
<p>最后我们来总结一下Stacking，同时也总结一下集成学习，Stacking 是一种强大的 多层集成策略，通过将不同基模型的预测组合训练一个元模型，实现更强的泛化能力。</p>
<p>Stacking可以融合不同类型模型，提升整体性能，对偏差和方差都有一定改善，并且相对灵活，可选基模型和元模型，但是训练较复杂，需要多轮训练，对数据量要求较高，否则容易过拟合，同时元模型选择不当可能导致性能下降。</p>
<p>Bagging 和 Boosting 解决了方差和偏差问题，而 Stacking 则进一步通过模型组合提升最终性能，是现代集成学习的重要方法。</p>
<p>最新的文章都在公众号aicoting更新，别忘记关注哦！！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂K-Means 聚类！]]></title>    <link>https://juejin.cn/post/7595774188910559270</link>    <guid>https://juejin.cn/post/7595774188910559270</guid>    <pubDate>2026-01-16T14:11:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595774188910559270" data-draft-id="7595764380472721458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂K-Means 聚类！"/> <meta itemprop="keywords" content="面试,算法"/> <meta itemprop="datePublished" content="2026-01-16T14:11:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aicoting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂K-Means 聚类！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aicoting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T14:11:21.000Z" title="Fri Jan 16 2026 14:11:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>推荐直接网站在线阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Faicoting.cn%2F" target="_blank" title="https://aicoting.cn/" ref="nofollow noopener noreferrer">aicoting AI算法面试学习在线网站</a></p>
</blockquote>
<h2 data-id="heading-0">什么是聚类？</h2>
<p>聚类（Clustering）是一种典型的无监督学习方法，其目标是在没有标签信息的情况下，将数据样本按照相似性划分为若干簇，使得同一簇内的样本相似度高，不同簇之间差异显著。常见方法包括基于划分的 K-Means、基于层次的 层次聚类、以及基于密度的 DBSCAN、OPTICS 等。聚类广泛应用于用户分群、市场细分、文本主题发现、图像分割等任务，是数据挖掘和探索性分析中的重要工具。</p>
<h2 data-id="heading-1">K-Means 聚类</h2>
<p>K-Means 是最经典的聚类算法之一，属于基于划分（Partition-based）的聚类方法。它通过迭代优化目标函数，将数据划分为 K 个簇，使得同簇内样本之间相似度最大化，而不同簇之间相似度最小化。一个簇说白了就是一组相同类别的东西，只是在这个方法里起了个名字叫簇，比如苹果，香蕉，橘子属于水果那一簇，彭于晏，刘亦菲和你们属于帅哥美女那一簇。由于其简单、高效，K-Means 在数据挖掘、文本分析、图像分割等领域被广泛应用。</p>
<p>K-Means 的目标是最小化簇内平方误差（Within-Cluster Sum of Squares, WCSS），即：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></msubsup><msub><mo>∑</mo><mrow><mi>x</mi><mo>∈</mo><msub><mi>C</mi><mi>i</mi></msub></mrow></msub><mi mathvariant="normal">∥</mi><mi>x</mi><mo>−</mo><msub><mi>μ</mi><mi>i</mi></msub><msup><mi mathvariant="normal">∥</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">J = \sum_{i=1}^{K} \sum_{x \in C_i} \| x - \mu_i \|^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.09618em;">J</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.381em;vertical-align:-0.3998em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1786em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.0715em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3998em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">∥</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>其中：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> ：簇的个数</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> ：第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个簇</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">μ_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> ：簇 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的质心（均值向量）</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi><mi>x</mi><mo>−</mo><msub><mi>μ</mi><mi>i</mi></msub><msup><mi mathvariant="normal">∥</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\| x - \mu_i \|^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">∥</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">μ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord">∥</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span> ：样本点与簇中心的欧式距离 K-Means的核心思想就是不断更新簇划分与质心，直到收敛（目标函数不再显著下降）。</li>
</ul>
<p>K-Means的算法流程也很容易理解：</p>
<ol>
<li>初始化：随机选择 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> 个样本作为初始质心。</li>
<li>分配样本：将每个样本分配到距离最近的簇中心。</li>
<li>更新质心：对每个簇，计算所有样本的均值作为新的质心。</li>
<li>迭代：重复步骤 2-3，直到簇划分不再变化或目标函数收敛。</li>
</ol>
<p>下面基于Scikit-learn编写一段示例代码让咱们更好的理解一下：</p>
<pre><code class="hljs language-ini" lang="ini">from sklearn.datasets import make_blobs
from sklearn.cluster import KMeans
import matplotlib.pyplot as plt

<span class="hljs-comment"># 1. 生成模拟数据</span>
X, <span class="hljs-attr">y</span> = make_blobs(n_samples=<span class="hljs-number">300</span>, centers=<span class="hljs-number">4</span>, cluster_std=<span class="hljs-number">0.6</span>, random_state=<span class="hljs-number">42</span>)

<span class="hljs-comment"># 2. 训练 K-Means</span>
<span class="hljs-attr">kmeans</span> = KMeans(n_clusters=<span class="hljs-number">4</span>, random_state=<span class="hljs-number">42</span>, n_init=<span class="hljs-number">10</span>)
<span class="hljs-attr">y_pred</span> = kmeans.fit_predict(X)

<span class="hljs-comment"># 3. 可视化结果</span>
plt.scatter(X<span class="hljs-section">[:, 0]</span>, X<span class="hljs-section">[:, 1]</span>, <span class="hljs-attr">c</span>=y_pred, s=<span class="hljs-number">30</span>, cmap=<span class="hljs-string">'viridis'</span>)
plt.scatter(kmeans.cluster_centers_<span class="hljs-section">[:, 0]</span>, kmeans.cluster_centers_<span class="hljs-section">[:, 1]</span>,
            <span class="hljs-attr">c</span>=<span class="hljs-string">'red'</span>, marker=<span class="hljs-string">'X'</span>, s=<span class="hljs-number">200</span>, label=<span class="hljs-string">'Centroids'</span>)
plt.legend()
plt.title("K-Means Clustering")
plt.show()
</code></pre>
<p>运行结果如下，不同颜色表示不同簇，红色 X 为聚类中心。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cda676c9e72341a29c6db9cdcccbf693~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769177480&amp;x-signature=0hO7sXAWf%2Fugv2IYi4g5PcWMzVg%3D" alt="" loading="lazy"/></p>
<p>总结环节！K-Means 作为经典的无监督学习方法，凭借其高效性和直观性，成为最常用的聚类算法之一。但在实际应用中，需要注意簇数选择、初始点敏感性以及对复杂分布的适用性问题。针对这些不足，研究者提出了 K-Means++、Mini-Batch K-Means 等改进方法，使其在大规模机器学习任务中依然具有重要地位。</p>
<p>最新的文章都在公众号aicoting更新，别忘记关注哦！！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 性能优化（七）使用 StrictMode 进行性能检测]]></title>    <link>https://juejin.cn/post/7595858353658953762</link>    <guid>https://juejin.cn/post/7595858353658953762</guid>    <pubDate>2026-01-16T14:21:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595858353658953762" data-draft-id="7595831648825032744" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 性能优化（七）使用 StrictMode 进行性能检测"/> <meta itemprop="keywords" content="Android,性能优化"/> <meta itemprop="datePublished" content="2026-01-16T14:21:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小墙程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1468603264407022"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 性能优化（七）使用 StrictMode 进行性能检测
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1468603264407022/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小墙程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T14:21:36.000Z" title="Fri Jan 16 2026 14:21:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>StrictMode</code> 是一个开发者工具，用于捕获在应用主线程中发生的磁盘I/O、网络访问违例等问题。
<code>StrictMode</code> 有两个策略，一个是线程策略，即 <code>TreadPolicy</code>，如下所示：</p>
<pre><code class="hljs language-scss" lang="scss">StrictMode<span class="hljs-selector-class">.setThreadPolicy</span>(
    StrictMode.ThreadPolicy.Builder()
        <span class="hljs-selector-class">.detectCustomSlowCalls</span>() <span class="hljs-comment">//配合StrictMode.noteSlowCall使用</span>
        <span class="hljs-selector-class">.detectDiskReads</span>()<span class="hljs-comment">//是否在主线程中进行磁盘读取</span>
        <span class="hljs-selector-class">.detectDiskWrites</span>()<span class="hljs-comment">//是否在主线程中进行磁盘写入</span>
        <span class="hljs-selector-class">.detectNetwork</span>() <span class="hljs-comment">// 是否在主线程中进行网络请求</span>
        <span class="hljs-selector-class">.penaltyDialog</span>() <span class="hljs-comment">//弹出违规提示对话框</span>
        <span class="hljs-selector-class">.penaltyLog</span>() <span class="hljs-comment">//在Logcat 中打印违规异常信息</span>
        <span class="hljs-selector-class">.penaltyFlashScreen</span>() <span class="hljs-comment">//会造成屏幕闪烁</span>
        <span class="hljs-selector-class">.penaltyDropBox</span>()<span class="hljs-comment">//将违规信息记录到 dropbox 系统日志目录中</span>
        <span class="hljs-selector-class">.build</span>()
)

<span class="hljs-comment">// noteSlowCall 用于触发耗时警告</span>
<span class="hljs-keyword">@WorkerThread</span>
public boolean compress(CompressFormat format, int quality, OutputStream stream) {
    ...
    
    StrictMode<span class="hljs-selector-class">.noteSlowCall</span>("Compression of a bitmap is slow");
    
    ...
    return result;
}
</code></pre>
<p>一个是VM策略，即 VmPolicy，如下所示：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">StrictMode</span><span class="hljs-selector-class">.setVmPolicy</span>(
    StrictMode.VmPolicy.<span class="hljs-built_in">Builder</span>()
        .<span class="hljs-built_in">detectActivityLeaks</span>()<span class="hljs-comment">//Activity是否内存泄漏</span>
        .<span class="hljs-built_in">detectLeakedSqlLiteObjects</span>()<span class="hljs-comment">//数据库是否未关闭</span>
        .<span class="hljs-built_in">detectLeakedClosableObjects</span>()<span class="hljs-comment">//文件是否未关闭</span>
        .<span class="hljs-built_in">setClassInstanceLimit</span>(MainActivity.class, <span class="hljs-number">1</span>) <span class="hljs-comment">//某个类在内存中实例上限</span>
        .<span class="hljs-built_in">detectLeakedRegistrationObjects</span>()<span class="hljs-comment">//对象是否被正确关闭</span>
        .<span class="hljs-built_in">penaltyLog</span>()<span class="hljs-comment">//打印日志，可以通过 StrictMode 来过滤</span>
        .<span class="hljs-built_in">penaltyDeath</span>()<span class="hljs-comment">//直接Crash掉当前应用程序</span>
        .<span class="hljs-built_in">build</span>()
)
</code></pre>
<p>我们也可以在需要的时候扩充StrictMode，代码如下所示：</p>
<pre><code class="hljs language-scss" lang="scss">StrictMode<span class="hljs-selector-class">.ThreadPolicy</span> oldThreadPolicy = StrictMode<span class="hljs-selector-class">.getThreadPolicy</span>();
StrictMode<span class="hljs-selector-class">.setThreadPolicy</span>(new StrictMode.ThreadPolicy.Builder(oldThreadPolicy)
    <span class="hljs-selector-class">.permitDiskWrites</span>()  <span class="hljs-comment">// 在原有策略的规则基础上，不监测读写磁盘</span>
    <span class="hljs-selector-class">.build</span>());
 
StrictMode<span class="hljs-selector-class">.VmPolicy</span> oldVmPolicy = StrictMode<span class="hljs-selector-class">.getVmPolicy</span>();
StrictMode<span class="hljs-selector-class">.setVmPolicy</span>(new StrictMode.VmPolicy.Builder(oldVmPolicy)
    <span class="hljs-selector-class">.setClassInstanceLimit</span>(MainActivity.class, <span class="hljs-number">1</span>) <span class="hljs-comment">// 可以在内存中，设置 MainActivity.class 的实例为1</span>
    <span class="hljs-selector-class">.build</span>());
</code></pre>
<h2 data-id="heading-0">参考</h2>
<ul>
<li><a href="https://juejin.cn/user/1415826705483144/posts" target="_blank" title="https://juejin.cn/user/1415826705483144/posts">Android性能优化工具-严苛模式StrictMode使用指南</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fos%2FStrictMode.html" target="_blank" title="http://developer.android.com/reference/android/os/StrictMode.html" ref="nofollow noopener noreferrer">官网文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解锁Vue新姿势：5种定义全局方法的实用技巧，让你的代码更优雅！]]></title>    <link>https://juejin.cn/post/7595764380472803378</link>    <guid>https://juejin.cn/post/7595764380472803378</guid>    <pubDate>2026-01-16T14:31:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595764380472803378" data-draft-id="7595841630675746867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解锁Vue新姿势：5种定义全局方法的实用技巧，让你的代码更优雅！"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-16T14:31:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解锁Vue新姿势：5种定义全局方法的实用技巧，让你的代码更优雅！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T14:31:05.000Z" title="Fri Jan 16 2026 14:31:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">解锁Vue新姿势：5种定义全局方法的实用技巧，让你的代码更优雅！</h2>
<p>无论你是Vue新手还是有一定经验的开发者，相信在工作中都遇到过这样的场景：多个组件需要用到同一个工具函数，比如格式化日期、权限验证、HTTP请求等。如果每个组件都单独引入，不仅代码冗余，维护起来也让人头疼。</p>
<p>今天我就为大家分享5种定义全局方法的实用方案，让你轻松解决这个问题！</p>
<h3 data-id="heading-1">🤔 为什么需要全局方法？</h3>
<p>先来看一个真实的例子。假设你的项目中有三个组件都需要格式化日期：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// UserProfile.vue</span>
methods: {
  <span class="hljs-built_in">formatDate</span>(date) {
    return <span class="hljs-built_in">dayjs</span>(date)<span class="hljs-selector-class">.format</span>('YYYY-MM-DD HH:mm:ss')
  }
}

<span class="hljs-comment">// OrderList.vue  </span>
methods: {
  <span class="hljs-built_in">formatDate</span>(date) {
    return <span class="hljs-built_in">dayjs</span>(date)<span class="hljs-selector-class">.format</span>('YYYY-MM-DD HH:mm:ss')
  }
}

<span class="hljs-comment">// Dashboard.vue</span>
methods: {
  <span class="hljs-built_in">formatDate</span>(date) {
    return <span class="hljs-built_in">dayjs</span>(date)<span class="hljs-selector-class">.format</span>('YYYY-MM-DD HH:mm:ss')
  }
}
</code></pre>
<p>发现了问题吗？<strong>同样的代码写了三遍！</strong>  这就是我们需要全局方法的原因。</p>
<h3 data-id="heading-2">📝 方案一：Vue.prototype（最经典的方式）</h3>
<p>这是Vue 2时代最常用的方法，直接扩展Vue的原型链：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js 或 plugins/global.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 定义全局方法</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$formatDate</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">date</span>) {
  <span class="hljs-keyword">const</span> dayjs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'dayjs'</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">dayjs</span>(date).<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD HH:mm:ss'</span>)
}

<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$checkPermission</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">permission</span>) {
  <span class="hljs-keyword">const</span> user = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$store</span>.<span class="hljs-property">state</span>.<span class="hljs-property">user</span>
  <span class="hljs-keyword">return</span> user.<span class="hljs-property">permissions</span>.<span class="hljs-title function_">includes</span>(permission)
}

<span class="hljs-comment">// 在组件中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.$formatDate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()))
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.$checkPermission(<span class="hljs-string">'admin'</span>)) {
      <span class="hljs-comment">// 执行管理员操作</span>
    }
  }
}
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>• 使用简单，直接通过 <code>this</code> 调用</li>
<li>• 广泛支持，兼容性好</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>• 污染Vue原型链</li>
<li>• 方法多了难以管理</li>
<li>• TypeScript支持需要额外声明</li>
</ul>
<h3 data-id="heading-3">🎯 方案二：全局混入（适合通用逻辑）</h3>
<p>如果你有一组相关的全局方法，可以考虑使用混入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// mixins/globalMethods.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    $showSuccess(message) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">success</span>(message)
    },
    $showError(error) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span> || <span class="hljs-string">'操作失败'</span>)
    },
    $confirmAction(title, content) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.$confirm(content, title, {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>
      })
    }
  }
}

<span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">GlobalMixin</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./mixins/globalMethods'</span>

<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">mixin</span>(<span class="hljs-title class_">GlobalMixin</span>)

<span class="hljs-comment">// 组件中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">deleteItem</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$confirmAction(<span class="hljs-string">'确认删除'</span>, <span class="hljs-string">'确定删除该记录吗？'</span>)
        <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">deleteItem</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>)
        <span class="hljs-variable language_">this</span>.$showSuccess(<span class="hljs-string">'删除成功'</span>)
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">this</span>.$showError(error)
      }
    }
  }
}
</code></pre>
<p><strong>适合场景：</strong>  UI反馈、确认对话框等通用交互逻辑。</p>
<h3 data-id="heading-4">🏗️ 方案三：独立模块 + Provide/Inject（Vue 3推荐）</h3>
<p>Vue 3提供了更优雅的解决方案：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/globalMethods.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> globalMethods = {
  <span class="hljs-comment">// 防抖函数</span>
  <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay = <span class="hljs-number">300</span></span>) {
    <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
      <span class="hljs-keyword">if</span> (timer) <span class="hljs-built_in">clearTimeout</span>(timer)
      timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
      }, delay)
    }
  },
  
  <span class="hljs-comment">// 深度拷贝</span>
  <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj))
  },
  
  <span class="hljs-comment">// 生成唯一ID</span>
  <span class="hljs-title function_">generateId</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">substr</span>(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)
  }
}

<span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { globalMethods } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/globalMethods'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

<span class="hljs-comment">// 通过provide提供给所有组件</span>
app.<span class="hljs-title function_">provide</span>(<span class="hljs-string">'$global'</span>, globalMethods)

<span class="hljs-comment">// 组件中使用</span>
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> $global = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'$global'</span>)
    
    <span class="hljs-keyword">const</span> handleInput = $global.<span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'搜索:'</span>, value)
    }, <span class="hljs-number">500</span>)
    
    <span class="hljs-keyword">return</span> { handleInput }
  }
}
</code></pre>
<p><strong>这是Vue 3的推荐方式，保持了良好的类型推断和代码组织。</strong></p>
<h3 data-id="heading-5">📦 方案四：插件化封装（企业级方案）</h3>
<p>对于大型项目，建议采用插件化的方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// plugins/globalMethods.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">GlobalMethodsPlugin</span> = {
  <span class="hljs-title function_">install</span>(<span class="hljs-params">app, options</span>) {
    <span class="hljs-comment">// 添加全局方法</span>
    app.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$http</span> = <span class="hljs-keyword">async</span> (url, config) =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, config)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败:'</span>, error)
        <span class="hljs-keyword">throw</span> error
      }
    }
    
    app.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$validate</span> = {
      <span class="hljs-title function_">email</span>(<span class="hljs-params">email</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-regexp">/^[^\s@]+@[^\s@]+.[^\s@]+$/</span>.<span class="hljs-title function_">test</span>(email)
      },
      <span class="hljs-title function_">phone</span>(<span class="hljs-params">phone</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-regexp">/^1[3-9]\d{9}$/</span>.<span class="hljs-title function_">test</span>(phone)
      }
    }
    
    <span class="hljs-comment">// 添加全局属性</span>
    app.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$appName</span> = options?.<span class="hljs-property">appName</span> || <span class="hljs-string">'My App'</span>
    
    <span class="hljs-comment">// 添加自定义指令</span>
    app.<span class="hljs-title function_">directive</span>(<span class="hljs-string">'focus'</span>, {
      <span class="hljs-title function_">mounted</span>(<span class="hljs-params">el</span>) {
        el.<span class="hljs-title function_">focus</span>()
      }
    })
  }
}

<span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">GlobalMethodsPlugin</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./plugins/globalMethods'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
app.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">GlobalMethodsPlugin</span>, {
  <span class="hljs-attr">appName</span>: <span class="hljs-string">'企业管理系统'</span>
})

<span class="hljs-comment">// 组件中使用</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 使用全局方法</span>
    <span class="hljs-variable language_">this</span>.$http(<span class="hljs-string">'/api/users'</span>)
    
    <span class="hljs-comment">// 使用验证</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">$validate</span>.<span class="hljs-title function_">email</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">email</span>)) {
      <span class="hljs-comment">// 邮箱有效</span>
    }
    
    <span class="hljs-comment">// 访问全局属性</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'应用名称:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">$appName</span>)
  }
}
</code></pre>
<h3 data-id="heading-6">🌟 方案五：Composition API方式（最现代）</h3>
<p>如果你使用Vue 3的Composition API，可以这样组织：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// composables/useGlobalMethods.js</span>
<span class="hljs-keyword">import</span> { readonly } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useGlobalMethods</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 定义所有全局方法</span>
  <span class="hljs-keyword">const</span> methods = {
    <span class="hljs-comment">// 金额格式化</span>
    <span class="hljs-title function_">formatCurrency</span>(<span class="hljs-params">amount</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'¥'</span> + <span class="hljs-title class_">Number</span>(amount).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>)
    },
    
    <span class="hljs-comment">// 文件大小格式化</span>
    <span class="hljs-title function_">formatFileSize</span>(<span class="hljs-params">bytes</span>) {
      <span class="hljs-keyword">const</span> units = [<span class="hljs-string">'B'</span>, <span class="hljs-string">'KB'</span>, <span class="hljs-string">'MB'</span>, <span class="hljs-string">'GB'</span>]
      <span class="hljs-keyword">let</span> size = bytes
      <span class="hljs-keyword">let</span> unitIndex = <span class="hljs-number">0</span>
      
      <span class="hljs-keyword">while</span> (size &gt;= <span class="hljs-number">1024</span> &amp;&amp; unitIndex &lt; units.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
        size /= <span class="hljs-number">1024</span>
        unitIndex++
      }
      
      <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${size.toFixed(<span class="hljs-number">1</span>)}</span> <span class="hljs-subst">${units[unitIndex]}</span>`</span>
    },
    
    <span class="hljs-comment">// 复制到剪贴板</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">copyToClipboard</span>(<span class="hljs-params">text</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">clipboard</span>.<span class="hljs-title function_">writeText</span>(text)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-comment">// 降级方案</span>
        <span class="hljs-keyword">const</span> textArea = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'textarea'</span>)
        textArea.<span class="hljs-property">value</span> = text
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(textArea)
        textArea.<span class="hljs-title function_">select</span>()
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">'copy'</span>)
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(textArea)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
      }
    }
  }
  
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">readonly</span>(methods)
}

<span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useGlobalMethods } <span class="hljs-keyword">from</span> <span class="hljs-string">'./composables/useGlobalMethods'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

<span class="hljs-comment">// 挂载到全局</span>
app.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$globalMethods</span> = <span class="hljs-title function_">useGlobalMethods</span>()

<span class="hljs-comment">// 组件中使用</span>
<span class="hljs-keyword">import</span> { getCurrentInstance } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">getCurrentInstance</span>()
    <span class="hljs-keyword">const</span> $global = instance?.<span class="hljs-property">appContext</span>.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$globalMethods</span>
    
    <span class="hljs-comment">// 或者在setup中直接引入</span>
    <span class="hljs-comment">// const $global = useGlobalMethods()</span>
    
    <span class="hljs-keyword">return</span> { $global }
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$global</span>.<span class="hljs-title function_">formatCurrency</span>(<span class="hljs-number">1234.56</span>))
  }
}
</code></pre>
<h3 data-id="heading-7">📊 5种方案对比总结</h3>















































<table><thead><tr><th>方案</th><th>适用版本</th><th>优点</th><th>缺点</th><th>推荐指数</th></tr></thead><tbody><tr><td>Vue.prototype</td><td>Vue 2</td><td>简单直接</td><td>污染原型链</td><td>⭐⭐⭐</td></tr><tr><td>全局混入</td><td>Vue 2/3</td><td>逻辑分组</td><td>可能造成冲突</td><td>⭐⭐⭐</td></tr><tr><td>Provide/Inject</td><td>Vue 3</td><td>类型安全</td><td>使用稍复杂</td><td>⭐⭐⭐⭐</td></tr><tr><td>插件封装</td><td>Vue 2/3</td><td>功能完整</td><td>配置复杂</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>Composition API</td><td>Vue 3</td><td>现代灵活</td><td>需要Vue 3</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>
<h3 data-id="heading-8">💡 最佳实践建议</h3>
<ol>
<li>1. <strong>按功能分类组织</strong></li>
</ol>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 不推荐：把所有方法堆在一个文件</span>
<span class="hljs-comment">// 推荐：按功能模块拆分</span>
utils/
  ├── formatters/    <span class="hljs-meta"># 格式化相关</span>
  ├── validators/    <span class="hljs-meta"># 验证相关  </span>
  ├── http/         <span class="hljs-meta"># 请求相关</span>
  └── ui/           <span class="hljs-meta"># UI交互相关</span>
</code></pre>
<ol>
<li>2. <strong>添加TypeScript支持</strong></li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// global.d.ts</span>
<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">'@vue/runtime-core'</span> {
  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ComponentCustomProperties</span> {
    <span class="hljs-attr">$formatDate</span>: <span class="hljs-function">(<span class="hljs-params">date: <span class="hljs-built_in">Date</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>
    <span class="hljs-attr">$checkPermission</span>: <span class="hljs-function">(<span class="hljs-params">permission: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">boolean</span>
  }
}
</code></pre>
<ol>
<li>3. <strong>注意性能影响</strong></li>
</ol>
<ul>
<li>• 避免在全局方法中执行重逻辑</li>
<li>• 考虑使用懒加载</li>
<li>• 及时清理不再使用的方法</li>
</ul>
<ol>
<li>4. <strong>保持方法纯净</strong></li>
</ol>
<ul>
<li>• 一个方法只做一件事</li>
<li>• 做好错误处理</li>
<li>• 添加详细的JSDoc注释</li>
</ul>
<h3 data-id="heading-9">🎁 福利：一个实用的全局方法库</h3>
<p>我整理了一些常用的全局方法，你可以直接使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/essentials.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> essentials = {
  <span class="hljs-comment">// 下载文件</span>
  <span class="hljs-title function_">downloadFile</span>(<span class="hljs-params">url, filename</span>) {
    <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'a'</span>)
    link.<span class="hljs-property">href</span> = url
    link.<span class="hljs-property">download</span> = filename
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(link)
    link.<span class="hljs-title function_">click</span>()
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(link)
  },
  
  <span class="hljs-comment">// 获取URL参数</span>
  <span class="hljs-title function_">getUrlParam</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>)
    <span class="hljs-keyword">return</span> params.<span class="hljs-title function_">get</span>(name)
  },
  
  <span class="hljs-comment">// 休眠函数</span>
  <span class="hljs-title function_">sleep</span>(<span class="hljs-params">ms</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, ms))
  },
  
  <span class="hljs-comment">// 对象转FormData</span>
  <span class="hljs-title function_">objectToFormData</span>(<span class="hljs-params">obj</span>) {
    <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>()
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      formData.<span class="hljs-title function_">append</span>(key, obj[key])
    })
    <span class="hljs-keyword">return</span> formData
  }
}
</code></pre>
<h3 data-id="heading-10">✨ 结语</h3>
<p>掌握全局方法的定义和使用，能够让你的Vue项目更加<strong>模块化、可维护、高效</strong>。不同的方案适用于不同的场景和需求，关键是要根据项目实际情况选择最合适的方式。</p>
<p><strong>记住：好的代码不是写出来的，而是设计出来的。</strong></p>
<p>希望今天的分享对你有帮助！如果你有更好的方案或实践经验，欢迎在评论区留言分享。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Perfetto从入门到精通】5. Perfetto Data Source（数据源）简介]]></title>    <link>https://juejin.cn/post/7595769731199434758</link>    <guid>https://juejin.cn/post/7595769731199434758</guid>    <pubDate>2026-01-16T14:32:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595769731199434758" data-draft-id="7594680314713178162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Perfetto从入门到精通】5. Perfetto Data Source（数据源）简介"/> <meta itemprop="keywords" content="Android,性能优化,Android Jetpack"/> <meta itemprop="datePublished" content="2026-01-16T14:32:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lei_official"/> <meta itemprop="url" content="https://juejin.cn/user/2351234021066314"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Perfetto从入门到精通】5. Perfetto Data Source（数据源）简介
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2351234021066314/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lei_official
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T14:32:06.000Z" title="Fri Jan 16 2026 14:32:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>要爱生活，胜过爱生活的意义。要爱具体的人，而不是抽象的人类。——《卡拉马佐夫兄弟》</p>
</blockquote>
<p>Perfetto是围绕着 <strong>数据驱动</strong> 而建设的性能分析工具，在这套工具体系中，数据源（Data Source）是一个重要的概念，它是系统中各项性能指标的量化表达。</p>
<h2 data-id="heading-0">使用 <code>perfetto --query</code> 查看 Android 设备支持的数据源</h2>
<p>不同的手机系统，能够支持的数据源类型和数量都有所区别，这会直接决定到我们进行性能分析的可行性。 <strong>如果手机系统不支持某些数据源，就无法抓取到对应的性能指标数据。</strong></p>
<p>通过命令 <code>adb shell perfetto --query</code> 可以查看当前设备所支持的数据源（破折号<code>——</code>后的部分为笔者注释）：</p>
<pre><code class="hljs language-bash" lang="bash">λ adb shell perfetto --query
Not meant <span class="hljs-keyword">for</span> machine consumption. Use --query-raw <span class="hljs-keyword">for</span> scripts.

Service: Perfetto v49.0 (N/A) —— 设备上运行的 Perfetto 版本
Tracing sessions: 0 (started: 0) —— 当前在执行的 Tracing 任务数量


PRODUCER PROCESSES CONNECTED: —— 已连接到 Perfetto Service 的数据生产者列表

ID     PID      UID      FLAGS  NAME                                       SDK
==     ===      ===      =====  ====                                       ===
1      2466     9999            traced
2      2462     9999            perfetto.traced_probes                     Perfetto v49.0 (N/A)
3      2134     1072            /system/bin/gpuservice                     Perfetto v49.0 (N/A)
4      2163     1000            /system/bin/surfaceflinger                 Perfetto v49.0 (N/A)
5      3010     1000            system_server                              Perfetto v49.0 (N/A)
6      994      1000            /system/bin/servicemanager                 Perfetto v49.0 (N/A)
7      4483     10079           com.android.systemui                       Perfetto v49.0 (N/A)
8      4937     1000            /** 略 **/                		           Perfetto v49.0 (N/A)
9      5097     10103           /** 略 **/		                           Perfetto v49.0 (N/A)
10     5072     1002            com.android.bluetooth                      Perfetto v49.0 (N/A)
/** 下略 **/


DATA SOURCES REGISTERED: —— 数据生产者对外暴露的数据源，一个生产者可以生产多种类型数据源

NAME                                     PRODUCER                     DETAILS
===                                      ========                     ========
android.bluetooth_tracing                com.android.bluetooth (10)
android.game_interventions               perfetto.traced_probes (2)
android.gpu.memory                       /system/bin/gpuservice (3)
android.heapprofd                        traced (1)
android.inputmethod                      system_server (5)
android.inputmethod                      com.android.systemui (7)、
android.java_hprof                       traced (1)
android.java_hprof.oom                   traced (1)
android.kernel_wakelocks                 perfetto.traced_probes (2)
android.log                              perfetto.traced_probes (2)
android.packages_list                    perfetto.traced_probes (2)
android.polled_state                     perfetto.traced_probes (2)
android.power                            perfetto.traced_probes (2)
android.protolog                         system_server (5)
android.protolog                         com.android.systemui (7)
android.sdk_sysprop_guard                traced (1)
android.statsd                           perfetto.traced_probes (2)
android.surfaceflinger.frame             /system/bin/surfaceflinger (4)
android.surfaceflinger.frametimeline     /system/bin/surfaceflinger (4)
android.surfaceflinger.layers            /system/bin/surfaceflinger (4)
android.system_property                  perfetto.traced_probes (2)
com.android.wm.shell.transition          system_server (5)
com.android.wm.shell.transition          com.android.systemui (7)
linux.ftrace                             perfetto.traced_probes (2)   gfx,input,view,webview,wm,am,sm,audio,vi... (use --long to <span class="hljs-built_in">expand</span>)
linux.inode_file_map                     perfetto.traced_probes (2)
linux.perf                               traced (1)
linux.process_stats                      perfetto.traced_probes (2)
linux.sys_stats                          perfetto.traced_probes (2)
linux.sysfs_power                        perfetto.traced_probes (2)
linux.system_info                        perfetto.traced_probes (2)
perfetto.metatrace                       traced (1)
perfetto.metatrace                       perfetto.traced_probes (2)
track_event                              system_server (5)            always,gfx,input,view,webview,wm,am,sm,a... (use --long to <span class="hljs-built_in">expand</span>)
track_event                              /system/bin/servicemanager (6) servicemanager
track_event                              com.android.systemui (7)     always,gfx,input,view,webview,wm,am,sm,a... (use --long to <span class="hljs-built_in">expand</span>)
track_event                              /system/bin/surfaceflinger (12) always,gfx,input,view,webview,wm,am,sm,a... (use --long to <span class="hljs-built_in">expand</span>)


TRACING SESSIONS: —— 当前正在执行的 Tracing 任务细节

ID      UID     STATE      BUF (<span class="hljs-comment">#) KB   DUR (s)   #DS  STARTED  NAME</span>
===     ===     =====      ==========   =======   ===  =======  ====
</code></pre>
<p>系统中存在10+的数据生产者以及20+数据源类型，我们不必对每一种数据源都了然于心。下文将对那些可以帮助我们分析性能的主要数据源进行讲解和介绍。在学习数据源之前，先了解一下Perfetto进行数据采集的架构模型。</p>
<h2 data-id="heading-1">Perfetto 数据收集 CS 架构</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57d7788a57e94e909a458eae323cb043~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769178796&amp;x-signature=eLdc7KjJz4sWM6enrPwYJY5268U%3D" alt="producer-service-consumer.png" loading="lazy"/></p>
<p>Perfetto 采用 Client-Service 的 CS 架构。如上图所示，位于系统中心的Tracing service 相当于数据的中转站，在上游接收 Producer 传来的各项原始数据，将这些原始数据保存在 Tracing service 内部的 buffer 缓冲区中，并通过 IPC 调用，进一步将数据交给下游的消费者。</p>
<p>我们启动Perfetto数据采集时，不论是通过网站（<a href="https://link.juejin.cn?target=https%3A%2F%2Fui.perfetto.dev%2F%25EF%25BC%2589" target="_blank" title="https://ui.perfetto.dev/%EF%BC%89" ref="nofollow noopener noreferrer">ui.perfetto.dev/）</a> 还是命令行工具（<code>cat config.pbtx | adb shell perfetto -c - --txt -o /data/misc/perfetto-traces/trace.pftrace</code>），都相当于创建了一个 <code>数据消费者</code>，将其挂载到 Tracing service 上，从而建立对数据生产者的监听。</p>
<h2 data-id="heading-2">生产者：Producer</h2>
<p><strong>每个Producer = 一类能力的来源</strong></p>
<ul>
<li><code>traced</code>：Java heap、heapprofd、linux.perf、metatrace 等</li>
<li><code>traced_probes</code>：ftrace / tracefs / CPU scheduling / binder / irq</li>
<li><code>surfaceflinger</code>：帧时间、FrameTimeline</li>
<li><code>gpuservice</code>：GPU相关数据</li>
</ul>
<p>Producer描述了设备本身的能力，这些能力所收集到的数据，以 Data Source 形式呈现给开发者，只有在列表里的 Data Source，才能够在客户端 config 里进行设置，从而采集该数据。</p>
<p>笔者遇到过设备不支持 <code>linux.ftrace</code> 的场景，无论怎么设置 config，都无法获取到 CPU 任务调度轨道（CPU Scheduling）。</p>
<blockquote>
<p><strong>在已经具备 root 权限的前提下，执行 <code>adb shell setprop ctl.start traced_probes</code> 可以开启 traced_probes 生产者，从而采集 <code>linux.ftrace</code></strong></p>
</blockquote>
<h3 data-id="heading-3">分析对象与常见数据源的对应关系</h3>







































































<table><thead><tr><th>分析对象</th><th>数据源</th><th>描述什么信息</th><th>解决什么问题</th></tr></thead><tbody><tr><td>一、CPU &amp; 线程</td><td><code>linux.perf</code></td><td>CPU Profiling，火焰图<br/>谁在占用CPU，热点函数定位，调用链</td><td>卡顿，掉帧<br/>异常耗电，CPU飙高</td></tr><tr><td/><td><code>linux.ftrace</code></td><td>CPU调度信息（谁唤醒了谁等）sched_switch / sched_waking / sched_wakeup</td><td>CPU被抢占，线程得不到运行</td></tr><tr><td/><td><code>linux.process_stats</code></td><td>进程名，线程名，PID，TID</td><td>Perfetto UI 显示不出进程名</td></tr><tr><td>二、UI &amp; 卡顿</td><td><code>android.surfaceflinger.frametimeline</code></td><td>帧序列，是否发生掉帧，掉帧发生在App/SF/GPU哪一步</td><td>UI 掉帧卡顿</td></tr><tr><td/><td><code>android.surfaceflinger.frame</code><br/><code>android.surfaceflinger.layers</code></td><td>UI 结构信息，帧提交，Layer变化</td><td>UI 掉帧卡顿</td></tr><tr><td>三、内存</td><td><code>android.heapprofd</code></td><td>Native / Java 堆</td><td>哪些对象占内存，是否有泄露趋势</td></tr><tr><td/><td><code>android.java_hprof</code></td><td>Java Heap Dump 内存快照</td><td>内存泄漏分析</td></tr><tr><td>四、系统负载 &amp; 背景环境</td><td><code>linux.sys_stats</code></td><td>CPU使用率，内存信息，上下文切换数量</td><td>给 perf / ftrace 提供背景信息</td></tr><tr><td/><td><code>android.power / linux.sysfs_power</code></td><td>CPU频率变化，电源状态</td><td>同样的代码，执行起来时快时慢</td></tr><tr><td>五、日志 &amp; 事件</td><td><code>android.log</code><br/><code>trace_event</code></td><td>logcat 输出</td><td>将关键日志与性能时间线对齐</td></tr></tbody></table>
<h3 data-id="heading-4">Q：为什么不同的 PRODUCER 可以对应相同的 <code>NAME</code> ?</h3>
<p>例如下面这段，一个 <code>android.inputmethod</code> 数据源，居然有8个不同的生产者，要如何理解？难道不是一个数据源只能由一个生产者提供么？</p>
<pre><code class="hljs language-bash" lang="bash">android.inputmethod system_server (5)
android.inputmethod com.android.systemui (7)
android.inputmethod com.vivo.upslide (8)
android.inputmethod com.bbk.launcher2 (9)
android.inputmethod com.vivo.globalanimation:drawing (11)
android.inputmethod com.vivo.ai.ime.nex (13)
android.inputmethod com.vivo.hiboard (14)
android.inputmethod com.vivo.globalsearch (15)
</code></pre>
<h3 data-id="heading-5">A： <code>NAME</code> 不是“全局唯一的数据源”，而是“同一种接口/协议的数据源实例”</h3>
<p>同一个 <code>NAME</code> 可以被多个 Producer 同时提供，这是 Perfetto 的设计特性。</p>
<p>Perfetto 的真实模型是：</p>
<blockquote>
<p><strong>一个 NAME = 一种“数据源类型 / 接口协议”<br/>多个 Producer = 各自提供这个接口的一个实例</strong></p>
</blockquote>
<p>对于上述 <code>android.inputmethod</code> 的例子，其数据生产者都“实现/接入”了该数据源接口，它们提供各自进程内的 input 相关事件，并非是共享的同一份数据。</p>
<p>Perfetto 进行这种设计，遵循的原则是“<strong>谁产生事件，谁就自己上报</strong>”。好处有以下几点：</p>
<ul>
<li>无跨进程侵入</li>
<li>权限边界清晰</li>
<li>开销可控</li>
<li>App/组件可以按需接入</li>
</ul>
<p>如果我们想对数据源 <code>android.inputmethod</code> 进行收集，则需要在配置文件里写：</p>
<pre><code class="hljs language-proto" lang="proto">data_sources {
  config {
    name: "android.inputmethod"
  }
}
</code></pre>
<p>这样会对 <strong>所有</strong> 注册了 <code>android.inputmethod</code> 的 Producer 都启用该数据源。最终在 trace 里，数据仍然按照 <strong>进程/线程</strong> 分轨道显示。</p>
<p>当然，系统中也存在一些唯一的数据源 <code>NAME</code>，它们有且仅有唯一的 PRODUCER。</p>
<ul>
<li><code>linux.perf</code> → 只有 <code>traced</code></li>
<li><code>linux.ftrace</code> → 只有 <code>perfetto.traced_probes</code></li>
<li><code>android.heapprofd</code> → 只有 <code>traced</code></li>
</ul>
<p>它们共同的特点是：</p>
<blockquote>
<p><strong>系统级、集中式、跨进程视角</strong></p>
</blockquote>
<h2 data-id="heading-6">中转站：Service</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13215d477a9b479dbb8bca1ca3aa1b59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769178796&amp;x-signature=g25JeWzZPBqyYmavxLhtoj9uFaI%3D" alt="image.png" loading="lazy"/></p>
<p>Tracing service 是位于 Producer 和 Consumer 之间，承上启下的桥梁。它读取 Consumer 所设置的配置信息，维护相应 buffer，并按照配置中的数据源，从 Producer 中采集数据。它具有如下职责：</p>
<ul>
<li>维护一个生产者-数据源对应关系的注册表。</li>
<li>管理数据缓冲区。</li>
<li>处理多个 Tracing Session 并行收集的场景。</li>
<li>将 Consumer 提供的配置给到对应的 Producer。</li>
<li>告知 Producer 进行 Tracing 的时机和内容。</li>
<li>将数据从 Producer 的共享内存缓冲区移动到自身的非共享内存缓冲区。</li>
<li>最终通过写文件的方式，将采集到的数据进行持久化。</li>
</ul>
<h2 data-id="heading-7">消费者：Consumer</h2>
<p>消费者是数据的应用方，它可以表现为多种可信实体（Linux/Android 上的命令行客户端，Chrome 中的浏览器进程接口）。它可以与 Tracing Service 进行 IPC 通信并读取其缓冲区。</p>
<p>对这两种操作的详细描述如下：</p>
<ul>
<li>向 Tracing service 发送跟踪配置，确定：
<ul>
<li>要创建的 Tracing buffer 数量。</li>
<li>Tracing buffer 的大小。</li>
<li>每个 Tracing buffer 的策略（<code>Stop when full</code>, <code>Ring buffer</code>, <code>Long trace</code>）。</li>
<li>要启用的数据源。</li>
<li>每个数据源的配置。</li>
<li>每个已配置数据源生成的数据的目标 Buffer。</li>
<li>启用和禁用 Tracing。</li>
</ul>
</li>
<li>读取跟踪缓冲区：
<ul>
<li>通过 IPC 通道流式传输数据。</li>
<li>向 Tracing service 传递文件描述符，并指示其定期将 Tracing buffer 保存到文件中，即 <code>perfetto -o</code> 参数指定的文件如 <code>/data/misc/perfetto-traces/trace.pftrace</code>。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-8">用一张图描述 Producer/Service/Consumer</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/634b2b7f7b6242d0ac87de97f188371b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVpX29mZmljaWFs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769178796&amp;x-signature=n0UN6nFFWmjKwB7YirvDnKOhvq4%3D" alt="perfetto_arch.png" loading="lazy"/></p>
<h2 data-id="heading-9">附：常见 Android 性能问题 → Perfetto 数据源对照表</h2>































































































<table><thead><tr><th>性能问题 / 现象</th><th>首选数据源</th><th>重点看什么</th><th>常见结论 / 行动</th></tr></thead><tbody><tr><td><strong>CPU 占用高 / 手机发热</strong></td><td><code>linux.perf</code><br/><code>linux.process_stats</code></td><td>火焰图热点函数、线程归属</td><td>热点在业务函数→优化算法/频率；热点在框架/IO→检查调用频次</td></tr><tr><td><strong>偶发卡顿（非 UI）</strong></td><td><code>linux.perf</code><br/><code>linux.ftrace</code><br/><code>linux.process_stats</code></td><td>热点是否伴随频繁切换/唤醒</td><td>不是“慢”，而是被打断→减少锁/跨线程唤醒</td></tr><tr><td><strong>UI 掉帧 / 丝滑度差</strong></td><td><code>android.surfaceflinger.frametimeline</code><br/><code>linux.ftrace</code><br/><code>linux.process_stats</code></td><td>哪一段掉帧（App/SF/GPU）</td><td>App 段慢→主线程；SF/GPU→过度绘制/纹理</td></tr><tr><td><strong>主线程阻塞</strong></td><td><code>linux.perf</code><br/><code>android.surfaceflinger.frametimeline</code></td><td>主线程火焰图、帧时间</td><td>同步 IO/大对象/反射→移到后台</td></tr><tr><td><strong>线程频繁被切走</strong></td><td><code>linux.ftrace (sched_switch)</code></td><td>同一线程短时间多次切换</td><td>优先级不当/CPU 竞争→调度/合并任务</td></tr><tr><td><strong>频繁唤醒导致抖动</strong></td><td><code>linux.ftrace (sched_waking)</code></td><td>谁在唤醒谁、频率</td><td>锁/条件变量/Binder 风暴→合并唤醒</td></tr><tr><td><strong>Binder 相关卡顿</strong></td><td><code>linux.ftrace</code><br/><code>linux.perf</code></td><td>唤醒链 + Binder 栈</td><td>同步 Binder/大包→异步/拆包</td></tr><tr><td><strong>后台任务拖慢前台</strong></td><td><code>linux.perf</code><br/><code>linux.ftrace</code></td><td>前后台线程竞争</td><td>后台降频/限速/WorkManager 约束</td></tr><tr><td><strong>启动慢（冷/温）</strong></td><td><code>linux.perf</code><br/><code>android.surfaceflinger.frametimeline</code></td><td>启动阶段热点、首帧</td><td>初始化过多→延迟加载</td></tr><tr><td><strong>耗电异常（CPU）</strong></td><td><code>linux.perf</code><br/><code>linux.sys_stats</code><br/><code>android.power</code></td><td>长时热点 + 频率</td><td>忙等/轮询→事件驱动</td></tr><tr><td><strong>同样代码时快时慢</strong></td><td><code>linux.sys_stats</code><br/><code>android.power</code><br/><code>linux.perf</code></td><td>频率/负载背景</td><td>DVFS/负载干扰→降频敏感点</td></tr><tr><td><strong>内存抖动/泄漏</strong></td><td><code>android.heapprofd</code><br/><code>android.java_hprof</code></td><td>分配热点/存活对象</td><td>对象复用/生命周期修正</td></tr><tr><td><strong>日志影响性能</strong></td><td><code>android.log</code><br/><code>linux.perf</code></td><td>日志与卡顿对齐</td><td>关键路径禁用/降级日志</td></tr><tr><td><strong>不明原因卡顿</strong></td><td><code>linux.perf</code><br/><code>linux.ftrace (sched_switch, sched_waking)</code><br/><code>linux.process_stats</code><br/><code>android.surfaceflinger.frametimeline</code><br/><code>linux.sys_stats</code></td><td>多源对齐</td><td>先定性再定量</td></tr></tbody></table>
<h2 data-id="heading-10">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fconcepts%2Fservice-model" target="_blank" title="https://perfetto.dev/docs/concepts/service-model" ref="nofollow noopener noreferrer">perfetto.dev/docs/concep…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1946580342459836058" target="_blank" title="https://zhuanlan.zhihu.com/p/1946580342459836058" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/194658034…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fperfetto.dev%2Fdocs%2Fgetting-started%2Fsystem-tracing" target="_blank" title="https://perfetto.dev/docs/getting-started/system-tracing" ref="nofollow noopener noreferrer">perfetto.dev/docs/gettin…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG进阶篇 | 混合检索+重排序=王炸！]]></title>    <link>https://juejin.cn/post/7595683968684539950</link>    <guid>https://juejin.cn/post/7595683968684539950</guid>    <pubDate>2026-01-16T13:32:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595683968684539950" data-draft-id="7595831738233094153" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG进阶篇 | 混合检索+重排序=王炸！"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2026-01-16T13:32:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG进阶篇 | 混合检索+重排序=王炸！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T13:32:25.000Z" title="Fri Jan 16 2026 13:32:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在构建 RAG 应用时，一个常见的认知偏差是将整个流程简化为：“把文档切分后存入向量库，再做语义检索”。</p>
<p>在原型验证阶段，这种仅依赖向量相似度的方案往往效果不错。然而，一旦进入真实业务场景，两类典型的检索失效问题便会暴露无遗：</p>
<p>专有名词匹配失败‌：当用户查询“X-2000 处理器”或“Error 503”这类精确标识符时，向量模型倾向于返回语义相近的泛化内容，如“高性能芯片”或“网络异常”，却完全遗漏了包含原始术语的精准文档——因为在嵌入空间中，这些字符缺乏显著的语义信号。</p>
<p>语义漂移‌：面对“不含糖的饮料”这样的查询，系统可能召回大量包含“糖”与“饮料”关键词的文档，甚至错误地包含“含糖饮料”，因为它捕捉到了词汇共现的相关性，却未能识别“不”这一关键逻辑否定。</p>
<p>要突破这些瓶颈，必须升级检索架构：引入‌混合检索（Hybrid Search）‌ 与 ‌重排序（Rerank）‌ 机制，实现精确匹配与语义理解的协同增强。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<h2 data-id="heading-0">01 为什么单一检索策略会失效？</h2>
<p>要理解混合检索的必要性，需先厘清两种主流检索范式的底层机制与各自短板。</p>
<p>向量检索‌（Dense Retrieval）</p>
<p>机制‌：通过将文本编码为高维语义向量，依据查询与文档在向量空间中的相似度进行匹配。</p>
<p>长处‌：能有效识别语义层面的关联与词汇替代关系，例如识别“电脑”与“计算机”为等价概念。</p>
<p>短处‌：对字面精确匹配能力薄弱，面对人名、产品编号、缩略词等无语义内涵的关键词时，召回效果显著弱于基于词频的方法。</p>
<p>关键词检索‌（Sparse Retrieval / BM25）</p>
<p>机制‌：依赖词频-逆文档频率（TF-IDF）统计模型，评估查询词在文档中的出现频次与区分度。</p>
<p>长处‌：在精准命中特定术语方面表现卓越，即便用户输入冷门词汇或专有名词，也能高效定位包含该词的文档。</p>
<p>短处‌：完全缺乏语义理解能力，无法建立“苹果”与“iPhone”之间的语义关联，亦无法处理同义转换或跨语言查询。</p>
<p>结论‌：在真实应用场景中（如企业知识库、法律文书、临床病历），用户查询通常兼具语义意图与精确术语需求。仅依赖单一检索机制，难以兼顾语义泛化与字面精准的双重目标。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05b631344f01407e9f8215dd76c00c87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769175145&amp;x-signature=bPEi9ITmFNBNpacaSU6gu%2BF0VlU%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">02 解决方案：混合检索与 RRF 融合</h2>
<p>混合检索的本质在于：同时启动向量搜索与关键词搜索，并对二者输出的结果进行整合。</p>
<p>然而，这一过程面临一个关键的数学障碍：评分尺度的异构性。</p>
<p>向量检索输出的是‌余弦相似度‌（一般范围为 0 至 1，例如 0.85）。</p>
<p>BM25 输出的是‌加权得分‌（常见区间为 0 至 20 以上，例如 12.5）。</p>
<p>若直接将 0.85 与 12.5 相加，将失去语义基础。因此，亟需一种机制，不依赖原始分数的绝对值，而仅依据文档的排序位置实现融合——这正是 ‌RRF‌（Reciprocal Rank Fusion，倒数排序融合）所解决的问题。</p>
<p>RRF 算法原理</p>
<p>RRF 的计算公式非常简洁：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e47d42a9dd94d168732e0b434db0f6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769175145&amp;x-signature=TPRIG61qpBme4ZqqFOIXVD8%2B13g%3D" alt="图片" loading="lazy"/></p>
<p>其中，rank 表示文档在单一检索列表中的位置（第 1 名、第 2 名……），k 为固定常数，通常设定为 60。</p>
<p>RRF 的核心机制如下：</p>
<p>当一个文档在‌向量检索‌中位列第 1，同时在 ‌BM25‌ 中也居于第 1，其综合得分将达到峰值。</p>
<p>若一个文档仅在 ‌BM25‌ 中排名首位，即便在向量检索中完全未被召回，它仍能获得显著的高分，从而保有进入最终结果列表的竞争力。</p>
<p>该设计通过融合两种检索信号的排名信息，使系统在保留语义相关性的同时，不遗漏关键词匹配的精准结果，从而显著增强整体‌召回率（Recall）‌。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e915b5b9e852467793dee1bd4864beb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769175145&amp;x-signature=fPzVZNHRG51KOKMWOxEWAIGXHS8%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-2">03 Cross-Encoder 重排序 (Rerank)</h2>
<p>通过混合检索，我们有效缓解了“召回不全”的痛点（显著提升召回率），但此时返回的 Top-K 结果（如前 50 条文档）中，仍混杂大量无关内容。</p>
<p>以搜索“iPhone 15 价格”为例，混合检索可能返回：</p>
<p>iPhone 15 的官方发布新闻（高度相关）</p>
<p>iPhone 14 的促销降价信息（关键词匹配，实际无关）</p>
<p>安卓旗舰机型对比评测（语义相近，但非目标对象）</p>
<p>为确保 LLM 接收的信息高度精准，需在检索与生成之间插入‌精排（Rerank）‌环节。</p>
<p>Bi-Encoder 与 Cross-Encoder 的差异：‌</p>
<p>向量检索（Bi-Encoder）‌：追求效率，查询与文档分别编码，相似度计算缺乏上下文交互，本质为“粗筛”。</p>
<p>重排序模型（Cross-Encoder）‌：高精度模型，将查询与候选文档拼接后联合编码，通过深度语义交互计算相关性得分，实现细粒度判断。</p>
<p>重排序执行流程：‌</p>
<p>广撒网‌：借助混合检索，初步召回 Top 50 至 Top 100 文档。</p>
<p>精挑选‌：采用 Cross-Encoder 模型（如 BGE-Reranker），对每一条候选文档独立评分。</p>
<p>截断‌：仅保留评分最高的 Top 5 文档，交付后续 LLM 生成。</p>
<p>该策略在效率与精度间达成最优权衡：以低开销检索快速扩大候选池，再以高成本模型在小规模集合中实现精准过滤。</p>
<h2 data-id="heading-3">04 总结与通用实践建议</h2>
<p>构建一个高可用的 RAG 检索系统，其核心在于分层过滤的漏斗机制。</p>
<p>第一层（L1）：混合检索‌</p>
<p>融合向量检索（Vector）与 BM25，借助 RRF 算法实现召回最大化（Recall 优先），策略宗旨为“宁滥勿缺”，确保不遗漏任何潜在相关文档。</p>
<p>第二层（L2）：重排序‌</p>
<p>引入 Cross-Encoder 模型，对 L1 输出进行深度语义排序（Precision 优先），目标直指“去伪存真”，精准剔除语义偏差与噪声干扰。</p>
<p>适用场景建议‌：</p>
<p>法律 / 医疗 / 金融领域‌：术语密集、数值敏感，单一向量检索极易遗漏关键语义锚点，混合检索为必要选择。</p>
<p>技术文档 / 代码库‌：变量名、错误码具有唯一性与字面强关联性，BM25 的精确匹配能力占据主导，混合架构不可替代。</p>
<p>通用客服 / 闲聊场景‌：对精度容忍度高，响应延迟为首要约束，可简化为纯向量检索，规避 Rerank 带来的额外开销。</p>
<p>尽管技术持续迭代，但“关键词匹配”与“语义理解”的协同互补，以及“粗排+精排”的层级架构，始终是搜索与推荐系统经久不衰的黄金范式，亦是现代 RAG 系统稳健运行的底层基石。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多模融合：金仓数据库重新定义文档处理能力]]></title>    <link>https://juejin.cn/post/7595764380472606770</link>    <guid>https://juejin.cn/post/7595764380472606770</guid>    <pubDate>2026-01-16T13:37:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595764380472606770" data-draft-id="7595764380472590386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多模融合：金仓数据库重新定义文档处理能力"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T13:37:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多模融合：金仓数据库重新定义文档处理能力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T13:37:27.000Z" title="Fri Jan 16 2026 13:37:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数字化转型的关键阶段，企业对数据处理的需求已超越基础的存储与检索。文档数据库凭借其处理半结构化数据的天然优势，成为现代应用开发的重要基石。然而，随着技术自主可控、供应链安全以及多模数据融合处理成为企业发展的核心诉求，传统开源文档数据库在性能、可靠性和企业级服务支撑方面的局限性日益凸显。</p>
<p>为应对这一挑战，电科金仓正式推出金仓数据库MongoDB兼容版。该产品并非简单的技术仿制，而是基于其成熟稳定的企业级内核，深度集成文档模型处理能力，旨在为企业提供一条更安全、更高效、更易于管理的国产化替代与升级路径。</p>
<p><strong>性能实测：对标行业标杆，彰显技术实力</strong></p>
<p>性能是衡量数据库核心竞争力的关键。金仓数据库MongoDB兼容版在权威的YCSB（Yahoo! Cloud Serving Benchmark）基准测试中，与行业标杆MongoDB 7.0展开了全面对比。测试涵盖了读写均衡、读多写少、只读及读最新写入等六种典型业务负载场景。结果表明，在绝大多数测试场景下，金仓数据库性能均达到或超越MongoDB 7.0，尤其在混合读写和插入后读取等高并发场景中表现更为出色。这充分说明，切换至金仓数据库不仅能够实现业务的平滑迁移，更可在同等资源条件下，为应用程序带来更高的吞吐量与更低的响应延迟，助力企业提升整体数据处理效能。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c60f2f48ce54a0f8222a620116b08b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769175447&amp;x-signature=vt9gop%2FnPgMejGKReat7Be8RVMo%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>此版本通过“正面交锋”、“清晰印证”等词汇强化对抗感，并以“双重价值”作结，使论述更具冲击力。</p>
<blockquote>
<p>即使与以处理复杂JSON数据见长的关系型数据库巨头Oracle相比，金仓数据库的BSON处理引擎也展现出了显著优势。在针对双层嵌套文档的更新性能测试中，面对轻量级JSON数据，金仓的处理速度可达到Oracle（基于其OSON格式）的约两倍。这一结果清晰印证了金仓在处理主流业务文档数据时的高效性，不仅能够充分满足系统对实时操作的性能要求，更从关键维度上，为从Oracle生态向金仓的迁移或融合提供了坚实的性能依据与信心。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eef5380e93c434b93cdf37e8aecb56a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX6L6wYWxr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769175447&amp;x-signature=FwLZFSuBphKncLv0w3TUL7xSO9w%3D" alt="在这里插入图片描述" loading="lazy"/>
在数字化转型的浪潮中，企业对数据处理的需求日益复杂多元。文档数据库因天然适配半结构化数据，成为现代应用架构的重要组成。然而，随着技术自主可控与供应链安全成为关键命题，传统开源文档数据库在企业级可靠性、性能及多模数据融合处理方面的短板逐渐显现。</p>
<p>电科金仓推出的金仓数据库MongoDB兼容版，正是为回应这一挑战而来。它并非简单的功能仿效，而是基于历经锤炼的企业级内核，深度集成文档模型能力，为企业提供一条更安全、更稳定、更易运维的国产化演进路径。</p>
<p><strong>性能表现：直面行业主流，验证硬核实力</strong>
性能是数据库的核心竞争力。在金仓数据库MongoDB兼容版与MongoDB 7.0的权威YCSB基准测试对比中，覆盖了读写均衡、读多写少、只读、读最近数据等六类典型业务场景。测试结果显示，金仓在绝大多数负载下性能均达到或优于MongoDB 7.0，尤其在读写混合与插入后读取的场景中优势更为明显。这意味着迁移至金仓不仅能实现业务平滑承接，还可进一步提升系统吞吐与响应效率。</p>
<p><strong>内核优势：企业级能力与多模融合架构</strong>
金仓的竞争力源于其深厚的原生内核积淀。通过将文档模型深度集成至统一内核，该产品天然继承了金仓在强事务一致性、高可用与高安全方面的完整能力。其统一的查询优化层可为关系、文档、向量等不同数据模型智能生成最优执行计划；统一的索引框架支持B-Tree、RUM、HASH等多种索引类型，并能扩展自定义索引方法，为复杂查询提供高效加速。这种多模一体的架构，显著降低了企业维护多套异构系统的成本与复杂度。</p>
<p><strong>无缝迁移与高可用保障</strong>
金仓数据库实现了对MongoDB 5.0+版本通信协议的原生兼容，常用命令与操作符兼容度接近100%，支持现有应用几乎无需改动代码即可迁移。针对文档型数据常见的大对象存储，亦通过原生兼容GridFS协议予以支持。</p>
<p>在高可用方面，金仓具备从实例、集群到多数据中心级别的完整容灾能力。其读写分离集群支持故障秒级切换（RTO＜30秒）且保障数据零丢失（RPO=0），可部署同城双活、两地三中心等高级架构，满足金融、政务等场景对业务连续性的严苛要求。</p>
<p>此外，通过统一的数据库管控平台KEMCC，管理员可在同一界面内完成对多类数据库实例的监控、管理与调优，大幅提升运维效率。</p>
<p><strong>实践验证：支撑关键业务系统</strong>
在福建省某地市电子证照共享服务系统的国产化改造中，金仓数据库成功替代原MongoDB，承载了超过2TB数据与上千级并发压力。迁移过程平滑，系统已稳定运行半年以上，支持当地500余家单位的证照服务，并通过读写分离与针对性优化，将部分复杂查询响应时间从秒级降至毫秒级。</p>
<p>同类案例已在金融、能源、通信等行业多次落地，验证了金仓数据库在核心业务场景中具备高兼容、高性能与高可靠的成熟能力。</p>
<p><strong>结语：构建面向未来的多模数据底座</strong>
金仓数据库MongoDB兼容版不只是一款替代产品，更代表了一种以企业级需求为导向、以技术自主为根基、以多模融合为路径的数据库发展新范式。它在性能上对标国际主流，在兼容性上最大化保护用户投资，在能力上提供完整可靠的企业级服务。</p>
<p>对于正推进文档数据库国产化替代或寻求构建统一、高效、安全数据平台的企业而言，金仓数据库提供了一个兼具技术前瞻性与落地实践性的选择。它不仅是现有架构的可靠替代，更是企业走向下一代智能数据管理的重要基石，助力企业在数字化转型中行稳致远。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一款专为 WinUI XAML 设计的快速原型设计工具，生成的代码可轻松复制到Visual Studio中！]]></title>    <link>https://juejin.cn/post/7595774188910493734</link>    <guid>https://juejin.cn/post/7595774188910493734</guid>    <pubDate>2026-01-16T13:50:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595774188910493734" data-draft-id="7595774188910477350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一款专为 WinUI XAML 设计的快速原型设计工具，生成的代码可轻松复制到Visual Studio中！"/> <meta itemprop="keywords" content="后端,C#"/> <meta itemprop="datePublished" content="2026-01-16T13:50:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一款专为 WinUI XAML 设计的快速原型设计工具，生成的代码可轻松复制到Visual Studio中！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T13:50:31.000Z" title="Fri Jan 16 2026 13:50:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>今天大姚给大家分享一款专为 WinUI XAML 设计的快速原型设计工具，生成的代码可轻松复制到 Visual Studio 中：<strong>XAML Studio</strong>。</p>
<h2 data-id="heading-1">XAML Studio 工具介绍</h2>
<p>XAML Studio 是一款专为 WinUI XAML 设计的快速原型设计工具，基于 C# 开源（MIT license），生成的代码可轻松复制到 Visual Studio 中的应用中。XAML Studio 让你实时预览 XAML 代码，并与结果互动，就像它在你自己的应用中运行一样。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/145026970fbc4b15b930dd27ce94b283~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769176230&amp;x-signature=EynhmnkAn1qE3gGAOLiT%2BG9kXFc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">WinUI 介绍</h2>
<p>WinUI 是一个现代 UI 框架，拥有丰富的控件和样式，用于构建动态且高性能的 Windows 应用程序。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fmicrosoft-ui-xaml" target="_blank" title="https://github.com/microsoft/microsoft-ui-xaml" ref="nofollow noopener noreferrer">github.com/microsoft/m…</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7df427d4642f4ce8aae1113f4580bcb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769176230&amp;x-signature=5nliKqb0hGm3X3fKVHPoZ7MsZLg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">应用场景</h2>
<ul>
<li><strong>界面调试与优化：</strong> 通过内置的调试工具和数据上下文编辑器，开发者可以实时调试和优化界面。</li>
<li><strong>学习与教学：</strong> 对于初学者，XAML Studio 提供了一个低门槛的平台来学习和实践 WinUI XAML 开发。</li>
<li><strong>快速原型设计：</strong> 开发者可以利用 XAML Studio 快速构建和测试 XAML 界面，无需在 Visual Studio 中完整构建应用程序。</li>
</ul>
<h2 data-id="heading-4">功能特点</h2>
<p>实时编辑与交互、绑定调试器、数据上下文编辑器、自动保存并恢复文档、智能感知（IntelliSense）、文档工具箱、对齐辅助线等。</p>
<h2 data-id="heading-5">项目源代码</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70692717550e4271ad6369dc21591ee1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769176230&amp;x-signature=IBYTfCh3MrgzqGv21CCSf5BioBA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">运行效果演示</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d77e8b9433054b97ae15dd74fceac531~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769176230&amp;x-signature=BGLQHZfG4KWTyC%2FhXU5HqOuTnA4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5134d21794b34067bf26fa4d28c798f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769176230&amp;x-signature=hTYD5DcsXBNy6IOtNHkX3rEjznY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/017b0377d5b9478db4f5e0c0482ccb1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769176230&amp;x-signature=Hz3G6JACwGxt2jpphO%2By1eG1hVM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aedf296bf64b43e785564344c071f529~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769176230&amp;x-signature=YL5CLtQ5IFKV%2FKroxp5HqLRxiYg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a597c7a85fc54ec3a3e72513ea89f4e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769176230&amp;x-signature=vwqODMrcUJBVahqNXXYu6eoTw3s%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dab24fef440d45b78843f1e171cbde32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769176230&amp;x-signature=jHidJYm4ghisBOR%2Brz4TFgTr%2Fcg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">项目源码地址</h2>
<p>更多项目实用功能和特性欢迎前往项目开源地址查看👀，别忘了给项目一个Star支持💖。</p>
<ul>
<li><strong>GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdotnet%2FXAMLStudio" target="_blank" title="https://github.com/dotnet/XAMLStudio" ref="nofollow noopener noreferrer">github.com/dotnet/XAML…</a></li>
</ul>
<h2 data-id="heading-8">优秀项目和框架精选</h2>
<p>该项目已收录到C#/.NET/.NET Core优秀项目和框架精选中，关注优秀项目和框架精选能让你及时了解C#、.NET和.NET Core领域的最新动态和最佳实践，提高开发工作效率和质量。坑已挖，欢迎大家踊跃提交PR推荐或自荐（<strong>让优秀的项目和框架不被埋没🤞</strong>）。</p>
<ul>
<li><strong>GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
<li><strong>Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[纯血国产的逆袭：GLM-Image如何用昇腾芯片霸榜Hugging Face]]></title>    <link>https://juejin.cn/post/7595771085394395187</link>    <guid>https://juejin.cn/post/7595771085394395187</guid>    <pubDate>2026-01-16T12:03:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595771085394395187" data-draft-id="7595772638881398835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="纯血国产的逆袭：GLM-Image如何用昇腾芯片霸榜Hugging Face"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-16T12:03:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            纯血国产的逆袭：GLM-Image如何用昇腾芯片霸榜Hugging Face
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T12:03:13.000Z" title="Fri Jan 16 2026 12:03:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在AI圈子里混久了，大家都有个心照不宣的认知：想训练顶级的SOTA（State of the Art）模型，似乎总绕不开那几张绿色的显卡。</p>
<p>但就在2026年1月14日，这个所谓的“铁律”被撕开了一道口子。</p>
<p>智谱AI联合华为悄无声息地开源了一个新家伙——GLM-Image。仅仅过了24小时，它就直接冲上了全球最大的AI开源社区Hugging Face的Trending榜单首位。这不仅是一次排名的更迭，更像是一场宣誓：即便完全脱离英伟达的硬件生态，全流程跑在国产算力上，我们依然能做出世界级的模型。</p>
<p>今天我们不谈那些晦涩的学术定义，单从技术和产业的角度，聊聊这个名为GLM-Image的项目到底为什么值得你关注。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2F640-2-719x1024.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/640-2-719x1024.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50f11dc0f0fc4b959a53031b5b378224~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769169793&amp;x-signature=vhJNWJFegIiV9FqpgXVwqzjm9Q0%3D" alt="640" loading="lazy"/></a></p>
<h3 data-id="heading-0">并没有“大力出奇迹”，而是赢在架构</h3>
<p>如果你只看参数量，GLM-Image并不是市面上最大的。它聪明在架构的设计上，采用了“自回归 + 扩散解码器”的混合打法。</p>
<p>我们可以把这个模型想象成一个配合默契的画家团队：</p>
<p>其中有一个90亿参数（9B）的<strong>自回归模型</strong>，它更像是一个“导演”或“构图师”。它的强项在于理解复杂的语言指令，规划画面的全局结构。它不负责具体的涂色，只负责把逻辑理顺，告诉后面的人：这里该有人，那里该有树，海报的标题必须放在正中间。</p>
<p>配合它的是一个70亿参数（7B）的<strong>扩散解码器</strong>，这是负责执行的“画师”。它拿着导演的草图，配合专门的字形编码器，开始精细地填充像素、还原光影，最重要的是——死磕文字的笔画细节。</p>
<p>这种组合拳彻底解决了一个长期困扰文生图领域的痛点：要么图好看但听不懂复杂指令，要么听得懂指令但画出来的字是乱码。GLM-Image在CVTG-2K（复杂视觉文本生成）榜单上拿下了开源第一，靠的就是这种分工明确的“脑手分离”架构。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Farchitecture_1-1024x251.jpeg" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/architecture_1-1024x251.jpeg" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4681fbf0604040ea82afdaf6ee238f20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769169793&amp;x-signature=RfF7L1Cp9g9SgOMnYOMe0CJ7tLE%3D" alt="architecture_1" loading="lazy"/></a></p>
<h3 data-id="heading-1">真正的“全栈国产”意味着什么？</h3>
<p>这才是GLM-Image最硬核的地方。</p>
<p>以往我们在谈论国产模型时，往往指的是算法层面的自研，但底层的训练芯片大概率还是依赖A100或H100。但GLM-Image这次把底裤都换了——它是首个从数据预处理、模型训练到最终推理，全流程基于<strong>华为昇腾Atlas 800T A2</strong>设备和<strong>昇思MindSpore</strong>框架完成的SOTA模型。</p>
<p>这意味着什么？</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Farchitecture_2-1024x422.jpeg" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/architecture_2-1024x422.jpeg" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05a3aeb3d5174ef5ba73d19cd4f25efd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769169793&amp;x-signature=ZygklLMpClr4fqAdtzxxeUxDu2I%3D" alt="architecture_2" loading="lazy"/></a></p>
<p>意味着智谱和华为的工程师们，硬是在国产硬件上跑通了复杂的分布式训练。他们用了动态图多级流水下发、高性能融合算子这些听起来很硬核的技术，去压榨昇腾NPU的性能上限。</p>
<p>结果证明，这套全栈国产的组合不仅能跑，而且跑得很快，甚至在训练效率上已经能和国际主流方案掰手腕。对于在这个特殊时期依然在探索AI自主可控的企业来说，这无疑是一剂强心针。</p>
<h3 data-id="heading-2">当AI不再“提笔忘字”</h3>
<p>对于普通开发者和设计师来说，GLM-Image最直观的冲击力在于它对文字的处理能力。</p>
<p>用过Midjourney或DALL-E 3的朋友都知道，让AI画一只猫容易，但让AI在猫的衣服上准确写出“恭喜发财”这四个汉字，简直是噩梦。GLM-Image得益于其独特的字形编码器，在中文长文本渲染上表现出了惊人的准确率（Word Accuracy达到0.9116）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-16_19.54.26-1024x541.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-16_19.54.26-1024x541.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa1d1c0db5a24dae9355d90afc011aee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769169793&amp;x-signature=%2FzDUBSLK59vxaSdidUVE6WYohy0%3D" alt="iShot_2026-01-16_19.54.26" loading="lazy"/></a></p>
<p>无论是做电商海报、科普插画，还是生成带文字的PPT配图，它都能做到字迹清晰、笔画准确。而且，它原生支持从1024到2048分辨率的任意比例生成，不需要重新裁剪或后期处理。</p>
<h3 data-id="heading-3">务实的定价与开源的诚意</h3>
<p>最后聊聊钱。</p>
<p>技术再好，用不起也是白搭。GLM-Image在API调用模式下，生成一张图的成本仅为<strong>0.1元人民币</strong>。相比于国外同类产品动辄几毛甚至上块的价格，这个定价极其务实，几乎是贴着成本价在跑。</p>
<p>更重要的是，它彻底开源了。无论是GitHub还是魔搭社区，你都可以直接下载权重，在自己的服务器上部署。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-16_19.54.52-1024x478.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-16_19.54.52-1024x478.png" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c65c06b55f524522ba3f6fde57433fb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769169793&amp;x-signature=7ktcd5qHYncaLhKfNZUguve1fsk%3D" alt="iShot_2026-01-16_19.54.52" loading="lazy"/></a></p>
<p>总结一下，GLM-Image的出现，不仅为我们提供了一个好用的文生图工具，更是在全行业面前完成了一次极具象征意义的技术验证：在国产算力底座上，我们完全有能力通过架构创新和软硬协同，构建出具有国际竞争力的多模态大模型。</p>
<p>这，或许才是它霸榜Hugging Face背后的真正原因。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（45）什么是Hibernate的连接池优化？]]></title>    <link>https://juejin.cn/post/7595801647247310867</link>    <guid>https://juejin.cn/post/7595801647247310867</guid>    <pubDate>2026-01-16T11:54:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595801647247310867" data-draft-id="7595769731199090694" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（45）什么是Hibernate的连接池优化？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T11:54:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（45）什么是Hibernate的连接池优化？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T11:54:07.000Z" title="Fri Jan 16 2026 11:54:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Hibernate中，连接池（Connection Pool）是管理数据库连接的一种机制，旨在优化数据库连接的性能。当应用程序需要访问数据库时，它不必每次都创建和销毁连接，而是从连接池中获取已创建的连接，这样可以显著提高性能。</p>
<h3 data-id="heading-0">连接池的优化</h3>
<p>Hibernate支持多种连接池实现，包括Hibernate内置的连接池和第三方连接池（如C3P0、HikariCP、DBCP等）。第三方连接池通常比Hibernate内置连接池提供更好的性能和更多的配置选项，因此更适合生产环境。</p>
<p>下面展示如何配置和优化Hibernate连接池，以C3P0为例。</p>
<h4 data-id="heading-1">步骤一：引入C3P0依赖</h4>
<p>首先，需要在项目中引入C3P0的依赖。如果使用Maven，可以在<code>pom.xml</code>中添加以下依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mchange<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>c3p0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.5.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-2">步骤二：配置Hibernate连接池</h4>
<p>在<code>hibernate.cfg.xml</code>配置文件中配置C3P0连接池的相关属性：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- C3P0 连接池配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.min_size"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.max_size"</span>&gt;</span>20<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.timeout"</span>&gt;</span>300<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.max_statements"</span>&gt;</span>50<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.idle_test_period"</span>&gt;</span>3000<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.acquire_increment"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">连接池属性解释</h4>
<ul>
<li><code>hibernate.c3p0.min_size</code>：连接池中保持的最小连接数。</li>
<li><code>hibernate.c3p0.max_size</code>：连接池中允许的最大连接数。</li>
<li><code>hibernate.c3p0.timeout</code>：连接在被丢弃之前可以闲置的最长时间（秒）。</li>
<li><code>hibernate.c3p0.max_statements</code>：连接池所提供的JDBC预处理语句缓存的大小。</li>
<li><code>hibernate.c3p0.idle_test_period</code>：每隔多少秒检查所有连接池中的空闲连接。</li>
<li><code>hibernate.c3p0.acquire_increment</code>：当连接池中的连接耗尽时，一次性创建的连接数。</li>
</ul>
<h4 data-id="heading-4">步骤三：实用类HibernateUtil</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<h4 data-id="heading-5">步骤四：测试连接池优化</h4>
<p>编写一个简单的测试类来验证连接池的配置和性能。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateConnectionPoolTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 测试连接池</span>
        testConnectionPool(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testConnectionPool</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++) {
            <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
            <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 执行查询或其他数据库操作</span>
                System.out.println(<span class="hljs-string">"Session "</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">" is opened"</span>);

                <span class="hljs-comment">// 提交事务</span>
                transaction.commit();
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                    transaction.rollback();
                }
                e.printStackTrace();
            } <span class="hljs-keyword">finally</span> {
                session.close();
                System.out.println(<span class="hljs-string">"Session "</span> + (i + <span class="hljs-number">1</span>) + <span class="hljs-string">" is closed"</span>);
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-6">详细解释</h3>
<ol>
<li>
<p><strong>引入C3P0依赖</strong>：</p>
<ul>
<li>在项目的<code>pom.xml</code>文件中添加C3P0的依赖，以便在项目中使用C3P0连接池。</li>
</ul>
</li>
<li>
<p><strong>配置Hibernate连接池</strong>：</p>
<ul>
<li>在<code>hibernate.cfg.xml</code>中添加C3P0连接池的配置属性，包括最小连接数、最大连接数、超时时间、最大语句数、空闲测试周期和获取增量等参数。</li>
<li>这些配置参数可以根据应用程序的需求进行调整，以优化数据库连接池的性能。</li>
</ul>
</li>
<li>
<p><strong>实用类HibernateUtil</strong>：</p>
<ul>
<li><code>HibernateUtil</code>类提供了一个静态方法来获取<code>SessionFactory</code>实例，并在静态块中初始化<code>SessionFactory</code>。</li>
</ul>
</li>
<li>
<p><strong>测试连接池优化</strong>：</p>
<ul>
<li><code>HibernateConnectionPoolTest</code>类通过循环打开和关闭多个<code>Session</code>来测试连接池的配置和性能。</li>
<li>打印每个<code>Session</code>的打开和关闭操作，验证C3P0连接池是否正常工作。</li>
</ul>
</li>
</ol>
<p>通过这种方式，可以有效地配置和优化Hibernate的连接池，从而提高应用程序的性能和响应速度。使用连接池可以减少创建和销毁数据库连接的开销，提高数据库访问的效率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（46） Hibernate的配置文件如何加载？]]></title>    <link>https://juejin.cn/post/7595801647247327251</link>    <guid>https://juejin.cn/post/7595801647247327251</guid>    <pubDate>2026-01-16T11:55:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595801647247327251" data-draft-id="7595552420048338987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（46） Hibernate的配置文件如何加载？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T11:55:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（46） Hibernate的配置文件如何加载？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T11:55:28.000Z" title="Fri Jan 16 2026 11:55:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Hibernate中，配置文件通常用于定义数据库连接信息、Hibernate属性和实体类映射等。常见的配置文件包括<code>hibernate.cfg.xml</code>和<code>hibernate.properties</code>。本文将详细介绍如何加载Hibernate的配置文件，并结合代码示例说明。</p>
<h3 data-id="heading-0">加载Hibernate配置文件</h3>
<h4 data-id="heading-1">1. 使用<code>hibernate.cfg.xml</code>加载配置</h4>
<p><code>hibernate.cfg.xml</code>是最常用的Hibernate配置文件。通常放置在类路径的根目录下。</p>
<h5 data-id="heading-2">示例配置文件 <code>hibernate.cfg.xml</code></h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Category"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h5 data-id="heading-3">加载<code>hibernate.cfg.xml</code>的示例代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用Configuration类加载hibernate.cfg.xml配置文件</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<p>在上面的代码中，<code>new Configuration().configure("hibernate.cfg.xml")</code>会自动查找类路径下的<code>hibernate.cfg.xml</code>文件，并加载其中的配置信息。然后使用这些配置信息构建<code>SessionFactory</code>实例。</p>
<h4 data-id="heading-4">2. 使用<code>hibernate.properties</code>加载配置</h4>
<p>除了<code>hibernate.cfg.xml</code>，Hibernate还支持通过<code>hibernate.properties</code>文件加载配置信息。</p>
<h5 data-id="heading-5">示例配置文件 <code>hibernate.properties</code></h5>
<pre><code class="hljs language-properties" lang="properties">hibernate.connection.driver_class=com.mysql.cj.jdbc.Driver
hibernate.connection.url=jdbc:mysql://localhost:3306/your_database
hibernate.connection.username=your_username
hibernate.connection.password=your_password
hibernate.dialect=org.hibernate.dialect.MySQLDialect
hibernate.show_sql=true
hibernate.format_sql=true
hibernate.hbm2ddl.auto=update
</code></pre>
<h5 data-id="heading-6">加载<code>hibernate.properties</code>的示例代码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用Configuration类加载hibernate.properties配置文件</span>
            <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>();
            configuration.configure(); <span class="hljs-comment">// 默认会加载类路径下的hibernate.cfg.xml或hibernate.properties</span>
            sessionFactory = configuration.buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}
</code></pre>
<p>在上面的代码中，<code>configuration.configure()</code>默认会加载类路径下的<code>hibernate.cfg.xml</code>或<code>hibernate.properties</code>文件，可以根据具体需求调整。</p>
<h3 data-id="heading-7">配置文件加载的深入解释</h3>
<ol>
<li>
<p><strong>Configuration类</strong>：</p>
<ul>
<li><code>org.hibernate.cfg.Configuration</code>类是Hibernate用来配置的核心类。它可以从XML文件或Java属性文件加载配置。</li>
<li><code>configure()</code>方法默认查找类路径根目录下的<code>hibernate.cfg.xml</code>文件。如果提供文件名参数，<code>configure("hibernate.properties")</code>则会加载指定文件。</li>
</ul>
</li>
<li>
<p><strong>SessionFactory</strong>：</p>
<ul>
<li><code>SessionFactory</code>是Hibernate框架中的关键对象，负责创建<code>Session</code>对象。<code>Session</code>对象是单线程的短期对象，用于执行CRUD操作。</li>
<li><code>SessionFactory</code>是线程安全的，可以在应用程序中全局共享，通常在应用启动时创建一次，并在整个应用生命周期中使用。</li>
</ul>
</li>
<li>
<p><strong>异常处理</strong>：</p>
<ul>
<li>在静态块中初始化<code>SessionFactory</code>，并捕获任何可能的异常。如果初始化失败，会抛出<code>ExceptionInInitializerError</code>，确保应用及时发现配置问题。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">综合示例</h3>
<p>以下是一个完整的示例，展示如何配置并加载Hibernate配置文件，创建<code>SessionFactory</code>并执行一些基本操作。</p>
<h5 data-id="heading-9">完整示例</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-comment">// HibernateUtil类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}

<span class="hljs-comment">// Category类</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "category")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Category</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@OneToMany(mappedBy = "category", fetch = FetchType.LAZY, cascade = CascadeType.ALL)</span>
    <span class="hljs-keyword">private</span> Set&lt;Product&gt; products = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

    <span class="hljs-comment">// Getters 和 Setters</span>
}

<span class="hljs-comment">// Product类</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-meta">@ManyToOne</span>
    <span class="hljs-meta">@JoinColumn(name = "category_id")</span>
    <span class="hljs-keyword">private</span> Category category;

    <span class="hljs-comment">// Getters 和 Setters</span>
}

<span class="hljs-comment">// Hibernate测试类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 获取SessionFactory</span>
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();

        <span class="hljs-comment">// 插入示例数据</span>
        insertSampleData(sessionFactory);

        <span class="hljs-comment">// 关闭SessionFactory</span>
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertSampleData</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Category</span> <span class="hljs-variable">category</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Category</span>();
            category.setName(<span class="hljs-string">"Electronics"</span>);

            <span class="hljs-type">Product</span> <span class="hljs-variable">product1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product1.setName(<span class="hljs-string">"Laptop"</span>);
            product1.setPrice(<span class="hljs-number">1000.0</span>);

            <span class="hljs-type">Product</span> <span class="hljs-variable">product2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product2.setName(<span class="hljs-string">"Smartphone"</span>);
            product2.setPrice(<span class="hljs-number">500.0</span>);

            category.addProduct(product1);
            category.addProduct(product2);

            session.save(category);

            transaction.commit();
            System.out.println(<span class="hljs-string">"Inserted sample data"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<p>在这个综合示例中，<code>HibernateUtil</code>类负责加载配置文件并创建<code>SessionFactory</code>，<code>Category</code>和<code>Product</code>类定义了实体，<code>HibernateTest</code>类则演示了如何使用Hibernate进行数据操作。通过这种方式，可以有效地加载和使用Hibernate的配置文件进行数据库操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Arthas 实战：线上 BUG 不重启？热更新救场指南]]></title>    <link>https://juejin.cn/post/7595837635569287220</link>    <guid>https://juejin.cn/post/7595837635569287220</guid>    <pubDate>2026-01-16T09:13:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595837635569287220" data-draft-id="7595755710733221903" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Arthas 实战：线上 BUG 不重启？热更新救场指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T09:13:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Arthas 实战：线上 BUG 不重启？热更新救场指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:13:27.000Z" title="Fri Jan 16 2026 09:13:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、线上应急的“生死时速”</h2>
<p>小张的团队刚完成代码上线，用户却反馈核心功能出现小 bug——订单状态同步异常，直接影响了客户体验。更棘手的是：<strong>重新打包、测试、发布全流程需要 1 小时以上</strong>，但用户迫切需要正常使用系统，“停机发版”意味着资损风险和口碑下滑。</p>
<p>此时， <strong>“不停机修复线上问题”</strong> ​ 成为唯一选择。而阿里开源的 Java 诊断利器 <strong>Arthas</strong>，正是解决这类场景的“救命稻草”。</p>
<h2 data-id="heading-1">二、Arthas 热更新的破局逻辑</h2>
<p>传统发版流程（编译→打包→部署→灰度）的本质是<strong>重启 JVM 加载新类</strong>，但线上业务对“停机零容忍”，必须寻找 <strong>“无侵入式热更新”</strong> ​ 方案。</p>
<p>Arthas 基于 <strong>Java Agent + 字节码增强</strong>​ 技术，通过 <code>Instrumentation</code>API 实现<strong>运行时替换类字节码</strong>，无需重启 JVM 即可让新逻辑生效。其核心是 <strong><code>retransformClasses</code>方法</strong>（允许类加载后重新转换字节码），配合反编译、编译命令，完成“诊断→修改→热加载”闭环。</p>
<h2 data-id="heading-2">三、四步实操：从反编译到热部署</h2>
<h3 data-id="heading-3">步骤 1：部署 &amp; 启动 Arthas</h3>
<p>登录<strong>存在 BUG 的服务器</strong>，通过以下命令快速部署 Arthas：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载 Arthas 引导包（国内镜像加速）</span>
curl -O https://arthas.aliyun.com/arthas-boot.jar  

<span class="hljs-comment"># 启动 Arthas 并选择目标 Java 进程  </span>
java -jar arthas-boot.jar
</code></pre>
<p>执行 <code>arthas-boot.jar</code>后，终端会列出当前服务器所有 Java 进程（含端口、启动参数）。根据业务标识（如端口、Spring Boot 应用名）选择<strong>目标进程编号</strong>，回车进入 Arthas 交互终端。</p>
<h3 data-id="heading-4">步骤 2：反编译目标类（提取源码）</h3>
<p>假设业务 BUG 出现在 <code>com.example.demo.service.OrderService</code>类的方法中，需先反编译获取源码：</p>
<pre><code class="hljs language-javascript" lang="javascript">jad --source-only com.<span class="hljs-property">example</span>.<span class="hljs-property">demo</span>.<span class="hljs-property">service</span>.<span class="hljs-property">OrderService</span> &gt; <span class="hljs-regexp">/tmp/</span><span class="hljs-title class_">OrderService</span>.<span class="hljs-property">java</span>
</code></pre>
<ul>
<li><code>jad</code>：Arthas 反编译命令，<code>--source-only</code>表示<strong>仅输出 Java 源码</strong>（省略字节码细节）。</li>
<li>输出路径 <code>/tmp/OrderService.java</code>需确保有写权限，后续用编辑器修改。</li>
</ul>
<blockquote>
<p>执行后会看到 Arthas 输出类加载器信息（如 <code>ClassLoader: 123456789</code>），这是后续编译的关键参数！</p>
</blockquote>
<h3 data-id="heading-5">步骤 3：修改源码 &amp; 编译（生成新 Class）</h3>
<p>用 <code>vim</code>或 IDE 打开 <code>/tmp/OrderService.java</code>，修复 BUG（如修正订单状态判断逻辑）。修改后，通过 <code>mc</code>命令编译源码：</p>
<pre><code class="hljs language-bash" lang="bash">mc -c 123456789 /tmp/OrderService.java -d /tmp/classes
</code></pre>
<ul>
<li><code>mc</code>：Arthas 编译命令，基于 JDK <code>JavaCompiler</code>API 实现<strong>内存编译</strong>。</li>
<li><code>-c 123456789</code>：指定<strong>类加载器的 hashcode</strong>（步骤 2 中 <code>jad</code>输出的 <code>ClassLoader</code>值），确保编译后的类能被目标类加载器识别。</li>
<li><code>-d /tmp/classes</code>：指定输出 <code>.class</code>文件的目录（需提前创建）。</li>
</ul>
<h3 data-id="heading-6">步骤 4：热加载新 Class（生效新逻辑）</h3>
<p>编译生成新 <code>.class</code>文件后，通过 <code>retransform</code>命令加载新字节码：</p>
<pre><code class="hljs language-arduino" lang="arduino">retransform /tmp/classes/com/example/demo/service/OrderService.<span class="hljs-keyword">class</span>
</code></pre>
<ul>
<li><code>retransform</code>：触发 JVM <code>retransformClasses</code>方法，<strong>替换已加载类的字节码</strong>。后续业务请求将自动使用新逻辑。</li>
</ul>
<h2 data-id="heading-7">四、原理深挖：Arthas 如何“无侵入”热更新？</h2>
<p>Java 的 <code>Instrumentation</code>API 是热更新的技术基石，但原生 API 存在限制：</p>
<ul>
<li><code>redefineClasses</code>：可替换类字节码，但<strong>要求新旧类结构完全一致</strong>（不能增删字段/方法）。</li>
<li><code>retransformClasses</code>：允许类加载后重新转换字节码，<strong>对结构修改兼容性更强</strong>（Arthas 热更新的核心）。</li>
</ul>
<p>Arthas 通过 <strong>Attach 机制</strong>​ 注入 Java Agent 到目标 JVM，利用 <code>retransformClasses</code>实现类字节码替换，全程无需重启进程，真正做到“业务零感知”。</p>
<h2 data-id="heading-8">五、避坑指南：热更新的边界与最佳实践</h2>
<p>热更新是<strong>应急手段</strong>，需警惕以下风险：</p>
<ol>
<li>
<p><strong>类加载器隔离</strong>​</p>
<p>若应用是多模块（如 Tomcat 多 Webapp），不同模块由独立类加载器加载。需确保 <code>mc</code>命令的 <code>-c</code>参数与 <code>jad</code>输出的类加载器 hashcode 一致，否则新 Class 无法被正确加载。</p>
</li>
<li>
<p><strong>修改范围限制</strong>​</p>
<p>热更新<strong>仅支持修改方法体内逻辑</strong>，禁止增删字段、方法，或修改类继承关系（否则触发 JVM 结构冲突，<code>retransform</code>失败）。</p>
</li>
<li>
<p><strong>备份与回滚</strong>​</p>
<p>热更新前用 <code>jad</code>保存原 <code>.java</code>文件，出现问题时可通过 <code>retransform</code>加载原 Class 回滚。</p>
</li>
<li>
<p><strong>生产环境克制使用</strong>​</p>
<p>热更新是“救火工具”，事后需补发正式版本。长期依赖热更新会导致代码版本混乱，增加维护成本。</p>
</li>
</ol>
<h2 data-id="heading-9">六、总结：Arthas 不止于热更新</h2>
<p>Arthas 是<strong>Java 在线诊断的全能选手</strong>：不仅能热更新救火，还能通过 <code>trace</code>（链路追踪）、<code>watch</code>（方法观测）、<code>stack</code>（线程栈分析）排查性能瓶颈、死锁等问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java static 静态变量 / 静态方法 超详细讲解（底层原理 + 内存分配 + 使用场景)]]></title>    <link>https://juejin.cn/post/7595683968683753518</link>    <guid>https://juejin.cn/post/7595683968683753518</guid>    <pubDate>2026-01-16T09:02:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595683968683753518" data-draft-id="7595683968683720750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java static 静态变量 / 静态方法 超详细讲解（底层原理 + 内存分配 + 使用场景)"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-16T09:02:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="定仙游453"/> <meta itemprop="url" content="https://juejin.cn/user/3968578224130505"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java static 静态变量 / 静态方法 超详细讲解（底层原理 + 内存分配 + 使用场景)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3968578224130505/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    定仙游453
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:02:11.000Z" title="Fri Jan 16 2026 09:02:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、先抛出核心问题：为什么需要 <code>static</code> 关键字？</h2>
<p>我们先看 <strong>汽车司机类 <code>CarDriver</code></strong> 的例子：</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CarDriver</span> {
    <span class="hljs-comment">// 成员变量：每个司机对象 独有 的属性</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name; <span class="hljs-comment">// 每个司机姓名不同</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;     <span class="hljs-comment">// 每个司机年龄不同</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> license; <span class="hljs-comment">// 每个司机驾照号不同</span>
    
    <span class="hljs-comment">// 思考：所有司机都有一个共同的属性 → 职业名称都是「司机」，这个属性值 所有对象都一样</span>
    <span class="hljs-comment">// 如果写成成员变量：private String job = "司机";</span>
    <span class="hljs-comment">// 问题：创建100个司机对象，堆内存中就会存100个"司机"字符串，完全重复，极度浪费内存！</span>
}
</code></pre>
<p>👉 <strong>核心痛点</strong>：当一个属性 / 方法，是<strong>属于【类本身】的、所有对象共享的、值完全相同的</strong>，如果定义成普通的成员变量 / 方法，会在每个对象中都存一份，<strong>造成巨大的内存浪费</strong>。</p>
<p>而 <code>static</code> 关键字就是为了解决这个问题而生的：</p>
<blockquote>
<p><strong>static 的核心作用</strong>：把「成员变量 / 方法」从【对象级】提升为【类级】，成为<strong>类的共有资源</strong>，所有对象共享同一份数据，内存中<strong>只存一份</strong>，极大节省内存。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、核心铺垫：复习 Java 的三大核心内存区域（<code>static</code>专属内存必看）</h2>
<p>理解<code>static</code>的内存分配，只需要牢记这三块内存，<strong>和上一篇字符串的内存完全一致，只是补充了 static 的专属区域</strong>，先复习巩固，重中之重：</p>
<h3 data-id="heading-2">✅ 1. 堆内存（Heap）</h3>
<ul>
<li>存储内容：<strong>所有通过<code>new</code>关键字创建的【对象本身】</strong> （比如<code>new CarDriver()</code>、<code>new MyMath()</code>、<code>new StringBuilder()</code>）、对象的<strong>成员变量</strong>（非 static 的变量，比如 name、age）；</li>
<li>核心特点：<strong>一个对象一份内存</strong>，不同对象的成员变量相互独立，互不影响。</li>
</ul>
<h3 data-id="heading-3">✅ 2. 方法区（Method Area，JDK8 叫【元空间】）【<code>static</code>的专属内存，核心核心】</h3>
<ul>
<li>存储内容：① 类的<strong>字节码信息</strong>（类的结构、方法定义、变量定义，只要类被加载，就会存到这里）；② <strong>所有被 static 修饰的内容</strong> → 静态变量、静态方法、静态代码块；③ 字符串常量池（上一篇学的，String 的字面量）；</li>
<li>核心特点：① JVM 启动时就加载，<strong>内存中永远只有一份</strong>，不会随对象的创建而创建，也不会随对象的销毁而销毁；② 只要类存在，static 的内容就存在，<strong>所有对象共享同一份 static 数据</strong>；③ 生命周期：<strong>和类的生命周期一致</strong>（类加载时初始化，程序结束时销毁）。</li>
</ul>
<h3 data-id="heading-4">✅ 3. 栈内存（Stack）</h3>
<ul>
<li>存储内容：方法的局部变量、方法的调用栈、对象的引用（变量名）；</li>
<li>核心特点：方法执行完，栈中的内容就会被销毁，速度最快。</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、<code>static</code> 静态变量 核心讲解（重点中的重点）</h2>
<h3 data-id="heading-6">✅ 1. 什么是静态变量？定义格式</h3>
<h4 data-id="heading-7">✔ 概念</h4>
<p>被 <code>static</code> 关键字修饰的<strong>成员变量</strong>，称为「静态变量」，也叫「类变量」。与之对应的是：<strong>非 static 的成员变量</strong> → 叫「实例变量 / 对象变量」（你之前写的 name、age 都是）。</p>
<h4 data-id="heading-8">✔ 定义格式（写在类中，方法外）</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> 类名 {
    <span class="hljs-comment">// 1. 静态变量：加static修饰，推荐加访问修饰符</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> 数据类型 变量名 = 初始值;
    
    <span class="hljs-comment">// 2. 实例变量：不加static，你的代码里全是这种</span>
    <span class="hljs-keyword">public</span> 数据类型 变量名 = 初始值;
}
</code></pre>
<h4 data-id="heading-9">✔ 你的代码改造示例（CarDriver 类，最贴合你的场景）</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CarDriver</span> {
    <span class="hljs-comment">// ✅ 实例变量：每个对象 独有，堆内存中每个对象存一份</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> license;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> carNum;
    
    <span class="hljs-comment">// ✅ 静态变量：所有司机对象 共享，方法区中只存一份，值完全相同</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> job = <span class="hljs-string">"汽车司机"</span>; <span class="hljs-comment">// 所有司机的职业都是这个，不用每个对象存一份</span>
    
    <span class="hljs-comment">// get/set方法、toString方法省略</span>
}
</code></pre>
<h3 data-id="heading-10">✅ 2. 静态变量的【内存分配规则】（核心！必背！内存图 + 文字详解）</h3>
<p>这是<code>static</code>最核心的知识点，也是面试必考的内容，我们用上面的<code>CarDriver</code>类举例子，执行如下代码，看内存分配的完整过程：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-comment">// 创建第一个司机对象</span>
    <span class="hljs-type">CarDriver</span> <span class="hljs-variable">driver1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CarDriver</span>();
    driver1.setName(<span class="hljs-string">"张三"</span>);
    driver1.setAge(<span class="hljs-number">30</span>);
    
    <span class="hljs-comment">// 创建第二个司机对象</span>
    <span class="hljs-type">CarDriver</span> <span class="hljs-variable">driver2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CarDriver</span>();
    driver2.setName(<span class="hljs-string">"李四"</span>);
    driver2.setAge(<span class="hljs-number">28</span>);
}
</code></pre>
<h4 data-id="heading-11">✔ 完整内存分配步骤（按执行顺序，一步步看，看懂这个 = 懂了 static 内存）</h4>
<h5 data-id="heading-12">步骤 1：类加载 → 方法区中初始化 <code>static静态变量</code></h5>
<p>当 JVM 执行到<code>CarDriver</code>类时，会先把类的字节码加载到<strong>方法区</strong>，同时：</p>
<ul>
<li>在方法区中，为静态变量 <code>job</code> 分配内存，赋值为 <code>"汽车司机"</code>；</li>
<li>✅ 关键：<strong>此时还没有创建任何对象，静态变量就已经存在了，内存中只存一份</strong>。</li>
</ul>
<h5 data-id="heading-13">步骤 2：创建对象 → 堆内存中初始化 <code>实例变量</code></h5>
<p>执行<code>new CarDriver()</code>时，JVM 在<strong>堆内存</strong>中创建一个司机对象：</p>
<ul>
<li>为实例变量 <code>name、age、license、carNum</code> 分配内存（默认值：String=null，int=0）；</li>
<li>通过 set 方法赋值后，堆中对象的成员变量有了具体值；</li>
<li>✅ 关键：<strong>堆中的对象，不会存储静态变量！静态变量只在方法区存一份</strong>。</li>
</ul>
<h5 data-id="heading-14">步骤 3：创建第二个对象 → 堆内存新增对象，静态变量依然只有一份</h5>
<p>执行第二个<code>new CarDriver()</code>时：</p>
<ul>
<li>堆内存中<strong>新增一个独立的对象</strong>，有自己的 name、age 等实例变量；</li>
<li>方法区中的静态变量<code>job</code>，<strong>没有任何变化，还是原来的那一份</strong>；</li>
</ul>
<h4 data-id="heading-15">✔ 核心内存结论（一句话总结，刻进脑子里）</h4>
<blockquote>
<p>**静态变量 → 存在【方法区】，内存中永远只存一份，属于类本身，所有对象共享；**<strong>实例变量 → 存在【堆内存】，每个对象存一份，属于对象本身，对象之间互不影响。</strong></p>
</blockquote>
<h4 data-id="heading-16">✔ 直观内存图（文字版，好理解）</h4>
<p>plaintext</p>
<pre><code class="hljs language-ini" lang="ini">【栈内存】：
  driver1 → 指向 堆内存的对象1
  driver2 → 指向 堆内存的对象2

【堆内存】：
  对象1：<span class="hljs-attr">name</span>=张三, age=<span class="hljs-number">30</span>, license=null, carNum=null （无静态变量）
  对象2：<span class="hljs-attr">name</span>=李四, age=<span class="hljs-number">28</span>, license=null, carNum=null （无静态变量）

【方法区】：
  CarDriver类的字节码信息
  静态变量：<span class="hljs-attr">job</span> = <span class="hljs-string">"汽车司机"</span>  → 所有对象共享这一份！
</code></pre>
<hr/>
<h2 data-id="heading-17">四、静态变量 vs 实例变量 核心区别（必背！必考！最全对比表）</h2>
<p>这是<code>static</code>的<strong>核心考点</strong>，也是你写代码时判断是否用 static 的唯一依据，<strong>所有区别都源于内存分配的不同</strong>，整理成你最容易记的对比表，优先级⭐越多越重要：</p>























































<table><thead><tr><th>对比维度</th><th>静态变量（类变量）<code>static</code></th><th>实例变量（对象变量）无 static</th></tr></thead><tbody><tr><td><strong>所属者</strong></td><td>✅ 属于【类本身】</td><td>✅ 属于【对象本身】</td></tr><tr><td><strong>内存位置</strong></td><td>✅ 方法区（元空间）</td><td>✅ 堆内存</td></tr><tr><td><strong>内存份数</strong></td><td>✅ 内存中<strong>永远只存 1 份</strong></td><td>✅ 每个对象存<strong>1 份</strong>，创建 n 个对象存 n 份</td></tr><tr><td><strong>初始化时机</strong></td><td>✅ 类加载时就初始化（早）</td><td>✅ 创建对象时才初始化（晚）</td></tr><tr><td><strong>生命周期</strong></td><td>✅ 和类的生命周期一致（程序结束销毁）</td><td>✅ 和对象的生命周期一致（对象被 GC 回收就销毁）</td></tr><tr><td><strong>调用方式</strong></td><td>✅ 两种方式：① 类名。静态变量 （推荐，规范）② 对象名。静态变量 （语法允许，不推荐）</td><td>✅ 只有 1 种方式：对象名。实例变量 （必须创建对象才能调用）</td></tr><tr><td><strong>核心特点</strong></td><td>✅ 所有对象<strong>共享同一份数据</strong>，一处修改，处处生效</td><td>✅ 每个对象<strong>独有数据</strong>，修改一个对象的变量，其他对象不受影响</td></tr><tr><td><strong>使用场景</strong></td><td>✅ 所有对象<strong>共用不变的值</strong>（比如职业、常量）✅ 统计对象的个数（比如统计创建了多少个司机）</td><td>✅ 每个对象<strong>独有的属性</strong>（比如姓名、年龄、驾照号）</td></tr><tr><td><strong>优先级⭐</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>
<h3 data-id="heading-18">✅ 调用方式代码示例（你的 CarDriver 类）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
    <span class="hljs-comment">// ===== 1. 静态变量的调用：推荐用【类名.变量名】，无需创建对象！</span>
    System.<span class="hljs-keyword">out</span>.println(CarDriver.job); <span class="hljs-comment">// 输出：汽车司机 ✔️ 推荐写法</span>
    
    <span class="hljs-comment">// 静态变量也可以用对象调用（语法允许，但不推荐，可读性差）</span>
    CarDriver driver = <span class="hljs-keyword">new</span> CarDriver();
    System.<span class="hljs-keyword">out</span>.println(driver.job); <span class="hljs-comment">// 输出：汽车司机 ✔️ 不推荐</span>
    
    <span class="hljs-comment">// ===== 2. 实例变量的调用：必须创建对象，用对象调用</span>
    System.<span class="hljs-keyword">out</span>.println(driver.getName()); <span class="hljs-comment">// 输出：张三 ✔️ 唯一写法</span>
    <span class="hljs-comment">// System.out.println(CarDriver.name); // 报错 ❌ 类名不能调用实例变量</span>
    
    <span class="hljs-comment">// ===== 3. 静态变量的核心特性：一处修改，处处生效</span>
    CarDriver.job = <span class="hljs-string">"职业司机"</span>; <span class="hljs-comment">// 修改类的静态变量</span>
    System.<span class="hljs-keyword">out</span>.println(CarDriver.job); <span class="hljs-comment">// 输出：职业司机</span>
    System.<span class="hljs-keyword">out</span>.println(driver.job);    <span class="hljs-comment">// 输出：职业司机 → 所有对象都看到修改后的值</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-19">五、<code>static</code> 静态方法 核心讲解（你写的 MyMath 类完美适配）</h2>
<p>讲完静态变量，必须讲静态方法，这是你<strong>作业中最常用的 static 场景</strong>（比如你写的<code>MyMath</code>类中的<code>add()</code>、<code>compare()</code>方法，就应该用 static 修饰），两者是配套使用的。</p>
<h3 data-id="heading-20">✅ 1. 什么是静态方法？定义格式</h3>
<p>被 <code>static</code> 关键字修饰的<strong>成员方法</strong>，称为「静态方法」，也叫「类方法」。</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> 类名 {
    <span class="hljs-comment">// 静态方法：加static修饰</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> 返回值类型 方法名(参数列表) {
        方法体;
    }
    
    <span class="hljs-comment">// 实例方法：不加static（你之前写的所有方法都是）</span>
    <span class="hljs-keyword">public</span> 返回值类型 方法名(参数列表) {
        方法体;
    }
}
</code></pre>
<h3 data-id="heading-21">✅ 2. 静态方法的核心特点（和静态变量一脉相承）</h3>
<h4 data-id="heading-22">✔ 核心特性①：静态方法属于【类本身】，存在方法区，内存中只存一份</h4>
<h4 data-id="heading-23">✔ 核心特性②：调用方式（和静态变量完全一样）</h4>
<ul>
<li>推荐：<code>类名.静态方法名(参数)</code> → 无需创建对象，直接调用（最方便！）</li>
<li>不推荐：<code>对象名.静态方法名(参数)</code> → 语法允许，可读性差</li>
</ul>
<h4 data-id="heading-24">✔ 你的代码改造：MyMath 类（最经典的静态方法场景，必改！）</h4>
<p>你之前写的<code>MyMath</code>类，是做「通用的数学计算」，不需要创建对象，所有方法都应该用<code>static</code>修饰，这样调用时<strong>不用 new 对象</strong>，代码简洁到极致！</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino">package com.shehuiuniversity;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMath</span> {
    <span class="hljs-comment">// ✅ 静态方法：加法计算，通用工具方法，无需创建对象</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(a + <span class="hljs-string">" + "</span> + b + <span class="hljs-string">" = "</span> + (a+b));
    }
    
    <span class="hljs-comment">// ✅ 静态方法：找三个数的最大值，通用工具方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">compare</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b, <span class="hljs-type">double</span> c)</span> </span>{
        <span class="hljs-type">double</span>[] arr = {a,b,c};
        <span class="hljs-type">double</span> max = arr[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">for</span> (<span class="hljs-type">double</span> num : arr) {
            <span class="hljs-keyword">if</span>(num &gt; max) max = num;
        }
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"最大值为："</span> + max);
    }
}
</code></pre>
<h4 data-id="heading-25">✔ 测试类调用（对比你之前的写法，简化太多！）</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">Testclass</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">shehuiuniversity</span>.<span class="hljs-property">MyMath</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MathTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// 之前的写法：需要new对象，再调用</span>
        <span class="hljs-comment">// MyMath math = new MyMath();</span>
        <span class="hljs-comment">// math.add(10,20);</span>
        <span class="hljs-comment">// math.compare(0.1,0.5,0.3);</span>
        
        <span class="hljs-comment">// ✅ 静态方法的写法：直接类名调用，无需new对象，超级简洁！</span>
        <span class="hljs-title class_">MyMath</span>.<span class="hljs-title function_">add</span>(<span class="hljs-number">10</span>,<span class="hljs-number">20</span>); <span class="hljs-comment">// 输出：10+20=30</span>
        <span class="hljs-title class_">MyMath</span>.<span class="hljs-title function_">compare</span>(<span class="hljs-number">0.1</span>,<span class="hljs-number">0.5</span>,<span class="hljs-number">0.3</span>); <span class="hljs-comment">// 输出：最大值为0.5</span>
    }
}
</code></pre>
<p>👉 <strong>为什么 MyMath 类要用静态方法？<strong>因为<code>add()</code>和<code>compare()</code>是</strong>通用的工具方法</strong>，不依赖任何对象的属性，只是做计算，这种方法用 static 修饰，调用时不需要创建对象，是 Java 开发的标准写法（比如 Java 内置的<code>Math.random()</code>、<code>Math.max()</code>都是静态方法）。</p>
<h3 data-id="heading-26">✅ 3. 静态方法的【核心规则：能做什么，不能做什么】（高频坑点！必背！）</h3>
<p>这是<code>static</code>最容易出错的考点，也是新手写代码最容易报错的地方，<strong>所有规则的根源：静态方法加载时，对象还没创建！</strong></p>
<h4 data-id="heading-27">✔ ✅ 静态方法中 可以直接调用的内容：</h4>
<ol>
<li>静态变量（因为静态变量和静态方法一起加载到方法区）；</li>
<li>其他静态方法（同理）；</li>
</ol>
<h4 data-id="heading-28">✔ ❌ 静态方法中 绝对不能直接调用的内容（编译报错！）：</h4>
<ol>
<li><strong>实例变量</strong>（非 static 的变量）→ 因为实例变量属于对象，静态方法加载时，对象还没创建，内存中没有实例变量；</li>
<li><strong>实例方法</strong>（非 static 的方法）→ 因为实例方法依赖对象，静态方法加载时，对象还没创建；</li>
</ol>
<h4 data-id="heading-29">✔ 补充规则：</h4>
<p>静态方法中<strong>可以间接调用</strong>实例变量 / 方法 → 必须<strong>手动创建对象</strong>，通过对象调用即可。</p>
<h4 data-id="heading-30">✔ 规则代码示例（一目了然）</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestStatic</span> {
    <span class="hljs-comment">// 静态变量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String strStatic = <span class="hljs-string">"静态变量"</span>;
    <span class="hljs-comment">// 实例变量</span>
    <span class="hljs-keyword">public</span> String strInstance = <span class="hljs-string">"实例变量"</span>;
    
    <span class="hljs-comment">// 静态方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">staticMethod</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(strStatic); <span class="hljs-comment">// ✅ 静态方法调用静态变量：允许</span>
        staticMethod2(); <span class="hljs-comment">// ✅ 静态方法调用静态方法：允许</span>
        
        <span class="hljs-comment">// System.out.println(strInstance); // ❌ 静态方法调用实例变量：报错！</span>
        <span class="hljs-comment">// instanceMethod(); // ❌ 静态方法调用实例方法：报错！</span>
        
        <span class="hljs-comment">// ✅ 间接调用实例变量/方法：创建对象后调用</span>
        TestStatic ts = <span class="hljs-keyword">new</span> TestStatic();
        System.<span class="hljs-keyword">out</span>.println(ts.strInstance); <span class="hljs-comment">// 允许</span>
        ts.instanceMethod(); <span class="hljs-comment">// 允许</span>
    }
    
    <span class="hljs-comment">// 静态方法2</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">staticMethod2</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"静态方法2"</span>);
    }
    
    <span class="hljs-comment">// 实例方法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">instanceMethod</span>()</span> {
        <span class="hljs-comment">// ✅ 实例方法可以调用任何内容：静态的+实例的（无任何限制）</span>
        System.<span class="hljs-keyword">out</span>.println(strStatic);
        System.<span class="hljs-keyword">out</span>.println(strInstance);
        staticMethod();
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-31">六、<code>static</code> 静态代码块 核心讲解（补充知识点，作业 / 面试常用）</h2>
<p>除了静态变量、静态方法，还有一个<code>static</code>的常用语法：<strong>静态代码块</strong>，也是面试高频考点，顺带讲完，内容完整。</p>
<h3 data-id="heading-32">✅ 1. 定义格式</h3>
<p>写在类中，方法外，被<code>static</code>修饰的代码块，没有方法名，没有参数，没有返回值：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> 类名 {
    <span class="hljs-comment">// 静态代码块</span>
    <span class="hljs-type">static</span> {
        代码体; <span class="hljs-comment">// 初始化静态变量、执行类的初始化逻辑</span>
    }
}
</code></pre>
<h3 data-id="heading-33">✅ 2. 核心特点</h3>
<ol>
<li>执行时机：<strong>类加载时自动执行，且只执行一次</strong>（不管创建多少个对象，静态代码块只执行一次）；</li>
<li>执行顺序：静态代码块 → 构造方法（静态代码块更早）；</li>
<li>作用：专门用于<strong>初始化静态变量</strong>，或者执行一些需要在类加载时就完成的初始化逻辑；</li>
</ol>
<h3 data-id="heading-34">✅ 3. 代码示例（你的 CarDriver 类适配）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">CarDriver</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String job;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> age;
    
    <span class="hljs-comment">// 静态代码块：初始化静态变量，类加载时执行，只执行一次</span>
    <span class="hljs-keyword">static</span> {
        job = <span class="hljs-string">"汽车司机"</span>;
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"静态代码块执行了 → 初始化职业为司机"</span>);
    }
    
    <span class="hljs-comment">// 构造方法：创建对象时执行，创建一次执行一次</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">CarDriver</span>()</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"构造方法执行了 → 创建司机对象"</span>);
    }
}
</code></pre>
<p>调用测试：</p>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
    <span class="hljs-type">CarDriver</span> <span class="hljs-variable">driver1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CarDriver</span>();
    <span class="hljs-type">CarDriver</span> <span class="hljs-variable">driver2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CarDriver</span>();
}
</code></pre>
<p>执行结果：</p>
<p>plaintext</p>
<pre><code class="hljs">静态代码块执行了 → 初始化职业为司机
构造方法执行了 → 创建司机对象
构造方法执行了 → 创建司机对象
</code></pre>
<p>👉 结论：静态代码块只执行一次，构造方法创建几个对象执行几次。</p>
<hr/>
<h2 data-id="heading-35">七、<code>static</code> 的核心使用场景（总结，学完就会用，不踩坑）</h2>
<p>结合你写的所有代码（CarDriver、MyMath、字符串工具类），整理出<code>static</code>的<strong>3 个最常用场景</strong>，也是开发中的标准用法，<strong>按优先级排序，你作业中用到的场景都在里面</strong>：</p>
<h3 data-id="heading-36">✅ 场景 1：定义【通用工具类的方法】→ 必用 static（你的 MyMath 类）</h3>
<p>比如：数学计算（add、compare）、字符串工具（拼接、判断）、数组工具（排序、找最值），这类方法是通用的，不依赖任何对象的属性，用 static 修饰后，调用时无需创建对象，直接类名调用，代码简洁高效。</p>
<blockquote>
<p>Java 内置的工具类都是这样写的：<code>java.lang.Math</code>、<code>java.util.Arrays</code>、<code>java.util.Collections</code> 中的所有方法都是静态方法。</p>
</blockquote>
<h3 data-id="heading-37">✅ 场景 2：定义【所有对象共享的常量 / 属性】→ 必用 static（你的 CarDriver 类）</h3>
<p>比如：所有司机的职业、所有学生的学校名称、所有商品的品牌，这类属性值所有对象都一样，用 static 修饰后，内存中只存一份，极大节省内存。</p>
<h3 data-id="heading-38">✅ 场景 3：定义【统计类的全局数据】→ 必用 static</h3>
<p>比如：统计创建了多少个司机对象、统计程序的运行次数、统计用户的登录次数，这类数据需要全局共享，用 static 变量存储，一处修改，处处生效。</p>
<hr/>
<h2 data-id="heading-39">八、<code>static</code> 的高频坑点（避坑指南，新手必看）</h2>
<h3 data-id="heading-40">✅ 坑 1：滥用 static，把所有变量 / 方法都加 static</h3>
<p>比如：把司机的 name、age 也加 static，结果所有司机的姓名和年龄都变成一样的，这是最常见的错误！</p>
<blockquote>
<p>✔ 原则：<strong>独有属性用实例变量，共享属性用静态变量</strong>。</p>
</blockquote>
<h3 data-id="heading-41">✅ 坑 2：静态方法中调用实例变量 / 方法，编译报错</h3>
<p>根源：静态方法加载时，对象还没创建，内存中没有实例变量，记住规则即可避免。</p>
<h3 data-id="heading-42">✅ 坑 3：用对象名调用静态变量 / 方法（语法允许，但不推荐）</h3>
<p>比如：<code>driver.job</code>、<code>math.add(10,20)</code>，虽然不报错，但可读性差，别人看代码时不知道这是静态的，<strong>标准写法永远是：类名。静态变量 / 方法</strong>。</p>
<h3 data-id="heading-43">✅ 坑 4：认为 static 的内容是「全局唯一」的，就可以随便修改</h3>
<p>静态变量是类的共有资源，一处修改，所有对象都会受影响，修改时要谨慎，避免误改导致程序逻辑错误。</p>
<hr/>
<h2 data-id="heading-44">九、最终总结（所有知识点精华，背下来 = 掌握所有 static 考点）</h2>
<h3 data-id="heading-45">✅ 核心一句话</h3>
<p><code>static</code>的本质是：<strong>把资源从【对象私有】变为【类公有】，内存中只存一份，所有对象共享，节省内存，简化调用</strong>。</p>
<h3 data-id="heading-46">✅ 核心记忆点</h3>
<ol>
<li><strong>静态变量</strong>：方法区、一份内存、类加载初始化、类名调用、所有对象共享；</li>
<li><strong>实例变量</strong>：堆内存、多份内存、对象创建初始化、对象名调用、对象独有；</li>
<li><strong>静态方法</strong>：类名调用、不能直接调用实例内容、适合做通用工具方法；</li>
<li><strong>静态代码块</strong>：类加载执行一次、初始化静态变量；</li>
<li><strong>使用原则</strong>：<strong>能不用 static 就不用，必须用的时候才用</strong> → 独有属性用实例，共享属性 / 工具方法用静态。</li>
</ol>
<hr/>
<h2 data-id="heading-47">十、附赠：你之前的 MyMath 类 + CarDriver 类 最终优化版（带 static，完美版本）</h2>
<h3 data-id="heading-48">✅ 优化后 MyMath 类（静态方法，推荐写法）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino">package com.shehuiuniversity;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMath</span> {
    <span class="hljs-comment">// 静态方法：加法</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> </span>{
        System.out.<span class="hljs-built_in">println</span>(a + <span class="hljs-string">" + "</span> + b + <span class="hljs-string">" = "</span> + (a+b));
    }
    <span class="hljs-comment">// 静态方法：找三个数最大值</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">compare</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b, <span class="hljs-type">double</span> c)</span> </span>{
        <span class="hljs-type">double</span> max = a &gt; b ? (a &gt; c ? a : c) : (b &gt; c ? b : c);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"参与比较的数值："</span> + a + <span class="hljs-string">","</span> + b + <span class="hljs-string">","</span> + c + <span class="hljs-string">"，最大值为："</span> + max);
    }
}
</code></pre>
<h3 data-id="heading-49">✅ 优化后 CarDriver 类（静态变量 + 实例变量）</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">shehuiuniversity</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Scanner</span>;
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CarDriver</span> {
    <span class="hljs-comment">// 静态变量：所有司机共享</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> job = <span class="hljs-string">"汽车司机"</span>;
    <span class="hljs-comment">// 实例变量：每个司机独有</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> gender;
    <span class="hljs-keyword">private</span> int age;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> license;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> carNum;

    <span class="hljs-comment">// set/get方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setName</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Scanner</span> sc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-title class_">System</span>.<span class="hljs-property">in</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"请输入姓名："</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = sc.<span class="hljs-title function_">nextLine</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setGender</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Scanner</span> sc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-title class_">System</span>.<span class="hljs-property">in</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"请输入性别："</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">gender</span> = sc.<span class="hljs-title function_">nextLine</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setAge</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Scanner</span> sc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-title class_">System</span>.<span class="hljs-property">in</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"请输入年龄："</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = sc.<span class="hljs-title function_">nextInt</span>();
        sc.<span class="hljs-title function_">nextLine</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setLicense</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Scanner</span> sc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-title class_">System</span>.<span class="hljs-property">in</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"请输入驾驶证号："</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">license</span> = sc.<span class="hljs-title function_">nextLine</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setCarNum</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Scanner</span> sc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(<span class="hljs-title class_">System</span>.<span class="hljs-property">in</span>);
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"请输入车牌号："</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">carNum</span> = sc.<span class="hljs-title function_">nextLine</span>();
    }
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> name; }
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getGender</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> gender; }
    <span class="hljs-keyword">public</span> int <span class="hljs-title function_">getAge</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> age; }
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getLicense</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> license; }
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getCarNum</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> carNum; }

    <span class="hljs-comment">// 实例方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">wayToDrive</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(name + <span class="hljs-string">"("</span> + job + <span class="hljs-string">")正在开车牌号为"</span> + carNum + <span class="hljs-string">"的车"</span>);
    }

    <span class="hljs-comment">// toString方法</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">toString</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"【"</span>+job+<span class="hljs-string">"信息】\n姓名："</span>+name+<span class="hljs-string">"\n性别："</span>+gender+<span class="hljs-string">"\n年龄："</span>+age+<span class="hljs-string">"\n驾驶证号："</span>+license+<span class="hljs-string">"\n车牌号："</span>+carNum;
    }
}
</code></pre>
<h3 data-id="heading-50">✅ 测试类</h3>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">package com.Testclass<span class="hljs-comment">;</span>
import com.shehuiuniversity.MyMath<span class="hljs-comment">;</span>
import com.shehuiuniversity.CarDriver<span class="hljs-comment">;</span>
public class TestAll {
    public static void main(String<span class="hljs-section">[]</span> args) {
        // 调用静态方法：无需创建对象
        MyMath.add(10,20)<span class="hljs-comment">;</span>
        MyMath.compare(0.1,0.5,0.3)<span class="hljs-comment">;</span>
        
        // 调用静态变量：类名调用
        System.out.println("职业：" + CarDriver.job)<span class="hljs-comment">;</span>
        
        // 创建对象调用实例方法
        CarDriver <span class="hljs-attr">driver</span> = new CarDriver()<span class="hljs-comment">;</span>
        driver.setName()<span class="hljs-comment">;</span>
        driver.setGender()<span class="hljs-comment">;</span>
        driver.setAge()<span class="hljs-comment">;</span>
        driver.setLicense()<span class="hljs-comment">;</span>
        driver.setCarNum()<span class="hljs-comment">;</span>
        System.out.println(driver)<span class="hljs-comment">;</span>
        driver.wayToDrive()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>至此，<code>static</code>的所有核心知识点你就全部掌握了，这是 Java 基础的重中之重</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SJF4J 五分钟入门：Java 的实用 JSON 门面]]></title>    <link>https://juejin.cn/post/7595772638880776243</link>    <guid>https://juejin.cn/post/7595772638880776243</guid>    <pubDate>2026-01-16T09:34:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595772638880776243" data-draft-id="7595774188909772838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SJF4J 五分钟入门：Java 的实用 JSON 门面"/> <meta itemprop="keywords" content="Java,JSON"/> <meta itemprop="datePublished" content="2026-01-16T09:34:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="信码由缰"/> <meta itemprop="url" content="https://juejin.cn/user/2110664941509214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SJF4J 五分钟入门：Java 的实用 JSON 门面
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2110664941509214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    信码由缰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:34:07.000Z" title="Fri Jan 16 2026 09:34:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Java 中的 JSON 处理很少是简单的。</p>
<p>在实际应用中，数据不断在以下形式之间流转：</p>
<ul>
<li>
<p>POJO（普通Java对象）</p>
</li>
<li>
<p>Map / List</p>
</li>
<li>
<p>JSON 字符串</p>
</li>
<li>
<p>配置文件</p>
</li>
<li>
<p>模式不断演进的 API</p>
</li>
</ul>
<p>Java 开发者常常被迫做出痛苦的选择：</p>
<blockquote>
<p><strong>要么要类型安全，要么要灵活性——二者不可兼得。</strong></p>
</blockquote>
<p><img src="https://cf-blog.icodebuddy.com/image/104/104-0.png" alt="" loading="lazy"/></p>
<p><strong>SJF4J（Java 简单 JSON 门面）</strong> 就是为了消除这种取舍而构建的。</p>
<h2 data-id="heading-0">SJF4J 是什么？</h2>
<p>SJF4J 是流行 JSON 库（Jackson、Gson、Fastjson2）及相关格式（YAML、Properties）之上的一个轻量级门面。它提供一个用于<strong>结构化数据处理的统一语义层</strong>，完全基于 JSON 规范。它<strong>不</strong>替代你的 JSON 解析器，而是在它们<em>之上</em>统一你的结构化数据处理方式。</p>
<h2 data-id="heading-1">核心理念：基于对象的节点树</h2>
<p>SJF4J 没有引入自定义的 JSON AST（抽象语法树），而是将<strong>现有的 Java 对象视为 JSON 节点</strong>。这被称为<strong>基于对象的节点树[Object-Based Node Tree (OBNT)]</strong>。</p>
<p>在 OBNT 中：</p>
<ul>
<li>
<p>JSON 对象 → JsonObject、Map、POJO</p>
</li>
<li>
<p>JSON 数组 → JsonArray、List、数组</p>
</li>
<li>
<p>JSON 值 → Java 原生类型</p>
</li>
</ul>
<p>一切都保持为<strong>普通的 Java 对象</strong>，只是在上层附加了 JSON 语义。</p>
<h2 data-id="heading-2">快速示例</h2>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-type">JsonObject</span> <span class="hljs-variable">jo</span> <span class="hljs-operator">=</span> JsonObject.fromJson(<span class="hljs-string">"""

{

"id": 1,

"active": true

}

"""</span>);

  


<span class="hljs-type">int</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> jo.getInt(<span class="hljs-string">"id"</span>); <span class="hljs-comment">// 类型安全</span>

<span class="hljs-type">String</span> <span class="hljs-variable">active</span> <span class="hljs-operator">=</span> jo.asString(<span class="hljs-string">"active"</span>); <span class="hljs-comment">// Boolean → String 转换</span>

</code></pre>
<p>SJF4J 提供三种访问级别：</p>
<ul>
<li>
<p><code>getNode</code> → 原始访问</p>
</li>
<li>
<p><code>getXxx</code> → 类型安全访问</p>
</li>
<li>
<p><code>asXxx</code> → 语义访问，支持跨类型转换</p>
</li>
</ul>
<p>你可以为每次调用选择严格程度。</p>
<h2 data-id="heading-3">基于路径的访问（符合 RFC 规范）</h2>
<p>SJF4J 完全支持：</p>
<ul>
<li>
<p>JSON 路径（RFC 9535）</p>
</li>
<li>
<p>JSON 指针（RFC 6901）</p>
</li>
</ul>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> jo.asByPath(<span class="hljs-string">"$.user.name"</span>);

List&lt;Integer&gt; ids = jo.findByPath(<span class="hljs-string">"$.items[*].id"</span>, Integer.class);

</code></pre>
<p>同样的路径 API 适用于：</p>
<ul>
<li>
<p>JSON</p>
</li>
<li>
<p>Map / List</p>
</li>
<li>
<p>POJO</p>
</li>
<li>
<p>混合对象图</p>
</li>
</ul>
<h2 data-id="heading-4">动态 + 类型化：JOJO</h2>
<p>SJF4J 引入了 JOJO（JSON 对象 Java 对象）—— 一个扩展了 JsonObject 的领域对象。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JsonObject</span> {

String name;

}

user.getName(); <span class="hljs-comment">// 类型化访问</span>

user.getString(<span class="hljs-string">"age"</span>); <span class="hljs-comment">// 动态访问</span>

user.findByPath(<span class="hljs-string">"$..name"</span>); <span class="hljs-comment">// JSON 语义访问</span>

</code></pre>
<p>你可以从动态访问开始，逐步添加结构 —— 而无需破坏 API。</p>
<h2 data-id="heading-5">使用 JsonPatch 进行声明式转换</h2>
<p>SJF4J 支持：</p>
<ul>
<li>
<p>JSON 补丁（RFC 6902）</p>
</li>
<li>
<p>JSON 合并补丁（RFC 7386）</p>
</li>
</ul>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-type">JsonPatch</span> <span class="hljs-variable">patch</span> <span class="hljs-operator">=</span> JsonPatch.diff(source, target);

patch.apply(source);

</code></pre>
<p>补丁操作在 POJO、Map、List 和 JSON 对象上统一工作。</p>
<h2 data-id="heading-6">SJF4J 何时大放异彩？</h2>
<p>如果你符合以下情况，SJF4J 是理想选择：</p>
<ul>
<li>
<p>处理不断演进或半结构化的数据</p>
</li>
<li>
<p>既需要灵活性又需要类型安全</p>
</li>
<li>
<p>希望在多个 JSON 库上使用统一的 API</p>
</li>
<li>
<p>关注 JSON 规范</p>
</li>
</ul>
<h2 data-id="heading-7">总结</h2>
<p>SJF4J 让面向 JSON 的 Java 开发成为可能 —— 无需过早锁定方案或编写过多样板代码。</p>
<p>它小巧、可组合，并且由规范驱动。</p>
<p>👉 GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsjf4j-projects%2Fsjf4j" target="_blank" title="https://github.com/sjf4j-projects/sjf4j" ref="nofollow noopener noreferrer">github.com/sjf4j-proje…</a></p>
<hr/>
<p>【注】本文译自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.to%2Fhannyu%2Fsjf4j-in-5-minutes-a-practical-json-facade-for-java-j73" target="_blank" title="https://dev.to/hannyu/sjf4j-in-5-minutes-a-practical-json-facade-for-java-j73" ref="nofollow noopener noreferrer">SJF4J in 5 Minutes: A Practical JSON Facade for Java</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一站式了解全局分布式生成ID方案]]></title>    <link>https://juejin.cn/post/7595603381663760390</link>    <guid>https://juejin.cn/post/7595603381663760390</guid>    <pubDate>2026-01-16T09:16:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595603381663760390" data-draft-id="7591969856577404978" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一站式了解全局分布式生成ID方案"/> <meta itemprop="keywords" content="后端,面试,架构"/> <meta itemprop="datePublished" content="2026-01-16T09:16:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一站式了解全局分布式生成ID方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:16:53.000Z" title="Fri Jan 16 2026 09:16:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>作为一名后端开发人员，理解分布式 ID 的演进过程，本质上是在理解如何在<strong>分布式 CAP 理论</strong>（一致性、可用性、分区容错性）中寻找性能与可靠性的平衡点。在分布式系统中，ID 不仅仅是一个数字。它是数据的唯一标识，是分库分表的路由依据，更是系统高性能运转的基石。所以，深度了解全局分布式生成ID的方案是非常有必要的，接下来让我们一起探讨一下吧！</p>
<h2 data-id="heading-1">为什么不能用自增主键？</h2>
<p>有同学说了，我们为啥不用数据库可以自增生成的主键呢？这样同时还能提高SQL的查询速度(B+树)。你先不急，不使用肯定是因为优先级高于这点优化的。</p>
<h3 data-id="heading-2">分布式系统中的困难</h3>
<p>在单机数据库中，自增主键（如 MySQL 的 <code>AUTO_INCREMENT</code>）简单高效。但在<strong>分布式系统</strong>中存在以下问题：</p>
<ul>
<li><strong>无法保证全局唯一</strong>：多个数据库实例各自维护自己的自增值，容易冲突。</li>
<li><strong>不利于分库分表</strong>：插入前不知道主键值，难以确定数据应路由到哪个分片。</li>
<li><strong>性能瓶颈</strong>：集中式生成器会成为单点瓶颈，高并发下承压太高。</li>
</ul>
<h3 data-id="heading-3">安全与业务风险</h3>
<p>除了提到的<strong>分布式系统中的技术限制</strong>（如全局唯一性、分片路由、性能瓶颈）之外，<strong>自增主键还有一个重要的安全和业务风险：容易被外部猜测出数据规律</strong>。这在很多实际业务场景中是不可接受的。</p>
<blockquote>
<p>据说,早期 Instagram 的照片 ID 是自增的，研究人员通过 ID 推算出其每日新增照片量，引发隐私争议。</p>
</blockquote>
<h4 data-id="heading-4"><strong>暴露业务规模</strong></h4>
<ul>
<li>
<p>比如一个电商网站的订单 ID 是 <code>10001</code>、<code>10002</code>……</p>
</li>
<li>
<p>竞争对手或用户通过观察 ID 增长速度，可以估算：</p>
<ul>
<li>每天/每小时的订单量</li>
<li>用户注册数量</li>
<li>内容发布频率（如帖子、评论数）</li>
</ul>
</li>
<li>
<p>这相当于<strong>免费泄露了核心运营数据</strong></p>
</li>
</ul>
<h4 data-id="heading-5"><strong>安全隐患：ID 遍历攻击（IDOR）</strong></h4>
<ul>
<li>如果 URL 是 <code>https://example.com/order/12345</code>，攻击者只需尝试 <code>12346</code>、<code>12347</code>……</li>
<li>如果权限校验不严，就可能<strong>越权访问他人数据</strong>。</li>
<li>即使有权限控制，大量无效请求也会增加服务器负担。</li>
</ul>
<blockquote>
<p>安全最佳实践：<strong>不要依赖“隐藏 ID”来保护数据</strong>，但使用不可预测的 ID 可以显著提高攻击成本</p>
</blockquote>
<h4 data-id="heading-6"><strong>影响 A/B 测试或灰度发布</strong></h4>
<p>如果新功能只对部分用户开放，而用户 ID 是连续的（如 1～10000 是老用户，10001+ 是新用户），容易被识别出测试分组，破坏实验有效性</p>
<h2 data-id="heading-7">分布式主键的核心要求</h2>
<p>ok,上面说了这么多自增主键的坏处，我们来谈谈分布式主键的核心要求</p>
<ol>
<li><strong>全局唯一</strong>（必须）</li>
<li><strong>趋势递增</strong>（有利于索引性能，避免随机写）</li>
<li><strong>高可用 &amp; 高性能</strong>（低延迟、无单点故障）</li>
<li><strong>可扩展</strong>（支持水平扩展）</li>
<li><strong>尽量短</strong>（节省存储和索引空间）</li>
</ol>
<h2 data-id="heading-8">全局分布式生成ID方案: 内外分离</h2>
<p>很多大厂采用“<strong>内部主键 + 外部公开 ID</strong>”的双 ID 体系，接下来我们分开谈谈各自可以怎么做。可以根据业务需要使用，不一定需要双ID体系。</p>
<p>如下图就是一个订单编号，也就是订单表的主键。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8834a65bec6140d6baaf95924975f6d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159813&amp;x-signature=OhLKbITH8u8%2B8%2BHcSJmfRoElM2A%3D" alt="bb08eefae3a0ab86c61b022bb1f9741d.jpg" loading="lazy"/></p>
<h3 data-id="heading-9">内部主键ID</h3>
<p>我们在程序内的，给数据库对应表的主键可以怎么样设计呢？来看看下面的方案吧，有些方案并不是完全适合全局分布式生成ID的要求，我之所以列出来，是因为有这样的方案，大家可以按需理解和使用。</p>
<h4 data-id="heading-10">数据库 Seq 表方案 (传统模式)</h4>
<p>这是最原始的分布式 ID 做法：在数据库中建立一张表，这个表只有有一列，专门用来记录 ID。不同的业务表都对应有这张表</p>
<ul>
<li>
<p><strong>实现：</strong> 每次需要 ID 时，执行类似 <code>REPLACE INTO</code> 或 <code>UPDATE</code> 的操作，利用数据库的自增属性获取新值。</p>
</li>
<li>
<p><strong>痛点：</strong></p>
</li>
</ul>
<p><strong>性能瓶颈：</strong> 每次生成 ID 都得读写数据库，在高并发场景下，数据库会成为严重的单点瓶颈。</p>
<p><strong>高可用风险：</strong> 如果这台 DB 宕机，整个系统的发号功能就瘫痪了</p>
<p><strong>表非常多：</strong> 每一种表都需要对应一张这样的表，那这种seq表就会非常多</p>
<p><strong>本质：</strong> 这种方案本质上还是自增的</p>
<h4 data-id="heading-11">UUID(Universally Unique Identifier)</h4>
<p>这是最简单、最不依赖外部系统的方案。</p>
<ul>
<li>
<p><strong>实现：</strong> Java 的 <code>UUID.randomUUID()</code> 或 Go 的 <code>google/uuid</code> 库。</p>
</li>
<li>
<p><strong>优点：</strong> 本地生成，性能极高，无网络开销。</p>
</li>
<li>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>无序：</strong> 作为 B+ 树主键会导致页分裂，严重影响数据库写入性能。</li>
<li><strong>不可读：</strong> 没有任何业务含义。</li>
<li><strong>太长：</strong> 36 位字符，占用空间大。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">Redis <code>INCR</code></h4>
<p>利用 Redis 的原子操作生成 ID。</p>
<ul>
<li><strong>实现：</strong> 通过 <code>INCR</code> 命令实现自增。为了提高可用性，可以采用多个 Redis 节点，设置不同的初始值和相同的步长。</li>
<li><strong>优点：</strong> 性能高于数据库，自增有序。</li>
<li><strong>缺点：</strong> 增加了 Redis 维护成本，且数据持久化（RDB/AOF）如果配置不当，重启后可能导致 ID 重复。本质上还是数据库的方案变种，只不过性能提高了不少。</li>
</ul>
<h4 data-id="heading-13">Snowflake - 雪花算法（重点）</h4>
<p>这是目前分布式系统中最主流的方案，Twitter 开源，非常适合微服务环境。</p>
<h5 data-id="heading-14">结构拆解</h5>
<p>雪花算法生成的 ID 是一个 <strong>64 位的 long 型整数</strong>：</p>
<ol>
<li><strong>1 bit：</strong> 固定为 0，表示正数。</li>
<li><strong>41 bit：</strong> 时间戳（毫秒级）。可以使用约 69 年。</li>
<li><strong>10 bit：</strong> 工作机器 ID。可以部署 1024 个节点。</li>
<li><strong>12 bit：</strong> 序列号。同一毫秒内可产生 4096 个 ID。</li>
</ol>
<h5 data-id="heading-15">优缺点分析</h5>
<ul>
<li>
<p><strong>优点：</strong></p>
<ul>
<li><strong>趋势递增：</strong> 整体按时间排序。</li>
<li><strong>不依赖外部：</strong> 纯本地算法，无网络 I/O。</li>
<li><strong>高性能：</strong> 每秒可产生数百万个 ID。</li>
</ul>
</li>
<li>
<p><strong>缺点：</strong>  <strong>时钟回拨，</strong> 这是雪花算法最大的痛点。如果服务器时间被回拨，可能会产生重复 ID。</p>
</li>
</ul>
<h5 data-id="heading-16">什么是时钟回拨？</h5>
<p>时钟回拨是指系统时钟在运行过程中，由于某些原因导致获取到的当前时间戳比上一次获取的时间戳还要小的现象。</p>
<p><strong>核心成因</strong></p>
<ul>
<li><strong>NTP 强行同步</strong>：服务器通常会通过 NTP (Network Time Protocol) 协议与时间服务器同步。如果本地时钟比 NTP 服务器快，同步时可能会导致本地时间跳回。</li>
<li><strong>管理员手动修改</strong>：运维人员手动调整了服务器系统时间。</li>
<li><strong>闰秒调整</strong>：虽然罕见，但地球自转变化导致的闰秒补偿也可能引起微妙的时间跳变</li>
</ul>
<h5 data-id="heading-17">为什么雪花算法怕回拨？</h5>
<p>雪花算法的核心逻辑是：<code>ID = [1位符号] + [41位时间戳] + [10位机器ID] + [12位序列号]</code>。</p>
<p>如果时间发生了回拨：</p>
<ol>
<li>算法在新的（但较旧的）毫秒内重新从 0 开始计数。</li>
<li>而这个旧的毫秒在真实时间的“过去”已经生成过 ID 了。</li>
<li><strong>结果</strong>：极大概率产生与过去完全相同的 ID，导致数据库主键冲突</li>
</ol>
<h5 data-id="heading-18">时钟回拨常见应对策略？</h5>
<p><strong>方案 A：抛出异常（最简单）</strong></p>
<p>如果检测到当前时间 &lt; 上次生成时间，直接拒绝服务，抛出异常告知上层逻辑。</p>
<p><strong>方案 B：容间等待（最通用）</strong></p>
<p>如果回拨时间很短（例如在 5ms 以内），则让程序线程阻塞（Sleep）等待时间追赶回来。</p>
<p><strong>方案 C：备用机位（高阶方案）</strong></p>
<p>为每台机器分配两个 <code>WorkerID</code>。平时用 A，发生回拨时立即切换到 B，由于机器 ID 不同，即使时间重叠也不会产生重复 ID。</p>
<p><strong>方案 D：时间追赶（百度 UidGenerator 策略）</strong></p>
<p>不再获取系统时间，而是基于上一次生成的 ID 时间戳平滑自增。如果系统时间回拨，逻辑时钟依然向后走</p>
<h4 data-id="heading-19">美团 Leaf算法</h4>
<p>美团的 Leaf 方案集各家之长，提供了两种模式，解决了上述方案的核心痛点。</p>
<h5 data-id="heading-20">Leaf-Segment (号段模式)</h5>
<p>这是对“数据库自增”的深度优化。</p>
<ul>
<li><strong>原理</strong>：不再是每次要 1 个 ID，而是每次从数据库批次获取一个号段（如 1000 个）。</li>
<li><strong>核心优化：双缓存 (Double Buffer)</strong> 当内存中第一个号段用掉 10% 时，Leaf 会异步启动一个线程去预取下一个号段。</li>
<li><strong>效果</strong>：即使数据库短时间宕机，由于内存有缓存，服务依然可用。同时解决了直接访问数据库的性能抖动</li>
</ul>
<h5 data-id="heading-21">Leaf-Snowflake (自愈雪花)</h5>
<p>针对雪花算法的优化：</p>
<ul>
<li><strong>自动分配 WorkerID</strong>：利用 ZooKeeper 的顺序节点自动注册机器 ID，无需手动配置。</li>
<li><strong>时钟回拨校验</strong>：启动时校验时间，运行中如果发现回拨，会报错或自动等待时间追赶。</li>
</ul>
<h3 data-id="heading-22">外部ID</h3>
<p>那么显示在浏览器链接的ID我们又有什么方案呢？来看看吧</p>
<h4 data-id="heading-23"><strong>外部 ID 是内部 ID 的「可逆编码」</strong></h4>
<p>外部显示id就加密一次（如纯 Base62）。</p>
<pre><code class="hljs language-java" lang="java">internal_id = <span class="hljs-number">1284756392012345678</span> 
public_id = <span class="hljs-string">"ord_"</span> + base62_encode(internal_id) # → <span class="hljs-string">"ord_k7mPq9sR"</span>
</code></pre>
<ul>
<li><strong>Base62 编码</strong>：只是将十进制数字转为 <code>0-9a-zA-Z</code> 的字符串表示（类似 hex，但更紧凑）</li>
<li><strong>无哈希、无盐值</strong>，是<strong>完全可逆</strong>的</li>
<li>数据库仍用 <code>BIGINT</code> 存 <code>internal_id</code>，对外展示 <code>public_id</code></li>
<li>查询时：收到 <code>ord_k7mPq9sR</code> → 去掉前缀 → Base62 解码 → 得到 <code>1284756392012...</code> → 直接查主键</li>
</ul>
<p><strong>优点：</strong></p>
<ul>
<li>无额外存储（不需要存 public_id 字段）</li>
<li>查询高效（直接命中主键索引）</li>
<li>保证唯一性（因为内部 ID 唯一）</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>仍然可预测</strong>！<br/>
虽然看起来像乱码，但攻击者知道是 Base62 后，可以反推内部 ID，进而推测业务量。</li>
<li>不具备“不可猜测性”（security through obscurity ≠ security）</li>
</ul>
<blockquote>
<p> <strong>结论</strong>：这种方案<strong>不是真正的安全方案</strong>，只是“美化 ID”或“缩短 URL”，<strong>不能防 IDOR 或防数据推断</strong></p>
</blockquote>
<h4 data-id="heading-24"><strong>外部 ID 是随机生成 or 加密派生</strong></h4>
<p>这种方案<strong>无直接数学对应，需额外存储映射关系</strong>。</p>
<h5 data-id="heading-25">方案 A：<strong>完全随机生成</strong></h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">public_id</span> = <span class="hljs-string">"ord_"</span> + secrets.token_urlsafe(<span class="hljs-number">8</span>) <span class="hljs-comment"># → "ord_k7mPq9sR"</span>
</code></pre>
<ul>
<li>每次创建订单时，<strong>独立生成一个随机字符串</strong></li>
<li>在数据库中<strong>额外存一个字段</strong>：<code>public_id VARCHAR(32) UNIQUE</code></li>
<li>查询时：用 <code>public_id</code> 作为查询条件（需在该字段上建唯一索引）</li>
</ul>
<h5 data-id="heading-26">方案 B：<strong>HMAC + 截断（伪随机但确定性）</strong></h5>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用密钥对 internal_id 做 HMAC，再 Base62 编码取前8位 </span>
<span class="hljs-attr">key</span> = b<span class="hljs-string">"your-secret-key"</span> h = hmac.new(key, str(internal_id).encode(), <span class="hljs-string">'sha256'</span>).digest() 
<span class="hljs-attr">public_id</span> = <span class="hljs-string">"ord_"</span> + base62_encode(int.from_bytes(h[:<span class="hljs-number">6</span>], <span class="hljs-string">'big'</span>))[:<span class="hljs-number">8</span>]
</code></pre>
<ul>
<li>相同 internal_id 总是生成相同 public_id（确定性）</li>
<li>但<strong>无法从 public_id 反推 internal_id</strong>（因为 HMAC 不可逆 + 截断信息丢失）</li>
<li><strong>仍需存储 public_id 字段</strong>（因为无法实时反算）</li>
</ul>
<blockquote>
<p>注意：即使使用 HMAC，如果截断太短（如只取 4 字符），可能有碰撞风险。一般建议 ≥8 字符。</p>
</blockquote>
<p><strong>优点：</strong></p>
<ul>
<li><strong>真正不可预测</strong>，防止 ID 遍历和业务数据推断</li>
<li>符合安全最佳实践（OWASP 推荐）</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>需要<strong>额外存储 public_id 字段</strong></li>
<li>需要<strong>在 public_id 上建唯一索引</strong>（增加写开销和存储）</li>
<li>查询路径变长（不能直接用主键）</li>
</ul>
<h2 data-id="heading-27">总结</h2>
<h3 data-id="heading-28">经验之谈</h3>
<ul>
<li><strong>面向公网、用户可见的 ID</strong> → 用<strong>随机生成</strong>，存字段，不可逆（安全优先）</li>
<li><strong>内部系统、API 间调用、日志追踪</strong> → 可用 Base62 编码 Snowflake 或者 单纯Snowflake（效率优先）</li>
</ul>
<p>在 Java 中，我们常用 <code>Long</code> 类型承载分布式 ID，但在 Go 中，由于 <code>int</code> 的长度取决于平台，通常建议明确使用 <code>int64</code>。另外，<strong>一定不要忘记前端精度问题</strong>：JavaScript 的 Number 类型最大只能安全表示 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>53</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{53} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">53</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，而 64 位 ID 最大是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>63</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{63} - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">63</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>。</p>
<h3 data-id="heading-29">杂谈</h3>
<p>了解分布式生成ID对分布式事务，分库分表这些重点问题都非常重要，而且其中都有很多前人踩过的坑。需要注意的是，不同业务对分布式生成ID的需求度都不同，不一定要按照最严格的去弄，有时候可能适得其反，毕竟适合自己的才是最好的。</p>
<p>如果你觉得这篇文章给你带来了不错的体感，那就给我点赞+收藏+关注吧，这是我更新的最大动力</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nuxt state状态如何管理，3秒手把手帮你]]></title>    <link>https://juejin.cn/post/7595502583269294116</link>    <guid>https://juejin.cn/post/7595502583269294116</guid>    <pubDate>2026-01-16T09:01:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595502583269294116" data-draft-id="7595513077220966446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nuxt state状态如何管理，3秒手把手帮你"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-16T09:01:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江湖文人"/> <meta itemprop="url" content="https://juejin.cn/user/3044986347066480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nuxt state状态如何管理，3秒手把手帮你
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044986347066480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江湖文人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:01:32.000Z" title="Fri Jan 16 2026 09:01:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>用<code>useState</code>。有响应式和支持<code>ssr</code>共享。</p>
<p><code>useState</code>是支持<code>ssr</code>的<code>ref</code>替代方案。其中，在后端渲染后（前端水合）会被保留，并通过唯一键在所有组件之间共享。</p>
<blockquote>
<p><code>useState</code>中的数据将序列化为<code>JSON</code>。</p>
</blockquote>
<h2 data-id="heading-0">例子</h2>
<h3 data-id="heading-1">基本用法</h3>
<p>用组件本地的计算器状态。任何用<code>useState('counter')</code>的组件都共享相同的响应式状态。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// app.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'counter'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>))
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    计算器：{{ counter }}
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"counter++"</span>&gt;</span>
      +
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"counter--"</span>&gt;</span>
      -
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-2">初始化状态</h3>
<p>异步解析去初始化状态。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// app.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">const</span> websiteConfig = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'config'</span>)

<span class="hljs-keyword">await</span> <span class="hljs-title function_">callOnce</span>(<span class="hljs-keyword">async</span> () =&gt; {
  websiteConfig.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> $fetch(<span class="hljs-string">'https://my-cms.com/api/website-config'</span>)
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-3">与Pinia一起用</h3>
<p>在<code>Pinia 模块</code>创建全局存储并在整个应用中使用它。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// stores/website.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useWebsiteStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'websiteStore'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">''</span>
  }),
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> infos = <span class="hljs-keyword">await</span> $fetch(<span class="hljs-string">'https://api.nuxt.com/modules/pinia'</span>)
      
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = infos.<span class="hljs-property">name</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">description</span> = infos.<span class="hljs-property">description</span>
    }
  }
})
</code></pre>
<h2 data-id="heading-4">高级用法</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// composables/locale.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useLocale</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useState</span>(<span class="hljs-string">'locale'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">useDefaultLocale</span>().<span class="hljs-property">value</span>)
}

<span class="hljs-keyword">export</span> cosnt useDefautLocale = <span class="hljs-function">(<span class="hljs-params">fallback = <span class="hljs-string">'en-US'</span></span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> locale = <span class="hljs-title function_">ref</span>(fallback)
  <span class="hljs-keyword">return</span> locale
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useLocales</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> locale = <span class="hljs-title function_">useLocale</span>()
  <span class="hljs-keyword">const</span> locales = <span class="hljs-title function_">ref</span>([
    <span class="hljs-string">'en-US'</span>,
    <span class="hljs-string">'en-GB'</span>,
    ...
  ])
  <span class="hljs-keyword">if</span> (!locales.<span class="hljs-property">value</span>.<span class="hljs-title function_">includes</span>(locale.<span class="hljs-property">value</span>)) {
    locales.<span class="hljs-property">value</span>.<span class="hljs-title function_">unshift</span>(locale.<span class="hljs-property">value</span>)
  }
  <span class="hljs-keyword">return</span> locales
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useLocaleDate</span> = (<span class="hljs-params">date: Ref&lt;<span class="hljs-built_in">Date</span>&gt; | <span class="hljs-built_in">Date</span>, locale = useLocale()</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">DateTimeFormat</span>(locale.<span class="hljs-property">value</span>, {
    <span class="hljs-attr">dateStyle</span>: <span class="hljs-string">'full'</span>
  }).<span class="hljs-title function_">format</span>(<span class="hljs-title function_">unref</span>(date)))
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// app.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">const</span> locales = <span class="hljs-title function_">useLocales</span>()
<span class="hljs-keyword">const</span> locale = <span class="hljs-title function_">useLocale</span>()
<span class="hljs-keyword">const</span> date = <span class="hljs-title function_">useLocaleDate</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2026-1-16'</span>))
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>生日<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ date }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">for</span>=<span class="hljs-string">"locale-chooser"</span>&gt;</span>语言<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"locale-chooser"</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"locale"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"loc of locales"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"loc"</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">"loc"</span>&gt;</span>
        {{ loc }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-5">共享状态</h2>
<p><code>自动导入的组合式函数</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// composables/states.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">useColor</span> = (<span class="hljs-params"/>) =&gt; useState&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'color'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'pink'</span>)
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// app.vue</span>
&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">useColor</span> = (<span class="hljs-params"/>) =&gt; useState&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'color'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'pink'</span>)

<span class="hljs-keyword">const</span> color = <span class="hljs-title function_">useColor</span>() <span class="hljs-comment">// 与 useState('color')相同</span>
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ color }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-6">用库 - 第三方的</h2>
<ul>
<li>Pinia</li>
<li>Harlem</li>
<li>XState</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你知道项目需要什么 node 版本吗？哪个包管理工具的什么版本？]]></title>    <link>https://juejin.cn/post/7595772638880497715</link>    <guid>https://juejin.cn/post/7595772638880497715</guid>    <pubDate>2026-01-16T09:11:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595772638880497715" data-draft-id="7595683968683687982" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你知道项目需要什么 node 版本吗？哪个包管理工具的什么版本？"/> <meta itemprop="keywords" content="前端,Node.js"/> <meta itemprop="datePublished" content="2026-01-16T09:11:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Carry345"/> <meta itemprop="url" content="https://juejin.cn/user/831674360017678"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你知道项目需要什么 node 版本吗？哪个包管理工具的什么版本？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/831674360017678/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Carry345
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:11:17.000Z" title="Fri Jan 16 2026 09:11:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>近期接手了一个新项目,<code>clone</code>下来发现</p>
<ol>
<li><code>readme</code> 无迹可循,node 版本等信息,只能口口相传,强依赖于上一个开发者</li>
<li>项目中有 npm, yan, pnpm 相关的配置，却无法知道明确应该使用那个包管理工具</li>
</ol>
<p>于是开始致力于寻找解决之法</p>
<h2 data-id="heading-0">1. 指定 node 版本</h2>
<h3 data-id="heading-1">1.1. 约束</h3>
<p>问题：如果开发者任意使用了某个版本的 node,显然是不符合预期的，所以我们需要添加约束，来尽可能早的暴露错误</p>
<p>目的：开发者可以从项目配置获取到 node 版本信息，以及使用了不符合的 node 版本时warn 或 error</p>
<h4 data-id="heading-2">步骤一：最基础约束：<code>package.json → engines</code></h4>
<p>配置方式：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18 &lt;21"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>实际效果：</p>
<ul>
<li>npm / pnpm / yarn 会检查</li>
</ul>
<blockquote>
<p>不一样的包管理工具，或同一包管理工具的不同版本，对应行为的说法多种多样，最好自己试一下，下面贴我试下来的结果：</p>
<ul>
<li>npm 10.9.2</li>
<li>pnpm 9.5.0</li>
<li>yarn 1.22.22</li>
</ul>
</blockquote>
<p>npm: warn</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/758d3bf86a174820bec914507b1b69e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=uWztzaNJv2ZLdBczUhdxWm3mg7g%3D" alt="" loading="lazy"/></p>
<p>pnpm: warn</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c96fd0889c240cd92568a29a5ada999~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=9An6IQOHMjW4J2pFuzSVcs9hzqo%3D" alt="" loading="lazy"/></p>
<p>yarn: error</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e92a8863731a40448de92553cb554d0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=9gl7GYse3rlVKPAZxPXgCuo1SRY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-3">步骤二：最基础约束基础上添加<code>engine-strict=true</code></h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">engine-strict</span>=<span class="hljs-literal">true</span>
</code></pre>
<p>npm: error</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0d70e2d4efa406fbda251f72f964b0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=buPGyynuJ5mxDyc0MQmYbjdK9gM%3D" alt="" loading="lazy"/></p>
<p>pnpm: error</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ca7a3ee074e455487716a3ebd10d90d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=1bBdiiP7QRQxqpdVvYkgJZ63qZc%3D" alt="" loading="lazy"/></p>
<p>yarn: error (原本也是)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dfd66d373094649951749339173c607~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=Jfip6fJFThAI3Q2ZYJCHw09bqRY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">步骤三：脚本约束(最终防线 可选)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [major] = process.<span class="hljs-property">versions</span>.<span class="hljs-property">node</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">map</span>(<span class="hljs-title class_">Number</span>)

<span class="hljs-keyword">if</span> (major &lt; <span class="hljs-number">18</span> || major &gt;= <span class="hljs-number">21</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(
    <span class="hljs-string">`❌ Node.js version <span class="hljs-subst">${process.versions.node}</span> is not supported.\n`</span> +
    <span class="hljs-string">`Required: &gt;=18 &lt;21`</span>
  )
  process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>)
}
</code></pre>

<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"preinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node scripts/check-node.js"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">1.2. node 版本切换辅助</h3>
<p>目的：进入项目实现 node 版本自动切换，或简化手动版本切换</p>
<h4 data-id="heading-6">方案一：nvm + .nvmrc （手动）</h4>
<p>1️⃣ 在项目根目录新建 <code>.nvmrc</code></p>
<pre><code class="hljs">22.16.0
</code></pre>
<p>2️⃣ 进入项目执行 <code>nvm use</code></p>
<blockquote>
<p>开发者需要提前安装</p>
<ul>
<li><code>nvm</code>（macOS / Linux）</li>
<li>Windows 需要 <code>nvm-windows</code></li>
</ul>
</blockquote>
<h4 data-id="heading-7">方案二：Volta （自动）</h4>
<p>1️⃣ 在项目中 pin node</p>
<pre><code class="hljs language-kotlin" lang="kotlin">volta pin <span class="hljs-symbol">node@</span><span class="hljs-number">22.16</span><span class="hljs-number">.0</span>

# 包管理工具一起固定
# volta pin <span class="hljs-symbol">pnpm@</span><span class="hljs-number">9.12</span><span class="hljs-number">.2</span>     # 或 <span class="hljs-symbol">yarn@</span><span class="hljs-number">1.22</span><span class="hljs-number">.19</span> / <span class="hljs-symbol">npm@</span><span class="hljs-number">10.8</span><span class="hljs-number">.3</span>
</code></pre>
<p>生成如下内容，会添加在 <code>package.josn</code>文件中</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"volta"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"18.19.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>2️⃣ 自动切换 node</p>
<p>不需要手动切换，进入项目后，volta 会在第一次用到 node 时自动切换为目标 <code>node</code> 版本（如果没有目标版本，会自动下载），进入项目 <code>node -v</code>可验证</p>
<blockquote>
<p>开发者需要提前安装</p>
<ul>
<li>Volta</li>
</ul>
</blockquote>
<blockquote>
<p>注意⚠️：现在 volta 不支持 uninstall node</p>
<p>原因：Volta 把 Node 当成“基础设施”，官方不支持、也不推荐卸载 node</p>
<p>偏方：自己找到文件夹的位置<code>~/.volta/tools/image/node/</code>删掉</p>
</blockquote>
<h2 data-id="heading-8">2. 指定包管理工具</h2>
<p>包管理工具 packageManager (PM)</p>
<p>当看见项目中关于npm,pnpm,yarn包管理工具的配置都存在时，我一脸蒙，不知道应该用哪一个包管理工具，此时明确指定包管理工具才是预期，那么如何指定呢？</p>
<h3 data-id="heading-9">2.1. 约束</h3>
<p>目的：开发者可以从项目配置获取到可以使用哪个包管理工具，以及使用了不符合的 node 版本时 error</p>
<h4 data-id="heading-10">步骤一：package.json -&gt; packageManager（声明 软提醒）</h4>
<p>比如指定 pnpm</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"packageManager"</span>: <span class="hljs-string">"pnpm@10.18.3"</span>
}
</code></pre>
<h4 data-id="heading-11">步骤二： <code>only-allow</code>（强制）</h4>
<p><code>npx only-allow pnpm</code>,<code>npx only-allow npm</code>,<code>npx only-allow yarn</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"preinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx only-allow pnpm"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>如果有其他脚本，建议把这个放在前面 <code>npx only-allow pnpm &amp;&amp; node scripts/check-node.js</code>，此时再用<code>pnpm</code>外的包管理工具可就不行了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fc8e0eba34041599f689507cc0f46ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=RWKm06vZW3T3EHPrQkcWM5QPrvM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">步骤三：脚本约束（最终防线 可选）</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">const</span> userAgent = process.env.npm_config_user_agent || <span class="hljs-comment">'';</span>
<span class="hljs-keyword">if</span> (!userAgent.includes(<span class="hljs-comment">'pnpm')) {</span>
  console.<span class="hljs-keyword">error</span>(<span class="hljs-comment">'❌ 请使用 pnpm 安装依赖');</span>
  console.<span class="hljs-keyword">error</span>(<span class="hljs-comment">'💡 运行: corepack enable &amp;&amp; pnpm install');</span>
  process.<span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>

<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"preinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx only-allow pnpm &amp;&amp; node scripts/check-node.js"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>暂时用<code>"preinstall": "node scripts/check-node.js"</code>查看报错：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ac5dd23ffdd4f6a9cc329bbaa88f82e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=ZXcOZtCKaR2ss35m7%2F1JiH2%2BlKk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">2.2. 包管理工具切换辅助 ❌</h3>
<p>我们没法辅助开发者切换npm/ pnpm /yarn,因为他们本来就不是项目级工具，而是系统级工具，开发者想用哪个用哪个（他尽管用，我们在约束环节已经拦截）</p>
<h2 data-id="heading-14">3. 指定包管理工具版本</h2>
<h3 data-id="heading-15">3.1. 约束</h3>
<h4 data-id="heading-16">3.1.1. npm 专有约束</h4>
<p>1️⃣ <code>package.json#npm</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18 &lt;21"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"npm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"11.7.0"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>2️⃣ <code>.npmrc</code></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">engine-strict</span>=<span class="hljs-literal">true</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bde5ae5d44de497ba633c28926af08ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=RQeVDGakKRrfMxBEp3FcXk9YjmM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-17">3.1.2. pnpm 专有约束</h4>
<p>1️⃣ package.json (声明）</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18 &lt;21"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"pnpm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"9.1.1"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2322f7aa14cc4050a98d22499058cf5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=ZNxaTgxeJL27MaR9StBduv1fJmw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-18">3.1.3. 共享约束：脚本约束</h4>
<p>三个PM都可以用的约束，以 pnpm@10.28.2 为例</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> semver <span class="hljs-keyword">from</span> <span class="hljs-string">'semver'</span>;
<span class="hljs-keyword">import</span> { execSync } <span class="hljs-keyword">from</span> <span class="hljs-string">'child_process'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">REQUIRED</span> = <span class="hljs-string">'10.28.2'</span>;

<span class="hljs-keyword">const</span> current = <span class="hljs-title function_">execSync</span>(<span class="hljs-string">'pnpm -v'</span>).<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

<span class="hljs-keyword">if</span> (!semver.<span class="hljs-title function_">eq</span>(current, <span class="hljs-variable constant_">REQUIRED</span>)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`
❌ pnpm 版本不符合要求

当前版本: <span class="hljs-subst">${current}</span>
要求版本: <span class="hljs-subst">${REQUIRED}</span>
`</span>);
  process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-19">3.2. 包管理工具版本辅助切换</h3>
<h4 data-id="heading-20">3.2.1. pnpm 自身的版本管理</h4>
<pre><code class="hljs language-perl" lang="perl"> {
    <span class="hljs-string">"packageManager"</span>: <span class="hljs-string">"pnpm@10.28.0"</span>,
 }
</code></pre>
<p>pnpm 触发时，检查 <code>packageManager</code>字段，如果发现不一致会尝试下载并切换到<code>packageManager</code>指定的版本</p>
<h4 data-id="heading-21">3.2.2. yarn 依赖 <code>packageManager</code>+<code>corepack</code></h4>
<p>1️⃣ <code>corepack enable</code></p>
<p>Node.js 版本 ≥ 16.9 &lt;25 自带<code>corepack</code>，没有则先安装<code>corepack</code></p>
<p>2️⃣ 提供PM信息</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"packageManager"</span>: <span class="hljs-string">"yarn@1.22.20"</span>,
}
</code></pre>
<p>3️⃣ 自动切换</p>
<p>使用PM时，<code>corepack</code>会读<code>packageManager</code>如果发现版本不一致，触发自动下载</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0711158a1192428fa174b1afea1eb8d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ2FycnkzNDU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159477&amp;x-signature=EHREUcuAdvBu0evvdgk3E9WOyFI%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>关于<code>corepack</code>可以解决用什么PM(packageManager 包管理工具)?什么PM 版本？</p>
<p>我持怀疑态度，理由如下</p>
<p><code>corepack</code> 出现的初衷本来就是为了统一PM的版本，而不是统一用户哪一个包版本工具，那都有人说它可以，那尝试一下硬着头皮用。</p>
<p>发现用它来指定PM需要：</p>
<ol>
<li>开发者本地存在<code>corepack</code>或Node.js 版本 ≥ 16.9 &lt;25（自带，也不完全自带，如果是 volta下载的，就不会带），且需要<code>corepack enable</code></li>
<li>无论 packageManager 配置了什么，都不限制 <code>npm install</code></li>
<li>只能限制 <code>corepack</code>下载的包版本工具，但哪个前端开发笔记本不安装几个包管理工具？</li>
</ol>
<p>发现用它来指PM版本也存在问题：</p>
<p>Corepack <strong>不管理 npm,</strong> 配置了<code>npm@10.25.0</code>但是任何版本的npm都会直接执行，不会下载指定版本</p>
<p>结论：❌ 多少有些不可靠，现在能想到的应用场景就只有辅助 yarn 版本切换了</p>
</blockquote>
<p>绕死我了！🙂‍↔️🙂‍↔️🙂‍↔️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跳转传参and接收参数]]></title>    <link>https://juejin.cn/post/7595615310180778038</link>    <guid>https://juejin.cn/post/7595615310180778038</guid>    <pubDate>2026-01-16T09:34:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595615310180778038" data-draft-id="7595502583269392420" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跳转传参and接收参数"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-16T09:34:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怪可爱的地球人"/> <meta itemprop="url" content="https://juejin.cn/user/4387527339288932"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跳转传参and接收参数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4387527339288932/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怪可爱的地球人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:34:59.000Z" title="Fri Jan 16 2026 09:34:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li>route:读取当前路由信息（参数、查询参数、路径等）</li>
<li>router:进行路由跳转操作（push、replace、go等）</li>
</ul>
<ol>
<li>跳转</li>
</ol>
<pre><code class="hljs language-js" lang="js">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()

<span class="hljs-comment">// 跳转到指定路径</span>
router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/dashboard'</span>)

<span class="hljs-comment">// 带参数跳转</span>
router.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'/dashboard'</span>, <span class="hljs-attr">query</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">'123'</span> } })

<span class="hljs-comment">// 命名路由跳转</span>
router.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'dashboard'</span>, <span class="hljs-attr">params</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">'123'</span> } })

<span class="hljs-comment">// 替换当前路由</span>
router.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'/dashboard'</span>)

<span class="hljs-comment">// 前进/后退</span>
router.<span class="hljs-title function_">go</span>(<span class="hljs-number">1</span>)
router.<span class="hljs-title function_">go</span>(-<span class="hljs-number">1</span>)
&lt;/script&gt;
</code></pre>
<ol start="2">
<li>读取：</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span>直接访问queryd对象

<span class="hljs-keyword">import</span> { useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">userRouter</span>()

<span class="hljs-keyword">const</span> id = route.<span class="hljs-property">query</span>.<span class="hljs-property">id</span>

<span class="hljs-number">2.</span>使用computed响应式获取

<span class="hljs-keyword">import</span> { useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">import</span> { conputed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">userRouter</span>()

<span class="hljs-keyword">const</span> userId = <span class="hljs-title function_">computed</span>(<span class="hljs-function">()=&gt;</span>route.<span class="hljs-property">query</span>.<span class="hljs-property">id</span>)

<span class="hljs-number">3.</span>获取多个参数

<span class="hljs-keyword">import</span> { useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">userRouter</span>()

<span class="hljs-keyword">const</span> { id,name,type } = route.<span class="hljs-property">query</span>

<span class="hljs-number">4.</span>在页面中的生命周期里面接收参数

<span class="hljs-keyword">import</span> { onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">import</span> { useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">userRouter</span>()

<span class="hljs-comment">//生命周期中的挂载后（最常用）</span>

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">()=&gt;</span>{

<span class="hljs-keyword">const</span> id = route.<span class="hljs-property">quert</span>.<span class="hljs-property">id</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"id"</span>,id)

})

<span class="hljs-number">5.</span>监听路由参数变化

<span class="hljs-keyword">import</span> { watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">import</span> {useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>()

<span class="hljs-comment">//监听query参数变化</span>

<span class="hljs-title function_">watch</span>(

<span class="hljs-function">()=&gt;</span>route.<span class="hljs-property">query</span>.<span class="hljs-property">id</span>,

<span class="hljs-function">(<span class="hljs-params">newId,oldId</span>)=&gt;</span>{

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(阐述变化：<span class="hljs-string">',oldId,'</span>-&gt;<span class="hljs-string">',newId)

})

//监听所有query参数变化

watch(()=&gt;route.query,

(newQuery)=&gt;{

console.log('</span>所有参数变化<span class="hljs-string">'，newQuery)

},

{deep:true}

)

6.在模板中直接使用
&lt;div&gt;ID:{{$route.query.id}}&lt;/div&gt;

7.类型安全的方式

import { useRoute } from '</span>vue-router<span class="hljs-string">'

import { conputed } from '</span>vue<span class="hljs-string">'

const route = userRouter()

const query = computed(()=&gt;route.query.id as string | undefined)

if(query.value){
console.log('</span><span class="hljs-variable constant_">ID</span><span class="hljs-string">',queryId.value)
}

8.实际应用写在onMounted里面

</span></code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[没有源码的情况下，iOS 应用还能怎么做加密与保护]]></title>    <link>https://juejin.cn/post/7595837635569516596</link>    <guid>https://juejin.cn/post/7595837635569516596</guid>    <pubDate>2026-01-16T09:48:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595837635569516596" data-draft-id="7595755710733418511" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="没有源码的情况下，iOS 应用还能怎么做加密与保护"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T09:48:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是谁的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2390811467846089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            没有源码的情况下，iOS 应用还能怎么做加密与保护
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2390811467846089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是谁的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:48:02.000Z" title="Fri Jan 16 2026 09:48:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在理想情况下，安全相关的事情都应该发生在源码阶段。
但现实项目里，经常会遇到一个并不“理想”的前提：<strong>手里只有 IPA，没有源码</strong>。</p>
<p>我第一次面对这个问题，是在一个已经上线的商业 App 上。项目并不是我最初参与开发的，能拿到的交付物只有已签名的安装包。那段时间讨论最多的一个问题是<strong>在这种前提下，还能不能做点什么，而不是完全放弃安全？</strong></p>
<hr/>
<h3 data-id="heading-0"><strong>没有源码并不等于完全无法处理</strong></h3>
<p>很多人听到没有源码这四个字，会直接把后面的可能性全部否定。
但站在项目角度看，IPA 本身就是一个完整的产物，里面包含了：</p>
<ul>
<li>可执行二进制</li>
<li>符号信息</li>
<li>资源文件</li>
<li>配置与结构</li>
</ul>
<p>无法做的，是源码级逻辑调整；
还能做的，是<strong>对现有结构进行再加工</strong>。</p>
<p>这两者的目标本来就不完全相同。</p>
<hr/>
<h3 data-id="heading-1"><strong>没有源码时，加密的重点要重新理解</strong></h3>
<p>如果把“加密”理解为算法级保护，那确实很难实现。
但在实际项目里，更现实的目标往往是：</p>
<ul>
<li>增加分析成本</li>
<li>延缓逆向时间</li>
<li>防止资源被直接复用</li>
<li>避免关键符号一眼可读</li>
</ul>
<p>在这种语境下，加密、混淆、清理信息，往往是一起出现的。</p>
<hr/>
<h3 data-id="heading-2"><strong>常见的几种可行手段，以及它们的边界</strong></h3>
<p>在没有源码的前提下，我实际尝试过的方案大致有几类：</p>
<ul>
<li><strong>符号级混淆</strong>：破坏类名、方法名、变量名的可读性</li>
<li><strong>资源处理</strong>：重命名资源、修改校验值，防止直接替换</li>
<li><strong>调试信息清理</strong>：减少可利用信息</li>
<li><strong>重新签名与验证</strong>：确保处理后的包仍可正常运行</li>
</ul>
<p>这些手段单独看都不“神秘”，关键在于<strong>如何组合使用</strong>。</p>
<hr/>
<h3 data-id="heading-3"><strong>为什么 IPA 层工具在这个场景下反而合适</strong></h3>
<p>在多个项目里，最终采用的思路都是：
<strong>不去模拟源码阶段能做的事，而是接受 IPA 阶段的能力边界。</strong></p>
<p>这类工具的优势也很明确：</p>
<ul>
<li>不需要项目工程</li>
<li>不依赖构建环境</li>
<li>对历史版本友好</li>
<li>适合补救与加固</li>
</ul>
<p>在这个阶段，我开始使用 <strong>Ipa Guard</strong> 来承担主要的处理工作。</p>
<hr/>
<h3 data-id="heading-4"><strong>基于 Ipa Guard 的一套实际操作路径</strong></h3>
<p>以下流程并不是标准答案，而是反复调整后的结果。</p>
<h4 data-id="heading-5"><strong>从 IPA 入手，而不是想太多源码细节</strong></h4>
<p>加载 IPA 后，第一步不是急着混淆，而是确认：</p>
<ul>
<li>可执行文件是否正确</li>
<li>是否包含多个二进制</li>
<li>资源结构是否清晰</li>
</ul>
<p>这一步的目的是避免“处理错目标”，尤其是在复杂项目中。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6128045d7b39441084f12d6a4107065a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161681&amp;x-signature=HQYHEImEXcgyeYHToNdRxsF3z4s%3D" alt="加载ipa" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-6"><strong>在代码层，只处理“值得处理的部分”</strong></h4>
<p>Ipa Guard 提供了对 OC / Swift 类、方法、参数、变量的混淆能力。
在没有源码的情况下，我通常会：</p>
<ul>
<li>通过名称和模块判断业务相关性</li>
<li>避开系统类和明显的第三方 SDK</li>
<li>控制混淆强度，避免影响运行稳定性</li>
</ul>
<p>混淆后的符号变成无意义字符串，对静态分析的干扰非常直接。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8d148ba65a346a78c5bc16fab482c5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161681&amp;x-signature=J5pSxwgkrJb3u%2BHz7UhQwyuRtDg%3D" alt="代码混淆" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-7"><strong>资源层的处理，往往比预期更重要</strong></h4>
<p>很多人低估了资源层的价值。
实际上，在不少应用中，业务线索反而藏在：</p>
<ul>
<li>JSON 配置</li>
<li>HTML / JS</li>
<li>图片命名规则</li>
</ul>
<p>通过对这些资源进行重命名、修改 MD5，能明显降低被直接复用的可能性。
Ipa Guard 在这一步的操作比较直观，也更容易验证效果。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a6471a9aea5485fa6586b57be143802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161681&amp;x-signature=8o04JiItGxa6LjfQp2MGMPbQNWU%3D" alt="文件混淆" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-8"><strong>清理调试信息，是顺手但必要的一步</strong></h4>
<p>即使不追求极致安全，清理调试信息也是值得做的事情。
它并不会改变功能，却能减少很多“现成线索”。</p>
<p>在没有源码的场景下，这一步的性价比其实很高。</p>
<hr/>
<h4 data-id="heading-9"><strong>重签名与测试，决定这套方案是否可用</strong></h4>
<p>处理完成后，需要重新配置证书并安装测试。
我通常会优先验证：</p>
<ul>
<li>启动是否正常</li>
<li>核心页面是否可用</li>
<li>是否存在资源加载异常</li>
</ul>
<p>确认无误后，保存配置，后续版本可以直接复用这一套流程。</p>
<hr/>
<h3 data-id="heading-10"><strong>多工具组合，而不是把希望压在单点上</strong></h3>
<p>需要强调的是，这类 IPA 处理工具并不适合“单独承担所有安全责任”。
在项目中，我通常会配合：</p>
<ul>
<li>服务端校验</li>
<li>接口签名</li>
<li>简单的完整性检测</li>
</ul>
<p>这样做的目的，是把风险分散到不同层面，而不是集中在某一个点。</p>
<hr/>
<h3 data-id="heading-11"><strong>哪些场景下，这种方式比较合适</strong></h3>
<p>从经验来看，这种“无源码加密”的思路更适合：</p>
<ul>
<li>外包或合作项目的后期保护</li>
<li>历史 App 的安全补救</li>
<li>多平台混合项目</li>
<li>对源码外泄高度敏感的团队</li>
</ul>
<p>如果期望的是“绝对不可破解”，那一开始就不在同一个讨论范围内。</p>
<hr/>
<p>没有源码并不意味着只能被动接受风险。
在 IPA 层做加密与混淆，更像是一种工程上的妥协，不追求完美，但尽量让事情变得不那么容易。</p>
<p>参考链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fipaguard.com%2Ftutorial%2Fzh%2F1%2F1.html" target="_blank" title="https://ipaguard.com/tutorial/zh/1/1.html" ref="nofollow noopener noreferrer">ipaguard.com/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小程序增加用户协议]]></title>    <link>https://juejin.cn/post/7595771085394165811</link>    <guid>https://juejin.cn/post/7595771085394165811</guid>    <pubDate>2026-01-16T09:55:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595771085394165811" data-draft-id="7595774188909821990" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小程序增加用户协议"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-16T09:55:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一涯"/> <meta itemprop="url" content="https://juejin.cn/user/1275089219491213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小程序增加用户协议
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1275089219491213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一涯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:55:57.000Z" title="Fri Jan 16 2026 09:55:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    21
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><pre><code class="hljs language-js" lang="js">在小程序中增加一个用户协议
</code></pre>
<h2 data-id="heading-0">1.开发用户协议页面</h2>
<p>在一个内部网站上开发一个用户协议的页面。</p>
<h2 data-id="heading-1">2.在小程序开发者后台添加业务域名</h2>
<p>添加的时候，会给一个验证码文件。下载下来。</p>
<h2 data-id="heading-2">3. 将验证码文件放在用户协议所在网站的根目录</h2>
<h2 data-id="heading-3">4. 在小程序中使用webview加载网页链接</h2>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"settings-page"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"list-card"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">view</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"list-item"</span>
        @<span class="hljs-attr">tap</span>=<span class="hljs-string">"openPage(userAgreementUrl)"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>用户协议<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"arrow"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span></span>
  &lt;view&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-view</span>
        <span class="hljs-attr">v-if</span>=<span class="hljs-string">"userAgreementUrl"</span>
        <span class="hljs-attr">:src</span>=<span class="hljs-string">"userAgreementUrl"</span>
    &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">web-view</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Taro</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@tarojs/taro'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">USER_AGREEMENT_URL</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/config/legal'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'settings-page'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">userAgreementUrl</span>: <span class="hljs-variable constant_">USER_AGREEMENT_URL</span>,
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">openPage</span>(<span class="hljs-params">url</span>) {
      <span class="hljs-keyword">if</span> (!url) {
        <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">showToast</span>({
          <span class="hljs-attr">title</span>: <span class="hljs-string">'链接未配置'</span>,
          <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>
        })
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-keyword">const</span> target = <span class="hljs-built_in">encodeURIComponent</span>(url)
      <span class="hljs-title class_">Taro</span>.<span class="hljs-title function_">navigateTo</span>({
        <span class="hljs-attr">url</span>: <span class="hljs-string">`/pages/webview/webview?url=<span class="hljs-subst">${target}</span>`</span>
      })
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>其中legal文件代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">USER_AGREEMENT_URL</span> = <span class="hljs-string">'https:/XXXXXXX/privacy/user.html'</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[绘制K线第四章：滚动优化]]></title>    <link>https://juejin.cn/post/7595615310181040182</link>    <guid>https://juejin.cn/post/7595615310181040182</guid>    <pubDate>2026-01-16T10:10:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595615310181040182" data-draft-id="7595502583269474340" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="绘制K线第四章：滚动优化"/> <meta itemprop="keywords" content="前端,架构,Android"/> <meta itemprop="datePublished" content="2026-01-16T10:10:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="佛系打工仔"/> <meta itemprop="url" content="https://juejin.cn/user/3227821867282167"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            绘制K线第四章：滚动优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821867282167/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    佛系打工仔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T10:10:27.000Z" title="Fri Jan 16 2026 10:10:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">滚动优化</h2>
<p>在第三章的基础上，我们发现 Case4 的拖拽功能存在一个问题：只能整根整根地绘制K线，拖拽体验不够平滑。本章介绍如何通过 <code>canvas.translate()</code> 实现像素级滚动来解决这个问题。</p>
<h3 data-id="heading-1">一、问题分析</h3>
<h4 data-id="heading-2">Case4 的问题</h4>
<p>Case4 在计算可见区间时，使用了以下逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">scrollIndex</span> = (scroll<span class="hljs-literal">Off</span>set / totalCandleWidth).toInt()  // 转换为K线索引偏移
val <span class="hljs-attr">startIndex</span> = (baseStartIndex - scrollIndex).coerceIn(...)
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li><code>scrollIndex</code> 是通过 <code>toInt()</code> 转换的，只能按整根K线计算</li>
<li>拖拽时，K线只能整根整根地移动，无法显示半根K线</li>
<li>拖拽体验不够平滑，感觉"卡顿"</li>
</ul>
<h4 data-id="heading-3">Case4 的绘制方式</h4>
<p>Case4 在绘制每根K线时，需要手动计算X坐标并加上 <code>pixelOffset</code>：</p>
<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">centerX</span> = index * totalCandleWidth + config.candleWidth / <span class="hljs-number">2</span> + <span class="hljs-literal">off</span>setX
</code></pre>
<p>这种方式存在以下问题：</p>
<ol>
<li><strong>代码复杂</strong>：每根K线都需要单独计算X坐标</li>
<li><strong>可见区间计算不精确</strong>：只能按整根K线计算可见范围</li>
<li><strong>边界处理复杂</strong>：需要处理半根K线的显示问题</li>
</ol>
<h3 data-id="heading-4">二、解决方案：使用 canvas.translate()</h3>
<h4 data-id="heading-5">canvas.translate() 的原理</h4>
<p><code>canvas.translate()</code> 是 Android Canvas 提供的一个坐标系变换方法，用于平移整个坐标系。</p>
<p><strong>工作原理</strong>：</p>
<ol>
<li><strong>保存画布状态</strong>：<code>canvas.save()</code> 保存当前的变换矩阵</li>
<li><strong>平移坐标系</strong>：<code>canvas.translate(dx, dy)</code> 将整个坐标系平移 (dx, dy)</li>
<li><strong>绘制内容</strong>：在平移后的坐标系中绘制，所有坐标都会自动偏移</li>
<li><strong>恢复画布状态</strong>：<code>canvas.restore()</code> 恢复之前的变换矩阵</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.save</span>()
<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.translate</span>(-<span class="hljs-number">100</span>f, <span class="hljs-number">0</span>f)  <span class="hljs-comment">// 将坐标系向左平移100像素</span>
<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawRect</span>(<span class="hljs-number">0</span>f, <span class="hljs-number">0</span>f, <span class="hljs-number">50</span>f, <span class="hljs-number">50</span>f, paint)  <span class="hljs-comment">// 实际绘制在屏幕的 (-100, 0) 位置（会被裁剪）</span>
<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.restore</span>()
<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.drawRect</span>(<span class="hljs-number">0</span>f, <span class="hljs-number">0</span>f, <span class="hljs-number">50</span>f, <span class="hljs-number">50</span>f, paint)  <span class="hljs-comment">// 实际绘制在屏幕的 (0, 0) 位置</span>
</code></pre>
<h4 data-id="heading-6">为什么 translate() 能实现半根K线？</h4>
<p><strong>关键理解</strong>：translate() 平移的是坐标系，而不是画布本身。Canvas 会自动裁剪超出屏幕的部分。</p>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>坐标系平移</strong>：<code>canvas.translate(translateX, 0f)</code> 平移坐标系</li>
<li><strong>基于像素计算可见范围</strong>：</li>
</ol>

<pre><code class="hljs language-ini" lang="ini">val <span class="hljs-attr">leftLogicalX</span> = -translateX      // 屏幕左边界在逻辑坐标系中的位置
val <span class="hljs-attr">rightLogicalX</span> = -translateX + width  // 屏幕右边界在逻辑坐标系中的位置
</code></pre>
<p>3.  <strong>Canvas 自动裁剪</strong>：如果K线的一部分在屏幕外，Canvas 会自动裁剪，实现"半根K线"的效果</p>
<h3 data-id="heading-7">三、核心实现</h3>
<h4 data-id="heading-8">1. 计算 translateX（坐标系平移量）</h4>
<p><strong>核心思想</strong>：</p>
<ul>
<li><code>scrollX = 0</code> 时：最后一根K线的右边界对齐屏幕右边界</li>
<li><code>scrollX = minScrollX</code> 时：第一根K线的左边界对齐屏幕左边界</li>
</ul>
<p><strong>计算方式</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculateTranslateX</span><span class="hljs-params">(screenWidth: <span class="hljs-type">Float</span>, totalCandleWidth: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
    <span class="hljs-keyword">val</span> minScrollX = getMinScrollX()
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (minScrollX &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 线性映射：scrollX 从 0 到 minScrollX，translateX 从 minTranslateX 到 maxTranslateX</span>
        <span class="hljs-keyword">val</span> minTranslateX = screenWidth - klineData.size * totalCandleWidth
        <span class="hljs-keyword">val</span> maxTranslateX = <span class="hljs-number">0f</span>
        (scrollX / minScrollX) * (maxTranslateX - minTranslateX) + minTranslateX
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 数据总宽度小于等于屏幕宽度，不需要滚动，从左往右绘制</span>
        <span class="hljs-comment">// 第一根K线的左边界对齐屏幕左边界</span>
        <span class="hljs-number">0f</span>
    }
}
</code></pre>
<p><strong>计算说明</strong>：</p>
<ul>
<li><code>minTranslateX = screenWidth - klineData.size * totalCandleWidth</code>：让最后一根K线的右边界对齐屏幕右边界</li>
<li><code>maxTranslateX = 0f</code>：让第一根K线的左边界对齐屏幕左边界</li>
<li>使用线性映射：<code>translateX = (scrollX / minScrollX) * (maxTranslateX - minTranslateX) + minTranslateX</code></li>
<li>当数据总宽度小于等于屏幕宽度时，<code>translateX = 0f</code>，从左往右绘制</li>
</ul>
<h4 data-id="heading-9">2. 平移坐标系并计算可见范围</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 平移坐标系</span>
<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.save</span>()
<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.translate</span>(translateX, <span class="hljs-number">0</span>f)  <span class="hljs-comment">// 向左平移 translateX 像素（translateX 为负值）</span>

<span class="hljs-comment">// 计算可见范围</span>
val leftLogicalX = -translateX      <span class="hljs-comment">// 屏幕左边界在逻辑坐标系中的位置</span>
val rightLogicalX = -translateX + <span class="hljs-attribute">width</span>  <span class="hljs-comment">// 屏幕右边界在逻辑坐标系中的位置</span>

<span class="hljs-comment">// 转换为K线索引</span>
val firstVisibleIndex = (leftLogicalX / totalCandleWidth)<span class="hljs-selector-class">.toInt</span>()
    <span class="hljs-selector-class">.coerceAtLeast</span>(<span class="hljs-number">0</span>)
    <span class="hljs-selector-class">.coerceAtMost</span>(klineData.size - <span class="hljs-number">1</span>)
val lastVisibleIndex = kotlin<span class="hljs-selector-class">.math</span><span class="hljs-selector-class">.ceil</span>(rightLogicalX / totalCandleWidth)<span class="hljs-selector-class">.toInt</span>()
    <span class="hljs-selector-class">.coerceAtMost</span>(klineData.size - <span class="hljs-number">1</span>)
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>右边界使用 <code>ceil</code> 向上取整，确保包含部分可见的K线</li>
<li>这样就能实现半根K线的显示效果</li>
</ul>
<h4 data-id="heading-10">3. 绘制K线</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 获取可见数据并计算价格范围</span>
val visibleData = klineData<span class="hljs-selector-class">.subList</span>(firstVisibleIndex, lastVisibleIndex + <span class="hljs-number">1</span>)
val (minPrice, maxPrice) = <span class="hljs-built_in">calculatePriceRange</span>(visibleData)

<span class="hljs-comment">// 绘制K线（使用固定逻辑坐标）</span>
visibleData<span class="hljs-selector-class">.forEachIndexed</span> { relativeIndex, entity -&gt;
    <span class="hljs-built_in">drawCandle</span>(canvas, entity, firstVisibleIndex + relativeIndex, minPrice, maxPrice, height)
}

<span class="hljs-selector-tag">canvas</span><span class="hljs-selector-class">.restore</span>()

<span class="hljs-comment">// 绘制网格和标签（在屏幕坐标系中）</span>
<span class="hljs-built_in">drawBackgroundGrid</span>(canvas, width, height)
<span class="hljs-built_in">drawPriceLabels</span>(canvas, minPrice, maxPrice, height, width)
<span class="hljs-built_in">drawTimeLabels</span>(canvas, visibleData, translateX, width, height)
</code></pre>
<p><strong>drawCandle 方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawCandle</span><span class="hljs-params">(
    canvas: <span class="hljs-type">Canvas</span>,
    entity: <span class="hljs-type">KLineEntity</span>,
    index: <span class="hljs-type">Int</span>,
    minPrice: <span class="hljs-type">Float</span>,
    maxPrice: <span class="hljs-type">Float</span>,
    height: <span class="hljs-type">Float</span>
)</span></span> {
    <span class="hljs-comment">// 计算X坐标（基于索引，在逻辑坐标系中）</span>
    <span class="hljs-keyword">val</span> totalCandleWidth = config.getTotalCandleWidth()
    <span class="hljs-keyword">val</span> centerX = index * totalCandleWidth + totalCandleWidth / <span class="hljs-number">2</span>
    <span class="hljs-comment">// ... 绘制K线</span>
}
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>每根K线的X坐标基于原始索引计算，是固定值</li>
<li>通过 <code>canvas.translate()</code> 平移坐标系，K线会自动移动到正确位置</li>
<li><code>canvas.restore()</code> 后绘制网格和标签，使用屏幕坐标系</li>
</ul>
<h3 data-id="heading-11">四、Case4 与 Case5 的区别</h3>



































<table><thead><tr><th>功能</th><th>Case4</th><th>Case5</th></tr></thead><tbody><tr><td>可见区间计算</td><td>按整根K线计算</td><td>按像素计算</td></tr><tr><td>支持半根K线</td><td>❌</td><td>✅</td></tr><tr><td>X坐标计算</td><td>手动计算 + offsetX</td><td>固定索引，通过 translate 平移</td></tr><tr><td>拖拽平滑度</td><td>一般</td><td>非常平滑</td></tr><tr><td>代码复杂度</td><td>较高</td><td>较低</td></tr></tbody></table>
<h3 data-id="heading-12">五、优势总结</h3>
<ol>
<li><strong>代码更简洁</strong>：不需要为每根K线单独计算X坐标偏移</li>
<li><strong>逻辑更清晰</strong>：K线的X坐标基于固定索引，通过坐标系变换实现滚动</li>
<li><strong>支持像素级精度</strong>：<code>translateX</code> 可以是任意像素值，K线会精确移动</li>
<li><strong>自动处理边界</strong>：半根K线会自动显示在正确位置，不需要额外的边界处理逻辑</li>
</ol>
<h3 data-id="heading-13">六： 效果</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a986bf380a943ea892e5b7d1ecdeff2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L2b57O75omT5bel5LuU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769163224&amp;x-signature=ioEDpJBv%2BYERCVbxSh3Tvzsk3YA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">系列</h3>
<ul>
<li><a href="https://juejin.cn/post/7594627998839701546" target="_blank" title="https://juejin.cn/post/7594627998839701546">K线绘制前言</a></li>
<li><a href="https://juejin.cn/post/7594533204003127359" target="_blank" title="https://juejin.cn/post/7594533204003127359">绘制K线入门</a></li>
<li><a href="https://juejin.cn/post/7594523145211117622" target="_blank" title="https://juejin.cn/post/7594523145211117622">绘制K线第一章：可见区间处理</a></li>
<li><a href="https://juejin.cn/post/7594642978696495167" target="_blank" title="https://juejin.cn/post/7594642978696495167">绘制K线第二章：背景网格绘制</a></li>
<li><a href="https://juejin.cn/post/7594854295758061611" target="_blank" title="https://juejin.cn/post/7594854295758061611">绘制K线第三章：拖拽功能实现</a></li>
<li><a href="https://juejin.cn/spost/7595615310181040182" target="_blank" title="https://juejin.cn/spost/7595615310181040182">绘制K线第四章：滚动优化</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SFT/DPO/PPO/GRPO/RLHF 等对齐方法总结-初版]]></title>    <link>https://juejin.cn/post/7595615310181056566</link>    <guid>https://juejin.cn/post/7595615310181056566</guid>    <pubDate>2026-01-16T10:19:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595615310181056566" data-draft-id="7595552420048240683" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SFT/DPO/PPO/GRPO/RLHF 等对齐方法总结-初版"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2026-01-16T10:19:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="矮人三等"/> <meta itemprop="url" content="https://juejin.cn/user/4350105576808472"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SFT/DPO/PPO/GRPO/RLHF 等对齐方法总结-初版
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4350105576808472/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    矮人三等
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T10:19:06.000Z" title="Fri Jan 16 2026 10:19:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<ol>
<li>文中的公式比较粗糙，建议看原版公式，此处公式仅作为个人理解使用的简化版</li>
</ol>
<h3 data-id="heading-1">1 SFT（Supervised Fine - Tuning，监督微调）</h3>
<ol>
<li>
<p>SFT 是在预训练大模型基础上，用高质量标注的输入 - 输出对数据进一步训练模型，使其适配特定任务、遵循人类指令并生成符合预期响应的核心技术，是大模型从通用能力到场景化对齐的关键一步。</p>
</li>
<li>
<p><strong>最基础的微调，目标是“让模型生成符合指令的回答”，强调准确</strong></p>
</li>
<li>
<p>SFT 和微调方法的区别：SFT 是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FLian_Ge_Blog%2Farticle%2Fdetails%2F156489537%3Fspm%3D1001.2014.3001.5501" target="_blank" title="https://blog.csdn.net/Lian_Ge_Blog/article/details/156489537?spm=1001.2014.3001.5501" ref="nofollow noopener noreferrer">微调</a> “目标和阶段”，LoRA 是实现 SFT 的 “技术手段” 之一</p>
<ol>
<li>SFT ≈ 基础微调方法（LoRA / 全参数 / Prefix-Tuning 等） + SFT 专属数据格式（带角色标识的输入输出对） + SFT 适配训练策略（prompt损失屏蔽 / 低学习率(防止灾难性遗忘) / 生成控制等）
<ol>
<li>基础微调方法是 “工具”，决定了 “用什么方式调参”；</li>
<li>SFT 数据格式是 “原材料”，决定了 “微调学什么内容”；</li>
<li>SFT 训练策略是 “施工规范”，决定了 “怎么调参才不让模型向着预期方向调整”</li>
</ol>
</li>
</ol>
</li>
<li>
<p>SFT 的数据和基础微调方法所用数据的区别：</p>






























<table><thead><tr><th>对比维度</th><th>基础微调数据</th><th>SFT 数据</th></tr></thead><tbody><tr><td>数据目标</td><td>让模型学会 “分类 / 识别 / 简单匹配”</td><td>让模型学会 “理解指令→生成符合人类习惯的自然语言回答”</td></tr><tr><td>文本长度</td><td>短（输入 / 输出多为短句 / 标签）</td><td>长（输入含上下文 / 规则，输出是完整、流畅的自然语言）</td></tr><tr><td>损失计算</td><td>全输入计算损失</td><td>仅计算 assistant（回答）部分的损失（屏蔽 system/user 部分）</td></tr><tr><td>多样性要求</td><td>侧重覆盖任务类别</td><td>侧重覆盖不同指令场景、不同回答风格（符合人类偏好）</td></tr></tbody></table>
</li>
<li>
<p>关于使用不同的微调方法的时候，数据的格式变化：</p>
<ol>
<li>基础微调（文本分类）：“这部电影超好看” → 标签 “正面”</li>
<li>SFT 微调（对话）：<code>&lt;system&gt;你是影评助手&lt;/system&gt;&lt;user&gt;这部电影超好看？&lt;/user&gt;&lt;assistant&gt;看来你很喜欢这部电影呀，能具体说说哪里打动你吗？&lt;/assistant&gt;</code></li>
<li>如果有些微调方法也是在前缀或者提示词入手，那就需要调整下数据格式，确实是会变的复杂一些，所以选择微调方法的原则顺序：
<ol>
<li>原则 1：优先适配数据格式，而非换微调方法</li>
<li>原则 2：如果数据格式极度不规范（如无明确输入输出边界），优先选不需要适配数据格式的方法，如 LoRA</li>
<li>原则 3：所有微调方法的核心适配点都是 “明确输入 / 输出边界”—— 哪怕数据格式乱，只要能区分 “模型该学的输入” 和 “模型该生成的输出”，就能用任何微调方法。</li>
</ol>
</li>
</ol>
</li>
<li>
<p>关于 prompt(其实指的就是 system 和 user 的信息) 损失屏蔽</p>
<ol>
<li>SFT 的核心目标是：让模型看到<code>system+user</code>的指令后，能生成符合预期的<code>assistant</code>回答。如果计算全部文本的损失，会出现两个问题：
<ol>
<li>模型会浪费算力去 “学习重复指令”（比如生成时重复<code>user</code>的问题）；</li>
<li>模型可能学偏：比如把<code>system</code>的规则（“你是医疗助手”）当成回答内容输出，而非遵守规则。</li>
<li>注：因为最终符合人类习惯的输出，是需要调整 assistant 来输出的，并不需要输出 system 提示和 user 的话，只需要回答即可</li>
<li>注：如何只计算 assistant 损失呢？
<ol>
<li>构建一个 “损失掩码（mask）”，让<code>system+user</code>部分的损失被置为 0（不参与梯度更新），只有<code>assistant</code>部分的损失参与计算。</li>
<li>移位预测：大模型是自回归生成，预测第 n 个 token 时用前 n-1 个 token，所以掩码也要对应移位；</li>
<li>最后除以有效 token 数：保证损失值的合理性，避免因有效 token 少导致损失值过大。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>角色标识（system/user/assistant） 是大模型 SFT 特有的，用于区分对话角色和输入输出边界，基础微调不用，因为场景更简单；</p>
</li>
<li>
<p>eos 的核心含义：End of Sequence，即 “序列结束符”</p>
<ol>
<li>eos 是一个特殊的 token（比如 GPT 系列的<code>&lt;|endoftext|&gt;</code>、Llama 的<code>&lt;/s&gt;</code>），作用是告诉模型：“生成到这个 token 就停止，不要再继续输出了”，原因如下
<ol>
<li>避免生成冗余，效果反而不好；</li>
<li>控制算力成本：生成的 token 越多，推理耗时和算力消耗越大；</li>
<li>保证回答聚焦：限制长度能让模型优先输出核心信息，而非无关内容</li>
</ol>
</li>
</ol>
</li>
<li>
<p>实际控制生成结果的参数：</p>
<ol>
<li><code>max_new_tokens</code>：只限制 “新生成的回答部分” 长度，不包含输入的 prompt；</li>
<li><code>eos_token_id</code>：指定终止符的 id，模型生成到这个 token 立即停止；</li>
<li><code>temperature</code>：控制生成的随机性（0.7 是常用值，值越小越确定，越大越多样）。</li>
</ol>
</li>
</ol>
<h3 data-id="heading-2">2 PPO (Proximal Policy Optimization 近端策略优化)</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab91f3610d7142799f88d388d2cb9f23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769163546&amp;x-signature=TQxmHl5qX1vfCOUIcUt1BMpZQzg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>
<p><strong>RLHF的核心环节，目标是“通过强化学习进一步对齐人类偏好”，强调在线调整和精准匹配人类偏好</strong></p>
</li>
<li>
<p>PPO 是一种策略梯度强化学习算法**，技术上的核心目标是解决传统策略梯度 “更新幅度过大导致训练崩溃” 的痛点，兼具**TRPO的稳定性和策略梯度的简洁性，是大模型 RLHF（基于人类反馈的强化学习）流程中的核心优化算法。</p>
<ol>
<li>策略梯度简化公式：ln(π(a|α)) * R，策略α下，生成动作 a (对应的 token)的概率，取对数后乘以激励模型(或者环境打分)的打分
<ol>
<li>相乘类似于"生成意愿" * "回答好坏"，如果 R 很大，生成概率π也很大，ln(π)就会慢慢靠近 0，而这才是损失函数的目标，这样就会让模型“朝着奖励高的方向调整参数”**。
<ol>
<li>注：此处的π是函数不是圆周率π，所以π(a|α)是生成概率，那就是 0&lt; π &lt; 1，log(π)在0-1 之间是递增，且数值小于 0</li>
</ol>
</li>
</ol>
</li>
<li>TRPO(信任域策略优化)：<strong>给策略调整设 “上限”</strong>，规定每次只能在 “信任域” 里小幅度改，确保改完后的策略不会和原来差太远，训练更稳定。
<ol>
<li>简易公式：max(π-n(a | α) /  π-o(a | α)  * R)  新旧策略的比值，乘以奖励打分的最大值
<ol>
<li>限制条件：π-n(a | α) 和π-o(a | α) 新旧策略的KL 散度不能超过 信任域阈值</li>
<li>因为如果还是上面取 log，那如果打分特别大就会导致模型调整过多，纠正过度，使用新旧策略的比值作为<strong>重要性权重</strong>就是为了不让新策略和旧策略变化太多，让训练更平稳</li>
<li>注：但是新旧策略生成 token 概率 KL 散度需要&lt;信任域阈值，这个计算很复杂，所以有了下面的 PPO</li>
<li>注：新策略在下一轮迭代训练后就变成了旧策略</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>
<p>PPO通常是SFT之后的第二步，业务上目标是让<strong>模型生成更符合人类偏好的回答</strong></p>
<ol>
<li>核心思想：通过<strong>裁剪的替代目标函数</strong>限制新策略与旧策略的差异（保持在可控的 “信任域” 内），允许对采样数据进行<strong>多轮小批量更新</strong>，提升样本效率</li>
</ol>
</li>
<li>
<p>核心架构：Actor-Critic + 参考模型 + 奖励模型</p>
<ol>
<li>补：重要性采样：旧策略和新策略用的是同一批数据，旧策略生成的样本，新策略使用的时候需要对数据进行加权(P_n / P_o P 是概率分布，权重就是新旧策略的概率比)</li>
<li>价值模型：<strong>给模型的 “生成行为” 打分</strong>（判断这个回答好不好）
<ol>
<li>单独训练一个小型模型（比如用 BERT / 小尺寸 LLaMA），专门干 “打分” 的活，输入是 “用户问题 + 模型回答”，输出是 0-10 的分数。</li>
<li>Actor 和 Critic 用<strong>同一个预训练模型主干</strong>（比如 LLaMA 7B 的主体部分，本质是隐藏层的输出），只在最后加一个不同的 “输出层”：Actor 的输出层是 “生成 token 的概率”(logits 经过 softmax 的值)，Critic 的输出层是 “标量分数”。</li>
<li>目标：让模型算准 “平均奖励”</li>
<li>共享主干并不是说这俩模型是一个模型干两件事，只是共享主干，然后接入不同下游，价值模型需要和奖励模型配合才能模拟出来"平均奖励"</li>
</ol>
</li>
</ol>






























<table><thead><tr><th>模型</th><th>作用</th><th>实现方式</th></tr></thead><tbody><tr><td>Actor（策略模型）</td><td>生成回答（动作），优化目标是最大化累积奖励</td><td>通常是使用 LoRA方法SFT 微调后的预训练模型（低秩微调，降低算力成本）</td></tr><tr><td>Critic（价值模型）</td><td>估计状态（文本上下文）的价值，计算优势函数（Advantage）</td><td>可以是独立的小型模型，或与 Actor 共享主干（更高效）</td></tr><tr><td>Reference Model（参考模型）</td><td>计算新策略与原始 SFT 策略的 KL 散度（防止模型偏离能力，旧策略）</td><td>固定的 SFT 模型（不参与训练）</td></tr><tr><td>Reward Model（奖励模型）</td><td>对 Actor 生成的回答打分，提供人类偏好反馈信号</td><td>独立训练的模型，输入为 “prompt + 回答”，输出为标量分数</td></tr></tbody></table>
</li>
<li>
<p>裁剪损失简化公式：L_clip =  min(R_t * R , R_clip * R)，(真实情况是用的 A^t 而不是 R)其中 R_t 就是上面 TRPO 中的重要性权重(新旧策略概率比)，R_clip 是权重裁剪后的结果：R_clip = max(min(Rt,1+ϵ), 1−ϵ)，这样依然可以实现限制损失，控制更新幅度，计算量小很多</p>
</li>
<li>
<p>新旧策略的 KL 散度通俗讲就是：旧策略（比如 SFT 后的模型）和新策略（PPO 训练中的模型），分别对同一个用户问题生成回答，输出每个 token 的<strong>生成概率</strong>，KL 散度就是把两个策略的 “token 概率分布” 做对比，算出一个数值，代表两者的 “差异度”</p>
</li>
<li>
<p>优势估计（Advantage Estimation）</p>
<ol>
<li>目的：衡量当前动作比 “平均期望” 好多少，是策略梯度的核心信号</li>
<li>常用<strong>GAE（广义优势估计）</strong>：平衡高方差和高偏差
<ol>
<li>核心作用是：<strong>综合 “短期奖励” 和 “长期奖励”，准确判断模型的一个 “生成动作” 到底好不好</strong>。</li>
<li>下方的 A^t 是单步优势值，GAE 计算是长期的，优化过的优势值</li>
</ol>
</li>
</ol>
</li>
<li>
<p>完整 PPO 损失函数：L = L_clip - c1 * L_vf + c2 * L_kl</p>
</li>
<li>
<p>完整步骤：PPO 训练是一个<strong>迭代优化过程</strong>，每一轮都包含以下五个步骤：</p>
<ol>
<li>样本采集：Actor（新策略）和 Reference Model（旧策略）对一批 prompt 生成回答，记录 “prompt + 回答 + 旧策略概率”</li>
<li>奖励计算：
<ol>
<li>Reward Model 对每个回答打分，得到基础奖励 R，使用价值模型得到预估平均奖励 V
<ol>
<li>优势值 A^t = R - V</li>
</ol>
</li>
</ol>
</li>
<li>计算裁剪损失：L_clip =  min(R_t * A^t , R_clip * A^t)</li>
<li>计算价值损失： L_vf = (V - R )^2</li>
<li>计算新策略与 Reference Model 的 KL 散度（作为惩罚项,可选）</li>
</ol>
</li>
</ol>
<h2 data-id="heading-3">3 DPO(Direct Preference Optimization)</h2>
<ol>
<li>PO 系列：<strong>进阶微调，目标是“让模型生成符合人类偏好的回答，简单对齐，离线调整”</strong></li>
<li>核心特点是<strong>无需额外训练奖励模型（RM）和价值模型（Critic）</strong>，仅通过<strong>SFT 后的模型</strong>和<strong>人类偏好对数据</strong>即可完成优化，兼具<strong>简单、稳定、低成本</strong>三大优势，是资源有限场景下偏好对齐的首选方案。</li>
<li>DPO 的核心逻辑可概括为 <strong>“直接用人类偏好对约束模型的生成概率”</strong>：
<ol>
<li>对于同一个问题x，让模型πθ生成好回答y+的对数概率，尽可能大于生成差回答y−的对数概率；</li>
<li>以 SFT 后的参考模型πref为基准，避免模型为了迎合偏好而丢失 SFT 阶段学会的基础能力；</li>
<li>无需像 PPO 那样通过 “RM 打分→Critic 预估→优势值计算” 的复杂链路，直接通过偏好对数据完成优化。</li>
</ol>
</li>
<li>L_d = -ln(σ（β * （ln π_θ（y+ ｜ x）-  ln π_θ（y- ｜ x）））) 单样本版本
<ol>
<li>ln π_θ（y+ ｜ x）-  ln π_θ（y- ｜ x） 表示：模型生成好回答的对数概率和，减去生成差回答的对数和
<ol>
<li>作用就是，如果差值如正，说明当前生成好回答的概率大于差的回答，符合偏好，如果差值是负，说明不符合偏好需要继续优化</li>
<li>对比就是 PPO 中，需要使用奖励模型打分和优势值的复杂奖励信号，逻辑更简单</li>
</ol>
</li>
<li>β * （ln π_θ（y+ ｜ x）-  ln π_θ（y- ｜ x）） 用温度系数β对 “对数概率差” 进行缩放，控制对差回答的惩罚程度，防止模型过拟合，缺乏泛化能力</li>
<li>σ(-) 将缩放后的对数概率差，输入 Sigmoid 函数，映射到(0,1)区间。通俗理解就是转化对数概率差为判断模型偏好好回答的概率</li>
<li>-ln(-) 把偏好好回答的概率转化成可优化的损失值，原因是：
<ol>
<li>如果σ(-)的结果趋近于 1，ln(1)是等于 0 的，也就是损失为 0，说明模型表现好，无需大幅调整参数；</li>
<li>防止就是损失为+♾️，需要大幅调整降低损失</li>
</ol>
</li>
</ol>
</li>
<li>完整训练流程：
<ol>
<li>数据处理：
<ol>
<li><strong>数据格式</strong>：必须是 <strong>「Prompt x + 好回答 y+ + 差回答 y−」</strong> 的三元组格式，这是 DPO 的核心数据基础，同时序列长度需要一致
<ol>
<li>通俗比喻就是：问题+ 好回答+查回答</li>
</ol>
</li>
<li>数据来源：线上用户反馈，标注人员标注，大模型生成然后人工筛选等方式</li>
</ol>
</li>
<li>模型初始化：
<ol>
<li>加载参考模型，固定其参数(不参与训练)，加载与参考模型一样的 SFT模型，作为待优化模型</li>
<li>可选：对待优化模型进行微调(参考模型不动)，微调只是使用不同的数据和方法进行处理，此处是替换了数据和损失函数，还是用的同样的微调方法，所以是可以使用的，一个是用交叉熵损失，一个用 DPO 损失</li>
</ol>
</li>
<li>计算 DPO 损失：按照上面 3 中公式计算批次损失</li>
<li>迭代训练：
<ol>
<li>将批次损失传入优化器（如 AdamW），计算损失对模型参数θ的梯度，通过梯度下降更新参数（若用 LoRA，仅更新 LoRA 矩阵）；</li>
<li><strong>验证与早停</strong>：每训练 1 轮（Epoch），用独立的验证集评估模型的偏好对齐效果（如人工抽查、自动评估指标 MT-Bench/AlpacaEval），若验证集损失不再下降，立即停止训练，避免过拟合；</li>
<li>保存模型</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 data-id="heading-4">4 GRPO(Group Relative Policy Optimization)</h2>
<ol>
<li>DeepSeek 提出的无价值模型（Critic-Free）强化学习算法，专为 LLM 大规模偏好对齐与推理能力提升设计，核心动机是解决<strong>PPO 的高显存 / 计算成本</strong>，同时保留强化学习的精准对齐能力，区别于 DPO 的纯离线偏好优化思路。</li>
<li>核心创新：<strong>用 “同一 Prompt 下多条回答的组内相对奖励” 替代 PPO 的 Critic 输出，既去掉了 Critic 模型，又保留了 PPO 的稳定更新机制，同时用 KL 约束防止模型偏离 SFT 的基础能力</strong>。</li>
<li>L_g = -  (1/ G) * ∑^G_(i= 1)  |1 / Yi| ∑^|Yi| _(t=1) min(r_t(θ) * A^i, clip(r_t(θ), 1+ε， 1 - ε) * A^i) −β⋅KL(πθ∥πref)
<ol>
<li>其中 A^i = (Ri - η(r) ) / (σ(r) + 1e -8) 表示组内相对优势值
<ol>
<li>Ri 表示奖励模型对模型生成的 G 条回答，对应每条回答的真实打分</li>
<li>η(r)表示组内奖励均值 σ(r)表示组内奖励标准差，1e-8 是一个防止分母为零的常数</li>
</ol>
</li>
<li>r_t(θ) = π_n(θ) / π_o(θ)  新旧策略生成的概率比</li>
<li>clip(r_t(θ), 1+ε， 1 - ε) 类比 PPO 中裁剪，防止新旧策略差异过大</li>
<li>裁剪损失：min(r_t(θ) * A^i, clip(r_t(θ), 1+ε， 1 - ε) * A^i) ，类比 PPO，保证训练平稳</li>
<li>KL 损失可选，防止模型偏离参考模型</li>
</ol>
</li>
<li>完整训练流程：
<ol>
<li>准备训练数据
<ol>
<li>数据格式：仅需大量 Prompt（如通用问答、代码、数学题），回答由模型实时生成，无需提前标注；</li>
<li>需要和 PPO 一样提前训练好奖励模型，只需 prompt，不需要 DPO 那样的数据格式</li>
</ol>
</li>
<li>模型初始化：加载参考模型，待优化模型，奖励模型
<ol>
<li>同样待优化模型可以使用 lora 这些方法轻量化微调</li>
</ol>
</li>
<li>组采样和奖励打分
<ol>
<li>对每个 Prompt，用旧策略π_O采样G条不同的回答，组成 1 个 “回答组”；</li>
<li>用 RM 给组内每条回答打分，得到奖励分数{r1,r2,...,rG}；</li>
<li>按公式计算每条回答的组内相对优势值A^i。</li>
</ol>
</li>
<li>计算 GRPO 损失(单样本)
<ol>
<li>将组内回答输入新策略πθ，计算每个 token 的新旧策略概率比rt(θ)；</li>
<li>应用 Clip 操作，计算裁剪损失项min(rt(θ)A^i,clip(rt(θ))A^i)；</li>
<li>计算新策略与参考模型的 KL 散度，加入 KL 正则项；</li>
<li>对批次内所有组的损失取平均，得到<strong>批次损失</strong>。</li>
</ol>
</li>
<li>迭代更新(同 DPO)</li>
</ol>
</li>
</ol>
<h2 data-id="heading-5">5 RLHF(Reinforcement Learning from Human Feedback)</h2>
<ol>
<li>RLHF 是<strong>大模型偏好对齐的经典完整体系</strong>，而非单一优化算法，是后续 DPO、GRPO 等轻量化方法的 “鼻祖”。核心逻辑是<strong>通过 “人类反馈” 串联起 “监督微调→奖励模型训练→强化学习” 三个阶段</strong>，实现模型从 “听懂指令” 到 “符合人类偏好” 的全链路优化。</li>
<li>核心思想：
<ol>
<li>第一步（SFT）：教学生 “看懂题目，写出正确答案”</li>
<li>第二步（RM 训练）：教老师 “学会给答案打分（按人类偏好）”</li>
<li>第三步（PPO 强化）：让学生 “根据老师的打分，不断优化答案（更符合偏好）”</li>
</ol>
</li>
<li>RLHF 损失的核心公式分为 <strong>SFT的交叉熵损失</strong> 和<strong>奖励模型（RM）的损失公式</strong>和<strong>PPO 的损失公式</strong>
<ol>
<li>SFT 损失 L_s = - E [∑t ln π(θ)]</li>
<li>奖励模型损失： L_rm = - E [ln σ(rϕ(x,y+)−rϕ(x,y−))]
<ol>
<li>rϕ(x,y)是奖励模型的打分（参数为ϕ），y+是人类偏好的好回答，y−是差回答，σ(⋅)是 Sigmoid 函数（映射到 0~1）。</li>
<li>通过差值实现 “给好回答打高分，差回答打低分”</li>
<li>σ(-),ln(-)函数的意义和 DPO 中是一致的</li>
<li>RM 的排序损失和 DPO 的偏好损失<strong>形式高度相似</strong>，但作用不同 ——RM 是 “学打分”，DPO 是 “直接用偏好对优化模型”。</li>
</ol>
</li>
<li>关于此部分奖励模型的数据格式，与 DPO 是一致的都是三元组，区别是：
<ol>
<li>不管是 RLHF 的 RM，还是 DPO 的偏好对，都需要先有 “同一 prompt 的多条回答”，再筛选 / 排序出y+和y−，比如：y1&gt;y2&gt;y3，形成的数据格式即：(x,y1,y2)、(x,y1,y3)、(x,y2,y3)，这不是 GRPO 的专利</li>
<li>与 GRPO 不同的是：
<ol>
<li>GRPO 训练时<strong>动态生成多条回答</strong>，是为了计算<strong>组内相对优势值</strong>（替代 Critic），直接用于策略优化；</li>
<li>RM 的数据收集阶段<strong>提前生成多条回答</strong>，是为了让<strong>人类排序</strong>，再拆成三元组，用于<strong>训练打分模型</strong>，不直接优化策略。</li>
</ol>
</li>
<li>RM 的损失和 DPO 的损失区别在于，DPO 是人类偏好差，RM 是打分差</li>
</ol>
</li>
</ol>
</li>
<li>PPO 损失：见上 PPO</li>
<li>完整训练流程
<ol>
<li>监督微调（SFT）—— 基础指令适配
<ol>
<li>数据准备：收集 “Prompt + 人类标注的正确回答” 数据（如通用问答、代码解释）；</li>
<li>模型初始化：加载预训练大模型，启用 LoRA/QLoRA 轻量化微调；</li>
<li>损失计算：按 SFT 交叉熵损失计算批次损失；</li>
<li>迭代更新：梯度下降更新模型参数，得到πSFT（RLHF 的基础模型）。</li>
</ol>
</li>
<li>奖励模型（RM）训练 —— 学习人类偏好（核心新环节）
<ol>
<li>数据准备：
<ol>
<li>收集 “同一 Prompt 下的N条不同回答”，让人类按<strong>偏好程度排序</strong>（如y1&gt;y2&gt;y3，&gt;表示 “更偏好”）；</li>
<li>转换为<strong>成对偏好数据</strong>：将排序数据拆分为多个 “好回答 / 差回答” 对（如y1/y2、y1/y3、y2/y3），作为 RM 的训练数据；</li>
</ol>
</li>
<li>模型初始化：(第一步的 SFT 模型作为奖励模型的基础模型)
<ol>
<li>改造输出层：将原有的 “词表大小线性层 + Softmax” 替换为<strong>输出维度 = 1 的线性层</strong>（无激活函数），用于输出标量打分；</li>
<li>启用 LoRA 微调（仅训练低秩矩阵，降低成本）。</li>
</ol>
</li>
<li>损失计算：
<ol>
<li>将成对数据(x,y+,y−)输入 RM，得到打分rϕ(x,y+)和rϕ(x,y−)；</li>
<li>按 RM 排序损失公式计算批次损失（对所有成对样本的损失取平均）。</li>
</ol>
</li>
<li>迭代更新：
<ol>
<li>梯度下降更新 RM 的参数ϕ，让 RM 的打分越来越符合人类排序；</li>
<li>验证：用独立的排序数据评估 RM，若 “RM 打分高低” 与 “人类排序” 的重合度≥90%，则 RM 训练完成。</li>
</ol>
</li>
</ol>
</li>
<li>PPO 强化学习 —— 精准对齐人类偏好
<ol>
<li>模型初始化：
<ol>
<li>加载SFT模型作为<strong>PPO 策略模型*<em>πθ*</em></strong>（也叫待优化模型）和<strong>参考模型</strong>（固定）；</li>
<li>加载SFT 模型并改造输出层，作为<strong>价值模型*<em>Vϕ*</em></strong>（Critic，预估状态价值）；</li>
<li>加载<strong>训练完成的 RM 奖励模型</strong>，用于给生成的回答打分；</li>
<li>对πθ和Vϕ启用 LoRA 微调（仅训练低秩矩阵）。</li>
</ol>
</li>
<li>采样和打分：
<ol>
<li>用旧策略πO对 Prompt 采样生成回答y；</li>
<li>用 RM 给回答打分，得到真实奖励r(x,y)；</li>
<li>计算 token 级的 GAE 优势值A^t</li>
</ol>
</li>
<li>损失计算：按 PPO 组合损失公式，计算裁剪损失、价值损失、KL 正则项，得到批次总损失。</li>
<li>迭代更新：
<ol>
<li>梯度下降同时更新πθ（策略模型）和Vϕ（价值模型）的参数；</li>
<li>定期保存πO（旧策略快照），用于下一轮采样；</li>
<li>验证：用 MT-Bench / 人工打分评估对齐效果，损失不再下降则早停。</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 data-id="heading-6">6 关于不同的优化方法的区别：</h2>













































































<table><thead><tr><th>排序</th><th>方法</th><th>核心定位</th><th>适用场景</th><th>关键特点</th><th>数据格式</th><th>核心对齐方式</th></tr></thead><tbody><tr><td>0</td><td>SFT</td><td>让模型 “听懂指令，生成正确回答”</td><td/><td/><td>「Prompt + 单条回答」</td><td>监督学习，让模型拟合人类标注的指令回答</td></tr><tr><td>1</td><td>PPO</td><td>RLHF 经典核心，在线优化标杆</td><td><strong>资源充足、追求极致对齐效果</strong>、需精细调参</td><td>Actor-Critic + 裁剪 + KL 约束；效果强但工程复杂（4 模型协同）</td><td>「Prompt + 回答 + RM 打分」</td><td>价值模型 + GAE 优势估计（需 RM+ Critic）</td></tr><tr><td>2</td><td>DPO</td><td>离线偏好对齐首选，替代 PPO 的主流方案</td><td><strong>资源有限、快速迭代</strong>、数据质量可控，轻量化对齐</td><td>无 RM/Critic，直接用偏好对优化；训练稳定、算力成本低 70%+</td><td>「Prompt + 好回答 + 差回答」</td><td>离线偏好优化，直接用好坏回答对约束模型生成倾向</td></tr><tr><td>3</td><td>GRPO</td><td>无 Critic 的在线优化，PPO 轻量化替代</td><td><strong>中等算力、需在线更新</strong>、不想维护 Critic</td><td>组内相对奖励替代 Critic；去掉价值网络，训练速度提升 50%+(推理任务、长序列生成、大规模模型)</td><td>prompt</td><td>在线轻量化强化，用组内相对奖励替代 Critic</td></tr><tr><td>4</td><td>RLHF</td><td>大模型偏好对齐领域的经典全链路体系，也是后续所有轻量化对齐方法（DPO/GRPO/KTO）的 “鼻祖”。</td><td>大厂通用大模型研发,高合规要求的垂直领域,需要动态适配用户偏好的场景</td><td>SFT+RM+PPO</td><td>「Prompt + 回答 + RM 打分」</td><td>三阶段全链路对齐：SFT→RM 训练→PPO 强化</td></tr><tr><td>5</td><td>KTO</td><td>二元偏好对齐，适合低成本</td><td>标注标注预算有限、只能获取二元反馈（是 / 否）</td><td>基于前景理论，用二元数据优化；无需排序，标注效率高</td><td/><td>离线二元偏好优化，用 “好 / 坏” 标签替代成对偏好</td></tr><tr><td>6</td><td>RLOO</td><td>在线奖励学习 + 策略优化，小众进阶</td><td>需动态更新奖励、强在线反馈场景，法研究、多场景适配</td><td>结合在线 RM 训练与策略优化；工程复杂，落地案例少</td><td/><td/></tr></tbody></table>
<ol>
<li>
<p><strong>PO 是一类方法的统称（偏好优化，Preference Optimization），不是单独的算法框架</strong>，其核心特征是 <strong>直接用人类偏好数据约束模型生成行为</strong>，而 DPO、KTO、ORPO 等都属于 <strong>PO 家族的具体算法</strong>；<strong>PPO 不属于 PO 范畴</strong>，它是强化学习算法，是 RLHF 体系的核心强化环节。</p>
</li>
<li>
<p>强化学习算法：RLHF（含 PPO）、GRPO、RLOO 等
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7ba61cc671a4413a1c8a07704e0bcf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55-u5Lq65LiJ562J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769163546&amp;x-signature=ZTsMGKPleNuaD9bD0YJRuATA6Vw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li>是否属于强化学习的方法：是否满足 <strong>「策略模型与环境 / 反馈交互→获取奖励信号→用策略梯度类方法优化模型」</strong> 的闭环逻辑。</li>
</ol>
</li>
</ol>
<h2 data-id="heading-7">参考</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Faifrontiers%2Fp%2F19357323" target="_blank" title="https://www.cnblogs.com/aifrontiers/p/19357323" ref="nofollow noopener noreferrer">1</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[项目“瑞士军刀”：全局 Spring Bean 与 Web 上下文访问工具类]]></title>    <link>https://juejin.cn/post/7595815509234237480</link>    <guid>https://juejin.cn/post/7595815509234237480</guid>    <pubDate>2026-01-16T09:50:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595815509234237480" data-draft-id="7595794942086709283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="项目“瑞士军刀”：全局 Spring Bean 与 Web 上下文访问工具类"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-16T09:50:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不止CRUD"/> <meta itemprop="url" content="https://juejin.cn/user/3766269895520140"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            项目“瑞士军刀”：全局 Spring Bean 与 Web 上下文访问工具类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3766269895520140/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不止CRUD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:50:31.000Z" title="Fri Jan 16 2026 09:50:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在标准 Spring 开发中，我们通常使用 <code>@Autowired</code> 进行依赖注入。但在一些非 Bean 管理的场景（如：静态工具类、某些三方框架的扩展点、或复杂的单例模式）中，我们无法直接注入对象。</p>
<p>在 Web 场景，我们只能在 Controller 的方法参数中获取 <code>HttpServletRequest</code> 或 <code>Response</code>。但在架构底层（如切面、拦截器、甚至是 Service 层），如果需要获取当前请求的 Header、IP 地址或 Session 信息，层层传递参数显然太笨重。</p>
<p>为了解决上面两个项目开发过程中的痛点，我们需要实现 <code>ApplicationContextAware</code> 接口，构建一个全局的 <strong>SpringContextHolder</strong>；利用 <code>RequestContextHolder</code>，在代码的任何角落静默获取当前线程关联的请求上下文。</p>
<h2 data-id="heading-1"><code>ApplicationContextAware</code></h2>
<p><code>ApplicationContextAware</code> 接口可以感知 Spring 中 <code>ApplicationContext</code>，通过实现 <code>ApplicationContextAware</code> 接口，Spring 会在启动时自动把容器引用（<code>ApplicationContext</code>）“注入”到这个类中。我们把它存入一个静态变量，就能在<strong>任何地方</strong>手动获取 Bean。</p>
<p>基本用法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringContextHolder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext applicationContext;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext context)</span> <span class="hljs-keyword">throws</span> BeansException {
        applicationContext = context;
    }

    <span class="hljs-comment">// 通过类型获取 Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> {
        <span class="hljs-keyword">return</span> applicationContext.getBean(clazz);
    }

    <span class="hljs-comment">// 通过名称获取 Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">return</span> applicationContext.getBean(name);
    }
}
</code></pre>
<h2 data-id="heading-2"><code>RequestContextHolder</code></h2>
<p><code>RequestContextHolder</code> 利用了 <strong>ThreadLocal</strong>。Spring MVC 在接收到请求时，会将当前请求的 <code>Request</code> 和 <code>Response</code> 绑定到处理该请求的线程上。只要你还在同一个线程内，就能随时“隔空取物”。</p>
<p>基本用法:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebUtils</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HttpServletRequest <span class="hljs-title function_">getRequest</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        <span class="hljs-keyword">return</span> attributes != <span class="hljs-literal">null</span> ? attributes.getRequest() : <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">// 快捷获取 Header</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getHeader</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> getRequest();
        <span class="hljs-keyword">return</span> request != <span class="hljs-literal">null</span> ? request.getHeader(name) : <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h2 data-id="heading-3">扩展 <code>ApplicationContextAware</code> 能力</h2>
<p>下面内容是对实际项目中，常见场景的封装：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringContextHolder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span>, DisposableBean {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

    <span class="hljs-comment">/**
     * 获取 ApplicationContext
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ApplicationContext <span class="hljs-title function_">getApplicationContext</span><span class="hljs-params">()</span> {
        assertContextInjected();
        <span class="hljs-keyword">return</span> applicationContext;
    }

    <span class="hljs-comment">/**
     * 获取环境属性
     *
     * <span class="hljs-doctag">@param</span> key 属性名
     * <span class="hljs-doctag">@return</span> 属性值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getProperty</span><span class="hljs-params">(String key)</span> {
        assertContextInjected();
        <span class="hljs-keyword">return</span> applicationContext.getEnvironment().getProperty(key);
    }

    <span class="hljs-comment">/**
     * 获取环境属性
     *
     * <span class="hljs-doctag">@param</span> key          属性名
     * <span class="hljs-doctag">@param</span> defaultValue 默认值
     * <span class="hljs-doctag">@return</span> 属性值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getProperty</span><span class="hljs-params">(String key, String defaultValue)</span> {
        assertContextInjected();
        <span class="hljs-keyword">return</span> applicationContext.getEnvironment().getProperty(key, defaultValue);
    }

    <span class="hljs-comment">/**
     * 获取环境属性
     *
     * <span class="hljs-doctag">@param</span> key        属性名
     * <span class="hljs-doctag">@param</span> targetType 目标类型
     * <span class="hljs-doctag">@param</span> &lt;T&gt;        泛型
     * <span class="hljs-doctag">@return</span> 属性值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getProperty</span><span class="hljs-params">(String key, Class&lt;T&gt; targetType)</span> {
        assertContextInjected();
        <span class="hljs-keyword">return</span> applicationContext.getEnvironment().getProperty(key, targetType);
    }

    <span class="hljs-comment">/**
     * 从静态变量 applicationContext 中取得 Bean, 自动转型为所赋值对象的类型
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> {
        assertContextInjected();
        <span class="hljs-keyword">return</span> (T) applicationContext.getBean(name);
    }

    <span class="hljs-comment">/**
     * 从静态变量 applicationContext 中取得 Bean, 自动转型为所赋值对象的类型
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(Class&lt;T&gt; requiredType)</span> {
        assertContextInjected();
        <span class="hljs-keyword">return</span> applicationContext.getBean(requiredType);
    }

    <span class="hljs-comment">/**
     * 发布事件
     *
     * <span class="hljs-doctag">@param</span> event 事件对象
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishEvent</span><span class="hljs-params">(ApplicationEvent event)</span> {
        <span class="hljs-keyword">if</span> (applicationContext == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span>;
        }
        applicationContext.publishEvent(event);
    }

    <span class="hljs-comment">/**
     * 清除 SpringContextHolder 中的 ApplicationContext 为 null
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearHolder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (log.isDebugEnabled()) {
            log.debug(<span class="hljs-string">"清除 SpringContextHolder 中的 ApplicationContext: {}"</span>, applicationContext);
        }
        applicationContext = <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">/**
     * 当 Spring 容器初始化这个 Bean 时，将 ApplicationContext 注入到静态变量中
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException {
        SpringContextHolder.applicationContext = applicationContext;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> {
        SpringContextHolder.clearHolder();
    }

    <span class="hljs-comment">/**
     * 检查 ApplicationContext 是否注入
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">assertContextInjected</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (applicationContext == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(
                    <span class="hljs-string">"applicationContext 属性未注入, 请确保 SpringContextHolder 已注册为 Bean，且在 Spring 上下文初始化完成后调用。"</span>);
        }
    }
}

</code></pre>
<h2 data-id="heading-4">扩展 <code>RequestContextHolder</code> 能力</h2>
<p>下面内容是对实际项目中，常见场景的封装：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@UtilityClass</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebUtils</span> {

    <span class="hljs-comment">/**
     * 获取 HttpServletRequest
     */</span>
    <span class="hljs-keyword">public</span> HttpServletRequest <span class="hljs-title function_">getRequest</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Optional.ofNullable(RequestContextHolder.getRequestAttributes())
                .map(ServletRequestAttributes.class::cast)
                .map(ServletRequestAttributes::getRequest)
                .orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">/**
     * 获取 HttpServletResponse
     */</span>
    <span class="hljs-keyword">public</span> HttpServletResponse <span class="hljs-title function_">getResponse</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Optional.ofNullable(RequestContextHolder.getRequestAttributes())
                .map(ServletRequestAttributes.class::cast)
                .map(ServletRequestAttributes::getResponse)
                .orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-comment">/**
     * 判断是否是 JSON 请求
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isJsonRequest</span><span class="hljs-params">(HandlerMethod handlerMethod)</span> {
        <span class="hljs-comment">// 1. 类上有 @RestController</span>
        <span class="hljs-keyword">if</span> (handlerMethod.getBeanType().isAnnotationPresent(RestController.class)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-comment">// 2. 方法或类上有 @ResponseBody</span>
        <span class="hljs-keyword">if</span> (handlerMethod.getMethodAnnotation(ResponseBody.class) != <span class="hljs-literal">null</span> ||
                handlerMethod.getBeanType().isAnnotationPresent(ResponseBody.class)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">/**
     * 渲染 JSON 数据到响应
     *
     * <span class="hljs-doctag">@param</span> response 响应对象
     * <span class="hljs-doctag">@param</span> json     JSON 字符串
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">renderJson</span><span class="hljs-params">(HttpServletResponse response, String json)</span> {
        <span class="hljs-keyword">if</span> (response == <span class="hljs-literal">null</span>) {
            log.warn(<span class="hljs-string">"HttpServletResponse 为空，跳过 JSON 渲染"</span>);
            <span class="hljs-keyword">return</span>;
        }
        Assert.notNull(json, <span class="hljs-string">"JSON 字符串不能为空"</span>);

        response.setCharacterEncoding(StandardCharsets.UTF_8.name());
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter()) {
            writer.write(json);
            writer.flush();
        } <span class="hljs-keyword">catch</span> (IOException e) {
            log.error(<span class="hljs-string">"渲染 JSON 失败"</span>, e);
        }
    }

    <span class="hljs-comment">/**
     * 获取客户端 IP
     * &lt;p&gt;
     * 考虑了 Nginx 等反向代理的场景
     *
     * <span class="hljs-doctag">@return</span> IP 地址
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getIpAddr</span><span class="hljs-params">()</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> getRequest();
        <span class="hljs-keyword">if</span> (request == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">return</span> getIpAddr(request);
    }

    <span class="hljs-comment">/**
     * 获取客户端 IP
     *
     * <span class="hljs-doctag">@param</span> request 请求对象
     * <span class="hljs-doctag">@return</span> IP 地址
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getIpAddr</span><span class="hljs-params">(HttpServletRequest request)</span> {
        <span class="hljs-keyword">if</span> (request == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"x-forwarded-for"</span>);
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.isEmpty() || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getHeader(<span class="hljs-string">"Proxy-Client-IP"</span>);
        }
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.isEmpty() || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getHeader(<span class="hljs-string">"WL-Proxy-Client-IP"</span>);
        }
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.isEmpty() || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getHeader(<span class="hljs-string">"HTTP_CLIENT_IP"</span>);
        }
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.isEmpty() || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getHeader(<span class="hljs-string">"HTTP_X_FORWARDED_FOR"</span>);
        }
        <span class="hljs-keyword">if</span> (ip == <span class="hljs-literal">null</span> || ip.isEmpty() || <span class="hljs-string">"unknown"</span>.equalsIgnoreCase(ip)) {
            ip = request.getRemoteAddr();
        }
        <span class="hljs-comment">// 对于通过多个代理的情况，第一个IP为客户端真实IP,多个IP按照','分割</span>
        <span class="hljs-keyword">if</span> (ip != <span class="hljs-literal">null</span> &amp;&amp; ip.contains(<span class="hljs-string">","</span>)) {
            ip = ip.split(<span class="hljs-string">","</span>)[<span class="hljs-number">0</span>].trim();
        }
        <span class="hljs-keyword">return</span> ip;
    }

    <span class="hljs-comment">/**
     * 获取请求头
     *
     * <span class="hljs-doctag">@param</span> name header 名称
     * <span class="hljs-doctag">@return</span> header 值
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getHeader</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> getRequest();
        <span class="hljs-keyword">return</span> request != <span class="hljs-literal">null</span> ? request.getHeader(name) : <span class="hljs-literal">null</span>;
    }

    <span class="hljs-comment">/**
     * 获取 Parameter
     *
     * <span class="hljs-doctag">@param</span> name parameter 名称
     * <span class="hljs-doctag">@return</span> parameter 值
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getParameter</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> getRequest();
        <span class="hljs-keyword">return</span> request != <span class="hljs-literal">null</span> ? request.getParameter(name) : <span class="hljs-literal">null</span>;
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring声明式事务：@Transactional用起来简单，但传播机制你真的配明白了吗？]]></title>    <link>https://juejin.cn/post/7595772638880907315</link>    <guid>https://juejin.cn/post/7595772638880907315</guid>    <pubDate>2026-01-16T09:53:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595772638880907315" data-draft-id="7595683968684113966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring声明式事务：@Transactional用起来简单，但传播机制你真的配明白了吗？"/> <meta itemprop="keywords" content="Java,Spring"/> <meta itemprop="datePublished" content="2026-01-16T09:53:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CV工程师的自我修养"/> <meta itemprop="url" content="https://juejin.cn/user/1039488093258619"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring声明式事务：@Transactional用起来简单，但传播机制你真的配明白了吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1039488093258619/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CV工程师的自我修养
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:53:32.000Z" title="Fri Jan 16 2026 09:53:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是一名CV工程师。</p>
<p>在使用Spring声明式事务时，你是否曾有过这样的困惑：明明标注了<code>@Transactional</code>，但事务却没按你预想的那样回滚？在复杂的业务方法嵌套调用中，事务的边界为何总像“玄学”一样难以捉摸？其实根本原因是：Spring事务的传播机制有着清晰、严谨的规则。虽然我们平时用到传播机制并不多。但是理解它，并非为了炫技，而是为了让我们能能精准控制数据一致性，也是为了在面试过程中能清楚的回答出面试官关于声明式事务传播机制的问题。</p>
<blockquote>
<p>接下来我将用代码调试的方式为大家讲解每个传播机制的区别!!!</p>
</blockquote>
<h3 data-id="heading-0">声明式事务传播机制的核心概念</h3>
<h4 data-id="heading-1">基本定义与核心概念</h4>
<p>传播机制是Spring声明式事务管理的核心特性之一，用于定义在多个事务方法相互调用时，事务应该如何传播和处理边界。特别需要注意的是传播行为是定义被调用方法的事务行为，而不是调用方法的控制手段。所以传播机制是需要定义在被调用方法上，以用来控制该方法如何与调用方的事务上下文进行交互。</p>
<h4 data-id="heading-2">七种传播传播行为区别</h4>













































<table><thead><tr><th>传播行为</th><th>行为定义</th><th>简单描述(以被调用方视角)</th></tr></thead><tbody><tr><td>REQUIRED</td><td>Spring默认的传播机制。如果当前(调用方)存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务。REQUIRED传播机制最常用的情况是在一个事务重进行多个操作，要么全部成功，要么全部失败。如果其中一个操作失败，整个事务都将被回滚。</td><td>"我"需要一个事务，有就加入，没有就新建</td></tr><tr><td>SUPPORTS</td><td>当前方法如果在一个事务方法中被调用，则加入该事务；否则，已非事务的方式运行。SUPPORTS传播机制适用于对事务要求不高的操作，例如读取操作。</td><td>"我"支持事务，有就用，没有就不用</td></tr><tr><td>MANDATORY</td><td>传播机制表示当前方法必须在一个事务中被调用，否则将抛出异常。MANDATORY传播机制适用于在需要事务的情况下调用方法。</td><td>"我"必须在事务中运行，否则抛异常</td></tr><tr><td>REQUIRES_NEW</td><td>表示当前方法必须开启一个新事务运行，如果当前存在事务，则挂起该事务。REQUIRES_NEW传播机制适用于对事务要求比较高的操作，例如更新操作。REQUIRES_NEW修饰的内部方法会新开启自己的事务，且开启的事务相互独立，互不干扰。</td><td>"我"需要新事务，有就挂起旧的，没有就新建</td></tr><tr><td>NOT_SUPPORTED</td><td>以非事务方式运行，如果当前存在事务，则把当前事务挂起。</td><td>"我"不支持事务，有就挂起，没有就算了</td></tr><tr><td>NEVER</td><td>以非事务方式运行，如果当前存在事务，则抛出异常。</td><td>"我"禁止在事务中运行，否则抛异常</td></tr><tr><td>NESTED</td><td>如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行；如果当前没有事务，则该取值等价于PROPAGATION_REQUIRED。</td><td>"我"需要嵌套事务，有就用保存点，没有就新建</td></tr></tbody></table>
<h3 data-id="heading-3">代码验证各个传播行为</h3>
<h4 data-id="heading-4">调用方使用<code>@Transactional</code>注解，被调用方没有使用</h4>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//✅更新被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}


<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>){
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//✅更新被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}


<span class="hljs-comment">/**
  * 结论：被调用方法受调用方法的事务管控
  */</span>
</code></pre>
<h4 data-id="heading-5">调用方未使用<code>@Transactional</code>注解，被调用方使用</h4>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}


<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
     <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>){
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//✅更新被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}


<span class="hljs-comment">/**
  * 结论：调用方法不受被调用方的事务管控，被调用方法独立使用事务。
  */</span>
</code></pre>
<h4 data-id="heading-6">被调用方法使用<code>REQUIRED</code>传播行为</h4>
<h5 data-id="heading-7">调用方法有事务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("test1Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Service test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test1Mapper test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test1Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
        test2Service.update();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-meta">@Service("test2Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Mapper test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class,propagation = Propagation.REQUIRED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test2Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
    }
}

<span class="hljs-comment">/**
 *现象：调用方法中抛出异常，被调用方法中的更新也被回滚。
 *结论:被调用方法加入到调用方法事务中。
 */</span>
</code></pre>
<h5 data-id="heading-8">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">REQUIRED</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//✅更新被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：被调用方法的更新被回滚
 *结论:被调用方法的创建了新的事务
 */</span>
</code></pre>
<h4 data-id="heading-9">被调用方法使用<code>SUPPORTS</code>传播行为</h4>
<h5 data-id="heading-10">调用方法有事务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("test1Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Service test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test1Mapper test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test1Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
        test2Service.update();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-meta">@Service("test2Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Mapper test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class,propagation = Propagation.SUPPORTS)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test2Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
    }
}

<span class="hljs-comment">/**
 *现象：调用方法中抛出异常，被调用方法中的更新也被回滚。
 *结论:被调用方法加入到调用方法事务中。次情景下与REQUIRED传播行为一致。
 */</span>
</code></pre>
<h5 data-id="heading-11">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">SUPPORTS</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：被调用方法的更新未被回滚
 *结论:被调用方法使用SUPPORTS传播行为时，当调用方法未开启事务时，被调用方法已非事务方式运行
 */</span>
</code></pre>
<h4 data-id="heading-12">被调用方法使用<code>MANDATORY</code>传播行为</h4>
<h5 data-id="heading-13">调用方法有事务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("test1Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Service test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test1Mapper test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test1Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
        test2Service.update();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-meta">@Service("test2Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Mapper test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class,propagation = Propagation.MANDATORY)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test2Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
    }
}

<span class="hljs-comment">/**
 *现象：调用方法中抛出异常，被调用方法中的更新也被回滚。
 *结论:被调用方法加入到调用方法事务中。此情景下与REQUIRED传播行为一致。
 */</span>
</code></pre>
<h5 data-id="heading-14">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">MANDATORY</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：运行代码报错：No existing transaction found for transaction marked with propagation 'mandatory'
 *结论:被调用方法使用MANDATORY传播行为时，调用方法必须开启事务，否则运行报错
 */</span>
</code></pre>
<h4 data-id="heading-15">被调用方法使用<code>REQUIRES_NEW</code>传播行为</h4>
<h5 data-id="heading-16">调用方法有事务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("test1Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Service test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test1Mapper test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test1Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
        test2Service.update();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-meta">@Service("test2Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Mapper test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class,propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test2Mapper.updateId1ColTo2();<span class="hljs-comment">//❌更新未被回滚</span>
    }
}

<span class="hljs-comment">/**
 *现象：调用方法中抛出异常，被调用方法中的更新未被回滚。
 *结论:被调用方法开启了独立的事务，与调用方法事务隔离。
 */</span>
</code></pre>
<h5 data-id="heading-17">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">REQUIRES_NEW</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//✅更新被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：被调用方法的更新被回滚
 *结论:被调用方法使用REQUIRES_NEW传播行为时，当调用方法未开启事务时，被调用方法开启独立事务。此情景下与REQUIRED传播行为一致。
 */</span>
</code></pre>
<h4 data-id="heading-18">被调用方法使用<code>NOT_SUPPORTED</code>传播行为</h4>
<h5 data-id="heading-19">调用方法有事务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("test1Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Service test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test1Mapper test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test1Mapper.updateId1ColTo2();<span class="hljs-comment">//✅更新被回滚</span>
        test2Service.update();
    }
}

<span class="hljs-meta">@Service("test2Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Mapper test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class,propagation = Propagation.NOT_SUPPORTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test2Mapper.updateId1ColTo2();<span class="hljs-comment">//❌更新未被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：被调用方法中抛出异常，被调用方法中的更新未被回滚，但调用方法更新被回滚。
 *结论:被调用方法不受事务管控，不管是自己还是调用方法出现异常都不会回滚更新操作。
 */</span>
</code></pre>
<h5 data-id="heading-20">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">NOT_SUPPORTED</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：调用方法与被调用方法的更新均被回滚
 *结论:被调用方法使用NOT_SUPPORTED传播行为时，当调用方法未开启事务时，被调用方法以非事务方式运行。此情景下与不使用声明式事务现象一致。
 */</span>
</code></pre>
<h4 data-id="heading-21">被调用方法使用<code>NEVER</code>传播行为</h4>
<h5 data-id="heading-22">调用方法有事务</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("test1Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Service test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test1Mapper test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test1Mapper.updateId1ColTo2();
        test2Service.update();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-meta">@Service("test2Service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> Test2Mapper test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class,propagation = Propagation.NEVER)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> {
        test2Mapper.updateId1ColTo2();
    }
}

<span class="hljs-comment">/**
 *现象：代码出现异常：Existing transaction found for transaction marked with propagation 'never'
 *结论:被调用方法必须被未开启事务的方法调用，否则异常。
 */</span>
</code></pre>
<h5 data-id="heading-23">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">NEVER</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：调用方法与被调用方法的更新均未被回滚
 *结论:被调用方法使用NEVER传播行为时，当调用方法未开启事务时，被调用方法以非事务方式运行。此情景下与不使用声明式事务现象一致。
 */</span>
</code></pre>
<h4 data-id="heading-24">被调用方法使用<code>NESTED</code>传播行为</h4>
<h5 data-id="heading-25">调用方法有事务</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Service</span>
public class BatchProcessService {
    
    <span class="hljs-keyword">@Transactional</span>(propagation = Propagation.REQUIRED)
    public void batchProcessOrders(List&lt;Order&gt; orders) {
        for (Order order : orders) {
            try {
                <span class="hljs-comment">// 嵌套事务处理每个订单</span>
                <span class="hljs-built_in">processOrderNested</span>(order);
            } catch (Exception e) {
                <span class="hljs-comment">// 单个订单失败不影响其他订单</span>
                log<span class="hljs-selector-class">.error</span>("订单处理失败: {}", order.getId(), e);
            }
        }
    }
    
    <span class="hljs-keyword">@Transactional</span>(propagation = Propagation.NESTED)
    public void processOrderNested(Order order) {
        <span class="hljs-comment">// 嵌套事务，可以独立回滚</span>
        <span class="hljs-built_in">validateOrder</span>(order);
        <span class="hljs-built_in">deductInventory</span>(order);
        <span class="hljs-built_in">createPayment</span>(order);
        
        if (hasError(order)) {
            throw new <span class="hljs-built_in">RuntimeException</span>("订单处理失败");
        }
    }
}

<span class="hljs-comment">/**
 *现象：单个循环内的订单出现异常，不影响其他订单的更新提交
 *结论:如果当前存在事务，则在嵌套事务内执行（保存点机制）；如果不存在，则创建新事务。
 */</span>
</code></pre>
<h5 data-id="heading-26">调用方法无事务</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>(<span class="hljs-string">"test1Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Service</span> test2Service;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test1Mapper</span> test1Mapper;

    <span class="hljs-comment">/**
     * 调用方法
     */</span>
<span class="hljs-comment">//    @Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test1Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//❌更新未被回滚</span>
        test2Service.<span class="hljs-title function_">update</span>();
    }
}

<span class="hljs-meta">@Service</span>(<span class="hljs-string">"test2Service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2Service</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Test2Mapper</span> test2Mapper;

    <span class="hljs-comment">/**
     * 被调用方法
     */</span>
    <span class="hljs-meta">@Transactional</span>(rollbackFor = <span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>,propagation = <span class="hljs-title class_">Propagation</span>.<span class="hljs-property">NESTED</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
        test2Mapper.<span class="hljs-title function_">updateId1ColTo2</span>();<span class="hljs-comment">//✅更新被回滚</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟异常"</span>);
    }
}

<span class="hljs-comment">/**
 *现象：被调用方法的更新被回滚
 *结论:被调用方法使用NESTED传播行为时，当调用方法未开启事务时，被调用方法开启独立事务。此情景下与REQUIRED传播行为一致。
 */</span>
</code></pre>
<blockquote>
<p>关注我！！！下篇文章为大家详细解释声明式事务各种失效场景</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何用一个 mcp 来教笨蛋 AI 好好干活]]></title>    <link>https://juejin.cn/post/7595771085394083891</link>    <guid>https://juejin.cn/post/7595771085394083891</guid>    <pubDate>2026-01-16T09:47:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595771085394083891" data-draft-id="7595610998033580059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何用一个 mcp 来教笨蛋 AI 好好干活"/> <meta itemprop="keywords" content="前端,MCP"/> <meta itemprop="datePublished" content="2026-01-16T09:47:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="voderl"/> <meta itemprop="url" content="https://juejin.cn/user/2911162522930877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何用一个 mcp 来教笨蛋 AI 好好干活
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2911162522930877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    voderl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:47:24.000Z" title="Fri Jan 16 2026 09:47:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">我们在写伪代码吗？</h2>
<p>相信很多人都有这种感觉：写 Prompt 越来越像在写伪代码</p>
<ul>
<li>“先 xxx，再 xxx” → 对应代码的执行顺序</li>
<li>“如果 xxx，就 xxx” → <code>if</code> 逻辑</li>
<li>“一直执行直到 xxx” → <code>while</code> 循环</li>
</ul>
<p>既然如此，我们能不能直接把一段“伪代码”丢给 AI？</p>
<p>kimi-k2 执行效果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a8b7c79b8b74e4da090ce165a6d907e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdm9kZXJs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161662&amp;x-signature=CLcZ%2FXc27%2FSluD6oRMLiVlOnXMw%3D" alt="image.png" loading="lazy"/></p>
<p>看起来还可以！</p>
<p>给它加一点限制，让它从 1+...+ 到 n，同时排除所有位数之和加起来为 5 的倍数的数字，不能调用脚本：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> count = <span class="hljs-title class_">Tool</span>.<span class="hljs-title class_">AskUserQuestion</span>(<span class="hljs-string">`please input a number`</span>);
<span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= count; i++) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Prompt</span>(<span class="hljs-string">`<span class="hljs-subst">${i}</span> 的每个位数加起来之和为 5 的倍数`</span>)) {

  } <span class="hljs-keyword">else</span> {
    sum += i;
  }
}
<span class="hljs-title class_">Prompt</span>(<span class="hljs-string">`最终计算结果为 <span class="hljs-subst">${sum}</span>`</span>)
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55bdc0ea16a24e36be4a9365b7ddc997~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdm9kZXJs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161662&amp;x-signature=njlbHlCpHEC5vQnIv0MTQ69DK0I%3D" alt="image.png" loading="lazy"/></p>
<p>好吧，这下原型毕露了，比如 86 这个完全不应该排除的数字，被它直接排除掉了。</p>
<p>而且它是先计算的所有值的和，再减去需要排除的值，其实没有严格按照我们的逻辑来执行。</p>
<p>其实好好想一想上面的过程，我们把一个伪代码丢给大模型来执行，期望于就像把代码丢给编译器来执行一样，但是 AI 有着很多的幻觉，这个“编译器”很不稳定。</p>
<p>在一些复杂任务的实测里，它会跳过逻辑胡乱执行，比如没按照预期调用 tool，或者直接在半路上认为自己已经成功了，特别是一些笨蛋 AI，每次执行过程和结果可能都不一样。</p>
<h2 data-id="heading-1">可以用代码驱动 AI 吗？</h2>
<p>为了解决这种不稳定性，我们需要一种能强约束执行流程的工具。</p>
<p>在 Claude Code 或类似的 Agent 框架中，AI 可以根据 Tool 的返回决定下一步。那么，我们能不能反过来？由一段真实的代码来驱动 AI，AI 只负责完成其中的“自然语言函数”部分？</p>
<p>这正是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvoderl%2Fagent-workflow-mcp-tool" target="_blank" title="https://github.com/voderl/agent-workflow-mcp-tool" ref="nofollow noopener noreferrer">agent-workflow-mcp-tool</a> 的核心思路：利用 MCP (Model Context Protocol) 协议，通过 TypeScript 的 Generator 函数，将 AI 变成流程中的一个执行单元。</p>
<p>下面的代码是可以真实执行的代码而非伪代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title class_">Workflow</span>() {
  <span class="hljs-keyword">const</span> count = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">ClaudeCodeTools</span>.<span class="hljs-title class_">AskUserQuestion</span>(
    <span class="hljs-string">`please input a number`</span>,
    z.<span class="hljs-title function_">number</span>()
  );

  <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= count; i++) {
    sum = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">Prompt</span>(<span class="hljs-string">`calculate <span class="hljs-subst">${sum}</span> + <span class="hljs-subst">${i}</span>`</span>, z.<span class="hljs-title function_">number</span>());
  }
  <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<p>github 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvoderl%2Fagent-workflow-mcp-tool" target="_blank" title="https://github.com/voderl/agent-workflow-mcp-tool" ref="nofollow noopener noreferrer">github.com/voderl/agen…</a></p>
<p>它有哪些优势呢：</p>
<ul>
<li>用代码控制流程。 Agent lies, code not</li>
<li>使用 zod 强校验，避免模型幻觉</li>
<li>完善的 typescript 支持</li>
<li>支持 async await throw catch 等语法</li>
<li>对比其他工具特别轻量，完全基于 mcp 协议</li>
<li>配合 claude code 和 kimi-k2 &amp; deepseek 工作良好</li>
</ul>
<p>比如用我们再举上面的例子，如果用该工具去处理上面的问题，让 AI 从 1+...+n，同时排除所有位数之和加起来为 5 的倍数的数字，那么完整的写法如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClaudeCodeTools</span>, registerWorkflowTool, <span class="hljs-title class_">Prompt</span>, z } <span class="hljs-keyword">from</span> <span class="hljs-string">"agent-workflow-mcp-tool"</span>;

<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">McpServer</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"agent-workflow"</span>,
  <span class="hljs-attr">version</span>: <span class="hljs-string">"0.0.1"</span>,
});

<span class="hljs-title function_">registerWorkflowTool</span>(
  server,
  <span class="hljs-string">"workflow"</span>,
  {
    <span class="hljs-attr">title</span>: <span class="hljs-string">"workflow"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">`workflow control`</span>,
  },
  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title class_">Workflow</span>() {
    <span class="hljs-keyword">const</span> count = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">ClaudeCodeTools</span>.<span class="hljs-title class_">AskUserQuestion</span>(
      <span class="hljs-string">`please input a number`</span>,
      z.<span class="hljs-title function_">number</span>()
    );

    <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= count; i++) {
      <span class="hljs-keyword">if</span> (
        <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">Prompt</span>(
          <span class="hljs-string">`计算 "<span class="hljs-subst">${i}</span>" 的所有位数加起来之和是否为 5 的倍数`</span>,
          z.<span class="hljs-title function_">boolean</span>()
        )
      ) {
      } <span class="hljs-keyword">else</span> {
        sum += i;
      }
    }
    <span class="hljs-keyword">return</span> sum;
  }
);
</code></pre>
<p>这时你让 Claude Code 直接执行该 mcp</p>
<pre><code class="hljs language-bash" lang="bash">Ask: use mcp <span class="hljs-string">"agent-workflow"</span> tool <span class="hljs-string">"workflow"</span> directly
</code></pre>
<p>执行结果见下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d95ddeaab14146d396ec12cdf6454c8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdm9kZXJs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161662&amp;x-signature=gDSpttUa%2BqFUe6o56yiD7imHBnk%3D" alt="image.png" loading="lazy"/></p>
<p>kimi-k2 真的严格按照代码给定的流程，从 1 + 2 + 直到加到 87，对每一个数字判断其所有数字加起来之和是否为 5 的倍数，调用了 87 次 mcp tool，最终得出了正确的结果。</p>
<p>可以在图中看出，在大模型每次调用 mcp 时，mcp 会给出当前的任务，如果大模型执行成功，大模型需要在下次调用时带上上次任务的执行结果。</p>
<p>每一步都有完善的 zod 类型校验，如果传参不对会给大模型提示，避免大模型的传参幻觉。</p>
<p>基于这样的 workflow，我们也可以把“对每一个数字判断其所有数字加起来之和是否为 5 的倍数”这一步可能会有大模型幻觉产生的步骤，改为使用代码来执行保证。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title class_">Workflow</span>() {
  <span class="hljs-keyword">const</span> count = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">ClaudeCodeTools</span>.<span class="hljs-title class_">AskUserQuestion</span>(
    <span class="hljs-string">`please input a number`</span>,
    z.<span class="hljs-title function_">number</span>()
  );

  <span class="hljs-keyword">let</span> sum = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= count; i++) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">sumDigits</span>(i) % <span class="hljs-number">5</span> === <span class="hljs-number">0</span>) {
    } <span class="hljs-keyword">else</span> {
      sum = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">Prompt</span>(<span class="hljs-string">`calculate <span class="hljs-subst">${sum}</span> + <span class="hljs-subst">${i}</span>`</span>, z.<span class="hljs-title function_">number</span>())
    }
  }
  <span class="hljs-keyword">return</span> sum;
}
</code></pre>
<h3 data-id="heading-2">更多复杂场景</h3>
<p>基于该工具，我们可以实现更复杂的逻辑，比如自动生成 commit 信息并在用户确认后提交代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">registerWorkflowTool</span>(
    server,
    <span class="hljs-string">"auto-commit"</span>,
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"auto commit"</span>,
      <span class="hljs-attr">description</span>: <span class="hljs-string">`auto commit`</span>,
    },
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title class_">Workflow</span>() {
      <span class="hljs-keyword">const</span> filesChangeList = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">Prompt</span>(
        <span class="hljs-string">`获取当前变更文件列表`</span>,
        z.<span class="hljs-title function_">array</span>(z.<span class="hljs-title function_">string</span>())
      );

      <span class="hljs-keyword">if</span> (filesChangeList.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`没有任何代码更改`</span>;
      }

      <span class="hljs-keyword">const</span> commitMessage = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">Prompt</span>(
        <span class="hljs-string">`根据当前变更内容生成对应的 commit message，格式需满足：
(fix|feat|chore): 单行简洁的提示

多行详细变更内容`</span>,
        z.<span class="hljs-title function_">string</span>()
      );

      <span class="hljs-keyword">const</span> { is_confirm } = <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">ClaudeCodeTools</span>.<span class="hljs-title class_">AskUserQuestion</span>(
        <span class="hljs-string">`commit message 为 <span class="hljs-subst">${commitMessage}</span>，是否确认继续`</span>,
        z.<span class="hljs-title function_">object</span>({
          <span class="hljs-attr">is_confirm</span>: z.<span class="hljs-title function_">boolean</span>(),
        })
      );

      <span class="hljs-keyword">if</span> (!is_confirm) <span class="hljs-keyword">return</span> <span class="hljs-string">`已取消`</span>;

      <span class="hljs-keyword">yield</span>* <span class="hljs-title class_">Prompt</span>(<span class="hljs-string">`将当前变更代码提交，commit message 为 <span class="hljs-subst">${commitMessage}</span>`</span>);
    }
  );
</code></pre>
<p>自动提交确认效果：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de8c238c5c5e4e1da2841f5d9833543c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdm9kZXJs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769161662&amp;x-signature=0gOEnO6Upuv%2BG5cxEeUyJ7ij%2F3Y%3D" alt="image.png" loading="lazy"/></p>
<p>还可以基于上面的流程，在 commit 前获取所有变更文件，挨个给每一个文件都使用 AI review 一遍，可以试试看～</p>
<h3 data-id="heading-3">使用</h3>
<pre><code class="hljs">npm install agent-workflow-mcp-tool
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { registerWorkflowTool, <span class="hljs-title class_">Prompt</span>, <span class="hljs-title class_">ClaudeCodeTools</span>, z } <span class="hljs-keyword">from</span> <span class="hljs-string">'agent-workflow-mcp-tool'</span>;
</code></pre>
<p>欢迎使用和反馈～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详细说一下nuxt generate是干啥的]]></title>    <link>https://juejin.cn/post/7595603381663924230</link>    <guid>https://juejin.cn/post/7595603381663924230</guid>    <pubDate>2026-01-16T10:21:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595603381663924230" data-draft-id="7595502583269539876" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详细说一下nuxt generate是干啥的"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-16T10:21:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江湖文人"/> <meta itemprop="url" content="https://juejin.cn/user/3044986347066480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详细说一下nuxt generate是干啥的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044986347066480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江湖文人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T10:21:52.000Z" title="Fri Jan 16 2026 10:21:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p><code>nuxt generate</code> 是 Nuxt.js 框架的一个**静态站点生成（Static Site Generation, SSG）**命令。我来详细解释一下它的含义和作用：</p>
<h2 data-id="heading-0">是什么？</h2>
<p><code>nuxt generate</code> 命令会将你的 Nuxt 应用预渲染为静态 HTML 文件。它会：</p>
<ul>
<li>为每个路由生成对应的 HTML 文件</li>
<li>将生成的静态文件保存在 <code>dist/</code> 目录中</li>
<li>包含必要的 CSS、JavaScript 和资源文件</li>
</ul>
<h2 data-id="heading-1">主要作用</h2>
<h3 data-id="heading-2">1. <strong>性能优化</strong></h3>
<ul>
<li>预生成的 HTML 文件无需服务器端渲染，加载速度极快</li>
<li>CDN 友好，可以轻松缓存</li>
<li>减少服务器压力和响应时间</li>
</ul>
<h3 data-id="heading-3">2. <strong>SEO 优化</strong></h3>
<ul>
<li>搜索引擎可以直接抓取静态 HTML 内容</li>
<li>更好的 SEO 表现（相比于纯客户端渲染）</li>
</ul>
<h3 data-id="heading-4">3. <strong>部署简单</strong></h3>
<ul>
<li>生成的文件可以部署到任何静态主机：
<ul>
<li>Netlify、Vercel、GitHub Pages</li>
<li>AWS S3、Firebase Hosting</li>
<li>Nginx、Apache 等传统服务器</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">4. <strong>成本效益</strong></h3>
<ul>
<li>无需专门的 Node.js 服务器</li>
<li>可以使用廉价的静态托管服务</li>
</ul>
<h2 data-id="heading-6">使用场景</h2>
<h3 data-id="heading-7">适合使用 <code>nuxt generate</code>：</h3>
<p>✅ <strong>内容型网站</strong>：博客、文档、营销页面<br/>
✅ <strong>数据不频繁变化</strong>：产品展示页、公司官网<br/>
✅ <strong>需要优秀 SEO</strong> 的应用<br/>
✅ <strong>高访问量</strong> 的只读页面</p>
<h3 data-id="heading-8">不适合使用（需要考虑 SSR 或 CSR）：</h3>
<p>❌ <strong>用户个性化内容</strong>：每个用户看到的内容不同<br/>
❌ <strong>实时数据</strong>：股票行情、聊天应用<br/>
❌ <strong>频繁更新</strong>：社交媒体动态<br/>
❌ <strong>需要身份验证</strong> 的页面（可通过混合模式解决）</p>
<h2 data-id="heading-9">基本使用</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成静态文件</span>
nuxt generate

<span class="hljs-comment"># 生成后预览</span>
nuxt generate &amp;&amp; nuxt start

<span class="hljs-comment"># 构建并生成（常用）</span>
npm run generate
<span class="hljs-comment"># 在 package.json 中通常配置为：</span>
<span class="hljs-comment"># "scripts": {</span>
<span class="hljs-comment">#   "generate": "nuxt generate"</span>
<span class="hljs-comment"># }</span>
</code></pre>
<h2 data-id="heading-10">配置示例</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// nuxt.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">target</span>: <span class="hljs-string">'static'</span>, <span class="hljs-comment">// 明确指定为静态站点</span>
  <span class="hljs-attr">generate</span>: {
    <span class="hljs-comment">// 动态路由需要指定</span>
    <span class="hljs-attr">routes</span>: [
      <span class="hljs-string">'/users/1'</span>,
      <span class="hljs-string">'/users/2'</span>,
      <span class="hljs-string">'/blog/post-1'</span>
    ],
    <span class="hljs-comment">// 或者异步获取路由</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">routes</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> $fetch(<span class="hljs-string">'/api/posts'</span>)
      <span class="hljs-keyword">return</span> posts.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> <span class="hljs-string">`/blog/<span class="hljs-subst">${post.id}</span>`</span>)
    }
  }
}
</code></pre>
<h2 data-id="heading-11">工作流程</h2>
<pre><code class="hljs language-css" lang="css">执行 nuxt generate
    ↓
Nuxt 启动构建过程
    ↓
为每个路由生成 <span class="hljs-selector-tag">HTML</span>
    ↓
提取 CSS 和 JavaScript
    ↓
保存到 dist/ 目录
    ↓
完成！可以部署到任何静态主机
</code></pre>
<h2 data-id="heading-12">与 <code>nuxt build</code> 的区别</h2>
<ul>
<li><strong><code>nuxt generate</code></strong>：生成静态 HTML 文件，用于静态托管</li>
<li><strong><code>nuxt build</code></strong>：构建应用，用于服务器端渲染（SSR）部署</li>
</ul>
<h2 data-id="heading-13">高级特性</h2>
<h3 data-id="heading-14">1. <strong>混合模式</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 部分页面静态生成，部分页面动态渲染</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">generate</span>: {
    <span class="hljs-attr">exclude</span>: [
      <span class="hljs-string">'/dashboard'</span>,  <span class="hljs-comment">// 这个页面保持动态</span>
      <span class="hljs-string">'/admin/**'</span>    <span class="hljs-comment">// 所有 admin 页面都动态</span>
    ]
  }
}
</code></pre>
<h3 data-id="heading-15">2. <strong>增量静态再生</strong></h3>
<p>可以通过定时任务重新生成部分页面。</p>
<h2 data-id="heading-16">实际示例</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建 Nuxt 项目</span>
npx nuxi@latest init my-static-site

<span class="hljs-comment"># 2. 安装依赖</span>
<span class="hljs-built_in">cd</span> my-static-site
npm install

<span class="hljs-comment"># 3. 生成静态文件</span>
npm run generate

<span class="hljs-comment"># 4. 查看生成的文件</span>
<span class="hljs-built_in">ls</span> -la dist/
<span class="hljs-comment"># 会看到 index.html, about.html 等</span>

<span class="hljs-comment"># 5. 本地测试生成的文件</span>
npx serve dist/
</code></pre>
<p>总之，<code>nuxt generate</code> 是 Nuxt.js 强大的静态站点生成功能，特别适合需要优秀性能、SEO 和低成本部署的场景。对于适合静态化的项目，它能提供极佳的用户体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[幽灵节点导致Rancher状态卡死]]></title>    <link>https://juejin.cn/post/7595772638880677939</link>    <guid>https://juejin.cn/post/7595772638880677939</guid>    <pubDate>2026-01-16T09:29:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595772638880677939" data-draft-id="7595772638880563251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="幽灵节点导致Rancher状态卡死"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2026-01-16T09:29:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jevanshy"/> <meta itemprop="url" content="https://juejin.cn/user/3938906715990890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            幽灵节点导致Rancher状态卡死
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3938906715990890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jevanshy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:29:02.000Z" title="Fri Jan 16 2026 09:29:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">幽灵节点导致Rancher状态卡死Updating</h2>
<h3 data-id="heading-1">问题背景</h3>
<p>本地测试环境通过 Rancher 部署并管理本地 <strong>k3s</strong> 集群</p>
<p>Rancher 本身运行正常，可添加节点通过 UI 和 local 集群的 shell 操作 Kubernetes</p>
<h3 data-id="heading-2">问题现象</h3>
<p>K8s 集群custom-2d74d4c9a104节点状态一直显示：Waiting for agent to check in and apply initial plan</p>
<p>集群轮换证书时会一直卡在此节点后阻碍其它节点的操作（不仅仅限于证书轮换）</p>
<p>configuring etcd node(s) custom-898d97f03763: waiting for plan to be applied</p>
<h3 data-id="heading-3">排查步骤</h3>
<p>1、因集群中<strong>Machine</strong>名称无法与<strong>K8s</strong>节点名称对应，需先对应是哪一个节点出了问题</p>
<ul>
<li>
<p>可使用排除法，因为正常的节点会显示<strong>node</strong>名称</p>
</li>
<li>
<p>通过<strong>rancher2_connection_info.json</strong>文件查看 <strong>secretName</strong>名称，取出名称后做一一对应</p>
<pre><code class="hljs language-shell" lang="shell">cat /var/lib/rancher/agent/rancher2_connection_info.json
{
  ......
  "namespace": "fleet-default",
  "secretName": "custom-f489526f114a-machine-plan"
}
</code></pre>
</li>
</ul>
<p>通过以上方案排查出异常节点为 <strong>dev-k8s-node01</strong></p>
<p>2、确定异常节点后，查看 <strong>node01</strong> 的 <strong>rancher2_connection_info.json</strong> 文件，可以看到node01的 <strong>custom-id</strong> 在 <strong>rancher</strong> 中不存在，而 <strong>rancher</strong> 中的 <strong>custom-id</strong> 在所有节点中均不存在</p>
<p>3、查看 <strong>node01</strong> 服务器上 <strong>rancher-system-agent</strong> 服务状态，能看到服务一直启动失败并一直试图自动重启，查看服务相关日志，可以看到服务启动后尝试连接集群，但是因为证书验证失败无法加入</p>
<pre><code class="hljs language-shell" lang="shell">[root@dev-k8s-node01 ~]# journalctl -xefu rancher-system-agent
1月 15 16:04:02 dev-k8s-node01 systemd[1]: Started Rancher System Agent.
-- Subject: Unit rancher-system-agent.service has finished start-up
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- 
-- Unit rancher-system-agent.service has finished starting up.
-- 
-- The start-up result is done.
1月 15 16:04:02 dev-k8s-node01 rancher-system-agent[6042]: time="2026-01-15T16:04:02+08:00" level=info msg="Rancher System Agent version v0.3.3 (9e827a5) is starting"
1月 15 16:04:02 dev-k8s-node01 rancher-system-agent[6042]: time="2026-01-15T16:04:02+08:00" level=info msg="Using directory /var/lib/rancher/agent/work for work"
1月 15 16:04:02 dev-k8s-node01 rancher-system-agent[6042]: time="2026-01-15T16:04:02+08:00" level=info msg="Starting remote watch of plans"
1月 15 16:04:03 dev-k8s-node01 rancher-system-agent[6042]: time="2026-01-15T16:04:03+08:00" level=fatal msg="error while connecting to Kubernetes cluster: the server has asked for the client to provide credentials"
1月 15 16:04:03 dev-k8s-node01 systemd[1]: rancher-system-agent.service: main process exited, code=exited, status=1/FAILURE
1月 15 16:04:03 dev-k8s-node01 systemd[1]: Unit rancher-system-agent.service entered failed state.
1月 15 16:04:03 dev-k8s-node01 systemd[1]: rancher-system-agent.service failed.
1月 15 16:04:08 dev-k8s-node01 systemd[1]: rancher-system-agent.service holdoff time over, scheduling restart.
1月 15 16:04:08 dev-k8s-node01 systemd[1]: Stopped Rancher System Agent.
-- Subject: Unit rancher-system-agent.service has finished shutting down
-- Defined-By: systemd
-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel
-- 
-- Unit rancher-system-agent.service has finished shutting down.
</code></pre>
<h3 data-id="heading-4">解决步骤</h3>
<p>1、通过 <strong>Rancher</strong> 控制台的 <strong>local</strong> 集群打开 <strong>kubectl shell</strong> 控制台，在控制台中执行强制删除命令，命令执行完成后返回 <strong>force delete</strong> 但是资源仍然存在</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash">kubectl -n fleet-default delete machine custom-2d74d4c9a104 --force</span>
</code></pre>
<p>2、通过 <strong>Rancher</strong> 控制台的 <strong>local</strong> 集群打开 <strong>kubectl shell</strong> 控制台，删除 <strong>custom</strong> 节点对应的 <strong>finalizers</strong> 条目，执行完成后 <strong>custom</strong> 节点被自动清理</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash">kubectl edit machine custom-2d74d4c9a104 -n fleet-default</span>
<span class="hljs-meta prompt_"># </span><span class="bash">找到 finalizers: 部分，删除其下的所有条目，保存退出</span>
</code></pre>
<p>3、<strong>custom</strong> 节点清理后，可以看到集群开始轮换证书，更新配置等操作</p>
<pre><code class="hljs language-shell" lang="shell">configuring worker node(s) custom-3524fa7f0d71,custom-3b154219b4e1,custom-40e383a8d1da and 10 more
</code></pre>
<p>4、在 <strong>node01</strong> 服务器重新执行 <strong>Registration Command</strong> 命令加入集群</p>
<h3 data-id="heading-5">原因分析</h3>
<h4 data-id="heading-6">Finalizers</h4>
<p>Finalizer 是带有命名空间的键，告诉 Kubernetes 等到特定的条件被满足后， 再完全删除被标记为删除的<a href="https://link.juejin.cn?target=https%3A%2F%2Fkubernetes.io%2Fzh-cn%2Fdocs%2Freference%2Fusing-api%2Fapi-concepts%2F%23standard-api-terminology" target="_blank" title="https://kubernetes.io/zh-cn/docs/reference/using-api/api-concepts/#standard-api-terminology" ref="nofollow noopener noreferrer">资源</a>。 Finalizer 提醒<a href="https://link.juejin.cn?target=https%3A%2F%2Fkubernetes.io%2Fzh-cn%2Fdocs%2Fconcepts%2Farchitecture%2Fcontroller%2F" target="_blank" title="https://kubernetes.io/zh-cn/docs/concepts/architecture/controller/" ref="nofollow noopener noreferrer">控制器</a>清理被删除的对象拥有的资源。</p>
<p>当你告诉 Kubernetes 删除一个指定了 Finalizer 的对象时， Kubernetes API 通过填充 <code>.metadata.deletionTimestamp</code> 来标记要删除的对象， 并返回 <code>202</code> 状态码（HTTP "已接受"）使其进入只读状态。 此时控制平面或其他组件会采取 Finalizer 所定义的行动， 而目标对象仍然处于终止中（Terminating）的状态。 这些行动完成后，控制器会删除目标对象相关的 Finalizer。 当 <code>metadata.finalizers</code> 字段为空时，Kubernetes 认为删除已完成并删除对象。</p>
<p>在 Kubernetes 架构中，<code>Finalizers</code> 是一种<strong>资源清理保护机制</strong>。确保在删除一个对象前，与其关联的外部资源（如云平台的负载均衡器、磁盘卷或 Rancher 的管理 Agent）能够被优雅地清理。当 <code>finalizers</code> 列表为空时，K8s 才会真正从 Etcd 中擦除该数据。</p>
<h4 data-id="heading-7">为何产生“幽灵节点”？</h4>
<p><strong>触发点</strong>：由于 node01 的 Agent 凭证失效，导致 node01 无法向 Rancher Server 上报状态。</p>
<p><strong>状态异常</strong>：Rancher 认为该节点失联，尝试重新同步或用户尝试删除该节点以重建。</p>
<p><strong>清理阻塞</strong>：<code>machine</code> 资源上存在的 Finalizers无法确认清除。Rancher 的控制器在尝试清理该节点时，需要通过 Agent 下发指令，但此时 <strong>Agent 连接已断开</strong>。</p>
<p><strong>幽灵化</strong>：清理逻辑由于通信失败而卡死，<code>Finalizers</code> 永远无法被移除，导致该节点资源在 UI 中一直存在，但又无法与实际运行的 k3s 节点建立有效连接。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[聚焦大模型落地：2025 年推理优化、MCP 探索与部署权衡的实战心得]]></title>    <link>https://juejin.cn/post/7595615310180646966</link>    <guid>https://juejin.cn/post/7595615310180646966</guid>    <pubDate>2026-01-16T09:13:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595615310180646966" data-draft-id="7595527937833402422" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="聚焦大模型落地：2025 年推理优化、MCP 探索与部署权衡的实战心得"/> <meta itemprop="keywords" content="算法,后端,架构"/> <meta itemprop="datePublished" content="2026-01-16T09:13:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fanstuck"/> <meta itemprop="url" content="https://juejin.cn/user/3927915182964183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            聚焦大模型落地：2025 年推理优化、MCP 探索与部署权衡的实战心得
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3927915182964183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fanstuck
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T09:13:24.000Z" title="Fri Jan 16 2026 09:13:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读32分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>2025年对我来说是充满挑战和收获的一年。这一年里，我聚焦于大模型应用落地与推理优化，从工程实践中总结经验。从提升大模型推理性能、调优OpenAI API参数，到探索新兴的MCP协议以及反思大模型对开发者工作的影响，我经历了技术与思维范式的转变。在这篇年度复盘中，我将围绕几个关键主题分享我的心得，希望为各位开发者提供有价值的参考。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e9bce9b57f046efbb91d92f09fc1408~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=yE7sb25o7IBdxYmI1SabWcWNYkk%3D" alt="4e294c9b7cda85462ddc05faa8170148.gif" loading="lazy"/></p>
<h3 data-id="heading-1">一、大模型推理优化：挑战与解决策略</h3>
<p>大型语言模型的推理性能直接决定了AI系统给用户响应的速度和体验。即使是毫秒级的延迟增加，累计到数百万用户规模也会显著拉低满意度，影响业务收益。实际项目中，我深刻体会到推理优化不仅是技术问题，更关系到用户体验和企业盈利。举个现实案例：某电商平台上线AI购物助手时，模型推理延迟超过5秒，导致大量用户流失、转化率低迷；后来通过模型优化、批处理推理和推理框架升级（TensorRT），性能提升了数倍，延迟降至毫秒级，用户体验显著改善。这个案例直观证明了优化推理带来的巨大业务价值。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52b0eb2ae80c44beb4d7775bada18df9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=DfSSm460lOVux%2FzTbUlH5%2FbWLEo%3D" alt="图片.png" loading="lazy"/></p>
<p>然而，大模型推理的优化难度也让我屡屡碰壁。总结来看，主要挑战包括：</p>
<ul>
<li>模型超大，内存占用高：最新的大模型参数动辄数百亿甚至上万亿，每次推理相当于“翻遍图书馆找答案”，内存开销巨大。就像电脑同时打开上百个网页会耗尽内存，大模型推理也面临类似风险。</li>
<li>GPU算力利用不足：GPU很强大，但如果模型设计或部署不合理，常常只有30%左右的利用率，大量算力闲置。有点像开着法拉利在市区堵车，性能完全跑不出来，结果推理延迟高、成本反而上涨。</li>
<li>CPU↔GPU数据传输瓶颈：推理过程中频繁的数据拷贝会带来严重延迟。这就像服务员每次只端一小盘菜在厨房和餐桌间来回跑，效率奇低。在需要处理大量数据的场景（例如视频流分析）尤为突出。</li>
<li>模型结构冗余计算：大模型网络结构复杂，往往存在不必要的重复计算。就像导航让你绕远路，明明直线最优却平添许多无用功。一些未优化的Transformer模型每次推理都有大量冗余步骤，严重拖慢了速度。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/986b70d3d8e24ad78168fe6e7d4d2336~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=XH3GGxJ3%2Ba8JQMgl4%2Fs%2BvTzLQWc%3D" alt="图片.png" loading="lazy"/></p>
<p>上述因素叠加，使大模型推理优化成为一个系统性难题。认识这些瓶颈后，我针对性地实施了一系列优化策略，总体原则是在尽量不影响模型效果的前提下，压榨出每一分性能：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a67a0eefeeb8473db2ea2854ed85646c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=GNG5xS5qy2%2F5BbTN3BIa64x7%2By8%3D" alt="图片.png" loading="lazy"/></p>
<p>模型压缩与轻量化：通过模型量化将权重从FP32降低到FP16甚至INT8，减少内存占用和计算量；以及剪枝（Pruning）去除冗余连接，精简模型规模。例如我将部分Transformer权重量化为INT8后，模型大小缩减一半以上，推理提速明显（需注意低精度可能带来精度损失，需要权衡业务容错度）。同时采用知识蒸馏（Distillation），用小模型学习大模型的行为，在保持大部分能力的情况下极大降低计算需求—我曾将一个无法在手机运行的Qwen-14b级别模型蒸馏出一个轻量版部署在手机端，实现了流畅响应。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/047a4d12e26a4b07833baec25fcf53f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=akoQ82qdWtqKJUBlQVs1%2F0wF77A%3D" alt="图片.png" loading="lazy"/></p>
<p>模型架构优化：针对实时对话、在线推荐这类低延迟场景，我倾向用精简架构的模型替换原始大模型。例如用 DistilBERT、TinyGPT 这类蒸馏/裁剪模型替换繁重的完整版模型，在略微牺牲精度的情况下换取数倍的推理提速。这就像打造一辆只保留核心功能、去掉累赘装饰的赛车，只为追求速度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/448b1e9a0dd94afe9965d9e4febf17dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=WzD1Ao%2BoDmAkhXAnWxZ8E7n8OQc%3D" alt="图片.png" loading="lazy"/></p>
<p>推理框架与硬件加速：选择合适的推理引擎对性能至关重要。我根据项目需求在不同方案间切换：本地部署快速原型时使用简单易用的框架，如 Ollama（资源占用低，部署方便）；追求极致性能时，则使用高性能推理服务或优化库，如 vLLM（具备批量调度等优化，能充分利用高端硬件并发）或 NVIDIA TensorRT（对GPU做深度图优化和算子融合）。例如在一项需处理大规模并发请求的服务中，我将模型部署切换到vLLM，利用其高效的连续批处理机制，让GPU吞吐能力大幅提升；又在GPU集群上借助TensorRT对模型计算图进行了编译优化，最终单机QPS提高了数倍。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c97ceec28bb45e3b96b419ae427eae4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=bwH9pHHdOFvmYAkzOX6rpfcQc2Y%3D" alt="图片.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5335c76247754d7ea323de12ab7d68a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=MYZlqeRgSdDfakgOw4%2BC3QUjViw%3D" alt="图片.png" loading="lazy"/></p>
<p>算子级别优化：通过融合算子、优化GPU内核来减少不必要的开销。我使用 PyTorch JIT 将模型脚本化，自动将多个连续算子融合为一个，减少中间内存读写和调度开销。例如，通过下面一行代码对模型进行脚本化：</p>
<p>scripted_model = torch.jit.script(model) # 脚本化模型以自动执行算子融合优化</p>
<p>PyTorch 会分析模型计算图，自动识别并融合可合并的算子，相当于把多步运算合成一步。无需手工改模型代码，就完成了算子级优化，大幅加快推理速度。</p>
<p>推理流水线并行：我将推理过程拆分为输入预处理 → 模型推理 → 输出后处理等阶段，通过流水线并行处理不同阶段，尽量消除各环节之间的等待时间。比如当模型在处理前一个请求时，下一请求的数据预处理已经在CPU上并行进行，再下一个请求的后处理也在同步进行。这样多段流水线重叠运行，整体延迟显著降低。如同餐厅后厨并行备菜、炒菜、装盘，提高了出菜速度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed97d0b7f3db46d982bf1b20fdba7494~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=bsWxsODORorVhehpNetlM95YFlc%3D" alt="图片.png" loading="lazy"/></p>
<p>经过上述多管齐下的优化，我在多个项目中将大模型推理从“勉强能跑”提升到了“高效好用”的水平。需要强调的是，优化手段的选择没有通用最优解，必须结合具体业务场景和硬件条件综合考量。有时需要同时应用多种手段并配合细致的实验调参，才能找到性能、成本和效果的最佳平衡点——但当你看到优化后的模型毫秒级响应、服务器资源利用率显著提升时，这一切付出都是值得的。</p>
<h3 data-id="heading-2">二、OpenAI SDK与主流推理框架：调优实践与经验</h3>
<p>在大模型应用开发中，我大量使用了 OpenAI 官方的Python SDK 作为基础接口。之所以选择它，是因为如今业界大多数大模型服务都兼容OpenAI API，而官方SDK本身完善易用、功能全面，能够方便地统一调用各种模型。通过OpenAI SDK这一套接口，不仅可以对接OpenAI自家的GPT-4/3.5模型，也能很容易集成其他厂商的大模型API，实现多模型融合。这种标准化极大加快了开发速度——“一套代码，通用多种模型”。因此在2025年的不少项目里，我都优先采用OpenAI SDK搭建原型，然后再根据需要切换到底层不同模型或框架。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/807c1608f9a94ba09a6867c9dc3e979e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=Bh2qcUft5JIxupDpfDlUSc7L3qk%3D" alt="图片.png" loading="lazy"/></p>
<p>通用多种模型”。因此在2025年的不少项目里，我都优先采用OpenAI SDK搭建原型，然后再根据需要切换到底层不同模型或框架。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4f25f9eee79460e9cc54b67afaebe0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=IZfcrzWSAXe0x3pVL1iQfYC%2B%2Bf4%3D" alt="" loading="lazy"/></p>
<ul>
<li>**</li>
<li>**</li>
<li>**</li>
<li/>
<li>**</li>
<li>**</li>
<li/>
<li>**</li>
<li/>
<li>**</li>
</ul>
<p>fig:</p>
<p>参数调优是用好OpenAI API的关键。 在实践中，我发现合理设置模型参数往往比盲目换更大模型更有效。OpenAI的ChatCompletion等接口提供了丰富的参数，可以微调生成内容的风格和质量。我常根据不同应用场景调整诸如温度、top_p、惩罚项等参数，以满足需求：</p>
<ul>
<li>客服问答场景：追求准确、简洁。将 temperature 调低到 ~0.2，top_p 调低到 ~0.5，减少回答的随机性，确保严谨一致。同时设定较小的 max_tokens（如100），避免模型啰嗦。</li>
<li>创意内容场景：需要发散、多样。将 temperature 提高到 ~0.8，top_p 提高到 ~0.9，增加随机性和创造力。并适当提高 presence_penalty 和 frequency_penalty，鼓励使用新颖表达、降低重复。</li>
<li>数据分析/报告场景：追求结构化和准确。保持 temperature 较低 (~0.3)，top_p 较低 (~0.6)，让输出确定、一致。同时设置适当的 max_tokens 上限（如200），防止内容截断并确保简洁。</li>
</ul>
<p>通过这些调优，我能精细控制模型回答的随机性、创造性和长度，使之符合预期。相反，如果参数设置不当，模型输出质量会大打折扣。例如：温度设置过高会导致回答天马行空、偏离主题（曾有测试中温度1.2时，询问菜谱却得到“去火星拿番茄”的荒诞答案）；温度设为0则可能使生成过于死板枯燥；max_tokens太小还会让长文回答中途被截断，丢失关键信息。可见，参数犹如调音台的各个滑杆，需要根据场景巧妙配合，找到恰到好处的“火候”。正因如此，掌握参数调优对于开发者来说非常重要——它直接关系到成本控制（如避免不必要的长输出浪费Token）/用户体验（回答是否合适）/业务适配（不同场景下输出风格迥异）等方方面面。</p>
<p>实践心得： 在实际项目中，我常常把调整参数当作与模型对话的艺术：“模型是死的，Prompt和参数才是活的”。遇到模型回答偏差，我不会一味抱怨模型不好用，而是先反思是否提示词(prompt)和参数没调优。当我耐心地调低一点温度、增加一点罚值，再次提问时，模型往往会给出令人满意的回应。这种调参过程其实是加深对模型脾性的了解——就像训马一样，慢慢摸索出缰绳的用力方式。</p>
<p>除了OpenAI云服务，今年我也探索了多种本地化的大模型推理框架，以满足不同部署需求。这些开源或第三方框架各有特点：</p>
<ul>
<li>Ollama – 主打一键本地部署和轻量级运行。它对资源要求低，安装使用非常简单，适合对速度要求不高但希望快速离线运行模型的场景。在资源受限的设备上（如笔记本电脑），Ollama往往是不错的选择，因为它占用少、易上手。</li>
<li>vLLM – 强调高性能服务的大模型推理库。vLLM内部采用了高效的连续批处理和内存管理技术，能够在有足够硬件支持的情况下，实现比传统方案更低的延迟和更高的吞吐。如果有较强的GPU算力，并发请求量也大，那么选择vLLM可以充分榨干硬件性能，获得业界领先的推理效率。</li>
<li>TensorRT – NVIDIA提供的深度学习推理引擎，专注于极致的GPU性能优化。通过模型层融合、kernel autotune等手段，把模型在GPU上的执行效率推到极限。我在项目中使用TensorRT对模型进行优化编译后，单卡推理延迟减少了数倍，非常适合对速度要求极高的云端服务。不过，TensorRT集成相对复杂，需要一定的GPU编程经验来排查兼容性和精度问题，但一旦调通，收获的性能提升也是巨大的。</li>
</ul>
<p>此外还有一些框架：如ONNX Runtime适合部署在CPU服务器上，可开启多线程和内存优化，充分挖掘CPU性能；TorchServe则方便将PyTorch模型快速包装成服务API，便于在生产环境中部署推理服务。这些工具我也在不同项目中有所尝试。我的体会是，推理框架没有银弹，只有“合适”与否：简单应用不一定要用最重型的方案，资源充足时也别错过性能优化的机会。选型时应考虑团队技术基础、硬件条件和性能目标，在易用性与性能之间寻找最佳平衡。例如，小团队做原型时用Ollama快速跑通功能优先，产品上线面向大流量用户时再切换vLLM或TensorRT优化性能——先跑起来，再跑快起来，分阶段逐步升级，是我的一条经验法则。</p>
<h3 data-id="heading-3">三、MCP在本地智能体中的角色：反思与取舍</h3>
<p>今年AI圈有一个热点话题是 MCP 协议（Model Context Protocol）的兴起。Anthropic在2024年底开源了MCP，旨在为AI助手连接外部工具提供统一标准。我也第一时间投入了研究和实践，亲手开发了本地MCP服务器，并构建了一个LLM+MCP的工具链项目（比如一个论文检索和摘要生成的智能Agent）。经过这一年的折腾，我对“MCP到底是必需品还是过渡方案”有了一些思考和反悟。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68ac99e961064454a636cade1be37cdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=4P1Zm3MvFDNmvy6W8XPagnZYW%2Fo%3D" alt="图片.png" loading="lazy"/></p>
<p>MCP是什么？ 简单来说，MCP提供了一种标准协议，让本地AI Agent可以方便地调用外部工具和数据源，相当于给桌面端的智能体安了一个“万能工具箱”接口。举个例子：本地的代码助手应用 Cursor 就通过MCP实现了动态插件加载，开发者不用为每个新工具写适配代码，只要遵循MCP协议，就能让Agent随时调用如代码搜索、文档查询、代码生成等各种能力。MCP的通信机制底层使用 SSE（Server-Sent Events）长连接配合 HTTP 短轮询的双通道模式，这种“客户端优先”的设计在本地环境中非常有效——长连接确保了工具调用的低延迟，动态发现机制则给予Agent几乎无限的扩展性。我在自己的实践中也验证了这些优点：基于MCP协议，我很快搭建了一个本地论文检索+摘要的Agent服务。MCP极大降低了接入论文数据库这种单一数据源工具的难度，只需简单配置就能稳定地调用工具；同时由于是在单机环境，SSE长连接运行十分稳定，没有遇到性能瓶颈。可以说，在本地单机/单用户场景下，MCP让开发AI助手变得前所未有的简单高效。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3e9004c2b4e46568801cf203fb397a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=XxaLvXUBLV9dG6H%2B3CU%2FSIhd%2FpI%3D" alt="图片.png" loading="lazy"/></p>
<p>然而，MCP并非毫无短板。当我尝试将MCP应用到更大规模、分布式、高并发的环境中时，问题暴露无遗。在云端部署的知识库问答服务中，面对大量并发请求需要做负载均衡和多机分布。这时MCP的双连接模式成为了瓶颈：服务器需要维持海量SSE长连接，占用巨大资源，而且跨多个节点时工具寻址逻辑复杂低效。简单来说，MCP在云端扩展时不够“云原生”：长连接就像高速路上的单车道，连接一多就排队堵塞；每次HTTP短连接调用又不断建立/关闭，好比频繁开关临时岔路，增加额外延迟。对于一些实时性要求极高的场景（例如金融风控需要毫秒级响应），MCP现有方案几乎无法满足——光连接开销就可能拖慢系统，哪怕答案再准时也晚了。我认识的团队里就有尝试用MCP做云端Agent的，最后不得不放弃转向别的方案，因为MCP一上云就“水土不服”，性能压力和实现复杂度都难以接受。</p>
<p>那么，MCP是刚需还是过渡？ 我的观点是：它适合的场景非常明确，但超出边界就力不从心。在本地桌面、单机智能体领域，MCP确实填补了空白——提供了一个标准化、低门槛、高扩展性的工具调用框架，这方面它就是刚需，目前没有更好的替代品。但在云端大规模服务场景下，MCP暴露出的不足说明它更像一个过渡方案：业界需要新的技术路径（或者对MCP的大改进）来替代它。事实上，今年OpenAI推出的函数调用 (Function Calling)、LangChain等Agent编排框架、以及各类RAG检索增强方案，都在不同维度提供了替代思路：</p>
<ul>
<li>OpenAI函数调用：通过在提示中定义可用函数接口，让模型直接输出函数及参数来完成工具使用。这种方式对简单、标准化的工具（如查天气API、数据库查询）特别高效和精准。但缺点是不支持动态扩展新工具，也没有统一的发现和连接能力。所以对于需要灵活加载各种奇异工具的场景，函数调用替代不了MCP，但在调用明确API的场合，它要比MCP简单直接得多。</li>
<li>LangChain等Agent框架：LangChain在今年依然火热，它提供了高度灵活的Agent流程定制，可以组合多工具、多步骤推理。相比之下，MCP走的是标准化路线，上手快但不易深度定制。而LangChain几乎无所不能但实现复杂。我在评估项目需求时，如果工作流很复杂（需要条件分支、循环调用不同工具），会考虑LangChain这类框架；反之，如果只想快速给Agent插几个工具，MCP的简洁和低门槛更讨喜。</li>
<li>RAG（Retrieval-Augmented Generation）：RAG技术专注于给模型接入外部知识库检索，通过检索结果增强回答的准确性。在企业知识问答这类知识获取场景中，RAG往往效果比MCP好，因为它直接解决“让模型掌握知识”的问题。但RAG不涉及通用工具调用和交互，所以在动态工具加载、本地交互这些MCP擅长的领域，它并不能替代MCP。总的来说各有所长：MCP偏通用工具接口，RAG偏知识增强，各自服务不同目标。</li>
</ul>
<p>综合来看，没有哪个方案能一统天下。MCP、函数调用、LangChain、RAG...每个都在特定应用中表现优秀，也都有局限。今年我在项目中也常常需要取舍：本地用MCP方便，但上线云端换别的；有的功能用函数调用就够，就不引入复杂MCP等等。技术选型没有对错，只有适合与否。我的做法是先明确业务场景需求，再决定要不要用MCP。例如，公司内部开发者工具（单机版IDE助手），我会大胆采用MCP来获取开发效率的红利；但如果是大规模对外的在线服务，我倾向保守，除非MCP协议得到改进，否则会考虑更成熟高效的替代方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ea103d6c0cd446b8419c6c0f435281d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=f6uEXTha8YEKnfGej9yy8VElKYo%3D" alt="图片.png" loading="lazy"/></p>
<p>P来获取开发效率的红利；但如果是大规模对外的在线服务，我倾向保守，除非MCP协议得到改进，否则会考虑更成熟高效的替代方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7495421c56024bfca9cc5018cf9e04b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=rDCYAdL6etOEUVJxuUUfRdouHb8%3D" alt="" loading="lazy"/></p>
<ul>
<li>**</li>
<li>**</li>
<li>**</li>
<li/>
<li>**</li>
<li>**</li>
<li/>
<li>**</li>
<li/>
<li>**</li>
</ul>
<p>fig:</p>
<p>值得一提的是，MCP并非停滞不前。今年社区也在推进MCP的改进。例如讨论用 gRPC 取代 SSE 以降低通信延迟，提高并发能力；完善动态工具发现机制（比如引入工具市场和健康监测）以提升可靠性；以及融合其他技术的可能性——比如让MCP和函数调用、RAG结合，取长补短，形成混合型的新方案。未来的MCP可能脱胎换骨，也可能融入更大的生态。但在当下，理性看待MCP尤为重要：它不是万能药，也并非昙花一现的噱头。作为开发者，我们应清醒地根据自身业务需求来决定是否采用MCP，划定它的使用边界。正如我在思考后给出的结论——“桌面端用好MCP，云端慎用MCP”：在单机本地场景下MCP能快速带来生产力提升，而在大规模云服务里则需要慎重评估性能瓶颈，选择更合适的高性能方案。只有这样，才能让技术选型既发挥MCP的优势，又不被其局限所拖累，在实践中取得更高效、务实的成功。</p>
<h3 data-id="heading-4">四、大模型部署的平衡取舍：成本、性能与场景</h3>
<p>在大模型系统的部署过程中，我深刻体会到处处充满权衡取舍。模型越大越准但也越慢、硬件越强跑得越快但也越贵，云端服务强大却牺牲了本地自主……如何平衡这些维度，是每个工程决策必须面对的问题。这里我从几个常见角度总结我的经验：</p>
<ul>
<li>成本 vs 用户体验：很多时候，提升用户体验需要投入更多算力，意味着更高的成本。但如果一味省钱，用低配方案导致用户体验差，反过来会造成用户流失，商业损失更大。优化推理性能本质上是在拿计算成本换用户体验，而事实证明这笔账通常划算。正如前文电商案例展示的：增加GPU优化推理虽有成本，却显著提升了转化率，带来远超投入的收益。在我的项目决策中，会优先确保关键交互环节的体验：例如AI客服回复时间必须控制在2秒内，那么哪怕增加服务器开销也要做到，否则用户等不及走掉，损失更大。另一方面，也要合理控制成本：能通过算法优化解决的，不靠叠加硬件蛮力；能用较小模型满足需求的，不一定上最贵的GPT-4模型。举例来说，在一些日常问答场景下，我们选择用速度快、价格低的GPT-3.5模型替代GPT-4，因为后者虽然效果稍好但价格高出一个数量级，综合考虑3.5已经足够且响应更快。总之，要找到成本支出与体验收益的平衡点：既不给用户“省”体验，也不让成本无谓地飙升。</li>
<li>速度 vs 精度：响应速度和输出质量往往是此消彼长的关系。在交互式产品中，我体会到“快比全更重要”。用户更愿意迅速得到一个80分的答案，而不愿久等10秒才出100分答案。在实时性要求高的场景，我会优先牺牲一定精度来保证速度。例如在智能家居语音助手中，我们宁可用被量化/剪枝后略降精度的模型，也要确保问了就秒回。“答案再完美，迟到也是无用” 说的就是这个道理。当然，反过来在高精度要求的任务（如法律文书分析、医疗诊断），我会接受稍慢的推理，换用性能更强的大模型或 ensemble 方法确保万无一失。在这些情况下，还可以通过异步处理或分段加载等方式，在保持质量的同时部分掩盖延迟。例如某次我们做金融报告生成，采用了高精度的大模型离线生成初稿，然后让用户实时查看生成进度和中间结果，以降低主观等待时间。优化速度与保证质量是一对永恒张力，需要根据应用目的明确取舍：To be fast, or to be perfect? 我的经验是，对于大多数2B/2C应用，快和比较准比慢和极准更实用，毕竟绝大部分用户更在意效率，而不是学术竞赛式的极致准确。</li>
<li>边缘部署 vs 云推理：这是今年讨论很多的一个取舍点。边缘部署（例如在手机、浏览器、本地服务器上运行模型）带来的好处是数据隐私好、可离线运行、延迟低（没有网络开销），缺点是受设备算力限制模型必须足够小、性能有限。而云端推理可以动用强大算力跑超大模型，集中维护更新，但是需要网络连接且每次调用有额外延迟和成本。我的策略是按场景选择：如果应用强调隐私或长连接（如本地办公助手，希望数据不上传云端），我会尽量采用边缘部署的小模型。比如在手机端运行语音助手时，我用蒸馏和量化技术将模型压缩到可以在移动芯片上跑的程度，并借助诸如TensorFlow Lite、MNN 这类轻量推理框架，尽可能榨取手机CPU/GPU性能。实际效果虽然比不上云端大模型，但胜在随叫随用、零依赖，用户体验依然不错。而对于需要重模型支撑的服务，如客服机器人需要最强语言理解能力，那就只能上云用大模型，并通过负载均衡和多机并行来支持大流量。这种情况下成本会很高，我们会采取措施缓解：例如对常见简单问题用边缘/小模型先行处理，复杂请求再调云上大模型；或者对付费用户提供大模型高精度回答，免费用户用小模型粗略回答，以此控制总体成本。混合部署也是一种思路：边缘 + 云协同，各取所长。今年有不少相关探索，例如一些浏览器插件内置本地小模型快速响应，同时后台有云端强模型优化答案。我自己的体会是，边缘和云并非对立，而是可融合：关键看应用场景和用户诉求。在能够本地满足的场合，就让用户装个小模型享受0延迟；在本地跑不动的任务，就老老实实用云，把网络和费用的问题通过产品策略去平衡解决。</li>
</ul>
<p>在实践中，我常用一个原则四象限来帮助决策复杂的部署问题：场景导向、硬件匹配、成本平衡、扩展性预留。举个例子，我们曾帮一家自动驾驶公司部署车载目标检测模型——边缘硬件算力有限又要求实时性，这是个典型的“边缘低延迟”场景。我和团队综合考量后采取了组合策略：(1) 场景导向：首要优化延迟，因此对模型做了剪枝和量化处理以加速推理；(2) 硬件匹配：针对车载GPU的架构特点，使用Nvidia TensorRT对模型进一步优化编译，充分利用硬件加速；(3) 成本平衡：引入知识蒸馏训练了一个小模型，使系统对高端芯片依赖降低，如此在不影响效果前提下选用了性价比更高的芯片方案；(4) 扩展性：设计了可动态调整的流水线，并预留接口以便日后更换传感器或算法时快速适配。最终部署结果非常成功：每帧图像的处理延迟满足毫秒级要求，整车AI模块成本也控制在预算内，且具有良好的升级弹性。这个案例体现了多维度权衡的价值：只有同时关注场景需求、硬件特点、投入产出和未来演进，才能做出最优的工程决策。</p>
<p>总的来说，大模型部署就像在性能、精度、成本三者之间走钢丝，需要不断调整平衡点。没有完全完美的方案，只有最适合当下约束的方案。2025年的实践让我更加坚定这一观点：面对具体问题，先明确优先级，再兼顾次要目标，理性取舍。技术人最终要为业务结果服务，在保证核心价值的前提下，灵活运用各种优化和架构方式，把有限的资源发挥出最大的效能。</p>
<h3 data-id="heading-5">五、大模型与开发者：能力扩展与思维演进的个人反思</h3>
<p>这一年，大模型技术突飞猛进的同时，也深刻改变了开发者的工作范式和思维方式。作为一名AI工程师，我在实践中切身体会到自身角色定位的转变和认知边界的拓展与挑战。</p>
<p>首先，在开发AI系统的工作上，工程师的角色正在从传统的“算法构建者”转变为“大模型的驯养师和维护者”。以往我们写代码实现规则和算法，而现在更多的时候是利用海量数据训练模型、调整参数，让模型去自动学习。这意味着我不得不让渡出一部分对细节的掌控，相信模型通过数据自我优化的能力。典型的例子是超大模型里的某些决策机理，我们很难完全弄懂，模型越庞大就越像一个黑箱。这促使我更加关注AI系统的可解释性和对齐性问题：如何确保在追求能力的同时，人类仍握有“方向盘”，而不是任由AI演化失控。这一切正是“Software 2.0”范式带来的思考——当代码不再完全由人写出，而是由数据训练得来，我们需要重新定义人与软件的关系边界。</p>
<p>其次，在日常使用大模型辅助创作和编码方面，我的工作方式和能力边界也发生了变化。以前写代码完全靠自己一个字符一个字符敲，现在有了像GitHub Copilot这样的AI助手，“身边多了一个经验丰富的搭档”。我感觉自己的开发带宽被极大拓宽：可以更快学习陌生领域的知识，有AI帮忙生成初始代码框架，我就有更多精力投入架构和逻辑层面。这种人机协作确实提升了效率——一些研究也表明，引入AI工具后程序员的产出明显提高，初级工程师进步尤其大。类似地，在内容创作上，大模型帮我代笔初稿、提供灵感，我能够更快地产出高质量方案。然而，这种能力增强的另一面是对自身技能提升的隐忧。我发现自己现在花更多时间在审查和调试AI给出的结果，而从零思考和动手的机会减少了。对于有经验的人来说，这未必是坏事，我们可以利用节省下来的时间处理更高层次的问题；但对于新人来说，长期依赖AI自动补全，可能会忽略打牢基本功。我带团队的过程中就意识到，有些年轻工程师一上来就用现成模型解决问题，遇到新问题时如果AI也不懂，他们自己也缺乏独立分析的能力。这提醒我，在享受AI带来的便利时，必须警惕过度依赖导致的能力退化。</p>
<p>从更广阔的角度看，大模型给开发者带来了“能力延展”与“认知让渡”的张力。一方面，LLM是强大的认知扩展器。它让我们如虎添翼，每个人都能借助AI完成本来可能力所不及的任务。就像国际象棋中的“半人马”模式，人类棋手+AI能击败纯AI，可见人机结合能够创造1+1&gt;2的效果。这种协同让我相信，在理想情况下，大模型并非取代我们，而是帮我们成为更强的自己。我在2025年的工作中多次体会到这一点：当我把AI当成助手而非对手，我能更快地获取知识、解决问题、探索创新路径。正如有学者所说，我们和AI的关系正从简单的“我-工具”进化到“我-你”的合作伙伴关系——AI扩展了人的认知边界，人也在塑造着AI的行为。这种人机共生的新范式让我对未来充满期待。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87007fecf9a94b2dadbeb20524f407dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=aV8d8YXyP1WkkRayfokVIQu2bBA%3D" alt="图片.png" loading="lazy"/></p>
<p>但另一方面，我们也不可忽视“认知主权”的让渡。当我们越来越依赖AI，会不会渐渐丧失自主思考的习惯？有研究警示说，频繁使用AI工具的人，其批判性思维得分显著下降。过度依赖导航会让人丧失方向感，类似地，过度依赖大模型会带来“认知卸载”现象——大脑因为省事把任务都丢给机器，久而久之思维能力可能退化。这一点我也有所警觉：当ChatGPT给出答案时，我是否还会本能地去验证、多想一步？当决策越来越依赖模型建议时，我是否在不知不觉中放弃了思考主导权？2025年的几次经历让我印象深刻：有次我们团队因为过分信赖模型输出的分析结论，险些做出错误决策，所幸及时发现模型其实给出了不正确的依据。这件事之后，我们加强了对AI输出的交叉验证和人审流程。我也在团队内部反复强调：AI再聪明，最后拍板的一定得是人。我们绝不能变成AI的执行者，而要让AI成为我们的工具。</p>
<p>保持批判性和掌控权是我在大模型时代给自己定下的准则。具体来说：第一，不把AI视作权威，对重要结果保持质疑，必要时查证模型回答的来源；第二，不让AI主导创造力输出，每当AI给出方案，我都会尝试自己提出改进或替代思路，确保自己大脑一直参与；第三，持续学习底层原理，哪怕模型封装得很好，我也尽量了解其基本工作机制（比如Transformer为什么会幻觉），这样遇到异常情况才能有独立判断。归根结底，我认同一句话：“工具并不可怕，可怕的是我们失去主动调适的意志”。面对大模型这把“双刃剑”，关键在于我们人类如何主动定位自己的角色——是让AI成为认知延长线，还是让AI牵着鼻子走。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f659aeb697ce41b2861c73791a3732fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZmFuc3R1Y2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769159604&amp;x-signature=0x9UuYU5pTHKlqMDe8oFiiH8MG0%3D" alt="图片.png" loading="lazy"/></p>
<p>让我欣慰的是，业界和社会已经开始重视这些问题。教育领域在讨论如何培养下一代具备AI素养：既会用AI又不迷信AI，保有创造力和批判精神。企业和监管层面也在制定伦理规范和使用指南，要求AI应用透明可控、保护数据隐私，防止过度依赖和滥用。这种“增强而非替代”的价值取向正在形成共识——即把大模型视为人类智能的扩展工具，而非智慧的替身。我个人在团队管理中，也开始有意识地打造人机协同的工作流程：鼓励大家用AI加速完成基础工作，但最终结果一定要经过人工复核和调整，以确保输出既高效又有人的创意和判断在里面。</p>
<p>最后，我想以我的亲身感悟作结：大模型既不是单纯的工具，也不是要取代我们的主人；它带领我们进入了人机共生的新阶段。在这个阶段中，技术的意义取决于使用者的初衷和方式。如果我们以主动、审慎的态度拥抱大模型，它会成为我们才能的延展，助力我们探索未知领域；反之，若我们不加分辨地沉迷于其便利，任其塑造认知，我们可能会在不经意间迷失自我。或许未来最理想的图景不是人机对立，而是你中有我、我中有你的协同进化——人类掌舵价值方向，AI提供前所未有的智慧和创造力，两者融合去完成任何一方单独都无法完成的宏图。正如有人所说，AI不一定是为了取代你——它可能是为了将你升级成为更好的自己。但这个“升级”的方向盘必须牢牢掌握在我们自己手中。展望未来，我坚信能力延展与认知主权并非不可兼得：唯有保持清醒与主动，我们开发者才能在这场巨变中既驾驭好技术之舟，又守护住宝贵的创造力之灯，真正实现与AI一起迈向更美好的明天。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[美团又上新模型，8个Thinker齐开工，能顶个诸葛亮？]]></title>    <link>https://juejin.cn/post/7595683968684261422</link>    <guid>https://juejin.cn/post/7595683968684261422</guid>    <pubDate>2026-01-16T10:37:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595683968684261422" data-draft-id="7595772638881169459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="美团又上新模型，8个Thinker齐开工，能顶个诸葛亮？"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-01-16T10:37:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            美团又上新模型，8个Thinker齐开工，能顶个诸葛亮？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T10:37:19.000Z" title="Fri Jan 16 2026 10:37:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>临近春节，各家 AI 厂商进入冲刺阶段，纷纷亮出最新大模型成果。</p>
<p>1 月 15 日，美团也重磅更新自家模型 ——LongCat-Flash-Thinking-2601。</p>
<p>这是一款强大高效的大规模推理模型，拥有 5600 亿个参数，基于创新的 MoE 架构构建。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/740e7d19a6954bdfa6fef537f8d6c355~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=mefTuR5P7nltV1W02prto5oMNog%3D" alt="图片" loading="lazy"/></p>
<p>该模型引入了强大的重思考模式（Heavy Thinking Mode），能够同时启动 8 路思考并最终总结出一个更全面、更可靠的结论。目前重思考模式已在 LongCat AI 平台正式上线，人人均可体验。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5fd2293599c4b6f8d1649c43fa21ddf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=FCXkJKA%2BqLBm8bVSBNgLbPcjPkY%3D" alt="图片" loading="lazy"/></p>
<p>仅选择「深度思考」时才会触发重思考模式。</p>
<ul>
<li>
<p>体验链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Flongcat.ai" target="_blank" title="https://longcat.ai" ref="nofollow noopener noreferrer">longcat.ai</a></p>
</li>
<li>
<p>模型地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmeituan-longcat%2FLongCat-Flash-Thinking-2601" target="_blank" title="https://huggingface.co/meituan-longcat/LongCat-Flash-Thinking-2601" ref="nofollow noopener noreferrer">huggingface.co/meituan-lon…</a></p>
</li>
<li>
<p>GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmeituan-longcat%2FLongCat-Flash-Thinking-2601" target="_blank" title="https://github.com/meituan-longcat/LongCat-Flash-Thinking-2601" ref="nofollow noopener noreferrer">github.com/meituan-lon…</a></p>
</li>
</ul>
<p>不仅如此，该模型的智能体能力还获得了重大提升：在智能体工具调用、智能体搜索和工具集成推理等基准测试中达到顶尖性能，而且在任意的 OOD（分布外）真实智能体场景中实现了泛化能力的显著提升。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cadf0c261d84c0d9ea15b83474b22b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=n4PTgsyl%2FpJD1OujV90TWaZZNPw%3D" alt="图片" loading="lazy"/></p>
<p>研究团队还专门提出了一种全新的智能体模型泛化能力评测方法。</p>
<p>通过构建自动化的环境和任务合成流程，基于给定关键词，随机生成任意的复杂任务。每个生成的任务都配备对应的工具集与可执行环境。</p>
<p>这种高度随机化的评测方式，能够更真实地检验模型在未知场景下的适应能力。</p>
<p>实验结果表明，LongCat-Flash-Thinking-2601 在该评测中始终保持领先性能。</p>
<p>接下来，我们就把模型拉到真实场景里实测一番。</p>
<p>一手实测：这只龙猫有点强</p>
<p>我们先来试试数理逻辑推理，顺便看看这个重思考模式到底是怎么一回事。</p>
<p>「运动会招募志愿者，第一次招募了不到 100 人，其中男女比例为 11:7；补招若干女性志愿者后，男女比例为 4:3。问最多可能补招了多少名女性志愿者？」</p>
<p>在 longcat.ai 上开启「深度思考」后，便进入了重思考模式，此时 8 个 Thinker 同时开工，每个都表现出不同的思考风格。有的按常规解题，有的则直接写了个 Python 脚本。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3e4c817eccc4dd38ad390c843a0c0ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=wh2vnngooj2aK6Qqm6zNmnXFZGY%3D" alt="图片" loading="lazy"/></p>
<p>大部分 Thinker 给出了答案 5，其中 3 号和 6 号 Thinker 还写出详细的推导过程。待 8 个 Thinker 执行完任务后，模型再验证不同 Thinker 的思考过程，形成最终答案。</p>
<p>整个过程就像一个团队开会讨论问题，最后达成共识，最终给出的解答也更靠谱得多。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78e1c856ea1a42a98b89ddf96f3a6023~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=On85Jll%2FIThOIU4hCvktM1tQxLg%3D" alt="图片" loading="lazy"/></p>
<p>下面是道逻辑推理题。「A 的手机号码最后 5 位，由五个不同的数字组成。B 说：我猜它是 84261。C 说：我猜它是 26048。D 说：我猜它是 49280。A 说：巧了，你们每人都猜对了位置不相邻的两个数。你知道这五位号码是多少？」</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49d5d27aa6fd4c0e89f82684c4b465af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=DeZU9Z%2BroJZyaquRgobh0PrqXJo%3D" alt="图片" loading="lazy"/></p>
<p>8 个 Thinker 再次启动，各自从不同角度切入。</p>
<p>模型没有简单地按照「少数服从多数」的原则采纳意见，而是调用一段代码，系统验证答案是否满足所有约束条件，并穷举所有可能的组合，确认 86240 是唯一解。</p>
<p>这种将单个模型调用八次的模型编排方式，在技术实现上虽直接，却在实际效果上发挥出「三个臭皮匠顶过诸葛亮」的优势。</p>
<p>实测过程中，我们还发现了重思考模式的一种有趣玩法：投票。</p>
<p>举个例子，我们可以开启「深度思考」模式，然后让模型选出 2000 年代最优秀的华语流行歌手。</p>
<p>我们发现不同的 Thinker 会给出很不一样的答案，比如有一个仅选出了周杰伦、蔡依林、孙燕姿、王菲、陈奕迅五位代表，而另一个则直接列出了一长串名单。</p>
<p>最终，经过模型在总结阶段的汇总整理，LongCat-Flash-Thinking-2601 给出了一份涵盖多维度评估的名单，颇具参考性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/987386cfb5b749788ec70698f18aee25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=TTl9BVgngWb2EiLWBuwWl40dB1c%3D" alt="图片" loading="lazy"/></p>
<p>我们又试了下该模型的编程能力。先让它生成一个 Flappy Bird 小游戏，效果很不错。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e7d795f656a4f5ea1f8cb8047e3bdd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=mtCSE3It08yMM6ooA9K5VY7J64M%3D" alt="图片" loading="lazy"/></p>
<p>Prompt：Make a game like flappy bird using HTML/CSS/JS in a single HTML file.</p>
<p>接下来我们又试了试让其编写一个康威生命游戏：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e714cfe2c0b40d8badc3bf0d278246f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=rrriv1QzjVJxWiJgBQmmzDC0YFA%3D" alt="图片" loading="lazy"/></p>
<p>Prompt：用 Python 写一个 Conway 生命游戏，提供可视化网格、暂停、单步和参数调节功能。</p>
<p>但实事求是地说，使用 8 个 Thinker 来完成编程任务的计算成本应当是比较高的，可能并不适合大规模应用（尽管目前该模型对普通用户免费），但是我们认为这种模式却非常适合医疗、金融、法律等可能需要多次深度思考来保证准确性的场景。</p>
<p>最后，我们再来测试一下 LongCat-Flash-Thinking-2601 模型主打的 Agent 能力，其中的核心便是工具调用。</p>
<p>为了方便用户测试，美团专门构建了一个「大模型工具使用测试」平台。该平台能基于关键词随机生成复杂的 OOD（分布外）任务，专门用来试探模型在陌生环境下的行动能力。</p>
<p>我们随机生成了一个「营养补给方案」任务。平台生成了一个包含近30个工具的复杂图谱。从页面右侧的依赖关系可以看出，这并非简单的线性调用，模型需要像经验丰富的营养学家，理清儿童营养需求分析、食物营养成分计算、过敏食物筛选等工具之间环环相扣的逻辑。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/526e3f218e9545f0bca436f66d6c5621~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=pziFrOw%2BLDv4U2WIlIj8EqRFkF0%3D" alt="图片" loading="lazy"/></p>
<p>更有趣的是，该平台还支持模型对比，让用户可以轻松地将 LongCat-Flash-Thinking 与其它模型放在同一起跑线上进行对比。</p>
<p>这里我们将其与当前大模型界的顶级选手 Claude 4.5 Opus 放在了同一个赛道上，进行同步竞技。</p>
<p>8 倍速视频</p>
<p>视频展示了两个模型在高频调用工具时的思考流。在任务完成后，系统会调用 AI 评估员，从执行速度与任务达成度两个维度进行复盘。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b00a398a840497f8f8e457b866aae5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=McE852dBdqeXh3KBTtAqtyD369c%3D" alt="图片" loading="lazy"/></p>
<p>在这个具体案例中，两个模型都交出了高分答卷，但 LongCat 成功达到了 100% 的标准覆盖率，而 Claude 4.5 Opus 却未能成功为用户创建健康档案，仅达到了 80% 的覆盖率。整体而言，LongCat 在处理工具依赖关系的响应节奏上展现出了更强的稳定性。</p>
<p>深入细节，我们可以看到这些工具的调用和输出都采用了标准的 JSON 格式，这也是当前大量的 MCP 或 API 工具采用的主流格式。这也意味着，我们可以非常轻松地将 LongCat-Flash-Thinking-2601 整合进到现有的工作流程中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9c68a22c3d24c408e377855c88f9b46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=RQrTlLqlsss4I0xnnaZES2QOPKg%3D" alt="图片" loading="lazy"/></p>
<p>强大实力的根基：重思考 + 智能体</p>
<p>那么，表现如此亮眼的 LongCat-Flash-Thinking-2601 究竟是如何炼成的？</p>
<p>正如其推文总结的那样，我们先给出几个关键词：并行思考、迭代式总结、环境规模扩展（Environment Scaling）、多环境大规模强化学习（Multi-Environment RL Scaling）、课程学习（Curriculum Learning）。另外，还有即将发布的 ZigZag Attention。</p>
<p>作为 LongCat-Flash-Thinking 的最新版本，2601 版本继承了上一版本的领域并行训练方案，而技术底座同样是参数总量达 560B 的高性能混合专家（MoE）架构模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58410df21e4b462cbfe566315040f11d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=2EP2BhTRGo6Kn2nSn88%2FteqkFd4%3D" alt="图片" loading="lazy"/></p>
<p>来自 LongCat-Flash-Thinking 技术报告</p>
<p>在此基础上，如上文评测所示，除了一些细节上的优化，这个新版本重点引入了两大改进：重思考模式和智能体能力。</p>
<p>该模型新引入的重思考模式别具一格，我们目前还未见其它任何模型显式或开源地提供类似模式。</p>
<p>而在智能体能力方面，美团引入了一套精心设计的流程。该流程结合了环境规模扩展与后续任务合成，并会在此之上进行可靠且高效的大规模、多环境强化学习。为更好地适应真实世界智能体任务中固有的噪声与不确定性，美团 LongCat 团队还对多种类型和不同强度的环境噪声进行了系统分析，并采用课程式训练，使模型在非理想条件下依然保持稳健表现。</p>
<p>下面我们就来更具体地看看美团的这些核心技术。</p>
<p>重思考模式：推理广度与深度的协同扩展</p>
<p>打开 longcat.ai 「深度思考」后开始体验，你第一时间就会被同时冒出的 8 个 Thinker 吸引注意。这正是 LongCat 团队提出的 Heavy Thinking Mode（重思考模式）的外在表现。它不仅看起来炫酷，更重要的是将推理能力推向了新的边界。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfec35b0c03142c09622933c1bd591e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=2FmQKWOA3KwlzwAPmvXMfPPUbZM%3D" alt="图片" loading="lazy"/></p>
<p>大致来看，其与 AI 大牛 Andrej Karpathy 实验性的<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2651003281%26idx%3D1%26sn%3D3d21baa1164c2afbbfc15c7b2fb5c847%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2651003281&amp;idx=1&amp;sn=3d21baa1164c2afbbfc15c7b2fb5c847&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">大模型议会</a>项目有相似之处，但不同的是，Karpathy 的大模型议会是通过模型编排方式来向不同模型构成的集体提出问题，让它们各自发言并讨论后给出最终解答，而 LongCat-Flash-Thinking-2601 新引入的重思考模式则是并行地调用一个模型 8 次来实现高强度的并行思考。</p>
<p>如此一来，便可以同时获得多条相互独立的推理路径并进行交叉验证，从而显著降低偶然性错误，提升在复杂问题上的稳定性、可靠性与最终答案质量。如此一来，可以进一步提升模型在极具挑战性任务上的表现。</p>
<p>具体来说，该模式会将高难度问题求解分解为两个互补阶段：并行思考与总结，从而同时扩展推理的深度与宽度。</p>
<ul>
<li>
<p>在推理宽度方面，重思考模式会并行生成多条独立轨迹，以广泛探索不同推理路径，并采用相对较高的推理温度以保证多样性。</p>
</li>
<li>
<p>在推理深度方面，总结阶段生成的精炼轨迹可以递归反馈给总结模型，形成支持逐步加深推理的迭代推理回路。LongCat 团队还专门设计了额外的强化学习阶段来训练总结能力，进一步释放该模式的潜力。</p>
</li>
</ul>
<p>智能体能力提升：环境规模扩展与多环境强化学习</p>
<p>智能体能力方面，LongCat 团队精心设计了一套自动化环境规模扩展链路，并构建了一组多样且高质量的环境，作为工具调用类任务强化学习的训练场，使模型能够习得高层次、可泛化的智能体能力。</p>
<p>每个环境包含多达 60 余种工具，并以高密度依赖图的形式组织，提供了足够的复杂度以支持多样化任务构建与大规模探索。实验表明，随着训练环境数量的增加，模型在分布外（OOD）任务中的表现会持续提升（Environment Scaling）。</p>
<p>高质量任务构建</p>
<p>为确保训练任务集的质量，LongCat 团队对任务复杂度和多样性进行显式控制。每个任务都定义在从高质量环境中采样得到的连通子图之上，任务复杂度通过要求在该子图内尽可能多地协同使用工具来调节。为促进任务多样性，已选工具的再次采样概率会逐步降低。</p>
<p>LongCat 团队还构建了配套数据库以确保任务的可执行性，并验证每个任务至少存在一种可执行解。然而，当环境中包含大量工具时，跨数据库的一致性维护会变得困难，可能导致部分任务无法验证。针对这一问题，LongCat 团队设计了专门的应对策略，使训练的稳定性和有效性得到了充分保障。</p>
<p>多环境强化学习</p>
<p>在保持高效异步训练和流式 rollout 特性的同时，LongCat 团队进一步扩展了其强化学习基础设施 DORA（异步弹性共卡系统），以支持环境规模扩展下的大规模多环境智能体训练（Multi-Environment RL Scaling）。</p>
<p>具体而言，来自多个环境的任务会在每个训练批次中以平衡的方式混合，并根据任务复杂度和当前训练状态分配不同的 rollout 预算。</p>
<p>下图展示了该模型的多环境混合强化学习训练曲线，可以看到上涨的趋势非常稳定，这表明美团构建的基础设施和算法可以有效保证训练的稳定性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d039c9fa3bd34c97ba3ff8f4e9f05c9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=C%2Bu0yAoEbNP4jl4Tvuk5%2BfZ3ZaE%3D" alt="图片" loading="lazy"/></p>
<p>下图则展示了多环境强化学习训练下，模型在不同 OOD 测试集上的 RL Scaling 表现，效果非常明显。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37c816c967b448e8b6f6e13ef31ba35e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=2INY5uPz1GVynPiJZR%2FMaCDzHqM%3D" alt="图片" loading="lazy"/></p>
<p>面向噪声环境的稳健训练</p>
<p>真实世界的智能体环境天然存在噪声和缺陷，仅在理想化环境中训练模型往往难以获得足够的稳健性。为此，LongCat 团队在训练过程中显式引入环境不完美因素，以提升模型的稳健性。</p>
<p>具体而言，LongCat 团队系统分析了智能体场景中真实世界噪声的主要来源，并设计了一套自动化流程，将这些噪声注入训练环境。在强化学习阶段，LongCat 团队采用课程式策略，随着训练推进逐步增加噪声的类型和强度。</p>
<p>下图展示了模型是否采取面向噪声环境的稳健训练，在带噪声 / 无噪声评测集下的表现对比，其中不同的评测集上依据特性添加了不同类型的噪声。可以看到，带噪声环境下未经过稳健训练的模型的表现会出现大幅衰减，Claude 也无法适应全部的噪声类型。而经过稳健训练后，LongCat-Flash-Thinking-2601（Training w/ Noise 组） 对环境的噪声和不确定性展现出了强大的适应能力，并在各类非理想条件下取得更优表现。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91ba01b5043c42f686435e6343449693~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=l2eURnPB8ge7IoHOCiQbRnUXFLg%3D" alt="图片" loading="lazy"/></p>
<p>得益于这些改进与创新，LongCat-Flash-Thinking-2601 不仅在智能体工具使用、智能体搜索以及工具融合推理等基准测试中达到顶尖水平，还在任意的 OOD（分布外）真实世界智能体场景中展现出显著提升的泛化能力。</p>
<p>LongCat ZigZag Attention：实现超长上下文</p>
<p>LongCat ZigZag Attention，顾名思义，是一种注意力机制，根据其官方推文描述，其一大核心亮点是能「实现 100 万 token 上下文」。据悉，LongCat ZigZag Attention 已被成功用于训练当前 LongCat-Flash-Thinking 模型的一个分支，我们也将很快见证这个分支版本面世。细节详见论文：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2512.23966" target="_blank" title="https://arxiv.org/abs/2512.23966" ref="nofollow noopener noreferrer">arxiv.org/abs/2512.23…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/106bfb57137e43e9a9ed3eb42e19fdfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=bT%2FP%2FRGIdF3yQZ04rQesz4pwQjM%3D" alt="图片" loading="lazy"/></p>
<p>One More Thing</p>
<p>回头来看，美团大模型站到台前时间并不算长但节奏清晰，首次亮相在 2025 年 9 月，此后保持了每月一更的开源节奏，不断扩容自己的能力库：从强调响应速度的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650988704%26idx%3D1%26sn%3Dda107de5f4054028060a334398147912%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650988704&amp;idx=1&amp;sn=da107de5f4054028060a334398147912&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">LongCat-Flash-Chat</a> 到专注逻辑的 Thinking 版本，再到覆盖多模态的 Omni 版本，每一步迭代都在让这只龙猫能够更好地理解这个世界，并让复杂的现实生活变得更加可计算。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55edc5bb60574adea2d6a85cf0c19b5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769164639&amp;x-signature=LT%2F6Ik85hg2wBZUwTIaZe20Z7WQ%3D" alt="图片" loading="lazy"/></p>
<p>美团在 Hugging Face 上的论文页面</p>
<p>这一次，龙猫聚焦 Agent 与 Thinking 能力进行全面提升，也是实现了一次从理解到融入真实世界的跃迁。</p>
<p>或许，美团现在追求的，就是一种确定性：能够用技术在真实世界中又好又快地解决问题，终有一天让「模型即服务」。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AWS Lambda Python 应用可观测最佳实践（DDTrace）]]></title>    <link>https://juejin.cn/post/7595837635569762356</link>    <guid>https://juejin.cn/post/7595837635569762356</guid>    <pubDate>2026-01-16T10:49:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7595837635569762356" data-draft-id="7595831648824410152" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AWS Lambda Python 应用可观测最佳实践（DDTrace）"/> <meta itemprop="keywords" content="AWS"/> <meta itemprop="datePublished" content="2026-01-16T10:49:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AWS Lambda Python 应用可观测最佳实践（DDTrace）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-16T10:49:47.000Z" title="Fri Jan 16 2026 10:49:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>随着企业核心业务全面向云原生和无服务器架构迁移，AWS Lambda 因其免运维、自动扩缩容和按调用计费的优势，已成为支撑高并发、事件驱动型业务的首选计算平台。然而，Serverless 的“黑盒化”特征也带来了新的可观测性挑战：</p>
<ul>
<li>分布式链路断裂：Lambda 函数往往作为事件触发链中的关键一环，与 API Gateway、S3、SQS、DynamoDB 等服务交叉调用，传统 APM 难以串联完整调用链。</li>
<li>冷启动与性能瓶颈难定位：函数初始化耗时、依赖库加载、网络延迟等性能指标缺乏细粒度追踪，影响用户体验与成本控制。</li>
<li>多环境、多账号下的观测一致性缺失：Dev、QA、Prod 环境函数数量众多，若没有统一的链路标准和标签规范，问题定位效率低，跨团队协作成本高。</li>
</ul>
<p>为保障线上稳定性、优化函数性能、实现 Serverless 场景下的可观测闭环，亟需基于 Python 运行时 构建一套标准化方案，提供从原理、代码示例到生产级部署的完整落地方案，助力企业在 Serverless 架构下实现“<strong>问题可追踪、性能可量化、成本可优化</strong>”的目标。</p>
<p>本文介绍如何通过 Lambda 服务接入 DDTrace 组件实现链路数据采集并上报至观测云。</p>
<h2 data-id="heading-1">实践</h2>
<h3 data-id="heading-2">运行环境</h3>
<ul>
<li>Lambda 函数（Zip 部署）</li>
<li>Runtime Language：Python (3.8-3.13)</li>
</ul>
<h3 data-id="heading-3">准备 Lambda Layer</h3>
<p>需要新增以下两个 Layer：</p>
<ul>
<li>DataDog Layer：用于链路插桩</li>
<li>DataKit Layer: 用于接收 datadog 的可观测数据</li>
</ul>
<h3 data-id="heading-4">新增 DataKit Layer</h3>
<p>参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fintegrations%2Fawslambda%2F%23layer" target="_blank" title="https://docs.guance.com/integrations/awslambda/#layer" ref="nofollow noopener noreferrer">AWS Lambda 扩展 &gt; 添加 DataKit 层</a></p>
<h3 data-id="heading-5">新增 DataDog Layer</h3>
<ul>
<li>AWS 全球区</li>
</ul>
<p>选择合适的 ARN：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># Use this format for x86-based Lambda deployed in AWS commercial regions</span>
<span class="hljs-symbol">arn:</span><span class="hljs-symbol">aws:</span><span class="hljs-symbol">lambda:</span>&lt;<span class="hljs-variable constant_">AWS_REGION</span>&gt;<span class="hljs-symbol">:</span><span class="hljs-number">464622532012</span><span class="hljs-symbol">:layer</span><span class="hljs-symbol">:Datadog-&lt;RUNTIME&gt;</span><span class="hljs-symbol">:</span><span class="hljs-number">118</span>

<span class="hljs-comment"># Use this format for arm64-based Lambda deployed in AWS commercial regions</span>
<span class="hljs-symbol">arn:</span><span class="hljs-symbol">aws:</span><span class="hljs-symbol">lambda:</span>&lt;<span class="hljs-variable constant_">AWS_REGION</span>&gt;<span class="hljs-symbol">:</span><span class="hljs-number">464622532012</span><span class="hljs-symbol">:layer</span><span class="hljs-symbol">:Datadog-&lt;RUNTIME&gt;-ARM</span><span class="hljs-symbol">:</span><span class="hljs-number">118</span>

<span class="hljs-comment"># Use this format for x86-based Lambda deployed in AWS GovCloud regions</span>
<span class="hljs-symbol">arn:</span>aws-us-<span class="hljs-symbol">gov:</span><span class="hljs-symbol">lambda:</span>&lt;<span class="hljs-variable constant_">AWS_REGION</span>&gt;<span class="hljs-symbol">:</span>002406178527<span class="hljs-symbol">:layer</span><span class="hljs-symbol">:Datadog-&lt;RUNTIME&gt;</span><span class="hljs-symbol">:</span><span class="hljs-number">118</span>

<span class="hljs-comment"># Use this format for arm64-based Lambda deployed in AWS GovCloud regions</span>
<span class="hljs-symbol">arn:</span>aws-us-<span class="hljs-symbol">gov:</span><span class="hljs-symbol">lambda:</span>&lt;<span class="hljs-variable constant_">AWS_REGION</span>&gt;<span class="hljs-symbol">:</span>002406178527<span class="hljs-symbol">:layer</span><span class="hljs-symbol">:Datadog-&lt;RUNTIME&gt;-ARM</span><span class="hljs-symbol">:</span><span class="hljs-number">118</span>
</code></pre>
<p>将 <code>&lt;AWS_REGION&gt;</code> 替换为有效的 AWS 区域，例如 <code>us-east-1</code>。<code>&lt;RUNTIME&gt;</code> 的选项有：<code>Python38、Python39、Python310、Python311、Python312、Python313</code>。</p>
<ul>
<li>AWS 中国区</li>
</ul>
<p>由于 Datadog 并没有在中国区的维护 <code>datadog-lambda-python</code> 层，所以我们使用 <code>pip</code> 将 <code>datadog-lambda</code> 包及其依赖项本地安装到您的函数项目文件夹中。</p>
<pre><code class="hljs language-python" lang="python">pip install datadog-<span class="hljs-keyword">lambda</span> -t ./
</code></pre>
<p>注意 ：<code>datadog-lambda</code> 依赖于 ddtrace，而 ddtrace 使用了原生扩展；因此必须在正确架构（x86_64 或 arm64）的 Linux 环境中安装和编译。</p>
<p>将函数的「运行时-处理程序」设置为 <code>datadog_lambda.handler.handler</code> 。</p>
<h3 data-id="heading-6">环境变量配置</h3>
<ul>
<li>DD_TRACE_ENABLED: 开启分布式追踪默认为 true</li>
<li>DD_LAMBDA_HANDLER: 设置为原始处理程序，例如：<code>lambda_function.lambda_handler</code></li>
<li>DD_TRACE_AGENT_URL：<code>http://localhost:9529</code></li>
<li>DD_TRACE_DEBUG：日志输出，默认关闭</li>
<li>ENV_DATAWAY：上报数据的 DataWay 地址（token 从工作空间获取）</li>
</ul>
<p>配置完成后，点击测试，然后可以登陆平台查看链路数据。</p>
<h2 data-id="heading-7">效果展示</h2>
<p>配置完成后，点击测试，成功后到观测云工作空间后，相关链路以及指标信息。</p>
<h3 data-id="heading-8">APM</h3>
<p><code>service:aws.lambda</code></p>
<p><code>resource:&lt;Your AWS Lambda FuncName&gt;</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a71e748c48c412cba8c9d56fe32c5f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769165386&amp;x-signature=VMVSrbXBUIedKUGiIaFW9%2BiyK9A%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">指标</h3>
<p>指标说明：AWS Lambda 拓展 &gt; 指标</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7bd447722ef4f9d8af5330721c477c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769165386&amp;x-signature=pGi4Ofd55dP6%2FItCipIJIua9%2FRw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">日志</h3>
<p><code>source:awslambda</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e8182390dca481a9e07ee821c208285~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769165386&amp;x-signature=kFzth6W0bZuwK58dE%2BUVpBEHow4%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>