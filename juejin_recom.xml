<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[完整指南：iPhone崩溃日志查看与分析方法及低内存崩溃处理]]></title>    <link>https://juejin.cn/post/7574245883635433524</link>    <guid>https://juejin.cn/post/7574245883635433524</guid>    <pubDate>2025-11-19T10:08:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245883635433524" data-draft-id="7574251313883267087" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="完整指南：iPhone崩溃日志查看与分析方法及低内存崩溃处理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T10:08:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            完整指南：iPhone崩溃日志查看与分析方法及低内存崩溃处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T10:08:39.000Z" title="Wed Nov 19 2025 10:08:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ios查看崩溃日志 查看iphone崩溃日志</p>
<p>我们在进行iPhone应用测试时必然会在“隐私”中找到不少应用的崩溃日志，但是不会阅读对于很多人来说简直头疼。在此小编为大家详细介绍一下具体的阅读方法，希望大家可以更快的定位BUG。首先我们先看一下从iPhone中随机抽出的一个Crash日志：</p>
<p><em>进程信息</em></p>
<p>日志主要分为六个部分： <strong>进程信息</strong>、 <strong>基本信息</strong>、 <strong>异常信息</strong>、 <strong>线程回溯</strong>、 <strong>线程状态</strong> 和 <strong>二进制映像</strong> <strong>，具体位置已经标记在上述文件中。</strong></p>
<p><strong>日志组成分析：</strong></p>
<p><strong>在上述六个部分中，我们最需要关注的是异常信息和线程回溯的内容。</strong></p>
<p><strong>1.</strong> <strong>进程信息：</strong> <strong>发生crash进程的相关信息</strong></p>
<p><strong>Hardware Model</strong>: 标识设备类型</p>
<p><strong>Process</strong>：应用名称</p>
<p><strong>Path</strong> <strong>：</strong> 所在路径</p>
<p><strong>Identifier</strong> <strong>：</strong> 程序ID</p>
<p><strong>Version</strong> <strong>：</strong> 版本号</p>
<p><strong>Code Type</strong> <strong>：</strong> 处理器架构</p>
<p><strong>2.</strong> <strong>基本信息：</strong> 给出了一些基本信息，包括闪退发生的日期和时间，设备的iOS版本。</p>
<p><strong>3.</strong> <strong>异常信息：</strong> 崩溃时抛出的异常类型，还能看到异常编码和抛出异常的线程。</p>
<p>注：</p>
<p><em>具体信号说明参见</em> <em>iOS异常捕获</em></p>
<p><em>详细的异常编码代表的含义请参考：</em> <em>Hexspeak</em></p>
<p>因此我们可以确定本次崩溃原因是内存访问错误</p>
<p><strong>4.</strong> <strong>线程回溯：</strong> 回溯是闪退发生时所有活动帧清单。它包含闪退发生时调用函数的清单。</p>
<p>实际上我们直接从iPhone中导出的崩溃日志应该是一串地址表示的，如下：</p>
<p><strong>大家可以通过symbolicatecrash</strong> 命令和dSYM文件将最后的两列解析为具体的方法名和行数。（具体使用方法大家可以自行查找）</p>
<p>使用Keymob工具可以更方便地进行崩溃日志的符号化分析，它支持自动解析和可视化展示，无需手动处理命令行，同时提供实时日志监控和过滤功能，帮助开发者快速定位问题。</p>
<p>在这里我们就可以看到详细的方法名，这样就能帮助开发同学定位到具体位置。</p>
<p><strong>5.</strong> <strong>线程状态：</strong> 闪退时寄存器中的值。一般不需要这部分的信息，因为回溯部分的信息已经足够让你找出问题所在。</p>
<p><strong>6.</strong> <strong>二进制映像：</strong> 闪退时已经加载的二进制文件。</p>
<p><strong>低内存崩溃：</strong></p>
<p>因为低内存崩溃日志与普通崩溃日志略有不同，所以本教程特别分开说明一下。</p>
<p>iOS设备检测到低内存时，虚拟内存系统发出通知请求应用释放内存。这些通知发送到所有正在运行的应用和进程，试图收回一些内存。</p>
<p>如果内存使用依然居高不下，系统将会终止后台线程以缓解内存压力。如果可用内存足够，应用将能够继续运行而不会产生崩溃报告。否则，应用将被iOS终止，并产生低内存崩溃报告。低内存崩溃日志上没有应用线程的堆栈回溯。相反，上面显示的是以内存页数为单位的各进程内存使用量。被iOS因释放内存页终止的进程名称后面你会看到jettisoned 字样。如果看到它出现在你的应用名称后面，说明你的应用因使用太多内存而被终止了。</p>
<p>当应用发生低内存闪退时，你必需看看应用中内存使用的方式，以及是如何处理低内存警告的。你可以使用Instruments工具中使用Allocations 和 Leaks来发现内存分配问题和内存泄漏问题。如果你不知道如何利用Instruments 检查内存问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[EMR Serverless Stella 1.0 技术分享：StarRocks企业级版本内核重大突破]]></title>    <link>https://juejin.cn/post/7574250031248523298</link>    <guid>https://juejin.cn/post/7574250031248523298</guid>    <pubDate>2025-11-19T10:17:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574250031248523298" data-draft-id="7574245883635286068" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="EMR Serverless Stella 1.0 技术分享：StarRocks企业级版本内核重大突破"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2025-11-19T10:17:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            EMR Serverless Stella 1.0 技术分享：StarRocks企业级版本内核重大突破
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T10:17:20.000Z" title="Wed Nov 19 2025 10:17:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在今年云栖大会上，EMR Serverless Stella 1.0正式发布，这是一款面向企业级场景深度优化的高性能数据分析引擎。阿里云开源大数据平台OLAP引擎负责人周康系统性地分享了 Stella 在存算分离架构、Lakehouse 场景以及全文检索等三大核心场景下的深度优化经验，为业界提供了大规模 OLAP 系统工程化实践的宝贵参考。Stella引擎的发布将为企业级用户提供更加专业、高效的OLAP解决方案。</p>
<h2 data-id="heading-0">站在巨人肩膀上：与 StarRocks 开源社区的深度合作</h2>
<p>阿里云与StarRocks开源社区的合作可以追溯到2021年，从开源第一天起就建立了深度合作关系。在过去四年中，双方在源码共创、产品发布和技术优化方面积累了丰富的经验。</p>
<p><strong>合作历程回顾：</strong></p>
<ul>
<li><strong>2021年</strong>：开启源码共创，重点推动数据湖分析相关框架和性能优化</li>
<li><strong>2022年3月</strong>：推出EMR半托管StarRocks形态</li>
<li><strong>2023年</strong>：响应市场需求，推出全托管产品形态</li>
<li><strong>2024年</strong>：正式商业化存算分离版本</li>
</ul>
<p>随着产品的成熟，阿里云EMR已积累数百家B端企业客户。“我们始终站在巨人的肩膀上，”阿里云开源大数据平台OLAP引擎负责人周康表示，“Stella 所有功能和优化都会逐步回馈给社区，同时确保API层面与开源版本完全兼容。”
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10ec765f33d845818662bffad09c55ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152239&amp;x-signature=OviiVhCs0EcdI0rKko4fWMejfIQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">Lakehouse 成为业界共识：Stella 应运而生</h2>
<p>2024年，阿里云正式发布 OpenLake 方案，标志着 Lakehouse 架构在数据基础设施领域的全面落地：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/251ae1e337554d93a358e35dc0ec1805~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152239&amp;x-signature=bOLQpvWkxLtV5CRWcF7It4Ogaww%3D" alt="image.png" loading="lazy"/>
2024云栖大会重磅发布OpenLake解決方案，StarRocks 为 OLAP场景核心组件</p>
<p>伴随这一趋势，Lakehouse（数据湖仓一体）已成为国内外头部公司的业界共识：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37b7b5571a1c48a5850d2c97fb007a15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152239&amp;x-signature=nkhdTjbAc0OAzI3i8X1gmDV9gtk%3D" alt="image.png" loading="lazy"/></p>
<p>海外Lakehouse发展趋势  Snowflake/Databricks/BigQuery + Iceberg/Delta/Hudi</p>
<p>阿里云推出了 OpenLake 一体化湖仓解决方案，StarRocks 在其中担任核心 OLAP 引擎角色。然而，在大规模生产环境中，StarRocks 在存算分离架构和湖表查询方面仍有优化空间。Stella 项目正是为了应对这些挑战而生。通过在调度、查询优化、执行引擎和存储引擎四个层面的全面改进，Stella 1.0 针对几十 TB 甚至 PB 级数据场景，解决了事务机制、Compaction 效率、查询性能、元数据管理等一系列生产环境痛点。</p>
<h2 data-id="heading-2">Stella 1.0 三大核心场景突破</h2>
<p>EMR Serverless Stella 1.0版本于今年5月正式发布，主要聚焦三大核心技术能力的重大突破：</p>
<h3 data-id="heading-3">一、存算分离：性能和稳定性大幅提升</h3>
<p>Stella 1.0 在存算分离架构下实现了三大突破：</p>
<p><strong>1. 冷查性能大幅提升</strong></p>
<ul>
<li>实现 IO 合并，减少对象存储访问次数</li>
<li>优化 Compaction 调度器，大幅减少小文件数量 </li>
<li>针对轻量级 ETL 场景优化负载调度</li>
</ul>
<p><strong>2. 写入性能保障</strong></p>
<ul>
<li>开发 Batch Publish 能力，解决串行化导入瓶颈 </li>
<li>推出 Collocated PK Index，避免缓存盘和索引盘互相影响 </li>
<li>优化 FE 侧 Tablet 创建删除效率</li>
</ul>
<p><strong>3. 缓存利用率优化</strong></p>
<ul>
<li>引入 Index Cache 和 Meta Data Cache，提升元数据访问速度 </li>
<li>实现自适应 IO Stream，智能选择本地缓存或远端访问 </li>
<li>针对 ETL 场景优化空间利用</li>
</ul>
<p>在TPC-H 10T基准测试中，存算分离版本的Stella相比上一版本<strong>性能提升超过120%</strong>，充分展现了云原生架构的技术优势。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ec1b23b39624717bc67f35adfd9d0bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152239&amp;x-signature=nzk591SzLrlCzqownmY%2BcZaWNP8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">二、Paimon 湖表查询：Co-design 驱动性能飞跃</h3>
<p>Stella 1.0在Paimon表分析方面，重点聚焦在三个方向的提升：</p>
<p><strong>1. 数据读写效率提升</strong> </p>
<ul>
<li>实现自适应 Batch Size 优化 </li>
<li>支持Native Paimon Writer，性能大幅提升</li>
</ul>
<p><strong>2. 元数据访问优化</strong> </p>
<ul>
<li>针对 Manifest 数量众多场景，实现分布式解析能力 </li>
<li>适配异步 Splits 调度框架 </li>
<li>优化 Manifest Cache 策略</li>
</ul>
<p><strong>3. 深度集成阿里云 DLF 2.x</strong> </p>
<ul>
<li>与 Data Lake Formation 产品深度整合 </li>
<li>借助 DLF 能力提升 Paimon 查询和写入的性能与稳定性 </li>
<li>针对DV表实现Native读取优化</li>
</ul>
<p>Stella在Lakehouse场景下查询Paimon下性能的提升非常明显：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a08f8a870994472938bfffc41fce1e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152239&amp;x-signature=r44PojoCMzaTuPucR08owzkGbiU%3D" alt="image.png" loading="lazy"/></p>
<p>虽然 Flink + Paimon 已成为成熟的实时入湖方案，但计算引擎与 Paimon 存储的查询优化结合仍有巨大提升空间。Stella 与 Paimon 将在多个方便持续进行Co-Design，更多优化成果将在后续版本中发布。</p>
<h3 data-id="heading-5">三、全文检索：打造高性能、高可用的文本分析能力</h3>
<p>Stella 1.0 正式推出全文检索能力，支持高效、精准的文本查询。</p>
<ul>
<li><strong>架构重构</strong>：对 Inverted Index（倒排索引） 整体解决方案进行架构优化</li>
<li><strong>存算分离主键表支持</strong>：新增主键表全文检索能力，实现高效精准的查询能力</li>
<li><strong>小文件合并</strong>：解决存算分离架构下的“性能杀手”问题（单个 Segment 产生十几个小文件）
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bde7b2fc36c467b94c0bf8fc075d392~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152239&amp;x-signature=AnF3GW2XeG6PDSGLQTFdVmdYDMI%3D" alt="image.png" loading="lazy"/></li>
</ul>
<p>文本过滤性能benchmark: Stella vs EMR StarRocks 3.3</p>
<p>目前，全文检索功能已在阿里集团内部和云上客户中投入使用，所有优化代码已通过 PR 提交至 StarRocks 开源社区。</p>
<h2 data-id="heading-6">技术创新路线图持续演进</h2>
<p>面向未来，Stella引擎制定了清晰的技术发展路线图，在四个关键领域持续深耕：</p>
<ol>
<li><strong>迈向Stella 2.0时代：轻量 ETL Production Ready</strong><br/>
全面强化轻量级 ETL 能力，打通从数据接入、转换到分析的端到端链路，使用户无需依赖外部调度系统即可高效完成日常数据加工任务，真正实现“开箱即用、生产就绪”。</li>
<li><strong>Lake Optimizer：湖表性能全面对齐甚至超越内表</strong><br/>
推出专为开放数据湖设计的 Lake Optimizer，显著提升 Apache Paimon 等湖表格式的查询性能，让湖表在复杂分析场景中媲美甚至超越传统内表体验。</li>
<li><strong>智能化 Background Job Service：彻底释放用户运维负担</strong><br/>
针对企业用户长期面临的内表运维复杂、资源争抢等问题，Stella 将推出智能化后台作业服务，自动处理 compaction、索引构建、统计信息收集等任务，实现高智能化的自治运维，大幅提升系统稳定性与资源效率。</li>
<li><strong>全文检索与向量检索能力持续提升</strong><br/>
在已有的高性能 OLAP 基础上，进一步融合全文检索与向量检索能力，支持非结构化与多模态数据的统一分析，为 AI 原生应用、智能搜索等新兴场景提供底层引擎支撑。</li>
</ol>
<p>这四大方向不仅体现了 Stella 对 Lakehouse 架构的深度适配，更彰显了其从“高性能分析引擎”向“智能数据平台核心引擎”演进的战略决心。随着这些能力的逐步落地，Stella 将为企业用户提供更开放、更智能、更易用的下一代实时分析体验。</p>
<h2 data-id="heading-7">技术探索与社区协作深度融合</h2>
<p>Stella引擎在技术架构探索方面持续深化与开源社区的合作：</p>
<p>Lakehouse架构能力的持续拓展体现了Stella引擎的前瞻性设计理念。在现有Lakehouse架构基础上，系统将支持更多检索功能，为企业的多元化分析需求提供全面支持。向量搜索技术是与Apache Paimon深度集成的创新探索，在AI和大数据时代，向量搜索能力将成为差异化的技术优势。</p>
<h3 data-id="heading-8">开源社区贡献亮点</h3>
<ul>
<li><strong>JSON等半结构化数据处理能力持续增强</strong>，推动整个生态发展</li>
<li><strong>大规模场景技术实践经验分享</strong>，为社区贡献宝贵技术智慧</li>
<li><strong>与Apache Paimon团队深度技术合作</strong>，确保生态整合持续优化</li>
<li><strong>所有优化方案回馈开源社区</strong>，推动开源生态系统发展进步</li>
</ul>
<p>开源社区的深度贡献体现了Stella团队的技术责任感和开放合作精神。JSON等半结构化数据处理能力的持续增强将推动整个生态的发展，为企业在数字化转型过程中处理多样化数据提供更强支持。大规模场景下的技术实践经验分享不仅展示技术实力，更为社区贡献了宝贵的技术智慧。</p>
<p>“我们不仅要在云上提供增值服务，更要推动整个开源生态的发展，”周康强调，“通过深度参与开源社区，确保所有用户都能从技术进步中受益。”</p>
<h2 data-id="heading-9">技术意义与未来规划</h2>
<p>EMR Serverless Stella 1.0的发布标志着阿里云在湖仓一体技术领域达到新的里程碑，为用户提供从数仓加速、湖仓查询到全文检索的全方位OLAP能力支持。该版本不仅解决了企业在实际生产环境中遇到的关键技术挑战，更通过持续的技术创新和社区贡献，推动了整个StarRocks生态系统的发展。</p>
<p>未来，Stella将继续围绕Lakehouse架构演进，在缓存调度、查询优化、存储引擎和写入能力等核心领域持续创新，为企业数字化转型提供更加强劲的技术引擎。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【开源】耗时数月、我开发了一款功能全面【30W行代码】的AI图床]]></title>    <link>https://juejin.cn/post/7574271557938905139</link>    <guid>https://juejin.cn/post/7574271557938905139</guid>    <pubDate>2025-11-19T10:15:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574271557938905139" data-draft-id="7574271557938855987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【开源】耗时数月、我开发了一款功能全面【30W行代码】的AI图床 "/> <meta itemprop="keywords" content="前端,后端,开源"/> <meta itemprop="datePublished" content="2025-11-19T10:15:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_小九"/> <meta itemprop="url" content="https://juejin.cn/user/3861140568811576"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【开源】耗时数月、我开发了一款功能全面【30W行代码】的AI图床 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3861140568811576/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _小九
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.5 如鱼得水
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.5 如鱼得水" title="VIP.5 如鱼得水" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T10:15:48.000Z" title="Wed Nov 19 2025 10:15:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AI编程发展迅猛，现在如果你是一个全栈开发，借助AI编辑器，比如<strong>Trae</strong>你可以开发很多你以往无法实现的功能，并且效率会大大提示，<strong>Tare</strong>的<strong>Coding能力</strong>已经非常智强了，借助他，我完成了这个<code>30W行</code>代码的开源项目，现在，想把这个项目推荐给你。</p>
<p>当前文章主要是介绍我们开发出的这个项目，在后续，将会新开一个文章专门介绍<strong>AI Coding</strong>的各种技巧，如何使用他，才能让他在<strong>大型项目</strong>中依然如虎添翼。</p>
<blockquote>
<p>如果你想快速了解此项目、你可以访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fpixelpunk.cc%2F" target="_blank" title="https://pixelpunk.cc/" ref="nofollow noopener noreferrer">PixelPunk官方文档</a>。</p>
</blockquote>
<blockquote>
<p>如果你想快速体验此项目、你可以访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fv1.pixelpunk.cc%2F" target="_blank" title="https://v1.pixelpunk.cc/" ref="nofollow noopener noreferrer">V1版本</a>,前往体验功能。</p>
</blockquote>
<blockquote>
<p>如果你想完整体验前后台全面的功能、你可以访问<a href="https://link.juejin.cn?target=http%3A%2F%2Fdev.pixelpunk.cc%2F" target="_blank" title="http://dev.pixelpunk.cc/" ref="nofollow noopener noreferrer">测试环境</a>。【root 123456】</p>
</blockquote>
<blockquote>
<p>如果您认可我的项目，愿意为我献上一个宝贵的Star，你可以前往<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCooperJiang%2FPixelPunk" target="_blank" title="https://github.com/CooperJiang/PixelPunk" ref="nofollow noopener noreferrer">PixelPunk</a>项目。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bada0a94aae436495f282772dd0748b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=046KAzJ3ITK5fWE0X%2BdC2dEoQZc%3D" alt="image.png" loading="lazy"/></p>
<p>开发这样一个项目在现在这个时间来看似乎没什么必要，实际上开发这样一个项目的原因其实就是在年初的时候失业了一段时间，闲在家里无聊，于是想着做一个自己的开源项目，最开始其实做的是另一个类型的项目，开发了一段时间感觉有些无聊就转战做了现在的这个项目<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCooperJiang%2FPixelPunk" target="_blank" title="https://github.com/CooperJiang/PixelPunk" ref="nofollow noopener noreferrer">PixelPunk图床</a>， 其实并不只是想要做一个<code>图床</code>，只是当前来说的一期功能比较贴合图床，后期的跌代准备支持更多格式包括视频文档等等，并且由于<code>AI多模态模型</code>的能力发展迅速，后期结合<code>AI</code>可以实现更多可玩性比较高的内容。</p>
<p>市面上已经有了非常多的开源图床了，开发这样一个项目要追求一些差异点才会有价值，本质上来说这类服务其实核心就是个存图片而已，其他功能并不是很重要，但是作为个人使用用户来说，除了存图也愿意去尝试一些便捷的功能，于是思考到这个点之后，我开始了这个项目的开发，项目的命名<code>[PixelPunk] </code>是我让AI起的，因为要做就要做一个不一样的有特点，我要做一个ui上就不一样的图床出来，于是有了此命名，中文翻译过来是<code>像素朋克</code>,由于像素风格感觉ui不是很适合工具类网站使用，于是我选择了<code>赛博朋克风格</code>，围绕这个ui来开发了此项目。</p>
<h3 data-id="heading-0">项目概览</h3>
<p>首先呢项目从开发就一个全栈项目，前后端放一起了，采用的技术栈是 go+vue， 前端会将打包的文件放入到go中一起打包为<code>二进制</code>安装包，这样部署起来将非常简单。
项目分为了用户端和管理端，并且同属于一个项目，不分离开发，为了符合我们定制化的ui，所有组件都是自定义的组件，项目使用了<code>70+</code>自定义组件。
项目接入了多模态<code>AI</code>大模型，在以前我们的图床要实现各种功能需要对接各种各样的平台，现在有了<code>AI</code>，我们只需要一个模型就能完成非常多的功能，比如【<strong>语义化描述图片</strong>】，【**<em>图片OCR识别</em>】，【**<em>图片自动分类</em>】，【**<em>图片自动打标</em>】，【**<em>图标自动审核NSFW、违规图、敏感图、血腥图等等</em>】，【<strong>图片颜色提取</strong>】等等功能都只需要配置一个<code>AI模型</code>即可，对于成本而言，比之前的三方<code>API</code>可能更加便宜</p>
<h3 data-id="heading-1">关于部署</h3>
<p>作为一个开源项目，我想的是需要使用者使用起来足够简单，部署起来也足够快，本身来讲，我们项目需要用来这些内容，<code>mysql|Sqlite</code> + <code>Redis|系统内存</code> + <code>qdrant向量数据库</code>， 这三件套，为了安装简单，我将向量数据库直接集成到安装包，用户可以无需关系任何内容，我们可以做到<code>0配置启动项目</code>，不需要你做任何配置即可超快部署项目。</p>
<p>我们提供了两种部署方式，一种是安装包部署，你可以下载对应平台的安装包**.zip安装包**，下载到你的服务器，解压之后里面有一个<code>install.sh</code>，直接<code>sh ./install.sh</code>即可安装，当然手动部署 可能还需要两个步骤，你可以使用我们的脚本直接进行部署，也可以看看我们的部署文档，<a href="https://link.juejin.cn?target=https%3A%2F%2Fpixelpunk.cc%2Fdocs%2Fgetting-started" target="_blank" title="https://pixelpunk.cc/docs/getting-started" ref="nofollow noopener noreferrer">PixelPunk部署文档</a>。</p>
<blockquote>
<p>安装包一键部署 <code>curl -fsSL https://download.pixelpunk.cc/shell/install.sh | bash</code></p>
</blockquote>
<blockquote>
<p>docker-compose一键部署脚本 <code>curl -fsSL https://download.pixelpunk.cc/shell/docker-install.sh | bash</code></p>
</blockquote>
<p>我们的部署非常简单，你只需要执行完脚本即可直接启动项目，我们的<code>docker-compose部署方式</code>已经配置了所有数据库缓存等信息，启动项目进入 <strong><a href="https://link.juejin.cn?target=http%3A%2F%2Fip%3A9520" target="_blank" title="http://ip:9520" ref="nofollow noopener noreferrer">http://ip:9520</a></strong> 会自动跳转到安装页面，添加管理员账号密码即可完成安装， 如果使用安装包模式呢，那么就支持你可以自定义选择数据库，可以填写自己的mysql，也可以使用系统内置的<code>Sqlite</code>，可以选择自己的<code>向量数据库和缓存</code>，也可以使用系统内置的，自由选择，总之，一键脚本预估20S就可以帮你安装并且启动项目，无需你的任何配置，希望会自己内置生成一些必要信息，比如<strong>jwt</strong>，系统安装后你可以进入后台管理进行修改。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28da070422dd4053915ba5f9e947322a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=QN8mnmOLPXfFpR6sGM1VVRjEBNw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">项目部分功能</h3>
<p>我们的项目功能可以说已经非常全面了，并且还在持续迭代，目前代码总行数已经达到了<code>30W行</code>，很多功能需要你自己体验，我们覆盖了主流图床的全部功能，并且还在进一步持续加入更多有趣的元素，我们可以列举一些功能做简要说明。</p>
<h4 data-id="heading-3">10+精美主题</h4>
<p>作为个人使用的工具，我一直在持续优化UI和交互，始终认为，<code>UI</code>还是很重要的一个步骤，目前的<code>UI还不够精美</code>，也是后续会持续调整的一个点，目前提供了<code>10多套</code>主题，并且您可以自定义主题，我在项目中放置了<strong>主题开发文档</strong>,你可以根据模板文件去替换一套变量即可完成一套主题的开发。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c9416634a9d4fe6a07b2f25dbab0ab4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=pkSI7K4CTlF5zHMEZLBFxl1QmFg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdf3798fec034b7aaceff58524b7b733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=gYITr0mdbY2Rj4EWqkTBkRBJJ3c%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">多语言双风格</h4>
<p>我们目前内置了三种语言<code>中英日</code>,并且为了迎合我们<code>PixelPunk风格</code>的特色，我们新增了一种风格选项，你可以选择<code>赛博朋克风格</code>的文案，让系统的所有内容提示充满赛博味道~</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3152eb1f44824daa9aaf4428e0357b0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=9u%2BdbT%2BNiVsgEKrlEa8cpZPpZXY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62ec4e8376c542c6b5fc0a62f9b8a512~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=zQlg2awfkZ6nL8c7OPjhm2V2hoA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">多布局系统</h4>
<p>我们网站为了更好的工作体验，提供了两种的布局方式,<code>传统布局</code>,<code>工作布局</code>，既可以使用传统的轻量化的布局让人轻松，也可以使用工作台布局让工作更高效。并且您还可以在后台限制这些功能，使用固定布局而不开放这些功能，在后台管理部分都可以实现。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b76d28edf12749e180c31bd42d90ad6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=BqsX8kXEGnHy0rVFOuBgu6jFKkQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f22417779924ad1898afc8620ad40f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=YyNiK%2FGz7syOQpWj8I6Ng%2BwaYc8%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">多种登录方式</h4>
<p>我们内置默认使用传统邮箱的登录方式，并且支持关闭注册，<code>邮箱配置也是后台配置即可</code>，同时系统对接了<code>Github</code>、<code>Google</code>、<code>LinuxDo</code>三种接入成本非常低的快捷登录方式，并且可能由于你是国内服务器，无法直接访问这些服务，所以系统贴心的准备了<code>(代理服务)</code>配置，让你即使是国内服务器也依然可以顺利完成这些快捷登录。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55af683a3ec340e09bba7b1a875dfaf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=bRWkKlZ%2FyX0ZYNK2y0Bpw41%2FQ3A%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8fc5d4613564de4b8bb1b823ec4c39e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=AIrC%2Fyf%2BppTocXvsAPBoh16kV7o%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">强大的特色文件上传</h4>
<p>文件上传是一个基础的功能，所有图床都支持，我们当然也支持，我们在此功能上进行了耐心的打磨，支持很多特色功能，</p>
<ul>
<li>支持后台动态配置允许格式，动态配置上传图片限制尺寸</li>
<li>支持<code>大文件分片上传</code>、<code>断点续传</code>等功能。</li>
<li>支持<code>秒传</code>，后台动态开启是否启用</li>
<li>支持<code>游客模式</code>，限制游客上传数量，并限制上传资源有效时间</li>
<li>支持<code>自定义资源保存时间</code>，后台可配置用户允许选择有效期，精确到分钟</li>
<li>支持<code>重复图检测</code>，重复图自动秒传，不占用空间</li>
<li>支持水印，并且特色化水印，开发了一个水印专用面板用于你配置特色化水印，支持<code>文字、图片</code>水印。</li>
<li>支持<code>中断上传</code>,取消上传</li>
<li>支持<code>上传实时进度提示</code></li>
<li>支持<code>自动优化图片</code>，<code>自定义上传文件夹</code>。</li>
<li>支持<code>文件夹上传</code>,<code>拖拽上传</code>,<code>项目内全局上传（任意页面都支持上传）</code>。</li>
<li>支持<code>原图复制</code>,<code>MD格式复制</code>,<code>HTML格式复制</code>,<code>缩略图格式复制</code>,<code>全部图片链接批量复制</code></li>
<li>支持<code>公开、私密、受保护</code>,三种权限设置，<code>公开图片</code>可以在任何地方显示并且授权给管理员可以用于推荐，并且在作者首页可以展示对外，<code>私密</code>则仅自己可见，系统其他人不可见，<code>受保护</code>权限图片只能在系统观看打开，无法产生链接，除自己登录系统外，其他人无法观看。</li>
<li>支持<code>持久化</code>，你可以选择图片并且上传中，跳转到任何页面而不会中断你的上传，你可以在上传过程中干任何事情</li>
<li>支持<code>特色悬浮球</code>，当你不在上传页面的其他页面，如果有上传内容，会有一个特色上传球实时告知您上传的进度，并且你可以随意拖动控制悬浮球的位置。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fdc7ea1ec924525bf3b14d5d5ca803d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=P5I48qTZ681qRtQemYbnxdyM2MY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f66c5469421d47639f17f4d9fd308934~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=AGis85x6E6aOeT514m8gygfdzhU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93ae54015b5348ceaa37d7fc7874985f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=Vo6udTlkiV2aSaZXgQXvrfRQ6G4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">超过上传渠道支持</h4>
<p>作为一个图床的基本素养，都会支持对接三方，目前我们已经支持了<code>10+</code>的三方云储存渠道，并且添加时候可以测试渠道保障你的配置，首先我们支持<code>服务器自身存储</code>，这也是系统默认渠道，你可以在后台渠道配置更多，比如<code>阿里云COS</code>,<code>腾讯云OSS</code>,<code>七牛云</code>,<code>雨云</code>,<code>又拍云</code>,<code>S3</code>,<code>Cloudfare R2</code>,<code>WebDav</code>,<code>AZure</code>,<code>Sftp</code>,<code>Ftp</code>,等等渠道，<strong>S3</strong>协议本身就可以支持非常多的基于S3协议的渠道了，并且，如果你想要更多渠道，可以去往我们官网网站提起诉求，我们可以很快支持新的渠道。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa931accca7c4903a5eb329f90d1adb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=lykqpx7jqED%2B9tnj8GK1NffKGnE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e2674a6366e4caabe03f3f98f0f6391~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=Ui6agEDPab1Q5OjE2WpOoaki%2B7A%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-9">特色AI功能</h4>
<p>AI也是我们图床的一大特色，我们利用AI做了这些事情</p>
<ul>
<li>自动分类</li>
<li>自动打标</li>
<li>语义化图片，提取信息，提取色调</li>
<li>实现ai自然语言搜索</li>
<li>实现相似图搜索</li>
<li>实现NSFW违规图审核</li>
</ul>
<p>而这些，仅仅只需要配置一个<strong>openai的gpt4-mini</strong>即可完成，后续会支持更多渠道（目前仅支持配置OPENAI格式的渠道），目前测试感觉<strong>gpt-4.1-mini</strong>足以胜任工作，并且价格低廉，性价比很高。</p>
<ul>
<li>违规图片检测 可以自定义等级 宽松或严格</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b57cfde532dc4c13bad16a572ff66a93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=qYG9qLtaHLEDBDx28fKEH5Sd5Go%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>自然语言搜索图片</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/084de3398649419f834f4c948b2bcfa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=Tt8nptZae1e3dNdJjKKL0js4HNI%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>相似图搜索</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d322149879694be5bfd9c7a94b420738~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=V9k%2BBT44cE4Xln%2B6wh4JTSX5f8g%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>图片ai描述</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55e575a838c24ced9ef145455cdd7ef1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=l%2BKwYtVZq0zxvfGEX5EvvthywJU%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>自动分类打标签</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05ea689cef8c44829823170ca949d523~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=mn03ubC2618pQuafFawjHPicIOA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">文件夹功能</h4>
<p>文件分类是一个和合理的诉求，所以我们可以自定义创建文件夹，同样可以控制不同的权限，并且文件夹可以无限嵌套 你可以自定义多层级的文件夹 合理管理你的文件，并且我们支持<code>文件夹移动</code>，<code>图片移动</code>，<code>批量操作</code>，<code>右键菜单</code>，<code>拖拽排序</code>等等特色功能，你可以灵活的管理你的文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffa3db788fb14937a9ca47cf82d77def~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=Zm%2F3TEl193SXbkK5hzmIiU0rJ8A%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>右键菜单</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/512e2954b1334e7fa3b57f69b490068d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=D3V4yCKNPBX62VmzJzfo0EBY%2F1g%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-11">分享系统</h4>
<p>我们拥有大量素材，或者一些收藏资源需要分享给好友，我们可以任意创建分享，可以分享自己的文件夹，图片，也可以组合分享，也可以分享用户公开的推荐图，选择任意探索广场的图进行分享，并且可以统计访问次数，限制访问次数，达到访问次数关闭分享，密码分享，限制时间有效期分享，邮箱通知等等功能。</p>
<p>您可以观看我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fv1.pixelpunk.cc%2Fshare%2FETDMDkz6EnzZxEMl" target="_blank" title="https://v1.pixelpunk.cc/share/ETDMDkz6EnzZxEMl" ref="nofollow noopener noreferrer">演示分享内容</a></p>
<ul>
<li>创建分享</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa459bf521ec476b8190f04bb4f84bd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=nnXi4XsOomOAIkEv6%2F9v4f1kaeU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a5e483c67d4441e897fb2c9879ec1b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=gh9K%2Bc9DazHicKKW500pas9c7EM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-12">防盗链管理</h4>
<p>图床安全始终是一个问题，经常会遇到被盗刷的风险，由于流量费用贵，鄙人有幸被刷破产过一次（TMD），我们加入了防盗链配置，可以配置<code>白黑名单域名|IP</code>，可以配置<code>网站refer</code>等内容，并且对于违规的用户，我们可以配置让其<code>302到他地址</code>,<code>可以自定义返回固定图</code>,<code>也可以直接拒绝</code>。</p>
<p>当我们对接三方渠道的时候，正常情况我们会拿到<code>远程url地址</code>，我们依然可以在后台配置渠道将其隐藏远程url地址，如果配置，那么域名请求将会从我们服务器代理获取，可以隐藏掉三方的地址，或者配置私有存储桶通过秘钥去动态获取图片，防止你的图片被盗刷大量流量</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6092e578d72a4b2f83e9f98b4ec1c277~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=s%2BghD%2FZfbwm7WX5k72c2eppjwgk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-13">开放API</h4>
<p>图床的基本功能之一，我们可以生成秘钥在三方进行上传文件，不同的是，我们系统支持了设置秘钥时可以<code>限制其使用的空间</code>，<code>限制上传次数</code>，可以<code>指定上传的文件夹</code>,指定<code>文件格式</code>等等，并位置提供了完整的上传文档，支持<code>单文件上传</code>,<code>多文件上传</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90d55a4cd12e45f3bccb57c8a30470dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=WQI3G2nTForI1P94vE%2FWCry264g%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-14">随机图片</h4>
<p>经常会有人需要一个随机图片的API，但是受限于使用别人的不够稳定，也不够灵活，于是我们开放了一个随机API功能，你可以动态的配置，选择其绑定你需要随机的图片，比如指定随机任意文件夹，指定返回方式302重定向，或直接返回图片，你可以点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fv1.pixelpunk.cc%2Fapi%2Fv1%2Fr%2Frnd_C3wEvW5T9EjJ" target="_blank" title="https://v1.pixelpunk.cc/api/v1/r/rnd_C3wEvW5T9EjJ" ref="nofollow noopener noreferrer">pixelpunk随机图片API演示</a> ，每次刷新你可以获取新的图片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d507d4f2f6947ef80c161b73337a5fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=%2FI687jhTfSy0lKAJpYJMOLzcATQ%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-15">空间带宽控制</h4>
<p>我们允许为用户配置限制的使用空间和流量，后台动态灵活配置这些内容，保证多用户使用的时候限制用户使用量。</p>
<h3 data-id="heading-16">更多功能</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed3904072cee4741a79777739e8ae0af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=Pf96zVJF6ve6QljPCceE3AR9VnE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92f44fb955fd48d283b89d061a5651e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=ge1kF0X3PvyAs4tLCnpOoBnTLkM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/813a5acee47f4818a667273b7ee0785e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=m2rGsoQ%2BSLy1j4aeBf7r59K5AwU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7232fbd2fa040d888643bf21fee31dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=mxt90OLx%2BeUlacgijTrk5k8aeRk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/800b0f1909c343e4b00f1b8b18b06fcd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wwj-S5nQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152147&amp;x-signature=29ECRlu6CGV5sUt9sEG2TbhLWPg%3D" alt="image.png" loading="lazy"/></p>
<p>总之我们的功能远不止如此，我们还有很多有意思的功能，一些更多的细节需要你去探索，比如，公告系统、消息通知、活动日志、限制登录、IP登录记录，超全的管理系统、埋点统计、访客系统等等模块，这是我个人第一个花费较多时间开发的一套系统，目前对比市面上所有的开源图床，自我认为是一款相对功能最全面的图床，耗费了我大量时间。</p>
<p>如果佬友花费时间看到了这里，那么希望能收获你的一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCooperJiang%2FPixelPunk" target="_blank" title="https://github.com/CooperJiang/PixelPunk" ref="nofollow noopener noreferrer">宝贵的Star</a>,后续的功能我依然会持续跌代，如果你有任何需求，可以私信我，如果合理，我可以无偿免费优先加入到后续跌代中去。</p>
<h3 data-id="heading-17">待更新预期功能</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 后端多语言适配</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> UI 美化</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Desktop 端开发</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 更多格式支持 (视频|文档)</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 交互体验优化</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 更多渠道支持</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 更多AI接入</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 图片处理工具箱</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【穿越Effective C++】条款22：将成员变量声明为private——封装的边界与设计的自由]]></title>    <link>https://juejin.cn/post/7574281453706854406</link>    <guid>https://juejin.cn/post/7574281453706854406</guid>    <pubDate>2025-11-19T10:22:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574281453706854406" data-draft-id="7574253222606782505" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【穿越Effective C++】条款22：将成员变量声明为private——封装的边界与设计的自由"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-11-19T10:22:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐怡旸"/> <meta itemprop="url" content="https://juejin.cn/user/2875978146656750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【穿越Effective C++】条款22：将成员变量声明为private——封装的边界与设计的自由
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978146656750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐怡旸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T10:22:47.000Z" title="Wed Nov 19 2025 10:22:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这个条款揭示了C++类设计的核心封装原则：成员变量应该声明为private，这不仅是技术选择，更是软件设计哲学的体现。通过严格控制数据访问，我们获得了实现灵活性、接口稳定性和维护便利性。</p>
<hr/>
<h3 data-id="heading-0"><strong>思维导图：成员变量封装的完整体系</strong></h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74cc5e2eec1e4da399a97db4ea1713e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5oCh5pe4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152567&amp;x-signature=hc6BMe%2F3o6XKFqTkWFHMZ77aNMw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1"><strong>关键洞见与行动指南</strong></h3>
<h4 data-id="heading-2"><strong>必须遵守的核心原则：</strong></h4>
<ol>
<li><strong>严格数据封装</strong>：所有数据成员都应该声明为private，无一例外</li>
<li><strong>行为导向接口</strong>：提供操作而非数据访问，表达"做什么"而非"是什么"</li>
<li><strong>实现自由度</strong>：保持改变内部实现的自由，不影响客户端代码</li>
<li><strong>不变式维护</strong>：在成员函数中集中维护类的不变式</li>
</ol>
<h4 data-id="heading-3"><strong>现代C++开发建议：</strong></h4>
<ol>
<li><strong>统一访问方法</strong>：为需要访问的数据提供一致的get/set接口</li>
<li><strong>移动语义支持</strong>：在访问函数中正确处理移动语义</li>
<li><strong>智能指针管理</strong>：对于动态资源，使用智能指针封装所有权</li>
<li><strong>const正确性</strong>：正确使用const成员函数提供只读访问</li>
</ol>
<h4 data-id="heading-4"><strong>设计原则总结：</strong></h4>
<ol>
<li><strong>最小权限原则</strong>：只暴露必要的最小接口，隐藏所有实现细节</li>
<li><strong>单一责任原则</strong>：数据和行为应该封装在同一个类中</li>
<li><strong>开闭原则</strong>：对扩展开放，对修改封闭</li>
<li><strong>依赖倒置原则</strong>：依赖抽象而非具体实现</li>
</ol>
<h4 data-id="heading-5"><strong>需要警惕的陷阱：</strong></h4>
<ol>
<li><strong>过度封装</strong>：为每个字段提供get/set等于没有封装</li>
<li><strong>protected陷阱</strong>：protected成员几乎和public一样缺乏封装性</li>
<li><strong>友元滥用</strong>：过度使用friend会破坏封装边界</li>
<li><strong>接口膨胀</strong>：暴露不必要的实现细节通过公有接口</li>
</ol>
<p><strong>最终建议：</strong> 将private成员变量视为类设计的防火墙。培养"封装思维"——在设计每个类时都思考："这个数据应该怎样被访问？谁会需要它？如何确保数据的完整性？" 这种思考方式是构建可维护、可扩展软件系统的关键。</p>
<p>记住：<strong>在C++类设计中，将成员变量声明为private不是可选项，而是必选项。这是区分专业设计和业余设计的关键标志。</strong> 条款22教会我们的不仅是一种编码规范，更是软件工程基本原则的具体实践。</p>
<hr/>
<h3 data-id="heading-6"><strong>深入解析：封装的核心价值</strong></h3>
<h4 data-id="heading-7"><strong>1. 实现自由的保障</strong></h4>
<p><strong>封装带来的实现灵活性：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 初始实现：使用数组存储</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentRecords</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">size_t</span> MAX_STUDENTS = <span class="hljs-number">1000</span>;
    Student students_[MAX_STUDENTS];
    <span class="hljs-type">size_t</span> count_ = <span class="hljs-number">0</span>;

<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addStudent</span><span class="hljs-params">(<span class="hljs-type">const</span> Student&amp; student)</span> </span>{
        <span class="hljs-keyword">if</span> (count_ &lt; MAX_STUDENTS) {
            students_[count_++] = student;
        }
    }
    
    <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">getStudentCount</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> count_; }
};

<span class="hljs-comment">// 升级实现：使用vector，接口不变！</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentRecords</span> {
<span class="hljs-keyword">private</span>:
    std::vector&lt;Student&gt; students_;  <span class="hljs-comment">// 实现完全改变！</span>

<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addStudent</span><span class="hljs-params">(<span class="hljs-type">const</span> Student&amp; student)</span> </span>{
        students_.<span class="hljs-built_in">push_back</span>(student);
    }
    
    <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">getStudentCount</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ 
        <span class="hljs-keyword">return</span> students_.<span class="hljs-built_in">size</span>();  <span class="hljs-comment">// 接口行为一致</span>
    }
};
</code></pre>
<h4 data-id="heading-8"><strong>2. 访问控制的精确性</strong></h4>
<p><strong>精细的访问控制示例：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">double</span> balance_;
    std::string accountNumber_;
    <span class="hljs-type">bool</span> isActive_;
    <span class="hljs-keyword">mutable</span> std::mutex balanceMutex_;  <span class="hljs-comment">// 封装同步原语</span>

<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 只读访问 - 线程安全</span>
    <span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">getBalance</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(balanceMutex_)</span></span>;
        <span class="hljs-keyword">return</span> balance_;
    }
    
    <span class="hljs-comment">// 受控的写入操作</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">deposit</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> </span>{
        <span class="hljs-keyword">if</span> (amount &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">"存款金额必须为正"</span>);
        }
        
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(balanceMutex_)</span></span>;
        balance_ += amount;
        <span class="hljs-built_in">logTransaction</span>(<span class="hljs-string">"存款"</span>, amount);
    }
    
    <span class="hljs-comment">// 条件化操作 - 业务规则封装</span>
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">withdraw</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> </span>{
        <span class="hljs-keyword">if</span> (amount &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">"取款金额必须为正"</span>);
        }
        
        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(balanceMutex_)</span></span>;
        <span class="hljs-keyword">if</span> (balance_ &gt;= amount) {
            balance_ -= amount;
            <span class="hljs-built_in">logTransaction</span>(<span class="hljs-string">"取款"</span>, amount);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 计算属性 - 不存储但通过接口暴露</span>
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isOverdrawn</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getBalance</span>() &lt; <span class="hljs-number">0</span>;
    }
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">logTransaction</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; type, <span class="hljs-type">double</span> amount)</span> </span>{
        <span class="hljs-comment">// 封装日志实现</span>
    }
};
</code></pre>
<hr/>
<h3 data-id="heading-9"><strong>解决方案：正确的封装实践</strong></h3>
<h4 data-id="heading-10"><strong>1. 行为导向的接口设计</strong></h4>
<p><strong>提供操作而非数据访问：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 糟糕的设计：暴露数据成员</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BadTemperatureSensor</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-type">double</span> currentTemperature;  <span class="hljs-comment">// public数据成员！</span>
    <span class="hljs-type">double</span> minTemperature;
    <span class="hljs-type">double</span> maxTemperature;
};

<span class="hljs-comment">// 优秀的设计：封装行为</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodTemperatureSensor</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">double</span> currentTemperature_;
    <span class="hljs-type">double</span> minTemperature_;
    <span class="hljs-type">double</span> maxTemperature_;
    <span class="hljs-type">bool</span> isCalibrated_;

<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 行为接口，而非数据访问</span>
    <span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">readTemperature</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">if</span> (!isCalibrated_) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">logic_error</span>(<span class="hljs-string">"传感器未校准"</span>);
        }
        <span class="hljs-keyword">return</span> currentTemperature_;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">calibrate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 复杂的校准逻辑</span>
        isCalibrated_ = <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isInSafeRange</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> currentTemperature_ &gt;= minTemperature_ &amp;&amp; 
               currentTemperature_ &lt;= maxTemperature_;
    }
    
    <span class="hljs-comment">// 必要时提供受控的数据访问</span>
    <span class="hljs-function">TemperatureRange <span class="hljs-title">getSafeRange</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> {minTemperature_, maxTemperature_};
    }
};
</code></pre>
<h4 data-id="heading-11"><strong>2. 计算属性与延迟初始化</strong></h4>
<p><strong>封装复杂的数据访问逻辑：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentProcessor</span> {
<span class="hljs-keyword">private</span>:
    std::string content_;
    <span class="hljs-keyword">mutable</span> std::unique_ptr&lt;WordCount&gt; wordCountCache_;  <span class="hljs-comment">// 延迟计算</span>
    <span class="hljs-keyword">mutable</span> std::unique_ptr&lt;ReadabilityScore&gt; readabilityCache_;
    <span class="hljs-keyword">mutable</span> <span class="hljs-type">bool</span> isAnalyzed_ = <span class="hljs-literal">false</span>;

<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setContent</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; content)</span> </span>{
        content_ = content;
        <span class="hljs-built_in">invalidateCaches</span>();  <span class="hljs-comment">// 状态变化时清理缓存</span>
    }
    
    <span class="hljs-comment">// 计算属性：看起来像数据，实则是计算</span>
    <span class="hljs-function"><span class="hljs-type">const</span> WordCount&amp; <span class="hljs-title">getWordCount</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">if</span> (!wordCountCache_) {
            wordCountCache_ = std::<span class="hljs-built_in">make_unique</span>&lt;WordCount&gt;(<span class="hljs-built_in">analyzeWords</span>());
        }
        <span class="hljs-keyword">return</span> *wordCountCache_;
    }
    
    <span class="hljs-function"><span class="hljs-type">const</span> ReadabilityScore&amp; <span class="hljs-title">getReadability</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">if</span> (!readabilityCache_) {
            <span class="hljs-built_in">ensureAnalysis</span>();  <span class="hljs-comment">// 确保分析完成</span>
            readabilityCache_ = std::<span class="hljs-built_in">make_unique</span>&lt;ReadabilityScore&gt;(<span class="hljs-built_in">calculateReadability</span>());
        }
        <span class="hljs-keyword">return</span> *readabilityCache_;
    }

<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">invalidateCaches</span><span class="hljs-params">()</span> </span>{
        wordCountCache_.<span class="hljs-built_in">reset</span>();
        readabilityCache_.<span class="hljs-built_in">reset</span>();
        isAnalyzed_ = <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ensureAnalysis</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">if</span> (!isAnalyzed_) {
            <span class="hljs-built_in">performDeepAnalysis</span>();
            isAnalyzed_ = <span class="hljs-literal">true</span>;
        }
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">performDeepAnalysis</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-comment">// 昂贵的分析操作</span>
    }
};
</code></pre>
<hr/>
<h3 data-id="heading-12"><strong>protected成员的陷阱</strong></h3>
<h4 data-id="heading-13"><strong>1. protected几乎等于public</strong></h4>
<p><strong>protected成员的封装性缺陷：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {
<span class="hljs-keyword">protected</span>:
    <span class="hljs-type">int</span> protectedData_;  <span class="hljs-comment">// 以为比public好？</span>
    std::vector&lt;<span class="hljs-type">int</span>&gt; implementationDetails_;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Base</span>() = <span class="hljs-keyword">default</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> : <span class="hljs-keyword">public</span> Base {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">misuseProtected</span><span class="hljs-params">()</span> </span>{
        protectedData_ = <span class="hljs-number">42</span>;  <span class="hljs-comment">// 派生类可以任意修改</span>
        implementationDetails_.<span class="hljs-built_in">clear</span>();  <span class="hljs-comment">// 破坏基类实现假设</span>
    }
};

<span class="hljs-comment">// 问题：一旦修改Base的protected成员，所有派生类都需要修改！</span>
<span class="hljs-comment">// 封装性实际上和public差不多差</span>
</code></pre>
<h4 data-id="heading-14"><strong>2. 更好的替代方案</strong></h4>
<p><strong>使用private + 受保护的访问函数：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WellDesignedBase</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> implementationDetail_;
    std::vector&lt;<span class="hljs-type">int</span>&gt; internalData_;

<span class="hljs-keyword">protected</span>:
    <span class="hljs-comment">// 为派生类提供受控的扩展点</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">doProcess</span><span class="hljs-params">(<span class="hljs-type">int</span> data)</span> </span>{
        <span class="hljs-comment">// 默认实现</span>
        implementationDetail_ = data;
    }
    
    <span class="hljs-comment">// 只读访问给派生类</span>
    <span class="hljs-function"><span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">int</span>&gt;&amp; <span class="hljs-title">getInternalData</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> internalData_;
    }
    
    <span class="hljs-comment">// 受控的写入给派生类</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safelyModifyData</span><span class="hljs-params">(<span class="hljs-type">size_t</span> index, <span class="hljs-type">int</span> value)</span> </span>{
        <span class="hljs-keyword">if</span> (index &lt; internalData_.<span class="hljs-built_in">size</span>()) {
            internalData_[index] = value;
            <span class="hljs-built_in">onDataModified</span>();  <span class="hljs-comment">// 通知机制</span>
        }
    }

<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">(<span class="hljs-type">int</span> data)</span> </span>{
        <span class="hljs-comment">// 参数验证、日志、性能监控...</span>
        <span class="hljs-built_in">doProcess</span>(data);
        <span class="hljs-comment">// 后处理、清理、通知...</span>
    }

<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">onDataModified</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 状态变化处理</span>
    }
};
</code></pre>
<hr/>
<h3 data-id="heading-15"><strong>现代C++的封装增强</strong></h3>
<h4 data-id="heading-16"><strong>1. 移动语义的封装支持</strong></h4>
<p><strong>自动化的资源管理：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ResourceHolder</span> {
<span class="hljs-keyword">private</span>:
    std::unique_ptr&lt;ExpensiveResource&gt; resource_;
    std::vector&lt;<span class="hljs-type">int</span>&gt; data_;

<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 移动操作的自动支持</span>
    <span class="hljs-built_in">ResourceHolder</span>(ResourceHolder&amp;&amp;) = <span class="hljs-keyword">default</span>;
    ResourceHolder&amp; <span class="hljs-keyword">operator</span>=(ResourceHolder&amp;&amp;) = <span class="hljs-keyword">default</span>;
    
    <span class="hljs-comment">// 拷贝操作需要显式处理</span>
    <span class="hljs-built_in">ResourceHolder</span>(<span class="hljs-type">const</span> ResourceHolder&amp; other) 
        : <span class="hljs-built_in">data_</span>(other.data_) {
        <span class="hljs-keyword">if</span> (other.resource_) {
            resource_ = std::<span class="hljs-built_in">make_unique</span>&lt;ExpensiveResource&gt;(*other.resource_);
        }
    }
    
    ResourceHolder&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> ResourceHolder&amp; other) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> != &amp;other) {
            data_ = other.data_;
            <span class="hljs-keyword">if</span> (other.resource_) {
                resource_ = std::<span class="hljs-built_in">make_unique</span>&lt;ExpensiveResource&gt;(*other.resource_);
            } <span class="hljs-keyword">else</span> {
                resource_.<span class="hljs-built_in">reset</span>();
            }
        }
        <span class="hljs-keyword">return</span> *<span class="hljs-keyword">this</span>;
    }
    
    <span class="hljs-comment">// 封装资源访问</span>
    <span class="hljs-function">ExpensiveResource&amp; <span class="hljs-title">getResource</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">if</span> (!resource_) {
            <span class="hljs-built_in">initializeResource</span>();
        }
        <span class="hljs-keyword">return</span> *resource_;
    }
    
    <span class="hljs-function"><span class="hljs-type">const</span> ExpensiveResource&amp; <span class="hljs-title">getResource</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">if</span> (!resource_) {
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">logic_error</span>(<span class="hljs-string">"资源未初始化"</span>);
        }
        <span class="hljs-keyword">return</span> *resource_;
    }

<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">initializeResource</span><span class="hljs-params">()</span> </span>{
        resource_ = std::<span class="hljs-built_in">make_unique</span>&lt;ExpensiveResource&gt;();
        <span class="hljs-comment">// 复杂的初始化逻辑</span>
    }
};
</code></pre>
<h4 data-id="heading-17"><strong>2. 智能指针与所有权封装</strong></h4>
<p><strong>明确的所有权语义：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DocumentManager</span> {
<span class="hljs-keyword">private</span>:
    std::vector&lt;std::shared_ptr&lt;Document&gt;&gt; documents_;
    std::unique_ptr&lt;Index&gt; searchIndex_;
    std::shared_ptr&lt;Cache&gt; globalCache_;

<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 工厂方法：明确所有权转移</span>
    <span class="hljs-function">std::unique_ptr&lt;Document&gt; <span class="hljs-title">createDocument</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; title)</span> </span>{
        <span class="hljs-keyword">auto</span> doc = std::<span class="hljs-built_in">make_unique</span>&lt;Document&gt;(title);
        <span class="hljs-built_in">setupDocument</span>(*doc);
        <span class="hljs-keyword">return</span> doc;
    }
    
    <span class="hljs-comment">// 共享所有权：明确语义</span>
    <span class="hljs-function">std::shared_ptr&lt;Document&gt; <span class="hljs-title">addSharedDocument</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; title)</span> </span>{
        <span class="hljs-keyword">auto</span> doc = std::<span class="hljs-built_in">make_shared</span>&lt;Document&gt;(title);
        documents_.<span class="hljs-built_in">push_back</span>(doc);
        <span class="hljs-built_in">updateIndex</span>(*doc);
        <span class="hljs-keyword">return</span> doc;
    }
    
    <span class="hljs-comment">// 只读访问：不涉及所有权</span>
    <span class="hljs-type">const</span> std::vector&lt;std::shared_ptr&lt;Document&gt;&gt;&amp; <span class="hljs-built_in">getAllDocuments</span>() <span class="hljs-type">const</span> {
        <span class="hljs-keyword">return</span> documents_;
    }
    
    <span class="hljs-comment">// 封装缓存访问</span>
    <span class="hljs-function">std::shared_ptr&lt;Document&gt; <span class="hljs-title">findCachedDocument</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; id)</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> cached = globalCache_-&gt;<span class="hljs-built_in">get</span>(id)) {
            <span class="hljs-keyword">return</span> cached;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
    }

<span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setupDocument</span><span class="hljs-params">(Document&amp; doc)</span> </span>{
        <span class="hljs-comment">// 私有设置逻辑</span>
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">updateIndex</span><span class="hljs-params">(<span class="hljs-type">const</span> Document&amp; doc)</span> </span>{
        <span class="hljs-comment">// 索引更新逻辑</span>
    }
};
</code></pre>
<hr/>
<h3 data-id="heading-18"><strong>实际工程中的平衡艺术</strong></h3>
<h4 data-id="heading-19"><strong>1. 性能与封装的平衡</strong></h4>
<p><strong>内联访问函数的合理使用：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vector3D</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">double</span> x_, y_, z_;

<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Vector3D</span>(<span class="hljs-type">double</span> x, <span class="hljs-type">double</span> y, <span class="hljs-type">double</span> z) : <span class="hljs-built_in">x_</span>(x), <span class="hljs-built_in">y_</span>(y), <span class="hljs-built_in">z_</span>(z) {}
    
    <span class="hljs-comment">// 内联访问函数 - 零开销抽象</span>
    <span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">x</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>{ <span class="hljs-keyword">return</span> x_; }
    <span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">y</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>{ <span class="hljs-keyword">return</span> y_; } 
    <span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">z</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>{ <span class="hljs-keyword">return</span> z_; }
    
    <span class="hljs-comment">// 可内联的修改函数</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setX</span><span class="hljs-params">(<span class="hljs-type">double</span> x)</span> <span class="hljs-keyword">noexcept</span> </span>{ x_ = x; }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setY</span><span class="hljs-params">(<span class="hljs-type">double</span> y)</span> <span class="hljs-keyword">noexcept</span> </span>{ y_ = y; }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setZ</span><span class="hljs-params">(<span class="hljs-type">double</span> z)</span> <span class="hljs-keyword">noexcept</span> </span>{ z_ = z; }
    
    <span class="hljs-comment">// 复杂操作保持非内联</span>
    <span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">length</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
    <span class="hljs-function">Vector3D <span class="hljs-title">normalized</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
};

<span class="hljs-comment">// 使用示例 - 性能与封装的完美结合</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processVectors</span><span class="hljs-params">(<span class="hljs-type">const</span> std::vector&lt;Vector3D&gt;&amp; vectors)</span> </span>{
    <span class="hljs-type">double</span> totalX = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; vec : vectors) {
        totalX += vec.<span class="hljs-built_in">x</span>();  <span class="hljs-comment">// 内联调用，无性能损失</span>
    }
}
</code></pre>
<h4 data-id="heading-20"><strong>2. 实际测量指导设计</strong></h4>
<p><strong>基于性能数据的决策：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 通过性能测试证明封装的可行性</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProfiledContainer</span> {
<span class="hljs-keyword">private</span>:
    std::vector&lt;<span class="hljs-type">int</span>&gt; data_;
    <span class="hljs-keyword">mutable</span> std::atomic&lt;<span class="hljs-type">size_t</span>&gt; accessCount_{<span class="hljs-number">0</span>};

<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> value)</span> </span>{
        data_.<span class="hljs-built_in">push_back</span>(value);
    }
    
    <span class="hljs-comment">// 封装的访问函数</span>
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-type">size_t</span> index)</span> <span class="hljs-type">const</span> </span>{
        accessCount_.<span class="hljs-built_in">fetch_add</span>(<span class="hljs-number">1</span>, std::memory_order_relaxed);
        <span class="hljs-keyword">return</span> data_.<span class="hljs-built_in">at</span>(index);
    }
    
    <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">getAccessCount</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-keyword">return</span> accessCount_.<span class="hljs-built_in">load</span>(std::memory_order_relaxed);
    }
    
    <span class="hljs-comment">// 性能关键路径的优化接口</span>
    <span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">int</span>* <span class="hljs-title">data</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>{
        <span class="hljs-keyword">return</span> data_.<span class="hljs-built_in">data</span>();
    }
    
    <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>{
        <span class="hljs-keyword">return</span> data_.<span class="hljs-built_in">size</span>();
    }
};

<span class="hljs-comment">// 使用建议：在性能敏感处提供批量访问</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">highPerformanceOperation</span><span class="hljs-params">(<span class="hljs-type">const</span> ProfiledContainer&amp; container)</span> </span>{
    <span class="hljs-type">const</span> <span class="hljs-type">int</span>* rawData = container.<span class="hljs-built_in">data</span>();  <span class="hljs-comment">// 性能关键处</span>
    <span class="hljs-type">size_t</span> size = container.<span class="hljs-built_in">size</span>();
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; size; ++i) {
        <span class="hljs-comment">// 直接访问数据</span>
        <span class="hljs-built_in">processElement</span>(rawData[i]);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-21"><strong>总结：封装的终极价值</strong></h3>
<p><strong>最终设计框架：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 优秀封装的典范</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">WellEncapsulatedClass</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 所有数据成员都是private</span>
    std::string name_;
    std::vector&lt;<span class="hljs-type">double</span>&gt; measurements_;
    <span class="hljs-keyword">mutable</span> std::shared_mutex dataMutex_;
    std::unique_ptr&lt;ImplementationDetail&gt; pImpl_;  <span class="hljs-comment">// Pimpl惯用法</span>
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 稳定的公有接口</span>
    <span class="hljs-built_in">WellEncapsulatedClass</span>(<span class="hljs-type">const</span> std::string&amp; name);
    ~<span class="hljs-built_in">WellEncapsulatedClass</span>() = <span class="hljs-keyword">default</span>;
    
    <span class="hljs-comment">// 禁止拷贝（或提供明确语义）</span>
    <span class="hljs-built_in">WellEncapsulatedClass</span>(<span class="hljs-type">const</span> WellEncapsulatedClass&amp;) = <span class="hljs-keyword">delete</span>;
    WellEncapsulatedClass&amp; <span class="hljs-keyword">operator</span>=(<span class="hljs-type">const</span> WellEncapsulatedClass&amp;) = <span class="hljs-keyword">delete</span>;
    
    <span class="hljs-comment">// 移动语义支持</span>
    <span class="hljs-built_in">WellEncapsulatedClass</span>(WellEncapsulatedClass&amp;&amp;) = <span class="hljs-keyword">default</span>;
    WellEncapsulatedClass&amp; <span class="hljs-keyword">operator</span>=(WellEncapsulatedClass&amp;&amp;) = <span class="hljs-keyword">default</span>;
    
    <span class="hljs-comment">// 行为导向的接口</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">performCalculation</span><span class="hljs-params">(<span class="hljs-type">double</span> parameter)</span></span>;
    <span class="hljs-function">std::future&lt;Result&gt; <span class="hljs-title">performAsyncCalculation</span><span class="hljs-params">(<span class="hljs-type">double</span> parameter)</span></span>;
    
    <span class="hljs-comment">// 受控的属性访问</span>
    <span class="hljs-function"><span class="hljs-type">const</span> std::string&amp; <span class="hljs-title">getName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">noexcept</span> </span>{ <span class="hljs-keyword">return</span> name_; }
    <span class="hljs-function">std::vector&lt;<span class="hljs-type">double</span>&gt; <span class="hljs-title">getMeasurements</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
    
    <span class="hljs-comment">// 计算属性</span>
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">isValid</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
    <span class="hljs-function"><span class="hljs-type">double</span> <span class="hljs-title">getAverage</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
    
    <span class="hljs-comment">// 状态查询</span>
    <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">getMeasurementCount</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
    
<span class="hljs-keyword">protected</span>:
    <span class="hljs-comment">// 为派生类提供的扩展点</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">onCalculationComplete</span><span class="hljs-params">(<span class="hljs-type">const</span> Result&amp; result)</span></span>;
    
<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// 实现细节完全隐藏</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">validateState</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">updateInternalCache</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">logOperation</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; operation)</span> <span class="hljs-type">const</span></span>;
};

<span class="hljs-comment">// 使用示例：客户端代码只依赖稳定接口</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clientCode</span><span class="hljs-params">(WellEncapsulatedClass&amp; obj)</span> </span>{
    obj.<span class="hljs-built_in">performCalculation</span>(<span class="hljs-number">42.0</span>);
    <span class="hljs-keyword">auto</span> avg = obj.<span class="hljs-built_in">getAverage</span>();  <span class="hljs-comment">// 封装的计算属性</span>
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-built_in">isValid</span>()) {
        <span class="hljs-comment">// 使用对象...</span>
    }
}
</code></pre>
<p><strong>最终建议：</strong> 将private成员变量视为类的"实现宪法"——它定义了内部实现的边界和规则。通过严格的封装，我们获得了改变实现的自由、维护不变式的保证和演进设计的弹性。在C++中，将成员变量声明为private不是风格选择，而是专业素养的体现。</p>
<p>记住：<strong>封装的价值不在于今天能做什么，而在于明天能改变什么。</strong> 条款22教会我们的不仅是一种技术实践，更是面向未来软件设计的智慧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[普通人如何免费使用Gemini3-Pro大模型？]]></title>    <link>https://juejin.cn/post/7574105194167910446</link>    <guid>https://juejin.cn/post/7574105194167910446</guid>    <pubDate>2025-11-19T10:26:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574105194167910446" data-draft-id="7574244766423711753" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 普通人如何免费使用Gemini3-Pro大模型？"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-19T10:26:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java中文社群"/> <meta itemprop="url" content="https://juejin.cn/user/61228381386487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             普通人如何免费使用Gemini3-Pro大模型？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/61228381386487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java中文社群
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T10:26:04.000Z" title="Wed Nov 19 2025 10:26:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大模型的用法主要分为以下两类：</p>
<ol>
<li><strong>个人用途</strong>：作为日常知识补充、内容创作及辅助工具。</li>
<li><strong>商业用途</strong>：集成至 Dify、Coze 等工作流与应用程序中，或在编程工具及第三方客户端（如 Cherry Studio）中使用。</li>
</ol>
<p>目前，<strong>普通用户几乎可以免费使用各类主流大模型</strong>，Google 最新推出的 Gemini 3 Pro 也不例外。</p>
<h2 data-id="heading-0">使用方法</h2>
<ol>
<li><strong>访问 AI Studio 官网</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Faistudio.google.com%2F" target="_blank" title="https://aistudio.google.com/" ref="nofollow noopener noreferrer">aistudio.google.com/</a></li>
<li><strong>注册并登录 Google 账号</strong></li>
</ol>
<p>登录后，即可免费通过 Gemini 3 Pro 进行对话，或完成代码生成任务。</p>
<p>此外，Google 还提供了其他免费模型，支持图片生成与编辑、音视频制作，甚至播客生成功能。</p>
<p>例如，生成图片可以使用 Google 的 Imagen，视频生成则可以使用 Veo 等模型。</p>
<h2 data-id="heading-1">视频演示</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV14ByjBqEAS%2F" target="_blank" title="https://www.bilibili.com/video/BV14ByjBqEAS/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV14B…</a></p>
<h2 data-id="heading-2">对话演示</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b148c537f3594584b82237e732d26092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152764&amp;x-signature=FZru96stpdtxBQseniKeKv04bD4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a44c55d622b84b60a3b3d7818eca111e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152764&amp;x-signature=B%2B6U6DQi4PFEzEqhG8uGwzSzkFY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">图片生成</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cc3b912ff4c465d93e05299b00cda4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152764&amp;x-signature=uB3kow8Aexel76EsOLU5ClWjRD0%3D" alt="" loading="lazy"/></p>
<p>视频与音频的生成方式与此类似，此处不再赘述。</p>
<h2 data-id="heading-4">代码生成（App / 网站 / 小游戏开发）</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/982a2c2350ef4fe3b1732c87c80dfd9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152764&amp;x-signature=YRG7ioQYzCywBv3vh26oJ2PsDKY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0908336ba7f140b8ade0c02aa0c18f31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeS4reaWh-ekvue-pA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764152764&amp;x-signature=lsHFJ4iWhiq0KktvLWTHUPU9OEw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">小结</h2>
<p>本文简要介绍了 Google Gemini 3 Pro 的免费使用渠道，及其在文本对话、代码编写及多模态生成方面的核心功能。</p>
<blockquote>
<p>本文已收录到我的技术小站 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.javacn.site" target="_blank" title="https://www.javacn.site" ref="nofollow noopener noreferrer">www.javacn.site</a>，其中包含的内容有：Spring AI、Spring AI Alibaba、LangChain4j、Dify、Coze、N8N、智能体（AI Agent）、MCP、Function Call、RAG、向量数据库、Prompt、多模态、向量数据库、嵌入模型、AI 常见面试问题等内容。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基本数据类型Symbol的基本应用场景]]></title>    <link>https://juejin.cn/post/7574250031248637986</link>    <guid>https://juejin.cn/post/7574250031248637986</guid>    <pubDate>2025-11-19T10:32:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574250031248637986" data-draft-id="7574251313883332623" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基本数据类型Symbol的基本应用场景"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-19T10:32:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基本数据类型Symbol的基本应用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T10:32:42.000Z" title="Wed Nov 19 2025 10:32:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p><code>Symbol</code> 作为 ES6 新增的基本数据类型，核心特性是<strong>唯一性</strong>和<strong>不可枚举性</strong>，在实际项目中主要用于解决命名冲突、保护对象私有属性等场景。以下是具体的应用举例及代码实现：</p>
<h3 data-id="heading-0">一、作为对象的唯一属性名，避免属性冲突</h3>
<p>当多人协作开发或引入第三方库时，普通字符串属性名容易被覆盖，<code>Symbol</code> 可确保属性唯一。</p>
<h4 data-id="heading-1">示例：组件库的私有属性</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义唯一的 Symbol 属性</span>
<span class="hljs-keyword">const</span> internalState = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'internalState'</span>);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Button</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 用 Symbol 作为私有属性名，外部无法直接访问</span>
    <span class="hljs-variable language_">this</span>[internalState] = {
      <span class="hljs-attr">clicked</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">disabled</span>: <span class="hljs-literal">false</span>
    };
  }

  <span class="hljs-title function_">click</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>[internalState].<span class="hljs-property">disabled</span>) {
      <span class="hljs-variable language_">this</span>[internalState].<span class="hljs-property">clicked</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'按钮被点击'</span>);
    }
  }

  <span class="hljs-title function_">disable</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>[internalState].<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
  }
}

<span class="hljs-keyword">const</span> btn = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Button</span>();
btn.<span class="hljs-title function_">click</span>(); <span class="hljs-comment">// 正常执行</span>

<span class="hljs-comment">// 外部无法通过常规方式访问或修改 internalState</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(btn.<span class="hljs-property">internalState</span>); <span class="hljs-comment">// undefined</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(btn[<span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'internalState'</span>)]); <span class="hljs-comment">// undefined（Symbol 是唯一的）</span>
</code></pre>
<h3 data-id="heading-2">二、定义常量，避免魔术字符串</h3>
<p>魔术字符串（直接写在代码中的字符串）易出错且难维护，用 <code>Symbol</code> 定义唯一常量更可靠。</p>
<h4 data-id="heading-3">示例：状态管理中的事件类型</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// event-types.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EVENT_TYPES</span> = {
  <span class="hljs-attr">LOGIN</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'login'</span>),
  <span class="hljs-attr">LOGOUT</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'logout'</span>),
  <span class="hljs-attr">UPDATE_USER</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'updateUser'</span>)
};

<span class="hljs-comment">// 使用常量</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleEvent</span>(<span class="hljs-params">eventType</span>) {
  <span class="hljs-keyword">switch</span> (eventType) {
    <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">EVENT_TYPES</span>.<span class="hljs-property">LOGIN</span>:
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户登录'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">EVENT_TYPES</span>.<span class="hljs-property">LOGOUT</span>:
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户登出'</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-attr">default</span>:
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'未知事件'</span>);
  }
}

<span class="hljs-title function_">handleEvent</span>(<span class="hljs-variable constant_">EVENT_TYPES</span>.<span class="hljs-property">LOGIN</span>); <span class="hljs-comment">// 输出“用户登录”</span>
</code></pre>
<h3 data-id="heading-4">三、实现对象的 “私有属性”</h3>
<p>虽然 JavaScript 没有真正的私有属性，但 <code>Symbol</code> 属性默认不可被 <code>for...in</code>、<code>Object.keys()</code> 枚举，可模拟私有属性。</p>
<h4 data-id="heading-5">示例：类的私有方法 / 属性</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> privateMethod = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'privateMethod'</span>);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; <span class="hljs-comment">// 公共属性</span>
    <span class="hljs-variable language_">this</span>[<span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'id'</span>)] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">slice</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// 私有属性</span>
  }

  [privateMethod]() {
    <span class="hljs-comment">// 私有方法，外部无法调用</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">`用户ID：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>[<span class="hljs-built_in">Symbol</span>(<span class="hljs-string">'id'</span>)]}</span>`</span>;
  }

  <span class="hljs-title function_">getInfo</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 公共方法间接调用私有方法</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> - <span class="hljs-subst">${<span class="hljs-variable language_">this</span>[privateMethod]()}</span>`</span>;
  }
}

<span class="hljs-keyword">const</span> user = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">'Alice'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-title function_">getInfo</span>()); <span class="hljs-comment">// 正常输出</span>

<span class="hljs-comment">// 无法枚举 Symbol 属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(user)); <span class="hljs-comment">// ['name']</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> user) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 仅输出 'name'</span>
}
</code></pre>
<h3 data-id="heading-6">四、自定义迭代器（Iterator）</h3>
<p><code>Symbol.iterator</code> 是内置 Symbol，用于定义对象的迭代器，让对象可被 <code>for...of</code> 遍历。</p>
<h4 data-id="heading-7">示例：自定义可迭代对象</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">const</span> iterableObj = {
  <span class="hljs-keyword">data</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>],
  [Symbol.iterator]() {
    let index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> {
      next: () =&gt; {
        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.length) {
          <span class="hljs-keyword">return</span> { value: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>[index++], done: <span class="hljs-literal">false</span> };
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> { done: <span class="hljs-literal">true</span> };
        }
      }
    };
  }
};

<span class="hljs-comment">// 可通过 for...of 遍历</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item of iterableObj) {
  console.log(item); <span class="hljs-comment">// 输出 a、b、c</span>
}
</code></pre>
<h3 data-id="heading-8">五、Vue 中的应用：自定义组件的 v-model 修饰符</h3>
<p>在 Vue 3 中，可通过 <code>Symbol</code> 定义自定义的 <code>v-model</code> 修饰符，避免与内置修饰符冲突。</p>
<h4 data-id="heading-9">示例：Vue 组件的自定义修饰符</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 定义唯一的修饰符 Symbol</span>
<span class="hljs-keyword">const</span> trimSymbol = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'trim'</span>);

<span class="hljs-comment">// 组件内</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: {
    <span class="hljs-attr">modelValue</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">modelModifiers</span>: {
      <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> ({})
    }
  },
  <span class="hljs-attr">emits</span>: [<span class="hljs-string">'update:modelValue'</span>],
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleInput</span>(<span class="hljs-params">e</span>) {
      <span class="hljs-keyword">let</span> value = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
      <span class="hljs-comment">// 判断是否使用自定义修饰符</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">modelModifiers</span>[trimSymbol]) {
        value = value.<span class="hljs-title function_">trim</span>();
      }
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'update:modelValue'</span>, value);
    }
  }
};
</code></pre>
<h3 data-id="heading-10">总结</h3>
<p><code>Symbol</code> 在项目中的核心应用场景包括：</p>
<ol>
<li><strong>避免属性名冲突</strong>（多人协作 / 第三方库集成）；</li>
<li><strong>模拟私有属性 / 方法</strong>（不可枚举特性）；</li>
<li><strong>定义唯一常量</strong>（替代魔术字符串）；</li>
<li><strong>扩展内置对象行为</strong>（如自定义迭代器）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI省流快讯】Cloudflare 炸了 / Gemini 3 来了 / Antigravity 独家实测 (附：无法登录解法)]]></title>    <link>https://juejin.cn/post/7574269207362224137</link>    <guid>https://juejin.cn/post/7574269207362224137</guid>    <pubDate>2025-11-19T10:30:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574269207362224137" data-draft-id="7574271557938970675" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI省流快讯】Cloudflare 炸了 /  Gemini 3 来了 / Antigravity 独家实测 (附：无法登录解法)"/> <meta itemprop="keywords" content="Gemini,AI编程,Google"/> <meta itemprop="datePublished" content="2025-11-19T10:30:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coder_pig"/> <meta itemprop="url" content="https://juejin.cn/user/4142615541321928"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI省流快讯】Cloudflare 炸了 /  Gemini 3 来了 / Antigravity 独家实测 (附：无法登录解法)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4142615541321928/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coder_pig
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T10:30:58.000Z" title="Wed Nov 19 2025 10:30:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">1. Cloudflare 挂了</h2>
<p>🤡 昨晚陆续刷到 "<strong>CF挂了</strong>" 的消息，没太在意，直到无法打开" <strong>盗版漫画</strong>" 站点，我才意识到问题的严重性：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f748a25110f745e18f7b1384cef114e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=RhfitPTrWxlvE30pX%2BQsSIBqTDA%3D" alt="" loading="lazy"/></p>
<p>🤣 原因众说纷纭，刷到这哥们的 "<strong>梗图</strong>"，差点把我笑岔气：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d79cda89bb24524ab7ea35be3eaa356~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=s64p2kBzFwzuFJ4NryZHtTIlLj0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49acdbcad2224b208e374262b2e89296~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=6rG0YCpJ8IA37T4eYHPq8B0EJfs%3D" alt="" loading="lazy"/></p>
<p>😃 还有人猜测可能是 <strong>Google</strong> 发布的 "<strong>哈基米 3</strong>" (Gemini) 发起的攻击：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6524514e494417fbbedb925046bbed1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=GjhQ9DPUP6Fy3L%2BHrPGeOcA9Pso%3D" alt="" loading="lazy"/></p>
<p><strong>时间线</strong>：</p>
<ul>
<li>【<strong>19:30</strong>】用户开始报告网站无法访问，出现10xx、52x、50x系列错误；Cloudflare Dashboard无法访问；部分Cloudflare域名解析中断。</li>
<li>【<strong>19:48</strong>】Cloudflare正式确认服务异常，启动紧急调查。</li>
<li>【<strong>20:03</strong>】持续调查中，未发现明显进展。</li>
<li>【<strong>20:13</strong>】部分服务开始恢复，但错误率仍高于正常水平。</li>
<li>【<strong>20:21</strong>】监测到部分服务恢复迹象；多次反复出现故障与恢复的波动；20:23、20:55等时间点再次中断。</li>
<li>【<strong>21:04</strong>】技术团队紧急关闭伦敦节点的WARP服务接入以控制影响范围。</li>
<li>【<strong>21:09</strong>】官方确认定位到根本原因，开始实施修复方案。</li>
<li>【<strong>21:13</strong>】Cloudflare Access与WARP服务全面恢复，错误率回落至日常水平。</li>
<li>【<strong>22:12</strong>】X应用恢复。</li>
<li>【<strong>22:22</strong>】Cloudflare状态页更新："我们正在继续努力修复此问题"。</li>
<li>【<strong>22:34</strong>】状态页再次更新："我们已经部署了一项变更，已恢复仪表板服务。我们仍在努力解决对整体应用服务的影响"。</li>
<li>【<strong>22:42</strong>】全局恢复完成，Cloudflare宣布事件解决，后续监控与处理继续进行中。</li>
</ul>
<p><strong>Cloudflare</strong> 发言人 <strong>Jackie Dutton</strong>在官方声明中表示，故障源于一个 <strong>用于管理威胁流量的自动生成配置文件</strong>。该配置文件原本用于防护潜在安全威胁，但由于文件规模异常庞大，导致多项内部系统在处理流量时发生故障：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89ff32267d3a46e380cc98d00e98437d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=buCsRzkkodHdPmWdqRcioN2r0C8%3D" alt="" loading="lazy"/></p>
<p>截止目前，<strong>Cloudflare</strong> 全球网络服务已全面恢复，受影响的X、ChatGPT、Facebook 等主流平台均已恢复正常使用。😀 在网上看到大佬的原因分析，也贴下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/988ad6de08034117af68196690d7c032~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=6zQX0kwjkKef24hkdTEZ9baL640%3D" alt="" loading="lazy"/></p>
<p>😆 难兄难弟啊，前阵子 <strong>亚马逊AWS</strong> 的大规模宕机 (10.20，<strong>美东区域数据库权限和DNS管理系统配置故障</strong>)，故障持续约15小时，直接造成全球互联网大面积混乱。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f313f43c8ffc40d48bbd61aa4552ef34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=tXwqQqB9puuYwH%2B4WWOu9ezVCkQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2. Gemini 3 来了</h2>
<p>😄 千呼万唤的 "<strong>哈基米 3</strong>" (<strong>Gemini</strong>) 终于来了，不过竟然没搞个发布会，只是在 <strong>官方博客</strong> 发下文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.google%2Fproducts%2Fgemini%2Fgemini-3%2F%23note-from-ceo" target="_blank" title="https://blog.google/products/gemini/gemini-3/#note-from-ceo" ref="nofollow noopener noreferrer">《A new era of intelligence with Gemini 3》</a></p>
<p>先简要回顾了一下 Gemini 系列的发展历程：</p>
<ul>
<li><strong>Gemini 1</strong>：着重在 "<strong>原生多模态</strong>" (文本+图像) 和 "<strong>长上下文窗口</strong>"。</li>
<li><strong>Gemini 2</strong>：开始推动 "<strong>智能代理式 (agentic)</strong> " 与 "<strong>推理与思考</strong>" 能力。</li>
</ul>
<p><strong>Gemini 3</strong> 在上述基础上进一步提升，方称其为迄今 "<strong>最智能、最安全</strong>" 的模型：</p>
<ul>
<li><strong>推理能力 &amp; 多模态理解</strong>：在各种 AI 基准测试 (benchmarks) 上表现优异：LMArena (1501 Elo)、GPQA Diamond (91.9%)、MMMU-Pro (81%)、Video-MMMU (87.6%)、SimpleQA Verified (72.1%)。<strong>模型能更好理解背景、意图，给予更有深度、少空话的回答</strong>。</li>
<li><strong>Gemini 3 Deep Think</strong>："<strong>深思</strong>" 增强模式，可进行更深的链式推理、更强代码执行与工具调用，提升复杂问题的求解能力，Humanity's Last Exam (41.0%)、GPQA Diamond (93.8%)、ARC-AGI-2 (带代码执行，45.1%)。该模式将在数周内向 <strong>Google AI Ultra</strong> 订阅用户开放。</li>
</ul>
<hr/>
<p><strong>三大应用场景</strong></p>
<p>① <strong>学习</strong></p>
<ul>
<li>模型支持文本、图像、视频、音频、代码等多模态输入，<strong>100w token</strong> 的上下文窗口。</li>
<li>如：可将手写不同语言的食谱翻译并制作家庭食谱；分析视频运动比赛 (如Picklebal) 帮助你提高训练。</li>
<li>可在 Google 搜索中的 "AI Mode" 借助 Gemini 3 提供生成式 UI、互动工具、仿真体验。</li>
</ul>
<p>② <strong>构建</strong></p>
<ul>
<li>强 "<strong>零样本生成</strong>" 能力：不用给示例、不用教，只说想法，直接生成你想要的东西。能处理复杂 <strong>提示/指令</strong> (提示/指令)，生成更丰富、互动性更强的 <strong>Web UI</strong>。基准测试：WebDev Arena (比谁能更好地完成Web开发任务，1487 Elo，战绩亮眼)、Terminal-Bench 2.0 (54.2%，命令行处理真实开发任务的能力)、SWE-bench Verified (软件工程能力-修bug、补功能，76.2%-非常高，大部分模型在30%-40%)。</li>
<li>可在 Google 的 AI Studio、Vertex AI、Gemini CLI、以及新出的 AI IDE-<strong>Google Antigravity</strong> 中使用。第三方平台也支持，如：Cursor、GitHub、JetBrains、Manus、Replit 等。</li>
</ul>
<p>③ <strong>计划</strong></p>
<ul>
<li>在长期多步骤任务中表现提升，如：Vending-Bench 2 中可 "模拟一年" 运营决策。</li>
<li>新增 <strong>Gemini Agent</strong> 工具，能够代表用户自动完成多步骤复杂任务，如管理邮箱、自动化工作流程和旅行计划，且仍受用户控制。已向 Google AI Ultra 用户开放早期体验。</li>
</ul>
<p>😄 打开 <strong>ai.studio</strong> 直接就能看到最新的模型了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff8e7beb48634a0984bc90a9d431803f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=bQ5lG9ujfbKDlQkAuD0MadilBfo%3D" alt="" loading="lazy"/></p>
<hr/>
<p><strong>谷歌官方</strong> 在演示中展示了三个 <strong>Vibe Coding</strong> 例子：</p>
<ul>
<li><strong>AI 课程平台登录页</strong>：通过简单 Prompt ("新布鲁特主义风格，创意有趣设计，平滑滚动动画，谷歌色彩，深浅主题")，直接生成了一个完整的、具有动画效果和深浅主题切换的登陆页。</li>
<li><strong>SaaS 数据看板</strong>：用户上传 CSV 数据文件和参考设计截图，自动生成了一个具有图表、筛选器、深色主题的专业数据仪表盘。</li>
<li><strong>互动游戏</strong>：通过复杂 Prompt (涉及React、Three.js、3D 效果等技术细节)，生成一个完全可玩的3D游戏。</li>
</ul>
<p>😄 国内 <strong>自媒体</strong> 基本都是在吹它的 "<strong>前端能力</strong>" (看效果图确实挺6的)：</p>
<ul>
<li><strong>能生成精确的 SVG 矢量图</strong>：包括复杂的动画 SVG (如：旋转风扇动画)，而非简单栅格图。</li>
<li><strong>3D 和动画</strong>：支持生成 Three.js 3D 模型、WebGL 着色器、CSS 动画等高级视觉效果。</li>
<li><strong>完成应用框架</strong>：能理解复杂的技术栈要求 (React、Three.js Fiber、TypeScript 等)，生成模块化、结构清晰的代码。</li>
<li><strong>注解修改</strong>：用户可以在生成的界面上用 "<strong>标注</strong>" 的方式指出要修改的地方 (画圈、画箭头、添加文字)，Gemini 3 会理解这些视觉标注并精确修改代码。这得益于它 <strong>多模态理解能力的显著提升</strong> (对屏幕截图的理解准确率达到 72.7%，达到现有水平的两倍)。</li>
<li>去 "<strong>AI味</strong>"：排版、色彩搭配、组件结构看起来是 "<strong>精心设计</strong>" 的，而非生硬地套模版。</li>
</ul>
<p>🤔 目前杰哥还没 <strong>深度体验</strong> 这个新模型，不好评价，只实测下这个新出的 <strong>AI IDE</strong> —— <strong>Antigravity</strong> 吧~</p>
<h2 data-id="heading-2">3. Google Antigravity (反重力)</h2>
<h3 data-id="heading-3">3.1. 下载安装</h3>
<p>下载地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fantigravity.google%2Fdownload" target="_blank" title="https://antigravity.google/download" ref="nofollow noopener noreferrer">下载 Google Antigravity</a></p>
<p>下载完双击安装：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f0dc3095dc44b0ca0cf7881e2dfa495~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=kwoZJSv81rSQxDuzvI%2FF38LtVRA%3D" alt="" loading="lazy"/></p>
<p>接着是不断按 <strong>Next</strong> 的 傻瓜式安装 (是否从VS Code 或 Cursor 导入设置)：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8dc4c77c9e34df99ccbaa8b27c51700~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=1Ssd75koLOp6fKurn%2Fy3JFOVSV0%3D" alt="" loading="lazy"/></p>
<p>选主题：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbfa6864490e410a92e293cfea5e5aa1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=7Ad3Axa37kqze56yGn1UcOSSgRg%3D" alt="" loading="lazy"/></p>
<p>选使用 Agent 的方式 &amp; 编辑器配置 (默认就好)：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c27ef240035948b8b5dd6a919dbc0bda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=n%2Fzd%2FXpuLQNN%2F4EV%2FbFDjzvlFHY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d819d869d2fc4d78a71be79c518cd8bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=UFhdQWhVVn44M4kfjiyRAnDUKhA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e29f64e784e242d98edc6fe2ccf8c01f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=8SYQkCeGPtetJBupezBUMqjcO%2BU%3D" alt="" loading="lazy"/></p>
<p>😐 最后，大部分人会卡在登录这里，杰哥也是折腾了一早上，买了两个号才登上的。</p>
<h3 data-id="heading-4">3.2. 登录问题的解决</h3>
<h4 data-id="heading-5">3.2.1. 代理问题</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8aedbbd65c5f421097cf88fc3cbdc74e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=HCIdOwy7%2BWZ8QFzLJOtHnHggpaI%3D" alt="" loading="lazy"/></p>
<p>如图，先检查 <strong>TUN</strong> (全局/系统代理) 模式有没有开：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a105dc54916a4eaba80112af781f414a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=8buUN4h4aZLviQZdGm7pJDhYabE%3D" alt="" loading="lazy"/></p>
<p>接着看 <strong>代理</strong> 的 "<strong>地区</strong>"，香港是不行滴，群里有人说新加坡/日本可以，杰哥用的 <strong>美国</strong>，其次是 <strong>代理</strong> 的 "<strong>质量</strong>"。</p>
<h4 data-id="heading-6">3.2.2. 账号问题</h4>
<p>代理没问题了，基本是能自动打开浏览器，跳转到授权页，然后授权成功的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7d15c6205f9441ca7c151d1ac13d880~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=z%2FsANOzmUusQfkWxEEB0fQMKmHU%3D" alt="" loading="lazy"/></p>
<p>接着返回 <strong>Antigravity</strong> 可能会出现这两种情况：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a922254431f443999cc54221b18fcd9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=gYQD%2BV%2FBV58yoVV0n%2B0%2FSUxK3Vw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e8c2b4d91b4980a2cdf8c443443e36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=pZqoAo9vtyU3X7ad0RDCMXWDoNk%3D" alt="" loading="lazy"/></p>
<p>这极大概率就是 "<strong>Google账号</strong>" 的问题，先访问下述网址，查看：<strong>账号当前的国家或地区版本</strong>。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpolicies.google.com%2Fterms" target="_blank" title="https://policies.google.com/terms" ref="nofollow noopener noreferrer">《Google 服务条款》</a></p>
<p>比如我的号：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1aea0ee7bad142fe960251670e891fba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=MXjUnJwVP7NG0OvFXRebhgzAgG0%3D" alt="" loading="lazy"/></p>
<p>🤷‍♀️ 香港肯定是不行的，可以访问下述地址申请修改 (<strong>一年只能改一次</strong> ❗️)</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpolicies.google.com%2Fcountry-association-form" target="_blank" title="https://policies.google.com/country-association-form" ref="nofollow noopener noreferrer">《账号关联地区更改请求》</a></p>
<p>具体操作：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa8f276cf54f49758a266c5e50362190~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=Bky2plOergs8HLeir88atWqCRAU%3D" alt="" loading="lazy"/></p>
<p>😐 改完，如果还不行的话，那应该是 "<strong>账号本身有问题</strong>" 或者触发了 Google 莫名其妙的拦截规则。我一开始在海鲜市场买了一个 "<strong>美区</strong>" 的老号，一直卡 Setting Up 那里转。后面又收了个 "<strong>日区</strong>" 的号，<strong>秒进</strong> ❗️❗️❗️</p>
<p>😄 还有个群友提供了一个野路子：</p>
<p>登Google play，在美区买本0刀的免费电子书，就成美区了。</p>
<p>💡 反正进不去，就是 "<strong>代理</strong>" 和 "<strong>账号</strong>" 的问题！我现在的组合是：<strong>日区号</strong> + <strong>美国代理</strong>。都没问题，会进入这个是否允许采集信息的页面，取消勾选，然后 <strong>Next</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46ec84fc6f5d4c4b8d0fe7b6876ccb17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=C5nZ8jS4JigiH0BAZPsGe8alKB4%3D" alt="" loading="lazy"/></p>
<p>接着就能来到 IDE 的主页面了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44095ca4aad04315bec4ce9561c06630~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=CnSEeGObforRnUv1i5MP466ho04%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">3.3. 初体验</h3>
<p>🤣 熟悉的 <strong>VS Code</strong> 套壳界面，还是很有亲切感的，右侧有常规的 <strong>AI Chat</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20ee9dc59df6427e95e9b15dd02a00b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=icRMFpuRxmEjzevAoQe2C6z1CbU%3D" alt="" loading="lazy"/></p>
<p>除了选模型外，还支持选模式：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/734458dbaae9403185b718c9bb5c3d8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=n2DbCetTmD83npgHvEOh8M8N6rs%3D" alt="" loading="lazy"/></p>
<p>按 <strong>Ctrl + E</strong> 可以打开类似于 <strong>Cursor Agents</strong> 模式的 "<strong>Agent Manager</strong>"：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf2165fbcb0942a2b611b44c51bd0527~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=eztvDb0o6T8x5tQCrFTiNaDrVnE%3D" alt="" loading="lazy"/></p>
<p>上面我写了一个，让 <strong>Antigravity</strong> 基于 <strong>Claudeflare</strong> 故障信息生成一个用于发布到 <strong>自媒体平台</strong> 的长图的 简单的<strong>Prompt</strong>，发送后可以看到 <strong>Agent</strong> 开始干活：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/393aa9190306494a97aa300d3998f6cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=L9MvNVyJSPxQEZYUCjnWUDYSuus%3D" alt="" loading="lazy"/></p>
<p>涉及到命令执行，让你 <strong>Accept</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64a13d2ee6cb49288740bf93b7c16b03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=O%2B0Axuewk0RhPprdufgibVcQ0Nc%3D" alt="" loading="lazy"/></p>
<p>觉得烦可以点下右侧切成 <strong>Turbo</strong> 模式：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c861f98ad38e450b91efe5a67ced3a32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=rvmMZV%2BSF2eiBx1h9jVUPytMFfQ%3D" alt="" loading="lazy"/></p>
<p>活干完，要预览，跳转 <strong>Chrome</strong>，提示安装一个 <strong>浏览器插件</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/196ca0fb0165477f9f0453a0fab04956~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=fN%2FnXzqWoXaX6WwkC9CTLwrcCmY%3D" alt="" loading="lazy"/></p>
<p>以便 <strong>Agent</strong> 能直接操作浏览器 (如获取页面节点、自动化、截图等)。最后看下生成效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a32643ee997849a7be4d3c4996e1544e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=V%2BQlgfFsKO5EmxQ1QbhTYAwWvgs%3D" alt="" loading="lazy"/></p>
<p>🤔 同样的 <strong>Prompt</strong>，分别看下 <strong>Claude 4.5</strong> 和 <strong>GPT 5</strong> 的生成效果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b25d3fc7d5ca417fb77f144352b9362f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=OW%2FxxbNu0St16S8CB5BXRs5yL6k%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/809e7c2d40034f6e969a482a9891ec7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=z6Ghp%2BpSHGIYQRXegMr%2BDU6h9Sk%3D" alt="" loading="lazy"/></p>
<p>🤣 哈哈，你更 <strong>Pick</strong> (喜欢) 哪个模型生成的页面呢？</p>
<h3 data-id="heading-8">3.4. 限额</h3>
<p>群里有小伙伴没蹬几次就出现了这个：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7df96168e4874941879e8d340f502648~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=oD6wZoaXXqj5IXH2nJgSwKR8oWU%3D" alt="" loading="lazy"/></p>
<p>看了下官网：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fantigravity.google%2Fdocs%2Fplans" target="_blank" title="https://antigravity.google/docs/plans" ref="nofollow noopener noreferrer">《Google Antigravity Plans》</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/682036ffc70f48bb9f1178dc4fdfb269~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZXJfcGln:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764153058&amp;x-signature=%2FcupRa9MTgvovy1%2FJQ0EXGBqxS8%3D" alt="" loading="lazy"/></p>
<p>💡 <strong>额度</strong> 由Google动态决定 (基于系统容量、防止滥用)，每五小时刷新一次，额度与任务复杂度相关。🐶 官方表示：只有 <strong>极少数高强度用户</strong> 会撞到每5小时上限。</p>
<p>😄 所以这个额度是 "<strong>不透明</strong>" 的，<strong>L站</strong> 有人说不一定得等五个小时，等了十几分钟又可以用了~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第4章：布局类组件 —— 4.8 LayoutBuilder、AfterLayout]]></title>    <link>https://juejin.cn/post/7574245788948709391</link>    <guid>https://juejin.cn/post/7574245788948709391</guid>    <pubDate>2025-11-19T09:03:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245788948709391" data-draft-id="7574245883634810932" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第4章：布局类组件 —— 4.8 LayoutBuilder、AfterLayout"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-19T09:03:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="旧时光_"/> <meta itemprop="url" content="https://juejin.cn/user/4442458669718279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第4章：布局类组件 —— 4.8 LayoutBuilder、AfterLayout
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4442458669718279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    旧时光_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:03:23.000Z" title="Wed Nov 19 2025 09:03:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">4.8 LayoutBuilder、AfterLayout</h2>
<h3 data-id="heading-1">📚 章节概览</h3>
<p>本章节是第4章的最后一节，将学习如何在布局过程中动态构建UI，以及如何获取组件的实际尺寸和位置：</p>
<ul>
<li><strong>LayoutBuilder</strong> - 布局过程中获取约束信息</li>
<li><strong>BoxConstraints</strong> - 约束信息详解</li>
<li><strong>响应式布局</strong> - 根据约束动态构建</li>
<li><strong>AfterLayout</strong> - 布局完成后获取尺寸</li>
<li><strong>RenderAfterLayout</strong> - 自定义RenderObject</li>
<li><strong>localToGlobal</strong> - 坐标转换</li>
<li><strong>Build和Layout</strong> - 交错执行机制</li>
</ul>
<hr/>
<h3 data-id="heading-2">🎯 核心知识点</h3>
<h4 data-id="heading-3">LayoutBuilder vs AfterLayout</h4>






























<table><thead><tr><th>特性</th><th>LayoutBuilder</th><th>AfterLayout</th></tr></thead><tbody><tr><td><strong>执行时机</strong></td><td>布局阶段（Layout）</td><td>布局完成后（Post-Layout）</td></tr><tr><td><strong>获取信息</strong></td><td>约束信息（BoxConstraints）</td><td>实际尺寸和位置</td></tr><tr><td><strong>主要用途</strong></td><td>响应式布局</td><td>尺寸获取</td></tr><tr><td><strong>性能</strong></td><td>较好</td><td>稍差（额外回调）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-4">1️⃣ LayoutBuilder（布局构建器）</h3>
<h4 data-id="heading-5">1.1 什么是LayoutBuilder</h4>
<p><code>LayoutBuilder</code> 可以在<strong>布局过程</strong>中拿到父组件传递的约束信息（<code>BoxConstraints</code>），然后根据约束信息动态地构建不同的布局。</p>
<h4 data-id="heading-6">1.2 构造函数</h4>
<pre><code class="hljs language-dart" lang="dart">LayoutBuilder({
  Key? key,
  <span class="hljs-keyword">required</span> Widget <span class="hljs-built_in">Function</span>(BuildContext, BoxConstraints) builder,
})
</code></pre>
<h4 data-id="heading-7">1.3 基础用法</h4>
<pre><code class="hljs language-dart" lang="dart">LayoutBuilder(
  builder: (BuildContext context, BoxConstraints constraints) {
    <span class="hljs-comment">// 打印约束信息（调试用）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'LayoutBuilder约束: <span class="hljs-subst">$constraints</span>'</span>);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'  maxWidth: <span class="hljs-subst">${constraints.maxWidth}</span>'</span>);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'  maxHeight: <span class="hljs-subst">${constraints.maxHeight}</span>'</span>);
    
    <span class="hljs-comment">// constraints包含父组件传递的约束信息</span>
    <span class="hljs-keyword">if</span> (constraints.maxWidth &gt; <span class="hljs-number">600</span>) {
      <span class="hljs-keyword">return</span> DesktopLayout();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> MobileLayout();
    }
  },
)
</code></pre>
<p><strong>控制台输出示例：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">LayoutBuilder约束:</span> <span class="hljs-string">BoxConstraints(0.0&lt;=w&lt;=392.7,</span> <span class="hljs-number">0.0</span><span class="hljs-string">&lt;=h&lt;=Infinity)</span>
  <span class="hljs-attr">maxWidth:</span> <span class="hljs-number">392.7272644042969</span>
  <span class="hljs-attr">maxHeight:</span> <span class="hljs-string">Infinity</span>
</code></pre>
<h4 data-id="heading-8">1.4 BoxConstraints（约束信息）</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BoxConstraints</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> minWidth;   <span class="hljs-comment">// 最小宽度</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> maxWidth;   <span class="hljs-comment">// 最大宽度</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> minHeight;  <span class="hljs-comment">// 最小高度</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> maxHeight;  <span class="hljs-comment">// 最大高度</span>
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isTight;        <span class="hljs-comment">// 是否为固定约束</span>
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isNormalized;   <span class="hljs-comment">// 是否标准化</span>
  <span class="hljs-comment">// ... 更多方法</span>
}
</code></pre>
<p><strong>常用属性：</strong></p>
<ul>
<li><code>minWidth</code> / <code>maxWidth</code>：宽度范围</li>
<li><code>minHeight</code> / <code>maxHeight</code>：高度范围</li>
<li><code>isTight</code>：是否固定尺寸（min == max）</li>
<li><code>biggest</code>：最大可用尺寸</li>
<li><code>smallest</code>：最小可用尺寸</li>
</ul>
<hr/>
<h3 data-id="heading-9">2️⃣ 响应式布局实战</h3>
<h4 data-id="heading-10">2.1 响应式Column</h4>
<p>根据可用宽度动态切换单列/双列布局：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResponsiveColumn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> ResponsiveColumn({<span class="hljs-keyword">super</span>.key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.children});

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; children;

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> LayoutBuilder(
      builder: (BuildContext context, BoxConstraints constraints) {
        <span class="hljs-keyword">if</span> (constraints.maxWidth &lt; <span class="hljs-number">200</span>) {
          <span class="hljs-comment">// 最大宽度小于200，显示单列</span>
          <span class="hljs-keyword">return</span> Column(
            children: children,
            mainAxisSize: MainAxisSize.min,
          );
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 大于200，显示双列</span>
          <span class="hljs-keyword">var</span> widgets = &lt;Widget&gt;[];
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; children.length; i += <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">if</span> (i + <span class="hljs-number">1</span> &lt; children.length) {
              widgets.add(Row(
                children: [children[i], children[i + <span class="hljs-number">1</span>]],
                mainAxisSize: MainAxisSize.min,
              ));
            } <span class="hljs-keyword">else</span> {
              widgets.add(children[i]);
            }
          }
          <span class="hljs-keyword">return</span> Column(
            children: widgets,
            mainAxisSize: MainAxisSize.min,
          );
        }
      },
    );
  }
}
</code></pre>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-dart" lang="dart">ResponsiveColumn(
  children: [
    Text(<span class="hljs-string">'Item 1'</span>),
    Text(<span class="hljs-string">'Item 2'</span>),
    Text(<span class="hljs-string">'Item 3'</span>),
    Text(<span class="hljs-string">'Item 4'</span>),
  ],
)
</code></pre>
<h4 data-id="heading-11">2.2 响应式断点</h4>
<p>常见的响应式断点：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">enum</span> DeviceType { mobile, tablet, desktop }

DeviceType getDeviceType(<span class="hljs-built_in">double</span> width) {
  <span class="hljs-keyword">if</span> (width &lt; <span class="hljs-number">600</span>) {
    <span class="hljs-keyword">return</span> DeviceType.mobile;    <span class="hljs-comment">// 手机</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (width &lt; <span class="hljs-number">1200</span>) {
    <span class="hljs-keyword">return</span> DeviceType.tablet;    <span class="hljs-comment">// 平板</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> DeviceType.desktop;   <span class="hljs-comment">// 桌面</span>
  }
}

<span class="hljs-comment">// 使用</span>
LayoutBuilder(
  builder: (context, constraints) {
    <span class="hljs-keyword">final</span> deviceType = getDeviceType(constraints.maxWidth);
    
    <span class="hljs-keyword">switch</span> (deviceType) {
      <span class="hljs-keyword">case</span> DeviceType.mobile:
        <span class="hljs-keyword">return</span> MobileLayout();
      <span class="hljs-keyword">case</span> DeviceType.tablet:
        <span class="hljs-keyword">return</span> TabletLayout();
      <span class="hljs-keyword">case</span> DeviceType.desktop:
        <span class="hljs-keyword">return</span> DesktopLayout();
    }
  },
)
</code></pre>
<h4 data-id="heading-12">2.3 自适应网格</h4>
<p>根据宽度自动调整列数：</p>
<pre><code class="hljs language-dart" lang="dart">LayoutBuilder(
  builder: (context, constraints) {
    <span class="hljs-comment">// 计算列数</span>
    <span class="hljs-keyword">final</span> cardWidth = <span class="hljs-number">120.0</span>;
    <span class="hljs-keyword">final</span> spacing = <span class="hljs-number">8.0</span>;
    <span class="hljs-keyword">final</span> columns = (constraints.maxWidth / (cardWidth + spacing))
        .floor()
        .clamp(<span class="hljs-number">1</span>, <span class="hljs-number">6</span>);  <span class="hljs-comment">// 最少1列，最多6列</span>
    
    <span class="hljs-keyword">return</span> GridView.builder(
      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
        crossAxisCount: columns,
        crossAxisSpacing: spacing,
        mainAxisSpacing: spacing,
      ),
      itemBuilder: (context, index) =&gt; Card(...),
    );
  },
)
</code></pre>
<hr/>
<h3 data-id="heading-13">3️⃣ AfterLayout（布局后回调）</h3>
<h4 data-id="heading-14">3.1 什么是AfterLayout</h4>
<p><code>AfterLayout</code> 是一个自定义组件，用于在布局完成后获取组件的实际尺寸和位置信息。</p>
<h4 data-id="heading-15">3.2 实现原理</h4>
<p>通过自定义 <code>RenderObject</code>，在 <code>performLayout</code> 方法中添加回调：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AfterLayout</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SingleChildRenderObjectWidget</span> </span>{
  <span class="hljs-keyword">const</span> AfterLayout({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.callback,
    <span class="hljs-keyword">super</span>.child,
  });

  <span class="hljs-keyword">final</span> ValueChanged&lt;RenderAfterLayout&gt; callback;

  <span class="hljs-meta">@override</span>
  RenderAfterLayout createRenderObject(BuildContext context) {
    <span class="hljs-keyword">return</span> RenderAfterLayout(callback: callback);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> updateRenderObject(
    BuildContext context,
    RenderAfterLayout renderObject,
  ) {
    renderObject.callback = callback;
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RenderAfterLayout</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RenderProxyBox</span> </span>{
  RenderAfterLayout({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.callback});

  ValueChanged&lt;RenderAfterLayout&gt; callback;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> performLayout() {
    <span class="hljs-keyword">super</span>.performLayout();
    <span class="hljs-comment">// 布局完成后触发回调</span>
    WidgetsBinding.instance.addPostFrameCallback((_) {
      callback(<span class="hljs-keyword">this</span>);
    });
  }

  <span class="hljs-comment">/// <span class="markdown">获取组件在屏幕中的偏移坐标</span></span>
  Offset <span class="hljs-keyword">get</span> offset =&gt; localToGlobal(Offset.zero);
}
</code></pre>
<h4 data-id="heading-16">3.3 基础用法</h4>
<pre><code class="hljs language-dart" lang="dart">AfterLayout(
  callback: (RenderAfterLayout ral) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'AfterLayout回调:'</span>);
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'  尺寸: <span class="hljs-subst">${ral.size}</span>'</span>);        <span class="hljs-comment">// Size(105.0, 17.0)</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'  位置: <span class="hljs-subst">${ral.offset}</span>'</span>);      <span class="hljs-comment">// Offset(42.5, 290.0)</span>
  },
  child: Text(<span class="hljs-string">'flutter@wendux'</span>),
)
</code></pre>
<p><strong>控制台输出：</strong></p>
<pre><code class="hljs language-css" lang="css">AfterLayout回调:
  尺寸: <span class="hljs-built_in">Size</span>(<span class="hljs-number">105.0</span>, <span class="hljs-number">17.0</span>)
  位置: <span class="hljs-built_in">Offset</span>(<span class="hljs-number">42.5</span>, <span class="hljs-number">290.0</span>)
</code></pre>
<h4 data-id="heading-17">3.4 获取相对坐标</h4>
<p>使用 <code>localToGlobal</code> 方法获取相对于某个父组件的坐标：</p>
<pre><code class="hljs language-dart" lang="dart">Builder(builder: (context) {
  <span class="hljs-keyword">return</span> Container(
    color: Colors.grey.shade200,
    width: <span class="hljs-number">100</span>,
    height: <span class="hljs-number">100</span>,
    child: AfterLayout(
      callback: (RenderAfterLayout ral) {
        <span class="hljs-comment">// 获取相对于Container的坐标</span>
        Offset offset = ral.localToGlobal(
          Offset.zero,
          ancestor: context.findRenderObject(),
        );
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'占用空间范围: <span class="hljs-subst">${offset &amp; ral.size}</span>'</span>);
      },
      child: Text(<span class="hljs-string">'A'</span>),
    ),
  );
})
</code></pre>
<hr/>
<h3 data-id="heading-18">4️⃣ RenderAfterLayout详解</h3>
<h4 data-id="heading-19">4.1 继承关系</h4>
<pre><code class="hljs language-markdown" lang="markdown">RenderObject
<span class="hljs-code">    ↓
RenderBox
    ↓
RenderProxyBox
    ↓
RenderAfterLayout
</span></code></pre>
<h4 data-id="heading-20">4.2 主要方法</h4>



































<table><thead><tr><th>方法/属性</th><th>说明</th><th>返回值</th></tr></thead><tbody><tr><td><code>size</code></td><td>组件尺寸</td><td><code>Size</code></td></tr><tr><td><code>offset</code></td><td>屏幕坐标</td><td><code>Offset</code></td></tr><tr><td><code>localToGlobal(Offset)</code></td><td>转换为全局坐标</td><td><code>Offset</code></td></tr><tr><td><code>localToGlobal(..., ancestor)</code></td><td>转换为相对坐标</td><td><code>Offset</code></td></tr><tr><td><code>paintBounds</code></td><td>绘制边界</td><td><code>Rect</code></td></tr></tbody></table>
<h4 data-id="heading-21">4.3 坐标转换</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 转换为屏幕坐标</span>
Offset screenOffset = ral.localToGlobal(Offset.zero);

<span class="hljs-comment">// 转换为相对于ancestor的坐标</span>
Offset relativeOffset = ral.localToGlobal(
  Offset.zero,
  ancestor: ancestorRenderObject,
);

<span class="hljs-comment">// 计算占用空间</span>
Rect bounds = offset &amp; size;  <span class="hljs-comment">// Rect.fromLTWH(x, y, width, height)</span>
</code></pre>
<hr/>
<h3 data-id="heading-22">5️⃣ Build和Layout的交错执行</h3>
<h4 data-id="heading-23">5.1 执行流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[开始Build] --&gt; B[遇到LayoutBuilder]
    B --&gt; C[进入Layout阶段]
    C --&gt; D[执行LayoutBuilder.builder]
    D --&gt; E[返回新Widget]
    E --&gt; F[继续Build新Widget]
    F --&gt; G[完成]
    
    style A fill:#e1f5ff
    style C fill:#ffe1e1
    style F fill:#e1f5ff
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>Build 和 Layout <strong>不是</strong>严格按顺序执行的</li>
<li>LayoutBuilder 的 builder 在 <strong>Layout 阶段</strong>执行</li>
<li>builder 中可以返回新 Widget，触发新的 Build</li>
</ul>
<h4 data-id="heading-24">5.2 执行顺序示例</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">print</span>(<span class="hljs-string">'1. 开始Build'</span>);

LayoutBuilder(
  builder: (context, constraints) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'3. 执行LayoutBuilder.builder（Layout阶段）'</span>);
    <span class="hljs-keyword">return</span> Column(
      children: [
        Text(<span class="hljs-string">'Hello'</span>),  <span class="hljs-comment">// 4. 触发新的Build</span>
      ],
    );
  },
)

<span class="hljs-built_in">print</span>(<span class="hljs-string">'2. LayoutBuilder创建完成'</span>);
</code></pre>
<p><strong>输出顺序：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 开始Build
<span class="hljs-bullet">2.</span> LayoutBuilder创建完成
<span class="hljs-bullet">3.</span> 执行LayoutBuilder.builder（Layout阶段）
<span class="hljs-bullet">4.</span> Build Text Widget
</code></pre>
<hr/>
<h3 data-id="heading-25">🤔 常见问题（FAQ）</h3>
<h4 data-id="heading-26">Q1: LayoutBuilder和MediaQuery的区别？</h4>
<p><strong>A:</strong></p>






























<table><thead><tr><th>特性</th><th>LayoutBuilder</th><th>MediaQuery</th></tr></thead><tbody><tr><td><strong>获取信息</strong></td><td>父组件约束</td><td>屏幕尺寸</td></tr><tr><td><strong>作用范围</strong></td><td>当前组件</td><td>全局</td></tr><tr><td><strong>响应变化</strong></td><td>父约束变化</td><td>屏幕尺寸变化</td></tr><tr><td><strong>使用场景</strong></td><td>组件级响应式</td><td>全局响应式</td></tr></tbody></table>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// LayoutBuilder - 父组件约束</span>
LayoutBuilder(
  builder: (context, constraints) {
    <span class="hljs-comment">// constraints来自父组件</span>
    <span class="hljs-keyword">return</span> Text(<span class="hljs-string">'宽度: <span class="hljs-subst">${constraints.maxWidth}</span>'</span>);
  },
)

<span class="hljs-comment">// MediaQuery - 屏幕尺寸</span>
<span class="hljs-keyword">final</span> screenWidth = MediaQuery.of(context).size.width;
</code></pre>
<h4 data-id="heading-27">Q2: 如何在StatefulWidget中使用AfterLayout？</h4>
<p><strong>A:</strong> 使用 <code>addPostFrameCallback</code> 避免在 build 中调用 setState</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  State&lt;MyWidget&gt; createState() =&gt; _MyWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">MyWidget</span>&gt; </span>{
  Size _size = Size.zero;

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> AfterLayout(
      callback: (RenderAfterLayout ral) {
        <span class="hljs-comment">// ✅ 正确：使用 addPostFrameCallback</span>
        WidgetsBinding.instance.addPostFrameCallback((_) {
          <span class="hljs-keyword">if</span> (mounted) {
            setState(() {
              _size = ral.size;
            });
          }
        });
      },
      child: Text(<span class="hljs-string">'Hello'</span>),
    );
  }
}
</code></pre>
<h4 data-id="heading-28">Q3: LayoutBuilder的builder何时执行？</h4>
<p><strong>A:</strong> 在以下情况会执行：</p>
<ol>
<li><strong>首次布局</strong>：组件首次被添加到树中</li>
<li><strong>约束变化</strong>：父组件传递的约束发生变化</li>
<li><strong>重新布局</strong>：调用 <code>markNeedsLayout()</code></li>
</ol>
<pre><code class="hljs language-dart" lang="dart">LayoutBuilder(
  builder: (context, constraints) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'Builder执行，约束: <span class="hljs-subst">$constraints</span>'</span>);
    <span class="hljs-keyword">return</span> Container();
  },
)
</code></pre>
<h4 data-id="heading-29">Q4: 如何优化LayoutBuilder性能？</h4>
<p><strong>A:</strong></p>
<ol>
<li><strong>避免过度嵌套</strong></li>
<li><strong>缓存计算结果</strong></li>
<li><strong>使用const构造函数</strong></li>
</ol>
<pre><code class="hljs language-dart" lang="dart">LayoutBuilder(
  builder: (context, constraints) {
    <span class="hljs-comment">// ❌ 每次都创建新Widget</span>
    <span class="hljs-keyword">return</span> Column(
      children: [
        Text(<span class="hljs-string">'Item 1'</span>),
        Text(<span class="hljs-string">'Item 2'</span>),
      ],
    );
    
    <span class="hljs-comment">// ✅ 使用const</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Column(
      children: [
        Text(<span class="hljs-string">'Item 1'</span>),
        Text(<span class="hljs-string">'Item 2'</span>),
      ],
    );
  },
)
</code></pre>
<h4 data-id="heading-30">Q5: AfterLayout会影响性能吗？</h4>
<p><strong>A:</strong> 会有轻微影响，因为：</p>
<ol>
<li>额外的回调开销</li>
<li>可能触发额外的 setState</li>
<li>每次布局都会执行回调</li>
</ol>
<p><strong>优化建议：</strong></p>
<ul>
<li>只在必要时使用</li>
<li>避免在回调中进行重量级操作</li>
<li>使用防抖/节流</li>
</ul>
<hr/>
<h3 data-id="heading-31">🎯 跟着做练习</h3>
<h4 data-id="heading-32">练习1：实现一个响应式导航栏</h4>
<p><strong>目标：</strong> 宽度&gt;600显示完整标签，否则显示图标</p>
<p><strong>步骤：</strong></p>
<ol>
<li>使用 LayoutBuilder</li>
<li>判断 constraints.maxWidth</li>
<li>返回不同的UI</li>
</ol>
<details>
<summary>💡 查看答案</summary>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResponsiveNavigationBar</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> ResponsiveNavigationBar({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> LayoutBuilder(
      builder: (context, constraints) {
        <span class="hljs-keyword">final</span> showLabels = constraints.maxWidth &gt; <span class="hljs-number">600</span>;
        
        <span class="hljs-keyword">return</span> Container(
          height: <span class="hljs-number">60</span>,
          color: Colors.blue,
          child: Row(
            mainAxisAlignment: MainAxisAlignment.spaceAround,
            children: [
              _buildNavItem(
                icon: Icons.home,
                label: <span class="hljs-string">'首页'</span>,
                showLabel: showLabels,
              ),
              _buildNavItem(
                icon: Icons.search,
                label: <span class="hljs-string">'搜索'</span>,
                showLabel: showLabels,
              ),
              _buildNavItem(
                icon: Icons.person,
                label: <span class="hljs-string">'我的'</span>,
                showLabel: showLabels,
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildNavItem({
    <span class="hljs-keyword">required</span> IconData icon,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> label,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">bool</span> showLabel,
  }) {
    <span class="hljs-keyword">return</span> Column(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        Icon(icon, color: Colors.white),
        <span class="hljs-keyword">if</span> (showLabel) ...[
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">4</span>),
          Text(
            label,
            style: <span class="hljs-keyword">const</span> TextStyle(color: Colors.white, fontSize: <span class="hljs-number">12</span>),
          ),
        ],
      ],
    );
  }
}
</code></pre>
</details>
<hr/>
<h4 data-id="heading-33">练习2：实现文本溢出检测</h4>
<p><strong>目标：</strong> 检测Text是否溢出，显示"展开"按钮</p>
<p><strong>步骤：</strong></p>
<ol>
<li>使用 AfterLayout 获取Text尺寸</li>
<li>计算是否溢出</li>
<li>显示/隐藏展开按钮</li>
</ol>
<details>
<summary>💡 查看答案</summary>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExpandableText</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> ExpandableText({<span class="hljs-keyword">super</span>.key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.text});

  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> text;

  <span class="hljs-meta">@override</span>
  State&lt;ExpandableText&gt; createState() =&gt; _ExpandableTextState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_ExpandableTextState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">ExpandableText</span>&gt; </span>{
  <span class="hljs-built_in">bool</span> _expanded = <span class="hljs-keyword">false</span>;
  <span class="hljs-built_in">bool</span> _isOverflow = <span class="hljs-keyword">false</span>;

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        AfterLayout(
          callback: (RenderAfterLayout ral) {
            <span class="hljs-comment">// 检查是否溢出</span>
            <span class="hljs-keyword">final</span> textPainter = TextPainter(
              text: TextSpan(text: widget.text),
              maxLines: _expanded ? <span class="hljs-keyword">null</span> : <span class="hljs-number">3</span>,
              textDirection: TextDirection.ltr,
            )..layout(maxWidth: ral.size.width);

            WidgetsBinding.instance.addPostFrameCallback((_) {
              <span class="hljs-keyword">if</span> (mounted) {
                setState(() {
                  _isOverflow = textPainter.didExceedMaxLines;
                });
              }
            });
          },
          child: Text(
            widget.text,
            maxLines: _expanded ? <span class="hljs-keyword">null</span> : <span class="hljs-number">3</span>,
            overflow: TextOverflow.ellipsis,
          ),
        ),
        <span class="hljs-keyword">if</span> (_isOverflow)
          TextButton(
            onPressed: () {
              setState(() {
                _expanded = !_expanded;
              });
            },
            child: Text(_expanded ? <span class="hljs-string">'收起'</span> : <span class="hljs-string">'展开'</span>),
          ),
      ],
    );
  }
}
</code></pre>
</details>
<hr/>
<h3 data-id="heading-34">📋 小结</h3>
<h4 data-id="heading-35">核心概念</h4>

























<table><thead><tr><th>组件</th><th>用途</th><th>执行时机</th></tr></thead><tbody><tr><td><strong>LayoutBuilder</strong></td><td>获取约束，响应式布局</td><td>Layout阶段</td></tr><tr><td><strong>AfterLayout</strong></td><td>获取尺寸和位置</td><td>Layout完成后</td></tr><tr><td><strong>BoxConstraints</strong></td><td>约束信息</td><td>Layout阶段传递</td></tr></tbody></table>
<h4 data-id="heading-36">LayoutBuilder使用场景</h4>

























<table><thead><tr><th>场景</th><th>示例</th></tr></thead><tbody><tr><td><strong>响应式布局</strong></td><td>根据宽度显示不同UI</td></tr><tr><td><strong>自适应网格</strong></td><td>动态调整列数</td></tr><tr><td><strong>断点设计</strong></td><td>手机/平板/桌面切换</td></tr><tr><td><strong>动态组件</strong></td><td>根据空间大小选择组件</td></tr></tbody></table>
<h4 data-id="heading-37">AfterLayout使用场景</h4>

























<table><thead><tr><th>场景</th><th>示例</th></tr></thead><tbody><tr><td><strong>尺寸获取</strong></td><td>获取组件实际大小</td></tr><tr><td><strong>位置计算</strong></td><td>计算组件坐标</td></tr><tr><td><strong>溢出检测</strong></td><td>判断Text是否溢出</td></tr><tr><td><strong>动画准备</strong></td><td>获取起始位置</td></tr></tbody></table>
<h4 data-id="heading-38">记忆技巧</h4>
<ol>
<li><strong>LayoutBuilder</strong>：Layout阶段<strong>构建</strong>UI</li>
<li><strong>AfterLayout</strong>：Layout<strong>之后</strong>获取信息</li>
<li><strong>Build和Layout</strong>：可以<strong>交错执行</strong></li>
<li><strong>BoxConstraints</strong>：约束向<strong>下</strong>传递</li>
<li><strong>RenderObject</strong>：渲染树的<strong>节点</strong></li>
</ol>
<hr/>
<h3 data-id="heading-39">🔗 相关资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.flutter.dev%2Fflutter%2Fwidgets%2FLayoutBuilder-class.html" target="_blank" title="https://api.flutter.dev/flutter/widgets/LayoutBuilder-class.html" ref="nofollow noopener noreferrer">LayoutBuilder 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.flutter.dev%2Fflutter%2Frendering%2FBoxConstraints-class.html" target="_blank" title="https://api.flutter.dev/flutter/rendering/BoxConstraints-class.html" ref="nofollow noopener noreferrer">BoxConstraints 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.flutter.dev%2Fflutter%2Frendering%2FRenderBox-class.html" target="_blank" title="https://api.flutter.dev/flutter/rendering/RenderBox-class.html" ref="nofollow noopener noreferrer">RenderBox 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.flutter.dev%2Fflutter%2Frendering%2FRenderObject-class.html" target="_blank" title="https://api.flutter.dev/flutter/rendering/RenderObject-class.html" ref="nofollow noopener noreferrer">RenderObject 官方文档</a></li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Canvas学习笔记（一）]]></title>    <link>https://juejin.cn/post/7573738017988640811</link>    <guid>https://juejin.cn/post/7573738017988640811</guid>    <pubDate>2025-11-18T09:49:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573738017988640811" data-draft-id="7573855399716470803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Canvas学习笔记（一）"/> <meta itemprop="keywords" content="前端,JavaScript,Canvas"/> <meta itemprop="datePublished" content="2025-11-18T09:49:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不是鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1704656590610676"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Canvas学习笔记（一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1704656590610676/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不是鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T09:49:33.000Z" title="Tue Nov 18 2025 09:49:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是 Canvas</h2>
<p>Canvas 是 HTML5 中新增的一种标签，表示一个画布，只是图形容器，绘制功能必须使用js来实现。</p>
<pre><code class="hljs language-js" lang="js">&lt;!doctype html&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>基础的HTML5页面<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"canvas"</span>&gt;</span>
            这里是canvas标签，当你的浏览器不支持canvas时，会显示这行文字
	<span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span> 

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</span></code></pre>
<p>打开后会是一个完全空白的画面，因为canvas本意就是一块画布，画布在html5中是透明的，不可见的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/646cf23d6a26415c90537a193f6ecaac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065164&amp;x-signature=bBQX5CtrgnfJvTCvVL5dEqMEMbc%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">绘制前的准备</h2>
<h3 data-id="heading-2">获取 Canvas 对象：</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'canvas'</span>);
</code></pre>
<h3 data-id="heading-3">获取画笔</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> context = canvas.<span class="hljs-title function_">getContext</span>(contextType, contextAttributes?);
<span class="hljs-keyword">const</span> context = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
<span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>, {
  <span class="hljs-attr">alpha</span>: <span class="hljs-literal">true</span>,          <span class="hljs-comment">// 启用透明通道（默认就是true）</span>
});
</code></pre>
<p><code>getContext</code>方法用于获取 Canvas 元素的绘图上下文，来对 Canvas 元素进行绘制操作，通常是 2D 类型，用于二维绘图。第一个参数是必须传的，第二个参数代表配置上下文的行为，不同的上下文的配置属性不同。</p>
<ul>
<li><code>2d</code></li>
</ul>






























<table><thead><tr><th>属性</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>alpha</code></td><td>是否包含alpha通道（透明度）</td><td><code>true</code></td></tr><tr><td><code>colorSpace</code></td><td>指定渲染上下文的色彩空间（<code>srgb</code>或<code>display-p3</code>）</td><td><code>srgb</code></td></tr><tr><td><code>desynchronized</code></td><td>是否将画布绘制周期与事件循环解耦以减少延迟</td><td><code>false</code></td></tr><tr><td><code>willReadFrequently</code></td><td>是否频繁读取像素（用于优化<code>getImageData()</code>性能）</td><td><code>false</code></td></tr></tbody></table>
<ul>
<li><code>webgl</code></li>
</ul>


















































<table><thead><tr><th>属性</th><th>作用</th><th>说明</th></tr></thead><tbody><tr><td><code>alpha</code></td><td>是否包含alpha通道</td><td>和2D一样</td></tr><tr><td><code>antialias</code></td><td>是否开启抗锯齿</td><td>让图形边缘更平滑</td></tr><tr><td><code>depth</code></td><td>是否包含深度缓冲区</td><td>用于3D场景的深度检测</td></tr><tr><td><code>failIfMajorPerformanceCaveat</code></td><td>性能低时是否创建上下文</td><td><code>true</code>：性能差时失败</td></tr><tr><td><code>powerPreference</code></td><td>GPU电源偏好</td><td><code>default</code>/<code>high-performance</code>/<code>low-power</code></td></tr><tr><td><code>premultipliedAlpha</code></td><td>是否预混合alpha</td><td>用于图像合成</td></tr><tr><td><code>preserveDrawingBuffer</code></td><td>是否保存缓冲区</td><td><code>true</code>：可以多次读取</td></tr><tr><td><code>stencil</code></td><td>是否包含模版缓冲区</td><td>用于复杂遮罩效果</td></tr></tbody></table>
<p>小结一下：准备工作就分为三步：</p>
<ol>
<li><strong>布置画布：通过添加</strong><code> &lt;canvas&gt; </code><strong>标签，添加canvas元素</strong></li>
<li><strong>获取画布：通过</strong><code> &lt;canvas&gt; </code><strong>标签的id，获得canvas对象</strong></li>
<li><strong>获得画笔：通过canvas对象的</strong><code>getContext("2d") </code><strong>方法，获得2D环境</strong></li>
</ol>
<hr/>
<h3 data-id="heading-4"><strong>绘制线段：</strong></h3>
<p>在Canvas中，<strong>是基于状态的绘制</strong>，所以前面几步都是在确定状态，直到最后一步才会具体绘制。</p>
<p>绘画步骤和现实中画画差不多，可以分为四步：</p>
<h4 data-id="heading-5">1.  首先移动画笔至绘画的起始位置</h4>
<pre><code class="hljs language-js" lang="js">context.<span class="hljs-title function_">moveTo</span>(x, y)
<span class="hljs-comment">// 将笔画移至 x, y 这个位置，canvas中是以画布的左上角为坐标原点，x轴的正方向向右，y轴的正方向向下</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eddbf10a40c648e79bca69ee62fc8c79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065164&amp;x-signature=GbwlNqPfmeiHAeKN9sykgeSq9Uw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">2.  确定第一笔的停止点</h4>
<pre><code class="hljs language-js" lang="js">context.<span class="hljs-title function_">lineTo</span>(x, y)
<span class="hljs-comment">// 从上一个笔的停止点，移动至x，y这里</span>
</code></pre>
<h4 data-id="heading-7">3.  规划好路线后，选择画笔（粗细，颜色，线条等）</h4>
<p>因为 Canvas 是基于状态的，所以我们在选择画笔粗细和颜色的同时，其实也是选择了线条的粗细和颜色。</p>









































<table><thead><tr><th>属性</th><th>说明</th><th>默认值</th><th>示例</th></tr></thead><tbody><tr><td><code>context.lineWidth</code></td><td><strong>线条粗细（宽度）</strong> ，单位是像素</td><td><code>1.0</code></td><td><code>ctx.lineWidth = 5;</code></td></tr><tr><td><code>context.strokeStyle</code></td><td><strong>描边颜色/样式</strong>（可为颜色、渐变、图案）</td><td><code>#000000</code>（黑色）</td><td><code>ctx.strokeStyle = "#AA394C";``ctx.strokeStyle = "red";``ctx.strokeStyle = gradient;</code></td></tr><tr><td><code>context.lineCap</code></td><td><strong>线段末端样式</strong></td><td><code>"butt"</code></td><td><code>"butt"</code>（平头） <code>"round"</code>（圆头） <code>"square"</code>（方头）</td></tr><tr><td><code>context.lineJoin</code></td><td><strong>两条线相交处的连接样式</strong></td><td><code>"miter"</code></td><td><code>"miter"</code>（尖角） <code>"round"</code>（圆角） <code>"bevel"</code>（斜角）</td></tr><tr><td><code>context.miterLimit</code></td><td><strong>尖角（miter）的最大长度限制</strong>（防止过长尖角）</td><td><code>10</code></td><td><code>ctx.miterLimit = 5;</code></td></tr></tbody></table>
<h4 data-id="heading-8">4. 进行绘制</h4>
<p>确定绘制有两种方法：</p>
<pre><code class="hljs language-js" lang="js">context.<span class="hljs-title function_">fill</span>() <span class="hljs-comment">// 填充</span>
context.<span class="hljs-title function_">stroke</span>() <span class="hljs-comment">// 描边</span>
</code></pre>
<h4 data-id="heading-9">5. 画一个线条！</h4>
<pre><code class="hljs language-js" lang="js">&lt;body&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"myCanvas"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"border: 1px solid black;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myCanvas'</span>);
        <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
        
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);

        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">10</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'red'</span>;

        ctx.<span class="hljs-title function_">stroke</span>();
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
&lt;/body&gt;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4110ef73c4114e18963318062516e274~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065164&amp;x-signature=oVnChnunxSkhxZQ4UVGs7pJ4ARk%3D" alt="image.png" loading="lazy"/></p>
<p>一条红色的线条就画好了。但是我们现在只给 Canvas 设置了边框，那它的宽高是从哪来的呢？</p>
<p>这是浏览器默认给 Canvas 分配的尺寸 300x150 像素的画布。如果我们要自己设置 Canvas 宽高的话有两种方法</p>
<ol>
<li>通过标签内部设置</li>
</ol>
<pre><code class="hljs language-js" lang="js"> &lt;canvas id=<span class="hljs-string">"myCanvas"</span> style=<span class="hljs-string">"border: 1px solid black;"</span> width = <span class="hljs-string">"500"</span> height = <span class="hljs-string">"500"</span>&gt;&lt;/canvas&gt;
</code></pre>
<ol start="2">
<li>通过 JS 设置</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myCanvas'</span>);

canvas.<span class="hljs-property">width</span> = <span class="hljs-number">500</span>;
canvas.<span class="hljs-property">height</span> = <span class="hljs-number">500</span>;
</code></pre>
<p>这两种方式设置的宽高是等效的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d52a13df55f64a10a2d554ccc2758a14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065164&amp;x-signature=JM%2FpMM2SsY%2BoELXFErqSPpIxZWE%3D" alt="image.png" loading="lazy"/>
<strong>这里有一个特别需要注意的点：我们设置的是画布的物理宽高，也就是 Canvas 元素的真实宽高，并不是通过 Css 设置的样式宽高，如果我们通过 Css 设置了 Canvas 的宽高，效果其实是在物理宽高的基础上进行了等比的缩小或者拉伸</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;canvas id=<span class="hljs-string">"myCanvas"</span> 
    style=<span class="hljs-string">"border: 1px solid black; width: 100px; height: 100px;"</span> width=<span class="hljs-string">"500"</span> height=<span class="hljs-string">"500"</span>&gt;
&lt;/canvas&gt;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/346e123667244b89b96c41c560b51a44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065164&amp;x-signature=IhqkmHc8XIiSOrVbJ78O8DJ2h48%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-10">线条组成图形</h2>
<h3 data-id="heading-11">绘制折线</h3>
<p>当我们学会绘制线条后，就可以用线条来组成图形了，方法其实很简单，就是复用上文用过的<code>lineTo()</code> 方法即可：</p>
<pre><code class="hljs language-js" lang="js">    ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>, <span class="hljs-number">100</span>);
    ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">0</span>);

    ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">10</span>;
    ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'red'</span>;

    ctx.<span class="hljs-title function_">stroke</span>();
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acfa8e95b0114d508c7c6a1f1a012e8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065164&amp;x-signature=uCoff0U9nEHXFzRwF%2FdeDY6YSPA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-12">绘制多条折线</h3>
<p>如果需要绘制多条不连接的线条，只需在绘制完一次后，再重新移动画笔，重新绘制一次即可</p>
<pre><code class="hljs language-js" lang="js">        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>, <span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">10</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'red'</span>;
        ctx.<span class="hljs-title function_">stroke</span>();

        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">150</span>, <span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">10</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'blue'</span>;
        ctx.<span class="hljs-title function_">stroke</span>(); 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c6c2b8f523e4707b5718d1f60ca827a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065164&amp;x-signature=XiP%2B4fnd%2B4Ec68%2BQd7mggwzOXZQ%3D" alt="image.png" loading="lazy"/>
诶？这是不是很奇怪，明明是先红色再蓝色，为什么就全变为蓝色了呢？<strong>是因为上文说过的 Canvas 是基于状态绘制的。我们每次使用<code>stroke()</code> 时，它都会把之前设置的状态再次绘制一遍，第一次<code>stroke</code>时会绘制一条红色折线，第二次<code>stroke</code>时，会再次重新绘制之前那条红色的折线，但是画笔已经变为蓝色的了，所以画出的折线全是蓝色的</strong>。</p>
<p>为了解决这个问题，我们需要在每次重新绘制时加上<code>beginPath()</code>，这个 API 代表下次绘制的起始处为<code>beginPath()</code>之后的代码。</p>
<pre><code class="hljs language-js" lang="js">        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>, <span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">10</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'red'</span>;
        ctx.<span class="hljs-title function_">stroke</span>();
        
        ctx.<span class="hljs-title function_">beginPath</span>(); <span class="hljs-comment">// 重新定义起始位置</span>
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">100</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">150</span>, <span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">200</span>, <span class="hljs-number">0</span>);
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">10</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">'blue'</span>;
        ctx.<span class="hljs-title function_">stroke</span>(); 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2051424865964361add06983e8ced723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065164&amp;x-signature=SxmjwGWroqhHM1wxxTLE5G8LR3Q%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-13">绘制矩形</h2>
<p>我们先使用绘制线条的方式绘制一个矩形</p>
<pre><code class="hljs language-js" lang="js">        <span class="hljs-comment">// 绘制一个矩形</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">50</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">50</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">50</span>);

        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">5</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">"black"</span>;

        ctx.<span class="hljs-title function_">stroke</span>();   
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/411bf8c2bde24ccc82a179d3ae34b4a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065164&amp;x-signature=EW0P2Szei%2FGtGhvNb%2BDwER1SV0E%3D" alt="image.png" loading="lazy"/>
会发现此时最后一笔画时有一个小缺口，这种情况是因为我们设置了<code>lineWidth</code>导致的，如果是默认笔触为1的话是不会有问题的，但是如果笔触越大，线条越宽，这个小缺口就会越明显。此时需要使用<code>closePath()</code>闭合图形。</p>
<pre><code class="hljs language-js" lang="js">        <span class="hljs-comment">// 绘制一个矩形</span>
        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">50</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">50</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">100</span>);
        <span class="hljs-comment">// ctx.lineTo(50,50); // 最后一笔可以不画</span>
        ctx.<span class="hljs-title function_">closePath</span>();
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbc42c23f5504718ab0fb038c009fabc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065164&amp;x-signature=xFAhir2AC8eCxfjR7mto%2FSQzqYY%3D" alt="image.png" loading="lazy"/></p>
<p>所以我们在绘制图形时需要使用<code>beginPath()</code>和 <code>closePath()</code>包裹起来。</p>
<h3 data-id="heading-14">给矩形上色</h3>
<p>上文中有提过绘制的两种方法分别是<code>stroke()</code>和<code>fill()</code>，我们需要使用<code>fill()</code>方法给矩形上色。和使用<code>stroke</code>前相同，我们需要先给它设置好属性。</p>
<pre><code class="hljs language-js" lang="js">        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">moveTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">50</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">50</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">100</span>,<span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">50</span>,<span class="hljs-number">100</span>);
        ctx.<span class="hljs-title function_">closePath</span>();

        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">5</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">"black"</span>;

        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">"red"</span>;

        ctx.<span class="hljs-title function_">fill</span>();
        ctx.<span class="hljs-title function_">stroke</span>();   
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34d863746af641cf951ba66a6be6130f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065164&amp;x-signature=%2FR0lXWgHcn5PPCqibDzvF7E7TwU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-15">使用<code>rect()</code>方法绘制矩形</h3>
<p>由于矩形是常用的图形，所以 Canvas API 封装好了一个定义矩形位置信息的方法，这个方法接受四个参数，分别表示矩形的起点坐标和宽高。</p>
<pre><code class="hljs language-js" lang="js">        ctx.<span class="hljs-title function_">rect</span>(x,y,width,height);

        ctx.<span class="hljs-title function_">beginPath</span>();
        ctx.<span class="hljs-title function_">rect</span>(<span class="hljs-number">50</span>,<span class="hljs-number">50</span>,<span class="hljs-number">100</span>,<span class="hljs-number">100</span>);
        
        ctx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">5</span>;
        ctx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">"black"</span>;
        ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">"red"</span>;

        ctx.<span class="hljs-title function_">fill</span>();
        ctx.<span class="hljs-title function_">stroke</span>();
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46338e599a61409da3d39828c7175cb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5piv6bG8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065164&amp;x-signature=b3V9TAjlyPZphxf2RgRKBTbLES4%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>今天 Canvas 的学习就到这啦</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript-实现函数方法-改变this指向call apply bind]]></title>    <link>https://juejin.cn/post/7574253222606290985</link>    <guid>https://juejin.cn/post/7574253222606290985</guid>    <pubDate>2025-11-19T09:14:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574253222606290985" data-draft-id="7574230922314448902" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript-实现函数方法-改变this指向call apply bind"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-19T09:14:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地狱恶犬萨煤耶"/> <meta itemprop="url" content="https://juejin.cn/user/485304409010298"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript-实现函数方法-改变this指向call apply bind
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/485304409010298/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地狱恶犬萨煤耶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:14:05.000Z" title="Wed Nov 19 2025 09:14:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">this</h2>
<ul>
<li>在<strong>函数执行时决定</strong>的不是定义时决定的</li>
<li><strong>this只和函数的调用有关</strong>*</li>
<li><code>obj.fn() </code>中 <code>fn</code>的 <code>this</code>就是<code>obj</code>  <code>arr[0] ()</code> <code>this</code>就是<code>arr</code></li>
</ul>
<h3 data-id="heading-1">重定义</h3>
<h4 data-id="heading-2">call</h4>
<ul>
<li>会直接执行函数</li>
<li>函数的参数逐个传进去
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36894c5eede7407cbc1074441e601003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148444&amp;x-signature=VlSyv%2BEmrExfJ3pg73AfFtc87aw%3D" alt="call" loading="lazy"/></li>
</ul>
<h5 data-id="heading-3">实现</h5>
<ul>
<li>首先先判断thisArg参数 如果为空就默认window 这里运用了<code>||运算符</code> <strong>有一个t结果就为t</strong> 所以短路效果为<strong>前面的表达式结果为t 后面的表达式就不执行</strong></li>
</ul>
<blockquote>
<p>补充说明<code>&amp;&amp;运算符</code> <strong>前面一个f结果就为f</strong> 所以短路效果是<strong>前面为f后面不执行</strong></p>
</blockquote>
<ul>
<li><strong>symbol(基本数据类型)有唯一性</strong> 可以保证属性与原对象不冲突 <code>  let key = Symbol('temp')</code>创建一个symbol类型的变量key其中<code>temp</code>是这个变量的描述符</li>
<li>利用<strong>对象的方法中的this指向对象</strong> :通过把这个函数给<code>thisArg</code>对象的方法再通过这个对象调用就改变了函数this的指向 其中利用<strong>数组的展开运算符</strong>把value(剩余参数数组)挨个传进这个方法完成了<code>mycall</code>改变this指向和直接执行函数的功能</li>
</ul>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-comment">//实现call</span>
    <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myCall</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">thisArg, ...value</span>) {
      <span class="hljs-comment">//如果参数为空 就默认是window</span>
      <span class="hljs-comment">//利用||特性</span>
      thisArg = thisArg || <span class="hljs-variable language_">window</span>

      <span class="hljs-keyword">let</span> key = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'temp'</span>)
      thisArg[key] = <span class="hljs-variable language_">this</span>
      <span class="hljs-comment">//利用...数组的展开运算符把value的所有元素 逐个全部传入</span>
      thisArg[key](...value)
      <span class="hljs-keyword">delete</span> thisArg[key]

    }
</code></pre>
<ul>
<li>测试用例</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//测试用例</span>
    <span class="hljs-comment">//this指向对象</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">fnCall</span>(<span class="hljs-params">a, b</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>, a, b);
    }
    fnCall.<span class="hljs-title function_">myCall</span>(obj, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
    <span class="hljs-comment">//this指向函数</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn1</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是测试函数'</span>);
    }
    fnCall.<span class="hljs-title function_">myCall</span>(fn1, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
</code></pre>
<h4 data-id="heading-4">apply</h4>
<ul>
<li>也会直接执行函数</li>
<li>参数以对象(一般是数组的形式传进去)
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3731b8441924504bfde8d0a87768a67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148444&amp;x-signature=i3sd7Wx2h49aanAauLyiqNwcVO4%3D" alt="apply" loading="lazy"/></li>
</ul>
<h5 data-id="heading-5">实现</h5>
<p>和<code>mycall</code>的基本思想是一样的区别如下</p>
<ul>
<li>因为参数是数组形式 所以<code>myApply</code>中的value参数不需要用剩余参数数组<code>...value</code>直接获取传入的数组<code>value</code>即可  然后还是使用<code>...</code>展开运算符把参数数组展开传入</li>
</ul>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">//实现apply</span>
     <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myApply</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">thisArg, value</span>) {
      thisArg = thisArg || <span class="hljs-variable language_">window</span>
      <span class="hljs-keyword">let</span> key = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'temp'</span>)
      thisArg[key] = <span class="hljs-variable language_">this</span>
      <span class="hljs-comment">//利用...数组的展开运算符把value的所有元素 逐个全部传入</span>
      thisArg[key](...value)
      <span class="hljs-keyword">delete</span> thisArg[key]
    }
    fnCall.<span class="hljs-title function_">myApply</span>(obj, [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>])
</code></pre>
<ul>
<li>测试用例同<code>mycall</code></li>
</ul>
<h4 data-id="heading-6">bind</h4>
<ul>
<li>参数逐个传入</li>
<li>返回新数组 调用之后才执行(参数自动传进去 this改变)
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f726b0038834767b307d337ac8a606d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148444&amp;x-signature=yHg8zwg0gbaI%2F17uG%2FRAzVDKSqY%3D" alt="bind" loading="lazy"/></li>
</ul>
<h5 data-id="heading-7">实现</h5>
<p>不会立即执行函数 而是返回新的函数</p>
<ul>
<li>因为返回的新函数中的this就不是调用函数了 所以要把this放进fn函数里</li>
<li><strong>返回一个新函数</strong> 先给<code>thisArg</code>对象添加fn方法(就是要改变this的函数) 然后<strong>把原函数的返回结果</strong>也就是对象方法的结果原函数的返回结果<strong>放进<code>result</code>作为新函数的返回结果</strong> 删除属性避免对原thisArg造成干扰 最后把<code>result</code>变量return出去</li>
</ul>
<blockquote>
<p>举例子(没有this干扰)理解<code>result</code>变量的必要性 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cb32a11ac354c54b6370d8edabb3aa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148444&amp;x-signature=VKTs%2BquC68jFy3I2Rho2V4pav5o%3D" alt="没有result" loading="lazy"/>
这里把内部函数的返回值return出去 就能实现调用<code>outside</code>函数返回一个<code>inside</code>函数并且把他的她的返回值也复制了<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1ae8e231ad84054be377eaae2d010c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148444&amp;x-signature=P6x4euU6gJ94dNY8ivypP0iF3Jw%3D" alt="有result" loading="lazy"/>最终代码</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">//实现bind</span>
    <span class="hljs-comment">//创建新函数 this绑定到指定对象上</span>
    <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myBind</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">thisArg, ...value</span>) {
      <span class="hljs-comment">//不会立即执行函数 而是返回新的函数</span>
      thisArg = thisArg || <span class="hljs-variable language_">window</span>
      <span class="hljs-keyword">let</span> fn = <span class="hljs-variable language_">this</span> <span class="hljs-comment">//把调用的函数存起来</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
        <span class="hljs-keyword">let</span> key = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'temp'</span>) <span class="hljs-comment">//每次调用都创建新的临时键</span>
        thisArg[key] = fn
        <span class="hljs-keyword">const</span> result = thisArg[key](...value)
        <span class="hljs-keyword">delete</span> thisArg.<span class="hljs-property">fn</span>
        <span class="hljs-keyword">return</span> result  <span class="hljs-comment">//返回原函数的执行结果</span>
      }
    }
</code></pre>
<ul>
<li>测试用例</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//生成新的函数</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">bindFn</span>(<span class="hljs-params">a, b</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'myBind结果'</span>, <span class="hljs-variable language_">this</span>, a, b);
    }
    <span class="hljs-keyword">let</span> <span class="hljs-title class_">Person</span> = {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'a'</span>
    }
    <span class="hljs-keyword">const</span> newBindfn = bindFn.<span class="hljs-title function_">myBind</span>(<span class="hljs-title class_">Person</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)
<span class="hljs-comment">//传入thisArg为空的情况</span>
    <span class="hljs-keyword">const</span> newBindfn1 = bindFn.<span class="hljs-title function_">myBind</span>(<span class="hljs-string">''</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)  <span class="hljs-comment">//this指向window</span>
<span class="hljs-comment">//新生成的函数返回值</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'函数返回结果'</span>
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fn.<span class="hljs-title function_">myBind</span>(<span class="hljs-title class_">Person</span>)());<span class="hljs-comment">//函数返回结果</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript-小游戏-2048]]></title>    <link>https://juejin.cn/post/7574230922314645510</link>    <guid>https://juejin.cn/post/7574230922314645510</guid>    <pubDate>2025-11-19T09:19:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574230922314645510" data-draft-id="7574245125028069395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript-小游戏-2048"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-19T09:19:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="地狱恶犬萨煤耶"/> <meta itemprop="url" content="https://juejin.cn/user/485304409010298"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript-小游戏-2048
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/485304409010298/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    地狱恶犬萨煤耶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:19:59.000Z" title="Wed Nov 19 2025 09:19:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">需求</h2>
<p>开局生成随机靠边方块
点击方向键移动方块
相邻方块且数值相同发生合并
方块占满界面触发游戏结束提示</p>
<h2 data-id="heading-1">游戏界面</h2>
<h3 data-id="heading-2">标签结构HTML</h3>
<p><code>area</code>区域和<code>death</code>区域分别表示游戏区域和死亡提示区域</p>
<pre><code class="hljs language-js" lang="js"> &lt;!-- 页面 --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"area"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  &lt;!-- 死亡提示区域 --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"death"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-3">层叠样式 css</h3>
<p>设置游戏区域为flex布局 主轴默认是水平<code>   flex-wrap: wrap;</code>设置主轴自动换行 注意这里游戏区域的大小是<code>200px*200px</code>的 后面可以算出每个方块的大小</p>
<pre><code class="hljs language-js" lang="js"> .<span class="hljs-property">area</span> {
      <span class="hljs-attr">display</span>: flex;
      flex-<span class="hljs-attr">wrap</span>: wrap;
      <span class="hljs-attr">width</span>: 200px;
      <span class="hljs-attr">height</span>: 200px;
      font-<span class="hljs-attr">size</span>: 30px;
    }
</code></pre>
<h3 data-id="heading-4">获取元素 js</h3>
<p>获取两个游戏区域和游戏结束提示区域的<code>div</code></p>
<pre><code class="hljs language-js" lang="js">   <span class="hljs-keyword">const</span> area = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.area'</span>)
    <span class="hljs-keyword">const</span> death = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.death'</span>)
</code></pre>
<h2 data-id="heading-5">数据分析</h2>
<p><strong>二维数组</strong> 用<code>arr[y][x]</code>第一个索引表示y坐标 第二个索引表示x坐标 数组的值表示方块的数值（2，4，8...)没有值就表示这个坐标位置没有方块
这里还要初始化一个<code>rArr</code>数组是用来将数组旋转结果存入新数组防止重复处理的</p>
<blockquote>
<p>后面的移动和合并都是需要旋转数组进行操作</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> arr = [] <span class="hljs-comment">//方块坐标和数值</span>
    <span class="hljs-keyword">let</span> rArr = [] <span class="hljs-comment">//旋转数组</span>
    <span class="hljs-comment">//初始化</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
      arr[i] = []
      rArr[i] = []
    }
</code></pre>
<h2 data-id="heading-6">功能实现</h2>
<h3 data-id="heading-7">渲染方法</h3>
<ul>
<li>像素点的思路渲染游戏区域为<code>5*5</code>个方块 所以算出每个方块 的大小为<code>40px*40px</code>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee013dbcc9e44ca3aaaca311a4fea661~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=hHC0ZHdoOHtd%2B3inAmHIedPODSs%3D" alt="渲染" loading="lazy"/></li>
<li>如果有方块 就渲染为粉色 方块的数值<code>${arr[y][x]}</code>也渲染在<code>div</code>上</li>
<li>其余部分就是画布</li>
<li><code>block</code>字符串累加完毕之后渲染到页面上</li>
</ul>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">//渲染页面</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
      block = <span class="hljs-string">''</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = <span class="hljs-number">0</span>; y &lt; <span class="hljs-number">5</span>; y++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-number">5</span>; x++) {
          <span class="hljs-keyword">if</span> (arr[y][x]) {
            block += <span class="hljs-string">`&lt;div class="square"style="width: 40px;height: 40px;text-align: center; line-height: 40px; background-color: pink;"&gt;<span class="hljs-subst">${arr[y][x]}</span>&lt;/div&gt;`</span>
          }
          <span class="hljs-keyword">else</span> {
            block += <span class="hljs-string">' &lt;div class="block" style="width: 40px;height: 40px;background-color: antiquewhite;"&gt;&lt;/div&gt;'</span>
          }
        }
      }
      area.<span class="hljs-property">innerHTML</span> = block
    }
    <span class="hljs-title function_">render</span>()
</code></pre>
<p>游戏区域页面如下
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1618ae46b6c746978d94d2a2e742d27c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=fAZi6iWgAd52Iwg886BCGvJU81E%3D" alt="游戏区域" loading="lazy"/></p>
<h3 data-id="heading-8">开局随机生成两个方块</h3>
<p>这里的<strong>方块坐标不能重复</strong></p>
<ul>
<li>声明两个数字类型的全局变量 用来表示两个随机生成的坐标</li>
<li>这里的<code>randomStart</code>函数用来<strong>随机生成不重复的两个坐标</strong> <code>a</code>和<code>c</code>变量表示随机生成<code>[0,4]</code>之间的整数坐标 如果生成的随机整数坐标<code>a c</code>重复 就重新调用<code>randomStart</code>函数生成</li>
<li>这里运用了<strong>三元运算符</strong> 来根据<code> Math.random()</code> 随机生成<code>[0,1)</code>范围内的两个小数的大小 决定这两个方块的坐标位置 这里坐标位置可以重复</li>
<li>第一个方块<code>Math.random()&gt; 0.5</code> 执行前面的表达式<code>arr[0][a] = 2 </code>方块随机在上面的边 否则执行后面的表达式<code> arr[a][0] = 2</code>方块随机在左边的边 第二个方块同理</li>
</ul>
<h4 data-id="heading-9">三元运算符</h4>
<p><code>条件?表达式A:表达式B</code> 条件为真执行前面的表达式A 条件为假执行后面的表达式B<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60ddca88c83f4c179b790a4c764c3ad6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=7D8Kkjg%2BRDYt2gos5fCUA%2BGFZSI%3D" alt="三元运算符例" loading="lazy"/>
<strong>常见用法</strong>是处理<code>null</code>值
这里表示 如果传入的参数是假的话name的值为<code> 'stranger'</code> 如果是真的话就是<code>参数name属性</code>的值</p>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">//三元运算符</span>
    <span class="hljs-comment">//以箭头函数形式 定义greeting函数 这里传入的参数是对象</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">greeting</span> = (<span class="hljs-params">person</span>) =&gt; {
      <span class="hljs-keyword">const</span> name = person ? person.<span class="hljs-property">name</span> : <span class="hljs-string">'stranger'</span>
      <span class="hljs-keyword">return</span> <span class="hljs-string">`hello <span class="hljs-subst">${name}</span>`</span>
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">greeting</span>({ <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'a'</span> })); <span class="hljs-comment">//hello a</span>

    <span class="hljs-comment">//这里三元运算符是真 </span>
    <span class="hljs-comment">// 但是字符串本身没有name属性</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">greeting</span>(<span class="hljs-string">'b'</span>)); <span class="hljs-comment">//undefined</span>

    <span class="hljs-comment">//传入的都是字面量 是最简单的表达式 可以通过代码直接看出值</span>
    <span class="hljs-comment">//这些是假值 </span>
    <span class="hljs-comment">//数字字面量</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">greeting</span>(<span class="hljs-number">0</span>)); <span class="hljs-comment">//hello stranger</span>
    <span class="hljs-comment">//null字面量</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">greeting</span>(<span class="hljs-literal">null</span>)); <span class="hljs-comment">//hello stranger</span>
    <span class="hljs-comment">//字符串字面量</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">greeting</span>(<span class="hljs-string">''</span>)); <span class="hljs-comment">//hello stranger</span>
</code></pre>
<p>最终开局随机生成两个方块功能代码如下</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//随机生成两个不相同随机坐标</span>
    <span class="hljs-keyword">let</span> a = <span class="hljs-number">0</span>, c = <span class="hljs-number">0</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">randomStart</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">//生成的随机数不能重复 连续两次的话</span>
      a = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">5</span>)  <span class="hljs-comment">//0-5</span>
      c = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">5</span>)
      <span class="hljs-keyword">if</span> (c === a) {
        <span class="hljs-title function_">randomStart</span>()
      }
    }
    <span class="hljs-comment">//开局生成两个不重复的方块</span>
    <span class="hljs-title function_">randomStart</span>()
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span> ? arr[<span class="hljs-number">0</span>][a] = <span class="hljs-number">2</span> : arr[a][<span class="hljs-number">0</span>] = <span class="hljs-number">2</span>
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span> ? arr[<span class="hljs-number">0</span>][c] = <span class="hljs-number">2</span> : arr[c][<span class="hljs-number">0</span>] = <span class="hljs-number">2</span>
</code></pre>
<p>效果如下
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b46de6fbdf214335923beb3187780b18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=TgCxieqM%2FOvzgU5XTxG55o0oO0c%3D" alt="随机" loading="lazy"/></p>
<h3 data-id="heading-10">点击方向键移动方块</h3>
<h4 data-id="heading-11">分析点击方向键之后方块变化</h4>
<p>这里有上下左右四个方向 每个方向都要写移动逻辑的话代码冗余了 所以可以<strong>根据要旋转的方向不同对数组进行旋转处理</strong> 然后再左移 这时候再进行左移这个方向的合并判断 最后把数组旋转回去
移动处理完毕之后还需要生成随机新方块</p>
<blockquote>
<p>这里的设计<strong>不太符合单一职责</strong>(一个函数 模块只负责一件事)事件监听承受了太多功能 目前还不知道怎么优化比较好</p>
</blockquote>
<p><strong>根据分析将功能拆分</strong></p>
<ul>
<li><strong>除了向左移动的情况 其他方向都是</strong>  点击键盘方向键之后先更改<code>type</code>的值再根据<code>type</code>调用<code>rotate()</code>函数旋转数组 <code>move()</code>往左移动 <code>add()</code>判断合并最后再<code>rotate()</code>旋转回去</li>
</ul>
<blockquote>
<p>这里的<code>rotate()</code>要传入具体的<code>type</code>参数 因为在上下移动过程中出现了顺时针和逆时针的旋转 这里将数组旋转回去的时候要传入的<code>type</code>就不同了</p>
</blockquote>
<ul>
<li><strong>向左移动的情况很简单</strong> 只需要直接<code>move()</code>移动再执行合并
<strong>移动完之后</strong></li>
<li>生成新随机方块<code> random()</code></li>
<li>此时<code>arr</code>已经处理完毕 <code>rander()</code>渲染页面</li>
<li>判断是否死亡<code>  deathJudge()</code>
键盘按键事件如下</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> type = <span class="hljs-string">''</span><span class="hljs-comment">//移动方向</span>
    <span class="hljs-comment">//每次移动完生成一个边缘新方块</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'ArrowUp'</span>) {
        type = <span class="hljs-string">'up'</span>
        <span class="hljs-title function_">rotate</span>(<span class="hljs-string">'up'</span>)<span class="hljs-comment">//旋转</span>
        <span class="hljs-title function_">move</span>()<span class="hljs-comment">//移动</span>
        <span class="hljs-title function_">add</span>()
        <span class="hljs-title function_">rotate</span>(<span class="hljs-string">'down'</span>)<span class="hljs-comment">//旋转回去</span>
      }

      <span class="hljs-comment">//这里处理错了down</span>
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'ArrowDown'</span>) {
        type = <span class="hljs-string">'down'</span>
        <span class="hljs-title function_">rotate</span>(<span class="hljs-string">'down'</span>)<span class="hljs-comment">//旋转</span>
        <span class="hljs-title function_">move</span>()<span class="hljs-comment">//移动</span>
        <span class="hljs-title function_">add</span>()
        <span class="hljs-title function_">rotate</span>(<span class="hljs-string">'up'</span>)<span class="hljs-comment">//旋转回去</span>
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'ArrowLeft'</span>) {
        type = <span class="hljs-string">'left'</span>
        <span class="hljs-title function_">move</span>()
        <span class="hljs-title function_">add</span>()
      }
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'ArrowRight'</span>) {
        type = <span class="hljs-string">'right'</span>
        <span class="hljs-title function_">rotate</span>(<span class="hljs-string">'right'</span>)<span class="hljs-comment">//旋转</span>
        <span class="hljs-title function_">move</span>()<span class="hljs-comment">//移动</span>
        <span class="hljs-title function_">add</span>()
        <span class="hljs-comment">//因为这里是翻转 所以和之前一样处理翻转回去就行</span>
        <span class="hljs-title function_">rotate</span>(<span class="hljs-string">'right'</span>)
      }
      <span class="hljs-comment">//移动处理完毕生成新随机方块</span>
      <span class="hljs-title function_">random</span>()
      <span class="hljs-title function_">render</span>()
      <span class="hljs-title function_">deathJudge</span>()
    })

</code></pre>
<h4 data-id="heading-12">旋转处理</h4>
<ul>
<li>如果有值就根据<code>type</code>不同旋转
<strong>right</strong> 这里相当于翻转 所以旋转回去只需要再翻转一次<code>rotate('right')</code>就行<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b067a42e26c40d1a2a97f90975a479d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=XhzfWcMBwpl1eG6EzxRhXvN7fBs%3D" alt="right" loading="lazy"/>
<strong>down</strong>这里相当于<strong>顺时针旋转90度</strong> 所以旋转回去需要逆时针旋转90度也就是<code>rotate(up)</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56c67c46f8784030a7f97f0c368b7739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=c5ZtkJ%2FaZpqUNYqS5Rr0Hmy21q0%3D" alt="down" loading="lazy"/></li>
</ul>
<p><strong>up</strong>这里相当于<strong>逆时针旋转90度</strong> 所以旋转回去需要顺时针旋转90度也就是<code>rotate('down')</code><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf68477dc7444f938e9fcd9e25730880~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=K91IQ20cx%2Bd3MzHPC7s5QxGKca4%3D" alt="up" loading="lazy"/></p>
<ul>
<li>旋转完毕后 删除已经处理完旋转的元素 便于后面将旋转之后的数组给arr</li>
</ul>
<blockquote>
<p>这里删除处理也可以用<code>delete</code> 不会破坏索引!<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46045a909c5248e39b071689b265328b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=PtYUG9ntyrjwodauCawuCygOM4g%3D" alt="delete" loading="lazy"/></p>
</blockquote>
<ul>
<li>然后遍历<code>rArr</code>把数值给arr 再把rArr相应的元素删除方便下次<code>rotate()</code>旋转</li>
</ul>
<blockquote>
<p>放进新数组是为了防止旋转后的元素被重复旋转遍历
最终代码如下</p>
</blockquote>
<pre><code class="hljs language-js" lang="js">  <span class="hljs-comment">//翻转数组 变成左移</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">rotate</span>(<span class="hljs-params">type</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'rotate'</span>, type);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = <span class="hljs-number">0</span>; y &lt; <span class="hljs-number">5</span>; y++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-number">5</span>; x++) {
          <span class="hljs-keyword">if</span> (arr[y][x]) {
            <span class="hljs-comment">//翻转</span>
            <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'right'</span>) {
              <span class="hljs-comment">//这里旋转结果必须放进新数组防止重复处理</span>
              rArr[y][<span class="hljs-number">4</span> - x] = arr[y][x]
            }
            <span class="hljs-comment">//顺时针90</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'down'</span>) {
              rArr[x][<span class="hljs-number">4</span> - y] = arr[y][x]
            }
            <span class="hljs-comment">//逆时针90</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'up'</span>) {
              rArr[<span class="hljs-number">4</span> - x][y] = arr[y][x]
            }
            <span class="hljs-comment">//删除原位置元素</span>
            <span class="hljs-comment">// arr[y][x] = 0</span>
            <span class="hljs-keyword">delete</span> arr[y][x]
          }
        }
      }
      <span class="hljs-comment">//把旋转之后的数组给arr 方便转回去</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">5</span>; j++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
          <span class="hljs-keyword">if</span> (rArr[j][i]) {
            arr[j][i] = rArr[j][i]
            <span class="hljs-keyword">delete</span> rArr[j][i]
          }
        }
      }
      <span class="hljs-comment">// console.log('rotate旋转处理之后的arr', arr);</span>
    }
</code></pre>
<h4 data-id="heading-13">移动处理</h4>
<p>旋转完毕后 数组只需要左移动就可以</p>
<ul>
<li>首先遍历<code>arr数组</code> 如果这行出现空位 <code>!arr[y][x]</code>为<code>true</code> 表示 <code>arr[y][x]</code>为false也就是为空和0的时候 执行后面的语句</li>
<li>就<strong>遍历这一行空位后面的部分</strong> 这里循环的起始点是<code>i = x</code> 如果后面有值就给前面空位 这里记得删掉后面的值 然后直接<code>break</code>跳出空位后元素遍历循环继续对这一行进行空位搜索</li>
</ul>
<blockquote>
<p>补充说明<code>break</code>和<code>continue</code>的区别
<code>break</code>只跳出一层循环 这里相当于 <code>x&gt;=1</code>的情况下都不执行内层循环了
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adf1db51f9cc4839b7b6e19e1d64d645~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=BzXB6t7PvZw%2FlkP1uyceaTw5hcc%3D" alt="break" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29b6645af89c4bff9aee8d7154b41f82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=uKxd3qJ5I5Oh%2BB2dOwu9yNSdcHE%3D" alt="break" loading="lazy"/>
<code>continue</code>跳过当前 然后进行下一个迭代 这里相当于只有在<code>x===1</code>的情况下才不执行内层循环 其他情况是正常执行的
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/518ed6e0ce8343bcb9748c0a05962e48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=w%2Beess9IslcPzp2lSM2RtZz8Tog%3D" alt="continue" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b6a551e6e1b47c8905c36359d5fcb33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=cOBhodRSECGA2hKwaUk1i2zdkME%3D" alt="continue" loading="lazy"/></p>
</blockquote>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-comment">// 移动逻辑</span>
    <span class="hljs-comment">//所有数组都旋转处理成左移判断</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">move</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'move'</span>);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = <span class="hljs-number">0</span>; y &lt; <span class="hljs-number">5</span>; y++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-number">5</span>; x++) {
          <span class="hljs-keyword">if</span> (!arr[y][x]) {
            <span class="hljs-comment">//后面如果后面有值就给前面空位</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = x; i &lt; <span class="hljs-number">5</span>; i++) {
              <span class="hljs-comment">//只执行一次 找出最靠近空位的值</span>
              <span class="hljs-keyword">if</span> (arr[y][i]) {
                arr[y][x] = arr[y][i]
                arr[y][i] = <span class="hljs-number">0</span>
                <span class="hljs-comment">//这里用哪个符号比较好</span>
                <span class="hljs-keyword">break</span> <span class="hljs-comment">//跳出for i 循环么</span>
              }
            }
          }
        }
      }
    }
</code></pre>
<p>点击方向键移动方块效果如下
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdd48d771f914d1a95a70293ddb46f2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=SbhDY6wC1FNK4qw5Ayc7Q8RlOes%3D" alt="移动" loading="lazy"/></p>
<h3 data-id="heading-14">合并判断</h3>
<p>这里合并判断也会根据方向不同 判断的方向不同 所以这里放在数组旋转回去之前 所以无论方向如何都是<strong>对左移进行合并判断</strong></p>
<ul>
<li><strong>合并</strong>这里是向左合并的 判断的是<code>arr[j][i] </code>和右边相邻位置 <code>arr[j][i + 1]</code>的元素数值 这里的判断范围缩小<code>i &lt; 4</code> 如果相等就左边方块数值累加然后右边方块数值清空</li>
</ul>
<blockquote>
<p>注意 这里只完成了数值的合并 合并完之后还要向左移动 如图例<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1377ced2d4c4857ac1cff9860853113~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=S58cd2p%2BJdkxZ2ZuU%2FEtj8BuwL0%3D" alt="合并之后移动" loading="lazy"/></p>
</blockquote>
<ul>
<li>全部合并完之后要都<strong>向左移动</strong><code>move()</code></li>
</ul>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">//合并</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'合并add'</span>, type, arr);
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">5</span>; j++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) {
          <span class="hljs-comment">//相邻检测</span>
          <span class="hljs-keyword">if</span> (arr[j][i]) {
            <span class="hljs-keyword">if</span> (arr[j][i] === arr[j][i + <span class="hljs-number">1</span>]) {
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'找到左移方块'</span>, j, i);
              arr[j][i] += arr[j][i]
              arr[j][i + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>
            }
          }
        }
      }
      <span class="hljs-comment">//全部合并完之后再向左移动</span>
      <span class="hljs-title function_">move</span>()
    }
</code></pre>
<p>合并效果如下
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c019edda8de84c94b803295551964137~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=fuJ5IDT8GUWrCf%2FJJN9Rp6216zU%3D" alt="合并" loading="lazy"/></p>
<h3 data-id="heading-15">移动完毕生成新随机方块</h3>
<p>这些方块是从没有方块的坐标中随机生成的</p>
<ul>
<li><code>scope</code>数组表示没有方块的坐标 第一个索引表示方块序号可以用来随机选取方块 第二个索引表示方块的x或者y值
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42404ffe36934a10af7bc687023cb03e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=B5TxEe9smTO5HnOgn6a4i5tXcIc%3D" alt="scope" loading="lazy"/></li>
<li>循环遍历<code>arr</code>把没有值的坐标放进<code>scope</code>数组</li>
<li><code>index</code>表示随机的<code>scope</code>索引 范围为<code>[0,scope.length-1]</code></li>
</ul>
<blockquote>
<p>用<code>Math.floor </code>和 <code>Math.random </code>表示从<code>[a,b]</code>随机整数
<code>Math.floor(Math.random() * (b - a + 1)) + a;</code>
<code>Math.random()</code>随机生成<code>[0,1)</code>之间的随机小数  <code>Math.random() * (b - a + 1) </code>生成<code>[0,b-a+1)</code>
<code>Math.floor </code>对小数向下取整得到<code>[0,b-a]</code>之间的整数
最后再加上<code>a</code> 范围偏移成<code>[a,b]</code></p>
</blockquote>
<ul>
<li>这里<code>randomY</code>表示随机到的y坐标 也就是<code>scope[index][0]</code>第<code>index</code>个方块的第0个坐标</li>
<li>最后随机生成的方块数值可能为2和4 继续用<code>Math.random()</code>随机生成的小数和0.5的大小比较决定随机生成方块的数值</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//移动之后再随机生成一个方块 数值可能是4或者2</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">random</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">let</span> scope = []
      <span class="hljs-comment">//因为可能后面没有值 长度实际上小于10</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">5</span>; j++) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
          <span class="hljs-comment">//方块不重复</span>
          <span class="hljs-comment">//把没有值的坐标放进数组 然后再随机索引进行选择</span>
          <span class="hljs-keyword">if</span> (!arr[j][i]) {
            scope.<span class="hljs-title function_">push</span>([j, i])
          }
        }
      }
      <span class="hljs-comment">//随机索引</span>
      <span class="hljs-keyword">let</span> index = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * scope.<span class="hljs-property">length</span>)
      <span class="hljs-keyword">let</span> randomY = scope[index][<span class="hljs-number">0</span>]
      <span class="hljs-keyword">let</span> randomX = scope[index][<span class="hljs-number">1</span>]

      <span class="hljs-comment">//随机数值</span>
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span> ? arr[randomY][randomX] = <span class="hljs-number">2</span> : arr[randomY][randomX] = <span class="hljs-number">4</span>
    }
</code></pre>
<p>移动完毕生成新随机方块效果如下
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eebb68e73cfc48a9860aea5d3e2123ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=g8sACbcsUe1LSIHD9F8L5M%2Fi8hI%3D" alt="新方块" loading="lazy"/></p>
<h3 data-id="heading-16">死亡功能</h3>
<h4 data-id="heading-17">死亡判断</h4>
<p>开局只生成两个方块不需要判断 之后每次移动完毕都要判断一次</p>
<ul>
<li><code>death</code>表示是否出现死亡 Boolean类型初始值是<code>true</code></li>
<li>遍历<code>arr</code> 如果位置上元素没有值 就还没有死亡 <code>death = false</code>  <strong>这个是要找的非常态 出现这种情况就知道最终结果了</strong> 所以初始值是常态<code>true</code> 元素上有值还要继续往下找</li>
</ul>
<blockquote>
<p>这里不能用<code>!arr[j].every((value) =&gt; value &gt; 1)</code> 因为<code>every</code><strong>对稀疏数组的空槽是不执行</strong>的 在<code>random()</code>和<code>randomStart()</code>给随机坐标赋值的时候造成了<code>arr[j]</code>是稀疏数组 会导致判断失误
补充说明 <strong>稀疏数组创建方式</strong><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec67202d125d4966b80bbc40acabbabd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=VbLkyMo9qbwG5noEnApOqgo%2BjPA%3D" alt="稀疏数组" loading="lazy"/></p>
</blockquote>
<ul>
<li>最终的<code>death</code>值就能表示死亡情况</li>
<li>如果<code>death === true</code>就执行死亡效果</li>
</ul>
<pre><code class="hljs language-js" lang="js">   <span class="hljs-comment">//死亡判断</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">deathJudge</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">let</span> death = <span class="hljs-literal">true</span> <span class="hljs-comment">//表示是否进入死亡</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = <span class="hljs-number">0</span>; y &lt; <span class="hljs-number">5</span>; y++) {
        <span class="hljs-comment">//如果这一行有空位 就跳出循环</span>
        <span class="hljs-comment">//这里不是表示每个都大于</span>
        <span class="hljs-comment">//不能用every因为稀疏数组不执行</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-number">5</span>; x++) {
          <span class="hljs-comment">//有一个位置上的元素没有值 就不是死亡</span>
          <span class="hljs-keyword">if</span> (!arr[y][x]) {
            death = <span class="hljs-literal">false</span>
          }
        }
      }
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(death, <span class="hljs-string">'死亡判断'</span>);
      <span class="hljs-keyword">if</span> (death === <span class="hljs-literal">true</span>) {
        <span class="hljs-title function_">deachCss</span>()  <span class="hljs-comment">//死亡效果</span>
      }
    }
</code></pre>
<h4 data-id="heading-18">死亡效果</h4>
<p>要找出方块数值最大值打印在游戏结束区域</p>
<ul>
<li><code>maxArr</code>数组用来放每行的最大值</li>
<li><code>maxX</code>表示每行的最大值 找出来之后放进<code>maxArr</code>数组</li>
<li><strong><code>arr[y]</code>采用线性遍历 像直线一样逐个排查</strong> 这里默认每行的第一个元素为最大值 然后遍历后面的元素 如果比<code>maxX</code>大 就更新 把值给<code>maxX</code></li>
</ul>
<blockquote>
<p>后面还会更新数组最大值的一些比较方法</p>
</blockquote>
<ul>
<li>把每行的最大值<code>push</code>进<code>maxArr</code>数组</li>
<li>然后再对<code>maxArr</code>进行线性遍历 从而找到整个<code>arr</code>数组的最大值</li>
<li>最后把最大数值渲染到页面</li>
</ul>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-keyword">function</span> <span class="hljs-title function_">deachCss</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">//找到数组中的最大数值</span>
      <span class="hljs-keyword">let</span> maxArr = []
      <span class="hljs-keyword">let</span> maxX = <span class="hljs-number">0</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> y = <span class="hljs-number">0</span>; y &lt; <span class="hljs-number">5</span>; y++) {
        maxX = arr[y][<span class="hljs-number">0</span>]
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> x = <span class="hljs-number">1</span>; x &lt; <span class="hljs-number">5</span>; x++) {
          <span class="hljs-keyword">if</span> (arr[y][x] &gt; maxX) {
            maxX = arr[y][x]
          }
        }
        maxArr.<span class="hljs-title function_">push</span>(maxX) <span class="hljs-comment">//每行的最大</span>
      }
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(maxArr);
      <span class="hljs-comment">//再从每行的最大里面找</span>
      <span class="hljs-keyword">let</span> max = maxArr[<span class="hljs-number">0</span>]
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> a = <span class="hljs-number">1</span>; a &lt; maxArr.<span class="hljs-property">length</span>; a++) {
        <span class="hljs-keyword">if</span> (max &lt; maxArr[a]) {
          max = maxArr[a]
        }
      }
      <span class="hljs-comment">//死亡效果</span>
      death.<span class="hljs-property">innerText</span> = <span class="hljs-string">`游戏结束 最大方块为<span class="hljs-subst">${max}</span>`</span>
    }
</code></pre>
<p>死亡效果如下
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad7163d2fccd4a27b511584a6a95d1fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zyw54ux5oG254qs6JCo54Wk6IC2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148799&amp;x-signature=6%2FXL4uWM6qeQnXYBWqHYuHUw%2FGo%3D" alt="死亡效果" loading="lazy"/></p>
<h2 data-id="heading-19">最终代码</h2>
<pre><code class="hljs language-js" lang="js">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
  &lt;title&gt;2048&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
  &lt;!-- 页面 --&gt;
  &lt;div class="area"&gt;&lt;/div&gt;
  &lt;!-- 死亡提示区域 --&gt;
  &lt;div class="death"&gt;&lt;/div&gt;
  &lt;style&gt;
    .area {
      display: flex;
      flex-wrap: wrap;
      width: 200px;
      height: 200px;
      font-size: 25px;
    }
  &lt;/style&gt;
  &lt;script&gt;
    const area = document.querySelector('.area')
    const death = document.querySelector('.death')
    let arr = [] //方块坐标和数值
    let rArr = [] //旋转数组
    //初始化
    for (let i = 0; i &lt; 5; i++) {
      arr[i] = []
      rArr[i] = []
    }
    deathJudge() //开局只随机生成两个方块不需要判断死亡

    //随机生成两个不相同随机坐标
    let a = 0, c = 0
    function randomStart() {
      //生成的随机数不能重复 连续两次的话
      a = Math.floor(Math.random() * 5)  //0-5
      c = Math.floor(Math.random() * 5)
      if (c === a) {
        randomStart()
      }
    }
    //开局生成两个不重复的方块
    randomStart()
    Math.random() &gt; 0.5 ? arr[0][a] = 2 : arr[a][0] = 2
    Math.random() &gt; 0.5 ? arr[0][c] = 2 : arr[c][0] = 2

    //移动之后再随机生成一个方块 数值可能是4或者2
    function random() {
      let scope = []
      for (let j = 0; j &lt; 5; j++) {
        for (let i = 0; i &lt; 5; i++) {
          //方块不重复
          //把没有值的坐标放进数组 然后再随机索引进行选择
          if (!arr[j][i]) {
            scope.push([j, i])
          }
        }
      }
      //随机索引
      let index = Math.floor(Math.random() * scope.length)
      let randomY = scope[index][0]
      let randomX = scope[index][1]

      //随机数值
      Math.random() &gt; 0.5 ? arr[randomY][randomX] = 2 : arr[randomY][randomX] = 4
    }


    let type = ''//移动方向
    //每次移动完生成一个边缘新方块

    document.addEventListener('keydown', function (e) {
      if (e.key === 'ArrowUp') {
        type = 'up'
        rotate('up')//旋转
        move()//移动
        add()
        rotate('down')//旋转回去

      }

      //这里处理错了down
      else if (e.key === 'ArrowDown') {
        type = 'down'
        rotate('down')//旋转
        move()//移动
        add()
        rotate('up')//旋转回去

      }
      else if (e.key === 'ArrowLeft') {
        type = 'left'
        move()
        add()
      }
      else if (e.key === 'ArrowRight') {
        type = 'right'
        rotate('right')//旋转
        move()//移动
        add()
        //因为这里是翻转 所以和之前一样处理翻转回去就行
        rotate('right')
      }
      //移动处理完毕生成新随机方块
      random()
      render()
      deathJudge()
    })

    //翻转数组 变成左移
    function rotate(type) {
      console.log('rotate', type);
      for (let y = 0; y &lt; 5; y++) {
        for (let x = 0; x &lt; 5; x++) {
          if (arr[y][x]) {
            //翻转
            if (type === 'right') {
              //这里旋转结果必须放进新数组防止重复处理
              rArr[y][4 - x] = arr[y][x]
            }
            //顺时针90
            else if (type === 'down') {
              rArr[x][4 - y] = arr[y][x]
            }
            //逆时针90
            else if (type === 'up') {
              rArr[4 - x][y] = arr[y][x]
            }
            //删除原位置元素
            // arr[y][x] = 0
            delete arr[y][x]
          }
        }
      }
      //把旋转之后的数组给arr 方便转回去
      for (let j = 0; j &lt; 5; j++) {
        for (let i = 0; i &lt; 5; i++) {
          if (rArr[j][i]) {
            arr[j][i] = rArr[j][i]
            delete rArr[j][i]
          }
        }
      }
      // console.log('rotate旋转处理之后的arr', arr);
    }


    // 移动逻辑
    //所有数组都旋转处理成左移判断
    function move() {
      console.log('move');
      for (let y = 0; y &lt; 5; y++) {
        for (let x = 0; x &lt; 5; x++) {
          if (!arr[y][x]) {
            //后面如果后面有值就给前面空位
            for (let i = x; i &lt; 5; i++) {
              //只执行一次 找出最靠近空位的值
              if (arr[y][i]) {
                arr[y][x] = arr[y][i]
                arr[y][i] = 0
                //这里用哪个符号比较好
                break //跳出for i 循环么
              }
            }
          }
        }
      }
    }

    //合并
    function add() {
      console.log('合并add', type, arr);
      for (let j = 0; j &lt; 5; j++) {
        for (let i = 0; i &lt; 4; i++) {
          //相邻检测
          if (arr[j][i]) {
            if (arr[j][i] === arr[j][i + 1]) {
              console.log('找到左移方块', j, i);
              arr[j][i] += arr[j][i]
              arr[j][i + 1] = 0
            }
          }
        }
      }
      //全部合并完之后再向左移动
      move()
    }

    //死亡判断
    function deathJudge() {
      let death = true //表示是否进入死亡
      for (let y = 0; y &lt; 5; y++) {
        //如果这一行有空位 就跳出循环
        //这里不是表示每个都大于
        //不能用every因为稀疏数组不执行
        for (let x = 0; x &lt; 5; x++) {
          //有一个位置上的元素没有值 就不是死亡
          if (!arr[y][x]) {
            death = false
          }
        }
      }
      console.log(death, '死亡判断');
      if (death === true) {
        deachCss()  //死亡效果
      }
    }


    function deachCss() {
      //找到数组中的最大数值
      let maxArr = []
      let maxX = 0
      for (let y = 0; y &lt; 5; y++) {
        maxX = arr[y][0]
        for (let x = 1; x &lt; 5; x++) {
          if (arr[y][x] &gt; maxX) {
            maxX = arr[y][x]
          }
        }
        maxArr.push(maxX) //每行的最大
      }
      console.log(maxArr);
      //再从每行的最大里面找
      let max = maxArr[0]
      for (let a = 1; a &lt; maxArr.length; a++) {
        if (max &lt; maxArr[a]) {
          max = maxArr[a]
        }
      }
      //死亡效果
      death.innerText = `游戏结束 最大方块为${max}`
    }


    //渲染页面
    function render() {
      block = ''
      for (let y = 0; y &lt; 5; y++) {
        for (let x = 0; x &lt; 5; x++) {
          if (arr[y][x]) {
            block += `&lt;div class="square"style="width: 40px;height: 40px;text-align: center; line-height: 40px; background-color: pink;"&gt;${arr[y][x]}&lt;/div&gt;`
          }
          else {
            block += ' &lt;div class="block" style="width: 40px;height: 40px;background-color: antiquewhite;"&gt;&lt;/div&gt;'

          }
        }
      }
      area.innerHTML = block
    }
    render()


  &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[playwright的调试模式，方便调试selector, locator语法及查找效果]]></title>    <link>https://juejin.cn/post/7574217823105531955</link>    <guid>https://juejin.cn/post/7574217823105531955</guid>    <pubDate>2025-11-19T09:20:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574217823105531955" data-draft-id="7574244766423515145" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="playwright的调试模式，方便调试selector, locator语法及查找效果"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T09:20:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yeyong"/> <meta itemprop="url" content="https://juejin.cn/user/4283353031781063"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            playwright的调试模式，方便调试selector, locator语法及查找效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4283353031781063/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yeyong
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:20:35.000Z" title="Wed Nov 19 2025 09:20:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>下面是一套“<strong>边写边测</strong>”的通用套路，确保 <code>page.locator()</code> / <code>wait_for_selector()</code> 在提交代码前就能一次跑通，<strong>不用每次都重跑完整流程</strong>。</p>
<hr/>
<ol>
<li>官方“秒测”工具：Playwright Inspector</li>
</ol>
<hr/>
<p>命令行里加 <code>--paused</code> 即可打开自带调试器：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Python 例子</span>
PWDEBUG=1 pytest my_test.py
<span class="hljs-comment"># 或直接</span>
playwright codegen https://your-site.com
</code></pre>
<ul>
<li>左侧 <strong>“Pick”</strong> 图标点一下，再点页面元素 → 自动生成最稳的 locator 代码。</li>
<li>右侧 <strong>“Explore”</strong> 面板会实时显示：<br/>
– 匹配到几个节点<br/>
– 实际文本/属性值<br/>
– 高亮渲染<br/>
→ 把生成的代码复制进脚本即可，<strong>零手写</strong>。</li>
</ul>
<hr/>
<ol start="2">
<li>在代码里快速“断言+高亮”</li>
</ol>
<hr/>
<pre><code class="hljs language-python" lang="python">loc = page.locator(<span class="hljs-string">'span.text-20px.font-bold'</span>)

<span class="hljs-comment"># 1) 断言存在且唯一</span>
expect(loc).to_have_count(<span class="hljs-number">1</span>)   <span class="hljs-comment"># 多于 1 个会立即失败</span>

<span class="hljs-comment"># 2) 临时高亮 2 秒，肉眼确认</span>
loc.evaluate(<span class="hljs-string">'el =&gt; el.style.border = "3px solid red"'</span>)
page.wait_for_timeout(<span class="hljs-number">2000</span>)
</code></pre>
<p>跑单条用例时一眼就能看到是不是你想找的元素。</p>
<hr/>
<ol start="3">
<li>交互式 REPL —— 边敲边回车</li>
</ol>
<hr/>
<p>官方提供 <strong>sync_playwright 的交互模式</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> playwright.sync_api <span class="hljs-keyword">import</span> sync_playwright
p = sync_playwright().start()
browser = p.chromium.launch(headless=<span class="hljs-literal">False</span>)
page = browser.new_page()
page.goto(<span class="hljs-string">'https://your-site'</span>)
<span class="hljs-comment"># 现在可以随便敲</span>
loc = page.locator(<span class="hljs-string">'button.el-button--primary'</span>)
loc.count()        <span class="hljs-comment"># 立即返回匹配数量</span>
loc.text_content() <span class="hljs-comment"># 立即返回文本</span>
loc.highlight()    <span class="hljs-comment"># 页面直接闪绿框</span>
</code></pre>
<p>调试完把确认好的 locator 复制到正式脚本即可。</p>
<hr/>
<ol start="4">
<li>脚本内“打印调试法”（最轻量）</li>
</ol>
<hr/>
<pre><code class="hljs language-python" lang="python">loc = page.locator(<span class="hljs-string">'span:has-text("崔新")'</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">'匹配数:'</span>, loc.count())      <span class="hljs-comment"># → 1 才继续</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'文本:'</span>, loc.text_content()) <span class="hljs-comment"># → 崔新</span>
</code></pre>
<hr/>
<ol start="5">
<li>常见踩坑 checklist</li>
</ol>
<hr/>
<ul>
<li>元素在 iframe → 先 <code>page.frame_locator('#xxx').locator(...)</code></li>
<li>等待时机不对 → 外加 <code>loc.wait_for()</code> 或 <code>expect(loc).to_be_visible()</code></li>
<li>动态 class 顺序变化 → 用 <code>[class*="text-20px"]</code> 而非完整串</li>
<li>文本前后有空格 → <code>text=/\s*崔新\s*/</code>（Playwright 正则语法）</li>
</ul>
<hr/>
<h2 data-id="heading-0">一句话流程</h2>
<ol>
<li><code>PWDEBUG=1 pytest</code> → Inspector 自动生成 locator</li>
<li>脚本里 <code>expect(loc).to_have_count(1)</code> + <code>loc.highlight()</code> 确认</li>
<li>通过后再集成到完整用例，<strong>基本一次写对</strong>。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于UniappX开发电销APP，实现CRM后台控制APP自动拨号]]></title>    <link>https://juejin.cn/post/7574040813750272051</link>    <guid>https://juejin.cn/post/7574040813750272051</guid>    <pubDate>2025-11-19T09:21:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574040813750272051" data-draft-id="7574270661871812646" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于UniappX开发电销APP，实现CRM后台控制APP自动拨号"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-19T09:21:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱心发电丶"/> <meta itemprop="url" content="https://juejin.cn/user/79577698543709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于UniappX开发电销APP，实现CRM后台控制APP自动拨号
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/79577698543709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱心发电丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:21:03.000Z" title="Wed Nov 19 2025 09:21:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnicen.cn%2F8532.html" target="_blank" title="https://nicen.cn/8532.html" ref="nofollow noopener noreferrer">nicen.cn/8532.html</a></p>
<p>在上一篇文章中（<a href="https://juejin.cn/post/7573528564025802798" target="_blank" title="https://juejin.cn/post/7573528564025802798">juejin.cn/post/757352…</a>），已经实现了电销APP的基础功能：通时通次记录、通话录音上传。 已经能在工作中进行应用了，但是离成熟的电销APP还是差了不少，还得继续开发。</p>
<p>电销APP大都还有一个与之对应的CRM系统，所以另一个常见的需求，就是通过CRM后台直接控制APP拨号。</p>
<p>相关代码和电销APP已经开源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffriend-nicen%2Funicall" target="_blank" title="https://github.com/friend-nicen/unicall" ref="nofollow noopener noreferrer">github.com/friend-nice…</a></p>
<h2 data-id="heading-0">开发思路</h2>
<p>常规需求用常规的办法：在保证消息收发高效实时的前提下，后端实现一个Websocket服务用于和APP用户端实时通信，再通过http提供接口给CRM后台调用，触发APP端拨号。从技术栈匹配度来看，用Node实现这个需求再合适不过了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9b8c8400ad14b87a65b472c91c61f01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5b-D5Y-R55S15Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764148863&amp;x-signature=OrLQt8sA8mUnMA%2FeJYVFnDYEIqs%3D" alt="基于UniappX开发电销APP，实现CRM后台控制APP自动拨号" loading="lazy"/></p>
<h3 data-id="heading-1">1.实现Websocket服务</h3>
<p>考虑到我的需求面向的是Saas多公司的系统，所以先实现一个方便存取ws链接的连接池对象，嵌套的两层Map对象，第一层是区分哪个公司，然后是哪个用户：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> corpClients = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
</code></pre>
<p>通过ws来实现Websocket服务，简单的几行代码，再加上自己的业务逻辑。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> wss = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketServer</span>({<span class="hljs-attr">host</span>: <span class="hljs-string">'0.0.0.0'</span>, <span class="hljs-attr">port</span>: <span class="hljs-variable constant_">CONFIG</span>.<span class="hljs-property">ports</span>.<span class="hljs-property">ws</span>});
  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`WebSocket服务器运行在 ws://localhost:<span class="hljs-subst">${CONFIG.ports.ws}</span>`</span>);

  wss.<span class="hljs-title function_">on</span>(<span class="hljs-string">'connection'</span>, <span class="hljs-function">(<span class="hljs-params">ws, req</span>) =&gt;</span> {

    <span class="hljs-keyword">let</span> ip = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-real-ip'</span>]
        || req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-forwarded-for'</span>]?.<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>)[<span class="hljs-number">0</span>].<span class="hljs-title function_">trim</span>()
        || req.<span class="hljs-property">socket</span>.<span class="hljs-property">remoteAddress</span>;

    <span class="hljs-keyword">if</span> (ip.<span class="hljs-title function_">substr</span>(<span class="hljs-number">0</span>, <span class="hljs-number">7</span>) === <span class="hljs-string">'::ffff:'</span>) ip = ip.<span class="hljs-title function_">substr</span>(<span class="hljs-number">7</span>);

    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">debug</span>(<span class="hljs-string">`新的WebSocket连接，<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({remoteAddress: ip, url: req.url})}</span>`</span>);
    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`当前连接数: <span class="hljs-subst">${getConnectionCount()}</span>`</span>);

    ws.<span class="hljs-title function_">on</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (ws.<span class="hljs-property">corp</span> &amp;&amp; ws.<span class="hljs-property">phone</span>) {
        <span class="hljs-keyword">const</span> companyMap = corpClients.<span class="hljs-title function_">get</span>(ws.<span class="hljs-property">corp</span>);
        <span class="hljs-keyword">if</span> (companyMap) {
          companyMap.<span class="hljs-title function_">delete</span>(ws.<span class="hljs-property">phone</span>);
          <span class="hljs-keyword">if</span> (companyMap.<span class="hljs-property">size</span> === <span class="hljs-number">0</span>) corpClients.<span class="hljs-title function_">delete</span>(ws.<span class="hljs-property">corp</span>);
        }
        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">debug</span>(<span class="hljs-string">'WebSocket连接关闭'</span>, {<span class="hljs-attr">phone</span>: ws.<span class="hljs-property">phone</span>, <span class="hljs-attr">corp</span>: ws.<span class="hljs-property">corp</span>, <span class="hljs-attr">remainingClients</span>: <span class="hljs-title function_">getConnectionCount</span>()});
      }
    });

    ws.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'WebSocket连接错误'</span>, error);
      <span class="hljs-keyword">if</span> (ws.<span class="hljs-property">corp</span> &amp;&amp; ws.<span class="hljs-property">phone</span>) {
        <span class="hljs-keyword">const</span> companyMap = corpClients.<span class="hljs-title function_">get</span>(ws.<span class="hljs-property">corp</span>);
        <span class="hljs-keyword">if</span> (companyMap) {
          companyMap.<span class="hljs-title function_">delete</span>(ws.<span class="hljs-property">phone</span>);
          <span class="hljs-keyword">if</span> (companyMap.<span class="hljs-property">size</span> === <span class="hljs-number">0</span>) corpClients.<span class="hljs-title function_">delete</span>(ws.<span class="hljs-property">corp</span>);
        }
      }
    });
  });
</code></pre>
<p>考虑到用户连接之后，得区分这个连接是哪个用户，所以还得有一个类似登录的过程，登录之后的链接才会保存到连接池。</p>
<pre><code class="hljs language-javascript" lang="javascript">ws.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">body</span>) =&gt;</span> {

      <span class="hljs-keyword">const</span> data = body.<span class="hljs-title function_">toString</span>();
      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`收到消息：<span class="hljs-subst">${data}</span>，<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({remoteAddress: ip})}</span>`</span>);

      <span class="hljs-comment">/* 维持心跳 */</span>
      <span class="hljs-keyword">if</span> (data === <span class="hljs-string">'ping'</span>) {
        ws.<span class="hljs-title function_">send</span>(<span class="hljs-string">"1"</span>);
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> msg = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
        <span class="hljs-keyword">if</span> (!ws.<span class="hljs-property">phone</span> &amp;&amp; msg.<span class="hljs-property">type</span> === <span class="hljs-string">'login'</span>) {
          <span class="hljs-keyword">if</span> (msg?.<span class="hljs-property">name</span> &amp;&amp; msg?.<span class="hljs-property">corp</span>) {
            <span class="hljs-keyword">const</span> phone = msg.<span class="hljs-property">name</span>;
            <span class="hljs-keyword">const</span> corp = <span class="hljs-title class_">String</span>(msg.<span class="hljs-property">corp</span>);
            <span class="hljs-keyword">let</span> companyMap = corpClients.<span class="hljs-title function_">get</span>(corp);
            <span class="hljs-keyword">if</span> (!companyMap) {
              companyMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
              corpClients.<span class="hljs-title function_">set</span>(corp, companyMap);
            }
            <span class="hljs-keyword">const</span> existingClient = companyMap.<span class="hljs-title function_">get</span>(phone);
            <span class="hljs-keyword">if</span> (existingClient) {
              <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`禁止重复登录，通知<span class="hljs-subst">${phone}</span>自动退出！`</span>);
              existingClient.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({<span class="hljs-attr">type</span>: <span class="hljs-string">'quit'</span>, <span class="hljs-attr">name</span>: phone}));
              companyMap.<span class="hljs-title function_">delete</span>(phone);
            }
            <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`新消息：<span class="hljs-subst">${phone}</span>上线`</span>);
            ws.<span class="hljs-property">phone</span> = phone;
            ws.<span class="hljs-property">corp</span> = corp;
            companyMap.<span class="hljs-title function_">set</span>(phone, ws);
          }
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'处理WebSocket消息失败'</span>, error);
      }
    });
</code></pre>
<p>提示：考虑到安全性的问题，可以继续完善做进一步的认证</p>
<h3 data-id="heading-2">2.实现http接口</h3>
<p>CRM后台唤起拨号的这个操作是不定时不定量的，所以不需要考虑到实时性的问题，所以通过提供http接口来实现是完全够用的。</p>
<p>通过Hono来快速实现接口，然后调用上面保存的连接池来向APP发送实时消息：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hono</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">param</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">c</span>) =&gt; {
    <span class="hljs-keyword">let</span> data = {};
    <span class="hljs-keyword">const</span> queryParams = c.<span class="hljs-property">req</span>.<span class="hljs-title function_">query</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(queryParams).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) data = {...data, ...queryParams};
    <span class="hljs-keyword">if</span> (c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span> === <span class="hljs-string">'POST'</span>) {
        <span class="hljs-keyword">const</span> contentType = c.<span class="hljs-property">req</span>.<span class="hljs-title function_">header</span>(<span class="hljs-string">'content-type'</span>) || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (contentType.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'application/json'</span>)) {
                <span class="hljs-keyword">const</span> jsonData = <span class="hljs-keyword">await</span> c.<span class="hljs-property">req</span>.<span class="hljs-title function_">json</span>();
                data = {...data, ...jsonData};
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contentType.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'multipart/form-data'</span>) || contentType.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'application/x-www-form-urlencoded'</span>)) {
                <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">await</span> c.<span class="hljs-property">req</span>.<span class="hljs-title function_">parseBody</span>();
                data = {...data, ...formData};
            }
        } <span class="hljs-keyword">catch</span> (parseError) {
            <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'解析请求数据失败'</span>, parseError);
        }
    }
    <span class="hljs-keyword">return</span> data;
};

app.<span class="hljs-title function_">all</span>(<span class="hljs-string">'/send'</span>, <span class="hljs-keyword">async</span> (c) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">param</span>(c);
        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">debug</span>(<span class="hljs-string">'收到请求'</span>, data);
        <span class="hljs-keyword">if</span> (!!data.<span class="hljs-property">phone</span> &amp;&amp; !!data.<span class="hljs-property">name</span> &amp;&amp; !!data.<span class="hljs-property">type</span> &amp;&amp; !!data.<span class="hljs-property">corp</span>) {
            <span class="hljs-keyword">const</span> companyMap = corpClients.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">String</span>(data.<span class="hljs-property">corp</span>));
            <span class="hljs-keyword">const</span> client = companyMap ? companyMap.<span class="hljs-title function_">get</span>(data.<span class="hljs-property">name</span>) : <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (!client) <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({<span class="hljs-attr">code</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'你的APP账号没有上线！'</span>}, <span class="hljs-number">200</span>);
            client.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)); <span class="hljs-comment">/* 操作 */</span>
            <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({<span class="hljs-attr">code</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'ok'</span>});
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({<span class="hljs-attr">code</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'fail'</span>});
        }
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'处理webhook请求失败'</span>, error);
        <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({<span class="hljs-attr">code</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'error'</span>}, <span class="hljs-number">200</span>);
    }
});

<span class="hljs-title function_">serve</span>({<span class="hljs-attr">fetch</span>: app.<span class="hljs-property">fetch</span>, <span class="hljs-attr">port</span>: <span class="hljs-variable constant_">CONFIG</span>.<span class="hljs-property">ports</span>.<span class="hljs-property">http</span>}, <span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {
    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`HTTP服务器运行在 http://localhost:<span class="hljs-subst">${info.port}</span>`</span>);
    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`调试模式: <span class="hljs-subst">${CONFIG.debug ? <span class="hljs-string">'开启'</span> : <span class="hljs-string">'关闭'</span>}</span>`</span>);
});

<span class="hljs-keyword">return</span> app;
</code></pre>
<h3 data-id="heading-3">3.APP端初始化Ws链接</h3>
<p>App端运行的稳定性没法保证，所以需要考虑各种极端条件，保证Ws连接的稳定性。下面是通过Vueuse来实现的Ws，Vuesuse已经封装好了自动重连、心跳包等逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* 链接websocket */</span>
<span class="hljs-keyword">const</span> {status, data, close, open, send, ws} = <span class="hljs-title function_">useWebSocket</span>(api.<span class="hljs-property">ws</span>, {
    <span class="hljs-title function_">onConnected</span>(<span class="hljs-params">ws</span>) {
        ws.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'login'</span>,
            <span class="hljs-attr">corp</span>: user.<span class="hljs-property">corp</span>.<span class="hljs-property">id</span>,
            <span class="hljs-attr">name</span>: user.<span class="hljs-property">username</span>
        }));
    },
    <span class="hljs-title function_">onMessage</span>(<span class="hljs-params">ws, event</span>) {

        <span class="hljs-comment">/* 接受数据 */</span>
        <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span> === <span class="hljs-string">"1"</span>) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>);

        <span class="hljs-comment">/* 处理，后台应用弹出 */</span>
        <span class="hljs-title function_">moveTop</span>();

        <span class="hljs-comment">/* 登录同一个账号，退出登录 */</span>
        <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> === <span class="hljs-string">"quit"</span>) {
            <span class="hljs-title function_">quit________system</span>();
            <span class="hljs-keyword">return</span> load.<span class="hljs-title function_">info</span>(<span class="hljs-string">'您的账号在别处登录'</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> === <span class="hljs-string">"call"</span>) {
            <span class="hljs-title function_">call</span>({<span class="hljs-attr">phone</span>: data.<span class="hljs-property">phone</span>});
        }

    },
    <span class="hljs-attr">heartbeat</span>: {
        <span class="hljs-attr">interval</span>: <span class="hljs-number">5000</span>
    },
    <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">autoClose</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">autoReconnect</span>: <span class="hljs-literal">true</span>
});
</code></pre>
<p>继续封装，用户登录的时候初始化链接，用户退出的时候自动断开：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/* 初始化监听：监控用户 token 登录与退出，自动建立/关闭 ws */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initWsWatch</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">/* 用户信息 */</span>
    <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">_user</span>();
    <span class="hljs-comment">/* 监听 token 变化：有值则连接，无值则关闭并重置 */</span>
    <span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> user.<span class="hljs-property">token</span>, <span class="hljs-function">(<span class="hljs-params">token</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (token) {
            <span class="hljs-title function_">connectWs</span>();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">disconnectWs</span>(<span class="hljs-literal">true</span>);
        }
    }, {<span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>});
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini 3.0 发布，Antigravity 掀桌，程序员何去何从？]]></title>    <link>https://juejin.cn/post/7574217823105548339</link>    <guid>https://juejin.cn/post/7574217823105548339</guid>    <pubDate>2025-11-19T09:26:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574217823105548339" data-draft-id="7574040813750288435" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini 3.0 发布，Antigravity 掀桌，程序员何去何从？"/> <meta itemprop="keywords" content="后端,AI编程,Gemini"/> <meta itemprop="datePublished" content="2025-11-19T09:26:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="该用户已不存在"/> <meta itemprop="url" content="https://juejin.cn/user/64217584778579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini 3.0 发布，Antigravity 掀桌，程序员何去何从？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/64217584778579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    该用户已不存在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:26:02.000Z" title="Wed Nov 19 2025 09:26:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>昨天，谷歌不开任何发布会，直接甩出了一枚重磅炸弹——Gemini 3.0。</p>
<p>这一波更新来得猝不及防。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Ffeatures%2Follama" target="_blank" title="https://www.servbay.com/features/ollama" ref="nofollow noopener noreferrer">Gemini 3.0</a> 不仅第一时间登陆了 AI Studio 和 Gemini CLI，还直接渗透到了开发者最常用的工具链里：Cursor、GitHub Copilot、JetBrains 全家桶，以及 Cline。甚至连谷歌自家的一系列产品，今天起也都集成了 Gemini 3 Pro 预览版。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c20b1ba099af4780bff19760fc21d871~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149161&amp;x-signature=KZyKXFrXHx1AsSrNzUwS415ckh0%3D" alt="" loading="lazy"/></p>
<p>伴随模型发布，谷歌还掏出了一个全新的开发平台，<strong>Google Antigravity</strong>。谷歌说这是 VS Code 的分支，但它的野心显然不在于做一个编辑器，而是试图将开发模式从编写代码转向任务导向的一次尝试。</p>
<h3 data-id="heading-0">Gemini 3.0 多项基准测试碾压一众模型</h3>
<p>在深入了解 Antigravity 之前，先来了解一下 Gemini 3.0 的三个主要技术特点。</p>
<h4 data-id="heading-1"><strong>逻辑推理能力的提升</strong></h4>
<p>Gemini 3 Pro 在 LMArena 等基准测试中取得了 1501 的高分，显示出接近博士水平的逻辑推理能力。</p>
<p>此外，谷歌还引入了 <strong>Gemini 3 Deep Think</strong> 模式。与普通版的快速响应不同，Deep Think 模式类似于人类的慢思考，在回答前会进行深度的思维链推导，专门用于解决数学、科学及复杂逻辑问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3965545fe7f4b9d87774ae4c39ac768~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149161&amp;x-signature=x2f8Kq756CDaP3%2B2yW3gKI5hnjo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-2"><strong>从生成内容到生成界面</strong></h4>
<p>Gemini 3.0 引入了 Generative UI（生成式界面）。传统的 AI 问答通常返回文本或代码片段，而 Gemini 3.0 支持生成完整的交互式界面。例如查询贷款计算方式时，模型可以直接构建一个包含滑块和输入框的计算器应用界面，而非仅仅列出计算公式。</p>
<h4 data-id="heading-3"><strong>对抽象风格的理解</strong></h4>
<p>新版本强调了对Vibe Coding（氛围感编程）的支持。模型能够理解较为抽象、模糊的需求描述。开发者无需提供法律条文般严谨的指令，只需描述想要的设计风格（如赛博朋克风、故障艺术感），模型即可将其转化为具体的代码实现。</p>
<h3 data-id="heading-4">重点解析：Antigravity 与任务导向型开发</h3>
<p>Antigravity 是此次发布的重头戏。据说这是谷歌基于 VS Code 开发的分支版本，谷歌的亲儿子，但其核心逻辑发生了根本性转变。</p>
<h4 data-id="heading-5"><strong>从文件导向到智能体导向</strong></h4>
<p>传统 IDE 的工作流围绕文件展开：打开文件、编写代码、手动运行。Antigravity 的工作流则围绕智能体（Agent）展开。其核心理念是让开发者从繁琐的实现细节中抽离，转向更高层次的任务管理。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/192503d55d6746d1b9affc0ccd13a597~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149161&amp;x-signature=go%2FDq0xFoGYVOunfCMgG3ta%2FF54%3D" alt="" loading="lazy"/></p>
<p><strong>Antigravity 的工作机制：</strong></p>
<ol>
<li>
<p><strong>任务下发</strong>：开发者以自然语言描述完整需求，例如“构建一个航班追踪器，界面简洁并支持实时更新”。</p>
</li>
<li>
<p><strong>任务拆解</strong>：平台内置的智能体自动将需求拆解为具体的技术步骤。</p>
</li>
<li>
<p><strong>全链路执行</strong>：Antigravity 深度集成了 <strong>Gemini 2.5 Computer Use</strong> 模型。这使得智能体不仅具备编写代码的能力，还拥有浏览器自动化操作的能力。智能体可以编写代码，随后自动打开浏览器进行测试，模拟点击、输入，并在发现错误时自动返回编辑器修正代码。</p>
</li>
<li>
<p><strong>本地与云端协同</strong>：配合最新的 Nano Banana 技术，整个开发过程在本地环境与云端资源之间进行调度。</p>
</li>
</ol>
<p>这种模式将开发者的角色从代码录入者转变为任务指挥官。</p>
<h3 data-id="heading-6">对初级开发岗位的冲击与转型</h3>
<p>Antigravity 展示了一种可能性，那就是基础的代码编写、测试和调试工作，正逐渐被 AI 接管。对于技能仅限于将需求直译为基础代码，或依赖网络搜索复制粘贴的初级程序员而言，职业空间确实面临压缩。</p>
<p>然而，这并不意味着程序员这一职业的消亡，而是职能的向上迁移。未来的开发趋势指向懂代码的架构师。</p>
<p><strong>开发者的新核心竞争力：</strong></p>
<ul>
<li>
<p><strong>代码审查能力</strong>：AI 能够生成代码，但也可能产生幻觉或逻辑漏洞。开发者必须具备阅读和审查 AI 产出的能力，以确保系统的安全性与稳定性。</p>
</li>
<li>
<p><strong>任务拆解与指令工程</strong>：Antigravity 的执行效率取决于指令的清晰度。如何将模糊的业务需求转化为 AI 可精准执行的技术任务，将成为关键技能。</p>
</li>
<li>
<p><strong>系统架构思维</strong>：AI 擅长执行具体的战术任务（如编写函数），但在宏观的战略布局（如高可用架构设计）上仍需人类把控。</p>
</li>
</ul>
<p>初级程序员应当减少对语法细节的死记硬背，转而投入到系统设计原理与调试逻辑的学习中。</p>
<h3 data-id="heading-7">快速构建本地开发环境</h3>
<p>对于希望第一时间体验 Gemini 3.0 新特性（特别是 Gemini CLI）的开发者来说，配置基础环境往往是第一道门槛。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com" target="_blank" title="https://www.servbay.com" ref="nofollow noopener noreferrer">Node.js 环境</a>的配置、版本管理常常耗费大量精力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b30167c4ff149a690f4d0ba1d554da1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149161&amp;x-signature=q2GFcow8lOqUX8cM6Hn2FnAADwQ%3D" alt="" loading="lazy"/></p>
<p>此时，ServBay 是一个高效的解决方案。ServBay 专为开发者设计，旨在简化本地开发环境的部署流程.</p>
<ul>
<li>
<p><strong>环境配置</strong>：支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Ffeatures%2Fnodejs" target="_blank" title="https://www.servbay.com/features/nodejs" ref="nofollow noopener noreferrer">一键部署 Node.js 环境</a>，无需处理复杂的环境变量和版本冲突，方便开发者快速运行 Gemini CLI。</p>
</li>
<li>
<p><strong>本地 AI 部署</strong>：ServBay 同样支持一键部署本地 AI 模型。开发者可以在本地运行 Gemma、Qwen 3 等开源模型，方便与 Gemini 3.0 进行对比测试，既满足了隐私需求，也便于低延迟调试。</p>
</li>
</ul>
<h3 data-id="heading-8"><strong>结语</strong></h3>
<p>Gemini 3.0 与 Antigravity 的出现，降低了写代码的门槛，却提高了构建软件”=的标准。工具的进化旨在释放生产力，开发者只需善用工具，从繁杂的重复劳动中脱身，专注于更有价值的创造与设计。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[软件苹果商城上架的流程与团队协作模式 一个项目从开发到发布的完整经历]]></title>    <link>https://juejin.cn/post/7574230586970849286</link>    <guid>https://juejin.cn/post/7574230586970849286</guid>    <pubDate>2025-11-19T09:25:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574230586970849286" data-draft-id="7574084898879160361" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="软件苹果商城上架的流程与团队协作模式 一个项目从开发到发布的完整经历"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T09:25:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aiopencode"/> <meta itemprop="url" content="https://juejin.cn/user/1898230261493865"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            软件苹果商城上架的流程与团队协作模式 一个项目从开发到发布的完整经历
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1898230261493865/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aiopencode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:25:50.000Z" title="Wed Nov 19 2025 09:25:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在很多技术团队里，“软件苹果商城上架” 常常被安排在项目周期的末尾，甚至被视为上线前的最后一道关卡。
但经历过多次 iOS 上架之后，你会发现——这不是简单的“把 IPA 传上去”，而是一段涉及角色分工、工具链协同、发布审核管理的完整流程。</p>
<p>在这篇文章中，我将以一个真实团队的视角，讲述我们如何把一款跨平台 App 成功上架到苹果商城（App Store），重点分享工程侧如何配合产品、设计、测试等角色，在没有单一 Mac 依赖的情况下完成上架流程。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、项目收尾阶段：上架并不是“最后一个动作”</strong></h2>
<p>在我们团队的项目中，上架准备往往从开发的后期就开始了。
原因很简单：苹果商城的要求并不只是“技术打包”，还包含大量信息配置和内容校验，例如：</p>
<ul>
<li>软件名称、简介、关键词</li>
<li>权限用途说明</li>
<li>隐私政策 URL</li>
<li>不同设备尺寸的截图</li>
<li>年龄分级问卷</li>
<li>App 类别、版权信息</li>
</ul>
<p>这意味着产品、设计、运营、后端甚至法务都参与其中。</p>
<p>因此，当代码进入稳定阶段时，我们就同步启动“上架准备任务”，让所有角色提前介入，而不是等到开发结束后才匆忙处理。</p>
<hr/>
<h2 data-id="heading-1"><strong>二、证书体系准备：技术团队的责任“链路起点”</strong></h2>
<p>对于技术团队来说，iOS 证书永远是上架链路的第一步。</p>
<p>在这个项目中，我们团队中有成员使用 Windows，也有人使用 Mac，而证书必须集中管理，因此我们采取以下策略：</p>
<h3 data-id="heading-2"><strong>策略 1：证书统一生成、统一保存</strong></h3>
<p>不允许“每个人自己弄一套证书”，这样会导致发布混乱。</p>
<h3 data-id="heading-3"><strong>策略 2：使用开心上架（Appuploader）跨平台生成证书，避免强依赖 Mac</strong></h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c13cafd98eb841cdb3bce19e8b86616a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWlvcGVuY29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149150&amp;x-signature=OP2Uosi7N2Xo9SFF8%2FdgSS7%2FSNc%3D" alt="证书" loading="lazy"/></p>
<p>输出内容：</p>
<ul>
<li>p12 证书</li>
<li>provisioning profile</li>
<li>可供整个团队使用的签名文件</li>
</ul>
<p>这样，无论开发者使用的是 Windows、Linux 还是 macOS，都可以拿到统一证书构建 IPA，不再依赖某个人或某台 Mac。</p>
<hr/>
<h2 data-id="heading-4"><strong>三、构建 IPA：跨平台开发团队的多路径实践</strong></h2>
<p>我们的项目基于跨平台技术（部分页面原生、部分页面使用 uni-app），所以构建方式是多样化的：</p>
<h3 data-id="heading-5"><strong>方式 1：原生模块使用 Mac + Xcode 构建</strong></h3>
<p>核心模块依然需要通过 Mac 进行 Xcode 打包。</p>
<h3 data-id="heading-6"><strong>方式 2：uni-app 页面使用云打包服务</strong></h3>
<p>Windows 成员可以直接提交资源，由云端完成 IPA 构建。</p>
<h3 data-id="heading-7"><strong>方式 3：CI 自动打包（自动化 pipeline）</strong></h3>
<p>我们还配置了一个 GitLab Runner，主要用于：</p>
<ul>
<li>每次发布自动打包</li>
<li>保存多个构建版本</li>
<li>自动化测试覆盖基础功能</li>
</ul>
<p>最终，我们能在任意环境中可靠产出 IPA，不再受限于某台 Mac。</p>
<hr/>
<h2 data-id="heading-8"><strong>四、上传 IPA：发布团队最关注的环节</strong></h2>
<p>在我们的流程中，“上传 IPA 到苹果商城后台（App Store Connect）” 是发布阶段最关键的一步。</p>
<p>官方方式只能在 Mac 上执行，例如：</p>
<ul>
<li>Transporter</li>
<li>Xcode Organizer</li>
</ul>
<p>但我们的团队分布式办公，并不是每个人都有 Mac，因此上传环节必须做到 <strong>跨平台</strong>。</p>
<h3 data-id="heading-9"><strong>我们使用的上传方式：开心上架（Appuploader）命令行发布（全平台适配）</strong></h3>
<p>示例命令：</p>
<pre><code class="hljs language-bash" lang="bash">appuploader_cli -u ios@team.com -p xxx-xxx-xxx-xxx -c 2 -f ./build/release.ipa
</code></pre>
<p>这条命令会将 IPA 上传到 App Store Connect → TestFlight → 构建版本列表。</p>
<p>这个方式的好处非常明显：</p>
<ul>
<li>Windows、Linux、macOS 全团队成员可执行</li>
<li>上传日志清晰，易于排查问题</li>
<li>支持集成到 CI/CD，发布流程自动化</li>
<li>不再担心“Mac 离线、软件崩溃”等问题</li>
</ul>
<p>对我们这种跨系统团队来说，这是非常可靠的解决方案。
同时还有图形化界面：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7db35f53a374023bc48d1c093a1acbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWlvcGVuY29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149150&amp;x-signature=Y4Ia5RaOmoFXH8l0TsJD4JmSxkI%3D" alt="上传" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-10"><strong>五、准备上架素材：产品与设计的“信息工作”</strong></h2>
<p>技术侧把 IPA 与签名准备好之后，接下来就是 App Store Connect 中大量的内容填充工作。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b006964636924d19b29654ad860647fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWlvcGVuY29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149150&amp;x-signature=e4ZLw%2FDUNyXFColDBEa3YGFoFM4%3D" alt="asc" loading="lazy"/></p>
<h3 data-id="heading-11">产品填写的内容包括：</h3>
<ul>
<li>软件名称、描述、关键词</li>
<li>隐私政策链接</li>
<li>版本更新说明</li>
<li>分类（主类目、次类目）</li>
</ul>
<h3 data-id="heading-12">设计团队需要：</h3>
<ul>
<li>提供 iPhone（6.5 / 5.5）截图</li>
<li>若适配 iPad，还需提供 iPad 截图</li>
<li>App 预览视频（可选）</li>
</ul>
<h3 data-id="heading-13">我们的做法</h3>
<p>通过一个共享文档（Notion/飞书文档）来统一所有上架内容，避免遗漏和重复沟通。</p>
<hr/>
<h2 data-id="heading-14"><strong>六、审核阶段：从风险控制到沟通策略</strong></h2>
<p>苹果审核严格，但逻辑明确。
从我们多次上架的经验看，最常见的拒审理由包括：</p>



































<table><thead><tr><th>典型问题</th><th>审核意见</th><th>实际处理方式</th></tr></thead><tbody><tr><td>启动闪退</td><td>无法正常体验</td><td>增加真机测试覆盖</td></tr><tr><td>截图与实际不符</td><td>有误导性</td><td>重新提供真实截图</td></tr><tr><td>隐私用途描述缺失</td><td>违反 5.1.1</td><td>补充 Info.plist 文案</td></tr><tr><td>第三方登录异常</td><td>无法登录</td><td>检查 OAuth 配置</td></tr><tr><td>内容未达到要求</td><td>信息不完整</td><td>按提示补充</td></tr></tbody></table>
<p>为了减少返工，我们建立了“审核风险清单”，每次提交前都逐项检查。</p>
<hr/>
<h2 data-id="heading-15">团队最终交付：让上架成为“稳定流程”而非“临时任务”</h2>
<p>软件苹果商城上架必须成为“团队协作链路的一部分”，而不是放在最后的临时动作。</p>
<p>我们最终形成了一套可复用的上架流程：</p>
<ol>
<li>跨平台证书统一创建与管理</li>
<li>多构建方式并行产出 IPA</li>
<li>开心上架（Appuploader）跨系统上传通道保证发布可靠性</li>
<li>App Store Connect 素材由产品与设计提前准备</li>
<li>建立审核风险清单</li>
<li>发布记录自动归档</li>
</ol>
<p>这套流程让我们之后的每次上架都变得稳定、可控、易管理。
参考教程:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.applicationloader.net%2Ftutorial%2Fzh%2F83%2F83.html" target="_blank" title="https://www.applicationloader.net/tutorial/zh/83/83.html" ref="nofollow noopener noreferrer">www.applicationloader.net/tutorial/zh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分享一名海外独立开发者的 AI 编程工作流]]></title>    <link>https://juejin.cn/post/7574045294612299811</link>    <guid>https://juejin.cn/post/7574045294612299811</guid>    <pubDate>2025-11-19T09:29:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574045294612299811" data-draft-id="7574250031248097314" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分享一名海外独立开发者的 AI 编程工作流"/> <meta itemprop="keywords" content="人工智能,LLM,AI编程"/> <meta itemprop="datePublished" content="2025-11-19T09:29:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Baihai_IDP"/> <meta itemprop="url" content="https://juejin.cn/user/3123071228582343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分享一名海外独立开发者的 AI 编程工作流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3123071228582343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Baihai_IDP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:29:07.000Z" title="Wed Nov 19 2025 09:29:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>编者按：</strong> 当 AI 编程智能体宣称能自动化一切时，我们是否在工具与概念的丛林中迷失了方向，反而忘记了如何最简单、直接地解决问题？</p>
<p>本文的核心主张尖锐而明确：与其追逐繁杂的“智能体套件”、子智能体（Subagents）、RAG 等概念，不如回归本质 —— 选择一个强大且高效的模型，像与一位靠谱的工程师同事那样，通过简洁的对话和直觉性的协作来直接解决问题。作者直言不讳地批评了当前生态中许多“华而不实”的工具，认为它们不过是绕开模型本身低效的临时补丁，并分享了他如何用多个终端窗口和经典工具（如 tmux）实现比许多专用工具更灵活、更可控的工作流。</p>
</blockquote>
<p><strong>本文系原作者观点，Baihai IDP 仅进行编译分享</strong></p>
<p><strong>作者 | Peter Steinberger</strong></p>
<p><strong>编译 | 岳扬</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a839239bfda34a20ae1e2b5c1c1ec417~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149347&amp;x-signature=7v4gAVRhqX2rllKELux06AOLrKA%3D" alt="image.png" loading="lazy"/></p>
<p>最近我没怎么在社交平台上活跃，因为我正全身心投入到最新的项目中。如今，智能体工程（Agentic engineering）已经变得非常强大，几乎能编写出我需要的 100% 的代码。然而，我却看到很多人还在费力解决本不该存在的问题，搞出一堆繁复的表演，而不是专注把事搞定。</p>
<p><strong>这篇文章的部分灵感来自最近在伦敦参加的“Claude Code Anonymous”活动[1]上的对话，另一部分则是因为距离我上次更新工作流已经整整一年（还是 AI 年[2]😏）。是时候做个回顾了。</strong></p>
<p>所有基础理念依然适用，像上下文管理这类简单内容本文不再赘述。想了解基础内容，请阅读我之前写的《Optimal AI Workflow》[3]一文。</p>
<h2 data-id="heading-0"><strong>01 我的工作背景与技术栈</strong></h2>
<p>我是一名独立开发者，当前开发的项目是一个约 30 万行代码的 TypeScript React 应用，外加一个 Chrome 扩展、一个 CLI 工具、一个基于 Tauri 的客户端应用，以及一个使用 Expo 的移动应用。网站托管在 Vercel 上，每次 PR 后大约两分钟就能测试新版本，其他应用尚未实现自动化部署。</p>
<h2 data-id="heading-1"><strong>02 我所使用的技术工具和处理开发任务的总体思路</strong></h2>
<p>我已完全改用 codex cli 作为主力工具。通常我会在一个 3x3 的终端网格中同时运行 3 到 8 个实例，它们大多位于同一目录[4]，部分实验性任务则会放在独立文件夹中。我尝试过 worktrees、PR 等方式，但总会回到当前这套配置，因为它能最快地把事情做完。</p>
<p>我的智能体（agents）会自行执行原子化的 Git commits[5]。为了保持相对干净的 commit 历史，我在 agent 配置文件[6]上反复迭代优化。这样一来，Git 操作更精准，每个智能体只提交它实际修改过的文件。</p>
<p>是的，用 Claude 你可以设置 hooks（译者注：可能是 git commit hook），而 codex 目前还不支持 hooks，但大模型极其聪明 —— 一旦它们下定决心，没有任何 hook 能拦得住[7]。</p>
<p>过去我曾因此被嘲讽为垃圾代码制造机[8]，如今看到并行运行智能体的做法逐渐成为主流[9]，深感欣慰。</p>
<h2 data-id="heading-2"><strong>03 模型选择</strong></h2>
<p>我几乎所有的开发工作都交由 gpt-5-codex 在“medium 配置”下完成。它在智能程度与速度之间取得了极佳的平衡，还能自动调节思考深度。我发觉过度纠结这些设置并无明显的回报，而且不用操心“超深度思考”（ultrathink）的感觉真的很轻松。</p>
<h3 data-id="heading-3"><strong>3.1 爆炸半径 💥</strong></h3>
<p>每次工作时，我都会考量“爆炸半径” —— 这个词不是我发明的，但我非常喜欢。当构思某个改动时，我基本能预判其耗时及波及的文件范围。我可以向代码库投掷多枚“小手雷”，或是一发“胖子”配几颗小炸弹。但如果你同时扔下多个大炸弹，就几乎不可能做出隔离良好的提交，一旦出错也更难回滚。</p>
<p>这同时也是我观察智能体运行时的一个重要指标。如果某项任务耗时超出预期，我会直接按 Esc，然后问一句“当前状态如何？”来获取任务进度，再决定是帮模型调整方向、中止任务，还是继续执行。<strong>别害怕在中途打断模型 —— 文件修改是原子性的，它们非常擅长接续未完成的工作。</strong></p>
<p>当我对改动的影响不确定时，会先让模型“在修改前给我几个选项”，以此评估影响范围。</p>
<h3 data-id="heading-4"><strong>3.2 为何不用 Worktree？</strong></h3>
<p>我始终只运行一个开发服务器。在迭代项目时，我会通过实时操作界面，一次性测试多处改动。如果为每个功能变更都创建独立的工作树（worktree）或分支（branch），会严重拖慢我的测试流程。而同时启动多个开发服务器又会带来不必要的操作负担。此外，我的项目受 Twitter OAuth 规则限制，只能注册有限数量的回调域名，这从客观上也不支持多环境并行的开发方式。</p>
<h3 data-id="heading-5"><strong>3.3 那 Claude Code 呢？</strong></h3>
<p>我曾经很喜欢 Claude Code，但如今实在受不了了（即便 codex 对其赞誉有加[10]）。那种语言风格、那种斩钉截铁的“绝对正确”[11]、那种测试明明失败却宣称“100%满足生产要求”的语气——实在令人无法继续。相比之下，codex 更像是那个内向但靠谱的工程师：默默推进，把事情做完。它在开始工作前会读取更多文件，因此即使是简短的提示词，通常也能精准实现我想要的效果。</p>
<p>在我关注的信息流中，大家已普遍认为 codex 才是当前的首选[12-13]。</p>
<h3 data-id="heading-6"><strong>3.4 codex 的其他优势</strong></h3>
<ul>
<li><strong>约 23 万的可用上下文（context），而 Claude 只有 15.6 万。</strong> 是的，如果你运气好或愿意按 API 定价付费，Sonnet 确实有 100 万上下文，但现实中 Claude 在耗尽上下文之前就已经开始胡言乱语了，所以这个超长上下文实际上并不可用。</li>
<li><strong>更高的 token 利用效率。</strong> 我不知道 OpenAI 做了什么不同处理，但我的上下文空间在 codex 中消耗得明显更慢。用 Claude 时我经常看到 “Compacting…” 提示，而在 Codex 中我极少触及上下文上限。</li>
<li><strong>消息队列（Message Queuing）。</strong> Codex 支持消息排队[14]。Claude 以前也有这功能，但几个月前改成了“消息会实时引导模型”的机制。如果我想引导 codex，只需按 Esc 再回车就能发送新消息。能同时选择“排队”或“即时干预”显然更好。我经常一次性将多个相关功能任务放入队列，它总能可靠地逐个完成。</li>
<li>速度。<strong>OpenAI 用 Rust 重写了 codex，效果立竿见影 —— 响应速度快得惊人。</strong> 而用 Claude Code 时，我经常遇到数秒的卡顿，内存占用动辄飙到几个 GB。还有终端显示的闪烁问题，尤其是在用 Ghostty 时。Codex 完全没有这些问题，感觉极其轻量、流畅。</li>
<li><strong>语言风格。</strong> 这点对我的心理健康真的很重要[15]。我曾无数次对 Claude 大吼大叫，但很少对 codex 发火。哪怕 codex 模型能力稍弱，光凭这一点我也愿意用它。只要你两个都用上几周，就懂我在说什么。</li>
<li><strong>不会到处乱生成 markdown 文件</strong>[16]。懂的都懂（IYKYK）[17]。</li>
</ul>
<h3 data-id="heading-7"><strong>3.5 为何不选用其他开发工具</strong></h3>
<p>在我看来，终端用户和大模型公司之间其实没有太多中间空间。我目前通过订阅获得的性价比远高于其他方式。我现在有 4 个 OpenAI 订阅和 1 个 Anthropic 订阅，每月总花费大约 1000 美元，基本可以享受“无限 token”的使用体验。如果改用 API 调用，成本大概会高出 10 倍。别太较真这个数字——我用过像 ccusage 这样的 token 统计工具，数据多少有些不精确，但即便只是五倍，也已是相当划算的交易了。</p>
<p>我很欣赏像 amp 或 Factory 这样的工具，但我不认为它们能长期存活。无论是 codex 还是 Claude Code，每个版本都在变得更强，而且功能理念正在快速趋同。某些工具可能在待办列表、引导控制或细微的开发者体验（DX）上暂时领先，但我不觉得它们能真正超越大型 AI 公司。</p>
<p>amp 已经不再以 GPT-5 为核心驱动，转而称其为“Oracle”（神谕）[18]。而我直接使用 codex，本质上就是一直在和那个更聪明的模型——也就是“Oracle”——打交道。是的，有各种基准测试[19]，但考虑到使用场景的巨大不同，我不太信任那些结果。实际体验中，codex 给我的输出远优于 amp。不过我得承认，他们在会话共享方面确实做了些有趣的创新。</p>
<p>Factory？我还没被说服。他们的演示视频有点尴尬，虽然我在信息流里确实听到一些正面评价 —— 尽管目前还不支持图像（至少现在还不行），而且也有标志性的闪烁问题[20]。</p>
<p>Cursor……如果你还在亲手写代码，那它的 Tab 补全模型确实是业界领先。我主要用 VS Code，但确实欣赏他们在浏览器自动化和计划模式（plan mode）等方面的探索。我试过 GPT-5-Pro，但 Cursor 依然存在那些从五月起就让我烦躁的 bug[21]。听说他们正在修复，所以它还留在我的程序坞里。</p>
<p>像 Auggie 这样的工具，只在我的信息流上昙花一现，之后就再没人提过。归根结底，它们底层无非是封装了 GPT-5 和/或 Sonnet，完全可以被替代。RAG 对 Sonnet 或许有点用，但 GPT-5 本身在代码检索上已经强到根本不需要额外的向量索引。</p>
<p>目前最有希望的是 opencode 和 crush，尤其是搭配开源模型使用时。你当然也能通过它们使用 OpenAI 或 Anthropic 的订阅（得益于一些巧妙的技术手段[22]），但这是否合规仍存疑，况且为何要为一个专为 Codex 或 Claude Code 优化的模型，配上一个能力较弱的“外壳”呢。</p>
<h3 data-id="heading-8"><strong>3.6 关于开源模型</strong></h3>
<p>基准测试只能说明一半的问题。在我看来，智能体工程（agentic engineering）大约在 Sonnet 4.0 发布的五月，才真正从“这玩意儿真烂”迈入“这还不错”的阶段；而随着 gpt-5-codex 的出现，我们又迎来了一次更大的进步 —— 从“不错”直接进入“这简直太棒了”的境界。</p>
<h3 data-id="heading-9"><strong>3.7 计划模式（Plan Mode）与方法</strong></h3>
<p>基准测试所忽略的，是模型与工具在接到指令后所采取的策略。codex 要谨慎得多 —— 它会在决定行动前读取你代码库中更多的文件。当你提出一个荒谬请求时，它也更倾向于明确反对[23]。相比之下，Claude 或其他智能体会更急切地直接动手尝试。虽然可以通过“计划模式”（plan mode）和严谨的结构化文档来缓解这个问题，但对我而言，这感觉像是在给一个有缺陷的系统打补丁。</p>
<p>如今我几乎不再为 codex 使用大型的计划文件。其实 codex 甚至没有专门的计划模式（plan mode） —— 但它对提示词的理解和遵循能力实在太强，我只要写一句“我们先讨论一下”或“给我几个选项”，它就会耐心等待我确认后再行动。完全不需要那些花里胡哨的东西，直接跟它对话就行。</p>
<h3 data-id="heading-10"><strong>3.8 但 Claude Code 现在有插件了</strong></h3>
<p>你听见远处那声叹息了吗？那是我在叹气。这真是彻头彻尾的胡扯。Anthropic 的这一举动让我对他们的产品方向感到非常失望。他们试图用插件[24]来掩盖模型本身的低效。当然，为特定任务维护优质文档是个好主意 —— 我自己就在一个 docs 文件夹里存了大量有用的 Markdown 文档。</p>
<h3 data-id="heading-11"><strong>3.9 但是！子智能体呢</strong></h3>
<p>但关于这场“子智能体”（subagents）的盛宴，我有些话不吐不快。今年五月时，这还叫“子任务”（subtasks），主要是当模型不需要完整上下文时，把任务拆出去单独处理——比如并行执行，或避免把冗长的构建脚本塞进主上下文造成浪费。后来他们重新包装并升级为“子智能体”，让你可以带着指令“优雅地”打包并分派任务。</p>
<p>但使用场景本质上没变。<strong>别人用子智能体干的事，我通常用多个终端窗口就搞定了。</strong> 如果我想调研某个问题，可能会在一个终端窗格里操作，再把结果粘贴到另一个窗格。这种方式让我对上下文工程拥有完全的控制权和可见性，而子智能体反而让上下文变得难以查看、引导或控制。</p>
<p>还有 Anthropic 博客里推荐的那个子智能体 —— 你去看看他们那个所谓的“AI Engineer”智能体[25]。那简直就是一锅大杂烩：一边吹集成了 GPT-4o 和 o1，一边堆砌一堆自动生成的空洞词汇，试图显得有逻辑。里面根本没有能让智能体真正变成更好“AI 工程师”的实质内容。</p>
<p>这到底有什么用？如果你希望获得更好的输出，光告诉模型“你是一位专精于生产级 LLM 应用的 AI 工程师”是没用的。<strong>真正有用的是提供文档、示例，以及明确的“该做什么/不该做什么”。</strong> 我敢打赌，你让智能体去“搜索 AI 智能体构建的最佳实践”并加载几个网页，效果都比那堆废话强得多。你甚至可以说，这种胡扯本身就是一种上下文污染（context poison）[26]。</p>
<h2 data-id="heading-12"><strong>04 我的提示词撰写之道</strong></h2>
<p>以前用 Claude 时，我（当然不是手打，而是靠语音）会写非常详尽的提示词，因为那个模型“给越多上下文，越懂我”。虽然所有模型多少都这样，但我发现换用 codex 后，提示词明显变短了 —— 常常就一两句话，外加一张图。这个模型读代码库的能力极强，就是能精准理解我的意图。有时候我甚至又愿意打字了，因为 codex 根本不需要太多上下文就能明白。</p>
<p><strong>添加图片是个绝妙的技巧，能快速补充上下文。</strong> 模型非常擅长精准定位你截图中的内容 —— 无论是字符串还是界面元素，它都能迅速匹配并跳转到你提到的位置。我至少有一半的提示词都包含截图，虽然添加标注效果更佳但效率更低，而直接拖拽截图到终端仅需两秒。</p>
<p>带语义纠错的 Wispr Flow[27] 仍是当前最优方案。</p>
<h2 data-id="heading-13"><strong>05 Web 端智能体新体验</strong></h2>
<p>最近我又重新尝试了一些 Web 端智能体：Devin、Cursor 和 Codex。Google 的 Jules 界面美观，但配置流程繁琐，且 Gemini 2.5 现在已经算不上好模型了。不过一旦 Gemini 3 Pro 上线[28]，情况或许会有所转变。目前唯一留下来的只有 codex web。虽然它也存在配置复杂的问题，而且现在还有 Bug（终端目前就无法正确加载），但我靠一个旧版环境让它跑起来了，代价是启动速度更慢。</p>
<p>我把 codex web 当作临时的问题追踪器。在外突发灵感时，就用 iOS App 发一条一行字的提词词，回头在 Mac 上再仔细处理。当然，我完全可以在手机上做更多事，比如审查、合并代码，但我刻意保持克制。我的工作已经够让人上瘾了，所以当我出门或和朋友聚会时，不想被进一步拉回工作状态。说这话的人，可是曾花将近两个月专门开发了一款便于使用手机编程的工具啊。</p>
<p>codex web 上的任务原本不计入使用额度，可惜这样的好日子恐怕快到头了。</p>
<h2 data-id="heading-14"><strong>06 The Agentic Journey</strong></h2>
<p>聊聊那些工具吧：Conductor[29]、Terragon[30]、Sculptor[31] 等数以千计的同类产品。有些是个人爱好项目，有些则被 VC 投来的钱淹得喘不过气。我试过太多太多，没一个能让我长期用下去。在我看来，它们都是在绕开当前模型的低效，推行一种并不真正高效的工作流。而且大多数还藏起终端，不让你看到模型的全部输出。</p>
<p>绝大多数不过是 Anthropic SDK 的浅层封装 + 工作树管理，毫无技术护城河可言。我甚至怀疑：我们真的需要在手机上更方便地调用编程智能体吗？这些工具的有限应用场景，现在 codex web 已经完全覆盖了。</p>
<p>不过我确实观察到一个普遍现象：几乎每个工程师都会经历一个“自己造工具”的阶段 —— 主要是因为好玩，也因为现在做这件事确实太容易了。既然如此，还有什么比造一个“（我们以为）能让造工具变得更简单的工具”更自然呢？</p>
<h2 data-id="heading-15"><strong>07 但 Claude Code 能处理后台任务！</strong></h2>
<p>确实如此。<strong>codex 目前缺少一些 Claude 有的小功能，其中最让人头疼的就是后台任务管理。</strong> 虽然理论上应该有超时机制，但我确实多次遇到它卡在不会自动结束的 CLI 任务上，比如启动开发服务器，或者死锁的测试。</p>
<p>这曾是我一度切回 Claude 的原因之一。但鉴于那个模型在其他方面实在太不靠谱，我现在改用 tmux。tmux 是一个老牌工具，能在后台持久化运行 CLI 会话，而且模型里早就内置了大量相关知识 —— 你只需要说一句“用 tmux 运行”，就能搞定，无需任何复杂的智能体配置流程。</p>
<h2 data-id="heading-16"><strong>08 那 MCPs 呢？</strong></h2>
<p>关于 MCP（Model Context Protocol），其他人已经写了很多。在我看来，大多数 MCP 本质都只是市场部门用来打勾炫耀的工具。几乎所有 MCP 其实都应该做成 CLI。这话出自一个自己写过 5 个 MCP[32] 的人之口。</p>
<p>我可以直接按工具名字调用一个 CLI，根本不需要在 agent 配置文件里写任何说明。模型第一次调用时可能会试一些乱七八糟的命令（$randomcrap），CLI 会自动返回帮助菜单，上下文立刻就拥有了完整的使用信息 —— 从此一切顺利。我不用为任何工具付出额外代价，而 MCP 却是持续的成本，还会污染我的上下文。试试 GitHub 的 MCP，瞬间吃掉 23k tokens。好吧，他们后来优化了 —— 刚上线时可是接近 5 万 tokens！换成 gh CLI 呢？功能基本一样，模型本来就认识它，还完全不用交“上下文税”。</p>
<p>我自己开源了一些 CLI 工具，比如 bslog[33] 和 inngest[34]。</p>
<p>我现在确实在用 chrome-devtools-mcp[35] 这个工具来做最终验证[36]，它已经取代了 Playwright，成为我进行网页调试时的首选 MCP 工具。虽然我不常用它，但一旦需要，它就能帮我完成从“代码修改”到“验证结果”这个关键闭环，非常有用。我还专门设计了我的网站，让模型能通过 curl 查询任意接口（通过我生成的 API key）——这在几乎所有场景下都比 MCP 更快、更省 token。所以就连这个 MCP，我也不是每天都需要。</p>
<h2 data-id="heading-17"><strong>09 但生成的代码太糟糕了！</strong></h2>
<p>我约 20% 的时间[37]投入在重构上。当然，这些全由智能体完成，我绝不会手动浪费时间干这种事。当我不太需要高度专注或感到疲惫时，“重构日”就特别有用 —— 即使状态一般，也能取得显著进展。</p>
<p>典型的重构工作包括：用 jscpd 找重复代码，用 knip[38] 清理死代码，运行 eslint 的 react-compiler 和弃用插件（译者注：一类 ESLint 插件，用于检查代码中是否使用了已过时的 API、方法或特性，并提示你改用现代、推荐的替代方案。），检查是否有可合并的 API 路由，更新文档，拆分过大的文件，为复杂逻辑补充测试和注释，更新依赖项，升级工具链，调整目录结构，找出并重写慢测试，引入现代 React 模式（比如你可能根本不需要 useEffect）等等。总有做不完的事。</p>
<p>有人可能会说这些应该在每次提交时就做完。但我发现，先快速迭代、再集中维护和优化代码库——即阶段性偿还技术债务——这种方式不仅效率更高，而且整体上有趣得多。</p>
<h2 data-id="heading-18"><strong>10 你采用规范驱动开发（spec-driven development）吗？</strong></h2>
<p>我去年六月还在用这种方式：先写一份详尽的规格文档，然后让模型去实现，理想情况下能连续跑上好几个小时。但现在我觉得，这种“先设计后构建”的思路已经是过时的软件开发范式了。</p>
<p>我现在的做法通常是：<strong>先直接和 codex 展开讨论，贴一些网站链接、初步构想，让它解读现有代码，然后我们一起把新功能逐步梳理出来。如果问题比较棘手，我会让它把思路整理成一份规范文档，然后交给 GPT-5-Pro（通过 chatgpt.com）做评审，看看是否有更好的建议 —— 出乎意料的是，这经常能大幅优化我的方案！接着，我会把其中我觉得有用的部分粘回主上下文，用于更新实际文件。</strong></p>
<p>现在我对不同任务消耗多少上下文已经有不错的直觉，而 codex 的上下文容量也相当充足，所以很多时候我干脆直接开干。有些人很“虔诚”，总喜欢为每个新计划新开一个上下文窗口 —— 我觉得这在 Sonnet 时代还有点用，但 GPT-5 处理长上下文的能力强得多，如果还这么做，每次都会白白多花 10 分钟，因为模型得重新慢慢加载所有构建功能所需的文件。</p>
<p>更有趣的方式是做基于 UI 的开发。我经常从一个非常简单的东西开始，故意把需求写得极其模糊，然后一边看模型编码，一边在浏览器里实时看到效果。接着我再排队加入更多调整，逐步迭代这个功能。很多时候我自己也不确定最终该长什么样，这种方式让我能边玩边试，看着想法慢慢成形。有时 codex 甚至会做出一些我根本没想到但很妙的设计。我从不重置进度，只是一步步迭代，把混沌慢慢塑造成我觉得对的形状。</p>
<p>开发过程中，我也常会冒出一些关联功能的新点子，顺势对其他部分也做些调整 —— 这部分工作我会放到另一个智能体里处理。通常我主攻一个核心功能，同时并行处理一些次要但相关的任务。</p>
<p>就在我写这段文字时，我正在给 Chrome 扩展开发一个新的 Twitter 数据导入器，为此我正在重构 graphql 导入模块。因为还不确定这个方案是否合理，我把这部分代码放在一个单独的文件夹里，这样可以通过 PR 预览来判断思路是否成立。主仓库则在做重构，让我能专心写这篇文章。</p>
<h2 data-id="heading-19"><strong>11 请分享您的斜杠命令！</strong></h2>
<p>我只有少数几个斜杠命令，而且很少用：</p>
<ul>
<li>/commit（自定义说明文本，用于协调多智能体在同一目录协作时仅提交自身修改。这样能保持提交信息干净，也能防止 GPT 因看到其他改动而 panic，比如 linter 报错时乱 revert（译者注：Git 版本控制中的常用术语，撤销某次或某几次提交（commit）所引入的更改。））</li>
<li>/automerge（一次处理一个 PR：响应机器人评论、回复、等 CI 通过后自动 squash 合并（译者注：Git 版本控制中的常用术语，将多个连续的提交记录合并成一个单一的、干净的提交。））</li>
<li>/massageprs（和 automerge 类似，但不用 squash，方便在有大量 PR 时并行处理）</li>
<li>/review（内置命令，偶尔用 —— 因为 GitHub 上已有 review bot，但有时还是有用）</li>
</ul>
<p>即便如此，大多数时候我其实就直接打 “commit” 两个字。除非我知道当前有太多脏文件，担心智能体在没有引导的情况下出错。如果我确信简单指令就够了，就绝不会搞那些花哨的表演或浪费上下文。这种直觉是慢慢练出来的。到目前为止，我还没见过其他真正有用的斜杠命令。</p>
<h2 data-id="heading-20"><strong>12 其他实用技巧</strong></h2>
<p><strong>与其费尽心思写出完美的提示词去“激励”智能体完成一个长期任务，不如用点偷懒的变通方法。</strong> 比如进行大型重构时，Codex 常会在中途暂停响应。这时候，只要提前排好几条 “continue” 消息，你就可以走开，等回来时活儿就干完了。如果 codex 已经完成了任务，再收到更多消息，它也会愉快地忽略掉。</p>
<p><strong>每次完成一个功能或 Bug 修复后，请让模型在同一上下文中顺手写点测试用例。</strong> 这样做不仅能产出质量高得多的测试用例，还常常能暴露代码实现中的 bug。如果是纯 UI 调整，可能测试意义不大。但对于其他情况，我强烈建议这么做。AI 写测试用例总体上还是不太行，但已经比没有强多了 —— 而且说实话，你自己每次改代码都会写测试用例吗？</p>
<p><strong>让模型“保留你的原始意图”，并“在复杂逻辑处添加代码注释”，这对您和后续模型理解代码都大有裨益。</strong></p>
<p><strong>当遇到棘手难题时，在提示词中加入一些触发词</strong>，比如 “take your time”（慢慢来）、“comprehensive”（全面一点）、“read all code that could be related”（读所有可能相关的代码）、“create possible hypothesis”（提出可能的假设） —— 这些都能让 codex 解决最棘手的问题。</p>
<h2 data-id="heading-21"><strong>13 你的 Agents/Claude 配置文件是什么样的？</strong></h2>
<p>我创建了一个名为 Agents.md 的主配置文件，然后为它创建了一个符号链接（译者注：Linux 操作系统中一个特殊的文件，内容存储指向目标文件或目录的路径字符串），这个链接的名字叫 claude.md。我这么做是因为开发 Claude 的 Anthropic 公司没有采用和其他工具（比如 Codex）统一的配置文件命名标准。我承认这很麻烦也不理想 —— 毕竟 GPT-5 和 Claude 偏好的提示词风格差异很大[39]。如果你还没看过它们各自的提示词指南，建议现在就去读一读。</p>
<p>Claude 对那种 🚨 全大写咆哮式命令 🚨[40]（比如“如果你执行 X 命令，后果将极其严重，100 只小猫会死掉！”）反应良好，但这会让 GPT-5 直接崩溃（也确实该崩溃）。所以，请彻底放弃这种写法，像正常人一样用平实的语言就行。这也意味着这些配置文件很难被最优地共享。不过对我来说问题不大，因为我主要用 codex，即使偶尔让 Claude 上场，我也接受这些指令对它来说可能强度不足。</p>
<p>我的 Agent 配置文件目前大约 800 行，感觉就像一堆“组织创伤”留下的疤痕组织。这不是我手写的，而是 codex 自己生成的。每次出了状况，我都会让它在文件里加一条简洁备注。我应该找个时间清理一下配置文件，但尽管文件很长，它却运行得极其可靠 —— GPT-5 也确实几乎总是遵守里面的规则。至少比 Claude 以前强太多了。（当然也得承认，Sonnet 4.5 在这方面确实有进步）</p>
<p>除了 Git 操作说明，文件里还包含产品说明书、我偏好的命名规范和 API 模式、关于 React Compiler 的注意事项等等 —— 很多内容甚至比模型的“世界知识”还新，因为我的技术栈相当激进。我预计随着模型更新，这部分内容还能进一步精简。例如，Sonnet 4.0 当年需要大量指导才能理解 Tailwind 4，而 Sonnet 4.5 和 GPT-5 已经内置了相关知识，所以我直接删掉了所有冗余的相关说明。</p>
<p>文件里很大一块内容专门描述我偏好的 React 模式、数据库迁移管理策略、测试规范，以及如何使用和编写 ast-grep 规则。（如果你还不知道 ast-grep，或者没把它用作代码库的 linter，请立刻停下来，让模型帮你把它设为 Git hook，用来拦截不符合规范的提交。）</p>
<p>我还尝试过一种基于文本的“设计系统”，用来规定 UI 应该长什么样 —— 不过这个实验目前还没下定论。</p>
<h2 data-id="heading-22"><strong>14 那么 GPT-5-Codex 是完美的吗？</strong></h2>
<p>当然不是。有时候它会花半个小时重构代码，然后突然 panic，把所有改动全 revert 掉 —— 这时候你得重新运行，并像哄小孩一样安抚它：“你有足够的时间，慢慢来。” 有时它会忘记自己其实能执行 bash 命令，需要你鼓励一下。偶尔它还会用俄语或韩语回复。更离谱的是，有时候这个“怪物”一滑手，直接把内部思考过程原样扔进了 bash 终端。但总体而言，这些情况相当罕见，而它在其他几乎所有方面都强到离谱，让我完全可以忽略这些小毛病。毕竟，人类也不是完美的。</p>
<p>我对 codex 最大的不满是它会“丢失文本行” —— 快速向上滚动时，部分文本会莫名其妙消失。真心希望 OpenAI 把这个 Bug 放在修复清单的最顶端，因为这是目前唯一迫使我放慢操作速度的原因，就怕消息突然不见了。</p>
<h2 data-id="heading-23"><strong>15 结论</strong></h2>
<p>别在 RAG、子智能体（subagents）、Agents 2.0 或其他华而不实的花架子上浪费时间了。直接跟它对话，动手试，慢慢培养直觉。你和智能体合作得越多，结果就会越好。</p>
<p>Simon Willison 的文章[41]说得特别到位：<strong>管理智能体所需的许多技能，其实和管理工程师非常相似 —— 而这些能力，几乎全都是资深软件工程师的特质。</strong></p>
<p>而且没错，写出好软件依然很难。我不再亲手写代码，并不意味着我不再深入思考架构、系统设计、依赖关系、功能实现，或者如何让用户感到惊喜。使用 AI 只意味着：大家对你交付成果的期望值变高了。</p>
<p>PS: 本文 100% 原创手写。我热爱 AI，但也清楚有些事用老办法反而更好。保留这些笔误，保留我的声音。🚄✌️</p>
<p>PPS: 文章头图由 Thorsten Ball 提供[42]，特此致谢。</p>
<p><strong>END</strong></p>
<p><strong>本期互动内容 🍻</strong></p>
<p><strong>❓文中哪个观点你极度认同？或者，哪个地方你持保留意见？</strong></p>
<p><strong>文中链接</strong></p>
<p>[1]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fchristianklotz%2Fstatus%2F1977866496001867925" target="_blank" title="https://x.com/christianklotz/status/1977866496001867925" ref="nofollow noopener noreferrer">x.com/christiankl…</a></p>
<p>[2]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fpmddomingos%2Fstatus%2F1976399060052607469" target="_blank" title="https://x.com/pmddomingos/status/1976399060052607469" ref="nofollow noopener noreferrer">x.com/pmddomingos…</a></p>
<p>[3]<a href="https://link.juejin.cn?target=https%3A%2F%2Fsteipete.me%2Fposts%2F2025%2Foptimal-ai-development-workflow" target="_blank" title="https://steipete.me/posts/2025/optimal-ai-development-workflow" ref="nofollow noopener noreferrer">steipete.me/posts/2025/…</a></p>
<p>[4]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1977771686176174352" target="_blank" title="https://x.com/steipete/status/1977771686176174352" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[5]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1977498385172050258" target="_blank" title="https://x.com/steipete/status/1977498385172050258" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[6]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgist.github.com%2Fsteipete%2Fd3b9db3fa8eb1d1a692b7656217d8655" target="_blank" title="https://gist.github.com/steipete/d3b9db3fa8eb1d1a692b7656217d8655" ref="nofollow noopener noreferrer">gist.github.com/steipete/d3…</a></p>
<p>[7]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1977119589860601950" target="_blank" title="https://x.com/steipete/status/1977119589860601950" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[8]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fweberwongwong%2Fstatus%2F1975749583079694398" target="_blank" title="https://x.com/weberwongwong/status/1975749583079694398" ref="nofollow noopener noreferrer">x.com/weberwongwo…</a></p>
<p>[9]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1976353767705457005" target="_blank" title="https://x.com/steipete/status/1976353767705457005" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[10]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1977072732136521836" target="_blank" title="https://x.com/steipete/status/1977072732136521836" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[11]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fvtahowe%2Fstatus%2F1976709116425871772" target="_blank" title="https://x.com/vtahowe/status/1976709116425871772" ref="nofollow noopener noreferrer">x.com/vtahowe/sta…</a></p>
<p>[12]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fs_streichsbier%2Fstatus%2F1974334735829905648" target="_blank" title="https://x.com/s_streichsbier/status/1974334735829905648" ref="nofollow noopener noreferrer">x.com/s_streichsb…</a></p>
<p>[13]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fkimmonismus%2Fstatus%2F1976404152541680038" target="_blank" title="https://x.com/kimmonismus/status/1976404152541680038" ref="nofollow noopener noreferrer">x.com/kimmonismus…</a></p>
<p>[14]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1978099041884897517" target="_blank" title="https://x.com/steipete/status/1978099041884897517" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[15]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1975297275242160395" target="_blank" title="https://x.com/steipete/status/1975297275242160395" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[16]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1977466373363437914" target="_blank" title="https://x.com/steipete/status/1977466373363437914" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[17]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fdeepfates%2Fstatus%2F1975604489634914326" target="_blank" title="https://x.com/deepfates/status/1975604489634914326" ref="nofollow noopener noreferrer">x.com/deepfates/s…</a></p>
<p>[18]<a href="https://link.juejin.cn?target=https%3A%2F%2Fampcode.com%2Fnews%2Fgpt-5-oracle" target="_blank" title="https://ampcode.com/news/gpt-5-oracle" ref="nofollow noopener noreferrer">ampcode.com/news/gpt-5-…</a></p>
<p>[19]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fbtibor91%2Fstatus%2F1976299256383250780" target="_blank" title="https://x.com/btibor91/status/1976299256383250780" ref="nofollow noopener noreferrer">x.com/btibor91/st…</a></p>
<p>[20]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fbadlogicgames%2Fstatus%2F1977103325192667323" target="_blank" title="https://x.com/badlogicgames/status/1977103325192667323" ref="nofollow noopener noreferrer">x.com/badlogicgam…</a></p>
<p>[21]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1976226900516209035" target="_blank" title="https://x.com/steipete/status/1976226900516209035" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[22]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1977286197375647870" target="_blank" title="https://x.com/steipete/status/1977286197375647870" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[23]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fthsottiaux%2Fstatus%2F1975565380388299112" target="_blank" title="https://x.com/thsottiaux/status/1975565380388299112" ref="nofollow noopener noreferrer">x.com/thsottiaux/…</a></p>
<p>[24]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fclaude-code-plugins" target="_blank" title="https://www.anthropic.com/news/claude-code-plugins" ref="nofollow noopener noreferrer">www.anthropic.com/news/claude…</a></p>
<p>[25]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwshobson%2Fagents%2Fblob%2Fmain%2Fplugins%2Fllm-application-dev%2Fagents%2Fai-engineer.md" target="_blank" title="https://github.com/wshobson/agents/blob/main/plugins/llm-application-dev/agents/ai-engineer.md" ref="nofollow noopener noreferrer">github.com/wshobson/ag…</a></p>
<p>[26]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FIanIsSoAwesome%2Fstatus%2F1976662563699245358" target="_blank" title="https://x.com/IanIsSoAwesome/status/1976662563699245358" ref="nofollow noopener noreferrer">x.com/IanIsSoAwes…</a></p>
<p>[27]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwisprflow.ai%2F" target="_blank" title="https://wisprflow.ai/" ref="nofollow noopener noreferrer">wisprflow.ai/</a></p>
<p>[28]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fcannn064%2Fstatus%2F1973415142302830878" target="_blank" title="https://x.com/cannn064/status/1973415142302830878" ref="nofollow noopener noreferrer">x.com/cannn064/st…</a></p>
<p>[29]<a href="https://link.juejin.cn?target=https%3A%2F%2Fconductor.build%2F" target="_blank" title="https://conductor.build/" ref="nofollow noopener noreferrer">conductor.build/</a></p>
<p>[30]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.terragonlabs.com%2F" target="_blank" title="https://www.terragonlabs.com/" ref="nofollow noopener noreferrer">www.terragonlabs.com/</a></p>
<p>[31]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1973132707707113691" target="_blank" title="https://x.com/steipete/status/1973132707707113691" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[32]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsteipete%2Fclaude-code-mcp" target="_blank" title="https://github.com/steipete/claude-code-mcp" ref="nofollow noopener noreferrer">github.com/steipete/cl…</a></p>
<p>[33]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsteipete%2Fbslog" target="_blank" title="https://github.com/steipete/bslog" ref="nofollow noopener noreferrer">github.com/steipete/bs…</a></p>
<p>[34]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsteipete%2Finngest" target="_blank" title="https://github.com/steipete/inngest" ref="nofollow noopener noreferrer">github.com/steipete/in…</a></p>
<p>[35]<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fblog%2Fchrome-devtools-mcp" target="_blank" title="https://developer.chrome.com/blog/chrome-devtools-mcp" ref="nofollow noopener noreferrer">developer.chrome.com/blog/chrome…</a></p>
<p>[36]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1977762275302789197" target="_blank" title="https://x.com/steipete/status/1977762275302789197" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[37]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsteipete%2Fstatus%2F1976985959242907656" target="_blank" title="https://x.com/steipete/status/1976985959242907656" ref="nofollow noopener noreferrer">x.com/steipete/st…</a></p>
<p>[38]<a href="https://link.juejin.cn?target=https%3A%2F%2Fknip.dev%2F" target="_blank" title="https://knip.dev/" ref="nofollow noopener noreferrer">knip.dev/</a></p>
<p>[39]<a href="https://link.juejin.cn?target=https%3A%2F%2Fcookbook.openai.com%2Fexamples%2Fgpt-5%2Fgpt-5_prompting_guide" target="_blank" title="https://cookbook.openai.com/examples/gpt-5/gpt-5_prompting_guide" ref="nofollow noopener noreferrer">cookbook.openai.com/examples/gp…</a></p>
<p>[40]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FAltimor%2Fstatus%2F1975752110164578576" target="_blank" title="https://x.com/Altimor/status/1975752110164578576" ref="nofollow noopener noreferrer">x.com/Altimor/sta…</a></p>
<p>[41]<a href="https://link.juejin.cn?target=https%3A%2F%2Fsimonwillison.net%2F2025%2FOct%2F7%2Fvibe-engineering%2F" target="_blank" title="https://simonwillison.net/2025/Oct/7/vibe-engineering/" ref="nofollow noopener noreferrer">simonwillison.net/2025/Oct/7/…</a></p>
<p>[42]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fthorstenball%2Fstatus%2F1976224756669309195" target="_blank" title="https://x.com/thorstenball/status/1976224756669309195" ref="nofollow noopener noreferrer">x.com/thorstenbal…</a></p>
<p><em><strong>本文经原作者授权，由 Baihai IDP 编译。如需转载译文，请联系获取授权。</strong></em></p>
<p><strong>原文链接：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsteipete.me%2Fposts%2Fjust-talk-to-it" target="_blank" title="https://steipete.me/posts/just-talk-to-it" ref="nofollow noopener noreferrer">steipete.me/posts/just-…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 代码评估的下一阶段已经到来]]></title>    <link>https://juejin.cn/post/7574253222606422057</link>    <guid>https://juejin.cn/post/7574253222606422057</guid>    <pubDate>2025-11-19T09:33:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574253222606422057" data-draft-id="7574230922314776582" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 代码评估的下一阶段已经到来"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-19T09:33:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 代码评估的下一阶段已经到来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:33:27.000Z" title="Wed Nov 19 2025 09:33:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnews.lmarena.ai%2Fcode-arena%2F" target="_blank" title="https://news.lmarena.ai/code-arena/" ref="nofollow noopener noreferrer">转载</a></p>
<h4 data-id="heading-0">Aryan Vichare</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1e7098834d6404bb145067396ceb733~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149607&amp;x-signature=dUQerb0uAQPl5Z9QOCTF8XhnAzA%3D" alt="" loading="lazy"/></p>
<p><strong>介绍 Code Arena：现实世界中 agentic coding 的实时评估</strong></p>
<p>AI 代码模型发展迅速。如今的系统不再只是一次性输出静态代码。它们<strong>构建</strong>。它们搭建完整的 Web 应用和站点，重构复杂系统，并实时自我调试。许多现在扮演着<strong>coding agents</strong>的角色，规划和执行结构化操作来设计和部署完整的应用程序。</p>
<p>但问题不再是"模型能写代码吗？"而是"它在多大程度上能端到端地构建真实的应用程序？"</p>
<p>传统基准测试衡量<strong>正确性</strong>：代码是否能编译并通过一组静态测试用例。正确性很重要，但这只是定义真实开发的部分。构建软件是迭代性和创造性的：你规划、测试、完善和重复。一个可信的评估必须反映这个过程。</p>
<p><strong>Code Arena</strong> 正好做到了这一点。这是我们下一代评估系统，从零开始重建，专为透明度、精确性和现实世界性能而设计。模型在受控的隔离环境中作为交互式 agents 运行，每个提示、渲染和操作都被记录。会话在访问之间可恢复且持久，生成内容可以稍后共享或重新访问。</p>
<p>其结果是一个实时的、可检查的系统，不仅评估代码是否有效，还评估<strong>它运行得如何良好</strong>、<strong>它交互得如何自然</strong>，以及<strong>它如何忠实地满足预期设计</strong>。Code Arena 衡量<strong>动态编码</strong>，捕捉模型在模拟真实开发的条件下如何思考、规划和构建。</p>
<h2 data-id="heading-1">为开发者带来什么新内容</h2>
<p>Code Arena 引入了面向开发者的体验，旨在营造实时编码环境的感觉：交互式、透明，并且从头到尾都是持久的。</p>
<ul>
<li><strong>Agentic behaviors（代理行为）</strong>： 模型使用结构化工具调用（create_file、edit_file、read_file）自主规划和执行，逐步展示推理过程。</li>
<li><strong>Multi-turn, multi-step execution（多轮、多步执行）</strong>： 模型在多次交互中迭代、编辑和完善，在单次评估中完成复杂构建。</li>
<li><strong>Real-time generation（实时生成）</strong>： 输出在模型构建时实时渲染，因此开发者可以在代码演进过程中探索运行中的应用。</li>
<li><strong>Persistent sessions（持久会话）</strong>： 代码会话在访问之间可恢复且持久，保留状态并支持协作审查。</li>
<li><strong>Recursive edits and HTML file trees（递归编辑和HTML文件树）</strong>： 每次生成包含完整的项目结构（HTML、CSS、JS），让评估者检查模型如何管理相互依赖的文件和递归编辑。</li>
<li><strong>Shareable generations（可共享生成）</strong>： 每个构建都可通过唯一链接共享，用于同行测试或模型比较。</li>
<li><strong>Unified workflow（统一工作流）</strong>： 提示、生成和评估现在完全在 Arena 的基础设施内完成，确保受控环境、一致参数和可重现结果。</li>
</ul>
<p>总之，这些更新将基准测试变成一个你可以看到、运行和共享的实验。Code Arena 现在是一个面向开发者、模型构建者、原型制作者、知识工作者、创意专业人士等的透明编码环境。</p>
<h2 data-id="heading-2">Code Arena 如何工作</h2>
<p>每次 Code Arena 评估都是一个可重现的实验，捕捉 AI 辅助开发的完整轨迹，从想法到生成到人类判断。</p>
<ol>
<li><strong>Prompt（提示）</strong>： 评估者或开发者提交一个任务，例如"构建一个带有暗色模式的 markdown 编辑器。"</li>
<li><strong>Plan（规划）</strong>： 模型解释请求并使用结构化工具调用决定采取哪些操作。这种 agentic 规划反映了真实的开发者工作流程。</li>
<li><strong>Generate（生成）</strong>： 模型生成实时的、可部署的 Web 应用和站点。</li>
<li><strong>Record（记录）</strong>： 每个模型操作（文件创建、编辑或执行）都被记录和版本控制。快照存储在 Cloudflare R2 中并链接到 Arena 的数据库以实现透明可追溯性。</li>
<li><strong>Render（渲染）</strong>： 生成的应用通过安全前端流式传输，使用 CodeMirror 6 进行源代码查看，使用实时预览进行交互和测试。</li>
<li><strong>Vote（投票）</strong>： 评估者成对比较输出，评估功能、可用性和保真度以及设计、品味和美学。每个投票都存储有完整的上下文：模型版本、延迟和环境。</li>
<li><strong>Aggregate（聚合）</strong>： 结构化的人类判断实时反馈到排行榜，显示置信区间和性能方差，而不是静态平均值。</li>
</ol>
<p>这个从提示到实时应用再到可验证投票的闭环管道，确保了 Code Arena 中的每个结果都是透明的、可重现的和科学基础的。Code Arena 不仅仅是完善我们评估 AI 代码模型的方式，它重新定义了基础本身。</p>
<h2 data-id="heading-3">从 WebDev Arena 到 Code Arena</h2>
<p>当我们启动 WebDev Arena 时，它引入了第一个大规模的人工参与式 AI 编码基准测试。开发者可以观看模型构建真实应用、与输出交互并对性能投票，使评估具有参与性和透明度。</p>
<p>随着使用规模的扩大，对精确性和可重现性的需求也日益增长。最初为实验设计的系统，无法满足现实世界使用和评估所需的严格性要求。</p>
<p>Code Arena 从零开始重建了这个基础。每个组件都为透明度、可追溯性和方法控制而重新设计。其结果是一个更强大、更具科学基础的系统，不仅衡量代码是否<strong>有效</strong>，还衡量它在实践中<strong>运行得如何良好</strong>。</p>
<h2 data-id="heading-4">重建内部</h2>
<p>Code Arena 不仅仅是基础设施升级。它是一个新的评估框架，为可重现性、透明度和科学严谨性而构建。每次评估都在为精确性和规模而设计的严格控制环境中运行，其中每个操作、渲染和结果都被记录并可重现。</p>
<ul>
<li><strong>Agentic tool use（代理工具使用）</strong>： 模型通过结构化工具调用自主创建、修改和执行代码，实现递归编辑和依赖管理等现实世界行为。</li>
<li><strong>Persistent and shareable sessions（持久和可共享会话）</strong>： 代码会话在访问之间是可恢复和持久的，允许用户重新访问、检查和分发实时生成内容。</li>
<li><strong>Reproducibility（可重现性）</strong>： 每个提示、模型版本和人类投票都链接到可追踪的 ID。</li>
<li><strong>Scoring framework（评分框架）</strong>： 结果结合结构化的人类评估与透明统计聚合，包括评估者间可靠性和置信区间。</li>
</ul>
<p>这种组合将 Code Arena 从排行榜转变为科学测量系统，其中每个数字都是可重现的，每个输出都是可验证的，每个模型都可以在现实世界条件下测试。</p>
<h3 data-id="heading-5">统一评估系统和方法论</h3>
<p>提示、生成、比较和投票现在在 Arena 平台内以一个无缝工作流程中进行。这种集成减少了延迟，提高了可靠性，并允许对数千个同时任务进行精确跟踪。</p>
<p>有了 Code Arena，我们不仅仅是更新了界面。我们重建了编码评估的基础。每个模型都在三个轴上评分，这反映了真实的开发者判断：</p>
<ul>
<li><strong>Functionality（功能性）</strong>： 应用程序是否做到了它应该做的？</li>
<li><strong>Usability（可用性）</strong>： 它是否清晰、响应迅速和直观？</li>
<li><strong>Fidelity（保真度）</strong>： 它是否匹配请求的设计或行为？</li>
</ul>
<p>新系统引入了<strong>agentic、多轮执行</strong>，模型自主规划和执行操作。每个模型可以调用像 create_file、edit_file 和 run_command 这样的工具，在结构化步骤中递归完善自己的工作。这实现了反映真实工程行为的复杂、迭代开发周期。</p>
<p>模型生成和部署完全交互的 Web 应用和站点，每次评估在一致条件下记录从提示到最终渲染的完整链，确保结果是可追溯的、可审计的和可重复的。</p>
<p>评估仍然是人工驱动的，但现在应用结构化评分和透明聚合，产生统计验证和可重现的结果。这次重建为 Code Arena 的演进评估框架奠定了基础，基于三个原则：</p>
<ul>
<li><strong>Humans at the core（人类为核心）</strong>： 每个分数都代表人类判断。投票随上下文记录并透明聚合。</li>
<li><strong>Show our work（展示工作）</strong>： 每个指标都链接到其数据：成本、延迟和方法论。透明度内置于基础设施中。</li>
<li><strong>Embrace uncertainty（拥抱不确定性）</strong>： Arena 发布置信区间和方差，而不仅仅是平均值。评估应该反映细微差别，而不是掩盖它。</li>
</ul>
<h3 data-id="heading-6">干净数据基础和新排行榜</h3>
<p>因为 Code Arena 的架构和方法论已经完全重建，它在为从头开始反映这个新系统而设计的新排行榜上启动。没有数据从 WebDev Arena 合并或改造，确保方法论一致性并保护未来比较的完整性。</p>
<p>将 WebDev Arena 的结果合并会损害数据完整性，因为它结合了在不同评分系统、环境和假设下产生的评估。从头开始允许 Code Arena 在清晰、可重现的评估规则下成熟，免受遗留偏见影响，并符合我们对透明度和可审计性的严格标准。</p>
<p>原始的 WebDev Arena 排行榜（<strong>WebDev Legacy</strong>）将在不久的将来退休，但目前，它仍然保持在线状态，作为 AI 编码评估第一个时代的历史记录。支撑 Code Arena 的新 <strong>WebDev V2 排行榜</strong>定义了现实世界性能的前瞻标准。</p>
<h3 data-id="heading-7">偏见跟踪和数据完整性</h3>
<p>每次 UI 或工作流更改都可以改变人类投票模式。Arena 将其视为评估科学的一部分。在任何更改集成之前，团队运行偏见审计，测量对投票行为的影响并在排行榜更新前进行补偿。这确保人工参与式评估在平台演进时保持一致、公平和统计合理。</p>
<h2 data-id="heading-8">社区为核心</h2>
<p>Arena 的优势一直是其社区：相信进步应该是开放、可测量和可共享的开发者、研究者和构建者。Code Arena 将这种信念付诸实践。</p>
<p>在平台内部，真实参与者推动每次评估。开发者探索实时应用、比较输出，并决定哪些模型在真实场景中表现最佳。他们的集体反馈构成了推动排行榜的数据。人类判断转化为结构化洞察。</p>
<p>Arena Discord 社区保持这个循环活跃。开发者在这里提出新挑战、参加实时测试，并发现帮助完善框架本身的异常情况。这种协作确保 Code Arena 与它所衡量的生态系统共同演进。</p>
<p>Arena Creator Community 延续了这种精神，展示人们如何使用、测试和构建 Arena。他们的项目使评估不仅是开放和透明的，而且是有吸引力和创造力的。</p>
<p>当人们参与 Code Arena 时，他们不仅仅是生成数据。<strong>他们在定义什么是好的 AI 编码。</strong></p>
<h2 data-id="heading-9">下一步</h2>
<p>Code Arena 的启动标志着一个新阶段的开始，专注于深度、可靠性和覆盖范围。在未来几个月，团队将继续完善数据质量、延迟和评估速度，同时扩展模型可以构建的内容以及开发者与它们的交互方式。</p>
<p>下一波更新将引入多文件 React 应用程序，允许模型生成结构化仓库而不是单文件原型，使 Code Arena 更接近现实世界软件开发：迭代、分层和可视化。</p>
<p>在未来几个月内，Arena 将开始推出 agent 支持和多模态输入，以及多文件项目的隔离沙盒。这些扩展将 Code Arena 推向连接的、协作的环境，反映现代 coding agents 实际如何跨系统、界面和媒体工作。</p>
<p>Code Arena 不是静态基准测试。它是一个活系统，随着每个新模型、实验和人类投票而演进。每次更新都加强其基础：为规模而构建的透明、可重现评估。</p>
<p>Arena 的使命一直是衡量重要的东西：AI 在现实世界中的表现。有了 Code Arena，这个使命现在触及软件创造的核心。这是开发者、研究者和模型构建者汇聚一堂、共同测试性能的地方。</p>
<p>AI 代码评估的下一阶段已经到来。</p>
<p>👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Flmarena.ai%2Fcode%3Fref%3Dnews.lmarena.ai" target="_blank" title="https://lmarena.ai/code?ref=news.lmarena.ai" ref="nofollow noopener noreferrer">探索 Code Arena →</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini 3深夜来袭：力压GPT 5.1，大模型谷歌时代来了]]></title>    <link>https://juejin.cn/post/7574270661871861798</link>    <guid>https://juejin.cn/post/7574270661871861798</guid>    <pubDate>2025-11-19T09:34:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574270661871861798" data-draft-id="7574254039023075354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini 3深夜来袭：力压GPT 5.1，大模型谷歌时代来了"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-19T09:34:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini 3深夜来袭：力压GPT 5.1，大模型谷歌时代来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:34:01.000Z" title="Wed Nov 19 2025 09:34:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Gemini 3 还没现身，推特先崩为敬。</p>
<p>没有哪家模型的发布比 Gemini 3 更万众瞩目，根据 Gemini 之前 3 个月更新一次的频率，AI 社区自 9 月起便对 Gemini 3 翘首以盼。</p>
<p>今天，谷歌开发者关系负责人、Google AI Studio 负责人一条仅含「Gemini」一词的推文，积蓄了数月的期待终于迎来了爆发点，推特相关话题瞬间沸腾。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8fdf3a46b4f4c1f8d218977e623dfee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=Z8kDAj7mQj75loo0ry8DMWz%2B4tU%3D" alt="图片" loading="lazy"/></p>
<p>有趣的是，临近发布节点，推特竟「应景」地崩了几次。尽管「幕后黑手」是 Cloudflare，但这崩溃的时机简直精准得让人怀疑有人背后搞鬼（小声蛐蛐：毕竟推特是各家模型的宣传主阵地）。</p>
<p>不知道今早刚发了 Grok 4.1 的马斯克此时作何感想，反正网友的梗图已经铺天盖地了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9994822a8f49485ebb48cf10cb382ad1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=PydLY2WC%2BYpnYk3uZDkCjFC9lUQ%3D" alt="图片" loading="lazy"/></p>
<p>就在刚刚，Gemini 3 终于正式登场，让我们看看在万众瞩目下登场的它到底有多强。</p>
<p>最智能模型</p>
<p>事实证明，Google 没有让等待的人失望，Gemini 3 正式发布，再一次定义了 SOTA，奥特曼和马斯克也发来贺电。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35da33afde8b4c34bc6ba64ea9e13993~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=VGAsHPu7i%2F3nOg5g%2BI4pdl4gW00%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a056f8d7cf2b41a0b012b608bf31b514~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=9G%2F1JdITkQ2p8TOja5Tebr%2F7dy4%3D" alt="图片" loading="lazy"/></p>
<p>Google 将其定义为「通往 AGI 的重要一步」，并强调这是目前世界上多模态理解能力最强、交互最深度的智能体。</p>
<p>Gemini 3 不仅在基础推理能力上刷新了 SOTA 标准，更通过推出全新的 Google Antigravity 平台和 Deep Think 模式，试图重塑开发者生态与 AI 辅助体验。</p>
<p>全面霸榜的推理怪兽</p>
<p>Gemini 3 Pro 被官方称为「最先进的推理模型」，在几乎所有主流 AI 基准测试中均显著超越了前代 Gemini 2.5 Pro，并且全面压制了 Claude Sonnet 4.5 和 GPT-5.1 等主要竞品。</p>
<p>Gemini 3 Pro 以 1501 Elo 的突破性高分登顶 LMArena Leaderboard，在 Humanity’s Last Exam（在不使用任何工具的情况下达到 37.5%）和 GPQA Diamond（91.9%）上获得最高分，展示了博士级的推理能力。它还在数学方面为前沿模型树立了新标准，在 MathArena Apex 上达到了 23.4% 的最新 SOTA 水平。</p>
<p>除了文本与逻辑，Gemini 3 Pro 还重新定义了多模态推理的上限。它在 MMMU-Pro 和 Video-MMMU 上分别斩获了 81% 和 87.6% 的高分，这意味着无论是解析复杂的科学图表还是理解动态视频流，它都游刃有余。</p>
<p>更值得一提的是，它在 SimpleQA Verified 上取得了 72.1% 的成绩，显示出在事实准确性上的巨大进步 —— 它不仅强，而且可靠。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baf441b2cc824f8db9237fba0d172c4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=AczIKcVzJG7%2BzNSBldGWW2CeBs4%3D" alt="图片" loading="lazy"/></p>
<p>拒绝奉承的思维伙伴</p>
<p>Gemini 3 Pro 的进化不仅在于跑分，更在于交互的质感。它摒弃了以往 AI 常见的陈词滥调和过度奉承，变得聪明、简洁且直接：告诉你需要听到的，而不仅仅是你爱听的。</p>
<p>它充当真正的思维伙伴，为你提供理解信息和表达自我的新方式，从通过生成高保真可视化的代码来翻译晦涩的科学概念，到创造性的头脑风暴。</p>
<p>Gemini 3 编写代码可视化托卡马克装置中的等离子体流，并创作了一首捕捉聚变物理学原理的诗。</p>
<p>Gemini 3 Deep Think</p>
<p>Gemini 3 Deep Think 模式进一步拓展了智能的边界，带来了 Gemini 3 在推理和多模态理解能力上的重大进步，帮助你解决更复杂的问题。</p>
<p>在测试中，Gemini 3 Deep Think 在 Humanity's Last Exam（不使用工具的情况下得分 41.0%）和 GPQA Diamond（得分 93.8%）上的表现均优于 Gemini 3 Pro 已相当出色的成绩。此外，它在 ARC-AGI-2（代码执行，已通过 ARC Prize 验证）上也取得了前所未有的 45.1% 的得分，展现了其解决全新挑战的能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cd550bd28884cbfbfbed05eb76bfca9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=CUOT56ExClY%2ByWarboRwV2P0ZME%3D" alt="图片" loading="lazy"/></p>
<p>Gemini 3 Deep Think 模式在一些最具挑战性的 AI 基准测试中表现出色。</p>
<p>学习、构建与规划</p>
<p>学习任何事情</p>
<p>Gemini 从一开始就旨在无缝整合任何主题的多种模态信息，包括文本、图像、视频、音频和代码。Gemini 3 结合了其先进的推理、视觉和空间理解能力、领先的多语言性能以及百万级 token 上下文窗口，进一步拓展了多模态推理的边界，帮助你以最适合自己的方式学习。</p>
<p>例如，如果你想学习如何烹饪家族传统菜肴，Gemini 3 可以解读并翻译不同语言的手写食谱，生成可与家人分享的食谱。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2725632f8f54eac96a16acd375555df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=lRgk%2FdCqPtiLdSnoOrUWIVtllMI%3D" alt="图片" loading="lazy"/></p>
<p>或者，如果你想学习某个新主题，就可以提供学术论文、长篇视频讲座或教程，它可以生成交互式记忆卡片、可视化或其他格式的代码，帮助你掌握相关知识。</p>
<p>它甚至可以分析你的匹克球比赛视频，找出可以改进的地方，并制定训练计划，帮助你全面提升球技。</p>
<p>为了帮助你更好地理解网络上的信息，搜索中的 AI 模式现在使用 Gemini 3 来实现新的生成式 UI 体验，例如沉浸式视觉布局、交互式工具和模拟，所有这些都是根据你的查询即时生成的。</p>
<p>学习像 RNA 聚合酶如何在 AI 模式下的生成式 UI 中工作这样的复杂主题 。</p>
<p>开发任何东西</p>
<p>在 2.5 Pro 成功的基础上，Gemini 3 兑现了将开发者的任何想法变为现实的承诺。它在零样本生成方面表现出色，能够处理复杂的提示和指令，从而渲染出更丰富、更具交互性的 Web 用户界面。</p>
<p>Gemini 3 是谷歌迄今为止构建的最佳 Vibe 编码和 Agent 编码模型，它使谷歌的产品更加自主，并显著提升了开发者的效率。它在 WebDev Arena 排行榜上名列榜首，获得了令人瞩目的 1487 Elo 分数。此外，它在 Terminal-Bench 2.0 测试中也取得了 54.2% 的成绩，该测试旨在评估模型通过终端操作计算机的工具使用能力。同时，它在 SWE-bench Verified 测试中也大幅超越了 2.5 Pro 版本（得分为 76.2%），该测试用于衡量编码代理的性能。</p>
<p>现在，用户可以使用 Google AI Studio、Vertex AI、Gemini CLI 以及谷歌全新的智能体开发平台 Google Antigravity 中的 Gemini 3 进行构建 。它也适用于 Cursor、GitHub、JetBrains、Manus、Replit 等第三方平台。</p>
<p>比如编写一款具有更丰富的视觉效果和更强交互性的复古 3D 太空飞船游戏。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c680556f960e451a9871df47039e1eff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=y%2B0j1VU1XrxWCapo%2BBcs6b50vdY%3D" alt="图片" loading="lazy"/></p>
<p>再比如编写更丰富、更具交互性的 Web UI 和应用程序：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/007f80b2f7ac49c68f40e7bbc8e46d6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=WhpJiPEl8C93kTc1lyzw3Y8Yzgc%3D" alt="图片" loading="lazy"/></p>
<p>规划任何事</p>
<p>自 Gemini 2 智能体之后，Gemini 显著提升了长周期任务中的规划能力。</p>
<p>Gemini 3 的规划能力在 Vending-Bench 2 测试中进一步得到印证：Gemini 3 在模拟售货机经营测试中登顶该排行榜，全程通过长周期规划管理虚拟商业运营。</p>
<p>在完整模拟年度的运营中，Gemini 3 Pro 始终保持稳定的工具调用与决策连贯性，在持续专注任务目标的同时实现了更高投资回报。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3344f7611f01475ebc0994b52f178b6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=b2GuwBahUHfqCa1b%2BBcl4jHGBqI%3D" alt="图片" loading="lazy"/></p>
<p>Gemini 3 Pro 展现出更卓越的长周期规划能力，与其他前沿模型相比，能创造更高的回报。</p>
<p>Gemini Agent 还可以帮助整理 Gmail 收件箱。</p>
<p>Gemini 3 现已全面开放。即日起，普通用户和订阅用户分别可通过 Gemini App 及搜索 AI 模式使用新模型；开发者与企业客户也能通过 AI Studio、Vertex AI 等渠道接入。至于备受期待的「深度思考模式」，预计将在未来几周内面向 Google AI Ultra 订阅用户独家上线。</p>
<p>另外，根据此前泄露的模型卡，还有许多值得关注的关键信息：Google 使用 TPU 从头开始训练这个模型，作为一个 MoE，具有 1M 输入和 64k token 输出，MoE 意味着他们可以负担得起使其变得便宜。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/488fba85e6bf4d779d80ed172d8904f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=JVTJaLmVzH1q0BR%2B%2BhOLfbNDNSo%3D" alt="图片" loading="lazy"/></p>
<p>定价方面，Gemini 3.0 Pro 引入了基于上下文长度的分级定价机制：200k tokens 以下的任务，输入 / 输出价格为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2.00</mn><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">2.00/</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">2.00/</span></span></span></span></span>12.00（每百万 token）；超过 200k tokens 则分别为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4.00</mn><mtext>和</mtext></mrow><annotation encoding="application/x-tex">4.00 和 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">4.00</span><span class="mord cjk_fallback">和</span></span></span></span></span>18.00。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d374233fcb8498596cfd2549256b384~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=bV5TRD74hbe32qRTxdLFA7vk9Ww%3D" alt="图片" loading="lazy"/></p>
<p>全新的「智能体优先」开发体验</p>
<p>Google Antigravity 是 Google 全新的智能体开发平台，使开发者能够在更高、以任务为导向的层面上进行操作。利用 Gemini 3 先进的推理、工具使用和智能体编程能力，Google Antigravity 将 AI 辅助从开发者工具箱中的一个工具转变为积极的合作伙伴。</p>
<p>虽然 Google Antigravity 的核心是熟悉的 AI IDE（集成开发环境）体验，但其智能体已被提升到一个专用界面，并被赋予直接访问编辑器、终端和浏览器的权限。现在，智能体可以代表你自主规划并同时执行复杂的端到端软件任务，同时验证它们自己的代码。</p>
<p>除了 Gemini 3 Pro，Google Antigravity 还紧密结合了 Google 最新的用于浏览器控制的 Gemini 2.5 Computer Use 模型，以及其顶级的图像编辑模型 Nano Banana (Gemini 2.5 Image)。</p>
<p>一手体验</p>
<p>既然 Gemini 3 Pro 预览版上线了 AI Studio 平台，我们也来上手体验了一把。</p>
<p>Prompt : SVG of NEW YORK SKYLINE Use whatever libraries to get this done but make sure I can paste it all into a single HTML file and open it in Chrome.make it interesting and highly detail , shows details that no one expected go full creative and full beauty in one code block.</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c80297c85c7f4389a4c266b15053975c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=4MYy1bRx2C0hIgaIjJIaL2kvTxg%3D" alt="图片" loading="lazy"/></p>
<p>Prompt: Create a visually stunning Space Invaders game.</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/132dd356610842099e8b0473e208882f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=Fdu%2BfN6IDx5JmycJCGU5kDxL3Ss%3D" alt="图片" loading="lazy"/></p>
<p>鹈鹕骑自行车曾难倒一众大模型，这次我们也让 Gemini 3 试了下。Prompt：An animated SVG of a pelican riding a bicycle.</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24960717397240ebb7c2013a8b6ba7c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=lM4670T2IyG4xi73Of957ryT8L8%3D" alt="图片" loading="lazy"/></p>
<p>相比之前版本，Gemini 3 已有较大进步，不过仍有 bug，比如自行车的脚蹬在天上空转。</p>
<p>我们又换了一个更为清晰的提示词：Create a single, complete, self-contained animated SVG code (no external files or images) of a cute pelican riding a bicycle from a side view. 这次 Gemini 3 生成的自行车似乎没有脚蹬。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71746c1cb2224d45a6789b5e5b69702b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=JByAwk83QzCF6cJnDuWbQsFxL1k%3D" alt="图片" loading="lazy"/></p>
<p>写在最后</p>
<p>在 X 博主 Chubby 发起的「到 2026 年底，哪家公司拥有最好的 LLM?」投票中，Google Gemini 遥遥领先。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed58ea0be2dc4ac6b7359e9a02e8eabb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=Cj%2BiN2h8Jq%2FPqAyW2IstO7Wxe8k%3D" alt="图片" loading="lazy"/></p>
<p>这种市场信心的回升也体现在了数据上，Alphabet CEO Sundar Pichai 在官方博客中回顾了 Gemini 过去两年的进展：AI Overviews 月活跃用户已达 20 亿，Gemini 应用月活突破 6.5 亿，此外更有超过 70% 的云客户以及 1300 万开发者正在使用其生成式模型。</p>
<p>回望过去两年，从 Bard（Gemini 前身）发布时的仓促应战与股价暴跌，到痛定思痛合并 Google DeepMind、召回创始人、斩获诺贝尔奖，Google 完成了一场教科书般的「大象转身」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/278308475ebc49a9b95037ca685d7f25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149641&amp;x-signature=O%2B49OZn1jpEP88bzmLy3bjnaiPo%3D" alt="图片" loading="lazy"/></p>
<p>那个曾经定义了 Transformer、如今「All in Gemini」的巨人，已经做好了全面反击的准备。</p>
<p>至于它到底能不能终结「最好的 LLM」之争？别急，让子弹（和服务器）再飞一会儿。</p>
<p>参考链接：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.google%2Fproducts%2Fgemini%2Fgemini-3%2F%255B%23gemini%255D()-3" target="_blank" title="https://blog.google/products/gemini/gemini-3/%5B#gemini%5D()-3" ref="nofollow noopener noreferrer">blog.google/products/ge…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如视发布空间大模型Argus1.0，支持全景图等多元输入，行业首创！]]></title>    <link>https://juejin.cn/post/7574254039023108122</link>    <guid>https://juejin.cn/post/7574254039023108122</guid>    <pubDate>2025-11-19T09:35:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574254039023108122" data-draft-id="7574105194167730222" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如视发布空间大模型Argus1.0，支持全景图等多元输入，行业首创！"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-19T09:35:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如视发布空间大模型Argus1.0，支持全景图等多元输入，行业首创！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:35:31.000Z" title="Wed Nov 19 2025 09:35:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近来，世界模型（World Model）很火。多个 AI 实验室纷纷展示出令人惊艳的 Demo：仅凭一张图片甚至一段文字，就能生成一个可交互、可探索的 3D 世界。这些演示当然很是炫酷，它们展现了 AI 强大的生成能力。</p>
<p>但一个关键问题随之而来：这些由 AI 生成的世界中，绝大部分事物都是模型想象和虚构的。</p>
<p>如果我们不满足于「创造」一个虚拟世界，而是想把我们当下生活的这个真实世界（比如我们的家、办公室、工厂和城市）完整地变成一个可交互、可计算的 3D 世界呢？</p>
<p>这正是如视（Realsee）想要解答的问题。11 月 13 日，如视，这家数字空间及空间智能综合解决方案引领者，正式发布了其空间大模型 Argus 1.0，这也是全球首个（目前也是唯一一个）支持全景图输入，推测空间深度的大模型。它所代表的正是与虚拟生成截然不同的另一条路径：真实复刻。而这背后，正是「空间智能」相关技术不断演进的结果。</p>
<p>Argus 1.0 的目标不是「虚构」世界，而是「还原」真实的世界。它能够以毫秒级的速度，从一个场景下的单张或多张全景/普通图像中，推理出所有图像带绝对尺度的相机位姿、深度图和点图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b5e0b9b61e4467383c70447443a5a94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149731&amp;x-signature=Wj%2F%2B6KNQ%2FWVcx%2BBH6ILxXO%2FfzAE%3D" alt="图片" loading="lazy"/></p>
<p>体验地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fh5.realsee.cn%2Fargus%3FUTM%3Darticlejqzx" target="_blank" title="https://h5.realsee.cn/argus?UTM=articlejqzx" ref="nofollow noopener noreferrer">h5.realsee.cn/argus?UTM=a…</a></p>
<p>从想象到测量，从虚拟到真实，Argus 1.0 的出现为 2D 图像通向 3D 真实空间架起了一座高速桥梁。这一技术突破意味着什么？它背后是如视怎样的技术积累与战略布局？</p>
<p>带着这些问题，我们与如视副总裁、首席科学家潘慈辉博士进行了深入对话，试图解码 Argus 模型的技术特性，及其在如视「空间智能」版图中的关键角色。</p>
<p>Argus 1.0 诞生的基石</p>
<p>如视的「数字空间-算法-行业应用」飞轮</p>
<p>任何强大模型的诞生都不是空中楼阁，Argus 1.0 也不例外。它根植于如视自 2017 年成立以来，围绕空间数字化所构建的深厚壁垒。在与潘慈辉博士的交流中，他提到了一个核心概念：「数字空间-算法-行业应用」的飞轮循环。而这个飞轮的核心驱动力，正是如视引以为傲的「真实空间数据库」。</p>
<p>核心资产：全球最大的三维空间数据库</p>
<p>作为最初脱胎于贝壳找房的事业部，如视从房产交易这一刚需场景切入，开启了大规模空间数字化的进程。截至 2025 年 9 月，如视已在全球范围内积累了突破 5300 万套的数字空间数据，覆盖面积超过 44 亿平方米。</p>
<p>潘慈辉解释道：「这个全球最大的真实空间数据库，是如视算法能力迭代的驱动器。」</p>
<p>海量数据的积累，持续驱动着空间智能 AI 算法的提升；而更强的系统能力，又为房产租售、家装家居、商业零售、工业园区等九大行业提供了高质量的解决方案；这些解决方案的落地，反过来又让如视得以触达更多元化的空间场景数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0b6ebcc47054e11b4bba7a40798a346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149731&amp;x-signature=VLsrliqXxZ66wy2CHioZ77DB0R8%3D" alt="图片" loading="lazy"/></p>
<p>高质量空间数据：高精度、完备且一致</p>
<p>如果说 5300 万的量构筑了护城河的宽度，那么数据的质则决定了护城河的深度。潘慈辉强调，Argus 1.0 最大的技术突破，正得益于如视坚持自研硬件与算法的技术路线，这为其带来了「完备且一致」的高质量数据。</p>
<p>潘慈辉说：「我们的数据最大的特色，是在硬件设计和标定阶段就保证了最终采集的图像数据和激光点云数据是完备的，并且做到了像素级精度的对齐。」</p>
<p>不同于业内一些只有图像数据（缺乏绝对尺度）或只有激光数据（缺乏纹理）的方案，如视通过自研的伽罗华（Galois）系列 3D 激光扫描仪（其 P4 型号可直出 3 亿像素超高清全景图，图像与点云平均匹配误差小于 2 个像素），确保了每一份数据都是「所见即所得」的高精度数据对。这种在源头就严格标定、高度一致的真实数据，是 Argus 1.0 能够学习到准确深度和绝对尺度的前提，也是其远超其他算法的养料。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ef6c85447144434a5a395be458c1bca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149731&amp;x-signature=%2BuchhuszZqzm57ZkTzC4rfj4pIo%3D" alt="图片" loading="lazy"/></p>
<p>伽罗华 Galois P4 亮点概览</p>
<p>应用导向的底层创新</p>
<p>强大的数据飞轮背后，是一支由如视副总裁、首席科学家潘慈辉博士带领的研发团队。据潘博士介绍，如视从创立之初就坚持应用导向的底层技术创新，平均每年的研发投入都在 2 亿人民币以上。这份坚决的技术投入，造就了如视的技术实力和底气。</p>
<p>持续的耕耘也为如视带来了国际上的权威认可。在学术上，如视团队的科研成果近年来多次入选 ICCV、CVPR 等国际顶会；在产品设计上，旗下的伽罗华 3D 激光扫描仪、REALSEE G1 手机云台和庞加莱手持实景扫描仪接连斩获 2021、2022 及 2023 年德国红点产品设计大奖。如今，这些技术和产品已服务于 9 大行业超过 3000+ 品牌客户，团队也已积累了 600 余项国内外授权专利。</p>
<p>正是这个由海量高质数据、软硬一体化和持续研发投入共同驱动的飞轮，为 Argus 1.0 的诞生奠定了基础。</p>
<p>Argus 1.0</p>
<p>从「单眼」到「百眼」的空间智能突破</p>
<p>如视算法团队喜欢用希腊神话人物为产品命名。潘慈辉在采访中分享道，单目图像深度估计算法 Cyclops（希腊神话中的独眼巨人），寓意着从单张图像、单一视角就能推测世界的深度。</p>
<p>而此次发布的 Argus 1.0，名称则源自希腊神话中的「百眼巨人」。这一命名极富象征意义，它预示着如视的重建技术正从「单视」推测跨越到「多视」全局一致性的新阶段。</p>
<p>具体技术上，Argus 1.0 基于 Transformer 架构构建，是一个前馈式神经网络模型。该模型基于如视累积的 近百万套真实高清空间数据（包含对玻璃、镜面等难题的处理）进行训练。得益于 Transformer 架构的通用性及其与大规模 3D 数据训练的协同效应，Argus 1.0 实现了兼容性、实时性与生成质量三大维度的行业突破。</p>
<p>兼容性：业界首个支持全景图输入的推测大模型</p>
<p>首先是输入端的巨大突破。Argus 1.0 是目前业界已知首个、也是唯一一个支持全景图作为输入的深度推测大模型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa0a5c3438024c0283c9e8fb1e32588e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149731&amp;x-signature=Cm5lJbKyOnhwqZ80z7KYMwqIfnA%3D" alt="图片" loading="lazy"/></p>
<p>Argus 1.0 甚至可以将 AI 生成的全景图转换成点云</p>
<p>同时，它还广泛兼容单张 / 多张普通照片乃至 AI 生成的图片，具备极强的多源适应能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b494b135316843ea970629cf876cd082~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149731&amp;x-signature=OEEgCUag%2FS3E5ptRMD6r9Toy%2Fl0%3D" alt="图片" loading="lazy"/></p>
<p>Argus 1.0 也支持普通图转点云</p>
<p>全景图推测深度的能力之所以重要，在于它直指 VR 内容生产的核心痛点。潘慈辉表示，Argus 1.0 能够「显著降低搭建全景图到 VR 的处理流程的门槛，极大提高处理效率」，让低成本、高效率的 3D 空间复刻成为可能。</p>
<p>实时性与一致性：毫秒级的全局重建</p>
<p>如果说 Cyclops 时代还是两步走，即先用算法推测单张全景图的深度，再通过额外的算法模块计算位姿、进行拼接；那么 Argus 1.0 则实现了一步到位。</p>
<p>潘慈辉向我们揭示了 Argus 1.0 的核心架构创新：「此次 Argus 的能力，是将之前 Cyclops 的深度推测能力和后续的位姿计算能力，融合到了一个算法模块中。」</p>
<p>通过将深度推测和位姿计算进行联合训练，模型得以更好地挖掘多视图之间的关联性，从而在全局尺度上实现更高的点云一致性和位姿精度。这一增量式到全局式的转变，带来了效率的质变。如视的官方报告显示，Argus 1.0 的推理效率达到毫秒级，是首个实时的全景图全局重建系统，真正实现了「全流程无感知响应」。</p>
<p>高质量：源自真实数据的稳健性</p>
<p>Argus 1.0 的高生成质量，则要归功于前文提到的如视独有的高精度、带尺度、像素级对齐的真实数据库。</p>
<p>在 3D 重建领域，玻璃、镜面、毛坯房、长走廊等场景一直是行业公认的难题。潘慈辉指出，其根源在于「一般的激光设备对玻璃镜子的测距能力不足，导致大家在学习过程中没有较好的监督数据」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/901c5a4008c2417e81c08d2426dec0b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149731&amp;x-signature=IGpFM8pJHtM8pG10WFSlCDsszTo%3D" alt="图片" loading="lazy"/></p>
<p>而如视的解决方案是其多年技术的自然结果：「我们的业务场景中会有专门的工具对玻璃镜子进行标注，根据这些标注，我们修正原始的有问题的激光点云。使用修正后的激光数据进行训练就能很好地解决这一难题。」</p>
<p>正是得益于海量、多样化且经过精细业务标注的养料，Argus 1.0 充分学习并掌握了这些困难场景的特征，使其在面对传统重建难题时依然表现稳定，生成的 3D 空间显著优于其他缺乏真实尺度和对齐能力的方案。</p>
<p>如视的版图</p>
<p>空间智能「四层理论」与 AIGC 终局</p>
<p>Argus 1.0 的发布，不仅是一款工具的升级，更是如视「空间智能」版图中的一块关键拼图。潘慈辉在采访中详细阐述了团队的研发脉络：一个结合自身实践总结出的「空间智能四层理论」。</p>
<p>这四层理论清晰地定义了从数字化到智能化的演进路径：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/117dc37d092b46afb2799668a536cbf8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149731&amp;x-signature=0kkbBUd%2FWtd6tH9gXwTx4ponM5o%3D" alt="图片" loading="lazy"/></p>
<ol>
<li>
<p>第一层：物理数据（重建）：即 1:1 复刻；</p>
</li>
<li>
<p>第二层：潜藏数据（感知推理）：理解空间结构、语义；</p>
</li>
<li>
<p>第三层：融合数据（业务）：结合 CAD、IoT 等业务数据；</p>
</li>
<li>
<p>第四层：AIGC（生成交互）：解决开集问题，实现泛化交互。</p>
</li>
</ol>
<p>在这个框架下，Argus 1.0 是第一层（重建）的集大成者。它打通的 2D 到 3D 能力已经可以赋能诸多应用场景。例如，它可以用于生成时下流行的动态锁屏空间壁纸；潘慈辉在采访中提到：「Argus 模型推测的深度精度更高，分辨率更高，且深度带有绝对尺度信息」，效果优于苹果披露使用的深度推测算法。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/645e0493659040539e81c8c761979f9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149731&amp;x-signature=cmIi4uze%2FGdA9UnJepqiQENkCrw%3D" alt="图片" loading="lazy"/></p>
<p>更进一步，如视透露，预计于明年初发布的 Argus 2.0 及后续版本可进一步用于实时渲染的 3DGS 模型和精细 Mesh 模型，为空间漫游提供沉浸式数字基底。通过与如视自研的空间智能算法结合，它还能驱动空间 CAD 自动生成、高精度语义分割及白模构建等高阶应用，实现从物理世界到数字空间，再赋能现实应用的闭环。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6789159b47d9468094b378751b5a23db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764149731&amp;x-signature=sGOAqeE3ROf9dyK9XKIulD4g6Wg%3D" alt="图片" loading="lazy"/></p>
<p>潘慈辉也明确指出，团队的下一个重点难题，正是攻克第四层：AIGC 层。他认为，许多应用的答案不在空间本身，而在于链接「空间之外的信息」，如行业规范、人类偏好等。他总结道：「我们希望当 AIGC 这一层实现后，利用其空间之外的信息能力，我们能更加快速、低成本地对接更多的行业，输出解决方案。」</p>
<p>开放生态</p>
<p>为空间智能行业铺路</p>
<p>在实现自身技术闭环的同时，如视也发挥自身优势，为整个空间智能行业的基础设施「铺路」。</p>
<p>长期以来，空间智能领域的研究与应用面临着一个瓶颈问题：空间智能的「基石」—— 高质量的空间数据，存在巨大缺口。而如视一直以来的技术成果，恰好为解决这一问题打开了一扇窗。</p>
<p>因此，为了加速整个空间智能应用领域的研究演进，如视计划于今年年底开放 10000 套的室内房屋数据集（其中 1000 套新房数据、9000 套 AI 设计数据），这同时也是目前最大规模的空间三维数据集。这种开放生态，让更多人能站在如视积累的真实数据之上进行创新，从而整个行业的发展。</p>
<p>迈向空间智能的 AIGC 终局</p>
<p>从最初服务于房产交易的 VR 看房，到如今赋能九大行业的空间智能；从打磨软硬一体的采集闭环，到发布毫秒级的深度推测大模型 Argus，如视的路径清晰地展现了其「数字空间 - 算法 - 行业应用」飞轮的强大势能。</p>
<p>Argus 1.0 的发布，不仅是如视的飞轮势能的一次集中爆发，它也是一个空间信息解码器，为 3D 视觉领域带来了一个低门槛、高效率、高质量的基础工具。它向行业证明了一条核心路径：海量、高精度、高一致性的真实世界数据是训练空间基础大模型的决定性优势。</p>
<p>这标志着空间智能领域一个新纪元的开始：以真实数据为基石，从底层重建走向顶层 AIGC 应用的路径被正式打通。</p>
<p>随着如视这样的空间数据巨头不断推动技术演进和生态开放，一个万物可计算、虚实深度融合的未来，正加速向我们走来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[抓包技术全面指南：原理、工具与应用场景]]></title>    <link>https://juejin.cn/post/7574105194167828526</link>    <guid>https://juejin.cn/post/7574105194167828526</guid>    <pubDate>2025-11-19T09:40:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574105194167828526" data-draft-id="7574217823105630259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="抓包技术全面指南：原理、工具与应用场景"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T09:40:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aiopencode"/> <meta itemprop="url" content="https://juejin.cn/user/1898230261493865"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            抓包技术全面指南：原理、工具与应用场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1898230261493865/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aiopencode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:40:30.000Z" title="Wed Nov 19 2025 09:40:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>抓包技术详解：网络通信的幕后英雄</p>
<p>抓包的定义</p>
<p>抓包，简单来说，就是网络抓包。它是一种在网络通信过程中捕获和分析数据包的技术。通过抓包，我们可以了解网络通信的细节，包括数据的来源、去向以及传输内容等。</p>
<p>抓包的基本原理</p>
<p>网络数据以数据包的形式传输。抓包利用网卡的混杂模式，让网卡能够接收所有流经的数据包，而不仅仅是发送给它的。然后通过抓包工具解析、分析这些数据包，将它们以可读的形式呈现出来。</p>
<p>抓包工具</p>
<p>Wireshark：这是一款开源且跨平台的抓包工具，具有强大的协议解析能力。它可以通过图形化界面查看数据包的详细信息，还能过滤和统计，非常便于分析。</p>
<p>tcpdump：主要用于Linux系统，通过命令行进行抓包。它可以通过灵活的命令指定抓包条件，将结果输出到终端或文件。</p>
<p>Fiddler：这款工具主要针对HTTP和HTTPS协议，在Web开发和测试中非常有用。它可以作为代理服务器拦截、查看并修改HTTP通信内容。</p>
<p>Sniffmaster：作为一款全平台抓包工具，Sniffmaster 支持 HTTPS、TCP 和 UDP 协议，可在 iOS、Android、Mac 和 Windows 设备上实现无需代理、越狱或 root 的抓包操作。它提供 HTTPS 暴力抓包、数据流抓包和代理抓包等功能，非常适合移动应用开发和网络调试。</p>
<p>应用场景</p>
<p>网络故障排查：当网络出现访问异常、延迟高或数据错误等问题时，抓包可以帮助我们获取通信信息，定位是网络设备、服务器还是客户端的故障。</p>
<p>网络安全检测：通过分析数据包，可以检测恶意攻击和数据泄露等安全威胁，保障网络安全。</p>
<p>网络性能优化：抓包可以帮助我们分析带宽使用、传输延迟和丢包率等，找到性能瓶颈，以便优化网络配置和应用程序代码。</p>
<p>协议分析与研究：对于研究人员来说，抓包可以让他们了解协议的运行机制，验证协议的正确性，为协议改进和创新提供依据。</p>
<p>希望这篇文章能帮助大家更好地理解抓包技术，下次再遇到网络问题时，不妨试试抓包工具，或许能帮你快速定位问题所在！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Amis源码阅读】低代码如何实现交互？（上）]]></title>    <link>https://juejin.cn/post/7574245883635204148</link>    <guid>https://juejin.cn/post/7574245883635204148</guid>    <pubDate>2025-11-19T09:40:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245883635204148" data-draft-id="7574245788948856847" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Amis源码阅读】低代码如何实现交互？（上）"/> <meta itemprop="keywords" content="前端,低代码"/> <meta itemprop="datePublished" content="2025-11-19T09:40:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云鹤_"/> <meta itemprop="url" content="https://juejin.cn/user/2647279733054638"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Amis源码阅读】低代码如何实现交互？（上）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2647279733054638/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云鹤_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:40:34.000Z" title="Wed Nov 19 2025 09:40:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>基于 6.13.0 版本</p>
</blockquote>
<p><strong>前期回顾</strong></p>
<ol>
<li><a href="https://juejin.cn/post/7559794761037545513" target="_blank" title="https://juejin.cn/post/7559794761037545513">【Amis源码阅读】组件注册方法远比预想的多！</a></li>
<li><a href="https://juejin.cn/post/7561753990247694388" target="_blank" title="https://juejin.cn/post/7561753990247694388">【Amis源码阅读】如何将json配置渲染成页面？</a></li>
</ol>
<h2 data-id="heading-0">前言</h2>
<ul>
<li>组件渲染搞定了，那组件如何进行交互呢？<code>amis</code>提出了<strong>事件动作</strong>的概念，在监听到事件后通过动作做出反应
<ul>
<li>事件：
<ul>
<li>渲染器事件：组件内部执行的事件，会暴露给外部监听。比如初始化、点击、值变化等事件</li>
<li>广播事件：全局事件，其他组件可在自身监听相关广播事件</li>
</ul>
</li>
<li>动作：监听到事件时，希望执行的逻辑。比如打开弹窗、<code>toast</code>提示、刷新接口等</li>
</ul>
</li>
<li>本篇先聊事件的工作逻辑，从常用的渲染器事件入手（渲染器等同组件）</li>
</ul>
<h2 data-id="heading-1">渲染器事件</h2>
<h3 data-id="heading-2">onEvent事件监听</h3>
<ul>
<li><code>amis</code>支持<code>onEvent</code>的形式监听组件事件的触发时机，比如组件被点击时触发一个<code>toast</code>。那写入<code>onEvent</code>中的动作是何时何地被执行的呢？</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx">{
  <span class="hljs-string">"onEvent"</span>: {
    <span class="hljs-string">"click"</span>: {
      <span class="hljs-string">"actions"</span>: [ 
        {
          <span class="hljs-string">"actionType"</span>: <span class="hljs-string">"toast"</span>,
          <span class="hljs-string">"args"</span>: {
            <span class="hljs-string">"msgType"</span>: <span class="hljs-string">"success"</span>,
            <span class="hljs-string">"msg"</span>: <span class="hljs-string">"点击成功"</span>
          }
        }
      ]
    }
  }
}
</code></pre>
<h3 data-id="heading-3">组件中的事件触发</h3>
<ul>
<li>以常见的<code>Page</code>组件中<code>init</code>（初始化）事件为例，它实际就是在类组件的<code>componentDidMount</code>生命周期（挂载阶段）中触发了一次，<code>dispatchEvent</code>就是事件的入口了</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// packages/amis/src/renderers/Page.tsx</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Page</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span>&lt;<span class="hljs-title class_">PageProps</span>&gt; {
	...
	
	<span class="hljs-keyword">async</span> <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> {
      initApi,
      initFetch,
      initFetchOn,
      store,
      messages,
      data,
      dispatchEvent,
      env
    } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mounted</span> = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">const</span> rendererEvent = <span class="hljs-keyword">await</span> <span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-string">'init'</span>, data, <span class="hljs-variable language_">this</span>);
		...
  }
}
</code></pre>
<ul>
<li>再以<code>Tpl</code>组件中的<code>click</code>（点击）、<code>mouseenter</code>（鼠标移入）、<code>mouseleave</code>（鼠标移出）事件为例，可以直观的看出他们就是在组件绑定的<code>onClick</code>、<code>onMouseEnter</code>、<code>onMouseLeave</code>事件中执行了一遍<code>dispatchEvent</code></li>
<li>此时可以推测出，<code>onEvent</code>应该是在<code>dispatchEvent</code>中被执行了</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// packages/amis/src/renderers/Tpl.tsx</span>

<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">TplSchema</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseSchema</span> {
	...
	
	@autobind
  <span class="hljs-title function_">handleClick</span>(<span class="hljs-params">e: React.MouseEvent&lt;HTMLDivElement&gt;</span>) {
    <span class="hljs-keyword">const</span> {dispatchEvent, data} = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;
    <span class="hljs-title function_">dispatchEvent</span>(e, data);
  }
  
  @autobind
  <span class="hljs-title function_">handleMouseEnter</span>(<span class="hljs-params">e: React.MouseEvent&lt;any&gt;</span>) {
    <span class="hljs-keyword">const</span> {dispatchEvent, data} = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;
    <span class="hljs-title function_">dispatchEvent</span>(e, data);
  }

  @autobind
  <span class="hljs-title function_">handleMouseLeave</span>(<span class="hljs-params">e: React.MouseEvent&lt;any&gt;</span>) {
    <span class="hljs-keyword">const</span> {dispatchEvent, data} = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;
    <span class="hljs-title function_">dispatchEvent</span>(e, data);
  }
  
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
	  <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span>
	      <span class="hljs-attr">...</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.handleClick}</span>
        <span class="hljs-attr">onMouseEnter</span>=<span class="hljs-string">{this.handleMouseEnter}</span>
        <span class="hljs-attr">onMouseLeave</span>=<span class="hljs-string">{this.handleMouseLeave}</span>
        {<span class="hljs-attr">...testIdBuilder</span>?<span class="hljs-attr">.getChild</span>('<span class="hljs-attr">tpl</span>')?<span class="hljs-attr">.getTestId</span>()}
      &gt;</span>
        ...
      <span class="hljs-tag">&lt;/<span class="hljs-name">Component</span>&gt;</span></span>
    );
  }
}
</code></pre>
<h3 data-id="heading-4">工作流</h3>
<h4 data-id="heading-5">触发事件（dispatchEvent）</h4>
<ul>
<li><code>broadcast</code>参数可忽略，没用（<code>factory.tsx</code>中的类型定义也说明了这点）</li>
<li><code>rendererEventListeners</code>是个全局变量（事件队列），所有的事件监听器都存储在这</li>
<li><code>dispatchEvent</code>流程
<ul>
<li><code>bindEvent</code>绑定事件，返回<code>unbindEvent</code>销毁函数</li>
<li><code>createRendererEvent</code>创建事件对象</li>
<li>事件队列里的事件按权重排序确定执行优先级</li>
<li>遍历事件队列，若有事件有<code>debounce</code>属性，就设置防抖，同时设置<code>executing</code>为真；若没有就直接执行事件（<code>runAction</code>）</li>
<li>遍历事件队列的时候会通过<code>checkExecuted</code>函数计数，当遍历完毕后（也就意味着事件都执行完毕了，会等待防抖的事件执行完），执行<code>unbindEvent</code>销毁事件</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// packages/amis-core/src/utils/renderer-event.ts</span>

<span class="hljs-keyword">let</span> <span class="hljs-attr">rendererEventListeners</span>: <span class="hljs-title class_">RendererEventListener</span>[] = [];
...

<span class="hljs-comment">// 触发事件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-params">
  e: string | React.MouseEvent&lt;any&gt;,
  renderer: React.Component&lt;RendererProps&gt;,
  scoped: IScopedContext,
  data: any,
  broadcast?: RendererEvent&lt;any&gt;
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">RendererEvent</span>&lt;any&gt; | <span class="hljs-keyword">void</span>&gt; {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">unbindEvent</span>: (<span class="hljs-function">(<span class="hljs-params">eventName?: string</span>) =&gt;</span> <span class="hljs-keyword">void</span>) | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> eventName = <span class="hljs-keyword">typeof</span> e === <span class="hljs-string">'string'</span> ? e : e.<span class="hljs-property">type</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-keyword">from</span> = renderer?.<span class="hljs-property">props</span>.<span class="hljs-property">id</span> || renderer?.<span class="hljs-property">props</span>.<span class="hljs-property">name</span> || <span class="hljs-string">''</span>;
	...

  broadcast &amp;&amp; renderer.<span class="hljs-property">props</span>.<span class="hljs-property">onBroadcast</span>?.(e <span class="hljs-keyword">as</span> string, broadcast, data);

  <span class="hljs-keyword">if</span> (!broadcast) {
    <span class="hljs-keyword">const</span> eventConfig = renderer?.<span class="hljs-property">props</span>?.<span class="hljs-property">onEvent</span>?.[eventName];

    <span class="hljs-keyword">if</span> (!eventConfig) {
      <span class="hljs-comment">// 没命中也没关系</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
    }

    unbindEvent = <span class="hljs-title function_">bindEvent</span>(renderer);
  }
  <span class="hljs-comment">// 没有可处理的监听</span>
  <span class="hljs-keyword">if</span> (!rendererEventListeners.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
  }
  <span class="hljs-comment">// 如果是广播动作，就直接复用</span>
  <span class="hljs-keyword">const</span> rendererEvent =
    broadcast ||
    <span class="hljs-title function_">createRendererEvent</span>(eventName, {
      <span class="hljs-attr">env</span>: renderer?.<span class="hljs-property">props</span>?.<span class="hljs-property">env</span>,
      <span class="hljs-attr">nativeEvent</span>: e,
      data,
      scoped
    });

  <span class="hljs-comment">// 过滤&amp;排序</span>
  <span class="hljs-keyword">const</span> listeners = rendererEventListeners
    .<span class="hljs-title function_">filter</span>(
      <span class="hljs-function">(<span class="hljs-params">item: RendererEventListener</span>) =&gt;</span>
        item.<span class="hljs-property">type</span> === eventName &amp;&amp;
        (broadcast
          ? <span class="hljs-literal">true</span>
          : item.<span class="hljs-property">renderer</span> === renderer &amp;&amp;
            item.<span class="hljs-property">actions</span> === renderer.<span class="hljs-property">props</span>?.<span class="hljs-property">onEvent</span>?.[eventName].<span class="hljs-property">actions</span>)
    )
    .<span class="hljs-title function_">sort</span>(
      <span class="hljs-function">(<span class="hljs-params">prev: RendererEventListener, next: RendererEventListener</span>) =&gt;</span>
        next.<span class="hljs-property">weight</span> - prev.<span class="hljs-property">weight</span>
    );
  <span class="hljs-keyword">let</span> executedCount = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkExecuted</span> = (<span class="hljs-params"/>) =&gt; {
    executedCount++;
    <span class="hljs-keyword">if</span> (executedCount === listeners.<span class="hljs-property">length</span>) {
      unbindEvent?.(eventName);
    }
  };
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> listener <span class="hljs-keyword">of</span> listeners) {
    <span class="hljs-keyword">const</span> {
      wait = <span class="hljs-number">100</span>,
      trailing = <span class="hljs-literal">true</span>,
      leading = <span class="hljs-literal">false</span>,
      maxWait = <span class="hljs-number">10000</span>
    } = listener?.<span class="hljs-property">debounce</span> || {};
    <span class="hljs-keyword">if</span> (listener?.<span class="hljs-property">debounce</span>) {
      <span class="hljs-keyword">const</span> debounced = <span class="hljs-title function_">debounce</span>(
        <span class="hljs-keyword">async</span> () =&gt; {
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">runActions</span>(listener.<span class="hljs-property">actions</span>, listener.<span class="hljs-property">renderer</span>, rendererEvent);
          <span class="hljs-title function_">checkExecuted</span>();
        },
        wait,
        {
          trailing,
          leading,
          maxWait
        }
      );
      rendererEventListeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
        <span class="hljs-comment">// 找到事件队列中正在执行的事件加上标识，下次待执行队列就会把这个事件过滤掉</span>
        <span class="hljs-keyword">if</span> (
          item.<span class="hljs-property">renderer</span> === listener.<span class="hljs-property">renderer</span> &amp;&amp;
          listener.<span class="hljs-property">type</span> === item.<span class="hljs-property">type</span>
        ) {
          item.<span class="hljs-property">executing</span> = <span class="hljs-literal">true</span>;
          item.<span class="hljs-property">debounceInstance</span> = debounced;
        }
      });
      <span class="hljs-title function_">debounced</span>();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">runActions</span>(listener.<span class="hljs-property">actions</span>, listener.<span class="hljs-property">renderer</span>, rendererEvent);
      <span class="hljs-title function_">checkExecuted</span>();
    }

    <span class="hljs-keyword">if</span> (listener?.<span class="hljs-property">track</span>) {
      <span class="hljs-keyword">const</span> {<span class="hljs-attr">id</span>: trackId, <span class="hljs-attr">name</span>: trackName} = listener.<span class="hljs-property">track</span>;
      renderer?.<span class="hljs-property">props</span>?.<span class="hljs-property">env</span>?.<span class="hljs-title function_">tracker</span>({
        <span class="hljs-attr">eventType</span>: listener.<span class="hljs-property">type</span>,
        <span class="hljs-attr">eventData</span>: {
          trackId,
          trackName
        }
      });
    }

    <span class="hljs-comment">// 停止后续监听器执行</span>
    <span class="hljs-keyword">if</span> (rendererEvent.<span class="hljs-property">stoped</span>) {
      <span class="hljs-keyword">break</span>;
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(rendererEvent);
}
</code></pre>
<h4 data-id="heading-6">绑定事件（bindEvent）</h4>
<ul>
<li>所谓绑定事件就是把事件推入事件队列</li>
<li>首先会遍历<code>onEvent</code>中的内容</li>
<li>然后处理防抖场景：如果存在<strong>相同的事件且在防抖时间内（<code>executing</code>为真）</strong>，则取消旧事件防抖并移除旧事件，把新事件加入事件队列。比如说，事件队列中存有用户触发了3次的事件<code>a</code>（假设都在防抖时间内），则前2次事件在<code>bindEvent</code>阶段会被删除，只保留第3次事件</li>
<li>如果不存在上述情况，直接加入事件队列</li>
<li>最终都是返回解绑事件的函数（从事件队列中移除）</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// packages/amis-core/src/utils/renderer-event.ts</span>

<span class="hljs-comment">// 绑定事件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">bindEvent</span> = (<span class="hljs-params">renderer: any</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!renderer) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  }
  <span class="hljs-keyword">const</span> <span class="hljs-attr">listeners</span>: <span class="hljs-title class_">EventListeners</span> = renderer.<span class="hljs-property">props</span>.<span class="hljs-property">$schema</span>.<span class="hljs-property">onEvent</span>;
  <span class="hljs-keyword">if</span> (listeners) {
    <span class="hljs-comment">// 暂存</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(listeners)) {
      <span class="hljs-keyword">const</span> listener = rendererEventListeners.<span class="hljs-title function_">find</span>(
        <span class="hljs-function">(<span class="hljs-params">item: RendererEventListener</span>) =&gt;</span>
          item.<span class="hljs-property">renderer</span> === renderer &amp;&amp;
          item.<span class="hljs-property">type</span> === key &amp;&amp;
          item.<span class="hljs-property">actions</span> === listeners[key].<span class="hljs-property">actions</span>
      );
	    <span class="hljs-comment">// 存在相同的事件且在防抖时间内</span>
      <span class="hljs-keyword">if</span> (listener?.<span class="hljs-property">executing</span>) {
        listener?.<span class="hljs-property">debounceInstance</span>?.<span class="hljs-property">cancel</span>?.();
        rendererEventListeners = rendererEventListeners.<span class="hljs-title function_">filter</span>(
          <span class="hljs-function">(<span class="hljs-params">item: RendererEventListener</span>) =&gt;</span>
            !(
              item.<span class="hljs-property">renderer</span> === listener.<span class="hljs-property">renderer</span> &amp;&amp; item.<span class="hljs-property">type</span> === listener.<span class="hljs-property">type</span>
            )
        );
        listener.<span class="hljs-property">actions</span>.<span class="hljs-property">length</span> &amp;&amp;
          rendererEventListeners.<span class="hljs-title function_">push</span>({
            renderer,
            <span class="hljs-attr">type</span>: key,
            <span class="hljs-attr">debounce</span>: listener.<span class="hljs-property">debounce</span> || <span class="hljs-literal">null</span>,
            <span class="hljs-attr">track</span>: listeners[key].<span class="hljs-property">track</span> || <span class="hljs-literal">null</span>,
            <span class="hljs-attr">weight</span>: listener.<span class="hljs-property">weight</span> || <span class="hljs-number">0</span>,
            <span class="hljs-attr">actions</span>: listener.<span class="hljs-property">actions</span>
          });
      }
      <span class="hljs-keyword">if</span> (!listener &amp;&amp; listeners[key].<span class="hljs-property">actions</span>?.<span class="hljs-property">length</span>) {
        rendererEventListeners.<span class="hljs-title function_">push</span>({
          renderer,
          <span class="hljs-attr">type</span>: key,
          <span class="hljs-attr">debounce</span>: listeners[key].<span class="hljs-property">debounce</span> || <span class="hljs-literal">null</span>,
          <span class="hljs-attr">track</span>: listeners[key].<span class="hljs-property">track</span> || <span class="hljs-literal">null</span>,
          <span class="hljs-attr">weight</span>: listeners[key].<span class="hljs-property">weight</span> || <span class="hljs-number">0</span>,
          <span class="hljs-attr">actions</span>: listeners[key].<span class="hljs-property">actions</span>
        });
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">eventName?: string</span>) =&gt;</span> {
      <span class="hljs-comment">// eventName用来避免过滤广播事件</span>
      rendererEventListeners = rendererEventListeners.<span class="hljs-title function_">filter</span>(
        <span class="hljs-function">(<span class="hljs-params">item: RendererEventListener</span>) =&gt;</span>
          <span class="hljs-comment">// 如果 eventName 为 undefined，表示全部解绑，否则解绑指定事件</span>
          eventName === <span class="hljs-literal">undefined</span>
            ? item.<span class="hljs-property">renderer</span> !== renderer
            : item.<span class="hljs-property">renderer</span> !== renderer || item.<span class="hljs-property">type</span> !== eventName
      );
    };
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
};
</code></pre>
<h4 data-id="heading-7">执行动作（runActions）</h4>
<ul>
<li>这里只是一个执行动作的前置处理</li>
<li>遍历动作，通过<code>getActionByType</code>查找动作实例，若没有则判断是否是组件专有动作（组件都有可调用），若再没有则判断是否是打开页面相关的动作，若还是没有则直接调用组件自定义的动作</li>
<li>实际的动作执行还是在<code>runAction</code>中，等下一篇再完整的分析动作相关流程</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// packages/amis-core/src/actions/Action.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">runActions</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
  actions: ListenerAction | ListenerAction[],
  renderer: ListenerContext,
  event: any
</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(actions)) {
    actions = [actions];
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> actionConfig <span class="hljs-keyword">of</span> actions) {
    <span class="hljs-keyword">let</span> actionInstrance = <span class="hljs-title function_">getActionByType</span>(actionConfig.<span class="hljs-property">actionType</span>);

    <span class="hljs-comment">// 如果存在指定组件ID，说明是组件专有动作</span>
    <span class="hljs-keyword">if</span> (
      !actionInstrance &amp;&amp;
      (actionConfig.<span class="hljs-property">componentId</span> || actionConfig.<span class="hljs-property">componentName</span>)
    ) {
      actionInstrance = [
        <span class="hljs-string">'static'</span>,
        <span class="hljs-string">'nonstatic'</span>,
        <span class="hljs-string">'show'</span>,
        <span class="hljs-string">'visibility'</span>,
        <span class="hljs-string">'hidden'</span>,
        <span class="hljs-string">'enabled'</span>,
        <span class="hljs-string">'disabled'</span>,
        <span class="hljs-string">'usability'</span>
      ].<span class="hljs-title function_">includes</span>(actionConfig.<span class="hljs-property">actionType</span>)
        ? <span class="hljs-title function_">getActionByType</span>(<span class="hljs-string">'status'</span>)
        : <span class="hljs-title function_">getActionByType</span>(<span class="hljs-string">'component'</span>);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ([<span class="hljs-string">'url'</span>, <span class="hljs-string">'link'</span>, <span class="hljs-string">'jump'</span>].<span class="hljs-title function_">includes</span>(actionConfig.<span class="hljs-property">actionType</span>)) {
      <span class="hljs-comment">// 打开页面动作</span>
      actionInstrance = <span class="hljs-title function_">getActionByType</span>(<span class="hljs-string">'openlink'</span>);
    }

    <span class="hljs-comment">// 找不到就通过组件专有动作完成</span>
    <span class="hljs-keyword">if</span> (!actionInstrance) {
      actionInstrance = <span class="hljs-title function_">getActionByType</span>(<span class="hljs-string">'component'</span>);
    }

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 这些节点的子节点运行逻辑由节点内部实现</span>
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">runAction</span>(actionInstrance, actionConfig, renderer, event);
    } <span class="hljs-keyword">catch</span> (e) {
      ...
    }

    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">stoped</span>) {
      <span class="hljs-keyword">break</span>;
    }
  }
};
</code></pre>
<h3 data-id="heading-8">设计特性</h3>
<h4 data-id="heading-9">全局事件管理</h4>
<ul>
<li>通过<code>rendererEventListeners</code>队列统一管理，和<code>react</code>的事件委托有点类似</li>
<li>支持跨组件通信</li>
<li>支持全局权重排序、防抖</li>
</ul>
<h4 data-id="heading-10">延迟绑定，执行完销毁</h4>
<ul>
<li>事件都是触发后，在<code>bindEvent</code>中绑定的（加入事件队列），<strong>减少内存占用</strong></li>
<li>然后执行完毕会立即销毁，<strong>避免内存泄漏</strong></li>
</ul>
<h2 data-id="heading-11">广播事件</h2>
<ul>
<li>独立于渲染器事件的全局事件，基于<code>BroadcastChannel</code>类实现</li>
</ul>
<h3 data-id="heading-12">工作流</h3>
<ul>
<li>由于是全局事件，肯定得优先绑定了</li>
</ul>
<h4 data-id="heading-13">绑定事件入口</h4>
<ul>
<li>组件渲染（渲染流程可参考之前的组件渲染篇）时绑定</li>
<li>组件生成时都会传入<code>childRef</code>，直接在组件的<code>ref</code>上通过<code>bindGlobalEvent</code>绑定了广播事件</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// packages/amis-core/src/SchemaRenderer.tsx</span>

<span class="hljs-keyword">import</span> {
  bindEvent,
  bindGlobalEventForRenderer <span class="hljs-keyword">as</span> bindGlobalEvent
} <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/renderer-event'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SchemaRenderer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span>&lt;<span class="hljs-title class_">SchemaRendererProps</span>, any&gt; {
	...
	@autobind
  <span class="hljs-title function_">childRef</span>(<span class="hljs-params">ref: any</span>) {
    ...
    <span class="hljs-keyword">while</span> (ref?.<span class="hljs-property">getWrappedInstance</span>?.()) {
      ref = ref.<span class="hljs-title function_">getWrappedInstance</span>();
    }

    ...

    <span class="hljs-keyword">if</span> (ref) {
      <span class="hljs-comment">// 这里无法区分监听的是不是广播，所以又bind一下，主要是为了绑广播</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">unbindEvent</span>?.();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">unbindGlobalEvent</span>?.();

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">unbindEvent</span> = <span class="hljs-title function_">bindEvent</span>(ref);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">unbindGlobalEvent</span> = <span class="hljs-title function_">bindGlobalEvent</span>(ref);
    }
    ...
  }
  
  <span class="hljs-title function_">render</span>(): <span class="hljs-variable constant_">JSX</span>.<span class="hljs-property">Element</span> | <span class="hljs-literal">null</span> {
		...

    <span class="hljs-keyword">let</span> component = supportRef ? (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> {<span class="hljs-attr">...props</span>} <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.childRef}</span> <span class="hljs-attr">storeRef</span>=<span class="hljs-string">{this.storeRef}</span> /&gt;</span></span>
    ) : (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span>
        {<span class="hljs-attr">...props</span>}
        <span class="hljs-attr">forwardedRef</span>=<span class="hljs-string">{this.childRef}</span>
        <span class="hljs-attr">storeRef</span>=<span class="hljs-string">{this.storeRef}</span>
      /&gt;</span></span>
    );

    ...

    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">env</span>.<span class="hljs-property">enableAMISDebug</span> ? (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">DebugWrapper</span> <span class="hljs-attr">renderer</span>=<span class="hljs-string">{renderer}</span>&gt;</span>{component}<span class="hljs-tag">&lt;/<span class="hljs-name">DebugWrapper</span>&gt;</span></span>
    ) : (
      component
    );
  }
}
</code></pre>
<h4 data-id="heading-14">绑定事件（bindGlobalEventForRenderer）</h4>
<ul>
<li>这里并未区分广播事件</li>
<li>遍历事件，创建<code>BroadcastChannel</code>对象，推入<code>bcs</code>广播事件队列</li>
<li>挂载<code>onmessage</code>消息监听，接收到广播时通过<code>runActions</code>触发动作</li>
<li>最终返回一个注销广播实例的函数</li>
<li>小疑问：这里直接把<code>renderer.props.$schema.onEvent</code>中所有的动作都绑定了广播事件，虽然统一管理了广播事件的绑定，但是绑定了很多多余的动作，这里实际可以判断<code>actionType</code>为<code>broadcast</code>才绑定？</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// packages/amis-core/src/utils/renderer-event.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">bindGlobalEventForRenderer</span> = (<span class="hljs-params">renderer: any</span>) =&gt; {
  ...
  <span class="hljs-keyword">const</span> <span class="hljs-attr">listeners</span>: <span class="hljs-title class_">EventListeners</span> = renderer.<span class="hljs-property">props</span>.<span class="hljs-property">$schema</span>.<span class="hljs-property">onEvent</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">bcs</span>: <span class="hljs-title class_">Array</span>&lt;{
    <span class="hljs-attr">renderer</span>: any;
    <span class="hljs-attr">bc</span>: <span class="hljs-title class_">BroadcastChannel</span>;
  }&gt; = [];
  <span class="hljs-keyword">if</span> (listeners) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(listeners)) {
      <span class="hljs-keyword">const</span> listener = listeners[key];
      ...
      <span class="hljs-keyword">const</span> bc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(key);
      bcs.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">renderer</span>: renderer,
        bc
      });
      bc.<span class="hljs-property">onmessage</span> = <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> { eventName, data } = e.<span class="hljs-property">data</span>;
        <span class="hljs-keyword">const</span> rendererEvent = <span class="hljs-title function_">createRendererEvent</span>(eventName, {
          <span class="hljs-attr">env</span>: renderer?.<span class="hljs-property">props</span>?.<span class="hljs-property">env</span>,
          <span class="hljs-attr">nativeEvent</span>: eventName,
          <span class="hljs-attr">scoped</span>: renderer?.<span class="hljs-property">context</span>,
          data
        });
        <span class="hljs-comment">// 过滤掉当前的广播事件，避免循环广播</span>
        <span class="hljs-keyword">const</span> actions = listener.<span class="hljs-property">actions</span>.<span class="hljs-title function_">filter</span>(
          <span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> !(a.<span class="hljs-property">actionType</span> === <span class="hljs-string">'broadcast'</span> &amp;&amp; a.<span class="hljs-property">eventName</span> === eventName)
        );

        <span class="hljs-title function_">runActions</span>(actions, renderer, rendererEvent);
      };
    }
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      bcs
        .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">renderer</span> === renderer)
        .<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">bc</span>.<span class="hljs-title function_">close</span>());
    };
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
};
</code></pre>
<h4 data-id="heading-15">触发事件（dispatchGlobalEventForRenderer）</h4>
<ul>
<li>广播动作<code>packages/amis-core/src/actions/BroadcastAction.ts</code>中调用了<code>dispatchGlobalEventForRenderer</code></li>
<li>代码较短，内部直接调用<code>dispatchGlobalEvent</code>方法，然后创建<code>BroadcastChannel</code>实例发送消息，然后关闭，齐活！</li>
<li>接收消息的地方就是上文<code>bindGlobalEventForRenderer</code>中挂载了<code>onmessage</code>事件的地方，不赘述</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// packages/amis-core/src/utils/renderer-event.ts</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">dispatchGlobalEventForRenderer</span>(<span class="hljs-params">
  eventName: string,
  renderer: React.Component&lt;RendererProps&gt;,
  scoped: IScopedContext,
  data: any,
  broadcast: RendererEvent&lt;any&gt;
</span>) {
  ...
  <span class="hljs-title function_">dispatchGlobalEvent</span>(eventName, data);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">dispatchGlobalEvent</span>(<span class="hljs-params">eventName: string, data: any</span>) {
  ...

  <span class="hljs-keyword">const</span> bc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(eventName);
  bc.<span class="hljs-title function_">postMessage</span>({
    eventName,
    data
  });
  bc.<span class="hljs-title function_">close</span>();
}
</code></pre>
<h4 data-id="heading-16">解绑事件</h4>
<ul>
<li>广播事件是长期绑定的，只有在组件卸载时才解绑</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// packages/amis-core/src/SchemaRenderer.tsx</span>

<span class="hljs-keyword">import</span> {
  bindEvent,
  bindGlobalEventForRenderer <span class="hljs-keyword">as</span> bindGlobalEvent
} <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/renderer-event'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SchemaRenderer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span>&lt;<span class="hljs-title class_">SchemaRendererProps</span>, any&gt; {
	...
	<span class="hljs-title function_">componentWillUnmount</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">unbindEvent</span>?.();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">unbindGlobalEvent</span>?.();
  }
	
}
</code></pre>
<h2 data-id="heading-17">总结</h2>
<ul>
<li><code>amis</code>的事件管理还是挺值得学习的</li>
<li>渲染器事件就是在组件的执行过程中开了个口子，支持插入想执行的逻辑</li>
<li>广播事件就是依赖<code>BroadcastChannel</code>的原生功能</li>
<li>下篇再写动作，脑子不够用了</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node+Express+MySQL 后端生产环境部署，实现注册功能(三)]]></title>    <link>https://juejin.cn/post/7574245788949004303</link>    <guid>https://juejin.cn/post/7574245788949004303</guid>    <pubDate>2025-11-19T09:47:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245788949004303" data-draft-id="7573864324713021492" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node+Express+MySQL 后端生产环境部署，实现注册功能(三)"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-11-19T09:47:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小胖霞"/> <meta itemprop="url" content="https://juejin.cn/user/3790771822016301"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node+Express+MySQL 后端生产环境部署，实现注册功能(三)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771822016301/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小胖霞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:47:36.000Z" title="Wed Nov 19 2025 09:47:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">一、部署前准备</h4>
<ul>
<li><strong>本地环境</strong>：MacOS（开发端）</li>
<li><strong>服务器环境</strong>：阿里云 Ubuntu 22.04 轻量应用服务器</li>
<li><strong>技术栈</strong>：Node.js + Express + MySQL</li>
<li><strong>核心目标</strong>：将本地开发完成的 Express 后端项目部署到阿里云，实现公网访问接口</li>
</ul>
<h4 data-id="heading-1">二、服务器环境配置（最终生效配置）</h4>
<h5 data-id="heading-2">1. 登录服务器</h5>
<p>通过 Mac 终端 SSH 连接服务器：</p>
<pre><code class="hljs language-bash" lang="bash">ssh root@你的服务器公网IP <span class="hljs-comment"># 例如：ssh root@47.101.129.155</span>
</code></pre>
<p>输入服务器登录密码即可进入。</p>
<h5 data-id="heading-3">2. 安装核心依赖软件</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 更新系统包</span>
sudo apt update &amp;&amp; sudo apt upgrade -y

<span class="hljs-comment"># 安装Node.js（v16+）</span>
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt install -y nodejs

<span class="hljs-comment"># 安装MySQL服务器</span>
sudo apt install -y mysql-server

<span class="hljs-comment"># 安装PM2（Node服务进程管理）</span>
sudo npm install pm2 -g

<span class="hljs-comment"># 安装Nginx（反向代理）</span>
sudo apt install -y nginx

</code></pre>
<h2 data-id="heading-4">创建本地数据库</h2>
<ol>
<li><strong>确保数据库已创建</strong>：用 MySQL Bench 连接本地 MySQL（root/admin123/3306），创建数据库 <code>mydb</code>（字符集 <code>utf8mb4</code>，排序规则 <code>utf8mb4_unicode_ci</code>）。</li>
</ol>
<h4 data-id="heading-5">三、创建用户表（存储注册信息）</h4>
<p>在 MySQL Bench 中，对 <code>mydb</code> 数据库执行以下 SQL，创建 <code>users</code> 表（用于存储注册用户）：</p>
<pre><code class="hljs language-sql" lang="sql">USE mydb; <span class="hljs-comment">-- 切换到 mydb 数据库</span>

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
  id <span class="hljs-type">INT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY, <span class="hljs-comment">-- 自增主键</span>
  email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>, <span class="hljs-comment">-- 邮箱（唯一，避免重复注册）</span>
  password <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- 加密后的密码（bcrypt 加密后长度固定60）</span>
  created_at DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>, <span class="hljs-comment">-- 注册时间</span>
  updated_at DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-comment">-- 更新时间</span>
);
</code></pre>
<h2 data-id="heading-6">四 新建项目</h2>
<p>创建文件夹node-api-test</p>
<ol>
<li><strong>安装依赖</strong>：需要 <code>mysql2</code>（数据库连接）、<code>bcrypt</code>（密码加密，不能明文存储）、<code>express-validator</code>（参数校验）,dotenv 判断环境变量</li>
</ol>
<pre><code class="hljs language-js" lang="js">
npm init -y

npm install mysql2 bcrypt express-validator deotnev

</code></pre>
<h5 data-id="heading-7">2. 多环境配置文件（区分测试 / 正式）</h5>
<p>在项目根目录创建 <strong>多个 <code>.env</code> 文件</strong>，分别对应不同环境：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">project/
├── .env.development  # 开发环境（本地调试）
├── .env.production   # 生产环境（正式服务器）
├── .env.test         # 测试环境（可选，测试服务器）
└── .gitignore        # 忽略 .env* 文件，避免提交到 Git
</code></pre>
<p><strong>文件内容示例</strong>：</p>
<pre><code class="hljs language-env" lang="env">NODE_ENV=development  # 标识环境
DB_HOST=localhost     # 本地数据库地址
DB_USER=root          # 本地数据库账号
DB_PASSWORD=admin123  # 本地数据库密码
DB_NAME=mydb          # 本地数据库名
API_PORT=3000         # 开发环境端口
</code></pre>
<p><code>.env.production</code>（生产环境）：</p>
<pre><code class="hljs language-env" lang="env">NODE_ENV=production
DB_HOST=10.0.0.1      # 服务器数据库地址（内网 IP）
DB_USER=prod_user     # 服务器数据库账号（非 root，更安全）
DB_PASSWORD=Prod@123  # 服务器数据库密码（复杂密码）
DB_NAME=mydb_prod     # 生产环境数据库名（可与开发环境不同）
API_PORT=3000         # 生产环境端口
</code></pre>
<h5 data-id="heading-8">3. 在代码中加载对应环境的配置</h5>
<p>在<code>db/mysql.js</code>，根据 <code>NODE_ENV</code> 自动加载对应的 <code>.env</code> 文件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// db/mysql.js（ESM 版）</span>
<span class="hljs-keyword">import</span> mysql <span class="hljs-keyword">from</span> <span class="hljs-string">'mysql2/promise'</span>;
<span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'url'</span>;

<span class="hljs-comment">// 解决 ESM 中 __dirname 问题</span>
<span class="hljs-keyword">const</span> __filename = <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>);
<span class="hljs-keyword">const</span> __dirname = path.<span class="hljs-title function_">dirname</span>(__filename);

<span class="hljs-comment">// 1. 确定当前环境（默认 development）</span>
<span class="hljs-keyword">const</span> env = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> || <span class="hljs-string">'development'</span>;

<span class="hljs-comment">// 2. 加载对应环境的 .env 文件（如 .env.development 或 .env.production）</span>
<span class="hljs-keyword">const</span> envPath = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">`../.env.<span class="hljs-subst">${env}</span>`</span>);
dotenv.<span class="hljs-title function_">config</span>({ <span class="hljs-attr">path</span>: envPath });  <span class="hljs-comment">// 加载指定路径的 .env 文件</span>

<span class="hljs-comment">// 3. 从 process.env 中读取配置（环境变量全部是字符串类型）</span>
<span class="hljs-keyword">const</span> dbConfig = {
  <span class="hljs-attr">host</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_HOST</span>,
  <span class="hljs-attr">user</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_USER</span>,
  <span class="hljs-attr">password</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_PASSWORD</span>,
  <span class="hljs-attr">database</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_NAME</span>,
  <span class="hljs-attr">port</span>: <span class="hljs-title class_">Number</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">DB_PORT</span>) || <span class="hljs-number">3306</span>,  <span class="hljs-comment">// 转换为数字</span>
  <span class="hljs-attr">connectionLimit</span>: <span class="hljs-number">10</span>,
};

<span class="hljs-comment">// 创建连接池</span>
<span class="hljs-keyword">const</span> pool = mysql.<span class="hljs-title function_">createPool</span>(dbConfig);

<span class="hljs-comment">// 测试连接时打印当前环境</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">testDbConnection</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> pool.<span class="hljs-title function_">getConnection</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✅ 数据库连接成功（环境：<span class="hljs-subst">${env}</span>，数据库：<span class="hljs-subst">${dbConfig.database}</span>`</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`❌ 数据库连接失败（环境：<span class="hljs-subst">${env}</span>）：`</span>, err.<span class="hljs-property">message</span>);
    <span class="hljs-keyword">throw</span> err;
  }
}

<span class="hljs-keyword">export</span> { pool };
</code></pre>
<p><code>app.js如下：</code></p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> bodyParser <span class="hljs-keyword">from</span> <span class="hljs-string">'body-parser'</span>
<span class="hljs-keyword">import</span> userRouter <span class="hljs-keyword">from</span> <span class="hljs-string">'./routes/user.js'</span>
<span class="hljs-keyword">import</span> { testDbConnection } <span class="hljs-keyword">from</span> <span class="hljs-string">'./db/mysql.js'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">HttpError</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/HttpError.js'</span> <span class="hljs-comment">// 导入自定义错误类</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()
<span class="hljs-comment">// 从环境变量读取端口（对应.env中的API_PORT）</span>
<span class="hljs-keyword">const</span> port = process.<span class="hljs-property">env</span>.<span class="hljs-property">API_PORT</span> || <span class="hljs-number">3000</span>

<span class="hljs-comment">// 解析JSON请求（必须，否则无法获取req.body）</span>
app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">json</span>())

<span class="hljs-comment">// 挂载用户模块路由</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-string">'/api/user'</span>, userRouter)

<span class="hljs-comment">// 全局错误处理中间件（必须放在所有路由和中间件之后）</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 1. 处理自定义HttpError</span>
  <span class="hljs-keyword">if</span> (err <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HttpError</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(err.<span class="hljs-property">statusCode</span>).<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">status</span>: err.<span class="hljs-property">statusCode</span>, <span class="hljs-comment">// 业务错误状态码（如400）</span>
      <span class="hljs-attr">message</span>: err.<span class="hljs-property">message</span>, <span class="hljs-comment">// 错误提示信息</span>
      <span class="hljs-attr">errors</span>: err.<span class="hljs-property">errors</span>, <span class="hljs-comment">// 详细错误列表（如参数校验错误）</span>
    })
  }

  <span class="hljs-comment">// 2. 处理系统错误（如数据库连接失败、代码bug等）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'系统错误堆栈：'</span>, err.<span class="hljs-property">stack</span>) <span class="hljs-comment">// 打印堆栈，方便后端调试</span>
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>({
    <span class="hljs-attr">status</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">message</span>:
      process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">'production'</span>
        ? <span class="hljs-string">'服务器内部错误，请稍后重试'</span> <span class="hljs-comment">// 生产环境隐藏具体错误</span>
        : <span class="hljs-string">`系统错误：<span class="hljs-subst">${err.message}</span>`</span>, <span class="hljs-comment">// 开发环境显示具体错误（便于调试）</span>
    <span class="hljs-attr">errors</span>: [],
  })
})

<span class="hljs-comment">// 启动服务（端口来自环境变量）</span>
app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(
    <span class="hljs-string">`服务启动成功（环境：<span class="hljs-subst">${process.env.NODE_ENV}</span>）：http://localhost:<span class="hljs-subst">${port}</span>`</span>
  )
  <span class="hljs-title function_">testDbConnection</span>() <span class="hljs-comment">// 启动时验证数据库连接</span>
})

</code></pre>
<h2 data-id="heading-9">注册接口编写</h2>
<p>在根目录下新建<code>routes/user.js</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>
<span class="hljs-keyword">import</span> { body, validationResult } <span class="hljs-keyword">from</span> <span class="hljs-string">'express-validator'</span>
<span class="hljs-keyword">import</span> bcrypt <span class="hljs-keyword">from</span> <span class="hljs-string">'bcrypt'</span>
<span class="hljs-keyword">import</span> { pool } <span class="hljs-keyword">from</span> <span class="hljs-string">'../db/mysql.js'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">HttpError</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/HttpError.js'</span>

<span class="hljs-keyword">const</span> router = express.<span class="hljs-title class_">Router</span>()

<span class="hljs-comment">// 注册接口：POST /api/user/register</span>
router.<span class="hljs-title function_">post</span>(
  <span class="hljs-string">'/register'</span>,
  <span class="hljs-comment">// 参数校验（字段名与前端传入、数据库字段一致）</span>
  [
    <span class="hljs-title function_">body</span>(<span class="hljs-string">'email'</span>).<span class="hljs-title function_">isEmail</span>().<span class="hljs-title function_">withMessage</span>(<span class="hljs-string">'邮箱格式错误'</span>), <span class="hljs-comment">// 对应数据库email字段</span>
    <span class="hljs-title function_">body</span>(<span class="hljs-string">'password'</span>).<span class="hljs-title function_">isLength</span>({ <span class="hljs-attr">min</span>: <span class="hljs-number">6</span> }).<span class="hljs-title function_">withMessage</span>(<span class="hljs-string">'密码至少6位'</span>), <span class="hljs-comment">// 对应password字段</span>
    <span class="hljs-title function_">body</span>(<span class="hljs-string">'nickname'</span>)
      .<span class="hljs-title function_">optional</span>()
      .<span class="hljs-title function_">isLength</span>({ <span class="hljs-attr">max</span>: <span class="hljs-number">50</span> })
      .<span class="hljs-title function_">withMessage</span>(<span class="hljs-string">'昵称最多50字'</span>), <span class="hljs-comment">// 对应nickname字段</span>
  ],
  <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 校验参数</span>
      <span class="hljs-keyword">const</span> errors = <span class="hljs-title function_">validationResult</span>(req)
      <span class="hljs-keyword">if</span> (!errors.<span class="hljs-title function_">isEmpty</span>()) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpError</span>(<span class="hljs-number">400</span>, <span class="hljs-string">'参数校验失败'</span>, errors.<span class="hljs-title function_">array</span>())
      }

      <span class="hljs-comment">// 解构前端传入的参数（字段名与数据库字段一致）</span>
      <span class="hljs-keyword">const</span> { email, password, nickname } = req.<span class="hljs-property">body</span>

      <span class="hljs-comment">// 1. 检查邮箱是否已注册（SQL中使用email字段，与数据库一致）</span>
      <span class="hljs-keyword">const</span> [existingUsers] = <span class="hljs-keyword">await</span> pool.<span class="hljs-title function_">query</span>(
        <span class="hljs-string">'SELECT id FROM users WHERE email = ?'</span>, <span class="hljs-comment">// WHERE条件用email字段</span>
        [email]
      )
      <span class="hljs-keyword">if</span> (existingUsers.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpError</span>(<span class="hljs-number">400</span>, <span class="hljs-string">'该邮箱已被注册'</span>)
      }

      <span class="hljs-comment">// 2. 密码加密</span>
      <span class="hljs-comment">//   const hashedPassword = await bcrypt.hash(password, 10)</span>

      <span class="hljs-comment">// 3. 插入数据库（字段名与数据库表完全一致）</span>
      <span class="hljs-keyword">const</span> [result] = <span class="hljs-keyword">await</span> pool.<span class="hljs-title function_">query</span>(
        <span class="hljs-string">'INSERT INTO users (email, password, nickname) VALUES (?, ?, ?)'</span>, <span class="hljs-comment">// 字段顺序：email, password, nickname</span>
        [email, password, nickname || <span class="hljs-literal">null</span>] <span class="hljs-comment">// 对应字段的值</span>
      )

      <span class="hljs-comment">// 4. 返回结果（包含数据库自动生成的id和字段）</span>
      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'注册成功'</span>,
        <span class="hljs-attr">data</span>: {
          <span class="hljs-attr">userId</span>: result.<span class="hljs-property">insertId</span>, <span class="hljs-comment">// 数据库自增id</span>
          <span class="hljs-attr">email</span>: email, <span class="hljs-comment">// 与数据库email字段一致</span>
          <span class="hljs-attr">nickname</span>: nickname || <span class="hljs-literal">null</span>, <span class="hljs-comment">// 与数据库nickname字段一致</span>
          <span class="hljs-attr">createdAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
        },
      })
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-title function_">next</span>(err)
    }
  }
)

<span class="hljs-comment">// 获取所有用户</span>
router.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/allUsers'</span>, <span class="hljs-keyword">async</span> (req, res, next) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> [users] = <span class="hljs-keyword">await</span> pool.<span class="hljs-title function_">query</span>(<span class="hljs-string">'SELECT * FROM users'</span>)
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">'获取成功'</span>,
      <span class="hljs-attr">data</span>: users,
    })
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-title function_">next</span>(err)
  }
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router

</code></pre>
<h2 data-id="heading-10">本地postman测试</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a02ec87429844106afff8dbfa76cdc05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6IOW6Zye:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764150455&amp;x-signature=j0%2F%2FjuCc6EZMVzVbbtklfW3GR5Y%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-11">数据库查看这条数据</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b52b30e96419446688ccd6ce9b986970~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6IOW6Zye:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764150455&amp;x-signature=glTxtnRbRhOUSlRKP87O9Ti2M1A%3D" alt="image.png" loading="lazy"/></p>
<p>下一篇学习如何把代码发布到服务器，通过域名来访问接口，实现注册，顺便把前端页面也发布上去</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[苹果iOS应用签名与上架App Store完整指南包括注意事项]]></title>    <link>https://juejin.cn/post/7574230922314989574</link>    <guid>https://juejin.cn/post/7574230922314989574</guid>    <pubDate>2025-11-19T09:53:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574230922314989574" data-draft-id="7574253222606635049" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="苹果iOS应用签名与上架App Store完整指南包括注意事项"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T09:53:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            苹果iOS应用签名与上架App Store完整指南包括注意事项
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:53:35.000Z" title="Wed Nov 19 2025 09:53:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>苹果商城（App Store）应用程序苹果ios签名进行系统怎么上架的注意事项完整教程</p>
<p>导语：苹果签名是保障安全和防止软件篡改的重要措施，也是苹果设备下载应用程序的必要步骤。本文将为大家提供一个详细的教程，介绍如何为应用程序进行苹果签名，以及发布到App Store上架的流程。</p>
<p>一、注册苹果开发者账号</p>
<p>在进行苹果签名和发布应用程序之前，首先需要注册一个苹果开发者账号。通过以下步骤注册：</p>
<p>打开苹果开发者网站
developer.apple.com；</p>
<p>点击右上角的“账户”按钮，然后选择“注册”；</p>
<p>按照页面提示填写相关信息，包括个人身份信息、联系方式以及支付方式；</p>
<p>提交注册申请并完成支付。</p>
<p>二、创建App ID</p>
<p>为了能够对应用程序进行签名，需要在苹果开发者账号中创建一个唯一的App ID。</p>
<p>登录苹果开发者网站
developer.apple.com；</p>
<p>点击右上角的“账户”按钮，然后选择“证书、标识和配置文件”；</p>
<p>在左侧菜单栏中选择“Identifiers”；</p>
<p>点击页面右上角的“添加”按钮；</p>
<p>在创建App ID页面中填写相关信息，包括App的名称、Bundle Identifier等；</p>
<p>点击“Continue”并确认App ID创建成功。</p>
<p>三、创建签名证书</p>
<p>为了进行苹果签名，需要在苹果开发者账号中创建签名证书。</p>
<p>登录苹果开发者网站
developer.apple.com；</p>
<p>点击右上角的“账户”按钮，然后选择“证书、标识和配置文件”；</p>
<p>在左侧菜单栏中选择“Certificates”；</p>
<p>点击页面右上角的“添加”按钮；</p>
<p>根据提示选择合适的证书类型（开发、生产或通用）；</p>
<p>按照页面提示进行操作，包括上传CSR文件等；</p>
<p>最后生成签名证书，并下载保存到本地。</p>
<p>四、下载和安装签名证书</p>
<p>为了在开发环境中使用签名证书，需要将证书下载并安装到本地电脑。</p>
<p>打开Keychain Access应用程序（在Launchpad-工具文件夹中找到）；</p>
<p>在菜单栏中选择“登录”；</p>
<p>点击菜单栏中的“文件”，选择“导入项目”；</p>
<p>在弹出的导入证书对话框中选择之前下载的签名证书文件（扩展名为.cer）；</p>
<p>根据提示完成证书的导入安装。</p>
<p>五、在Xcode中进行签名设置</p>
<p>在Xcode中进行签名设置可以让我们在开发过程中自动对应用程序进行苹果签名。</p>
<p>打开Xcode应用程序，进入项目的“General”选项卡；</p>
<p>在“Identity”部分选择对应的Team；</p>
<p>在“Signing”部分选择对应的Provisioning Profile；</p>
<p>如果没有可用的Provisioning Profile，可以点击“Manage Certificates”按钮创建或下载；</p>
<p>如果需要发布到App Store上架，需要选择“Generic iOS Device”为目标设备；</p>
<p>点击菜单栏中的“Product”，选择“Archive”进行打包。</p>
<p>对于希望简化流程的开发者，可以使用AppUploader等工具来管理iOS证书和描述文件，支持在Windows、Linux或Mac系统中直接创建和上传，无需钥匙串助手或Xcode即可完成部分操作。</p>
<p>六、提交应用程序到App Store</p>
<p>一旦应用程序经过签名，就可以准备将其提交到App Store进行上架了。</p>
<p>打开Xcode应用程序，进入“Organizer”（在菜单栏中选择“Window”-“Organizer”）；</p>
<p>选择之前打包的应用程序，点击“Validate”进行验证；</p>
<p>根据提示进行验证并解决相应问题；</p>
<p>验证通过后，点击“Submit”进行提交申请；</p>
<p>登录iTunes Connect账号，选择App对应的App Store信息和截图等；</p>
<p>提交申请后，等待苹果审核，并按照审核结果进行相应调整和修改；</p>
<p>一旦应用程序通过审核，即可上架App Store，用户可以在App Store中下载和使用。</p>
<p>七、应用程序更新</p>
<p>在应用程序发布后，可能需要对其进行更新。下面是应用程序更新的流程：</p>
<p>在Xcode中打开项目，进行相应的更新和修改；</p>
<p>在Xcode中进行签名设置和打包；</p>
<p>使用之前创建的Provisioning Profile进行签名和验证；</p>
<p>将更新的应用程序提交到App Store进行审核。</p>
<p>结语：本文详细介绍了如何为应用程序进行苹果签名，并将其发布到App Store上架的完整流程。希望能够对开发者和想要发布应用程序的用户提供帮助。同时，我们强调了苹果签名的重要性和安全性，建议用户遵循官方流程进行应用程序的签名和发布，避免绕过苹果签名带来的安全隐患。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[生产环境服务器变慢？从应急到根因的全流程诊断处理指南]]></title>    <link>https://juejin.cn/post/7574245125028413459</link>    <guid>https://juejin.cn/post/7574245125028413459</guid>    <pubDate>2025-11-19T09:54:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245125028413459" data-draft-id="7574267813734187027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="生产环境服务器变慢？从应急到根因的全流程诊断处理指南"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-11-19T09:54:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            生产环境服务器变慢？从应急到根因的全流程诊断处理指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:54:12.000Z" title="Wed Nov 19 2025 09:54:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">生产环境服务器变慢？从应急到根因的全流程诊断处理指南</h2>
<p>生产环境服务器突然变慢，是运维和开发人员最头疼的场景之一 —— 用户反馈 “页面加载超时”“接口响应慢”，监控面板显示 “响应时间从 100ms 飙到 5s”，但登录服务器后却不知道从哪下手。此时盲目重启服务可能暂时缓解，但会丢失关键日志；逐个排查又怕耽误业务恢复。</p>
<p>本文结合 10 + 年生产环境运维经验，总结出一套 “<strong>先应急恢复，再分层诊断，最后根因解决</strong>” 的标准化流程，覆盖 CPU、内存、磁盘 IO、网络、应用等全链路问题，附具体工具命令与案例，帮你快速搞定服务器变慢问题。</p>
<h3 data-id="heading-1">一、第一步：先明确 “变慢” 的具体现象（避免盲目排查）</h3>
<p>服务器 “变慢” 是个模糊概念，首先要通过 “现象归类” 缩小排查范围，不同现象对应不同的问题方向：</p>






























<table><thead><tr><th>现象类型</th><th>具体表现</th><th>可能的问题方向</th></tr></thead><tbody><tr><td>响应延迟高</td><td>接口响应时间 &gt; 3s，页面加载超时，SSH 连接卡顿</td><td>CPU 过载、内存不足、网络拥堵、应用死锁</td></tr><tr><td>吞吐量下降</td><td>每秒处理请求数从 1000 降至 100，带宽利用率低</td><td>应用线程池满、数据库连接耗尽、依赖服务故障</td></tr><tr><td>资源使用率异常</td><td>CPU&gt;90%、内存使用率 &gt; 95%、磁盘 IO% util&gt;90%</td><td>进程占用过高、内存泄漏、磁盘读写频繁</td></tr><tr><td>间歇性卡顿</td><td>每隔 10 分钟慢一次，持续 30 秒后恢复</td><td>定时任务（如日志切割、备份）、GC 频繁</td></tr></tbody></table>
<p><strong>实战技巧</strong>：用 “对比法” 确认现象 —— 和历史正常数据比（如上周同一时段 CPU 仅 30%），和同集群其他节点比（如节点 A 慢，节点 B 正常），快速判断是 “单节点问题” 还是 “全局问题”。</p>
<h3 data-id="heading-2">二、第二步：应急处理（先恢复业务，再排查根因）</h3>
<p>生产环境的核心目标是 “业务可用”，如果服务器变慢已影响用户，需先执行应急措施，再深入诊断：</p>
<h4 data-id="heading-3">1. 快速恢复业务的 3 个常用手段</h4>
<ul>
<li><strong>重启核心服务</strong>：若确定是应用问题（如线程死锁、内存泄漏），先重启应用（如systemctl restart app.service），重启前记录关键日志（jstack 进程ID &gt; stack.log，避免丢失现场）；</li>
</ul>

<ul>
<li><strong>流量切换</strong>：若有负载均衡（如 Nginx、SLB），将慢节点的流量切到其他正常节点（如 Nginx 注释该节点 IP），待节点恢复后再重新接入；</li>
</ul>

<ul>
<li><strong>资源扩容</strong>：若因资源不足（如 CPU / 内存不够）导致变慢，临时扩容（如云服务器升级配置、增加容器实例），缓解压力后再优化。</li>
</ul>
<h4 data-id="heading-4">2. 关键注意点</h4>
<ul>
<li>不要直接重启服务器：重启会清除所有进程状态和日志，除非是 “SSH 都连不上” 的极端情况；</li>
</ul>

<ul>
<li>先备份日志：重启应用或服务前，备份应用日志、系统日志（/var/log/messages）、GC 日志，方便后续根因分析。</li>
</ul>
<h3 data-id="heading-5">三、第三步：分层诊断（从系统到应用，逐个击破）</h3>
<p>业务恢复后，按 “<strong>系统资源层→网络层→应用层→依赖层</strong>” 的顺序分层诊断，每一层都用工具定位具体问题，避免 “东一榔头西一棒子”。</p>
<h4 data-id="heading-6">第一层：系统资源诊断（CPU、内存、磁盘 IO）</h4>
<p>系统资源是服务器的 “硬件基础”，90% 的变慢问题都和资源过载有关，优先排查这一层。</p>
<h5 data-id="heading-7">1. CPU 问题诊断（用 top、pidstat、pstack）</h5>
<p><strong>核心工具</strong>：top（实时查看 CPU 使用率）、pidstat -u 1（按进程查看 CPU 占用）、pstack 进程ID（查看进程线程栈）。</p>
<p><strong>诊断步骤</strong>：</p>
<ol>
<li>执行top命令，观察关键指标：</li>
</ol>
<ul>
<li>
<ul>
<li>%us（用户态 CPU）：若 &gt; 80%，说明应用进程（如 Java、Python）占用过高；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>%sy（内核态 CPU）：若 &gt; 30%，说明内核操作频繁（如频繁系统调用、网络中断）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>%wa（IO 等待 CPU）：若 &gt; 20%，说明 CPU 在等待磁盘 IO，磁盘读写是瓶颈；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>Cpu(s)行的id（空闲 CPU）：若 &lt; 10%，说明 CPU 整体过载。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>定位高 CPU 进程：</li>
</ol>
<ul>
<li>
<ul>
<li>在top中按P键，按 CPU 使用率排序，找到占用最高的进程（如java进程 PID=12345，% CPU=95%）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>执行pidstat -u 1 -p 12345，查看该进程的 CPU 占用是否持续过高，区分是 “瞬时高” 还是 “持续高”。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>定位高 CPU 线程（若进程内多线程）：</li>
</ol>
<ul>
<li>
<ul>
<li>执行top -Hp 12345，按P键排序，找到进程内占用 CPU 最高的线程（如 TID=12346，% CPU=90%）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>将线程 ID 转为十六进制（printf "%x\n" 12346 → 303a），执行jstack 12345 | grep 303a -A 20（Java 进程），查看线程栈，判断是否是死循环、频繁 GC、大量计算。</li>
</ul>
</li>
</ul>
<p><strong>案例</strong>：某 Java 应用 CPU 持续 95%，jstack发现 10 个线程卡在 “java.util.HashMap.put”，进一步排查发现是多线程并发修改 HashMap 导致的死循环，修改为 ConcurrentHashMap 后恢复正常。</p>
<h5 data-id="heading-8">2. 内存问题诊断（用 free、vmstat、jmap）</h5>
<p><strong>核心工具</strong>：free -h（查看内存使用）、vmstat 1（查看内存交换）、jmap -heap 进程ID（Java 进程内存使用）。</p>
<p><strong>诊断步骤</strong>：</p>
<ol>
<li>执行free -h，观察关键指标：</li>
</ol>
<ul>
<li>
<ul>
<li>used（已用内存）：若used接近total，且available（可用内存）&lt;10%，说明物理内存不足；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>Swap（交换分区）：若used&gt;0，说明物理内存不够，系统开始使用磁盘作为内存（Swap 速度比内存慢 100 倍，会导致服务器变慢）。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>查看内存占用进程：</li>
</ol>
<ul>
<li>
<ul>
<li>执行top，按M键按内存使用率排序，找到占用最高的进程（如mysql进程占用 8GB 内存）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>若为 Java 进程，执行jmap -heap 12345，查看堆内存使用（如老年代使用率 &gt; 95%，且 GC 后不下降，可能是内存泄漏）。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>检查内存泄漏（长期变慢的常见原因）：</li>
</ol>
<ul>
<li>
<ul>
<li>Java 进程：执行jmap -dump:format=b,file=heap.hprof 12345，导出堆内存快照，用 MAT（Memory Analyzer Tool）分析，查看是否有大对象（如 ArrayList）持续增长且不释放；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>非 Java 进程：用valgrind工具检测内存泄漏（valgrind --leak-check=full ./app），适合 C/C++ 程序。</li>
</ul>
</li>
</ul>
<p><strong>案例</strong>：某 Python 应用运行 3 天后变慢，free发现 Swap 使用 10GB，top显示该进程内存从 2GB 涨到 15GB，排查发现是爬虫程序未释放请求连接，导致内存泄漏，修复连接池释放逻辑后恢复。</p>
<h5 data-id="heading-9">3. 磁盘 IO 问题诊断（用 iostat、iotop、df）</h5>
<p><strong>核心工具</strong>：iostat -x 1（查看磁盘 IO 使用率）、iotop（按进程查看磁盘读写）、df -h（查看磁盘空间）。</p>
<p><strong>诊断步骤</strong>：</p>
<ol>
<li>执行iostat -x 1，观察关键指标：</li>
</ol>
<ul>
<li>
<ul>
<li>%util（磁盘 IO 利用率）：若 &gt; 90%，说明磁盘读写满了（即使rMB/s/wMB/s不高，也可能是随机读写频繁）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>rawait（读请求平均等待时间）、wawait（写请求平均等待时间）：若 &gt; 10ms，说明磁盘 IO 响应慢；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>svctm（磁盘服务时间）：若接近await，说明 IO 无等待（正常）；若await远大于svctm，说明 IO 队列堆积。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>定位高 IO 进程：</li>
</ol>
<ul>
<li>
<ul>
<li>执行iotop，按O键（大写）只显示有 IO 活动的进程，查看哪个进程的DISK READ/DISK WRITE持续过高（如logrotate进程频繁写日志）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>若为日志写入过多，检查应用日志级别（如是否误设为DEBUG级别，导致日志暴增）。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>检查磁盘空间：</li>
</ol>
<ul>
<li>
<ul>
<li>执行df -h，查看是否有分区使用率 &gt; 95%（磁盘满会导致无法写入，应用卡住）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>执行du -sh /<em>逐步排查大文件，删除无用日志（如rm -rf /var/log/app/</em>.log.1）或转移大文件。</li>
</ul>
</li>
</ul>
<p><strong>案例</strong>：某数据库服务器变慢，iostat显示%util=100%，iotop发现mysqld进程写 IO 达 200MB/s，排查发现是某 SQL 语句未加索引，导致全表扫描频繁读写磁盘，添加索引后%util降至 10%。</p>
<h4 data-id="heading-10">第二层：网络层诊断（用 ping、traceroute、tcpdump）</h4>
<p>若系统资源正常，但服务器仍变慢，需排查网络问题（如带宽拥堵、连接数满、网络丢包）。</p>
<h5 data-id="heading-11">1. 网络连通性与延迟</h5>
<ul>
<li>执行ping 目标IP（如ping 数据库IP），查看丢包率（packet loss）和延迟（time）：丢包率 &gt; 5% 或延迟 &gt; 100ms（内网），说明网络链路有问题；</li>
</ul>

<ul>
<li>执行traceroute 目标IP（内网用mtr更详细），查看链路中哪个节点延迟高或丢包（如某交换机节点延迟从 1ms 升至 200ms）。</li>
</ul>
<h5 data-id="heading-12">2. 网络连接与带宽</h5>
<ul>
<li>查看连接数：netstat -an | grep :8080 | wc -l（查看应用端口的连接数），对比应用配置的最大连接数（如 Tomcat 的maxConnections），若接近上限，说明连接数满；</li>
</ul>

<ul>
<li>查看带宽使用：iftop -i eth0（实时查看带宽），若TX（发送）或RX（接收）带宽接近网卡上限（如 1G 网卡达 900Mbps），说明带宽拥堵；</li>
</ul>

<ul>
<li>查看 TIME_WAIT 连接：netstat -an | grep TIME_WAIT | wc -l，若数量 &gt; 10000，可能是 TCP 连接回收慢，可调整内核参数（如net.ipv4.tcp_tw_reuse=1）。</li>
</ul>
<h5 data-id="heading-13">3. 抓包分析（定位异常请求）</h5>
<p>若怀疑是异常请求（如大量无效请求、大文件传输）导致网络拥堵，用tcpdump抓包：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 抓应用端口8080的包，保存到文件（后续用Wireshark分析）</span>
<span class="hljs-string">tcpdump</span> <span class="hljs-string">-i</span> <span class="hljs-string">eth0</span> <span class="hljs-string">port</span> <span class="hljs-number">8080</span> <span class="hljs-string">-w</span> <span class="hljs-string">network.pcap</span>
</code></pre>
<p>用 Wireshark 打开network.pcap，过滤 “大尺寸数据包”（如ip.len &gt; 10000），查看是否有异常请求（如恶意爬虫频繁发送大请求）。</p>
<h4 data-id="heading-14">第三层：应用层诊断（用日志、线程栈、性能分析工具）</h4>
<p>系统和网络都正常时，问题大概率在应用本身（如代码 bug、配置错误、线程池满）。</p>
<h5 data-id="heading-15">1. 应用日志分析（最直接的问题线索）</h5>
<ul>
<li>查看错误日志：如 Java 应用的error.log、Python 应用的exception.log，搜索ERROR、Exception关键词，定位是否有代码异常（如空指针、数据库连接超时）；</li>
</ul>

<ul>
<li>查看访问日志：如 Nginx 的access.log、Tomcat 的localhost_access_log.txt，统计慢请求（如响应时间 &gt; 3s 的请求），分析是否是某接口 / URL 导致变慢；</li>
</ul>

<ul>
<li>日志分析工具：用grep、awk快速筛选（如awk '<span class="math math-inline"><span class="katex-error" title="ParseError: KaTeX parse error: Expected '}', got 'EOF' at end of input: NF&gt;3 {print " style="color:#cc0000">NF&gt;3 {print </span></span>0}' access.log筛选响应时间 &gt; 3s 的请求），或用 ELK（Elasticsearch+Logstash+Kibana）可视化分析。</li>
</ul>
<h5 data-id="heading-16">2. 应用性能分析（深入代码层面）</h5>
<ul>
<li><strong>Java 应用</strong>：用jprofiler或Arthas（阿里开源，无需重启）分析性能：</li>
</ul>

<ul>
<li>
<ul>
<li>arthas attach 12345（ attach 到 Java 进程）；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>dashboard查看实时 CPU、内存、线程状态；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>trace com.example.AppController query跟踪接口调用链，查看哪个方法耗时最长；</li>
</ul>
</li>
</ul>

<ul>
<li><strong>Python 应用</strong>：用cProfile分析函数耗时（python -m cProfile -s cumulative <a href="https://link.juejin.cn?target=http%3A%2F%2Fapp.py" target="_blank" title="http://app.py" ref="nofollow noopener noreferrer">app.py</a>），定位耗时久的函数；</li>
</ul>

<ul>
<li><strong>Go 应用</strong>：用pprof分析（go tool pprof <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A6060%2Fdebug%2Fpprof%2Fprofile%3Fseconds%3D30" target="_blank" title="http://localhost:6060/debug/pprof/profile?seconds=30" ref="nofollow noopener noreferrer">http://localhost:6060/debug/pprof/profile?seconds=30</a>），生成 CPU 使用报告。</li>
</ul>
<p><strong>案例</strong>：某 Java 接口响应慢，Arthas trace发现query方法中JSONObject.parse耗时占比 80%，排查发现是接口返回的 JSON 数据达 10MB（包含大量冗余字段），精简字段后响应时间从 5s 降至 200ms。</p>
<h4 data-id="heading-17">第四层：依赖层诊断（数据库、Redis、第三方接口）</h4>
<p>应用变慢很多时候是 “依赖服务拖后腿”，需排查应用依赖的中间件和第三方服务：</p>
<h5 data-id="heading-18">1. 数据库问题（最常见的依赖瓶颈）</h5>
<ul>
<li>查看数据库连接数：show processlist（MySQL），若Threads_connected接近max_connections，说明连接数满；</li>
</ul>

<ul>
<li>查看慢查询：show slow logs（MySQL），分析慢 SQL（如无索引、join 过多），用explain分析 SQL 执行计划；</li>
</ul>

<ul>
<li>查看数据库资源：top查看数据库进程 CPU / 内存占用，iostat查看数据库磁盘 IO，判断是否是数据库本身过载。</li>
</ul>
<h5 data-id="heading-19">2. Redis 问题</h5>
<ul>
<li>查看 Redis 连接数：info clients，若connected_clients接近maxclients，说明连接数满；</li>
</ul>

<ul>
<li>查看 Redis 性能：info stats，查看instantaneous_ops_per_sec（每秒操作数），若远超 Redis 性能上限（单实例建议 &lt; 10 万 / 秒），需扩容；</li>
</ul>

<ul>
<li>查看慢命令：slowlog get，查看是否有keys *、hgetall等慢命令，这些命令会阻塞 Redis。</li>
</ul>
<h5 data-id="heading-20">3. 第三方接口问题</h5>
<ul>
<li>直接调用测试：在服务器上用curl -w "%{time_total}\n" -o /dev/null -s "<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.thirdparty.com%2Fpay" target="_blank" title="https://api.thirdparty.com/pay" ref="nofollow noopener noreferrer">api.thirdparty.com/pay</a>"，查看第三方接口响应时间，若 &gt; 3s，说明是第三方服务慢；</li>
</ul>

<ul>
<li>查看应用中第三方接口的超时配置：若超时时间设为 10s，而第三方接口经常 5s 响应，会导致应用线程等待，需调整超时时间并加重试机制。</li>
</ul>
<h3 data-id="heading-21">四、第四步：根因解决（避免问题重复发生）</h3>
<p>定位到具体问题后，需针对性解决，避免 “临时恢复后再次出现”：</p>



































<table><thead><tr><th>问题类型</th><th>根因解决方法</th><th>预防措施</th></tr></thead><tbody><tr><td>CPU 过载（应用计算多）</td><td>优化代码（如减少循环、用缓存）、拆分计算任务</td><td>性能压测时关注 CPU 使用率，设置 CPU 告警阈值</td></tr><tr><td>内存泄漏</td><td>修复代码（如释放无用对象、关闭连接）、用内存分析工具定期检测</td><td>部署内存监控，设置老年代使用率告警（如 &gt; 90%）</td></tr><tr><td>磁盘 IO 高（日志多）</td><td>调整日志级别（如 DEBUG→INFO）、日志轮转（如 logrotate）、用 SSD 替换 HDD</td><td>监控磁盘 IO% util，设置告警阈值（如 &gt; 80%）</td></tr><tr><td>慢 SQL</td><td>加索引、优化 SQL（如拆分 join、避免 select *）、分库分表</td><td>开启慢查询日志，定期优化慢 SQL</td></tr><tr><td>第三方接口慢</td><td>更换第三方服务商、增加本地缓存、异步调用</td><td>监控第三方接口响应时间，设置超时重试</td></tr></tbody></table>
<h3 data-id="heading-22">五、第五步：预防措施（构建长效监控体系）</h3>
<p>最好的处理是 “避免问题发生”，需构建完善的监控体系，提前发现隐患：</p>
<h4 data-id="heading-23">1. 核心监控指标与工具</h4>



































<table><thead><tr><th>监控层面</th><th>核心指标</th><th>推荐工具</th><th>告警阈值</th></tr></thead><tbody><tr><td>系统资源</td><td>CPU% us、内存 available、磁盘 % util、网络丢包率</td><td>Prometheus+Grafana、Zabbix</td><td>CPU&gt;80%、内存 available&lt;10%、IO% util&gt;80%</td></tr><tr><td>应用性能</td><td>接口响应时间、错误率、线程数</td><td>SkyWalking、Pinpoint、Arthas</td><td>响应时间 &gt; 3s、错误率 &gt; 1%、线程数 &gt; 90% 上限</td></tr><tr><td>中间件</td><td>数据库慢查询数、Redis ops、连接数</td><td>Prometheus+Exporter（MySQL/Redis）</td><td>慢查询数 &gt; 10 / 分钟、Redis ops&gt;8 万 / 秒</td></tr><tr><td>业务指标</td><td>每秒请求数、订单成功率、页面加载时间</td><td>自定义监控脚本、APM 工具</td><td>每秒请求数下降 50%、成功率 &lt; 99.9%</td></tr></tbody></table>
<h4 data-id="heading-24">2. 定期巡检与压测</h4>
<ul>
<li>每周巡检：检查服务器资源使用率、应用日志错误率、慢查询数量，及时发现潜在问题；</li>
</ul>

<ul>
<li>每月压测：用 JMeter/LoadRunner 模拟峰值流量，验证服务器和应用的承载能力，提前扩容或优化；</li>
</ul>

<ul>
<li>版本发布前测试：新功能上线前，在测试环境验证 CPU、内存使用，避免上线后导致服务器变慢。</li>
</ul>
<h3 data-id="heading-25">总结：服务器变慢诊断的核心原则</h3>
<ol>
<li><strong>先应急后根因</strong>：生产环境优先恢复业务，再排查问题，避免因排查导致业务中断更久；</li>
</ol>

<ol start="2">
<li><strong>分层诊断</strong>：从系统资源到应用，从本地到依赖，按层排查，不遗漏任何环节；</li>
</ol>

<ol start="3">
<li><strong>工具落地</strong>：熟练使用 top、iostat、jstack 等工具，用数据说话，不凭感觉猜测；</li>
</ol>

<ol start="4">
<li><strong>长效预防</strong>：解决问题后，通过监控和巡检避免重复发生，构建 “发现 - 解决 - 预防” 的闭环。</li>
</ol>
<p>记住：服务器变慢不是 “偶发事件”，而是 “系统隐患的暴露”。每次诊断处理后，都要总结经验，优化监控或流程，让服务器越来越稳定。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别泡咖啡等报表！阿里云物化视图，把日志查询速度提升100倍！]]></title>    <link>https://juejin.cn/post/7574245788949069839</link>    <guid>https://juejin.cn/post/7574245788949069839</guid>    <pubDate>2025-11-19T09:55:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245788949069839" data-draft-id="7574251313882906639" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别泡咖啡等报表！阿里云物化视图，把日志查询速度提升100倍！"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-11-19T09:55:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别泡咖啡等报表！阿里云物化视图，把日志查询速度提升100倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:55:04.000Z" title="Wed Nov 19 2025 09:55:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：戴志勇</p>
<h2 data-id="heading-0">当“即查即算”遇上数据爆炸</h2>
<p>你是否经历过这样的场景？</p>
<p>在阿里云日志服务里，一个看似简单的看板，点开却要等上几十秒；高峰期多人同时查日志，系统直接“卡成 PPT”；更糟的是，有时结果还不准——因为达到资源限制，系统只能“估算”答案。</p>
<p>这背后，是日志规模爆炸式增长带来的现实困境：当数据量从 GB 跃升至 TB 甚至 PB 级，“边查边算”的传统模式已力不从心。</p>
<ul>
<li><strong>查得慢：</strong> 复杂聚合动辄几十秒，看板刷新比泡杯咖啡还久</li>
<li><strong>扛不住：</strong> 一到高峰，查询互相抢资源，一个慢、全链路崩</li>
<li><strong>不准了：</strong> 资源超限被迫降级，数据失真，决策风险陡增</li>
</ul>
<p>而这些痛点，恰恰集中在最常用的场景——监控大屏、运营看板、实时报表。它们有个共同特点：查询模式固定、时间跨度大、但要求秒级响应、结果精准。</p>
<p>现在，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fsls%3Fspm%3Da1z389.11499242.0.0.65452413PLWe13%26utm_content%3Dg_1000408139" target="_blank" title="https://www.aliyun.com/product/sls?spm=a1z389.11499242.0.0.65452413PLWe13&amp;utm_content=g_1000408139" ref="nofollow noopener noreferrer">阿里云日志服务</a>带来破局利器——<strong>物化视图</strong>。</p>
<p>它就像给你的日志数据“提前算好答案，存好快照”。通过智能增量预计算 + 自动查询改写，系统在后台默默把高频查询的结果提前准备好。当你发起请求时，不再扫描全量原始日志，而是直接读取预计算结果——查询速度提升数十倍乃至百倍，资源消耗大幅降低，结果还更稳、更准。</p>
<p>用一点额外的存储空间，换回秒级洞察力。从此，再大的日志量，也能做到“点开即见，所见即所得”。</p>
<h2 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fsls%3Fspm%3Da1z389.11499242.0.0.65452413PLWe13%26utm_content%3Dg_1000408139" target="_blank" title="https://www.aliyun.com/product/sls?spm=a1z389.11499242.0.0.65452413PLWe13&amp;utm_content=g_1000408139" ref="nofollow noopener noreferrer">日志服务</a>物化视图优势</h2>
<p>物化视图的核心思想是：用额外的存储空间，换来查询速度的飞跃。日志服务的物化视图主要支持两种场景的查询加速。</p>
<p><strong>1. 过滤加速：只留“有用”的日志</strong></p>
<p>比如你只关心“错误日志”，物化视图会提前把所有 error 级别的日志筛选出来单独存好。下次查错误，就不用翻遍全部日志，直接查这个“精选集”，速度提升几十倍。</p>
<p><strong>2. 预聚合加速：提前算好统计结果</strong></p>
<p>比如每天要统计“各地区的用户访问量”，物化视图会每隔一段时间自动算好这个数据并存起来。你查的时候，系统直接拿现成结果，不用再从原始日志里一条条加总——数据量可能从亿行变成百行。</p>
<p>与业界其他物化视图方案相比，日志服务物化视图具有以下优势：</p>
<h3 data-id="heading-2">1. 异步物化视图，增量刷新，不影响写入性能</h3>
<p>物化视图的构建完全独立于数据写入流程，采用异步更新机制，每次刷新只针对新写入的数据，更新任务由后端托管，对用户透明。</p>
<h3 data-id="heading-3">2. 自动数据合并，写入即可查</h3>
<p>自动合并未物化的最近数据和已物化的历史结果，有效解决了同类产品的关键问题：</p>
<ul>
<li>异步刷新痛点：无法读取最新数据，秒级刷新也无法保证数据实时性</li>
<li>同步刷新痛点：严重影响写入性能，系统吞吐量大幅下降</li>
</ul>
<h3 data-id="heading-4">3. 支持复杂聚合函数的改写</h3>
<p>除了常用的聚合函数（sum、count、avg、min、max等），还支持如下复杂的聚合函数：</p>
<ul>
<li><code>count(distinct)</code>：精确去重统计</li>
<li><code>approx_percentile</code>：近似百分位数计算</li>
<li><code>approx_distinct</code>：高效近似去重</li>
</ul>
<h3 data-id="heading-5">4. 支持动态更新物化视图</h3>
<p>更改物化视图的 SQL 定义时，历史物化视图无需重建，不影响已物化的历史结果。对于经常动态增加列或减少列的场景，这一特性显得尤为重要，可以避免频繁更新物化视图带来的存储和计算成本增加。</p>
<h3 data-id="heading-6">5. 透明改写</h3>
<p>除了支持 SQL 的透明改写，对于查询语句也可以做谓词的自动补偿。举例说明：</p>
<p><strong>用户创建物化视图的语句：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">level:</span><span class="hljs-keyword">error</span> | <span class="hljs-keyword">select</span> latency, host <span class="hljs-keyword">from</span> log <span class="hljs-keyword">where</span> message <span class="hljs-built_in">like</span> <span class="hljs-comment">'%xxx%'</span>
</code></pre>
<p><strong>对于如下的查询请求：</strong></p>
<pre><code class="hljs language-sql" lang="sql">level:error <span class="hljs-keyword">and</span> latency <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span> <span class="hljs-operator">|</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">avg</span>(latency), host <span class="hljs-keyword">from</span> log <span class="hljs-keyword">where</span> message <span class="hljs-keyword">like</span> <span class="hljs-string">'%xxx%'</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> host
</code></pre>
<p>优化器自动添加 latency &gt; 100<code> </code>作为查询条件去查物化结果，用户完全无感。对于过滤性加速场景，多个 SQL 可以最大化复用物化结果，有效降低了物化带来的存储开销。</p>
<h2 data-id="heading-7">原理介绍</h2>
<p>对于用户创建的物化视图，日志服务会在后台自动托管整个计算与维护流程——无需用户干预，一切静默完成。</p>
<p>具体来说，系统会为每个物化视图启动一个智能定时任务，持续追踪新写入的日志数据。每隔一段时间，它就会自动执行您创建视图时指定的 SQL（无论是简单的过滤条件，还是复杂的聚合逻辑），并将计算结果持久化存储起来。每次任务完成后，系统还会精准记录“已处理到哪个时间点”，为后续查询提供优化依据。这一切对用户完全透明：不用写调度脚本、不用管任务失败、也不用担心数据一致性——日志服务全权负责。</p>
<p>当发起查询时，基于成本的优化器（CBO）会自动介入：</p>
<ul>
<li>如果发现有匹配的物化视图，它会智能选择最优的一个；</li>
<li>对于非聚合类查询，优化器将执行计划改写为“原始数据 + 物化数据”的轻量级 Union；</li>
<li>对于聚合类查询，则巧妙地将新数据实时聚合后，再与预计算结果合并。</li>
</ul>
<p>整个过程无缝衔接，既保证了结果的实时性与准确性，又大幅降低了查询延迟和资源开销。整个架构图如下所示（以聚合场景为例）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baeb2e5591a541968f4f6d1554b128a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764150904&amp;x-signature=VtQjBQJNcp36Y7Kre77Z2nv%2BfZw%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">案例分享：Dashboard 从“超时失败”到“秒级响应”</h2>
<p>在 Dashboard 场景中，用户对仪表盘打开时间极为敏感，通常要求秒级响应。当多个用户同时刷新 Dashboard 时，如果单个 SQL 请求消耗大量计算资源，会导致计算资源争抢，所有用户都在等待，严重影响用户体验。通过物化视图预计算关键指标，可以将原本需要分钟级计算的复杂查询优化为秒级响应，显著提升用户体验。</p>
<p>举个真实场景：当系统延迟突然飙升，如何快速定位问题？</p>
<p>假设一个高并发的在线服务，其日志数据被写入某个 Logstore 中。每条日志记录的关键信息：</p>
<ul>
<li>请求延迟（latency）</li>
<li>请求类型（RequestType）</li>
<li>用户 ID（ProjectId）</li>
<li>状态码（Status）</li>
<li>请求数据量（InFlow）</li>
<li>返回数据量（OutFlow）</li>
</ul>
<p>某时刻，监控告警响起——系统平均延迟突然升高！是正常波动？是流量激增导致？还是某个特定用户或接口出了问题？你需要立刻响应，不想等上几十秒甚至最后超时无法看到结果。</p>
<p><strong>创建物化视图的 SQL：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">*| <span class="hljs-function"><span class="hljs-keyword">select</span> <span class="hljs-title">avg</span>(<span class="hljs-params">latency</span>) <span class="hljs-keyword">as</span> avg_latency,<span class="hljs-title">date_trunc</span>(<span class="hljs-params"><span class="hljs-string">'hour'</span>, __time__</span>) <span class="hljs-keyword">as</span> time <span class="hljs-keyword">from</span> log <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> time
*| <span class="hljs-keyword">select</span> <span class="hljs-title">sum</span>(<span class="hljs-params">InFlow</span>) <span class="hljs-keyword">as</span> in_flow,<span class="hljs-title">sum</span>(<span class="hljs-params">OutFlow</span>) <span class="hljs-keyword">as</span> out_flow,<span class="hljs-title">avg</span>(<span class="hljs-params">latency</span>) <span class="hljs-keyword">as</span> latency, ProjectId,RequestType,Status <span class="hljs-keyword">from</span> log <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> ProjectId,RequestType,Status
</span></code></pre>
<p>仪表盘使用的 SQL：</p>
<pre><code class="hljs language-sql" lang="sql">统计每个小时的平均延迟同比一天前、三天前和一周前的变化
<span class="hljs-operator">*</span><span class="hljs-operator">|</span> <span class="hljs-keyword">select</span> <span class="hljs-type">time</span>,diff[<span class="hljs-number">1</span>] <span class="hljs-keyword">as</span> day1,diff[<span class="hljs-number">2</span>] <span class="hljs-keyword">as</span> day2,diff[<span class="hljs-number">3</span>] <span class="hljs-keyword">as</span> day3, diff[<span class="hljs-number">4</span>] <span class="hljs-keyword">as</span> day7 <span class="hljs-keyword">from</span> ( <span class="hljs-keyword">select</span> <span class="hljs-type">time</span>,ts_compare(avg_latency, <span class="hljs-number">86400</span>,<span class="hljs-number">172800</span>,<span class="hljs-number">604800</span>) <span class="hljs-keyword">as</span> diff <span class="hljs-keyword">from</span> (<span class="hljs-keyword">select</span> <span class="hljs-built_in">avg</span>(latency) <span class="hljs-keyword">as</span> avg_latency,date_trunc(<span class="hljs-string">'hour'</span>, __time__) <span class="hljs-keyword">as</span> <span class="hljs-type">time</span> <span class="hljs-keyword">from</span> log <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> <span class="hljs-type">time</span>) <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> <span class="hljs-type">time</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-type">time</span>) limit <span class="hljs-keyword">all</span>
按照 ProjectId 维度统计读写流量和延迟的变化
<span class="hljs-operator">*</span><span class="hljs-operator">|</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">sum</span>(InFlow)<span class="hljs-operator">/</span><span class="hljs-number">1024</span><span class="hljs-operator">/</span><span class="hljs-number">1024</span><span class="hljs-operator">/</span><span class="hljs-number">1024</span> <span class="hljs-keyword">as</span> in_flow,<span class="hljs-built_in">sum</span>(OutFlow)<span class="hljs-operator">/</span><span class="hljs-number">1024</span><span class="hljs-operator">/</span><span class="hljs-number">1024</span><span class="hljs-operator">/</span><span class="hljs-number">1024</span> <span class="hljs-keyword">as</span> out_flow,<span class="hljs-built_in">avg</span>(latency) <span class="hljs-keyword">as</span> latency,ProjectId <span class="hljs-keyword">from</span> log <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> ProjectId <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> in_flow <span class="hljs-keyword">desc</span> limit <span class="hljs-number">10</span>
按照 Status 维度和 ProjectId 的维度，统计平均延迟大于 <span class="hljs-number">200</span> 的读写流量
<span class="hljs-operator">*</span><span class="hljs-operator">|</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">sum</span>(InFlow)<span class="hljs-operator">/</span><span class="hljs-number">1024</span><span class="hljs-operator">/</span><span class="hljs-number">1024</span><span class="hljs-operator">/</span><span class="hljs-number">1024</span> <span class="hljs-keyword">as</span> in_flow,<span class="hljs-built_in">sum</span>(OutFlow)<span class="hljs-operator">/</span><span class="hljs-number">1024</span><span class="hljs-operator">/</span><span class="hljs-number">1024</span><span class="hljs-operator">/</span><span class="hljs-number">1024</span> <span class="hljs-keyword">as</span> out_flow,<span class="hljs-built_in">avg</span>(latency) <span class="hljs-keyword">as</span> latency,ProjectId <span class="hljs-keyword">from</span> log <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> Status,ProjectId <span class="hljs-keyword">having</span> latency <span class="hljs-operator">&gt;</span> <span class="hljs-number">200</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> in_flow <span class="hljs-keyword">desc</span>  limit <span class="hljs-number">10</span>
</code></pre>
<ol>
<li>查看近一周延迟同比的变化情况，开启了物化视图的请求，千亿以上数据秒内出结果，未开启的请求直接超时。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24320f24713b412f8d48e0786fa0c375~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764150904&amp;x-signature=P5Rx%2FNocJZleif3Rlxaz9bdxwBc%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f77648263c2945daa0dbac9ef863c84b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764150904&amp;x-signature=gM6FxE4X0TdW%2B3WXBnAtSg0qEdE%3D" alt="图片" loading="lazy"/></p>
<ol start="2">
<li>按照 ProjectId 维度统计读写流量和延迟的变化，开启了物化视图的请求，千亿以上数据不到 400 毫秒返回结果，而未开启的请求 54 秒才返回，性能提升 100 倍以上。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e207f96112a643168d6f7fdf094973f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764150904&amp;x-signature=YJgUBcilvYIVO1QjOcAzqLElT7g%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f5385986fc04f528c1241df134dd814~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764150904&amp;x-signature=cnUHEw7gdlExEWRrKt7xwyApPKU%3D" alt="图片" loading="lazy"/></p>
<ol start="3">
<li>按照 Status 维度和 ProjectId 的维度，统计平均延迟大于 200 的读写流量，由于统计的维度更多了，未使用物化视图的请求最后超时了，而使用物化视图后，800 多毫秒返回。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1d4dbd843c344b187a5d9138aa4eb7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764150904&amp;x-signature=u04GKFZC05kRMURR9PMj48O7tTg%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da3960642ae042998ddc8cfc6c370c9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764150904&amp;x-signature=2n4fNB2rVV%2BUNT74x81muxUEzQA%3D" alt="图片" loading="lazy"/></p>
<p>有趣的是，创建物化视图时写的 SQL 和系统实际执行的 SQL 并不完全相同。这正是阿里云日志服务强大的智能优化器在幕后工作——它能自动识别和改写查询逻辑，让用户无需深入了解底层细节，就可以轻松为仪表盘查询加速。</p>
<p>在千亿级数据规模的实测中，采用物化视图的图表可以秒开，而相同的 SQL 若不使用物化视图，即使是最快的情况也需要 50 多秒，更多时候会直接超时无法返回结果。这不仅是性能的提升，更是体验的质的飞跃。理论上来说数据规模越大，加速效果越好。在数据规模更加庞大的另一个 Region 中，万亿级数据的 SQL 查询也能稳定在 3 秒左右完成，进一步验证了随着数据量的增长，物化视图带来的性能收益呈现出更为显著的加速效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cd9316afaab4a51af259215c099e601~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764150904&amp;x-signature=BXJ1Kh0pAHJt4FpfKVA6csor3RM%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-9">展望</h2>
<p>在数据驱动的时代，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fsls%3Fspm%3Da1z389.11499242.0.0.65452413PLWe13%26utm_content%3Dg_1000408139" target="_blank" title="https://www.aliyun.com/product/sls?spm=a1z389.11499242.0.0.65452413PLWe13&amp;utm_content=g_1000408139" ref="nofollow noopener noreferrer">阿里云日志服务</a>物化视图通过预计算技术，从根本上解决了大规模日志分析中的性能瓶颈和吞吐量限制问题，为实时日志分析提供了新的技术解决方案。未来，我们将继续在以下方向深耕：</p>
<ul>
<li>智能推荐：自动识别高频查询模式，一键生成最优物化视图</li>
<li>扩展使用场景：支持 join 算子的物化视图，支持数据删除场景</li>
<li>改写增强：支持表达式非精确匹配的改写</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PageHelper 分页失效原因分析与正确实践]]></title>    <link>https://juejin.cn/post/7574245125028429843</link>    <guid>https://juejin.cn/post/7574245125028429843</guid>    <pubDate>2025-11-19T09:54:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245125028429843" data-draft-id="7574253222606618665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PageHelper 分页失效原因分析与正确实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-19T09:54:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秧歌star519"/> <meta itemprop="url" content="https://juejin.cn/user/2385260356310428"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PageHelper 分页失效原因分析与正确实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2385260356310428/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秧歌star519
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:54:18.000Z" title="Wed Nov 19 2025 09:54:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 问题现象</h2>
<p>在使用 PageHelper 插件开发查询接口时，出现分页失效的情况：接口返回了全部数据而非当前页数据，且 <code>PageInfo</code> 对象中的分页元数据（如 <code>total</code> 总条数、<code>pages</code> 总页数）计算错误。</p>
<h3 data-id="heading-1">❌ 错误代码示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> BaseResponse&lt;MyDataDTO&gt; <span class="hljs-title function_">queryDataList</span><span class="hljs-params">(<span class="hljs-type">int</span> pageNum, <span class="hljs-type">int</span> pageSize, Map&lt;String, Object&gt; params)</span> {
    <span class="hljs-type">BaseResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseResponse</span>();
    
    <span class="hljs-comment">// 1. 错误：在设置分页参数前执行了数据库查询</span>
    List&lt;MyDataDTO&gt; dataList = myMapper.selectData(params);
    
    <span class="hljs-comment">// 2. 判空逻辑</span>
    <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(dataList)) {
        <span class="hljs-comment">// 3. 错误：查询早已完成，此时调用 startPage 无效</span>
        PageHelper.startPage(pageNum, pageSize);
        
        <span class="hljs-comment">// 4. 错误：直接使用全量 List 包装 PageInfo，无法获取数据库真实总数</span>
        PageInfo&lt;MyDataDTO&gt; pageInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageInfo</span>&lt;&gt;(dataList);
        
        response.setResult(wrapPageResult(pageInfo));
        <span class="hljs-keyword">return</span> response;
    }
    
    response.setResult(Collections.EMPTY_LIST);
    <span class="hljs-keyword">return</span> response;
}
</code></pre>
<hr/>
<h2 data-id="heading-2">2. 原理分析</h2>
<p>PageHelper 的核心机制基于 <strong>ThreadLocal</strong> 和 <strong>MyBatis 拦截器（Interceptor）</strong>。</p>
<h3 data-id="heading-3">2.1 执行流程</h3>
<p>PageHelper 不是在内存中对结果集进行截取，而是通过拦截器修改 SQL 语句。</p>
<ol>
<li><strong>设置参数</strong>：调用 <code>PageHelper.startPage(...)</code> 时，插件会将分页参数（pageNum, pageSize）存入当前线程的 <code>ThreadLocal</code> 中。</li>
<li><strong>拦截 SQL</strong>：当 MyBatis 执行 Mapper 方法时，PageHelper 拦截器会触发。</li>
<li><strong>SQL 改写</strong>：
<ul>
<li>拦截器检查 <code>ThreadLocal</code> 中是否存在分页参数。</li>
<li><strong>若存在</strong>：拦截器会根据数据库方言（如 MySQL）生成 <code>SELECT COUNT(0)</code> 语句获取总数，并将原 SQL 改写为带 <code>LIMIT/OFFSET</code> 的分页 SQL 执行。</li>
<li><strong>若不存在</strong>：拦截器直接放行，执行原始 SQL。</li>
</ul>
</li>
<li><strong>清理上下文</strong>：SQL 执行结束后，拦截器会清除 <code>ThreadLocal</code> 中的分页参数，避免污染后续查询。</li>
</ol>
<h3 data-id="heading-4">2.2 失效原因</h3>
<p>在上述错误代码中：</p>
<ol>
<li><strong>执行顺序错误</strong>：<code>myMapper.selectData</code> 在 <code>PageHelper.startPage</code> 之前执行。</li>
<li><strong>拦截失败</strong>：执行查询时，<code>ThreadLocal</code> 中没有任何分页参数，拦截器未生效，MyBatis 执行了全量查询。</li>
<li><strong>参数无效</strong>：查询结束后才调用 <code>startPage</code>，虽然设置了 <code>ThreadLocal</code>，但 SQL 交互已结束，该参数未被消费。</li>
<li><strong>元数据错误</strong>：<code>PageInfo</code> 接收的是全量 List，因此它只能基于 List 的大小计算 <code>total</code>，导致分页信息不符合预期。</li>
</ol>
<hr/>
<h2 data-id="heading-5">3. ✅ 正确实现</h2>
<p><strong>核心原则</strong>：<code>PageHelper.startPage</code> 必须紧邻 Mapper 查询方法之前调用。</p>
<h3 data-id="heading-6">修正代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> BaseResponse&lt;MyDataDTO&gt; <span class="hljs-title function_">queryDataList</span><span class="hljs-params">(<span class="hljs-type">int</span> pageNum, <span class="hljs-type">int</span> pageSize, Map&lt;String, Object&gt; params)</span> {
    <span class="hljs-type">BaseResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseResponse</span>();

    <span class="hljs-comment">// 1. 设置分页参数（存入 ThreadLocal）</span>
    PageHelper.startPage(pageNum, pageSize);
    
    <span class="hljs-comment">// 2. 执行查询（拦截器生效，自动改写 SQL 并执行 Count 查询）</span>
    <span class="hljs-comment">// 注意：此时返回的 list 实际类型为 Page&lt;E&gt;</span>
    List&lt;MyDataDTO&gt; dataList = myMapper.selectData(params);

    <span class="hljs-comment">// 3. 获取分页结果</span>
    PageInfo&lt;MyDataDTO&gt; pageInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageInfo</span>&lt;&gt;(dataList);
    
    <span class="hljs-comment">// 4. 结果处理（PageInfo 可安全处理空集合）</span>
    <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(dataList)) {
         <span class="hljs-comment">// pageInfo.getTotal() 为数据库真实总数</span>
         response.setResult(wrapPageResult(pageInfo));
    } <span class="hljs-keyword">else</span> {
         response.setResult(Collections.EMPTY_LIST);
    }
    
    <span class="hljs-keyword">return</span> response;
}
</code></pre>
<hr/>
<h2 data-id="heading-7">4. 最佳实践与注意事项</h2>
<ol>
<li>
<p><strong>严格遵守调用顺序</strong>
必须保证 <code>startPage</code> -&gt; <code>Mapper查询</code> -&gt; <code>PageInfo包装</code> 的执行顺序。</p>
</li>
<li>
<p><strong>避免逻辑穿插</strong>
严禁在 <code>startPage</code> 和 <code>Mapper查询</code> 之间插入其他 SQL 操作或复杂逻辑。</p>
<ul>
<li><strong>风险</strong>：PageHelper 的分页参数是“一次性消费”的。如果在分页查询前插入了其他 SQL（如查询用户信息），分页参数会被那条 SQL 消费掉，导致原本需要分页的主查询失效。</li>
</ul>
</li>
<li>
<p><strong>PageInfo 的健壮性</strong>
无需为了判空调整代码顺序。<code>PageInfo</code> 对空 List 有良好的兼容性，若查询结果为空，它会自动设置 <code>total=0</code>，不会抛出异常。</p>
</li>
<li>
<p><strong>大数据量风险</strong>
如果因顺序错误导致分页失效，全量查询可能会将百万级数据加载至内存，极易引发 OOM（内存溢出），影响系统稳定性。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【底层机制】Android OTA更新系统：原理与应用深度解析]]></title>    <link>https://juejin.cn/post/7574281453706739718</link>    <guid>https://juejin.cn/post/7574281453706739718</guid>    <pubDate>2025-11-19T09:58:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574281453706739718" data-draft-id="7574245125028446227" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【底层机制】Android OTA更新系统：原理与应用深度解析"/> <meta itemprop="keywords" content="Android,面试"/> <meta itemprop="datePublished" content="2025-11-19T09:58:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐怡旸"/> <meta itemprop="url" content="https://juejin.cn/user/2875978146656750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【底层机制】Android OTA更新系统：原理与应用深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978146656750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐怡旸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T09:58:19.000Z" title="Wed Nov 19 2025 09:58:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3db9d0837844dbb8955347aa14d2f87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5oCh5pe4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764151147&amp;x-signature=Ug08MmlNYDDiq%2F8%2FEP2CxZVo9Yk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-0"><strong>一、 OTA更新系统概述</strong></h4>
<p>OTA（Over-The-Air）更新是指通过无线网络下载和安装系统更新的技术。在Android生态中，OTA更新系统是一个复杂而精密的工程，涉及多个系统组件和严格的安全验证。</p>
<p><strong>核心价值：</strong></p>
<ul>
<li>无需连接电脑即可完成系统升级</li>
<li>快速推送安全补丁和功能更新</li>
<li>提供完整的回滚和容错机制</li>
</ul>
<h4 data-id="heading-1"><strong>二、 OTA更新类型</strong></h4>
<p><strong>1. 完整更新（Full OTA）</strong></p>
<ul>
<li>包含完整的系统镜像</li>
<li>体积较大，但兼容性最好</li>
<li>可以修复任何系统损坏问题</li>
</ul>
<p><strong>2. 增量更新（Incremental OTA）</strong></p>
<ul>
<li>仅包含与上一版本的差异文件</li>
<li>体积小，下载速度快</li>
<li>需要基于特定基础版本构建</li>
</ul>
<p><strong>3. A/B 系统更新（Seamless Update）</strong></p>
<ul>
<li>Android 7.0+引入的新机制</li>
<li>在系统运行时更新备用系统分区</li>
<li>下次重启时切换到新系统，实现无缝更新</li>
</ul>
<h4 data-id="heading-2"><strong>三、 OTA系统架构与核心组件</strong></h4>
<p><strong>1. 系统更新服务（Update Engine）</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 核心服务，位于 system/update_engine/</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UpdateEngineService</span> {
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ApplyPayload</span><span class="hljs-params">(<span class="hljs-type">const</span> string&amp; payload_url)</span></span>;
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Bind</span><span class="hljs-params">(<span class="hljs-type">const</span> string&amp; update_engine)</span></span>;
}
</code></pre>
<ul>
<li>负责下载和验证更新包</li>
<li>管理更新过程的生命周期</li>
<li>与恢复系统（Recovery）交互</li>
</ul>
<p><strong>2. 恢复系统（Recovery System）</strong></p>
<ul>
<li>独立的迷你Linux系统</li>
<li>负责实际写入系统分区</li>
<li>提供恢复模式和故障处理</li>
</ul>
<p><strong>3. OTA包结构解析</strong></p>
<pre><code class="hljs language-python" lang="python">ota_package.<span class="hljs-built_in">zip</span>
├── META-INF/
│   ├── com/
│   │   └── android/
│   │       ├── metadata      <span class="hljs-comment"># 元数据：版本、设备信息</span>
│   │       └── otacert       <span class="hljs-comment"># 签名证书</span>
├── payload.<span class="hljs-built_in">bin</span>               <span class="hljs-comment"># 实际系统数据</span>
├── payload_properties.txt    <span class="hljs-comment"># 负载属性</span>
└── care_map.txt             <span class="hljs-comment"># 分区映射信息</span>
</code></pre>
<h4 data-id="heading-3"><strong>四、 OTA更新流程详解</strong></h4>
<p><strong>阶段一：更新检查与下载</strong></p>
<ol>
<li><strong>周期检查</strong>：系统定期向OTA服务器查询更新</li>
<li><strong>差分检测</strong>：服务器根据设备当前版本返回合适的更新包</li>
<li><strong>后台下载</strong>：通过DownloadManager下载OTA包到/cache或/data分区</li>
</ol>
<p><strong>阶段二：验证与准备</strong></p>
<ol>
<li><strong>签名验证</strong>：使用设备制造商公钥验证OTA包签名</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 签名验证核心逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">verifyPackage</span><span class="hljs-params">(Package pkg, Certificate deviceCert)</span> {
    <span class="hljs-keyword">return</span> pkg.verifySignature(deviceCert);
}
</code></pre>
<ol start="2">
<li><strong>兼容性检查</strong>：验证设备型号、基带版本等</li>
<li><strong>空间检查</strong>：确保有足够空间进行更新</li>
</ol>
<p><strong>阶段三：安装过程</strong></p>
<ol>
<li><strong>重启到恢复模式</strong>：系统重启进入Recovery环境</li>
<li><strong>分区验证</strong>：检查系统分区完整性</li>
<li><strong>应用更新</strong>：
<ul>
<li>完整更新：直接刷写新系统镜像</li>
<li>增量更新：使用bsdiff/bspatch应用差异</li>
</ul>
</li>
<li><strong>更新后优化</strong>：重新生成ART字节码，优化应用性能</li>
</ol>
<p><strong>A/B系统更新特殊流程：</strong></p>
<ol>
<li>在后台更新非活动系统分区（system_b）</li>
<li>更新完成设置启动标志位</li>
<li>下次重启时bootloader引导到新分区</li>
<li>如果启动失败，自动回退到旧分区</li>
</ol>
<h4 data-id="heading-4"><strong>五、 增量更新技术原理</strong></h4>
<p><strong>1. 差异算法</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 使用bsdiff生成差异包</span>
<span class="hljs-built_in">bsdiff</span>(old_file, new_file, patch_file);

<span class="hljs-comment">// 更新时应用差异</span>
<span class="hljs-built_in">bspatch</span>(old_file, new_file, patch_file);
</code></pre>
<p><strong>2. 块级差分</strong></p>
<ul>
<li>将系统镜像分割为固定大小的块</li>
<li>计算每个块的SHA256哈希值</li>
<li>只传输发生变化的块</li>
</ul>
<p><strong>3. 压缩优化</strong></p>
<ul>
<li>对差异数据使用LZ4或Brotli压缩</li>
<li>进一步减小更新包体积</li>
</ul>
<h4 data-id="heading-5"><strong>六、 安全机制</strong></h4>
<p><strong>1. 数字签名</strong></p>
<ul>
<li>OTA包必须由设备制造商签名</li>
<li>使用RSA-2048或ECDSA等非对称加密算法</li>
<li>防止恶意篡改和未授权更新</li>
</ul>
<p><strong>2. 版本回滚保护</strong></p>
<ul>
<li>防止设备降级到旧版本</li>
<li>通过版本号或防回滚计数器实现</li>
<li>避免安全漏洞被重新利用</li>
</ul>
<p><strong>3. 完整性验证</strong></p>
<ul>
<li>更新前验证当前系统完整性</li>
<li>更新后验证新系统完整性</li>
<li>使用dm-verity确保分区数据完整</li>
</ul>
<h4 data-id="heading-6"><strong>七、 系统集成与定制</strong></h4>
<p><strong>1. 厂商定制接口</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- OTA配置示例 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">config</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">updateUrl</span>&gt;</span>https://ota.vendor.com/update<span class="hljs-tag">&lt;/<span class="hljs-name">updateUrl</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">checkInterval</span>&gt;</span>86400<span class="hljs-tag">&lt;/<span class="hljs-name">checkInterval</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">requireBatteryLevel</span>&gt;</span>50<span class="hljs-tag">&lt;/<span class="hljs-name">requireBatteryLevel</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">config</span>&gt;</span>
</code></pre>
<p><strong>2. 运营商定制</strong></p>
<ul>
<li>运营商特定的更新策略</li>
<li>网络条件限制（如仅限WiFi更新）</li>
<li>数据用量控制</li>
</ul>
<p><strong>3. 企业设备管理</strong></p>
<ul>
<li>EMM（企业移动管理）控制的更新策略</li>
<li>批量部署和更新调度</li>
<li>合规性验证</li>
</ul>
<h4 data-id="heading-7"><strong>八、 故障处理与恢复</strong></h4>
<p><strong>1. 更新失败处理</strong></p>
<ul>
<li>自动回滚机制</li>
<li>恢复模式手动更新</li>
<li>Fastboot紧急恢复</li>
</ul>
<p><strong>2. 日志与诊断</strong></p>
<ul>
<li>详细的更新日志记录</li>
<li>错误代码和故障分类</li>
<li>远程诊断支持</li>
</ul>
<p><strong>3. 用户数据保护</strong></p>
<ul>
<li>更新过程不擦除用户数据</li>
<li>应用数据兼容性检查</li>
<li>备份和恢复机制</li>
</ul>
<h4 data-id="heading-8"><strong>九、 开发者应用场景</strong></h4>
<p><strong>1. 系统应用更新</strong></p>
<ul>
<li>通过OTA更新系统级应用</li>
<li>权限和API版本管理</li>
<li>兼容性测试策略</li>
</ul>
<p><strong>2. 功能标志管理</strong></p>
<ul>
<li>通过服务器控制功能开关</li>
<li>A/B测试新功能</li>
<li>渐进式功能发布</li>
</ul>
<p><strong>3. 热修复集成</strong></p>
<ul>
<li>与热修复系统协同工作</li>
<li>紧急问题快速修复</li>
<li>与正式更新的版本管理</li>
</ul>
<h4 data-id="heading-9"><strong>十、 未来发展趋势</strong></h4>
<p><strong>1. 模块化更新</strong></p>
<ul>
<li>Project Mainline模块更新</li>
<li>独立更新系统组件</li>
<li>更细粒度的控制</li>
</ul>
<p><strong>2. 智能更新</strong></p>
<ul>
<li>AI驱动的更新时机选择</li>
<li>基于使用模式的优化</li>
<li>预测性更新准备</li>
</ul>
<p><strong>3. 云原生集成</strong></p>
<ul>
<li>与云服务的深度集成</li>
<li>容器化系统组件</li>
<li>持续交付流水线</li>
</ul>
<h4 data-id="heading-10"><strong>十一、 总结</strong></h4>
<p>Android OTA更新系统是一个复杂而精密的工程，它体现了Android系统设计的多个核心理念：</p>
<ol>
<li>
<p><strong>安全第一</strong>：通过数字签名、完整性验证和回滚保护确保更新安全可靠。</p>
</li>
<li>
<p><strong>用户体验</strong>：A/B系统更新实现无缝升级，最大限度减少用户等待时间。</p>
</li>
<li>
<p><strong>资源优化</strong>：增量更新技术显著减少数据消耗，适应不同网络环境。</p>
</li>
<li>
<p><strong>生态协作</strong>：为设备制造商、运营商和企业提供灵活的定制能力。</p>
</li>
<li>
<p><strong>持续演进</strong>：从传统的恢复模式更新到现代的A/B无缝更新，系统不断进化。</p>
</li>
</ol>
<p>理解OTA更新系统的原理，对于Android系统开发、设备定制和企业移动管理都具有重要意义。这套系统不仅保证了Android生态的安全性和一致性，也为未来的系统架构演进奠定了坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae Coding - 「Excel 秒变海报」—— 上传 CSV，一句话生成可打印信息图。]]></title>    <link>https://juejin.cn/post/7574020645863653427</link>    <guid>https://juejin.cn/post/7574020645863653427</guid>    <pubDate>2025-11-19T07:58:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574020645863653427" data-draft-id="7574204970775298075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae Coding - 「Excel 秒变海报」—— 上传 CSV，一句话生成可打印信息图。 "/> <meta itemprop="keywords" content="Trae,人工智能,前端"/> <meta itemprop="datePublished" content="2025-11-19T07:58:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae Coding - 「Excel 秒变海报」—— 上传 CSV，一句话生成可打印信息图。 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T07:58:28.000Z" title="Wed Nov 19 2025 07:58:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Trae 的 Coding 能力已完全超出我们的印象</h2>
<p>Hello, 很高兴和大家分享Trae Coding 实战案例，作为一个应用开发工程师，相信大家已经在Ai强大能力的背后做了很多的心理建设了，有的担忧自己的从业前景，而有的技术发烧友正在利用强大的AI 能力完成他们的 Idea, ok, 今天我们借着(<a href="https://juejin.cn/post/7571751304625815598" target="_blank" title="https://juejin.cn/post/7571751304625815598">🚀TRAE SOLO 实战赛 | 智启Coding 码力全开🔥TRAE SOLO 正式版重磅上线，Vibe Codi - 掘金</a>) 机会，做一次深度应用开发实践。</p>
<h2 data-id="heading-1">项目背景</h2>
<p><strong>创意名：「Excel 秒变海报」—— 上传 CSV，一句话生成可打印信息图</strong></p>
<ol>
<li>前端上传 CSV → 调用 AntV ChartAdvisor 自动推荐最佳图表。</li>
<li>用户输入：“做成儿童节海报，要卡通、要粉色”。</li>
<li>AI 返回一份 Vega-Lite 配置 + 插画素材 URL，前端直接渲染成 300dpi SVG，可一键下载。<br/>
<strong>技术亮点</strong>：把「数据→图表→美化」三步压缩成一句自然语言。<br/>
<strong>教育意义</strong>：让非技术老师也能 30 秒做出家长会海报。</li>
</ol>
<h2 data-id="heading-2">实现过程</h2>
<p>1、创建项目</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad734a672cc24c40b02d8dba9d06b78c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=KgXrU2%2Fv1OIkWtQBwXqk0i%2FtLQA%3D" alt="image.png" loading="lazy"/></p>
<p>2、在builder环境输入我们的提示词，这个提示词是我用豆包生成的，每次没创意的时候我都这样做，在这个时代，我们甚至连想法都不缺了，缺的是谁足够认真，足够理解用户，足够理解产品，从而让Ai辅助我们完成一款高质量、高品质的应用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/864e481143f9413d93c56d93306cc912~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=0n3Zdorv0yZmAcbX1tUv44RlQJs%3D" alt="image.png" loading="lazy"/></p>
<p>3、完成Trae推荐的步骤，可以看到当Trae分析后，不出1分钟就给出了完备的开发计划，你只需要协助它不断调整迭代即可。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e883441e9bf04c0682022b357f26eabd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=bPjczCZNF9k8sH%2FNG2RQq2ZLEoY%3D" alt="image.png" loading="lazy"/></p>
<p>4、当然也要注意，有一些终端action需要我们手动去run一下，可不要连这个懒都偷呀，Ai让我们从容，而不是懒惰，因为好的产品一定出自于高效的工作流程和细腻的工程师把控。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be72494e47b34271a45b79b5ace24ecc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=XeCiP38hJdfQ8pBbr%2BwhvZoZDVI%3D" alt="image.png" loading="lazy"/></p>
<p>不到5分钟后，我们得到了如下提示：</p>
<p>——————</p>
<p>已完成「Excel 秒变海报」应用开发，实现了从 CSV 上传到可打印信息图生成的完整流程。</p>
<p>核心功能：</p>
<ol>
<li>CSV 上传与解析 ：支持上传 Excel 导出的 CSV 文件，自动解析数据</li>
<li>AI 图表推荐 ：集成 AntV ChartAdvisor，根据数据类型自动推荐最佳图表</li>
<li>自然语言美化 ：支持输入如「做成儿童节海报，要卡通、要粉色」的描述，自动解析主题、风格、颜色</li>
<li>300dpi SVG 输出 ：生成符合印刷标准的高清 SVG 格式海报</li>
<li>插画素材匹配 ：根据主题自动匹配相关插画素材</li>
<li>一键下载 ：支持直接下载生成的海报文件
技术实现：</li>
</ol>
<ul>
<li>前端框架：React + TypeScript + Vite</li>
<li>图表引擎：Vega-Lite</li>
<li>AI 推荐：AntV ChartAdvisor</li>
<li>文件解析：PapaParse
使用方式：</li>
</ul>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000%2F" target="_blank" title="http://localhost:3000/" ref="nofollow noopener noreferrer">http://localhost:3000/</a></li>
<li>上传 CSV 文件（提供了 test-data.csv 示例）</li>
<li>输入自然语言描述调整海报风格</li>
<li>点击「生成海报」</li>
<li>下载 300dpi SVG 格式海报
应用已成功启动开发服务器，可立即使用！</li>
</ol>
<h2 data-id="heading-3">结果展示</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2417fad7cfe24b9a9ad515310fa0d492~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=rN7Jx1e4iqoYsu5vf7oGT3mbfpA%3D" alt="image.png" loading="lazy"/></p>
<p>没错，你没有眼花，我也没有，是个空白页面。</p>
<p>此时一般你会有俩种心理：1、这什么垃圾，什么东西都没搞出来。2、这个右侧root 节点没有挂载成功，是不是这里有什么错误干扰，让Trae排查这里。</p>
<p>我选择第2种，因为我是项目的主导者，太多的情绪化，不利于我们项目的完成，而且人都会犯错，为什么AI 不被允许呢？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2be95d1ccb6457e9517a0a6c6ea2a50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=iu3%2FZeCc3niA6yRQtgG407W4%2BBI%3D" alt="image.png" loading="lazy"/></p>
<p>此刻，我把Trae当成了我的搭档，我会跟它高效沟通，然后也给它最大的期待。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/397aee10c9d846fca9e9b2e7e42ad523~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=qTdTlsM%2BU6GayeW8oEMQD%2BBzLqU%3D" alt="image.png" loading="lazy"/></p>
<p>我觉得太多的话无法去描述它，只需要看结果即可，Trae 马上做出了结构化的排查，并聪明的使用build打包命令来暴露文件结构或者代码安排上的错误，这一点我认为已经不输cursor了，为伟大的国产软件点赞！！！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8125a51a73ac4ece8ae84232901132cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=6NPYfPYsFwViYSpW2SXIT5s858U%3D" alt="image.png" loading="lazy"/></p>
<p>说时迟那时快，我们打字的功夫，Trae已经修复了问题，并打开了内置浏览器，展示了我们需要的功能，我只能说它没有让我失望，光凭这一点儿，我已经可以充一年pro会员了。</p>
<p>既然界面出来了，那我继续进行，顺便期待一下，剩余的挑战（摩拳擦掌），这里我有一个观点想分享，现代大多数开发者的内心都比较浮躁，总想一次完成，又快又好，殊不知，曲径通幽处。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42dbdc1e43334f14a38d12f61f0c6fd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=SiQ4ttQy2W%2FTYpj11ckpwoU%2FGfs%3D" alt="image.png" loading="lazy"/></p>
<p>我选择了一份测试数据，当点击生成海报时，右侧的渲染卡住了，那我们再来看看这个调整是什么，我们不妨先自己审查一下元素，或者看看控制台，有什么提示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27f15b571856413284944d69acc4ce95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=6DyQYBeaOyXlyj9HzznWL4UtnMc%3D" alt="image.png" loading="lazy"/></p>
<p>看起来挺好没有报错，那就是业务逻辑出现了问题，看看Trae又有什么样的表现。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3196b6b3bc6440b18a3be7ca3ca740ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=tT5j1uRdWSMVvdaDWd8K5bK9slw%3D" alt="image.png" loading="lazy"/></p>
<p>我是这样与它沟通的，尽量表达简洁，提供有用的信息，我附上截图和控制打印的数据。</p>
<p>进行了一段时间的修复后，没有按预期修复....，我们让Trae自己添加排查逻辑，这个是我用ai工具完成问题修复的利器：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f807d9b7ebb444d49cbef422ff338f6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=hTe5oDwILZjVHoVREjcFwBYnguk%3D" alt="image.png" loading="lazy"/></p>
<p>那么结果如下，大家一起来感受下成果，后续也等待着我们去进一步迭代更好看的ui、更强大的功能！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79a5a950c15a436aab58fc717bb6efa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGVvbkdhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143908&amp;x-signature=VQwqVCwmQrRGfAQARBFqBdZYEaY%3D" alt="Excel 秒变海报 - Google Chrome 2025-11-19 15-50-56.gif" loading="lazy"/></p>
<h2 data-id="heading-4">Trae 的开发总结</h2>
<h3 data-id="heading-5">项目概述</h3>
<p>PosterEngine是一款将CSV数据转换为可视化海报的Web应用，核心功能包括CSV解析、智能图表推荐（基于@antv/chart-advisor）和Vega-Lite图表渲染。</p>
<h3 data-id="heading-6">关键问题与解决方案</h3>
<ol>
<li>
<p>图表渲染失败 ：</p>
<ul>
<li>根本原因：图表容器div仅在 isRendered 为true时渲染，而该状态需在图表嵌入后设置，形成死锁。</li>
<li>修复：修改组件结构，始终渲染带ref的图表容器，并在未渲染完成时显示加载动画。</li>
</ul>
</li>
<li>
<p>特殊字符兼容性 ：</p>
<ul>
<li>根本原因：CSV字段"满意度%"包含%字符，可能在Vega-Lite配置中导致解析问题。</li>
<li>修复：在 enhanceChartConfig 函数中实现字段名净化，将数据和编码配置中的%统一替换为下划线。</li>
</ul>
</li>
<li>
<p>DOM时机问题 ：</p>
<ul>
<li>根本原因：useEffect可能在DOM完全渲染前执行，导致无法获取chartRef。</li>
<li>修复：改用useLayoutEffect确保DOM就绪后再执行图表嵌入逻辑。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-7">技术改进</h3>
<ul>
<li>增强图表嵌入的错误处理与日志输出</li>
<li>添加数据字段特殊字符净化机制</li>
<li>优化组件挂载逻辑，确保ref可靠访问</li>
</ul>
<h3 data-id="heading-8">最终状态</h3>
<ul>
<li>开发服务器运行在 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3002%2F" target="_blank" title="http://localhost:3002/" ref="nofollow noopener noreferrer">http://localhost:3002/</a></li>
<li>图表渲染功能正常</li>
<li>支持包含特殊字符的CSV数据</li>
<li>各组件集成工作良好</li>
</ul>
<p>最后感谢大家耐心的观看，支持作者的留下你的赞赞和评论！作者会发布更多优质内容。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 重试机制终极指南：基于 go-retry 打造可靠容错系统]]></title>    <link>https://juejin.cn/post/7574244766423007241</link>    <guid>https://juejin.cn/post/7574244766423007241</guid>    <pubDate>2025-11-19T08:09:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574244766423007241" data-draft-id="7574244766422990857" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 重试机制终极指南：基于 go-retry 打造可靠容错系统"/> <meta itemprop="keywords" content="Go,架构"/> <meta itemprop="datePublished" content="2025-11-19T08:09:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狼爷"/> <meta itemprop="url" content="https://juejin.cn/user/2418581314208279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 重试机制终极指南：基于 go-retry 打造可靠容错系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2418581314208279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狼爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T08:09:53.000Z" title="Wed Nov 19 2025 08:09:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><p>在分布式系统、API 调用、数据库操作等场景中，网络抖动、服务临时不可用等问题时有发生。重试机制作为容错设计的核心手段，能有效提升系统稳定性——但不合理的重试策略（如无限制重试、固定间隔重试）可能导致雪崩效应或资源耗尽。本文将深入解析 <code>sethvargo/go-retry</code> 这个轻量且强大的 Go 重试库，带你从原理到实践，构建灵活、安全、高效的重试逻辑。</p>
<h2 data-id="heading-0">一、为什么选择 go-retry？</h2>
<p>Go 标准库并未提供重试相关的原生支持，手动实现重试逻辑往往面临诸多问题：</p>
<ul>
<li>重复编码：每次需要重试时都要写循环、睡眠、退出条件判断；</li>
<li>策略僵化：难以灵活切换固定间隔、指数退避等重试策略；</li>
<li>错误处理混乱：无法清晰区分“可重试错误”和“不可重试错误”；</li>
<li>资源泄漏：忘记终止重试导致无限循环，或超时控制不当。</li>
</ul>
<p>而 <code>sethvargo/go-retry</code> 完美解决了这些痛点，其核心优势如下：</p>
<ol>
<li><strong>轻量无依赖</strong>：纯 Go 实现，代码量少，无额外依赖，接入成本极低；</li>
<li><strong>丰富的重试策略</strong>：内置固定间隔、指数退避、抖动退避等常用策略，支持自定义扩展；</li>
<li><strong>灵活的终止条件</strong>：支持最大重试次数、超时时间、自定义退出判断等多重终止规则；</li>
<li><strong>优雅的错误处理</strong>：清晰区分重试错误和最终失败，支持错误过滤（仅重试特定错误）；</li>
<li><strong>上下文支持</strong>：深度集成 <code>context.Context</code>，支持取消信号和超时控制，符合 Go 最佳实践；</li>
<li><strong>并发安全</strong>：核心组件可安全地在多个 goroutine 中复用。</li>
</ol>
<h2 data-id="heading-1">二、快速入门：5 分钟实现基础重试</h2>
<h3 data-id="heading-2">2.1 安装依赖</h3>
<p>首先通过 <code>go get</code> 安装库：</p>
<pre><code class="hljs language-bash" lang="bash">go get github.com/sethvargo/go-retry@latest
</code></pre>
<h3 data-id="heading-3">2.2 基础示例：重试 HTTP 请求</h3>
<p>下面以“重试调用一个不稳定的 API”为例，展示最基础的重试逻辑：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"net/http"</span>
	<span class="hljs-string">"time"</span>

	retry <span class="hljs-string">"github.com/sethvargo/go-retry"</span>
)

<span class="hljs-comment">// 模拟不稳定的 API 调用</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">callUnstableAPI</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
	resp, err := http.Get(<span class="hljs-string">"https://api.example.com/unstable"</span>)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		fmt.Println(<span class="hljs-string">"API 调用失败:"</span>, err)
		<span class="hljs-keyword">return</span> err <span class="hljs-comment">// 网络错误，可重试</span>
	}
	<span class="hljs-keyword">defer</span> resp.Body.Close()

	<span class="hljs-keyword">if</span> resp.StatusCode != http.StatusOK {
		fmt.Printf(<span class="hljs-string">"API 返回非 200 状态码: %d\n"</span>, resp.StatusCode)
		<span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"status code: %d"</span>, resp.StatusCode) <span class="hljs-comment">// 非 200 可重试</span>
	}

	fmt.Println(<span class="hljs-string">"API 调用成功!"</span>)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 1. 创建上下文（支持超时/取消）</span>
	ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">30</span>*time.Second)
	<span class="hljs-keyword">defer</span> cancel()

	<span class="hljs-comment">// 2. 定义重试策略：固定间隔 2 秒，最多重试 5 次</span>
	<span class="hljs-comment">// ConstantBackoff(间隔) + LimitMaxRetries(最大次数)</span>
	strategy := retry.WithMaxRetries(<span class="hljs-number">5</span>, retry.ConstantBackoff(<span class="hljs-number">2</span>*time.Second))

	<span class="hljs-comment">// 3. 执行重试逻辑</span>
	err := retry.Do(ctx, strategy, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> <span class="hljs-type">error</span> {
		err := callUnstableAPI()
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-comment">// 标记错误为“可重试”，触发下一次重试</span>
			<span class="hljs-keyword">return</span> retry.RetryableError(err)
		}
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> <span class="hljs-comment">// 成功则终止重试</span>
	})

	<span class="hljs-comment">// 4. 处理最终结果</span>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		fmt.Printf(<span class="hljs-string">"所有重试失败: %v\n"</span>, err)
		<span class="hljs-keyword">return</span>
	}
	fmt.Println(<span class="hljs-string">"重试流程正常结束"</span>)
}
</code></pre>
<h3 data-id="heading-4">核心概念解析</h3>
<ol>
<li><strong>Strategy（重试策略）</strong>：定义“何时重试”，如固定间隔、指数退避等，是 <code>go-retry</code> 的核心接口；</li>
<li><strong>RetryableError</strong>：包装错误，标记该错误是“可重试”的，若返回普通错误则直接终止重试；</li>
<li><strong>Context</strong>：传递超时、取消信号，确保重试逻辑能响应外部控制（如用户中断、服务关闭）。</li>
</ol>
<h2 data-id="heading-5">三、进阶用法：打造生产级重试逻辑</h2>
<h3 data-id="heading-6">3.1 选择合适的重试策略</h3>
<p><code>go-retry</code> 内置了 4 种常用策略，可根据场景组合使用：</p>
<h4 data-id="heading-7">1. 固定间隔重试（ConstantBackoff）</h4>
<p>适用于服务恢复时间可预测的场景（如数据库重启）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 每次重试间隔 1 秒，最多重试 3 次</span>
strategy := retry.WithMaxRetries(<span class="hljs-number">3</span>, retry.ConstantBackoff(<span class="hljs-number">1</span>*time.Second))
</code></pre>
<h4 data-id="heading-8">2. 指数退避重试（ExponentialBackoff）</h4>
<p>适用于高并发场景，避免重试风暴（间隔随重试次数指数增长）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 初始间隔 1 秒，最大间隔 10 秒，最多重试 5 次</span>
<span class="hljs-comment">// 间隔：1s → 2s → 4s → 8s → 10s（后续保持 10s）</span>
strategy := retry.WithMaxRetries(<span class="hljs-number">5</span>, retry.ExponentialBackoff(<span class="hljs-number">1</span>*time.Second, <span class="hljs-number">10</span>*time.Second))
</code></pre>
<h4 data-id="heading-9">3. 抖动退避（Jitter）</h4>
<p>在指数退避基础上添加随机抖动，进一步分散重试请求，避免“峰值同时重试”：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 指数退避 + 抖动，初始 1s，最大 10s，最多 5 次</span>
strategy := retry.WithMaxRetries(<span class="hljs-number">5</span>, retry.Jitter(retry.ExponentialBackoff(<span class="hljs-number">1</span>*time.Second, <span class="hljs-number">10</span>*time.Second), <span class="hljs-number">0.5</span>))
<span class="hljs-comment">// 第二个参数是抖动因子（0-1），因子越大，随机波动越明显</span>
</code></pre>
<h4 data-id="heading-10">4. 线性退避（LinearBackoff）</h4>
<p>间隔随重试次数线性增长（如 1s → 2s → 3s），适用于服务恢复时间缓慢增长的场景：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 初始间隔 1s，每次增加 1s，最大间隔 5s，最多重试 4 次</span>
strategy := retry.WithMaxRetries(<span class="hljs-number">4</span>, retry.LinearBackoff(<span class="hljs-number">1</span>*time.Second, <span class="hljs-number">1</span>*time.Second, <span class="hljs-number">5</span>*time.Second))
</code></pre>
<h3 data-id="heading-11">3.2 过滤可重试错误</h3>
<p>实际场景中，并非所有错误都需要重试（如参数错误、404 等），可通过 <code>retry.If</code> 过滤：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">30</span>*time.Second)
	<span class="hljs-keyword">defer</span> cancel()

	<span class="hljs-comment">// 仅重试“网络错误”和“5xx 状态码错误”</span>
	strategy := retry.WithMaxRetries(<span class="hljs-number">5</span>, retry.ConstantBackoff(<span class="hljs-number">2</span>*time.Second))

	err := retry.Do(ctx, strategy, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> <span class="hljs-type">error</span> {
		err := callUnstableAPI()
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-comment">// 自定义过滤逻辑：判断错误类型是否可重试</span>
			<span class="hljs-keyword">if</span> isRetryableError(err) {
				<span class="hljs-keyword">return</span> retry.RetryableError(err)
			}
			<span class="hljs-keyword">return</span> err <span class="hljs-comment">// 不可重试错误，直接终止</span>
		}
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})

	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		fmt.Printf(<span class="hljs-string">"最终失败: %v\n"</span>, err)
	}
}

<span class="hljs-comment">// 定义可重试错误的判断逻辑</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">isRetryableError</span><span class="hljs-params">(err <span class="hljs-type">error</span>)</span></span> <span class="hljs-type">bool</span> {
	<span class="hljs-comment">// 网络错误（如连接超时、拒绝连接）</span>
	<span class="hljs-keyword">if</span> _, ok := err.(*http.Error); ok {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
	}
	<span class="hljs-comment">// 5xx 状态码错误</span>
	<span class="hljs-keyword">if</span> err.Error()[:<span class="hljs-number">3</span>] == <span class="hljs-string">"500"</span> || err.Error()[:<span class="hljs-number">3</span>] == <span class="hljs-string">"503"</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
	}
	<span class="hljs-comment">// 其他错误（如 400、404）不可重试</span>
	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<h3 data-id="heading-12">3.3 结合超时和取消信号</h3>
<p>通过 <code>context</code> 实现多重控制：超时时间（整体重试流程的最大耗时）、手动取消（如用户中断）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 1. 设置整体超时 15 秒</span>
	ctx, cancel := context.WithTimeout(context.Background(), <span class="hljs-number">15</span>*time.Second)
	<span class="hljs-keyword">defer</span> cancel()

	<span class="hljs-comment">// 2. 启动一个 goroutine，模拟用户手动取消（5 秒后）</span>
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		time.Sleep(<span class="hljs-number">5</span> * time.Second)
		fmt.Println(<span class="hljs-string">"用户手动取消重试"</span>)
		cancel()
	}()

	<span class="hljs-comment">// 3. 重试策略：指数退避，最多 10 次（但会被超时/取消中断）</span>
	strategy := retry.WithMaxRetries(<span class="hljs-number">10</span>, retry.ExponentialBackoff(<span class="hljs-number">1</span>*time.Second, <span class="hljs-number">5</span>*time.Second))

	err := retry.Do(ctx, strategy, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> <span class="hljs-type">error</span> {
		<span class="hljs-comment">// 检查上下文是否已取消/超时</span>
		<span class="hljs-keyword">select</span> {
		<span class="hljs-keyword">case</span> &lt;-ctx.Done():
			<span class="hljs-keyword">return</span> ctx.Err() <span class="hljs-comment">// 传递取消信号</span>
		<span class="hljs-keyword">default</span>:
		}

		<span class="hljs-keyword">return</span> retry.RetryableError(callUnstableAPI())
	})

	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		fmt.Printf(<span class="hljs-string">"重试终止: %v\n"</span>, err) <span class="hljs-comment">// 可能是超时或取消错误</span>
	}
}
</code></pre>
<h3 data-id="heading-13">3.4 自定义重试策略</h3>
<p>如果内置策略不满足需求，可通过实现 <code>retry.Strategy</code> 接口自定义策略：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 自定义策略：前 3 次间隔 1 秒，之后间隔 3 秒</span>
<span class="hljs-keyword">type</span> CustomStrategy <span class="hljs-keyword">struct</span> {
	maxRetries <span class="hljs-type">int</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *CustomStrategy)</span></span> NextRetry(ctx context.Context, attempt <span class="hljs-type">int</span>) (time.Duration, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// attempt 是已重试次数（从 0 开始）</span>
	<span class="hljs-keyword">if</span> attempt &gt;= s.maxRetries {
		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>, retry.ErrMaxRetriesExceeded <span class="hljs-comment">// 达到最大次数，终止</span>
	}

	<span class="hljs-comment">// 前 3 次间隔 1s，之后 3s</span>
	<span class="hljs-keyword">if</span> attempt &lt; <span class="hljs-number">3</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-number">1</span> * time.Second, <span class="hljs-literal">nil</span>
	}
	<span class="hljs-keyword">return</span> <span class="hljs-number">3</span> * time.Second, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 使用自定义策略</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	ctx := context.Background()
	strategy := &amp;CustomStrategy{maxRetries: <span class="hljs-number">5</span>}

	err := retry.Do(ctx, strategy, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> <span class="hljs-type">error</span> {
		<span class="hljs-keyword">return</span> retry.RetryableError(callUnstableAPI())
	})
}
</code></pre>
<h3 data-id="heading-14">3.5 重试过程监控</h3>
<p>通过 <code>retry.WithCallback</code> 记录重试过程（如日志、指标上报）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	ctx := context.Background()

	<span class="hljs-comment">// 添加回调函数，监控每次重试</span>
	strategy := retry.WithCallback(
		retry.WithMaxRetries(<span class="hljs-number">5</span>, retry.ConstantBackoff(<span class="hljs-number">2</span>*time.Second)),
		<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, attempt <span class="hljs-type">int</span>, err <span class="hljs-type">error</span>, next time.Duration)</span></span> {
			fmt.Printf(<span class="hljs-string">"第 %d 次重试失败: %v，下次重试间隔 %v\n"</span>, attempt+<span class="hljs-number">1</span>, err, next)
			<span class="hljs-comment">// 此处可添加指标上报（如 Prometheus 计数器）</span>
			<span class="hljs-comment">// retryTotal.WithLabelValues("api").Inc()</span>
		},
	)

	err := retry.Do(ctx, strategy, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> <span class="hljs-type">error</span> {
		<span class="hljs-keyword">return</span> retry.RetryableError(callUnstableAPI())
	})
}
</code></pre>
<h2 data-id="heading-15">四、最佳实践与避坑指南</h2>
<h3 data-id="heading-16">4.1 最佳实践</h3>
<ol>
<li><strong>明确可重试场景</strong>：仅对“暂时性错误”重试（如网络抖动、5xx 服务错误、数据库锁等待），避免对“永久性错误”（如参数错误、404）重试；</li>
<li><strong>控制重试强度</strong>：结合 <code>WithMaxRetries</code> 和 <code>context.WithTimeout</code>，避免无限重试导致资源耗尽；</li>
<li><strong>使用退避+抖动</strong>：高并发场景优先选择“指数退避+抖动”，减少重试风暴对下游服务的压力；</li>
<li><strong>重试前检查上下文</strong>：在重试函数中优先检查 <code>ctx.Done()</code>，确保能及时响应取消/超时信号；</li>
<li><strong>不要重试幂等操作</strong>：若操作非幂等（如重复创建订单），需先保证接口幂等性，或通过唯一标识避免重复执行；</li>
<li><strong>记录重试日志</strong>：通过 <code>WithCallback</code> 记录重试次数、错误信息，便于问题排查。</li>
</ol>
<h3 data-id="heading-17">4.2 常见坑点</h3>
<ol>
<li><strong>忘记标记 RetryableError</strong>：若返回普通错误，重试会直接终止，需确保可重试错误被 <code>retry.RetryableError</code> 包装；</li>
<li><strong>忽略上下文取消</strong>：未在重试函数中检查 <code>ctx.Done()</code>，可能导致重试逻辑无法及时终止；</li>
<li><strong>重试策略过于激进</strong>：固定间隔+高重试次数，可能加剧下游服务压力，引发雪崩；</li>
<li><strong>未处理重试中的资源泄漏</strong>：如重试 HTTP 请求时未关闭 <code>resp.Body</code>，需在 <code>defer</code> 中确保资源释放；</li>
<li><strong>混淆“重试次数”和“尝试次数”</strong>：<code>WithMaxRetries(5)</code> 表示“最多重试 5 次”，即“总共尝试 6 次”（初始 1 次 + 重试 5 次）。</li>
</ol>
<h2 data-id="heading-18">五、总结</h2>
<p><code>sethvargo/go-retry</code> 以其轻量、灵活、贴合 Go 生态的设计，成为 Go 语言重试机制的首选库。通过本文的讲解，你可以掌握：</p>
<ul>
<li>基础重试逻辑的快速实现；</li>
<li>多种重试策略的选型与组合；</li>
<li>过滤可重试错误、监控重试过程、响应取消信号等进阶用法；</li>
<li>生产环境中的最佳实践与避坑要点。</li>
</ul>
<p>重试机制是系统容错能力的基础，但它不是银弹——需结合业务场景合理设计策略，同时搭配熔断、限流、降级等机制，才能构建真正高可用的分布式系统。如果你正在开发需要容错的 Go 应用，不妨试试 <code>go-retry</code>，它会让重试逻辑的编写变得简洁而可靠。</p>
<h2 data-id="heading-19">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsethvargo%2Fgo-retry" target="_blank" title="https://github.com/sethvargo/go-retry" ref="nofollow noopener noreferrer">go-retry 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.go.dev%2Fcontext" target="_blank" title="https://pkg.go.dev/context" ref="nofollow noopener noreferrer">Go 官方 Context 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmartinfowler.com%2Farticles%2Fpatterns-of-distributed-systems%2F" target="_blank" title="https://martinfowler.com/articles/patterns-of-distributed-systems/" ref="nofollow noopener noreferrer">分布式系统容错设计原则</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apache Doris AI 能力揭秘（三）：AI_AGG 与 EMBED 函数深度解析]]></title>    <link>https://juejin.cn/post/7574045294611726371</link>    <guid>https://juejin.cn/post/7574045294611726371</guid>    <pubDate>2025-11-19T08:10:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574045294611726371" data-draft-id="7573995798604185615" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apache Doris AI 能力揭秘（三）：AI_AGG 与 EMBED 函数深度解析"/> <meta itemprop="keywords" content="Apache,数据库,后端"/> <meta itemprop="datePublished" content="2025-11-19T08:10:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apache Doris AI 能力揭秘（三）：AI_AGG 与 EMBED 函数深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T08:10:22.000Z" title="Wed Nov 19 2025 08:10:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在初步探索了 AI 函数的可能性之后，本次我们将目光投向两个更为核心的函数：<code>AI_AGG</code> 和 <code>EMBED</code>。我们将深入解析这两个函数的设计理念、实现原理及其在业务场景中的应用，展示 Apache Doris 如何通过原生的函数设计，将文本聚合与语义向量分析无缝集成到 SQL 中，为用户提供更强大、更易用的智能数据分析体验。</p>
<p>相关阅读：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1491" target="_blank" title="https://www.selectdb.com/blog/1491" ref="nofollow noopener noreferrer">Apache Doris 4.0 AI 能力揭秘（二）：为企业级应用而生的 AI 函数设计与实践</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1455" target="_blank" title="https://www.selectdb.com/blog/1455" ref="nofollow noopener noreferrer">Apache Doris 4.0 AI 能力揭秘（一）：AI 函数之 LLM 函数介绍</a></li>
</ul>
<h2 data-id="heading-0">AI_AGG：基于 AI 的文本聚合</h2>
<p>聚合是数据分析中最常见的操作，但如果聚合的对象是海量的用户评论、支持工单或日志文本，传统的聚合函数难以直接处理这类非结构化文本数据。为此，Doris 支持了 <code>AI_AGG</code>，一个能够调用 AI 对文本进行聚合的函数。它让分析师可以根据自定义指令，从大量的文本中处理特定的任务。</p>
<h3 data-id="heading-1">01 使用方法及示例</h3>
<blockquote>
<p>AI_AGG 详细用法请参考： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2Fdev%2Fsql-manual%2Fsql-functions%2Faggregate-functions%2Fai-agg" target="_blank" title="https://doris.apache.org/zh-CN/docs/dev/sql-manual/sql-functions/aggregate-functions/ai-agg" ref="nofollow noopener noreferrer">doris.apache.org/zh-CN/docs/…</a></p>
</blockquote>
<p><strong>示例 1：</strong></p>
<p>下表模拟一个简易的客服工单：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> support_tickets;
<span class="hljs-operator">+</span><span class="hljs-comment">-----------+---------------+------------------+----------------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span> ticket_id <span class="hljs-operator">|</span> customer_name <span class="hljs-operator">|</span> subject          <span class="hljs-operator">|</span> details                                                                          <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------+---------------+------------------+----------------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>         <span class="hljs-number">2</span> <span class="hljs-operator">|</span> Bob           <span class="hljs-operator">|</span> Login Failure    <span class="hljs-operator">|</span> Same problem <span class="hljs-keyword">as</span> Alice. Also seeing <span class="hljs-number">502</span> errors <span class="hljs-keyword">on</span> the SSO page.                   <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>         <span class="hljs-number">3</span> <span class="hljs-operator">|</span> Carol         <span class="hljs-operator">|</span> Payment Declined <span class="hljs-operator">|</span> Credit card charged twice but <span class="hljs-keyword">order</span> still shows pending.                         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>         <span class="hljs-number">5</span> <span class="hljs-operator">|</span> Eve           <span class="hljs-operator">|</span> Login Failure    <span class="hljs-operator">|</span> Getting redirected back <span class="hljs-keyword">to</span> login after entering <span class="hljs-number">2</span>FA code.                        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>         <span class="hljs-number">1</span> <span class="hljs-operator">|</span> Alice         <span class="hljs-operator">|</span> Login Failure    <span class="hljs-operator">|</span> Cannot log <span class="hljs-keyword">in</span> after password reset. Tried clearing cache <span class="hljs-keyword">and</span> different browsers. <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>         <span class="hljs-number">4</span> <span class="hljs-operator">|</span> Dave          <span class="hljs-operator">|</span> Slow Dashboard   <span class="hljs-operator">|</span> Dashboard takes <span class="hljs-operator">&gt;</span><span class="hljs-number">30</span> seconds <span class="hljs-keyword">to</span> load since the <span class="hljs-keyword">last</span> release.                      <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------+---------------+------------------+----------------------------------------------------------------------------------+</span>
</code></pre>
<p><strong>我们可以通过 <code>AI_AGG</code> 对不同问题类型下客户的问题进行总结</strong></p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span>
    subject,
    AI_AGG(
        details,
        <span class="hljs-string">'Summarize every ticket detail into one short paragraph'</span>
    ) <span class="hljs-keyword">AS</span> ai_summary
<span class="hljs-keyword">FROM</span> support_tickets
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> subject;
</code></pre>
<p>输出示例如下：</p>
<pre><code class="hljs language-Plain" lang="Plain">+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| subject          | ai_summary                                                                                                                                                              |
+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Slow Dashboard   | The dashboard is experiencing slow loading times, taking over 30 seconds to load following the most recent release.                                                     |
| Payment Declined | A customer reports being charged twice for their order, which remains in a pending status.                                                                              |
| Login Failure    | Users are experiencing login issues, including 2FA redirection, post-password reset failures, and SSO 502 errors, despite clearing cache and trying different browsers. |
+------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
</code></pre>
<p><strong>示例 2：</strong></p>
<p>下表简易模拟了应用反馈表：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> app_feedback;
<span class="hljs-operator">+</span><span class="hljs-comment">-------------+----------------+-----------+--------------------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span> feedback_id <span class="hljs-operator">|</span> feature_module <span class="hljs-operator">|</span> user_name <span class="hljs-operator">|</span> feedback_text                                                                        <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------+----------------+-----------+--------------------------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>           <span class="hljs-number">1</span> <span class="hljs-operator">|</span> 机票预订       <span class="hljs-operator">|</span> 李雷      <span class="hljs-operator">|</span> 搜索航班非常快，价格也透明，筛选功能很好用。                                         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           <span class="hljs-number">2</span> <span class="hljs-operator">|</span> 机票预订       <span class="hljs-operator">|</span> 韩梅梅    <span class="hljs-operator">|</span> 支付后出票速度有点慢，等了快半小时，希望能改进。                                     <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           <span class="hljs-number">3</span> <span class="hljs-operator">|</span> 机票预订       <span class="hljs-operator">|</span> 小陈      <span class="hljs-operator">|</span> 希望能增加更多廉价航空公司的选项。                                                   <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           <span class="hljs-number">4</span> <span class="hljs-operator">|</span> 机票预订       <span class="hljs-operator">|</span> 马丽      <span class="hljs-operator">|</span> App在选择日期的时候偶尔会卡顿，体验不是很好。                                        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           <span class="hljs-number">5</span> <span class="hljs-operator">|</span> 酒店预订       <span class="hljs-operator">|</span> 王先生    <span class="hljs-operator">|</span> 酒店信息很全，图片也真实。但是取消预订的流程太复杂了。                               <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           <span class="hljs-number">6</span> <span class="hljs-operator">|</span> 酒店预订       <span class="hljs-operator">|</span> 刘女士    <span class="hljs-operator">|</span> 通过App预订比其他平台便宜，还有会员折扣，非常满意。                                  <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           <span class="hljs-number">7</span> <span class="hljs-operator">|</span> 行程规划       <span class="hljs-operator">|</span> 赵四      <span class="hljs-operator">|</span> 行程规划功能太棒了，可以自动推荐路线和景点，省了不少心。                             <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           <span class="hljs-number">8</span> <span class="hljs-operator">|</span> 客户服务       <span class="hljs-operator">|</span> 孙小小    <span class="hljs-operator">|</span> 联系客服很方便，问题解决得也很快，给客服点赞。                                       <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           <span class="hljs-number">9</span> <span class="hljs-operator">|</span> 客户服务       <span class="hljs-operator">|</span> 钱多多    <span class="hljs-operator">|</span> 电话客服总是占线，在线客服回复又很慢，希望能增加人手。                               <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-------------+----------------+-----------+--------------------------------------------------------------------------------------+</span>
</code></pre>
<p><strong>我们可以通过 <code>AI_AGG</code> 对用户反馈进行总结：</strong></p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span>
    feature_module <span class="hljs-keyword">AS</span> <span class="hljs-string">'功能模块'</span>,
    AI_AGG(
        feedback_text,
        <span class="hljs-string">'请用精确且尽可能简短地总结这些用户反馈中提到的主要问题和建议'</span>
    ) <span class="hljs-keyword">AS</span> <span class="hljs-string">'AI反馈总结'</span>
<span class="hljs-keyword">FROM</span> app_feedback
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> feature_module;
</code></pre>
<p>输出示例如下</p>
<pre><code class="hljs language-Plain" lang="Plain">+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 功能模块     | AI反馈总结                                                                                                                                                                                                     |
+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| 客户服务     | 主要问题：客服电话占线，在线客服回复慢。  
主要建议：增加客服人手。                                                                                                                                                |
| 行程规划     | 主要问题：无  
主要建议：赞赏行程规划功能，建议继续优化                                                                                                                                                        |
| 酒店预订     | 主要问题：取消预订流程复杂。
主要建议：无明确建议，但肯定App预订价格优势和会员折扣。                                                                                                                          |
| 机票预订     | 主要问题：支付后出票慢（约半小时），App日期选择卡顿，廉价航空公司选项不足。
主要建议：优化出票速度，修复App卡顿问题，增加廉价航空公司选项。                                                                   |
+--------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
</code></pre>
<h3 data-id="heading-2">02 AI_AGG 的实现原理</h3>
<p>将聚合函数与 AI 结合，需要解决一个分组内文本总量可能远超模型上下文窗口的问题。如果将所有文本拼接后一次性发送给 AI， 极易出现拼接文本大于模型的最大上下文窗口的情况，<strong>而 Doris 中通过动态预聚合解决了这个问题：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b494b99e2c2e487f99313c46db572ae2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764144622&amp;x-signature=gzMRN8uc8k9TGtdqmxU%2B8V7Hwkw%3D" alt="02 AI_AGG 的实现原理.png" loading="lazy"/></p>
<ol>
<li><strong>上下文监控</strong>：在聚合拼接文本的过程中，<code>AI_AGG</code> 会为每一个分组维护一个内部的文本缓冲区（目前大小固定为 128K，为绝大部分 AI 可兼容的上下文窗口）</li>
<li><strong>动态预聚合</strong>：当新的文本行将要被加入缓冲区并会导致其大小超过阈值时，<code>AI_AGG</code> 会触发一次预聚合。它会暂停接收新数据，将当前缓冲区内的所有文本作为一个批次发送给 AI 进行一次中间任务处理。</li>
<li><strong>上下文替换</strong>：AI 返回的中间处理结果，其长度通常远小于原始文本。<code>AI_AGG</code> 会用这个精炼后的摘要替换掉缓冲区内原有的长文本，从而为处理更多的新文本行腾出空间。为保证聚合过程的稳定性和防止超出模型服务上限，在替换原有文本后，若加入当前文本行还是会导致缓冲区超过阈值，<code>AI_AGG</code> 会直接报错退出。</li>
</ol>
<p><strong>通过这种实现方式，<code>AI_AGG</code> 可以完全融入 Doris 的分布式查询计划，利用多节点并行计算，并由数据库自动管理聚合过程中的中间状态。因此，用户可以用熟悉的 SQL 聚合语法，在海量文本上实现高效的智能分析。</strong></p>
<h2 data-id="heading-3">EMBED: 文本向量化函数</h2>
<p><code>EMBED</code> 函数的核心功能是通过 AI 将任意文本转换为高维度的浮点数向量。这个向量是文本在语义空间中的一种数学表示，它捕捉了文本的语义信息。语义相近的文本，其向量在空间中的距离也更近。</p>
<blockquote>
<p>EMBED 详细用法请参考： <a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2Fdev%2Fsql-manual%2Fsql-functions%2Fai-functions%2Fdistance-functions%2Fembed" target="_blank" title="https://doris.apache.org/zh-CN/docs/dev/sql-manual/sql-functions/ai-functions/distance-functions/embed" ref="nofollow noopener noreferrer">doris.apache.org/zh-CN/docs/…</a></p>
</blockquote>
<h3 data-id="heading-4">01 使用方法及示例</h3>
<p><strong>示例 1：</strong></p>
<p>下表模拟简易的行为手册</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> knowledge_base (
    id <span class="hljs-type">BIGINT</span>,
    title STRING,
    content STRING,
    embedding <span class="hljs-keyword">ARRAY</span><span class="hljs-operator">&lt;</span><span class="hljs-type">FLOAT</span><span class="hljs-operator">&gt;</span> COMMENT <span class="hljs-string">'Semantic vector generated by EMBED function'</span>
)
DUPLICATE KEY(id)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(id) BUCKETS <span class="hljs-number">4</span>
PROPERTIES (
    "replication_num" <span class="hljs-operator">=</span> "1"
);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> knowledge_base (id, title, content, embedding) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">1</span>, "Travel Reimbursement Policy",
    "Employees must submit a reimbursement request within 7 days after the business trip, with invoices and travel approval attached.",
    EMBED("travel reimbursement policy")),
(<span class="hljs-number">2</span>, "Leave Policy",
    "Employees must apply for leave in the system in advance. If the leave is longer than three days, approval from the direct manager is required.",
    EMBED("leave request policy")),
(<span class="hljs-number">3</span>, "VPN User Guide",
    "To access the internal network, employees must use VPN. For the first login, download and install the client and configure the certificate.",
    EMBED("VPN guide intranet access")),
(<span class="hljs-number">4</span>, "Meeting Room Reservation",
    "Meeting rooms can be reserved in advance through the OA system, with time and number of participants specified.",
    EMBED("meeting room booking reservation")),
(<span class="hljs-number">5</span>, "Procurement Request Process",
    "Departments must fill out a procurement request form for purchasing items. If the amount exceeds $5000, financial approval is required.",
    EMBED("procurement request process finance"));
</code></pre>
<p><strong>通过 <code>EMBED</code> 函数对文本的向量化操作，结合 Doris 支持的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2Fdev%2Fsql-manual%2Fsql-functions%2Fai-functions%2Fdistance-functions%2Fcosine-distance" target="_blank" title="https://doris.apache.org/zh-CN/docs/dev/sql-manual/sql-functions/ai-functions/distance-functions/cosine-distance" ref="nofollow noopener noreferrer">向量函数</a>， 可对数据进行如下操作：</strong></p>
<ol>
<li>问答检索（结合 <code>COSINE_DISTANCE</code>）</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> 
    id, title, content,
    COSINE_DISTANCE(embedding, EMBED("How to apply for travel reimbursement?")) <span class="hljs-keyword">AS</span> score
<span class="hljs-keyword">FROM</span> knowledge_base
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> score <span class="hljs-keyword">ASC</span>
LIMIT <span class="hljs-number">2</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+--------------------+</span>
<span class="hljs-operator">|</span> id   <span class="hljs-operator">|</span> title                       <span class="hljs-operator">|</span> content                                                                                                                                 <span class="hljs-operator">|</span> score              <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+--------------------+</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">1</span> <span class="hljs-operator">|</span> Travel Reimbursement Policy <span class="hljs-operator">|</span> Employees must submit a reimbursement request <span class="hljs-keyword">within</span> <span class="hljs-number">7</span> days after the business trip, <span class="hljs-keyword">with</span> invoices <span class="hljs-keyword">and</span> travel approval attached.        <span class="hljs-operator">|</span> <span class="hljs-number">0.4463210454563673</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">5</span> <span class="hljs-operator">|</span> Procurement Request Process <span class="hljs-operator">|</span> Departments must fill <span class="hljs-keyword">out</span> a procurement request form <span class="hljs-keyword">for</span> purchasing items. If the amount exceeds $<span class="hljs-number">5000</span>, financial approval <span class="hljs-keyword">is</span> required. <span class="hljs-operator">|</span> <span class="hljs-number">0.5726841578491431</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+--------------------+</span>
</code></pre>
<ol>
<li>问题分析匹配（结合 <code>L2_DISTANCE</code>）</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> 
    id, title, content,
    L2_DISTANCE(embedding, EMBED("How to access the company intranet")) <span class="hljs-keyword">AS</span> distance
<span class="hljs-keyword">FROM</span> knowledge_base
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> distance <span class="hljs-keyword">ASC</span>
LIMIT <span class="hljs-number">2</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+---------------------------------------------------------------------------------------------------------------------------------------------+--------------------+</span>
<span class="hljs-operator">|</span> id   <span class="hljs-operator">|</span> title                       <span class="hljs-operator">|</span> content                                                                                                                                     <span class="hljs-operator">|</span> distance           <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+---------------------------------------------------------------------------------------------------------------------------------------------+--------------------+</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">3</span> <span class="hljs-operator">|</span> VPN <span class="hljs-keyword">User</span> Guide              <span class="hljs-operator">|</span> <span class="hljs-keyword">To</span> access the internal network, employees must use VPN. <span class="hljs-keyword">For</span> the <span class="hljs-keyword">first</span> login, download <span class="hljs-keyword">and</span> install the client <span class="hljs-keyword">and</span> configure the certificate. <span class="hljs-operator">|</span> <span class="hljs-number">0.5838271122253775</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">1</span> <span class="hljs-operator">|</span> Travel Reimbursement Policy <span class="hljs-operator">|</span> Employees must submit a reimbursement request <span class="hljs-keyword">within</span> <span class="hljs-number">7</span> days after the business trip, <span class="hljs-keyword">with</span> invoices <span class="hljs-keyword">and</span> travel approval attached.            <span class="hljs-operator">|</span>  <span class="hljs-number">1.272394695975331</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+---------------------------------------------------------------------------------------------------------------------------------------------+--------------------+</span>
</code></pre>
<ol>
<li>根据文章内容进行文本相关度匹配并推荐（结合<code>INNER PRODUCT</code>）</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> 
    id, title, content,
    INNER_PRODUCT(embedding, EMBED("Leave system request leader approval")) <span class="hljs-keyword">AS</span> score
<span class="hljs-keyword">FROM</span> knowledge_base
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">!=</span> <span class="hljs-number">2</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> score <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">2</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+---------------------+</span>
<span class="hljs-operator">|</span> id   <span class="hljs-operator">|</span> title                       <span class="hljs-operator">|</span> content                                                                                                                                 <span class="hljs-operator">|</span> score               <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+---------------------+</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">5</span> <span class="hljs-operator">|</span> Procurement Request Process <span class="hljs-operator">|</span> Departments must fill <span class="hljs-keyword">out</span> a procurement request form <span class="hljs-keyword">for</span> purchasing items. If the amount exceeds $<span class="hljs-number">5000</span>, financial approval <span class="hljs-keyword">is</span> required. <span class="hljs-operator">|</span>    <span class="hljs-number">0.33268885332504</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">4</span> <span class="hljs-operator">|</span> Meeting Room Reservation    <span class="hljs-operator">|</span> Meeting rooms can be reserved <span class="hljs-keyword">in</span> advance through the OA <span class="hljs-keyword">system</span>, <span class="hljs-keyword">with</span> <span class="hljs-type">time</span> <span class="hljs-keyword">and</span> number <span class="hljs-keyword">of</span> participants specified.                         <span class="hljs-operator">|</span> <span class="hljs-number">0.29224032230852487</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+-----------------------------------------------------------------------------------------------------------------------------------------+---------------------+</span>
</code></pre>
<ol>
<li>寻找差异较小的内容（结合<code>L1_DISTANCE</code>）</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> 
    id, title, content,
    L1_DISTANCE(embedding, EMBED("Procurement application process")) <span class="hljs-keyword">AS</span> distance
<span class="hljs-keyword">FROM</span> knowledge_base
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> distance <span class="hljs-keyword">ASC</span>
LIMIT <span class="hljs-number">3</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+</span>
<span class="hljs-operator">|</span> id   <span class="hljs-operator">|</span> title                       <span class="hljs-operator">|</span> content                                                                                                                                        <span class="hljs-operator">|</span> distance           <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">5</span> <span class="hljs-operator">|</span> Procurement Request Process <span class="hljs-operator">|</span> Departments must fill <span class="hljs-keyword">out</span> a procurement request form <span class="hljs-keyword">for</span> purchasing items. If the amount exceeds $<span class="hljs-number">5000</span>, financial approval <span class="hljs-keyword">is</span> required.        <span class="hljs-operator">|</span>  <span class="hljs-number">18.66882028897362</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">4</span> <span class="hljs-operator">|</span> Meeting Room Reservation    <span class="hljs-operator">|</span> Meeting rooms can be reserved <span class="hljs-keyword">in</span> advance through the OA <span class="hljs-keyword">system</span>, <span class="hljs-keyword">with</span> <span class="hljs-type">time</span> <span class="hljs-keyword">and</span> number <span class="hljs-keyword">of</span> participants specified.                                <span class="hljs-operator">|</span>  <span class="hljs-number">30.90449328294426</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">2</span> <span class="hljs-operator">|</span> Leave Policy                <span class="hljs-operator">|</span> Employees must apply <span class="hljs-keyword">for</span> leave <span class="hljs-keyword">in</span> the <span class="hljs-keyword">system</span> <span class="hljs-keyword">in</span> advance. If the leave <span class="hljs-keyword">is</span> longer than three days, approval <span class="hljs-keyword">from</span> the direct manager <span class="hljs-keyword">is</span> required. <span class="hljs-operator">|</span> <span class="hljs-number">31.060405636536416</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+</span>
</code></pre>
<p><strong><code>EMBED</code> 的设计不仅是一个文本向量化工具，更是 Doris 向量分析生态的重要组成部分。</strong> 通过与其他向量函数（<code>COSINE_DISTANCE</code>， <code>L2_DISTANCE</code>， <code>INNER_PRODUCT</code>， <code>L1_DISTANCE</code> ）的无缝集成，<code>EMBED</code> 支持用户在 SQL 查询中完成从文本到向量，再到相似度计算或检索的一站式分析。</p>
<p><strong>示例 2：</strong></p>
<p>下表模拟简易的客服常见问题文档：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> support_docs (
    id <span class="hljs-type">BIGINT</span>,
    title STRING,
    content STRING,
    embedding <span class="hljs-keyword">ARRAY</span><span class="hljs-operator">&lt;</span><span class="hljs-type">FLOAT</span><span class="hljs-operator">&gt;</span> COMMENT <span class="hljs-string">'由 EMBED 函数生成的语义向量'</span>
) DUPLICATE KEY(id)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(id) BUCKETS <span class="hljs-number">1</span>
PROPERTIES ( "replication_num" <span class="hljs-operator">=</span> "1" );

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> support_docs (id, title, content, embedding) <span class="hljs-keyword">VALUES</span>
(<span class="hljs-number">1</span>, "系统登录问题排查",
    "当用户无法登录时，请先检查网络连接、浏览器缓存，并确认账号未被锁定。",
    EMBED("登录问题排查 网络异常 账号锁定")),
(<span class="hljs-number">2</span>, "数据备份与恢复指南",
    "客户可在管理后台手动备份数据，若误删可通过支持团队申请数据恢复。",
    EMBED("数据备份 恢复 操作指南")),
(<span class="hljs-number">3</span>, "账单与发票问题",
    "企业客户可在财务模块下载电子发票。如需纸质版，请提交申请工单。",
    EMBED("账单 发票 财务模块")),
(<span class="hljs-number">4</span>, "API 接口调用规范",
    "开发者在调用 API 时需携带正确的访问令牌，否则将返回身份验证错误。",
    EMBED("接口调用 认证错误 访问令牌")),
(<span class="hljs-number">5</span>, "服务中断应急流程",
    "若出现服务中断，技术团队需在30分钟内启动应急响应并发布公告。",
    EMBED("服务中断 应急响应 处理流程"));
</code></pre>
<p><strong>通过 <code>EMBED</code> 函数对文本的向量化操作，结合 Doris 支持的<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2Fdev%2Fsql-manual%2Fsql-functions%2Fai-functions%2Fdistance-functions%2Fcosine-distance" target="_blank" title="https://doris.apache.org/zh-CN/docs/dev/sql-manual/sql-functions/ai-functions/distance-functions/cosine-distance" ref="nofollow noopener noreferrer">向量函数</a>， 可对数据进行如下操作：</strong></p>
<ol>
<li>问答检索（结合 <code>COSINE_DISTANCE</code>）</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> 
    id, title, content,
    COSINE_DISTANCE(embedding, EMBED("登录不上系统怎么办？")) <span class="hljs-keyword">AS</span> score
<span class="hljs-keyword">FROM</span> support_docs
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> score <span class="hljs-keyword">ASC</span>
LIMIT <span class="hljs-number">2</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">------+--------------------------+--------------------------------------------------------------------------------------------------------+-----------+</span>
<span class="hljs-operator">|</span> id   <span class="hljs-operator">|</span> title                    <span class="hljs-operator">|</span> content                                                                                                <span class="hljs-operator">|</span> score     <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+--------------------------+--------------------------------------------------------------------------------------------------------+-----------+</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">1</span> <span class="hljs-operator">|</span> 系统登录问题排查         <span class="hljs-operator">|</span> 当用户无法登录时，请先检查网络连接、浏览器缓存，并确认账号未被锁定。                                   <span class="hljs-operator">|</span> <span class="hljs-number">0.3183002</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">4</span> <span class="hljs-operator">|</span> API 接口调用规范         <span class="hljs-operator">|</span> 开发者在调用 API 时需携带正确的访问令牌，否则将返回身份验证错误。                                      <span class="hljs-operator">|</span> <span class="hljs-number">0.5599254</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+--------------------------+--------------------------------------------------------------------------------------------------------+-----------+</span>
</code></pre>
<ol>
<li>问题分析匹配（结合 <code>L2_DISTANCE</code>）</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> 
    id, title, content,
    L2_DISTANCE(embedding, EMBED("接口调用时提示没有权限")) <span class="hljs-keyword">AS</span> distance
<span class="hljs-keyword">FROM</span> support_docs
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> distance <span class="hljs-keyword">ASC</span>
LIMIT <span class="hljs-number">2</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">------+--------------------------+--------------------------------------------------------------------------------------------------------+-----------+</span>
<span class="hljs-operator">|</span> id   <span class="hljs-operator">|</span> title                    <span class="hljs-operator">|</span> content                                                                                                <span class="hljs-operator">|</span> distance  <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+--------------------------+--------------------------------------------------------------------------------------------------------+-----------+</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">4</span> <span class="hljs-operator">|</span> API 接口调用规范         <span class="hljs-operator">|</span> 开发者在调用 API 时需携带正确的访问令牌，否则将返回身份验证错误。                                      <span class="hljs-operator">|</span> <span class="hljs-number">0.6471552</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">1</span> <span class="hljs-operator">|</span> 系统登录问题排查         <span class="hljs-operator">|</span> 当用户无法登录时，请先检查网络连接、浏览器缓存，并确认账号未被锁定。                                   <span class="hljs-operator">|</span> <span class="hljs-number">0.9831962</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+--------------------------+--------------------------------------------------------------------------------------------------------+-----------+</span>
</code></pre>
<ol>
<li>根据文章内容进行文本相关度匹配并推荐（结合<code>INNER PRODUCT</code>）</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> 
    id, title, content,
    INNER_PRODUCT(embedding, EMBED("账单 发票 报销流程")) <span class="hljs-keyword">AS</span> score
<span class="hljs-keyword">FROM</span> support_docs
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> score <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">2</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">------+--------------------------+-----------------------------------------------------------------------------------------------+-----------+</span>
<span class="hljs-operator">|</span> id   <span class="hljs-operator">|</span> title                    <span class="hljs-operator">|</span> content                                                                                       <span class="hljs-operator">|</span> score     <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+--------------------------+-----------------------------------------------------------------------------------------------+-----------+</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">3</span> <span class="hljs-operator">|</span> 账单与发票问题           <span class="hljs-operator">|</span> 企业客户可在财务模块下载电子发票。如需纸质版，请提交申请工单。                                <span class="hljs-operator">|</span> <span class="hljs-number">0.8098868</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">5</span> <span class="hljs-operator">|</span> 服务中断应急流程         <span class="hljs-operator">|</span> 若出现服务中断，技术团队需在<span class="hljs-number">30</span>分钟内启动应急响应并发布公告。                                  <span class="hljs-operator">|</span> <span class="hljs-number">0.3729638</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+--------------------------+-----------------------------------------------------------------------------------------------+-----------+</span>
</code></pre>
<ol>
<li>寻找差异较小的内容（结合<code>L1_DISTANCE</code>）</li>
</ol>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">SELECT</span> 
    id, title, content,
    L1_DISTANCE(embedding, EMBED("服务中断 处理 指南")) <span class="hljs-keyword">AS</span> distance
<span class="hljs-keyword">FROM</span> support_docs
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> distance <span class="hljs-keyword">ASC</span>
LIMIT <span class="hljs-number">3</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+--------------------------------------------------------------------------------------------------------+----------+</span>
<span class="hljs-operator">|</span> id   <span class="hljs-operator">|</span> title                       <span class="hljs-operator">|</span> content                                                                                                <span class="hljs-operator">|</span> distance <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+--------------------------------------------------------------------------------------------------------+----------+</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">5</span> <span class="hljs-operator">|</span> 服务中断应急流程            <span class="hljs-operator">|</span> 若出现服务中断，技术团队需在<span class="hljs-number">30</span>分钟内启动应急响应并发布公告。                                           <span class="hljs-operator">|</span> <span class="hljs-number">13.94832</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">2</span> <span class="hljs-operator">|</span> 数据备份与恢复指南          <span class="hljs-operator">|</span> 客户可在管理后台手动备份数据，若误删可通过支持团队申请数据恢复。                                       <span class="hljs-operator">|</span> <span class="hljs-number">24.65827</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>    <span class="hljs-number">1</span> <span class="hljs-operator">|</span> 系统登录问题排查            <span class="hljs-operator">|</span> 当用户无法登录时，请先检查网络连接、浏览器缓存，并确认账号未被锁定。                                   <span class="hljs-operator">|</span>  <span class="hljs-number">24.9747</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------+-----------------------------+--------------------------------------------------------------------------------------------------------+----------+</span>
</code></pre>
<h3 data-id="heading-5">02 灵活的向量维度控制</h3>
<p>通过 Doris 内置的 <code>RESOURCE</code> 机制，用户在配置 AI  Resource 时，可以设置 <code>ai.dimensions</code> 参数来精确指定生成向量的维度。用户可以根据具体的业务场景和性能考量，选择生成高维向量以保留更丰富的语义信息，或选择低维向量以节约存储空间和加速计算。这种灵活性使得 <code>EMBED</code> 函数能够更好地适应从轻量级语义匹配到高精度向量检索等多样化的分析需求，让用户在成本与效果之间找到最佳平衡。</p>
<blockquote>
<p><strong>注意</strong>：在使用 <code>dimensions</code> 参数时，请务必确认 <code>RESOURCE</code> 中配置的模型支持您所指定的维度，否则可能导致请求错误。此外，Doris 内部对部分不支持维度定制的模型（例如 OpenAI 的 <code>text-embedding-ada-002</code>）做了限制。对于这些模型，即使在 <code>RESOURCE</code> 中设置了 <code>dimensions</code> 参数，该设置也将被忽略，函数将返回模型默认的维度。</p>
</blockquote>
<h2 data-id="heading-6">总结与展望</h2>
<p>借助<code>AI_AGG</code> 与 <code>EMBED</code> 函数，Apache Doris 拥有了了强大的智能分析能力，极大地拓展了数据分析与智能应用的边界。<code>AI_AGG</code> 通过其动态预聚合机制，将非结构化文本的智能聚合分析带入数据库，轻松应对海量用户评论、日志分析等场景。而 <code>EMBED</code> 函数则与 Doris 的向量函数无缝集成，提供从文本到语义向量、再到相似度检索的一站式解决方案，极大简化了问答系统、内容推荐等应用的开发。这些功能使得 SQL 语言本身具备了驾驭 AI 模型的能力，让每一位数据分析师都能以低成本、高效率的方式，挖掘数据中更深层次的语义价值。</p>
<p>展望未来，Doris 将继续深化 AI 与数据库的融合。我们将致力于优化模型调度与计算性能，并探索更多如多模态数据分析、AI Agent 交互等前沿功能，持续降低 AI 技术的使用门槛，让数据驱动的智能决策无处不在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习React-DnD：实现多任务项拖拽-useDrop处理]]></title>    <link>https://juejin.cn/post/7574041466710671403</link>    <guid>https://juejin.cn/post/7574041466710671403</guid>    <pubDate>2025-11-19T07:45:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574041466710671403" data-draft-id="7574084898878259241" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习React-DnD：实现多任务项拖拽-useDrop处理"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-11-19T07:45:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Wect"/> <meta itemprop="url" content="https://juejin.cn/user/4185164878720068"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习React-DnD：实现多任务项拖拽-useDrop处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4185164878720068/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Wect
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T07:45:05.000Z" title="Wed Nov 19 2025 07:45:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一篇技术分享中，我们聚焦于useDrag钩子实现Todo任务项的拖动触发逻辑，完成了任务的选中与拖拽启动功能。而拖拽交互的闭环，必然离不开放置接收环节——当用户将任务拖拽到目标位置时，如何精准判断拖动类型（单个/多个）并执行对应的排序逻辑，才是确保交互流畅性的核心。本文将详细拆解这一环节的实现思路，重点解析批量排序操作的设计与hover事件的逻辑处理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f18f7ec5723048b3ad3a87c33279a42f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2VjdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764143316&amp;x-signature=6DLmE4mu32QDvn3kn0l%2F%2F2LB7HE%3D" alt="SelectTodosDrop.gif" loading="lazy"/></p>
<h2 data-id="heading-0">核心问题：区分拖动类型，匹配差异化逻辑</h2>
<p>任务拖拽的放置接收环节，首要解决的问题是“识别当前拖动场景”。当用户拖拽任务时，存在两种典型场景：单个任务独立拖动、多个已选中任务批量拖动。这两种场景的排序逻辑存在本质差异：单个任务只需处理“源位置”与“目标位置”的双向交换；而批量任务则需要先提取所有选中项，再整体插入目标位置，同时保持选中项内部的相对顺序。</p>
<p>针对这一差异，我们的技术方案分为两步：一是新增批量排序的Context操作类型，专门处理多任务排序逻辑；二是在useDrop的hover事件中添加类型判断，根据是否为批量拖动执行对应逻辑。</p>
<h2 data-id="heading-1">第一步：实现批量排序操作BATCH_REORDER_TODOS</h2>
<p>单个任务排序可通过简单的数组元素交换实现，但批量排序需要处理“选中项提取-目标位置计算-选中项插入”三个核心步骤。为此，我们新增<code>BATCH_REORDER_TODOS</code>操作类型，封装完整的批量排序逻辑。</p>
<h3 data-id="heading-2">1.1 核心设计思路</h3>
<p>批量排序的核心需求是：将所有选中的任务作为一个整体，移动到目标位置，并保持选中项在原始数组中的相对顺序。具体思路如下：</p>
<ul>
<li>边界校验：排除“无选中任务”“目标位置越界”等无效场景；</li>
<li>选中项排序：确保选中任务的顺序与原始数组一致，避免排序混乱；</li>
<li>分离数组：将原始任务数组拆分为“选中任务”和“非选中任务”两个集合；</li>
<li>目标位置校准：计算选中任务在非选中数组中的实际插入位置；</li>
<li>数组重组：将选中任务整体插入目标位置，形成新的任务数组。</li>
</ul>
<h3 data-id="heading-3">1.2 完整代码实现与解析</h3>
<p>以下是<code>BATCH_REORDER_TODOS</code>在Context reducer中的实现代码，关键步骤已添加详细注释：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">case</span> <span class="hljs-title class_">ActionTypes</span>.<span class="hljs-property">BATCH_REORDER_TODOS</span>:
  {
    <span class="hljs-comment">// 从action中获取目标位置索引和移动方向</span>
    <span class="hljs-keyword">const</span> { destinationIndex, direction } = action.<span class="hljs-property">payload</span>;

    <span class="hljs-comment">// 边界条件检查：无选中任务/目标位置越界则返回原状态</span>
    <span class="hljs-keyword">if</span> (!state.<span class="hljs-property">selectedTodos</span>.<span class="hljs-property">length</span> || destinationIndex &lt; <span class="hljs-number">0</span> || destinationIndex &gt;= state.<span class="hljs-property">todos</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> state;
    }

    <span class="hljs-comment">// 复制原始任务数组，避免直接修改state</span>
    <span class="hljs-keyword">let</span> newTodos = [...state.<span class="hljs-property">todos</span>];

    <span class="hljs-comment">// 关键：按选中任务在原始数组中的顺序重新排序</span>
    <span class="hljs-comment">// 通过findIndex匹配id，确保排序与原始位置一致</span>
    <span class="hljs-keyword">let</span> tempSelectedTodos = [...state.<span class="hljs-property">selectedTodos</span>].<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> newTodos.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> === a.<span class="hljs-property">id</span>) - newTodos.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> === b.<span class="hljs-property">id</span>);
    });

    <span class="hljs-comment">// 创建选中任务ID集合，用于快速过滤非选中任务</span>
    <span class="hljs-keyword">const</span> selectedTodoIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(tempSelectedTodos.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span>));

    <span class="hljs-comment">// 从原始数组中移除所有选中任务，得到非选中任务数组</span>
    <span class="hljs-keyword">const</span> nonSelectedTodos = newTodos.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> !selectedTodoIds.<span class="hljs-title function_">has</span>(todo.<span class="hljs-property">id</span>));

    <span class="hljs-comment">// 计算选中任务在非选中数组中的实际插入位置</span>
    <span class="hljs-comment">// 原理：通过目标位置的任务ID，找到其在非选中数组中的索引</span>
    <span class="hljs-keyword">let</span> actualDestinationIndex = nonSelectedTodos.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> todo.<span class="hljs-property">id</span> === state.<span class="hljs-property">todos</span>[destinationIndex].<span class="hljs-property">id</span>);

    <span class="hljs-comment">// 确保目标位置不超出非选中数组范围</span>
    actualDestinationIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(actualDestinationIndex, nonSelectedTodos.<span class="hljs-property">length</span>);

    <span class="hljs-comment">// 根据移动方向微调目标位置：UP表示向上移动，需将插入位置后移一位</span>
    <span class="hljs-keyword">if</span>(direction === <span class="hljs-string">'UP'</span>){
      actualDestinationIndex++;
    }

    <span class="hljs-comment">// 重组数组：将选中任务整体插入目标位置</span>
    <span class="hljs-keyword">const</span> resultTodos = [
      ...nonSelectedTodos.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, actualDestinationIndex), <span class="hljs-comment">// 目标位置前的非选中任务</span>
      ...tempSelectedTodos, <span class="hljs-comment">// 选中任务整体插入</span>
      ...nonSelectedTodos.<span class="hljs-title function_">slice</span>(actualDestinationIndex) <span class="hljs-comment">// 目标位置后的非选中任务</span>
    ];

    <span class="hljs-comment">// 返回新状态，保持选中状态方便用户继续操作</span>
    <span class="hljs-keyword">return</span> {
      ...state,
      <span class="hljs-attr">todos</span>: resultTodos,
      <span class="hljs-attr">selectedTodos</span>: [...state.<span class="hljs-property">selectedTodos</span>],
    }
  }
</code></pre>
<h3 data-id="heading-4">1.3 配套Action创建函数</h3>
<p>为了在组件中调用批量排序逻辑，我们需要创建对应的action创建函数，将目标位置和移动方向作为参数传递：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 批量重新排序任务的action创建函数</span>
<span class="hljs-attr">batchReorderTodos</span>: <span class="hljs-function">(<span class="hljs-params">destinationIndex, direction</span>) =&gt;</span> {
  <span class="hljs-title function_">dispatch</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">ActionTypes</span>.<span class="hljs-property">BATCH_REORDER_TODOS</span>,
    <span class="hljs-attr">payload</span>: { destinationIndex, direction },
  });
},
</code></pre>
<h2 data-id="heading-5">第二步：优化useDrop的hover事件，区分拖动类型</h2>
<p>useDrop钩子的hover事件是处理“放置接收”的关键——当拖拽的任务悬停在目标任务上时，需要实时计算位置并触发排序。我们在此处添加“是否为批量拖动”的判断，分别执行单个和批量排序逻辑。</p>
<h3 data-id="heading-6">2.1 核心交互逻辑</h3>
<p>hover事件的核心需求是“精准判断插入位置”：</p>
<ul>
<li>批量拖动时：根据鼠标在目标任务上的垂直位置（上半部分/下半部分），确定整体插入方向（上方/下方）；</li>
<li>单个拖动时：直接匹配源任务与目标任务的位置，执行交换排序。</li>
</ul>
<p>同时需要避免“自我交换”问题——当拖拽的任务与目标任务为同一任务（单个拖动），或目标任务属于选中任务集合（批量拖动）时，不执行任何操作。</p>
<h3 data-id="heading-7">2.2 完整hover事件代码实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">hover</span>: <span class="hljs-function">(<span class="hljs-params">item, monitor</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (item.<span class="hljs-property">selected</span>) {
    <span class="hljs-comment">// 场景一：批量拖拽逻辑</span>
    <span class="hljs-comment">// 避免将选中任务拖到自身集合内</span>
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">selectedTodos</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">selectedTodo</span> =&gt;</span> selectedTodo.<span class="hljs-property">id</span> === todo.<span class="hljs-property">id</span>)) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 获取目标任务在原始数组中的索引</span>
    <span class="hljs-keyword">const</span> destinationIndex = todos.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">oneTodo</span> =&gt;</span> oneTodo.<span class="hljs-property">id</span> === todo.<span class="hljs-property">id</span>);

    <span class="hljs-comment">// 计算鼠标在目标任务元素上的垂直偏移量</span>
    <span class="hljs-comment">// monitor.getClientOffset().y：鼠标在视口中的Y坐标</span>
    <span class="hljs-comment">// divRef.current.getBoundingClientRect().top：目标元素顶部在视口中的Y坐标</span>
    <span class="hljs-keyword">const</span> hoverOffset = monitor.<span class="hljs-title function_">getClientOffset</span>().<span class="hljs-property">y</span> - divRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">top</span>;
    <span class="hljs-comment">// 目标元素的半高，作为判断插入方向的阈值</span>
    <span class="hljs-keyword">const</span> halfHeight = divRef.<span class="hljs-property">current</span>.<span class="hljs-property">offsetHeight</span> / <span class="hljs-number">2</span>;

    <span class="hljs-keyword">if</span> (hoverOffset &gt; halfHeight) {
      <span class="hljs-comment">// 鼠标在目标元素下半部分：将选中任务插入到目标元素下方</span>
      <span class="hljs-title function_">batchReorderTodos</span>(destinationIndex, <span class="hljs-string">'UP'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 鼠标在目标元素上半部分：将选中任务插入到目标元素上方</span>
      <span class="hljs-title function_">batchReorderTodos</span>(destinationIndex, <span class="hljs-string">'DOWN'</span>);
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 场景二：单个拖拽逻辑</span>
    <span class="hljs-comment">// 避免任务自我交换</span>
    <span class="hljs-keyword">if</span> (item.<span class="hljs-property">id</span> === todo.<span class="hljs-property">id</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 关键：通过ID获取实时索引，而非依赖初始索引（避免快速拖拽导致的索引混乱）</span>
    <span class="hljs-keyword">const</span> sourceIndex = todos.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">oneTodo</span> =&gt;</span> oneTodo.<span class="hljs-property">id</span> === item.<span class="hljs-property">id</span>);
    <span class="hljs-keyword">const</span> destinationIndex = todos.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">oneTodo</span> =&gt;</span> oneTodo.<span class="hljs-property">id</span> === todo.<span class="hljs-property">id</span>);

    <span class="hljs-comment">// 执行单个任务排序</span>
    <span class="hljs-title function_">reorderTodos</span>(sourceIndex, destinationIndex);
  }
},
</code></pre>
<h3 data-id="heading-8">2.3 关键技术点解析</h3>
<p>上述代码中，有两个极易踩坑的技术点需要重点关注：</p>
<ol>
<li><strong>索引获取方式</strong>：放弃“依赖初始索引”的方式，改用<code>findIndex</code>通过任务ID获取实时索引。这是因为快速拖拽过程中，任务数组顺序会动态变化，初始索引会失效，而ID作为唯一标识能确保索引精准。</li>
<li><strong>批量拖动的位置判断</strong>：通过“鼠标垂直偏移量+元素半高”的组合，实现“hover上半部分插上方，hover下半部分插下方”的自然交互。这种设计符合用户直觉，避免了“拖拽到任务边缘时位置判断模糊”的问题。</li>
</ol>
<h2 data-id="heading-9">功能闭环：从拖动到放置的交互优化</h2>
<p>通过新增批量排序操作和优化hover事件逻辑，我们完成了Todo任务拖拽的完整功能闭环。实际使用中，用户可通过以下流程完成拖拽操作：</p>
<ol>
<li>单个任务拖拽：直接拖动目标任务，悬停到目标位置即可完成排序；</li>
<li>批量任务拖拽：先选中多个任务（可通过Ctrl/Shift键辅助），拖动任意选中任务，整体悬停到目标位置，根据鼠标位置完成批量插入。</li>
</ol>
<p>这种实现方式既保证了操作的灵活性，又通过边界校验（如越界判断、自我交换排除）确保了功能的稳定性。下图为批量拖拽的实际效果演示：</p>
<h2 data-id="heading-10">总结</h2>
<p>本文通过“批量排序操作封装+hover事件类型区分”的技术方案，解决了Todo任务拖拽中“放置接收”的核心问题。核心亮点在于：</p>
<ul>
<li>用ID作为索引匹配的唯一标识，避免了动态排序中的索引混乱问题；</li>
<li>批量排序时保持选中项的原始顺序，符合用户操作预期；</li>
<li>基于鼠标位置的精细判断，提升了拖拽交互的流畅性。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里云可观测 2025 年 10 月产品动态]]></title>    <link>https://juejin.cn/post/7574245788948496399</link>    <guid>https://juejin.cn/post/7574245788948496399</guid>    <pubDate>2025-11-19T08:32:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245788948496399" data-draft-id="7573989365615329280" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里云可观测 2025 年 10 月产品动态"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-11-19T08:32:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里云可观测 2025 年 10 月产品动态
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T08:32:50.000Z" title="Wed Nov 19 2025 08:32:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">本月可观测热文回顾</h2>
<p><strong>文章一览：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578952%26idx%3D1%26sn%3Dd37f4a402cafc39fdbb95d7c95a3b913%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578952&amp;idx=1&amp;sn=d37f4a402cafc39fdbb95d7c95a3b913&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">用户说“App 卡死了”，你却查不到原因？可能是监控方式错了</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578905%26idx%3D1%26sn%3D0681660bf43f99bb015af41511b74440%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578905&amp;idx=1&amp;sn=0681660bf43f99bb015af41511b74440&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">清理祖传 AK 不怕炸锅：基于 UModel 的云监控 2.0 身份凭证观测实践</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578779%26idx%3D2%26sn%3De71a751b24edf463a7b8f7514f4249a3%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578779&amp;idx=2&amp;sn=e71a751b24edf463a7b8f7514f4249a3&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">告别手动埋点！Android 无侵入式数据采集方案深度解析</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578672%26idx%3D1%26sn%3Da5894d77679325b085e257b1143f4bfc%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578672&amp;idx=1&amp;sn=a5894d77679325b085e257b1143f4bfc&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">从数据孤岛到智能洞察：构建面向未来的 Operation intelligence 体系</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578672%26idx%3D2%26sn%3D0b4184ef524dd80f78630ccd5d66d258%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578672&amp;idx=2&amp;sn=0b4184ef524dd80f78630ccd5d66d258&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">从“天书”到源码：HarmonyOS NEXT 崩溃堆栈解析实战指南</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578606%26idx%3D2%26sn%3Dd2f5f7e216c2055533dc164beba3f6be%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578606&amp;idx=2&amp;sn=d2f5f7e216c2055533dc164beba3f6be&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">阿里云加持，《泡姆泡姆》让全球玩家畅享零延迟冒险</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578603%26idx%3D1%26sn%3D32042269250cb2a8cc475a789e0b24ba%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578603&amp;idx=1&amp;sn=32042269250cb2a8cc475a789e0b24ba&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">16 倍性能提升，成本降低 98%！ 解读 SLS 向量索引架构升级改造</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578445%26idx%3D1%26sn%3D6b2b1fff767580b31412319163cbc0fd%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578445&amp;idx=1&amp;sn=6b2b1fff767580b31412319163cbc0fd&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">移动端性能监控探索：iOS RUM SDK 技术架构与实践</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwODY2NTk0OQ%3D%3D%26mid%3D2247485489%26idx%3D1%26sn%3D1b44928dab36242369be1f238429c279%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwODY2NTk0OQ==&amp;mid=2247485489&amp;idx=1&amp;sn=1b44928dab36242369be1f238429c279&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">云栖实录：重构可观测 - 打造大模型驱动的云监控 2.0 与 AIOps 新范式</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwODY2NTk0OQ%3D%3D%26mid%3D2247485489%26idx%3D3%26sn%3D155788294b7b280405c852d2b216bf97%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwODY2NTk0OQ==&amp;mid=2247485489&amp;idx=3&amp;sn=155788294b7b280405c852d2b216bf97&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">移动端性能监控探索：可观测 Android 采集探针架构与实现</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578325%26idx%3D1%26sn%3D3453c36c2f865111aa5fdcfda575bb19%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578325&amp;idx=1&amp;sn=3453c36c2f865111aa5fdcfda575bb19&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">零代码改造 + 全链路追踪！Spring AI 最新可观测性详细解读</a></p>
<h2 data-id="heading-1">功能快报</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1e98e29d3554e01be4ab83e5120f22d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764145970&amp;x-signature=3j6k%2BRJxmSFbtiA%2B%2B9d0bRfE7sA%3D" alt="image.png" loading="lazy"/></p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Farms" target="_blank" title="https://www.aliyun.com/product/arms" ref="nofollow noopener noreferrer">此处</a>，了解更多产品详情。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何训练你的大语言模型：使用 Unsloth 进行低秩适配微调！]]></title>    <link>https://juejin.cn/post/7574253222606094377</link>    <guid>https://juejin.cn/post/7574253222606094377</guid>    <pubDate>2025-11-19T08:41:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574253222606094377" data-draft-id="7574041466710818859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何训练你的大语言模型：使用 Unsloth 进行低秩适配微调！"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-19T08:41:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何训练你的大语言模型：使用 Unsloth 进行低秩适配微调！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T08:41:34.000Z" title="Wed Nov 19 2025 08:41:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>大语言模型（LLM）微调就像训练一条龙。图片由ChatGPT根据作者提示生成 训练大语言模型的体验，很像在《驯龙高手》里教“无牙”（Toothless）飞行：“无牙”无疑是条强大的龙，但它少了一只尾翼；同理，基础大语言模型看似功能强大，但若未经训练、无法获取你的领域知识，就容易出现“幻觉”（生成虚假信息），给出不可靠的回复。</p>
<p>我们的期望是什么？希望通过少量微调，让模型学习你的数据——最终在需要时能“精准咬合”（输出符合需求的结果）。</p>
<p>在本文中，我将一步步拆解微调流程：从数据集准备到训练执行，并分享实际操作中的结果。剧透一下：第一次尝试并没有“喷火”般的惊艳效果，但这正是实验最有意思的地方。</p>
<p>所有代码均可在我的GitHub仓库中获取。</p>
<h2 data-id="heading-0">一、先聊聊大语言模型微调</h2>
<p>这部分内容至关重要，在写一行代码之前，我们先来深入探讨一下。</p>
<p>大语言模型的微调，和其他AI模型的微调截然不同。因为大语言模型在规模和能力上都独树一帜：它们通过海量文本语料训练，能够形成对语言的理解能力。</p>
<h3 data-id="heading-1">1. 大语言模型的“理解能力”</h3>
<p>随便问ChatGPT西兰花的健康益处，你都会为之惊叹——它的回答不仅快速、准确，还带有惊人的细节丰富度。</p>
<p>大语言模型的能力甚至可以延伸到“推理”：尤其当它们在包含“思维链”（Chain-of-Thought, CoT）推理的数据集上训练时，推理能力会更突出。如今，大多数主流大语言模型都融入了这类复杂的训练机制。</p>
<p>不过，大语言模型微调仍是一个存在争议的话题，学术论文中支持与反对的观点并存。一些研究警告，微调可能导致“灾难性遗忘”（模型忘记原有知识）、安全护栏弱化、幻觉风险增加以及隐私问题；更令人担忧的是，在教模型学习特定领域知识时，可能会无意间让它丧失推理能力。尽管有研究提出了缓解这些问题的技术，但持续的争议表明，解决方案并非那么简单。</p>
<h3 data-id="heading-2">2. 微调的核心突破：参数高效微调（PEFT）</h3>
<p>大语言模型微调领域的一项重大突破，是“参数高效微调”（Parameter-Efficient Fine-Tuning, PEFT）。这是一种足以让人拍案叫绝的“跨时代思路”，如今已被快速纳入开源框架，用于生产环境。</p>
<p>大语言模型的规模正在飞速增长。例如，Meta的Llama 4 Behemoth模型据称拥有2万亿个参数，极少有机构能拥有重训这类超大模型的计算资源。此外，为每个下游任务单独存储和部署微调模型的成本极高——因为每个微调模型的规模几乎与原始模型相当。</p>
<p>PEFT的目标就是解决这两个核心问题：参数负担与部署成本，同时也能在一定程度上缓解前文提到的风险（尽管争议表明效果参差不齐）。PEFT技术仅对少量新增参数进行微调，而将预训练模型的大部分参数“冻结”（不更新），这大大降低了计算和存储需求。</p>
<h3 data-id="heading-3">3. 低秩适配（LoRA）登场</h3>
<p>在各类PEFT方法中，“低秩适配”（Low-Rank Adaptation, LoRA）是目前应用最广泛的一种。它不更新模型的所有权重，而是冻结预训练模型的参数，通过注入可训练的低秩矩阵，实现任务特定的学习。</p>
<p>LoRA的工作原理如下：</p>
<ul>
<li> <strong>确定目标层</strong>：LoRA通常应用于线性层（例如Transformer注意力机制中的查询层、键层、值层和输出投影层）；</li>
<li> <strong>添加低秩矩阵</strong>：对于每个冻结的目标权重矩阵W₀，LoRA引入两个更小的矩阵A和B，使得它们的乘积BA具有较低的秩r（r远小于W₀的维度）；</li>
<li> <strong>训练低秩矩阵</strong>：微调过程中，仅更新矩阵A和B的参数，原始权重W₀保持不变，最终的有效权重矩阵为W = W₀ + BA；</li>
<li> <strong>推理时可选合并矩阵</strong>：训练完成后，可将低秩矩阵BA合并回原始权重矩阵W₀，形成新的权重矩阵W。这意味着，推理时的计算量与全量微调模型完全一致，无需额外开销。</li>
</ul>
<h3 data-id="heading-4">4. LoRA会影响大语言模型的激活值吗？</h3>
<p>答案是肯定的。低秩矩阵A和B用于计算原始权重矩阵的更新量（BA）；当输入经过LoRA适配层时，输出结果（以及后续的激活值）会与未适配的原始模型产生差异。</p>
<p>本质上，LoRA通过注入可训练的低秩矩阵，修改了大语言模型的有效权重。这些修改后的权重会在推理时产生新的激活模式——且这种模式是针对特定任务定制的，同时还能保持较低的计算和内存成本。这是一种实用、精妙的优化手段，正在重塑大语言模型的实际应用方式。</p>
<h3 data-id="heading-5">5. 要不要微调？关键看模型规模</h3>
<p>在我看来，微调的收益在“小型大语言模型”上体现得最明显。这类模型通常通过“知识蒸馏”从更大规模的“兄弟模型”中学习：尽管能继承基础的语言理解能力，但深度和广度往往不及大型模型。</p>
<p>但这一点反而可能成为优势。实证研究表明，小型大语言模型的“灾难性遗忘”现象更轻微——微调时覆盖原有预训练知识的风险更低。作为回报，你只需付出远低于大型模型的训练、部署和推理成本，就能获得模型的“领域特定能力”。</p>
<p>那么，“小型”具体指多大？在本文中，我们将微调Llama 3.2 10亿参数模型（Llama 3.2 1bn）——它是目前主流大语言模型中，规模较小但能力足够的代表之一。</p>
<h2 data-id="heading-6">二、步骤1：构建训练集与测试集</h2>
<p>关于大语言模型微调，有一个常见误区：“训练数据永远不够”。但事实并非如此——因为你完全可以用另一个大语言模型来生成训练数据！</p>
<p>首先，我们来搭建 notebook 环境：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ./notebooks/training_dataset_gen.ipynb  </span>
  
<span class="hljs-keyword">import</span> nest_asyncio  
nest_asyncio.apply()  
  
<span class="hljs-keyword">from</span> llama_index.core <span class="hljs-keyword">import</span> SimpleDirectoryReader  
<span class="hljs-keyword">from</span> llama_index.core.llama_dataset.generator <span class="hljs-keyword">import</span> RagDatasetGenerator  
<span class="hljs-keyword">from</span> llama_index.llms.ollama <span class="hljs-keyword">import</span> Ollama  
  
<span class="hljs-comment"># 创建数据目录并下载示例文档（关于“非传统资质”的论文）  </span>
!mkdir  -p ../data  
!wget <span class="hljs-string">"https://arxiv.org/pdf/2405.00247.pdf"</span> -O <span class="hljs-string">"../data/non_traditional_credentials.pdf"</span>  
  
<span class="hljs-comment"># 加载文档  </span>
docs = SimpleDirectoryReader(<span class="hljs-string">"../data/"</span>).load_data(show_progress=<span class="hljs-literal">True</span>)
</code></pre>
<p>我们将使用LlamaIndex的<code>RagDatasetGenerator</code>工具来构建数据集，具体代码如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ./notebooks/training_dataset_gen.ipynb  </span>
  
<span class="hljs-attr">data_gen</span> = RagDatasetGenerator.from_documents(  
    docs,  
    <span class="hljs-attr">llm</span>=Ollama(<span class="hljs-string">"qwen2.5"</span>),  <span class="hljs-comment"># 使用Qwen 2.5模型生成数据  </span>
    <span class="hljs-comment"># 生成指令：模拟教师/教授，基于文档上下文生成1个问题及对应答案  </span>
    <span class="hljs-attr">question_gen_query</span>=<span class="hljs-string">"You are a teacher/professor. Using the provided context, formulate a single question and its answer"</span>,  
    <span class="hljs-attr">num_questions_per_chunk</span>=<span class="hljs-number">10</span>  <span class="hljs-comment"># 每个文档片段生成10个问题  </span>
)  
<span class="hljs-comment"># 从文档节点生成问答数据集  </span>
<span class="hljs-attr">qa_dataset</span> = data_gen.generate_dataset_from_nodes()
</code></pre>
<p>💡 <strong>实用技巧</strong>：生成问答对时，以及评估待微调的小型模型性能时，一定要用更强大（规模更大）的大语言模型。如果这个“强模型”对小型模型的输出满意，就说明你成功打造了一个“小而强”的紧凑模型。</p>
<p>为了避免API调用次数限制和降低成本，我选择使用本地部署的Qwen 2.5 7B模型生成训练数据——它的能力足以支撑数据生成，且无需承担调用云端API的额外开销。</p>
<p>接下来，我们将数据集划分为训练集和保留集（用于后续评估），并将保留集导出为CSV文件：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ./notebooks/training_dataset_gen.ipynb  </span>
  
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split  
<span class="hljs-keyword">from</span> llama_index.core.llama_dataset <span class="hljs-keyword">import</span> LabelledRagDataset  
<span class="hljs-keyword">import</span> json  
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd  
  
<span class="hljs-comment"># 提取所有示例  </span>
all_examples = qa_dataset.examples  
<span class="hljs-comment"># 按8:2比例划分训练集和测试集（随机种子确保可复现）  </span>
train_examples, test_examples = train_test_split(  
    all_examples,  
    test_size=<span class="hljs-number">0.2</span>,          <span class="hljs-comment"># 20%数据作为保留集  </span>
    random_state=<span class="hljs-number">42</span>,        <span class="hljs-comment"># 随机种子，保证结果可复现  </span>
    shuffle=<span class="hljs-literal">True</span>  
)  
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"训练集样本数：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(train_examples)}</span>，测试集样本数：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(test_examples)}</span>"</span>)  
  
<span class="hljs-comment"># 构建带标签的RAG数据集  </span>
training_dataset = LabelledRagDataset(examples=train_examples)  
holdout_dataset = LabelledRagDataset(examples=test_examples)  
  
<span class="hljs-comment"># 将保留集转换为DataFrame并导出为CSV  </span>
records = []  
<span class="hljs-keyword">for</span> ex <span class="hljs-keyword">in</span> holdout_dataset.examples:  
    records.append({  
        <span class="hljs-string">"query"</span>: ex.query,  
        <span class="hljs-comment"># 对参考上下文列表进行JSON编码  </span>
        <span class="hljs-string">"reference_contexts"</span>: json.dumps(ex.reference_contexts),  
        <span class="hljs-string">"reference_answer"</span>: ex.reference_answer,  
        <span class="hljs-comment"># 对CreatedBy对象进行JSON编码  </span>
        <span class="hljs-string">"query_by"</span>: ex.query_by.model_dump_json(),  
        <span class="hljs-string">"reference_answer_by"</span>: ex.reference_answer_by.model_dump_json(),  
    })  
  
df = pd.DataFrame.from_records(records)  
df.to_csv(<span class="hljs-string">"holdout_dataset.csv"</span>, index=<span class="hljs-literal">False</span>)  
  
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"训练集样本数：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(train_examples)}</span>，测试集样本数：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(test_examples)}</span>"</span>)
</code></pre>
<p>最后，我们将训练集序列化为训练所需的JSONL格式：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ./notebooks/training_dataset_gen.ipynb  </span>
  
<span class="hljs-keyword">def</span> <span class="hljs-title function_">serialize_to_jsonl</span>(<span class="hljs-params">examples, out_path=<span class="hljs-string">"train.jsonl"</span></span>):  
    <span class="hljs-string">"""  
    将带标签的RAG数据示例序列化为JSONL格式  
    参数：  
        examples: LabelledRagDataExample列表，每个示例包含.query和.reference_answer字段  
        out_path: JSONL文件的输出路径  
    """</span>  
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">strip_prefix</span>(<span class="hljs-params">text</span>):  
        <span class="hljs-comment"># 移除文本开头的"**Question:**"或"**Answer:**"前缀（若存在）  </span>
        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> (<span class="hljs-string">"**Question:**"</span>, <span class="hljs-string">"**Answer:**"</span>):  
            <span class="hljs-keyword">if</span> text.strip().startswith(p):  
                <span class="hljs-keyword">return</span> text.strip()[<span class="hljs-built_in">len</span>(p):].strip()  
        <span class="hljs-keyword">return</span> text  
  
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(out_path, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf8"</span>) <span class="hljs-keyword">as</span> f:  
        <span class="hljs-keyword">for</span> ex <span class="hljs-keyword">in</span> examples:  
            q_raw = ex.query <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>  
            a_raw = <span class="hljs-built_in">getattr</span>(ex, <span class="hljs-string">"reference_answer"</span>, <span class="hljs-literal">None</span>)  
            <span class="hljs-comment"># 仅序列化包含"Question"前缀且有答案的示例  </span>
            <span class="hljs-keyword">if</span> q_raw.lower().startswith(<span class="hljs-string">"**question"</span>) <span class="hljs-keyword">and</span> a_raw:  
                q = strip_prefix(q_raw)  
                a = a_raw.strip()  
                <span class="hljs-comment"># 构建符合格式的消息对象  </span>
                obj = {  
                    <span class="hljs-string">"messages"</span>: [  
                        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,      <span class="hljs-string">"content"</span>: q},  
                        {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: a}  
                    ]  
                }  
                f.write(json.dumps(obj, ensure_ascii=<span class="hljs-literal">False</span>) + <span class="hljs-string">"\n"</span>)  
  
<span class="hljs-comment"># 序列化训练集  </span>
serialize_to_jsonl(train_examples)
</code></pre>
<p>大功告成！我们的训练集已经准备好了。</p>
<h2 data-id="heading-7">三、步骤2：先评估“未微调”的基础模型性能</h2>
<p>在开始微调前，必须先评估基础模型的“原生性能”——这是重要的基准。我们将使用之前保存的保留集，进行一次简单的“检索增强生成”（RAG）评估。</p>
<h3 data-id="heading-8">1. 加载保留集（从CSV文件）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ./notebooks/training_dataset_gen.ipynb  </span>
  
<span class="hljs-keyword">from</span> llama_index.core.llama_dataset <span class="hljs-keyword">import</span> (  
    LabelledRagDataset,  
    LabelledRagDataExample,  
    CreatedBy,  
)  
  
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_rag_dataset_from_csv</span>(<span class="hljs-params">csv_path: <span class="hljs-built_in">str</span></span>):  
    <span class="hljs-string">"""从CSV文件加载带标签的RAG数据集"""</span>  
    <span class="hljs-comment"># 定义CSV列的转换器（处理JSON格式数据）  </span>
    converters = {  
        <span class="hljs-string">"reference_contexts"</span>:    <span class="hljs-keyword">lambda</span> s: json.loads(s),  
        <span class="hljs-string">"query_by"</span>:             <span class="hljs-keyword">lambda</span> s: CreatedBy.model_validate_json(s),  
        <span class="hljs-string">"reference_answer_by"</span>:  <span class="hljs-keyword">lambda</span> s: CreatedBy.model_validate_json(s),  
    }  
    <span class="hljs-comment"># 读取CSV文件  </span>
    df = pd.read_csv(csv_path, converters=converters)  
    examples = []  
    <span class="hljs-keyword">for</span> _, row <span class="hljs-keyword">in</span> df.iterrows():  
        <span class="hljs-comment"># 构建LabelledRagDataExample对象  </span>
        examples.append(  
            LabelledRagDataExample(  
                query=row[<span class="hljs-string">"query"</span>],  
                query_by=row[<span class="hljs-string">"query_by"</span>],                      <span class="hljs-comment"># 转换为CreatedBy对象  </span>
                reference_contexts=row[<span class="hljs-string">"reference_contexts"</span>],   <span class="hljs-comment"># 转换为字符串列表  </span>
                reference_answer=row[<span class="hljs-string">"reference_answer"</span>],  
                reference_answer_by=row[<span class="hljs-string">"reference_answer_by"</span>], <span class="hljs-comment"># 转换为CreatedBy对象  </span>
            )  
        )  
    <span class="hljs-comment"># 构建并返回带标签的RAG数据集  </span>
    dataset = LabelledRagDataset(examples=examples)  
    <span class="hljs-keyword">return</span> dataset  
  
<span class="hljs-comment"># 加载保留集  </span>
holdout_dataset = get_rag_dataset_from_csv(<span class="hljs-string">"holdout_dataset.csv"</span>)
</code></pre>
<h3 data-id="heading-9">2. 构建RAG引擎</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ./notebooks/training_dataset_gen.ipynb  </span>
  
from llama_index.embeddings.ollama import OllamaEmbedding  
from llama_index.llms.ollama import Ollama  
from llama_index.core import VectorStoreIndex  
  
<span class="hljs-comment"># 初始化嵌入模型（用于文本向量转换）  </span>
<span class="hljs-attr">embed_model</span> = OllamaEmbedding(model_name=<span class="hljs-string">"nomic-embed-text"</span>)  
<span class="hljs-comment"># 从文档构建向量存储索引  </span>
<span class="hljs-attr">index</span> = VectorStoreIndex.from_documents(docs, embed_model=embed_model)  
<span class="hljs-comment"># 构建查询引擎（使用待微调的基础模型Llama 3.2 1B）  </span>
<span class="hljs-attr">query_engine</span> = index.as_query_engine(  
      <span class="hljs-attr">similarity_top_k</span>=<span class="hljs-number">6</span>,  <span class="hljs-comment"># 检索Top 6个相似文档片段  </span>
      <span class="hljs-attr">llm</span>=Ollama(<span class="hljs-string">"llama3.2:1b"</span>)  <span class="hljs-comment"># 基础模型（后续将微调此模型）  </span>
)
</code></pre>
<h3 data-id="heading-10">3. 执行RAG评估</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ./notebooks/training_dataset_gen.ipynb  </span>
  
from llama_index.core.llama_pack import download_llama_pack  
  
<span class="hljs-comment"># 下载RAG评估工具包  </span>
<span class="hljs-attr">RagEvaluatorPack</span> = download_llama_pack(<span class="hljs-string">"RagEvaluatorPack"</span>, <span class="hljs-string">"./pack"</span>)  
<span class="hljs-comment"># 初始化评估器  </span>
<span class="hljs-attr">rag_evaluator</span> = RagEvaluatorPack(  
    <span class="hljs-attr">query_engine</span>=query_engine,   
    <span class="hljs-attr">rag_dataset</span>=holdout_dataset,  
    <span class="hljs-comment"># 使用生成数据集时的同一模型（Qwen 2.5）作为评估裁判  </span>
    <span class="hljs-attr">judge_llm</span>=Ollama(<span class="hljs-string">"qwen2.5"</span>, request_timeout=<span class="hljs-number">120.0</span>),  
    <span class="hljs-attr">embed_model</span>=OllamaEmbedding(model_name=<span class="hljs-string">"nomic-embed-text"</span>)  
)  
<span class="hljs-comment"># 运行评估并获取结果  </span>
<span class="hljs-attr">benchmark_df</span> = rag_evaluator.run()
</code></pre>
<p>评估指标说明：</p>
<ul>
<li>• “正确性”（Correctness）：评分范围为1-5分；</li>
<li>• 其他指标（如相关性、忠实度、流畅度）：评分范围为0-1分。</li>
</ul>
<p>整体来看，基础模型的表现不算差，但“忠实度”（Faithfulness）得分明显偏低——这是一个关键短板。</p>
<p>“忠实度”衡量的是生成回答与检索到的上下文之间的“事实一致性”：只有当回答中的每一个主张都能被检索上下文直接支持时，才算“忠实”。忠实度低，意味着模型存在“幻觉”（生成无依据内容）或“过度泛化”（超出上下文范围推断）的问题——这正是我们希望通过微调解决的核心痛点。</p>
<h2 data-id="heading-11">四、步骤3：终于到微调环节！</h2>
<p>接下来就是最有趣的部分：微调！这里要介绍一个非常出色的框架——Unsloth.ai。</p>
<p>Unsloth的核心优势在于，它通过手动推导反向传播步骤，绕开了PyTorch的标准自动求导（autograd）系统。这种优化大幅降低了计算需求，显著加快了训练速度，非常适合在本地或资源有限的硬件上运行。</p>
<p>需要明确的是，Unsloth.ai的核心创新并非“替代训练框架”，而是“优化LLM模块”——专门针对PEFT微调场景进行改写。事实上，Unsloth的大多数示例代码（cookbook）都能在免费的Google Colab实例上运行，甚至能微调参数规模达140亿的模型！</p>
<p>实际微调过程中，我们仍会使用Hugging Face的“Transformer强化学习”（TRL）框架——这是一个基于PyTorch的高层抽象框架，支持：</p>
<ul>
<li>• 监督式微调（包括推理密集型数据集）；</li>
<li>• PEFT（参数高效微调）方法；</li>
<li>• 基于强化学习的微调（如GRPO）。</li>
</ul>
<p>Unsloth与TRL的组合，为资源有限场景下的大语言模型训练提供了高效且灵活的解决方案。</p>
<h3 data-id="heading-12">1. 加载数据集与模型</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ./notebooks/finetune_llama32_1bn.ipynb  </span>
  
import json  
from datasets import Dataset  
from unsloth import FastLanguageModel  
import torch  
  
<span class="hljs-comment"># 加载数据集（添加系统提示词）  </span>
def load_messages_with_system(path, <span class="hljs-attr">system_content</span>=<span class="hljs-string">"You are a helpful assistant."</span>):  
    <span class="hljs-attr">examples</span> = []  
    with open(path, 'r', <span class="hljs-attr">encoding</span>=<span class="hljs-string">'utf8'</span>) as f:  
        for line in f:  
            <span class="hljs-attr">obj</span> = json.loads(line)  
            <span class="hljs-comment"># 构建系统提示词消息  </span>
            <span class="hljs-attr">sys_msg</span> = {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: system_content}  
            <span class="hljs-comment"># 获取用户-助手消息对  </span>
            <span class="hljs-attr">ua_msgs</span> = obj.get(<span class="hljs-string">"messages"</span>, [])  
            <span class="hljs-comment"># 组合系统消息与用户-助手消息  </span>
            examples.append({"messages": <span class="hljs-section">[sys_msg]</span> + ua_msgs})  
    return examples  
  
<span class="hljs-comment"># 加载训练集（JSONL格式）  </span>
<span class="hljs-attr">examples</span> = load_messages_with_system(<span class="hljs-string">"train.jsonl"</span>)  
<span class="hljs-comment"># 转换为Hugging Face Dataset格式  </span>
<span class="hljs-attr">dataset</span> = Dataset.from_list(examples)  
  
<span class="hljs-comment"># 加载模型与分词器（使用Unsloth的FastLanguageModel包装器）  </span>
model, <span class="hljs-attr">tokenizer</span> = FastLanguageModel.from_pretrained(  
    <span class="hljs-attr">model_name</span>=<span class="hljs-string">"unsloth/Llama-3.2-1B-Instruct"</span>,  <span class="hljs-comment"># Unsloth预训练的Llama 3.2 1B模型  </span>
    <span class="hljs-attr">max_seq_length</span>=<span class="hljs-number">2048</span>,  <span class="hljs-comment"># 长上下文长度（可按需设置）  </span>
    <span class="hljs-attr">load_in_4bit</span>=<span class="hljs-literal">True</span>,   <span class="hljs-comment"># 4位量化，减少内存占用  </span>
    <span class="hljs-attr">load_in_8bit</span>=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 8位量化（精度略高，但内存占用翻倍）  </span>
    <span class="hljs-attr">full_finetuning</span>=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 关闭全量微调（启用PEFT）  </span>
)
</code></pre>
<p>步骤说明：</p>
<ul>
<li>• 首先将JSONL格式的训练集加载为Hugging Face Dataset格式；</li>
<li>• 然后通过Unsloth的<code>FastLanguageModel</code>包装器加载基础模型与分词器——<code>model_name</code>参数对应Unsloth在Hugging Face Hub上发布的模型，可根据需求浏览并选择兼容模型。</li>
</ul>
<h3 data-id="heading-13">2. 配置LoRA参数（启用PEFT）</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ./notebooks/finetune_llama32_1bn.ipynb  </span>
  
<span class="hljs-attr">model</span> = FastLanguageModel.get_peft_model(  
    model,  
    <span class="hljs-attr">r</span>=<span class="hljs-number">16</span>,  <span class="hljs-comment"># 低秩矩阵的秩（常用值：8、16、32、64、128）  </span>
    <span class="hljs-comment"># LoRA适配的目标层（不同模型可能不同，需参考官方文档）  </span>
    <span class="hljs-attr">target_modules</span>=[<span class="hljs-string">"q_proj"</span>, <span class="hljs-string">"k_proj"</span>, <span class="hljs-string">"v_proj"</span>, <span class="hljs-string">"o_proj"</span>,  
                    <span class="hljs-string">"gate_proj"</span>, <span class="hljs-string">"up_proj"</span>, <span class="hljs-string">"down_proj"</span>],  
    <span class="hljs-attr">lora_alpha</span>=<span class="hljs-number">16</span>,  <span class="hljs-comment"># LoRA缩放因子  </span>
    <span class="hljs-attr">lora_dropout</span>=<span class="hljs-number">0</span>,  <span class="hljs-comment"># LoRA dropout率（设为0以优化性能）  </span>
    <span class="hljs-attr">bias</span>=<span class="hljs-string">"none"</span>,     <span class="hljs-comment"># 偏置项处理（"none"最节省内存）  </span>
    <span class="hljs-attr">use_gradient_checkpointing</span>=<span class="hljs-string">"unsloth"</span>,  <span class="hljs-comment"># 使用Unsloth梯度检查点，减少30%显存占用  </span>
    <span class="hljs-attr">random_state</span>=<span class="hljs-number">3407</span>,  <span class="hljs-comment"># 随机种子，保证可复现  </span>
    <span class="hljs-attr">use_rslora</span>=<span class="hljs-literal">False</span>,   <span class="hljs-comment"># 关闭秩稳定LoRA（按需启用）  </span>
    <span class="hljs-attr">loftq_config</span>=None,  <span class="hljs-comment"># 关闭LoftQ量化（按需配置）  </span>
)
</code></pre>
<p>通过<code>FastLanguageModel.get_peft_model()</code>，我们将基础模型转换为支持PEFT的模型。其中，<code>target_modules</code>定义了LoRA将适配的层——不同模型的目标层可能不同，建议参考Unsloth官方示例代码，确认对应模型的目标层设置。</p>
<h3 data-id="heading-14">3. 格式化训练数据（适配Llama 3.2指令格式）</h3>
<p>Llama 3.2的指令微调需要特定的对话格式，示例如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">&lt;</span><span class="hljs-operator">|</span>begin_of_text<span class="hljs-operator">|</span><span class="hljs-operator">&gt;</span><span class="hljs-operator">&lt;</span><span class="hljs-operator">|</span>start_header_id<span class="hljs-operator">|</span><span class="hljs-operator">&gt;</span><span class="hljs-keyword">system</span><span class="hljs-operator">&lt;</span><span class="hljs-operator">|</span>end_header_id<span class="hljs-operator">|</span><span class="hljs-operator">&gt;</span>  
  
知识截止日期：<span class="hljs-number">2023</span>年<span class="hljs-number">12</span>月  
当前日期：<span class="hljs-number">2025</span>年<span class="hljs-number">5</span>月<span class="hljs-number">1</span>日  
  
你是一个乐于助人的助手。<span class="hljs-operator">&lt;</span><span class="hljs-operator">|</span>eot_id<span class="hljs-operator">|</span><span class="hljs-operator">&gt;</span><span class="hljs-operator">&lt;</span><span class="hljs-operator">|</span>start_header_id<span class="hljs-operator">|</span><span class="hljs-operator">&gt;</span><span class="hljs-keyword">user</span><span class="hljs-operator">&lt;</span><span class="hljs-operator">|</span>end_header_id<span class="hljs-operator">|</span><span class="hljs-operator">&gt;</span>  
  
<span class="hljs-number">1</span><span class="hljs-operator">+</span><span class="hljs-number">1</span>等于多少？<span class="hljs-operator">&lt;</span><span class="hljs-operator">|</span>eot_id<span class="hljs-operator">|</span><span class="hljs-operator">&gt;</span><span class="hljs-operator">&lt;</span><span class="hljs-operator">|</span>start_header_id<span class="hljs-operator">|</span><span class="hljs-operator">&gt;</span>assistant<span class="hljs-operator">&lt;</span><span class="hljs-operator">|</span>end_header_id<span class="hljs-operator">|</span><span class="hljs-operator">&gt;</span>  
  
<span class="hljs-number">2</span><span class="hljs-operator">&lt;</span><span class="hljs-operator">|</span>eot_id<span class="hljs-operator">|</span><span class="hljs-operator">&gt;</span>
</code></pre>
<p>注意：该格式是“模型专属”的，但Unsloth提供了对话模板映射工具，可简化这一步骤：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ./notebooks/finetune_llama32_1bn.ipynb  </span>
  
<span class="hljs-keyword">def</span> <span class="hljs-title function_">formatting_prompts_func</span>(<span class="hljs-params">batch</span>):  
    <span class="hljs-string">"""将对话消息转换为Llama 3.2所需的格式"""</span>  
    convos = batch[<span class="hljs-string">"messages"</span>]  <span class="hljs-comment"># 对话消息列表（每个元素是一条对话）  </span>
    <span class="hljs-comment"># 应用分词器的对话模板  </span>
    texts = [  
        tokenizer.apply_chat_template(convo,  
                                      tokenize=<span class="hljs-literal">False</span>,  
                                      add_generation_prompt=<span class="hljs-literal">False</span>)  
        <span class="hljs-keyword">for</span> convo <span class="hljs-keyword">in</span> convos  
    ]  
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"text"</span>: texts}  
  
<span class="hljs-comment"># 批量处理数据集（不删除原始"messages"字段）  </span>
dataset = dataset.<span class="hljs-built_in">map</span>(  
    formatting_prompts_func,  
    batched=<span class="hljs-literal">True</span>,  
)
</code></pre>
<p>现在，数据集已完成格式转换，可用于训练！</p>
<h3 data-id="heading-15">4. 配置并启动微调</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ./notebooks/finetune_llama32_1bn.ipynb  </span>
import os  
from trl import SFTTrainer, SFTConfig  
  
<span class="hljs-comment"># 初始化监督式微调（SFT）训练器  </span>
<span class="hljs-attr">trainer</span> = SFTTrainer(  
    <span class="hljs-attr">model</span>=model,  
    <span class="hljs-attr">tokenizer</span>=tokenizer,  
    <span class="hljs-attr">train_dataset</span>=dataset,  
    <span class="hljs-attr">eval_dataset</span>=None,  <span class="hljs-comment"># 可按需配置评估集  </span>
    <span class="hljs-attr">args</span>=SFTConfig(  
        <span class="hljs-attr">dataset_text_field</span>=<span class="hljs-string">"text"</span>,  <span class="hljs-comment"># 数据集中文本字段的名称  </span>
        <span class="hljs-attr">per_device_train_batch_size</span>=<span class="hljs-number">2</span>,  <span class="hljs-comment"># 单设备训练批次大小  </span>
        <span class="hljs-attr">gradient_accumulation_steps</span>=<span class="hljs-number">4</span>,  <span class="hljs-comment"># 梯度累积步数（用于模拟更大批次）  </span>
        <span class="hljs-attr">warmup_steps</span>=<span class="hljs-number">5</span>,  <span class="hljs-comment"># 预热步数  </span>
        <span class="hljs-attr">max_steps</span>=<span class="hljs-number">60</span>,  <span class="hljs-comment"># 总训练步数（也可注释此参数，设置num_epochs=1）  </span>
        <span class="hljs-attr">learning_rate</span>=<span class="hljs-number">2</span>e-<span class="hljs-number">4</span>,  <span class="hljs-comment"># 学习率  </span>
        <span class="hljs-attr">logging_steps</span>=<span class="hljs-number">1</span>,  <span class="hljs-comment"># 日志记录步数  </span>
        <span class="hljs-attr">optim</span>=<span class="hljs-string">"adamw_8bit"</span>,  <span class="hljs-comment"># 优化器（8位AdamW，节省内存）  </span>
        <span class="hljs-attr">weight_decay</span>=<span class="hljs-number">0.01</span>,  <span class="hljs-comment"># 权重衰减（防止过拟合）  </span>
        <span class="hljs-attr">lr_scheduler_type</span>=<span class="hljs-string">"linear"</span>,  <span class="hljs-comment"># 学习率调度器类型  </span>
        <span class="hljs-attr">seed</span>=<span class="hljs-number">2025</span>,  <span class="hljs-comment"># 随机种子  </span>
        <span class="hljs-attr">report_to</span>=<span class="hljs-string">"none"</span>,  <span class="hljs-comment"># 关闭日志上报（如需使用WandB等工具，可修改此参数）  </span>
    ),  
)  
<span class="hljs-comment"># 启动训练  </span>
<span class="hljs-attr">trainer_stats</span> = trainer.train()  
  
<span class="hljs-comment"># 将微调后的模型推送到Hugging Face Hub  </span>
model.push_to_hub(  
  "tituslhy/retrained_llama32-1bn-finetuned",   
  <span class="hljs-attr">token</span>=os.environ[<span class="hljs-string">"HUGGINGFACE_ACCESS_TOKEN"</span>]  <span class="hljs-comment"># 从环境变量获取Hub令牌  </span>
)   
<span class="hljs-comment"># 将分词器推送到Hugging Face Hub  </span>
tokenizer.push_to_hub(  
  "tituslhy/retrained_llama32-1bn-finetuned",   
  <span class="hljs-attr">token</span>=os.environ[<span class="hljs-string">"HUGGINGFACE_ACCESS_TOKEN"</span>]  
)
</code></pre>
<p>训练配置说明：</p>
<ul>
<li>• 微调的核心是<code>SFTConfig</code>：它控制所有训练参数。本文中，我们选择按“固定步数”（60步）训练，而非按“完整轮次”（epoch）——按轮次训练耗时更长，按步数训练更适合快速原型验证；</li>
<li>• Hugging Face的TRL框架封装了PyTorch的底层细节（如<code>zero_grad()</code>和自动求导调用），因此只需一行代码配置训练器、一行代码启动训练。</li>
</ul>
<p>训练启动后，你会看到Unsloth标志性的控制台输出：</p>
<pre><code class="hljs language-ini" lang="ini">==((====))==  Unsloth - 2x faster free finetuning | Num GPUs <span class="hljs-attr">used</span> = <span class="hljs-number">1</span>  
   \\   /|    Num <span class="hljs-attr">examples</span> = <span class="hljs-number">16</span> | Num Epochs = <span class="hljs-number">30</span> | Total steps = <span class="hljs-number">60</span>  
O^O/ \_/ \    Batch size per <span class="hljs-attr">device</span> = <span class="hljs-number">2</span> | Gradient accumulation steps = <span class="hljs-number">4</span>  
\        /    Data Parallel <span class="hljs-attr">GPUs</span> = <span class="hljs-number">1</span> | Total batch size (<span class="hljs-number">2</span> x <span class="hljs-number">4</span> x <span class="hljs-number">1</span>) = <span class="hljs-number">8</span>  
 "-____-"     Trainable <span class="hljs-attr">parameters</span> = <span class="hljs-number">11</span>,<span class="hljs-number">272</span>,<span class="hljs-number">192</span>/<span class="hljs-number">1</span>,<span class="hljs-number">000</span>,<span class="hljs-number">000</span>,<span class="hljs-number">000</span> (<span class="hljs-number">1.13</span>% trained)
</code></pre>
<p>没错，输出里有一个树懒图案！🦥 在10亿个参数中，我们仅训练了1127万个参数——这就是LoRA低秩适配的魔力。</p>
<p>训练完成后，可通过<code>model.push_to_hub()</code>将模型推送到Hugging Face Hub，方便后续调用。</p>
<h3 data-id="heading-16">5. （可选）推送量化版本模型</h3>
<p>如果需要推送量化版本的模型，Unsloth底层使用llama.cpp实现该功能（注意：需确保llama.cpp安装正确，我曾在此步骤遇到过问题，重新安装几次后才解决）。代码如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ./notebooks/finetune_llama32_1bn.ipynb  </span>
model.push_to_hub_gguf(  
    "tituslhy/retrained_llama32-1bn-finetuned",   
    tokenizer,  
    <span class="hljs-attr">quantization_method</span>=[<span class="hljs-string">"q4_k_m"</span>, <span class="hljs-string">"q8_0"</span>, <span class="hljs-string">"q5_k_m"</span>],  <span class="hljs-comment"># 量化方式  </span>
    <span class="hljs-attr">token</span>=os.environ[<span class="hljs-string">"HUGGINGFACE_ACCESS_TOKEN"</span>],   
)
</code></pre>
<p>另外，你可能会注意到控制台输出显示“30轮训练”，但我们明明只设置了60步——这是因为训练数据集规模过小：少量样本需要循环多次，才能达到设定的步数。</p>
<p>现在，关键问题来了：这种训练方式到底好不好？让我们通过评估来寻找答案。</p>
<h2 data-id="heading-17">五、步骤4：使用Ollama本地部署模型</h2>
<p>首先，在Hugging Face Hub上找到你的模型，点击“Use this model”，再选择“Ollama”。</p>
<p>你可以直接将页面提供的命令复制到终端运行，也可以稍作修改：将<code>run</code>改为<code>pull</code>，将模型下载到本地Ollama环境中。</p>
<h2 data-id="heading-18">六、步骤5：评估微调后的模型</h2>
<h3 data-id="heading-19">1. 基于RAG的评估</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ./notebooks/finetune_llama32_1bn.ipynb  </span>
  
<span class="hljs-comment"># 构建新的查询引擎（使用微调后的模型）  </span>
<span class="hljs-attr">query_engine2</span> = index.as_query_engine(  
    <span class="hljs-attr">similarity_top_k</span>=<span class="hljs-number">6</span>,   
    <span class="hljs-attr">llm</span>=Ollama(<span class="hljs-string">"hf.co/tituslhy/retrained_llama32-1bn-finetuned:Q4_K_M"</span>)  
)  
<span class="hljs-comment"># 初始化新的评估器  </span>
<span class="hljs-attr">rag_evaluator2</span> = RagEvaluatorPack(  
    <span class="hljs-attr">query_engine</span>=query_engine2,   
    <span class="hljs-attr">rag_dataset</span>=holdout_dataset,  
    <span class="hljs-comment"># 仍使用Qwen 2.5作为评估裁判（与生成数据集时一致）  </span>
    <span class="hljs-attr">judge_llm</span>=Ollama(<span class="hljs-string">"qwen2.5"</span>, request_timeout=<span class="hljs-number">120.0</span>),  
    <span class="hljs-attr">embed_model</span>=OllamaEmbedding(model_name=<span class="hljs-string">"nomic-embed-text"</span>)  
)  
<span class="hljs-comment"># 运行评估（异步方式）  </span>
<span class="hljs-attr">benchmark_df</span> = await rag_evaluator.arun()
</code></pre>
<p>结果令人意外：微调效果并不明显——尽管忠实度得分略有提升（达到0.31/1），但整体仍处于较低水平。</p>
<p>原因可能在于：我们在“RAG模式”下评估微调模型——此时模型依赖外部检索到的文本片段生成答案，而非仅依靠自身内化的知识；但大语言模型微调的核心目标，是让模型“内化领域知识”，而非“提升使用外部上下文的能力”。</p>
<h3 data-id="heading-20">2. 直接评估模型（无检索，仅依赖内化知识）</h3>
<p>因此，我们需要换一种正确的评估方式：不进行检索，让模型直接回答问题，仅依靠微调时学到的领域知识。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># ./notebooks/finetune_llama32_1bn.ipynb  </span>
  
from llama_index.llms.ollama import Ollama  
from llama_index.embeddings.ollama import OllamaEmbedding  
from llama_index.core.evaluation import SemanticSimilarityEvaluator  
from tqdm import tqdm  
  
<span class="hljs-comment"># 初始化微调后的模型与嵌入模型  </span>
<span class="hljs-attr">llm</span> = Ollama(<span class="hljs-string">"hf.co/tituslhy/retrained_llama32-1bn-finetuned:Q4_K_M"</span>)  
<span class="hljs-attr">embed_model</span> = OllamaEmbedding(model_name=<span class="hljs-string">"nomic-embed-text"</span>)  
  
<span class="hljs-comment"># 读取保留集（处理JSON格式字段）  </span>
<span class="hljs-attr">converters</span> = {  
        "reference_contexts":   lambda s: json.loads(s),  
        "query_by":             lambda s: CreatedBy.model_validate_json(s),  
        "reference_answer_by":  lambda s: CreatedBy.model_validate_json(s),  
    }  
<span class="hljs-attr">df</span> = pd.read_csv(<span class="hljs-string">"holdout_dataset.csv"</span>, converters=converters)  
  
<span class="hljs-comment"># 初始化语义相似度评估器（相似度阈值设为0.5）  </span>
<span class="hljs-attr">evaluator</span> = SemanticSimilarityEvaluator(  
    <span class="hljs-attr">similarity_threshold</span>=<span class="hljs-number">0.5</span>,   
    <span class="hljs-attr">embed_model</span>=embed_model  
)  
  
<span class="hljs-comment"># 筛选出包含"Question"的有效查询与参考答案  </span>
<span class="hljs-attr">queries</span> = [df.iloc[i][<span class="hljs-string">'query'</span>] for i in range(len(df)) if <span class="hljs-string">"Question"</span> in df.iloc[i][<span class="hljs-string">'query'</span>]]  
<span class="hljs-attr">references</span> = [df.iloc[i][<span class="hljs-string">'reference_answer'</span>] for i in range(len(df)) if <span class="hljs-string">"Question"</span> in df.iloc[i][<span class="hljs-string">'query'</span>]]  
<span class="hljs-comment"># 构建DataFrame存储查询与参考答案  </span>
<span class="hljs-attr">df_answers</span> = pd.DataFrame({<span class="hljs-string">'queries'</span>: queries, <span class="hljs-string">'reference_answers'</span>: references})  
  
<span class="hljs-comment"># 存储模型回答与相似度得分  </span>
answers, <span class="hljs-attr">similarity_scores</span> = [], []  
<span class="hljs-comment"># 遍历所有查询，让模型直接回答  </span>
for idx, (query, reference) in tqdm(df_answers.iterrows()):  
    <span class="hljs-attr">answer</span> = llm.complete(query)  
    answers.append(str(answer))  
      
    <span class="hljs-comment"># 计算模型回答与参考答案的语义相似度  </span>
    <span class="hljs-attr">similarity_score</span> = evaluator.evaluate(  
        <span class="hljs-attr">response</span>=str(answer),  
        <span class="hljs-attr">reference</span>=reference  
    )  
    similarity_scores.append(round(similarity_score.score, 2))  
  
<span class="hljs-comment"># 将结果添加到DataFrame  </span>
df_answers<span class="hljs-section">['answers']</span> = answers  
df_answers<span class="hljs-section">['similarity_scores']</span> = similarity_scores
</code></pre>
<h3 data-id="heading-21">3. 评估结果分析</h3>
<p>我们来拆解这段代码的逻辑：</p>
<ol>
<li>初始化微调后的模型与嵌入模型；</li>
<li>加载保留集，筛选出有效查询（包含“Question”的条目）；</li>
<li>让模型不依赖任何检索上下文，直接回答每个查询；</li>
<li>计算模型回答与参考答案之间的语义相似度（得分范围0-1）。</li>
</ol>
<p>从相似度得分来看，似乎有了提升！但别急着下结论——我们需要仔细阅读模型的回答内容，而非仅看分数。</p>
<p>问题很快浮现：以第一个问题为例，模型的回答非常冗长，而参考答案只是一句话。这种“高分”其实具有误导性——更长的回答包含更多token和信息点，自然更容易与参考答案产生语义重叠。</p>
<p>更深入分析“得分最高”的回答后，发现情况更不乐观。例如，有一个非常模糊的查询：“Which study are we referring to here?”（我们这里指的是哪项研究？）——这个问题本身表述不明确、信息不完整。</p>
<p>从表面上看，模型似乎学到了文档中的一些信息——即使面对模糊的提示，也给出了连贯的回答。但问题在于：我们从未在训练数据中提及“该研究的名称”，因此这个回答很可能是“幻觉”。</p>
<p>👉 我将这种情况称为“假阳性”：回答看起来正确，但实际上基于假设或虚构的上下文。</p>
<h2 data-id="heading-22">七、实验反思</h2>
<p>总体而言，这次微调实验不能算“成功”，但却带来了宝贵的经验。以下是几点关键启示：</p>
<ol>
<li><strong>数据集质量至关重要</strong> 我们的训练集仅包含49个示例，且没有对数据质量进行校验（只是盲目相信大语言模型生成的问答对）。实际场景中，这类数据往往存在“What format is this document?”（这是什么格式的文档？）这类无意义问题，需要手动剔除。正因如此，生成训练数据集时，务必使用性能优异的大语言模型！</li>
<li><strong>数据集规模同样关键</strong> 样本量过少时，微调很可能是“错误选择”——我们的实验就出现了性能未达预期的情况。更优的路径（我将在下一篇文章中探讨）是“微调整个RAG系统”，敬请关注！</li>
<li><strong>训练配置决定结果成败</strong> 理想的训练配置应包含：</li>
</ol>
<ul>
<li>单独的评估集（同样需要精心筛选或生成）；</li>
<li>多组超参数实验（测试不同参数组合的效果）；</li>
<li>借助Weights &amp; Biases或MLflow等工具进行完整的训练跟踪。</li>
</ul>
<p>但在本次实验中，我们仅进行了一次“一次性训练”，且几乎没有跟踪记录——悄悄说一句，可别让我的教授知道这事。</p>
<ol start="4">
<li><strong>微调比想象中简单，归功于开源社区</strong> 我们能轻松完成这次实验，离不开开源社区的贡献。Unsloth.AI、Hugging Face和Ollama等工具，将曾经复杂且高门槛的大语言模型微调，变得如今触手可及。没有这些出色的工具，本次实验的代码编写和运行会困难得多。</li>
</ol>
<p>虽然我们没能成功“教无牙学会咬合”（让模型精准输出），但这次实验仍是一次宝贵的“大语言模型微调入门”——我们不仅学到了大量知识，还得到了可复用的代码，而不仅仅是复制Unsloth的示例。</p>
<p>目前，Hugging Face和Kaggle上有许多高质量的领域数据集可供使用。相信只要优化数据质量、设计更合理的训练方案，我们一定能构建出更精准、更可靠的微调模型。</p>
<h2 data-id="heading-23">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[logback 配置文件]]></title>    <link>https://juejin.cn/post/7574245125027938323</link>    <guid>https://juejin.cn/post/7574245125027938323</guid>    <pubDate>2025-11-19T08:42:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574245125027938323" data-draft-id="7574253222606061609" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="logback 配置文件"/> <meta itemprop="keywords" content="Java,后端"/> <meta itemprop="datePublished" content="2025-11-19T08:42:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哪里的破水瓶"/> <meta itemprop="url" content="https://juejin.cn/user/4394111849466414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            logback 配置文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4394111849466414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哪里的破水瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T08:42:37.000Z" title="Wed Nov 19 2025 08:42:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>日志级别指的是日志信息的类型，日志都会分级别，常见的日志级别如下（级别由低到高）：</p>



































<table><thead><tr><th>日志级别</th><th>说明</th><th>记录方式</th></tr></thead><tbody><tr><td>trace</td><td>追踪，记录程序运行轨迹 【使用很少】</td><td>log.trace("...")</td></tr><tr><td>debug</td><td>调试，记录程序调试过程中的信息，实际应用中一般将其视为最低级别 【使用较多】</td><td>log.debug("...")</td></tr><tr><td>info</td><td>记录一般信息，描述程序运行的关键事件，如：网络连接、io操作 【使用较多】</td><td>log.info("...")</td></tr><tr><td>warn</td><td>警告信息，记录潜在有害的情况 【使用较多】</td><td>log.warn("...")</td></tr><tr><td>error</td><td>错误信息 【使用较多】</td><td>log.error("...")</td></tr></tbody></table>
<p>可以在配置文件中，灵活的控制输出那些类型的日志。（大于等于配置的日志级别的日志才会输出）</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"info"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"STDOUT"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"FILE"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span>
</code></pre>
<h2 data-id="heading-0">文件如下</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 控制台输出 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"STDOUT"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>&gt;</span>
          <span class="hljs-comment">&lt;!--格式化输出：%d 表示日期，%thread 表示线程名，%-5level表示级别从左显示5个字符宽度，%logger显示日志记录器的名称， %msg表示日志消息，%n表示换行符 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50}-%msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
       <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 系统文件输出 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"FILE"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">rollingPolicy</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy"</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- 日志文件输出的文件名, %i表示序号 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">FileNamePattern</span>&gt;</span>D:/tlias-%d{yyyy-MM-dd}-%i.log<span class="hljs-tag">&lt;/<span class="hljs-name">FileNamePattern</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- 最多保留的历史日志文件数量 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">MaxHistory</span>&gt;</span>30<span class="hljs-tag">&lt;/<span class="hljs-name">MaxHistory</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- 最大文件大小，超过这个大小会触发滚动到新文件，默认为 10MB --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">maxFileSize</span>&gt;</span>10MB<span class="hljs-tag">&lt;/<span class="hljs-name">maxFileSize</span>&gt;</span>
       <span class="hljs-tag">&lt;/<span class="hljs-name">rollingPolicy</span>&gt;</span>

       <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>&gt;</span>
          <span class="hljs-comment">&lt;!--格式化输出：%d 表示日期，%thread 表示线程名，%-5level表示级别从左显示5个字符宽度，%msg表示日志消息，%n表示换行符 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50}-%msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
       <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 日志输出级别 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"ALL"</span>&gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"STDOUT"</span> /&gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"FILE"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LLM 四阶段和 Transformer 架构（二）]]></title>    <link>https://juejin.cn/post/7574230922314268678</link>    <guid>https://juejin.cn/post/7574230922314268678</guid>    <pubDate>2025-11-19T08:42:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574230922314268678" data-draft-id="7573993452577849387" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LLM 四阶段和 Transformer 架构（二）"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-19T08:42:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小兵张健"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032405229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LLM 四阶段和 Transformer 架构（二）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032405229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小兵张健
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T08:42:40.000Z" title="Wed Nov 19 2025 08:42:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上一篇解释完点积和矩阵乘法，矩阵乘法是一种转换，这一篇看 Transformer 中如何运用的。</p>
<p>LLM 的本质是预测下一个 token，阶段二中，使用大量的互联网内容，给模型做训练，使用自监督学习，不断调整 1750 亿个参数。直到模型能够正确的补全文本内容。</p>
<p>阶段二的产物，只有文本补全功能，不具备问答、对话能力。</p>
<p>现在假设所有参数已经调节完毕，以一个输入是 "The cat sat" 展示模型怎么预测下一个 token 是 "on" 的。</p>
<h3 data-id="heading-0">查询向量坐标</h3>
<p>输入 "The cat sat" 经过 Tokenizer 会把这句话分为 the、cat、sat 三个 token，再从 Vocab Map&lt;String, Integer&gt; 中找到对应的id，再去 Embedding Table 中找到这三个向量坐标。</p>
<p>得到 3 个形状为 [1,4096] 的向量，Vector_The: [0.1, -0.5, ...]、Vector_cat: [0.8, 0.2, ...]、Vector_sat: [-0.1, 0.9, ...]。把这三个向量合并到一个矩阵里面，得到一个形状是 [3,4096] 的向量。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>x</mi><mo>⃗</mo></mover><mrow><mi>T</mi><mi>h</mi><mi>e</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>x</mi><mo>⃗</mo></mover><mrow><mi>c</mi><mi>a</mi><mi>t</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>x</mi><mo>⃗</mo></mover><mrow><mi>s</mi><mi>a</mi><mi>t</mi></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">X_{in} = \begin{bmatrix} \vec{x}_{The} \\ \vec{x}_{cat} \\ \vec{x}_{sat} \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">in</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span><span class="mord mathnormal mtight">h</span><span class="mord mathnormal mtight">e</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<h3 data-id="heading-1">进入 Layer 加工</h3>
<p>接下来正式进入 Layer 加工。之前说过一共有 96 层 Layers，每一层 Layer 有 MHA (Multi-Head Attention) 多头注意力机制 和 FFN (Feed-Forward Network) 前馈神经网络处理。形状为 [3,4096] 的矩阵会完整经历所有 Layers，最后得到加工后的 [3,4096]。</p>
<h3 data-id="heading-2"><code>x_in</code> ➔ <strong>[Norm]</strong> ➔ <strong>[MHA]</strong> ➔ <strong>(+ 残差连接)</strong> ➔ <code>x_mid</code> ➔ <strong>[Norm]</strong> ➔ <strong>[FFN]</strong> ➔ <strong>(+ 残差连接)</strong> ➔ <code>x_out</code></h3>
<p>以上是一层 Layer 完整过程。 x_out 会是下一层 Layer 的 x_in。</p>
<h4 data-id="heading-3">Norm 层归一化</h4>
<p>其中 Norm 是 Layer Normalization（层归一化），矩阵乘法的结果范围非常大，有的值是 50000 而有的是 0.000003，为了防止计算溢出或者梯度乱跳，需要把这些值统一处理为均值为 0 方差为 1。</p>
<p>Norm 计算包含四个步骤，假设以  (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>x</mi><mo>⃗</mo></mover><mrow><mi>c</mi><mi>a</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\vec{x}_{cat}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.864em;vertical-align:-0.15em;"/><span class="mord"><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.714em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathnormal">x</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.2077em;"><span class="overlay" style="height:0.714em;width:0.471em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.471em" height="0.714em" style="width:0.471em" viewbox="0 0 471 714" preserveaspectratio="xMinYMin"><path d="M377 20c0-5.333 1.833-10 5.5-14S391 0 397 0c4.667 0 8.667 1.667 12 5&#10;3.333 2.667 6.667 9 10 19 6.667 24.667 20.333 43.667 41 57 7.333 4.667 11&#10;10.667 11 18 0 6-1 10-3 12s-6.667 5-14 9c-28.667 14.667-53.667 35.667-75 63&#10;-1.333 1.333-3.167 3.5-5.5 6.5s-4 4.833-5 5.5c-1 .667-2.5 1.333-4.5 2s-4.333 1&#10;-7 1c-4.667 0-9.167-1.833-13.5-5.5S337 184 337 178c0-12.667 15.667-32.333 47-59&#10;H213l-171-1c-8.667-6-13-12.333-13-19 0-4.667 4.333-11.333 13-20h359&#10;c-16-25.333-24-45-24-59z"/></svg></span></span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>): [10, 2, 12, 0] 为例。</p>
<ol>
<li>
<p>求均值 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi></mrow><annotation encoding="application/x-tex">\mu</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">μ</span></span></span></span></span>)</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>10</mn><mo>+</mo><mn>2</mn><mo>+</mo><mn>12</mn><mo>+</mo><mn>0</mn><mo stretchy="false">)</mo><mo>÷</mo><mn>4</mn><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">(10 + 2 + 12 + 0) \div 4 = 6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">10</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">12</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">0</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">÷</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">6</span></span></span></span></span></p>
</li>
<li>
<p>求方差 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>σ</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\sigma^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>)</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mo>→</mo><mo stretchy="false">(</mo><mn>10</mn><mo>−</mo><mn>6</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mn>16</mn></mrow><annotation encoding="application/x-tex">10 \to (10-6)^2 = 16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">10</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">6</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span><br/>
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>→</mo><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mn>6</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mn>16</mn></mrow><annotation encoding="application/x-tex">2 \to (2-6)^2 = 16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">6</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span><br/>
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mo>→</mo><mo stretchy="false">(</mo><mn>12</mn><mo>−</mo><mn>6</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mn>36</mn></mrow><annotation encoding="application/x-tex">12 \to (12-6)^2 = 36</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">12</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">12</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">6</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">36</span></span></span></span></span><br/>
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>→</mo><mo stretchy="false">(</mo><mn>0</mn><mo>−</mo><mn>6</mn><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mn>36</mn></mrow><annotation encoding="application/x-tex">0 \to (0-6)^2 = 36</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord">6</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">36</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>方差</mtext><mo>=</mo><mo stretchy="false">(</mo><mn>16</mn><mo>+</mo><mn>16</mn><mo>+</mo><mn>36</mn><mo>+</mo><mn>36</mn><mo stretchy="false">)</mo><mo>÷</mo><mn>4</mn><mo>=</mo><mn>26</mn></mrow><annotation encoding="application/x-tex">\text{方差} = (16 + 16 + 36 + 36) \div 4 = 26</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord text"><span class="mord cjk_fallback">方差</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">16</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">16</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">36</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">36</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">÷</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">4</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">26</span></span></span></span></span></p>
<p><strong>标准差 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span></span></span></span></span>):</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mn>26</mn></msqrt><mo>≈</mo><mn>5.1</mn></mrow><annotation encoding="application/x-tex">\sqrt{26} \approx 5.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1328em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9072em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord">26</span></span></span><span style="top:-2.8672em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1328em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5.1</span></span></span></span></span></p>
</li>
<li>
<p>归一化 (Normalize)<br/>
公式：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>x</mi><mo>−</mo><mtext>均值</mtext></mrow><mtext>标准差</mtext></mfrac></mrow><annotation encoding="application/x-tex">\frac{x - \text{均值}}{\text{标准差}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2173em;vertical-align:-0.345em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord cjk_fallback mtight">标准差</span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mbin mtight">−</span><span class="mord text mtight"><span class="mord cjk_fallback mtight">均值</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span>目的是把数据强行拉回到 “均值为 0，方差为 1” 的标准形态。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mo>→</mo><mo stretchy="false">(</mo><mn>10</mn><mo>−</mo><mn>6</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>5.1</mn><mo>≈</mo><mn mathvariant="bold">0.78</mn></mrow><annotation encoding="application/x-tex">10 \to (10 - 6) / 5.1 \approx \mathbf{0.78}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">10</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">6</span><span class="mclose">)</span><span class="mord">/5.1</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord"><span class="mord mathbf">0.78</span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>→</mo><mo stretchy="false">(</mo><mn>2</mn><mo>−</mo><mn>6</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>5.1</mn><mo>≈</mo><mrow><mo>−</mo><mn mathvariant="bold">0.78</mn></mrow></mrow><annotation encoding="application/x-tex">2 \to (2 - 6) / 5.1 \approx \mathbf{-0.78}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">6</span><span class="mclose">)</span><span class="mord">/5.1</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord">−</span><span class="mord mathbf">0.78</span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mo>→</mo><mo stretchy="false">(</mo><mn>12</mn><mo>−</mo><mn>6</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>5.1</mn><mo>≈</mo><mn mathvariant="bold">1.17</mn></mrow><annotation encoding="application/x-tex">12 \to (12 - 6) / 5.1 \approx \mathbf{1.17}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">12</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">12</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">6</span><span class="mclose">)</span><span class="mord">/5.1</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord"><span class="mord mathbf">1.17</span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>→</mo><mo stretchy="false">(</mo><mn>0</mn><mo>−</mo><mn>6</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mn>5.1</mn><mo>≈</mo><mrow><mo>−</mo><mn mathvariant="bold">1.17</mn></mrow></mrow><annotation encoding="application/x-tex">0 \to (0 - 6) / 5.1 \approx \mathbf{-1.17}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">6</span><span class="mclose">)</span><span class="mord">/5.1</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord"><span class="mord">−</span><span class="mord mathbf">1.17</span></span></span></span></span></span></p>
<p>结果向量： [0.78, -0.78, 1.17, -1.17]</p>
</li>
<li>
<p>缩放与平移 (Scale &amp; Shift)
如果每次都强行变成 0 均值，可能会破坏数据的含义。所以模型有两个可变参数：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span></span> (缩放) 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span> (平移)。这里可以理解成一个一元二次方程的线性函数。
假设模型学到这一层需要数值稍微大一点：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mo>=</mo><mo stretchy="false">[</mo><mn>2</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>2</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\gamma = [2, 2, 2, 2]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mclose">]</span></span></span></span></span>
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mo>=</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\beta = [1, 1, 1, 1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span></p>
<p>最终输出 = <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>归一化结果</mtext><mo>×</mo><mi>γ</mi><mo>+</mo><mi>β</mi></mrow><annotation encoding="application/x-tex">\text{归一化结果} \times \gamma + \beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord text"><span class="mord cjk_fallback">归一化结果</span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05278em;">β</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.78</mn><mo>×</mo><mn>2</mn><mo>+</mo><mn>1</mn><mo>=</mo><mn mathvariant="bold">2.56</mn></mrow><annotation encoding="application/x-tex">0.78 \times 2 + 1 = \mathbf{2.56}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0.78</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord"><span class="mord mathbf">2.56</span></span></span></span></span></span><br/>
...</p>
</li>
</ol>
<h4 data-id="heading-4">残差连接</h4>
<p>经过 MHA 和 FFN 后，为了防止原始数据丢失，会加上处理前的原始值。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mi>u</mi><mi>t</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo>=</mo><mtext>New_Process</mtext><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">Output = \text{New\_Process}(x) + x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal">u</span><span class="mord mathnormal">tp</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord text"><span class="mord">New_Process</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">x</span></span></span></span></span></p>
<h3 data-id="heading-5">MHA</h3>
<p>回到公式，x_in 是形状为 [3,4096] 的矩阵，经过 Norm 后还是 [3,4096]。接着进入 MHA。</p>
<p>MHA 中有  <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub><mtext>、</mtext><msub><mi>W</mi><mi>K</mi></msub><mtext>、</mtext><msub><mi>W</mi><mi>V</mi></msub></mrow><annotation encoding="application/x-tex">W_Q、W_K、W_V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>O</mi></msub></mrow><annotation encoding="application/x-tex">W_O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 四个形状为 [d_modle,d_modle]（[4096,4096]） 的矩阵。这是在阶段二训练好的。</p>
<p>Q 是 question，K 是 key，V 是 value，这是三个非常抽象的矩阵，他们的作用是把 "The cat sat" 中三个 token 的向量坐标互相融合，比如 the 要更关注 cat，经过融合后 the 这个 token 的向量值里就包含了大量 cat 的向量值。</p>
<p>MHA 叫多头注意力机制，比如有 32 个头,4096/32=128，就是把 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub><mtext>、</mtext><msub><mi>W</mi><mi>K</mi></msub><mtext>、</mtext><msub><mi>W</mi><mi>V</mi></msub></mrow><annotation encoding="application/x-tex">W_Q、W_K、W_V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord cjk_fallback">、</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 分为 32 个形状为 [4096,128] 的小矩阵，并行计算得到 32 个结果，再合并起来乘以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>O</mi></msub></mrow><annotation encoding="application/x-tex">W_O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 得到最终的产物。</p>
<p>大量的并行矩阵计算，这也是算力以 GPU 为核心的原因。</p>
<p>头也是抽象的概念，可以用角度类比，以 "The cat sat on the mat because it was tired." 为例。</p>
<p>Head 1 (语法眼): 专门盯着主谓关系。它发现 "it" 指代 "cat"。</p>
<p>Head 2 (逻辑眼): 专门盯着因果关系。它发现 "because" 导致了 "tired"。</p>
<p>Head 3 (位置眼): 专门盯着方位关系。它关注 "on the mat"。</p>
<p>真个 MHA 的计算过程用一个公式表示。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mo stretchy="false">(</mo><mi>X</mi><msub><mi>W</mi><mi>Q</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>X</mi><msub><mi>W</mi><mi>K</mi></msub><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></msqrt></mfrac><mo fence="true">)</mo></mrow><mo stretchy="false">(</mo><mi>X</mi><msub><mi>W</mi><mi>V</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Z = \text{softmax}\left( \frac{(X W_Q)(X W_K)^T}{\sqrt{d_{model}}} \right) (X W_V)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8009em;vertical-align:-0.65em;"/><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1509em;"><span style="top:-2.5864em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8622em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8222em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1778em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.5075em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2822em;"><span/></span></span></span></span></span><span class="mclose mtight">)</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.07847em;">X</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3567em;margin-left:-0.1389em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1433em;"><span/></span></span></span></span></span><span class="mclose mtight"><span class="mclose mtight">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9191em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>其中，
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Scores</mtext><mo>=</mo><mo stretchy="false">(</mo><mi>X</mi><msub><mi>W</mi><mi>Q</mi></msub><mo stretchy="false">)</mo><mo stretchy="false">(</mo><mi>X</mi><msub><mi>W</mi><mi>K</mi></msub><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\text{Scores} = (X W_Q)(X W_K)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord text"><span class="mord">Scores</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1274em;vertical-align:-0.2861em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><msub><mi>W</mi><mi>Q</mi></msub></mrow><annotation encoding="application/x-tex">X W_Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></strong> : 算出 Q 矩阵。<br/>
<strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><msub><mi>W</mi><mi>K</mi></msub></mrow><annotation encoding="application/x-tex">X W_K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></strong> : 算出 K 矩阵。<br/>
<strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo>…</mo><mtext> </mtext><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">(\dots)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span></strong> : 转置 K 矩阵，为了能进行矩阵乘法（前一个矩阵的横行必须等于后一个矩阵的纵列）。</p>
<p>转置是沿对角线翻转。比如</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">K = \begin{bmatrix} 1 &amp; 2 &amp; 3 \\ 4 &amp; 5 &amp; 6 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span></span></span></p>
<p>转置后是</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>K</mi><mi>T</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>5</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>3</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>6</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">K^T = \begin{bmatrix} 1 &amp; 4 \\ 2 &amp; 5 \\ 3 &amp; 6 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">6</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p>d_modle 计算模型设定的维度，除以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><msub><mi>d</mi><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi></mrow></msub></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{d_{model}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1828em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span></span></span></span></span> 也是为了防止向量值之间差距太大。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mtext>Scores</mtext><msqrt><mn>4</mn></msqrt></mfrac><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">A = \text{softmax}\left( \frac{\text{Scores}}{\sqrt{4}} \right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.551em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9128em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight">4</span></span></span><span style="top:-2.8728em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1272em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Scores</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p>softmax 是一种把一堆数字变为总和为 1 的小数算法，假设有一个输入向量（Logits） <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>=</mo><mo stretchy="false">[</mo><msub><mi>z</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>z</mi><mn>2</mn></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>z</mi><mi>n</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">z = [z_1, z_2, ..., z_n]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span>。 Softmax 函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo stretchy="false">(</mo><mi>z</mi><msub><mo stretchy="false">)</mo><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\sigma(z)_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的公式是：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>σ</mi><mo stretchy="false">(</mo><mi>z</mi><msub><mo stretchy="false">)</mo><mi>i</mi></msub><mo>=</mo><mfrac><msup><mi>e</mi><msub><mi>z</mi><mi>i</mi></msub></msup><mrow><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></msubsup><msup><mi>e</mi><msub><mi>z</mi><mi>j</mi></msub></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\sigma(z)_i = \frac{e^{z_i}}{\sum_{j=1}^N e^{z_j}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">σ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.6629em;vertical-align:-0.7519em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.911em;"><span style="top:-2.5703em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8852em;"><span style="top:-2.1786em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-2.8971em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4603em;"><span/></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.1952em;"/><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.779em;"><span style="top:-2.9714em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:-0.044em;margin-right:0.1em;"><span class="pstrut" style="height:2.6595em;"/><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5092em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7385em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3448em;margin-left:-0.044em;margin-right:0.1em;"><span class="pstrut" style="height:2.6595em;"/><span class="mord mathnormal mtight">i</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3147em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
<p><strong>分子 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><msub><mi>z</mi><mi>i</mi></msub></msup></mrow><annotation encoding="application/x-tex">e^{z_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6644em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>)</strong> ：算出当前元素的指数值。</p>
<p><strong>分母 (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∑</mo><msup><mi>e</mi><msub><mi>z</mi><mi>j</mi></msub></msup></mrow><annotation encoding="application/x-tex">\sum e^{z_j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>)</strong> ：算出所有元素指数值的总和。</p>
<p>用到了 e 自然指数，把负数也转成正数（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo>≈</mo><mn>0.135</mn></mrow><annotation encoding="application/x-tex">e^{-2} \approx 0.135</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.135</span></span></span></span></span>），由于指数函数特性，拉大的原始的差距（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mn>2.0</mn></msup><mo>≈</mo><mn mathvariant="bold">7.4</mn></mrow><annotation encoding="application/x-tex">e^{2.0} \approx \mathbf{7.4}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2.0</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord"><span class="mord mathbf">7.4</span></span></span></span></span></span> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mn>1.0</mn></msup><mo>≈</mo><mn mathvariant="bold">2.7</mn></mrow><annotation encoding="application/x-tex">e^{1.0} \approx \mathbf{2.7}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1.0</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord"><span class="mord mathbf">2.7</span></span></span></span></span></span>）。</p>
<p>LLM 中常见的配置 temperature 就是在这个公式的分子和分母同时除以 T。</p>
<p><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><msub><mi>W</mi><mi>V</mi></msub></mrow><annotation encoding="application/x-tex">X W_V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></strong> : 算出 V 矩阵。</p>
<p>再乘以 softmax 后的概率 A，就是最终的结果。</p>
<p>这里 X 参数是形状为 [3,4096] 的矩阵，而不是单一的 token，在这个过程中，每个 token 之间都相互融合，由于前一个 token 不能看到后一个 token，所以后一个 token 的向量是包含了前面所有信息的。</p>
<p>后一个 token 看不到前一个 token 通过 Mask 矩阵实现。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Attention</mtext><mo>=</mo><mtext>softmax</mtext><mrow><mo fence="true">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><mi>d</mi></msqrt></mfrac><mo>+</mo><mrow><mi mathvariant="bold">M</mi><mi mathvariant="bold">a</mi><mi mathvariant="bold">s</mi><mi mathvariant="bold">k</mi></mrow><mo fence="true">)</mo></mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">\text{Attention} = \text{softmax}\left( \frac{Q K^T}{\sqrt{d}} + \mathbf{Mask} \right) V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord text"><span class="mord">Attention</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mord text"><span class="mord">softmax</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0895em;"><span style="top:-2.5335em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9378em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mathnormal mtight">d</span></span></span><span style="top:-2.8978em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1022em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.4461em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">Q</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9191em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathbf">Mask</span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size2">)</span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
<p>上面的公式简化后是这样的，Mask 矩阵是一个<strong>上三角矩阵</strong>（右上角全是负无穷 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">-\infty</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">∞</span></span></span></span></span>），例如（为了简化这里 d_modle 是 3）：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Mask</mtext><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\text{Mask} = \begin{bmatrix} 0 &amp; -\infty &amp; -\infty \\ 0 &amp; 0 &amp; -\infty \\ 0 &amp; 0 &amp; 0 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord text"><span class="mord">Mask</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p>这样任何矩阵加上这个矩阵右上角都是负无穷，而 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></msup><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">e^{-\infty} = 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7713em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7713em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">∞</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>，这保证了在原始句子 "The cat sat" 中 cat 的概率永远是 1。</p>
<p>如果说后一个 token 向量包含了所有信息，那为什么还要算所有向量的 Q K V？这是因为后一个向量计算的过程中，用到了这些数据。</p>
<p>现在用一个 dmodle = 3 的例子，完整演示 MHA 中的计算过程。</p>
<p>入参 X</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>The</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>cat</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>sat</mtext></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">X = \begin{bmatrix} 1 &amp; 0 &amp; 0 \\ 0 &amp; 2 &amp; 0 \\ 0 &amp; 0 &amp; 2 \end{bmatrix} \begin{matrix} \leftarrow \text{The} \\ \leftarrow \text{cat} \\ \leftarrow \text{sat} \end{matrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">The</span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">cat</span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">sat</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p>阶段二训练后的参数（注意这里是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub></mrow><annotation encoding="application/x-tex">W_Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>，Q 是计算后的矩阵）</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold">1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">W_Q = \begin{bmatrix} 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 \\ 0 &amp; \mathbf{1} &amp; 0 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathbf">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>K</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold">1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">W_K = \begin{bmatrix} 0 &amp; 0 &amp; 0 \\ 0 &amp; \mathbf{1} &amp; 0 \\ 0 &amp; 0 &amp; 0 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathbf">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>V</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">W_V = \begin{bmatrix} 1 &amp; 0 &amp; 0 \\ 0 &amp; 1 &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p>矩阵乘法后</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>The (无需求)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>cat (无需求)</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>sat (有需求)</mtext></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">Q = \begin{bmatrix} 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 \\ 0 &amp; 2 &amp; 0 \end{bmatrix} \begin{matrix} \leftarrow \text{The (无需求)} \\ \leftarrow \text{cat (无需求)} \\ \leftarrow \text{sat (有需求)} \end{matrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">The (</span><span class="mord cjk_fallback">无需求</span><span class="mord">)</span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">cat (</span><span class="mord cjk_fallback">无需求</span><span class="mord">)</span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">sat (</span><span class="mord cjk_fallback">有需求</span><span class="mord">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mspace width="1em"/><mo>→</mo><mspace width="1em"/><msup><mi>K</mi><mi>T</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">K = \begin{bmatrix} 0 &amp; 0 &amp; 0 \\ 0 &amp; 2 &amp; 0 \\ 0 &amp; 0 &amp; 0 \end{bmatrix} \quad \rightarrow \quad K^T = \begin{bmatrix} 0 &amp; 0 &amp; 0 \\ 0 &amp; 2 &amp; 0 \\ 0 &amp; 0 &amp; 0 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8413em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>The 的货</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>cat 的货</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>sat 的货</mtext></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">V = \begin{bmatrix} 1 &amp; 0 &amp; 0 \\ 0 &amp; 2 &amp; 0 \\ 0 &amp; 0 &amp; 2 \end{bmatrix} \begin{matrix} \leftarrow \text{The 的货} \\ \leftarrow \text{cat 的货} \\ \leftarrow \text{sat 的货} \end{matrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">The </span><span class="mord cjk_fallback">的货</span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">cat </span><span class="mord cjk_fallback">的货</span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">sat </span><span class="mord cjk_fallback">的货</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p>根据公式计算 scores</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Scores</mtext><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold">4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\text{Scores} = \begin{bmatrix} 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 \\ 0 &amp; \mathbf{4} &amp; 0 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord text"><span class="mord">Scores</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathbf">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Masked</mtext><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>+</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold">4</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\text{Masked} = \begin{bmatrix} 0 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 0 \\ 0 &amp; 4 &amp; 0 \end{bmatrix} + \begin{bmatrix} 0 &amp; -\infty &amp; -\infty \\ 0 &amp; 0 &amp; -\infty \\ 0 &amp; 0 &amp; 0 \end{bmatrix} = \begin{bmatrix} 0 &amp; -\infty &amp; -\infty \\ 0 &amp; 0 &amp; -\infty \\ 0 &amp; \mathbf{4} &amp; 0 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord text"><span class="mord">Masked</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathbf">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p>softmax 后结果</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold">0.08</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold">0.84</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold">0.08</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>The</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>cat</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mrow><mi mathvariant="bold">s</mi><mi mathvariant="bold">a</mi><mi mathvariant="bold">t</mi></mrow><mtext> (聚焦 cat)</mtext></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">A = \begin{bmatrix} 1.0 &amp; 0 &amp; 0 \\ 0.5 &amp; 0.5 &amp; 0 \\ \mathbf{0.08} &amp; \mathbf{0.84} &amp; \mathbf{0.08} \end{bmatrix} \begin{matrix} \leftarrow \text{The} \\ \leftarrow \text{cat} \\ \leftarrow \mathbf{sat} \text{ (聚焦 cat)} \end{matrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1.0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0.5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathbf">0.08</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0.5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathbf">0.84</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathbf">0.08</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">The</span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord">cat</span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord"><span class="mord mathbf">sat</span></span><span class="mord text"><span class="mord"> (</span><span class="mord cjk_fallback">聚焦</span><span class="mord"> cat)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p>解释下第三行怎么算的<br/>
公式：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>softmax</mtext><mo stretchy="false">(</mo><mfrac><mtext>Scores</mtext><msqrt><mn>3</mn></msqrt></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{softmax}(\frac{\text{Scores}}{\sqrt{3}})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.4103em;vertical-align:-0.538em;"/><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.551em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9128em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mtight" style="padding-left:0.833em;"><span class="mord mtight">3</span></span></span><span style="top:-2.8728em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail mtight" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1272em;"><span/></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">Scores</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.538em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span></span></span></span></span>。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mn>3</mn></msqrt><mo>≈</mo><mn>1.73</mn></mrow><annotation encoding="application/x-tex">\sqrt{3} \approx 1.73</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1328em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9072em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord">3</span></span></span><span style="top:-2.8672em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1328em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1.73</span></span></span></span></span>。</p>
<ul>
<li>cat 得分: <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mi mathvariant="normal">/</mi><mn>1.73</mn><mo>≈</mo><mn>2.3</mn></mrow><annotation encoding="application/x-tex">4 / 1.73 \approx 2.3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">4/1.73</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2.3</span></span></span></span></span></li>
<li>The/sat 得分: <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mn>2.3</mn></msup><mo>≈</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">e^{2.3} \approx 10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2.3</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">10</span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mn>0</mn></msup><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">e^0 = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>。</li>
<li>概率: <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mn>10</mn><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo><mo>≈</mo><mn>0.84</mn></mrow><annotation encoding="application/x-tex">10 / (1+10+1) \approx 0.84</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">10/</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">10</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.84</span></span></span></span></span></li>
</ul>
<p>所以是 [0.08,0.84,0.08]</p>
<p>最后计算 Z 矩阵(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><mi>A</mi><mo>×</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">Z = A \times V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>)</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.5</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1.0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold">0.08</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold">1.68</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn mathvariant="bold">0.16</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>输出给下一层的 The</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>输出给下一层的 cat</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>←</mo><mtext>输出给下一层的 sat</mtext></mrow></mstyle></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">Z = \begin{bmatrix} 1.0 &amp; 0 &amp; 0 \\ 0.5 &amp; 1.0 &amp; 0 \\ \mathbf{0.08} &amp; \mathbf{1.68} &amp; \mathbf{0.16} \end{bmatrix} \begin{matrix} \leftarrow \text{输出给下一层的 The} \\ \leftarrow \text{输出给下一层的 cat} \\ \leftarrow \text{输出给下一层的 sat} \end{matrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1.0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0.5</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathbf">0.08</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1.0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathbf">1.68</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathbf">0.16</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord cjk_fallback">输出给下一层的</span><span class="mord"> The</span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord cjk_fallback">输出给下一层的</span><span class="mord"> cat</span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord text"><span class="mord cjk_fallback">输出给下一层的</span><span class="mord"> sat</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p>至此初始值 X 向量经过 MHA 后变为了 Z 向量，可以看到 sat 的原始向量向 cat 倾斜了。</p>
<p>32 个头同时这么进行，每个头都会得到一个 Z 向量结果，取最后一行的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mrow><mi>c</mi><mi>a</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Z_{cat}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 把他们全部拼接起来，又变成了一个形状为 [1,4096] 的向量。（推理是只用最后一个 token，训练都用了）</p>
<p>但向量的 0<del>128 位是头 1 的表示的是语法，头 2 的 128</del>256 位表示位置等等，一直到头 32，最终需要再乘以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>o</mi></msub></mrow><annotation encoding="application/x-tex">W_o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 矩阵，把这些独立的信息融为一体，得到最终的结果。</p>
<p>这就是 MHA 的全部过程。</p>
<h4 data-id="heading-6">FFN</h4>
<p>Z 经过残差连接和层归一化后，进入 FFN。</p>
<p>FFN 里面有两个在阶段二训练好的矩阵，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">W_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">W_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">W_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 是升维矩阵，形状是 [d_modle, 4<em>d_modle]，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">W_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 是降维矩阵，形状是 [4</em>d_modle,d_modle]。</p>
<p>假设 Z 已经完成残差连接和层归一化，乘以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">W_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 矩阵</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>H</mi><mrow><mi>u</mi><mi>p</mi></mrow></msub><mo>=</mo><msub><mi>Z</mi><mrow><mi>s</mi><mi>a</mi><mi>t</mi></mrow></msub><mo>×</mo><msub><mi>W</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">H_{up} = Z_{sat} \times W_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0813em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p>升维后有更多更细节的信息，比如 Apple 这个 token 升维前的向量是 <code>x = [0.8, 0.1, 0.5]</code> 分别代码是水果，是公司，是红色的。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">W_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 就像包含 6 个问题的问卷：</p>
<ul>
<li>是电子产品吗？</li>
<li>是红色的吗？</li>
<li>能吃吗？</li>
<li>是交通工具吗？</li>
<li>有毛吗？</li>
<li>是液体吗？</li>
</ul>
<p>计算 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo>=</mo><mi>x</mi><mo>×</mo><msub><mi>W</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">H = x \times W_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>：</p>
<p>结果向量（6维）可能是这样的：</p>
<p>[10, 8, 9, -5, -10, -2]</p>
<ul>
<li><strong>10 (是电子产品):</strong> 命中！</li>
<li><strong>8 (是红色的):</strong> 命中！</li>
<li><strong>9 (能吃):</strong> 命中！</li>
<li><strong>-5 (是交通工具):</strong> 完全不是，负分！</li>
<li><strong>-10 (有毛):</strong> 负分滚粗！</li>
<li><strong>-2 (是液体):</strong> 不太像。</li>
</ul>
<p>然后经过 ReLU 激活函数处理，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x) = \max(0, x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">max</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></span>，把小于 0 的置位 0，结果就变成了 [10, 8, 9, 0, 0, 0]。</p>
<p>再通过 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">W_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 把结果压缩回去，去掉无用信息，比如变成了 [5.0, 2.0, 8.0]。</p>
<p>再把这个值做一道残差连接，整个 Layer 层执行结束，把结果作为输入传给下一个 Layer 层。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PAI Physical AI Notebook详解3：基于仿真的导航模型训练]]></title>    <link>https://juejin.cn/post/7574045294611808291</link>    <guid>https://juejin.cn/post/7574045294611808291</guid>    <pubDate>2025-11-19T08:38:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574045294611808291" data-draft-id="7573864324713676852" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PAI Physical AI Notebook详解3：基于仿真的导航模型训练"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-19T08:38:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PAI Physical AI Notebook详解3：基于仿真的导航模型训练
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T08:38:07.000Z" title="Wed Nov 19 2025 08:38:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前两期，我们已经分别基于仿真环境和世界模型进行了针对Manipulation（动作控制）模型的训练数据合成与模仿学习。我们来回顾下整个过程：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5397c9718de04142955000b58f3c7ad4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=n4xww8psEFf01%2Bfd5XpY%2F2wRtpI%3D" alt="image.png" loading="lazy"/></p>
<p>针对具身智能场景，除了Manipution，Navigation（导航）也是一类非常重要的控制模型，本期我们就来详细解读基于仿真环境的导航模型训练的全过程。</p>
<p>和动作控制模型类似，对导航模型的训练也可以通过人工演示、数据扩增、数据增强、模仿学习和模型测评几个环节来进行。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71911d95af9b4c4b8f3b46064a2f76b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=T5i%2Fk07CoCwxWxqVqve2SnzZeAg%3D" alt="image.png" loading="lazy"/></p>
<p>但是相比动作控制模型，导航模型的训练过程有以下特点：</p>
<ul>
<li>人工演示相对简单，只需要在二维平面上控制运动方向即可</li>
<li>数据扩增相对简单，因为二维平面上仅有2个自由度</li>
<li>运动控制的目标更复杂，不再是完成先验的特定动作，而是到达一个随机指定的坐标</li>
<li>基于上述第3点的原因，对导航模型的测评也更加复杂，需要结合仿真环境和模型推理进行在环验证</li>
</ul>
<p>在PAI的Notebook Gallery中，我们已经预置了一个最佳实践，就是这个过程的一个具体示例：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgallery.pai-ml.com%2F%23%2Fpreview%2FdeepLearning%2Fcv%2Fisaac_sim_wf3" target="_blank" title="https://gallery.pai-ml.com/#/preview/deepLearning/cv/isaac_sim_wf3" ref="nofollow noopener noreferrer">gallery.pai-ml.com/#/preview/d…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c11167d6ff314fc3ab91914c91432214~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=y2u8pNBhVVJMNOZx4MsJ8itG8cg%3D" alt="image.png" loading="lazy"/></p>
<p>下面我们来详细解读这个示例。</p>
<h2 data-id="heading-0">使用Isaac Asset公共数据集</h2>
<p>由于导航模型的训练需要一个比较复杂的3D场景，在PAI的公共数据集中已经内置了一个数据集，包含了一些3D场景：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61ecbcbc24c246ed9b2cadcccc46abde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=um1SKZqoToanT73tg4OLcpx2MM0%3D" alt="image.png" loading="lazy"/></p>
<p>在启动用于人工演示的DSW时，除了选择资源类型、自定义数据集，还可以选择这个公共数据集，方便后续的场景构建
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/faf56c4892d44a9d9a20aca76d8484fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=mhADkGkjnykMU99jNj8%2BPBpU%2F%2FI%3D" alt="image.png" loading="lazy"/></p>
<p>这样，DSW启动后，就可以看到这个公共数据集：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/968d70820ee646899dee5c3a4b2f8b42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=FBcFJuZt9I8en2RQJ5VYxyQbWIE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">人工少量演示</h2>
<h3 data-id="heading-2">加载场景</h3>
<p>接下来，我们在这个DSW中，通过livestream启动Isaac Sim环境：</p>
<pre><code class="hljs language-python" lang="python">export ACCEPT_EULA=Y
PUBLIC_IP=$(curl -s ifconfig.me) &amp;&amp; /isaac-sim/runheadless.sh --/persistent/isaac/asset_root/default=<span class="hljs-string">"/mnt/data/isaac_tmp/isaac_asset/Assets/Isaac/5.0"</span> --/app/livestream/publicEndpointAddress=$PUBLIC_IP --/app/livestream/port=<span class="hljs-number">49100</span>
</code></pre>
<p>即可在Isaac Sim中通过Isaac Asset公共数据集加载导航模型将要运行的场景：</p>
<p>（场景目录：/mnt/isaac_assets/5.0/Isaac/Environments/Simple_Warehouse/warehouse_multiple_shelves.usd）
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2e8bc794ae84b77ba3c63d5d3e22621~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=ghCpSqB07zF%2B068TrC4UNFLY%2Bo0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">创建Occupancy Map</h3>
<p>接下来我们需要为这个场景创建Occupancy Map，这样MobilityGen就知道机器人在哪里可以移动。</p>
<ol>
<li>选择 Tools &gt; Robotics &gt; Occupancy Map 打开占用地图扩展</li>
<li>在占用地图窗口中设置参数：<br/>
Origin: X=2.0, Y=0.0, Z=0.0<br/>
Upper Bound: X=10.0, Y=20.0, Z=2.0<br/>
Lower Bound: X=-14.0, Y=-18.0, Z=0.1</li>
<li>点击 <code>Calculate</code> 生成占用地图</li>
<li>点击 Visualize Image 查看占用地图</li>
<li>在可视化窗口中选择 Rotate Image: 180</li>
<li>选择 Coordinate Type: ROS Occupancy Map Parameters File YAML</li>
<li>点击 Regenerate Image</li>
<li>复制生成的YAML文本</li>
<li>创建文件 <code>~/MobilityGenData/maps/warehouse_multiple_shelves/map.yaml</code></li>
<li>粘贴YAML内容并修改 <code>image: warehouse_multiple_shelves.png</code> 为 <code>image: map.png</code></li>
<li>保存文件</li>
<li>在可视化窗口中点击 Save Image，在<code>/root/MobilityGenData/maps/warehouse_multiple_shelves</code>下保存为 <code>map.png</code>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a5e54b7938e47fb832785524cfde448~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=2UoOWWQ1lWASC6ZUl7wntiv5Mts%3D" alt="image.png" loading="lazy"/></li>
</ol>
<h3 data-id="heading-4">启动MobilityGen插件</h3>
<p>按照下列操作启动MobilityGen插件：</p>
<ol>
<li>导航到 Window &gt; Extensions</li>
<li>搜索 MobilityGen UI</li>
<li>点击切换开关启用扩展</li>
<li>您应该看到两个窗口：MobilityGen UI和占用地图可视化窗口
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26d357875f0547fcbe441166587c5821~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=ZdX6htAh5eU0L%2Feniwr%2F%2FaBSKWM%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f8f3331980c44049008448321f02ac5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=3w73GtHLrlUrUGGXO5jRox4y2UA%3D" alt="image.png" loading="lazy"/></li>
</ol>
<p>在MobilityGen窗口中设置以下参数：</p>
<ol>
<li>
<p><strong>Stage</strong>: 粘贴仓库USD路径</p>
<pre><code class="hljs language-plaintext" lang="plaintext">/mnt/isaac_assets/5.0/Isaac/Environments/Simple_Warehouse/warehouse_multiple_shelves.usd
</code></pre>
</li>
<li>
<p><strong>Occupancy Map</strong>: 输入之前创建的map.yaml文件路径</p>
<pre><code class="hljs language-plaintext" lang="plaintext">~/MobilityGenData/maps/warehouse_multiple_shelves/map.yaml
</code></pre>
</li>
<li>
<p><strong>Robot</strong>: 选择 <strong>CarterRobot</strong></p>
</li>
<li>
<p><strong>Scenario</strong>: 选择 <strong>KeyboardTeleoperationScenario</strong>（可选：如果您想自动生成数据，请选择 <strong>RandomPathFollowingScenario</strong>）</p>
</li>
<li>
<p>点击 <strong>Build</strong></p>
</li>
</ol>
<h3 data-id="heading-5">录制轨迹</h3>
<ol>
<li>点击 <strong>Start recording</strong> 开始记录日志</li>
<li>移动机器人（如您选取<strong>KeyboardTeleoperationScenario</strong>）</li>
<li>点击 <strong>Stop recording</strong> 停止记录</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.video.taobao.com%2Fvod%2FFZuzlx0k-G4EEVTb4lFDJm4VbzqbLDd8ae5Qcin4t1o.mp4" target="_blank" title="https://cloud.video.taobao.com/vod/FZuzlx0k-G4EEVTb4lFDJm4VbzqbLDd8ae5Qcin4t1o.mp4" ref="nofollow noopener noreferrer">视频演示&gt;&gt;</a></p>
<p>数据现在记录到 <code>~/MobilityGenData/recordings</code> 目录中。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbc68468c0d94335b6d455b1f444a57d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=isIEU9kIVc4Ns449A%2Fb2awt3gfs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">重放生成视频</h3>
<p>然后使用Isaac Sim提供的 <code>replay_directory.py</code> Python脚本重放场景：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /isaac-sim &amp;&amp; \
/isaac-sim/python.sh standalone_examples/replicator/mobility_gen/replay_directory.py --render_interval 10 --<span class="hljs-built_in">enable</span> isaacsim.replicator.mobility_gen.examples
</code></pre>
<p>脚本完成后，重放渲染的图像和传感器数据会被保存到 <code>~/MobilityGenData/replays</code>路径下
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcdd07c0b72d41ae82aaa35a9c16a892~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=XUFCn0FINbO%2F3vGMC1gXkYBAzPk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-7">数据增强</h2>
<p>我们使用Cosmos-Transfer1-7B模型来增强采集到的图像数据。在PAI-ModelGallery中已经集成了这个模型的部署方案：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4832a98022d74b2e8a3f317c4cc5b1e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=T2hS47LPKPHY2qjv7wpV4d5RFO0%3D" alt="image.png" loading="lazy"/></p>
<p>完成模型部署后，可以使用如下脚本来对图像数据进行增强：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> cv2
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">import</span> shutil
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> gradio_client.client <span class="hljs-keyword">as</span> gradio_client
<span class="hljs-keyword">import</span> gradio_client.utils <span class="hljs-keyword">as</span> gradio_utils  

<span class="hljs-comment"># 定义Cosmos服务URL和Token</span>
<span class="hljs-comment"># COSMOS_SERVICE_URL = "http://xxxxxx"  # 请替换为实际服务URL</span>
<span class="hljs-comment"># EAS_TOKEN = "your_eas_token"  # 请替换为实际EAS Token</span>

RGB_TARGETS = [
    <span class="hljs-string">"state/rgb/robot.front_camera.left.rgb_image"</span>,
    <span class="hljs-string">"state/rgb/robot.front_camera.right.rgb_image"</span>,
]

<span class="hljs-comment"># --- 模块1: 图像序列转视频 ---</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_sequence_to_video</span>(<span class="hljs-params">input_dir: Path, output_path: Path, fps: <span class="hljs-built_in">int</span>, image_format: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - Converting to video: <span class="hljs-subst">{input_dir.name}</span> (Format: <span class="hljs-subst">{image_format}</span>)"</span>)
    image_files = <span class="hljs-built_in">sorted</span>(<span class="hljs-built_in">list</span>(input_dir.glob(<span class="hljs-string">f'*.<span class="hljs-subst">{image_format}</span>'</span>)))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> image_files:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    -&gt; No '<span class="hljs-subst">{image_format}</span>' images found. Skipping."</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-keyword">try</span>:
        first_img = cv2.imread(<span class="hljs-built_in">str</span>(image_files[<span class="hljs-number">0</span>]))
        <span class="hljs-keyword">if</span> first_img <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>: <span class="hljs-keyword">raise</span> IOError(<span class="hljs-string">"Cannot read the first image."</span>)
        height, width = first_img.shape[:<span class="hljs-number">2</span>]
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    -&gt; Error reading first image: <span class="hljs-subst">{e}</span>. Skipping."</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    output_path.parent.mkdir(parents=<span class="hljs-literal">True</span>, exist_ok=<span class="hljs-literal">True</span>)
    fourcc = cv2.VideoWriter_fourcc(*<span class="hljs-string">'mp4v'</span>)
    out = cv2.VideoWriter(<span class="hljs-built_in">str</span>(output_path), fourcc, fps, (width, height))
    <span class="hljs-keyword">for</span> image_file <span class="hljs-keyword">in</span> image_files:
        frame = cv2.imread(<span class="hljs-built_in">str</span>(image_file))
        <span class="hljs-keyword">if</span> frame <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            out.write(frame)
    out.release()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    -&gt; Video created: <span class="hljs-subst">{output_path}</span>"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-comment"># --- 新模块: 视频转图像序列 ---</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">split_video_to_frames</span>(<span class="hljs-params">video_path: Path, output_dir: Path, original_image_dir: Path, image_format: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""
    将视频文件拆分为一帧帧的图片，并使用原始图片的文件名进行命名。
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - Splitting video back to frames: <span class="hljs-subst">{video_path.name}</span>"</span>)
    
    <span class="hljs-comment"># 1. 获取原始文件名作为模板</span>
    original_image_files = <span class="hljs-built_in">sorted</span>(<span class="hljs-built_in">list</span>(original_image_dir.glob(<span class="hljs-string">f'*.<span class="hljs-subst">{image_format}</span>'</span>)))
    original_filenames = [p.name <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> original_image_files]
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> original_filenames:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    -&gt; Warning: Could not find original images in <span class="hljs-subst">{original_image_dir}</span> to use for naming. Skipping frame splitting."</span>)
        <span class="hljs-keyword">return</span>

    <span class="hljs-comment"># 2. 准备输出目录</span>
    output_dir.mkdir(parents=<span class="hljs-literal">True</span>, exist_ok=<span class="hljs-literal">True</span>)
    
    <span class="hljs-comment"># 3. 打开视频文件并逐帧读取</span>
    cap = cv2.VideoCapture(<span class="hljs-built_in">str</span>(video_path))
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> cap.isOpened():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    -&gt; Error: Could not open video file <span class="hljs-subst">{video_path}</span>. Skipping."</span>)
        <span class="hljs-keyword">return</span>

    frame_index = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        ret, frame = cap.read()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ret:
            <span class="hljs-keyword">break</span>  <span class="hljs-comment"># 视频结束</span>

        <span class="hljs-keyword">if</span> frame_index &lt; <span class="hljs-built_in">len</span>(original_filenames):
            <span class="hljs-comment"># 使用原始文件名来保存新帧</span>
            output_filepath = output_dir / original_filenames[frame_index]
            cv2.imwrite(<span class="hljs-built_in">str</span>(output_filepath), frame)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 如果视频帧数多于原始图片数，则停止，避免命名冲突</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    -&gt; Warning: Video contains more frames than original image sequence. Stopping at frame <span class="hljs-subst">{frame_index}</span>."</span>)
            <span class="hljs-keyword">break</span>
        
        frame_index += <span class="hljs-number">1</span>

    cap.release()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    -&gt; Success! <span class="hljs-subst">{frame_index}</span> frames saved to: <span class="hljs-subst">{output_dir}</span>"</span>)

<span class="hljs-comment"># --- 模块2: 调用Cosmos服务 ---</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">cosmos_sync_with_upload</span>(<span class="hljs-params">client, rgb_video_path, seg_video_path, output_dir, original_rgb_dir</span>):
    <span class="hljs-string">"""上传视频，调用API，下载结果，并触发视频到帧的转换。"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_file</span>(<span class="hljs-params">filepath: Path</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> filepath <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> filepath.exists(): <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - Uploading: <span class="hljs-subst">{filepath.name}</span>"</span>)
        file_desc = gradio_utils.handle_file(<span class="hljs-built_in">str</span>(filepath))
        result_str = client.predict(file_desc, api_name=<span class="hljs-string">"/upload_file"</span>)
        <span class="hljs-keyword">return</span> json.loads(result_str).get(<span class="hljs-string">"path"</span>)

    remote_rgb_path = upload_file(rgb_video_path)
    remote_seg_path = upload_file(seg_video_path)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> remote_rgb_path <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> remote_seg_path:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">"视频上传失败"</span>

    request_dict = create_cosmos_request(remote_rgb_path, remote_seg_path)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"  - Sending generation request to Cosmos service..."</span>)
    result = client.predict(json.dumps(request_dict), api_name=<span class="hljs-string">"/generate_video"</span>)
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(result, <span class="hljs-built_in">tuple</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(result) &gt;= <span class="hljs-number">2</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(result[<span class="hljs-number">0</span>], <span class="hljs-built_in">dict</span>):
        video_path = result[<span class="hljs-number">0</span>].get(<span class="hljs-string">"video"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> video_path:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">f"API did not return a video path. Message: <span class="hljs-subst">{result[<span class="hljs-number">1</span>]}</span>"</span>

        output_file = Path(output_dir) / <span class="hljs-string">f"<span class="hljs-subst">{rgb_video_path.stem}</span>_cosmos_enhanced.mp4"</span>
        
        <span class="hljs-comment"># 统一处理下载或复制的逻辑</span>
        success = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> video_path.startswith((<span class="hljs-string">"http://"</span>, <span class="hljs-string">"https://"</span>)):
            <span class="hljs-keyword">try</span>:
                resp = requests.get(video_path, stream=<span class="hljs-literal">True</span>, timeout=<span class="hljs-number">300</span>)
                resp.raise_for_status()
                <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(output_file, <span class="hljs-string">"wb"</span>) <span class="hljs-keyword">as</span> f: shutil.copyfileobj(resp.raw, f)
                success = <span class="hljs-literal">True</span>
            <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">f"Failed to download video: <span class="hljs-subst">{e}</span>"</span>
        <span class="hljs-keyword">else</span>:
            source_path = Path(video_path)
            <span class="hljs-keyword">if</span> source_path.exists():
                shutil.copy2(source_path, output_file)
                success = <span class="hljs-literal">True</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">f"API returned a local path that does not exist: <span class="hljs-subst">{video_path}</span>"</span>

        <span class="hljs-keyword">if</span> success:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  -&gt; Augmented video saved to: <span class="hljs-subst">{output_file}</span>"</span>)
            <span class="hljs-comment"># 定义新帧的输出目录，例如 .../robot.front_camera.left.rgb_image_cosmos</span>
            new_frames_output_dir = original_rgb_dir.parent / <span class="hljs-string">f"<span class="hljs-subst">{original_rgb_dir.name}</span>_cosmos"</span>
            split_video_to_frames(
                video_path=output_file,
                output_dir=new_frames_output_dir,
                original_image_dir=original_rgb_dir,
                image_format=<span class="hljs-string">"jpg"</span>  <span class="hljs-comment"># RGB图像的原始格式</span>
            )
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-built_in">str</span>(output_file)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">"Failed to retrieve the generated video file."</span>
            
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-string">f"Unexpected API response format: <span class="hljs-subst">{result}</span>"</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_cosmos_request</span>(<span class="hljs-params">remote_rgb_path, remote_seg_path</span>):
    <span class="hljs-string">"""动态创建Cosmos请求，包含主视频和分割视频的远程路径。"""</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"A realistic warehouse environment with consistent lighting, perspective, and camera motion. Preserve the original structure, object positions, and layout from the input video. Ensure the output exactly matches the segmentation video frame-by-frame in timing and content. Camera movement must follow the original path precisely."</span>,
        <span class="hljs-string">"negative_prompt"</span>: <span class="hljs-string">"The video captures a game playing, with bad crappy graphics and cartoonish frames. It represents a recording of old outdated games. The images are very pixelated and of poor CG quality. There are many subtitles in the footage. Overall, the video is unrealistic and appears cg. Plane background."</span>,
        <span class="hljs-string">"sigma_max"</span>: <span class="hljs-number">80</span>,
        <span class="hljs-string">"guidance"</span>: <span class="hljs-number">7</span>,
        <span class="hljs-string">"input_video_path"</span>: remote_rgb_path, <span class="hljs-comment"># 主视频路径</span>
        <span class="hljs-string">"blur_strength"</span>: <span class="hljs-string">"low"</span>,
        <span class="hljs-string">"canny_threshold"</span>: <span class="hljs-string">"low"</span>,
        <span class="hljs-string">"edge"</span>: {<span class="hljs-string">"control_weight"</span>: <span class="hljs-number">0.3</span>},
        <span class="hljs-string">"seg"</span>: {
            <span class="hljs-string">"control_weight"</span>: <span class="hljs-number">1.0</span>,
            <span class="hljs-string">"input_control"</span>: remote_seg_path <span class="hljs-comment"># 分割视频路径</span>
        }
    }

<span class="hljs-comment"># --- 模块3: 主工作流控制器 ---</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_and_augment_replays</span>(<span class="hljs-params">output_dir: <span class="hljs-built_in">str</span>, fps: <span class="hljs-built_in">int</span> = <span class="hljs-number">30</span></span>):
    source_root = Path(<span class="hljs-string">"/root/MobilityGenData/replays"</span>)
    output_root = Path(output_dir)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> source_root.is_dir(): <span class="hljs-keyword">return</span>
    timestamp_dirs = [d <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> source_root.iterdir() <span class="hljs-keyword">if</span> d.is_dir()]
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> timestamp_dirs: <span class="hljs-keyword">return</span>
    
    client = gradio_client.Client(COSMOS_SERVICE_URL, hf_token=EAS_TOKEN)

    <span class="hljs-keyword">for</span> ts_dir <span class="hljs-keyword">in</span> timestamp_dirs:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\nProcessing replay: <span class="hljs-subst">{ts_dir.name}</span>"</span>)
        final_output_dir = output_root / ts_dir.name
        final_output_dir.mkdir(exist_ok=<span class="hljs-literal">True</span>)
        
        <span class="hljs-keyword">for</span> rgb_rel_path_str <span class="hljs-keyword">in</span> RGB_TARGETS:
            rgb_image_dir = ts_dir / rgb_rel_path_str
            seg_rel_path_str = rgb_rel_path_str.replace(<span class="hljs-string">"rgb"</span>, <span class="hljs-string">"segmentation"</span>)
            seg_image_dir = ts_dir / seg_rel_path_str
            
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (rgb_image_dir.is_dir() <span class="hljs-keyword">and</span> seg_image_dir.is_dir()):
                <span class="hljs-keyword">continue</span>
            
            rgb_video_path = final_output_dir / <span class="hljs-string">f"<span class="hljs-subst">{rgb_image_dir.name}</span>.mp4"</span>
            seg_video_path = final_output_dir / <span class="hljs-string">f"<span class="hljs-subst">{seg_image_dir.name}</span>.mp4"</span>
            
            rgb_ok = convert_sequence_to_video(rgb_image_dir, rgb_video_path, fps, <span class="hljs-string">"jpg"</span>)
            seg_ok = convert_sequence_to_video(seg_image_dir, seg_video_path, fps, <span class="hljs-string">"png"</span>)
            
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (rgb_ok <span class="hljs-keyword">and</span> seg_ok):
                <span class="hljs-keyword">continue</span>

            cosmos_sync_with_upload(
                client, 
                rgb_video_path, 
                seg_video_path, 
                final_output_dir,
                original_rgb_dir=rgb_image_dir
            )

    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">20</span> + <span class="hljs-string">" 全部处理完成 "</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">20</span>)

<span class="hljs-comment"># --- 程序入口 ---</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    !mkdir -p /root/MobilityGenData/cosmos_augmented_videos
    output_directory = <span class="hljs-string">"/root/MobilityGenData/cosmos_augmented_videos"</span>
    process_and_augment_replays(output_dir=output_directory)
</code></pre>
<p>以下是两段数据增强前后的视频数据，作为对比：</p>
<p>增强前
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.video.taobao.com%2Fvod%2F0nkgzuEMsC7zGPY0jivLOgJSMd5ojDoigOUS14L9H9c.mp4" target="_blank" title="https://cloud.video.taobao.com/vod/0nkgzuEMsC7zGPY0jivLOgJSMd5ojDoigOUS14L9H9c.mp4" ref="nofollow noopener noreferrer">视频演示&gt;&gt;</a></p>
<p>增强后
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.video.taobao.com%2Fvod%2FKIS5xt9rjZubBfL5Y6Tqbk0nY2FeC5qwprEtYNJMBNs.mp4" target="_blank" title="https://cloud.video.taobao.com/vod/KIS5xt9rjZubBfL5Y6Tqbk0nY2FeC5qwprEtYNJMBNs.mp4" ref="nofollow noopener noreferrer">视频演示&gt;&gt;</a></p>
<h2 data-id="heading-8">模仿学习</h2>
<p>这里选择NVLab的开源模型X-Mobility（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FNVlabs%2FX-Mobility" target="_blank" title="https://github.com/NVlabs/X-Mobility" ref="nofollow noopener noreferrer">github.com/NVlabs/X-Mo…</a>）作为基模，进行模仿学习。</p>
<p>可以使用以下脚本，启动DLC进行分布式训练：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">from</span> alibabacloud_tea_openapi.models <span class="hljs-keyword">import</span> Config
<span class="hljs-keyword">from</span> alibabacloud_credentials.client <span class="hljs-keyword">import</span> Client <span class="hljs-keyword">as</span> CredClient
<span class="hljs-keyword">from</span> alibabacloud_credentials.models <span class="hljs-keyword">import</span> Config <span class="hljs-keyword">as</span> CredConfig
<span class="hljs-keyword">from</span> alibabacloud_pai_dlc20201203.client <span class="hljs-keyword">import</span> Client <span class="hljs-keyword">as</span> DLCClient
<span class="hljs-keyword">from</span> alibabacloud_pai_dlc20201203.models <span class="hljs-keyword">import</span> (
    CreateJobRequest,
    GetJobRequest,
)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">wait_for_job_to_terminate</span>(<span class="hljs-params">client, job_id</span>):
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        job = client.get_job(job_id, GetJobRequest()).body
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'job({}) is {}'</span>.<span class="hljs-built_in">format</span>(job_id, job.status))
        <span class="hljs-keyword">if</span> job.status <span class="hljs-keyword">in</span> (<span class="hljs-string">'Succeeded'</span>, <span class="hljs-string">'Failed'</span>, <span class="hljs-string">'Stopped'</span>):
            <span class="hljs-keyword">return</span> job.status
        time.sleep(<span class="hljs-number">5</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    current_time_tuple = time.localtime()
    year = current_time_tuple.tm_year
    month = current_time_tuple.tm_mon
    day = current_time_tuple.tm_mday
    hour = current_time_tuple.tm_hour
    minute = current_time_tuple.tm_min
    <span class="hljs-comment"># 请确认您的主账号已授权DLC，且拥有足够的权限。</span>
    display_name = <span class="hljs-string">f"train_xmobility_for_isaac_<span class="hljs-subst">{day}</span>_<span class="hljs-subst">{hour}</span>-<span class="hljs-subst">{minute}</span>"</span>  <span class="hljs-comment">#设置任务名称 </span>
    region_id = os.environ.get(<span class="hljs-string">"dsw_region"</span>) <span class="hljs-comment">#设置regionid</span>
    workspace_id = os.environ.get(<span class="hljs-string">'PAI_WORKSPACE_ID'</span>) <span class="hljs-comment">#设置成用户自己的工作空间id</span>
    image_uri = <span class="hljs-string">f"dsw-registry.<span class="hljs-subst">{region_id}</span>.cr.aliyuncs.com/pai-training-algorithm/isaac-sim:x-mobility-v10"</span> <span class="hljs-comment">#使用官方镜像</span>
    ecs_spec = <span class="hljs-string">"ecs.gn8v-4x.8xlarge"</span>     <span class="hljs-comment">#</span>
    <span class="hljs-comment">#########训练任务相关配置#############</span>
    <span class="hljs-comment"># 样例数据集设置</span>
    <span class="hljs-comment"># data_type = 'pqt'</span>
    <span class="hljs-comment"># dataset1_dir = "/mnt/data/notebook3/x_mobility_isaac_sim_random_160k/data"</span>
    <span class="hljs-comment"># dataset2_dir = "/mnt/data/notebook3/x_mobility_isaac_sim_nav2_100k/data"</span>
    <span class="hljs-comment"># output_dir = "/mnt/data/notebook3/sample_output"</span>
    <span class="hljs-comment"># 样例cosmos数据集设置</span>
    data_type = <span class="hljs-string">'pqt'</span>
    dataset1_dir = <span class="hljs-string">"/mnt/data/notebook3/x_mobility_isaac_sim_random_160k_cosmos_to_xmob_resized/afm_isaac_sim_random_160k/data"</span>
    dataset2_dir = <span class="hljs-string">"/mnt/data/notebook3/x_mobility_isaac_sim_nav2_100k_cosmos_to_xmob_resized/afm_isaac_sim_nav2_100k/data"</span>
    output_dir = <span class="hljs-string">"/mnt/data/notebook3/sample_cosmos_output"</span>
    <span class="hljs-comment"># mobilitygen数据集设置</span>
    <span class="hljs-comment"># data_type = 'lerobot'</span>
    <span class="hljs-comment"># dataset1_dir = "/mnt/data/notebook3/x_mobility_isaac_sim_mobilitygen"</span>
    <span class="hljs-comment"># dataset2_dir = "/mnt/data/notebook3/x_mobility_isaac_sim_mobilitygen"</span>
    <span class="hljs-comment"># output_dir = "/mnt/data/notebook3/mobilitygen_output"</span>
    <span class="hljs-comment">#########训练任务相关配置#############</span>

    <span class="hljs-comment"># 本示例通过Credentials SDK默认从环境变量中读取AccessKey，来实现身份验证。</span>
    credentialsConfig = CredConfig(
        <span class="hljs-built_in">type</span>=<span class="hljs-string">'credentials_uri'</span>   <span class="hljs-comment"># 选填。若您未配置其他“默认凭据链”访问方式，您无需再显式指定，Credentials SDK会通过uri方式获取临时凭证</span>
    )
    cred = CredClient(credentialsConfig)

    <span class="hljs-comment"># 1. create client;</span>
    dlc_client = DLCClient(
         config=Config(
            credential=cred,
            region_id=region_id,
            endpoint=<span class="hljs-string">'pai-dlc.{}.aliyuncs.com'</span>.<span class="hljs-built_in">format</span>(region_id),
         )
    )
        
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'-------- Create Job ----------'</span>)
    <span class="hljs-comment"># 创建DLC作业。</span>
    create_job_resp = dlc_client.create_job(CreateJobRequest().from_map({
        <span class="hljs-string">'WorkspaceId'</span>: workspace_id,
        <span class="hljs-string">'DisplayName'</span>: display_name,
        <span class="hljs-string">'JobType'</span>: <span class="hljs-string">'PyTorchJob'</span>,
        <span class="hljs-comment"># 'ResourceId': resource_quota_id,</span>
        <span class="hljs-string">'JobSpecs'</span>: [
            {
                <span class="hljs-string">"Type"</span>: <span class="hljs-string">"Master"</span>,
                <span class="hljs-string">"Image"</span>: image_uri,
                <span class="hljs-string">"PodCount"</span>: <span class="hljs-number">1</span>,
                <span class="hljs-string">"EcsSpec"</span>: ecs_spec,
            },
        ],
        <span class="hljs-string">'DataSources'</span>: [
            {
                <span class="hljs-string">"DataSourceId"</span>: dataset_id,
            },
        ],
       <span class="hljs-string">'UserVpc'</span>: {
            <span class="hljs-string">"VpcId"</span>: vpc_id,  <span class="hljs-comment"># 替换为实际 VPC ID</span>
            <span class="hljs-string">"SwitchId"</span>: switch_id,  <span class="hljs-comment"># 替换为实际交换机 ID</span>
            <span class="hljs-string">"SecurityGroupId"</span>: security_groupid  <span class="hljs-comment"># 替换为实际安全组 ID</span>
        },
        <span class="hljs-string">"UserCommand"</span>: <span class="hljs-string">f" export WANDB_MODE=offline &amp;&amp; \
            export NCCL_NVLS_ENABLE=0 &amp;&amp; \
            cd /workspace &amp;&amp; \
            python3 /train_pai/train_wrapper.py \
            -d <span class="hljs-subst">{dataset1_dir}</span> \
            -o <span class="hljs-subst">{output_dir}</span> \
            --type <span class="hljs-subst">{data_type}</span> \
            --stage 1 &amp;&amp; \
            python3 /train_pai/train_wrapper.py \
            -d <span class="hljs-subst">{dataset2_dir}</span> \
            -o <span class="hljs-subst">{output_dir}</span> \
            --type <span class="hljs-subst">{data_type}</span> \
            --stage 2 &amp;&amp; \
            sleep 30"</span>,
    }))
    job_id = create_job_resp.body.job_id

    wait_for_job_to_terminate(dlc_client, job_id)

    <span class="hljs-keyword">pass</span>


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    main()
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6b34cba99964daaac70da308750baf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=jHvfl28bQe7Vm67UHX%2BJpAFmkxQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">软件在环验证</h2>
<h3 data-id="heading-10">模型格式转换</h3>
<p>使用以下命令将微调得到的X-Mobility模型转换为ONNX格式：</p>
<pre><code class="hljs language-python" lang="python">%cd /X-MOBILITY
<span class="hljs-comment"># 以sample训练结果为例，请更换为自己的训练结果路径</span>
!python3 onnx_conversion.py -p /mnt/data/notebook3/nav2_output/checkpoints/last.ckpt -o /tmp/x_mobility.onnx

<span class="hljs-comment"># 请勿随意更改tensorrt路径，此为X-Mobility默认路径</span>
!python3 trt_conversion.py -o /tmp/x_mobility.onnx -t /tmp/x_mobility.engine
</code></pre>
<h3 data-id="heading-11">部署ROS2</h3>
<p>使用以下脚本部署ROS2环境，以加载X-Mobility模型</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建ros2工作空间文件夹</span>
!mkdir -p ~/ros2_ws/src

<span class="hljs-comment"># 创建符号链接到x_mobility_navigator ROS2包</span>
!ln -s /X-MOBILITY/ros2_deployment/x_mobility_navigator ~/ros2_ws/src/x_mobility_navigator

<span class="hljs-comment"># 构建ROS2工作空间</span>
!cd ~/ros2_ws &amp;&amp; colcon build --symlink-install
</code></pre>
<h3 data-id="heading-12">启动VNC</h3>
<p>X-Mobility模型的软件在环验证使用Isaac Sim + ROS2的组合方案，需要使用VNC以驱动图形化界面。使用以下命令在DSW中启动VNC：</p>
<pre><code class="hljs language-shell" lang="shell">/opt/TurboVNC/bin/vncserver :0 -geometry 4000x3000
</code></pre>
<h3 data-id="heading-13">在Isaac Sim中启用ROS2</h3>
<p>使用如下步骤在Isaac Sim中启动ROS2插件：</p>
<ol>
<li>
<p>进行ROS2预配置</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">source</span> /opt/ros/humble/setup.bash
<span class="hljs-built_in">cd</span> ~/ros2_ws &amp;&amp; <span class="hljs-built_in">source</span> install/setup.bash
<span class="hljs-built_in">source</span> ~/.bashrc

</code></pre>
</li>
<li>
<p>启动Isaac Sim</p>
<pre><code class="hljs language-bash" lang="bash">ACCEPT_EULA=Y /isaac-sim/runapp.sh --/persistent/isaac/asset_root/default=<span class="hljs-string">"/mnt/isaac_assets/5.0"</span>

</code></pre>
</li>
<li>
<p>通过点击<code>Robotics Examples</code> &gt; <code>ROS2</code> &gt; <code>Navigation</code> &gt; <code>Carter Navigation</code> &gt; <code>Load Sample Scene</code> 启动Carter导航示例</p>
</li>
<li>
<p>点击左侧工具栏的<code>Play</code>图标</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d7217e862224a4dbabd009abc7fee22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146287&amp;x-signature=l7%2BcW5%2FL3GPMRC65hiSi6lTobbY%3D" alt="image.png" loading="lazy"/></p>
<p>可以新开一个Terminal测试ROS2连接是否正常工作：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置ROS2环境</span>
<span class="hljs-built_in">source</span> /opt/ros/humble/setup.bash
<span class="hljs-built_in">cd</span> ~/ros2_ws &amp;&amp; <span class="hljs-built_in">source</span> install/setup.bash
<span class="hljs-comment"># 列出可用主题</span>
ros2 topic list

</code></pre>
<p>如果看到以下主题：</p>
<pre><code class="hljs language-bash" lang="bash">/back_stereo_imu/imu
/chassis/imu
/chassis/odom
/clock
/cmd_vel
/front_3d_lidar/lidar_points
/front_stereo_camera/left/camera_info
/front_stereo_camera/left/image_raw
/front_stereo_camera/left/image_raw/nitros_bridge
/front_stereo_imu/imu
/left_stereo_imu/imu
/parameter_events
/right_stereo_imu/imu
/rosout
/tf

</code></pre>
<p>则证明ROS2插件安装成功。</p>
<h3 data-id="heading-14">启动X-Mobility模型</h3>
<p>可以通过以下命令在Terminal中启动X-Mobility Navigator软件：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置构建的工作空间</span>
<span class="hljs-built_in">cd</span> ~/ros2_ws &amp;&amp; <span class="hljs-built_in">source</span> install/setup.bash
<span class="hljs-comment"># 启动X-Mobility导航器</span>
ros2 launch x_mobility_navigator x_mobility_navigator.launch.py

</code></pre>
<p>设置目标姿态：选择<code>2D Goal Pose</code>然后点击地图设置位置/方向。
如果一切正常，应该看到机器人在模拟中向目标位置移动。</p>
<h2 data-id="heading-15">总结</h2>
<p>在本 Notebook 中，我们基于阿里云 PAI 平台的强大功能，完整地演示了使用 Isaac Sim 和 X-Mobility 的通用导航与运动控制工作流，实现了从数据生成、视觉增强到模型训练和仿真部署的端到端流程。</p>
<p>处理流程包括：</p>
<ul>
<li>人工演示: 使用 Isaac Sim 5.0 和 MobilityGen 自动化生成大规模导航演示数据。</li>
<li>数据扩增（可选）：使用MobilityGen的Random轨迹生成功能，可以快速扩增演示数据。</li>
<li>数据增强: 利用 Cosmos-Transfer1 对仿真数据进行风格迁移，提升其真实感和多样性。</li>
<li>模仿学习: 基于生成的数据训练 X-Mobility，一个以世界模型为基础的通用导航与运动控制策略。</li>
<li>软件在环验证: 将训练好的模型通过 ROS2 集成到 Isaac Sim 中，进行端到端的闭环导航验证。</li>
</ul>
<p>通过 Cosmos 增强数据后重新训练的 X-Mobility 模型，在泛化性和鲁棒性上展现了巨大潜力。此工作流为通用机器人导航提供了一套完整的技术方案，显著提升了模型在复杂视觉环境下的泛化能力，并为 Sim2Real 的成功迁移奠定了坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Happy-LLM：从零开始的大语言模型原理与实践教程]]></title>    <link>https://juejin.cn/post/7574230922314285062</link>    <guid>https://juejin.cn/post/7574230922314285062</guid>    <pubDate>2025-11-19T08:44:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574230922314285062" data-draft-id="7574230922314252294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Happy-LLM：从零开始的大语言模型原理与实践教程"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-19T08:44:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Happy-LLM：从零开始的大语言模型原理与实践教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T08:44:04.000Z" title="Wed Nov 19 2025 08:44:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f701f34f207d4cfba043219bf8ee4475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764146643&amp;x-signature=y5ZsL2DXDXx3RxbyhUsfn0J2q74%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">一、项目概述</h2>
<p>《Happy-LLM》项目是一个系统性的 LLM 学习教程的开源项目，旨在帮助学习者深入理解大语言模型的核心原理和训练过程，并能够亲手搭建和训练一个 LLM。</p>
<p>适合大学生、研究人员和 LLM 爱好者阅读，建议具备一定的编程经验（尤其是 Python）和深度学习基础。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdatawhalechina%2Fhappy-llm" target="_blank" title="https://github.com/datawhalechina/happy-llm" ref="nofollow noopener noreferrer">github.com/datawhalech…</a></p>
<hr/>
<h2 data-id="heading-1">二、内容结构</h2>
<p>《Happy-LLM》的内容分为"基础理论"和"实战应用"两大部分，共7章，难度由浅入深。</p>
<h3 data-id="heading-2">第一部分：基础理论</h3>
<ul>
<li>第 1 章：NLP 与 LLM 基础：从分词、词向量讲到PLM发展历程，为 LLM 学习铺垫基础。</li>
<li>第 2 章：Transformer 架构详解：拆解输入层、编码器、解码器、输出层，配合数学公式推导与代码实现，吃透核心原理；</li>
<li>第 3 章：预训练语言模型：整体介绍经典的 PLM，包括 Encoder-Only、Encoder-Decoder 和 Decoder-Only 三种架构，也同时介绍了当前一些主流 LLM 的架构和思想。</li>
<li>第 4 章：LLM特性与训练流程：详细介绍 LLM 的特点和能力，以及大模型“预训练→SFT（有监督微调）→RLHF（人类反馈强化学习）”的全流程。</li>
</ul>
<h3 data-id="heading-3">第二部分：实战应用</h3>
<ul>
<li>第 5 章：LLaMA2 模型实现：手动复现模型结构、训练专属 Tokenizer，完成从 0 到 1 的模型搭建。</li>
<li>第 6 章：LLM 微调技术：对比全参数微调与 LoRA/QLoRA 的优缺点，实战微调 7B 模型并部署推理。</li>
<li>第 7 章：RAG 与 Agent 开发：搭建向量数据库、实现检索增强生成，开发能调用工具的智能体应用。</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、核心学习收获</h2>
<p>通过《Happy-LLM》的学习，你将获得 5 项关键能力，覆盖 LLM 开发的全流程。掌握这些技能，你也能玩转 LLM。</p>
<h3 data-id="heading-5">1. 深入理解 Transformer 架构与注意力机制</h3>
<p>Transformer 是所有现代LLM的基础，教程从原始论文出发，详解其核心模块：</p>
<ul>
<li>词嵌入：将 Token 转为固定维度向量。</li>
<li>位置编码：通过正弦/余弦函数添加序列顺序信息。</li>
<li>多头注意力：并行计算多维度语义关联。</li>
<li>前馈神经网络：特征提取与非线性变换。</li>
</ul>
<p>不仅能看懂架构图，还能手动推导注意力权重计算公式，理解"为什么注意力机制能捕捉长距离依赖。</p>
<h3 data-id="heading-6">2. 掌握预训练语言模型（PLM）的经典架构</h3>
<p>LLM 是预训练语言模型（PLM）的升级版，教程系统梳理了 PLM 的三大经典架构：</p>
<ul>
<li>Encoder-only（如 BERT）：双向注意力，擅长理解类任务（文本分类、实体识别）。</li>
<li>Decoder-only（如 GPT）：单向注意力，擅长生成类任务（文本生成、对话）。</li>
<li>Encoder-Decoder（如 T5）：双向编码+单向解码，擅长翻译、摘要等序列转换任务。</li>
</ul>
<p>理解这些架构的差异，能帮你在实际应用中选择合适的模型底座。</p>
<h3 data-id="heading-7">3. 从零实现LLaMA2模型：亲手搭建你的第一个大模型</h3>
<p>教程的实战核心是带领学习者手动实现 Meta 的 LLaMA2 模型：</p>
<ul>
<li>模型结构定义：Transformer Decoder 层堆叠。</li>
<li>Tokenizer 训练：基于 BPE 算法处理文本。</li>
<li>参数参数初始化、前向传播计算，全程代码可调试。</li>
</ul>
<p>这一步能让你彻底打破对大模型的敬畏心理，理解 LLaMA2 模型的核心模块。</p>
<h3 data-id="heading-8">4. 掌握LLM全流程训练：从预训练到微调</h3>
<p>LLM 训练分为预训练、微调两大阶段：</p>
<ul>
<li>预训练阶段：在海量无标注文本上训练模型，学习语言规律。</li>
<li>微调阶段：通过指令数据（SFT）或人类反馈（RLHF）优化模型输出，使其对齐人类需求。</li>
</ul>
<p>教程不仅讲解原理，还提供工程实践技巧，例如用 LoRA/QLoRA 微调 7B 模型。</p>
<h3 data-id="heading-9">5. 前沿技术落地：RAG、Agent应用开发</h3>
<p>将 LLM 与实际业务结合，聚焦两大前沿应用：</p>
<ul>
<li>RAG（检索增强生成）：通过“文档分块→向量化→向量数据库检索→生成答案”的流程，让LLM能调用外部知识库，解决知识过时幻觉问题；</li>
<li>Agent（智能体）：教模型规划任务、调用工具（如计算器、搜索引擎），实现复杂目标（如“写报告→查数据→可视化”全流程自动化）。</li>
</ul>
<h2 data-id="heading-10">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React源码学习准备工作①——什么是Fiber]]></title>    <link>https://juejin.cn/post/7574040813749862451</link>    <guid>https://juejin.cn/post/7574040813749862451</guid>    <pubDate>2025-11-19T08:35:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574040813749862451" data-draft-id="7573900332637519882" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React源码学习准备工作①——什么是Fiber"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-11-19T08:35:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jseeza"/> <meta itemprop="url" content="https://juejin.cn/user/2601912558697392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React源码学习准备工作①——什么是Fiber
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2601912558697392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jseeza
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T08:35:24.000Z" title="Wed Nov 19 2025 08:35:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在 React 16 以前，React的更新方式是这样的：<strong>一次性、不可中断的深度递归更新</strong>。这种更新方式：</p>
<ul>
<li>采用<strong>调用递归树</strong>来遍历组件树</li>
<li>从<strong>根节点</strong>开始递归render</li>
<li>中间过程不能暂停、不能打断</li>
<li>一旦开始，就必须一次性执行到结束</li>
</ul>
<p>这种更新方式被称作：<strong>Stack Reconciler</strong>（调用栈调和器）。
其优点是显而易见的：实现简单，逻辑清晰，理论上来说性能不会太差，小更新速度非常快，不可打断的一次性能保证渲染的一致性，包括UI的一致性和生命周期顺序的固定可靠。</p>
<p>但是，也正是因为这种不可打断的一次性，带来了非常致命的问题：大组件树会卡死主线程。</p>
<p>React 的更新逻辑是运行在 JS 主线程中的，但是 JS 主线程除了负责 React 的更新，还需要去负责：</p>
<ul>
<li>UI渲染</li>
<li>用户输入事件</li>
<li>动画</li>
<li>网络回调</li>
<li>等等</li>
</ul>
<p>如果我们需要渲染一个巨型的组件树， React 就会一次性递归计算组件树的所有节点，占用了 JS 主线程，并且中途无法暂停，从而导致 JS 堵塞，页面卡死，用户的交互事件也没有反应——因为主线程都被哪去给 React 渲染组件树了。</p>
<p>不仅于此，Raact 阻塞进程还会导致浏览器无法响应更高优先级的任务，在 React 16 以前，React 不会让用户输入等更高优先级的任务去插队响应，JS 线程必须等待当前组件树 render 完成，才能去响应其他任务——给用户的体验就是：<strong>页面卡顿、掉帧、输出延迟</strong>。</p>
<p>此外，因为递归栈形式的遍历不能中断，因此也很难去保存当前执行的上下文，记录执行到哪一步从而恢复执行，这种方式完全无法实现<strong>渐进式渲染</strong>，包括分片等功能自然也无法实现。</p>
<p>总结：React 16 以前使用的Stack Reconciler，优点是实现简单、一次性渲染保证一致性；缺点是不能中断、不能分片、不能恢复，导致长任务会阻塞主线程，引发页面卡顿，因此被Fiber替代。</p>
<p>React 开发团队也正是为了实现 <strong>“可中断、可恢复”的渲染</strong>，从而引入了Fiber的概念。</p>
<h2 data-id="heading-1">Fiber 的定义</h2>
<h3 data-id="heading-2">什么是 Fiber</h3>
<p>一句话概括：Fiber 是 React 用来执行“可中断更新”的一种数据结构（FiberNode）+调度机制（Workloop）。</p>
<p>Fiber 既是一个轻量级数据结构（描述组件的工作单元），又是一个任务调度系统（让更新分片执行，不卡主线程）。</p>
<p>可以这么说，<strong>Fiber=数据结构+调度系统</strong>。</p>
<p>Fiber 的引入使得渲染过程可以中断，并且根据需要重新调度任务，这种可中断可分片的优化使得 React 可以更好利用 JS 主线程的空闲时间，优化性能，提升用户体验。</p>
<h3 data-id="heading-3">Fiber 是一种数据结构</h3>
<p>为什么这么说呢？我们可以看看FiberNode的源码。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FiberNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tag, pendinfProps, key, mode</span>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = key;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elementType</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">stateNode</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 树形结构</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">return</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sibling</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// props</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingProps</span> = pendingProps;
    <span class="hljs-variable language_">this</span>,memoizedProps = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 状态</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoizedState</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateQueue</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// Effect 相关</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">flags</span> = <span class="hljs-title class_">NoFlags</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subtreeFlags</span> = <span class="hljs-title class_">NoFlags</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deletions</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 调度 lane</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lanes</span> = <span class="hljs-title class_">NoLanes</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">childLanes</span> = <span class="hljs-title class_">NoLanes</span>;

    <span class="hljs-comment">// 双缓存树</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">alternate</span> = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<p>我们可以重点关注以下几个内容。</p>
<h4 data-id="heading-4">1. child / sibling / return</h4>
<p>Fiber 是一个非常典型的<strong>链表结构+树结构</strong>的混合，而非一棵标准的多叉树。</p>
<pre><code class="hljs language-tsx" lang="tsx">child → 第一个子节点  
sibling → 右兄弟节点  
<span class="hljs-keyword">return</span> → 父节点  
</code></pre>
<h4 data-id="heading-5">2. alternate</h4>
<p>Fiber 使用的是“双缓存”机制，alternate 是双缓存树的核心。</p>
<p>Fiber 会同时维护两棵 Fiber 树：</p>
<ul>
<li>一棵是当前页面正在用的树（current）</li>
<li>另一棵是正在计算下一帧UI的树（workInProgress）</li>
</ul>
<p>计算完成后，就用一次性“切换指针”的方式把新的树换成 current，渲染过程可以实现<strong>无闪烁、可中断、不卡顿</strong>。双缓存依赖 alternate 形成两棵树，alternate 相当于两棵树切换的桥梁，能让 React 同时维护 current 树和 workInProgress 树，并在它们之间随时切换，无需重新创建整棵树。</p>
<p>每个 Fiber 节点都有两个版本，alternate 字段去记录它们的映射关系：</p>
<pre><code class="hljs language-tsx" lang="tsx">currentFiber.<span class="hljs-property">alternate</span> = workInProgressFiber
workInProgressFiber.<span class="hljs-property">alternate</span> = currentFiber
</code></pre>
<p>这种桥梁关系可以使 React 快速从 current 得到对应的 WIP，计算下一帧UI树时也不需要 new 新的树，而是直接复用已有的节点，在更新的过程中也会保存上一次的状态。</p>
<p>这里延伸一下：alternate 为什么可以让 Fiber 重用已有的节点？这里可以直接参考源码：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">if</span> (current.<span class="hljs-property">alternate</span> !== <span class="hljs-literal">null</span>) {
  <span class="hljs-comment">// reuse</span>
  workInProgress = current.<span class="hljs-property">alternate</span>;
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// create a new fiber</span>
}
</code></pre>
<p>这意味着，在 current.alternate 存在时，Fiber 会直接复用已有的节点，而不是创建一个新的Tree Node，这将大大减少性能。</p>
<p>这也意味着，WIP 的构建是可以随时产生随时停止的，只需要根据 current 即可随时构造，那么，在 JS 线程中，一旦有更高优先级的任务发生，WIP 可以立即被丢弃，等待更高优先级的任务完成，然后再重新算，期间不会对 current 造成任何影响，用户只能看到 current 的内容，页面体验也不会受到影响。</p>
<p>在 WIP 构建完成后，UI 切换并不是重新创建，而是“调换指针”。</p>
<pre><code class="hljs language-tsx" lang="tsx">root.<span class="hljs-property">current</span> = finishedWork;
</code></pre>
<p>Alternate 保证两棵树的节点是一一对应的，那么只需要切换指针，就能实现将 WIP 推到页面上。</p>
<p>用一句话总结：<strong>Alternate 是双缓存的核心，因为它让 React 能维持 current 和 workInProgress 两棵并行的 Fiber 树。所有的更新都在WIP上进行，最终通过 alternate 快速切换指针使页面更新。</strong> 这种方式带来了可中断、可恢复、可丢弃、低卡顿的并发渲染能力。</p>
<h4 data-id="heading-6">3. lans</h4>
<p>React 17 内部引入 lanes 取代 expirationTime，但 lanes 的真实能力在 React 18 并发模式中才真正向开发者开放。</p>
<p>Lans 模型决定：</p>
<ul>
<li>哪些任务可以中断</li>
<li>哪些任务可以合并</li>
<li>哪些任务需要优先执行</li>
</ul>
<p>这是并发模式的基础。</p>
<h3 data-id="heading-7">Fiber 是一种调度系统</h3>
<p>说 Fiber 是一种调度系统，本质上是抓住了 Fiber 的设计核心：Fiber 不是一个单纯的树结构，而是一个可以拆分任务、按优先级执行、暂停和恢复的<strong>工作调度引擎</strong>。上文提到的 lans 很好地揭示了这样的一种行为。</p>
<h4 data-id="heading-8">为什么说 Fiber 是一种调度系统</h4>
<h5 data-id="heading-9">1. 可中断/可恢复</h5>
<p>React 16 以前，渲染是“递归+同步”的渲染：一旦开始渲染，就无法停止。Fiber 支持将渲染工作拆分成小单元，渲染间隙可以将 JS 线程让给优先级更高的任务，等待任务完成后再回来继续渲染。</p>
<p>这种机制非常像操作系统到的 CPU 调度：Fiber 是任务线程/进程，React 根据需求去调度。</p>
<h5 data-id="heading-10">2. 优先级机制</h5>
<p>操作系统的 CPU 调度会提到优先级这个概念，根据优先级安排任务调度顺序，保证高优先级的任务优先被执行。</p>
<p>Fiber 也可以实现类似的优先级调度机制，支持不同优先级的任务，实现原理就是上文提到的 Lans，通过优先级调度系统，React 可以“插队”执行高优先级任务，例如在渲染过程中来了一个用户交互任务，React 可以暂停渲染先去处理交互任务，完成后再返回继续执行渲染任务。</p>
<p>上下文的储存也会保证不会丢失以前的渲染结果。这个优先级机制是并发渲染的基础。</p>
<h5 data-id="heading-11">3. 时间分片</h5>
<p>Fiber 可以通过“时间分片”的思想，将大的渲染任务分解为小的任务，每一帧都只完成部分任务。这样 JS 主线程不会长时间被渲染任务占据，浏览器调度 API 在此基础上可以决定什么时候继续渲染任务，这样可以保证用户交互、动画等高优先级的任务不会被低优先级的渲染任务卡住。</p>
<h5 data-id="heading-12">4. 调度器</h5>
<p>React 有一个单独的调度层（Scheduler），与 Fiber 结合，从而实现决定何时执行任务。这个调度层支持优先级任务、超时、挂起、恢复等，是一个真正的任务调度系统。</p>
<h5 data-id="heading-13">5. 可撤销/可放弃任务</h5>
<p>如果正在执行的渲染任务优先级低于高优先级的用户交互任务，则当前的渲染任务可以被暂停，断点执行时机可以被推后或者放弃。渲染进度会被保存，下次可以从中断处恢复，这样，React 的渲染就不是一次性的必须全部成功或者全部失败，而是有“弹性”的。</p>
<h4 data-id="heading-14">从调度系统角度看 Fiber 的优势</h4>
<p>一句话总结：更好地实现可中断、可恢复、低卡顿的渲染与页面交互。</p>
<ul>
<li>更好响应页面交互：高优先级的用户交互任务被优先执行，低优先级任务可以被打断，使用户的页面使用体验更流畅。</li>
<li>提升页面性能：渲染任务被分片分时渲染，减少了 React 长任务占用 JS 主线程的时间，浏览器可以及时进行重绘/回流。</li>
<li>支持并发特性：Fiber 是 React 并发模式的基础，调度系统为并发渲染提供了核心与基石。</li>
<li>错误恢复能力更强：Fiber 会记住渲染的上下文，渲染任务中断或放弃不会影响现有页面与整个渲染任务，可以根据上下文恢复渲染任务。</li>
</ul>
<h2 data-id="heading-15">Fiber 如何实现渲染</h2>
<p>这里我们要研究实现渲染的关键函数。</p>
<h3 data-id="heading-16">1. 初次渲染：创建双缓存树</h3>
<p>初次渲染时没有 alternate，于是 React 会创建一棵新的 workInProgress Fiber 树。</p>
<p>这里可以去看一看 Fiber 的源码 <code>ReactFiber.js</code>。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createWorkInProgress</span>(<span class="hljs-params">current, pendingProps</span>) {
  <span class="hljs-keyword">let</span> workInProgress = current.<span class="hljs-property">alternate</span>;
  <span class="hljs-keyword">if</span> (workInProgress === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 初次渲染：current 没有 alternate，会去创建一个新的 Fiber</span>
    workInProgress = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FiberNode</span>(current.<span class="hljs-property">tag</span>, pendingProps, current.<span class="hljs-property">key</span>);
    workInProgress.<span class="hljs-property">stateNode</span> = current.<span class="hljs-property">stateNode</span>;
    workInProgress.<span class="hljs-property">alternate</span> = current;
    current.<span class="hljs-property">alternate</span> = workInProgress;
  }
  <span class="hljs-keyword">return</span> workInProgress;
}
</code></pre>
<p>初次渲染之后，current 和 WIP 两棵树就建好了，彼此通过 alternate 连接，相互复用，减少了后续节点构建的压力（因为后续就复用了）。</p>
<h3 data-id="heading-17">2. 更新阶段：利用双缓存机制构建新的UI</h3>
<p>更新流程发生在 <code>ReactFiberWorkLoop.js</code> 中。</p>
<p>核心步骤如下：</p>
<ol>
<li>从 current 树中获取对应 Fiber；</li>
<li>通过 createWorkInProgress 创建或复用 WIP 树；</li>
<li>所有的计算、diff、effect 都在 WIP 树种进行；</li>
<li>完成后执行 commit 阶段；</li>
<li>用改变指针的方式交换两棵树的角色：WIP 变成新的 current。</li>
</ol>
<h4 data-id="heading-18">① Render 阶段：构建 WIP 树</h4>
<p>循环由 <code>performUnitOfWork(WIP)</code> 驱动实现。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">unitOfWork</span>) {
  <span class="hljs-keyword">const</span> current = unitOfWork.<span class="hljs-property">alternate</span>;
  <span class="hljs-keyword">let</span> next = <span class="hljs-title function_">beginWork</span>(current, unitOfWork);
  unitOfWork.<span class="hljs-property">memoizedProps</span> = unitOfWork.<span class="hljs-property">pendingProps</span>;

  <span class="hljs-keyword">if</span> (next === <span class="hljs-literal">null</span>) {
    <span class="hljs-title function_">completeUnitOfWork</span>(unitOfWork);
  }
  <span class="hljs-keyword">return</span> next;
}
</code></pre>
<p>渲染都在WIP上计算，如果节点有子节点，那就进入子节点继续处理，直到节点没有子节点了（叶子节点），则向上归并进入 complete 阶段。</p>
<h4 data-id="heading-19">② Commit 阶段：切换缓存树</h4>
<p>commit 阶段有两个特点：</p>
<ol>
<li>同步执行，不可中断</li>
<li>会真正地更新 DOM/UI</li>
</ol>
<p>在 commitLayoutEffects 阶段，React 会在浏览器执行绘制（paint）之前执行所有 Layout 副作用，统一在同一帧内完成，以避免 layout thrashing（布局抖动）。</p>
<p>由 commitRoot 执行角色交换，交换方式是指针指向修改，commit 阶段又被拆成三个阶段。来自<code>ReactFiberWorkLoop.js</code>：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRoot</span>(<span class="hljs-params">root</span>) {
  <span class="hljs-keyword">const</span> finishedWork = root.<span class="hljs-property">finishedWork</span>;
  root.<span class="hljs-property">finishedWork</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// 阶段1：mutation 前</span>
  <span class="hljs-title function_">commitBeforeMutationEffects</span>(root, finishedWork);

  <span class="hljs-comment">// 阶段2：mutation</span>
  <span class="hljs-title function_">commitMutationEffects</span>(root, finishedWork);
  root.<span class="hljs-property">current</span> = finishedWork ;
  
  <span class="hljs-comment">// 阶段3：layout 阶段</span>
  <span class="hljs-title function_">commitLayoutEffects</span>(root, finishedWork);
}
</code></pre>
<p><strong>阶段一：mutation 前</strong></p>
<p>该阶段发生在更新 DOM 前，用于为 mutation 做准备。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitBeforeMutationEffects</span>(<span class="hljs-params">root, firstChild</span>) {
  <span class="hljs-keyword">let</span> nextEffect = firstChild;
  <span class="hljs-keyword">while</span> (nextEffect !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> flags = nextEffect.<span class="hljs-property">flags</span>;
    <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Snapshot</span>) {
      <span class="hljs-title function_">commitBeforeMutationEffectOnFiber</span>(nextEffect);
    }
    nextEffect = nextEffect.<span class="hljs-property">nextEffect</span>;
  }
}
</code></pre>
<p>在这个阶段，React 会遍历所有带 Snapshot 标记的 Fiber，Snapshot 标记对应 getSnapshotBeforeUpdate。</p>
<p>这么做的目的是让我们在 DOM 更新前拿到更新前的 DOM 的真实状态的“快照”，如果在更新后再获取，就不完全准确了。</p>
<p>React 是一个增量更新的 Fiber 树，不是一个单纯的 DOM 树，可能会出现如下情况：</p>
<ul>
<li>多个组件有 Snapshot 副作用</li>
<li>有些嵌套组件会产生 Snapshot</li>
<li>某些组件的子组件没有更新，但子组件仍然需要 Snapshot</li>
</ul>
<p>因此 React 不能只处理当前节点，它需要确保：每一个 Fiber 节点，只要在本次更新中被标记为 Snapshot，都必须在 DOM 更新前执行快照。</p>
<p>在这个阶段，只处理 Snapshot，不需要考虑其它flags，因为其它 flags 不是必须在 DOM 更新前执行。比如：</p>
<ul>
<li>Placement（插入 DOM）：mutation 阶段</li>
<li>Update（更新属性）：mutation 阶段</li>
<li>Deletion（删除DOM）：mutation 阶段</li>
<li>useEffect：Layout 后异步执行</li>
</ul>
<p>总结：如果被问到 commitBeforeMutationEffects 要遍历所有 Snapshot Fiber 的原因，可以这么回答：</p>
<blockquote>
<p>因为 Snapshot 对应 getSnapshotBeforeUpdate，它的语义要求“读取旧 DOM 状态”。<br/>
所以必须在 mutation 阶段（DOM 更新）之前执行。<br/>
React 通过遍历 effectList 上所有带 Snapshot 标记的 Fiber，确保所有组件在 DOM 被修改之前完成快照读取。<br/>
这保证了组件在 update 阶段能获得精准的 DOM 变化前的状态，使滚动恢复、光标位置保存、布局测量等成为可能。</p>
</blockquote>
<p><strong>阶段二：mutation</strong></p>
<p>这个阶段是真正更新 DOM 的阶段，所有的 DOM 变动都在这一步完成。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitMutationEffects</span>(<span class="hljs-params">root, finishedWork</span>) {
  <span class="hljs-keyword">let</span> nextEffect = finishedWork

  <span class="hljs-keyword">while</span> (nextEffect !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> flags = nextEffect.<span class="hljs-property">flags</span>

    <span class="hljs-comment">// 删除节点</span>
    <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Deletion</span>) {
      <span class="hljs-title function_">commitDeletion</span>(root, nextEffect)
    }

    <span class="hljs-comment">// 插入或移动节点</span>
    <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Placement</span>) {
      <span class="hljs-title function_">commitPlacement</span>(nextEffect)
    }

    <span class="hljs-comment">// 更新属性或文本</span>
    <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
      <span class="hljs-title function_">commitWork</span>(nextEffect)
    }

    nextEffect = nextEffect.<span class="hljs-property">nextEffect</span>
  }
}
</code></pre>
<p>React 用 flags 标记 effect，常见的与 mutation 相关的 flags 有：</p>
<ul>
<li>Placement：需要插入（mount）或移动节点</li>
<li>Deletion：需要删除（unmount）节点</li>
<li>Update：更新属性/文本</li>
<li>Snapshot：在 before-mutation 阶段处理（已在前面完成）</li>
<li>Ref：需要更新/清理 ref（通常在 layout 阶段也会处理）</li>
<li>Passive：useEffect（但 cleanup 在 mutation 阶段需要先执行其 cleanup，再在 layout/after 写入）</li>
</ul>
<p>处理顺序也有先后，遵循<strong>Deletion → Placement → Update</strong> 的顺序，这样可以保证 DOM 父节点的稳定性。</p>
<p><strong>阶段三：layout 阶段</strong></p>
<p>在 DOM 更新后执行：</p>
<ul>
<li>类组件的 <code>componentDidMount</code></li>
<li>类组件的 <code>componentDidUpdate</code></li>
<li>hook 的 <code>useLayoutEffect</code> create 部分</li>
<li>调用 ref 回调</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitLayoutEffects</span>(<span class="hljs-params">root, finishedWork</span>) {
  <span class="hljs-keyword">let</span> nextEffect = finishedWork;
  
  <span class="hljs-keyword">while</span> (nextEffect !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (nextEffect.<span class="hljs-property">flags</span> &amp; <span class="hljs-title class_">Update</span>) {
      <span class="hljs-title function_">commitLayoutEffectOnFiber</span>(root, nextEffect);
    }
    nextEffect = nextEffect.<span class="hljs-property">nextEffect</span>;
  }
}
</code></pre>
<p>主要作用就是：执行所有需要“看到最新 DOM”的副作用，从而实现同步、强制、阻塞，保证顺序一致，且能访问最新 DOM。</p>
<p>主流程如下：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitLayoutEffects</span>(<span class="hljs-params">finishedWork, root, committedLanes</span>) {
  <span class="hljs-comment">// ① 清理上次的 passive destroy（useEffect cleanup）</span>
  <span class="hljs-title function_">flushSyncCallbacksOnlyInLegacyMode</span>();

  <span class="hljs-comment">// ② 遍历 layoutEffects</span>
  <span class="hljs-title function_">commitLayoutEffectsOnFiber</span>(root, finishedWork, committedLanes);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitLayoutEffectsOnFiber</span>(<span class="hljs-params">root, finishedWork, lanes</span>) {
  <span class="hljs-keyword">let</span> nextEffect = finishedWork.<span class="hljs-property">firstEffect</span>;
  <span class="hljs-keyword">while</span> (nextEffect !== <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 执行 layout 的 work</span>
    <span class="hljs-title function_">commitLayoutEffectOnFiber</span>(
      root,
      nextEffect.<span class="hljs-property">alternate</span>,
      nextEffect,
      lanes
    );
    nextEffect = nextEffect.<span class="hljs-property">nextEffect</span>;
  }
}
</code></pre>
<p>其中，我们重点关注一下<code>commitLayoutEffectsOnFiber</code>，这个阶段是根据 flags 分类处理副作用：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">commitLayoutEffectOnFiber</span>(<span class="hljs-params">root, current, finishedWork, lanes</span>) {
  <span class="hljs-keyword">const</span> flags = finishedWork.<span class="hljs-property">flags</span>;

  <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Update</span>) {
    <span class="hljs-comment">// 处理 class 组件的 didUpdate 生命周期</span>
  }

  <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Callback</span>) {
    <span class="hljs-comment">// setState 的回调</span>
  }

  <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">Ref</span>) {
    <span class="hljs-comment">// 安装 ref</span>
  }

  <span class="hljs-comment">// 重点：处理 Layout effects</span>
  <span class="hljs-keyword">if</span> (flags &amp; <span class="hljs-title class_">LayoutMask</span>) {
    <span class="hljs-title function_">commitHookEffectListMount</span>(<span class="hljs-title class_">HookLayout</span>, finishedWork)
  }
}
</code></pre>
<p>其中 LayoutMask 包括 useLayoutEffect 的销毁和创建。对于 useLayoutEffect，React会先执行 destory，再执行 create，这里的先后顺序永远不会被打破。</p>
<p>强调！useLayoutEffect 必须同步执行？</p>
<p><strong>因为这一阶段的 DOM 已经更新，依然可以同步读取，但是还没有渲染在浏览器上，这时 useLayoutEffect 可以进行 DOM 的尺寸测量和位置计算、修改 DOM ，以及注入同步逻辑。</strong> React 故意将 useLayoutEffect 安排在渲染浏览器之前，从而避免渲染在页面的 DOM 会出现闪烁，这是一个同步行为。</p>
<p>如果时会被问到这样的问题——为什么 useEffect 不在这个阶段执行？我们可以这么回答：</p>
<blockquote>
<p>因为 useLayoutEffect 是同步 + 阻塞的，而 useEffect 是异步 + 不阻塞渲染的（调度到微任务/宏任务），所以 useEffect 不会在这个阶段的layout 执行，而是在下一轮事件循环执行。</p>
</blockquote>
<p>以上阶段内容总结：</p>
<p><strong>commitLayoutEffects 是 React commit 阶段的“布局阶段”，在 DOM 已更新但浏览器尚未绘制时执行。<br/>
它同步执行 useLayoutEffect 的 destroy 与 create、类组件的 didMount/didUpdate、ref 赋值等所有需要访问最新 DOM 的副作用。<br/>
React 通过 effect list 遍历仅更新的 Fiber，保证副作用按严格顺序执行，并确保 DOM 状态一致性</strong>。</p>
<h2 data-id="heading-20">补充：为什么 Fiber 是“最小可工作单元”</h2>
<p>因为 Fiber 以前是不可中断、不可暂停的“递归调用栈”，Fiber 的出现把递归变成了“可迭代的单链表结构”，每个 FiberNode 本质上是一个工作单元，这就是 Fiber “可中断”的根本原因。</p>
<p>React Fiber 的本质就是：把组件树从递归改写成可遍历的链表，让渲染变成可拆分的工作单元，从而可以暂停、恢复、丢弃、重做。</p>
<h2 data-id="heading-21">总结</h2>
<p>React 16 引入 Fiber，本质上是用一套“可中断、可恢复”的调度系统来替代原先不可中断的 Stack Reconciler（递归调用栈）。Fiber 既是一种轻量级的数据结构（FiberNode），又是一套完整的渲染与调度机制（WorkLoop + Scheduler）。它通过：</p>
<ul>
<li><strong>双缓存机制</strong></li>
<li><strong>单链表化的树节点FiberNode</strong></li>
<li><strong>可分片与可中断的工作单元</strong></li>
<li><strong>基于优先级的调度模型</strong></li>
</ul>
<p>让 React 能够在渲染期间暂停、恢复、放弃任务，并在合适的时机继续执行，不去长时间的占据 JS 主线程，从而避免卡顿。</p>
<p>Fiber 的引入彻底改变了 React 的渲染模型，使得：</p>
<ul>
<li>渲染变得可控、不再阻塞主线程</li>
<li>更高优先级的用户交互可以“插队”</li>
<li>更新可以分片完成（时间切片）</li>
<li>DOM 更新被拆解成 before-mutation → mutation → layout 三阶段，更可预测、更加精细</li>
</ul>
<p>可以说：<strong>Fiber 是 React 并发特性的基础，也是 React 性能优化的核心。</strong></p>
<p>React 从同步递归 → 可调度的 Fiber 架构，是一次从“函数调用”到“任务调度”的根本性转变，为后续的 Concurrent Mode、Suspense 等特性奠定了全部基础。</p>
<p>以上为个人在学习过程中的一些理解和感悟，部分有参考，如有不足，欢迎指正。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[干了10年前端，才学会使用IntersectionObserver]]></title>    <link>https://juejin.cn/post/7574045294611873827</link>    <guid>https://juejin.cn/post/7574045294611873827</guid>    <pubDate>2025-11-19T08:45:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7574045294611873827" data-draft-id="7573989365615460352" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="干了10年前端，才学会使用IntersectionObserver"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-19T08:45:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tyro曹仓舒"/> <meta itemprop="url" content="https://juejin.cn/user/3403743729041038"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            干了10年前端，才学会使用IntersectionObserver
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743729041038/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tyro曹仓舒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-19T08:45:37.000Z" title="Wed Nov 19 2025 08:45:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>IntersectionObserver</code> 是 JavaScript 原生 API，用于<strong>异步监听目标元素与视口（或指定容器元素）的交叉状态</strong>（即元素是否进入 / 离开视口、交叉比例多少）。核心优势是性能优异（浏览器原生优化，避免 scroll 事件的高频触发），常见场景：懒加载图片 / 视频、滚动加载列表、曝光统计、元素进入视口时触发动画等。</p>
<h3 data-id="heading-0">一、核心概念</h3>
<ol>
<li><strong>目标元素（target）</strong> ：需要监听的 DOM 元素（如图片、列表项）。</li>
<li><strong>根元素（root）</strong> ：作为 “视口” 的参考容器，默认是浏览器视口（<code>null</code>），必须是目标元素的祖先元素。</li>
<li><strong>根边界（rootMargin）</strong> ：根元素的 “扩展 / 收缩边距”，用于提前 / 延迟触发监听（如提前 100px 检测元素即将进入视口）。</li>
<li><strong>阈值（threshold）</strong> ：触发回调的 “交叉比例阈值”（0~1），可传单个值或数组（如 <code>[0, 0.5, 1]</code> 表示元素刚进入、一半进入、完全进入时都触发）。</li>
<li><strong>交叉状态（intersectionRatio）</strong> ：目标元素与根元素的交叉比例（0 = 完全不交叉，1 = 完全交叉）。</li>
</ol>
<h3 data-id="heading-1">二、基本使用步骤</h3>
<h4 data-id="heading-2">1. 语法结构</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建观察器实例，传入回调函数和配置项</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries, observer</span>) =&gt;</span> {
  <span class="hljs-comment">// entries：所有被监听元素的交叉状态数组（每个元素是 IntersectionObserverEntry 对象）</span>
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-comment">// entry：单个元素的交叉状态信息</span>
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
      <span class="hljs-comment">// 元素进入视口（交叉比例 &gt; 0）</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'元素进入视口'</span>, entry.<span class="hljs-property">target</span>);
      <span class="hljs-comment">// 执行业务逻辑（如懒加载、触发动画）</span>
      <span class="hljs-comment">// 可选：只监听一次，触发后取消观察</span>
      observer.<span class="hljs-title function_">unobserve</span>(entry.<span class="hljs-property">target</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 元素离开视口（交叉比例 = 0）</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'元素离开视口'</span>, entry.<span class="hljs-property">target</span>);
    }
  });
}, {
  <span class="hljs-attr">root</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 根元素，默认视口（null）</span>
  <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'0px'</span>, <span class="hljs-comment">// 根元素边距（格式：上 右 下 左，支持 px/%)</span>
  <span class="hljs-attr">threshold</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 阈值（默认 0，元素刚进入视口时触发）</span>
});

<span class="hljs-comment">// 2. 监听目标元素（可监听多个）</span>
<span class="hljs-keyword">const</span> target1 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.target1'</span>);
<span class="hljs-keyword">const</span> target2 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.target2'</span>);
observer.<span class="hljs-title function_">observe</span>(target1);
observer.<span class="hljs-title function_">observe</span>(target2);

<span class="hljs-comment">// 3. 可选：停止监听单个元素</span>
observer.<span class="hljs-title function_">unobserve</span>(target1);

<span class="hljs-comment">// 4. 可选：销毁观察器（所有监听都停止）</span>
observer.<span class="hljs-title function_">disconnect</span>();
</code></pre>
<h4 data-id="heading-3">2. 关键参数详解</h4>

























<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>entries</code></td><td>数组，每个元素是 <code>IntersectionObserverEntry</code> 对象，包含单个目标的交叉信息：- <code>isIntersecting</code>：布尔值，是否正在交叉（进入视口）- <code>intersectionRatio</code>：交叉比例（0~1）- <code>target</code>：被监听的 DOM 元素- <code>boundingClientRect</code>：目标元素的位置信息- <code>rootBounds</code>：根元素的位置信息</td></tr><tr><td><code>root</code></td><td>参考容器（DOM 元素），默认 <code>null</code>（浏览器视口），必须是目标元素的祖先。</td></tr><tr><td><code>rootMargin</code></td><td>根元素的边距，用于扩展 / 收缩根元素的 “有效视口”，格式同 CSS 边距。例：<code>rootMargin: '50px 0px'</code> → 根元素上下扩展 50px，提前 50px 触发监听。</td></tr><tr><td><code>threshold</code></td><td>触发回调的交叉比例阈值，可传数组：- <code>threshold: 0</code>（默认）→ 元素刚进入视口（交叉比例 &gt;0）时触发- <code>threshold: 1</code> → 元素完全进入视口（交叉比例 =1）时触发- <code>threshold: [0, 0.5, 1]</code> → 元素刚进入、一半进入、完全进入时各触发一次</td></tr></tbody></table>
<h3 data-id="heading-4">三、常见场景示例</h3>
<h4 data-id="heading-5">示例 1：图片懒加载（核心场景）</h4>
<p>需求：页面滚动时，图片进入视口后再加载真实图片（优化首屏加载速度）。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- HTML：占位图 + 真实图片地址存放在 data-src 属性 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy-img"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"placeholder.jpg"</span> <span class="hljs-attr">data-src</span>=<span class="hljs-string">"real-img1.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"懒加载图片"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy-img"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"placeholder.jpg"</span> <span class="hljs-attr">data-src</span>=<span class="hljs-string">"real-img2.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"懒加载图片"</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 创建观察器</span>
<span class="hljs-keyword">const</span> lazyLoadObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
      <span class="hljs-comment">// 元素进入视口，加载真实图片</span>
      <span class="hljs-keyword">const</span> img = entry.<span class="hljs-property">target</span>;
      img.<span class="hljs-property">src</span> = img.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>; <span class="hljs-comment">// 替换 src 为真实地址</span>
      img.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'loaded'</span>); <span class="hljs-comment">// 可选：添加加载完成样式</span>
      lazyLoadObserver.<span class="hljs-title function_">unobserve</span>(img); <span class="hljs-comment">// 只加载一次，取消监听</span>
    }
  });
}, {
  <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'100px 0px'</span>, <span class="hljs-comment">// 提前 100px 开始加载（优化体验，避免白屏）</span>
  <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.1</span> <span class="hljs-comment">// 元素 10% 进入视口时触发</span>
});

<span class="hljs-comment">// 2. 监听所有懒加载图片</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.lazy-img'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> {
  lazyLoadObserver.<span class="hljs-title function_">observe</span>(img);
});
</code></pre>
<h4 data-id="heading-6">示例 2：滚动加载更多（无限滚动）</h4>
<p>需求：滚动到页面底部的 “加载更多” 按钮时，请求下一页数据。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"list"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"load-more"</span>&gt;</span>加载更多<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> loadMoreBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.load-more'</span>);
<span class="hljs-keyword">const</span> list = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.list'</span>);
<span class="hljs-keyword">let</span> page = <span class="hljs-number">1</span>;

<span class="hljs-comment">// 创建观察器（监听“加载更多”按钮）</span>
<span class="hljs-keyword">const</span> loadMoreObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> [entry] = entries;
  <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span> &amp;&amp; !isLoading) { <span class="hljs-comment">// isLoading 防止重复请求</span>
    isLoading = <span class="hljs-literal">true</span>;
    loadMoreBtn.<span class="hljs-property">textContent</span> = <span class="hljs-string">'加载中...'</span>;
    <span class="hljs-comment">// 模拟请求下一页数据</span>
    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/data?page=<span class="hljs-subst">${page}</span>`</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        data.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> li = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'li'</span>);
          li.<span class="hljs-property">textContent</span> = item.<span class="hljs-property">content</span>;
          list.<span class="hljs-title function_">appendChild</span>(li);
        });
        page++;
        isLoading = <span class="hljs-literal">false</span>;
        loadMoreBtn.<span class="hljs-property">textContent</span> = <span class="hljs-string">'加载更多'</span>;
      });
  }
}, { <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'50px 0px'</span> }); <span class="hljs-comment">// 提前 50px 触发，优化体验</span>

<span class="hljs-comment">// 监听“加载更多”按钮</span>
loadMoreObserver.<span class="hljs-title function_">observe</span>(loadMoreBtn);
</code></pre>
<h4 data-id="heading-7">示例 3：元素进入视口触发动画</h4>
<p>需求：元素滚动进入视口时，添加 “淡入” 动画。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* CSS：初始状态（透明、偏移）+ 动画状态 */</span>
<span class="hljs-selector-class">.fade-in</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">20px</span>);
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.5s</span>, transform <span class="hljs-number">0.5s</span>;
}
<span class="hljs-selector-class">.fade-in</span><span class="hljs-selector-class">.active</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">0</span>);
}
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fade-in"</span>&gt;</span>元素 1：进入视口淡入<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fade-in"</span>&gt;</span>元素 2：进入视口淡入<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建观察器</span>
<span class="hljs-keyword">const</span> animationObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
      entry.<span class="hljs-property">target</span>.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'active'</span>); <span class="hljs-comment">// 触发动画</span>
      animationObserver.<span class="hljs-title function_">unobserve</span>(entry.<span class="hljs-property">target</span>); <span class="hljs-comment">// 只触发一次</span>
    }
  });
}, { <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.3</span> }); <span class="hljs-comment">// 元素 30% 进入视口时触发</span>

<span class="hljs-comment">// 监听所有需要动画的元素</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.fade-in'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
  animationObserver.<span class="hljs-title function_">observe</span>(el);
});
</code></pre>
<h3 data-id="heading-8">四、注意事项</h3>
<ol>
<li><strong>兼容性</strong>：支持 Chrome 51+、Firefox 55+、Safari 12.1+、Edge 16+，不支持 IE（需兼容可使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fw3c%2FIntersectionObserver%2Ftree%2Fmain%2Fpolyfill" target="_blank" title="https://github.com/w3c/IntersectionObserver/tree/main/polyfill" ref="nofollow noopener noreferrer">polyfill</a>）。</li>
<li><strong>异步特性</strong>：<code>IntersectionObserver</code> 是异步的，回调函数不会阻塞主线程（性能优势），但无法同步获取元素交叉状态。</li>
<li><strong>root 必须是祖先元素</strong>：如果指定 <code>root</code>，必须确保它是目标元素的父级 / 祖先元素，否则监听无效。</li>
<li><strong>动态元素监听</strong>：如果目标元素是动态创建的（如通过 JS 新增的列表项），创建后需调用 <code>observer.observe(新元素)</code> 手动添加监听。</li>
<li><strong>rootMargin 单位</strong>：支持 <code>px</code> 或 <code>%</code>，但不能混合单位（如 <code>50px 10%</code> 是允许的，<code>50 10px</code> 不允许）。</li>
</ol>
<h3 data-id="heading-9">五、总结</h3>
<p><code>IntersectionObserver</code> 的核心价值是<strong>高效监听元素交叉状态</strong>，替代传统的 <code>scroll</code> + <code>getBoundingClientRect()</code> 方案（后者高频触发，性能较差）。使用时只需三步：</p>
<ol>
<li>创建观察器（配置回调和参数）；</li>
<li>监听目标元素；</li>
<li>触发后执行业务逻辑（并可选取消监听）。</li>
</ol>
<p>常见应用：懒加载、无限滚动、曝光统计、滚动动画，是前端性能优化和交互体验提升的重要 API。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大部分人都错了！这才是chrome插件多脚本通信的正确姿势]]></title>    <link>https://juejin.cn/post/7573521516324732955</link>    <guid>https://juejin.cn/post/7573521516324732955</guid>    <pubDate>2025-11-18T00:06:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573521516324732955" data-draft-id="7572481101711097910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大部分人都错了！这才是chrome插件多脚本通信的正确姿势"/> <meta itemprop="keywords" content="前端,浏览器,JavaScript"/> <meta itemprop="datePublished" content="2025-11-18T00:06:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不一样的少年_"/> <meta itemprop="url" content="https://juejin.cn/user/3035079961218551"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大部分人都错了！这才是chrome插件多脚本通信的正确姿势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3035079961218551/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不一样的少年_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T00:06:38.000Z" title="Tue Nov 18 2025 00:06:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    264
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>昨天一个实习生同事来找我：“哥们，我的Chrome插件遇到个奇怪问题，为什么我插入到页面的内容脚本content.js，重写页面脚本的方法没有生效？”</p>
<p>其实类似的问题我也经常碰到，比如：“为什么popup页面调用不了content.js的函数？”、“插入到页面的内容脚本为啥访问不到Vue实例？”、“background脚本为啥不能访问页面的dom节点”?………这些问题在插件开发里真的挺常见的，大家都容易踩坑。</p>
<p>所以今天，我想用最通俗的方式，把自己遇到的问题和一些小经验分享出来：</p>
<ul>
<li>为什么Chrome要把插件分成这么多脚本？它们之间到底啥关系？</li>
<li>那些“看起来应该能用，但就是不行”的通信方式，背后的原因是什么？</li>
<li>怎么让插件的各个部分配合得更顺畅？</li>
</ul>
<p>放心，没有复杂的术语，用图解的方式来梳理脉络，希望这些内容能帮到大家，也欢迎大家一起交流！</p>
</blockquote>
<h3 data-id="heading-0">前置知识：</h3>
<p>要搞懂插件通信，首先得了解浏览器的架构。现在的 Chrome 浏览器采用的是“多进程架构”，什么意思呢？直接看图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef2bd5d3aa8b482ab9bbdb857454ceef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764050800&amp;x-signature=1cwDjD6VYVqmH2tNZsn8N02yW84%3D" alt="" loading="lazy"/></p>
<p>上图中，我们浏览器架构是由、渲染进程、插件进程、网路进程、浏览器主进程、gpu进程等组成的</p>
<ul>
<li>
<p><code>浏览器主进程</code>: 相当于公司的大老板，负责整个公司的运转。比如你要开新窗口、切换标签、下载文件、弹出权限提示，都是浏览器主进程安排的。</p>
<p>其他进程有啥事也都得跟主进程报备，主进程来调度。</p>
</li>
<li>
<p><code>渲染进程</code>：平时我们使用浏览器打开的每一个网页，都是由渲染进程进行渲染的。插件注入的内容脚本也在这里运行，不过处于“隔离世界”，与页面脚本相互隔离，这个后面我们会详细讲</p>
</li>
<li>
<p><code>网络进程</code>：处理所有页面与扩展的请求，我们网页中或者插件中的接口请求这种脏活累活都由它来干</p>
</li>
<li>
<p><code>GPU进程</code>：网页中有炫酷动画、视频、3D效果啥的，GPU进程就会帮你画的又快又漂亮。</p>
</li>
<li>
<p><code>插件进程</code>：运行我们平时所装的浏览器插件，我们装的不同的插件都会分配到不同的插件进程中，互不干扰，谁家插件出了问题，最多自己崩，不会影响到其他插件和页面的运行</p>
</li>
</ul>
<p>Chrome 浏览器其实就是把各种工作分开来做，谁负责啥都很清楚。<code>主进程</code>管大局，<code>渲染进程</code>负责把网页内容展示出来，<code>网络进程</code>专门搞数据传输，<code>GPU进程</code>让动画和视频更流畅，<code>插件进程</code>则让你装的各种扩展各自独立运行。大家各干各的，互不影响，这样浏览器用起来才又快又稳还安全。</p>
<h3 data-id="heading-1">插件各部分的角色与能力</h3>
<p><a href="https://juejin.cn/column/7548643621609193482" target="_blank" title="https://juejin.cn/column/7548643621609193482">浏览器插件开发实践 - 不一样的少年_的专栏 - 掘金</a></p>
<p>大家看到我的插件专栏里的插件目录，大致是这样：</p>
<pre><code class="hljs language-js" lang="js">demo
├── manifest.<span class="hljs-property">json</span> # 扩展的<span class="hljs-string">"身份证"</span>
├── background.<span class="hljs-property">js</span> # 插件后台脚本
├── injected.<span class="hljs-property">js</span> # 注入页面脚本
├── content.<span class="hljs-property">js</span> # 内容脚本
└── popup.<span class="hljs-property">html</span> # 弹窗页面
</code></pre>
<p>我们来简单聊聊每个文件的作用：</p>
<h4 data-id="heading-2">manifest.json —— 插件的“身份证”</h4>
<p>这个文件就像插件的身份证，里面写明了插件的名字、版本、权限、各个脚本的入口。比如你这个插件是弹窗类型，还是需要内容脚本、后台脚本，都要在这里声明清楚。没有它，浏览器都不认你这个插件。</p>
<h4 data-id="heading-3">popup.html —— 弹窗页面</h4>
<p>这个文件就是你点浏览器右上角插件图标弹出来的小窗口。写法跟普通网页一样，可以放按钮、输入框、结果展示区。</p>
<p>如下红色框住的就是popup页面：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/903ab19c88c74d078203bb1649f097ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764050800&amp;x-signature=wZskmJ%2BDzZvcUWNqhmQBCKUIkA0%3D" alt="" loading="lazy"/></p>
<p>这个popup页面，浏览器会分配一个渲染进程来进行渲染，如下图：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9021eb9b881c4d8cbc75bf3718accc39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764050800&amp;x-signature=SIKyf34nfHwlYK9HkadTyqOBnXM%3D" alt="" width="70%" loading="lazy"/>
<h4 data-id="heading-4">background.js —— 后台脚本</h4>
<p>后台脚本是插件的大脑，负责处理各种“后台任务”。比如监听消息、和服务器通信、管理数据。它不直接操作页面内容，但能帮你做很多“脏活累活”，比如跨域请求、定时任务、权限控制。弹窗页面、内容脚本都可以和它发消息，让它帮忙干活。</p>
<p>这个后台脚本，浏览器会开一个service worker服务进程来运行，如下图：</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eb0c1e3ccac481b894a0accd1bfb9c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764050800&amp;x-signature=%2FcZUsyxtR2zQFGF1x2%2BpvSV%2Fnok%3D" alt="" width="70%" loading="lazy"/>
<p><strong>举例</strong>： <code>popup页面和插件后台的通信</code></p>
<p>比如你做了一个“天气查询”插件，用户在弹窗页面输入城市名，点击“查询”按钮，弹窗页面就会通过 chrome.runtime.sendMessage 把城市名发给后台脚本，后台脚本收到后去请求天气接口，然后把结果返回给弹窗页面显示。</p>
<p><code>图解</code>：</p>
<ul>
<li>
<p>用户操作 popup 页面</p>
</li>
<li>
<p>popup 页面用 chrome.runtime.sendMessage 发消息给后台脚本</p>
</li>
<li>
<p>后台脚本处理请求，返回结果给 popup 页面</p>
</li>
</ul>
<p>虽然都popup页面和service worker属于同一个扩展，但它们运行在不同进程/沙箱中，无法直接共享内存或调用函数，必须通过浏览器主进程的消息路由（IPC）中转，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/444bdaa4c84048a6b4e93ca0c366757e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764050800&amp;x-signature=xjVKvxWHgGHWCDZrWbNF50qEWGE%3D" alt="" loading="lazy"/></p>
<p>代码示例：</p>
<p><code>popup.htm</code>l</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"city"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"城市名"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"btn"</span>&gt;</span>查天气<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"result"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'btn'</span>)
      btn.<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> city = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'city'</span>).<span class="hljs-property">value</span>;
        <span class="hljs-comment">// popup向background.js发送查询消息</span>
        chrome.<span class="hljs-property">runtime</span>.<span class="hljs-title function_">sendMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'getWeather'</span>, city }, <span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) {
            <span class="hljs-comment">// background.js返回的消息</span>
          <span class="hljs-keyword">const</span> data =  response.<span class="hljs-property">weather</span> 
          <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'result'</span>).<span class="hljs-property">textContent</span> = data || <span class="hljs-string">'查询失败'</span>;
        });
      };
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><code>background.js</code></p>
<pre><code class="hljs language-js" lang="js">chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-function">(<span class="hljs-params">msg, sender, sendResponse</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">'getWeather'</span>) {
    <span class="hljs-comment">// 这里只做演示，实际开发可以用 fetch 去请求真实接口</span>
    <span class="hljs-keyword">const</span> fakeWeather = <span class="hljs-string">`<span class="hljs-subst">${msg.city}</span>：晴，25°C`</span>;
    <span class="hljs-title function_">sendResponse</span>({ <span class="hljs-attr">weather</span>: fakeWeather });
    <span class="hljs-comment">// 如果是异步操作（比如 fetch），需要 return true</span>
  }
});
</code></pre>
<p>这样，弹窗页面和后台脚本就能通过消息机制实现通信，弹窗页面只负责收集用户输入和展示结果，后台脚本负责处理数据和业务逻辑，分工明确，开发起来也很清晰！</p>
<p>我们打开chrome的任务管理器看刚刚上面提到的popup插件，来看看service worker和popup是否在不同的进程中运行</p>
<p>如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ead66cfebf6472fa38e9edc9c41b92e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764050800&amp;x-signature=0LZWsp41x2ar4YidqphQ%2F%2FryV7c%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16e2c6d77b0f48ddbd2d44dccd26b671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764050800&amp;x-signature=XaV1aOSHMATkPDlTHfzH%2BKHLxLM%3D" alt="image.png" loading="lazy"/></p>
<p>可以看出service worker和popup确实是分别在两个进程中运行</p>
<h4 data-id="heading-5">content.js —— 内容脚本</h4>
<p>内容脚本是插件派到网页里的“卧底”，所以这个content.js是在页面的渲染进程中运行的，不是在插件中运行的</p>
<p>我们画个图来解释下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/795107b9fbfb4fed82e87c49023499c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764050800&amp;x-signature=YKwiP%2F7r5E3I103NI%2Br67%2BCFMvk%3D" alt="" loading="lazy"/></p>
<p>当我们用浏览器打开掘金网站时，浏览器会启动一个渲染进程来负责页面的展示。掘金网站自己的 JS 变量和运行环境都在 Main World（页面脚本环境）里，比如你用 React/Vue 写的代码、window 上挂的变量，都是属于这个世界。</p>
<p>如果你这时候装了一个护眼插件，想让页面变成护眼模式（比如把背景色调成绿色），插件会通过内容脚本来操作页面的 DOM，比如直接修改 body 的样式。这段内容脚本其实是在另一个独立的 JS 环境里运行，也就是图里的 Isolated World（内容脚本环境）。</p>
<p>虽然内容脚本和页面脚本的执行环境是隔离开的，互相访问不到对方的变量，但它们可以一起操作和共享页面上的 DOM（比如 document.body），所以内容脚本能帮你改页面样式、加按钮、弹提示，但没法直接拿到页面里的 JS 变量。如果内容脚本真要和页面脚本通信，可以用 window.postMessage 这种方式来“搭桥”。</p>
<p>这样设计既保证了安全，又能让插件灵活地扩展页面功能。</p>
<h5 data-id="heading-6">内容脚本是怎么进到页面里的呢？</h5>
<p>内容脚本是插件派到网页里的“卧底”，其实它的“卧底”过程也是有讲究的：</p>
<p>有两种方式，第一种是声明式的，另一种是编程式的</p>
<h6 data-id="heading-7">声明式：</h6>
<p>浏览器根据插件的 manifest.json 配置，自动帮你注入到指定网页的渲染进程里。 比如你在 manifest.json 里写了：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"content_scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"https://juejin.cn/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"js"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"content.js"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>只要你打开掘金网站，浏览器就会自动把 content.js 注入到页面的渲染进程里，让它在 Isolated World（隔离环境）里运行。</p>
<h6 data-id="heading-8">编程式（按需注入）</h6>
<p>这里有个很重要的概念： 浏览器里不同进程之间（比如主进程、渲染进程、插件进程）要互相传递消息，靠的就是 IPC（Inter-Process Communication）机制，翻译过来就是“进程间通信”。</p>
<ul>
<li>
<p>比如你在后台脚本（background.js）或弹窗页面（popup）里调用 chrome.scripting.executeScript ，就能按需把内容脚本注入到指定网站页面里。</p>
</li>
<li>
<p>这个过程其实是：插件发起注入请求后，浏览器主进程会先受理这个请求，然后通过 IPC机制，把要注入的内容脚本安全地传递给目标页面的渲染进程。</p>
</li>
<li>
<p>渲染进程收到脚本后，就会在页面的隔离环境（Isolated World）里执行内容脚本，这样内容脚本就真正“落地”到页面中了。</p>
</li>
</ul>
<p>所以，整个流程就是： 插件调用 chrome.scripting.executeScript → 浏览器主进程受理并通过 IPC 转发 → 页面渲染进程执行内容脚本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59eb3f573d1745afbcfe59271299a3d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764050800&amp;x-signature=cFoNmcJY%2FREtXrZTlfcFNx7qdns%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">injected.js —— 注入页面脚本</h4>
<p>前面说过，页面的 JS 环境和内容脚本的 JS 环境是互相隔离的，彼此访问不到对方的变量和方法，但它们共享同一个 DOM 树。 如果你想直接改页面里的 JS 环境，比如重写 fetch 或 XMLHttpRequest，实现像 mock 接口这样的功能，就不能只靠内容脚本了。</p>
<p>这时候就需要用“注入脚本”的方式： 我们可以在内容脚本里创建一个 script 标签，把要改写的代码（比如新的 fetch 实现）写进去，然后把这个标签插入到页面的 DOM 里。这样，页面会像加载普通 JS 文件一样执行这段代码，最终就能覆盖页面原生的 fetch 和 xhr 方法。</p>
<p>这种做法的好处是：</p>
<ul>
<li>
<p>能直接影响页面自己的 JS 环境，实现更强的功能扩展</p>
</li>
<li>
<p>只要 DOM 是共享的，插入 script 标签就能让页面执行我们的代码</p>
</li>
<li>
<p>很适合做 mock、日志劫持、性能监控等插件功能</p>
</li>
</ul>
<p>比如我最近写的一个基础的 mock 插件(<a href="https://juejin.cn/post/7570984257666056238" target="_blank" title="https://juejin.cn/post/7570984257666056238">juejin.cn/post/757098…</a>), 就是用这种方式，在页面加载前偷偷把 fetch 和 XMLHttpRequest 替换成我重写的，让所有网络请求都能被插件拦截和处理。</p>
<h5 data-id="heading-10">跨环境通信流程举例</h5>
<p>有时候，我们的注入页面脚本（injected.js）需要用到插件进程里的数据，比如判断某个 fetch 请求是否命中插件配置的规则。但页面环境是拿不到插件进程里的配置的，不过内容脚本可以帮忙“中转”。</p>
<p>比如我们在 injected.js 里重写了 fetch 方法，页面发起请求后，需要查一下插件里有没有对应的 mock 规则。整个数据流可以这样走：</p>
<ul>
<li>
<ol>
<li>注入脚本（injected.js）拦截到 fetch 请求，发现需要插件里的规则配置。</li>
</ol>
</li>
<li>
<ol start="2">
<li>注入脚本用 window.postMessage 向内容脚本发消息，请求规则数据。</li>
</ol>
</li>
<li>
<ol start="3">
<li>内容脚本收到消息后，再用 chrome.runtime.sendMessage 向插件进程（比如后台脚本）发起请求，获取最新规则。</li>
</ol>
</li>
<li>
<ol start="4">
<li>插件进程通过 IPC 机制把规则数据返回给内容脚本。</li>
</ol>
</li>
<li>
<ol start="5">
<li>内容脚本拿到数据后，再用 window.postMessage 把结果传回 injected.js。</li>
</ol>
</li>
<li>
<ol start="6">
<li>注入脚本拿到规则，判断请求是否命中，然后做后续处理（比如 mock、拦截、日志等）。</li>
</ol>
</li>
</ul>
<p>这样一来，页面脚本、内容脚本、插件进程就能通过消息链路把数据安全地串联起来，实现复杂的功能扩展。 整个过程就像“接力传话”，每个环节各司其职，既保证了安全，又让插件和页面能灵活协作</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/398541a9c4df48e2b4d612ffefa12615~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764050800&amp;x-signature=qB3A%2BkU3KI%2Byl6kUWkxvrXKxfXQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">总结：插件多脚本通信，没那么难！</h3>
<p>看到这里，相信你已经对Chrome插件中的多脚本通信有了清晰的认识。让我们简单回顾一下今天学到的关键知识：</p>
<ol>
<li>为什么需要多脚本？</li>
</ol>
<ul>
<li>Chrome的多进程架构是为了安全和稳定性，不是为了故意为难开发者</li>
</ul>
<ol start="2">
<li>各脚本的角色：</li>
</ol>
<ul>
<li>background.js ：常驻后台，负责大部分逻辑和权限，是插件的大脑。</li>
<li>content.js ：嵌入页面，能操作DOM，但和页面JS是隔离的，像是派驻到页面的特工。</li>
<li>popup.html ：弹窗页面，主要负责UI交互，关闭就“失忆”，但用起来很方便。</li>
<li>injected.js ：直接注入页面，能访问和修改页面环境，类似卧底。</li>
</ul>
<ol start="3">
<li>通信秘诀：</li>
</ol>
<ul>
<li>background ↔ popup ：用 chrome.runtime.sendMessage</li>
<li>background ↔ content ：用 chrome.tabs.sendMessage 或 chrome.runtime.sendMessage</li>
<li>content ↔ 页面JS ：用 window.postMessage</li>
</ul>
<p>还记得开头那位苦恼的同事吗？现在你不仅知道为什么他的变量“死活拿不到”，更重要的是，掌握了正确的解决方法！</p>
<p>希望这篇文章能帮你少踩坑、多收获。如果觉得有用，欢迎点赞、收藏，你的支持是我持续分享的动力！</p>
<p>有任何问题，欢迎在评论区讨论。下期见！👋</p>
<blockquote>
<p>如果觉得对您有帮助，欢迎点赞 👍 收藏 ⭐ 关注 🔔 支持一下！</p>
<p><strong>往期实战推荐：</strong></p>
<ul>
<li>
<p><a href="https://juejin.cn/post/7549096640340426802" target="_blank" title="https://juejin.cn/post/7549096640340426802">Vue3 后台分页写腻了？我用 1 个 Hook 删掉 90% 重复代码（附源码）</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7511332054941188147" target="_blank" title="https://juejin.cn/post/7511332054941188147">⚡ 一个Vue自定义指令搞定丝滑拖拽列表，告别复杂组件封装
</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7543806966926802971" target="_blank" title="https://juejin.cn/post/7543806966926802971">🔥 这才是 Vue 驱动的 Chrome 插件工程化正确打开方式</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7566299971643424819" target="_blank" title="https://juejin.cn/post/7566299971643424819">  老板问我：AI真能一键画广州旅游路线图？我用 MCP 现场开图</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7559124639323242506" target="_blank" title="https://juejin.cn/post/7559124639323242506">【前端效率工具】：告别右键另存，不到 50 行代码一键批量下载网页图片</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7561612065707065390" target="_blank" title="https://juejin.cn/post/7561612065707065390"> 女朋友炸了：刚打开的网页怎么又没了？我反手甩出一键恢复按钮！</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7562859113246343178" target="_blank" title="https://juejin.cn/post/7562859113246343178"> 你家孩子又偷玩网页游戏? 试试这个防沉迷工具</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7563830723057647643" target="_blank" title="https://juejin.cn/post/7563830723057647643">  她说想要浪漫，我把浏览器鼠标换成了柴犬，点一下就有烟花（附源码）</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7566677296801071155" target="_blank" title="https://juejin.cn/post/7566677296801071155"> 女朋友被链接折磨疯了，我写了个工具一键解救</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7568055953310662707" target="_blank" title="https://juejin.cn/post/7568055953310662707"> 上班摸鱼看掘金，老板突然出现在身后...</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7570984257666056238" target="_blank" title="https://juejin.cn/post/7570984257666056238"> 【前端效率工具】再也不用 APIfox 联调！零侵入 Mock，全程不改代码、不开代理</a></p>
</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kafka 消息积压了，同事跑路了]]></title>    <link>https://juejin.cn/post/7573687816431190026</link>    <guid>https://juejin.cn/post/7573687816431190026</guid>    <pubDate>2025-11-18T07:54:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573687816431190026" data-draft-id="7573687816431140874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kafka 消息积压了，同事跑路了"/> <meta itemprop="keywords" content="Spring Cloud,Kafka,后端"/> <meta itemprop="datePublished" content="2025-11-18T07:54:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="纸仓"/> <meta itemprop="url" content="https://juejin.cn/user/1812410601572599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kafka 消息积压了，同事跑路了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1812410601572599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    纸仓
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T07:54:44.000Z" title="Tue Nov 18 2025 07:54:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>快到年底了，系统频繁出问题。我有正当理由怀疑老板不想发年终奖所以搞事。</p>
<p>这不，几年都遇不到的消息队列积压现象今晚又卷土重来了。</p>
<p>今晚注定是个不眠夜了，原神启动。。。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d262a2234a3345a5bd06d6e88cb83886~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764057283&amp;x-signature=EgR7MTMwdg1urXnKTvopJ4l0pdY%3D" alt="image.png" loading="lazy"/></p>
<p>组里的小伙伴火急火燎找到我说，Kafka 的消息积压一直在涨，预览图一直出不来。我加了几个服务实例，刚开始可以消费，后面消费着也卡住了。</p>
<p>本来刚刚下班的我就比较疲惫，想让他撤回镜像明天再上。不成想组长不讲武德，直接开了个飞书视频。</p>
<p>我当时本来不想理他，我已经下班了，别人上线的功能出问题关我啥事。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de4e28b56392431cb9ced680fc7ca0fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764057283&amp;x-signature=0E67yTsROPOVD8BnIxMoOI0E6Hg%3D" alt="image.png" loading="lazy"/></p>
<p>后来他趁我不注意搞偷袭，给我私信了，我当时没多想就点开了飞书。</p>
<p>本来以传统功夫的点到为止，我进入飞书不点开他的会话，是能看他给我发的最后一句话的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d01ffbdf60cd4787b53b80772b77e7a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764057283&amp;x-signature=HIYSUBEibj6LkQLBebckeAbaiu4%3D" alt="image.png" loading="lazy"/></p>
<p>我把手放在他那个会话上就是没点开，已读不回这种事做多了不好。我笑了一下，准备洗洗睡了。</p>
<p>正在我收手不点的时候，他突然给我来了一个电话，我大意了啊，没有挂，还强行接了他的电话。两分多钟以后就好了，我说小伙子你不讲武德。</p>
<p>直接喊话，今晚必须解决，大家都点咖啡算他的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd429dec7d7b40628ea638adf1398c1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764057283&amp;x-signature=BlGPf6cgFQnEht1CZSow5sSincg%3D" alt="image.png" loading="lazy"/>
这真没办法，都找上门来了。只能跟着查一下，早点解决早点睡觉。然后我就上 Kafka 面板一看：最初的4个分区已经积压了 1200 条，后面新加的分区也开始积压了，而且积压的速度越来越快。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/168bdb4c49b341a09684c6d7474a7aeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764057283&amp;x-signature=IQk0XL6JvXa3zCv32Ke%2BxEF0%2BdY%3D" alt="image.png" loading="lazy"/></p>
<p>搞清楚发生了什么？我们就得思考一下导致积压的原因。一般是消费者代码执行出错了，导致某条消息消费不了。</p>
<p>所以某个点卡住了，然后又有新的消息进来。</p>
<p>Kafka 是通过 offset 机制来标记消息是否消费过的，所以如果分区中有某一条消息消费失败，就会导致后面的没机会消费。</p>
<p>我用的是spring cloud stream 来处理消息队列的发送和监听。代码上是每次处理一条消息，而且代码还在处理的过程中加了 try-catch。监听器链路打印的日志显示执行成功了，try-catch也没有捕捉到任何的异常。</p>
<p>这一看，我就以为是消费者性能不足，突然想起 SpringCloudStream 好像有个多线程消费的机制。立马让开发老哥试试，看看能不能就这样解决了，我困得不行。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4aa5194bc0dd4d11a11e4f420644b18d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764057283&amp;x-signature=%2BrMIs%2FHVShaV5EWk1STUCapwJDI%3D" alt="image.png" loading="lazy"/></p>
<p>我半眯着眼睛被提醒吵醒了。开发老哥把多线程改成10之后，发现积压更快了，而且还有pod会挂。老哥查了一下多线程的配置 concurrency。</p>
<p>原来指的是消费者线程，一个消费者线程会负责处理一个分区。对于我们来说，增加之后可能会导致严重的流量倾斜，难怪pod会挂掉，赶紧恢复了回去。</p>
<p>看来想糊弄过去是不行了，我把pod运行的日志全部拉下来。查了一下日志，日志显示执行成功了，但同时有超时错误，这就见了鬼了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f520d30783e648208fc84f9af2fa7e15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764057283&amp;x-signature=9Xd6ePItrR7Gza9g4a4v6jmip84%3D" alt="image.png" loading="lazy"/></p>
<p>作为一个坚定的唯物主义者，我是不信见鬼的。但此刻我汗毛倒竖，吓得不敢再看屏幕一眼。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e734b9c41f6d44cc9d91f95346099844~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764057283&amp;x-signature=uJ6DjPAI2ah7TsTUDgNrZgaYilU%3D" alt="image.png" loading="lazy"/></p>
<p>但是内心又觉得不甘心，于是我偷偷瞄了一眼屏幕。不看还好，一喵你猜我发现了啥？</p>
<p>消费者组重平衡了，这就像是在黑暗中有一束光照向了我，猪八戒发现嫦娥原来一直暗恋自己，我的女神其实不需要拉屎。</p>
<p>有了重平衡就好说了，无非就是两种情况，一是服务挂掉了，二是服务消费者执行超时了。现在看来服务没有挂，那就是超时了，也正好和上面的日志能对上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04985de725e14d628345e7b71ee76d0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764057283&amp;x-signature=iK374RfLuibUb%2BoRMw%2BlPETGfq0%3D" alt="image.png" loading="lazy"/></p>
<p>那怎么又看到监听器执行的结果是正常的呢？</p>
<p>这就得从 Kafka 的批量拉取机制说起了，这货和我们人类直觉上的的队列机制不太一样。我们一般理解的队列是发送一个消息给队列，然后队列就异步把这消息给消费者。但是这货是消费者主动去<strong>拉取一批</strong>来消费。</p>
<p>然后好死不死，SpringCloudStream 为了封装得好用符合人类的认知，就做成了一般理解的队列那种方式。</p>
<p>SpringCloudStream 一批拉了500条记录，然后提供了一个监听器接口让我们实现。入参是一个对象，也就是500条数据中的一条，而不是一个数组。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/659126ce33d44c4e887c1df1db5655f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764057283&amp;x-signature=cbDMY0wPWJdT9Y9FacBwEj61cyk%3D" alt="image.png" loading="lazy"/></p>
<p>我们假设这500条数据的ID是 001-500，每一条数据对应的消费者需要执行10s。那么总共就需要500 x 10s=5000s。</p>
<p>再假设消费者执行的超时时间是 300s，而且消费者执行的过程是串行的。那么500条中最多只能执行30条，这就能解释为什么看消费链路是正常的，但是还超时。</p>
<p>因为单次消费确实成功了，但是批次消费也确实超时了。</p>
<p>我咧个豆，破案了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01f37852aca94c5e82fb78b2cf547c96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764057283&amp;x-signature=obku9iCkmjK%2BKHFoNtRFYpM%2B8h4%3D" alt="image.png" loading="lazy"/></p>
<p>于是我就想到了两种方式来处理这个问题：第一是改成单条消息消费完立马确认，第二是把批次拉取的数据量改小一点。</p>
<p>第一种方案挺好的，就是性能肯定没有批量那么好，不然你以为 Kafka 的吞吐量能薄纱ActiveMQ这些传统队列。吞吐量都是小事，这个方案胜在可以立马去睡觉了。只需要改一个配置：<code>ack-mode: RECORD</code></p>
<p>第二种方案是后来提的，其实单单把批次拉取的数据量改小性能提升还不是很明显。不过既然我们都能拿到一批数据了，那多线程安排上就得了。</p>
<p>先改配置，一次只拉取50条 <code>max.poll.records: 50</code>。然后启用线程池处理，完美！</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@StreamListener("&lt;TOPIC&gt;")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">consume</span><span class="hljs-params">(List&lt;<span class="hljs-type">byte</span>[]&gt; payloads)</span> {
    
    List&lt;CompletableFuture&lt;Void&gt;&gt; futures = payloads.stream().map(bytes -&gt; {
        <span class="hljs-type">Payload</span> <span class="hljs-variable">payload</span> <span class="hljs-operator">=</span> JacksonSnakeCaseUtils.parseJson(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bytes), Payload.class);

        <span class="hljs-keyword">return</span> CompletableFuture.runAsync(() -&gt; {
            <span class="hljs-comment">// ........</span>
        }, batchConsumeExecutor).exceptionally(e -&gt; {
            log.error(<span class="hljs-string">"Thread error {}"</span>, bytes, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        });
    }).collect(Collectors.toList());

    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 等待这批消息中的所有任务全部完成</span>
        CompletableFuture.allOf(futures.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>[<span class="hljs-number">0</span>])).join();
        errorMessage = <span class="hljs-string">"OK"</span>;
    } <span class="hljs-keyword">catch</span> (Exception e) {
        errorMessage = <span class="hljs-string">"Ex: "</span> + e.getMessage();
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22c364e4a4264b7394cdcd4ea05eadb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764057283&amp;x-signature=052zcBN1DKbaLbU2W6KA1WK2yNw%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Langchain Template 全面指南]]></title>    <link>https://juejin.cn/post/7573535624532639763</link>    <guid>https://juejin.cn/post/7573535624532639763</guid>    <pubDate>2025-11-17T16:51:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573535624532639763" data-draft-id="7573524348130050111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Langchain Template 全面指南"/> <meta itemprop="keywords" content="LangChain,OpenAI"/> <meta itemprop="datePublished" content="2025-11-17T16:51:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端小东"/> <meta itemprop="url" content="https://juejin.cn/user/932815872994359"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Langchain Template 全面指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/932815872994359/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端小东
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T16:51:42.000Z" title="Mon Nov 17 2025 16:51:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p><code>LangChain Template</code> 是 LangChain 提示工程的核心组件，用于动态生成模型的输入。</p>
<p>🎯 <strong>Template</strong> 的核心概念：</p>
<p><strong>Template</strong> 本质是一个带有<strong>占位符</strong>的文本字符串，这些占位符会在运行时被具体的值填充。它的主要目的是将<strong>提示逻辑</strong>与<strong>业务数据</strong>分离。</p>
<h2 data-id="heading-1">模板分类</h2>
<h3 data-id="heading-2">1. 🎯 基础模板类（Core Templates）</h3>
<h4 data-id="heading-3">(1) <code>PromptTemplate</code></h4>
<p><strong>最基础的文本模板</strong></p>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import PromptTemplate

<span class="hljs-comment"># 创建模板的两种方式</span>
<span class="hljs-comment"># 方式1: 使用 from_template (推荐)</span>
<span class="hljs-attr">template</span> = PromptTemplate.from_template(<span class="hljs-string">"请把{text}翻译成{language}"</span>)
<span class="hljs-attr">result</span> = template.format(text=<span class="hljs-string">"Hello"</span>, language=<span class="hljs-string">"中文"</span>)
print(result)  <span class="hljs-comment"># 输出: "请把Hello翻译成中文"</span>

<span class="hljs-comment"># 方式2: 传统创建方式</span>
<span class="hljs-attr">template</span> = PromptTemplate(
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"text"</span>, <span class="hljs-string">"language"</span>],
    <span class="hljs-attr">template</span>=<span class="hljs-string">"请把{text}翻译成{language}"</span>
)

<span class="hljs-comment"># 实际应用示例</span>
<span class="hljs-attr">translation_template</span> = PromptTemplate.from_template(
    "将以下{source_lang}文本翻译成{target_lang}：{text}"
)
<span class="hljs-attr">translation_result</span> = translation_template.format(
    <span class="hljs-attr">source_lang</span>=<span class="hljs-string">"英文"</span>,
    <span class="hljs-attr">target_lang</span>=<span class="hljs-string">"中文"</span>, 
    <span class="hljs-attr">text</span>=<span class="hljs-string">"Hello, how are you?"</span>
)
</code></pre>
<h4 data-id="heading-4">(2) <code>ChatPromptTemplate</code></h4>
<p><strong>聊天消息模板（最常用）</strong></p>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import ChatPromptTemplate

<span class="hljs-comment"># 创建聊天提示模板</span>
<span class="hljs-attr">chat_prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个{role}"</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"请回答：{question}"</span>)
])

<span class="hljs-comment"># 格式化模板</span>
<span class="hljs-attr">messages</span> = chat_prompt.format_messages(
    <span class="hljs-attr">role</span>=<span class="hljs-string">"数学老师"</span>,
    <span class="hljs-attr">question</span>=<span class="hljs-string">"什么是勾股定理？"</span>
)

<span class="hljs-comment"># 实际应用：客服机器人模板</span>
<span class="hljs-attr">customer_service_prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是{company}的客服代表，专门处理{department}问题"</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"我遇到了一个问题：{issue_description}"</span>),
    (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"我很理解您的情况，让我来帮您解决。"</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"具体的细节是：{details}"</span>)
])
</code></pre>
<h3 data-id="heading-5">2. 👥 消息模板类（Message Templates）</h3>
<p>这些是 <code>ChatPromptTemplate</code> 的组成部分：</p>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import (
    SystemMessagePromptTemplate,
    HumanMessagePromptTemplate,
    AIMessagePromptTemplate,
    FunctionMessagePromptTemplate
)

<span class="hljs-comment"># 创建各种消息模板</span>
<span class="hljs-attr">system_template</span> = SystemMessagePromptTemplate.from_template(
    "你是{role}，具有{expertise}专业知识"
)
<span class="hljs-attr">human_template</span> = HumanMessagePromptTemplate.from_template(
    "我的问题是：{question}"
)
<span class="hljs-attr">ai_template</span> = AIMessagePromptTemplate.from_template(
    "根据我的知识，{answer}"
)

<span class="hljs-comment"># 组合使用</span>
<span class="hljs-attr">chat_prompt</span> = ChatPromptTemplate.from_messages([
    system_template, 
    human_template,
    ai_template
])

<span class="hljs-comment"># 完整示例：编程助手</span>
<span class="hljs-attr">programming_prompt</span> = ChatPromptTemplate.from_messages([
    SystemMessagePromptTemplate.from_template(
        <span class="hljs-string">"你是{language}编程专家，擅长{domain}开发"</span>
    ),
    HumanMessagePromptTemplate.from_template(
        <span class="hljs-string">"请帮我解决这个编程问题：{problem}"</span>
    ),
    AIMessagePromptTemplate.from_template(
        <span class="hljs-string">"我会按照以下思路解决：{approach}"</span>
    ),
    HumanMessagePromptTemplate.from_template(
        <span class="hljs-string">"具体实现代码是？"</span>
    )
])
</code></pre>
<h3 data-id="heading-6">3. 🎪 高级模板类（Advanced Templates）</h3>
<h4 data-id="heading-7">(7) <code>FewShotPromptTemplate</code></h4>
<p><strong>少样本学习模板</strong></p>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import FewShotPromptTemplate, PromptTemplate

<span class="hljs-comment"># 定义示例数据</span>
<span class="hljs-attr">examples</span> = [
    {
        <span class="hljs-string">"input"</span>: <span class="hljs-string">"The weather is nice today"</span>, 
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"今天天气很好"</span>
    },
    {
        <span class="hljs-string">"input"</span>: <span class="hljs-string">"I love programming"</span>, 
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"我喜欢编程"</span>
    },
    {
        <span class="hljs-string">"input"</span>: <span class="hljs-string">"The meeting starts at 3 PM"</span>, 
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"会议下午三点开始"</span>
    }
]

<span class="hljs-comment"># 定义单个示例的模板</span>
<span class="hljs-attr">example_template</span> = PromptTemplate.from_template(
    "英文: {input}\n中文: {output}"
)

<span class="hljs-comment"># 创建少样本提示模板</span>
<span class="hljs-attr">few_shot_prompt</span> = FewShotPromptTemplate(
    <span class="hljs-attr">examples</span>=examples,
    <span class="hljs-attr">example_prompt</span>=example_template,
    <span class="hljs-attr">prefix</span>=<span class="hljs-string">"请根据以下示例将英文翻译成中文："</span>,
    <span class="hljs-attr">suffix</span>=<span class="hljs-string">"英文: {input}\n中文:"</span>,
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"input"</span>]
)

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-attr">result</span> = few_shot_prompt.format(input=<span class="hljs-string">"Thank you for your help"</span>)
print("=== 生成的提示 ===")
print(result)

<span class="hljs-comment"># 实际应用：情感分析少样本模板</span>
<span class="hljs-attr">sentiment_examples</span> = [
    {<span class="hljs-string">"text"</span>: <span class="hljs-string">"这个产品太棒了！"</span>, <span class="hljs-string">"sentiment"</span>: <span class="hljs-string">"正面"</span>},
    {<span class="hljs-string">"text"</span>: <span class="hljs-string">"服务很差，很不满意"</span>, <span class="hljs-string">"sentiment"</span>: <span class="hljs-string">"负面"</span>},
    {<span class="hljs-string">"text"</span>: <span class="hljs-string">"还可以，一般般"</span>, <span class="hljs-string">"sentiment"</span>: <span class="hljs-string">"中性"</span>}
]

<span class="hljs-attr">sentiment_template</span> = FewShotPromptTemplate(
    <span class="hljs-attr">examples</span>=sentiment_examples,
    <span class="hljs-attr">example_prompt</span>=PromptTemplate.from_template(
        "文本: {text}\n情感: {sentiment}"
    ),
    <span class="hljs-attr">prefix</span>=<span class="hljs-string">"分析以下文本的情感倾向："</span>,
    <span class="hljs-attr">suffix</span>=<span class="hljs-string">"文本: {text}\n情感:"</span>,
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"text"</span>]
)
</code></pre>
<h4 data-id="heading-8">(8) <code>FewShotChatMessagePromptTemplate</code></h4>
<p><strong>聊天版的少样本模板</strong></p>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import FewShotChatMessagePromptTemplate, ChatPromptTemplate

<span class="hljs-comment"># 定义聊天示例</span>
<span class="hljs-attr">chat_examples</span> = [
    {
        <span class="hljs-string">"input"</span>: <span class="hljs-string">"今天的天气怎么样？"</span>,
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"我无法获取实时天气信息，请查看天气预报应用。"</span>
    },
    {
        <span class="hljs-string">"input"</span>: <span class="hljs-string">"现在几点了？"</span>,
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"我无法获取当前时间，请查看您的设备时钟。"</span>
    },
    {
        <span class="hljs-string">"input"</span>: <span class="hljs-string">"我的快递到哪里了？"</span>, 
        <span class="hljs-string">"output"</span>: <span class="hljs-string">"我无法查询物流信息，请使用快递公司的官方应用查询。"</span>
    }
]

<span class="hljs-comment"># 创建示例模板</span>
<span class="hljs-attr">example_prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>),
    (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"{output}"</span>)
])

<span class="hljs-comment"># 创建少样本聊天模板</span>
<span class="hljs-attr">few_shot_chat</span> = FewShotChatMessagePromptTemplate(
    <span class="hljs-attr">examples</span>=chat_examples,
    <span class="hljs-attr">example_prompt</span>=example_prompt
)

<span class="hljs-comment"># 组合到完整提示中</span>
<span class="hljs-attr">final_prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个有帮助的AI助手，请礼貌地回答用户问题。"</span>),
    few_shot_chat,
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{user_input}"</span>)
])

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-attr">messages</span> = final_prompt.format_messages(
    <span class="hljs-attr">user_input</span>=<span class="hljs-string">"我的银行余额是多少？"</span>
)
</code></pre>
<h3 data-id="heading-9">4. 🧩 特殊用途模板</h3>
<h4 data-id="heading-10">(9) <code>MessagesPlaceholder</code></h4>
<p><strong>消息占位符（用于动态插入消息）</strong></p>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import MessagesPlaceholder, ChatPromptTemplate

<span class="hljs-comment"># 创建带消息占位符的模板</span>
<span class="hljs-attr">prompt_with_history</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是专业的{expert_role}"</span>),
    MessagesPlaceholder(variable_name=<span class="hljs-string">"chat_history"</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{current_question}"</span>)
])

<span class="hljs-comment"># 模拟对话历史</span>
<span class="hljs-attr">chat_history</span> = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"human"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"什么是Python？"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"ai"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Python是一种编程语言。"</span>}
]

<span class="hljs-comment"># 格式化模板</span>
<span class="hljs-attr">messages</span> = prompt_with_history.format_messages(
    <span class="hljs-attr">expert_role</span>=<span class="hljs-string">"编程教师"</span>,
    <span class="hljs-attr">chat_history</span>=chat_history,
    <span class="hljs-attr">current_question</span>=<span class="hljs-string">"Python有什么特点？"</span>
)

<span class="hljs-comment"># 实际应用：带记忆的对话系统</span>
<span class="hljs-attr">memory_prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"""你是{assistant_name}，具有以下特点：
    - 专业领域: {expertise}
    - 回答风格: {style}
    - 语言: {language}"""</span>),
    
    MessagesPlaceholder(variable_name=<span class="hljs-string">"conversation_history"</span>),
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{current_input}"</span>)
])
</code></pre>
<h2 data-id="heading-11">🔗 Template 关系图谱</h2>
<pre><code class="hljs language-scss" lang="scss">PromptTemplate (基类)
    │
    ├── ChatPromptTemplate (组合多个消息)
    │       ├── SystemMessagePromptTemplate
    │       ├── HumanMessagePromptTemplate  
    │       ├── AIMessagePromptTemplate
    │       └── FunctionMessagePromptTemplate
    │
    ├── FewShotPromptTemplate (包含example_prompt)
    │
    └── FewShotChatMessagePromptTemplate (专门用于聊天)
</code></pre>
<h2 data-id="heading-12">🎯 核心关系说明</h2>
<h3 data-id="heading-13">关系1：<strong>包含关系</strong></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># FewShotPromptTemplate 包含 PromptTemplate</span>
<span class="hljs-attr">examples</span> = [
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"hello"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"你好"</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"goodbye"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"再见"</span>}
]

<span class="hljs-attr">example_prompt</span> = PromptTemplate.from_template(
    "输入: {input}\n输出: {output}"
)

<span class="hljs-attr">few_shot_prompt</span> = FewShotPromptTemplate(
    <span class="hljs-attr">example_prompt</span>=example_prompt,  <span class="hljs-comment"># 包含关系</span>
    <span class="hljs-attr">examples</span>=examples,
    <span class="hljs-attr">prefix</span>=<span class="hljs-string">"翻译任务："</span>,
    <span class="hljs-attr">suffix</span>=<span class="hljs-string">"输入: {input}\n输出:"</span>,
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"input"</span>]
)

<span class="hljs-comment"># ChatPromptTemplate 包含 MessagePromptTemplates</span>
<span class="hljs-attr">system_template</span> = SystemMessagePromptTemplate.from_template(<span class="hljs-string">"系统: {role}"</span>)
<span class="hljs-attr">human_template</span> = HumanMessagePromptTemplate.from_template(<span class="hljs-string">"用户: {question}"</span>)

<span class="hljs-attr">chat_prompt</span> = ChatPromptTemplate.from_messages([
    system_template,    <span class="hljs-comment"># 包含关系</span>
    human_template      <span class="hljs-comment"># 包含关系</span>
])
</code></pre>
<h3 data-id="heading-14">关系2：<strong>组合关系</strong></h3>
<pre><code class="hljs language-ini" lang="ini">from langchain.prompts import ChatPromptTemplate, FewShotChatMessagePromptTemplate

<span class="hljs-comment"># 创建少样本部分</span>
<span class="hljs-attr">few_shot_examples</span> = [
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"如何学习编程？"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"建议从基础语法开始..."</span>},
    {<span class="hljs-string">"input"</span>: <span class="hljs-string">"最好的编程语言？"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"这取决于你的目标..."</span>}
]

<span class="hljs-attr">few_shot_section</span> = FewShotChatMessagePromptTemplate(
    <span class="hljs-attr">example_prompt</span>=ChatPromptTemplate.from_messages([
        (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>),
        (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"{output}"</span>)
    ]),
    <span class="hljs-attr">examples</span>=few_shot_examples
)

<span class="hljs-comment"># FewShotChatMessagePromptTemplate 作为 ChatPromptTemplate 的一部分</span>
<span class="hljs-attr">final_prompt</span> = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是{teacher_type}老师"</span>),
    few_shot_section,  <span class="hljs-comment"># 组合关系</span>
    MessagesPlaceholder(variable_name=<span class="hljs-string">"history"</span>),  <span class="hljs-comment"># 组合关系</span>
    HumanMessagePromptTemplate.from_template(<span class="hljs-string">"{current_input}"</span>)
])

<span class="hljs-comment"># 使用组合模板</span>
<span class="hljs-attr">formatted_messages</span> = final_prompt.format_messages(
    <span class="hljs-attr">teacher_type</span>=<span class="hljs-string">"编程"</span>,
    <span class="hljs-attr">history</span>=[],
    <span class="hljs-attr">current_input</span>=<span class="hljs-string">"如何调试代码？"</span>
)
</code></pre>
<h2 data-id="heading-15">🛠️ 实际使用场景对比</h2>
<h3 data-id="heading-16">场景1：简单文本生成 → <code>PromptTemplate</code></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 诗歌生成</span>
<span class="hljs-attr">poem_template</span> = PromptTemplate.from_template(<span class="hljs-string">"""
请以{style}风格写一首关于{topic}的诗。

要求：
- 意境: {mood}
- 长度: {length}
- 语言: {language}

诗歌：
"""</span>)

<span class="hljs-attr">poem_prompt</span> = poem_template.format(
    <span class="hljs-attr">style</span>=<span class="hljs-string">"浪漫"</span>,
    <span class="hljs-attr">topic</span>=<span class="hljs-string">"春天"</span>, 
    <span class="hljs-attr">mood</span>=<span class="hljs-string">"欢快"</span>,
    <span class="hljs-attr">length</span>=<span class="hljs-string">"八句"</span>,
    <span class="hljs-attr">language</span>=<span class="hljs-string">"中文"</span>
)
</code></pre>
<h3 data-id="heading-17">场景2：聊天对话 → <code>ChatPromptTemplate</code> + <code>MessageTemplates</code></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 专业咨询对话</span>
<span class="hljs-attr">system_msg</span> = SystemMessagePromptTemplate.from_template(<span class="hljs-string">"""
你是{profession}顾问，具有以下资质：
- 经验: {experience}
- 专长: {specialization} 
- 认证: {certifications}
"""</span>)

<span class="hljs-attr">human_msg</span> = HumanMessagePromptTemplate.from_template(<span class="hljs-string">"""
我的咨询问题是：{question}

背景信息：
{context}
"""</span>)

<span class="hljs-attr">chat_prompt</span> = ChatPromptTemplate.from_messages([system_msg, human_msg])

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-attr">messages</span> = chat_prompt.format_messages(
    <span class="hljs-attr">profession</span>=<span class="hljs-string">"法律"</span>,
    <span class="hljs-attr">experience</span>=<span class="hljs-string">"10年"</span>,
    <span class="hljs-attr">specialization</span>=<span class="hljs-string">"合同法"</span>,
    <span class="hljs-attr">certifications</span>=<span class="hljs-string">"律师执业证"</span>,
    <span class="hljs-attr">question</span>=<span class="hljs-string">"合同违约如何处理？"</span>,
    <span class="hljs-attr">context</span>=<span class="hljs-string">"甲方未按约定时间付款"</span>
)
</code></pre>
<h3 data-id="heading-18">场景3：示例学习 → <code>FewShotPromptTemplate</code></h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 代码生成少样本学习</span>
<span class="hljs-attr">code_examples</span> = [
    {
        <span class="hljs-string">"requirement"</span>: <span class="hljs-string">"计算列表平均值"</span>,
        <span class="hljs-string">"code"</span>: <span class="hljs-string">"def calculate_average(numbers):\n    return sum(numbers) / len(numbers)"</span>
    },
    {
        <span class="hljs-string">"requirement"</span>: <span class="hljs-string">"反转字符串"</span>, 
        <span class="hljs-string">"code"</span>: <span class="hljs-string">"def reverse_string(s):\n    return s[::-1]"</span>
    }
]

<span class="hljs-attr">code_template</span> = FewShotPromptTemplate(
    <span class="hljs-attr">examples</span>=code_examples,
    <span class="hljs-attr">example_prompt</span>=PromptTemplate.from_template(
        "需求: {requirement}\n代码: {code}"
    ),
    <span class="hljs-attr">prefix</span>=<span class="hljs-string">"请根据示例编写Python代码："</span>,
    <span class="hljs-attr">suffix</span>=<span class="hljs-string">"需求: {requirement}\n代码:"</span>,
    <span class="hljs-attr">input_variables</span>=[<span class="hljs-string">"requirement"</span>]
)

<span class="hljs-attr">code_prompt</span> = code_template.format(
    <span class="hljs-attr">requirement</span>=<span class="hljs-string">"检查字符串是否是回文"</span>
)
</code></pre>
<h3 data-id="heading-19">场景4：复杂聊天 + 示例 → 组合使用</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 创建少样本部分</span>
<span class="hljs-attr">few_shot_examples</span> = [
    {
        <span class="hljs-string">"situation"</span>: <span class="hljs-string">"用户询问个人隐私信息"</span>,
        <span class="hljs-string">"response"</span>: <span class="hljs-string">"出于安全考虑，我无法访问或提供个人隐私信息。"</span>
    },
    {
        <span class="hljs-string">"situation"</span>: <span class="hljs-string">"用户要求违法帮助"</span>, 
        <span class="hljs-string">"response"</span>: <span class="hljs-string">"抱歉，我无法提供任何违法或不道德行为的帮助。"</span>
    }
]

<span class="hljs-attr">few_shot_section</span> = FewShotChatMessagePromptTemplate(
    <span class="hljs-attr">example_prompt</span>=ChatPromptTemplate.from_messages([
        (<span class="hljs-string">"human"</span>, <span class="hljs-string">"情境: {situation}"</span>),
        (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"回复: {response}"</span>)
    ]),
    <span class="hljs-attr">examples</span>=few_shot_examples
)

<span class="hljs-comment"># 2. 创建完整聊天提示</span>
<span class="hljs-attr">final_prompt</span> = ChatPromptTemplate.from_messages([
    SystemMessagePromptTemplate.from_template(<span class="hljs-string">"""
    你是{assistant_name}，安全准则：
    - {safety_guidelines}
    - 始终遵守{regulations}
    """</span>),
    
    few_shot_section,  <span class="hljs-comment"># 包含少样本示例</span>
    
    MessagesPlaceholder(variable_name=<span class="hljs-string">"conversation_history"</span>),  <span class="hljs-comment"># 动态历史</span>
    
    HumanMessagePromptTemplate.from_template(<span class="hljs-string">"当前查询: {current_query}"</span>)
])

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-attr">messages</span> = final_prompt.format_messages(
    <span class="hljs-attr">assistant_name</span>=<span class="hljs-string">"安全助手"</span>,
    <span class="hljs-attr">safety_guidelines</span>=<span class="hljs-string">"不分享个人信息，不提供违法建议"</span>,
    <span class="hljs-attr">regulations</span>=<span class="hljs-string">"AI使用规范"</span>,
    <span class="hljs-attr">conversation_history</span>=[],
    <span class="hljs-attr">current_query</span>=<span class="hljs-string">"你能告诉我别人的电话号码吗？"</span>
)
</code></pre>
<h2 data-id="heading-20">📝 使用频率总结</h2>


















































<table><thead><tr><th>Template 类型</th><th>用途</th><th>使用频率</th></tr></thead><tbody><tr><td><code>PromptTemplate</code></td><td>基础文本模板</td><td>⭐⭐⭐⭐</td></tr><tr><td><code>ChatPromptTemplate</code></td><td>聊天消息组合</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><code>SystemMessagePromptTemplate</code></td><td>系统消息</td><td>⭐⭐⭐⭐</td></tr><tr><td><code>HumanMessagePromptTemplate</code></td><td>用户消息</td><td>⭐⭐⭐⭐</td></tr><tr><td><code>AIMessagePromptTemplate</code></td><td>AI消息</td><td>⭐⭐⭐</td></tr><tr><td><code>FewShotPromptTemplate</code></td><td>少样本学习</td><td>⭐⭐⭐</td></tr><tr><td><code>FewShotChatMessagePromptTemplate</code></td><td>聊天少样本</td><td>⭐⭐</td></tr><tr><td><code>MessagesPlaceholder</code></td><td>动态消息占位</td><td>⭐⭐</td></tr></tbody></table>
<h2 data-id="heading-21">总结</h2>
<p><code>LangChain Template</code> 提供了强大而灵活的提示工程能力：</p>
<ul>
<li><strong>🎯 精准控制</strong>: 通过模板精确控制模型输入，确保提示的一致性</li>
<li><strong>♻️ 可复用性</strong>: 一次创建，多处使用，提高开发效率</li>
<li><strong>🔧 模块化</strong>: 像搭积木一样组合模板，支持复杂场景</li>
<li><strong>🛡️ 可靠性</strong>: 类型安全和错误检查，减少运行时错误</li>
<li><strong>🚀 高效开发</strong>: 加速 AI 应用开发流程，降低维护成本</li>
</ul>
<p>掌握 <code>LangChain Template</code> 是构建高质量大模型应用的关键技能，它让提示工程从艺术走向工程化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[打包票！前端和小白一定明白的人工智能基础概念！]]></title>    <link>https://juejin.cn/post/7573592127299108914</link>    <guid>https://juejin.cn/post/7573592127299108914</guid>    <pubDate>2025-11-18T05:38:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573592127299108914" data-draft-id="7573595009553137674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="打包票！前端和小白一定明白的人工智能基础概念！"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-18T05:38:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            打包票！前端和小白一定明白的人工智能基础概念！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T05:38:01.000Z" title="Tue Nov 18 2025 05:38:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AI时代，不知道你是否和我有同样的经历：搜索了大量号称“小白也能看懂”的AI科普文章，结果点进去，仍有90%的内容让人一头雾水。</p>
<p>这篇文章，是我在阅读众多资料后，整理出的一份更易懂的总结。它不强求全面，但力求逻辑清晰、层层递进——从基础概念逐步引出更复杂的内容，而不是一上来就抛出“神经网络”“深度学习”或“ChatGPT预测模型”这样的术语。</p>
<p>我相信，只要你具备初中知识水平，就能轻松理解。让我们开始吧！</p>
<h2 data-id="heading-0">一、人工智能的起源</h2>
<p>1956年，一群科学家在达特茅斯会议上首次提出“人工智能”这一概念。他们讨论的核心问题是：如何制造出能够学习并模拟人类智能的机器。</p>
<p>从此，人工智能作为一个独立的研究领域正式诞生。</p>
<p>但问题在于，机器处理信息的方式与人类截然不同。机器接收的所有数据最终都会转化为数字（包括文字）。</p>
<blockquote>
<p>简单解释为什么文字在计算机内部也是数字表示的，就涉及到编码的知识，例如 ASCII 编码，字母 a 在计算机内部表示 97。而 97 最终会被解释而 2 进制，因为计算机本身就是 2 进制的。它只能认识 0 和 1。然后我们将数字和文字做个映射，例如 <code>01100001</code> 表示字母 a ，而 <code>01100001</code> 的 10 进制就是 97.</p>
</blockquote>
<p>我们抽象一下计算机的思考方式，简单来说就是：</p>
<p>f(x)=<em>y</em></p>
<ul>
<li>
<p>我们向计算机输入参数 x</p>
</li>
<li>
<p>计算机将参数转为数字（这就是为什么很多文章说什么向量这个概念，向量可以简单理解为数字组成的多维数组，也就是说例如 “苹果” 这个词，最终要转化为数字，计算机才能理解），然后通过函数 f 处理并计算</p>
</li>
<li>
<p>最终输出结果 y</p>
</li>
</ul>
<p>但这显然不是人类思考问题的方式。那么，如何让机器具备类似人类的判断与学习能力，成为真正的“智能机器”呢？</p>
<p>科学家们提出了不同的思路。</p>
<h2 data-id="heading-1">二、符号主义：用规则模拟智能</h2>
<p>在人工智能的早期阶段，符号主义（Symbolism）是一种主流思路。它认为，可以通过数学逻辑来模拟人类的推理过程。</p>
<p>举个例子，我们设计一个判断是否下雨的机器：</p>
<ul>
<li>
<p>参数 a<em>a</em>：是否为阴天</p>
</li>
<li>
<p>参数 b<em>b</em>：湿度是否大于70%</p>
</li>
</ul>
<p>只有当 a 和 b 同时为“真”时，机器才输出“要下雨”，否则输出“不下雨”。</p>
<p>这种思路本质上就是编程中的 <code>if...else...</code> 逻辑。</p>
<p>别小看符号主义，它的成功应用之一就是“专家系统”。比如在医疗诊断中：</p>
<ul>
<li>
<p>从 头疼 + 发热 + 咳嗽 的症状 → 能推测出得了流感</p>
</li>
<li>
<p>从 腹痛 + 尿血 → 能推测出得了 肾结石</p>
</li>
</ul>
<p>通过一系列规则组合，专家系统能够模拟人类专家的决策过程，并在特定领域取得了显著成果。</p>
<p>但它也有明显的局限：</p>
<ol>
<li>
<p>规则难以统一：比如面对同一张股票走势图，不同专家可能做出完全相反的判断。</p>
</li>
<li>
<p>无法自主学习：系统本身不具备学习能力，依赖人工更新规则。</p>
</li>
</ol>
<p>随着研究的深入，另一种思路逐渐兴起：与其预设所有规则，不如让机器自己从数据中学习。这就是“联结主义”（Connectionism）。</p>
<h2 data-id="heading-2">三、联结主义：让机器自己学习</h2>
<p>这种模式有点像训狗，你说坐下，它坐下你就奖励零食，如果错了，就跟它一飞腿，这样你就能训练出一个会听坐下指令的狗了。</p>
<p>我们把狗换成机器，也可以用同样的方式训练，让它在某个任务下完成任务。例如说现在要训练一个能识别苹果图片的智能。</p>
<h3 data-id="heading-3">举例：识别苹果</h3>
<p>那么机器肯定要识别苹果的特征，才能区别别的图片，假设我们设置了如下维度</p>
<ul>
<li>
<p>直径: 苹果直径大约10cm</p>
</li>
<li>
<p>颜色: 苹果是红色</p>
</li>
<li>
<p>形状: 苹果是球形</p>
</li>
</ul>
<p>例如在某些条件下，直径，颜色，形状都符合苹果特性的条件下，才是苹果，但是我们之前说了，计算机只认识数字，只能通过计算来判断，所以我们需要结合一些数学公式来把 直径，颜色，形状，映射为数字，通过数字的计算映射它们在现实生活的是否对应。</p>
<p>既然文字也可以通过数字映射，例如 97 代表数字 a，那么其它属性也可以，例如（我乱说的，就是表达一种意思），我们把形状，颜色，和直径，都理解为权重。什么意思呢？我们举个例子:</p>
<p>假设我们给每个特征分配一个权重（weight），代表这个特征对“是否是苹果”的重要程度：</p>
<ul>
<li>
<p>直径：苹果直径约 10cm 权重 = +0.6（越接近 10cm 越可能是苹果）</p>
</li>
<li>
<p>颜色：红色程度（0 不是红，1 是红） 权重 = +0.3（红色对判断有贡献）</p>
</li>
<li>
<p>形状：球形程度（0 不是球形，1 是球形） 权重 = +0.4（球形对判断有贡献）</p>
</li>
</ul>
<p>然后，我们设计一个简单的“苹果得分”公式：</p>
<p>苹果得分=(直径得分)×0.6+(颜色得分)×0.3+(形状得分)×0.4</p>
<p>然后得出来的值，如果大于 1 就是苹果，如果小于 1 就不是苹果。</p>
<h3 data-id="heading-4">计算例子</h3>
<p>例1：一个红苹果（直径 10cm，红色，球形）</p>
<ul>
<li>直径得分 = 1</li>
<li>颜色得分 = 1</li>
<li>形状得分 = 1</li>
</ul>
<p>苹果得分 = 1×0.6+1×0.3+1×0.4=1.3</p>
<p>例2：一个橙子（直径 8cm，橙色，球形）</p>
<ul>
<li>直径得分 = 0.8（假设 8cm 离 10cm 差 2cm，得分 0.8）</li>
<li>颜色得分 = 0（不是红色）</li>
<li>形状得分 = 1</li>
<li/>
</ul>
<p>苹果得分 = 0.8×0.6+0×0.3+1×0.4=0.48+0.4=0.88</p>
<p>大家应该明白上面的意思了吧。我们再次抽象为数学公式，也就是变为 1 次函数。将得分用 x 表示，将权重用 w 表示，如下：</p>
<p><em>z</em> = (<em>w</em>1 × <em>x</em>1) + (<em>w</em>2 × <em>x</em>2) + (<em>w</em>3 × <em>x</em>3) + <em>b</em></p>
<p>其中：</p>
<ul>
<li>
<p>w1,w2,w3 是各特征的权重（重要性）</p>
</li>
<li>
<p>b 是偏置项（可理解为判断门槛）</p>
</li>
</ul>
<p>所以</p>
<ul>
<li>
<p>如果 z≥0，判定为苹果</p>
</li>
<li>
<p>如果 z&lt;0，判定为非苹果</p>
</li>
</ul>
<p>因为有 w1,w2,w3 3个参数，不利于我们后面的讲解，我们再次简化公式，来帮助我们理解后面的概念。</p>
<p><em>z</em> = (<em>w</em>1 × <em>x</em>1) + (<em>w</em>2 × <em>x</em>2) + <em>b</em></p>
<p>变为只有两个参数来决定是否是苹果，其实这是这是初中数学中的 <strong>线性方程</strong>，它的图像是一条直线。如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/460c799cbeb34e6aa592ff313d6496c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764049081&amp;x-signature=IOZzjUAdhfch1IA%2FB%2FtnvQ0j7c0%3D" alt="" loading="lazy"/></p>
<p>这条直线下方的就是就是非苹果，上方的就是苹果。</p>
<p>接下来有人会问，你说形状，直径这些特征的值，是怎么来的呢？</p>
<p>它们当然不是天然存在的，而是需要我们人为设计和提取的。这个过程在传统机器学习中被称为 “特征工程”。我们又要举一个粗糙的例子了，我们拿颜色得分来举例：</p>
<ul>
<li>
<p>思路： 苹果通常是红色、绿色或黄色。我们需要量化“红色程度”。</p>
</li>
<li>
<p>设计方法：</p>
<ul>
<li>
<p>如果是从图片中提取： 计算机可以分析图片的所有像素点。</p>
<ul>
<li>将图片从RGB颜色空间转换到 HSV 颜色空间（H代表色调，能更好地表示颜色本身）。</li>
<li>统计所有像素中，色调（H）在红色范围内（比如0-10度和350-360度）的像素比例。比例越高，<code>x2</code>越接近1。</li>
</ul>
</li>
<li>
<p>如果是从文字描述提取： 如果我们的数据是文字“深红色”，我们可以建立一个颜色词典：</p>
<ul>
<li>
<p>“深红色” -&gt; <code>x2 = 0.9</code></p>
</li>
<li>
<p>“浅红色” -&gt; <code>x2 = 0.7</code></p>
</li>
<li>
<p>“绿色” -&gt; <code>x2 = 0.3</code>（因为青苹果也存在）</p>
</li>
<li>
<p>“蓝色” -&gt; <code>x2 = 0</code></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>好了，特征得分我们解决了，然后就是训练，调整 w1 和 w2 参数，从而找出一个分界线，在分界线范围内的就是苹果，范围外的就是其它。当然这个分界线不一定是直线，也可以是很复杂的曲线范围，我们只是为了引出核心概念，就是：</p>
<p>“机器学习”！</p>
<p>虽然没有直接说出“机器学习”四个字，但已经完整地描绘了它的核心思想：通过数据（苹果的特征）和反馈（得分是否大于阈值），让机器自动调整内部参数（权重 w 和偏置 b），从而学会一项任务（识别苹果）。</p>
<p>我们接着聊，刚才我们举得例子非常粗糙，但可以很容易的理解大概的意思。</p>
<p>上面这种机器学习的思路，称为联结主义，可这种思路在最初曾一度被整个世界称为骗子思路！</p>
<h3 data-id="heading-5">为什么是骗子？</h3>
<p>刚才我们举了一个非常简单的例子，让机器根据 <strong>直径、颜色</strong> 来判断是不是苹果。</p>
<p>我们最终把它抽象成一个数学公式：</p>
<p><em>z</em> = (<em>w</em>1 × <em>x</em>1) + (<em>w</em>2 × <em>x</em>2) + <em>b</em></p>
<p>本质上，它就是一个<strong>一次函数</strong>（二维下是一条直线，三维下是一张平面）。</p>
<p>在很多任务中，这种模型真的能工作。</p>
<p>比如“苹果 vs 不是苹果”，</p>
<p>如果苹果的数据大多集中在同一块区域，那么一条直线（或平面）确实能把它们区分开来。</p>
<p>如果有一个任务，根本无法用一条直线分开呢？</p>
<p>科学家们很快就发现：</p>
<p>并不是所有问题都像识别苹果一样简单。</p>
<p>其中最典型的例子就是 <strong>异或</strong> <strong>（</strong> <strong>XOR</strong> <strong>）问题</strong>。</p>
<p>先看什么是异或：</p>






























<table><thead><tr><th>输入 A</th><th>输入 B</th><th>输出</th></tr></thead><tbody><tr><td>0</td><td>0</td><td>0</td></tr><tr><td>0</td><td>1</td><td>1</td></tr><tr><td>1</td><td>0</td><td>1</td></tr><tr><td>1</td><td>1</td><td>0</td></tr></tbody></table>
<p>也就是输入是一样的情况，例如都是 0 或者都是 1 ，得到的结果是 0，否则得到的结果是 1。</p>
<p>如下图，我们是无法找到一条直线，分割红色点和蓝色点的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ff3a6c2dbc747b0b20e4e501cd1f22c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764049081&amp;x-signature=BpH509yPUYJd%2FeIoYJV9yTWDriU%3D" alt="" loading="lazy"/></p>
<p>这就意味着，简单的线性模型，有些情况是无法模拟的！</p>
<p>也就是说 ❌ 再怎么调整 w1、w2、b，这个模型也永远无法学会异或。</p>
<p>这导致了人工智能历史上第一次寒冬（AI Winter）。</p>
<h2 data-id="heading-6">四、突破：引入非线性！—— 神经网络的诞生</h2>
<p>后来科学家们发现：</p>
<blockquote>
<p>如果在两个线性模型中间，再加上一层“非线性函数”，就能解开异或。</p>
</blockquote>
<p>你可以把思想理解成：</p>
<ul>
<li>
<p>一条直线不能分的</p>
</li>
<li>
<p>两条直线可以</p>
</li>
<li>
<p>让模型像搭积木一样把“多条直线”组合起来 → 就能拼出复杂的边界</p>
</li>
</ul>
<p>什么意思呢，我们可以简单用下入理解：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b077caac745476ab67031c27d3debf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764049081&amp;x-signature=5J%2BCcAl8VUuwYuInG8qwrkVRkgQ%3D" alt="" loading="lazy"/></p>
<p>如上图右边，是不是边界变成了不是一条直线，而是两个曲线去分割呢，借助这这种思路就解决了异或问题。</p>
<p>这就是**神经网络（Neural Network）**最核心的思想：</p>
<blockquote>
<p>多个简单模型叠在一起，中间加上激活函数（非线性）， 就能表达更复杂的决策边界。</p>
</blockquote>
<p>我们从开始的线性模型，也就是单层结构是：</p>
<p><code>输入 → 权重加权 → 激活函数 → 输出</code></p>
<p>简单来说就是输入 x1, x2 的得分 —&gt; 跟 w1，w2 权重计算 -&gt; 跟阈值对比，例如大于 1 就是苹果 -&gt; 输出是否是苹果</p>
<p>然后再看看新的多层结构：</p>
<p><code>输入 → [权重加权 + 激活函数] → [权重加权 + 激活函数] → 输出</code></p>
<p>好了至此，我们就明白了神经网络的概念，神经网络也是联结主义的一部分。此时再次解释以下联结主义的主张：</p>
<blockquote>
<p>“智能来自大量简单单元（神经元）的连接和学习，而不是手写规则。”</p>
</blockquote>
<p>我们再来一个小小结，就是从符号主义，这种依靠人自身写规则到联结主义，到神经网络，我们逐渐步入了新的人工智能时代。</p>
<h2 data-id="heading-7">五、从神经网络到深度学习：当网络变得“深不可测”</h2>
<p>好了，现在我们明白了神经网络——它通过多层连接，巧妙地解决了简单模型无法处理的复杂问题（如异或问题）。那么，深度学习又是什么呢？</p>
<p>其实答案出乎意料的简单：</p>
<p>深度学习 = 特别“深”的神经网络。</p>
<p>这里的“深”，指的不是哲学的深邃，而是字面意思上的层数非常多。</p>
<p>我们可以做一个直观的对比：</p>
<ul>
<li>
<p>传统的神经网络：可能只有几层（比如一个输入层、一个隐藏层、一个输出层）。就像一个简单的三明治。</p>
</li>
<li>
<p>深度学习模型：则拥有十几层、上百层甚至上千层。这就像一个巨无霸汉堡，拥有无数层馅料和面包。</p>
</li>
</ul>
<p>为什么层数多了就厉害？</p>
<p>还记得我们之前手动设计“特征”的麻烦吗？（比如要自己写规则计算“颜色得分”、“形状得分”）深度学习的强大之处在于，它能够自动完成这件事，而且做得比我们好得多。</p>
<p>我们拿一个识别狗的例子举例：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4888eca8ffd4101a1456e5678916785~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2f56WlX-aIkOmDvQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764049081&amp;x-signature=WqgnIE25U0x6jpBX5jQKCkUGe48%3D" alt="" loading="lazy"/></p>
<p>我们可以把一个深度网络理解成一个分工极其精细的流水线工厂，用来识别一张“狗”的图片：</p>
<ol>
<li>第一层（最基础的工人）：只负责检测图像中最简单的边缘和色块。比如这里是横线，那里是竖线，那片是黑色。</li>
<li>中间几层（初级组装工）：接收下一层的“边缘和色块”，把它们组合成更复杂的局部特征。比如，“两个圆圈”可能是眼睛，“一个三角形”可能是耳朵。</li>
<li>最后层（最终决策者）：基于前面所有层传递过来的、已经高度抽象化的信息（比如“这是一个有胡须、尖耳朵、竖瞳的动物面部”），最终做出判断：“这是狗。”</li>
</ol>
<p>这个过程，就是一个“逐层抽象，不断精炼”的过程。 每一层都在前一层的基础上，学习并提取更复杂、更核心的特征。网络越深，能学到的特征就越抽象，解决问题的能力也就越强。</p>
<p>到此我相信大部分应该明白了几个很基础的概念，就是机器学习，神经网络，深度学习的概念。我是一名前端开发技术专家，目前除了开始接触 ai 部分的知识，前端部分正在写关于 <a href="https://link.juejin.cn?target=%255Blio-mengxiang.github.io%2Ft-ui%2F%255D(https%3A%2F%2Flio-mengxiang.github.io%2Ft-ui%2F)" target="_blank" title="%5Blio-mengxiang.github.io/t-ui/%5D(https://lio-mengxiang.github.io/t-ui/)" ref="nofollow noopener noreferrer">headless 组件库教程</a> 这是网站首页，欢迎大家给个赞哦，感谢！同时也在写酷炫的动画教程，有兴趣的同学可以看<a href="https://juejin.cn/post/7572157115907375154" target="_blank" title="https://juejin.cn/post/7572157115907375154">这篇文章</a></p>
<p>下一章我将简单介绍一下 chatgpt 的基本原理，也是面相纯小白，也绝对包票你能看懂。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个超级真实的Three.js树🌲生成器插件]]></title>    <link>https://juejin.cn/post/7573588675638099983</link>    <guid>https://juejin.cn/post/7573588675638099983</guid>    <pubDate>2025-11-18T03:54:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573588675638099983" data-draft-id="7573588675637641231" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个超级真实的Three.js树🌲生成器插件"/> <meta itemprop="keywords" content="three.js,前端"/> <meta itemprop="datePublished" content="2025-11-18T03:54:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="答案answer"/> <meta itemprop="url" content="https://juejin.cn/user/2634865719391869"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个超级真实的Three.js树🌲生成器插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634865719391869/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    答案answer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T03:54:14.000Z" title="Tue Nov 18 2025 03:54:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>分享一个基于Three.js封装的树生成器插件，可以实现创建不同类型且渲染效果真实的3D树</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a739c9d99f34af9b9a7b74a14737f60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg562U5qGIYW5zd2Vy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764042854&amp;x-signature=iqNirUDW51hzE1%2BPTqF%2FpL7l0Jk%3D" alt="11111111111111111111111.gif" loading="lazy"/></p>
<p>说实话，第一次在这个<em>插件官网</em>看到这个效果时我一度以为这只是一个<em>视频</em>，树的内容不仅仅是动态的而且整体的渲染效果也十分真实。</p>
<p>在three.js中使用起来也是非常的简单的仅仅需<em>几行代码</em>就可以搞定，下面给大家简单的介绍一下。</p>
<h3 data-id="heading-1">安装</h3>
<p>通过 npm/pnpm 安装到项目本地即可</p>
<pre><code class="hljs language-js" lang="js">npm i @dgreenheck/ez-tree

pnpm add @dgreenheck/ez-tree

</code></pre>
<h3 data-id="heading-2">使用</h3>
<p>使用起来也是非常简单的，只需要将插件import 引入然后在 new 实例化出来 在添加到 场景中就可以了</p>
<p>最后在一个requestAnimationFrame 动画函数中更新<strong>树</strong>的内容就行了</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Tree</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@dgreenheck/ez-tree'</span>;

<span class="hljs-title function_">createTree</span>(<span class="hljs-params"/>){

      <span class="hljs-keyword">const</span> tree = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tree</span>();
      tree.<span class="hljs-title function_">generate</span>();
      <span class="hljs-comment">// 设置一下位置</span>
      tree.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      <span class="hljs-comment">// 设置一下大小缩放</span>
      tree.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0.1</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.1</span>);
      <span class="hljs-comment">// 添加到场景中</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-title function_">add</span>(tree);
      
}

  <span class="hljs-title function_">sceneAnimation</span>(): <span class="hljs-keyword">void</span> {
    <span class="hljs-comment">// 确保动画循环持续进行</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">renderAnimation</span> = <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sceneAnimation</span>());

      <span class="hljs-comment">// 更新时钟</span>
      <span class="hljs-keyword">const</span> elapsedTime = <span class="hljs-variable language_">this</span>.<span class="hljs-property">clock</span>.<span class="hljs-title function_">getElapsedTime</span>();


      <span class="hljs-comment">// 更新控制器 如果当前是第一人称控制器则不更新</span>
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">pointerLockControls</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">controls</span>.<span class="hljs-title function_">update</span>();
      }

      <span class="hljs-comment">// 更新 Tree 动态效果（风动效果等）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">tree</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">tree</span>.<span class="hljs-title function_">update</span>(elapsedTime);
      }
      <span class="hljs-comment">// 渲染场景</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">renderer</span>.<span class="hljs-title function_">render</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">camera</span>);
  }

</code></pre>
<p>本地项目效果</p>
<p>因为本地项目对光照等参数没有专门调试所以和官网展示的效果有一定的差距</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6728f9c801d40848718d1824f330bd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg562U5qGIYW5zd2Vy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764042854&amp;x-signature=7PwEs1PJX4A8eRbDCmHMm%2B8AfAE%3D" alt="image.png" loading="lazy"/></p>
<p>将相机放大查看树渲染的效果细节处理个人觉得是非常nice的，十分真实</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ef8af9abe50456d939aa39ff33b9a4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg562U5qGIYW5zd2Vy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764042854&amp;x-signature=vpMyBZLYK3nCr0kswuAemNKZqAY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">参数</h3>
<p>该插件还提供了创建不同类型树的方法，通过官网的在线调试就可以看到效果了</p>
<p>创建一个别的类型树</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a0b1cc0b4db4e228d2ad1b34a60097f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg562U5qGIYW5zd2Vy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764042854&amp;x-signature=qJn0cr4YP%2FouH7lNfcZ1tjYdOrY%3D" alt="image.png" loading="lazy"/></p>
<p>修改树枝的方向</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1372f4e75c4b420ca42967f689e0ac11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg562U5qGIYW5zd2Vy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764042854&amp;x-signature=brwjizkErZBTjkD7TIMduSHCRcs%3D" alt="image.png" loading="lazy"/></p>
<p>树叶的多少</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f3a2d1a0ba647199c8c568c30a88012~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg562U5qGIYW5zd2Vy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764042854&amp;x-signature=S8RwmA1NpaY0VH1TDP2QsaMq4Zw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">项目地址</h3>
<p>该项目插件是一个外国大佬开发，如果你的项目或者个人网站需要丰富一下页面内容，那么这个插件或许是个不错的选择</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.eztree.dev%2F" target="_blank" title="https://www.eztree.dev/" ref="nofollow noopener noreferrer">www.eztree.dev/</a></p>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdgreenheck%2Fez-tree" target="_blank" title="https://github.com/dgreenheck/ez-tree" ref="nofollow noopener noreferrer">github.com/dgreenheck/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[工作中最常用的6种API网关]]></title>    <link>https://juejin.cn/post/7573594825317253160</link>    <guid>https://juejin.cn/post/7573594825317253160</guid>    <pubDate>2025-11-18T02:18:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573594825317253160" data-draft-id="7573530680887607330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="工作中最常用的6种API网关"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-18T02:18:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            工作中最常用的6种API网关
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T02:18:02.000Z" title="Tue Nov 18 2025 02:18:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>API网关在项目中非常重要。</p>
<p>今天这篇文章跟大家一起聊聊工作最常用的6种网关，希望对你会有所帮助。</p>
<p><a href="https://link.juejin.cn/?target=http%3A%2F%2Fwww.susan.net.cn%3Frefer%3Djuejin" title="https://link.juejin.cn/?target=http%3A%2F%2Fwww.susan.net.cn%3Frefer%3Djuejin" target="_blank">最近准备面试的小伙伴，可以看一下这个宝藏网站（Java突击队）：www.susan.net.cn，里面：面试八股文、场景设计题、面试真题、7个项目实战、工作内推什么都有</a>。</p>
<h2 data-id="heading-1">一、为什么需要API网关？</h2>
<p>有些小伙伴在工作中可能会问：我们的系统直接调用微服务不是更简单吗？</p>
<p>为什么非要引入API网关这个"中间商"呢？</p>
<p>让我们先来看一个实际的例子。</p>
<h3 data-id="heading-2">没有网关的微服务困境</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 前端直接调用多个微服务 - 问题重重</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FrontendController</span> {
    
    <span class="hljs-comment">// 问题1：服务地址硬编码</span>
    <span class="hljs-meta">@Value("${user.service.url:http://localhost:8081}")</span>
    <span class="hljs-keyword">private</span> String userServiceUrl;
    
    <span class="hljs-meta">@Value("${order.service.url:http://localhost:8082}")</span>
    <span class="hljs-keyword">private</span> String orderServiceUrl;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestTemplate restTemplate;
    
    <span class="hljs-meta">@GetMapping("/user-dashboard")</span>
    <span class="hljs-keyword">public</span> UserDashboard <span class="hljs-title function_">getUserDashboard</span><span class="hljs-params">(<span class="hljs-meta">@RequestHeader("Authorization")</span> String token)</span> {
        <span class="hljs-comment">// 问题2：每个服务都要重复认证逻辑</span>
        <span class="hljs-keyword">if</span> (!validateToken(token)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">"Token invalid"</span>);
        }
        
        <span class="hljs-comment">// 问题3：需要手动处理服务间调用顺序</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> restTemplate.getForObject(userServiceUrl + <span class="hljs-string">"/users/current"</span>, User.class);
        List&lt;Order&gt; orders = restTemplate.getForObject(orderServiceUrl + <span class="hljs-string">"/orders?userId="</span> + user.getId(), List.class);
        
        <span class="hljs-comment">// 问题4：错误处理复杂</span>
        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || orders == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceUnavailableException</span>(<span class="hljs-string">"Backend service unavailable"</span>);
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDashboard</span>(user, orders);
    }
    
    <span class="hljs-comment">// 问题5：重复的认证代码</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-comment">// 每个接口都要实现的认证逻辑</span>
        <span class="hljs-keyword">return</span> token != <span class="hljs-literal">null</span> &amp;&amp; token.startsWith(<span class="hljs-string">"Bearer "</span>);
    }
}
</code></pre>
<h3 data-id="heading-3">引入网关后的优雅架构</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 网关统一处理所有横切关注点</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RouteLocator <span class="hljs-title function_">customRouteLocator</span><span class="hljs-params">(RouteLocatorBuilder builder)</span> {
        <span class="hljs-keyword">return</span> builder.routes()
            .route(<span class="hljs-string">"user_service"</span>, r -&gt; r.path(<span class="hljs-string">"/api/users/**"</span>)
                .uri(<span class="hljs-string">"lb://user-service"</span>))
            .route(<span class="hljs-string">"order_service"</span>, r -&gt; r.path(<span class="hljs-string">"/api/orders/**"</span>)
                .uri(<span class="hljs-string">"lb://order-service"</span>))
            .route(<span class="hljs-string">"product_service"</span>, r -&gt; r.path(<span class="hljs-string">"/api/products/**"</span>)
                .uri(<span class="hljs-string">"lb://product-service"</span>))
            .build();
    }
}

<span class="hljs-comment">// 前端只需调用网关</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FrontendController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestTemplate restTemplate;
    
    <span class="hljs-meta">@GetMapping("/api/user-dashboard")</span>
    <span class="hljs-keyword">public</span> UserDashboard <span class="hljs-title function_">getUserDashboard</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 网关已经处理了认证、路由、负载均衡等问题</span>
        <span class="hljs-keyword">return</span> restTemplate.getForObject(<span class="hljs-string">"http://gateway/api/users/current/dashboard"</span>, UserDashboard.class);
    }
}
</code></pre>
<h3 data-id="heading-4">API网关的核心价值</h3>
<p>让我们通过架构图来理解网关在微服务架构中的关键作用：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a0b22cc4a7b42e9a8d3c57431384a95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764037082&amp;x-signature=%2F6VuMccszgnP%2FTxBznc0N7cQApo%3D" alt="" loading="lazy"/></p>
<p><strong>网关解决的8大核心问题：</strong></p>
<ol>
<li><strong>统一入口</strong>：所有请求都通过网关进入系统</li>
<li><strong>认证授权</strong>：集中处理身份验证和权限控制</li>
<li><strong>流量控制</strong>：限流、熔断、降级等 resiliency 模式</li>
<li><strong>监控统计</strong>：统一的日志、指标收集</li>
<li><strong>协议转换</strong>：HTTP/1.1、HTTP/2、gRPC 等协议适配</li>
<li><strong>缓存加速</strong>：响应缓存降低后端压力</li>
<li><strong>安全防护</strong>：WAF、防爬虫、防重放攻击</li>
<li><strong>服务治理</strong>：服务发现、负载均衡、路由转发</li>
</ol>
<p>下面我们一起看看工作中最常见的6种API网关有哪些。</p>
<h2 data-id="heading-5">二、Spring Cloud Gateway</h2>
<p>有些小伙伴在Spring技术栈中开发微服务，Spring Cloud Gateway 无疑是最自然的选择。</p>
<p>作为Spring官方推出的第二代网关，它基于WebFlux响应式编程模型，性能卓越。</p>
<h3 data-id="heading-6">核心架构深度解析</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedGatewayConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Order(-1)</span>
    <span class="hljs-keyword">public</span> GlobalFilter <span class="hljs-title function_">customGlobalFilter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> (exchange, chain) -&gt; {
            <span class="hljs-comment">// 前置处理</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> exchange.getRequest();
            
            <span class="hljs-comment">// 添加追踪ID</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">traceId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
            <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">mutatedRequest</span> <span class="hljs-operator">=</span> request.mutate()
                .header(<span class="hljs-string">"X-Trace-Id"</span>, traceId)
                .build();
                
            <span class="hljs-keyword">return</span> chain.filter(exchange.mutate().request(mutatedRequest).build())
                .then(Mono.fromRunnable(() -&gt; {
                    <span class="hljs-comment">// 后置处理</span>
                    <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
                    log.info(<span class="hljs-string">"Request {} completed in {}ms"</span>, traceId, duration);
                }));
        };
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RouteLocator <span class="hljs-title function_">advancedRoutes</span><span class="hljs-params">(RouteLocatorBuilder builder)</span> {
        <span class="hljs-keyword">return</span> builder.routes()
            <span class="hljs-comment">// 用户服务 - 带熔断和重试</span>
            .route(<span class="hljs-string">"user_service"</span>, r -&gt; r.path(<span class="hljs-string">"/api/users/**"</span>)
                .filters(f -&gt; f
                    .circuitBreaker(config -&gt; config
                        .setName(<span class="hljs-string">"userServiceCB"</span>)
                        .setFallbackUri(<span class="hljs-string">"forward:/fallback/user-service"</span>))
                    .retry(config -&gt; config
                        .setRetries(<span class="hljs-number">3</span>)
                        .setMethods(HttpMethod.GET, HttpMethod.POST)
                        .setBackoff(<span class="hljs-number">100L</span>, <span class="hljs-number">1000L</span>, <span class="hljs-number">2</span>, <span class="hljs-literal">true</span>))
                    .requestRateLimiter(config -&gt; config
                        .setRateLimiter(redisRateLimiter())
                        .setKeyResolver(apiKeyResolver()))
                    .modifyRequestBody(String.class, String.class, 
                        (exchange, s) -&gt; Mono.just(validateAndTransform(s))))
                .uri(<span class="hljs-string">"lb://user-service"</span>))
            
            <span class="hljs-comment">// 订单服务 - 带JWT认证</span>
            .route(<span class="hljs-string">"order_service"</span>, r -&gt; r.path(<span class="hljs-string">"/api/orders/**"</span>)
                .filters(f -&gt; f
                    .filter(jwtAuthenticationFilter())
                    .prefixPath(<span class="hljs-string">"/v1"</span>)
                    .addResponseHeader(<span class="hljs-string">"X-API-Version"</span>, <span class="hljs-string">"1.0"</span>))
                .uri(<span class="hljs-string">"lb://order-service"</span>))
            
            <span class="hljs-comment">// 商品服务 - 静态资源缓存</span>
            .route(<span class="hljs-string">"product_service"</span>, r -&gt; r.path(<span class="hljs-string">"/api/products/**"</span>)
                .filters(f -&gt; f
                    .dedupeResponseHeader(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"RETAIN_FIRST"</span>)
                    .setResponseHeader(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"public, max-age=3600"</span>))
                .uri(<span class="hljs-string">"lb://product-service"</span>))
            .build();
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> JwtAuthenticationFilter <span class="hljs-title function_">jwtAuthenticationFilter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JwtAuthenticationFilter</span>();
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RedisRateLimiter <span class="hljs-title function_">redisRateLimiter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisRateLimiter</span>(<span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KeyResolver <span class="hljs-title function_">apiKeyResolver</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> exchange -&gt; {
            <span class="hljs-type">String</span> <span class="hljs-variable">apiKey</span> <span class="hljs-operator">=</span> exchange.getRequest().getHeaders().getFirst(<span class="hljs-string">"X-API-Key"</span>);
            <span class="hljs-keyword">return</span> Mono.just(Optional.ofNullable(apiKey).orElse(<span class="hljs-string">"anonymous"</span>));
        };
    }
}

<span class="hljs-comment">// JWT认证过滤器</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthenticationFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GatewayFilter</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JwtUtil jwtUtil;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> extractToken(exchange.getRequest());
        
        <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> onError(exchange, <span class="hljs-string">"Missing authentication token"</span>, HttpStatus.UNAUTHORIZED);
        }
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> jwtUtil.parseToken(token);
            <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> claims.getSubject();
            
            <span class="hljs-comment">// 将用户信息添加到header</span>
            <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">mutatedRequest</span> <span class="hljs-operator">=</span> exchange.getRequest().mutate()
                .header(<span class="hljs-string">"X-User-Name"</span>, username)
                .header(<span class="hljs-string">"X-User-Roles"</span>, String.join(<span class="hljs-string">","</span>, claims.get(<span class="hljs-string">"roles"</span>, List.class)))
                .build();
                
            <span class="hljs-keyword">return</span> chain.filter(exchange.mutate().request(mutatedRequest).build());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> onError(exchange, <span class="hljs-string">"Invalid token: "</span> + e.getMessage(), HttpStatus.UNAUTHORIZED);
        }
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">extractToken</span><span class="hljs-params">(ServerHttpRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">bearerToken</span> <span class="hljs-operator">=</span> request.getHeaders().getFirst(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-keyword">if</span> (StringUtils.hasText(bearerToken) &amp;&amp; bearerToken.startsWith(<span class="hljs-string">"Bearer "</span>)) {
            <span class="hljs-keyword">return</span> bearerToken.substring(<span class="hljs-number">7</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-keyword">private</span> Mono&lt;Void&gt; <span class="hljs-title function_">onError</span><span class="hljs-params">(ServerWebExchange exchange, String err, HttpStatus status)</span> {
        exchange.getResponse().setStatusCode(status);
        <span class="hljs-type">DataBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> exchange.getResponse().bufferFactory()
            .wrap((<span class="hljs-string">"{\"error\":\""</span> + err + <span class="hljs-string">"\"}"</span>).getBytes());
        <span class="hljs-keyword">return</span> exchange.getResponse().writeWith(Mono.just(buffer));
    }
}
</code></pre>
<h3 data-id="heading-7">Spring Cloud Gateway 执行流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3aadd8f06f84f65ba665baa24a1b4e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764037082&amp;x-signature=QtfTLKG7jroFTug4l3ISQ3WvaKY%3D" alt="" loading="lazy"/></p>
<p><strong>优点：</strong></p>
<ul>
<li>与Spring Cloud生态完美集成</li>
<li>基于WebFlux，性能优秀</li>
<li>功能丰富，支持过滤器和断言</li>
<li>配置灵活，支持代码和配置文件两种方式</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>对非Spring技术栈不友好</li>
<li>学习曲线相对陡峭</li>
<li>依赖Spring Cloud组件</li>
</ul>
<p><strong>使用场景：</strong></p>
<ul>
<li>Spring Cloud微服务架构</li>
<li>需要深度定制网关逻辑</li>
<li>团队熟悉Spring技术栈</li>
</ul>
<h2 data-id="heading-8">三、Kong：企业级API网关标杆</h2>
<p>有些小伙伴在企业级场景中需要更高的性能和更丰富的功能，Kong就是这样一个基于Nginx和OpenResty的高性能API网关。</p>
<h3 data-id="heading-9">Kong 配置实战</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># kong.yml - 声明式配置</span>
<span class="hljs-attr">_format_version:</span> <span class="hljs-string">"2.1"</span>
<span class="hljs-attr">_transform:</span> <span class="hljs-literal">true</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">user-service</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">http://user-service:8080</span>
    <span class="hljs-attr">routes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">user-route</span>
        <span class="hljs-attr">paths:</span> [<span class="hljs-string">"/api/users"</span>]
        <span class="hljs-attr">strip_path:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">plugins:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">key-auth</span>
        <span class="hljs-attr">config:</span>
          <span class="hljs-attr">key_names:</span> [<span class="hljs-string">"apikey"</span>]
          <span class="hljs-attr">hide_credentials:</span> <span class="hljs-literal">true</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rate-limiting</span>
        <span class="hljs-attr">config:</span>
          <span class="hljs-attr">minute:</span> <span class="hljs-number">10</span>
          <span class="hljs-attr">policy:</span> <span class="hljs-string">redis</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">http://order-service:8080</span>
    <span class="hljs-attr">routes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">order-route</span>
        <span class="hljs-attr">paths:</span> [<span class="hljs-string">"/api/orders"</span>]
        <span class="hljs-attr">methods:</span> [<span class="hljs-string">"GET"</span>, <span class="hljs-string">"POST"</span>, <span class="hljs-string">"PUT"</span>]
    <span class="hljs-attr">plugins:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">cors</span>
        <span class="hljs-attr">config:</span>
          <span class="hljs-attr">origins:</span> [<span class="hljs-string">"https://example.com"</span>]
          <span class="hljs-attr">methods:</span> [<span class="hljs-string">"GET"</span>, <span class="hljs-string">"POST"</span>, <span class="hljs-string">"PUT"</span>]
          <span class="hljs-attr">headers:</span> [<span class="hljs-string">"Accept"</span>, <span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Content-Type"</span>]
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">request-transformer</span>
        <span class="hljs-attr">config:</span>
          <span class="hljs-attr">add:</span>
            <span class="hljs-attr">headers:</span> [<span class="hljs-string">"X-From-Kong: true"</span>]
          <span class="hljs-attr">remove:</span>
            <span class="hljs-attr">headers:</span> [<span class="hljs-string">"User-Agent"</span>]

<span class="hljs-attr">consumers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">username:</span> <span class="hljs-string">mobile-app</span>
    <span class="hljs-attr">keyauth_credentials:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">mobile-key-123</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">username:</span> <span class="hljs-string">web-app</span>
    <span class="hljs-attr">keyauth_credentials:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">web-key-456</span>

<span class="hljs-attr">plugins:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ip-restriction</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">allow:</span> [<span class="hljs-string">"192.168.0.0/16"</span>, <span class="hljs-string">"10.0.0.0/8"</span>]
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">correlation-id</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">header_name:</span> <span class="hljs-string">"X-Request-ID"</span>
      <span class="hljs-attr">generator:</span> <span class="hljs-string">"uuid"</span>
</code></pre>
<h3 data-id="heading-10">自定义Kong插件开发</h3>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- kong/plugins/request-validator/handler.lua</span>
<span class="hljs-keyword">local</span> BasePlugin = <span class="hljs-built_in">require</span> <span class="hljs-string">"kong.plugins.base_plugin"</span>
<span class="hljs-keyword">local</span> cjson = <span class="hljs-built_in">require</span> <span class="hljs-string">"cjson"</span>

<span class="hljs-keyword">local</span> RequestValidator = BasePlugin:extend()

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RequestValidator:new</span><span class="hljs-params">()</span></span>
  RequestValidator.super.new(<span class="hljs-built_in">self</span>, <span class="hljs-string">"request-validator"</span>)
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RequestValidator:access</span><span class="hljs-params">(conf)</span></span>
  RequestValidator.super.access(<span class="hljs-built_in">self</span>)
  
  <span class="hljs-keyword">local</span> headers = kong.request.get_headers()
  <span class="hljs-keyword">local</span> method = kong.request.get_method()
  <span class="hljs-keyword">local</span> body = kong.request.get_raw_body()
  
  <span class="hljs-comment">-- API Key验证</span>
  <span class="hljs-keyword">local</span> api_key = headers[<span class="hljs-string">"X-API-Key"</span>]
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> api_key <span class="hljs-keyword">then</span>
    kong.response.<span class="hljs-built_in">exit</span>(<span class="hljs-number">401</span>, { message = <span class="hljs-string">"Missing API Key"</span> })
  <span class="hljs-keyword">end</span>
  
  <span class="hljs-comment">-- 验证API Key格式</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">string</span>.<span class="hljs-built_in">match</span>(api_key, <span class="hljs-string">"^%x%x%x%-%x%x%x%-%x%x%x$"</span>) <span class="hljs-keyword">then</span>
    kong.response.<span class="hljs-built_in">exit</span>(<span class="hljs-number">401</span>, { message = <span class="hljs-string">"Invalid API Key format"</span> })
  <span class="hljs-keyword">end</span>
  
  <span class="hljs-comment">-- 请求体验证</span>
  <span class="hljs-keyword">if</span> method == <span class="hljs-string">"POST"</span> <span class="hljs-keyword">or</span> method == <span class="hljs-string">"PUT"</span> <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> body <span class="hljs-keyword">or</span> body == <span class="hljs-string">""</span> <span class="hljs-keyword">then</span>
      kong.response.<span class="hljs-built_in">exit</span>(<span class="hljs-number">400</span>, { message = <span class="hljs-string">"Request body is required"</span> })
    <span class="hljs-keyword">end</span>
    
    <span class="hljs-keyword">local</span> ok, json_body = <span class="hljs-built_in">pcall</span>(cjson.decode, body)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span>
      kong.response.<span class="hljs-built_in">exit</span>(<span class="hljs-number">400</span>, { message = <span class="hljs-string">"Invalid JSON format"</span> })
    <span class="hljs-keyword">end</span>
    
    <span class="hljs-comment">-- 业务规则验证</span>
    <span class="hljs-keyword">if</span> json_body.amount <span class="hljs-keyword">and</span> <span class="hljs-built_in">tonumber</span>(json_body.amount) &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
      kong.response.<span class="hljs-built_in">exit</span>(<span class="hljs-number">400</span>, { message = <span class="hljs-string">"Amount must be greater than 0"</span> })
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
  
  <span class="hljs-comment">-- 添加验证通过标记</span>
  kong.service.request.set_header(<span class="hljs-string">"X-Request-Validated"</span>, <span class="hljs-string">"true"</span>)
  kong.service.request.set_header(<span class="hljs-string">"X-API-Key"</span>, api_key)
  
  <span class="hljs-comment">-- 记录审计日志</span>
  kong.<span class="hljs-built_in">log</span>.info(<span class="hljs-string">"Request validated for API Key: "</span>, api_key)
<span class="hljs-keyword">end</span>

<span class="hljs-keyword">return</span> RequestValidator
</code></pre>
<h3 data-id="heading-11">Kong 集群架构</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/042215d4aa9143c1858568a990d14aef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764037082&amp;x-signature=wwnNcgipQSgGkYWRfLBgA49TWoU%3D" alt="" loading="lazy"/></p>
<p><strong>优点：</strong></p>
<ul>
<li>基于Nginx，性能极高</li>
<li>插件生态丰富</li>
<li>支持集群部署</li>
<li>成熟的监控和管理界面</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>依赖数据库（PostgreSQL/Cassandra）</li>
<li>插件开发需要Lua知识</li>
<li>配置相对复杂</li>
</ul>
<p><strong>使用场景：</strong></p>
<ul>
<li>高并发企业级应用</li>
<li>需要丰富插件功能的场景</li>
<li>已有Kong技术栈的团队</li>
</ul>
<p>最近为了帮助大家找工作，专门建了一些工作内推群，各大城市都有，欢迎各位HR和找工作的小伙伴进群交流，群里目前已经收集了不少的工作内推岗位。加苏三的微信：li_su223，备注：掘金+所在城市，即可进群。</p>
<h2 data-id="heading-12">四、Nginx：经典反向代理网关</h2>
<p>有些小伙伴在传统架构或简单场景中，Nginx仍然是最可靠的选择。它虽然功能相对简单，但性能卓越且稳定。</p>
<h3 data-id="heading-13">Nginx 配置详解</h3>
<pre><code class="hljs language-nginx" lang="nginx"># nginx.conf - 生产环境配置
http {
    # 基础配置
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    
    # 日志格式
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';
    
    # 上游服务配置
    upstream user_service {
        server user-service-1:8080 weight=3;
        server user-service-2:8080 weight=2;
        server user-service-3:8080 weight=1;
        
        # 健康检查
        check interval=3000 rise=2 fall=3 timeout=1000;
    }
    
    upstream order_service {
        server order-service-1:8080;
        server order-service-2:8080;
        
        # 会话保持
        hash $cookie_jsessionid;
        hash_again 1;
    }
    
    upstream product_service {
        server product-service:8080;
        
        # 备份服务器
        server backup-product-service:8080 backup;
    }
    
    # API网关配置
    server {
        listen 80;
        server_name api.example.com;
        
        # 全局限流
        limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
        
        # 用户服务路由
        location /api/users/ {
            limit_req zone=api burst=20 nodelay;
            
            # 反向代理配置
            proxy_pass http://user_service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 超时配置
            proxy_connect_timeout 5s;
            proxy_read_timeout 10s;
            proxy_send_timeout 10s;
            
            # 重试机制
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 3;
            proxy_next_upstream_timeout 10s;
            
            # 缓存配置
            proxy_cache api_cache;
            proxy_cache_key "$scheme$request_method$host$request_uri";
            proxy_cache_valid 200 302 5m;
            proxy_cache_valid 404 1m;
            
            # 添加安全头
            add_header X-Frame-Options DENY;
            add_header X-Content-Type-Options nosniff;
            add_header X-XSS-Protection "1; mode=block";
        }
        
        # 订单服务路由
        location /api/orders/ {
            # JWT验证
            auth_request /auth;
            auth_request_set $user $upstream_http_x_user;
            proxy_set_header X-User $user;
            
            proxy_pass http://order_service;
            
            # CORS配置
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
                add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type';
                add_header 'Access-Control-Max-Age' 86400;
                return 204;
            }
        }
        
        # 认证端点
        location = /auth {
            internal;
            proxy_pass http://auth_service/validate;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header X-Original-URI $request_uri;
        }
        
        # 健康检查端点
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
        
        # 监控端点
        location /nginx-status {
            stub_status on;
            access_log off;
            allow 192.168.0.0/16;
            deny all;
        }
    }
}
</code></pre>
<h3 data-id="heading-14">Nginx 请求处理流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f50f62bc7b0b4bc1a61dd9709981392c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764037082&amp;x-signature=Y1BjLK0V5lj0S%2F7NiZjTwuF%2B%2BxQ%3D" alt="" loading="lazy"/></p>
<p><strong>优点：</strong></p>
<ul>
<li>性能极高，C语言编写</li>
<li>配置相对简单</li>
<li>资源消耗低</li>
<li>社区成熟，资料丰富</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>动态配置能力弱</li>
<li>功能相对基础</li>
<li>需要reload生效配置变更</li>
</ul>
<p><strong>使用场景：</strong></p>
<ul>
<li>高性能要求的简单路由</li>
<li>静态资源服务</li>
<li>传统架构升级</li>
</ul>
<h2 data-id="heading-15">五、APISIX：云原生API网关新星</h2>
<p>有些小伙伴在云原生环境中需要动态配置和高性能，APISIX就是这样一个基于etcd的云原生API网关。</p>
<h3 data-id="heading-16">APISIX 路由配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># apisix-config.yaml</span>
<span class="hljs-attr">routes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">uri:</span> <span class="hljs-string">/api/users/*</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">user-service</span>
    <span class="hljs-attr">methods:</span> [<span class="hljs-string">GET</span>, <span class="hljs-string">POST</span>, <span class="hljs-string">PUT</span>, <span class="hljs-string">DELETE</span>]
    <span class="hljs-attr">upstream:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">roundrobin</span>
      <span class="hljs-attr">nodes:</span>
        <span class="hljs-attr">user-service-1:8080:</span> <span class="hljs-number">1</span>
        <span class="hljs-attr">user-service-2:8080:</span> <span class="hljs-number">2</span>
        <span class="hljs-attr">user-service-3:8080:</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">plugins:</span>
      <span class="hljs-attr">proxy-rewrite:</span>
        <span class="hljs-attr">uri:</span> <span class="hljs-string">"/users$1"</span>
      <span class="hljs-attr">limit-count:</span>
        <span class="hljs-attr">count:</span> <span class="hljs-number">100</span>
        <span class="hljs-attr">time_window:</span> <span class="hljs-number">60</span>
        <span class="hljs-attr">key:</span> <span class="hljs-string">remote_addr</span>
        <span class="hljs-attr">rejected_code:</span> <span class="hljs-number">503</span>
      <span class="hljs-attr">jwt-auth:</span>
        <span class="hljs-attr">key:</span> <span class="hljs-string">user-service</span>
        <span class="hljs-attr">secret:</span> <span class="hljs-string">my-secret-key</span>
        <span class="hljs-attr">exp:</span> <span class="hljs-number">86400</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">uri:</span> <span class="hljs-string">/api/orders/*</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">order-service</span>  
    <span class="hljs-attr">upstream:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">chash</span>
      <span class="hljs-attr">key:</span> <span class="hljs-string">arg_user_id</span>
      <span class="hljs-attr">nodes:</span>
        <span class="hljs-attr">order-service-1:8080:</span> <span class="hljs-number">1</span>
        <span class="hljs-attr">order-service-2:8080:</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">plugins:</span>
      <span class="hljs-attr">cors:</span>
        <span class="hljs-attr">allow_origins:</span> <span class="hljs-string">"https://example.com"</span>
        <span class="hljs-attr">allow_methods:</span> <span class="hljs-string">"GET,POST,PUT,DELETE"</span>
        <span class="hljs-attr">allow_headers:</span> <span class="hljs-string">"*"</span>
      <span class="hljs-attr">response-rewrite:</span>
        <span class="hljs-attr">body:</span> <span class="hljs-string">'{"code": 0, "message": "success", "data": $body}'</span>
      <span class="hljs-attr">fault-injection:</span>
        <span class="hljs-attr">abort:</span>
          <span class="hljs-attr">http_status:</span> <span class="hljs-number">500</span>
          <span class="hljs-attr">body:</span> <span class="hljs-string">"service unavailable"</span>
          <span class="hljs-attr">percentage:</span> <span class="hljs-number">5</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">uri:</span> <span class="hljs-string">/api/products/*</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">product-service</span>
    <span class="hljs-attr">upstream:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">roundrobin</span>
      <span class="hljs-attr">nodes:</span>
        <span class="hljs-attr">product-service:8080:</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">plugins:</span>
      <span class="hljs-attr">proxy-cache:</span>
        <span class="hljs-attr">cache_key:</span> [<span class="hljs-string">"$uri"</span>, <span class="hljs-string">"$args"</span>]
        <span class="hljs-attr">cache_zone:</span> <span class="hljs-string">disk_cache_one</span>
        <span class="hljs-attr">cache_ttl:</span> <span class="hljs-number">300</span>
      <span class="hljs-attr">uri-blocker:</span>
        <span class="hljs-attr">block_rules:</span> [<span class="hljs-string">"^/admin/"</span>, <span class="hljs-string">".php$"</span>]
        <span class="hljs-attr">rejected_code:</span> <span class="hljs-number">403</span>

<span class="hljs-comment"># 全局插件</span>
<span class="hljs-attr">plugins:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prometheus</span>
    <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">zipkin</span>
    <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">config:</span>
      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://zipkin:9411/api/v2/spans</span>
      <span class="hljs-attr">sample_ratio:</span> <span class="hljs-number">0.001</span>
</code></pre>
<h3 data-id="heading-17">APISIX 插件开发</h3>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- apisix/plugins/rate-limit-advanced/init.lua</span>
<span class="hljs-keyword">local</span> core = <span class="hljs-built_in">require</span>(<span class="hljs-string">"apisix.core"</span>)
<span class="hljs-keyword">local</span> plugin_name = <span class="hljs-string">"rate-limit-advanced"</span>

<span class="hljs-keyword">local</span> schema = {
    <span class="hljs-built_in">type</span> = <span class="hljs-string">"object"</span>,
    properties = {
        rate = {<span class="hljs-built_in">type</span> = <span class="hljs-string">"integer"</span>, minimum = <span class="hljs-number">1</span>},
        burst = {<span class="hljs-built_in">type</span> = <span class="hljs-string">"integer"</span>, minimum = <span class="hljs-number">0</span>},
        key = {<span class="hljs-built_in">type</span> = <span class="hljs-string">"string"</span>},
        window = {<span class="hljs-built_in">type</span> = <span class="hljs-string">"integer"</span>, minimum = <span class="hljs-number">1</span>},
        rejected_code = {<span class="hljs-built_in">type</span> = <span class="hljs-string">"integer"</span>, default = <span class="hljs-number">429</span>},
        rejected_msg = {<span class="hljs-built_in">type</span> = <span class="hljs-string">"string"</span>, default = <span class="hljs-string">"rate limit exceeded"</span>}
    },
    required = {<span class="hljs-string">"rate"</span>, <span class="hljs-string">"key"</span>}
}

<span class="hljs-keyword">local</span> _M = {
    version = <span class="hljs-number">1.0</span>,
    priority = <span class="hljs-number">1000</span>,
    name = plugin_name,
    schema = schema,
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_M.check_schema</span><span class="hljs-params">(conf)</span></span>
    <span class="hljs-keyword">return</span> core.schema.check(schema, conf)
<span class="hljs-keyword">end</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_M.access</span><span class="hljs-params">(conf, ctx)</span></span>
    <span class="hljs-keyword">local</span> key = conf.key
    <span class="hljs-keyword">if</span> key == <span class="hljs-string">"remote_addr"</span> <span class="hljs-keyword">then</span>
        key = ctx.var.remote_addr
    <span class="hljs-keyword">elseif</span> key == <span class="hljs-string">"server_addr"</span> <span class="hljs-keyword">then</span>
        key = ctx.var.server_addr
    <span class="hljs-keyword">end</span>
    
    <span class="hljs-keyword">local</span> rate = conf.rate
    <span class="hljs-keyword">local</span> burst = conf.burst <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>
    <span class="hljs-keyword">local</span> window = conf.window <span class="hljs-keyword">or</span> <span class="hljs-number">60</span>
    
    <span class="hljs-comment">-- 使用redis进行分布式限流</span>
    <span class="hljs-keyword">local</span> redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">"resty.redis"</span>)
    <span class="hljs-keyword">local</span> red = redis:new()
    
    <span class="hljs-keyword">local</span> ok, err = red:connect(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">6379</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span>
        core.<span class="hljs-built_in">log</span>.<span class="hljs-built_in">error</span>(<span class="hljs-string">"failed to connect to redis: "</span>, err)
        <span class="hljs-keyword">return</span> <span class="hljs-number">500</span>
    <span class="hljs-keyword">end</span>
    
    <span class="hljs-keyword">local</span> current_time = ngx.now()
    <span class="hljs-keyword">local</span> key_name = <span class="hljs-string">"rate_limit:"</span> .. key
    
    <span class="hljs-comment">-- 使用令牌桶算法</span>
    <span class="hljs-keyword">local</span> tokens = red:get(key_name)
    <span class="hljs-keyword">if</span> tokens <span class="hljs-keyword">then</span>
        tokens = <span class="hljs-built_in">tonumber</span>(tokens)
    <span class="hljs-keyword">else</span>
        tokens = burst
    <span class="hljs-keyword">end</span>
    
    <span class="hljs-keyword">local</span> last_update = red:get(key_name .. <span class="hljs-string">":time"</span>)
    <span class="hljs-keyword">if</span> last_update <span class="hljs-keyword">then</span>
        last_update = <span class="hljs-built_in">tonumber</span>(last_update)
        <span class="hljs-keyword">local</span> elapsed = current_time - last_update
        <span class="hljs-keyword">local</span> new_tokens = elapsed * rate / window
        
        <span class="hljs-keyword">if</span> new_tokens &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span>
            tokens = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(tokens + new_tokens, burst)
        <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">end</span>
    
    <span class="hljs-keyword">if</span> tokens &lt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span>
        red:setex(key_name .. <span class="hljs-string">":time"</span>, window, current_time)
        <span class="hljs-keyword">return</span> conf.rejected_code, conf.rejected_msg
    <span class="hljs-keyword">end</span>
    
    tokens = tokens - <span class="hljs-number">1</span>
    red:setex(key_name, window, tokens)
    red:setex(key_name .. <span class="hljs-string">":time"</span>, window, current_time)
<span class="hljs-keyword">end</span>

<span class="hljs-keyword">return</span> _M
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>配置热更新，无需重启</li>
<li>性能卓越</li>
<li>插件生态丰富</li>
<li>云原生友好</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>相对较新，生态不如Kong成熟</li>
<li>依赖etcd</li>
<li>学习成本较高</li>
</ul>
<p><strong>使用场景：</strong></p>
<ul>
<li>云原生环境</li>
<li>需要动态配置的场景</li>
<li>高性能要求的微服务架构</li>
</ul>
<h2 data-id="heading-18">六、Zuul：Netflix经典网关</h2>
<p>有些小伙伴在传统Spring Cloud项目中可能还在使用Zuul，虽然它已被Spring Cloud Gateway取代，但了解其原理仍有价值。</p>
<h3 data-id="heading-19">Zuul 过滤器实战</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Zuul前置过滤器 - 认证和限流</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthPreFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ZuulFilter</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RateLimiterService rateLimiter;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JwtTokenProvider tokenProvider;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">filterType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"pre"</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">filterOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldFilter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ZuulException {
        <span class="hljs-type">RequestContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> RequestContext.getCurrentContext();
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ctx.getRequest();
        
        <span class="hljs-comment">// 1. 限流检查</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">clientId</span> <span class="hljs-operator">=</span> getClientId(request);
        <span class="hljs-keyword">if</span> (!rateLimiter.tryAcquire(clientId)) {
            ctx.setSendZuulResponse(<span class="hljs-literal">false</span>);
            ctx.setResponseStatusCode(<span class="hljs-number">429</span>);
            ctx.setResponseBody(<span class="hljs-string">"{\"error\": \"Rate limit exceeded\"}"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-comment">// 2. JWT认证</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> extractToken(request);
        <span class="hljs-keyword">if</span> (token == <span class="hljs-literal">null</span> &amp;&amp; requiresAuth(request)) {
            ctx.setSendZuulResponse(<span class="hljs-literal">false</span>);
            ctx.setResponseStatusCode(<span class="hljs-number">401</span>);
            ctx.setResponseBody(<span class="hljs-string">"{\"error\": \"Authentication required\"}"</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        
        <span class="hljs-keyword">if</span> (token != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Claims</span> <span class="hljs-variable">claims</span> <span class="hljs-operator">=</span> tokenProvider.parseToken(token);
                ctx.addZuulRequestHeader(<span class="hljs-string">"X-User-Id"</span>, claims.getSubject());
                ctx.addZuulRequestHeader(<span class="hljs-string">"X-User-Roles"</span>, 
                    String.join(<span class="hljs-string">","</span>, claims.get(<span class="hljs-string">"roles"</span>, List.class)));
            } <span class="hljs-keyword">catch</span> (Exception e) {
                ctx.setSendZuulResponse(<span class="hljs-literal">false</span>);
                ctx.setResponseStatusCode(<span class="hljs-number">401</span>);
                ctx.setResponseBody(<span class="hljs-string">"{\"error\": \"Invalid token\"}"</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }
        }
        
        <span class="hljs-comment">// 3. 添加追踪信息</span>
        ctx.addZuulRequestHeader(<span class="hljs-string">"X-Request-ID"</span>, UUID.randomUUID().toString());
        ctx.addZuulRequestHeader(<span class="hljs-string">"X-Forwarded-For"</span>, request.getRemoteAddr());
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getClientId</span><span class="hljs-params">(HttpServletRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">apiKey</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"X-API-Key"</span>);
        <span class="hljs-keyword">return</span> apiKey != <span class="hljs-literal">null</span> ? apiKey : request.getRemoteAddr();
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">extractToken</span><span class="hljs-params">(HttpServletRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">bearerToken</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"Authorization"</span>);
        <span class="hljs-keyword">if</span> (bearerToken != <span class="hljs-literal">null</span> &amp;&amp; bearerToken.startsWith(<span class="hljs-string">"Bearer "</span>)) {
            <span class="hljs-keyword">return</span> bearerToken.substring(<span class="hljs-number">7</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">requiresAuth</span><span class="hljs-params">(HttpServletRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> request.getRequestURI();
        <span class="hljs-keyword">return</span> !path.startsWith(<span class="hljs-string">"/api/public/"</span>) &amp;&amp; 
               !path.equals(<span class="hljs-string">"/health"</span>) &amp;&amp; 
               !path.startsWith(<span class="hljs-string">"/actuator/"</span>);
    }
}

<span class="hljs-comment">// Zuul后置过滤器 - 响应处理</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponsePostFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ZuulFilter</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(ResponsePostFilter.class);
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">filterType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"post"</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">filterOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-number">1000</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">shouldFilter</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ZuulException {
        <span class="hljs-type">RequestContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> RequestContext.getCurrentContext();
        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> ctx.getRequest();
        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> ctx.getResponse();
        
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> (Long) ctx.get(<span class="hljs-string">"startTime"</span>);
        <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
        
        <span class="hljs-comment">// 记录访问日志</span>
        logger.info(<span class="hljs-string">"{} {} {} {} {}ms"</span>, 
            request.getRemoteAddr(),
            request.getMethod(),
            request.getRequestURI(),
            response.getStatus(),
            duration);
        
        <span class="hljs-comment">// 添加响应头</span>
        response.setHeader(<span class="hljs-string">"X-Response-Time"</span>, duration + <span class="hljs-string">"ms"</span>);
        response.setHeader(<span class="hljs-string">"X-API-Version"</span>, <span class="hljs-string">"1.0"</span>);
        
        <span class="hljs-comment">// 统一响应格式</span>
        <span class="hljs-keyword">if</span> (ctx.getResponseBody() != <span class="hljs-literal">null</span> &amp;&amp; 
            response.getContentType() != <span class="hljs-literal">null</span> &amp;&amp; 
            response.getContentType().contains(<span class="hljs-string">"application/json"</span>)) {
            
            <span class="hljs-type">String</span> <span class="hljs-variable">originalBody</span> <span class="hljs-operator">=</span> ctx.getResponseBody();
            <span class="hljs-type">String</span> <span class="hljs-variable">wrappedBody</span> <span class="hljs-operator">=</span> <span class="hljs-string">"{\"code\": 0, \"data\": "</span> + originalBody + <span class="hljs-string">", \"timestamp\": "</span> + 
                System.currentTimeMillis() + <span class="hljs-string">"}"</span>;
            ctx.setResponseBody(wrappedBody);
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>与Netflix集成良好</li>
<li>过滤器机制灵活</li>
<li>文档资料丰富</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>性能较差（阻塞IO）</li>
<li>已被Spring Cloud Gateway取代</li>
<li>社区活跃度下降</li>
</ul>
<p><strong>使用场景：</strong></p>
<ul>
<li>遗留Spring Cloud项目</li>
<li>Netflix技术栈</li>
<li>非性能敏感场景</li>
</ul>
<h2 data-id="heading-20">七、Traefik：云原生动态网关</h2>
<p>有些小伙伴在容器化环境中需要自动服务发现，Traefik就是为云原生而生的动态网关。</p>
<h3 data-id="heading-21">Traefik 配置示例</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># traefik.yaml</span>
<span class="hljs-attr">api:</span>
  <span class="hljs-attr">dashboard:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">insecure:</span> <span class="hljs-literal">true</span>

<span class="hljs-attr">entryPoints:</span>
  <span class="hljs-attr">web:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-string">":80"</span>
    <span class="hljs-attr">http:</span>
      <span class="hljs-attr">redirections:</span>
        <span class="hljs-attr">entryPoint:</span>
          <span class="hljs-attr">to:</span> <span class="hljs-string">websecure</span>
          <span class="hljs-attr">scheme:</span> <span class="hljs-string">https</span>
          
  <span class="hljs-attr">websecure:</span>
    <span class="hljs-attr">address:</span> <span class="hljs-string">":443"</span>

<span class="hljs-attr">certificatesResolvers:</span>
  <span class="hljs-attr">myresolver:</span>
    <span class="hljs-attr">acme:</span>
      <span class="hljs-attr">email:</span> <span class="hljs-string">admin@example.com</span>
      <span class="hljs-attr">storage:</span> <span class="hljs-string">/etc/traefik/acme.json</span>
      <span class="hljs-attr">httpChallenge:</span>
        <span class="hljs-attr">entryPoint:</span> <span class="hljs-string">web</span>

<span class="hljs-attr">providers:</span>
  <span class="hljs-attr">docker:</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"unix:///var/run/docker.sock"</span>
    <span class="hljs-attr">exposedByDefault:</span> <span class="hljs-literal">false</span>
    
  <span class="hljs-attr">file:</span>
    <span class="hljs-attr">filename:</span> <span class="hljs-string">/etc/traefik/dynamic.yaml</span>
    <span class="hljs-attr">watch:</span> <span class="hljs-literal">true</span>

<span class="hljs-attr">log:</span>
  <span class="hljs-attr">level:</span> <span class="hljs-string">INFO</span>

<span class="hljs-attr">accessLog:</span>
  <span class="hljs-attr">filePath:</span> <span class="hljs-string">"/var/log/traefik/access.log"</span>
  <span class="hljs-attr">bufferingSize:</span> <span class="hljs-number">100</span>

<span class="hljs-attr">metrics:</span>
  <span class="hljs-attr">prometheus:</span>
    <span class="hljs-attr">entryPoint:</span> <span class="hljs-string">websecure</span>

<span class="hljs-comment"># 动态配置</span>
<span class="hljs-comment"># dynamic.yaml</span>
<span class="hljs-attr">http:</span>
  <span class="hljs-attr">middlewares:</span>
    <span class="hljs-comment"># 认证中间件</span>
    <span class="hljs-attr">auth-middleware:</span>
      <span class="hljs-attr">basicAuth:</span>
        <span class="hljs-attr">users:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">"admin:$2y$05$YOUR_HASHED_PASSWORD"</span>
          
    <span class="hljs-comment"># 限流中间件  </span>
    <span class="hljs-attr">rate-limit-middleware:</span>
      <span class="hljs-attr">rateLimit:</span>
        <span class="hljs-attr">burst:</span> <span class="hljs-number">100</span>
        <span class="hljs-attr">period:</span> <span class="hljs-string">1m</span>
        
    <span class="hljs-comment"># 重试中间件</span>
    <span class="hljs-attr">retry-middleware:</span>
      <span class="hljs-attr">retry:</span>
        <span class="hljs-attr">attempts:</span> <span class="hljs-number">3</span>
        
    <span class="hljs-comment"># 熔断中间件</span>
    <span class="hljs-attr">circuit-breaker-middleware:</span>
      <span class="hljs-attr">circuitBreaker:</span>
        <span class="hljs-attr">expression:</span> <span class="hljs-string">"NetworkErrorRatio() &gt; 0.5"</span>
        
    <span class="hljs-comment"># 压缩中间件</span>
    <span class="hljs-attr">compress-middleware:</span>
      <span class="hljs-attr">compress:</span> {}

  <span class="hljs-attr">routers:</span>
    <span class="hljs-comment"># 用户服务路由</span>
    <span class="hljs-attr">user-service:</span>
      <span class="hljs-attr">rule:</span> <span class="hljs-string">"PathPrefix(`/api/users`)"</span>
      <span class="hljs-attr">entryPoints:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">websecure</span>
      <span class="hljs-attr">middlewares:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">rate-limit-middleware</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">compress-middleware</span>
      <span class="hljs-attr">service:</span> <span class="hljs-string">user-service</span>
      <span class="hljs-attr">tls:</span>
        <span class="hljs-attr">certResolver:</span> <span class="hljs-string">myresolver</span>
        
    <span class="hljs-comment"># 订单服务路由  </span>
    <span class="hljs-attr">order-service:</span>
      <span class="hljs-attr">rule:</span> <span class="hljs-string">"PathPrefix(`/api/orders`)"</span>
      <span class="hljs-attr">entryPoints:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">websecure</span>
      <span class="hljs-attr">middlewares:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">auth-middleware</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">rate-limit-middleware</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">circuit-breaker-middleware</span>
      <span class="hljs-attr">service:</span> <span class="hljs-string">order-service</span>
      <span class="hljs-attr">tls:</span>
        <span class="hljs-attr">certResolver:</span> <span class="hljs-string">myresolver</span>

  <span class="hljs-attr">services:</span>
    <span class="hljs-attr">user-service:</span>
      <span class="hljs-attr">loadBalancer:</span>
        <span class="hljs-attr">servers:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">"http://user-service-1:8080"</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">"http://user-service-2:8080"</span>
        <span class="hljs-attr">healthCheck:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">/health</span>
          <span class="hljs-attr">interval:</span> <span class="hljs-string">10s</span>
          <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span>
          
    <span class="hljs-attr">order-service:</span>
      <span class="hljs-attr">loadBalancer:</span>
        <span class="hljs-attr">servers:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">"http://order-service-1:8080"</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">url:</span> <span class="hljs-string">"http://order-service-2:8080"</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>自动服务发现</li>
<li>配置简单</li>
<li>云原生友好</li>
<li>内置监控和Dashboard</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>功能相对简单</li>
<li>性能不如Nginx系网关</li>
<li>高级功能需要企业版</li>
</ul>
<p><strong>使用场景：</strong></p>
<ul>
<li>容器化环境</li>
<li>需要自动服务发现的场景</li>
<li>快速原型开发</li>
</ul>
<h2 data-id="heading-22">八、6大网关对比</h2>
<p>通过前面的分析，我们现在对这六种API网关有了深入的了解。</p>
<p>让我们通过一个全面的对比来帮助大家做出正确的技术选型。</p>
<h3 data-id="heading-23">详细对比表格</h3>













































































<table><thead><tr><th>特性维度</th><th>Spring Cloud Gateway</th><th>Kong</th><th>Nginx</th><th>APISIX</th><th>Zuul</th><th>Traefik</th></tr></thead><tbody><tr><td><strong>性能</strong></td><td>高（WebFlux）</td><td>极高（Nginx）</td><td>极高（C）</td><td>极高（Nginx）</td><td>中（阻塞IO）</td><td>中</td></tr><tr><td><strong>配置方式</strong></td><td>代码/配置</td><td>声明式YAML</td><td>配置文件</td><td>动态配置</td><td>代码/配置</td><td>动态配置</td></tr><tr><td><strong>服务发现</strong></td><td>Spring Cloud</td><td>插件支持</td><td>需手动配置</td><td>支持</td><td>Spring Cloud</td><td>自动发现</td></tr><tr><td><strong>K8s支持</strong></td><td>良好</td><td>良好</td><td>需Ingress</td><td>优秀</td><td>一般</td><td>优秀</td></tr><tr><td><strong>监控</strong></td><td>Micrometer</td><td>Prometheus</td><td>基础监控</td><td>Prometheus</td><td>Hystrix</td><td>内置</td></tr><tr><td><strong>学习曲线</strong></td><td>中</td><td>中高</td><td>低</td><td>中高</td><td>中</td><td>低</td></tr><tr><td><strong>适用场景</strong></td><td>Spring Cloud</td><td>企业级</td><td>传统架构</td><td>云原生</td><td>传统Spring</td><td>容器化</td></tr></tbody></table>
<h3 data-id="heading-24">选型决策指南</h3>
<p><strong>选择Spring Cloud Gateway当：</strong></p>
<ul>
<li>技术栈以Spring为主</li>
<li>需要深度定制网关逻辑</li>
<li>已经使用Spring Cloud组件</li>
<li>团队熟悉响应式编程</li>
</ul>
<p><strong>选择Kong当：</strong></p>
<ul>
<li>企业级高并发场景</li>
<li>需要丰富插件生态</li>
<li>有专业运维团队</li>
<li>需要成熟的管理界面</li>
</ul>
<p><strong>选择Nginx当：</strong></p>
<ul>
<li>性能要求极高</li>
<li>场景相对简单</li>
<li>团队熟悉Nginx</li>
<li>资源受限环境</li>
</ul>
<p><strong>选择APISIX当：</strong></p>
<ul>
<li>云原生环境</li>
<li>需要动态配置</li>
<li>追求最新技术</li>
<li>高性能要求</li>
</ul>
<p><strong>选择Zuul当：</strong></p>
<ul>
<li>维护遗留Spring Cloud项目</li>
<li>Netflix技术栈</li>
<li>非性能敏感场景</li>
</ul>
<p><strong>选择Traefik当：</strong></p>
<ul>
<li>容器化部署</li>
<li>需要自动服务发现</li>
<li>快速开发部署</li>
<li>配置简单要求</li>
</ul>
<h2 data-id="heading-25">总结</h2>
<p>通过本文的介绍，我们对6种主流API网关有了全面的认识。</p>
<p>在选择网关时需要考虑以下关键因素：</p>
<ol>
<li><strong>技术栈匹配</strong>：选择与团队技术栈最匹配的方案</li>
<li><strong>性能要求</strong>：根据业务并发量选择性能合适的网关</li>
<li><strong>功能需求</strong>：评估需要的功能特性，如限流、认证、监控等</li>
<li><strong>运维成本</strong>：考虑部署、监控、维护的复杂度</li>
<li><strong>团队能力</strong>：评估团队对网关技术的掌握程度</li>
</ol>
<h3 data-id="heading-26">核心建议</h3>
<ol>
<li><strong>新项目优先考虑</strong>：Spring Cloud Gateway（Spring技术栈）或 APISIX（云原生）</li>
<li><strong>高并发场景</strong>：Kong 或 Nginx</li>
<li><strong>快速原型</strong>：Traefik</li>
<li><strong>遗留系统</strong>：根据现有技术栈选择</li>
</ol>
<p>记住，没有最好的网关，只有最合适的网关。</p>
<p>合理的网关选型可以大大提升系统的可维护性、可扩展性和性能表现。</p>
<h2 data-id="heading-27">最后说一句(求关注，别白嫖我)</h2>
<p>如果这篇文章对您有所帮助，或者有所启发的话，帮忙关注一下我的同名公众号：苏三说技术，您的支持是我坚持写作最大的动力。</p>
<p>求一键三连：点赞、转发、在看。</p>
<p>关注公众号：【苏三说技术】，在公众号中回复：进大厂，可以免费获取我最近整理的10万字的面试宝典，好多小伙伴靠这个宝典拿到了多家大厂的offer。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SOLO Coder 实践｜给开源云盘 Cloudreve 加个 AI 对话功能]]></title>    <link>https://juejin.cn/post/7573592127298240562</link>    <guid>https://juejin.cn/post/7573592127298240562</guid>    <pubDate>2025-11-18T02:56:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573592127298240562" data-draft-id="7573589277004054566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SOLO Coder 实践｜给开源云盘 Cloudreve 加个 AI 对话功能"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-18T02:56:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SOLO Coder 实践｜给开源云盘 Cloudreve 加个 AI 对话功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T02:56:14.000Z" title="Tue Nov 18 2025 02:56:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/749b11d4371d4c8d9db419e6002f45bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=78kZMcKhdgLFxm8MEM9PpzEXJ3Q%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>作者介绍：刘星辰，TRAE 技术专家</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d535a33641e14520857916eff5bb3bec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=a%2FQJZ%2FQY3mdn6dDP3kPUUCdltb0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>项目背景</strong></h2>
<h3 data-id="heading-1"><strong>Cloudreve 简介</strong></h3>
<p><strong>项目地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcloudreve%2Fcloudreve" target="_blank" title="https://github.com/cloudreve/cloudreve" ref="nofollow noopener noreferrer">github.com/cloudreve/c…</a></p>
<p>Cloudreve 是一个功能完善的<strong>自托管文件管理与分享系统</strong>，支持将文件存储到多种云服务（如本地存储、S3、OneDrive、阿里云 OSS、腾讯 COS 等）。该项目提供了完整的<strong>网页版网盘体验</strong>，包括文件上传下载、在线预览、分享链接、多用户与分组管理，以及 WebDAV 接入等功能。</p>
<p><strong>项目亮点包括：</strong></p>
<ul>
<li>
<p>支持多种云存储服务的统一管理</p>
</li>
<li>
<p>前后端一体化的自部署方案（Go + React 技术栈）</p>
</li>
<li>
<p>文件加密、压缩、断点续传、在线预览等功能齐全</p>
</li>
<li>
<p>适用于个人网盘、团队文件协作、轻量级私有云等场景</p>
</li>
</ul>
<p><strong>一句话总结：</strong> 🌩️ Cloudreve 是一个开源的、可自己搭建的多云文件管理平台，让你拥有属于自己的「网盘系统」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d08a57f7abc4bb181e0c73b6b3efb62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=F6PKwP4M0c06mO%2F9q6CLcx2ORCI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf5c0109a0db4f279ca542a3a54a5f6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=BFSrSB8pLgq%2BQ%2Bfo%2B2E5%2B9mSf68%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>项目理解</strong></h2>
<p>面对一个陌生的开源项目，如何快速上手？可以直接把问题交给 SOLO Coder，让它把复杂的项目拆解为可理解的模块。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/344587d235224e0d8d7c3987949168bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=llbRSP3KUJJz1nSjzlrcz4tdBD4%3D" alt="" loading="lazy"/></p>
<p>根据任务拆解，Coder 写了 6 篇技术报告：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c75b056c81fc418bbc9086826b2c89b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=payXeh7PkBbW7lEMBVd2Xm5vd8k%3D" alt="" loading="lazy"/></p>
<p>首先需要理解项目的宏观结构。Coder 绘制了整体架构分析文档，涵盖技术栈、部署方式和数据流程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1214c883383a4896b1768bca7f43b310~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=hs1y0GhCbgFkHwU1azRvxixbh3A%3D" alt="" loading="lazy"/></p>
<p>以下是文档完整内容：</p>
<h3 data-id="heading-3"><strong>01-project-overview.md - 项目整体架构概览</strong></h3>
<ul>
<li>
<p>技术栈分析（React + Go + 数据库）</p>
</li>
<li>
<p>部署架构图和数据流程</p>
</li>
<li>
<p>核心功能模块介绍</p>
</li>
</ul>

<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># Cloudreve 项目整体架构分析</span>

<span class="hljs-section">## 项目概述</span>

Cloudreve 是一个功能完整的自托管网盘系统，支持多种存储后端，提供完整的文件管理、分享、用户管理等功能。项目采用现代化的前后端分离架构，具有良好的可扩展性和维护性。

<span class="hljs-section">## 技术栈总览</span>

<span class="hljs-section">### 前端技术栈</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**框架**</span>: React 18 + TypeScript
<span class="hljs-bullet">-</span> <span class="hljs-strong">**UI 库**</span>: Material-UI (MUI) v6
<span class="hljs-bullet">-</span> <span class="hljs-strong">**状态管理**</span>: Redux Toolkit
<span class="hljs-bullet">-</span> <span class="hljs-strong">**路由**</span>: React Router v6
<span class="hljs-bullet">-</span> <span class="hljs-strong">**构建工具**</span>: Vite
<span class="hljs-bullet">-</span> <span class="hljs-strong">**HTTP 客户端**</span>: Axios
<span class="hljs-bullet">-</span> <span class="hljs-strong">**拖拽**</span>: React DnD
<span class="hljs-bullet">-</span> <span class="hljs-strong">**国际化**</span>: i18next

<span class="hljs-section">### 后端技术栈</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**语言**</span>: Go 1.23
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Web 框架**</span>: Gin
<span class="hljs-bullet">-</span> <span class="hljs-strong">**ORM**</span>: Ent (Facebook 开源的 Go ORM)
<span class="hljs-bullet">-</span> <span class="hljs-strong">**数据库**</span>: 支持 MySQL、PostgreSQL、SQLite
<span class="hljs-bullet">-</span> <span class="hljs-strong">**认证**</span>: JWT + Session
<span class="hljs-bullet">-</span> <span class="hljs-strong">**文件存储**</span>: 支持本地、阿里云 OSS、AWS S3、腾讯云 COS 等
<span class="hljs-bullet">-</span> <span class="hljs-strong">**任务队列**</span>: 内置任务调度系统

<span class="hljs-section">## 项目结构</span>

<span class="hljs-code">```mermaid
graph TB
    subgraph "Cloudreve 项目结构"
        A[根目录] --&gt; B[Cloudreve/]
        A --&gt; C[assets/]
        A --&gt; D[.trae/]
        
        B --&gt; B1[main.go - 入口文件]
        B --&gt; B2[routers/ - 路由层]
        B --&gt; B3[service/ - 业务逻辑层]
        B --&gt; B4[ent/ - 数据模型层]
        B --&gt; B5[pkg/ - 工具包]
        B --&gt; B6[middleware/ - 中间件]
        B --&gt; B7[inventory/ - 库存管理]
        B --&gt; B8[application/ - 应用配置]
        
        C --&gt; C1[src/ - 前端源码]
        C --&gt; C2[assets/ - 静态资源]
        C --&gt; C3[locales/ - 国际化文件]
        
        C1 --&gt; C11[component/ - React 组件]
        C1 --&gt; C12[redux/ - 状态管理]
        C1 --&gt; C13[api/ - API 接口]
        C1 --&gt; C14[router/ - 前端路由]
        C1 --&gt; C15[session/ - 会话管理]
    end
```</span>

<span class="hljs-section">## 核心架构设计</span>

<span class="hljs-section">### 1. 分层架构</span>

<span class="hljs-code">```mermaid
graph TB
    subgraph "后端分层架构"
        A[路由层 - routers/] --&gt; B[控制器层 - controllers/]
        B --&gt; C[服务层 - service/]
        C --&gt; D[数据访问层 - ent/]
        D --&gt; E[数据库]
        
        F[中间件层 - middleware/] --&gt; B
        G[工具包 - pkg/] --&gt; C
    end
```</span>

<span class="hljs-section">### 2. 前端组件架构</span>

<span class="hljs-code">```mermaid
graph TB
    subgraph "前端组件架构"
        A[App.tsx - 根组件] --&gt; B[Frame/ - 框架组件]
        A --&gt; C[Pages/ - 页面组件]
        
        B --&gt; B1[NavBarFrame - 导航框架]
        B --&gt; B2[HeadlessFrame - 无头框架]
        
        B1 --&gt; B11[TopAppBar - 顶部栏]
        B1 --&gt; B12[AppDrawer - 侧边栏]
        B1 --&gt; B13[AppMain - 主内容区]
        
        C --&gt; C1[FileManager/ - 文件管理器]
        C --&gt; C2[Login/ - 登录页面]
        C --&gt; C3[Admin/ - 管理页面]
        
        C1 --&gt; C11[Explorer/ - 文件浏览器]
        C1 --&gt; C12[Uploader/ - 文件上传器]
        C1 --&gt; C13[Viewers/ - 文件查看器]
    end
```</span>

<span class="hljs-section">## 部署架构</span>

Cloudreve 支持两种部署模式：

<span class="hljs-section">### 1. 单机模式 (Master Mode)</span>
<span class="hljs-code">```mermaid
graph LR
    A[用户] --&gt; B[Nginx/反向代理]
    B --&gt; C[Cloudreve 主节点]
    C --&gt; D[数据库]
    C --&gt; E[文件存储]
```</span>

<span class="hljs-section">### 2. 集群模式 (Master-Slave Mode)</span>
<span class="hljs-code">```mermaid
graph TB
    A[用户] --&gt; B[负载均衡器]
    B --&gt; C[Cloudreve 主节点]
    B --&gt; D[Cloudreve 从节点 1]
    B --&gt; E[Cloudreve 从节点 2]
    
    C --&gt; F[共享数据库]
    D --&gt; G[本地存储 1]
    E --&gt; H[本地存储 2]
    
    C -.-&gt; D
    C -.-&gt; E
```</span>

<span class="hljs-section">## 核心功能模块</span>

<span class="hljs-section">### 1. 用户管理系统</span>
<span class="hljs-bullet">-</span> 用户注册、登录、权限管理
<span class="hljs-bullet">-</span> 用户组管理
<span class="hljs-bullet">-</span> 存储配额管理
<span class="hljs-bullet">-</span> 2FA 双因子认证
<span class="hljs-bullet">-</span> Passkey 支持

<span class="hljs-section">### 2. 文件管理系统</span>
<span class="hljs-bullet">-</span> 文件上传、下载、预览
<span class="hljs-bullet">-</span> 文件夹管理
<span class="hljs-bullet">-</span> 文件分享（公开/私密）
<span class="hljs-bullet">-</span> 文件版本控制
<span class="hljs-bullet">-</span> 批量操作

<span class="hljs-section">### 3. 存储系统</span>
<span class="hljs-bullet">-</span> 多存储后端支持
<span class="hljs-bullet">-</span> 存储策略管理
<span class="hljs-bullet">-</span> 文件加密
<span class="hljs-bullet">-</span> 缩略图生成
<span class="hljs-bullet">-</span> 媒体元数据提取

<span class="hljs-section">### 4. 任务系统</span>
<span class="hljs-bullet">-</span> 异步任务处理
<span class="hljs-bullet">-</span> 离线下载
<span class="hljs-bullet">-</span> 文件压缩/解压
<span class="hljs-bullet">-</span> 定时任务

<span class="hljs-section">### 5. 聊天系统 (已实现)</span>
<span class="hljs-bullet">-</span> OpenRouter API 集成
<span class="hljs-bullet">-</span> 流式对话支持
<span class="hljs-bullet">-</span> 多模态文件处理
<span class="hljs-bullet">-</span> 文件上下文分析

<span class="hljs-section">## 数据流架构</span>

<span class="hljs-code">```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端 (React)
    participant R as 路由层 (Gin)
    participant S as 服务层
    participant D as 数据层 (Ent)
    participant DB as 数据库

    U-&gt;&gt;F: 用户操作
    F-&gt;&gt;R: HTTP 请求
    R-&gt;&gt;R: 中间件处理 (认证/授权)
    R-&gt;&gt;S: 调用业务服务
    S-&gt;&gt;D: 数据操作
    D-&gt;&gt;DB: SQL 查询
    DB--&gt;&gt;D: 返回数据
    D--&gt;&gt;S: 返回实体
    S--&gt;&gt;R: 返回结果
    R--&gt;&gt;F: JSON 响应
    F--&gt;&gt;U: 更新界面
```</span>

<span class="hljs-section">## 关键设计特点</span>

<span class="hljs-section">### 1. 模块化设计</span>
<span class="hljs-bullet">-</span> 前后端完全分离
<span class="hljs-bullet">-</span> 组件化开发
<span class="hljs-bullet">-</span> 插件式存储后端
<span class="hljs-bullet">-</span> 中间件架构

<span class="hljs-section">### 2. 可扩展性</span>
<span class="hljs-bullet">-</span> 支持集群部署
<span class="hljs-bullet">-</span> 水平扩展能力
<span class="hljs-bullet">-</span> 插件系统
<span class="hljs-bullet">-</span> API 版本管理

<span class="hljs-section">### 3. 安全性</span>
<span class="hljs-bullet">-</span> JWT 认证
<span class="hljs-bullet">-</span> RBAC 权限控制
<span class="hljs-bullet">-</span> 文件加密
<span class="hljs-bullet">-</span> CSRF 保护
<span class="hljs-bullet">-</span> 输入验证

<span class="hljs-section">### 4. 性能优化</span>
<span class="hljs-bullet">-</span> 缓存机制
<span class="hljs-bullet">-</span> 异步任务处理
<span class="hljs-bullet">-</span> 文件分片上传
<span class="hljs-bullet">-</span> CDN 支持
<span class="hljs-bullet">-</span> 数据库连接池

<span class="hljs-section">## 开发环境要求</span>

<span class="hljs-section">### 前端开发</span>
<span class="hljs-bullet">-</span> Node.js 18+
<span class="hljs-bullet">-</span> npm 或 yarn
<span class="hljs-bullet">-</span> 现代浏览器

<span class="hljs-section">### 后端开发</span>
<span class="hljs-bullet">-</span> Go 1.23+
<span class="hljs-bullet">-</span> 数据库 (MySQL/PostgreSQL/SQLite)
<span class="hljs-bullet">-</span> Redis (可选，用于缓存)

<span class="hljs-section">## 项目特色功能</span>

<span class="hljs-bullet">1.</span> <span class="hljs-strong">**多存储后端**</span>: 支持本地、云存储等多种存储方式
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**WebDAV 支持**</span>: 可通过 WebDAV 协议访问文件
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**Office 在线编辑**</span>: 集成 WOPI 协议支持 Office 文档在线编辑
<span class="hljs-bullet">4.</span> <span class="hljs-strong">**媒体处理**</span>: 支持图片、视频、音频的预览和元数据提取
<span class="hljs-bullet">5.</span> <span class="hljs-strong">**离线下载**</span>: 支持 Aria2 离线下载
<span class="hljs-bullet">6.</span> <span class="hljs-strong">**文件分享**</span>: 灵活的文件分享机制
<span class="hljs-bullet">7.</span> <span class="hljs-strong">**AI 聊天**</span>: 集成 OpenRouter API 的智能对话功能

<span class="hljs-section">## 总结</span>

Cloudreve 是一个架构清晰、功能完整的现代化网盘系统。其前后端分离的设计、模块化的架构、以及丰富的功能特性，为开发者提供了良好的扩展基础。特别是已经实现的聊天功能，为你要开发的侧边栏对话功能提供了很好的参考和基础。

下一步建议深入了解前端组件架构和后端服务层的具体实现，这将有助于你更好地理解如何在现有架构基础上添加新功能。
</code></pre>
<h3 data-id="heading-4"><strong>02-frontend-architecture.md - 前端架构详解</strong></h3>
<ul>
<li>
<p>React + TypeScript + Material-UI 技术栈</p>
</li>
<li>
<p>组件层次结构和状态管理</p>
</li>
<li>
<p>路由系统和性能优化策略</p>
</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Cloudreve 前端架构学习指南</span>

<span class="hljs-comment">## 前端技术栈详解</span>

<span class="hljs-comment">### 核心技术栈</span>
- **React 18**: 使用最新的 React 特性，包括 Hooks、Suspense、Concurrent Features
- **TypeScript**: 提供类型安全和更好的开发体验
- **Material-UI (MUI) v6**: Google Material Design 设计语言的 React 实现
- **Redux Toolkit**: 现代化的 Redux 状态管理解决方案
- **React Router v6**: 声明式路由管理
- **Vite**: 快速的构建工具和开发服务器

<span class="hljs-comment">### 开发工具链</span>
- **ESLint**: 代码质量检查
- **Prettier**: 代码格式化
- **Husky**: Git hooks 管理
- **TypeScript**: 静态类型检查

<span class="hljs-comment">## 项目结构详解</span>

```
assets/src/
├── component/           <span class="hljs-comment"># React 组件</span>
│   ├── Common/         <span class="hljs-comment"># 通用组件</span>
│   ├── Frame/          <span class="hljs-comment"># 框架组件</span>
│   ├── FileManager/    <span class="hljs-comment"># 文件管理器组件</span>
│   ├── Pages/          <span class="hljs-comment"># 页面组件</span>
│   ├── Admin/          <span class="hljs-comment"># 管理后台组件</span>
│   ├── Viewers/        <span class="hljs-comment"># 文件查看器组件</span>
│   ├── Uploader/       <span class="hljs-comment"># 文件上传组件</span>
│   ├── Icons/          <span class="hljs-comment"># 图标组件</span>
│   └── Dialogs/        <span class="hljs-comment"># 对话框组件</span>
├── redux/              <span class="hljs-comment"># 状态管理</span>
│   ├── hooks.ts        <span class="hljs-comment"># Redux hooks</span>
│   ├── store.ts        <span class="hljs-comment"># Store 配置</span>
│   └── slices/         <span class="hljs-comment"># Redux slices</span>
├── api/                <span class="hljs-comment"># API 接口</span>
│   ├── api.ts          <span class="hljs-comment"># API 函数</span>
│   ├── request.ts      <span class="hljs-comment"># 请求封装</span>
│   └── types.ts        <span class="hljs-comment"># 类型定义</span>
├── router/             <span class="hljs-comment"># 路由配置</span>
├── session/            <span class="hljs-comment"># 会话管理</span>
├── util/               <span class="hljs-comment"># 工具函数</span>
└── App.tsx             <span class="hljs-comment"># 根组件</span>
```

<span class="hljs-comment">## 组件架构设计</span>

<span class="hljs-comment">### 1. 框架组件层次结构</span>

```mermaid
graph TB
    subgraph "框架组件架构"
        A<span class="hljs-section">[App.tsx]</span> --&gt; B<span class="hljs-section">[NavBarFrame]</span>
        A --&gt; C<span class="hljs-section">[HeadlessFrame]</span>
        
        B --&gt; D<span class="hljs-section">[TopAppBar]</span>
        B --&gt; E<span class="hljs-section">[AppDrawer]</span>
        B --&gt; F<span class="hljs-section">[AppMain]</span>
        
        D --&gt; D1<span class="hljs-section">[UserAction]</span>
        D --&gt; D2<span class="hljs-section">[SearchBar]</span>
        D --&gt; D3<span class="hljs-section">[NavBarMainActions]</span>
        
        E --&gt; E1<span class="hljs-section">[SideNavItem]</span>
        E --&gt; E2<span class="hljs-section">[StorageSummary]</span>
        E --&gt; E3<span class="hljs-section">[PageNavigation]</span>
        
        F --&gt; F1<span class="hljs-section">[FileManager]</span>
        F --&gt; F2<span class="hljs-section">[Pages]</span>
        F --&gt; F3<span class="hljs-section">[Admin]</span>
    end
```

<span class="hljs-comment">### 2. 文件管理器组件结构</span>

```mermaid
graph TB
    subgraph "文件管理器组件"
        A<span class="hljs-section">[FileManager]</span> --&gt; B<span class="hljs-section">[TopBar]</span>
        A --&gt; C<span class="hljs-section">[Explorer]</span>
        A --&gt; D<span class="hljs-section">[Uploader]</span>
        A --&gt; E<span class="hljs-section">[Viewers]</span>
        A --&gt; F<span class="hljs-section">[Dialogs]</span>
        
        B --&gt; B1<span class="hljs-section">[Breadcrumb]</span>
        B --&gt; B2<span class="hljs-section">[TopActions]</span>
        B --&gt; B3<span class="hljs-section">[ViewOptions]</span>
        
        C --&gt; C1<span class="hljs-section">[FileList]</span>
        C --&gt; C2<span class="hljs-section">[ContextMenu]</span>
        C --&gt; C3<span class="hljs-section">[DragDrop]</span>
        
        D --&gt; D1<span class="hljs-section">[UploadQueue]</span>
        D --&gt; D2<span class="hljs-section">[ProgressBar]</span>
        
        E --&gt; E1<span class="hljs-section">[ImageViewer]</span>
        E --&gt; E2<span class="hljs-section">[VideoPlayer]</span>
        E --&gt; E3<span class="hljs-section">[DocumentViewer]</span>
        
        F --&gt; F1<span class="hljs-section">[CreateNew]</span>
        F --&gt; F2<span class="hljs-section">[ShareDialog]</span>
        F --&gt; F3<span class="hljs-section">[DeleteConfirm]</span>
    end
```

<span class="hljs-comment">## 状态管理架构</span>

<span class="hljs-comment">### Redux Store 结构</span>

```typescript
// store.ts 核心配置
export const <span class="hljs-attr">store</span> = configureStore({
  reducer: {
    // 全局状态
    globalState: globalStateSlice.reducer,
    // 文件管理器状态
    explorer: explorerSlice.reducer,
    // 用户状态
    user: userSlice.reducer,
    // 上传状态
    uploader: uploaderSlice.reducer,
    // 对话框状态
    dialog: dialogSlice.reducer,
  },
  middleware: (getDefaultMiddleware) =&gt;
    getDefaultMiddleware({
      serializableCheck: {
        ignoredActions: <span class="hljs-section">[FLUSH, REHYDRATE, PAUSE, PERSIST, PURGE, REGISTER]</span>,
      },
    }),
})<span class="hljs-comment">;</span>
```

<span class="hljs-comment">### 状态管理模式</span>

```mermaid
graph LR
    subgraph "Redux 数据流"
        A<span class="hljs-section">[Component]</span> --&gt; B<span class="hljs-section">[Action]</span>
        B --&gt; C<span class="hljs-section">[Reducer]</span>
        C --&gt; D<span class="hljs-section">[Store]</span>
        D --&gt; A
        
        E<span class="hljs-section">[Middleware]</span> --&gt; C
        F<span class="hljs-section">[DevTools]</span> --&gt; D
    end
```

<span class="hljs-comment">### 主要 Slice 说明</span>

<span class="hljs-comment">#### 1. globalStateSlice</span>
```typescript
interface GlobalState {
  // 侧边栏状态
  drawerOpen: boolean<span class="hljs-comment">;</span>
  mobileDrawerOpen: boolean<span class="hljs-comment">;</span>
  // 主题设置
  theme: 'light' | 'dark' | 'auto'<span class="hljs-comment">;</span>
  // 语言设置
  language: string<span class="hljs-comment">;</span>
  // 加载状态
  loading: boolean<span class="hljs-comment">;</span>
}
```

<span class="hljs-comment">#### 2. explorerSlice</span>
```typescript
interface ExplorerState {
  // 当前路径
  currentPath: string<span class="hljs-comment">;</span>
  // 文件列表
  files: FileResponse<span class="hljs-section">[]</span><span class="hljs-comment">;</span>
  // 选中的文件
  selectedFiles: string<span class="hljs-section">[]</span><span class="hljs-comment">;</span>
  // 视图模式
  viewMode: 'list' | 'grid' | 'small'<span class="hljs-comment">;</span>
  // 排序方式
  sortBy: string<span class="hljs-comment">;</span>
  sortOrder: 'asc' | 'desc'<span class="hljs-comment">;</span>
}
```

<span class="hljs-comment">## 路由系统</span>

<span class="hljs-comment">### 路由配置结构</span>

```typescript
// router/index.tsx
export const <span class="hljs-attr">router</span> = createBrowserRouter([
  {
    path: <span class="hljs-string">"/"</span>,
    element: &lt;App /&gt;,
    errorElement: &lt;ErrorBoundary /&gt;,
    children: [
      { path: <span class="hljs-string">"/"</span>, element: &lt;HomeRedirect /&gt; },
      {
        path: <span class="hljs-string">"/"</span>,
        element: &lt;HeadlessFrame /&gt;,
        children: [
          // 登录相关路由
          {
            path: <span class="hljs-string">"/session"</span>,
            element: &lt;SessionIntro /&gt;,
            children: [
              { path: <span class="hljs-string">"/session"</span>, element: &lt;SignIn /&gt; },
              { path: <span class="hljs-string">"signup"</span>, element: &lt;SignUp /&gt; },
              { path: <span class="hljs-string">"activate"</span>, element: &lt;Activate /&gt; },
              { path: <span class="hljs-string">"reset"</span>, element: &lt;Reset /&gt; },
            ],
          },
        ],
      },
    ],
  },
])<span class="hljs-comment">;</span>
```

<span class="hljs-comment">### 路由守卫机制</span>

```mermaid
sequenceDiagram
    participant U as 用户
    participant R as Router
    participant A as Auth Guard
    participant S as Session
    participant C as Component

    U-&gt;&gt;R: 访问路由
    R-&gt;&gt;A: 检查权限
    A-&gt;&gt;S: 验证会话
    alt 已登录
        S--&gt;&gt;A: 返回用户信息
        A--&gt;&gt;R: 允许访问
        R-&gt;&gt;C: 渲染组件
        C--&gt;&gt;U: 显示页面
    else 未登录
        S--&gt;&gt;A: 返回未认证
        A--&gt;&gt;R: 重定向登录
        R-&gt;&gt;U: 跳转登录页
    end
```

<span class="hljs-comment">## 组件设计模式</span>

<span class="hljs-comment">### 1. 容器组件 vs 展示组件</span>

```typescript
// 容器组件 - 负责数据和逻辑
const FileManagerContainer: <span class="hljs-attr">React.FC</span> = () =&gt; {
  const <span class="hljs-attr">dispatch</span> = useAppDispatch()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">files</span> = useAppSelector(state =&gt; state.explorer.files)<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">handleFileSelect</span> = (fileId: string) =&gt; {
    dispatch(selectFile(fileId))<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
  
  return (
    &lt;FileList 
      <span class="hljs-attr">files</span>={files}
      <span class="hljs-attr">onFileSelect</span>={handleFileSelect}
    /&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 展示组件 - 负责 UI 渲染
interface FileListProps {
  files: FileResponse<span class="hljs-section">[]</span><span class="hljs-comment">;</span>
  onFileSelect: (fileId: string) =&gt; void<span class="hljs-comment">;</span>
}

const FileList: React.FC&lt;FileListProps&gt; = ({ files, onFileSelect }) =&gt; {
  return (
    &lt;List&gt;
      {files.map(<span class="hljs-attr">file</span> =&gt; (
        &lt;FileItem 
          <span class="hljs-attr">key</span>={file.id}
          <span class="hljs-attr">file</span>={file}
          <span class="hljs-attr">onClick</span>={() =&gt; <span class="hljs-literal">on</span>FileSelect(file.id)}
        /&gt;
      ))}
    &lt;/List&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
```

<span class="hljs-comment">### 2. 自定义 Hooks</span>

```typescript
// hooks/useFileManager.ts
export const <span class="hljs-attr">useFileManager</span> = () =&gt; {
  const <span class="hljs-attr">dispatch</span> = useAppDispatch()<span class="hljs-comment">;</span>
  const { files, currentPath, loading } = useAppSelector(<span class="hljs-attr">state</span> =&gt; state.explorer)<span class="hljs-comment">;</span>
  
  const <span class="hljs-attr">loadFiles</span> = useCallback(async (path: string) =&gt; {
    dispatch(setLoading(true))<span class="hljs-comment">;</span>
    try {
      const <span class="hljs-attr">response</span> = await api.listFiles(path)<span class="hljs-comment">;</span>
      dispatch(setFiles(response.data))<span class="hljs-comment">;</span>
    } catch (error) {
      // 错误处理
    } finally {
      dispatch(setLoading(false))<span class="hljs-comment">;</span>
    }
  }, <span class="hljs-section">[dispatch]</span>)<span class="hljs-comment">;</span>
  
  return {
    files,
    currentPath,
    loading,
    loadFiles,
  }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
```

<span class="hljs-comment">### 3. 高阶组件 (HOC)</span>

```typescript
// hoc/withAuth.tsx
export const <span class="hljs-attr">withAuth</span> = &lt;P extends object&gt;(
  Component: React.ComponentType&lt;P&gt;
) =&gt; {
  return (props: P) =&gt; {
    const { user } = useAppSelector(<span class="hljs-attr">state</span> =&gt; state.user)<span class="hljs-comment">;</span>
    
    if (!user) {
      return &lt;Navigate <span class="hljs-attr">to</span>=<span class="hljs-string">"/session"</span> /&gt;<span class="hljs-comment">;</span>
    }
    
    return &lt;Component {...props} /&gt;<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 使用方式
const <span class="hljs-attr">ProtectedPage</span> = withAuth(FileManager)<span class="hljs-comment">;</span>
```

<span class="hljs-comment">## Material-UI 主题系统</span>

<span class="hljs-comment">### 主题配置</span>

```typescript
// App.tsx 中的主题配置
export const <span class="hljs-attr">applyThemeWithOverrides</span> = (themeConfig: ThemeOptions): ThemeOptions =&gt; {
  return {
    ...themeConfig,
    shape: {
      borderRadius: 12,
    },
    components: {
      MuiButton: {
        styleOverrides: {
          root: {
            textTransform: "none",
          },
        },
      },
      MuiTooltip: {
        defaultProps: {
          enterDelay: 500,
        },
      },
    },
  }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
```

<span class="hljs-comment">### 响应式设计</span>

```typescript
// 使用 MUI 的断点系统
const <span class="hljs-attr">useStyles</span> = () =&gt; {
  const <span class="hljs-attr">theme</span> = useTheme()<span class="hljs-comment">;</span>
  const <span class="hljs-attr">isMobile</span> = useMediaQuery(theme.breakpoints.down(<span class="hljs-string">'sm'</span>))<span class="hljs-comment">;</span>
  const <span class="hljs-attr">isTablet</span> = useMediaQuery(theme.breakpoints.down(<span class="hljs-string">'md'</span>))<span class="hljs-comment">;</span>
  
  return {
    container: {
      padding: isMobile ? theme.spacing(1) : theme.spacing(3),
      gridTemplateColumns: isMobile ? '1fr' : 'repeat(auto-fill, minmax(200px, 1fr))',
    },
  }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
```

<span class="hljs-comment">## API 集成模式</span>

<span class="hljs-comment">### 请求封装</span>

```typescript
// api/request.ts
const <span class="hljs-attr">instance</span> = axios.create({
  baseURL: '/api/v4',
})<span class="hljs-comment">;</span>

// 请求拦截器
instance.interceptors.request.use(async (config) =&gt; {
  const <span class="hljs-attr">token</span> = await SessionManager.getAccessToken()<span class="hljs-comment">;</span>
  if (token) {
    <span class="hljs-attr">config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${token}</span>`<span class="hljs-comment">;</span>
  }
  return config<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>

// 响应拦截器
instance.interceptors.response.use(
  (response) =&gt; response,
  async (error) =&gt; {
    if (error.response?.<span class="hljs-attr">status</span> === <span class="hljs-number">401</span>) {
      // 处理认证失败
      await SessionManager.refreshToken()<span class="hljs-comment">;</span>
    }
    return Promise.reject(error)<span class="hljs-comment">;</span>
  }
)<span class="hljs-comment">;</span>
```

<span class="hljs-comment">### API 函数设计</span>

```typescript
// api/explorer.ts
export const <span class="hljs-attr">explorerAPI</span> = {
  // 获取文件列表
  listFiles: (path: string): Promise&lt;Response&lt;FileResponse<span class="hljs-section">[]</span>&gt;&gt; =&gt; {
    return request.get('/file/list', { params: { path } })<span class="hljs-comment">;</span>
  },
  
  // 上传文件
  uploadFile: (
    file: File, 
    path: string, 
    onProgress?: (progress: number) =&gt; void
  ): Promise&lt;Response&lt;FileResponse&gt;&gt; =&gt; {
    const <span class="hljs-attr">formData</span> = new FormData()<span class="hljs-comment">;</span>
    formData.append('file', file)<span class="hljs-comment">;</span>
    formData.append('path', path)<span class="hljs-comment">;</span>
    
    return request.post('/file/upload', formData, {
      onUploadProgress: (progressEvent) =&gt; {
        const <span class="hljs-attr">progress</span> = Math.round(
          (progressEvent.loaded * 100) / progressEvent.total
        )<span class="hljs-comment">;</span>
        onProgress?.(progress)<span class="hljs-comment">;</span>
      },
    })<span class="hljs-comment">;</span>
  },
}<span class="hljs-comment">;</span>
```

<span class="hljs-comment">## 国际化 (i18n) 系统</span>

<span class="hljs-comment">### 配置结构</span>

```typescript
// i18n.ts
import i18n from 'i18next'<span class="hljs-comment">;</span>
import Backend from 'i18next-http-backend'<span class="hljs-comment">;</span>
import LanguageDetector from 'i18next-browser-languagedetector'<span class="hljs-comment">;</span>

i18n
  .use(Backend)
  .use(LanguageDetector)
  .init({
    fallbackLng: 'en-US',
    debug: false,
    
    interpolation: {
      escapeValue: false,
    },
    
    backend: {
      loadPath: '/assets/locales/{{lng}}/{{ns}}.json',
    },
  })<span class="hljs-comment">;</span>
```

<span class="hljs-comment">### 使用方式</span>

```typescript
// 在组件中使用
const FileManager: <span class="hljs-attr">React.FC</span> = () =&gt; {
  const { t } = useTranslation()<span class="hljs-comment">;</span>
  
  return (
    &lt;Box&gt;
      &lt;Typography <span class="hljs-attr">variant</span>=<span class="hljs-string">"h6"</span>&gt;
        {t('fileManager.title')}
      &lt;/Typography&gt;
      &lt;Button&gt;
        {t('common.upload')}
      &lt;/Button&gt;
    &lt;/Box&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
```

<span class="hljs-comment">## 性能优化策略</span>

<span class="hljs-comment">### 1. 代码分割</span>

```typescript
// 路由级别的代码分割
const <span class="hljs-attr">FileManager</span> = lazy(() =&gt; import(<span class="hljs-string">'../component/FileManager/FileManager'</span>))<span class="hljs-comment">;</span>
const <span class="hljs-attr">AdminPanel</span> = lazy(() =&gt; import(<span class="hljs-string">'../component/Admin/AdminPanel'</span>))<span class="hljs-comment">;</span>

// 在路由中使用
&lt;Route 
  <span class="hljs-attr">path</span>=<span class="hljs-string">"/files"</span> 
  <span class="hljs-attr">element</span>={
    &lt;Suspense <span class="hljs-attr">fallback</span>={&lt;Loading /&gt;}&gt;
      &lt;FileManager /&gt;
    &lt;/Suspense&gt;
  } 
/&gt;
```

<span class="hljs-comment">### 2. 组件优化</span>

```typescript
// 使用 React.memo 优化渲染
const <span class="hljs-attr">FileItem</span> = React.memo&lt;FileItemProps&gt;(({ file, <span class="hljs-literal">on</span>Select }) =&gt; {
  return (
    &lt;ListItem <span class="hljs-attr">onClick</span>={() =&gt; <span class="hljs-literal">on</span>Select(file.id)}&gt;
      &lt;ListItemText <span class="hljs-attr">primary</span>={file.name} /&gt;
    &lt;/ListItem&gt;
  )<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>

// 使用 useMemo 优化计算
const FileList: React.FC&lt;FileListProps&gt; = ({ files, filter }) =&gt; {
  const <span class="hljs-attr">filteredFiles</span> = useMemo(() =&gt; {
    return files.filter(<span class="hljs-attr">file</span> =&gt; 
      file.name.toLowerCase().includes(filter.toLowerCase())
    )<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[files, filter]</span>)<span class="hljs-comment">;</span>
  
  return (
    &lt;List&gt;
      {filteredFiles.map(<span class="hljs-attr">file</span> =&gt; (
        &lt;FileItem <span class="hljs-attr">key</span>={file.id} file={file} /&gt;
      ))}
    &lt;/List&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
```

<span class="hljs-comment">### 3. 虚拟滚动</span>

```typescript
// 使用 react-virtuoso 处理大列表
import { Virtuoso } from 'react-virtuoso'<span class="hljs-comment">;</span>

const VirtualFileList: React.FC&lt;{ files: FileResponse<span class="hljs-section">[]</span> }&gt; = ({ files }) =&gt; {
  return (
    &lt;Virtuoso
      <span class="hljs-attr">data</span>={files}
      <span class="hljs-attr">itemContent</span>={(index, file) =&gt; (
        &lt;FileItem <span class="hljs-attr">key</span>={file.id} file={file} /&gt;
      )}
      <span class="hljs-attr">style</span>={{ height: <span class="hljs-string">'400px'</span> }}
    /&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
```

<span class="hljs-comment">## 错误处理机制</span>

<span class="hljs-comment">### 错误边界</span>

```typescript
// component/Common/ErrorBoundary.tsx
class ErrorBoundary extends React.Component&lt;Props, State&gt; {
  constructor(props: Props) {
    super(props)<span class="hljs-comment">;</span>
    <span class="hljs-attr">this.state</span> = { hasError: <span class="hljs-literal">false</span> }<span class="hljs-comment">;</span>
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true }<span class="hljs-comment">;</span>
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('Error caught by boundary:', error, errorInfo)<span class="hljs-comment">;</span>
  }

  render() {
    if (this.state.hasError) {
      return &lt;ErrorFallback /&gt;<span class="hljs-comment">;</span>
    }

    return this.props.children<span class="hljs-comment">;</span>
  }
}
```

<span class="hljs-comment">### 全局错误处理</span>

```typescript
// 在 request.ts 中统一处理错误
instance.interceptors.response.use(
  (response) =&gt; response,
  (error) =&gt; {
    const <span class="hljs-attr">message</span> = error.response?.data?.message || error.message<span class="hljs-comment">;</span>
    
    // 显示错误提示
    enqueueSnackbar(message, { 
      variant: 'error',
      action: &lt;DefaultCloseAction /&gt;
    })<span class="hljs-comment">;</span>
    
    return Promise.reject(error)<span class="hljs-comment">;</span>
  }
)<span class="hljs-comment">;</span>
```

<span class="hljs-comment">## 测试策略</span>

<span class="hljs-comment">### 单元测试</span>

```typescript
// __tests__/FileItem.test.tsx
import { render, screen, fireEvent } from '@testing-library/react'<span class="hljs-comment">;</span>
import { FileItem } from '../FileItem'<span class="hljs-comment">;</span>

describe('FileItem', () =&gt; {
  const <span class="hljs-attr">mockFile</span> = {
    id: '1',
    name: 'test.txt',
    size: 1024,
  }<span class="hljs-comment">;</span>

  it('renders file name correctly', () =&gt; {
    render(&lt;FileItem <span class="hljs-attr">file</span>={mockFile} <span class="hljs-literal">on</span>Select={jest.fn()} /&gt;)<span class="hljs-comment">;</span>
    expect(screen.getByText('test.txt')).toBeInTheDocument()<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>

  it('calls onSelect when clicked', () =&gt; {
    const <span class="hljs-attr">onSelect</span> = jest.fn()<span class="hljs-comment">;</span>
    render(&lt;FileItem <span class="hljs-attr">file</span>={mockFile} <span class="hljs-literal">on</span>Select={<span class="hljs-literal">on</span>Select} /&gt;)<span class="hljs-comment">;</span>
    
    fireEvent.click(screen.getByText('test.txt'))<span class="hljs-comment">;</span>
    expect(onSelect).toHaveBeenCalledWith('1')<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
```

<span class="hljs-comment">## 开发最佳实践</span>

<span class="hljs-comment">### 1. 组件设计原则</span>
- **单一职责**: 每个组件只负责一个功能
- **可复用性**: 设计通用的组件接口
- **可测试性**: 便于编写单元测试
- **性能优化**: 避免不必要的重渲染

<span class="hljs-comment">### 2. 状态管理原则</span>
- **最小化状态**: 只存储必要的状态
- **不可变更新**: 使用 Redux Toolkit 的 Immer
- **异步处理**: 使用 createAsyncThunk 处理异步操作

<span class="hljs-comment">### 3. 代码组织原则</span>
- **按功能分组**: 相关组件放在同一目录
- **类型定义**: 为所有 props 和状态定义类型
- **文档注释**: 为复杂组件添加 JSDoc 注释

<span class="hljs-comment">## 总结</span>

Cloudreve 的前端架构采用了现代化的 React 生态系统，具有以下特点：

1. **类型安全**: 全面使用 TypeScript
2. **组件化**: 高度模块化的组件设计
3. **状态管理**: 使用 Redux Toolkit 进行状态管理
4. **UI 一致性**: 基于 Material-UI 的设计系统
5. **性能优化**: 代码分割、虚拟滚动等优化策略
6. **国际化**: 完整的多语言支持
7. **错误处理**: 完善的错误边界和错误处理机制

这个架构为你开发侧边栏对话功能提供了良好的基础，你可以参考现有的组件设计模式和状态管理方式来实现新功能。
</code></pre>
<h3 data-id="heading-5"><strong>03-backend-architecture.md - 后端架构指南</strong></h3>
<ul>
<li>
<p>Go 语言基础知识（专为前端开发者）</p>
</li>
<li>
<p>Gin 框架和 Ent ORM 使用</p>
</li>
<li>
<p>服务层设计和认证系统</p>
</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"># Cloudreve 后端架构学习指南

## Go 语言基础知识

### 为什么选择 Go
- **高性能**: 编译型语言，接近 C/C++ 的性能
- **并发支持**: 原生的 goroutine 和 channel 支持
- **简洁语法**: 学习曲线平缓，代码可读性强
- **丰富生态**: 优秀的 Web 框架和工具链
- **内存安全**: 垃圾回收机制，避免内存泄漏

### Go 语言核心概念

#### <span class="hljs-number">1</span>. 包 (Package) 系统
```go
// 包声明
package main

// 导入其他包
import (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net/http"</span>
    <span class="hljs-string">"github.com/gin-gonic/gin"</span>
)

// 函数定义
func <span class="hljs-built_in">main</span>() {
    fmt<span class="hljs-selector-class">.Println</span>("Hello, World!")
}
```

#### <span class="hljs-number">2</span>. 结构体 (Struct)
```go
<span class="hljs-comment">// 定义结构体</span>
type User struct {
    ID       int    `json:<span class="hljs-string">"id"</span>`
    Name     string `json:<span class="hljs-string">"name"</span>`
    Email    string `json:<span class="hljs-string">"email"</span>`
    Password string `json:<span class="hljs-string">"-"</span>` // 不序列化到 JSON
}

<span class="hljs-comment">// 结构体方法</span>
func (u *User) <span class="hljs-built_in">GetDisplayName</span>() string {
    return u<span class="hljs-selector-class">.Name</span>
}
```

#### <span class="hljs-number">3</span>. 接口 (Interface)
```go
<span class="hljs-comment">// 定义接口</span>
type UserService interface {
    <span class="hljs-built_in">CreateUser</span>(user *User) error
    <span class="hljs-built_in">GetUser</span>(id int) (*User, error)
    <span class="hljs-built_in">UpdateUser</span>(user *User) error
    <span class="hljs-built_in">DeleteUser</span>(id int) error
}

<span class="hljs-comment">// 实现接口</span>
type userServiceImpl struct {
    db *sql<span class="hljs-selector-class">.DB</span>
}

func (s *userServiceImpl) <span class="hljs-built_in">CreateUser</span>(user *User) error {
    <span class="hljs-comment">// 实现逻辑</span>
    return nil
}
```

#### <span class="hljs-number">4</span>. 错误处理
```go
func <span class="hljs-built_in">GetUser</span>(id int) (*User, error) {
    if id &lt;= <span class="hljs-number">0</span> {
        return nil, fmt<span class="hljs-selector-class">.Errorf</span>("invalid user id: %d", id)
    }
    
    user, err := db.<span class="hljs-built_in">FindUser</span>(id)
    if err != nil {
        return nil, fmt<span class="hljs-selector-class">.Errorf</span>("failed to find user: %w", err)
    }
    
    return user, nil
}

<span class="hljs-comment">// 使用</span>
user, err := <span class="hljs-built_in">GetUser</span>(<span class="hljs-number">123</span>)
if err != nil {
    log<span class="hljs-selector-class">.Printf</span>("Error: %v", err)
    return
}
```

## Cloudreve 后端技术栈

### 核心框架和库
- **Gin**: 高性能的 HTTP Web 框架
- **Ent**: Facebook 开源的 Go ORM 框架
- **Cobra**: 命令行应用框架
- **JWT**: JSON Web Token 认证
- **Viper**: 配置管理
- **Logrus**: 结构化日志

### 数据库支持
- **MySQL**: 主要生产数据库
- **PostgreSQL**: 企业级数据库
- **SQLite**: 轻量级嵌入式数据库

## 项目架构设计

### 分层架构

```mermaid
graph TB
    subgraph <span class="hljs-string">"Cloudreve 后端分层架构"</span>
        A[HTTP 层] --&gt; B[路由层 - routers/]
        B --&gt; C[控制器层 - controllers/]
        C --&gt; D[服务层 - service/]
        D --&gt; E[数据访问层 - ent/]
        E --&gt; F[数据库]
        
        G[中间件层 - middleware/] --&gt; C
        H[工具包 - pkg/] --&gt; D
        I[应用配置 - application/] --&gt; D
    end
```

### 目录结构详解

```
Cloudreve/
├── main.go                 # 应用入口
├── cmd/                    # 命令行工具
│   ├── root.go            # 根命令
│   ├── server.go          # 服务器命令
│   └── migrate.go         # 数据库迁移
├── routers/               # 路由层
│   ├── router.go          # 路由配置
│   └── controllers/       # 控制器
├── service/               # 业务逻辑层
│   ├── admin/            # 管理服务
│   ├── user/             # 用户服务
│   ├── explorer/         # 文件管理服务
│   └── chat/             # 聊天服务
├── ent/                   # 数据模型层 (Ent ORM)
│   ├── schema/           # 数据库模式定义
│   ├── migrate/          # 数据库迁移
│   └── *.go              # 生成的实体代码
├── middleware/            # 中间件
│   ├── auth.go           # 认证中间件
│   ├── cors.go           # 跨域中间件
│   └── session.go        # 会话中间件
├── pkg/                   # 工具包
│   ├── auth/             # 认证工具
│   ├── cache/            # 缓存工具
│   ├── conf/             # 配置管理
│   └── util/             # 通用工具
├── inventory/             # 库存管理
└── application/           # 应用配置
```

## Gin 框架详解

### 基本用法

```go
package main

import (
    <span class="hljs-string">"github.com/gin-gonic/gin"</span>
    <span class="hljs-string">"net/http"</span>
)

func <span class="hljs-built_in">main</span>() {
    <span class="hljs-comment">// 创建 Gin 引擎</span>
    r := gin.<span class="hljs-built_in">Default</span>()
    
    // 定义路由
    r.<span class="hljs-built_in">GET</span>(<span class="hljs-string">"/ping"</span>, <span class="hljs-built_in">func</span>(c *gin.Context) {
        c<span class="hljs-selector-class">.JSON</span>(http.StatusOK, gin.H{
            "message": "pong",
        })
    })
    
    <span class="hljs-comment">// 启动服务器</span>
    r<span class="hljs-selector-class">.Run</span>(":<span class="hljs-number">8080</span>")
}
```

### 路由组织

```go
<span class="hljs-comment">// routers/router.go</span>
func <span class="hljs-built_in">InitRouter</span>(dep dependency.Dep) *gin<span class="hljs-selector-class">.Engine</span> {
    r := gin.<span class="hljs-built_in">New</span>()
    
    // 全局中间件
    r.<span class="hljs-built_in">Use</span>(gin.<span class="hljs-built_in">Recovery</span>())
    r.<span class="hljs-built_in">Use</span>(middleware.<span class="hljs-built_in">CORS</span>())
    
    // API 版本分组
    v4 := r.<span class="hljs-built_in">Group</span>(<span class="hljs-string">"/api/v4"</span>)
    
    // 用户相关路由
    user := v4.<span class="hljs-built_in">Group</span>(<span class="hljs-string">"/user"</span>)
    user.<span class="hljs-built_in">Use</span>(middleware.<span class="hljs-built_in">LoginRequired</span>())
    {
        user<span class="hljs-selector-class">.GET</span>("/info", controllers.GetUserInfo)
        user<span class="hljs-selector-class">.PUT</span>("/info", controllers.UpdateUserInfo)
    }
    
    <span class="hljs-comment">// 文件相关路由</span>
    file := v4.<span class="hljs-built_in">Group</span>(<span class="hljs-string">"/file"</span>)
    {
        file<span class="hljs-selector-class">.GET</span>("/list", controllers.ListFiles)
        file<span class="hljs-selector-class">.POST</span>("/upload", controllers.UploadFile)
    }
    
    return r
}
```

### 中间件系统

```go
<span class="hljs-comment">// middleware/auth.go</span>
func <span class="hljs-built_in">LoginRequired</span>() gin<span class="hljs-selector-class">.HandlerFunc</span> {
    return <span class="hljs-built_in">func</span>(c *gin.Context) {
        <span class="hljs-comment">// 从请求头获取 token</span>
        token := c.<span class="hljs-built_in">GetHeader</span>(<span class="hljs-string">"Authorization"</span>)
        if token == <span class="hljs-string">""</span> {
            c<span class="hljs-selector-class">.JSON</span>(http.StatusUnauthorized, gin.H{
                "error": "Missing authorization token",
            })
            c<span class="hljs-selector-class">.Abort</span>()
            return
        }
        
        <span class="hljs-comment">// 验证 token</span>
        user, err := <span class="hljs-built_in">validateToken</span>(token)
        if err != nil {
            c<span class="hljs-selector-class">.JSON</span>(http.StatusUnauthorized, gin.H{
                "error": "Invalid token",
            })
            c<span class="hljs-selector-class">.Abort</span>()
            return
        }
        
        <span class="hljs-comment">// 将用户信息存储到上下文</span>
        c<span class="hljs-selector-class">.Set</span>("user", user)
        c<span class="hljs-selector-class">.Next</span>()
    }
}
```

## Ent ORM 框架

### 模式定义

```go
<span class="hljs-comment">// ent/schema/user.go</span>
package schema

import (
    "entgo.io/ent"
    "entgo.io/ent/schema/field"
    "entgo.io/ent/schema/edge"
)

<span class="hljs-comment">// User 用户实体</span>
type User struct {
    ent<span class="hljs-selector-class">.Schema</span>
}

<span class="hljs-comment">// Fields 字段定义</span>
func (User) <span class="hljs-built_in">Fields</span>() <span class="hljs-selector-attr">[]</span>ent<span class="hljs-selector-class">.Field</span> {
    return <span class="hljs-selector-attr">[]</span>ent<span class="hljs-selector-class">.Field</span>{
        field<span class="hljs-selector-class">.String</span>("name").
            <span class="hljs-built_in">NotEmpty</span>().
            <span class="hljs-built_in">Comment</span>("用户名"),
        field<span class="hljs-selector-class">.String</span>("email").
            <span class="hljs-built_in">Unique</span>().
            <span class="hljs-built_in">Comment</span>("邮箱"),
        field<span class="hljs-selector-class">.String</span>("password").
            <span class="hljs-built_in">Sensitive</span>().
            <span class="hljs-built_in">Comment</span>("密码"),
        field<span class="hljs-selector-class">.Time</span>("created_at").
            Default(time.Now).
            <span class="hljs-built_in">Comment</span>("创建时间"),
    }
}

<span class="hljs-comment">// Edges 关联关系</span>
func (User) <span class="hljs-built_in">Edges</span>() <span class="hljs-selector-attr">[]</span>ent<span class="hljs-selector-class">.Edge</span> {
    return <span class="hljs-selector-attr">[]</span>ent<span class="hljs-selector-class">.Edge</span>{
        edge<span class="hljs-selector-class">.To</span>("files", File.Type).
            <span class="hljs-built_in">Comment</span>("用户文件"),
        edge<span class="hljs-selector-class">.To</span>("groups", Group.Type).
            <span class="hljs-built_in">Through</span>("user_groups", UserGroup.Type).
            <span class="hljs-built_in">Comment</span>("用户组"),
    }
}
```

### 数据库操作

```go
<span class="hljs-comment">// service/user/user.go</span>
type UserService struct {
    client *ent<span class="hljs-selector-class">.Client</span>
}

func <span class="hljs-built_in">NewUserService</span>(client *ent.Client) *UserService {
    return &amp;UserService{client: client}
}

<span class="hljs-comment">// 创建用户</span>
func (s *UserService) <span class="hljs-built_in">CreateUser</span>(ctx context.Context, req *CreateUserRequest) (*ent.User, error) {
    user, err := s.client.User.
        <span class="hljs-built_in">Create</span>().
        <span class="hljs-built_in">SetName</span>(req.Name).
        <span class="hljs-built_in">SetEmail</span>(req.Email).
        <span class="hljs-built_in">SetPassword</span>(<span class="hljs-built_in">hashPassword</span>(req.Password)).
        <span class="hljs-built_in">Save</span>(ctx)
    
    if err != nil {
        return nil, fmt<span class="hljs-selector-class">.Errorf</span>("failed to create user: %w", err)
    }
    
    return user, nil
}

<span class="hljs-comment">// 查询用户</span>
func (s *UserService) <span class="hljs-built_in">GetUser</span>(ctx context.Context, id int) (*ent.User, error) {
    user, err := s.client.User.
        <span class="hljs-built_in">Query</span>().
        <span class="hljs-built_in">Where</span>(user.<span class="hljs-built_in">ID</span>(id)).
        <span class="hljs-built_in">WithFiles</span>().  // 预加载文件关联
        <span class="hljs-built_in">Only</span>(ctx)
    
    if err != nil {
        if ent<span class="hljs-selector-class">.IsNotFound</span>(err) {
            return nil, fmt<span class="hljs-selector-class">.Errorf</span>("user not found")
        }
        return nil, fmt<span class="hljs-selector-class">.Errorf</span>("failed to get user: %w", err)
    }
    
    return user, nil
}

<span class="hljs-comment">// 更新用户</span>
func (s *UserService) <span class="hljs-built_in">UpdateUser</span>(ctx context.Context, id int, req *UpdateUserRequest) (*ent.User, error) {
    user, err := s.client.User.
        <span class="hljs-built_in">UpdateOneID</span>(id).
        <span class="hljs-built_in">SetName</span>(req.Name).
        <span class="hljs-built_in">SetEmail</span>(req.Email).
        <span class="hljs-built_in">Save</span>(ctx)
    
    if err != nil {
        return nil, fmt<span class="hljs-selector-class">.Errorf</span>("failed to update user: %w", err)
    }
    
    return user, nil
}
```

## 控制器层设计

### 控制器结构

```go
<span class="hljs-comment">// routers/controllers/user.go</span>
package controllers

import (
    "github.com/gin-gonic/gin"
    "github.com/cloudreve/Cloudreve/v4/service/user"
)

<span class="hljs-comment">// GetUserInfo 获取用户信息</span>
func <span class="hljs-built_in">GetUserInfo</span>(c *gin.Context) {
    <span class="hljs-comment">// 从上下文获取用户</span>
    currentUser, exists := c.<span class="hljs-built_in">Get</span>(<span class="hljs-string">"user"</span>)
    if !exists {
        c<span class="hljs-selector-class">.JSON</span>(http.StatusUnauthorized, gin.H{
            "error": "User not found in context",
        })
        return
    }
    
    user := currentUser.(*ent.User)
    
    // 返回用户信息
    c.<span class="hljs-built_in">JSON</span>(http.StatusOK, gin.H{
        "data": gin.H{
            "id":    user.ID,
            <span class="hljs-string">"name"</span>:  user.Name,
            <span class="hljs-string">"email"</span>: user.Email,
        },
    })
}

<span class="hljs-comment">// UpdateUserInfo 更新用户信息</span>
func <span class="hljs-built_in">UpdateUserInfo</span>(c *gin.Context) {
    <span class="hljs-selector-tag">var</span> req user<span class="hljs-selector-class">.UpdateUserRequest</span>
    
    <span class="hljs-comment">// 绑定请求参数</span>
    if err := c.<span class="hljs-built_in">ShouldBindJSON</span>(&amp;req); err != nil {
        c<span class="hljs-selector-class">.JSON</span>(http.StatusBadRequest, gin.H{
            "error": err.Error(),
        })
        return
    }
    
    <span class="hljs-comment">// 获取当前用户</span>
    currentUser := c.<span class="hljs-built_in">MustGet</span>(<span class="hljs-string">"user"</span>).(*ent.User)
    
    // 调用服务层
    userService := user.<span class="hljs-built_in">NewUserService</span>(ent.<span class="hljs-built_in">GetClient</span>())
    updatedUser, err := userService.<span class="hljs-built_in">UpdateUser</span>(c.Request.<span class="hljs-built_in">Context</span>(), currentUser.ID, &amp;req)
    if err != nil {
        c<span class="hljs-selector-class">.JSON</span>(http.StatusInternalServerError, gin.H{
            "error": err.Error(),
        })
        return
    }
    
    c<span class="hljs-selector-class">.JSON</span>(http.StatusOK, gin.H{
        "data": updatedUser,
    })
}
```

### 参数绑定和验证

```go
<span class="hljs-comment">// service/user/types.go</span>
type CreateUserRequest struct {
    Name     string `json:<span class="hljs-string">"name"</span> binding:<span class="hljs-string">"required,min=2,max=50"</span>`
    Email    string `json:<span class="hljs-string">"email"</span> binding:<span class="hljs-string">"required,email"</span>`
    Password string `json:<span class="hljs-string">"password"</span> binding:<span class="hljs-string">"required,min=6"</span>`
}

type UpdateUserRequest struct {
    Name  string `json:<span class="hljs-string">"name"</span> binding:<span class="hljs-string">"omitempty,min=2,max=50"</span>`
    Email string `json:<span class="hljs-string">"email"</span> binding:<span class="hljs-string">"omitempty,email"</span>`
}

<span class="hljs-comment">// 自定义验证器</span>
func <span class="hljs-built_in">ValidatePassword</span>(fl validator.FieldLevel) bool {
    password := fl.<span class="hljs-built_in">Field</span>().<span class="hljs-built_in">String</span>()
    // 密码必须包含字母和数字
    hasLetter := regexp.<span class="hljs-built_in">MustCompile</span>(`[a-zA-Z]`).<span class="hljs-built_in">MatchString</span>(password)
    hasNumber := regexp.<span class="hljs-built_in">MustCompile</span>(`[<span class="hljs-number">0</span>-<span class="hljs-number">9</span>]`).<span class="hljs-built_in">MatchString</span>(password)
    return hasLetter &amp;&amp; hasNumber
}
```

## 服务层设计模式

### 依赖注入

```go
<span class="hljs-comment">// application/dependency/dependency.go</span>
type Dep interface {
    <span class="hljs-built_in">Logger</span>() logging<span class="hljs-selector-class">.Logger</span>
    <span class="hljs-built_in">ConfigProvider</span>() conf<span class="hljs-selector-class">.Provider</span>
    <span class="hljs-built_in">DatabaseClient</span>() *ent<span class="hljs-selector-class">.Client</span>
    <span class="hljs-built_in">CacheProvider</span>() cache<span class="hljs-selector-class">.Driver</span>
}

type dep struct {
    logger         logging<span class="hljs-selector-class">.Logger</span>
    configProvider conf<span class="hljs-selector-class">.Provider</span>
    dbClient       *ent<span class="hljs-selector-class">.Client</span>
    cacheProvider  cache<span class="hljs-selector-class">.Driver</span>
}

func <span class="hljs-built_in">NewDep</span>() Dep {
    return &amp;dep{
        logger:         logging.<span class="hljs-built_in">NewLogger</span>(),
        configProvider: conf.<span class="hljs-built_in">NewProvider</span>(),
        dbClient:       ent.<span class="hljs-built_in">NewClient</span>(),
        cacheProvider:  cache.<span class="hljs-built_in">NewRedisDriver</span>(),
    }
}
```

### 服务接口设计

```go
<span class="hljs-comment">// service/user/interface.go</span>
type Service interface {
    <span class="hljs-built_in">CreateUser</span>(ctx context.Context, req *CreateUserRequest) (*ent.User, error)
    <span class="hljs-built_in">GetUser</span>(ctx context.Context, id int) (*ent.User, error)
    <span class="hljs-built_in">UpdateUser</span>(ctx context.Context, id int, req *UpdateUserRequest) (*ent.User, error)
    <span class="hljs-built_in">DeleteUser</span>(ctx context.Context, id int) error
    <span class="hljs-built_in">ListUsers</span>(ctx context.Context, req *ListUsersRequest) ([]*ent.User, error)
}

<span class="hljs-comment">// service/user/service.go</span>
type service struct {
    dep    dependency<span class="hljs-selector-class">.Dep</span>
    client *ent<span class="hljs-selector-class">.Client</span>
    logger logging<span class="hljs-selector-class">.Logger</span>
}

func <span class="hljs-built_in">NewService</span>(dep dependency.Dep) Service {
    return &amp;service{
        dep:    dep,
        client: dep.<span class="hljs-built_in">DatabaseClient</span>(),
        logger: dep.<span class="hljs-built_in">Logger</span>(),
    }
}
```

## 认证和授权系统

### JWT 认证

```go
<span class="hljs-comment">// pkg/auth/jwt.go</span>
type JWTAuth struct {
    secretKey <span class="hljs-selector-attr">[]</span>byte
    issuer    string
}

type Claims struct {
    UserID int    `json:<span class="hljs-string">"user_id"</span>`
    Email  string `json:<span class="hljs-string">"email"</span>`
    jwt.RegisteredClaims
}

func (j *JWTAuth) <span class="hljs-built_in">GenerateToken</span>(user *ent.User) (string, error) {
    claims := &amp;Claims{
        UserID: user.ID,
        Email:  user.Email,
        RegisteredClaims: jwt.RegisteredClaims{
            ExpiresAt: jwt.<span class="hljs-built_in">NewNumericDate</span>(time.<span class="hljs-built_in">Now</span>().<span class="hljs-built_in">Add</span>(<span class="hljs-number">24</span> * time.Hour)),
            IssuedAt:  jwt.<span class="hljs-built_in">NewNumericDate</span>(time.<span class="hljs-built_in">Now</span>()),
            Issuer:    j.issuer,
        },
    }
    
    token := jwt.<span class="hljs-built_in">NewWithClaims</span>(jwt.SigningMethodHS256, claims)
    return token.<span class="hljs-built_in">SignedString</span>(j.secretKey)
}

func (j *JWTAuth) <span class="hljs-built_in">ValidateToken</span>(tokenString string) (*Claims, error) {
    token, err := jwt.<span class="hljs-built_in">ParseWithClaims</span>(tokenString, &amp;Claims{}, <span class="hljs-built_in">func</span>(token *jwt.Token) (interface{}, error) {
        return j<span class="hljs-selector-class">.secretKey</span>, nil
    })
    
    if err != nil {
        return nil, err
    }
    
    if claims, ok := token.Claims.(*Claims); ok &amp;&amp; token<span class="hljs-selector-class">.Valid</span> {
        return claims, nil
    }
    
    return nil, fmt<span class="hljs-selector-class">.Errorf</span>("invalid token")
}
```

### 权限控制

```go
<span class="hljs-comment">// middleware/rbac.go</span>
func <span class="hljs-built_in">RequirePermission</span>(permission string) gin<span class="hljs-selector-class">.HandlerFunc</span> {
    return <span class="hljs-built_in">func</span>(c *gin.Context) {
        user := c.<span class="hljs-built_in">MustGet</span>(<span class="hljs-string">"user"</span>).(*ent.User)
        
        // 检查用户权限
        hasPermission, err := <span class="hljs-built_in">checkUserPermission</span>(user.ID, permission)
        if err != nil {
            c<span class="hljs-selector-class">.JSON</span>(http.StatusInternalServerError, gin.H{
                "error": "Failed to check permission",
            })
            c<span class="hljs-selector-class">.Abort</span>()
            return
        }
        
        if !hasPermission {
            c<span class="hljs-selector-class">.JSON</span>(http.StatusForbidden, gin.H{
                "error": "Insufficient permissions",
            })
            c<span class="hljs-selector-class">.Abort</span>()
            return
        }
        
        c<span class="hljs-selector-class">.Next</span>()
    }
}

<span class="hljs-comment">// 使用方式</span>
admin := v4.<span class="hljs-built_in">Group</span>(<span class="hljs-string">"/admin"</span>)
admin.<span class="hljs-built_in">Use</span>(middleware.<span class="hljs-built_in">LoginRequired</span>())
admin.<span class="hljs-built_in">Use</span>(middleware.<span class="hljs-built_in">RequirePermission</span>(<span class="hljs-string">"admin:read"</span>))
{
    admin<span class="hljs-selector-class">.GET</span>("/users", controllers.ListUsers)
}
```

## 文件存储系统

### 存储接口设计

```go
<span class="hljs-comment">// pkg/filesystem/driver.go</span>
type Driver interface {
    <span class="hljs-comment">// 上传文件</span>
    <span class="hljs-built_in">Put</span>(ctx context.Context, path string, file io.Reader) error
    
    <span class="hljs-comment">// 获取文件</span>
    <span class="hljs-built_in">Get</span>(ctx context.Context, path string) (io.ReadCloser, error)
    
    <span class="hljs-comment">// 删除文件</span>
    <span class="hljs-built_in">Delete</span>(ctx context.Context, path string) error
    
    <span class="hljs-comment">// 获取文件信息</span>
    <span class="hljs-built_in">Stat</span>(ctx context.Context, path string) (*FileInfo, error)
    
    <span class="hljs-comment">// 列出文件</span>
    <span class="hljs-built_in">List</span>(ctx context.Context, path string) ([]*FileInfo, error)
}

type FileInfo struct {
    Name    string
    Size    int64
    ModTime <span class="hljs-selector-tag">time</span><span class="hljs-selector-class">.Time</span>
    IsDir   bool
}
```

### 本地存储实现

```go
<span class="hljs-comment">// pkg/filesystem/local.go</span>
type LocalDriver struct {
    rootPath string
}

func <span class="hljs-built_in">NewLocalDriver</span>(rootPath string) Driver {
    return &amp;LocalDriver{rootPath: rootPath}
}

func (d *LocalDriver) <span class="hljs-built_in">Put</span>(ctx context.Context, path string, file io.Reader) error {
    fullPath := filepath.<span class="hljs-built_in">Join</span>(d.rootPath, path)
    
    // 确保目录存在
    if err := os.<span class="hljs-built_in">MkdirAll</span>(filepath.<span class="hljs-built_in">Dir</span>(fullPath), <span class="hljs-number">0755</span>); err != nil {
        return fmt<span class="hljs-selector-class">.Errorf</span>("failed to create directory: %w", err)
    }
    
    <span class="hljs-comment">// 创建文件</span>
    dst, err := os.<span class="hljs-built_in">Create</span>(fullPath)
    if err != nil {
        return fmt<span class="hljs-selector-class">.Errorf</span>("failed to create file: %w", err)
    }
    defer dst<span class="hljs-selector-class">.Close</span>()
    
    <span class="hljs-comment">// 复制文件内容</span>
    _, err = io<span class="hljs-selector-class">.Copy</span>(dst, file)
    if err != nil {
        return fmt<span class="hljs-selector-class">.Errorf</span>("failed to write file: %w", err)
    }
    
    return nil
}

func (d *LocalDriver) <span class="hljs-built_in">Get</span>(ctx context.Context, path string) (io.ReadCloser, error) {
    fullPath := filepath.<span class="hljs-built_in">Join</span>(d.rootPath, path)
    
    file, err := os.<span class="hljs-built_in">Open</span>(fullPath)
    if err != nil {
        return nil, fmt<span class="hljs-selector-class">.Errorf</span>("failed to open file: %w", err)
    }
    
    return file, nil
}
```

## 聊天服务实现

### OpenRouter 客户端

```go
<span class="hljs-comment">// pkg/openrouter/client.go</span>
type Client struct {
    apiKey     string
    baseURL    string
    httpClient *http<span class="hljs-selector-class">.Client</span>
    logger     logging<span class="hljs-selector-class">.Logger</span>
}

type ChatRequest struct {
    Model       string    `json:<span class="hljs-string">"model"</span>`
    Messages    []Message `json:<span class="hljs-string">"messages"</span>`
    Stream      bool      `json:<span class="hljs-string">"stream"</span>`
    Temperature float64   `json:<span class="hljs-string">"temperature"</span>`
    MaxTokens   int       `json:<span class="hljs-string">"max_tokens"</span>`
}

type Message struct {
    Role    string `json:<span class="hljs-string">"role"</span>`
    Content string `json:<span class="hljs-string">"content"</span>`
}

func (c *Client) <span class="hljs-built_in">Chat</span>(ctx context.Context, req ChatRequest) (*ChatResponse, error) {
    reqBody, err := json.<span class="hljs-built_in">Marshal</span>(req)
    if err != nil {
        return nil, fmt<span class="hljs-selector-class">.Errorf</span>("failed to marshal request: %w", err)
    }
    
    httpReq, err := http.<span class="hljs-built_in">NewRequestWithContext</span>(ctx, <span class="hljs-string">"POST"</span>, c.baseURL+<span class="hljs-string">"/chat/completions"</span>, bytes.<span class="hljs-built_in">NewReader</span>(reqBody))
    if err != nil {
        return nil, fmt<span class="hljs-selector-class">.Errorf</span>("failed to create request: %w", err)
    }
    
    httpReq<span class="hljs-selector-class">.Header</span><span class="hljs-selector-class">.Set</span>("Authorization", "Bearer "+c.apiKey)
    httpReq<span class="hljs-selector-class">.Header</span><span class="hljs-selector-class">.Set</span>("Content-Type", "application/json")
    
    resp, err := c.httpClient.<span class="hljs-built_in">Do</span>(httpReq)
    if err != nil {
        return nil, fmt<span class="hljs-selector-class">.Errorf</span>("failed to send request: %w", err)
    }
    defer resp<span class="hljs-selector-class">.Body</span><span class="hljs-selector-class">.Close</span>()
    
    <span class="hljs-selector-tag">var</span> chatResp ChatResponse
    if err := json.<span class="hljs-built_in">NewDecoder</span>(resp.Body).<span class="hljs-built_in">Decode</span>(&amp;chatResp); err != nil {
        return nil, fmt<span class="hljs-selector-class">.Errorf</span>("failed to decode response: %w", err)
    }
    
    return &amp;chatResp, nil
}
```

### 流式响应处理

```go
<span class="hljs-comment">// service/chat/chat.go</span>
type StreamCallback <span class="hljs-built_in">func</span>(content string, done bool) error

func (s *ChatService) <span class="hljs-built_in">StreamChat</span>(ctx context.Context, user *ent.User, message string, callback StreamCallback) error {
    req := openrouter.ChatRequest{
        Model: <span class="hljs-string">"google/gemini-2.5-pro"</span>,
        Messages: []openrouter.Message{
            {
                Role:    <span class="hljs-string">"system"</span>,
                Content: <span class="hljs-string">"你是 Cloudreve 云盘的 AI 助手"</span>,
            },
            {
                Role:    <span class="hljs-string">"user"</span>,
                Content: message,
            },
        },
        Stream:      true,
        Temperature: <span class="hljs-number">0.7</span>,
        MaxTokens:   <span class="hljs-number">2000</span>,
    }
    
    return s<span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.ChatStream</span>(ctx, req, callback)
}

<span class="hljs-comment">// 在控制器中使用</span>
func <span class="hljs-built_in">ChatStream</span>(c *gin.Context) {
    <span class="hljs-comment">// 设置 SSE 响应头</span>
    c<span class="hljs-selector-class">.Header</span>("Content-Type", "text/event-stream")
    c<span class="hljs-selector-class">.Header</span>("Cache-Control", "no-cache")
    c<span class="hljs-selector-class">.Header</span>("Connection", "keep-alive")
    
    <span class="hljs-comment">// 获取参数</span>
    service := ParametersFromContext[*chatsvc.Service](c, ChatParameterCtx)
    user := c.<span class="hljs-built_in">MustGet</span>(<span class="hljs-string">"user"</span>).(*ent.User)
    
    // 创建聊天服务
    chatService := chatsvc.<span class="hljs-built_in">NewChatService</span>(dep)
    
    // 流式回调
    callback := <span class="hljs-built_in">func</span>(content string, done bool) error {
        data := map[string]interface{}{
            "choices": []map[string]interface{}{
                {
                    "delta": map[string]interface{}{
                        "<span class="hljs-attribute">content</span>": content,
                    },
                    "finish_reason": nil,
                },
            },
        }
        
        if done {
            data<span class="hljs-selector-attr">[<span class="hljs-string">"choices"</span>]</span>.([]map[string]interface{})<span class="hljs-selector-attr">[0]</span><span class="hljs-selector-attr">[<span class="hljs-string">"finish_reason"</span>]</span> = "stop"
        }
        
        jsonData, _ := json.<span class="hljs-built_in">Marshal</span>(data)
        fmt.<span class="hljs-built_in">Fprintf</span>(c.Writer, <span class="hljs-string">"data: %s\n\n"</span>, jsonData)
        c.Writer.<span class="hljs-built_in">Flush</span>()
        
        return nil
    }
    
    <span class="hljs-comment">// 执行流式聊天</span>
    err := chatService.<span class="hljs-built_in">StreamChat</span>(c.Request.<span class="hljs-built_in">Context</span>(), user, service.Message, callback)
    if err != nil {
        c<span class="hljs-selector-class">.JSON</span>(http.StatusInternalServerError, gin.H{"error": err.Error()})
        return
    }
}
```

## 错误处理和日志

### 统一错误处理

```go
<span class="hljs-comment">// pkg/errors/errors.go</span>
type AppError struct {
    <span class="hljs-selector-tag">Code</span>    int    `json:<span class="hljs-string">"code"</span>`
    Message string `json:<span class="hljs-string">"message"</span>`
    Details string `json:<span class="hljs-string">"details,omitempty"</span>`
}

func (e *AppError) <span class="hljs-built_in">Error</span>() string {
    return e<span class="hljs-selector-class">.Message</span>
}

func <span class="hljs-built_in">NewAppError</span>(code int, message string) *AppError {
    return &amp;AppError{
        <span class="hljs-selector-tag">Code</span>:    code,
        Message: message,
    }
}

<span class="hljs-comment">// 预定义错误</span>
<span class="hljs-selector-tag">var</span> (
    ErrUserNotFound     = NewAppError(<span class="hljs-number">404</span>, "User not found")
    ErrInvalidPassword  = <span class="hljs-built_in">NewAppError</span>(<span class="hljs-number">400</span>, "Invalid password")
    ErrUnauthorized     = <span class="hljs-built_in">NewAppError</span>(<span class="hljs-number">401</span>, "Unauthorized")
    ErrForbidden        = <span class="hljs-built_in">NewAppError</span>(<span class="hljs-number">403</span>, "Forbidden")
)
```

### 结构化日志

```go
<span class="hljs-comment">// pkg/logging/logger.go</span>
type Logger interface {
    <span class="hljs-built_in">Debug</span>(msg string, fields ...Field)
    <span class="hljs-built_in">Info</span>(msg string, fields ...Field)
    <span class="hljs-built_in">Warn</span>(msg string, fields ...Field)
    <span class="hljs-built_in">Error</span>(msg string, fields ...Field)
    <span class="hljs-built_in">Fatal</span>(msg string, fields ...Field)
}

type Field struct {
    Key   string
    Value interface{}
}

func <span class="hljs-built_in">String</span>(key, value string) Field {
    return Field{Key: key, Value: value}
}

func <span class="hljs-built_in">Int</span>(key string, value int) Field {
    return Field{Key: key, Value: value}
}

<span class="hljs-comment">// 使用方式</span>
logger<span class="hljs-selector-class">.Info</span>("User created successfully",
    String("user_id", user.ID),
    <span class="hljs-built_in">String</span>("email", user.Email),
    <span class="hljs-built_in">String</span>("ip", c.ClientIP()),
)
```

## 配置管理

### 配置结构

```go
<span class="hljs-comment">// pkg/conf/conf.go</span>
type Config struct {
    System   SystemConfig   `mapstructure:<span class="hljs-string">"system"</span>`
    Database DatabaseConfig `mapstructure:<span class="hljs-string">"database"</span>`
    Redis    RedisConfig    `mapstructure:<span class="hljs-string">"redis"</span>`
    Storage  StorageConfig  `mapstructure:<span class="hljs-string">"storage"</span>`
}

type SystemConfig struct {
    Mode        string `mapstructure:<span class="hljs-string">"mode"</span>`
    Port        int    `mapstructure:<span class="hljs-string">"port"</span>`
    Debug       bool   `mapstructure:<span class="hljs-string">"debug"</span>`
    SessionName string `mapstructure:<span class="hljs-string">"session_name"</span>`
}

type DatabaseConfig struct {
    Type     string `mapstructure:<span class="hljs-string">"type"</span>`
    Host     string `mapstructure:<span class="hljs-string">"host"</span>`
    Port     int    `mapstructure:<span class="hljs-string">"port"</span>`
    User     string `mapstructure:<span class="hljs-string">"user"</span>`
    Password string `mapstructure:<span class="hljs-string">"password"</span>`
    Name     string `mapstructure:<span class="hljs-string">"name"</span>`
}

<span class="hljs-comment">// 加载配置</span>
func <span class="hljs-built_in">LoadConfig</span>(path string) (*Config, error) {
    viper<span class="hljs-selector-class">.SetConfigFile</span>(path)
    viper<span class="hljs-selector-class">.SetConfigType</span>("yaml")
    
    if err := viper.<span class="hljs-built_in">ReadInConfig</span>(); err != nil {
        return nil, fmt<span class="hljs-selector-class">.Errorf</span>("failed to read config: %w", err)
    }
    
    <span class="hljs-selector-tag">var</span> config Config
    if err := viper.<span class="hljs-built_in">Unmarshal</span>(&amp;config); err != nil {
        return nil, fmt<span class="hljs-selector-class">.Errorf</span>("failed to unmarshal config: %w", err)
    }
    
    return &amp;config, nil
}
```

## 测试策略

### 单元测试

```go
<span class="hljs-comment">// service/user/user_test.go</span>
func <span class="hljs-built_in">TestUserService_CreateUser</span>(t *testing.T) {
    <span class="hljs-comment">// 设置测试数据库</span>
    client := enttest.<span class="hljs-built_in">Open</span>(t, <span class="hljs-string">"sqlite3"</span>, <span class="hljs-string">"file:ent?mode=memory&amp;cache=shared&amp;_fk=1"</span>)
    defer client.<span class="hljs-built_in">Close</span>()
    
    // 创建服务
    service := <span class="hljs-built_in">NewUserService</span>(client)
    
    // 测试数据
    req := &amp;CreateUserRequest{
        Name:     <span class="hljs-string">"Test User"</span>,
        Email:    <span class="hljs-string">"test@example.com"</span>,
        Password: <span class="hljs-string">"password123"</span>,
    }
    
    <span class="hljs-comment">// 执行测试</span>
    user, err := service.<span class="hljs-built_in">CreateUser</span>(context.<span class="hljs-built_in">Background</span>(), req)
    
    // 断言
    assert.<span class="hljs-built_in">NoError</span>(t, err)
    assert.<span class="hljs-built_in">NotNil</span>(t, user)
    assert.<span class="hljs-built_in">Equal</span>(t, req.Name, user.Name)
    assert.<span class="hljs-built_in">Equal</span>(t, req.Email, user.Email)
}
```

### 集成测试

```go
<span class="hljs-comment">// test/integration/api_test.go</span>
func <span class="hljs-built_in">TestUserAPI</span>(t *testing.T) {
    <span class="hljs-comment">// 设置测试服务器</span>
    router := <span class="hljs-built_in">setupTestRouter</span>()
    
    // 创建用户
    createReq := `{"name":<span class="hljs-string">"Test User"</span>,<span class="hljs-string">"email"</span>:<span class="hljs-string">"test@example.com"</span>,<span class="hljs-string">"password"</span>:<span class="hljs-string">"password123"</span>}`
    w := httptest.<span class="hljs-built_in">NewRecorder</span>()
    req, _ := http.<span class="hljs-built_in">NewRequest</span>(<span class="hljs-string">"POST"</span>, <span class="hljs-string">"/api/v4/user"</span>, strings.<span class="hljs-built_in">NewReader</span>(createReq))
    req.Header.<span class="hljs-built_in">Set</span>(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>)
    
    router.<span class="hljs-built_in">ServeHTTP</span>(w, req)
    
    assert.<span class="hljs-built_in">Equal</span>(t, http.StatusCreated, w.Code)
    
    var response map[string]interface{}
    json<span class="hljs-selector-class">.Unmarshal</span>(w.Body.Bytes(), &amp;response)
    
    assert<span class="hljs-selector-class">.Equal</span>(t, "Test User", response["data"].(map[string]interface{})<span class="hljs-selector-attr">[<span class="hljs-string">"name"</span>]</span>)
}
```

## 性能优化

### 数据库优化

```go
<span class="hljs-comment">// 使用索引</span>
func (User) <span class="hljs-built_in">Indexes</span>() <span class="hljs-selector-attr">[]</span>ent<span class="hljs-selector-class">.Index</span> {
    return <span class="hljs-selector-attr">[]</span>ent<span class="hljs-selector-class">.Index</span>{
        index<span class="hljs-selector-class">.Fields</span>("email")<span class="hljs-selector-class">.Unique</span>(),
        index<span class="hljs-selector-class">.Fields</span>("name", "created_at"),
    }
}

<span class="hljs-comment">// 批量操作</span>
func (s *UserService) <span class="hljs-built_in">CreateUsers</span>(ctx context.Context, users []*CreateUserRequest) ([]*ent.User, error) {
    bulk := <span class="hljs-built_in">make</span>([]*ent.UserCreate, <span class="hljs-built_in">len</span>(users))
    for i, req := range users {
        bulk<span class="hljs-selector-attr">[i]</span> = s<span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.User</span><span class="hljs-selector-class">.Create</span>().
            <span class="hljs-built_in">SetName</span>(req.Name).
            <span class="hljs-built_in">SetEmail</span>(req.Email).
            <span class="hljs-built_in">SetPassword</span>(hashPassword(req.Password))
    }
    
    return s<span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.User</span><span class="hljs-selector-class">.CreateBulk</span>(bulk...)<span class="hljs-selector-class">.Save</span>(ctx)
}

<span class="hljs-comment">// 预加载关联</span>
func (s *UserService) <span class="hljs-built_in">GetUserWithFiles</span>(ctx context.Context, id int) (*ent.User, error) {
    return s<span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.User</span>.
        <span class="hljs-built_in">Query</span>().
        <span class="hljs-built_in">Where</span>(user.ID(id)).
        <span class="hljs-built_in">WithFiles</span>(func(q *ent.FileQuery) {
            <span class="hljs-selector-tag">q</span><span class="hljs-selector-class">.Order</span>(ent.Desc(file.FieldCreatedAt)).
              <span class="hljs-built_in">Limit</span>(<span class="hljs-number">10</span>)
        }).
        <span class="hljs-built_in">Only</span>(ctx)
}
```

### 缓存策略

```go
<span class="hljs-comment">// pkg/cache/cache.go</span>
type Cache interface {
    <span class="hljs-built_in">Get</span>(ctx context.Context, key string) (string, error)
    <span class="hljs-built_in">Set</span>(ctx context.Context, key string, value string, ttl time.Duration) error
    <span class="hljs-built_in">Delete</span>(ctx context.Context, key string) error
}

<span class="hljs-comment">// 在服务中使用缓存</span>
func (s *UserService) <span class="hljs-built_in">GetUser</span>(ctx context.Context, id int) (*ent.User, error) {
    cacheKey := fmt.<span class="hljs-built_in">Sprintf</span>(<span class="hljs-string">"user:%d"</span>, id)
    
    // 尝试从缓存获取
    cached, err := s.cache.<span class="hljs-built_in">Get</span>(ctx, cacheKey)
    if err == nil {
        <span class="hljs-selector-tag">var</span> user ent<span class="hljs-selector-class">.User</span>
        if json<span class="hljs-selector-class">.Unmarshal</span>([]byte(cached), &amp;user) == nil {
            return &amp;user, nil
        }
    }
    
    <span class="hljs-comment">// 从数据库获取</span>
    user, err := s.client.User.<span class="hljs-built_in">Get</span>(ctx, id)
    if err != nil {
        return nil, err
    }
    
    <span class="hljs-comment">// 存入缓存</span>
    if data, err := json.<span class="hljs-built_in">Marshal</span>(user); err == nil {
        s<span class="hljs-selector-class">.cache</span><span class="hljs-selector-class">.Set</span>(ctx, cacheKey, string(data), <span class="hljs-selector-tag">time</span><span class="hljs-selector-class">.Hour</span>)
    }
    
    return user, nil
}
```

## 部署和运维

### Docker 化

```dockerfile
# Dockerfile
FROM golang:<span class="hljs-number">1.23</span>-alpine AS builder

WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=<span class="hljs-number">0</span> GOOS=linux go build -o cloudreve .

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/

COPY --from=builder /app/cloudreve .
COPY --from=builder /app/conf.ini .

EXPOSE <span class="hljs-number">5212</span>
CMD [<span class="hljs-string">"./cloudreve"</span>]
```

### 健康检查

```go
// routers/controllers/health.go
func <span class="hljs-built_in">HealthCheck</span>(c *gin.Context) {
    <span class="hljs-comment">// 检查数据库连接</span>
    if err := <span class="hljs-built_in">checkDatabase</span>(); err != nil {
        c<span class="hljs-selector-class">.JSON</span>(http.StatusServiceUnavailable, gin.H{
            "status": "unhealthy",
            "error":  err.Error(),
        })
        return
    }
    
    <span class="hljs-comment">// 检查缓存连接</span>
    if err := <span class="hljs-built_in">checkCache</span>(); err != nil {
        c<span class="hljs-selector-class">.JSON</span>(http.StatusServiceUnavailable, gin.H{
            "status": "unhealthy",
            "error":  err.Error(),
        })
        return
    }
    
    c<span class="hljs-selector-class">.JSON</span>(http.StatusOK, gin.H{
        "status": "healthy",
        "timestamp": time.Now()<span class="hljs-selector-class">.Unix</span>(),
    })
}
```

## 总结

Cloudreve 的后端架构具有以下特点：

<span class="hljs-number">1</span>. **清晰的分层设计**: 路由、控制器、服务、数据访问层职责分明
<span class="hljs-number">2</span>. **现代化的 ORM**: 使用 Ent 提供类型安全的数据库操作
<span class="hljs-number">3</span>. **完善的中间件系统**: 认证、授权、日志、错误处理等
<span class="hljs-number">4</span>. **灵活的存储系统**: 支持多种存储后端
<span class="hljs-number">5</span>. **强大的聊天功能**: 集成 OpenRouter API 支持 AI 对话
<span class="hljs-number">6</span>. **良好的测试覆盖**: 单元测试和集成测试
<span class="hljs-number">7</span>. **性能优化**: 缓存、数据库优化、并发处理

这个架构为你开发侧边栏对话功能提供了坚实的基础，你可以参考现有的聊天服务实现来扩展新功能。
</code></pre>
<h3 data-id="heading-6"><strong>04-api-communication.md - API 通信机制</strong></h3>
<ul>
<li>RESTful API 设计规范</li>
<li>JWT 认证流程和 SSE 流式传输</li>
<li>错误处理和缓存策略</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"># Cloudreve 前后端通信机制详解

## API 设计概览

Cloudreve 采用 RESTful API 设计，前后端通过 HTTP/HTTPS 协议进行通信。API 遵循统一的设计规范，提供清晰的接口定义和错误处理机制。

### API 版本管理

```
基础路径: /api/v4
当前版本: v4
```

所有 API 请求都使用 `/api/v4` 作为基础路径，便于版本管理和向后兼容。

## 请求响应格式

### 统一响应格式

```typescript
interface Response&lt;T&gt; {
  data: T;           <span class="hljs-comment">// 响应数据</span>
  code: number;      <span class="hljs-comment">// 状态码</span>
  msg: string;       <span class="hljs-comment">// 消息</span>
  error?: string;    <span class="hljs-comment">// 错误信息</span>
  correlation_id?: string; <span class="hljs-comment">// 请求追踪ID</span>
}
```

### 成功响应示例

```json
{
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"用户名"</span>,
    <span class="hljs-string">"email"</span>: <span class="hljs-string">"user@example.com"</span>
  },
  <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
  <span class="hljs-string">"msg"</span>: <span class="hljs-string">"success"</span>
}
```

### 错误响应示例

```json
{
  <span class="hljs-string">"data"</span>: null,
  <span class="hljs-string">"code"</span>: <span class="hljs-number">400</span>,
  <span class="hljs-string">"msg"</span>: <span class="hljs-string">"参数验证失败"</span>,
  <span class="hljs-string">"error"</span>: <span class="hljs-string">"email field is required"</span>,
  <span class="hljs-string">"correlation_id"</span>: <span class="hljs-string">"req-123456789"</span>
}
```

## 认证机制

### JWT Token 认证

```mermaid
sequenceDiagram
    participant C as 客户端
    participant S as 服务器
    participant DB as 数据库

    C-&gt;&gt;S: POST /api/v4/session/<span class="hljs-built_in">token</span> (用户名/密码)
    S-&gt;&gt;DB: 验证用户凭据
    DB--&gt;&gt;S: 返回用户信息
    S--&gt;&gt;C: 返回 JWT Token
    
    Note over C: 存储 Token 到 localStorage
    
    C-&gt;&gt;S: GET /api/v4/user/<span class="hljs-built_in">info</span> (Authorization: Bearer &lt;token&gt;)
    S-&gt;&gt;S: 验证 Token
    S--&gt;&gt;C: 返回用户信息
```

### Token 管理

#### <span class="hljs-number">1.</span> 获取 Token

```typescript
<span class="hljs-comment">// 前端登录请求</span>
<span class="hljs-type">const</span> loginRequest = {
  email: <span class="hljs-string">"user@example.com"</span>,
  password: <span class="hljs-string">"password123"</span>
};

<span class="hljs-type">const</span> response = await axios.<span class="hljs-built_in">post</span>(<span class="hljs-string">'/api/v4/session/token'</span>, loginRequest);
<span class="hljs-type">const</span> { access_token, refresh_token } = response.data;

<span class="hljs-comment">// 存储 Token</span>
SessionManager.<span class="hljs-built_in">setTokens</span>(access_token, refresh_token);
```

#### <span class="hljs-number">2.</span> 请求拦截器

```typescript
<span class="hljs-comment">// api/request.ts</span>
instance.interceptors.request.<span class="hljs-built_in">use</span>(<span class="hljs-built_in">async</span> (config) =&gt; {
  <span class="hljs-type">const</span> token = await SessionManager.<span class="hljs-built_in">getAccessToken</span>();
  <span class="hljs-keyword">if</span> (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  <span class="hljs-keyword">return</span> config;
});
```

#### <span class="hljs-number">3.</span> Token 刷新机制

```typescript
instance.interceptors.response.<span class="hljs-built_in">use</span>(
  (response) =&gt; response,
  <span class="hljs-built_in">async</span> (error) =&gt; {
    <span class="hljs-keyword">if</span> (error.response?.status === <span class="hljs-number">401</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 尝试刷新 Token</span>
        await SessionManager.<span class="hljs-built_in">refreshToken</span>();
        <span class="hljs-comment">// 重试原请求</span>
        <span class="hljs-keyword">return</span> instance.<span class="hljs-built_in">request</span>(error.config);
      } <span class="hljs-built_in">catch</span> (refreshError) {
        <span class="hljs-comment">// 刷新失败，跳转登录页</span>
        router.<span class="hljs-built_in">push</span>(<span class="hljs-string">'/session'</span>);
      }
    }
    <span class="hljs-keyword">return</span> Promise.<span class="hljs-built_in">reject</span>(error);
  }
);
```

## 核心 API 接口

### <span class="hljs-number">1.</span> 用户认证 API

#### 登录
```http
POST /api/v4/session/token
Content-Type: application/json

{
  <span class="hljs-string">"email"</span>: <span class="hljs-string">"user@example.com"</span>,
  <span class="hljs-string">"password"</span>: <span class="hljs-string">"password123"</span>
}
```

响应：
```json
{
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"access_token"</span>: <span class="hljs-string">"eyJhbGciOiJIUzI1NiIs..."</span>,
    <span class="hljs-string">"refresh_token"</span>: <span class="hljs-string">"eyJhbGciOiJIUzI1NiIs..."</span>,
    <span class="hljs-string">"expires_in"</span>: <span class="hljs-number">3600</span>,
    <span class="hljs-string">"user"</span>: {
      <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"用户名"</span>,
      <span class="hljs-string">"email"</span>: <span class="hljs-string">"user@example.com"</span>
    }
  },
  <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
  <span class="hljs-string">"msg"</span>: <span class="hljs-string">"登录成功"</span>
}
```

#### 刷新 Token
```http
POST /api/v4/session/refresh
Content-Type: application/json

{
  <span class="hljs-string">"refresh_token"</span>: <span class="hljs-string">"eyJhbGciOiJIUzI1NiIs..."</span>
}
```

#### 登出
```http
DELETE /api/v4/session/token
Authorization: Bearer &lt;access_token&gt;
```

### <span class="hljs-number">2.</span> 文件管理 API

#### 获取文件列表
```http
GET /api/v4/file/list?path=/documents&amp;sort=name&amp;order=asc
Authorization: Bearer &lt;access_token&gt;
```

响应：
```json
{
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"files"</span>: [
      {
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"file_123"</span>,
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"document.pdf"</span>,
        <span class="hljs-string">"size"</span>: <span class="hljs-number">1024000</span>,
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"file"</span>,
        <span class="hljs-string">"created_at"</span>: <span class="hljs-string">"2023-01-01T00:00:00Z"</span>,
        <span class="hljs-string">"path"</span>: <span class="hljs-string">"cloudreve://my/documents/document.pdf"</span>
      }
    ],
    <span class="hljs-string">"total"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"path"</span>: <span class="hljs-string">"/documents"</span>
  },
  <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
  <span class="hljs-string">"msg"</span>: <span class="hljs-string">"success"</span>
}
```

#### 文件上传
```http
POST /api/v4/file/upload
Authorization: Bearer &lt;access_token&gt;
Content-Type: multipart/form-data

file: &lt;binary_data&gt;
path: /documents
```

#### 文件下载
```http
GET /api/v4/file/download/&lt;file_id&gt;
Authorization: Bearer &lt;access_token&gt;
```

### <span class="hljs-number">3.</span> 聊天 API

#### 普通聊天
```http
POST /api/v4/chat
Authorization: Bearer &lt;access_token&gt;
Content-Type: application/json

{
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"请帮我总结一下文档内容"</span>
}
```

响应：
```json
{
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"response"</span>: <span class="hljs-string">"根据您的文档内容，主要包含以下几个方面..."</span>,
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"google/gemini-2.5-pro"</span>,
    <span class="hljs-string">"usage"</span>: {
      <span class="hljs-string">"prompt_tokens"</span>: <span class="hljs-number">100</span>,
      <span class="hljs-string">"completion_tokens"</span>: <span class="hljs-number">200</span>,
      <span class="hljs-string">"total_tokens"</span>: <span class="hljs-number">300</span>
    }
  },
  <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
  <span class="hljs-string">"msg"</span>: <span class="hljs-string">"success"</span>
}
```

#### 流式聊天
```http
POST /api/v4/chat/stream
Authorization: Bearer &lt;access_token&gt;
Content-Type: application/json

{
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"请帮我分析这些文件"</span>
}
```

响应（SSE 格式）：
```
Content-Type: text/event-stream
Cache-Control: no-cache
Connection: keep-alive

data: {<span class="hljs-string">"choices"</span>:[{<span class="hljs-string">"delta"</span>:{<span class="hljs-string">"content"</span>:<span class="hljs-string">"根据"</span>},<span class="hljs-string">"finish_reason"</span>:null}]}

data: {<span class="hljs-string">"choices"</span>:[{<span class="hljs-string">"delta"</span>:{<span class="hljs-string">"content"</span>:<span class="hljs-string">"您的"</span>},<span class="hljs-string">"finish_reason"</span>:null}]}

data: {<span class="hljs-string">"choices"</span>:[{<span class="hljs-string">"delta"</span>:{<span class="hljs-string">"content"</span>:<span class="hljs-string">"文件"</span>},<span class="hljs-string">"finish_reason"</span>:null}]}

data: {<span class="hljs-string">"choices"</span>:[{<span class="hljs-string">"delta"</span>:{<span class="hljs-string">"content"</span>:<span class="hljs-string">""</span>},<span class="hljs-string">"finish_reason"</span>:<span class="hljs-string">"stop"</span>}]}
```

## 错误处理机制

### HTTP 状态码规范

| 状态码 | 含义 | 使用场景 |
|--------|------|----------|
| <span class="hljs-number">200</span> | 成功 | 请求成功处理 |
| <span class="hljs-number">201</span> | 创建成功 | 资源创建成功 |
| <span class="hljs-number">400</span> | 请求错误 | 参数验证失败 |
| <span class="hljs-number">401</span> | 未认证 | Token 无效或过期 |
| <span class="hljs-number">403</span> | 权限不足 | 没有访问权限 |
| <span class="hljs-number">404</span> | 资源不存在 | 请求的资源不存在 |
| <span class="hljs-number">409</span> | 冲突 | 资源冲突（如邮箱已存在） |
| <span class="hljs-number">422</span> | 验证失败 | 业务逻辑验证失败 |
| <span class="hljs-number">500</span> | 服务器错误 | 内部服务器错误 |

### 错误响应格式

```typescript
interface ErrorResponse {
  code: number;
  msg: string;
  error?: string;
  details?: {
    field: string;
    message: string;
  }[];
  correlation_id?: string;
}
```

### 前端错误处理

```typescript
<span class="hljs-comment">// 全局错误处理</span>
instance.interceptors.response.<span class="hljs-built_in">use</span>(
  (response) =&gt; response,
  (error) =&gt; {
    <span class="hljs-type">const</span> { response } = error;
    
    <span class="hljs-keyword">if</span> (response) {
      <span class="hljs-type">const</span> { status, data } = response;
      
      <span class="hljs-keyword">switch</span> (status) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">400</span>:
          <span class="hljs-built_in">enqueueSnackbar</span>(data.msg || <span class="hljs-string">'请求参数错误'</span>, { variant: <span class="hljs-string">'error'</span> });
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
          <span class="hljs-built_in">enqueueSnackbar</span>(<span class="hljs-string">'登录已过期，请重新登录'</span>, { variant: <span class="hljs-string">'error'</span> });
          router.<span class="hljs-built_in">push</span>(<span class="hljs-string">'/session'</span>);
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">403</span>:
          <span class="hljs-built_in">enqueueSnackbar</span>(<span class="hljs-string">'权限不足'</span>, { variant: <span class="hljs-string">'error'</span> });
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">404</span>:
          <span class="hljs-built_in">enqueueSnackbar</span>(<span class="hljs-string">'请求的资源不存在'</span>, { variant: error<span class="hljs-number">'</span> });
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">500</span>:
          <span class="hljs-built_in">enqueueSnackbar</span>(<span class="hljs-string">'服务器内部错误'</span>, { variant: <span class="hljs-string">'error'</span> });
          <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">default</span>:
          <span class="hljs-built_in">enqueueSnackbar</span>(data.msg || <span class="hljs-string">'未知错误'</span>, { variant: <span class="hljs-string">'error'</span> });
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">enqueueSnackbar</span>(<span class="hljs-string">'网络连接错误'</span>, { variant: <span class="hljs-string">'error'</span> });
    }
    
    <span class="hljs-keyword">return</span> Promise.<span class="hljs-built_in">reject</span>(error);
  }
);
```

## 流式数据传输

### <span class="hljs-built_in">Server</span>-<span class="hljs-function">Sent <span class="hljs-title">Events</span> <span class="hljs-params">(SSE)</span>

Cloudreve 使用 SSE 协议实现流式数据传输，主要用于聊天功能的实时响应。

#### 前端 SSE 处理

```typescript
<span class="hljs-comment">// 流式聊天实现</span>
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> streamChat </span>= <span class="hljs-built_in">async</span> (
  message: string,
  onMessage: (content: string) =&gt; <span class="hljs-type">void</span>,
  onComplete: () =&gt; <span class="hljs-type">void</span>,
  onError: (error: Error) =&gt; <span class="hljs-type">void</span>
) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-type">const</span> token = await SessionManager.<span class="hljs-built_in">getAccessToken</span>();
    
    <span class="hljs-type">const</span> response = await <span class="hljs-built_in">fetch</span>(<span class="hljs-string">'/api/v4/chat/stream'</span>, {
      method: <span class="hljs-string">'POST'</span>,
      headers: {
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
        <span class="hljs-string">'Authorization'</span>: `Bearer ${token}`,
      },
      body: JSON.<span class="hljs-built_in">stringify</span>({ message }),
    });
    
    <span class="hljs-keyword">if</span> (!response.ok) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    <span class="hljs-type">const</span> reader = response.body?.<span class="hljs-built_in">getReader</span>();
    <span class="hljs-type">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-built_in">TextDecoder</span>();
    
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
      <span class="hljs-type">const</span> { done, value } = await reader!.<span class="hljs-built_in">read</span>();
      
      <span class="hljs-keyword">if</span> (done) {
        <span class="hljs-built_in">onComplete</span>();
        <span class="hljs-keyword">break</span>;
      }
      
      <span class="hljs-type">const</span> chunk = decoder.<span class="hljs-built_in">decode</span>(value);
      <span class="hljs-type">const</span> lines = chunk.<span class="hljs-built_in">split</span>(<span class="hljs-string">'\n'</span>);
      
      <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> line of lines) {
        <span class="hljs-keyword">if</span> (line.<span class="hljs-built_in">startsWith</span>(<span class="hljs-string">'data: '</span>)) {
          <span class="hljs-type">const</span> data = line.<span class="hljs-built_in">slice</span>(<span class="hljs-number">6</span>);
          
          <span class="hljs-keyword">if</span> (data === <span class="hljs-string">'[DONE]'</span>) {
            <span class="hljs-built_in">onComplete</span>();
            <span class="hljs-keyword">return</span>;
          }
          
          <span class="hljs-keyword">try</span> {
            <span class="hljs-type">const</span> parsed = JSON.<span class="hljs-built_in">parse</span>(data);
            <span class="hljs-type">const</span> content = parsed.choices?.[<span class="hljs-number">0</span>]?.delta?.content;
            
            <span class="hljs-keyword">if</span> (content) {
              <span class="hljs-built_in">onMessage</span>(content);
            }
            
            <span class="hljs-keyword">if</span> (parsed.choices?.[<span class="hljs-number">0</span>]?.finish_reason === <span class="hljs-string">'stop'</span>) {
              <span class="hljs-built_in">onComplete</span>();
              <span class="hljs-keyword">return</span>;
            }
          } <span class="hljs-built_in">catch</span> (parseError) {
            console.<span class="hljs-built_in">warn</span>(<span class="hljs-string">'Failed to parse SSE data:'</span>, data);
          }
        }
      }
    }
  } <span class="hljs-built_in">catch</span> (error) {
    <span class="hljs-built_in">onError</span>(error as Error);
  }
};
```

#### 后端 SSE 实现

```go
<span class="hljs-comment">// 控制器中的流式响应</span>
<span class="hljs-function">func <span class="hljs-title">ChatStream</span><span class="hljs-params">(c *gin.Context)</span> </span>{
    <span class="hljs-comment">// 设置 SSE 响应头</span>
    c.<span class="hljs-built_in">Header</span>(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/event-stream"</span>)
    c.<span class="hljs-built_in">Header</span>(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"no-cache"</span>)
    c.<span class="hljs-built_in">Header</span>(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"keep-alive"</span>)
    c.<span class="hljs-built_in">Header</span>(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>)
    
    <span class="hljs-comment">// 获取参数</span>
    service := ParametersFromContext[*chatsvc.Service](c, ChatParameterCtx)
    user := c.<span class="hljs-built_in">MustGet</span>(<span class="hljs-string">"user"</span>).(*ent.User)
    
    <span class="hljs-comment">// 创建聊天服务</span>
    chatService := chatsvc.<span class="hljs-built_in">NewChatService</span>(dep)
    
    <span class="hljs-comment">// 流式回调函数</span>
    callback := <span class="hljs-built_in">func</span>(content string, done <span class="hljs-type">bool</span>) error {
        data := map[string]interface{}{
            <span class="hljs-string">"id"</span>:      <span class="hljs-string">"chatcmpl-"</span> + <span class="hljs-built_in">generateID</span>(),
            <span class="hljs-string">"object"</span>:  <span class="hljs-string">"chat.completion.chunk"</span>,
            <span class="hljs-string">"created"</span>: time.<span class="hljs-built_in">Now</span>().<span class="hljs-built_in">Unix</span>(),
            <span class="hljs-string">"model"</span>:   <span class="hljs-string">"google/gemini-2.5-pro"</span>,
            <span class="hljs-string">"choices"</span>: []map[string]interface{}{
                {
                    <span class="hljs-string">"index"</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">"delta"</span>: map[string]interface{}{
                        <span class="hljs-string">"content"</span>: content,
                    },
                    <span class="hljs-string">"finish_reason"</span>: nil,
                },
            },
        }
        
        <span class="hljs-keyword">if</span> done {
            data[<span class="hljs-string">"choices"</span>].([]map[string]interface{})[<span class="hljs-number">0</span>][<span class="hljs-string">"finish_reason"</span>] = <span class="hljs-string">"stop"</span>
        }
        
        jsonData, _ := json.<span class="hljs-built_in">Marshal</span>(data)
        fmt.<span class="hljs-built_in">Fprintf</span>(c.Writer, <span class="hljs-string">"data: %s\n\n"</span>, jsonData)
        c.Writer.<span class="hljs-built_in">Flush</span>()
        
        <span class="hljs-keyword">return</span> nil
    }
    
    <span class="hljs-comment">// 执行流式聊天</span>
    err := chatService.<span class="hljs-built_in">StreamChatWithFiles</span>(c.Request.<span class="hljs-built_in">Context</span>(), user, service.Message, callback)
    <span class="hljs-keyword">if</span> err != nil {
        errorData := map[string]interface{}{
            <span class="hljs-string">"error"</span>: map[string]interface{}{
                <span class="hljs-string">"message"</span>: err.<span class="hljs-built_in">Error</span>(),
                <span class="hljs-string">"type"</span>:    <span class="hljs-string">"server_error"</span>,
            },
        }
        jsonData, _ := json.<span class="hljs-built_in">Marshal</span>(errorData)
        fmt.<span class="hljs-built_in">Fprintf</span>(c.Writer, <span class="hljs-string">"data: %s\n\n"</span>, jsonData)
        c.Writer.<span class="hljs-built_in">Flush</span>()
    }
    
    <span class="hljs-comment">// 发送结束标记</span>
    fmt.<span class="hljs-built_in">Fprintf</span>(c.Writer, <span class="hljs-string">"data: [DONE]\n\n"</span>)
    c.Writer.<span class="hljs-built_in">Flush</span>()
}
```

## 文件上传机制

### 分片上传

对于大文件，Cloudreve 支持分片上传机制：

```mermaid
sequenceDiagram
    participant C as 客户端
    participant S as 服务器
    participant FS as 文件系统

    C-&gt;&gt;S: <span class="hljs-number">1.</span> 创建上传会话
    S--&gt;&gt;C: 返回 session_id
    
    loop 分片上传
        C-&gt;&gt;S: <span class="hljs-number">2.</span> 上传分片 (session_id, chunk_index, chunk_data)
        S-&gt;&gt;FS: 存储分片
        S--&gt;&gt;C: 返回上传进度
    end
    
    C-&gt;&gt;S: <span class="hljs-number">3.</span> 完成上传 (session_id)
    S-&gt;&gt;FS: 合并分片
    S--&gt;&gt;C: 返回文件信息
```

#### 前端分片上传实现

```typescript
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> uploadFileWithProgress = <span class="hljs-built_in">async</span> (
  file: <span class="hljs-built_in">File</span>,
  path: string,
  onProgress: (progress: number) =&gt; <span class="hljs-type">void</span>
): Promise&lt;FileResponse&gt; =&gt; {
  <span class="hljs-type">const</span> CHUNK_SIZE = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>; <span class="hljs-comment">// 1MB per chunk</span>
  <span class="hljs-type">const</span> totalChunks = Math.<span class="hljs-built_in">ceil</span>(file.size / CHUNK_SIZE);
  
  <span class="hljs-comment">// 1. 创建上传会话</span>
  <span class="hljs-type">const</span> sessionResponse = await api.<span class="hljs-built_in">post</span>(<span class="hljs-string">'/file/upload/session'</span>, {
    name: file.name,
    size: file.size,
    path: path,
    chunks: totalChunks,
  });
  
  <span class="hljs-type">const</span> sessionId = sessionResponse.data.session_id;
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 2. 分片上传</span>
    <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">0</span>; i &lt; totalChunks; i++) {
      <span class="hljs-type">const</span> start = i * CHUNK_SIZE;
      <span class="hljs-type">const</span> end = Math.<span class="hljs-built_in">min</span>(start + CHUNK_SIZE, file.size);
      <span class="hljs-type">const</span> chunk = file.<span class="hljs-built_in">slice</span>(start, end);
      
      <span class="hljs-type">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-built_in">FormData</span>();
      formData.<span class="hljs-built_in">append</span>(<span class="hljs-string">'chunk'</span>, chunk);
      formData.<span class="hljs-built_in">append</span>(<span class="hljs-string">'session_id'</span>, sessionId);
      formData.<span class="hljs-built_in">append</span>(<span class="hljs-string">'chunk_index'</span>, i.<span class="hljs-built_in">toString</span>());
      
      await api.<span class="hljs-built_in">post</span>(<span class="hljs-string">'/file/upload/chunk'</span>, formData, {
        headers: {
          <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'multipart/form-data'</span>,
        },
      });
      
      <span class="hljs-comment">// 更新进度</span>
      <span class="hljs-type">const</span> progress = Math.<span class="hljs-built_in">round</span>(((i + <span class="hljs-number">1</span>) / totalChunks) * <span class="hljs-number">100</span>);
      <span class="hljs-built_in">onProgress</span>(progress);
    }
    
    <span class="hljs-comment">// 3. 完成上传</span>
    <span class="hljs-type">const</span> completeResponse = await api.<span class="hljs-built_in">post</span>(<span class="hljs-string">'/file/upload/complete'</span>, {
      session_id: sessionId,
    });
    
    <span class="hljs-keyword">return</span> completeResponse.data;
  } <span class="hljs-built_in">catch</span> (error) {
    <span class="hljs-comment">// 上传失败，清理会话</span>
    await api.<span class="hljs-built_in">delete</span>(`/file/upload/session/${sessionId}`);
    <span class="hljs-keyword">throw</span> error;
  }
};
```

## 缓存策略

### 前端缓存

#### <span class="hljs-number">1.</span> HTTP 缓存

```typescript
<span class="hljs-comment">// 为静态资源设置缓存</span>
<span class="hljs-type">const</span> cacheableRequests = [
  <span class="hljs-string">'/api/v4/site/config'</span>,
  <span class="hljs-string">'/api/v4/user/info'</span>,
];

instance.interceptors.request.<span class="hljs-built_in">use</span>((config) =&gt; {
  <span class="hljs-keyword">if</span> (cacheableRequests.<span class="hljs-built_in">some</span>(url =&gt; config.url?.<span class="hljs-built_in">includes</span>(url))) {
    config.headers[<span class="hljs-string">'Cache-Control'</span>] = <span class="hljs-string">'max-age=300'</span>; <span class="hljs-comment">// 5分钟缓存</span>
  }
  <span class="hljs-keyword">return</span> config;
});
```

#### <span class="hljs-number">2.</span> 内存缓存

```typescript
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiCache</span> {
  <span class="hljs-keyword">private</span> cache = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>&lt;string, { data: any; expires: number }&gt;();
  
  <span class="hljs-built_in">get</span>(key: string): any | null {
    <span class="hljs-type">const</span> item = <span class="hljs-keyword">this</span>.cache.<span class="hljs-built_in">get</span>(key);
    <span class="hljs-keyword">if</span> (!item || Date.<span class="hljs-built_in">now</span>() &gt; item.expires) {
      <span class="hljs-keyword">this</span>.cache.<span class="hljs-built_in">delete</span>(key);
      <span class="hljs-keyword">return</span> null;
    }
    <span class="hljs-keyword">return</span> item.data;
  }
  
  <span class="hljs-built_in">set</span>(key: string, data: any, ttl: number = <span class="hljs-number">300000</span>): <span class="hljs-type">void</span> {
    <span class="hljs-keyword">this</span>.cache.<span class="hljs-built_in">set</span>(key, {
      data,
      expires: Date.<span class="hljs-built_in">now</span>() + ttl,
    });
  }
  
  <span class="hljs-built_in">clear</span>(): <span class="hljs-type">void</span> {
    <span class="hljs-keyword">this</span>.cache.<span class="hljs-built_in">clear</span>();
  }
}

<span class="hljs-type">const</span> apiCache = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ApiCache</span>();

<span class="hljs-comment">// 在请求拦截器中使用缓存</span>
instance.interceptors.request.<span class="hljs-built_in">use</span>((config) =&gt; {
  <span class="hljs-keyword">if</span> (config.method === <span class="hljs-string">'GET'</span>) {
    <span class="hljs-type">const</span> cacheKey = `${config.url}?${JSON.<span class="hljs-built_in">stringify</span>(config.params)}`;
    <span class="hljs-type">const</span> cached = apiCache.<span class="hljs-built_in">get</span>(cacheKey);
    
    <span class="hljs-keyword">if</span> (cached) {
      <span class="hljs-comment">// 返回缓存的 Promise</span>
      <span class="hljs-keyword">return</span> Promise.<span class="hljs-built_in">resolve</span>({
        ...config,
        adapter: () =&gt; Promise.<span class="hljs-built_in">resolve</span>({
          data: cached,
          status: <span class="hljs-number">200</span>,
          statusText: <span class="hljs-string">'OK'</span>,
          headers: {},
          config,
        }),
      });
    }
  }
  
  <span class="hljs-keyword">return</span> config;
});
```

### 后端缓存

```go
<span class="hljs-comment">// 缓存中间件</span>
<span class="hljs-function">func <span class="hljs-title">CacheMiddleware</span><span class="hljs-params">(ttl time.Duration)</span> gin.HandlerFunc </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">func</span>(c *gin.Context) {
        <span class="hljs-keyword">if</span> c.Request.Method != <span class="hljs-string">"GET"</span> {
            c.<span class="hljs-built_in">Next</span>()
            <span class="hljs-keyword">return</span>
        }
        
        cacheKey := fmt.<span class="hljs-built_in">Sprintf</span>(<span class="hljs-string">"api:%s:%s"</span>, c.Request.URL.Path, c.Request.URL.RawQuery)
        
        <span class="hljs-comment">// 尝试从缓存获取</span>
        <span class="hljs-keyword">if</span> cached, err := cache.<span class="hljs-built_in">Get</span>(c.Request.<span class="hljs-built_in">Context</span>(), cacheKey); err == nil {
            c.<span class="hljs-built_in">Header</span>(<span class="hljs-string">"X-Cache"</span>, <span class="hljs-string">"HIT"</span>)
            c.<span class="hljs-built_in">Data</span>(<span class="hljs-number">200</span>, <span class="hljs-string">"application/json"</span>, []<span class="hljs-built_in">byte</span>(cached))
            <span class="hljs-keyword">return</span>
        }
        
        <span class="hljs-comment">// 包装 ResponseWriter 以捕获响应</span>
        w := &amp;responseWriter{
            ResponseWriter: c.Writer,
            body:          &amp;bytes.Buffer{},
        }
        c.Writer = w
        
        c.<span class="hljs-built_in">Next</span>()
        
        <span class="hljs-comment">// 缓存响应</span>
        <span class="hljs-keyword">if</span> w.status == <span class="hljs-number">200</span> {
            cache.<span class="hljs-built_in">Set</span>(c.Request.<span class="hljs-built_in">Context</span>(), cacheKey, w.body.<span class="hljs-built_in">String</span>(), ttl)
        }
    }
}
```

## 跨域处理

### CORS 配置

```go
<span class="hljs-comment">// middleware/cors.go</span>
func <span class="hljs-built_in">CORS</span>() gin.HandlerFunc {
    <span class="hljs-keyword">return</span> cors.<span class="hljs-built_in">New</span>(cors.Config{
        AllowOrigins:     []string{<span class="hljs-string">"http://localhost:3000"</span>, <span class="hljs-string">"https://yourdomain.com"</span>},
        AllowMethods:     []string{<span class="hljs-string">"GET"</span>, <span class="hljs-string">"POST"</span>, <span class="hljs-string">"PUT"</span>, <span class="hljs-string">"DELETE"</span>, <span class="hljs-string">"OPTIONS"</span>},
        AllowHeaders:     []string{<span class="hljs-string">"Origin"</span>, <span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"Authorization"</span>},
        ExposeHeaders:    []string{<span class="hljs-string">"Content-Length"</span>},
        AllowCredentials: <span class="hljs-literal">true</span>,
        MaxAge:           <span class="hljs-number">12</span> * time.Hour,
    })
}
```

### 预检请求处理

```typescript
<span class="hljs-comment">// 前端处理预检请求</span>
axios.defaults.withCredentials = <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 自定义预检请求处理</span>
instance.interceptors.request.<span class="hljs-built_in">use</span>((config) =&gt; {
  <span class="hljs-comment">// 对于复杂请求，浏览器会先发送 OPTIONS 预检请求</span>
  <span class="hljs-keyword">if</span> (config.method !== <span class="hljs-string">'GET'</span> &amp;&amp; config.method !== <span class="hljs-string">'POST'</span>) {
    config.headers[<span class="hljs-string">'Content-Type'</span>] = <span class="hljs-string">'application/json'</span>;
  }
  
  <span class="hljs-keyword">return</span> config;
});
```

## API 版本兼容

### 版本策略

```typescript
<span class="hljs-comment">// API 版本管理</span>
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> API_VERSIONS = {
  V3: <span class="hljs-string">'/api/v3'</span>,
  V4: <span class="hljs-string">'/api/v4'</span>,
} as <span class="hljs-type">const</span>;

<span class="hljs-comment">// 根据功能选择 API 版本</span>
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> createApiClient = (version: keyof typeof API_VERSIONS = <span class="hljs-string">'V4'</span>) =&gt; {
  <span class="hljs-keyword">return</span> axios.<span class="hljs-built_in">create</span>({
    baseURL: API_VERSIONS[version],
    timeout: <span class="hljs-number">10000</span>,
  });
};

<span class="hljs-comment">// 向后兼容处理</span>
<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> legacyApiCall = <span class="hljs-built_in">async</span> (endpoint: string, data: any) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 尝试使用新版本 API</span>
    <span class="hljs-keyword">return</span> await v4Client.<span class="hljs-built_in">post</span>(endpoint, data);
  } <span class="hljs-built_in">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error.response?.status === <span class="hljs-number">404</span>) {
      <span class="hljs-comment">// 回退到旧版本 API</span>
      console.<span class="hljs-built_in">warn</span>(`Falling back to v3 API <span class="hljs-keyword">for</span> ${endpoint}`);
      <span class="hljs-keyword">return</span> await v3Client.<span class="hljs-built_in">post</span>(endpoint, data);
    }
    <span class="hljs-keyword">throw</span> error;
  }
};
```

## 性能优化

### 请求优化

#### <span class="hljs-number">1.</span> 请求合并

```typescript
<span class="hljs-comment">// 批量请求合并</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestBatcher</span> {
  <span class="hljs-keyword">private</span> batches = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>&lt;string, any[]&gt;();
  <span class="hljs-keyword">private</span> timers = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>&lt;string, NodeJS.Timeout&gt;();
  
  <span class="hljs-built_in">batch</span>&lt;T&gt;(
    key: string,
    request: any,
    batchFn: (requests: any[]) =&gt; Promise&lt;T[]&gt;,
    delay: number = <span class="hljs-number">100</span>
  ): Promise&lt;T&gt; {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>((resolve, reject) =&gt; {
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.batches.<span class="hljs-built_in">has</span>(key)) {
        <span class="hljs-keyword">this</span>.batches.<span class="hljs-built_in">set</span>(key, []);
      }
      
      <span class="hljs-type">const</span> batch = <span class="hljs-keyword">this</span>.batches.<span class="hljs-built_in">get</span>(key)!;
      batch.<span class="hljs-built_in">push</span>({ request, resolve, reject });
      
      <span class="hljs-comment">// 清除之前的定时器</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.timers.<span class="hljs-built_in">has</span>(key)) {
        <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-keyword">this</span>.timers.<span class="hljs-built_in">get</span>(key)!);
      }
      
      <span class="hljs-comment">// 设置新的定时器</span>
      <span class="hljs-type">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-built_in">async</span> () =&gt; {
        <span class="hljs-type">const</span> currentBatch = <span class="hljs-keyword">this</span>.batches.<span class="hljs-built_in">get</span>(key)!;
        <span class="hljs-keyword">this</span>.batches.<span class="hljs-built_in">delete</span>(key);
        <span class="hljs-keyword">this</span>.timers.<span class="hljs-built_in">delete</span>(key);
        
        <span class="hljs-keyword">try</span> {
          <span class="hljs-type">const</span> requests = currentBatch.<span class="hljs-built_in">map</span>(item =&gt; item.request);
          <span class="hljs-type">const</span> results = await <span class="hljs-built_in">batchFn</span>(requests);
          
          currentBatch.forEach((item, index) =&gt; {
            item.<span class="hljs-built_in">resolve</span>(results[index]);
          });
        } <span class="hljs-built_in">catch</span> (error) {
          currentBatch.forEach(item =&gt; {
            item.<span class="hljs-built_in">reject</span>(error);
          });
        }
      }, delay);
      
      <span class="hljs-keyword">this</span>.timers.<span class="hljs-built_in">set</span>(key, timer);
    });
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-type">const</span> batcher = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RequestBatcher</span>();

<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> getUserInfo = (userId: number) =&gt; {
  <span class="hljs-keyword">return</span> batcher.<span class="hljs-built_in">batch</span>(
    <span class="hljs-string">'getUserInfo'</span>,
    userId,
    <span class="hljs-built_in">async</span> (userIds: number[]) =&gt; {
      <span class="hljs-type">const</span> response = await api.<span class="hljs-built_in">post</span>(<span class="hljs-string">'/user/batch'</span>, { ids: userIds });
      <span class="hljs-keyword">return</span> response.data;
    }
  );
};
```

#### <span class="hljs-number">2.</span> 请求去重

```typescript
<span class="hljs-comment">// 请求去重</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestDeduplicator</span> {
  <span class="hljs-keyword">private</span> pending = <span class="hljs-keyword">new</span> Map&lt;string, Promise&lt;any&gt;&gt;();
  
  <span class="hljs-built_in">dedupe</span>&lt;T&gt;(key: string, requestFn: () =&gt; Promise&lt;T&gt;): Promise&lt;T&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pending.<span class="hljs-built_in">has</span>(key)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pending.<span class="hljs-built_in">get</span>(key)!;
    }
    
    <span class="hljs-type">const</span> promise = <span class="hljs-built_in">requestFn</span>().<span class="hljs-built_in">finally</span>(() =&gt; {
      <span class="hljs-keyword">this</span>.pending.<span class="hljs-built_in">delete</span>(key);
    });
    
    <span class="hljs-keyword">this</span>.pending.<span class="hljs-built_in">set</span>(key, promise);
    <span class="hljs-keyword">return</span> promise;
  }
}

<span class="hljs-type">const</span> deduplicator = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RequestDeduplicator</span>();

<span class="hljs-keyword">export</span> <span class="hljs-type">const</span> getFileList = (path: string) =&gt; {
  <span class="hljs-type">const</span> key = `fileList:${path}`;
  <span class="hljs-keyword">return</span> deduplicator.<span class="hljs-built_in">dedupe</span>(key, () =&gt; 
    api.<span class="hljs-built_in">get</span>(<span class="hljs-string">'/file/list'</span>, { params: { path } })
  );
};
```

## 监控和调试

### 请求日志

```typescript
<span class="hljs-comment">// 请求日志中间件</span>
instance.interceptors.request.<span class="hljs-built_in">use</span>((config) =&gt; {
  <span class="hljs-type">const</span> requestId = <span class="hljs-built_in">generateRequestId</span>();
  config.metadata = { requestId, startTime: Date.<span class="hljs-built_in">now</span>() };
  
  console.<span class="hljs-built_in">log</span>(`[${requestId}] ${config.method?.<span class="hljs-built_in">toUpperCase</span>()} ${config.url}`, {
    params: config.params,
    data: config.data,
  });
  
  <span class="hljs-keyword">return</span> config;
});

instance.interceptors.response.<span class="hljs-built_in">use</span>(
  (response) =&gt; {
    <span class="hljs-type">const</span> { requestId, startTime } = response.config.metadata;
    <span class="hljs-type">const</span> duration = Date.<span class="hljs-built_in">now</span>() - startTime;
    
    console.<span class="hljs-built_in">log</span>(`[${requestId}] Response ${response.status} (${duration}ms)`, {
      data: response.data,
    });
    
    <span class="hljs-keyword">return</span> response;
  },
  (error) =&gt; {
    <span class="hljs-type">const</span> { requestId, startTime } = error.config?.metadata || {};
    <span class="hljs-type">const</span> duration = Date.<span class="hljs-built_in">now</span>() - startTime;
    
    console.<span class="hljs-built_in">error</span>(`[${requestId}] Error ${error.response?.status} (${duration}ms)`, {
      error: error.response?.data,
    });
    
    <span class="hljs-keyword">return</span> Promise.<span class="hljs-built_in">reject</span>(error);
  }
);
```

### 性能监控

```typescript
<span class="hljs-comment">// API 性能监控</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiMonitor</span> {
  <span class="hljs-keyword">private</span> metrics = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>&lt;string, {
    count: number;
    totalTime: number;
    errors: number;
  }&gt;();
  
  <span class="hljs-built_in">record</span>(endpoint: string, duration: number, success: <span class="hljs-type">boolean</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.metrics.<span class="hljs-built_in">has</span>(endpoint)) {
      <span class="hljs-keyword">this</span>.metrics.<span class="hljs-built_in">set</span>(endpoint, { count: <span class="hljs-number">0</span>, totalTime: <span class="hljs-number">0</span>, errors: <span class="hljs-number">0</span> });
    }
    
    <span class="hljs-type">const</span> metric = <span class="hljs-keyword">this</span>.metrics.<span class="hljs-built_in">get</span>(endpoint)!;
    metric.count++;
    metric.totalTime += duration;
    
    <span class="hljs-keyword">if</span> (!success) {
      metric.errors++;
    }
  }
  
  <span class="hljs-built_in">getStats</span>() {
    <span class="hljs-type">const</span> stats = Array.<span class="hljs-built_in">from</span>(<span class="hljs-keyword">this</span>.metrics.<span class="hljs-built_in">entries</span>()).<span class="hljs-built_in">map</span>(([endpoint, metric]) =&gt; ({
      endpoint,
      count: metric.count,
      avgTime: metric.totalTime / metric.count,
      errorRate: metric.errors / metric.count,
    }));
    
    <span class="hljs-keyword">return</span> stats.<span class="hljs-built_in">sort</span>((a, b) =&gt; b.avgTime - a.avgTime);
  }
}

<span class="hljs-type">const</span> monitor = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ApiMonitor</span>();

<span class="hljs-comment">// 在拦截器中使用</span>
instance.interceptors.response.<span class="hljs-built_in">use</span>(
  (response) =&gt; {
    <span class="hljs-type">const</span> duration = Date.<span class="hljs-built_in">now</span>() - response.config.metadata.startTime;
    monitor.<span class="hljs-built_in">record</span>(response.config.url!, duration, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> response;
  },
  (error) =&gt; {
    <span class="hljs-type">const</span> duration = Date.<span class="hljs-built_in">now</span>() - error.config?.metadata?.startTime;
    monitor.<span class="hljs-built_in">record</span>(error.config?.url!, duration, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">return</span> Promise.<span class="hljs-built_in">reject</span>(error);
  }
);
```

## 总结

Cloudreve 的前后端通信机制具有以下特点：

<span class="hljs-number">1.</span> **统一的 API 设计**: RESTful 风格，清晰的接口规范
<span class="hljs-number">2.</span> **完善的认证机制**: JWT Token + 自动刷新
<span class="hljs-number">3.</span> **灵活的错误处理**: 统一的错误格式和处理策略
<span class="hljs-number">4.</span> **流式数据支持**: SSE 协议实现实时通信
<span class="hljs-number">5.</span> **高效的文件传输**: 分片上传支持大文件
<span class="hljs-number">6.</span> **智能缓存策略**: 前后端多层缓存优化
<span class="hljs-number">7.</span> **性能监控**: 完整的请求监控和调试机制

这套通信机制为你开发侧边栏对话功能提供了可靠的基础，你可以直接使用现有的 API 接口和通信模式来实现新功能。
</code></pre>
<h3 data-id="heading-7"><strong>05-development-guide.md - 开发流程指南</strong></h3>
<ul>
<li>
<p>环境搭建和开发工作流</p>
</li>
<li>
<p>调试技巧和性能优化</p>
</li>
<li>
<p>部署流程和最佳实践</p>
</li>
</ul>
<blockquote>
<p>因篇幅限制，完整文档内容详见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FO65Ay8h1S6jbK_j67jQVDg" target="_blank" title="https://mp.weixin.qq.com/s/O65Ay8h1S6jbK_j67jQVDg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/O65Ay8h1S…</a></p>
</blockquote>
<h3 data-id="heading-8"><strong>06-chat-feature-extension.md - 聊天功能扩展实现方案</strong></h3>
<ul>
<li>
<p>基于现有聊天功能的侧边栏扩展</p>
</li>
<li>
<p>完整的前后端代码示例</p>
</li>
<li>
<p>文件夹上下文读取和 AI 对话集成</p>
</li>
</ul>
<blockquote>
<p>因篇幅限制，完整文档内容详见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FO65Ay8h1S6jbK_j67jQVDg" target="_blank" title="https://mp.weixin.qq.com/s/O65Ay8h1S6jbK_j67jQVDg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/O65Ay8h1S…</a></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb0e8142224a4b3d998726c7bfecac32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=hMYrTL9aIgepbNietMJntPYejkE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>模块重构</strong></h2>
<h3 data-id="heading-10"><strong>分析并规划重构</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a38acf5942b948578c636054c1df6fe7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=SHj%2BiM7YijijumkImq44YMSQdkA%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b243bc6b1a74472a9b6a8a0b0650674f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=pREIpCB2EreCJD3a1Fjzqw%2FqygQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11"><strong>重构计划详情</strong></h3>
<pre><code class="hljs language-markdown" lang="markdown">
<span class="hljs-section"># Cloudreve 前端重构优化计划</span>

<span class="hljs-section">## 📊 项目现状分析</span>

<span class="hljs-section">### 技术栈概况</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**React 18.2.0 + TypeScript 5.2.2**</span> - 现代化技术栈
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Material-UI 6.x**</span> - 成熟的组件库
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Redux Toolkit**</span> - 现代状态管理
<span class="hljs-bullet">-</span> <span class="hljs-strong">**119个依赖包**</span> - 依赖较为复杂

<span class="hljs-section">### 主要问题识别</span>
<span class="hljs-bullet">1.</span> <span class="hljs-strong">**性能问题**</span>: Bundle过大、缺少虚拟化、不必要的重渲染
<span class="hljs-bullet">2.</span> <span class="hljs-strong">**代码质量**</span>: 75个文件使用any类型、组件职责不清、代码重复
<span class="hljs-bullet">3.</span> <span class="hljs-strong">**架构问题**</span>: 组件耦合度高、状态管理分散、缺少抽象层
<span class="hljs-bullet">4.</span> <span class="hljs-strong">**技术债务**</span>: 8个TODO标记、重复样式定义、错误处理不统一

<span class="hljs-section">## 🎯 重构优先级排序</span>

<span class="hljs-section">### 第一优先级：快速胜利项目（2-3周）</span>
<span class="hljs-strong">**风险：🟢低 | 收益：💰💰中高**</span>

<span class="hljs-bullet">1.</span> <span class="hljs-strong">**代码规范统一**</span>
<span class="hljs-bullet">   -</span> 统一TypeScript配置，消除any类型滥用
<span class="hljs-bullet">   -</span> 建立组件命名规范和文件组织标准
<span class="hljs-bullet">   -</span> 实施自动化代码格式化

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**国际化优化**</span>
<span class="hljs-bullet">   -</span> 优化10种语言的翻译文件结构
<span class="hljs-bullet">   -</span> 实施按需加载机制
<span class="hljs-bullet">   -</span> 统一翻译key命名规范

<span class="hljs-bullet">3.</span> <span class="hljs-strong">**工具函数抽取**</span>
<span class="hljs-bullet">   -</span> 创建统一的时间格式化、文件类型判断工具
<span class="hljs-bullet">   -</span> 抽取重复的API调用模式
<span class="hljs-bullet">   -</span> 建立公共Hook库

<span class="hljs-section">### 第二优先级：性能优化项目（3-4周）</span>
<span class="hljs-strong">**风险：🔴高 | 收益：💰💰💰高**</span>

<span class="hljs-bullet">1.</span> <span class="hljs-strong">**Bundle优化**</span>
<span class="hljs-bullet">   -</span> 实施精细化代码分割，预计减少35%包大小
<span class="hljs-bullet">   -</span> 优化Monaco Editor、Excalidraw等大型库的加载
<span class="hljs-bullet">   -</span> 实施懒加载和预加载策略

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**组件性能优化**</span>
<span class="hljs-bullet">   -</span> 为核心组件添加React.memo和useCallback
<span class="hljs-bullet">   -</span> 实施虚拟滚动解决长列表性能问题
<span class="hljs-bullet">   -</span> 优化文件缩略图加载机制

<span class="hljs-bullet">3.</span> <span class="hljs-strong">**运行时优化**</span>
<span class="hljs-bullet">   -</span> 修复内存泄漏问题
<span class="hljs-bullet">   -</span> 优化状态更新频率
<span class="hljs-bullet">   -</span> 实施智能缓存策略

<span class="hljs-section">### 第三优先级：架构重构项目（4-6周）</span>
<span class="hljs-strong">**风险：🔴高 | 收益：💰💰💰高**</span>

<span class="hljs-bullet">1.</span> <span class="hljs-strong">**组件架构重构**</span>
<span class="hljs-bullet">   -</span> 重构GridFile等大型组件（463行→拆分为多个小组件）
<span class="hljs-bullet">   -</span> 分离数据获取和UI渲染逻辑
<span class="hljs-bullet">   -</span> 建立统一的错误处理和加载状态管理

<span class="hljs-bullet">2.</span> <span class="hljs-strong">**状态管理优化**</span>
<span class="hljs-bullet">   -</span> 重构聊天系统的状态管理
<span class="hljs-bullet">   -</span> 统一Redux和本地状态的使用模式
<span class="hljs-bullet">   -</span> 实施状态机管理复杂状态转换

<span class="hljs-bullet">3.</span> <span class="hljs-strong">**依赖升级**</span>
<span class="hljs-bullet">   -</span> 分批升级核心依赖包
<span class="hljs-bullet">   -</span> 解决安全漏洞和兼容性问题
<span class="hljs-bullet">   -</span> 获得新版本特性支持

<span class="hljs-section">## 🚀 实施策略</span>

<span class="hljs-section">### 渐进式重构方案</span>
<span class="hljs-code">```
阶段一（2-3周）：基础优化
├── 代码规范统一
├── 国际化优化  
└── 技术债务清理

阶段二（3-4周）：性能优化
├── Bundle分割优化
├── 组件渲染优化
└── 缓存策略实施

阶段三（4-6周）：架构重构
├── 组件拆分重构
├── 状态管理统一
└── 依赖版本升级
```</span>

<span class="hljs-section">### 测试和质量保证</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**自动化测试**</span>: 核心组件90%+覆盖率
<span class="hljs-bullet">-</span> <span class="hljs-strong">**性能测试**</span>: FCP&lt;1.5s, LCP&lt;2.5s目标
<span class="hljs-bullet">-</span> <span class="hljs-strong">**回滚计划**</span>: 每阶段设置稳定版本标签
<span class="hljs-bullet">-</span> <span class="hljs-strong">**监控告警**</span>: 实时监控关键性能指标

<span class="hljs-section">## 📈 预期收益</span>

<span class="hljs-section">### 性能提升</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**加载速度**</span>: 提升50%
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Bundle大小**</span>: 减少35%
<span class="hljs-bullet">-</span> <span class="hljs-strong">**内存占用**</span>: 降低20-30%

<span class="hljs-section">### 开发效率</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**新功能开发**</span>: 速度提升40%
<span class="hljs-bullet">-</span> <span class="hljs-strong">**组件复用率**</span>: 提升60%
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Bug修复时间**</span>: 减少40%

<span class="hljs-section">### 代码质量</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**技术债务**</span>: 减少80%
<span class="hljs-bullet">-</span> <span class="hljs-strong">**测试覆盖率**</span>: 达到85%+
<span class="hljs-bullet">-</span> <span class="hljs-strong">**类型安全**</span>: 消除75个any类型使用

<span class="hljs-section">## ⚠️ 风险控制</span>

<span class="hljs-section">### 技术风险缓解</span>
<span class="hljs-bullet">-</span> 渐进式重构避免大爆炸式改动
<span class="hljs-bullet">-</span> 充分的自动化和手工测试
<span class="hljs-bullet">-</span> 灰度发布和实时监控

<span class="hljs-section">### 项目风险管理</span>
<span class="hljs-bullet">-</span> 每周进度和质量评审
<span class="hljs-bullet">-</span> 明确的里程碑和交付物
<span class="hljs-bullet">-</span> 备用方案和知识分享机制

<span class="hljs-section">## 💼 资源需求</span>

<span class="hljs-bullet">-</span> <span class="hljs-strong">**人力**</span>: 前端架构师1人 + 高级工程师2人 + 工程师1人
<span class="hljs-bullet">-</span> <span class="hljs-strong">**时间**</span>: 总计13-16周
<span class="hljs-bullet">-</span> <span class="hljs-strong">**工具**</span>: 自动化测试框架、性能监控工具、CI/CD流水线

这个重构计划通过科学的优先级排序和风险控制，确保在提升代码质量的同时保持项目稳定性，为长期的可维护性和开发效率奠定基础。
</code></pre>
<h3 data-id="heading-12"><strong>重构实施结果</strong></h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed106812a2e4451f9d7dde99b3110e86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=sDw3gqwosSQmuCv4rXsFLbn%2BSz0%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71621d638a9442a1966fa481eef3a3e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=VVWK46lP8jA0gEGh4hImskngD%2FY%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86e8de53d9894f608e9012012ad386eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=rhZVUNICSjbJfihDET%2F%2F1MEo0oc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35d3584594a34692a93ae213af2edbc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=EASH%2B%2BKH5eup8CL53NcMqxbLzf4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13"><strong>功能迭代</strong></h2>
<p>在完成项目理解和代码优化后，正式进入功能开发阶段。我计划为 Cloudreve 添加一个智能对话功能，让用户可以通过自然语言与云盘交互。</p>
<h3 data-id="heading-14"><strong>准备工作：接入 Context7 MCP</strong></h3>
<p>为了提高 AI 对 OpenRouter API 的理解和使用能力，我先接入了 Context7 MCP 服务。</p>
<p><strong>Context7 链接：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fcontext7.com%3Fq%3Dopenrouter" target="_blank" title="https://context7.com?q=openrouter" ref="nofollow noopener noreferrer">context7.com?q=openrouter</a></p>
<p><strong>MCP 配置：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"context7"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://mcp.context7.com/mcp"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/000fed0186eb4531a9b3d9163ff64b4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=Mv%2FmE1oZ5%2BUCsfbT4wbPVwRgFyM%3D" alt="" loading="lazy"/></p>
<p align="center">Context7 MCP 配置界面</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3b77040a0f34d24a8df19056abd0a76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=UWlKqSJvyujlMJH5mt4en%2Bxbk%2BM%3D" alt="" loading="lazy"/></p>
<p align="center">MCP 服务状态</p>
<h3 data-id="heading-15"><strong>第一阶段：基础对话功能</strong></h3>
<p><strong>需求规划</strong></p>
<p>打开 Plan，明确基础对话功能的核心需求。</p>
<p><strong>需求描述：</strong></p>
<pre><code class="hljs language-diff" lang="diff">需求：
给云盘加个 AI 对话功能，用户可以用自然语言跟 AI 聊天

后端 ：
<span class="hljs-deletion">- 新增流式对话接口并注册到路由中，需要身份鉴权</span>
<span class="hljs-deletion">- 集成 OpenRouter 调用模型</span>

前端 ：
<span class="hljs-deletion">- 右下角加个圆形悬浮按钮</span>
<span class="hljs-deletion">- 点击弹出 600px 宽的侧边栏对话面板</span>
<span class="hljs-deletion">- 基本的聊天界面：消息列表 + 输入框</span>
<span class="hljs-deletion">- 调用流式对话接口时，处理好鉴权参数、流式输出状态</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c4fdfa41fc948a4a2e85d39fd4b9e43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=0b6PtVj9WiV3hroEpAZe8gWNiTQ%3D" alt="" loading="lazy"/></p>
<p>Coder 会自动调用内置的 Search Agent 分析项目结构，理解代码上下文：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/531d8d6529fc4849ba172c8ff5cde9fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=1PFGSyJ9ptLPanIxbTGwP7MASC8%3D" alt="" loading="lazy"/></p>
<p align="center">Search Agent 工作过程</p>
<p>分析完成后，Coder 将技术方案以文档形式呈现，支持实时修改和编辑：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0969b63c5ad471e9681b69689819455~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=rYrZaNhWCV%2Ftf7RnQZR8bsPEvuY%3D" alt="" loading="lazy"/></p>
<p align="center">技术方案文档</p>
<h4 data-id="heading-16"><strong>任务执行</strong></h4>
<p>确认方案后，Coder 会根据技术规划自动拆解任务并分步执行</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0bc4e5bed4644204837f2389623260cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=0aCkB8F%2BsDVjpnM2CaKZ0%2FXNz7A%3D" alt="" loading="lazy"/></p>
<p align="center">任务拆解列表</p>
<p>在实施过程中，可以实时看到每个步骤的状态更新：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e973700b38df4cfabbcacb23665b6e40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=CubWtnj1VSsDyRphP%2BxgppbOpDY%3D" alt="" loading="lazy"/></p>
<p align="center">实施进度追踪</p>
<p>开发完成后，Coder 会自动启动项目进行预览验证：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6c3c56fc76347d78e450509f1e164ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=YW7Vw2onWpJ6qZgpYpz%2BaCF1KTs%3D" alt="" loading="lazy"/></p>
<p align="center">自动启动预览</p>
<p><strong>实现效果：</strong></p>
<p>对话功能已经成功实现，UI 风格与 Cloudreve 原生界面保持高度一致：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ceb9310336146a79dc16ac837dc6a4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=8I20e%2Fj9tKqXqbTBNe56DqVkAPM%3D" alt="" loading="lazy"/></p>
<p align="center">对话功能界面</p>
<h3 data-id="heading-17"><strong>第二阶段：增量迭代，增加多模态召回</strong></h3>
<p>基础对话功能完成后，我进一步提出了更高级的需求：让 AI 能够理解和检索云盘中的文件内容。</p>
<p><strong>增强需求</strong></p>
<p><strong>需求描述：</strong></p>
<pre><code class="hljs language-diff" lang="diff">需求：
AI 聊天支持多模态文件智能检索

后端：
<span class="hljs-deletion">- 流式对话接口中读取全量云盘文内容作为上下文提供给模型，模型通过文件元信息及多模态内容进行文件召回</span>
<span class="hljs-deletion">- 返回：summary + file list 的结构，前端渲染为文本 + GUI 列表</span>
<span class="hljs-deletion">- 问"帮我找包含小狗的图片"这类问题时，能够召回文件元信息或文件内容与用户意图相关的文件</span>

前端：
<span class="hljs-deletion">- 消息中展示文件列表</span>
<span class="hljs-deletion">- 3 列网格布局，显示缩略图、文件名</span>
</code></pre>
<p><strong>实现效果</strong></p>
<p>Coder 会自动启动前后端服务，并通过终端进行功能测试：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/806ec905e34e4d118e7a6ca2b7a247b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=Ir0CL9WSmCDnmy2mWPPu7WT5jgs%3D" alt="" loading="lazy"/></p>
<p align="center">功能测试过程</p>
<p><strong>最终效果：</strong></p>
<p>系统成功实现了文件内容识别和智能召回功能。当用户询问"帮我找包含小狗的图片"时，AI 能够准确识别图片内容并返回相关文件：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d018f95c7f24fe78a42f3f539caf686~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=mXFmRh%2F8fbZoot3avhyHlDb5jrs%3D" alt="" loading="lazy"/></p>
<p align="center">文件召回效果展示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/581c966bbfde4d35b71c95b4ceabcb1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764039376&amp;x-signature=xz9gTKrb1g%2BuhEQ7lJ9mSmvTFBc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-18"><strong>总结与思考</strong></h2>
<p>通过这次实践，可以看到 SOLO Coder 在项目理解、代码重构到功能开发的每个环节都可以提供支持。这个项目未来还可以进一步探索的有：更复杂的多模态交互场景、智能文件管理和推荐和基于用户行为的个性化体验，欢迎大家去创造体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day 12：09. 基于Nuxt开发博客项目-使用NuxtContent构建博客模块]]></title>    <link>https://juejin.cn/post/7573776814927446035</link>    <guid>https://juejin.cn/post/7573776814927446035</guid>    <pubDate>2025-11-18T03:30:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573776814927446035" data-draft-id="7573631442312609798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day 12：09. 基于Nuxt开发博客项目-使用NuxtContent构建博客模块"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-18T03:30:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申阳"/> <meta itemprop="url" content="https://juejin.cn/user/4353721775165486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day 12：09. 基于Nuxt开发博客项目-使用NuxtContent构建博客模块
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721775165486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T03:30:51.000Z" title="Tue Nov 18 2025 03:30:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.hljs-comment,.hljs-quote,.hljs-variable{color:green}.hljs-built_in,.hljs-keyword,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#00f}.hljs-addition,.hljs-attribute,.hljs-literal,.hljs-section,.hljs-string,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type{color:#a31515}.hljs-deletion,.hljs-meta,.hljs-selector-attr,.hljs-selector-pseudo{color:#2b91af}.hljs-doctag{color:grey}.hljs-attr{color:red}.hljs-bullet,.hljs-link,.hljs-symbol{color:#00b0e8}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df86e40dd69f4632aa6fba29585aa97d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=hlKOs9cGdzZA2mWGMfDpYXHJyow%3D" alt="PixPin_2025-11-18_11-05-26.gif" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p>用官网的介绍来说，这其实是专为<code>Nuxt</code>开发人员设计的一款强大的基于文件系统的<code>CMS</code> 系统。官方文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcontent.nuxt.com%2F%25EF%25BC%258C" target="_blank" title="https://content.nuxt.com/%EF%BC%8C" ref="nofollow noopener noreferrer">content.nuxt.com/，</a> 这是一个比较新的版本，我暂时没有找到比较好的中文翻译站点，我建议大家直接看官网原文档，避免因为版本不同而踩坑。</p>
<h2 data-id="heading-1">二、页面布局设计</h2>
<p>这里我参考了一些博客站点的设计，我希望左边是一个合集的展示，点击专栏，右侧显示出具体的文章列表，点击文章后进入详细内容查看页面。大概得示意图如下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ccd1e5bb7bb4cf0a69ea8dd71991bbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=IdkxqcHBZeh4KJZzTqrhE6Svoc0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">三、整合 NuxtContent</h2>
<h3 data-id="heading-3">1. 安装模块</h3>
<pre><code class="hljs language-bash" lang="bash">npx nuxt module add content
</code></pre>
<blockquote>
<p>不出意外的话，你应该会碰到以下报错</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/593829820eb84d31bde4b711840ac596~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=9ooJIyauHnPpiHfBd3LUTTkRC8s%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>不要慌，首先我是完全按照官方文档进行操作的，如果有问题，肯定会有人反馈，所以第一时间我就去<code>github</code>的 <code>issues</code> 里翻了一下，果不其然，有很多人都反馈了这个问题，感兴趣的自己去了解一下。这里我给出直达链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnuxt%2Fcontent%2Fissues%3Fq%3DCould%2520not%2520locate%2520the%2520bindings%2520file%25EF%25BC%258C%25E6%259C%2580%25E7%25BB%2588%25E5%25BE%2597%25E5%2587%25BA%25E7%259A%2584%25E7%25BB%2593%25E8%25AE%25BA%25E6%2598%25AF" target="_blank" title="https://github.com/nuxt/content/issues?q=Could%20not%20locate%20the%20bindings%20file%EF%BC%8C%E6%9C%80%E7%BB%88%E5%BE%97%E5%87%BA%E7%9A%84%E7%BB%93%E8%AE%BA%E6%98%AF" ref="nofollow noopener noreferrer">github.com/nuxt/conten…</a> <code>node</code> 版本过高，在 <code>pnpm@10</code> 之后有一些破坏性的更新。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffb00d567622427ab42a07d60d286184~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=gGY5Z%2FX8TNd1Uq%2BCwEP4PKyJ1GQ%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>重新安装一下一来 <code>pnpm i</code>，我发现了这个</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b812468c433d434883cab1da321bdd5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=2B85YMmsyIYEwzGLQ5sK6q%2F3gjI%3D" alt="image.png" loading="lazy"/></p>
<p>根据提示，我尝试了一下执行<code>pnpm approve-builds</code>, 并且勾选上以下依赖</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63da803f46c745bc8a1c1b9c53a6a1e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=Vl4Ot2LinkEkYyp7Hi%2FNmp8Azn4%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>报错，安装不成功</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/851c020d46924ae4bc1635ed0b023e9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=VrLodekcEFhp6fkxrhmFsY%2B62uM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b88fe256d4e495eb781a518a1993fab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=DJjtUEkI5wyUUSlcIBwAfp6GVYQ%3D" alt="image.png" loading="lazy"/>
大致意思是说，它需要依赖我本地的 <code>Visual Studio</code> 来进行编译，还和 <code>c++</code>有点关系，说巧不巧，我前几天刚把这玩意卸载了，之前学习<code>c#</code>的时候装过。我肯定不会再装回去了，这有点反直觉了，难道我用这个还得为你装个本地的编译器嘛。<strong>我都懒得去试这个解决方案，我觉得很不合理。</strong></p>
<blockquote>
<p>我又去官网扫了一遍 , 搜了一下关键词 <code>better-sqlite3</code></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30767b105a4741f98cb6a8904c6e0468~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=w%2FCsckh5Na0IuEQ9cvnQS%2FtZqlk%3D" alt="image.png" loading="lazy"/></p>
<p>非常好，<code>install</code> 的时候官方这里有提示</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a09ec99768c4bafb50fe096f88849ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=cS%2FCIEAjhQzu3c150Uqp5EL5nXg%3D" alt="image.png" loading="lazy"/></p>
<p>修改配置</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40131dec09264d57b4ad0f14d72a5960~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=dzJkmxuGSv34n%2FZgR%2BdO7%2FvYuMw%3D" alt="image.png" loading="lazy"/></p>
<p>重新启动项目，运行成功。</p>
<p><strong>问题解决。</strong></p>
<p>将刚刚执行 <code>pnpm approve-builds</code> 造成的影响还原</p>
<ul>
<li>删除生成的 <code>pnpm-workspace.yaml</code> 文件</li>
<li>卸载 <code>sqlite3</code> 相关依赖</li>
</ul>
<blockquote>
<p><strong>反省，看文档还是不够仔细啊！</strong>
耽误了一些时间，不过我觉得这个排查步骤还是比较有意义的，所以花了大量篇幅记录下来了，希望对看我博客的你能有所帮助。</p>
</blockquote>
<h3 data-id="heading-4">2. 组织我们的文件结构</h3>
<h4 data-id="heading-5">1. 页面结构</h4>
<pre><code class="hljs language-ini" lang="ini">pages                
├─ blog              
│  ├─ index.vue      <span class="hljs-comment"># 默认加载页面</span>
│  └─ <span class="hljs-section">[...slug]</span>.vue  <span class="hljs-comment"># 动态详情页</span>
├─ about.vue         
├─ index.vue         
└─ tools.vue         
</code></pre>
<h4 data-id="heading-6">2. 文档结构 (没有 content 目录自己新建一个)</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">content</span>           
└─ blog           
   └─ v2h         
      ├─ day1<span class="hljs-selector-class">.md</span>  
      └─ day2<span class="hljs-selector-class">.md</span>  
</code></pre>
<blockquote>
<p>这里简单解释一下，<code>blog</code> 是一个合集，表示这里存放的是所有博客文章，<code>v2h</code> 意思是 <code>value 2 hours</code> 每天两小时这个专栏的意思，<code>day1.md</code> 则表示专栏下的文章。</p>
</blockquote>
<h3 data-id="heading-7">3. 读取文件内容</h3>
<p>接下来就是将我们的博客文章，读取到页面中。</p>
<p>首先我们需要定义一个配置文件，告知<code>blog</code>目录，作为合集配置</p>
<h4 data-id="heading-8">1. 新建 content.config.ts</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineCollection, defineContentConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nuxt/content'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineContentConfig</span>({
    <span class="hljs-attr">collections</span>: {
        <span class="hljs-attr">blog</span>: <span class="hljs-title function_">defineCollection</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'page'</span>,
            <span class="hljs-attr">source</span>: <span class="hljs-string">'blog/**/*.md'</span>,

        })
    }
})
</code></pre>
<h4 data-id="heading-9">2. 测试一下<code>api</code></h4>
<p>新建一些文档，目录结构如下</p>
<pre><code class="hljs language-bash" lang="bash">content           
└─ blog           
   ├─ miniapp      <span class="hljs-comment"># 小程序专栏</span>
   │  └─ aaa.md   
   └─ v2h         <span class="hljs-comment"># 每天两小时专栏合集</span>
      ├─ day1.md  
      └─ day2.md  
</code></pre>
<p>在 <code>blog/index.vue</code>中读取文件导航信息。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">useAsyncData</span>(<span class="hljs-string">'navigation'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryCollectionNavigation</span>(<span class="hljs-string">'blog'</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>博客<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- &lt;div&gt;{{ allPosts }}&lt;/div&gt; --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{{ data }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>查看输出内容</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Blog"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/blog"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"stem"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"blog"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Miniapp"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/blog/miniapp"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"stem"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"blog/miniapp"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                    <span class="hljs-punctuation">{</span>
                        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Aaa"</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/blog/miniapp/aaa"</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-attr">"stem"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"blog/miniapp/aaa"</span>
                    <span class="hljs-punctuation">}</span>
                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"page"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"V2h"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/blog/v2h"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"stem"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"blog/v2h"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                    <span class="hljs-punctuation">{</span>
                        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Day1"</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/blog/v2h/day1"</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-attr">"stem"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"blog/v2h/day1"</span>
                    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
                    <span class="hljs-punctuation">{</span>
                        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Day2"</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/blog/v2h/day2"</span><span class="hljs-punctuation">,</span>
                        <span class="hljs-attr">"stem"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"blog/v2h/day2"</span>
                    <span class="hljs-punctuation">}</span>
                <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"page"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
            <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"page"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<blockquote>
<p>返回了整个文档结构。有了这个我么就可以轻松的组织好左侧的目录结构了。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/456089a3676644e4ba7620777cd7ff04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=38xCgzfuN%2BEy9EdSbMXfuhIjlQU%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">useAsyncData</span>(<span class="hljs-string">'navigation'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryCollectionNavigation</span>(<span class="hljs-string">'blog'</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"full-height-container grid grid-cols-5 gap-6 p-6"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 左侧导航栏 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-span-1 bg-white rounded-xl shadow-lg overflow-hidden flex flex-col"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"p-4 border-b border-gray-100"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-lg font-semibold text-gray-800"</span>&gt;</span>博客专栏<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"menu menu-lg rounded-box w-full h-full"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"columns in data![0]!.children"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">details</span> <span class="hljs-attr">open</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">summary</span>&gt;</span>{{ columns.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">summary</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"article in columns.children"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>{{ article.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">details</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 右侧内容区 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-span-4 bg-white rounded-xl shadow-lg flex flex-col overflow-hidden"</span>&gt;</span>{{ data }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

</code></pre>
<blockquote>
<p>完善两点，基本上就成型了。</p>
<ol>
<li>点击一级菜单的时候右侧分页展示专栏下所有文章列表</li>
<li>点击子集菜单，直接进入文章详情</li>
</ol>
</blockquote>
<h2 data-id="heading-10">四、最终成果展示</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df86e40dd69f4632aa6fba29585aa97d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=hlKOs9cGdzZA2mWGMfDpYXHJyow%3D" alt="PixPin_2025-11-18_11-05-26.gif" loading="lazy"/>
示例代码：</p>
<p><code>blog/index.vue</code></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">ContentNavigationItem</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nuxt/content'</span>

<span class="hljs-keyword">const</span> currentPage = ref&lt;<span class="hljs-title class_">ContentNavigationItem</span>[]&gt;([])
<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()
<span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">useAsyncData</span>(<span class="hljs-string">'navigation'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryCollectionNavigation</span>(<span class="hljs-string">'blog'</span>, [<span class="hljs-string">'description'</span>])
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleColumnsClick</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">title: string</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!data.<span class="hljs-property">value</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">children</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'No navigation data found'</span>)
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-comment">// 过滤匹配的项</span>
  <span class="hljs-keyword">const</span> filteredItems = data.<span class="hljs-property">value</span>[<span class="hljs-number">0</span>].<span class="hljs-property">children</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">title</span> === title)
  <span class="hljs-keyword">if</span> (!filteredItems?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">children</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'No Content data found'</span>)
    <span class="hljs-keyword">return</span>
  }
  currentPage.<span class="hljs-property">value</span> = filteredItems[<span class="hljs-number">0</span>]?.<span class="hljs-property">children</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleArticleClick</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">path: string</span>) =&gt; {
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">navigateTo</span>(path)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"full-height-container grid grid-cols-5 p-6"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 左侧导航栏 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-span-1 bg-white rounded-xl shadow-lg overflow-hidden flex flex-col"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"p-4 border-b border-gray-100"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-lg font-semibold text-gray-800"</span>&gt;</span>博客专栏<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"menu menu-lg rounded-box w-full h-full"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"columns in data![0]!.children"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">details</span> <span class="hljs-attr">open</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">summary</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleColumnsClick(columns.title)"</span>&gt;</span>{{ columns.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">summary</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"before:w-px"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"article in columns.children"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleArticleClick(article.path)"</span>&gt;</span>{{ article.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">details</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 右侧内容区 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"col-span-4 flex flex-col gap-4 px-20"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in currentPage"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.path"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">NuxtLink</span> <span class="hljs-attr">:to</span>=<span class="hljs-string">"item.path"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card card-side bg-base-100 shadow-sm px-2"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">figure</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-40 h-20"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/images/image-20251031133400797.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">" "</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">figure</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-body"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-title"</span>&gt;</span>{{ item.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ item.description }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">NuxtLink</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

</code></pre>
<p><code>blog/[...slug].vue</code></p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
const route = useRoute()
const { data: post } = await useAsyncData(route.path, () =&gt; {
  return queryCollection('blog').path(route.path).first()
})
&lt;/script&gt;
&lt;template&gt;
  &lt;div class="h-screen"&gt;&lt;ContentRenderer v-if="post" :value="post" /&gt;&lt;/div&gt;
&lt;/template&gt;
&lt;style scoped lang="scss"&gt;&lt;/style&gt;

</code></pre>
<h2 data-id="heading-11">五、总结</h2>
<p>到这里基本结构算是定下来了，后续就是内容的填充，以及观感上的优化了。</p>
<p>当然这并不是我们最终的目标，最终会集成后台管理系统，完成一套真正的 <code>CMS</code> 发布系统。所以如果你觉得麻烦，或者对于 <code>NuxtContent</code>并不感兴趣，完全可以忽略这一节内容。</p>
<blockquote>
<p>在进行样式调整的时候，我发现了一个<code>bug</code>，<strong>inspira-ui</strong> 和 <strong>daisyui</strong> 的样式表变量存在命名冲突。</p>
<p>比如：<strong>inspira-ui</strong> 定义 <code> --border: oklch(0.922 0 0);</code> 是颜色属性，而 <strong>daisyui</strong> 定义的是宽度属性 <code>--border: 1px;</code></p>
<p>导致属性值覆盖，这肯定不是个例，暂时记录一下，后续再考虑怎么解决。</p>
<p>目前会导致  <strong>daisyui</strong> 的菜单左边没有竖线</p>
<p>我目前的解决方案是直接在标签覆盖回去</p>
<p><code>&lt;ul class="before:w-px"&gt;</code></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e87041c758194a9a9bb8256570492027~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764041451&amp;x-signature=qDeiaaxUlGaEn7fJRMV3T2m6KsE%3D" alt="image.png" loading="lazy"/></p>
<p><strong>千里之行，始于足下。你的“个人公司”从这第一个2小时开始。欢迎在评论区分享你的进展或遇到的卡点，我会逐一查看，尽可能的帮助解决。我们下一篇文章见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（130）Redis的压缩列表（Ziplist）是如何实现的？]]></title>    <link>https://juejin.cn/post/7573519273030664238</link>    <guid>https://juejin.cn/post/7573519273030664238</guid>    <pubDate>2025-11-17T23:02:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573519273030664238" data-draft-id="7573528564026556462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（130）Redis的压缩列表（Ziplist）是如何实现的？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-17T23:02:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（130）Redis的压缩列表（Ziplist）是如何实现的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T23:02:08.000Z" title="Mon Nov 17 2025 23:02:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>压缩列表（Ziplist）是Redis中一种紧凑型的数据结构，用于存储小量的字符串或整数。它的设计初衷是为了节省内存，尤其适用于存储短小数据的场景，如列表或哈希表中的少量元素。Ziplist通过连续的内存块存储数据，并使用一种紧凑的编码方式来表示字符串和整数，从而减少内存占用。</p>
<h3 data-id="heading-0">主要结构</h3>
<p>Ziplist的结构可以分为三部分：表头、数据项和表尾。</p>
<ol>
<li><strong>表头</strong>：包含两个字段：<code>zlbytes</code>和<code>zltail</code>。
<ul>
<li><code>zlbytes</code>：整个压缩列表所占的字节数。</li>
<li><code>zltail</code>：到压缩列表尾部的偏移量。</li>
<li><code>zllen</code>：压缩列表包含的节点数。</li>
</ul>
</li>
<li><strong>数据项</strong>：每个数据项都有三部分：前置节点长度、编码方式和实际数据。</li>
<li><strong>表尾</strong>：用一个字节<code>0xFF</code>标识压缩列表的结束。</li>
</ol>
<h4 data-id="heading-1">压缩列表的完整结构</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/*  
 * |&lt;zlbytes&gt;|&lt;zltail&gt;|&lt;zllen&gt;|&lt;entry&gt;...|&lt;entry&gt;|&lt;zlend&gt;|
 */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ziplist</span> {</span>
    <span class="hljs-type">uint32_t</span> zlbytes;  <span class="hljs-comment">// 压缩列表所占用的总字节数</span>
    <span class="hljs-type">uint32_t</span> zltail;   <span class="hljs-comment">// 到压缩列表尾部的偏移量</span>
    <span class="hljs-type">uint16_t</span> zllen;    <span class="hljs-comment">// 压缩列表包含的节点数</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> entries[]; <span class="hljs-comment">// 压缩列表的实际数据部分</span>
} ziplist;
</code></pre>
<h3 data-id="heading-2">数据项的结构</h3>
<p>每个数据项由以下部分组成：</p>
<ol>
<li><strong>前置节点长度（PrevEntryLength）</strong>：表示前一个节点的长度。</li>
<li><strong>编码方式（Encoding）</strong>：表示当前节点的类型和编码方式。</li>
<li><strong>实际数据（Content）</strong>：当前节点的实际数据。</li>
</ol>
<h4 data-id="heading-3">数据项的结构定义</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ziplistEntry</span> {</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> prevrawlen;  <span class="hljs-comment">// 前一个节点的长度</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> encoding;    <span class="hljs-comment">// 当前节点的数据类型和编码方式</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *p;         <span class="hljs-comment">// 指向实际数据的指针</span>
} ziplistEntry;
</code></pre>
<h3 data-id="heading-4">主要操作</h3>
<h4 data-id="heading-5">1. 压缩列表的创建</h4>
<p>创建一个新的压缩列表，并初始化其头部和尾部。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">ziplistNew</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bytes = ZIPLIST_HEADER_SIZE+<span class="hljs-number">1</span>; <span class="hljs-comment">// 头部 + 尾部</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *zl = zmalloc(bytes);

    ZIPLIST_BYTES(zl) = intrev32ifbe(bytes);  <span class="hljs-comment">// 设置 zlbytes</span>
    ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(ZIPLIST_HEADER_SIZE);  <span class="hljs-comment">// 设置 zltail</span>
    ZIPLIST_LENGTH(zl) = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 设置 zllen</span>
    zl[bytes<span class="hljs-number">-1</span>] = ZIP_END;  <span class="hljs-comment">// 设置 zlend</span>

    <span class="hljs-keyword">return</span> zl;
}
</code></pre>
<h4 data-id="heading-6">2. 插入操作</h4>
<p>插入一个新的数据项到压缩列表中。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">ziplistInsert</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *zl, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *p, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *s, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> slen)</span> {
    <span class="hljs-type">size_t</span> curlen = intrev32ifbe(ZIPLIST_BYTES(zl));
    <span class="hljs-type">size_t</span> reqlen;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> encoding = <span class="hljs-number">0</span>;
    <span class="hljs-type">long</span> <span class="hljs-type">long</span> value;

    <span class="hljs-comment">// 计算插入数据所需的空间</span>
    <span class="hljs-keyword">if</span> (zipTryEncoding(s, slen, &amp;value, &amp;encoding)) {
        reqlen = zipIntSize(encoding);
    } <span class="hljs-keyword">else</span> {
        reqlen = slen;
    }

    <span class="hljs-comment">// 计算新节点的总长度</span>
    reqlen += zipStorePrevEntryLength(<span class="hljs-literal">NULL</span>, curlen);
    reqlen += zipStoreEntryEncoding(<span class="hljs-literal">NULL</span>, encoding, slen);

    zl = zrealloc(zl, curlen + reqlen);
    p = zl + (p - zl);

    <span class="hljs-comment">// 更新头部信息</span>
    memmove(p + reqlen, p, curlen - (p - zl));
    zipStorePrevEntryLength(p, curlen);
    p += zipStoreEntryEncoding(p, encoding, slen);
    
    <span class="hljs-keyword">if</span> (encoding == ZIP_INT_8B) {
        p[<span class="hljs-number">0</span>] = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>)value;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (encoding == ZIP_INT_16B) {
        <span class="hljs-type">int16_t</span> i16 = (<span class="hljs-type">int16_t</span>)value;
        <span class="hljs-built_in">memcpy</span>(p, &amp;i16, <span class="hljs-keyword">sizeof</span>(i16));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (encoding == ZIP_INT_32B) {
        <span class="hljs-type">int32_t</span> i32 = (<span class="hljs-type">int32_t</span>)value;
        <span class="hljs-built_in">memcpy</span>(p, &amp;i32, <span class="hljs-keyword">sizeof</span>(i32));
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (encoding == ZIP_INT_64B) {
        <span class="hljs-type">int64_t</span> i64 = (<span class="hljs-type">int64_t</span>)value;
        <span class="hljs-built_in">memcpy</span>(p, &amp;i64, <span class="hljs-keyword">sizeof</span>(i64));
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">memcpy</span>(p, s, slen);
    }

    ZIPLIST_BYTES(zl) = intrev32ifbe(curlen + reqlen);
    ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(curlen + reqlen - (p - zl));
    ZIPLIST_LENGTH(zl) = intrev16ifbe(intrev16ifbe(ZIPLIST_LENGTH(zl)) + <span class="hljs-number">1</span>);

    <span class="hljs-keyword">return</span> zl;
}
</code></pre>
<h4 data-id="heading-7">3. 删除操作</h4>
<p>从压缩列表中删除一个数据项。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *<span class="hljs-title function_">ziplistDelete</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *zl, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> **p)</span> {
    <span class="hljs-type">size_t</span> curlen = intrev32ifbe(ZIPLIST_BYTES(zl));
    <span class="hljs-type">size_t</span> reqlen = zipRawEntryLength(*p);
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *ptr = *p;
    <span class="hljs-type">size_t</span> offset = ptr - zl;

    <span class="hljs-comment">// 删除节点</span>
    memmove(ptr, ptr+reqlen, curlen-(offset+reqlen));
    zl = zrealloc(zl, curlen-reqlen);

    <span class="hljs-comment">// 更新头部信息</span>
    ZIPLIST_BYTES(zl) = intrev32ifbe(curlen-reqlen);
    ZIPLIST_TAIL_OFFSET(zl) = intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))-reqlen);
    ZIPLIST_LENGTH(zl) = intrev16ifbe(intrev16ifbe(ZIPLIST_LENGTH(zl))<span class="hljs-number">-1</span>);

    <span class="hljs-keyword">return</span> zl;
}
</code></pre>
<h3 data-id="heading-8">辅助函数</h3>
<h4 data-id="heading-9">编码和存储长度</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">zipStorePrevEntryLength</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *p, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len)</span> {
    <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">return</span> (len &lt; ZIP_BIG_PREVLEN) ? <span class="hljs-number">1</span> : <span class="hljs-number">5</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (len &lt; ZIP_BIG_PREVLEN) {
            p[<span class="hljs-number">0</span>] = len;
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        } <span class="hljs-keyword">else</span> {
            p[<span class="hljs-number">0</span>] = ZIP_BIG_PREVLEN;
            <span class="hljs-built_in">memcpy</span>(p+<span class="hljs-number">1</span>, &amp;len, <span class="hljs-keyword">sizeof</span>(len));
            <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;
        }
    }
}

<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">zipStoreEntryEncoding</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *p, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> encoding, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> rawlen)</span> {
    <span class="hljs-keyword">if</span> (p == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">if</span> (ZIP_IS_STR(encoding)) {
            <span class="hljs-keyword">if</span> (rawlen &lt;= <span class="hljs-number">0x3f</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rawlen &lt;= <span class="hljs-number">0x3fff</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (ZIP_IS_STR(encoding)) {
            <span class="hljs-keyword">if</span> (rawlen &lt;= <span class="hljs-number">0x3f</span>) {
                p[<span class="hljs-number">0</span>] = ZIP_STR_06B | rawlen;
                <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (rawlen &lt;= <span class="hljs-number">0x3fff</span>) {
                p[<span class="hljs-number">0</span>] = ZIP_STR_14B | ((rawlen &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0x3f</span>);
                p[<span class="hljs-number">1</span>] = rawlen &amp; <span class="hljs-number">0xff</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;
            } <span class="hljs-keyword">else</span> {
                p[<span class="hljs-number">0</span>] = ZIP_STR_32B;
                <span class="hljs-built_in">memcpy</span>(p+<span class="hljs-number">1</span>, &amp;rawlen, <span class="hljs-keyword">sizeof</span>(rawlen));
                <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;
            }
        } <span class="hljs-keyword">else</span> {
            p[<span class="hljs-number">0</span>] = encoding;
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-10">示例使用</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *zl = ziplistNew();
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *p;

    <span class="hljs-comment">// 插入数据项</span>
    zl = ziplistInsert(zl, zl + ZIPLIST_HEADER_SIZE, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)<span class="hljs-string">"hello"</span>, <span class="hljs-number">5</span>);
    zl = ziplistInsert(zl, zl + ZIPLIST_HEADER_SIZE, (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)<span class="hljs-string">"world"</span>, <span class="hljs-number">5</span>);

    p = zl + ZIPLIST_HEADER_SIZE;
    <span class="hljs-keyword">while</span> (*p != ZIP_END) {
        <span class="hljs-comment">// 访问数据项</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\n"</span>, p + <span class="hljs-number">1</span>); <span class="hljs-comment">// 打印数据项内容</span>
        p += zipRawEntryLength(p);
    }

    <span class="hljs-comment">// 删除数据项</span>
    zl = ziplistDelete(zl, &amp;p);

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>总结：压缩列表（ziplist）通过紧凑的内存布局和灵活的编码方式实现了高效的内存利用。它适用于存储短小数据的场景，通过精心设计的数据结构，保证了高效的插入、删除和查找操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 Hologres 构建智能驾驶图像高性能分析系统]]></title>    <link>https://juejin.cn/post/7573708620870975540</link>    <guid>https://juejin.cn/post/7573708620870975540</guid>    <pubDate>2025-11-18T10:16:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7573708620870975540" data-draft-id="7573679820632342563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 Hologres 构建智能驾驶图像高性能分析系统"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2025-11-18T10:16:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 Hologres 构建智能驾驶图像高性能分析系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-18T10:16:35.000Z" title="Tue Nov 18 2025 10:16:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-18
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着人工智能技术的深入发展，企业对数据的利用已不再局限于传统的结构化数据分析。越来越多的行业开始依赖多模态数据进行智能决策，涵盖商品推荐、驾驶行为分析、金融风控、教育个性化等多个场景。这些场景普遍具备一个共同特征：<strong>数据形态多样、分析需求复杂、检索方式多元</strong>。Hologres 4.0的整体架构围绕“多模态分析检索 all-in-one”设计，实现“一份数据、一份计算、多模分析”的一站式目标，一条SQL即可完成从数据接入、AI加工到多模查询的全流程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/954b03bd631747bc9ecdbc804bc7276b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065957&amp;x-signature=UXzee7usV9IDcPSda96iKERLGV8%3D" alt="image.png" loading="lazy"/></p>
<p>智能驾驶场景中，可以看到采集的车机各种信号数据，以大宽表的形式存储在数据库中。这些信号数据通常会包含结构化数据（车辆状态、车机版本等）、半结构化数据（车机信号）、非结构化数据（轨迹照片等）。在业务应用的时候，要进行点查、OLAP分析、全文检索、向量检索、混合检索等多种场景。</p>
<p>传统架构往往依赖多个独立引擎协同工作，导致系统复杂、成本高昂、数据不一致等问题频发。AI时代的应用需要在一个统一平台上完成OLAP分析、点查服务、全文检索、向量搜索以及AI推理等多种能力的融合使用。本文以自动驾驶图像数据集为例，介绍Hologres如何在传统的结构化分析的基础上，完成文搜图、图搜图等多模态分析场景。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51e2915b7deb45cea3632a5a2ee92aea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065957&amp;x-signature=gavDrk9mOWaDApHcEgrFfrQ12UA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>基于Hologres构建自动驾驶图像高性能分析系统</strong></h2>
<p>在自动驾驶系统中，车辆图片分析是环境感知模块的核心场景之一，主要用于实时解析车辆内外部摄像头捕捉的视觉信息，以实现对周围环境的精准理解与决策。本文以BDD自动驾驶数据集为例模拟自动驾驶场景，模拟真实驾驶场景，采集10万张包括驾驶区域、地理、环境、天气多样性等数据的图片，通过对图片的分析与检索，进行了行驶轨迹分析、环境感知优化及行人车辆识别精度提升等全栈技术验证，提升系统对复杂交通场景的适应能力、安全性和用户体验。</p>
<p>基于Hologres构建自动驾驶图像高性能分析系统包含的主要能力如下：</p>
<ul>
<li>非结构化数据（Object Table）：支持通过表的形式读取OSS中非结构化数据（PDF、IMAGE、PPT等）。</li>
<li>AI Function：在Hologres中可以用标准SQL的方式调用Function，自动调用内置大模型，完成AI服务建设场景。
<ul>
<li>数据加工：提供Embed、Chunk算子，可以对非结构化数据加工成结构化数据存储，无需使用外部算法就能自动Embed。</li>
<li>数据检索和分析：提供ai_gen、ai_summarize等算子，使用SQL就能对数据进行推理、问题总结以及翻译等能力。</li>
</ul>
</li>
<li>Dynamic Table介绍：支持增量刷新模式对非结构化数据自动加工，每次只计算增量的数据有效减少重复计算，降低资源利用率。</li>
<li>向量检索：支持标准SQL的向量检索，用于非结构化数据的相似度搜索、场景识别等，在同一个查询中可以自由地实现向量和标量的检索。</li>
<li>全文检索：通过倒排索引、分词等机制实现对非结构化数据的高效检索，支持关键词匹配、短语检索等丰富的检索方式，实现更加灵活的检索。</li>
</ul>
<h2 data-id="heading-1"><strong>方案优势</strong></h2>
<p>通过如上核心能力，在Hologres中对图片检索的核心优势如下：</p>
<ul>
<li><strong>完整的<strong><strong>AI</strong></strong>数据处理流程</strong>：涵盖从数据Embed、Chunk、增量加工和检索/分析的全流程，与使用大数据系统一样轻松构建AI应用。</li>
<li><strong>标准<strong><strong>SQL</strong></strong>加工图片数据</strong>：无需使用专用开发语言，<strong>纯SQL</strong>就能完成图片数据提取、加工。</li>
<li><strong>一个平台支持跨模态检索</strong>：支持以文搜图、以图搜图，语义理解突破关键词局限，在Hologres就能实现跨模态检索。</li>
<li><strong>检索更精准、灵活和智能</strong>：可以轻松构建“关键词+语义+多模态”的混合检索链路，覆盖从精准搜索到意图理解的全场景需求。还能结合AI Function实现对用户意图的深度理解，语义关联和上下文推理，实现更智能的检索能力。</li>
<li><strong>数据不出库，安全性更高</strong>：不需要将数据导出到外部系统，与Hologres的多种安全能力无缝集成，并高效保护数据安全。</li>
</ul>
<h2 data-id="heading-2">方案流程</h2>
<p>本次方案的流程如下：</p>
<ol>
<li>数据集准备。</li>
</ol>
<p>将图片数据上传至OSS存储。</p>
<ol start="2">
<li>图片加工。</li>
</ol>
<p>使用Object Table读取图片的元数据信息，然后创建增量刷新的Dynamic Table对数据进行Embed，并为Dynamic Table构建向量索引，以便后续检索能够充分利用索引的功能。</p>
<ol start="3">
<li>使用ai_embed算子将自然语言的问题进行Embedding，然后使用向量检索输出Top N的结果。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61d6d9715947417bbfa09193822f216c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065957&amp;x-signature=GSSEtM2lHOc6a8afhygWFOuFuuc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>准备工作</strong></h2>
<ol>
<li>数据准备</li>
</ol>
<p>本文使用ModelScope公开的BDD100K 自动驾驶图像数据集中<code>val.zip</code>文件，模拟多个车辆真是行驶数据。</p>
<ol start="2">
<li>环境准备</li>
</ol>
<ul>
<li>购买Hologres V4.0及以上版本实例并创建数据库。</li>
<li>购买AI资源。</li>
</ul>
<p>本文以<code>large-96core-512GB-384GB</code>、1个节点为例。</p>
<ul>
<li>模型部署。本次方案使用的模型以及分配的资源为：</li>
</ul>







<table><thead><tr><th/><th/></tr></thead></table>





































<table><thead><tr><th align="left"><strong>类别</strong></th><th align="left"><strong>示例值</strong></th></tr></thead><tbody><tr><td align="left"><strong>模型名称</strong></td><td align="left">image_embed</td></tr><tr><td align="left"><strong>模型类别</strong></td><td align="left">clip-ViT-B-32</td></tr><tr><td align="left"><strong>模型作用描述</strong></td><td align="left">图片Embedding</td></tr><tr><td align="left"><strong>单副本CPU（Core）</strong></td><td align="left">7</td></tr><tr><td align="left"><strong>单副本内存</strong></td><td align="left">30 GB</td></tr><tr><td align="left"><strong>单副本GPU</strong></td><td align="left">1卡(96 GB)</td></tr><tr><td align="left"><strong>资源副本数</strong></td><td align="left">1</td></tr></tbody></table>
<p><strong>说明：</strong>上述模型的资源均为默认分配的资源。</p>
<h2 data-id="heading-4"><strong>操作步骤</strong></h2>
<p>1.下载图片数据并导入至OSS。</p>
<ul>
<li>下载BDD100K 自动驾驶图像数据集中的文件。</li>
<li>登录OSS管理控制台，创建Bucket并将已下载的文件上传至该Bucket路径下。上传操作详情，请参见简单上传。</li>
</ul>
<p><strong>说明：</strong>文件夹名称请使用小写。</p>
<ol start="2">
<li>账号授权。</li>
</ol>
<p>a. 登录RAM控制台，创建阿里云RAM角色并授予OSS的相关权限。
推荐授予AliyunOSSReadOnlyAccess权限。</p>
<p>b.为上述阿里云RAM角色添加登录和Hologres的访问权限。</p>
<ul>
<li>阿里云账号（主账号）</li>
</ul>
<p>修改RAM角色的信任策略。重点需更新如下参数：</p>
<ul>
<li>Action:更新为 sts:AssumeRole.</li>
<li>Service:更新为 hologres.aliyuncs.com</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sts:AssumeRole"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Principal"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"RAM"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">"acs:ram::1866xxxx:root"</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">"hologres.aliyuncs.com"</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>RAM用户（子账号）</li>
</ul>
<ol>
<li>为RAM用户授权。</li>
</ol>
<ul>
<li>在<strong>权限管理 &gt; 权限策略</strong>页面，单击<strong>创建权限策略</strong>，并选择<strong>脚本编辑</strong>模式创建权限策略。具体操作，请参见创建自定义权限策略</li>
</ul>
<p>Hologres可通过该策略判断当前RAM用户是否具备创建对应RAM角色的权限。权限策略内容如下。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"hologram:GrantAssumeRole"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&lt;arn账号&gt;"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>在<strong>身份管理 &gt; 用户</strong>页面，单击目标RAM用户<strong>操作</strong>列中的<strong>添加权限</strong>，为RAM用户（子账号）授予上述步骤已创建的权限策略。具体操作，请参见为RAM用户授权。</li>
</ul>
<ol start="2">
<li>为已创建的RAM角色授权。</li>
</ol>
<p>修改RAM角色的信任策略。重点需更新如下参数：</p>
<ul>
<li>Action：更新为sts:AssumeRole。</li>
<li>Service：更新为hologres.aliyuncs.com。</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sts:AssumeRole"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"Principal"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"RAM"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">"acs:ram::1866xxxx:root"</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"Service"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-string">"hologres.aliyuncs.com"</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ol start="3">
<li>对图片进行Embedding。</li>
</ol>
<p>创建Object Table和Dynamic Table读取图片元数据，并对图片加工Embedding。因为流程较长，Hologres直接将过程封装成附录：存储过程。该存储过程包括的能力如下：</p>
<ul>
<li>创建一张Object Table，用于读取图片的元数据。</li>
<li>创建一张增量刷新的Dynamic Table结果表，用于存储加工后的数据，并设置向量索引。该Dynamic Table未设置自动刷新，需要手动刷新。</li>
<li>Dynamic Table的刷新过程中会使用ai_embed对图片进行Embedding。</li>
</ul>
<p>该存储过程的使用如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--存储过程，创建Object Table和Dynamic Table，使用dt对图片进行Embedding</span>
<span class="hljs-keyword">CALL</span> create_image_table_from_oss(
    oss_path <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'oss://xxxx/bdd100k/val/images'</span>,
    oss_endpoint <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'oss-cn-hangzhou-internal.aliyuncs.com'</span>,
    oss_role_arn <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'acs:ram::1xxxx:role/xxxx'</span>,
    image_table <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'public.dt_image_bdd100k'</span>,
    embedding_model <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span><span class="hljs-string">'image_embed'</span>
);
</code></pre>
<ol start="4">
<li>刷新结果表。</li>
</ol>
<p>通过上述步骤创建的Object Table和Dynamic Table都需要手动刷新，才能完成数据加工。该步骤已被封装为附录：存储过程，该存储过程包括的能力如下：</p>
<ul>
<li>刷新一次Object Table获取图片元数据。</li>
<li>刷新一次Dynamic Table，进行图片的Embedding加工。</li>
</ul>
<p>该存储过程的使用如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--刷新Dynamic Table，将图片Embedding</span>
<span class="hljs-keyword">CALL</span> refresh_image_table(
    image_table <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-string">'public.dt_image_bdd100k'</span>
);
</code></pre>
<ol start="5">
<li>图片检索。</li>
</ol>
<p>图片数据处理过后可以使用向量检索和AI Function进行检索。</p>
<p><strong>以文搜图：</strong></p>
<p>如果使用clip-ViT-B-32模型进行以文搜图，问题请使用英文。如果是中文问题，请换成LLM模型。以文搜图的示例SQL如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--以文搜图</span>
<span class="hljs-keyword">SELECT</span>
    object_uri,
    approx_cosine_distance (embedding_vector, ai_embed (<span class="hljs-string">'image_embed'</span>, <span class="hljs-string">'a red car in the rain'</span>)) <span class="hljs-keyword">AS</span> score
<span class="hljs-keyword">FROM</span>
    public.dt_image_bdd100k
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    score <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">1</span>;

                            object_uri                         <span class="hljs-operator">|</span>  score   
<span class="hljs-comment">---------------------------------------------------------------+-------</span>
 oss:<span class="hljs-operator">/</span><span class="hljs-comment">/****/</span>bd<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span>k<span class="hljs-operator">/</span>val<span class="hljs-operator">/</span>images<span class="hljs-operator">/</span>b836b14a<span class="hljs-operator">-</span>fb13<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span>.jpg｜ <span class="hljs-number">0.322337151</span>
(<span class="hljs-number">5</span> <span class="hljs-keyword">rows</span>)
</code></pre>
<p>在OSS中找到第一个结果的图片如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74b4c914d822445ebf39ca0181b51a47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065957&amp;x-signature=pKp7g4Lu4ubZpCntviH6qdPW6H8%3D" alt="image.png" loading="lazy"/></p>
<p><strong>以图搜图：</strong></p>
<p>以图搜图的示例SQL如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">--以图搜图</span>
<span class="hljs-keyword">SELECT</span>
    object_uri,
    approx_cosine_distance (embedding_vector, ai_embed (<span class="hljs-string">'image_embed'</span>, to_file (<span class="hljs-string">'oss://xxxx/val/images/b9b53753-91a5d5f8.jpg'</span>, <span class="hljs-string">'oss-cn-hangzhou-internal.aliyuncs.com'</span>, <span class="hljs-string">'acs:ram::18xxx:role/xxx'</span>))) <span class="hljs-keyword">AS</span> score
<span class="hljs-keyword">FROM</span>
    public.dt_image_bdd100k
<span class="hljs-keyword">WHERE</span>
    object_uri <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-string">'oss://hm-**-hangzhou/bd****k/val/images/b9b53753-91a5****.jpg'</span> <span class="hljs-comment">--排除自身</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
    score <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">1</span>;

                          object_uri                           <span class="hljs-operator">|</span>  score   
<span class="hljs-comment">---------------------------------------------------------------+------</span>
 oss:<span class="hljs-operator">/</span><span class="hljs-comment">/****/</span>bd<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span>k<span class="hljs-operator">/</span>val<span class="hljs-operator">/</span>images<span class="hljs-operator">/</span>c0e9b7c4<span class="hljs-operator">-</span>cd8b<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span>.jpg <span class="hljs-operator">|</span> <span class="hljs-number">0.918008327</span>
</code></pre>
<p>在OSS中找到召回的图片，并做对比，结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98bb4d9d1b17467990c1a03b84160c69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764065957&amp;x-signature=3ZVmWanJAhS%2B0GlZ%2Bd3H1XZjW%2FY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">附录：存储过程</h2>
<ul>
<li>创建Object Table和Dynamic Table </li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- Query查询结果默认限制200行，如需更多数据请修改limit，最多展示10000行或20M。</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">PROCEDURE</span> create_image_table_from_oss(
    oss_path TEXT,
    oss_endpoint TEXT,
    oss_role_arn TEXT,
    image_table TEXT,
    embedding_model TEXT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
    overwrite <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>
)
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    image_schema_name TEXT;
    image_table_name TEXT;
    obj_table_name TEXT;
    full_image_table_ident TEXT;
    full_obj_ident TEXT;
    embed_expr TEXT;
    create_sql TEXT;
    embedding_dims <span class="hljs-type">INT</span>;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- 1. 拆 schema name + table name</span>
    IF <span class="hljs-built_in">position</span>(<span class="hljs-string">'.'</span> <span class="hljs-keyword">in</span> image_table) <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
        image_schema_name :<span class="hljs-operator">=</span> split_part(image_table, <span class="hljs-string">'.'</span>, <span class="hljs-number">1</span>);
        image_table_name  :<span class="hljs-operator">=</span> split_part(image_table, <span class="hljs-string">'.'</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">ELSE</span>
        image_schema_name :<span class="hljs-operator">=</span> <span class="hljs-string">'public'</span>;
        image_table_name  :<span class="hljs-operator">=</span> image_table;
    <span class="hljs-keyword">END</span> IF;

    obj_table_name :<span class="hljs-operator">=</span> image_table_name <span class="hljs-operator">||</span> <span class="hljs-string">'_obj_table'</span>;

    full_image_table_ident :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, image_schema_name, image_table_name);
    full_obj_ident    :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, image_schema_name, obj_table_name);
    
    <span class="hljs-comment">-- 2. 如果需要覆盖，先删表和索引</span>
    IF overwrite <span class="hljs-keyword">THEN</span>
        <span class="hljs-keyword">DECLARE</span>
            dyn_table_exists <span class="hljs-type">BOOLEAN</span>;
            rec RECORD;
        <span class="hljs-keyword">BEGIN</span>
            <span class="hljs-comment">-- 检查 dynamic table 是否存在</span>
            <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">EXISTS</span> (
                <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>
                <span class="hljs-keyword">FROM</span> pg_class c
                <span class="hljs-keyword">JOIN</span> pg_namespace n <span class="hljs-keyword">ON</span> n.oid <span class="hljs-operator">=</span> c.relnamespace
                <span class="hljs-keyword">WHERE</span> c.relname <span class="hljs-operator">=</span> image_table_name
                <span class="hljs-keyword">AND</span> n.nspname <span class="hljs-operator">=</span> image_schema_name
            )
            <span class="hljs-keyword">INTO</span> dyn_table_exists;

            IF dyn_table_exists <span class="hljs-keyword">THEN</span>
                <span class="hljs-comment">-- 2.1 关闭动态表自动刷新</span>
                <span class="hljs-comment">-- RAISE NOTICE 'Disabling auto refresh for %', full_image_table_ident;</span>
                <span class="hljs-comment">-- EXECUTE format('ALTER TABLE IF EXISTS %s SET (auto_refresh_enable=false)', full_image_table_ident);</span>

                <span class="hljs-comment">-- 2.2 查找 RUNNING 刷新任务并取消</span>
                <span class="hljs-keyword">FOR</span> rec <span class="hljs-keyword">IN</span>
                    <span class="hljs-keyword">EXECUTE</span> format(
                        $f$
                        <span class="hljs-keyword">SELECT</span> query_job_id
                            <span class="hljs-keyword">FROM</span> hologres.hg_dynamic_table_refresh_log(<span class="hljs-operator">%</span>L)
                            <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'RUNNING'</span>;
                        $f$,
                        image_table
                    )
                LOOP
                    RAISE NOTICE <span class="hljs-string">'Found running refresh job: %'</span>, rec.query_job_id;
                    IF hologres.hg_internal_cancel_query_job(rec.query_job_id::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">THEN</span>
                        RAISE NOTICE <span class="hljs-string">'Cancel job % succeeded.'</span>, rec.query_job_id;
                    <span class="hljs-keyword">ELSE</span>
                        RAISE WARNING <span class="hljs-string">'Cancel job % failed.'</span>, rec.query_job_id;
                    <span class="hljs-keyword">END</span> IF;
                <span class="hljs-keyword">END</span> LOOP;

                <span class="hljs-comment">-- 2.3 删除 Dynamic Table</span>
                <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP TABLE IF EXISTS %s;'</span>, full_image_table_ident);
            <span class="hljs-keyword">ELSE</span>
                RAISE NOTICE <span class="hljs-string">'Dynamic table % does not exist, skip cancel job and drop.'</span>, full_image_table_ident;
            <span class="hljs-keyword">END</span> IF;

            <span class="hljs-comment">-- 2.4 无论如何，Object Table 都要删除</span>
            <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP OBJECT TABLE IF EXISTS %s;'</span>, full_obj_ident);
        <span class="hljs-keyword">END</span>;
    <span class="hljs-keyword">END</span> IF;

    <span class="hljs-comment">-- 3. 创建 Object Table</span>
    RAISE NOTICE <span class="hljs-string">'Create object table: %'</span>, obj_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(
        $f$
        <span class="hljs-keyword">CREATE</span> OBJECT <span class="hljs-keyword">TABLE</span> <span class="hljs-operator">%</span>s
        <span class="hljs-keyword">WITH</span> (
            path <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>L,
            oss_endpoint <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>L,
            role_arn <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>L
        );
        $f$,
        full_obj_ident,
        oss_path,
        oss_endpoint,
        oss_role_arn
    );

    <span class="hljs-keyword">COMMIT</span>;

    <span class="hljs-comment">-- 4. 刷新 Object Table</span>
    RAISE NOTICE <span class="hljs-string">'Refresh object table: %'</span>, obj_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'REFRESH OBJECT TABLE %s;'</span>, full_obj_ident);

    <span class="hljs-keyword">COMMIT</span>;

    <span class="hljs-comment">-- 5. embedding 模型选择</span>
    IF embedding_model <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">OR</span> length(<span class="hljs-built_in">trim</span>(embedding_model)) <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
        embed_expr :<span class="hljs-operator">=</span> <span class="hljs-string">'ai_embed(file)'</span>;

        <span class="hljs-keyword">EXECUTE</span> <span class="hljs-string">'SELECT array_length(ai_embed(''dummy''), 1)'</span>
        <span class="hljs-keyword">INTO</span> embedding_dims;
    <span class="hljs-keyword">ELSE</span>
        embed_expr :<span class="hljs-operator">=</span> format(<span class="hljs-string">'ai_embed(%L, file)'</span>, embedding_model);

        <span class="hljs-keyword">EXECUTE</span> format(
            <span class="hljs-string">'SELECT array_length(ai_embed(%L, ''dummy''), 1)'</span>,
            embedding_model
        )
        <span class="hljs-keyword">INTO</span> embedding_dims;
    <span class="hljs-keyword">END</span> IF;

    RAISE NOTICE <span class="hljs-string">'embedding dimension is: %'</span>, embedding_dims;

    <span class="hljs-comment">-- 6. 创建 RAG 输出动态表</span>
    RAISE NOTICE <span class="hljs-string">'create dynamic table: %'</span>, image_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(
        $f$
        <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DYNAMIC</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-operator">%</span>s(
            <span class="hljs-keyword">CHECK</span>(array_ndims(embedding_vector) <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> array_length(embedding_vector, <span class="hljs-number">1</span>) <span class="hljs-operator">=</span> <span class="hljs-operator">%</span>s)
        )
        <span class="hljs-keyword">WITH</span> (
            vectors <span class="hljs-operator">=</span> <span class="hljs-string">'{
                "embedding_vector": {
                    "algorithm": "HGraph",
                    "distance_method": "Cosine",
                    "builder_params": {
                    "base_quantization_type": "sq8_uniform",
                    "max_degree": 64,
                    "ef_construction": 400,
                    "precise_quantization_type": "fp32",
                    "use_reorder": true
                    }
                }
            }'</span>,
            auto_refresh_mode <span class="hljs-operator">=</span> <span class="hljs-string">'incremental'</span>,
            freshness <span class="hljs-operator">=</span> <span class="hljs-string">'5 minutes'</span>,
            auto_refresh_enable <span class="hljs-operator">=</span> <span class="hljs-string">'false'</span>
        ) <span class="hljs-keyword">AS</span>
        <span class="hljs-keyword">SELECT</span>
            object_uri,
            etag,
            <span class="hljs-operator">%</span>s <span class="hljs-keyword">AS</span> embedding_vector
        <span class="hljs-keyword">FROM</span> <span class="hljs-operator">%</span>s;
        $f$,
        full_image_table_ident,
        embedding_dims,
        embed_expr,
        obj_table_name
    );

    <span class="hljs-keyword">COMMIT</span>;

    RAISE NOTICE <span class="hljs-string">''</span>;
    RAISE NOTICE <span class="hljs-string">'Create image table success: %'</span>, image_table;
    RAISE NOTICE <span class="hljs-string">'    Vector index is: %.embedding_vector'</span>, image_table;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<ul>
<li>Object Table和Dynamic Table</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">PROCEDURE</span> refresh_image_table(
    image_table TEXT
)
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    image_schema_name TEXT;
    image_table_name   TEXT;
    obj_table_name TEXT;
    full_image_table_ident TEXT;
    full_obj_ident    TEXT;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- 1. 解析 schema 和表名</span>
    IF <span class="hljs-built_in">position</span>(<span class="hljs-string">'.'</span> <span class="hljs-keyword">in</span> image_table) <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
        image_schema_name :<span class="hljs-operator">=</span> split_part(image_table, <span class="hljs-string">'.'</span>, <span class="hljs-number">1</span>);
        image_table_name  :<span class="hljs-operator">=</span> split_part(image_table, <span class="hljs-string">'.'</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">ELSE</span>
        image_schema_name :<span class="hljs-operator">=</span> <span class="hljs-string">'public'</span>;
        image_table_name  :<span class="hljs-operator">=</span> image_table;
    <span class="hljs-keyword">END</span> IF;

    obj_table_name :<span class="hljs-operator">=</span> image_table_name <span class="hljs-operator">||</span> <span class="hljs-string">'_obj_table'</span>;

    full_image_table_ident :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, image_schema_name, image_table_name);
    full_obj_ident    :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, image_schema_name, obj_table_name);

    <span class="hljs-comment">-- 2. 刷新 Object Table</span>
    RAISE NOTICE <span class="hljs-string">'Refreshing Object Table: %'</span>, obj_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'REFRESH OBJECT TABLE %s;'</span>, full_obj_ident);

    <span class="hljs-comment">-- 3. 刷新 Dynamic Table</span>
    RAISE NOTICE <span class="hljs-string">'Refreshing Dynamic Table: %'</span>, image_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'REFRESH TABLE %s;'</span>, full_image_table_ident);

    RAISE NOTICE <span class="hljs-string">'Refresh image table complete: %'</span>, image_table;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<ul>
<li>删除存储过程</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-keyword">PROCEDURE</span> drop_image_table(
    image_table TEXT
)
<span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">DECLARE</span>
    image_schema_name TEXT;
    image_table_name   TEXT;
    obj_table_name TEXT;
    full_image_table_ident TEXT;
    full_obj_ident    TEXT;
    rec RECORD;
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- 1. 解析 schema 和表名</span>
    IF <span class="hljs-built_in">position</span>(<span class="hljs-string">'.'</span> <span class="hljs-keyword">in</span> image_table) <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span>
        image_schema_name :<span class="hljs-operator">=</span> split_part(image_table, <span class="hljs-string">'.'</span>, <span class="hljs-number">1</span>);
        image_table_name   :<span class="hljs-operator">=</span> split_part(image_table, <span class="hljs-string">'.'</span>, <span class="hljs-number">2</span>);
    <span class="hljs-keyword">ELSE</span>
        image_schema_name :<span class="hljs-operator">=</span> <span class="hljs-string">'public'</span>;
        image_table_name   :<span class="hljs-operator">=</span> image_table;
    <span class="hljs-keyword">END</span> IF;

    obj_table_name :<span class="hljs-operator">=</span> image_table_name <span class="hljs-operator">||</span> <span class="hljs-string">'_obj_table'</span>;

    full_image_table_ident :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, image_schema_name, image_table_name);
    full_obj_ident    :<span class="hljs-operator">=</span> format(<span class="hljs-string">'%I.%I'</span>, image_schema_name, obj_table_name);

    <span class="hljs-comment">-- 2. 删除表</span>
    <span class="hljs-comment">-- 2.1 关闭动态表自动刷新</span>
    <span class="hljs-comment">-- RAISE NOTICE 'Disabling auto refresh for %', full_image_table_ident;</span>
    <span class="hljs-comment">-- EXECUTE format('ALTER TABLE IF EXISTS %s SET (auto_refresh_enable=false)', full_image_table_ident);</span>

    <span class="hljs-comment">-- 2.2 查找 RUNNING 刷新任务并取消</span>
    <span class="hljs-keyword">FOR</span> rec <span class="hljs-keyword">IN</span>
        <span class="hljs-keyword">EXECUTE</span> format(
            $f$
            <span class="hljs-keyword">SELECT</span> query_job_id
                <span class="hljs-keyword">FROM</span> hologres.hg_dynamic_table_refresh_log(<span class="hljs-operator">%</span>L)
                <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'RUNNING'</span>;
            $f$,
            image_table
        )
    LOOP
        RAISE NOTICE <span class="hljs-string">'Found running refresh job: %'</span>, rec.query_job_id;
        IF hologres.hg_internal_cancel_query_job(rec.query_job_id::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">THEN</span>
            RAISE NOTICE <span class="hljs-string">'Cancel job % succeeded.'</span>, rec.query_job_id;
        <span class="hljs-keyword">ELSE</span>
            RAISE WARNING <span class="hljs-string">'Cancel job % failed.'</span>, rec.query_job_id;
        <span class="hljs-keyword">END</span> IF;
    <span class="hljs-keyword">END</span> LOOP;

    <span class="hljs-comment">-- 2.3 删除 Dynamic Table</span>
    RAISE NOTICE <span class="hljs-string">'Dropping Dynamic Table: %'</span>, image_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP TABLE IF EXISTS %s;'</span>, full_image_table_ident);

    <span class="hljs-comment">-- 2.4 删除 Object Table</span>
    RAISE NOTICE <span class="hljs-string">'Dropping Object Table: %'</span>, obj_table_name;
    <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">'DROP OBJECT TABLE IF EXISTS %s;'</span>, full_obj_ident);

    RAISE NOTICE <span class="hljs-string">'Drop image table complete: %'</span>, image_table;
<span class="hljs-keyword">END</span>;
$$ <span class="hljs-keyword">LANGUAGE</span> plpgsql;
</code></pre>
<p>如果想体验更多操作流程，欢迎到阿里云官网领取Hologres免费试用，开通Hologres4.0，并按照操作文档实践。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fhologres%2Fuser-guide%2Fvisual-data-analysis-for-autonomous-driving" target="_blank" title="https://help.aliyun.com/zh/hologres/user-guide/visual-data-analysis-for-autonomous-driving" ref="nofollow noopener noreferrer">help.aliyun.com/zh/hologres…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>