<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[高通QCRIL和QMI]]></title>    <link>https://juejin.cn/post/7603355275257102376</link>    <guid>https://juejin.cn/post/7603355275257102376</guid>    <pubDate>2026-02-06T07:00:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603355275257102376" data-draft-id="7603308967125352448" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高通QCRIL和QMI"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T07:00:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高通QCRIL和QMI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:00:59.000Z" title="Fri Feb 06 2026 07:00:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. <strong>什么是 QCRIL？</strong></h3>
<p><strong>QCRIL</strong> = <strong>Qualcomm</strong> <strong>C</strong> <strong>RIL</strong> (高通 C 语言 RIL)</p>
<ul>
<li>QCRIL 是高通为其 Snapdragon 处理器开发的 RIL 实现</li>
<li>是一个原始厂商提供的电话接口库，实现了 Android 的 RIL 接口</li>
<li>负责与高通调制解调器通信，处理电话功能</li>
</ul>
<h3 data-id="heading-1">2. <strong>什么是 QMI？</strong></h3>
<p><strong>QMI</strong> = <strong>Qualcomm Message Interface</strong> (高通消息接口)</p>
<ul>
<li>QMI 是高通定义的通信协议，用于与调制解调器(Modem)通信</li>
<li>是 QCRIL 的底层通信协议</li>
<li>运行在内核中，通过 <code>/dev/qmi</code> 设备进行通信</li>
</ul>
<p><strong>关键特点：</strong></p>
<ul>
<li>基于<strong>消息的通信协议</strong></li>
<li>使用 TLV (Tag-Length-Value) 编码格式</li>
<li>支持多个<strong>服务</strong>(Service)，每个服务负责不同的功能</li>
</ul>
<hr/>
<h3 data-id="heading-2">3. <strong>QCRIL 和 QMI 的关系</strong></h3>
<pre><code class="hljs language-scss" lang="scss">Android Framework (Phone App)
       ↓
RIL Daemon (rild)
       ↓
QCRIL Library (vendor-specific RIL implementation)
       ↓
QMI Protocol (/dev/qmi device)
       ↓
Modem (高通调制解调器)
</code></pre>
<hr/>
<h3 data-id="heading-3">4. <strong>代码示例：QMI 数据连接建立</strong></h3>
<p>从 <code>reference-ril.c</code> 可以看到 QMI 的实际使用：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-number">1916</span>|    fd = open (<span class="hljs-string">"/dev/qmi"</span>, O_RDWR);  <span class="hljs-comment">// 打开QMI设备</span>
<span class="hljs-number">1917</span>|    <span class="hljs-keyword">if</span> (fd &gt;= <span class="hljs-number">0</span>) { <span class="hljs-comment">/* the device doesn't exist on the emulator */</span>
<span class="hljs-number">1918</span>|
<span class="hljs-number">1919</span>|        RLOGD(<span class="hljs-string">"opened the qmi device\n"</span>);
<span class="hljs-number">1920</span>|        asprintf(&amp;cmd, <span class="hljs-string">"up:%s"</span>, apn);  <span class="hljs-comment">// 构造命令：up:APN名称</span>
<span class="hljs-number">1921</span>|        len = <span class="hljs-built_in">strlen</span>(cmd);
<span class="hljs-number">1922</span>|
<span class="hljs-number">1923</span>|        <span class="hljs-keyword">while</span> (cur &lt; len) {
<span class="hljs-number">1924</span>|            <span class="hljs-keyword">do</span> {
<span class="hljs-number">1925</span>|                written = write (fd, cmd + cur, len - cur);  <span class="hljs-comment">// 发送QMI命令给modem</span>
<span class="hljs-number">1926</span>|            } <span class="hljs-keyword">while</span> (written &lt; <span class="hljs-number">0</span> &amp;&amp; errno == EINTR);
<span class="hljs-number">1927</span>|        }
<span class="hljs-number">1928</span>|
<span class="hljs-number">1929</span>|        <span class="hljs-comment">// 等待接口上线</span>
<span class="hljs-number">1930</span>|        <span class="hljs-keyword">do</span> {
<span class="hljs-number">1931</span>|            sleep(<span class="hljs-number">1</span>);
<span class="hljs-number">1932</span>|            <span class="hljs-keyword">do</span> {
<span class="hljs-number">1933</span>|                rlen = read(fd, status, <span class="hljs-number">31</span>);  <span class="hljs-comment">// 读取modem响应</span>
<span class="hljs-number">1934</span>|            } <span class="hljs-keyword">while</span> (rlen &lt; <span class="hljs-number">0</span> &amp;&amp; errno == EINTR);
<span class="hljs-number">1935</span>|        } <span class="hljs-keyword">while</span> (<span class="hljs-built_in">strncmp</span>(status, <span class="hljs-string">"STATE=up"</span>, <span class="hljs-number">8</span>) &amp;&amp; <span class="hljs-built_in">strcmp</span>(status, <span class="hljs-string">"online"</span>) &amp;&amp; --retry);
</code></pre>
<p><strong>数据连接流程：</strong></p>





































<table><thead><tr><th>步骤</th><th>操作</th></tr></thead><tbody><tr><td>1</td><td>RIL 接收 <code>RIL_REQUEST_SETUP_DATA_CALL</code> 请求</td></tr><tr><td>2</td><td>QCRIL 打开 <code>/dev/qmi</code> 设备</td></tr><tr><td>3</td><td>发送 QMI 命令：<code>up:apn_name</code></td></tr><tr><td>4</td><td>Modem 处理 QMI 消息，建立数据连接</td></tr><tr><td>5</td><td>读取 Modem 响应状态 (<code>STATE=up</code> 或 <code>online</code>)</td></tr><tr><td>6</td><td>配置网络接口 (<code>netcfg rmnet0 dhcp</code>)</td></tr><tr><td>7</td><td>返回数据连接结果给 Android Framework</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-4">5. <strong>QMI 服务类型</strong></h3>
<p>QMI 定义了多个服务，用于处理不同类型的请求：</p>








































<table><thead><tr><th>QMI 服务</th><th>功能</th><th>关联的 RIL 请求</th></tr></thead><tbody><tr><td><strong>WDS</strong> (Wireless Data Service)</td><td>数据连接、分组数据</td><td><code>SETUP_DATA_CALL</code>, <code>DEACTIVATE_DATA_CALL</code></td></tr><tr><td><strong>NAS</strong> (Network Access Service)</td><td>网络注册、信号强度、服务状态</td><td><code>VOICE_REGISTRATION_STATE</code>, <code>DATA_REGISTRATION_STATE</code></td></tr><tr><td><strong>QMI_CTL</strong></td><td>QMI 控制和初始化</td><td>基础初始化</td></tr><tr><td><strong>SMS</strong></td><td>短信服务</td><td><code>SEND_SMS</code>, <code>RECEIVE_SMS</code></td></tr><tr><td><strong>DMS</strong> (Device Management Service)</td><td>设备管理</td><td>获取 IMEI、IMSI 等</td></tr><tr><td><strong>UIM</strong> (USIM Interface)</td><td>SIM 卡管理</td><td><code>SIM_IO</code>, <code>GET_SIM_STATUS</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">6. <strong>RIL 请求处理流程</strong></h3>
<p>以 <code>RIL_REQUEST_SETUP_DATA_CALL</code> 为例：</p>
<pre><code class="hljs language-bash" lang="bash">Java 层 (ConnectivityManager)
   ↓
RIL.java (java/com/android/internal/telephony/)
   ↓
radio::setupDataCallResponse (ril_service.cpp)
   ↓
QCRIL (vendor library)
   ↓
QMI WDS Service (Write to /dev/qmi)
   ↓
Modem (执行数据连接)
   ↓
QMI WDS Response (Read from /dev/qmi)
   ↓
RIL_onRequestComplete() 回调
   ↓
Java 层获得结果，更新网络状态
</code></pre>
<hr/>
<h3 data-id="heading-6">7. <strong>实际的 RIL 请求处理</strong></h3>
<p>从 <code>ril_service.cpp</code> 看数据调用请求：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function">Return&lt;<span class="hljs-type">void</span>&gt; <span class="hljs-title">RadioImpl::setupDataCall</span><span class="hljs-params">(
    <span class="hljs-type">int32_t</span> serial, 
    RadioTechnology radioTechnology,
    <span class="hljs-type">const</span> DataProfileInfo&amp; dataProfileInfo, 
    <span class="hljs-type">bool</span> modemCognitive,
    <span class="hljs-type">bool</span> roamingAllowed, 
    <span class="hljs-type">bool</span> isRoaming)</span> </span>{
    
    <span class="hljs-comment">// 构造 RIL_REQUEST_SETUP_DATA_CALL 请求参数</span>
    <span class="hljs-built_in">dispatchStrings</span>(serial, mSlotId, RIL_REQUEST_SETUP_DATA_CALL, <span class="hljs-literal">true</span>, <span class="hljs-number">15</span>,
        std::<span class="hljs-built_in">to_string</span>((<span class="hljs-type">int</span>) radioTechnology + <span class="hljs-number">2</span>).<span class="hljs-built_in">c_str</span>(),
        std::<span class="hljs-built_in">to_string</span>((<span class="hljs-type">int</span>) dataProfileInfo.profileId).<span class="hljs-built_in">c_str</span>(),
        dataProfileInfo.apn.<span class="hljs-built_in">c_str</span>(),           <span class="hljs-comment">// APN 名称</span>
        dataProfileInfo.user.<span class="hljs-built_in">c_str</span>(),          <span class="hljs-comment">// 用户名</span>
        dataProfileInfo.password.<span class="hljs-built_in">c_str</span>(),      <span class="hljs-comment">// 密码</span>
        std::<span class="hljs-built_in">to_string</span>((<span class="hljs-type">int</span>) dataProfileInfo.authType).<span class="hljs-built_in">c_str</span>(),
        dataProfileInfo.protocol.<span class="hljs-built_in">c_str</span>(),      <span class="hljs-comment">// IP/IPv6/IPV4V6</span>
        <span class="hljs-comment">// ... 更多参数</span>
    );
}
</code></pre>
<hr/>
<h3 data-id="heading-7">8. <strong>QCRIL 的优势</strong></h3>

























<table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td><strong>高性能</strong></td><td>针对高通 Modem 优化</td></tr><tr><td><strong>功能完整</strong></td><td>支持所有高通 Modem 特性</td></tr><tr><td><strong>稳定性</strong></td><td>经过严格测试</td></tr><tr><td><strong>低延迟</strong></td><td>直接通过 QMI 协议与 Modem 通信</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">9. <strong>关键文件位置</strong></h3>

























<table><thead><tr><th>文件</th><th>功能</th></tr></thead><tbody><tr><td><code>hardware_ril/reference-ril/reference-ril.c</code></td><td>参考 RIL 实现</td></tr><tr><td><code>hardware_ril/libril/ril.cpp</code></td><td>RIL 核心库</td></tr><tr><td><code>hardware_ril/libril/ril_service.cpp</code></td><td>RIL HAL 服务适配</td></tr><tr><td><code>hardware_ril/include/telephony/ril.h</code></td><td>RIL 接口定义</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-9">10. <strong>总结</strong></h3>
<ul>
<li><strong>QCRIL</strong> 是高通实现的 RIL，遵循 Android 的 RIL 接口规范</li>
<li><strong>QMI</strong> 是 QCRIL 与 Modem 通信的底层协议</li>
<li>QMI 通过 <code>/dev/qmi</code> 设备驱动与内核交互</li>
<li>所有电话功能（通话、短信、数据等）都通过 QMI 消息在 QCRIL 和 Modem 之间传输</li>
<li>QCRIL + QMI 构成了 Android 系统与高通 Modem 通信的桥梁</li>
</ul>
<p>这个架构确保了 Android 系统与不同厂商 Modem 的兼容性，同时为厂商提供了优化其硬件的机会。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mybatis]]></title>    <link>https://juejin.cn/post/7603301285475647530</link>    <guid>https://juejin.cn/post/7603301285475647530</guid>    <pubDate>2026-02-06T07:04:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603301285475647530" data-draft-id="7603352061505765382" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mybatis"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T07:04:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悦悦妍妍"/> <meta itemprop="url" content="https://juejin.cn/user/3395772841729421"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mybatis
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3395772841729421/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悦悦妍妍
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:04:44.000Z" title="Fri Feb 06 2026 07:04:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">准备工作</h3>
<ul>
<li>
<p>相关maven依赖
<code>Lombok</code> <code>Spring Web</code>  <code>MyBatis Framework</code>  <code>MySQL Driver</code></p>
</li>
<li>
<p>application.properties 配置数据源</p>
</li>
</ul>
<pre><code class="hljs language-java" lang="java">spring.datasource.url=jdbc:mysql:<span class="hljs-comment">//localhost:3306/myapp_db</span>
spring.datasource.username=xxx
spring.datasource.password=xxx
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver


# resources目录下新建mapper目录 
mybatis.mapper-locations=classpath:mapper<span class="hljs-comment">/**.xml
# 数据库表列明 中横线转 表实体bean对应的小驼峰
mybatis.configuration.map-underscore-to-camel-case=true
# 开启sql日志
logging.level.org.example.mybatis.mapper=debug
</span></code></pre>
<ul>
<li>idea安装<code>mybatisx</code>插件, 按键自动生成Mapper接口对应的xml实现</li>
</ul>
<h3 data-id="heading-1">取值</h3>
<p><code>#{}</code><strong>安全</strong>的参数预编译<br/>
<code>${}</code>是<strong>直接</strong>的字符串拼接。</p>






























<table><thead><tr><th>特性</th><th><code>#{}</code> (井号占位符)</th><th><code>${}</code> (美元占位符)</th></tr></thead><tbody><tr><td><strong>处理方式</strong></td><td><strong>预编译（PreparedStatement）</strong> ，参数化查询</td><td><strong>字符串拼接（Statement）</strong> ，直接替换</td></tr><tr><td><strong>安全性</strong></td><td><strong>高</strong>，有效防止SQL注入</td><td><strong>低</strong>，存在SQL注入风险</td></tr><tr><td><strong>参数类型</strong></td><td>任意类型，自动进行类型转换和转义</td><td>通常为<strong>字符串</strong>，原样替换，不转义</td></tr><tr><td><strong>使用场景</strong></td><td><strong>几乎所有的值传递</strong>（WHERE条件值、INSERT值等）</td><td><strong>动态SQL片段</strong>（表名、列名、ORDER BY等）</td></tr></tbody></table>
<h4 data-id="heading-2">取入参值</h4>
<ul>
<li>当只有一个参数时，直接放变量名(xml中的变量名可以随便命名) 或 bean中属性, 这时可以不用<code>@Param</code>；若用了<code>@Param</code>，xml中的变量名必须和<code>@Param</code>内的命名保持一致，不能直接取bean中属性，需要<code>@Param</code>内的命名.属性名</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> {

    User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(String id)</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertUser</span><span class="hljs-params">(User user)</span>;

}

&lt;select id=<span class="hljs-string">"getUserById"</span> resultType=<span class="hljs-string">"org.example.mybatis.entity.User"</span>&gt;
    select * from users <span class="hljs-type">where</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> #{id}
&lt;/select&gt;

&lt;!-- username  email 为 User 中的属性 --&gt;
&lt;insert id=<span class="hljs-string">"insertUser"</span>&gt;
    insert into <span class="hljs-title function_">users</span><span class="hljs-params">(username, email)</span>values (#{username}, #{email})
&lt;/insert&gt;
</code></pre>
<ul>
<li>多个参数用<code>@Param</code></li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@Param("id")</span> String id, <span class="hljs-meta">@Param("us")</span> User user)</span>;

&lt;update id=<span class="hljs-string">"updateUser"</span>&gt;
    update users
    <span class="hljs-type">set</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> #{us.username},
        email    = #{us.email}
    <span class="hljs-type">where</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> #{id}
&lt;/update&gt;
</code></pre>
<p><code>最佳实践</code>：为了统一化取参，即使一个参数也使用<code>@Param</code></p>
<h3 data-id="heading-3">返回值处理</h3>
<h4 data-id="heading-4">返回普通数据 <code>resultType</code></h4>
<ul>
<li>返回基本类型、String、Long、普通javeBean都只需要在 <code>resultType</code>中声明返回值的全限定类名</li>
<li>mybatis.configuration.map-underscore-to-camel-case=true <code>开启驼峰映射</code>：表中查询结果集中<code>a_column</code>列会自动被映射为bean中的<code>aColumn</code>属性</li>
</ul>
<h4 data-id="heading-5">自定义映射结果集 <code>resultMap</code></h4>
<p>当表中结果和javabean属性不能映射（字段名不对应，即使开启驼峰映射也不行），这时需要使用自定义映射</p>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-comment">&lt;!-- 当结果表能主动映射bean中属性时，可以不用在resultMap中声明 id自定义的结果映射唯一名 type-接受结果bean的全类名 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"UserRm"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"org.example.mybatis.entity.User"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- id标签-主键 result标签-其他普通列 column-结果表的列名 property-bean的属性名 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"user_phone"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"phone"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getUserByIdRm"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"UserRm"</span>&gt;</span>
    select * from users;
<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[THREE.js 摄像机]]></title>    <link>https://juejin.cn/post/7603383059150831658</link>    <guid>https://juejin.cn/post/7603383059150831658</guid>    <pubDate>2026-02-06T07:04:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603383059150831658" data-draft-id="7603389033040986166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="THREE.js 摄像机"/> <meta itemprop="keywords" content="前端,JavaScript,three.js"/> <meta itemprop="datePublished" content="2026-02-06T07:04:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="龙猫不热"/> <meta itemprop="url" content="https://juejin.cn/user/4098608612778654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            THREE.js 摄像机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4098608612778654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    龙猫不热
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:04:29.000Z" title="Fri Feb 06 2026 07:04:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前置代码</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">html</span>,
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    }

    <span class="hljs-selector-id">#c</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">display</span>: block;
    }

    <span class="hljs-selector-class">.split</span> {
      <span class="hljs-attribute">position</span>: absolute;
      <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">display</span>: flex;
    }

    <span class="hljs-selector-class">.split</span>&gt;<span class="hljs-selector-tag">div</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"c"</span>&gt;</span>

  <span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"split"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"view1"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"view2"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"importmap"</span>&gt;</span><span class="javascript">
    {
        <span class="hljs-string">"imports"</span>: {
            <span class="hljs-string">"three"</span>: <span class="hljs-string">"https://esm.sh/three@0.174.0/build/three.module.js"</span>,
            <span class="hljs-string">"three/addons/"</span>: <span class="hljs-string">"https://cdn.jsdelivr.net/npm/three@0.174.0/examples/jsm/"</span>
        }   
    }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./index.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-1">透视摄像机<a href="https://link.juejin.cn?target=https%3A%2F%2Fthreejs.org%2Fdocs%2F%23api%2Fzh%2Fcameras%2FPerspectiveCamera" target="_blank" title="https://threejs.org/docs/#api/zh/cameras/PerspectiveCamera" ref="nofollow noopener noreferrer"><code>PerspectiveCamera</code></a></h2>
<p><code>PerspectiveCamera</code> 通过四个属性来定义一个视锥, <code>near</code>定义视锥前端, <code>far</code>定义远端, <code>fov</code>是视野, 通过计算正确的高度来从摄像机的位置获取指定的以<code>near</code>为单位的视野, 定义的是视锥的前端和远端的高度
<code>aspect</code>间接地定义了视锥前端和远端的宽度, 实际上视锥的宽度是通过高度乘以 <code>aspect</code> 来得到的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3376eb777f44248f74c7156e361b04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z54yr5LiN54Ot:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966269&amp;x-signature=Z0C%2FbuZ7LRjOsGGt7cqkoZHG38s%3D" alt="" loading="lazy"/></p>
<p>下面这个例子我们使用 three 的<a href="https://link.juejin.cn?target=https%3A%2F%2Fthreejs.org%2Fdocs%2Findex.html%3Fq%3Dwebgl%23WebGLRenderer.setScissor" target="_blank" title="https://threejs.org/docs/index.html?q=webgl#WebGLRenderer.setScissor" ref="nofollow noopener noreferrer">剪函数</a>, 把视图分成两部分, 主视图正常渲染, 辅视图用来观察 <code>cameraHelper</code> 的渲染</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/addons/controls/OrbitControls.js"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">GUI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/addons/libs/lil-gui.module.min.js"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#c"</span>);
  <span class="hljs-keyword">const</span> view1Elem = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#view1"</span>);
  <span class="hljs-keyword">const</span> view2Elem = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#view2"</span>);

  <span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({ <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>, canvas });

  <span class="hljs-comment">// #region 左视图的相机</span>
  <span class="hljs-keyword">const</span> fov = <span class="hljs-number">45</span>;
  <span class="hljs-keyword">const</span> aspect = <span class="hljs-number">2</span>; <span class="hljs-comment">// the canvas default</span>
  <span class="hljs-keyword">const</span> near = <span class="hljs-number">0.1</span>;
  <span class="hljs-keyword">const</span> far = <span class="hljs-number">100</span>;
  <span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(fov, aspect, near, far);
  camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>);

  <span class="hljs-keyword">const</span> cameraHelper = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CameraHelper</span>(camera);

  <span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, view1Elem);
  controls.<span class="hljs-property">target</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>);
  controls.<span class="hljs-title function_">update</span>();

  <span class="hljs-comment">// #endregion</span>

  <span class="hljs-comment">// #region 右视图的相机</span>
  <span class="hljs-keyword">const</span> camera2 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
    <span class="hljs-number">60</span>, <span class="hljs-comment">// fov</span>
    <span class="hljs-number">2</span>, <span class="hljs-comment">// aspect</span>
    <span class="hljs-number">0.1</span>, <span class="hljs-comment">// near</span>
    <span class="hljs-number">500</span>, <span class="hljs-comment">// far</span>
  );
  camera2.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">40</span>, <span class="hljs-number">10</span>, <span class="hljs-number">30</span>);
  camera2.<span class="hljs-title function_">lookAt</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> controls2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera2, view2Elem);
  controls2.<span class="hljs-property">target</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>);
  controls2.<span class="hljs-title function_">update</span>();

  <span class="hljs-comment">// #endregion</span>

  <span class="hljs-comment">/**
   * 设置裁剪区域和视口, 返回宽高比
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">elem</span>
   * <span class="hljs-doctag">@returns</span>
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">setScissorForElement</span>(<span class="hljs-params">elem</span>) {
    <span class="hljs-comment">// 获取 canvas 与元素的边界矩形</span>
    <span class="hljs-keyword">const</span> canvasRect = canvas.<span class="hljs-title function_">getBoundingClientRect</span>();
    <span class="hljs-keyword">const</span> elemRect = elem.<span class="hljs-title function_">getBoundingClientRect</span>();

    <span class="hljs-comment">// 相对位置计算元素在 canvas 内的左右上下边界</span>
    <span class="hljs-keyword">const</span> right = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(elemRect.<span class="hljs-property">right</span>, canvasRect.<span class="hljs-property">right</span>) - canvasRect.<span class="hljs-property">left</span>;
    <span class="hljs-keyword">const</span> left = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, elemRect.<span class="hljs-property">left</span> - canvasRect.<span class="hljs-property">left</span>);
    <span class="hljs-keyword">const</span> bottom = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(elemRect.<span class="hljs-property">bottom</span>, canvasRect.<span class="hljs-property">bottom</span>) - canvasRect.<span class="hljs-property">top</span>;
    <span class="hljs-keyword">const</span> top = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, elemRect.<span class="hljs-property">top</span> - canvasRect.<span class="hljs-property">top</span>);

    <span class="hljs-keyword">const</span> width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(canvasRect.<span class="hljs-property">width</span>, right - left);
    <span class="hljs-keyword">const</span> height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(canvasRect.<span class="hljs-property">height</span>, bottom - top);

    <span class="hljs-comment">// 设置裁剪</span>
    <span class="hljs-keyword">const</span> positiveYUpBottom = canvasRect.<span class="hljs-property">height</span> - bottom;

    <span class="hljs-comment">// 对 renderer 设置裁剪区域和视口</span>
    renderer.<span class="hljs-title function_">setScissor</span>(left, positiveYUpBottom, width, height);
    renderer.<span class="hljs-title function_">setViewport</span>(left, positiveYUpBottom, width, height);

    <span class="hljs-keyword">return</span> width / height;
  }

  <span class="hljs-comment">// gui 使用,限制对象中属性的最大值最小值</span>
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinMaxGUIHelper</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">obj, minProp, maxProp, minDif</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span> = obj;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">minProp</span> = minProp;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span> = maxProp;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">minDif</span> = minDif;
    }
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">min</span>() {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">minProp</span>];
    }
    <span class="hljs-keyword">set</span> <span class="hljs-title function_">min</span>(<span class="hljs-params">v</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">minProp</span>] = v;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>], v + <span class="hljs-variable language_">this</span>.<span class="hljs-property">minDif</span>);
    }
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">max</span>() {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>];
    }
    <span class="hljs-keyword">set</span> <span class="hljs-title function_">max</span>(<span class="hljs-params">v</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>] = v;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">min</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">min</span>; <span class="hljs-comment">// this will call the min setter</span>
    }
  }

  <span class="hljs-comment">// #region 添加相机属性的gui界面</span>
  <span class="hljs-keyword">const</span> gui = <span class="hljs-keyword">new</span> <span class="hljs-title function_">GUI</span>();
  gui.<span class="hljs-title function_">add</span>(camera, <span class="hljs-string">"fov"</span>, <span class="hljs-number">1</span>, <span class="hljs-number">180</span>);
  <span class="hljs-keyword">const</span> minMaxGUIHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MinMaxGUIHelper</span>(camera, <span class="hljs-string">"near"</span>, <span class="hljs-string">"far"</span>, <span class="hljs-number">0.1</span>);
  gui.<span class="hljs-title function_">add</span>(minMaxGUIHelper, <span class="hljs-string">"min"</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0.1</span>).<span class="hljs-title function_">name</span>(<span class="hljs-string">"near"</span>);
  gui.<span class="hljs-title function_">add</span>(minMaxGUIHelper, <span class="hljs-string">"max"</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0.1</span>).<span class="hljs-title function_">name</span>(<span class="hljs-string">"far"</span>);

  <span class="hljs-comment">// #endregion</span>

  <span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
  scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-string">"black"</span>);
  scene.<span class="hljs-title function_">add</span>(cameraHelper);

  {
    <span class="hljs-keyword">const</span> planeSize = <span class="hljs-number">40</span>;

    <span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>();
    <span class="hljs-keyword">const</span> texture = loader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"https://threejs.org/manual/examples/resources/images/checker.png"</span>);
    texture.<span class="hljs-property">wrapS</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">RepeatWrapping</span>;
    texture.<span class="hljs-property">wrapT</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">RepeatWrapping</span>;
    texture.<span class="hljs-property">magFilter</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">NearestFilter</span>;
    <span class="hljs-comment">//texture.colorSpace = THREE.SRGBColorSpace;</span>
    <span class="hljs-keyword">const</span> repeats = planeSize / <span class="hljs-number">2</span>;
    texture.<span class="hljs-property">repeat</span>.<span class="hljs-title function_">set</span>(repeats, repeats);

    <span class="hljs-keyword">const</span> planeGeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneGeometry</span>(planeSize, planeSize);
    <span class="hljs-keyword">const</span> planeMat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({
      <span class="hljs-attr">map</span>: texture,
      <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>,
    });
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(planeGeo, planeMat);
    mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * -<span class="hljs-number">0.5</span>;
    scene.<span class="hljs-title function_">add</span>(mesh);
  }

  {
    <span class="hljs-keyword">const</span> cubeSize = <span class="hljs-number">4</span>;
    <span class="hljs-keyword">const</span> cubeGeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(cubeSize, cubeSize, cubeSize);
    <span class="hljs-keyword">const</span> cubeMat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-string">"#8AC"</span> });
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(cubeGeo, cubeMat);
    mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(cubeSize + <span class="hljs-number">1</span>, cubeSize / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);
    scene.<span class="hljs-title function_">add</span>(mesh);
  }

  {
    <span class="hljs-keyword">const</span> sphereRadius = <span class="hljs-number">3</span>;
    <span class="hljs-keyword">const</span> sphereWidthDivisions = <span class="hljs-number">32</span>;
    <span class="hljs-keyword">const</span> sphereHeightDivisions = <span class="hljs-number">16</span>;
    <span class="hljs-keyword">const</span> sphereGeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(
      sphereRadius,
      sphereWidthDivisions,
      sphereHeightDivisions,
    );
    <span class="hljs-keyword">const</span> sphereMat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-string">"#CA8"</span> });
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(sphereGeo, sphereMat);
    mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-sphereRadius - <span class="hljs-number">1</span>, sphereRadius + <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);
    scene.<span class="hljs-title function_">add</span>(mesh);
  }

  {
    <span class="hljs-keyword">const</span> color = <span class="hljs-number">0xffffff</span>;
    <span class="hljs-keyword">const</span> intensity = <span class="hljs-number">3</span>;
    <span class="hljs-keyword">const</span> light = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(color, intensity);
    light.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>);
    light.<span class="hljs-property">target</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-<span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    scene.<span class="hljs-title function_">add</span>(light);
    scene.<span class="hljs-title function_">add</span>(light.<span class="hljs-property">target</span>);
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">resizeRendererToDisplaySize</span>(<span class="hljs-params">renderer</span>) {
    <span class="hljs-keyword">const</span> canvas = renderer.<span class="hljs-property">domElement</span>;
    <span class="hljs-keyword">const</span> width = canvas.<span class="hljs-property">clientWidth</span>;
    <span class="hljs-keyword">const</span> height = canvas.<span class="hljs-property">clientHeight</span>;
    <span class="hljs-keyword">const</span> needResize = canvas.<span class="hljs-property">width</span> !== width || canvas.<span class="hljs-property">height</span> !== height;
    <span class="hljs-keyword">if</span> (needResize) {
      renderer.<span class="hljs-title function_">setSize</span>(width, height, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-keyword">return</span> needResize;
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">resizeRendererToDisplaySize</span>(renderer);

    <span class="hljs-comment">// 启用剪刀函数</span>
    renderer.<span class="hljs-title function_">setScissorTest</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-comment">// #region 视图1 渲染</span>
    <span class="hljs-keyword">const</span> aspect1 = <span class="hljs-title function_">setScissorForElement</span>(view1Elem);
    camera.<span class="hljs-property">aspect</span> = aspect1;
    camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
    <span class="hljs-comment">// 不在视图 1中渲染 helper</span>
    cameraHelper.<span class="hljs-property">visible</span> = <span class="hljs-literal">false</span>;
    cameraHelper.<span class="hljs-title function_">update</span>();
    renderer.<span class="hljs-title function_">render</span>(scene, camera);
    <span class="hljs-comment">// #endregion</span>

    <span class="hljs-comment">// #region 视图2 渲染</span>
    <span class="hljs-keyword">const</span> aspect2 = <span class="hljs-title function_">setScissorForElement</span>(view2Elem);
    camera2.<span class="hljs-property">aspect</span> = aspect2;
    camera2.<span class="hljs-title function_">updateProjectionMatrix</span>();
    <span class="hljs-comment">// 在第二台摄像机中绘制cameraHelper</span>
    cameraHelper.<span class="hljs-property">visible</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// 单独给视图 2 设置个背景色</span>
    scene.<span class="hljs-property">background</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0x000040</span>);
    renderer.<span class="hljs-title function_">render</span>(scene, camera2);

    <span class="hljs-comment">// #endregion</span>

    <span class="hljs-title function_">requestAnimationFrame</span>(render);
  }

  <span class="hljs-title function_">requestAnimationFrame</span>(render);
}

<span class="hljs-title function_">main</span>();

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b62f61666694aaeb584fe439b0173ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z54yr5LiN54Ot:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966269&amp;x-signature=EaB0ieVWLNQ7Ajz6Zkt0DF5irXo%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">正交摄像机<a href="https://link.juejin.cn?target=https%3A%2F%2Fthreejs.org%2Fdocs%2F%23api%2Fzh%2Fcameras%2FOrthographicCamera" target="_blank" title="https://threejs.org/docs/#api/zh/cameras/OrthographicCamera" ref="nofollow noopener noreferrer"><code>OrthographicCamera</code></a></h2>
<p>与透视摄像机不同的是, 它需要设置<code>left</code> <code>right</code> <code>top</code> <code>bottom</code> <code>near</code> 和 <code>far</code> 指定一个长方形, 使得视野是平行的而不是透视的</p>
<p>使用 <code>zoom</code> 属性可以缩放<code>世界 -&gt; 屏幕</code>的映射比例, 不改变实际尺寸</p>
<p><code>&lt; 1</code> 看到更多
<code>&gt; 1</code> 看到更少</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-variable constant_">THREE</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"three"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OrbitControls</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/addons/controls/OrbitControls.js"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">GUI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"three/addons/libs/lil-gui.module.min.js"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#c"</span>);
  <span class="hljs-keyword">const</span> view1Elem = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#view1"</span>);
  <span class="hljs-keyword">const</span> view2Elem = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#view2"</span>);

  <span class="hljs-keyword">const</span> renderer = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">WebGLRenderer</span>({
    <span class="hljs-attr">antialias</span>: <span class="hljs-literal">true</span>,
    canvas,
    <span class="hljs-attr">logarithmicDepthBuffer</span>: <span class="hljs-literal">true</span>,
  });

  <span class="hljs-comment">// #region 左视图的相机</span>
  <span class="hljs-keyword">const</span> size = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">const</span> near = <span class="hljs-number">5</span>;
  <span class="hljs-keyword">const</span> far = <span class="hljs-number">50</span>;
  <span class="hljs-keyword">const</span> camera = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">OrthographicCamera</span>(-size, size, size, -size, near, far);
  camera.<span class="hljs-property">zoom</span> = <span class="hljs-number">0.2</span>;
  camera.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>, <span class="hljs-number">0</span>);
  <span class="hljs-comment">// camera.lookAt(0, 0, 0);</span>
  <span class="hljs-keyword">const</span> cameraHelper = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">CameraHelper</span>(camera);

  <span class="hljs-keyword">const</span> controls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera, view1Elem);
  controls.<span class="hljs-property">target</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
  controls.<span class="hljs-title function_">update</span>();

  <span class="hljs-comment">// #endregion</span>

  <span class="hljs-comment">// #region 右视图的相机</span>
  <span class="hljs-keyword">const</span> camera2 = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PerspectiveCamera</span>(
    <span class="hljs-number">60</span>, <span class="hljs-comment">// fov</span>
    <span class="hljs-number">2</span>, <span class="hljs-comment">// aspect</span>
    <span class="hljs-number">0.1</span>, <span class="hljs-comment">// near</span>
    <span class="hljs-number">500</span>, <span class="hljs-comment">// far</span>
  );
  camera2.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">40</span>, <span class="hljs-number">10</span>, <span class="hljs-number">30</span>);
  camera2.<span class="hljs-title function_">lookAt</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> controls2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrbitControls</span>(camera2, view2Elem);
  controls2.<span class="hljs-property">target</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0</span>);
  controls2.<span class="hljs-title function_">update</span>();

  <span class="hljs-comment">// #endregion</span>

  <span class="hljs-comment">/**
   * 设置裁剪区域和视口, 返回宽高比
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">elem</span>
   * <span class="hljs-doctag">@returns</span>
   */</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">setScissorForElement</span>(<span class="hljs-params">elem</span>) {
    <span class="hljs-comment">// 获取 canvas 与元素的边界矩形</span>
    <span class="hljs-keyword">const</span> canvasRect = canvas.<span class="hljs-title function_">getBoundingClientRect</span>();
    <span class="hljs-keyword">const</span> elemRect = elem.<span class="hljs-title function_">getBoundingClientRect</span>();

    <span class="hljs-comment">// 相对位置计算元素在 canvas 内的左右上下边界</span>
    <span class="hljs-keyword">const</span> right = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(elemRect.<span class="hljs-property">right</span>, canvasRect.<span class="hljs-property">right</span>) - canvasRect.<span class="hljs-property">left</span>;
    <span class="hljs-keyword">const</span> left = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, elemRect.<span class="hljs-property">left</span> - canvasRect.<span class="hljs-property">left</span>);
    <span class="hljs-keyword">const</span> bottom = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(elemRect.<span class="hljs-property">bottom</span>, canvasRect.<span class="hljs-property">bottom</span>) - canvasRect.<span class="hljs-property">top</span>;
    <span class="hljs-keyword">const</span> top = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, elemRect.<span class="hljs-property">top</span> - canvasRect.<span class="hljs-property">top</span>);

    <span class="hljs-keyword">const</span> width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(canvasRect.<span class="hljs-property">width</span>, right - left);
    <span class="hljs-keyword">const</span> height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(canvasRect.<span class="hljs-property">height</span>, bottom - top);

    <span class="hljs-comment">// 设置裁剪</span>
    <span class="hljs-keyword">const</span> positiveYUpBottom = canvasRect.<span class="hljs-property">height</span> - bottom;

    <span class="hljs-comment">// 对 renderer 设置裁剪区域和视口</span>
    renderer.<span class="hljs-title function_">setScissor</span>(left, positiveYUpBottom, width, height);
    renderer.<span class="hljs-title function_">setViewport</span>(left, positiveYUpBottom, width, height);

    <span class="hljs-keyword">return</span> width / height;
  }

  <span class="hljs-comment">// gui 使用,限制对象中属性的最大值最小值</span>
  <span class="hljs-keyword">class</span> <span class="hljs-title class_">MinMaxGUIHelper</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">obj, minProp, maxProp, minDif</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span> = obj;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">minProp</span> = minProp;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span> = maxProp;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">minDif</span> = minDif;
    }
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">min</span>() {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">minProp</span>];
    }
    <span class="hljs-keyword">set</span> <span class="hljs-title function_">min</span>(<span class="hljs-params">v</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">minProp</span>] = v;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>], v + <span class="hljs-variable language_">this</span>.<span class="hljs-property">minDif</span>);
    }
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">max</span>() {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>];
    }
    <span class="hljs-keyword">set</span> <span class="hljs-title function_">max</span>(<span class="hljs-params">v</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">obj</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">maxProp</span>] = v;
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">min</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">min</span>; <span class="hljs-comment">// this will call the min setter</span>
    }
  }

  <span class="hljs-comment">// #region 添加相机属性的gui界面</span>
  <span class="hljs-keyword">const</span> gui = <span class="hljs-keyword">new</span> <span class="hljs-title function_">GUI</span>();
  <span class="hljs-comment">// gui.add(camera, "fov", 1, 180);</span>
  <span class="hljs-keyword">const</span> minMaxGUIHelper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MinMaxGUIHelper</span>(camera, <span class="hljs-string">"near"</span>, <span class="hljs-string">"far"</span>, <span class="hljs-number">0.1</span>);
  gui.<span class="hljs-title function_">add</span>(minMaxGUIHelper, <span class="hljs-string">"min"</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0.1</span>).<span class="hljs-title function_">name</span>(<span class="hljs-string">"near"</span>);
  gui.<span class="hljs-title function_">add</span>(minMaxGUIHelper, <span class="hljs-string">"max"</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">50</span>, <span class="hljs-number">0.1</span>).<span class="hljs-title function_">name</span>(<span class="hljs-string">"far"</span>);
  gui.<span class="hljs-title function_">add</span>(camera, <span class="hljs-string">"zoom"</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">1</span>).<span class="hljs-title function_">name</span>(<span class="hljs-string">"zoom"</span>).<span class="hljs-title function_">listen</span>(); <span class="hljs-comment">// 调整相机展现多少单位大小</span>

  <span class="hljs-comment">// #endregion</span>

  <span class="hljs-keyword">const</span> scene = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Scene</span>();
  scene.<span class="hljs-property">background</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Color</span>(<span class="hljs-string">"black"</span>);
  scene.<span class="hljs-title function_">add</span>(cameraHelper);

  {
    <span class="hljs-keyword">const</span> planeSize = <span class="hljs-number">40</span>;

    <span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">TextureLoader</span>();
    <span class="hljs-keyword">const</span> texture = loader.<span class="hljs-title function_">load</span>(<span class="hljs-string">"https://threejs.org/manual/examples/resources/images/checker.png"</span>);
    texture.<span class="hljs-property">wrapS</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">RepeatWrapping</span>;
    texture.<span class="hljs-property">wrapT</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">RepeatWrapping</span>;
    texture.<span class="hljs-property">magFilter</span> = <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">NearestFilter</span>;
    <span class="hljs-comment">//texture.colorSpace = THREE.SRGBColorSpace;</span>
    <span class="hljs-keyword">const</span> repeats = planeSize / <span class="hljs-number">2</span>;
    texture.<span class="hljs-property">repeat</span>.<span class="hljs-title function_">set</span>(repeats, repeats);

    <span class="hljs-keyword">const</span> planeGeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">PlaneGeometry</span>(planeSize, planeSize);
    <span class="hljs-keyword">const</span> planeMat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({
      <span class="hljs-attr">map</span>: texture,
      <span class="hljs-attr">side</span>: <span class="hljs-variable constant_">THREE</span>.<span class="hljs-property">DoubleSide</span>,
    });
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(planeGeo, planeMat);
    mesh.<span class="hljs-property">rotation</span>.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * -<span class="hljs-number">0.5</span>;
    scene.<span class="hljs-title function_">add</span>(mesh);
  }

  {
    <span class="hljs-keyword">const</span> cubeSize = <span class="hljs-number">4</span>;
    <span class="hljs-keyword">const</span> cubeGeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">BoxGeometry</span>(cubeSize, cubeSize, cubeSize);
    <span class="hljs-keyword">const</span> cubeMat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-string">"#8AC"</span> });
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(cubeGeo, cubeMat);
    mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(cubeSize + <span class="hljs-number">1</span>, cubeSize / <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);
    scene.<span class="hljs-title function_">add</span>(mesh);
  }

  {
    <span class="hljs-keyword">const</span> sphereRadius = <span class="hljs-number">3</span>;
    <span class="hljs-keyword">const</span> sphereWidthDivisions = <span class="hljs-number">32</span>;
    <span class="hljs-keyword">const</span> sphereHeightDivisions = <span class="hljs-number">16</span>;
    <span class="hljs-keyword">const</span> sphereGeo = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">SphereGeometry</span>(
      sphereRadius,
      sphereWidthDivisions,
      sphereHeightDivisions,
    );
    <span class="hljs-keyword">const</span> sphereMat = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">MeshPhongMaterial</span>({ <span class="hljs-attr">color</span>: <span class="hljs-string">"#CA8"</span> });
    <span class="hljs-keyword">const</span> mesh = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">Mesh</span>(sphereGeo, sphereMat);
    mesh.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-sphereRadius - <span class="hljs-number">1</span>, sphereRadius + <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);
    scene.<span class="hljs-title function_">add</span>(mesh);
  }

  {
    <span class="hljs-keyword">const</span> color = <span class="hljs-number">0xffffff</span>;
    <span class="hljs-keyword">const</span> intensity = <span class="hljs-number">3</span>;
    <span class="hljs-keyword">const</span> light = <span class="hljs-keyword">new</span> <span class="hljs-variable constant_">THREE</span>.<span class="hljs-title class_">DirectionalLight</span>(color, intensity);
    light.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">0</span>);
    light.<span class="hljs-property">target</span>.<span class="hljs-property">position</span>.<span class="hljs-title function_">set</span>(-<span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    scene.<span class="hljs-title function_">add</span>(light);
    scene.<span class="hljs-title function_">add</span>(light.<span class="hljs-property">target</span>);
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">resizeRendererToDisplaySize</span>(<span class="hljs-params">renderer</span>) {
    <span class="hljs-keyword">const</span> canvas = renderer.<span class="hljs-property">domElement</span>;
    <span class="hljs-keyword">const</span> width = canvas.<span class="hljs-property">clientWidth</span>;
    <span class="hljs-keyword">const</span> height = canvas.<span class="hljs-property">clientHeight</span>;
    <span class="hljs-keyword">const</span> needResize = canvas.<span class="hljs-property">width</span> !== width || canvas.<span class="hljs-property">height</span> !== height;
    <span class="hljs-keyword">if</span> (needResize) {
      renderer.<span class="hljs-title function_">setSize</span>(width, height, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-keyword">return</span> needResize;
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">resizeRendererToDisplaySize</span>(renderer);

    <span class="hljs-comment">// 启用剪刀函数</span>
    renderer.<span class="hljs-title function_">setScissorTest</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-comment">// #region 视图1 渲染</span>
    <span class="hljs-keyword">const</span> aspect1 = <span class="hljs-title function_">setScissorForElement</span>(view1Elem);
    camera.<span class="hljs-property">left</span> = -aspect1;
    camera.<span class="hljs-property">right</span> = aspect1;
    camera.<span class="hljs-title function_">updateProjectionMatrix</span>();
    <span class="hljs-comment">// 不在视图 1中渲染 helper</span>
    cameraHelper.<span class="hljs-property">visible</span> = <span class="hljs-literal">false</span>;
    cameraHelper.<span class="hljs-title function_">update</span>();
    renderer.<span class="hljs-title function_">render</span>(scene, camera);
    <span class="hljs-comment">// #endregion</span>

    <span class="hljs-comment">// #region 视图2 渲染</span>
    <span class="hljs-keyword">const</span> aspect2 = <span class="hljs-title function_">setScissorForElement</span>(view2Elem);
    camera2.<span class="hljs-property">aspect</span> = aspect2;
    camera2.<span class="hljs-title function_">updateProjectionMatrix</span>();
    <span class="hljs-comment">// 在第二台摄像机中绘制cameraHelper</span>
    cameraHelper.<span class="hljs-property">visible</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-comment">// 单独给视图 2 设置个背景色</span>
    scene.<span class="hljs-property">background</span>.<span class="hljs-title function_">set</span>(<span class="hljs-number">0x000040</span>);
    renderer.<span class="hljs-title function_">render</span>(scene, camera2);

    <span class="hljs-comment">// #endregion</span>

    <span class="hljs-title function_">requestAnimationFrame</span>(render);
  }

  <span class="hljs-title function_">requestAnimationFrame</span>(render);
}

<span class="hljs-title function_">main</span>();


</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74942e32e8464a54b040c8668eb1f636~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6b6Z54yr5LiN54Ot:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966269&amp;x-signature=%2Bph78ht6RnByyveYBi%2Bpc8PJ1ZA%3D" alt="image.png" loading="lazy"/></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DOM 操作实战｜原生 JS 实现 6 个高频交互效果（选项卡 / 轮播图等，附源码 + 注释）]]></title>    <link>https://juejin.cn/post/7603383059150897194</link>    <guid>https://juejin.cn/post/7603383059150897194</guid>    <pubDate>2026-02-06T07:06:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603383059150897194" data-draft-id="7603389033041330230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DOM 操作实战｜原生 JS 实现 6 个高频交互效果（选项卡 / 轮播图等，附源码 + 注释）"/> <meta itemprop="keywords" content="HTML,JavaScript"/> <meta itemprop="datePublished" content="2026-02-06T07:06:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码煮茶"/> <meta itemprop="url" content="https://juejin.cn/user/4197279069639178"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DOM 操作实战｜原生 JS 实现 6 个高频交互效果（选项卡 / 轮播图等，附源码 + 注释）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4197279069639178/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码煮茶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:06:04.000Z" title="Fri Feb 06 2026 07:06:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、实战前言</h3>
<p>DOM 操作是前端开发的核心基础，无论是业务开发还是框架底层，都离不开对页面元素的增删改查、事件绑定、样式修改。很多新手入门后直接学习 Vue/React 等框架，忽略了原生 DOM 操作，导致遇到框架底层问题、原生开发需求时无从下手。</p>
<p>本次实战将用纯原生 HTML+CSS+JS实现前端开发中6 个高频 DOM 交互效果，覆盖点击、鼠标悬浮、轮播、表单交互等核心场景，所有案例均遵循 <strong>「结构搭建→样式美化→JS 交互」三步法，代码附带详细注释，同时讲解DOM 核心 API</strong>、事件处理技巧和新手避坑点，实现后的代码可直接复制到项目中使用，无需依赖任何框架。</p>
<h3 data-id="heading-1">二、前置准备</h3>
<ol>
<li>工具要求：仅需 VS Code（搭配 HTML/CSS/JS 高亮插件）+ 浏览器（Chrome/Firefox），无需额外环境和依赖</li>
<li>基础储备：了解 HTML 基本标签、CSS 基础样式（浮动 / 弹性布局）、JS 基础语法（变量 / 函数 / 条件判断），零基础可跟随步骤，核心 API 会逐行讲解</li>
<li>实现原则：结构与样式与行为分离（HTML 写结构、CSS 写样式、JS 写交互），代码解耦易维护；兼容主流浏览器，考虑边界场景（如无数据、高频点击）</li>
<li>核心 DOM API：本次实战会用到的高频 API，提前梳理方便理解</li>
</ol>
<ul>
<li>元素获取：querySelector/querySelectorAll（精准获取单个 / 多个元素）</li>
<li>事件绑定：addEventListener（推荐，可绑定多个事件，支持事件移除）</li>
<li>样式修改：style（行内样式）/classList（类名操作，推荐）</li>
<li>节点操作：createElement/appendChild（创建 / 添加节点）</li>
<li>事件对象：e.target（事件源）/e.preventDefault（阻止默认行为）</li>
</ul>
<h3 data-id="heading-2">三、实战说明</h3>
<p>本次实现的 6 个 DOM 交互效果覆盖 80% 的前端基础交互场景，难度由浅入深，从简单的点击切换到复杂的自动轮播，逐步提升 DOM 操作能力：</p>
<ol>
<li>基础点击类：选项卡切换（点击切换内容）、手风琴折叠（点击展开 / 折叠）</li>
<li>鼠标悬浮类：导航栏悬浮高亮、商品卡片悬浮效果（含动画）</li>
<li>自动轮播类：简易轮播图（自动播放 + 点击切换 + 鼠标暂停）</li>
<li>表单交互类：表单非空验证（提交前校验 + 实时提示）</li>
</ol>
<h3 data-id="heading-3">四、分步实现（结构 + 样式 + JS，逐一拆解）</h3>
<p>所有案例均提供完整可运行代码，复制到 VS Code 中保存为.html文件，直接用浏览器打开即可看到效果。</p>
<h3 data-id="heading-4">案例 1：选项卡切换（点击切换内容，高频基础交互）</h3>
<p>适用场景：后台管理系统、商品详情页、资讯页面的内容切换，前端基础面试高频考点核心逻辑：给所有选项绑定点击事件，点击时给当前选项添加高亮类，移除其他选项的高亮类；同时根据选项索引，显示对应内容，隐藏其他内容。</p>
<h3 data-id="heading-5">完整代码</h3>
<p><span href="https://code.juejin.cn/pen/7603641533250142258" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7603641533250142258" data-src="https://code.juejin.cn/pen/7603641533250142258" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h5 data-id="heading-6">核心知识点 &amp; 避坑点</h5>
<ol>
<li><strong>类名操作推荐<code>classList</code></strong>：替代直接修改<code>className</code>，避免覆盖原有类名，支持<code>add/remove/toggle/contains</code>方法</li>
<li><strong><code>querySelectorAll</code>返回伪数组</strong>：可直接用<code>forEach</code>遍历，比<code>getElementsByTagName</code>更灵活（支持 CSS 选择器）</li>
<li><strong>索引匹配</strong>：利用<code>forEach</code>的第二个参数<code>index</code>，实现选项和内容的一一对应，无需手动设置自定义属性</li>
<li><strong>避坑</strong>：不要用<code>onclick</code>绑定事件（一次只能绑定一个，会被覆盖），优先使用<code>addEventListener</code></li>
</ol>
<h4 data-id="heading-7">案例 2：手风琴折叠（点击展开 / 折叠，移动端高频）</h4>
<p><strong>适用场景</strong>：移动端导航、FAQ 常见问题、侧边栏分类，核心是<strong>单开 / 多开</strong>折叠控制<strong>核心逻辑</strong>：给所有折叠项绑定点击事件，点击时切换当前项内容的显示 / 隐藏（通过类名控制高度）；单开模式下，先折叠所有内容，再展开当前内容。</p>
<h5 data-id="heading-8">完整代码</h5>
<p><span href="https://code.juejin.cn/pen/7603642291110838282" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7603642291110838282" data-src="https://code.juejin.cn/pen/7603642291110838282" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h5 data-id="heading-9">核心知识点 &amp; 避坑点</h5>
<ol>
<li><strong>过渡动画</strong>：通过<code>transition</code>给<code>height</code>添加过渡，实现平滑的展开 / 折叠，替代<code>display: none/block</code>（无动画）</li>
<li><strong>单开 / 多开切换</strong>：单开先移除所有高亮类，再添加当前；多开直接用<code>toggle</code>切换当前项的类名，一行代码实现</li>
<li><strong>父元素获取</strong>：通过<code>this.parentElement</code>获取当前标题的父元素（折叠项），无需额外获取，简化代码</li>
<li><strong>避坑</strong>：不要直接修改<code>style.height</code>为<code>auto</code>，过渡动画会失效，需设置固定高度或通过<code>scrollHeight</code>获取真实高度（适配动态内容）</li>
</ol>
<h4 data-id="heading-10">案例 3：导航栏悬浮高亮（鼠标悬浮 + 点击选中，通用导航）</h4>
<p><strong>适用场景</strong>：网站顶部导航、侧边栏导航，结合<strong>鼠标悬浮</strong>和<strong>点击选中</strong>双交互，提升用户体验<strong>核心逻辑</strong>：鼠标悬浮时，给当前导航项添加悬浮高亮类，离开时移除；点击时，给当前项添加选中类，移除其他项的选中类，选中状态持久化。</p>
<h5 data-id="heading-11">完整代码</h5>
<p><span href="https://code.juejin.cn/pen/7603642758038519846" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7603642758038519846" data-src="https://code.juejin.cn/pen/7603642758038519846" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h5 data-id="heading-12">核心知识点 &amp; 避坑点</h5>
<ol>
<li><strong>阻止默认行为</strong>：通过<code>e.preventDefault()</code>阻止 a 标签的默认跳转，适配纯前端导航（无实际链接）</li>
<li><strong>样式优先级</strong>：选中类样式高于悬浮类，通过<code>contains</code>判断是否为选中项，避免悬浮样式覆盖选中样式</li>
<li><strong>鼠标事件</strong>：<code>mouseenter/mouseleave</code>（不冒泡）优于<code>mouseover/mouseout</code>（冒泡），避免子元素触发父元素事件</li>
<li><strong>避坑</strong>：不要给 a 标签设置<code>href="#"</code>，点击会导致页面跳转到顶部，用<code>href="javascript:;"</code>更友好</li>
</ol>
<h4 data-id="heading-13">案例 4：商品卡片悬浮效果（含动画，电商高频）</h4>
<p><strong>适用场景</strong>：电商网站商品列表、资讯卡片、产品展示，结合<strong>样式动画</strong>和<strong>DOM 鼠标事件</strong>，提升页面质感<strong>核心逻辑</strong>：鼠标悬浮在卡片上时，通过<code>classList</code>添加悬浮类，实现卡片上移、阴影放大、显示遮罩层；鼠标离开时移除悬浮类，恢复原样式，所有效果通过 CSS 过渡实现，JS 仅做类名切换。</p>
<h5 data-id="heading-14">完整代码</h5>
<p><span href="https://code.juejin.cn/pen/7603643319142662153" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7603643319142662153" data-src="https://code.juejin.cn/pen/7603643319142662153" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h5 data-id="heading-15">核心知识点 &amp; 避坑点</h5>
<ol>
<li><strong>样式与行为分离</strong>：JS 仅负责类名切换，所有动画和样式由 CSS 实现，符合前端开发规范，便于维护</li>
<li><strong>CSS 过渡</strong>：给<code>card</code>添加<code>transition: all 0.3s ease</code>，实现所有样式的平滑过渡，包括<code>transform</code>、<code>box-shadow</code>、<code>opacity</code></li>
<li><strong>绝对定位</strong>：遮罩层通过<code>position: absolute</code>脱离文档流，相对于卡片（<code>relative</code>）定位，实现全屏遮罩</li>
<li><strong>避坑</strong>：给卡片添加<code>overflow: hidden</code>，避免卡片上移时超出容器，同时防止图片圆角失效</li>
</ol>
<h4 data-id="heading-16">案例 5：简易轮播图（自动播放 + 点击切换 + 鼠标暂停，高频核心）</h4>
<p><strong>适用场景</strong>：网站首页轮播、广告展示、图片集，前端 DOM 实战高频考点，融合<strong>定时器</strong>、<strong>事件绑定</strong>、<strong>样式切换</strong>核心知识点<strong>核心逻辑</strong>：通过定时器实现图片自动轮播（修改索引，切换图片和指示器）；点击左右按钮切换上一张 / 下一张（索引加减，边界判断）；点击指示器跳转到对应图片；鼠标悬浮在轮播图上暂停定时器，离开后恢复。</p>
<h5 data-id="heading-17">完整代码</h5>
<p><span href="https://code.juejin.cn/pen/7603643841714847770" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7603643841714847770" data-src="https://code.juejin.cn/pen/7603643841714847770" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h5 data-id="heading-18">核心知识点 &amp; 避坑点</h5>
<ol>
<li><strong>定时器管理</strong>：用变量保存定时器 ID，方便暂停和恢复，避免多个定时器同时运行</li>
<li><strong>边界判断</strong>：切换索引时判断是否超出范围，实现轮播循环（最后一张切到第一张，第一张切到最后一张）</li>
<li><strong>样式移动</strong>：通过修改<code>left</code>值实现图片横向滑动，结合<code>transition</code>实现平滑动画，比<code>display</code>更友好</li>
<li><strong>事件委托</strong>：轮播图的所有子元素（按钮、指示器、图片）的鼠标事件，都可以绑定在父容器上，减少事件绑定数量</li>
<li><strong>避坑</strong>：给轮播容器添加<code>overflow: hidden</code>，隐藏超出的图片；图片容器的宽度要设置为<code>单张宽度*图片数量</code>，确保横向排列</li>
</ol>
<h4 data-id="heading-19">案例 6：表单非空验证（实时提示 + 提交校验，业务高频）</h4>
<p><strong>适用场景</strong>：登录 / 注册表单、留言表单、提交表单，前端基础校验，减少无效接口请求，提升用户体验<strong>核心逻辑</strong>：给输入框绑定<code>input</code>实时事件，输入时校验是否为空，实时显示提示信息；给表单绑定<code>submit</code>提交事件，提交前校验所有必填项，若有未填项阻止提交并提示，全部填完则提交成功。</p>
<h5 data-id="heading-20">完整代码</h5>
<p><span href="https://code.juejin.cn/pen/7603644243231866926" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7603644243231866926" data-src="https://code.juejin.cn/pen/7603644243231866926" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h5 data-id="heading-21">核心知识点 &amp; 避坑点</h5>
<ol>
<li><strong>通用函数封装</strong>：将非空校验逻辑封装为<code>checkInput</code>函数，避免重复代码，便于维护和拓展（如后续添加长度校验、格式校验）</li>
<li><strong>实时校验</strong>：绑定<code>input</code>事件，输入时实时校验，比<code>blur</code>（失去焦点）更友好，提升用户体验</li>
<li><strong>表单提交事件</strong>：绑定<code>form</code>的<code>submit</code>事件，而非按钮的<code>click</code>事件，兼容回车键提交，更符合表单交互规范</li>
<li><strong>阻止默认提交</strong>：提交前必须用<code>e.preventDefault()</code>阻止默认行为，先完成前端校验，再执行接口请求或手动提交</li>
<li><strong>避坑</strong>：校验时要使用<code>trim()</code>去除输入框的首尾空格，避免用户输入空格视为非空；密码框用<code>type="password"</code>，保证安全性</li>
</ol>
<h3 data-id="heading-22">五、DOM 操作核心技巧与避坑总结</h3>
<h4 data-id="heading-23">核心技巧</h4>
<ol>
<li><strong>元素获取</strong>：优先使用<code>querySelector/querySelectorAll</code>，支持 CSS 选择器，精准且灵活，替代老旧的<code>getElementById/getElementsByClassName</code></li>
<li><strong>事件绑定</strong>：优先使用<code>addEventListener</code>，支持多事件绑定、事件移除，避免<code>onxxx</code>的覆盖问题；利用<strong>事件委托</strong>减少事件绑定数量（将子元素事件绑定到父元素）</li>
<li><strong>样式修改</strong>：优先使用<code>classList</code>操作类名，分离样式和行为，避免直接修改<code>style</code>（行内样式难维护，覆盖优先级高）</li>
<li><strong>函数封装</strong>：将重复的 DOM 操作逻辑封装为通用函数（如表单校验、类名切换），提升代码复用性和可维护性</li>
<li><strong>事件对象</strong>：熟练使用<code>e.target</code>（事件源）、<code>e.preventDefault</code>（阻止默认行为）、<code>e.stopPropagation</code>（阻止事件冒泡），解决交互中的各种问题</li>
<li><strong>定时器管理</strong>：用变量保存定时器 ID，及时清除定时器，避免内存泄漏和多次执行（如轮播图的暂停 / 恢复）</li>
</ol>
<h4 data-id="heading-24">新手常踩避坑点</h4>
<ol>
<li><strong>元素获取时机</strong>：在 DOM 节点渲染完成后再获取元素，避免获取到<code>null</code>（将 JS 写在<code>body</code>底部或使用<code>DOMContentLoaded</code>事件）</li>
<li><strong>伪数组遍历</strong>：<code>querySelectorAll</code>返回的是伪数组，可直接用<code>forEach</code>遍历，不能直接使用数组的<code>push/pop</code>方法</li>
<li><strong>this 指向问题</strong>：在箭头函数中，<code>this</code>指向父级作用域，而非事件触发的元素，事件处理函数优先使用普通函数</li>
<li><strong>样式覆盖</strong>：直接修改<code>style</code>会覆盖行内样式，优先使用类名切换；多个样式冲突时，利用 CSS 优先级解决（如选中类高于悬浮类）</li>
<li><strong>默认行为未阻止</strong>：a 标签、表单、按钮等有默认行为，交互时需用<code>e.preventDefault()</code>阻止，避免页面跳转或表单默认提交</li>
<li><strong>内存泄漏</strong>：及时移除事件监听、清除定时器、释放无用的 DOM 节点引用，避免页面长时间运行后性能下降</li>
</ol>
<h3 data-id="heading-25">六、拓展延伸（新手进阶方向）</h3>
<ol>
<li><strong>事件委托进阶</strong>：将所有子元素的事件绑定到父容器，利用<code>e.target</code>判断事件源，实现动态添加节点的事件绑定（如动态添加的商品卡片自动拥有悬浮效果）</li>
<li><strong>DOM 节点动态操作</strong>：用<code>createElement/appendChild/removeChild</code>实现动态添加 / 删除 DOM 节点（如动态添加表单项、商品卡片）</li>
<li><strong>表单校验拓展</strong>：在非空校验基础上，添加手机号、邮箱、密码强度、验证码等格式校验，封装为通用表单校验库</li>
<li><strong>轮播图升级</strong>：实现无缝轮播、触摸滑动（适配移动端）、图片预加载、轮播速度可配置等功能，打造通用轮播图组件</li>
<li><strong>本地存储结合</strong>：将表单数据、选中状态、轮播索引等保存到<code>localStorage/sessionStorage</code>，实现页面刷新后状态持久化</li>
<li><strong>封装通用组件</strong>：将 6 个案例封装为可复用的原生 JS 组件，通过参数配置（如轮播图速度、卡片宽度、表单校验规则）适配不同业务场景</li>
<li><strong>跨浏览器兼容</strong>：添加低版本浏览器的兼容代码（如<code>classList</code>的 polyfill、<code>forEach</code>的兼容），适配 IE11 等老旧浏览器</li>
</ol>
<h3 data-id="heading-26">七、总结</h3>
<p>本次实战用纯原生 HTML+CSS+JS 实现了<strong>6 个前端高频 DOM 交互效果</strong>，覆盖了点击、鼠标悬浮、自动轮播、表单交互等核心场景，所有案例均遵循<strong>结构与样式与行为分离</strong>的开发原则，代码简洁、注释详细，可直接复制到项目中使用。</p>
<p>通过本次实战，不仅能熟练掌握<strong>DOM 增删改查、事件绑定、样式修改</strong>等核心 API，还能理解前端交互的底层逻辑，掌握<strong>函数封装、代码解耦、边界处理</strong>的开发思维 —— 这些能力是学习 Vue/React 等框架的基础，也是前端开发和面试的核心要求。</p>
<p>所有案例的难度由浅入深，新手可跟随步骤逐一实现，在实现过程中理解每个 API 的使用场景和技巧，同时避开新手常踩的坑，逐步提升原生 DOM 操作能力，为后续前端开发打下坚实的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RIL 异步处理模型和命令队列详解]]></title>    <link>https://juejin.cn/post/7603359026710839306</link>    <guid>https://juejin.cn/post/7603359026710839306</guid>    <pubDate>2026-02-06T07:10:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603359026710839306" data-draft-id="7603261102795882522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RIL 异步处理模型和命令队列详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T07:10:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RIL 异步处理模型和命令队列详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:10:47.000Z" title="Fri Feb 06 2026 07:10:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>RIL处理命令和响应的方式是确保通信顺畅的关键。RIL实现了一个异步处理模型，命令发送和响应接收是分开进行的。命令发送之后，RIL等待无线模块的响应，响应到来时，RIL会根据响应数据的内容进行相应的处理。当有多个命令需要执行时，RIL会使用队列管理这些命令，确保它们按顺序执行。</p>
<p>处理命令和响应的过程大致如下：</p>
<p>命令队列 ：所有待发送的命令放入队列中。</p>
<p>异步发送 ：从队列中取出命令，并异步发送给硬件模块。</p>
<p>响应监听 ：RIL监听来自硬件模块的响应。</p>
<p>结果回调 ：当响应到达时，RIL将结果回调给发起请求的应用程序。</p>
<h3 data-id="heading-0">1. <strong>核心数据结构</strong></h3>
<h4 data-id="heading-1">RequestInfo 结构体（待发送的命令信息）</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 来自 ril.cpp 第 126 行</span>
<span class="hljs-type">static</span> <span class="hljs-type">pthread_mutex_t</span> s_pendingRequestsMutex = PTHREAD_MUTEX_INITIALIZER;
<span class="hljs-type">static</span> RequestInfo *s_pendingRequests = <span class="hljs-literal">NULL</span>;  <span class="hljs-comment">// 待处理请求的链表头</span>
</code></pre>
<p><strong>RequestInfo 包含：</strong></p>
<ul>
<li><code>token</code> - 唯一标识符，用于匹配请求和响应</li>
<li><code>pCI</code> - 指向 CommandInfo 结构体的指针</li>
<li><code>socket_id</code> - SIM 卡 ID（多卡支持）</li>
<li><code>p_next</code> - 链表指针，指向下一个待处理请求</li>
<li><code>wasAckSent</code> - 标志异步确认是否已发送</li>
</ul>
<h4 data-id="heading-2">多 SIM 卡支持</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 多 SIM 卡的独立队列</span>
<span class="hljs-meta">#<span class="hljs-keyword">if</span> (SIM_COUNT &gt;= 2)</span>
<span class="hljs-type">static</span> <span class="hljs-type">pthread_mutex_t</span> s_pendingRequestsMutex_socket2  = PTHREAD_MUTEX_INITIALIZER;
<span class="hljs-type">static</span> RequestInfo *s_pendingRequests_socket2          = <span class="hljs-literal">NULL</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">if</span> (SIM_COUNT &gt;= 3)</span>
<span class="hljs-type">static</span> <span class="hljs-type">pthread_mutex_t</span> s_pendingRequestsMutex_socket3  = PTHREAD_MUTEX_INITIALIZER;
<span class="hljs-type">static</span> RequestInfo *s_pendingRequests_socket3          = <span class="hljs-literal">NULL</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
<span class="hljs-comment">// ...</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">2. <strong>命令队列的完整流程</strong></h3>
<h4 data-id="heading-4">步骤 1: 命令入队 - <code>addRequestToList()</code></h4>
<pre><code class="hljs language-c" lang="c">RequestInfo *
<span class="hljs-title function_">addRequestToList</span><span class="hljs-params">(<span class="hljs-type">int</span> serial, <span class="hljs-type">int</span> slotId, <span class="hljs-type">int</span> request)</span> {
    RequestInfo *pRI;
    <span class="hljs-type">int</span> ret;
    RIL_SOCKET_ID socket_id = (RIL_SOCKET_ID) slotId;
    
    <span class="hljs-comment">// 根据 slotId 选择对应的互斥锁和队列</span>
    <span class="hljs-type">pthread_mutex_t</span>* pendingRequestsMutexHook = &amp;s_pendingRequestsMutex;
    RequestInfo** pendingRequestsHook = &amp;s_pendingRequests;
    
    <span class="hljs-keyword">if</span> (socket_id == RIL_SOCKET_2) {
        pendingRequestsMutexHook = &amp;s_pendingRequestsMutex_socket2;
        pendingRequestsHook = &amp;s_pendingRequests_socket2;
    }
    <span class="hljs-comment">// ... 其他 SIM 卡处理 ...</span>
    
    <span class="hljs-comment">// 分配内存并初始化 RequestInfo</span>
    pRI = (RequestInfo *)<span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(RequestInfo));
    <span class="hljs-keyword">if</span> (pRI == <span class="hljs-literal">NULL</span>) {
        RLOGE(<span class="hljs-string">"Memory allocation failed for request %s"</span>, requestToString(request));
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
    }
    
    <span class="hljs-comment">// 保存请求信息</span>
    pRI-&gt;token = serial;              <span class="hljs-comment">// 唯一标识</span>
    pRI-&gt;pCI = &amp;(s_commands[request]); <span class="hljs-comment">// 命令定义</span>
    pRI-&gt;socket_id = socket_id;        <span class="hljs-comment">// SIM 卡 ID</span>
    
    <span class="hljs-comment">// 原子操作：将请求添加到队列头部</span>
    ret = pthread_mutex_lock(pendingRequestsMutexHook);
    assert (ret == <span class="hljs-number">0</span>);
    
    pRI-&gt;p_next = *pendingRequestsHook;  <span class="hljs-comment">// 新请求指向原来的头</span>
    *pendingRequestsHook = pRI;          <span class="hljs-comment">// 新请求成为新的头</span>
    
    ret = pthread_mutex_unlock(pendingRequestsMutexHook);
    assert (ret == <span class="hljs-number">0</span>);
    
    <span class="hljs-keyword">return</span> pRI;  <span class="hljs-comment">// 返回用作 token</span>
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>使用<strong>互斥锁</strong>保护共享数据结构</li>
<li>使用<strong>链表</strong>（LIFO - 后进先出）存储待处理请求</li>
<li><code>token</code> 就是返回的 <code>RequestInfo</code> 指针本身</li>
</ul>
<hr/>
<h4 data-id="heading-5">步骤 2: 异步发送命令</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ril_service.cpp 中的命令分发</span>
<span class="hljs-type">bool</span> <span class="hljs-title function_">dispatchVoid</span><span class="hljs-params">(<span class="hljs-type">int</span> serial, <span class="hljs-type">int</span> slotId, <span class="hljs-type">int</span> request)</span> {
    <span class="hljs-comment">// 1. 将请求加入队列（创建 RequestInfo）</span>
    RequestInfo *pRI = android::addRequestToList(serial, slotId, request);
    <span class="hljs-keyword">if</span> (pRI == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 2. 异步发送给硬件模块</span>
    CALL_ONREQUEST(request, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>, pRI, slotId);
    <span class="hljs-comment">// 这会调用到 vendor RIL 实现（如 QCRIL）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>实际调用链：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">dispatchVoid</span>()
    → <span class="hljs-built_in">addRequestToList</span>() 创建 RequestInfo 并加入队列
    → <span class="hljs-built_in">CALL_ONREQUEST</span>() 调用 s_vendorFunctions-&gt;<span class="hljs-built_in">onRequest</span>()
        → vendor RIL (QCRIL) 处理请求
            → 与硬件模块通信
                → 等待响应...
</code></pre>
<hr/>
<h4 data-id="heading-6">步骤 3: 响应监听和回调 - <code>RIL_onRequestComplete()</code></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-type">void</span>
<span class="hljs-title function_">RIL_onRequestComplete</span><span class="hljs-params">(RIL_Token t, RIL_Errno e, <span class="hljs-type">void</span> *response, <span class="hljs-type">size_t</span> responselen)</span> {
    RequestInfo *pRI;
    <span class="hljs-type">int</span> ret;
    RIL_SOCKET_ID socket_id = RIL_SOCKET_1;
    
    pRI = (RequestInfo *)t;  <span class="hljs-comment">// 从 token 恢复 RequestInfo</span>
    
    <span class="hljs-comment">// 从队列中移除该请求</span>
    <span class="hljs-keyword">if</span> (!checkAndDequeueRequestInfoIfAck(pRI, <span class="hljs-literal">false</span>)) {
        RLOGE (<span class="hljs-string">"RIL_onRequestComplete: invalid RIL_Token"</span>);
        <span class="hljs-keyword">return</span>;
    }
    
    socket_id = pRI-&gt;socket_id;
    
    <span class="hljs-comment">// ... 异常处理 ...</span>
    
    <span class="hljs-keyword">if</span> (pRI-&gt;cancelled == <span class="hljs-number">0</span>) {
        <span class="hljs-type">int</span> responseType;
        
        <span class="hljs-comment">// 判断响应类型</span>
        <span class="hljs-keyword">if</span> (s_callbacks.version &gt;= <span class="hljs-number">13</span> &amp;&amp; pRI-&gt;wasAckSent == <span class="hljs-number">1</span>) {
            <span class="hljs-comment">// 异步响应：先前发送过 ack，现在发送最终响应</span>
            responseType = RESPONSE_SOLICITED_ACK_EXP;
            grabPartialWakeLock();  <span class="hljs-comment">// 获取 wake lock</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 同步响应</span>
            responseType = RESPONSE_SOLICITED;
        }
        
        <span class="hljs-comment">// 调用响应函数，返回给 Java 层</span>
        ret = pRI-&gt;pCI-&gt;responseFunction((<span class="hljs-type">int</span>) socket_id,
                responseType, pRI-&gt;token, e, response, responselen);
    }
    
    <span class="hljs-comment">// 释放内存</span>
    <span class="hljs-built_in">free</span>(pRI);
}
</code></pre>
<hr/>
<h4 data-id="heading-7">步骤 4: 移除请求 - <code>checkAndDequeueRequestInfoIfAck()</code></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">int</span>
<span class="hljs-title function_">checkAndDequeueRequestInfoIfAck</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> RequestInfo *pRI, <span class="hljs-type">bool</span> isAck)</span> {
    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;
    <span class="hljs-type">pthread_mutex_t</span>* pendingRequestsMutexHook = &amp;s_pendingRequestsMutex;
    RequestInfo ** pendingRequestsHook = &amp;s_pendingRequests;
    
    <span class="hljs-keyword">if</span> (pRI == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-comment">// 根据 socket_id 选择对应的队列</span>
    <span class="hljs-keyword">if</span> (pRI-&gt;socket_id == RIL_SOCKET_2) {
        pendingRequestsMutexHook = &amp;s_pendingRequestsMutex_socket2;
        pendingRequestsHook = &amp;s_pendingRequests_socket2;
    }
    <span class="hljs-comment">// ...</span>
    
    pthread_mutex_lock(pendingRequestsMutexHook);
    
    <span class="hljs-comment">// 从链表中查找并移除该请求</span>
    <span class="hljs-keyword">for</span>(RequestInfo **ppCur = pendingRequestsHook
        ; *ppCur != <span class="hljs-literal">NULL</span>
        ; ppCur = &amp;((*ppCur)-&gt;p_next)
    ) {
        <span class="hljs-keyword">if</span> (pRI == *ppCur) {
            ret = <span class="hljs-number">1</span>;
            
            <span class="hljs-keyword">if</span> (isAck) {
                <span class="hljs-comment">// 标记 ack 已发送（用于异步长时间请求）</span>
                pRI-&gt;wasAckSent = <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 从链表中移除该请求</span>
                *ppCur = (*ppCur)-&gt;p_next;
            }
            <span class="hljs-keyword">break</span>;
        }
    }
    
    pthread_mutex_unlock(pendingRequestsMutexHook);
    
    <span class="hljs-keyword">return</span> ret;
}
</code></pre>
<hr/>
<h3 data-id="heading-8">3. <strong>异步处理模型时间线</strong></h3>
<pre><code class="hljs language-vbnet" lang="vbnet">时间轴：

<span class="hljs-symbol">T0:</span> 应用发起请求（如拨号）
    ↓
<span class="hljs-symbol">T1:</span> addRequestToList() 创建 RequestInfo，加入 s_pendingRequests
    │ [RequestInfo 已在队列中]
    ↓
<span class="hljs-symbol">T2:</span> CALL_ONREQUEST() 发送命令给 vendor RIL
    │ [命令异步发送，不等待]
    ↓
<span class="hljs-symbol">T3:</span> Vendor RIL 与硬件通信，处理请求
    │ [可能耗时几秒钟]
    ↓
<span class="hljs-symbol">T4a:</span> 如果支持异步确认 (RIL version &gt;= <span class="hljs-number">13</span>)
    │   → RIL_onRequestAck() 被调用
    │   → pRI-&gt;wasAckSent = <span class="hljs-number">1</span>（标记但不移除）
    │   → 返回 ACK 给应用（让应用知道已收到）
    │
    ↓ (几秒后)
    │
<span class="hljs-symbol">T4b:</span> 硬件响应，回调 RIL_onRequestComplete()
    │ → checkAndDequeueRequestInfoIfAck(pRI, <span class="hljs-literal">false</span>)
    │ → 从 s_pendingRequests 中移除
    │ → 调用 responseFunction() 返回结果给 Java 层
    │ → free(pRI) 释放内存
    ↓
<span class="hljs-symbol">T5:</span> 应用收到最终响应
</code></pre>
<hr/>
<h3 data-id="heading-9">4. <strong>多并发请求的处理</strong></h3>
<p>当多个请求同时到达时：</p>
<pre><code class="hljs language-scss" lang="scss">请求队列状态变化：

初始状态：
s_pendingRequests → NULL

请求 <span class="hljs-number">1</span> (拨号) 到达：
s_pendingRequests → <span class="hljs-selector-attr">[RequestInfo-1]</span> → NULL

请求 <span class="hljs-number">2</span> (获取信号强度) 到达：
s_pendingRequests → <span class="hljs-selector-attr">[RequestInfo-2]</span> → <span class="hljs-selector-attr">[RequestInfo-1]</span> → NULL

请求 <span class="hljs-number">3</span> (设置网络) 到达：
s_pendingRequests → <span class="hljs-selector-attr">[RequestInfo-3]</span> → <span class="hljs-selector-attr">[RequestInfo-2]</span> → <span class="hljs-selector-attr">[RequestInfo-1]</span> → NULL

请求 <span class="hljs-number">2</span> 完成，响应：
<span class="hljs-built_in">checkAndDequeueRequestInfoIfAck</span>(RequestInfo-<span class="hljs-number">2</span>, false)
s_pendingRequests → <span class="hljs-selector-attr">[RequestInfo-3]</span> → <span class="hljs-selector-attr">[RequestInfo-1]</span> → NULL
（RequestInfo-<span class="hljs-number">2</span> 被移除并释放）

请求 <span class="hljs-number">1</span> 完成，响应：
s_pendingRequests → <span class="hljs-selector-attr">[RequestInfo-3]</span> → NULL
</code></pre>
<hr/>
<h3 data-id="heading-10">5. <strong>同步保护机制</strong></h3>
<h4 data-id="heading-11">互斥锁使用</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 关键的互斥保护</span>
pthread_mutex_lock(pendingRequestsMutexHook);
    <span class="hljs-comment">// 原子操作：增加或遍历链表</span>
    pRI-&gt;p_next = *pendingRequestsHook;
    *pendingRequestsHook = pRI;
pthread_mutex_unlock(pendingRequestsMutexHook);
</code></pre>
<p><strong>保护的操作：</strong></p>
<ul>
<li>✓ 添加请求到队列</li>
<li>✓ 查找并移除请求</li>
<li>✓ 遍历列表查找特定请求</li>
</ul>
<hr/>
<h3 data-id="heading-12">6. <strong>异步应答机制（ACK）</strong></h3>
<p>对于耗时较长的请求（如拨号）：</p>
<pre><code class="hljs language-css" lang="css">双阶段确认：

Phase <span class="hljs-number">1</span>: 快速 ACK
────────────────
请求来到时（T2）
    ↓
<span class="hljs-built_in">RIL_onRequestAck</span>() 
    ├─ pRI-&gt;wasAckSent = <span class="hljs-number">1</span>
    ├─ 调用 radio::<span class="hljs-built_in">acknowledgeRequest</span>()
    └─ 立即返回给应用

应用：「收到 ACK，知道正在处理」

Phase <span class="hljs-number">2</span>: 最终响应
─────────────────
硬件完成操作（T4b）
    ↓
<span class="hljs-built_in">RIL_onRequestComplete</span>()
    ├─ responseType = RESPONSE_SOLICITED_ACK_EXP
    ├─ <span class="hljs-built_in">grabPartialWakeLock</span>()
    ├─ 调用 <span class="hljs-built_in">responseFunction</span>()
    └─ 返回实际结果

应用：「收到最终响应」
</code></pre>
<hr/>
<h3 data-id="heading-13">7. <strong>关键 API 总结</strong></h3>



































<table><thead><tr><th>API</th><th>功能</th><th>调用方</th></tr></thead><tbody><tr><td><code>addRequestToList()</code></td><td>创建 RequestInfo，加入队列</td><td>RIL Service (ril_service.cpp)</td></tr><tr><td><code>CALL_ONREQUEST()</code></td><td>异步发送命令给 vendor RIL</td><td>RIL Service</td></tr><tr><td><code>RIL_onRequestAck()</code></td><td>Vendor RIL 发送快速确认</td><td>Vendor RIL</td></tr><tr><td><code>RIL_onRequestComplete()</code></td><td>Vendor RIL 发送最终响应</td><td>Vendor RIL</td></tr><tr><td><code>checkAndDequeueRequestInfoIfAck()</code></td><td>从队列移除请求</td><td>ril.cpp 内部</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-14">8. <strong>超时和 Wake Lock 管理</strong></h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 获取 wake lock，防止系统休眠</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">grabPartialWakeLock</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (s_callbacks.version &gt;= <span class="hljs-number">13</span>) {
        acquire_wake_lock(PARTIAL_WAKE_LOCK, ANDROID_WAKE_LOCK_NAME);
        
        <span class="hljs-comment">// 200ms 后自动释放（防止长期占用）</span>
        UserCallbackInfo *p_info =
            internalRequestTimedCallback(wakeTimeoutCallback, <span class="hljs-literal">NULL</span>, 
                                        &amp;TIMEVAL_WAKE_TIMEOUT);
        s_last_wake_timeout_info = p_info;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-15">总结</h3>









































<table><thead><tr><th>特性</th><th>实现方式</th></tr></thead><tbody><tr><td><strong>队列管理</strong></td><td>链表 + 互斥锁</td></tr><tr><td><strong>并发控制</strong></td><td>Pthread mutex</td></tr><tr><td><strong>请求标识</strong></td><td>Token (RequestInfo 指针)</td></tr><tr><td><strong>多 SIM 支持</strong></td><td>每个 SIM 独立队列 + 互斥锁</td></tr><tr><td><strong>异步处理</strong></td><td>命令发送和响应分离</td></tr><tr><td><strong>快速确认</strong></td><td>RIL_onRequestAck()</td></tr><tr><td><strong>最终响应</strong></td><td>RIL_onRequestComplete()</td></tr><tr><td><strong>系统睡眠保护</strong></td><td>Wake lock + 超时释放</td></tr></tbody></table>
<p>这个设计确保了 RIL 能够高效地处理多个并发请求，同时保持通信的可靠性和系统的电源管理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[langchain-RAG高级检索策略学习总结]]></title>    <link>https://juejin.cn/post/7603309951226806322</link>    <guid>https://juejin.cn/post/7603309951226806322</guid>    <pubDate>2026-02-06T07:06:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951226806322" data-draft-id="7603263490343026697" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="langchain-RAG高级检索策略学习总结"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T07:06:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心在飞扬AI"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194366823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            langchain-RAG高级检索策略学习总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1556564194366823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心在飞扬AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:06:06.000Z" title="Fri Feb 06 2026 07:06:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    22
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RAG高级检索策略学习总结</h2>
<h3 data-id="heading-1">1. 自定义检索器</h3>
<h4 data-id="heading-2">这是什么</h4>
<p>自定义检索器是通过继承LangChain的<code>BaseRetriever</code>基类，实现<code>_get_relevant_documents</code>方法来创建的个性化检索器。这允许开发者根据自己的业务逻辑和需求，自定义文档检索的方式。</p>
<h4 data-id="heading-3">这个有什么用</h4>
<ul>
<li>实现特定的检索逻辑，如关键词匹配、模糊搜索等</li>
<li>整合多种数据源的检索能力</li>
<li>添加业务规则和过滤条件</li>
<li>灵活控制返回文档的数量和质量</li>
</ul>
<h4 data-id="heading-4">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langchain_core.callbacks <span class="hljs-keyword">import</span> CallbackManagerForRetrieverRun
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain_core.retrievers <span class="hljs-keyword">import</span> BaseRetriever

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRetriever</span>(<span class="hljs-title class_ inherited__">BaseRetriever</span>):
    documents: <span class="hljs-type">List</span>[Document]
    k: <span class="hljs-built_in">int</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_relevant_documents</span>(<span class="hljs-params">
        self, query: <span class="hljs-built_in">str</span>, *, run_manager: CallbackManagerForRetrieverRun
    </span>) -&gt; <span class="hljs-type">List</span>[Document]:
        <span class="hljs-string">"""根据传入的query，获取相关联的文档列表"""</span>
        matching_documents = []
        <span class="hljs-keyword">for</span> document <span class="hljs-keyword">in</span> self.documents:
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(matching_documents) &gt;= self.k:
                <span class="hljs-keyword">return</span> matching_documents
            <span class="hljs-keyword">if</span> query.lower() <span class="hljs-keyword">in</span> document.page_content.lower():
                matching_documents.append(document)
        <span class="hljs-keyword">return</span> matching_documents

<span class="hljs-comment"># 使用示例</span>
documents = [
    Document(page_content=<span class="hljs-string">"笨笨是一只很喜欢睡觉的猫咪"</span>, metadata={<span class="hljs-string">"page"</span>: <span class="hljs-number">1</span>}),
    Document(page_content=<span class="hljs-string">"猫咪在窗台上打盹，看起来非常可爱。"</span>, metadata={<span class="hljs-string">"page"</span>: <span class="hljs-number">3</span>}),
]

retriever = CustomRetriever(documents=documents, k=<span class="hljs-number">3</span>)
results = retriever.invoke(<span class="hljs-string">"猫"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-5">2. Multi-Query多查询策略</h3>
<h4 data-id="heading-6">这是什么</h4>
<p>Multi-Query检索器使用大语言模型自动生成多个不同角度的查询，然后基于这些查询进行检索，最后合并所有结果。这是一种提高检索召回率和准确性的策略。</p>
<h4 data-id="heading-7">这个有什么用</h4>
<ul>
<li>解决用户查询表述不准确的问题</li>
<li>从多个角度理解同一个问题</li>
<li>提高检索的召回率，找到更多相关文档</li>
<li>减少因查询措辞不当导致的检索失败</li>
</ul>
<h4 data-id="heading-8">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> weaviate
<span class="hljs-keyword">from</span> langchain_classic.retrievers <span class="hljs-keyword">import</span> MultiQueryRetriever
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_weaviate <span class="hljs-keyword">import</span> WeaviateVectorStore
<span class="hljs-keyword">from</span> weaviate.auth <span class="hljs-keyword">import</span> AuthApiKey

<span class="hljs-comment"># 1. 构建向量数据库与检索器</span>
db = WeaviateVectorStore(
    client=weaviate.connect_to_wcs(
        cluster_url=<span class="hljs-string">"your_cluster_url"</span>,
        auth_credentials=AuthApiKey(<span class="hljs-string">"your_api_key"</span>),
    ),
    index_name=<span class="hljs-string">"DatasetDemo"</span>,
    text_key=<span class="hljs-string">"text"</span>,
    embedding=QianfanEmbeddingsEndpoint(model=<span class="hljs-string">"embedding-v1"</span>),
)
retriever = db.as_retriever(search_type=<span class="hljs-string">"mmr"</span>)

<span class="hljs-comment"># 2. 创建多查询检索器</span>
multi_query_retriever = MultiQueryRetriever.from_llm(
    retriever=retriever,
    llm=ChatOpenAI(model=<span class="hljs-string">"moonshot-v1-8k"</span>, temperature=<span class="hljs-number">0</span>),
    include_original=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 是否包含原始查询</span>
)

<span class="hljs-comment"># 3. 执行检索</span>
docs = multi_query_retriever.invoke(<span class="hljs-string">"关于LLMOps应用配置的文档有哪些"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-9">3. RAG多查询结果融合策略</h3>
<h4 data-id="heading-10">这是什么</h4>
<p>RAG Fusion是在Multi-Query基础上，使用RRF（Reciprocal Rank Fusion，倒数排名融合）算法来智能合并多个查询结果的策略。它不仅去重，还根据文档在不同查询结果中的排名进行加权排序。</p>
<h4 data-id="heading-11">这个有什么用</h4>
<ul>
<li>消除多个查询结果中的重复文档</li>
<li>根据文档的排名位置智能计算相关性得分</li>
<li>融合多个查询的优势，提高最终结果质量</li>
<li>避免简单去重导致的信息丢失</li>
</ul>
<h4 data-id="heading-12">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langchain_core.callbacks <span class="hljs-keyword">import</span> CallbackManagerForRetrieverRun
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain_classic.retrievers <span class="hljs-keyword">import</span> MultiQueryRetriever
<span class="hljs-keyword">from</span> langchain_core.load <span class="hljs-keyword">import</span> dumps, loads

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGFusionRetriever</span>(<span class="hljs-title class_ inherited__">MultiQueryRetriever</span>):
    <span class="hljs-string">"""RAG多查询结果融合策略检索器"""</span>
    k: <span class="hljs-built_in">int</span> = <span class="hljs-number">4</span>  <span class="hljs-comment"># 返回前k个文档</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">retrieve_documents</span>(<span class="hljs-params">
            self, queries: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], run_manager: CallbackManagerForRetrieverRun
    </span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">List</span>]:
        <span class="hljs-string">"""重写检索文档函数，返回嵌套列表"""</span>
        documents = []
        <span class="hljs-keyword">for</span> query <span class="hljs-keyword">in</span> queries:
            docs = self.retriever.invoke(
                query, config={<span class="hljs-string">"callbacks"</span>: run_manager.get_child()}
            )
            documents.append(docs)
        <span class="hljs-keyword">return</span> documents

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">unique_union</span>(<span class="hljs-params">self, documents: <span class="hljs-type">List</span>[<span class="hljs-type">List</span>]</span>) -&gt; <span class="hljs-type">List</span>[Document]:
        <span class="hljs-string">"""使用RRF算法来去重合并对应的文档"""</span>
        fused_result = {}

        <span class="hljs-comment"># RRF算法：根据排名计算得分</span>
        <span class="hljs-keyword">for</span> docs <span class="hljs-keyword">in</span> documents:
            <span class="hljs-keyword">for</span> rank, doc <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(docs):
                doc_str = dumps(doc)
                <span class="hljs-keyword">if</span> doc_str <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> fused_result:
                    fused_result[doc_str] = <span class="hljs-number">0</span>
                <span class="hljs-comment"># 计算得分：排名越前，得分越高</span>
                fused_result[doc_str] += <span class="hljs-number">1</span> / (rank + <span class="hljs-number">60</span>)

        <span class="hljs-comment"># 按得分降序排序，返回前k个</span>
        reranked_results = [
            (loads(doc), score)
            <span class="hljs-keyword">for</span> doc, score <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(fused_result.items(), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">1</span>], reverse=<span class="hljs-literal">True</span>)
        ]

        <span class="hljs-keyword">return</span> [item[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> reranked_results[:self.k]]

<span class="hljs-comment"># 使用方式与MultiQueryRetriever相同</span>
rag_fusion_retriever = RAGFusionRetriever.from_llm(
    retriever=retriever,
    llm=ChatOpenAI(model=<span class="hljs-string">"moonshot-v1-8k"</span>, temperature=<span class="hljs-number">0</span>),
)
docs = rag_fusion_retriever.invoke(<span class="hljs-string">"查询内容"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-13">4. 问题分解策略</h3>
<h4 data-id="heading-14">这是什么</h4>
<p>问题分解策略将复杂的用户问题分解成多个独立的子问题，然后对每个子问题分别进行检索和回答，最后将所有子问题的答案整合起来形成最终答案。</p>
<h4 data-id="heading-15">这个有什么用</h4>
<ul>
<li>处理复杂、多方面的查询问题</li>
<li>提高对复合问题的回答准确性</li>
<li>逐步构建答案，每个子问题都可以获得独立的上下文</li>
<li>避免单一查询无法覆盖所有相关信息的缺陷</li>
</ul>
<h4 data-id="heading-16">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> operator <span class="hljs-keyword">import</span> itemgetter
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnablePassthrough
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-comment"># 1. 构建问题分解链</span>
decomposition_prompt = ChatPromptTemplate.from_template(
    <span class="hljs-string">"你是一个乐于助人的AI助理，可以针对一个输入问题生成多个相关的子问题。\n"</span>
    <span class="hljs-string">"目标是将输入问题分解成一组可以独立回答的子问题或者子任务。\n"</span>
    <span class="hljs-string">"生成与以下问题相关的多个搜索查询：{question}\n"</span>
    <span class="hljs-string">"并使用换行符进行分割，输出（3个子问题/子查询）："</span>
)

decomposition_chain = (
    {<span class="hljs-string">"question"</span>: RunnablePassthrough()}
    | decomposition_prompt
    | ChatOpenAI(model=<span class="hljs-string">"moonshot-v1-8k"</span>, temperature=<span class="hljs-number">0</span>)
    | StrOutputParser()
    | (<span class="hljs-keyword">lambda</span> x: x.strip().split(<span class="hljs-string">"\n"</span>))
)

<span class="hljs-comment"># 2. 构建迭代问答链</span>
prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"""这是你需要回答的问题：
---
{question}
---

这是所有可用的背景问题和答案对：
---
{qa_pairs}
---

这是与问题相关的额外背景信息：
---
{context}
---"""</span>)

chain = (
    {
        <span class="hljs-string">"question"</span>: itemgetter(<span class="hljs-string">"question"</span>),
        <span class="hljs-string">"qa_pairs"</span>: itemgetter(<span class="hljs-string">"qa_pairs"</span>),
        <span class="hljs-string">"context"</span>: itemgetter(<span class="hljs-string">"question"</span>) | retriever,
    }
    | prompt
    | ChatOpenAI(model=<span class="hljs-string">"moonshot-v1-8k"</span>, temperature=<span class="hljs-number">0</span>)
    | StrOutputParser()
)

<span class="hljs-comment"># 3. 循环处理所有子问题</span>
question = <span class="hljs-string">"关于LLMOps应用配置的文档有哪些"</span>
sub_questions = decomposition_chain.invoke(question)

qa_pairs = <span class="hljs-string">""</span>
<span class="hljs-keyword">for</span> sub_question <span class="hljs-keyword">in</span> sub_questions:
    answer = chain.invoke({<span class="hljs-string">"question"</span>: sub_question, <span class="hljs-string">"qa_pairs"</span>: qa_pairs})
    qa_pair = <span class="hljs-string">f"Question: <span class="hljs-subst">{sub_question}</span>\nAnswer: <span class="hljs-subst">{answer}</span>\n\n"</span>
    qa_pairs += qa_pair
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"问题: <span class="hljs-subst">{sub_question}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"答案: <span class="hljs-subst">{answer}</span>"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-17">5. 少量示例模板（Few-Shot Prompting）</h3>
<h4 data-id="heading-18">这是什么</h4>
<p>Few-Shot提示模板通过在提示中提供少量示例来引导大语言模型生成符合预期的输出。它结合了<code>ChatPromptTemplate</code>和<code>FewShotChatMessagePromptTemplate</code>，使模型能够通过示例理解任务模式。</p>
<h4 data-id="heading-19">这个有什么用</h4>
<ul>
<li>提高模型对特定任务的理解能力</li>
<li>减少对复杂prompt工程的需求</li>
<li>通过示例快速定义输出格式和风格</li>
<li>适用于文本转换、计算、分类等各种任务</li>
</ul>
<h4 data-id="heading-20">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, FewShotChatMessagePromptTemplate
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-comment"># 1. 构建示例模板与示例</span>
example_prompt = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{question}"</span>),
    (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"{answer}"</span>),
])

examples = [
    {<span class="hljs-string">"question"</span>: <span class="hljs-string">"帮我计算下2+2等于多少？"</span>, <span class="hljs-string">"answer"</span>: <span class="hljs-string">"4"</span>},
    {<span class="hljs-string">"question"</span>: <span class="hljs-string">"帮我计算下2+3等于多少？"</span>, <span class="hljs-string">"answer"</span>: <span class="hljs-string">"5"</span>},
    {<span class="hljs-string">"question"</span>: <span class="hljs-string">"帮我计算下20*15等于多少？"</span>, <span class="hljs-string">"answer"</span>: <span class="hljs-string">"300"</span>},
]

<span class="hljs-comment"># 2. 构建少量示例提示模板</span>
few_shot_prompt = FewShotChatMessagePromptTemplate(
    example_prompt=example_prompt,
    examples=examples,
)

<span class="hljs-comment"># 3. 构建最终提示模板</span>
prompt = ChatPromptTemplate.from_messages([
    (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个可以计算复杂数学问题的聊天机器人"</span>),
    few_shot_prompt,
    (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{question}"</span>),
])

<span class="hljs-comment"># 4. 创建链并调用</span>
llm = ChatOpenAI(model=<span class="hljs-string">"moonshot-v1-8k"</span>, temperature=<span class="hljs-number">0</span>)
chain = prompt | llm | StrOutputParser()

result = chain.invoke(<span class="hljs-string">"帮我计算下14*15等于多少"</span>)
<span class="hljs-built_in">print</span>(result)
</code></pre>
<hr/>
<h3 data-id="heading-21">6. 回答回退策略检索器</h3>
<h4 data-id="heading-22">这是什么</h4>
<p>回答回退（Step-Back）检索器是一种策略，它会将用户的具体问题"回退"到一个更通用或更基础的问题，然后用这个回退问题进行检索。这种方法基于这样的理念：有时从更宏观的角度搜索，能找到更全面的相关信息。</p>
<h4 data-id="heading-23">这个有什么用</h4>
<ul>
<li>解决过于具体的问题导致检索结果过少的问题</li>
<li>从更宽泛的角度获取背景信息</li>
<li>通过Few-Shot示例学习如何生成合适的回退问题</li>
<li>提高对复杂、抽象问题的检索效果</li>
</ul>
<h4 data-id="heading-24">示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> langchain_core.callbacks <span class="hljs-keyword">import</span> CallbackManagerForRetrieverRun
<span class="hljs-keyword">from</span> langchain_core.documents <span class="hljs-keyword">import</span> Document
<span class="hljs-keyword">from</span> langchain_core.language_models <span class="hljs-keyword">import</span> BaseLanguageModel
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, FewShotChatMessagePromptTemplate
<span class="hljs-keyword">from</span> langchain_core.retrievers <span class="hljs-keyword">import</span> BaseRetriever
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnablePassthrough

<span class="hljs-keyword">class</span> <span class="hljs-title class_">StepBackRetriever</span>(<span class="hljs-title class_ inherited__">BaseRetriever</span>):
    <span class="hljs-string">"""回答回退检索器"""</span>
    retriever: BaseRetriever
    llm: BaseLanguageModel

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_relevant_documents</span>(<span class="hljs-params">
            self, query: <span class="hljs-built_in">str</span>, *, run_manager: CallbackManagerForRetrieverRun
    </span>) -&gt; <span class="hljs-type">List</span>[Document]:
        <span class="hljs-comment"># 1. 构建少量示例提示模板</span>
        examples = [
            {<span class="hljs-string">"input"</span>: <span class="hljs-string">"慕课网上有关于AI应用开发的课程吗？"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"慕课网上有哪些课程？"</span>},
            {<span class="hljs-string">"input"</span>: <span class="hljs-string">"慕小课出生在哪个国家？"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"慕小课的人生经历是什么样的？"</span>},
            {<span class="hljs-string">"input"</span>: <span class="hljs-string">"司机可以开快车吗？"</span>, <span class="hljs-string">"output"</span>: <span class="hljs-string">"司机可以做什么？"</span>},
        ]
        example_prompt = ChatPromptTemplate.from_messages([
            (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{input}"</span>),
            (<span class="hljs-string">"ai"</span>, <span class="hljs-string">"{output}"</span>),
        ])
        few_shot_prompt = FewShotChatMessagePromptTemplate(
            examples=examples,
            example_prompt=example_prompt,
        )

        <span class="hljs-comment"># 2. 构建生成回退问题的模板</span>
        prompt = ChatPromptTemplate.from_messages([
            (<span class="hljs-string">"system"</span>,
             <span class="hljs-string">"你是一个世界知识的专家。你的任务是回退问题，将问题改述为更一般或者前置问题，这样更容易回答，请参考示例来实现。"</span>),
            few_shot_prompt,
            (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{question}"</span>),
        ])

        <span class="hljs-comment"># 3. 构建链应用，生成回退问题并执行检索</span>
        chain = (
                {<span class="hljs-string">"question"</span>: RunnablePassthrough()}
                | prompt
                | self.llm
                | StrOutputParser()
                | self.retriever
        )

        <span class="hljs-keyword">return</span> chain.invoke(query)

<span class="hljs-comment"># 使用示例</span>
step_back_retriever = StepBackRetriever(
    retriever=retriever,
    llm=ChatOpenAI(model=<span class="hljs-string">"moonshot-v1-8k"</span>, temperature=<span class="hljs-number">0</span>),
)

documents = step_back_retriever.invoke(<span class="hljs-string">"人工智能会让世界发生翻天覆地的变化吗？"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-25">总结</h3>
<p>这些RAG高级检索策略各有特点，可以根据实际场景选择或组合使用：</p>
<ol>
<li><strong>自定义检索器</strong>：适用于需要特殊检索逻辑的场景</li>
<li><strong>Multi-Query</strong>：适用于查询表述不准确、需要多角度检索的场景</li>
<li><strong>RAG Fusion</strong>：适用于需要智能合并多查询结果的场景</li>
<li><strong>问题分解</strong>：适用于复杂、多方面的复合问题</li>
<li><strong>Few-Shot</strong>：适用于需要引导模型理解特定输出格式的场景</li>
<li><strong>回退策略</strong>：适用于问题过于具体导致检索效果不佳的场景</li>
</ol>
<p>这些策略可以灵活组合，例如在问题分解策略中使用Multi-Query检索器，或在RAG Fusion中应用回退策略，以达到最佳的检索效果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C2U动态编译+NLP自学习：BridgeCode 与企业原有代码集成架构详解]]></title>    <link>https://juejin.cn/post/7603389033041575990</link>    <guid>https://juejin.cn/post/7603389033041575990</guid>    <pubDate>2026-02-06T07:15:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603389033041575990" data-draft-id="7603352061506207750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C2U动态编译+NLP自学习：BridgeCode 与企业原有代码集成架构详解"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-06T07:15:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C2U动态编译+NLP自学习：BridgeCode 与企业原有代码集成架构详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:15:05.000Z" title="Fri Feb 06 2026 07:15:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">摘要</h2>
<p>在企业级应用开发中，如何将自动生成的代码与现有代码库无缝集成是一个长期存在的挑战。Ooder D2B (Design to Bridge) 框架通过 BridgeCode 机制，巧妙地解决了这个问题。本文将深入剖析 BridgeCode 的核心机制，揭示它如何通过 C2U 动态编译、NLP Module 自学习、项目级模板规则配置等技术，与企业原有代码完美融合。</p>
<hr/>
<h2 data-id="heading-1">目录</h2>
<ol>
<li><a href="#1-%25E5%25BC%2595%25E8%25A8%2580" title="#1-%25E5%25BC%2595%25E8%25A8%2580">引言</a></li>
<li><a href="#2-c2u-%25E5%258A%25A8%25E6%2580%2581%25E7%25BC%2596%25E8%25AF%2591%25E6%259C%25BA%25E5%2588%25B6%25E6%25B7%25B1%25E5%25BA%25A6%25E8%25A7%25A3%25E6%259E%2590" title="#2-c2u-%25E5%258A%25A8%25E6%2580%2581%25E7%25BC%2596%25E8%25AF%2591%25E6%259C%25BA%25E5%2588%25B6%25E6%25B7%25B1%25E5%25BA%25A6%25E8%25A7%25A3%25E6%259E%2590">C2U 动态编译机制深度解析</a></li>
<li><a href="#3-nlp-module-%25E8%2587%25AA%25E5%25AD%25A6%25E4%25B9%25A0%25E6%259C%25BA%25E5%2588%25B6" title="#3-nlp-module-%25E8%2587%25AA%25E5%25AD%25A6%25E4%25B9%25A0%25E6%259C%25BA%25E5%2588%25B6">NLP Module 自学习机制</a></li>
<li><a href="#4-%25E9%25A1%25B9%25E7%259B%25AE%25E7%25BA%25A7%25E6%25A8%25A1%25E6%259D%25BF%25E8%25A7%2584%25E5%2588%2599%25E9%2585%258D%25E7%25BD%25AE" title="#4-%25E9%25A1%25B9%25E7%259B%25AE%25E7%25BA%25A7%25E6%25A8%25A1%25E6%259D%25BF%25E8%25A7%2584%25E5%2588%2599%25E9%2585%258D%25E7%25BD%25AE">项目级模板规则配置</a></li>
<li><a href="#5-bridgecode-%25E6%25A0%25B8%25E5%25BF%2583%25E6%259E%25B6%25E6%259E%2584" title="#5-bridgecode-%25E6%25A0%25B8%25E5%25BF%2583%25E6%259E%25B6%25E6%259E%2584">BridgeCode 核心架构</a></li>
<li><a href="#6-%25E6%25A8%25A1%25E6%259D%25BF%25E7%2594%259F%25E6%2580%2581%25E4%25B8%258E%25E8%2587%25AA%25E5%25AD%25A6%25E4%25B9%25A0" title="#6-%25E6%25A8%25A1%25E6%259D%25BF%25E7%2594%259F%25E6%2580%2581%25E4%25B8%258E%25E8%2587%25AA%25E5%25AD%25A6%25E4%25B9%25A0">模板生态与自学习</a></li>
<li><a href="#7-%25E6%25A1%2586%25E6%259E%25B6%25E4%25BC%2598%25E5%258A%25BF%25E6%2580%25BB%25E7%25BB%2593" title="#7-%25E6%25A1%2586%25E6%259E%25B6%25E4%25BC%2598%25E5%258A%25BF%25E6%2580%25BB%25E7%25BB%2593">框架优势总结</a></li>
<li><a href="#8-%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5" title="#8-%25E6%259C%2580%25E4%25BD%25B3%25E5%25AE%259E%25E8%25B7%25B5">最佳实践</a></li>
<li><a href="#9-%25E6%2580%25BB%25E7%25BB%2593" title="#9-%25E6%2580%25BB%25E7%25BB%2593">总结</a></li>
</ol>
<hr/>
<h2 data-id="heading-2">1. 引言</h2>
<h3 data-id="heading-3">1.1 代码生成与集成的挑战</h3>
<p>在企业级应用开发中，代码生成技术已经被广泛应用，但如何将生成的代码与现有代码库无缝集成仍然是一个挑战。传统的方法存在以下问题：</p>
<ol>
<li><strong>代码冲突</strong>：生成的代码可能覆盖或与手动编写的代码冲突</li>
<li><strong>维护困难</strong>：生成的代码难以维护，修改后重新生成会丢失变更</li>
<li><strong>集成复杂</strong>：生成的代码需要手动配置才能与现有系统集成</li>
<li><strong>版本管理</strong>：生成的代码难以纳入版本控制系统</li>
<li><strong>团队协作</strong>：开发人员难以理解生成的代码，影响团队协作</li>
</ol>
<h3 data-id="heading-4">1.2 Ooder D2B 的解决方案</h3>
<p>Ooder D2B (Design to Bridge) 框架通过 BridgeCode 机制，提供了一种全新的解决方案：</p>
<ol>
<li><strong>C2U 动态编译</strong>：支持运行时动态编译和加载代码，无需重启应用</li>
<li><strong>NLP Module 自学习</strong>：通过 AI 辅助完成复杂的模板库维护</li>
<li><strong>项目级配置</strong>：每个项目可以独立设置规则和模板</li>
<li><strong>元数据驱动</strong>：通过 DSM (Design System Model) 元数据驱动代码生成</li>
<li><strong>VFS 管理</strong>：通过虚拟文件系统管理生成的代码，支持版本控制</li>
</ol>
<h3 data-id="heading-5">1.3 本文结构</h3>
<p>本文将从以下几个方面深入剖析 BridgeCode 机制：</p>
<ul>
<li>C2U 动态编译机制的深度解析</li>
<li>NLP Module 自学习机制的原理</li>
<li>项目级模板规则配置的体系</li>
<li>BridgeCode 核心架构设计</li>
<li>模板生态与自学习机制</li>
<li>框架优势总结</li>
<li>最佳实践</li>
</ul>
<hr/>
<h2 data-id="heading-6">2. C2U 动态编译机制深度解析</h2>
<h3 data-id="heading-7">2.1 C2UFactory 核心职责</h3>
<p>C2UFactory 是 Ooder 框架中负责动态编译和 UI 模块管理的核心工厂类。它的主要职责包括：</p>
<ol>
<li><strong>动态编译</strong>：支持运行时动态编译 UI 模块</li>
<li><strong>模块管理</strong>：管理 UI 模块的生命周期</li>
<li><strong>模板渲染</strong>：使用 MVEL 表达式引擎渲染模板</li>
<li><strong>缓存管理</strong>：提供模块缓存机制，提高性能</li>
</ol>
<p><strong>核心代码位置</strong>：</p>
<h3 data-id="heading-8">2.2 动态编译原理</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27af9895a1334979addd8a64ebe8e689~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=hn7%2FllzK2eDp%2FxI36czhVNUEqwo%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-9">2.2.1 核心方法分析</h4>
<p>C2UFactory 提供了多个核心方法来实现动态编译：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 动态编译 MODULE</span>
<span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ModuleUIComponent</span>&gt; UIModule&lt;T&gt; <span class="hljs-title function_">dynBuild</span><span class="hljs-params">(Class customClass, Map&lt;String, ?&gt; valueMap)</span>

<span class="hljs-comment">// 动态编译 MODULE（完整版）</span>
<span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ModuleUIComponent</span>&gt; UIModule&lt;T&gt; <span class="hljs-title function_">dynModule</span><span class="hljs-params">(MethodConfig methodConfig, Class&lt;T&gt; customClass, UIModule <span class="hljs-keyword">module</span>, Map&lt;String, ?&gt; valueMap)</span>

<span class="hljs-comment">// 获取视图（支持缓存）</span>
<span class="hljs-keyword">public</span> UIModule <span class="hljs-title function_">getViewByMethod</span><span class="hljs-params">(MethodConfig methodAPIBean, String projectName, Map&lt;String, ?&gt; valueMap)</span>

<span class="hljs-comment">// 创建真实视图</span>
<span class="hljs-keyword">public</span> UIModule <span class="hljs-title function_">createRealView</span><span class="hljs-params">(MethodConfig methodAPIBean, Class customClass, String projectName, Map&lt;String, ?&gt; valueMap, <span class="hljs-type">boolean</span> isDyn)</span>
</code></pre>
<h4 data-id="heading-10">2.2.2 动态编译流程</h4>
<p>C2UFactory 的动态编译流程如下：</p>
<h3 data-id="heading-11">2.3 MVEL 表达式引擎</h3>
<p>C2UFactory 使用 MVEL (MVFLEX Expression Language) 表达式引擎进行模板渲染：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 核心渲染代码</span>
<span class="hljs-type">String</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> (String) TemplateRuntime.eval(json, MvelDSMRoot.getInstance(), perContext(oTopModule, component.getUIModule()));
<span class="hljs-type">T</span> <span class="hljs-variable">moduleComponent</span> <span class="hljs-operator">=</span> JSONObject.parseObject(obj, customClass);
</code></pre>
<p><strong>MVEL 的优势</strong>：</p>
<ol>
<li><strong>高性能</strong>：比传统的 JSP/FreeMarker 更快</li>
<li><strong>灵活性</strong>：支持复杂的表达式和逻辑</li>
<li><strong>轻量级</strong>：无需额外的依赖</li>
<li><strong>易用性</strong>：语法简洁，易于理解</li>
</ol>
<h3 data-id="heading-12">2.4 动态编译的关键特性</h3>
<h4 data-id="heading-13">2.4.1 线程安全</h4>
<p>C2UFactory 使用线程锁确保线程安全：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">THREAD_LOCK</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Thread Lock"</span>;

<span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ModuleUIComponent</span>&gt; UIModule&lt;T&gt; <span class="hljs-title function_">dynModule</span><span class="hljs-params">(MethodConfig methodConfig, Class&lt;T&gt; customClass, UIModule <span class="hljs-keyword">module</span>, Map&lt;String, ?&gt; valueMap)</span> {
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">module</span>.getClassName()) {
        <span class="hljs-comment">// 动态编译逻辑</span>
    }
}
</code></pre>
<h4 data-id="heading-14">2.4.2 缓存机制</h4>
<p>C2UFactory 提供了多层缓存机制：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 线程缓存</span>
<span class="hljs-type">Map</span> <span class="hljs-variable">contextMap</span> <span class="hljs-operator">=</span> JDSActionContext.getActionContext().getContext();

<span class="hljs-comment">// 2. 时间缓存</span>
<span class="hljs-type">Long</span> <span class="hljs-variable">createTime</span> <span class="hljs-operator">=</span> (Long) contextMap.get(url + <span class="hljs-string">"[TIME]"</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">module</span> == <span class="hljs-literal">null</span> &amp;&amp; (createTime == <span class="hljs-literal">null</span> || System.currentTimeMillis() - createTime &gt; <span class="hljs-number">500</span>)) {
    <span class="hljs-comment">// 重新加载</span>
}

<span class="hljs-comment">// 3. 模块缓存</span>
<span class="hljs-keyword">static</span> Map&lt;String, C2UFactory&gt; managerMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, C2UFactory&gt;();
</code></pre>
<h4 data-id="heading-15">2.4.3 自定义组件支持</h4>
<p>C2UFactory 支持自定义组件：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 支持自定义类</span>
<span class="hljs-keyword">if</span> (customClass == <span class="hljs-literal">null</span>) {
    customClass = methodConfig.getRealViewClass();
}

<span class="hljs-comment">// 支持动态加载视图</span>
<span class="hljs-keyword">if</span> (methodConfig.getDynDataBean() != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-keyword">module</span>.getRealClassName().equals(<span class="hljs-keyword">module</span>.getClassName())) {
    customClass = (Class&lt;T&gt;) CustomDynLoadView.class;
}
</code></pre>
<hr/>
<h2 data-id="heading-16">3. NLP Module 自学习机制</h2>
<h3 data-id="heading-17">3.1 FullNlpComponentConverter 概述</h3>
<p>FullNlpComponentConverter 是 Ooder 框架中负责将自然语言和配置转换为 NLP 组件的核心转换器。它支持三种转换模式：</p>
<ol>
<li><strong>LLM_ONLY</strong>：只使用 LLM（大语言模型）进行转换</li>
<li><strong>SKILLS_ONLY</strong>：只使用 Skills（技能）进行转换</li>
<li><strong>HYBRID</strong>：混合使用 LLM 和 Skills</li>
</ol>
<p><strong>核心代码位置</strong>：FullNlpComponentConverter.java</p>
<h3 data-id="heading-18">3.2 转换模式详解</h3>
<h4 data-id="heading-19">3.2.1 LLM_ONLY 模式</h4>
<p>只使用 LLM 进行转换：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">case</span> LLM_ONLY:
    <span class="hljs-keyword">if</span> (llmInterface != <span class="hljs-literal">null</span>) {
        config = llmInterface.convertNaturalLanguageToConfig(naturalLanguage, componentType);
    }
    <span class="hljs-keyword">break</span>;
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>需要理解复杂的自然语言描述</li>
<li>需要生成创新的组件配置</li>
<li>对准确性要求极高的场景</li>
</ul>
<h4 data-id="heading-20">3.2.2 SKILLS_ONLY 模式</h4>
<p>只使用 Skills 进行转换：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">case</span> SKILLS_ONLY:
    <span class="hljs-keyword">if</span> (skillsBridge != <span class="hljs-literal">null</span>) {
        config = skillsBridge.processNaturalLanguage(naturalLanguage, componentType);
    }
    <span class="hljs-keyword">break</span>;
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>有明确的转换规则</li>
<li>需要快速响应</li>
<li>对稳定性要求极高的场景</li>
</ul>
<h4 data-id="heading-21">3.2.3 HYBRID 模式</h4>
<p>混合使用 LLM 和 Skills：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">case</span> HYBRID:
<span class="hljs-keyword">default</span>:
    <span class="hljs-comment">// 先尝试使用 Skills，失败后使用 LLM</span>
    <span class="hljs-keyword">if</span> (skillsBridge != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
            config = skillsBridge.processNaturalLanguage(naturalLanguage, componentType);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// Skills 失败，使用 LLM</span>
            <span class="hljs-keyword">if</span> (llmInterface != <span class="hljs-literal">null</span>) {
                config = llmInterface.convertNaturalLanguageToConfig(naturalLanguage, componentType);
            }
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (llmInterface != <span class="hljs-literal">null</span>) {
        config = llmInterface.convertNaturalLanguageToConfig(naturalLanguage, componentType);
    }
    <span class="hljs-keyword">break</span>;
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>需要兼顾准确性和灵活性</li>
<li>需要快速响应但也要保证准确性</li>
<li>大多数生产环境场景</li>
</ul>
<h3 data-id="heading-22">3.3 NlpComponentFactory 组件工厂</h3>
<h4 data-id="heading-23">3.3.1 工厂模式</h4>
<p>NlpComponentFactory 使用工厂模式创建各种 Nlp*UIComponent 实例，支持超过 30 种组件类型：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b0532c847044046847839fea67db9d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=qq0mB4WGCLMuW1HC7eScyNbxT6o%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>NlpComponentFactory 使用工厂模式创建各种 Nlp*UIComponent 实例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NlpComponentFactory</span> {
    <span class="hljs-keyword">private</span> Map&lt;String, ComponentCreator&gt; creatorMap;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NlpComponentFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.creatorMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        initializeCreators();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeCreators</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 注册组件创建器</span>
        registerCreator(<span class="hljs-string">"Block"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpBlockUIComponent</span>());
        registerCreator(<span class="hljs-string">"ButtonLayout"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpButtonLayoutUIComponent</span>());
        registerCreator(<span class="hljs-string">"ContentBlock"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpContentBlockUIComponent</span>());
        registerCreator(<span class="hljs-string">"CustomLayout"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpCustomLayoutUIComponent</span>());
        registerCreator(<span class="hljs-string">"Div"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpDivUIComponent</span>());
        registerCreator(<span class="hljs-string">"ECharts"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpEChartsUIComponent</span>());
        registerCreator(<span class="hljs-string">"FChart"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpFChartUIComponent</span>());
        registerCreator(<span class="hljs-string">"Gallery"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpGalleryUIComponent</span>());
        registerCreator(<span class="hljs-string">"Group"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpGroupUIComponent</span>());
        registerCreator(<span class="hljs-string">"MTree"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMTreeUIComponent</span>());
        registerCreator(<span class="hljs-string">"Opinion"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpOpinionUIComponent</span>());
        registerCreator(<span class="hljs-string">"Panel"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpPanelUIComponent</span>());
        registerCreator(<span class="hljs-string">"PopTree"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpPopTreeUIComponent</span>());
        registerCreator(<span class="hljs-string">"SVGPaper"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpSVGPaperUIComponent</span>());
        registerCreator(<span class="hljs-string">"Tabs"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpTabsUIComponent</span>());
        registerCreator(<span class="hljs-string">"TitleBlock"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpTitleBlockUIComponent</span>());
        registerCreator(<span class="hljs-string">"Tree"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpTreeUIComponent</span>());
        registerCreator(<span class="hljs-string">"ClassForm"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpClassFormUIComponent</span>());
        registerCreator(<span class="hljs-string">"MForm"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMFormUIComponent</span>());
        registerCreator(<span class="hljs-string">"TableForm"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpTableFormUIComponent</span>());
        registerCreator(<span class="hljs-string">"Grid"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpGridUIComponent</span>());
        registerCreator(<span class="hljs-string">"MGrid"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMGridUIComponent</span>());
        registerCreator(<span class="hljs-string">"TableGrid"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpTableGridUIComponent</span>());
        registerCreator(<span class="hljs-string">"MainIndex"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMainIndexUIComponent</span>());
        registerCreator(<span class="hljs-string">"ButtonViews"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpButtonViewsUIComponent</span>());
        registerCreator(<span class="hljs-string">"FoldingTabs"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpFoldingTabsUIComponent</span>());
        registerCreator(<span class="hljs-string">"Main"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMainUIComponent</span>());
        registerCreator(<span class="hljs-string">"MButtonViews"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMButtonViewsUIComponent</span>());
        registerCreator(<span class="hljs-string">"MNavButtonViews"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpMNavButtonViewsUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavButtonLayout"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavButtonLayoutUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavFoldingTree"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavFoldingTreeUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavGallery"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavGalleryUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavGroup"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavGroupUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavMenuBar"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavMenuBarUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavTabs"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavTabsUIComponent</span>());
        registerCreator(<span class="hljs-string">"NavTree"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpNavTreeUIComponent</span>());
        registerCreator(<span class="hljs-string">"Stacks"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">NlpStacksUIComponent</span>());
    }
}
</code></pre>
<h4 data-id="heading-24">3.3.2 支持的组件类型</h4>
<p>NlpComponentFactory 支持超过 30 种组件类型，包括：</p>
<p><strong>基础组件</strong>：</p>
<ul>
<li>Block、Div、Panel、Group</li>
<li>Form、Grid、Tree、Gallery</li>
<li>Tabs、Stacks、Layout</li>
</ul>
<p><strong>导航组件</strong>：</p>
<ul>
<li>NavButtonViews、NavGallery、NavGroup</li>
<li>NavMenuBar、NavTabs、NavTree</li>
<li>NavButtonLayout、NavFoldingTree</li>
</ul>
<p><strong>表单组件</strong>：</p>
<ul>
<li>ClassForm、MForm、TableForm</li>
<li>ButtonLayout、ContentBlock、TitleBlock</li>
</ul>
<p><strong>图表组件</strong>：</p>
<ul>
<li>ECharts、FChart</li>
<li>SVGPaper</li>
</ul>
<p><strong>主组件</strong>：</p>
<ul>
<li>MainIndex、Main</li>
<li>MButtonViews、MNavButtonViews</li>
</ul>
<h3 data-id="heading-25">3.4 LLM 和 Skills 接口</h3>
<h4 data-id="heading-26">3.4.1 LLMInterface 接口</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LLMInterface</span> {
    Object <span class="hljs-title function_">convertNaturalLanguageToConfig</span><span class="hljs-params">(String naturalLanguage, String componentType)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span>;
    String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInitialized</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>将自然语言转换为组件配置</li>
<li>支持多种 LLM 模型</li>
<li>提供初始化和关闭机制</li>
</ul>
<h4 data-id="heading-27">3.4.2 SkillsBridge 接口</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SkillsBridge</span> {
    Object <span class="hljs-title function_">processNaturalLanguage</span><span class="hljs-params">(String naturalLanguage, String componentType)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSkill</span><span class="hljs-params">(String skillName, Object skill)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">initialize</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span>;
    String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInitialized</span><span class="hljs-params">()</span>;
    Map&lt;String, Object&gt; <span class="hljs-title function_">getSkills</span><span class="hljs-params">()</span>;
    Object <span class="hljs-title function_">getSkill</span><span class="hljs-params">(String skillName)</span>;
}
</code></pre>
<p><strong>职责</strong>：</p>
<ul>
<li>处理自然语言并转换为组件配置</li>
<li>注册和管理技能</li>
<li>支持技能的动态扩展</li>
</ul>
<h3 data-id="heading-28">3.5 自学习机制原理</h3>
<h4 data-id="heading-29">3.5.1 技能注册机制</h4>
<p>SkillsBridge 支持动态注册技能：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerSkill</span><span class="hljs-params">(String skillName, Object skill)</span> {
    skills.put(skillName, skill);
}
</code></pre>
<p><strong>自学习过程</strong>：</p>
<ol>
<li>开发者定义技能规则</li>
<li>通过 registerSkill 注册技能</li>
<li>在转换时自动选择合适的技能</li>
<li>持续优化技能规则</li>
</ol>
<h4 data-id="heading-30">3.5.2 混合转换策略</h4>
<p>HYBRID 模式的混合转换策略：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72316b5196914b378380061ba5e02447~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=PFTgx8JKMz1fJfTPd2NVnYO%2BSfw%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p><strong>优势</strong>：</p>
<ol>
<li><strong>快速响应</strong>：Skills 通常比 LLM 更快</li>
<li><strong>高准确性</strong>：LLM 可以处理复杂场景</li>
<li><strong>高稳定性</strong>：Skills 失败时自动降级到 LLM</li>
<li><strong>持续优化</strong>：可以不断优化 Skills 规则</li>
</ol>
<hr/>
<h2 data-id="heading-31">4. 项目级模板规则配置</h2>
<h3 data-id="heading-32">4.1 UIPackagePathType 枚举</h3>
<p>UIPackagePathType 定义了 30+ 种不同的包路径类型，每种类型对应不同的系统模块：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/482f90db22d443bba5623b293bc59415~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=yAqcpqiKAyrzaInUFwMOPPGWTl8%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">UIPackagePathType</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IconEnumstype</span> {
    <span class="hljs-comment">// 用户工程</span>
    App(<span class="hljs-string">"App"</span>, <span class="hljs-string">"/App/"</span>, <span class="hljs-string">"用户工程"</span>, UIPackageType.sys, <span class="hljs-string">"ri-node-tree"</span>),
    
    <span class="hljs-comment">// 流程应用</span>
    bpm(<span class="hljs-string">"bpm"</span>, <span class="hljs-string">"/bpm/"</span>, <span class="hljs-string">"流程应用"</span>, UIPackageType.custom, <span class="hljs-string">"ri-node-tree"</span>),
    bpmadmin(<span class="hljs-string">"bpmadmin"</span>, <span class="hljs-string">"/bpm/admin/"</span>, <span class="hljs-string">"流程配置"</span>, UIPackageType.admin, <span class="hljs-string">"ri-settings-3-line"</span>),
    custom(<span class="hljs-string">"bpmcustom"</span>, <span class="hljs-string">"/bpm/custom/"</span>, <span class="hljs-string">"流程示例"</span>, UIPackageType.custom, <span class="hljs-string">"ri-flow-chart-line"</span>),
    bpmdisplay(<span class="hljs-string">"bpmdisplay"</span>, <span class="hljs-string">"/bpm/custom/display/"</span>, <span class="hljs-string">"流转控制"</span>, UIPackageType.custom, <span class="hljs-string">"ri-exchange-line"</span>),
    bpmlist(<span class="hljs-string">"bpmlist"</span>, <span class="hljs-string">"/bpm/custom/list/"</span>, <span class="hljs-string">"工作流"</span>, UIPackageType.custom, <span class="hljs-string">"ri-list-check-line"</span>),
    bpmform(<span class="hljs-string">"bpmform"</span>, <span class="hljs-string">"/bpm/form/"</span>, <span class="hljs-string">"工作流表单"</span>, UIPackageType.custom, <span class="hljs-string">"ri-file-line"</span>),
    
    <span class="hljs-comment">// 表单插件</span>
    formplugins(<span class="hljs-string">"formplugins"</span>, <span class="hljs-string">"/fdtform/plugins"</span>, <span class="hljs-string">"表单插件"</span>, UIPackageType.custom, <span class="hljs-string">"ri-puzzle-line"</span>),
    
    <span class="hljs-comment">// 用户定义</span>
    img(<span class="hljs-string">"img"</span>, <span class="hljs-string">"/img/"</span>, <span class="hljs-string">"图片"</span>, UIPackageType.userdef, <span class="hljs-string">"ri-image-line"</span>),
    css(<span class="hljs-string">"css"</span>, <span class="hljs-string">"/css/"</span>, <span class="hljs-string">"样式"</span>, UIPackageType.userdef, <span class="hljs-string">"ri-css3-line"</span>),
    
    <span class="hljs-comment">// JAVA 编译</span>
    java(<span class="hljs-string">"java"</span>, <span class="hljs-string">"/java/"</span>, <span class="hljs-string">"JAVA编译"</span>, UIPackageType.esd, <span class="hljs-string">"ri-code-box-line"</span>),
    debugproject(<span class="hljs-string">"debugproject"</span>, <span class="hljs-string">"/debugproject/"</span>, <span class="hljs-string">"预览"</span>, UIPackageType.esd, <span class="hljs-string">"ri-code-box-line"</span>),
    
    <span class="hljs-comment">// 嵌入模块</span>
    Module(<span class="hljs-string">"Module"</span>, <span class="hljs-string">"/Module/"</span>, <span class="hljs-string">"嵌入模块"</span>, UIPackageType.userdef, <span class="hljs-string">"ri-puzzle-line"</span>),
    
    <span class="hljs-comment">// 预览</span>
    preview(<span class="hljs-string">"preview"</span>, <span class="hljs-string">"/preview/"</span>, <span class="hljs-string">"预览"</span>, UIPackageType.admin, <span class="hljs-string">"ri-search-line"</span>),
    Debug(<span class="hljs-string">"Debug"</span>, <span class="hljs-string">"/Debug/"</span>, <span class="hljs-string">"调试运行"</span>, UIPackageType.admin, <span class="hljs-string">"ri-bug-line"</span>),
    
    <span class="hljs-comment">// 编辑器</span>
    RAD(<span class="hljs-string">"RAD"</span>, <span class="hljs-string">"/RAD/"</span>, <span class="hljs-string">"编辑器"</span>, UIPackageType.admin, <span class="hljs-string">"ri-cube-line"</span>),
    RADDB(<span class="hljs-string">"RADDB"</span>, <span class="hljs-string">"/RAD/db/"</span>, <span class="hljs-string">"数据库插件"</span>, UIPackageType.esd, <span class="hljs-string">"ri-database-line"</span>),
    RADServer(<span class="hljs-string">"RADServer"</span>, <span class="hljs-string">"/RAD/server/"</span>, <span class="hljs-string">"服务器插件"</span>, UIPackageType.esd, <span class="hljs-string">"ri-server-line"</span>),
    RADResource(<span class="hljs-string">"RADResource"</span>, <span class="hljs-string">"/RAD/resource/"</span>, <span class="hljs-string">"资源管理"</span>, UIPackageType.esd, <span class="hljs-string">"ri-box-3-line"</span>),
    RADProject(<span class="hljs-string">"RADProject"</span>, <span class="hljs-string">"/RAD/project/"</span>, <span class="hljs-string">"编辑器工程插件"</span>, UIPackageType.esd, <span class="hljs-string">"ri-node-tree"</span>),
    RADOrg(<span class="hljs-string">"RADOrg"</span>, <span class="hljs-string">"/RAD/org/"</span>, <span class="hljs-string">"协同插件"</span>, UIPackageType.esd, <span class="hljs-string">"ri-user-group-line"</span>),
    esd(<span class="hljs-string">"esd"</span>, <span class="hljs-string">"/esd/"</span>, <span class="hljs-string">"编辑器插件"</span>, UIPackageType.esd, <span class="hljs-string">"ri-puzzle-line"</span>),
    
    <span class="hljs-comment">// 系统菜单</span>
    systemnav(<span class="hljs-string">"systemnav"</span>, <span class="hljs-string">"/system/nav/"</span>, <span class="hljs-string">"导航菜单"</span>, UIPackageType.sys, <span class="hljs-string">"ri-menu-line"</span>),
    action(<span class="hljs-string">"action"</span>, <span class="hljs-string">"/action/"</span>, <span class="hljs-string">"系统菜单"</span>, UIPackageType.sys, <span class="hljs-string">"ri-css3-line"</span>),
    system(<span class="hljs-string">"system"</span>, <span class="hljs-string">"/system/"</span>, <span class="hljs-string">"统计监控"</span>, UIPackageType.sys, <span class="hljs-string">"ri-line-chart-line"</span>),
    
    <span class="hljs-comment">// 库表管理</span>
    db(<span class="hljs-string">"db"</span>, <span class="hljs-string">"/db/"</span>, <span class="hljs-string">"库表管理"</span>, UIPackageType.sys, <span class="hljs-string">"ri-database-line"</span>),
    fdt(<span class="hljs-string">"fdt"</span>, <span class="hljs-string">"/fdt/"</span>, <span class="hljs-string">"数据库示例"</span>, UIPackageType.sys, <span class="hljs-string">"ri-database-line"</span>),
    
    <span class="hljs-comment">// 工具</span>
    formula(<span class="hljs-string">"formula"</span>, <span class="hljs-string">"/admin/formula/"</span>, <span class="hljs-string">"公式管理"</span>, UIPackageType.tool, <span class="hljs-string">"ri-calculator-line"</span>),
    orgmanager(<span class="hljs-string">"orgmanager"</span>, <span class="hljs-string">"/admin/org/"</span>, <span class="hljs-string">"组织机构管理"</span>, UIPackageType.tool, <span class="hljs-string">"ri-node-tree"</span>),
    admin(<span class="hljs-string">"admin"</span>, <span class="hljs-string">"/admin/"</span>, <span class="hljs-string">"管理工具"</span>, UIPackageType.tool, <span class="hljs-string">"ri-tools-line"</span>),
    bpd(<span class="hljs-string">"bpd"</span>, <span class="hljs-string">"/admin/bpd/"</span>, <span class="hljs-string">"工作流插件"</span>, UIPackageType.tool, <span class="hljs-string">"ri-exchange-line"</span>),
    esdright(<span class="hljs-string">"esdright"</span>, <span class="hljs-string">"/esd/right/"</span>, <span class="hljs-string">"权限插件"</span>, UIPackageType.tool, <span class="hljs-string">"ri-key-line"</span>),
    esddic(<span class="hljs-string">"esddic"</span>, <span class="hljs-string">"/esd/dic/"</span>, <span class="hljs-string">"字典"</span>, UIPackageType.tool, <span class="hljs-string">"ri-book-line"</span>),
    esdpage(<span class="hljs-string">"esdpage"</span>, <span class="hljs-string">"/esd/page/"</span>, <span class="hljs-string">"页面插件"</span>, UIPackageType.tool, <span class="hljs-string">"ri-file-line"</span>),
    
    <span class="hljs-comment">// DSM 建模</span>
    dsm(<span class="hljs-string">"dsm"</span>, <span class="hljs-string">"/dsm/"</span>, <span class="hljs-string">"DSM建模"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-settings-3-line"</span>),
    dsmAgg(<span class="hljs-string">"dsm"</span>, <span class="hljs-string">"/dsm/agg/"</span>, <span class="hljs-string">"聚合模型"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-node-tree"</span>),
    dsmEsdClass(<span class="hljs-string">"dsmEsdClass"</span>, <span class="hljs-string">"/dsm/esdclass/"</span>, <span class="hljs-string">"实体关系"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-settings-3-line"</span>),
    dsmManger(<span class="hljs-string">"dsmManger"</span>, <span class="hljs-string">"/dsm/manager/"</span>, <span class="hljs-string">"领域实例"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-settings-3-line"</span>),
    dsmAdmin(<span class="hljs-string">"dsmAdmin"</span>, <span class="hljs-string">"/dsm/admin/"</span>, <span class="hljs-string">"控制台"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-speed-line"</span>),
    dsmWebSite(<span class="hljs-string">"dsmWebSite"</span>, <span class="hljs-string">"/dsm/website/"</span>, <span class="hljs-string">"模板站点"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-earth-line"</span>),
    dsmManager(<span class="hljs-string">"dsmManager"</span>, <span class="hljs-string">"/dsm/manager/"</span>, <span class="hljs-string">"DSM管理"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-tools-line"</span>),
    repository(<span class="hljs-string">"repository"</span>, <span class="hljs-string">"/dsm/repository/"</span>, <span class="hljs-string">"库表关系"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-database-line"</span>),
    dsmTable(<span class="hljs-string">"dsmTable"</span>, <span class="hljs-string">"/dsm/repository/table/"</span>, <span class="hljs-string">"资源"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-table-line"</span>),
    dsmNav(<span class="hljs-string">"dsmNav"</span>, <span class="hljs-string">"/dsm/nav/"</span>, <span class="hljs-string">"导航"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-menu-line"</span>),
    dsmTemp(<span class="hljs-string">"dsmTemp"</span>, <span class="hljs-string">"/dsm/temp/"</span>, <span class="hljs-string">"领域模板"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-file-copy-line"</span>),
    dsmWebSiteTemp(<span class="hljs-string">"dsmWebSiteTemp"</span>, <span class="hljs-string">"/dsm/website/temp/"</span>, <span class="hljs-string">"模板管理"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-file-copy-line"</span>),
    dsmSelect(<span class="hljs-string">"dsmSelect"</span>, <span class="hljs-string">"/dsm/website/select/"</span>, <span class="hljs-string">"站点模板"</span>, UIPackageType.dsm, <span class="hljs-string">"ri-earth-line"</span>);
}
</code></pre>
<p><strong>代码位置</strong>：UIPackagePathType.java</p>
<h3 data-id="heading-33">4.2 ProjectConfig 项目配置</h3>
<p>ProjectConfig 包含项目的所有配置信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProjectConfig</span> {
    <span class="hljs-comment">// 数据库配置</span>
    <span class="hljs-keyword">private</span> List&lt;DataBaseConfig&gt; dbConfigs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;DataBaseConfig&gt;();
    
    <span class="hljs-comment">// 用户包</span>
    <span class="hljs-keyword">private</span> String usrPackage;
    
    <span class="hljs-comment">// 项目名称</span>
    <span class="hljs-keyword">private</span> String projectName;
    
    <span class="hljs-comment">// 公共路径</span>
    <span class="hljs-keyword">private</span> String publicPath;
    
    <span class="hljs-comment">// 工作空间</span>
    <span class="hljs-keyword">private</span> String workSpace;
    
    <span class="hljs-comment">// 资源类型</span>
    <span class="hljs-keyword">private</span> ProjectResourceType resourceType;
    
    <span class="hljs-comment">// API 过滤器</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; apiFilter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    
    <span class="hljs-comment">// 自定义模块过滤器</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; customModuleFilter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    
    <span class="hljs-comment">// 索引</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-string">"App.index"</span>;
    
    <span class="hljs-comment">// 公共服务器 URL</span>
    <span class="hljs-keyword">private</span> String publicServerUrl;
    
    <span class="hljs-comment">// 扩展组件</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; extcoms = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; extmodules = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    
    <span class="hljs-comment">// 字体、图片、样式</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; fonts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; imgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    <span class="hljs-keyword">private</span> List&lt;String&gt; styles = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    
    <span class="hljs-comment">// 开发人员</span>
    <span class="hljs-keyword">public</span> Map&lt;ProjectRoleType, Set&lt;String&gt;&gt; devPersons = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;ProjectRoleType, Set&lt;String&gt;&gt;();
}
</code></pre>
<p><strong>代码位置</strong>：ProjectConfig.java</p>
<h3 data-id="heading-34">4.3 项目级配置的层次结构</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cd3a1adf9ea40a5a0bae4cb95aa1afc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=WRKO2%2BJIcDrpXCwBnhqxrqrXhyM%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>4.4 项目级配置的优势</p>
<ol>
<li><strong>独立性</strong>：每个项目可以独立配置，互不影响</li>
<li><strong>灵活性</strong>：支持自定义模块、API 过滤器等</li>
<li><strong>扩展性</strong>：支持扩展组件和模块</li>
<li><strong>可维护性</strong>：配置集中管理，易于维护</li>
<li><strong>团队协作</strong>：支持多角色开发人员配置</li>
</ol>
<hr/>
<h2 data-id="heading-35">5. BridgeCode 核心架构</h2>
<h3 data-id="heading-36">5.1 BridgeCode 与传统代码生成的区别</h3>




























































<table><thead><tr><th align="left">特性</th><th align="left">传统代码生成</th><th align="left">BridgeCode</th></tr></thead><tbody><tr><td align="left">代码格式</td><td align="left">JavaScript/Java</td><td align="left">Java (注解驱动)</td></tr><tr><td align="left">生成方式</td><td align="left">静态生成</td><td align="left">动态生成 (C2U)</td></tr><tr><td align="left">集成方式</td><td align="left">手动集成</td><td align="left">自动集成</td></tr><tr><td align="left">更新方式</td><td align="left">重新生成</td><td align="left">热加载 (C2U)</td></tr><tr><td align="left">版本控制</td><td align="left">困难</td><td align="left">支持 VFS</td></tr><tr><td align="left">类型安全</td><td align="left">弱类型</td><td align="left">强类型</td></tr><tr><td align="left">维护性</td><td align="left">低</td><td align="left">高</td></tr><tr><td align="left">模板数量</td><td align="left">固定</td><td align="left">几百种 (NLP)</td></tr><tr><td align="left">配置粒度</td><td align="left">全局</td><td align="left">项目级</td></tr><tr><td align="left">自学习</td><td align="left">无</td><td align="left">支持 (NLP)</td></tr></tbody></table>
<h3 data-id="heading-37">5.2 BridgeCode 的设计理念</h3>
<p>BridgeCode 的设计理念是"声明式生成，运行时集成，自学习优化"：</p>
<ol>
<li><strong>声明式生成</strong>：通过注解和元数据声明代码的生成规则，而不是直接生成代码</li>
<li><strong>运行时集成</strong>：在运行时动态加载和集成代码，而不是在编译时静态集成</li>
<li><strong>元数据驱动</strong>：通过 DSM 元数据驱动代码生成，而不是硬编码生成逻辑</li>
<li><strong>热加载</strong>：支持运行时动态加载和更新代码，无需重启应用</li>
<li><strong>自学习优化</strong>：通过 NLP Module 自学习机制，持续优化模板规则</li>
</ol>
<h3 data-id="heading-38">5.3 BridgeCode 核心架构图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a1e8c5c160a4305919673795e69956d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=dzD0b%2Bdk57HjqajCde4o89TNHJo%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-39">6.1 模板数量与分类</h3>
<p>Ooder D2B 框架支持几百种模板，通过多个维度进行分类：</p>
<h4 data-id="heading-40">6.1.1 按组件类型分类</h4>
















































































<table><thead><tr><th align="left">组件类型</th><th align="left">模板数量</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">Block</td><td align="left">5+</td><td align="left">块组件模板</td></tr><tr><td align="left">Div</td><td align="left">5+</td><td align="left">DIV 容器模板</td></tr><tr><td align="left">Form</td><td align="left">10+</td><td align="left">表单组件模板</td></tr><tr><td align="left">Grid</td><td align="left">10+</td><td align="left">网格组件模板</td></tr><tr><td align="left">Tree</td><td align="left">8+</td><td align="left">树形组件模板</td></tr><tr><td align="left">Gallery</td><td align="left">5+</td><td align="left">画廊组件模板</td></tr><tr><td align="left">SVG</td><td align="left">5+</td><td align="left">SVG 绘图模板</td></tr><tr><td align="left">Tabs</td><td align="left">8+</td><td align="left">标签页模板</td></tr><tr><td align="left">Chart</td><td align="left">10+</td><td align="left">图表模板</td></tr><tr><td align="left">Panel</td><td align="left">5+</td><td align="left">面板模板</td></tr><tr><td align="left">Layout</td><td align="left">5+</td><td align="left">布局模板</td></tr><tr><td align="left">导航组件</td><td align="left">20+</td><td align="left">导航组件模板</td></tr><tr><td align="left">主组件</td><td align="left">5+</td><td align="left">主组件模板</td></tr><tr><td align="left">表单组件</td><td align="left">10+</td><td align="left">表单字段模板</td></tr></tbody></table>
<p><strong>总计</strong>：超过 100 种组件模板</p>
<h4 data-id="heading-41">6.1.2 按应用场景分类</h4>

































































<table><thead><tr><th align="left">应用场景</th><th align="left">模板数量</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left">用户工程 (App)</td><td align="left">10+</td><td align="left">用户应用模板</td></tr><tr><td align="left">流程应用 (bpm)</td><td align="left">20+</td><td align="left">流程管理模板</td></tr><tr><td align="left">表单插件</td><td align="left">10+</td><td align="left">表单插件模板</td></tr><tr><td align="left">JAVA 编译</td><td align="left">15+</td><td align="left">Java 编译模板</td></tr><tr><td align="left">嵌入模块</td><td align="left">10+</td><td align="left">嵌入模块模板</td></tr><tr><td align="left">编辑器 (RAD)</td><td align="left">20+</td><td align="left">编辑器模板</td></tr><tr><td align="left">系统菜单</td><td align="left">15+</td><td align="left">系统菜单模板</td></tr><tr><td align="left">统计监控</td><td align="left">10+</td><td align="left">监控统计模板</td></tr><tr><td align="left">库表管理</td><td align="left">10+</td><td align="left">库表管理模板</td></tr><tr><td align="left">工具</td><td align="left">15+</td><td align="left">工具模板</td></tr><tr><td align="left">DSM 建模</td><td align="left">20+</td><td align="left">DSM 建模模板</td></tr></tbody></table>
<p><strong>总计</strong>：超过 150 种应用场景模板</p>
<h3 data-id="heading-42">6.2 模板的自学习机制</h3>
<h4 data-id="heading-43">6.2.1 AI 辅助维护</h4>
<p>Ooder 框架通过 AI Skills 辅助完成复杂的模板库维护：</p>
<ol>
<li><strong>规则学习</strong>：通过 Skills 学习模板使用规则</li>
<li><strong>模式识别</strong>：识别常用的模板组合模式</li>
<li><strong>智能推荐</strong>：根据使用情况推荐模板</li>
<li><strong>自动优化</strong>：自动优化模板参数</li>
</ol>
<h4 data-id="heading-44">6.2.2 模板版本管理</h4>
<p>通过 VFS 支持模板版本管理：</p>
<ol>
<li><strong>版本控制</strong>：每个模板可以有多个版本</li>
<li><strong>版本切换</strong>：支持不同版本之间的切换</li>
<li><strong>版本回滚</strong>：支持回滚到历史版本</li>
<li><strong>版本对比</strong>：支持版本之间的对比</li>
</ol>
<h4 data-id="heading-45">6.2.3 模板共享机制</h4>
<p>支持模板的共享和复用：</p>
<ol>
<li><strong>项目内共享</strong>：项目内模板共享</li>
<li><strong>跨项目共享</strong>：跨项目模板共享</li>
<li><strong>全局共享</strong>：全局模板共享</li>
<li><strong>自定义模板</strong>：支持自定义模板</li>
</ol>
<h3 data-id="heading-46">6.3 模板生态的优势</h3>
<ol>
<li><strong>丰富性</strong>：几百种模板覆盖各种场景</li>
<li><strong>灵活性</strong>：支持自定义和扩展</li>
<li><strong>智能化</strong>：AI 辅助维护，持续优化</li>
<li><strong>可维护性</strong>：版本管理，易于维护</li>
<li><strong>可复用性</strong>：支持共享和复用</li>
</ol>
<hr/>
<h2 data-id="heading-47">7. 框架优势总结</h2>
<h3 data-id="heading-48">7.1 核心优势</h3>
<p>Ooder D2B 框架相比传统代码生成方案，具有以下核心优势：</p>
<h4 data-id="heading-49">7.1.1 无缝集成</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/831fb2b199db4718b866b01c9d462587~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966904&amp;x-signature=0L9hXNF8pDd1zH9CmrksfHxCXt0%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p><strong>传统方案</strong>：</p>
<ul>
<li>需要手动配置才能与现有系统集成</li>
<li>生成的代码可能覆盖手动编写的代码</li>
<li>集成复杂，容易出错</li>
</ul>
<p><strong>BridgeCode 方案</strong>：</p>
<ul>
<li>自动集成，无需手动配置</li>
<li>通过注解声明生成规则，避免代码冲突</li>
<li>运行时动态加载，即时生效</li>
</ul>
<h4 data-id="heading-50">7.1.2 开发效率</h4>
<p><strong>传统方案</strong>：</p>
<ul>
<li>需要重新编译和重启应用</li>
<li>开发效率低，迭代周期长</li>
<li>团队协作困难</li>
</ul>
<p><strong>BridgeCode 方案</strong>：</p>
<ul>
<li>热加载，无需重启应用</li>
<li>开发效率高，快速迭代</li>
<li>支持团队协作</li>
</ul>
<h4 data-id="heading-51">7.1.3 类型安全</h4>
<p><strong>传统方案</strong>：</p>
<ul>
<li>弱类型，运行时才发现错误</li>
<li>难以保证代码质量</li>
<li>维护困难</li>
</ul>
<p><strong>BridgeCode 方案</strong>：</p>
<ul>
<li>强类型，编译时发现错误</li>
<li>保证代码质量</li>
<li>易于维护</li>
</ul>
<h4 data-id="heading-52">7.1.4 可维护性</h4>
<p><strong>传统方案</strong>：</p>
<ul>
<li>生成的代码难以理解</li>
<li>维护困难，修改后重新生成会丢失变更</li>
<li>版本管理困难</li>
</ul>
<p><strong>BridgeCode 方案</strong>：</p>
<ul>
<li>注解清晰明了，易于理解</li>
<li>通过元数据驱动，修改不会丢失</li>
<li>支持 VFS 版本管理</li>
</ul>
<h4 data-id="heading-53">7.1.5 扩展性</h4>
<p><strong>传统方案</strong>：</p>
<ul>
<li>模板数量固定，难以扩展</li>
<li>不支持自定义模板</li>
<li>扩展困难</li>
</ul>
<p><strong>BridgeCode 方案</strong>：</p>
<ul>
<li>支持几百种模板</li>
<li>支持自定义和扩展</li>
<li>AI 辅助维护，持续优化</li>
</ul>
<h3 data-id="heading-54">7.2 技术优势</h3>
<ol>
<li><strong>C2U 动态编译</strong>：支持运行时动态编译和加载</li>
<li><strong>NLP Module 自学习</strong>：通过 AI 辅助完成复杂的模板库维护</li>
<li><strong>项目级配置</strong>：每个项目可以独立设置规则和模板</li>
<li><strong>模板生态</strong>：几百种模板，覆盖各种场景</li>
<li><strong>VFS 管理</strong>：支持版本控制和共享</li>
</ol>
<h3 data-id="heading-55">7.3 业务优势</h3>
<ol>
<li><strong>降低成本</strong>：减少手动编码工作量</li>
<li><strong>提高质量</strong>：保证代码质量和一致性</li>
<li><strong>加速交付</strong>：快速迭代，加速项目交付</li>
<li><strong>降低风险</strong>：减少人为错误，降低项目风险</li>
<li><strong>提升体验</strong>：热加载，提升开发和用户体验</li>
</ol>
<hr/>
<h2 data-id="heading-56">8. 最佳实践</h2>
<h3 data-id="heading-57">8.1 C2U 动态编译最佳实践</h3>
<h4 data-id="heading-58">8.1.1 合理使用缓存</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用时间缓存避免频繁加载</span>
<span class="hljs-type">Long</span> <span class="hljs-variable">createTime</span> <span class="hljs-operator">=</span> (Long) contextMap.get(url + <span class="hljs-string">"[TIME]"</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">module</span> == <span class="hljs-literal">null</span> &amp;&amp; (createTime == <span class="hljs-literal">null</span> || System.currentTimeMillis() - createTime &gt; <span class="hljs-number">500</span>)) {
    <span class="hljs-comment">// 重新加载</span>
}
</code></pre>
<h4 data-id="heading-59">8.1.2 线程安全</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 synchronized 保证线程安全</span>
<span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">module</span>.getClassName()) {
    <span class="hljs-comment">// 动态编译逻辑</span>
}
</code></pre>
<h4 data-id="heading-60">8.1.3 异常处理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 完善的异常处理</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">module</span> = buildView(methodAPIBean, <span class="hljs-literal">null</span>, projectName, valueMap, !isCache(methodAPIBean));
} <span class="hljs-keyword">catch</span> (Exception e) {
    e.printStackTrace();
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JDSException</span>(e);
}
</code></pre>
<h3 data-id="heading-61">8.2 NLP Module 最佳实践</h3>
<h4 data-id="heading-62">8.2.1 选择合适的转换模式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 生产环境使用 HYBRID 模式</span>
<span class="hljs-type">FullNlpComponentConverter</span> <span class="hljs-variable">converter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FullNlpComponentConverter</span>(llmInterface, skillsBridge);
converter.setConversionMode(FullNlpComponentConverter.ConversionMode.HYBRID);
</code></pre>
<h4 data-id="heading-63">8.2.2 注册自定义技能</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 注册自定义技能</span>
skillsBridge.registerSkill(<span class="hljs-string">"customSkill"</span>, customSkillImplementation);
</code></pre>
<h4 data-id="heading-64">8.2.3 初始化和关闭</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 正确初始化和关闭</span>
llmInterface.initialize();
skillsBridge.initialize();

<span class="hljs-comment">// 使用完成后关闭</span>
llmInterface.close();
skillsBridge.close();
</code></pre>
<h3 data-id="heading-65">8.3 项目配置最佳实践</h3>
<h4 data-id="heading-66">8.3.1 合理设置项目配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设置项目配置</span>
<span class="hljs-type">ProjectConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProjectConfig</span>();
config.setProjectName(<span class="hljs-string">"myProject"</span>);
config.setUsrPackage(<span class="hljs-string">"com.example"</span>);
config.setApiFilter(Arrays.asList(<span class="hljs-string">"api1"</span>, <span class="hljs-string">"api2"</span>));
</code></pre>
<h4 data-id="heading-67">8.3.2 使用包路径类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 UIPackagePathType 确定包路径</span>
<span class="hljs-type">UIPackagePathType</span> <span class="hljs-variable">pathType</span> <span class="hljs-operator">=</span> UIPackagePathType.fromSystemCode(<span class="hljs-string">"bpm"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">pattern</span> <span class="hljs-operator">=</span> pathType.getPattern();
</code></pre>
<h4 data-id="heading-68">8.3.3 配置开发人员</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 配置开发人员</span>
config.addDevPersons(ProjectRoleType.developer, <span class="hljs-string">"user1"</span>);
config.addDevPersons(ProjectRoleType.tester, <span class="hljs-string">"user2"</span>);
</code></pre>
<h3 data-id="heading-69">8.4 模板使用最佳实践</h3>
<h4 data-id="heading-70">8.4.1 选择合适的模板</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 根据组件类型选择模板</span>
<span class="hljs-type">String</span> <span class="hljs-variable">componentType</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Form"</span>;
<span class="hljs-type">NlpBaseUIComponent</span> <span class="hljs-variable">component</span> <span class="hljs-operator">=</span> converter.convertFromNaturalLanguage(<span class="hljs-string">"创建一个用户表单"</span>, componentType);
</code></pre>
<h4 data-id="heading-71">8.4.2 自定义模板</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义模板</span>
NlpComponentFactory.registerCreator(<span class="hljs-string">"CustomComponent"</span>, () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomNlpComponent</span>());
</code></pre>
<h4 data-id="heading-72">8.4.3 版本管理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用 VFS 进行版本管理</span>
<span class="hljs-type">Folder</span> <span class="hljs-variable">versionFolder</span> <span class="hljs-operator">=</span> dsmInst.getJavaFolder().createChildFolder(<span class="hljs-string">"version-1.0"</span>);
versionFolder.upload(<span class="hljs-string">"template.ftl"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(templateFile));
</code></pre>
<hr/>
<h2 data-id="heading-73">9. 总结</h2>
<h3 data-id="heading-74">9.1 核心要点</h3>
<p>本文深入剖析了 BridgeCode 如何与企业原有代码合体的核心机制：</p>
<ol>
<li><strong>C2U 动态编译</strong>：支持运行时动态编译和加载代码，无需重启应用</li>
<li><strong>NLP Module 自学习</strong>：通过 AI 辅助完成复杂的模板库维护，支持几百种模板</li>
<li><strong>项目级配置</strong>：每个项目可以独立设置规则和模板，支持 30+ 种包路径类型</li>
<li><strong>元数据驱动</strong>：通过 DSM 元数据驱动代码生成，与现有代码库无缝集成</li>
<li><strong>VFS 管理</strong>：通过虚拟文件系统管理生成的代码，支持版本控制</li>
</ol>
<h3 data-id="heading-75">9.2 技术优势</h3>
<p>BridgeCode 机制具有以下技术优势：</p>
<ol>
<li><strong>无缝集成</strong>：与企业原有代码无缝集成，无需修改现有代码</li>
<li><strong>开发效率</strong>：热加载、动态编译，提高开发效率，快速迭代</li>
<li><strong>类型安全</strong>：强类型检查，编译时发现错误</li>
<li><strong>可维护性</strong>：注解清晰明了，易于理解和维护</li>
<li><strong>扩展性</strong>：支持几百种模板，支持自定义和扩展，AI 辅助维护</li>
</ol>
<h3 data-id="heading-76">9.3 应用场景</h3>
<p>BridgeCode 机制适用于以下场景：</p>
<ol>
<li><strong>企业级应用</strong>：企业级应用开发，需要与现有代码库集成</li>
<li><strong>快速原型</strong>：快速原型开发，快速迭代</li>
<li><strong>动态扩展</strong>：动态扩展功能，无需重启应用</li>
<li><strong>代码生成</strong>：代码生成场景，自动生成代码</li>
<li><strong>元数据驱动</strong>：元数据驱动开发，基于配置生成代码</li>
</ol>
<h3 data-id="heading-77">9.4 未来展望</h3>
<p>BridgeCode 机制的未来发展方向：</p>
<ol>
<li><strong>更多模板</strong>：支持更多模板类型，覆盖更多场景</li>
<li><strong>更好的 AI</strong>：集成更先进的 AI 模型，提高自学习能力</li>
<li><strong>更好的性能</strong>：优化性能，提高编译和加载速度</li>
<li><strong>更好的工具</strong>：提供更好的开发工具，提高开发体验</li>
<li><strong>更好的社区</strong>：建立更好的社区生态，促进交流和学习</li>
</ol>
<h3 data-id="heading-78">9.5 结语</h3>
<p>BridgeCode 机制是 Ooder D2B 框架的核心创新，通过 C2U 动态编译、NLP Module 自学习、项目级配置等技术，实现了与企业原有代码的无缝集成。它不仅解决了传统代码生成的痛点，还为企业级应用开发提供了一种全新的思路和方法。</p>
<p>Ooder 框架通过几百种模板、AI 辅助维护、项目级配置等特性，构建了一个强大的代码生成生态系统。这个生态系统不仅提高了开发效率，还保证了代码质量和可维护性。</p>
<p>希望本文能够帮助读者深入理解 BridgeCode 机制，并在实际项目中应用和推广。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用星流AI做库洛米卡牌APP，每一张都颜值爆表！]]></title>    <link>https://juejin.cn/post/7603263490343075849</link>    <guid>https://juejin.cn/post/7603263490343075849</guid>    <pubDate>2026-02-06T07:16:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603263490343075849" data-draft-id="7603283691457740810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用星流AI做库洛米卡牌APP，每一张都颜值爆表！"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2026-02-06T07:16:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿星AI工作室"/> <meta itemprop="url" content="https://juejin.cn/user/2250051536050763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用星流AI做库洛米卡牌APP，每一张都颜值爆表！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250051536050763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿星AI工作室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:16:22.000Z" title="Fri Feb 06 2026 07:16:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3f9dd3e3a25426bbfaefed31d8a9808~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=Flmh7iEGg1vnJoFzX2aZdsbXlzc%3D" alt="图片" loading="lazy"/></p>
<p>家人们，库洛米脑袋要嗨疯了，</p>
<p>我不仅把它做成了手势交互游戏，又甜又酷。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56465fbe30ee4d739acc63443bf421c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=J9MnDMQDSZ4VwJQwOqIvU0ut4BI%3D" alt="图片" loading="lazy"/></p>
<p>而且我做了全套库洛米APP，</p>
<p>可以感受暗黑甜心沉浸式体验哦。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71745a2b82ec4476a2a73ca7808e42a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=lqwxDu5KYFkuju5eieJqEZ8a4dw%3D" alt="图片" loading="lazy"/></p>
<p>这是我用星流agent做的库洛米卡牌</p>
<p>星流，就是国内版的lovart没有网络要求，小白特友好。</p>
<h2 data-id="heading-0">设计风格选择</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fefcb10dc6d644cfa41c813f90f46c65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=PAPco5duR3zRa1aFZ%2Fq7cFGnjng%3D" alt="图片" loading="lazy"/></p>
<p>而且很久之前就有做卡牌游戏的想法了，但是我在网上找素材。</p>
<p>找了很久，发现都是这种经典式的卡牌素材。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76fdbeedad194be7bceda1632936e866~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=UwrMcYrMdErkTM6AeYxRA9%2Bo%2FoU%3D" alt="图片" loading="lazy"/></p>
<p>比如说github上这个，但是我想有自己的设计风格，</p>
<p>虽然我没学过设计，</p>
<p>刚好看到有人在星流社区发布了自己做的这个库洛米的demo。</p>
<p>所以我就按照他的提示词思路来做了这一套卡牌。</p>
<p>它其实全套的78张，大概20分钟，每一张小表情都超有戏。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed6c39e04b274a1fbd482dffacc230fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=E0Lg%2B4%2BPFE4eLE0Gj0PThxwOwws%3D" alt="图片" loading="lazy"/></p>
<p>就画质在多端运行也不会糊掉，因为我用我那个超大屏幕试了还是超级清晰，我真的每张都好喜欢。</p>
<p>就是要出去开盲盒，我要能开这么多库洛米，我得快乐死，这样你就可以拥有全套库洛米卡牌了。</p>
<h2 data-id="heading-1">接入iosAPP</h2>
<p>接下来阿星想把它搬到苹果APP上，就预览一下。我得先定好全套的交互脚本视觉清单。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efe3123e92764a658f64225f2119bd1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=JopDz8nea1iqY6OHka4BzhA2HO8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">告诉星流UI组件命名清单</h2>
<p>接着我就把这些需求都丢给了星流——因为我先写好交互脚本（代码），定好了每个角色的名字（变量名），然后再把这份【命名清单】丢给星流。这样它生成的每一张图，都不需要我二次改名，实现真正的 <strong>落地即生产</strong> 。</p>
<p>跟它说：请帮我生成库洛米全套UI，命名规范如下</p>
<p>告诉星流建议的 <strong>命名规范清单，你可以把这个part所有内容直接告诉星流</strong> ：</p>
<h3 data-id="heading-3">基础资源命名规范 (Base Assets)</h3>



































<table><thead><tr><th>资源类型</th><th>命名格式</th><th>示例</th><th>作用</th></tr></thead><tbody><tr><td>启动图</td><td>img_splash</td><td>img_splash.png</td><td>对应 App 启动画面</td></tr><tr><td>背景图</td><td>bg_类型</td><td>bg_main_purple, bg_card_yellow</td><td>作为 SwiftUI ZStack 的最底层</td></tr><tr><td>按钮图</td><td>btn_功能_状态</td><td>btn_draw_normal, btn_draw_pressed</td><td>用于自定义 Button Style</td></tr><tr><td>图标</td><td>ic_名称</td><td>ic_heart, ic_star, ic_kuromi_head</td><td>用于导航栏或功能点缀</td></tr></tbody></table>
<h3 data-id="heading-4">核心卡牌资源 (重点：序列化命名)</h3>
<p>为了让那 78 张卡牌能通过 <code>ForEach</code> 循环自动渲染， <strong>严禁使用中文或无规律名称</strong> 。</p>
<ul>
<li>• <strong>命名规则：</strong> <code>card_序号</code> 或 <code>card_类型_序号</code></li>
</ul>
<h3 data-id="heading-5">iOS 组件与 UI 零件 (Component Assets)</h3>
<p>针对你让星流生成的 UI 零件，命名如下：</p>
<ul>
<li>• <strong>小组件 (Widgets):</strong></li>
<li>
<ul>
<li>• <code>widget_small_luck</code> (今日运势小组件)</li>
<li>• <code>widget_medium_history</code> (占卜历史中组件)</li>
</ul>
</li>
<li>• <strong>装饰件 (Decorations):</strong></li>
<li>
<ul>
<li>• <code>deco_frame_gold</code> (卡牌外框)</li>
<li>• <code>deco_crystal_ball</code> (水晶球动画素材)</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-6">如何在 Prompt 中要求“星流”？</h3>
<p>当你让“星流”生成图集时， <strong>结尾可以在 Prompt 结尾加上这一段指令：</strong></p>
<blockquote>
<p>请确保 UI 资源清晰分离。如果提供工作表，请将它们以网格形式排列。在命名或引用这些资源时，使用小写字母和下划线（例如，btn_start_draw、bg_tarot_main）。对于 78 张塔罗牌，遵循严格的顺序命名约定，如 card_01 到 card_78，以便于编码集成。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">开发者小贴士 <strong>切图透明度</strong></h3>
<p><strong>切图透明度：</strong>  要求星流生成图标（Icons）和按钮（Buttons）时，背景必须是 <strong>纯色（如纯黑或纯白）</strong>  ，最好要求星流直接生成带有 Alpha 通道的透明 PNG，如果星流做不到，再使用纯色背景方案。</p>
<p>它就直接按照我的开发命名规范精准生成完了。</p>
<h2 data-id="heading-8">生成UI组件素材</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/353fd4ff0f2042b8809c98abf1079c1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=WOjTxGmv58gYJgvMed5ZInozoMI%3D" alt="图片" loading="lazy"/></p>
<p>大到背景图，</p>
<p>小到交互按钮的全套截图都ok了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34c41574d01c433bbc5b65583acfc247~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=yXX0A3R06i8zaPbRag9tGQjyfy0%3D" alt="图片" loading="lazy"/></p>
<p>然后我把这些组件图片直接拖进Xcode里面。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79d44e19a18c4b58b935683cfde62761~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=q%2BGikpxaLuAjQ9fcc3ff04EA2Ek%3D" alt="图片" loading="lazy"/></p>
<p>点击build就可以直接运行成功了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5fe2d1b935d4c94b4d745b9ae839e97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=33CLtY%2BBZFJSEStGIUUfilqmdCQ%3D" alt="图片" loading="lazy"/></p>
<p>要知道如果名字对不上的话，</p>
<p>咱们的这个程序是没法跑起来的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f930971b01d1493c829a74df3a37f16d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=CK2BubvpeNSqYTejFO7fmGDYAtk%3D" alt="图片" loading="lazy"/></p>
<p>而星流AI它非常出色的完成了每张UI图的命名。</p>
<p>它既扮演了设计师，就比如说给咱们用prompt出图，又扮演了前端程序员，</p>
<p>把图片上的名称和咱们在程序里面的命名方式是高度的一致，</p>
<p>这样的话才会有那种丝滑的体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74543178cd424cacb487be1a3e692286~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=oGsMtTb%2F%2BQm4aUcsqcqYQTG0fMk%3D" alt="图片" loading="lazy"/></p>
<p>要上架了，</p>
<p>那我们再来一套APP store广告图，</p>
<p>官方尺寸告诉新流瞬间get，省去了以往要做多种尺寸icon的重复工作。</p>
<p>这是每一个上架过IOSAPP首选最痛苦的地方。</p>
<p>因为苹果官方它有很多很多种要求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/332538b957ac4805a9809a3231186e56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=u5%2BRkFYYpSFxfYAwduM4YbCGjrc%3D" alt="图片" loading="lazy"/></p>
<p>ok。继续</p>
<p>有任何不满意的地方就可以用他们家的文字编辑txt edit和精准编辑touch edit来修改，</p>
<p>改哪里，完全不需要重新作图。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3feeb2aa71ab4dd19dae366f149a439e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=t9lDdDEk%2BvgKstFvQCPiFbuttbg%3D" alt="图片" loading="lazy"/></p>
<p>总之阿星之后的独立开发的UI设计，感觉都可以用星流来代表了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03bfe1566c7a49f3b9a53d7e09da3c7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=HpTk6feCVf4nvUZtyPFegotWbN8%3D" alt="图片" loading="lazy"/></p>
<p>颜值高还懂开发需求，我有信心成为全干工程师了。</p>
<p>我自己的话是仅供自己欣赏，大家如果要发布的话是要注意版权的。</p>
<p>OK，我是阿星！</p>
<p>更多AI应用，我们下期再见👋🏻</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93ddb5496c3248ea9809ebbc90c229f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966981&amp;x-signature=apu4LFjfzliu5X3EE3CWkBi7Kw0%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 2.7 封装全屏弹窗组件：基于命名空间的样式定制]]></title>    <link>https://juejin.cn/post/7603283691457822730</link>    <guid>https://juejin.cn/post/7603283691457822730</guid>    <pubDate>2026-02-06T07:14:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603283691457822730" data-draft-id="7603359026710855690" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 2.7 封装全屏弹窗组件：基于命名空间的样式定制"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-02-06T07:14:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="user8615818578154"/> <meta itemprop="url" content="https://juejin.cn/user/3549647826599133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 2.7 封装全屏弹窗组件：基于命名空间的样式定制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3549647826599133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    user8615818578154
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:14:40.000Z" title="Fri Feb 06 2026 07:14:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Vue 2.7 + Element UI 项目中，封装全屏 Iframe 弹窗常遇到样式覆盖无效的问题。特别是开启 <code>append-to-body</code> 后，弹窗 DOM 位于根节点，常规的 <code>scoped</code> 样式难以生效。</p>
<p>本文介绍一种<strong>不依赖 <code>scoped</code></strong>，通过CSS 命名空间来实现安全样式隔离的方案。</p>
<h2 data-id="heading-0">1. 核心需求</h2>
<ul>
<li><strong>全屏沉浸</strong>：弹窗无边距、无默认内边距。</li>
<li><strong>DOM 结构安全</strong>：必须使用 <code>append-to-body</code>，防止被父级容器截断。</li>
<li><strong>样式无污染</strong>：在全局样式模式下，确保只影响当前组件。</li>
</ul>
<h2 data-id="heading-1">2. 组件实现 (<code>SurveyPortal.vue</code>)</h2>
<h3 data-id="heading-2">Template 结构</h3>
<p>关键在于设置 <code>custom-class</code>。这个唯一的类名将作为我们的“样式防火墙”。</p>
<pre><code class="hljs language-ini" lang="ini">&lt;template&gt;
  &lt;el-dialog
    :<span class="hljs-attr">visible.sync</span>=<span class="hljs-string">"dialogVisible"</span>
    :<span class="hljs-attr">title</span>=<span class="hljs-string">"title"</span>
    fullscreen
    :<span class="hljs-attr">append-to-body</span>=<span class="hljs-string">"true"</span>
    :<span class="hljs-attr">destroy-on-close</span>=<span class="hljs-string">"true"</span>
    <span class="hljs-attr">custom-class</span>=<span class="hljs-string">"survey-portal-dialog"</span> 
    @<span class="hljs-attr">close</span>=<span class="hljs-string">"handleClose"</span>
  &gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"iframe-wrapper"</span> v-loading=<span class="hljs-string">"loading"</span>&gt;
      &lt;iframe
        :<span class="hljs-attr">src</span>=<span class="hljs-string">"surveyUrl"</span>
        <span class="hljs-attr">frameborder</span>=<span class="hljs-string">"0"</span>
        <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span>
        <span class="hljs-attr">height</span>=<span class="hljs-string">"100%"</span>
        @<span class="hljs-attr">load</span>=<span class="hljs-string">"onIframeLoad"</span>
      &gt;&lt;/iframe&gt;
    &lt;/div&gt;
  &lt;/el-dialog&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-3">Script 逻辑</h3>
<p>保持标准的 Vue 2.7 写法，计算属性处理 URL，Watch 处理双向绑定。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">&lt;script setup&gt;
<span class="hljs-keyword">import</span> { ref, watch, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">visible</span>: <span class="hljs-title class_">Boolean</span>,
  <span class="hljs-attr">surveyId</span>: { <span class="hljs-attr">type</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Number</span>], <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> },
  <span class="hljs-attr">title</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>, <span class="hljs-attr">default</span>: <span class="hljs-string">'外部页面'</span> }
});

<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'update:visible'</span>, <span class="hljs-string">'close'</span>]);

<span class="hljs-keyword">const</span> dialogVisible = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>);

<span class="hljs-keyword">const</span> surveyUrl = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-string">`/wj/<span class="hljs-subst">${props.surveyId}</span>`</span>);

<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">visible</span>, <span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> {
  dialogVisible.<span class="hljs-property">value</span> = val;
  <span class="hljs-keyword">if</span> (val) loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
});

<span class="hljs-title function_">watch</span>(dialogVisible, <span class="hljs-function">(<span class="hljs-params">val</span>) =&gt;</span> {
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'update:visible'</span>, val);
});

<span class="hljs-keyword">const</span> <span class="hljs-title function_">onIframeLoad</span> = (<span class="hljs-params"/>) =&gt; {
  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClose</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">emit</span>(<span class="hljs-string">'close'</span>);
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-4">3. 样式处理（命名空间隔离法）</h2>
<p>由于 <code>append-to-body</code> 将 DOM 移出了组件作用域，我们放弃 <code>scoped</code>，转而使用<strong>全局样式</strong>。为了防止污染全局，我们将所有样式严格包裹在 <code>custom-class</code> 定义的唯一类名中。</p>
<h3 data-id="heading-5">CSS 实现原理</h3>
<ol>
<li><strong>去掉 <code>scoped</code></strong>：让样式变为全局可见。</li>
<li><strong>顶层包裹</strong>：所有规则必须写在 <code>.survey-portal-dialog</code> 内部。</li>
<li><strong>覆盖 Element UI</strong>：直接选中 <code>.el-dialog__body</code> 进行重置。</li>
</ol>
<pre><code class="hljs language-SCSS" lang="SCSS">&lt;style lang="scss"&gt;
<span class="hljs-comment">/* * 注意：不加 scoped 
 * 通过 ".survey-portal-dialog" 这个唯一类名实现逻辑隔离
 */</span>
<span class="hljs-selector-class">.survey-portal-dialog</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;

  <span class="hljs-comment">/* 1. 修正头部样式 */</span>
  <span class="hljs-selector-class">.el-dialog__header</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span> <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ebeef5</span>;
  }

  <span class="hljs-comment">/* 2. 暴力清除 Body 内边距，实现全屏无缝 */</span>
  <span class="hljs-selector-class">.el-dialog__body</span> {
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-meta">!important</span>;
    <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  }

  <span class="hljs-comment">/* 3. 内部 Iframe 容器高度计算 */</span>
  <span class="hljs-selector-class">.iframe-wrapper</span> {
    <span class="hljs-comment">/* 减去 Header 高度(约54px)，避免出现双重滚动条 */</span>
    <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span> - <span class="hljs-number">54px</span>);
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
    <span class="hljs-attribute">overflow</span>: hidden;
  }
}
&lt;/style&gt;
</code></pre>
<h2 data-id="heading-6">4. 方案优劣分析</h2>
<ul>
<li>
<p><strong>优点</strong>：</p>
<ul>
<li><strong>极度稳定</strong>：不受 Vue Loader 版本或 <code>scoped</code> 穿透语法（<code>/deep/</code> vs <code>::v-deep</code>）变更的影响。</li>
<li><strong>符合直觉</strong>：完美兼容 <code>append-to-body</code> 的 DOM 移动行为。</li>
</ul>
</li>
<li>
<p><strong>注意点</strong>：</p>
<ul>
<li><strong>命名唯一性</strong>：必须保证 <code>survey-portal-dialog</code> 这个类名在项目中是唯一的，避免与其他弹窗冲突。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-7">5. 总结</h2>
<p>在处理 Element UI 的 <code>append-to-body</code> 弹窗时，“全局样式 + 唯一类名包裹”是最简单且副作用最小的方案。它通过 CSS 选择器的嵌套规则，手动建立了一个“样式沙箱”，既解决了全屏覆盖问题，又规避了全局污染风险。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个月手搓 JavaScript runtime]]></title>    <link>https://juejin.cn/post/7603393977476546586</link>    <guid>https://juejin.cn/post/7603393977476546586</guid>    <pubDate>2026-02-06T07:08:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603393977476546586" data-draft-id="7603393977476530202" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 一个月手搓 JavaScript runtime"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-02-06T07:08:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             一个月手搓 JavaScript runtime
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:08:17.000Z" title="Fri Feb 06 2026 07:08:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fthemackabu.dev%2Fblog%2Fjs-in-one-month" target="_blank" title="https://themackabu.dev/blog/js-in-one-month" ref="nofollow noopener noreferrer">building a javascript runtime in one month</a></p>
<p>作者：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthemackabu" target="_blank" title="https://github.com/themackabu" ref="nofollow noopener noreferrer">themackabu</a></p>
<p>日期：2026年1月2日</p>
<p>翻译：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN" target="_blank" title="https://github.com/TUARAN" ref="nofollow noopener noreferrer">TUARAN</a></p>
<p>欢迎关注 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn" ref="nofollow noopener noreferrer">前端周刊</a>，每周更新国外论坛的前端热门文章，紧跟时事，掌握前端技术动态。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">TL;DR</h2>
<p>我做了一个叫 <strong>Ant</strong> 的小型 JavaScript runtime（大概 2MB）。源码、测试和文档都在 GitHub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthemackabu%2Fant%2F" target="_blank" title="https://github.com/themackabu/ant/" ref="nofollow noopener noreferrer">github.com/themackabu/…</a>。</p>
<hr/>
<p>我在 11 月初开始做这个项目时，脑子里只有一个简单念头：</p>
<p>如果能做一个足够小、能嵌进 C 程序里，但又足够完整、能跑真实代码的 JavaScript 引擎，会怎么样？</p>
<p>一个你可以发布出去、却不用捆上几百 MB 的 V8 或 Node 的东西。我以前也试过做“极简版 Deno”的路子，但始终不够。</p>
<p>我没想到这会花一个月；更没想到一个月真的做得出来。但不设 deadline 的项目有个特点：你会一直往前推，推着推着就做出来了。</p>
<h2 data-id="heading-1">第一周：纯纯生存模式</h2>
<p>我是一边做一边学——说白了就是不断试错，然后把每一个错误也一起“发布”出去。最开始的工作只围绕最基本的东西：</p>
<ul>
<li>数值运算</li>
<li>字符串内建函数</li>
<li>一个非常粗糙的 CommonJS 模块系统</li>
</ul>
<p>每一次提交都像是在虚无里抢回一点点地盘。</p>
<p>最核心的问题是 <strong>解析（parsing）</strong>。在其它东西能工作之前，你必须先有 parser。而 parser 往往比看起来复杂得多。JavaScript 这种语言尤其“诡异”：</p>
<ul>
<li>自动分号插入（ASI）是规范的一部分，你得处理</li>
<li><code>this</code> 的绑定会随上下文变化</li>
<li><code>var</code> 的提升（hoisting）意味着变量会在赋值前就“存在”</li>
<li>甚至 <code>window.window.window</code> 这种写法都是合法的……</li>
</ul>
<p>我前几天做的主要是把基本流程跑通，类似一个“能算数、也能调用函数”的计算器。由于动量已经起来了，我就一直继续。</p>
<p>runtime 的核心数据表示大概长这样：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-type">uint64_t</span> <span class="hljs-type">jsval_t</span>;
</code></pre>
<p>在这个 runtime 里，每一个 JavaScript 值都用一个 64 位整数表示：<strong>NaN-boxing</strong>。</p>
<p>IEEE 754 浮点规范有个“洞”：理论上存在 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>53</mn></msup></mrow><annotation encoding="application/x-tex">2^{53}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"/><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">53</span></span></span></span></span></span></span></span></span></span></span></span></span> 种 NaN，其中绝大多数从来不会被用到。所以我把它们“偷”来用了。</p>
<p>如果把一个 64 位值按 double 解释时它看起来像 NaN，同时 exponent 与 mantissa 又满足你定义的模式，那么你就可以在这些 bit 里塞一个 tag。你有足够空间同时存一个指针和一个类型标签：把对象引用和类型 tag 一起塞进 64 bit，瞬间所有 JS 值都能塞进一个 machine word。</p>
<p>编译期断言也证明了前提：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">_Static_assert</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>) == <span class="hljs-number">8</span>, <span class="hljs-string">"NaN-boxing requires 64-bit IEEE 754 doubles"</span>);
<span class="hljs-keyword">_Static_assert</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>) == <span class="hljs-number">8</span>, <span class="hljs-string">"NaN-boxing requires 64-bit integers"</span>);
<span class="hljs-keyword">_Static_assert</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">double</span>) == <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint64_t</span>), <span class="hljs-string">"double and uint64_t must have same size"</span>);
</code></pre>
<p>这就成了 runtime 表示“一切”的心脏：每个数字、对象、字符串、函数、Promise、参数、作用域……全部都是一个 <code>jsval_t</code>。</p>
<p>没有“带标签联合体”、没有 vtable、也不需要额外分配元数据——只有 bits。为了把它调顺，我迭代了好几天；但一旦跑通，其它东西就会更快更顺。NaN 和 Infinity 当然也有坑，不过通过微调 boxing 布局也能解决。</p>
<p>大约第 4 天我让变量能用了，第 5 天函数能用了，第 6 天循环能跑了。早期提交非常散：箭头函数、IIFE、可选链、空值合并……我就是一边翻 MDN 一边想起啥加啥。</p>
<h2 data-id="heading-2">垃圾回收（GC）灾难</h2>
<p>然后就撞上了真正的硬骨头：<strong>内存管理</strong>。</p>
<p>一个 JavaScript runtime 必须有 GC，你不可能要求用户手动 free 对象。所以到第二周左右，我开始尝试自己实现 GC。</p>
<p>结果是一场噩梦：</p>
<ul>
<li>我加新特性会把 GC 搞崩</li>
<li>我修 GC 又会把性能搞崩</li>
<li>我试着接入别人写的 GC，又发现集成复杂到不可控</li>
</ul>
<p>这段时间我非常痛苦。手写的 free-list GC 被我开开关关上百次，每次都能把另一个核心模块弄坏。有些日子我明显已经快崩了：凌晨三点 debug，试图弄清为什么协程栈没被保护好、为什么内存泄漏、为什么加了 JSON 支持之后一切都坏了。</p>
<p>转折点是：<strong>放弃手写 GC，改用 bdwgc</strong>。</p>
<p>这是一个生产级 GC（很多语言都在用）。我把它和自己手写的“带前向引用跟踪的内存压缩”结合起来：它能做 mark、能做 forwarding 的哈希表、能做生产 GC 会做的所有事。</p>
<p>一旦集成上去，内存问题大部分就消失了。我写代码的“语气”也变了：东西开始更稳定地工作起来，我加了 <code>process</code> 模块、把错误信息做得更友好——速度从这里开始明显加快。</p>
<h2 data-id="heading-3">Promise / async：另一个野兽</h2>
<p>你以为 async/await 很简单，直到你尝试自己实现它。</p>
<p>要实现 async/await，你需要 Promise；Promise 需要 microtask 与定时器；microtask 与定时器又需要事件循环；事件循环还要有地方存异步操作的状态。</p>
<p>我为这件事折腾了好几天：</p>
<ul>
<li>想让 async 工作，你需要协程</li>
<li>协程需要调度</li>
<li>调度需要事件循环</li>
<li>事件循环还要知道协程什么时候结束</li>
</ul>
<p>如果协程在等 I/O，你不能阻塞；如果某个协程死了，它也不该把整个系统拖死。</p>
<p>你看提交历史就能感受到痛苦：<em>"async promise pushback"</em>、<em>"segfault when event loop empty"</em>、<em>"prevent dead task from blocking"</em>……这些坑都是做到一半才会冒出来的。</p>
<p>更要命的是：JS Promise 不能“简化”。它必须支持 <code>.then()</code> 链式调用，必须正确 reject，还要能与 async function 配合——而 async function 本质上是 generator 的语法糖，而 generator 又是 Promise 与回调的语法糖……</p>
<p>大约第 10 天，我引入了 <strong>minicoro</strong> 作为协程支持。这个决定大概救了整个项目。minicoro 很优雅：你定义基于栈的协程，然后让系统在它们之间切换。有了协程，我终于能让 async 真正跑起来。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">coroutine</span> {</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">js</span> *<span class="hljs-title">js</span>;</span>
	<span class="hljs-type">coroutine_type_t</span> type;
	<span class="hljs-type">jsval_t</span> scope;
	<span class="hljs-type">jsval_t</span> this_val;
	<span class="hljs-type">jsval_t</span> awaited_promise;
	<span class="hljs-type">jsval_t</span> result;
	<span class="hljs-type">jsval_t</span> async_func;
	<span class="hljs-type">jsval_t</span> *args;
	<span class="hljs-type">int</span> nargs;
	<span class="hljs-type">bool</span> is_settled;
	<span class="hljs-type">bool</span> is_error;
	<span class="hljs-type">bool</span> is_done;
	<span class="hljs-type">jsoff_t</span> resume_point;
	<span class="hljs-type">jsval_t</span> yield_value;
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">coroutine</span> *<span class="hljs-title">prev</span>;</span>
	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">coroutine</span> *<span class="hljs-title">next</span>;</span>
	mco_coro* mco;
	<span class="hljs-type">bool</span> mco_started;
	<span class="hljs-type">bool</span> is_ready;
} <span class="hljs-type">coroutine_t</span>;
</code></pre>
<p>所有 async 执行相关的信息都塞进了这个结构：scope、<code>this</code>、正在等待哪个 promise、是否出错……接着我只需要调度这些东西并管理事件循环。</p>
<p>有了协程以后，Promise 才“成真”：<code>.then()</code> 链能跑，<code>await</code> 会真正暂停并在之后恢复执行。runtime 的 async 侧开始成形。后面我再补齐 Promise 内建时就快很多了，因为最难的那部分已经解决。</p>
<h2 data-id="heading-4">JavaScript 的“诡异边缘案例”</h2>
<p>中间两周基本就是：不停发现 JavaScript 比我预想中更诡异。</p>
<p>不可配置属性、freeze/seal、可选链的边缘语义、严格模式……听起来都不难，但每一个背后都是几十年的规范细节，真实世界的代码会依赖这些行为。</p>
<p>我一个个啃过去：</p>
<ul>
<li>处理冻结/密封对象</li>
<li>支持不可配置属性</li>
<li>第 10 次修解构</li>
<li>给属性查找加 getter/setter 的访问器支持</li>
</ul>
<p>每天都在撞一个新边缘案例。有时候一天修好几个：我实现一个功能、跑一致性测试、发现三个 bug、修完之后又冒出五个新 bug。</p>
<p>你知道 JavaScript 有多少种方式访问原型链吗？</p>
<ul>
<li><code>__proto__</code></li>
<li><code>Object.getPrototypeOf()</code></li>
<li><code>Object.setPrototypeOf()</code></li>
<li><code>[[Prototype]]</code> 内部槽</li>
</ul>
<p>你得把它们全部做对，而且还要彼此一致。一个看起来很短的提交信息，比如 “use descriptor tables for getters/setters/properties”，背后可能就是几周的工作。</p>
<p>解构看起来也很简单：<code>const [a, b] = arr</code>。</p>
<p>但稀疏数组怎么办？对象的可枚举属性怎么办？嵌套解构、默认值、<code>...rest</code> 参数怎么办？每次修一个点都像打地鼠：修好这里，那里又坏。</p>
<p>一致性测试在“最好的意义上”非常残酷：每次跑都会失败在一个我根本不知道存在的语义上。然后我修掉它，继续失败在下一个。这个循环发生了几十次。</p>
<h2 data-id="heading-5">后半程：开始变得“能用”</h2>
<p>第二周时，我已经有了一个能执行代码的 JavaScript runtime。它不完整，但它是真的。</p>
<p>然后我开始加那些让它变得“有用”的东西：文件系统、路径工具、URL 模块、以及那个因为 Bun 而变得很有名的内建 HTTP server。突然之间，<strong>真实程序</strong>开始能在 Ant 上跑了。</p>
<p>比如一个 Web 服务器只要写：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { join } <span class="hljs-keyword">from</span> <span class="hljs-string">'ant:path'</span>;
<span class="hljs-keyword">import</span> { readFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'ant:fs'</span>;
<span class="hljs-keyword">import</span> { createRouter, addRoute, findRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'rou3'</span>;

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>();

<span class="hljs-title function_">addRoute</span>(router, <span class="hljs-string">'GET'</span>, <span class="hljs-string">'/status/:id'</span>, <span class="hljs-keyword">async</span> c =&gt; {
	<span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>));

	<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Hello'</span>);
	<span class="hljs-keyword">const</span> name = <span class="hljs-keyword">await</span> <span class="hljs-title function_">readFile</span>(<span class="hljs-title function_">join</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">dirname</span>, <span class="hljs-string">'name.txt'</span>));

	<span class="hljs-keyword">const</span> base = <span class="hljs-string">'{{name}} {{version}} server is responding with'</span>;
	<span class="hljs-keyword">const</span> data = { name, <span class="hljs-attr">version</span>: <span class="hljs-title class_">Ant</span>.<span class="hljs-title function_">version</span>() };

	<span class="hljs-keyword">return</span> c.<span class="hljs-property">res</span>.<span class="hljs-title function_">body</span>(<span class="hljs-string">`<span class="hljs-subst">${base.template(data)}</span> <span class="hljs-subst">${result}</span> <span class="hljs-subst">${c.params.id}</span>!`</span>);
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">c</span>) {
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'request:'</span>, c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>, c.<span class="hljs-property">req</span>.<span class="hljs-property">uri</span>);
	<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">findRoute</span>(router, c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>, c.<span class="hljs-property">req</span>.<span class="hljs-property">uri</span>);

	<span class="hljs-keyword">if</span> (result?.<span class="hljs-property">data</span>) {
		c.<span class="hljs-property">params</span> = result.<span class="hljs-property">params</span>;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> result.<span class="hljs-title function_">data</span>(c);
	}

	c.<span class="hljs-property">res</span>.<span class="hljs-title function_">body</span>(<span class="hljs-string">'not found: '</span> + c.<span class="hljs-property">req</span>.<span class="hljs-property">uri</span>, <span class="hljs-number">404</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'started on http://localhost:8000'</span>);
<span class="hljs-title class_">Ant</span>.<span class="hljs-title function_">serve</span>(<span class="hljs-number">8000</span>, handleRequest);
</code></pre>
<p>运行起来就是：</p>
<pre><code class="hljs language-bash" lang="bash">$ ant examples/server/server.js
started on http://localhost:8000

$ curl http://localhost:8000/status/world
Ant 0.3.2.6 server is responding with Hello world!
</code></pre>
<p>这就是“真 JavaScript”跑在 Ant 里：async/await、文件 I/O、HTTP、带参数路由、网络、字符串操作。</p>
<p>之后节奏更快：每天更自信，修更多 bug，加更多特性。然后到了“冷门但必须”的阶段：Proxy、Reflection、Symbol，甚至 class 私有字段/方法。它们也许很少人用，但规范里写了就得支持。</p>
<p>我最喜欢的一类能力之一是 <strong>Atomics</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> sharedBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedArrayBuffer</span>(<span class="hljs-number">256</span>);

<span class="hljs-keyword">const</span> int32View = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int32Array</span>(sharedBuffer);
<span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">store</span>(int32View, <span class="hljs-number">0</span>, <span class="hljs-number">42</span>);
<span class="hljs-keyword">const</span> value = <span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">load</span>(int32View, <span class="hljs-number">0</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'stored 42, loaded:'</span>, value);

<span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">store</span>(int32View, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>);
<span class="hljs-keyword">const</span> oldValue = <span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">add</span>(int32View, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'old value:'</span>, oldValue);

<span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">store</span>(int32View, <span class="hljs-number">2</span>, <span class="hljs-number">100</span>);
<span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">compareExchange</span>(int32View, <span class="hljs-number">2</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'exchanged, new value:'</span>, <span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">load</span>(int32View, <span class="hljs-number">2</span>));
</code></pre>
<pre><code class="hljs language-bash" lang="bash">$ ant examples/atomics.js
stored 42, loaded: 42
old value: 10
exchanged, new value: 200
</code></pre>
<h2 data-id="heading-6">最后一周：多米诺骨牌一样倒下</h2>
<p>当 Ant 的核心 runtime 能跑、GC 稳了、Promise 也通了之后，其它东西就像多米诺骨牌一样：小问题被修掉、缺的方法补齐、边缘语义逐个处理。</p>
<p>我重新加回了数组 length 校验，修了对象的属性缓存失效逻辑；为了优化 hash 性能又掉进“复杂算法 + 安全影响”的兔子洞——因为我已经在打磨一个“能工作的东西”。</p>
<p>到第 28 天，我给一个真的能用的 runtime 收尾：支持 async/await、靠谱的内存管理、网络、文件 I/O、并通过 ES1–ES5 的一致性测试，还混搭了一堆更现代的特性。</p>
<p>我甚至在别人提醒之后才“想起来”打开 LTO 和一些编译器 flag 😅</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d32e5b0a1cb44e182e79748dda03079~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966501&amp;x-signature=Pjjr%2F0zBH5skHvHX9z%2BMnmjHcO8%3D" alt="uzaaft" loading="lazy"/></p>
<h2 data-id="heading-7">最终结果</h2>
<p>一个月后，Ant 作为 JavaScript runtime：</p>
<ul>
<li>通过 javascript-zoo 测试套件中 ES1 到 ES5 的每一个一致性测试（25 年规范跨度的完整兼容）</li>
<li>实现 async/await，并具备正确的 Promise 与 microtask 行为</li>
<li>拥有一个真的能用、且不漏内存的 GC</li>
<li>基于 libuv 运行 Web 服务器（和 Node 类似的网络底座）</li>
<li>支持通过 FFI 调用系统库，例如：</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { dlopen, suffix, <span class="hljs-title class_">FFIType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'ant:ffi'</span>;

<span class="hljs-keyword">const</span> sqlite3 = <span class="hljs-title function_">dlopen</span>(<span class="hljs-string">`libsqlite3.<span class="hljs-subst">${suffix}</span>`</span>);

sqlite3.<span class="hljs-title function_">define</span>(<span class="hljs-string">'sqlite3_libversion'</span>, {
	<span class="hljs-attr">args</span>: [],
	<span class="hljs-attr">returns</span>: <span class="hljs-title class_">FFIType</span>.<span class="hljs-property">string</span>
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`version: <span class="hljs-subst">${sqlite3.sqlite3_libversion()}</span>`</span>);
</code></pre>
<pre><code class="hljs language-bash" lang="bash">$ ant examples/ffi/basic/sqlite.js
version: 3.43.2
</code></pre>
<ul>
<li>支持读写文件与异步 I/O</li>
<li>支持正确的作用域、提升、变量遮蔽</li>
<li>支持 class、箭头函数、解构、展开、模板字符串、可选链</li>
<li>覆盖一些多数人根本不会想到的“怪边缘”：<code>__proto__</code> 赋值、属性描述符、不可配置属性、冻结/密封对象（可参考测试：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthemackabu%2Fant%2Fblob%2Fmaster%2Ftests%2F__proto__.js" target="_blank" title="https://github.com/themackabu/ant/blob/master/tests/__proto__.js" ref="nofollow noopener noreferrer"><code>tests/__proto__.js</code></a>）</li>
<li>实现 ES Module（import / export）</li>
<li>支持 Symbol、Proxy、Reflect、WeakMap/WeakSet、Map/Set</li>
<li>支持共享内存与 Atomics 并发原语</li>
</ul>
<p>把这些串起来，你会发现你面对的已经几乎是一个“完整的 JavaScript runtime”，不太像玩具。</p>
<h2 data-id="heading-8">代价</h2>
<p>我不知道代价是什么。</p>
<p>可能是睡眠，可能是健康，可能是本来可以拿去做任何其它事情的大把时间。</p>
<p>有些日子我连续工作 10+ 小时；有些日子一天 20+ commits。项目不会减速，只会加速：每天更自信、更快、修更多 bug、加更多特性。</p>
<p>到最后，我开始撞上那些必须去读 ECMAScript 规范、去理解 V8 行为、去对比其它引擎怎么处理某个怪角落的工作。改符号计数、优化 class、把内部属性迁移到 slots（像 V8 那样）……这类优化正常应该等代码稳定后再做，但因为地基已经稳了，我在最后一周反而有了余力去做。</p>
<h2 data-id="heading-9">发布后：优化阶段</h2>
<p>首个 release 是 11 月 26 日。之后是一段沉默——那种“发完版本之后就没声了”的沉默。直到 12 月 20 日左右，开发又恢复。</p>
<p>这一次不同：runtime 能跑、能过测试，但总有更多优化空间。xctrace 让我看清什么才是真正的瓶颈。12 月下旬和 1 月初的提交呈现一种模式：找到瓶颈 → 修复 → 测量提升。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/066c3f4daf4a42bf811380a18180ce41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966501&amp;x-signature=iLb1Fg4MH9%2B8wsdBhOBHdyxUrGI%3D" alt="fast" loading="lazy"/></p>
<p>我先为 typed array 加了 arena allocator。之前 typed array 散落在 heap 的各处；我把它们集中起来，加速分配并改善 cache locality。</p>
<p>然后我把 getter/setter/property 从“每个 descriptor 单独分配”改成“descriptor table 批处理”：更少的分配、更少的指针追逐。</p>
<p>让 <code>.</code> 运算符支持 property reference 也很烦：每次查属性都要全量解析；于是我加了 reference table 跳过重复工作。</p>
<p>我很喜欢 dispatch table。我把 FFI、JSON 等路径改为 computed goto，让 CPU 直接跳到正确的 handler：少一次分支、少一次查找。</p>
<p>把 properties 迁到 slots 是最侵入的一次重构。对象之前用的是灵活但慢的属性系统；slots 则是按对象类型固定结构，让 runtime 能做更多假设，减少 indirection。</p>
<p>某个时刻我开始拿它对比 Node：跑同样 benchmark，Ant 表现如何？结果开始变得很好——好到你会想：我是不是能在某些点上赢 Node？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9db5280b5f3f4835b5b4e4af63a7ae63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770966501&amp;x-signature=iYGhJDm9lr9CzROb%2FRPV3m5ER58%3D" alt="bunnerfly wow" loading="lazy"/></p>
<p>优化 Ant 的过程中我会保留一些可工作的 snapshot：如果某次优化把东西搞坏了，我还能退回到一个稳定点。于是就能持续小步推进：每次提交都比上一次快一点。有些优化有效，有些没用，但整体模式始终成立：profile → optimize → measure → commit。</p>
<p>然后是 GC 的改进。在最初那一个月里 bdwgc 集成得挺好，但在优化阶段的某个时刻它被禁掉了，runtime 就开始漏内存。我重新加回“可延迟 GC”的机制，并把旧 GC 的大部分代码取消注释。</p>
<p>但这次不是老办法：我做的是一个 mark-copy + compact 的 GC，能真正做内存碎片整理。旧 GC 的问题是它在错误的时机运行，导致热路径卡顿。所以我让它“可延迟”：在逻辑工作单元之间再收集；同时用前向引用跟踪保证对象移动后指针不坏。GC 回来了，但更聪明：它会等到合适的点暂停，并在运行时压缩堆。</p>
<h2 data-id="heading-10">为什么会做这件事</h2>
<p>老实说，我也不知道。</p>
<p>也许是赌气？也许是想证明点什么？也许是纯粹的执念。</p>
<p>那种“进入心流”的状态：你写着写着，八小时就过去了，已经凌晨四点，然后你把代码 commit 掉，第二天又继续。</p>
<p>这个项目之所以存在，是因为我脑子里某个东西决定“它必须存在”，并且直到它真的存在之前都不会停。</p>
<p>它并不完美。代码里可能还有没发现的 bug；可能还有没做的性能优化；可能还有漏掉的规范角落。</p>
<p>但它能跑：你可以写真实 JavaScript，它会执行；你可以用 async/await；你可以写服务器；你可以拿它去做真实事情。</p>
<p>如果你曾经好奇：一个人如果足够执着、又不睡觉，能做到什么？答案就是：做出一个规范兼容的 JavaScript 引擎。</p>
<p>源码、测试与文档都在：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthemackabu%2Fant%2F" target="_blank" title="https://github.com/themackabu/ant/" ref="nofollow noopener noreferrer">github.com/themackabu/…</a>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《TanStack Start 深入解析：Single Flight Mutations 机制（第二篇）》]]></title>    <link>https://juejin.cn/post/7603352117638856713</link>    <guid>https://juejin.cn/post/7603352117638856713</guid>    <pubDate>2026-02-06T07:34:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603352117638856713" data-draft-id="7603352117638791177" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《TanStack Start 深入解析：Single Flight Mutations 机制（第二篇）》"/> <meta itemprop="keywords" content="前端,面试,JavaScript"/> <meta itemprop="datePublished" content="2026-02-06T07:34:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《TanStack Start 深入解析：Single Flight Mutations 机制（第二篇）》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:34:19.000Z" title="Fri Feb 06 2026 07:34:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fsingle-flight-mutations-in-tanstack-start-part-2%2F" target="_blank" title="https://frontendmasters.com/blog/single-flight-mutations-in-tanstack-start-part-2/" ref="nofollow noopener noreferrer">Single Flight Mutations in TanStack Start: Part 2</a></p>
<p>作者：Adam Rackis</p>
<p>日期：2026年1月28日</p>
<p>翻译：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN" target="_blank" title="https://github.com/TUARAN" ref="nofollow noopener noreferrer">TUARAN</a></p>
<p>欢迎关注 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn" ref="nofollow noopener noreferrer">前端周刊</a>，每周更新国外论坛的前端热门文章，紧跟时事，掌握前端技术动态。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">TL;DR</h2>
<p>这篇文章延续 Part 1 的思路：把一次 mutation 所需的 UI 更新数据，在同一次网络往返里一起带回来（避免 mutation 后再额外发请求 refetch）。</p>
<p>Part 2 的重点是把“要 refetch 哪些查询”抽成可复用的 middleware：调用 server function 时传入 react-query 的 <code>QueryKey[]</code>，middleware 会在客户端从 Query Cache 找到每个 query 对应的 <code>serverFn</code> 和参数，把这些信息通过 <code>sendContext</code> 送到服务端统一执行，然后把结果回传给客户端并用 <code>setQueryData</code> 写回缓存。</p>
<hr/>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fsingle-flight-mutations-in-tanstack-start-part-1%2F" target="_blank" title="https://frontendmasters.com/blog/single-flight-mutations-in-tanstack-start-part-1/" ref="nofollow noopener noreferrer">Part 1</a> 里，我们聊过 single flight mutations：它让你在更新数据时，同时把 UI 需要的所有相关“已更新数据”重新获取回来，并且整个过程只需要一次跨网络的往返。</p>
<p>我们当时做了个很朴素的实现：在“更新数据”的 server function 里直接把需要的东西 refetch 一遍。它确实能用，但可扩展性和灵活性都一般（耦合也偏重）。</p>
<p>这篇文章我们会实现同样的效果，但方式更通用：定义一个“refetch middleware”，把它挂到任意 server function 上。这个 middleware 允许我们通过 react-query 的 key 指定要 refetch 的数据，剩下的事情它会自动完成。</p>
<p>我们会先做一个最简单版本，然后不断加能力、加灵活性。到最后会稍微复杂一些，但请别误会：你不需要把文中讲的全部都用上。事实上，对绝大多数应用来说，single flight mutations 可能完全无关紧要。更别被“高级做法”迷惑了：对很多小应用而言，直接在 server function 里 refetch 一点数据可能就足够了。</p>
<p>不过，跟着做一遍，我们会看到一些很酷的 TanStack（甚至 TypeScript）特性。即便你永远不用 single flight mutations，这些内容也很可能在别的场景派上用场。</p>
<h2 data-id="heading-1">我们的第一个 Middleware</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftanstack.com%2Fquery%2Flatest" target="_blank" title="https://tanstack.com/query/latest" ref="nofollow noopener noreferrer">TanStack Query</a>（我们有时也会称它为 react-query，这是它的包名）已经有一套非常好用的层级 key 系统。如果我们的 middleware 能直接接收“要 refetch 的 query keys”，然后就……自动搞定，那该多好？</p>
<p>问题在于：middleware 要怎么知道“怎么 refetch”呢？第一眼看确实有点难。我们的 queries（刻意保持简单）本质上都是对 server functions 的调用。但我们没法把一个普通函数引用传到服务端；函数不可序列化，这很合理。你能把字符串/数字/布尔值序列化成 JSON 在线上传输，但一个函数可能带状态、闭包、上下文……传过去根本说不清。</p>
<p>除非——它是 TanStack Start 的 server function。</p>
<p>这个项目背后的工程师们为序列化引擎做了定制，使其支持 server functions。也就是说：你可以从客户端把一个 server function “发到”服务端，它能正常工作。底层原理是：server functions 有一个内部 ID。TanStack 会捕捉到它、发送 ID，然后在另一端把 ID 反序列化成对应的 server function。</p>
<p>为了让事情更简单，我们不妨把 server function（以及它需要的参数）直接放到我们已经定义好的 query options 上。这样 middleware 只要拿到 query keys，就能从 TanStack Query 的 cache 里找到对应的 query options，拿到“如何 refetch”的信息，然后把整个流程串起来。</p>
<h2 data-id="heading-2">开始吧</h2>
<p>首先引入一些好用的东西：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createMiddleware, getRouterInstance } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tanstack/react-start"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">QueryClient</span>, <span class="hljs-title class_">QueryKey</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tanstack/react-query"</span>;
</code></pre>
<p>接着更新我们的 epics 列表查询（主要的 epics 列表）的 query options：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">epicsQueryOptions</span> = (<span class="hljs-params">page: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>, page],
    <span class="hljs-attr">queryFn</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getEpicsList</span>({ <span class="hljs-attr">data</span>: page });
      <span class="hljs-keyword">return</span> result;
    },
    <span class="hljs-attr">staleTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
    <span class="hljs-attr">gcTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">__revalidate</span>: {
        <span class="hljs-attr">serverFn</span>: getEpicsList,
        <span class="hljs-attr">arg</span>: page,
      },
    },
  });
};
</code></pre>
<p>注意这个新增的 <code>meta</code> 区块。它允许我们往 query 上塞任何我们需要的元数据。这里我们放了 <code>getEpicsList</code> 这个 server function 的引用以及它需要的参数。这样写确实会有“重复”（<code>queryFn</code> 写了一次调用方式，<code>meta</code> 又写了一次），如果你觉得别扭，先别急，后面会处理。summary 查询（用于统计数量）我们也会同样更新，不过这里没贴代码。</p>
<p>接下来我们把 middleware 一点点拼出来：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// the server function and args are all `any`, for now, </span>
<span class="hljs-comment">// to keep things simple we'll see how to type them in a bit</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">RevalidationPayload</span> = {
  <span class="hljs-attr">refetch</span>: {
    <span class="hljs-attr">key</span>: <span class="hljs-title class_">QueryKey</span>;
    <span class="hljs-attr">fn</span>: <span class="hljs-built_in">any</span>;
    <span class="hljs-attr">arg</span>: <span class="hljs-built_in">any</span>;
  }[];
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">RefetchMiddlewareConfig</span> = {
  <span class="hljs-attr">refetch</span>: <span class="hljs-title class_">QueryKey</span>[];
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> refetchMiddleware = <span class="hljs-title function_">createMiddleware</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span> })
  .<span class="hljs-title function_">inputValidator</span>(<span class="hljs-function">(<span class="hljs-params">config?: RefetchMiddlewareConfig</span>) =&gt;</span> config)
  .<span class="hljs-title function_">client</span>(<span class="hljs-keyword">async</span> ({ next, data }) =&gt; {
    <span class="hljs-keyword">const</span> { refetch = [] } = data ?? {};
</code></pre>
<p>我们为 middleware 定义了一个输入。这个输入会自动与“挂载该 middleware 的 server function 的输入”合并。</p>
<p>我们把输入写成可选的（<code>config?</code>），因为完全可能出现这种情况：你只想调用 server function，但并不想 refetch 任何东西。</p>
<p>然后开始写 <code>.client</code> 回调（在浏览器中运行）：先拿到要 refetch 的 keys：</p>
<p><code>const { refetch = [] } = data ?? {};</code></p>
<p>接着我们拿到 <code>queryClient</code> 和它的 cache，并创建一个 payload，之后会通过 <code>sendContext</code> 发到 <code>.server</code> 回调，让它执行真正的 refetch。</p>
<p>如果你对 TanStack middleware 不熟，我之前写的 <a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Fintroducing-tanstack-start-middleware%2F" target="_blank" title="https://frontendmasters.com/blog/introducing-tanstack-start-middleware/" ref="nofollow noopener noreferrer">middleware 文章</a> 可能会更适合作为入门。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> router = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRouterInstance</span>();
<span class="hljs-keyword">const</span> <span class="hljs-attr">queryClient</span>: <span class="hljs-title class_">QueryClient</span> = router.<span class="hljs-property">options</span>.<span class="hljs-property">context</span>.<span class="hljs-property">queryClient</span>;
<span class="hljs-keyword">const</span> cache = queryClient.<span class="hljs-title function_">getQueryCache</span>();

<span class="hljs-keyword">const</span> <span class="hljs-attr">revalidate</span>: <span class="hljs-title class_">RevalidationPayload</span> = {
  <span class="hljs-attr">refetch</span>: [],
};
</code></pre>
<p>我们的 <code>queryClient</code> 已经挂在 TanStack router 的 context 上，所以只要拿到 router 再取出来即可。</p>
<p>还记得我们把 <code>__revalidate</code> 塞到 query options 的 <code>meta</code> 里吗？现在我们针对每个 key 去 cache 里找对应 query，并把 <code>serverFn/arg</code> 抽出来组装成要发给服务端的 payload。</p>
<pre><code class="hljs language-ts" lang="ts">refetch.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key: QueryKey</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> entry = cache.<span class="hljs-title function_">find</span>({ <span class="hljs-attr">queryKey</span>: key, <span class="hljs-attr">exact</span>: <span class="hljs-literal">true</span> });
  <span class="hljs-keyword">if</span> (!entry) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidatePayload</span>: <span class="hljs-built_in">any</span> = entry?.<span class="hljs-property">meta</span>?.<span class="hljs-property">__revalidate</span> ?? <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">if</span> (revalidatePayload) {
    revalidate.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">push</span>({
      key,
      <span class="hljs-attr">fn</span>: revalidatePayload.<span class="hljs-property">serverFn</span>,
      <span class="hljs-attr">arg</span>: revalidatePayload.<span class="hljs-property">arg</span>,
    });
  }
});
</code></pre>
<p><code>if (!entry) return;</code> 是为了防止请求里包含了“当前缓存里根本不存在”的 query（也就是说，它可能从未在 UI 里被请求过）。这种情况下我们拿不到 <code>serverFn</code>，也就无法 refetch。</p>
<p>你也可以把 middleware 输入扩展得更丰富：比如对那些“无论是否在缓存里都必须执行”的 refetch，直接把 <code>serverFn + arg</code> 一起传上去。比如你打算 mutation 后 redirect，并希望新页面的数据能预取。本文不实现这个变体，但它只是同一主题的另一种组合。</p>
<p>接着我们调用 <code>next</code>，触发真正的 server function（以及其它 middleware）。通过 <code>sendContext</code> 我们把 <code>revalidate</code> 发到服务端：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
  <span class="hljs-attr">sendContext</span>: {
    revalidate,
  },
});
</code></pre>
<p><code>result</code> 是 server function 调用的返回值。它的 <code>context</code> 上会有一个 <code>payloads</code> 数组（由下方 <code>.server</code> 回调返回），其中每一项都包含 <code>key</code>（query key）和 <code>result</code>（对应数据）。我们遍历并写回 query cache。</p>
<p>我们稍后会修复这里用 <code>// @ts-expect-error</code> 遮掉的 TS 错误：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// @ts-expect-error</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> result.<span class="hljs-property">context</span>?.<span class="hljs-property">payloads</span> ?? []) {
  queryClient.<span class="hljs-title function_">setQueryData</span>(entry.<span class="hljs-property">key</span>, entry.<span class="hljs-property">result</span>);
}

<span class="hljs-keyword">return</span> result;
</code></pre>
<h2 data-id="heading-3">服务端回调</h2>
<p>服务端回调完整代码如下：</p>
<pre><code class="hljs language-ts" lang="ts">.<span class="hljs-title function_">server</span>(<span class="hljs-keyword">async</span> ({ next, context }) =&gt; {
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
    <span class="hljs-attr">sendContext</span>: {
      <span class="hljs-attr">payloads</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>[]
    }
  });

  <span class="hljs-keyword">const</span> allPayloads = context.<span class="hljs-property">revalidate</span>.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">refetchPayload</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">key</span>: refetchPayload.<span class="hljs-property">key</span>,
      <span class="hljs-attr">result</span>: refetchPayload.<span class="hljs-title function_">fn</span>({ <span class="hljs-attr">data</span>: refetchPayload.<span class="hljs-property">arg</span> })
    };
  });

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> refetchPayload <span class="hljs-keyword">of</span> allPayloads) {
    result.<span class="hljs-property">sendContext</span>.<span class="hljs-property">payloads</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">key</span>: refetchPayload.<span class="hljs-property">key</span>,
      <span class="hljs-attr">result</span>: <span class="hljs-keyword">await</span> refetchPayload.<span class="hljs-property">result</span>
    });
  }

  <span class="hljs-keyword">return</span> result;
});
</code></pre>
<p>我们会立刻调用 <code>next()</code>，它会执行这个 middleware 所挂载的 server function。我们在 <code>sendContext</code> 里传入一个 <code>payloads</code> 数组：这个数组决定了“服务端最终会发回给客户端回调的数据结构”（也就是 <code>.client</code> 里循环的那份 <code>payloads</code>）。</p>
<p>然后我们遍历客户端通过 <code>sendContext</code> 传上来的 <code>revalidate</code> payload，并从 <code>context</code> 上读出来（是的：<em>send</em> context，发上来再从 context 读出来）。接着调用所有 server functions，并把结果 push 到 <code>payloads</code> 数组里。</p>
<p>把前后拼起来，这就是完整 middleware：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> refetchMiddleware = <span class="hljs-title function_">createMiddleware</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span> })
  .<span class="hljs-title function_">inputValidator</span>(<span class="hljs-function">(<span class="hljs-params">config?: RefetchMiddlewareConfig</span>) =&gt;</span> config)
  .<span class="hljs-title function_">client</span>(<span class="hljs-keyword">async</span> ({ next, data }) =&gt; {
    <span class="hljs-keyword">const</span> { refetch = [] } = data ?? {};

    <span class="hljs-keyword">const</span> router = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRouterInstance</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-attr">queryClient</span>: <span class="hljs-title class_">QueryClient</span> = router.<span class="hljs-property">options</span>.<span class="hljs-property">context</span>.<span class="hljs-property">queryClient</span>;
    <span class="hljs-keyword">const</span> cache = queryClient.<span class="hljs-title function_">getQueryCache</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidate</span>: <span class="hljs-title class_">RevalidationPayload</span> = {
      <span class="hljs-attr">refetch</span>: [],
    };

    refetch.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key: QueryKey</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> entry = cache.<span class="hljs-title function_">find</span>({ <span class="hljs-attr">queryKey</span>: key, <span class="hljs-attr">exact</span>: <span class="hljs-literal">true</span> });
      <span class="hljs-keyword">if</span> (!entry) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidatePayload</span>: <span class="hljs-built_in">any</span> = entry?.<span class="hljs-property">meta</span>?.<span class="hljs-property">__revalidate</span> ?? <span class="hljs-literal">null</span>;

      <span class="hljs-keyword">if</span> (revalidatePayload) {
        revalidate.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">push</span>({
          key,
          <span class="hljs-attr">fn</span>: revalidatePayload.<span class="hljs-property">serverFn</span>,
          <span class="hljs-attr">arg</span>: revalidatePayload.<span class="hljs-property">arg</span>,
        });
      }
    });

    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
      <span class="hljs-attr">sendContext</span>: {
        revalidate,
      },
    });

    <span class="hljs-comment">// @ts-expect-error</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> result.<span class="hljs-property">context</span>?.<span class="hljs-property">payloads</span> ?? []) {
      queryClient.<span class="hljs-title function_">setQueryData</span>(entry.<span class="hljs-property">key</span>, entry.<span class="hljs-property">result</span>);
    }

    <span class="hljs-keyword">return</span> result;
  })
  .<span class="hljs-title function_">server</span>(<span class="hljs-keyword">async</span> ({ next, context }) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
      <span class="hljs-attr">sendContext</span>: {
        <span class="hljs-attr">payloads</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>[],
      },
    });

    <span class="hljs-keyword">const</span> allPayloads = context.<span class="hljs-property">revalidate</span>.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">refetchPayload</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">key</span>: refetchPayload.<span class="hljs-property">key</span>,
        <span class="hljs-attr">result</span>: refetchPayload.<span class="hljs-title function_">fn</span>({ <span class="hljs-attr">data</span>: refetchPayload.<span class="hljs-property">arg</span> }),
      };
    });

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> refetchPayload <span class="hljs-keyword">of</span> allPayloads) {
      result.<span class="hljs-property">sendContext</span>.<span class="hljs-property">payloads</span>.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">key</span>: refetchPayload.<span class="hljs-property">key</span>,
        <span class="hljs-attr">result</span>: <span class="hljs-keyword">await</span> refetchPayload.<span class="hljs-property">result</span>,
      });
    }

    <span class="hljs-keyword">return</span> result;
  });
</code></pre>
<h2 data-id="heading-4">修复 TypeScript 报错</h2>
<p>为什么下面这一行是无效的？</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// @ts-expect-error</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> result.<span class="hljs-property">context</span>?.<span class="hljs-property">payloads</span> ?? []) {
</code></pre>
<p>这段代码运行在 <code>.client</code> 回调里，并且是在我们调用 <code>next()</code> 之后运行的。本质上，我们是在服务端读取“发送回客户端的数据”（通过 <code>sendContext</code> 传回来的 payload）。这段代码在运行时确实能工作，那为什么类型对不上？</p>
<p>我在上面提到的 middleware 文章里解释过：服务端回调能“看见”客户端发给它的内容，但反过来不成立。这种信息天生就不是双向可见的；类型推断也没法倒着跑。</p>
<p>解决方式很简单：把 middleware 拆成两段，让后一段 middleware 依赖前一段。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> prelimRefetchMiddleware = <span class="hljs-title function_">createMiddleware</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span> })
  .<span class="hljs-title function_">inputValidator</span>(<span class="hljs-function">(<span class="hljs-params">config?: RefetchMiddlewareConfig</span>) =&gt;</span> config)
  .<span class="hljs-title function_">client</span>(<span class="hljs-keyword">async</span> ({ next, data }) =&gt; {
    <span class="hljs-keyword">const</span> { refetch = [] } = data ?? {};

    <span class="hljs-keyword">const</span> router = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRouterInstance</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-attr">queryClient</span>: <span class="hljs-title class_">QueryClient</span> = router.<span class="hljs-property">options</span>.<span class="hljs-property">context</span>.<span class="hljs-property">queryClient</span>;

    <span class="hljs-comment">// same</span>
    <span class="hljs-comment">// as</span>
    <span class="hljs-comment">// before</span>

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
      <span class="hljs-attr">sendContext</span>: {
        revalidate,
      },
    });

    <span class="hljs-comment">// those last few lines are removed</span>
  })
  .<span class="hljs-title function_">server</span>(<span class="hljs-keyword">async</span> ({ next, context }) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
      <span class="hljs-attr">sendContext</span>: {
        <span class="hljs-attr">payloads</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>[],
      },
    });

    <span class="hljs-comment">// exactly the same as before</span>

    <span class="hljs-keyword">return</span> result;
  });

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> refetchMiddleware = <span class="hljs-title function_">createMiddleware</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span> })
  .<span class="hljs-title function_">middleware</span>([prelimRefetchMiddleware]) <span class="hljs-comment">// &lt;-------- connect them!</span>
  .<span class="hljs-title function_">client</span>(<span class="hljs-keyword">async</span> ({ next }) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();

    <span class="hljs-keyword">const</span> router = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRouterInstance</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-attr">queryClient</span>: <span class="hljs-title class_">QueryClient</span> = router.<span class="hljs-property">options</span>.<span class="hljs-property">context</span>.<span class="hljs-property">queryClient</span>;

    <span class="hljs-comment">// and here's those last few lines we removed from above</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> result.<span class="hljs-property">context</span>?.<span class="hljs-property">payloads</span> ?? []) {
      queryClient.<span class="hljs-title function_">setQueryData</span>(entry.<span class="hljs-property">key</span>, entry.<span class="hljs-property">result</span>);
    }

    <span class="hljs-keyword">return</span> result;
  });
</code></pre>
<p>整体逻辑不变，只是把 <code>.client</code> 回调里 <code>next()</code> 之后那部分移到了单独的 middleware 里。其余部分留在另一个 middleware 中，并作为输入传给新的这个 middleware。这样当我们在 <code>refetchMiddleware</code> 里调用 <code>next</code> 时，TypeScript 就能看到“从服务端发下来的 context 数据”，因为这些数据是在 <code>prelimRefetchMiddleware</code> 里发送的，而它又是本 middleware 的输入，因此 TS 可以完整看清类型流动。</p>
<h2 data-id="heading-5">接起来</h2>
<p>现在我们回到“更新 epic”的 server function：把之前的手动 refetch 移除，改为使用 refetch middleware。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> updateEpic = <span class="hljs-title function_">createServerFn</span>({ <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span> })
  .<span class="hljs-title function_">middleware</span>([refetchMiddleware])
  .<span class="hljs-title function_">inputValidator</span>(<span class="hljs-function">(<span class="hljs-params">obj: { id: <span class="hljs-built_in">number</span>; name: <span class="hljs-built_in">string</span> }</span>) =&gt;</span> obj)
  .<span class="hljs-title function_">handler</span>(<span class="hljs-keyword">async</span> ({ data }) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()));
    <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">update</span>(epicsTable).<span class="hljs-title function_">set</span>({ <span class="hljs-attr">name</span>: data.<span class="hljs-property">name</span> }).<span class="hljs-title function_">where</span>(<span class="hljs-title function_">eq</span>(epicsTable.<span class="hljs-property">id</span>, data.<span class="hljs-property">id</span>));
  });
</code></pre>
<p>在 React 组件中通过 <code>useServerFn</code> 来调用它；这个 hook 会自动处理错误、重定向等。</p>
<p><code>const runSave = useServerFn(updateEpic);</code></p>
<p>还记得我说过：middleware 的输入会自动与底层 server function 的输入合并吗？当我们调用这个 server function 时就能看到：</p>
<p><img alt="图 1：一个 handleSaveFinal 函数的代码片段，保存输入值并调用 runSave，参数对象包含 id 和 name。转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p>（<code>unknown[]</code> 对 react-query 的 query key 来说就是正确类型）</p>
<p>现在我们可以这样调用它，并指定要 refetch 的查询：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">await</span> <span class="hljs-title function_">runSave</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">id</span>: epic.<span class="hljs-property">id</span>,
    <span class="hljs-attr">name</span>: newValue,
    <span class="hljs-attr">refetch</span>: [
      [<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-number">1</span>],
      [<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"summary"</span>],
    ],
  },
});
</code></pre>
<p>运行后，一切正常：epics 列表和 summary 都会在没有任何新网络请求的情况下更新。测试 single flight mutations 时，你其实不是在找“发生了什么”，而是在找“什么都没发生”——也就是 Network 面板里缺少那些本该出现的额外请求。</p>
<h2 data-id="heading-6">再改进</h2>
<p>react-query 的 query keys 是层级结构的，你可能很熟悉这种写法：</p>
<p><code>queryClient.invalidateQueries({ queryKey: ["epics", "list"] });</code></p>
<p>它会 refetch 任何 key 以 <code>["epics", "list"]</code> 开头的 queries。我们的 middleware 能不能也支持这种“key 前缀”呢？也就是只传一个 key prefix，让它找出所有匹配项并 refetch。</p>
<p>可以，开干。</p>
<p>匹配 key 会稍复杂一点：每个传入的 key 可能是 prefix，会匹配多条 cache entry，所以我们用 <code>flatMap</code> 来找出所有匹配项，再利用 <code>cache.findAll</code>（很好用）。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> allQueriesFound = refetch.<span class="hljs-title function_">flatMap</span>(
  <span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> cache.<span class="hljs-title function_">findAll</span>({ <span class="hljs-attr">queryKey</span>: k, <span class="hljs-attr">exact</span>: <span class="hljs-literal">false</span> })
);
</code></pre>
<p>然后循环并做和之前一样的事：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> allQueriesFound = refetch.<span class="hljs-title function_">flatMap</span>(
  <span class="hljs-function"><span class="hljs-params">k</span> =&gt;</span> cache.<span class="hljs-title function_">findAll</span>({ <span class="hljs-attr">queryKey</span>: k, <span class="hljs-attr">exact</span>: <span class="hljs-literal">false</span> })
);

allQueriesFound.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidatePayload</span>: <span class="hljs-built_in">any</span> = entry?.<span class="hljs-property">meta</span>?.<span class="hljs-property">__revalidate</span> ?? <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">if</span> (revalidatePayload) {
    revalidate.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">key</span>: entry.<span class="hljs-property">queryKey</span>,
      <span class="hljs-attr">fn</span>: revalidatePayload.<span class="hljs-property">serverFn</span>,
      <span class="hljs-attr">arg</span>: revalidatePayload.<span class="hljs-property">arg</span>,
    });
  }
});
</code></pre>
<p>这就能用了。</p>
<h2 data-id="heading-7">更进一步</h2>
<p>不过我们的方案仍然不理想。假设用户在 epics 页面翻页：到第 2 页、到第 3 页、再回到第 1 页。我们的逻辑会找到第 1 页和 summary query，但也会把第 2、3 页一并找到（因为它们现在也在 cache 里）。然而第 2、3 页并不活跃，也不在屏幕上展示，我们不应该 refetch 它们。</p>
<p>我们可以只 refetch active queries：只要给 <code>findAll</code> 加上 <code>type</code> 参数即可。</p>
<p><code>cache.findAll({ queryKey: key, exact: false, type: "active" });</code></p>
<p>于是代码就变成这样：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> allQueriesFound = refetch.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> cache.<span class="hljs-title function_">findAll</span>({ <span class="hljs-attr">queryKey</span>: key, <span class="hljs-attr">exact</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">"active"</span> }));

allQueriesFound.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidatePayload</span>: <span class="hljs-built_in">any</span> = entry?.<span class="hljs-property">meta</span>?.<span class="hljs-property">__revalidate</span> ?? <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">if</span> (revalidatePayload) {
    revalidate.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">key</span>: entry.<span class="hljs-property">queryKey</span>,
      <span class="hljs-attr">fn</span>: revalidatePayload.<span class="hljs-property">serverFn</span>,
      <span class="hljs-attr">arg</span>: revalidatePayload.<span class="hljs-property">arg</span>,
    });
  }
});
</code></pre>
<h2 data-id="heading-8">更更进一步</h2>
<p>这样就能工作了。但你仔细想想，那些 inactive 的 queries 其实应该被 invalidated。我们不希望立刻 refetch 它们（浪费资源，而且用户没在看），但如果用户又翻回那些页面，我们希望触发一次重新获取。TanStack Query 通过 <code>invalidateQueries</code> 很容易做到。</p>
<p>我们把这段加到“被依赖的那个 middleware”的 client 回调里：</p>
<pre><code class="hljs language-ts" lang="ts">data?.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
  queryClient.<span class="hljs-title function_">invalidateQueries</span>({ <span class="hljs-attr">queryKey</span>: key, <span class="hljs-attr">exact</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">"inactive"</span>, <span class="hljs-attr">refetchType</span>: <span class="hljs-string">"none"</span> });
});
</code></pre>
<p>遍历传入的 query keys，把所有匹配的 inactive queries 标记为无效，但不立刻 refetch（<code>refetchType: "none"</code>）。</p>
<p>下面是更新后的完整 middleware：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> prelimRefetchMiddleware = <span class="hljs-title function_">createMiddleware</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span> })
  .<span class="hljs-title function_">inputValidator</span>(<span class="hljs-function">(<span class="hljs-params">config?: RefetchMiddlewareConfig</span>) =&gt;</span> config)
  .<span class="hljs-title function_">client</span>(<span class="hljs-keyword">async</span> ({ next, data }) =&gt; {
    <span class="hljs-keyword">const</span> { refetch = [] } = data ?? {};

    <span class="hljs-keyword">const</span> router = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRouterInstance</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-attr">queryClient</span>: <span class="hljs-title class_">QueryClient</span> = router.<span class="hljs-property">options</span>.<span class="hljs-property">context</span>.<span class="hljs-property">queryClient</span>;
    <span class="hljs-keyword">const</span> cache = queryClient.<span class="hljs-title function_">getQueryCache</span>();

    <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidate</span>: <span class="hljs-title class_">RevalidationPayload</span> = {
      <span class="hljs-attr">refetch</span>: [],
    };

    <span class="hljs-keyword">const</span> allQueriesFound = refetch.<span class="hljs-title function_">flatMap</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> cache.<span class="hljs-title function_">findAll</span>({ <span class="hljs-attr">queryKey</span>: key, <span class="hljs-attr">exact</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">"active"</span> }));

    allQueriesFound.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-attr">revalidatePayload</span>: <span class="hljs-built_in">any</span> = entry?.<span class="hljs-property">meta</span>?.<span class="hljs-property">__revalidate</span> ?? <span class="hljs-literal">null</span>;

      <span class="hljs-keyword">if</span> (revalidatePayload) {
        revalidate.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">key</span>: entry.<span class="hljs-property">queryKey</span>,
          <span class="hljs-attr">fn</span>: revalidatePayload.<span class="hljs-property">serverFn</span>,
          <span class="hljs-attr">arg</span>: revalidatePayload.<span class="hljs-property">arg</span>,
        });
      }
    });

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
      <span class="hljs-attr">sendContext</span>: {
        revalidate,
      },
    });
  })
  .<span class="hljs-title function_">server</span>(<span class="hljs-keyword">async</span> ({ next, context }) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>({
      <span class="hljs-attr">sendContext</span>: {
        <span class="hljs-attr">payloads</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>[],
      },
    });

    <span class="hljs-keyword">const</span> allPayloads = context.<span class="hljs-property">revalidate</span>.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">refetchPayload</span> =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">key</span>: refetchPayload.<span class="hljs-property">key</span>,
        <span class="hljs-attr">result</span>: refetchPayload.<span class="hljs-title function_">fn</span>({ <span class="hljs-attr">data</span>: refetchPayload.<span class="hljs-property">arg</span> }),
      };
    });

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> refetchPayload <span class="hljs-keyword">of</span> allPayloads) {
      result.<span class="hljs-property">sendContext</span>.<span class="hljs-property">payloads</span>.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">key</span>: refetchPayload.<span class="hljs-property">key</span>,
        <span class="hljs-attr">result</span>: <span class="hljs-keyword">await</span> refetchPayload.<span class="hljs-property">result</span>,
      });
    }

    <span class="hljs-keyword">return</span> result;
  });

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> refetchMiddleware = <span class="hljs-title function_">createMiddleware</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">"function"</span> })
  .<span class="hljs-title function_">middleware</span>([prelimRefetchMiddleware])
  .<span class="hljs-title function_">client</span>(<span class="hljs-keyword">async</span> ({ data, next }) =&gt; {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();

    <span class="hljs-keyword">const</span> router = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRouterInstance</span>();
    <span class="hljs-keyword">const</span> <span class="hljs-attr">queryClient</span>: <span class="hljs-title class_">QueryClient</span> = router.<span class="hljs-property">options</span>.<span class="hljs-property">context</span>.<span class="hljs-property">queryClient</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> result.<span class="hljs-property">context</span>?.<span class="hljs-property">payloads</span> ?? []) {
      queryClient.<span class="hljs-title function_">setQueryData</span>(entry.<span class="hljs-property">key</span>, entry.<span class="hljs-property">result</span>, { <span class="hljs-attr">updatedAt</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() });
    }

    data?.<span class="hljs-property">refetch</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> {
      queryClient.<span class="hljs-title function_">invalidateQueries</span>({ <span class="hljs-attr">queryKey</span>: key, <span class="hljs-attr">exact</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">"inactive"</span>, <span class="hljs-attr">refetchType</span>: <span class="hljs-string">"none"</span> });
    });

    <span class="hljs-keyword">return</span> result;
  });
</code></pre>
<p>我们告诉 TanStack Query：把匹配 key 的 inactive queries 置为 invalid（但不 refetch）。</p>
<p>这个方案非常好用：如果你浏览到第 2、3 页，然后回到第 1 页，再编辑一个 todo，你会看到第 1 页列表和 summary 立刻更新。之后如果你再翻回第 2、3 页，你会看到网络请求触发，从而拿到新数据。</p>
<h2 data-id="heading-9">锦上添花</h2>
<p>还记得我们把 server function 和参数塞进 query options 时的写法吗？</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">epicsQueryOptions</span> = (<span class="hljs-params">page: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>, page],
    <span class="hljs-attr">queryFn</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getEpicsList</span>({ <span class="hljs-attr">data</span>: page });
      <span class="hljs-keyword">return</span> result;
    },
    <span class="hljs-attr">staleTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
    <span class="hljs-attr">gcTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">__revalidate</span>: {
        <span class="hljs-attr">serverFn</span>: getEpicsList,
        <span class="hljs-attr">arg</span>: page,
      },
    },
  });
};
</code></pre>
<p>我之前提过：在 <code>meta</code> 和 <code>queryFn</code> 里重复写 serverFn/arg 有点“脏”。我们来修一下。</p>
<p>先从最简单的 helper 开始：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">refetchedQueryOptions</span>(<span class="hljs-params">queryKey: QueryKey, serverFn: <span class="hljs-built_in">any</span>, arg?: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">const</span> queryKeyToUse = [...queryKey];
  <span class="hljs-keyword">if</span> (arg != <span class="hljs-literal">null</span>) {
    queryKeyToUse.<span class="hljs-title function_">push</span>(arg);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    <span class="hljs-attr">queryKey</span>: queryKeyToUse,
    <span class="hljs-attr">queryFn</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">serverFn</span>({ <span class="hljs-attr">data</span>: arg });
    },
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">__revalidate</span>: {
        serverFn,
        arg,
      },
    },
  });
}
</code></pre>
<p>这个 helper 会接收 query key、server function 和参数，然后返回 query options：</p>
<ul>
<li>拼好的 <code>queryKey</code>（必要时把 arg 追加进去）</li>
<li><code>queryFn</code>（直接调用 server function）</li>
<li><code>meta.__revalidate</code>（同样记录 server function 和参数）</li>
</ul>
<p>于是 epics 列表 query 就可以写成：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">epicsQueryOptions</span> = (<span class="hljs-params">page: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    ...<span class="hljs-title function_">refetchedQueryOptions</span>([<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>], getEpicsList, page),
    <span class="hljs-attr">staleTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
    <span class="hljs-attr">gcTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
  });
};
</code></pre>
<p>它能工作，但类型不好：到处都是 <code>any</code>，意味着传给 server function 的参数不做类型检查；更糟的是，<code>queryFn</code> 的返回值也不会被检查，于是你的 query（比如这个 epics 列表）会变成返回 <code>any</code>。</p>
<p>我们来加点类型。</p>
<p>server functions 本质上是函数：接收一个对象参数；如果 server function 定义了输入，那么这个对象会包含一个 <code>data</code> 属性，里面就是输入。说一堆大白话不如看调用例子：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">runSaveSimple</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">id</span>: epic.<span class="hljs-property">id</span>,
    <span class="hljs-attr">name</span>: newValue,
  },
});
</code></pre>
<p>第二版 helper 可以这样写：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> refetchedQueryOptions&lt;T <span class="hljs-keyword">extends</span> (<span class="hljs-attr">arg</span>: { <span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span> }) =&gt; <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;&gt;(
  <span class="hljs-attr">queryKey</span>: <span class="hljs-title class_">QueryKey</span>,
  <span class="hljs-attr">serverFn</span>: T,
  <span class="hljs-attr">arg</span>: <span class="hljs-title class_">Parameters</span>&lt;T&gt;[<span class="hljs-number">0</span>][<span class="hljs-string">"data"</span>],
) {
  <span class="hljs-keyword">const</span> queryKeyToUse = [...queryKey];
  <span class="hljs-keyword">if</span> (arg != <span class="hljs-literal">null</span>) {
    queryKeyToUse.<span class="hljs-title function_">push</span>(arg);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    <span class="hljs-attr">queryKey</span>: queryKeyToUse,
    <span class="hljs-attr">queryFn</span>: <span class="hljs-keyword">async</span> (): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">ReturnType</span>&lt;T&gt;&gt;&gt; =&gt; {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">serverFn</span>({ <span class="hljs-attr">data</span>: arg });
    },
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">__revalidate</span>: {
        serverFn,
        arg,
      },
    },
  });
}
</code></pre>
<p>我们把 server function 约束为一个 async 函数，且它的参数对象上有 <code>data</code>；然后用它来静态推断 <code>arg</code> 的类型。这已经不错了，但当你把它用在“没有参数”的 server function 上时会报错：</p>
<pre><code class="hljs language-ts" lang="ts">...<span class="hljs-title function_">refetchedQueryOptions</span>([<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>, <span class="hljs-string">"summary"</span>], getEpicsSummary)
<span class="hljs-comment">// Expected 3 arguments, but got 2.</span>
</code></pre>
<p>你传 <code>undefined</code> 可以解决，功能也正常：</p>
<p><code>...refetchedQueryOptions(["epics", "list", "summary"], getEpicsSummary, undefined),</code></p>
<p>如果你是个正常人，你大概会觉得这已经很好了，而且确实如此。但如果你像我一样有点“怪”，你可能会想能不能做到更完美：</p>
<ul>
<li>当 server function 有参数时：必须传入且类型要正确</li>
<li>当 server function 没参数时：允许省略 arg</li>
</ul>
<p>TypeScript 有一个特性正好适合：<strong>函数重载（overloaded functions）</strong>。</p>
<p>这篇文章已经够长了，所以我直接贴代码，解读留作读者练习（以及可能的未来文章）。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">QueryKey</span>, queryOptions } <span class="hljs-keyword">from</span> <span class="hljs-string">"@tanstack/react-query"</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">AnyAsyncFn</span> = <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ServerFnArgs</span>&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt; = <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">TFn</span>&gt;[<span class="hljs-number">0</span>] <span class="hljs-keyword">extends</span> infer <span class="hljs-title class_">TRootArgs</span>
  ? <span class="hljs-title class_">TRootArgs</span> <span class="hljs-keyword">extends</span> { <span class="hljs-attr">data</span>: infer <span class="hljs-title class_">TResult</span> }
    ? <span class="hljs-title class_">TResult</span>
    : <span class="hljs-literal">undefined</span>
  : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ServerFnHasArgs</span>&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt; = <span class="hljs-title class_">ServerFnArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt; <span class="hljs-keyword">extends</span> infer U ? (U <span class="hljs-keyword">extends</span> <span class="hljs-literal">undefined</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>) : <span class="hljs-literal">false</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ServerFnWithArgs</span>&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt; = <span class="hljs-title class_">ServerFnHasArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-literal">true</span> ? <span class="hljs-title class_">TFn</span> : <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ServerFnWithoutArgs</span>&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt; = <span class="hljs-title class_">ServerFnHasArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-literal">false</span> ? <span class="hljs-title class_">TFn</span> : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">RefetchQueryOptions</span>&lt;T&gt; = {
  <span class="hljs-attr">queryKey</span>: <span class="hljs-title class_">QueryKey</span>;
  queryFn?: <span class="hljs-function">(<span class="hljs-params">_: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;;
  meta?: <span class="hljs-built_in">any</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ValidateServerFunction</span>&lt;<span class="hljs-title class_">Provided</span>, <span class="hljs-title class_">Expected</span>&gt; = <span class="hljs-title class_">Provided</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Expected</span> ? <span class="hljs-title class_">Provided</span> : <span class="hljs-string">"This server function requires an argument!"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> refetchedQueryOptions&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt;(
  <span class="hljs-attr">queryKey</span>: <span class="hljs-title class_">QueryKey</span>,
  <span class="hljs-attr">serverFn</span>: <span class="hljs-title class_">ServerFnWithArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt;,
  <span class="hljs-attr">arg</span>: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">TFn</span>&gt;[<span class="hljs-number">0</span>][<span class="hljs-string">"data"</span>],
): <span class="hljs-title class_">RefetchQueryOptions</span>&lt;<span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-title class_">TFn</span>&gt;&gt;&gt;;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> refetchedQueryOptions&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt;(
  <span class="hljs-attr">queryKey</span>: <span class="hljs-title class_">QueryKey</span>,
  <span class="hljs-attr">serverFn</span>: <span class="hljs-title class_">ValidateServerFunction</span>&lt;<span class="hljs-title class_">TFn</span>, <span class="hljs-title class_">ServerFnWithoutArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt;&gt;,
): <span class="hljs-title class_">RefetchQueryOptions</span>&lt;<span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-title class_">TFn</span>&gt;&gt;&gt;;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> refetchedQueryOptions&lt;<span class="hljs-title class_">TFn</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnyAsyncFn</span>&gt;(
  <span class="hljs-attr">queryKey</span>: <span class="hljs-title class_">QueryKey</span>,
  <span class="hljs-attr">serverFn</span>: <span class="hljs-title class_">ServerFnWithoutArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt; | <span class="hljs-title class_">ServerFnWithArgs</span>&lt;<span class="hljs-title class_">TFn</span>&gt;,
  arg?: <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">TFn</span>&gt;[<span class="hljs-number">0</span>][<span class="hljs-string">"data"</span>],
): <span class="hljs-title class_">RefetchQueryOptions</span>&lt;<span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-title class_">TFn</span>&gt;&gt;&gt; {
  <span class="hljs-keyword">const</span> queryKeyToUse = [...queryKey];
  <span class="hljs-keyword">if</span> (arg != <span class="hljs-literal">null</span>) {
    queryKeyToUse.<span class="hljs-title function_">push</span>(arg);
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    <span class="hljs-attr">queryKey</span>: queryKeyToUse,
    <span class="hljs-attr">queryFn</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">serverFn</span>({ <span class="hljs-attr">data</span>: arg });
    },
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">__revalidate</span>: {
        serverFn,
        arg,
      },
    },
  });
}
</code></pre>
<p>有了它之后，当 server function 需要参数时，你可以这样调用：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">epicsQueryOptions</span> = (<span class="hljs-params">page: <span class="hljs-built_in">number</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">queryOptions</span>({
    ...<span class="hljs-title function_">refetchedQueryOptions</span>([<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>], getEpicsList, page),
    <span class="hljs-attr">staleTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
    <span class="hljs-attr">gcTime</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">5</span>,
  });
};
</code></pre>
<p>参数类型会被正确检查：</p>
<pre><code class="hljs language-ts" lang="ts">...<span class="hljs-title function_">refetchedQueryOptions</span>([<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>], getEpicsList, <span class="hljs-string">""</span>)
<span class="hljs-comment">// Argument of type 'string' is not assignable to parameter of type 'number'.</span>
</code></pre>
<p>如果你忘了传参数，它也会报错：</p>
<pre><code class="hljs language-ts" lang="ts">...<span class="hljs-title function_">refetchedQueryOptions</span>([<span class="hljs-string">"epics"</span>, <span class="hljs-string">"list"</span>], getEpicsList)
<span class="hljs-comment">// Argument of type 'RequiredFetcher&lt;undefined, (page: number) =&gt; number, Promise&lt;{ id: number; name: string; }[]&gt;&gt;' is not assignable to parameter of type '"This server function requires an argument!"'.</span>
</code></pre>
<p>最后这个报错信息不算特别直观，但如果你把代码读到最后，会发现它已经在尽力提示你哪里错了，靠的就是这个小工具类型：</p>
<p><code>type ValidateServerFunction&lt;Provided, Expected&gt; = Provided extends Expected ? Provided : "This server function requires an argument!";</code></p>
<p>而对于“没有参数”的 server function，它也能正常工作。完整解释留给未来文章。</p>
<h2 data-id="heading-10">总结</h2>
<p>single flight mutations 是一个很不错的优化工具：当你做一次 mutation 后，UI 需要的更新数据不必再额外发请求获取，而是可以在同一次往返里顺便带回来。</p>
<p>希望这篇文章把各个拼图都讲清楚了：如何用 middleware 收集要 refetch 的查询、如何借助 TanStack Start 的 server function 序列化能力把“要执行的 refetch”发送到服务端、以及如何在客户端用 <code>setQueryData</code> 把数据写回缓存。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Electron 打包白屏排查实录：一个 continue_on_error 引发的三天三夜"血案"]]></title>    <link>https://juejin.cn/post/7603359026711035914</link>    <guid>https://juejin.cn/post/7603359026711035914</guid>    <pubDate>2026-02-06T07:41:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603359026711035914" data-draft-id="7603301285475532842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Electron 打包白屏排查实录：一个 continue_on_error 引发的三天三夜&quot;血案&quot;"/> <meta itemprop="keywords" content="前端,Electron,AI编程"/> <meta itemprop="datePublished" content="2026-02-06T07:41:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CocoonBreak"/> <meta itemprop="url" content="https://juejin.cn/user/3817931570691031"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Electron 打包白屏排查实录：一个 continue_on_error 引发的三天三夜"血案"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817931570691031/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CocoonBreak
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:41:17.000Z" title="Fri Feb 06 2026 07:41:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Electron 打包白屏排查实录：一个 continue_on_error 引发的三天三夜"血案"</h2>
<blockquote>
<p>本文记录了我在开源项目 AionUi（一个统一 AI Agent 图形界面）中遭遇的一次 Electron 打包白屏事故。从发现问题到最终定位根因，历时三天三夜。如果你也在用 Electron + GitHub Actions 做 CI/CD，这篇文章或许能帮你避开一个隐蔽的大坑。</p>
</blockquote>
<h3 data-id="heading-1">故事的开始：一个"完美"的 CI 构建</h3>
<p>那是一个平静的夜晚。</p>
<p>我像往常一样推送了一个版本到 <code>dev</code> 分支，GitHub Actions 开始了它忠实的自动构建工作。十几分钟后，CI 亮起了绿灯——所有平台构建成功。</p>
<blockquote>
<p>"不错，今天又是顺利的一天。"</p>
</blockquote>
<p>我下载了 macOS 的 DMG，拖进 Applications，双击启动——</p>
<p><strong>白屏。</strong></p>
<p>纯白的、一尘不染的、令人窒息的白屏。像是这个 App 在用行为艺术表达它对这个世界的失望。</p>
<p>没有报错弹窗，没有崩溃提示，就是一片白。</p>
<h3 data-id="heading-2">第一天：本地没问题，那一定是 CI 的问题</h3>
<p>作为一个经历过无数"在我机器上是好的"名场面的工程师，我的第一反应是——先在本地复现。</p>
<pre><code class="hljs language-bash" lang="bash">npm start  <span class="hljs-comment"># 本地开发 ✅ 正常</span>
node scripts/build-with-builder.js arm64 --mac --arm64  <span class="hljs-comment"># 本地打包 ✅ 正常</span>
</code></pre>
<p>本地打包出来的 DMG 安装后运行完全正常。</p>
<p>这就尴尬了。经典的"本地好好的，CI 就炸"。</p>
<p>我打开 Electron 的开发者工具日志，终于看到了这个错误：</p>
<pre><code class="hljs language-perl" lang="perl">Not allowed to load <span class="hljs-keyword">local</span> resource:
file:<span class="hljs-regexp">//</span><span class="hljs-regexp">/Applications/</span>AionUi.app/Contents/Resources/app/.webpack/renderer/main_window/index.html
</code></pre>
<p><code>ERR_FILE_NOT_FOUND</code>——Electron 找不到渲染进程的入口文件。这个 <code>index.html</code> 是 webpack 打包生成的，没有它，整个界面就是一片白。</p>
<h3 data-id="heading-3">第一个嫌疑人：tar v7</h3>
<p>翻看最近的 <code>package.json</code> 变更，我注意到一个依赖升级：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"overrides"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tar"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^7.5.7"</span>  <span class="hljs-comment">// 从 ^6.2.1 升级</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>tar v7 是一个 breaking change 版本，API 完全重写。而 electron-builder 在打包时需要处理 tar/asar 归档。会不会是 tar v7 导致 asar 打包出了问题？</p>
<p>我花了大半天时间研究 tar v7 的兼容性：</p>
<ul>
<li>翻了 npm 的 changelog</li>
<li>查了 electron-builder 的源码</li>
<li>对比了 tar v6 和 v7 的 API 差异</li>
</ul>
<p>结论：<strong>tar v7 是无辜的</strong>。它修复的是 CVE-2026-23745 安全漏洞，electron-builder 并不直接依赖 tar 的 API。</p>
<p>第一天，白忙。</p>
<h3 data-id="heading-4">第二天：深入 asar 的内心世界</h3>
<p>既然不是 tar 的问题，那就得看看 CI 打包出来的产物到底长什么样。</p>
<p>我从 CI artifacts 下载了 DMG，挂载后检查 asar：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 本地打包的 asar</span>
npx asar list /Applications/AionUi-Local.app/Contents/Resources/app.asar | grep index.html
<span class="hljs-comment"># ✅ .webpack/renderer/main_window/index.html  存在</span>

<span class="hljs-comment"># CI 打包的 asar</span>
npx asar list /Applications/AionUi-CI.app/Contents/Resources/app.asar | grep index.html
<span class="hljs-comment"># ❌ 没有任何输出</span>
</code></pre>
<p><strong>找到了！</strong> CI 打包出来的 asar 里压根没有 <code>index.html</code>！</p>
<p>这意味着 webpack 的产物在 CI 环境下根本没有生成。但 CI 构建明明显示成功了啊？</p>
<h3 data-id="heading-5">转折点：一条被吞掉的错误</h3>
<p>带着疑惑，我仔细翻看了 CI 的构建日志。在数百行日志的角落里，我发现了这个：</p>
<pre><code class="hljs language-bash" lang="bash">FATAL ERROR: Ineffective mark-compacts near heap <span class="hljs-built_in">limit</span> Allocation failed
- JavaScript heap out of memory
</code></pre>
<p><strong>Node.js 内存溢出了！</strong></p>
<p>webpack 在打包过程中吃光了内存，进程直接崩溃。但是——为什么 CI 没有报错？</p>
<p>答案就在 GitHub Actions 的 workflow 配置里：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">with</span> <span class="hljs-string">electron-builder</span> <span class="hljs-string">(non-Windows)</span>
  <span class="hljs-attr">uses:</span> <span class="hljs-string">nick-fields/retry@v3</span>
  <span class="hljs-attr">with:</span>
    <span class="hljs-attr">timeout_minutes:</span> <span class="hljs-number">80</span>
    <span class="hljs-attr">max_attempts:</span> <span class="hljs-number">2</span>
    <span class="hljs-attr">continue_on_error:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># ← 就是你！</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">${{</span> <span class="hljs-string">matrix.command</span> <span class="hljs-string">}}</span>
</code></pre>
<p><strong><code>continue_on_error: true</code></strong>——这个设置的本意是：macOS 构建有时会因为 Apple 公证服务超时而失败，为了不阻塞其他平台的构建，设置了继续执行。</p>
<p>但它也悄悄地吞掉了 OOM 错误。webpack 崩溃了，HTML 没生成，但 CI 一脸无事地继续往下走，把一个<strong>残缺的产物</strong>打包成了 DMG 并上传。</p>
<p>这就像一个建筑工人告诉你"房子盖好了"，但实际上里面连墙都没有。</p>
<h3 data-id="heading-6">为什么只有 macOS 炸了？</h3>
<p>这里有一个有趣的细节：Windows 和 Linux 的构建都正常，唯独 macOS 白屏。</p>
<p>原因在于 Node.js V8 引擎的内存管理机制。V8 有一个<strong>人为设定的堆内存上限</strong>（64 位系统默认约 4GB），这个限制独立于物理内存。</p>
<p>GitHub Actions 各平台 Runner 虽然标称内存相同（7GB），但实际可用内存差异很大：</p>
<pre><code class="hljs language-scss" lang="scss">GitHub Actions Runner (<span class="hljs-number">7</span>GB RAM)
├── macOS 系统开销 (~<span class="hljs-number">1.5</span>GB)
├── Xcode / 签名工具 (~<span class="hljs-number">0.5</span>GB)
├── npm / 其他进程 (~<span class="hljs-number">0.5</span>GB)
└── Node<span class="hljs-selector-class">.js</span> 可用 (~<span class="hljs-number">4.5</span>GB)
    └── V8 默认堆上限: ~<span class="hljs-number">4</span>GB  ← webpack 需要 ~<span class="hljs-number">5</span>GB，超了！
</code></pre>
<p>macOS 系统本身就比 Linux 更"臃肿"，加上 Xcode 工具链、代码签名服务等额外负担，留给 Node.js 的空间更少。当 webpack 打包一个包含 Monaco Editor、Arco Design、多个 AI SDK 的大型 Electron 项目时，内存消耗刚好<strong>卡在了 macOS 的临界点上</strong>。</p>
<p>Windows 和 Linux 刚好没超，macOS 刚好超了。差的可能就是那几百 MB。</p>
<p>这也解释了为什么这个问题之前没出现——随着项目不断壮大，依赖越来越多，webpack 的内存消耗在某个版本终于突破了 macOS 上的 4GB 天花板。</p>
<h3 data-id="heading-7">第三天：修复与反思</h3>
<h4 data-id="heading-8">修复方案</h4>
<p>修复本身只需要一行：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">env:</span>
  <span class="hljs-attr">NODE_OPTIONS:</span> <span class="hljs-string">"--max-old-space-size=8192"</span>
</code></pre>
<p>这不是"给 Node.js 更多物理内存"——Runner 的物理内存还是 7GB，不会凭空变多。</p>
<p>这是<strong>解除 V8 引擎的人为限制</strong>。告诉 V8："如果需要，你可以用到 8GB"。实际上 webpack 只会用到它需要的量（约 5GB）。因为 5GB &lt; 8GB（新上限），所以不再触发 OOM。</p>


























<table><thead><tr><th>情况</th><th>V8 堆上限</th><th>实际需要</th><th>系统可用</th><th>结果</th></tr></thead><tbody><tr><td>修复前</td><td>~4GB (默认)</td><td>~5GB</td><td>~4.5GB</td><td><strong>OOM</strong></td></tr><tr><td>修复后</td><td>8GB (手动)</td><td>~5GB</td><td>~4.5GB</td><td><strong>成功</strong></td></tr></tbody></table>
<h4 data-id="heading-9">防御性措施</h4>
<p>光修 OOM 不够。真正的问题是 <code>continue_on_error: true</code> 让构建失败变成了"沉默的杀手"。</p>
<p>我重写了 macOS 构建步骤，将<strong>公证失败</strong>和<strong>构建失败</strong>区分开来：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">with</span> <span class="hljs-string">electron-builder</span> <span class="hljs-string">(macOS)</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">|
    set +e
    ${{ matrix.command }} 2&gt;&amp;1 | tee build.log
    BUILD_EXIT_CODE=${PIPESTATUS[0]}
</span>
    <span class="hljs-comment"># 检查 DMG 是否生成</span>
    <span class="hljs-string">if</span> <span class="hljs-string">ls</span> <span class="hljs-string">out/*.dmg</span> <span class="hljs-number">1</span><span class="hljs-string">&gt;/dev/null</span> <span class="hljs-number">2</span><span class="hljs-string">&gt;&amp;1;</span> <span class="hljs-string">then</span>
      <span class="hljs-string">DMG_EXISTS=true</span>
    <span class="hljs-string">fi</span>

    <span class="hljs-string">if</span> [ <span class="hljs-string">$BUILD_EXIT_CODE</span> <span class="hljs-string">-eq</span> <span class="hljs-number">0</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
      <span class="hljs-string">exit</span> <span class="hljs-number">0</span>  <span class="hljs-comment"># 完全成功 ✅</span>
    <span class="hljs-string">fi</span>

    <span class="hljs-comment"># DMG 存在但构建失败 → 可能只是公证问题</span>
    <span class="hljs-string">if</span> [ <span class="hljs-string">"$DMG_EXISTS"</span> <span class="hljs-string">=</span> <span class="hljs-literal">true</span> ]<span class="hljs-string">;</span> <span class="hljs-string">then</span>
      <span class="hljs-string">if</span> <span class="hljs-string">grep</span> <span class="hljs-string">-qiE</span> <span class="hljs-string">"notariz|staple"</span> <span class="hljs-string">build.log;</span> <span class="hljs-string">then</span>
        <span class="hljs-string">echo</span> <span class="hljs-string">"⚠️ DMG 构建成功，但公证失败"</span>
        <span class="hljs-string">exit</span> <span class="hljs-number">0</span>  <span class="hljs-comment"># 允许继续</span>
      <span class="hljs-string">fi</span>
    <span class="hljs-string">fi</span>

    <span class="hljs-comment"># DMG 都没生成 → 真正的构建失败</span>
    <span class="hljs-string">exit</span> <span class="hljs-number">1</span>  <span class="hljs-comment"># ❌ 阻断 CI</span>
</code></pre>
<p>逻辑很简单：</p>
<ul>
<li><strong>构建成功 + 公证成功</strong> → 全部通过 ✅</li>
<li><strong>DMG 生成了但公证失败</strong> → 警告但不阻塞 ⚠️（用户右键打开即可）</li>
<li><strong>DMG 都没生成</strong> → 直接失败 ❌（这才是真问题）</li>
</ul>
<p>不再一刀切地 <code>continue_on_error</code>，而是<strong>精准区分错误类型</strong>。</p>
<h3 data-id="heading-10">番外篇：AionUi 的"混血"打包架构</h3>
<p>讲完了 bug 本身，我想聊聊这个 bug 之所以能藏这么深的根本原因——AionUi 的打包流程本身就不走寻常路。</p>
<h4 data-id="heading-11">传统开源项目怎么打包？</h4>
<p>大多数 Electron 开源项目的打包流程是这样的：</p>
<pre><code class="hljs language-css" lang="css">方案 <span class="hljs-selector-tag">A</span>：纯 Electron Forge
源代码 → electron-forge make → DMG/EXE/DEB
（开发、编译、打包一条龙）

方案 <span class="hljs-selector-tag">B</span>：纯 electron-builder
源代码 → webpack/vite 编译 → electron-builder → DMG/EXE/DEB
（自己编译，builder 负责打包）
</code></pre>
<p>简单直接。一个工具从头管到尾，出了问题也好排查。</p>
<h4 data-id="heading-12">AionUi 为什么要"混血"？</h4>
<p>AionUi 的打包流程长这样：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">源代码</span>
  <span class="hljs-string">↓</span>
<span class="hljs-attr">Step 1:</span> <span class="hljs-string">Electron</span> <span class="hljs-string">Forge</span> <span class="hljs-string">(webpack</span> <span class="hljs-string">编译)</span>
  <span class="hljs-string">├──</span> <span class="hljs-string">WebpackPlugin</span> <span class="hljs-string">编译</span> <span class="hljs-string">main</span> <span class="hljs-string">process</span>
  <span class="hljs-string">├──</span> <span class="hljs-string">WebpackPlugin</span> <span class="hljs-string">编译</span> <span class="hljs-string">renderer</span> <span class="hljs-string">process</span> <span class="hljs-string">→</span> <span class="hljs-string">index.html</span>  <span class="hljs-string">←</span> <span class="hljs-string">白屏就是这里没生成</span>
  <span class="hljs-string">└──</span> <span class="hljs-string">输出到</span> <span class="hljs-string">.webpack/</span> <span class="hljs-string">目录</span>
  <span class="hljs-string">↓</span>
<span class="hljs-attr">Step 2:</span> <span class="hljs-string">产物校验</span>
  <span class="hljs-string">└──</span> <span class="hljs-string">检查</span> <span class="hljs-string">.webpack/renderer/main_window/index.html</span> <span class="hljs-string">是否存在</span>
  <span class="hljs-string">↓</span>
<span class="hljs-attr">Step 3:</span> <span class="hljs-string">electron-builder</span> <span class="hljs-string">(分发打包)</span>
  <span class="hljs-string">├──</span> <span class="hljs-string">读取</span> <span class="hljs-string">electron-builder.yml</span> <span class="hljs-string">配置</span>
  <span class="hljs-string">├──</span> <span class="hljs-string">将</span> <span class="hljs-string">.webpack/</span> <span class="hljs-string">打入</span> <span class="hljs-string">asar</span> <span class="hljs-string">归档</span>
  <span class="hljs-string">├──</span> <span class="hljs-attr">afterPack:</span> <span class="hljs-string">重建原生模块</span> <span class="hljs-string">(better-sqlite3,</span> <span class="hljs-string">node-pty...)</span>
  <span class="hljs-string">└──</span> <span class="hljs-attr">afterSign:</span> <span class="hljs-string">代码签名</span> <span class="hljs-string">+</span> <span class="hljs-string">Apple</span> <span class="hljs-string">公证</span>
  <span class="hljs-string">↓</span>
<span class="hljs-string">DMG</span> <span class="hljs-string">/</span> <span class="hljs-string">ZIP</span> <span class="hljs-string">/</span> <span class="hljs-string">EXE</span> <span class="hljs-string">/</span> <span class="hljs-string">DEB</span>
</code></pre>
<p>为什么不直接用一个工具？因为 AionUi 的需求太"拧巴"了：</p>
<p><strong>需要 Electron Forge 的原因：</strong></p>
<ul>
<li>它的 <code>WebpackPlugin</code> 对 Electron 多进程架构（main + renderer + preload）有开箱即用的支持</li>
<li>开发时的 HMR 热更新、DevServer、日志端口管理都做得很好</li>
<li><code>FusesPlugin</code> 可以在打包时控制 Electron 安全特性（禁用 RunAsNode、启用 Cookie 加密等）</li>
</ul>
<p><strong>需要 electron-builder 的原因：</strong></p>
<ul>
<li>macOS 代码签名 + Apple 公证（Forge 的 maker 支持有限）</li>
<li>跨架构编译（在 arm64 机器上构建 x64 包，反之亦然）</li>
<li>精细的 asar 控制（哪些模块打包、哪些解压、哪些排除）</li>
<li>多格式输出（DMG + ZIP 同时生成）</li>
<li>更成熟的 CI/CD 集成</li>
</ul>
<p>单独用 Forge 做不了完善的公证；单独用 electron-builder 又没有 Forge 的 webpack 集成好用。所以 AionUi 用了一个<strong>混血方案</strong>——Forge 负责编译，electron-builder 负责打包。</p>
<h4 data-id="heading-13">混血的代价：两个工具之间的"信任边界"</h4>
<p>这个方案的核心脚本是 <code>build-with-builder.js</code>，它充当了两个工具之间的"桥梁"：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Step 1: 让 Forge 编译 webpack</span>
<span class="hljs-title function_">execSync</span>(<span class="hljs-string">`npm exec electron-forge -- package --arch=<span class="hljs-subst">${targetArch}</span>`</span>);

<span class="hljs-comment">// Step 2: 把 .webpack/ 目录结构整理成 electron-builder 期望的样子</span>
<span class="hljs-title function_">ensureDir</span>(sourceDir, webpackDir, <span class="hljs-string">'main'</span>);
<span class="hljs-title function_">ensureDir</span>(sourceDir, webpackDir, <span class="hljs-string">'renderer'</span>);

<span class="hljs-comment">// Step 3: 校验关键产物</span>
<span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(rendererIndex)) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Missing renderer entry'</span>);
}

<span class="hljs-comment">// Step 4: 让 electron-builder 打包</span>
<span class="hljs-title function_">execSync</span>(<span class="hljs-string">`npx electron-builder <span class="hljs-subst">${builderArgs}</span> --<span class="hljs-subst">${targetArch}</span>`</span>);
</code></pre>
<p>问题就出在这里：<strong>Forge 和 electron-builder 之间没有原生的握手机制</strong>。Forge 编译完就完了，至于 <code>.webpack/</code> 目录里到底有没有该有的文件，它不管。electron-builder 拿到 <code>.webpack/</code> 就打包，至于里面是不是空的，它也不管。</p>
<p>当 webpack 因为 OOM 中途崩溃时，<code>.webpack/</code> 目录可能是"半成品"——main 进程的代码可能已经编译好了（因为它先编译），但 renderer 的 <code>index.html</code> 还没来得及生成。electron-builder 照样把这个半成品打进了 asar，产出了一个"看起来正常但其实没有界面"的 DMG。</p>
<p>这就是混血架构的代价：<strong>两个工具之间的信任边界，恰好是 bug 的藏身之处</strong>。</p>
<h4 data-id="heading-14">与传统方案的对比</h4>













































<table><thead><tr><th>维度</th><th>传统方案 (单工具)</th><th>AionUi (混血方案)</th></tr></thead><tbody><tr><td><strong>编译</strong></td><td>工具内置</td><td>Electron Forge (WebpackPlugin)</td></tr><tr><td><strong>打包</strong></td><td>同一工具</td><td>electron-builder</td></tr><tr><td><strong>签名/公证</strong></td><td>工具内置或手动</td><td>electron-builder + afterSign.js</td></tr><tr><td><strong>原生模块</strong></td><td>工具自动处理</td><td>afterPack.js 手动重建</td></tr><tr><td><strong>错误传播</strong></td><td>直通，容易发现</td><td>跨工具，可能被吞掉</td></tr><tr><td><strong>灵活性</strong></td><td>受限于单工具</td><td>高（可单独定制每个环节）</td></tr><tr><td><strong>复杂度</strong></td><td>低</td><td>高</td></tr></tbody></table>
<h4 data-id="heading-15">原生模块：另一个深坑</h4>
<p>AionUi 不是一个纯 JS 应用。它依赖了多个原生 C++ 模块：</p>
<ul>
<li><strong>better-sqlite3</strong> — 本地数据库，存储对话历史和设置</li>
<li><strong>node-pty</strong> — 终端模拟，用于运行 CLI AI 工具</li>
<li><strong>tree-sitter</strong> — 代码解析，用于语法高亮</li>
</ul>
<p>这些模块必须针对目标平台和架构编译成 <code>.node</code> 二进制文件。在 <code>afterPack.js</code> 中，AionUi 实现了一套完整的跨架构重建逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 交叉编译时，先清理错误架构的二进制</span>
<span class="hljs-keyword">if</span> (isCrossCompile) {
  <span class="hljs-comment">// 删除 build/ 目录（包含错误架构的编译产物）</span>
  fs.<span class="hljs-title function_">rmSync</span>(buildDir, { <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">force</span>: <span class="hljs-literal">true</span> });
  <span class="hljs-comment">// 删除对立架构的可选依赖包</span>
  <span class="hljs-comment">// 比如目标是 arm64，就删除所有 *-x64 的包</span>
}

<span class="hljs-comment">// 然后为目标架构重新编译</span>
<span class="hljs-title function_">rebuildSingleModule</span>({
  moduleName, moduleRoot,
  <span class="hljs-attr">platform</span>: electronPlatformName,
  <span class="hljs-attr">arch</span>: targetArch,
  electronVersion
});
</code></pre>
<p>这意味着一次 macOS arm64 构建实际上要经历：webpack 编译 → Forge 打包 → electron-builder 打包 → 原生模块重建 → 代码签名 → Apple 公证，<strong>六个步骤</strong>。任何一步失败都可能导致最终产物有问题。</p>
<h4 data-id="heading-16">为什么不简化？</h4>
<p>说实话，我也想简化。但现实是：</p>
<ol>
<li><strong>Forge 的 maker 不支持 Apple notarytool</strong> — 这是硬伤，没法绕过</li>
<li><strong>electron-builder 的 webpack 集成不如 Forge</strong> — 特别是多入口（main + renderer + preload + worker）场景</li>
<li><strong>原生模块的跨架构编译</strong> — 需要精细控制，两个工具各自的方案都不够灵活</li>
<li><strong>安全特性</strong> — Electron Fuses 只有 Forge 的 FusesPlugin 支持得好</li>
</ol>
<p>所以这个"混血"方案虽然复杂，但在当前的 Electron 生态下，它是 AionUi 这种重量级桌面应用的<strong>实际最优解</strong>。</p>
<p>代价就是——当 bug 出现在两个工具的"交界处"时，排查难度会指数级上升。就像这次的白屏事故。</p>
<h3 data-id="heading-17">经验总结</h3>
<h4 data-id="heading-18">1. <code>continue_on_error</code> 是一把双刃剑</h4>
<p>它能防止非关键失败阻塞流水线，但也能让关键错误悄无声息地溜走。如果一定要用，请确保有额外的<strong>产物校验逻辑</strong>，而不是无条件信任构建命令的退出码。</p>
<h4 data-id="heading-19">2. CI 绿灯 ≠ 构建成功</h4>
<p>特别是在 Electron 这种多步骤构建（webpack → electron-forge → electron-builder → 签名 → 公证）的场景下，任何一个环节的静默失败都可能产出一个"看起来没问题但其实不能用"的安装包。</p>
<p><strong>建议</strong>：在 build 脚本最后加一个产物校验：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> rendererIndex = path.<span class="hljs-title function_">join</span>(webpackDir, <span class="hljs-string">'renderer'</span>, <span class="hljs-string">'main_window'</span>, <span class="hljs-string">'index.html'</span>);
<span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(rendererIndex)) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Missing renderer entry: .webpack/renderer/main_window/index.html'</span>);
}
</code></pre>
<h4 data-id="heading-20">3. OOM 是一个平台相关的"薛定谔 Bug"</h4>
<p>同样的代码，同样的 webpack 配置，在 Windows 不 OOM、在 macOS 就 OOM。它可能今天不出现，明天加了一个依赖就出现了。对于大型 Electron 项目，<strong>主动设置 <code>--max-old-space-size</code> 是一个好习惯</strong>，不要等到 OOM 了才想起来。</p>
<h4 data-id="heading-21">4. 永远验证最终产物</h4>
<p>不要相信过程，要验证结果。在 CI 流水线里加一步检查最终产物是否存在且完整，能省去无数个排查白屏的深夜。</p>
<h3 data-id="heading-22">写在最后</h3>
<p>三天三夜，从怀疑 tar v7、到拆解 asar、到翻遍数百行 CI 日志，最终发现是一个 <code>continue_on_error: true</code> 配合 Node.js OOM 造成的"完美犯罪"。</p>
<p>修复只用了一行配置。但找到这一行的过程，让我深刻理解了一个道理：</p>
<blockquote>
<p><strong>最难调试的 bug，不是会报错的 bug，而是假装没有 bug 的 bug。</strong></p>
</blockquote>
<hr/>
<p>如果你也在做 Electron 开源项目，或者正在被 CI 打包问题折磨，欢迎关注 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FiOfficeAI%2FAionUi" target="_blank" title="https://github.com/iOfficeAI/AionUi" ref="nofollow noopener noreferrer">AionUi</a> —— 一个将命令行 AI Agent 变成现代聊天界面的桌面应用，支持 Gemini CLI、Claude Code、Codex、通义灵码等多种 AI 工具。</p>
<ul>
<li><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FiOfficeAI%2FAionUi" target="_blank" title="https://github.com/iOfficeAI/AionUi" ref="nofollow noopener noreferrer">github.com/iOfficeAI/A…</a></li>
<li><strong>技术栈</strong>：Electron 37 + React 19 + TypeScript + UnoCSS + Monaco Editor</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b1f4fc7f8ed450288840bba6b6f7ea3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29jb29uQnJlYWs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968477&amp;x-signature=86RivDulkWsTvYEW8LtpoxtUuPo%3D" alt="扫码_搜索联合传播样式-白色版.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[海量小文件 + 多云协同：地瓜机器人 JuiceFS 存储优化之路]]></title>    <link>https://juejin.cn/post/7603288778679500835</link>    <guid>https://juejin.cn/post/7603288778679500835</guid>    <pubDate>2026-02-06T07:49:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603288778679500835" data-draft-id="7603288778679484451" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="海量小文件 + 多云协同：地瓜机器人 JuiceFS 存储优化之路"/> <meta itemprop="keywords" content="后端,运维"/> <meta itemprop="datePublished" content="2026-02-06T07:49:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JuiceFS"/> <meta itemprop="url" content="https://juejin.cn/user/2665636828032446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            海量小文件 + 多云协同：地瓜机器人 JuiceFS 存储优化之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2665636828032446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JuiceFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:49:43.000Z" title="Fri Feb 06 2026 07:49:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>地瓜科技成立于 2024 年，由地平线机器人事业部拆分组建，专注于消费级机器人底层计算平台的研发；此外，地瓜科技在 2025 年还发布了具身智能基座模型。</p>
<p>在机器人数据管理和训练推理中，数据量庞大，使用对象存储时面临小文件、多云数据管理等挑战，在尝试了百度云 BOS、阿里云 CPFS 和将私有 MinIO 替换为 SSD 存储后，方案在应对上述挑战时仍然面临困难。地瓜机器人最终选择了 JuiceFS 作为核心存储解决方案。</p>
<p>JuiceFS 对跨云业务的天然适配能力，能够高效支持多云环境中的数据共享需求。在训练场景中，JuiceFS 针对小文件数据设计的缓存机制，能够有效替代传统缓存方案，同时在成本和效率之间实现高性价比，完全满足存储性能的需求。目前，地瓜机器人的文件管理规模已达到千万级别。</p>
<p>本文将详细介绍我们的业务背景、存储痛点、方案选型、落地实践与生产调优经验，希望对同行业的技术实践与方案选型提供参考与借鉴。</p>
<h2 data-id="heading-0">01 机器人行业的存储痛点</h2>
<p>云平台作为地瓜机器人的技术核心中枢，承担仿真环境搭建、数据生成与模型训练、模型轻量化部署及可视化验证等关键业务职能。平台所涉及的数据类型多元，主要包括传感器图像数据、激光雷达点云数据、模型权重与配置数据、电机运行数据及地图构建数据等。</p>
<p>对象存储虽能满足海量数据的基础存储需求，但在机器人业务高频出现的海量小文件处理场景中，性能短板尤为突出。地瓜机器人的存储系统面临四大核心挑战：</p>
<p><strong>海量小文件的元数据性能瓶颈</strong>：机器人模型训练环节涉及千万至亿级规模的传感器图像、激光雷达数据与模型文件，传统对象存储（如标准 S3）在处理该规模数据时，元数据操作性能存在显著瓶颈，文件列表检索、属性获取等常规操作的固定 API 延迟通常为 10–30 ms，直接制约训练与推理环节的 QPS 表现，影响整体研发效率。</p>
<p><strong>多云协同与数据流通效率低下</strong>：当前机器人企业普遍采用多云架构开展研发与生产业务，如何保障数据在不同云平台及地域间高效同步与共享，成为行业普遍面临的核心问题。传统存储方案跨云数据流通效率偏低，且大多与单一云服务商深度绑定，易形成技术依赖，难以实现灵活的跨云业务部署与数据协同。</p>
<p><strong>性能、成本与运维的 “不可能三角”</strong>：高性能并行文件系统可提供高吞吐、低延迟的存储服务，但通常依赖全闪存阵列或专用硬件设备，前期硬件投入与后期运维成本高昂，且部署运维流程复杂。低成本对象存储虽具备良好的弹性扩展能力，却难以支撑 AI 训练场景下 GPU 集群所需的高吞吐 I/O 负载。行业常规方案是将 S3 数据同步至高速文件系统作为缓存使用，但额外的数据同步流程大幅降低业务易用性，无法实现存储与计算的高效协同。</p>
<p><strong>数据集版本管理困难</strong>：机器人模型迭代速度快，需对多版本数据集进行高效、精细化管理。若采用物理拷贝的方式实现数据集版本控制，会直接导致底层存储容量成倍消耗，显著推高存储成本，同时多版本数据的检索、复用与维护难度也会大幅上升。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d38f7c618c37466194c1e8df3894012f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968983&amp;x-signature=bx%2BxzikdUNNUajZynkOEMH2qMDY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">02 存储选型：JuiceFS vs. MinIO/S3 vs. PFS</h2>
<p>为解决上述存储痛点，地瓜机器人确立了明确的选型评估标准，围绕存储架构、协议兼容性、元数据性能、扩展性、多云适配能力、成本效率、运维复杂度七大核心维度，对行业主流存储方案开展全面对比测试。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9335119fa4894d37a4c3a7f2179f78cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968983&amp;x-signature=ump0I6ByeE08ePpOTK5SnV5t3r8%3D" alt="" loading="lazy"/></p>
<p>基于上述对比结果，JuiceFS 在核心性能、扩展性、多云适配与成本效率等多个关键维度均展现出显著优势，成为地瓜机器人统一存储解决方案的首选。</p>
<p><strong>同时，JuiceFS 在智能驾驶领域已实现广泛落地，地平线等行业头部企业已通过 JuiceFS 完成千 PB 级别的数据承载，具备成熟的大规模场景应用经验</strong>。</p>
<p>针对地瓜机器人业务场景，JuiceFS 的核心技术优势主要体现在以下四大方面：</p>
<ul>
<li><strong>解耦架构</strong>：JuiceFS 采用元数据与数据分离的架构设计，将数据持久化存储在低成本对象存储（如 S3、OSS），元数据则托管于 Redis 或 TiKV 等数据库组件。<strong>这种解耦架构实现了存储的弹性扩展，避免对单一云服务商的依赖</strong>。</li>
<li><strong>分块与缓存机制</strong>：JuiceFS 使用 Chunk、Slice、Block 三级分块机制，有效提高了小文件读取效率，并提升了并发读写能力。此外，结合多级缓存（内存、本地 SSD、分布式缓存），可降低热数据访问延迟，满足高吞吐训练需求。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/255cf005d91148f8a8ae34b80b45d69d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnVpY2VGUw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770968983&amp;x-signature=%2BBXnmBm1Q7pqEXetpJDzJYzUfX4%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>云原生适配性</strong>：通过提供 CSI 驱动，JuiceFS 在 Kubernetes 环境中提供与计算节点解耦的持久化存储，支持容器无状态化部署和跨云迁移。它支持数据共享，提升应用的高可用性和灵活性，并适配多种 Kubernetes 部署方式。</li>
<li><strong>AI 训练全链路支持</strong>：JuiceFS 完整支持 POSIX、HDFS 和 S3 API，兼容主流 AI 框架（如 PyTorch、TensorFlow），无需修改代码即可接入，降低技术门槛。</li>
<li><strong>支持多云</strong>：其跨云能力和高性能元数据引擎确保数据流转高效，完美契合了我们“算力随需而动”的战略。</li>
</ul>
<p>从成本维度来看，JuiceFS 在初期小规模部署时成本优势不突出，但当数据规模突破 PB 级，尤其达到 10PB、100PB 级别并与全闪存方案对比时，其依托对象存储的低成本架构优势将全面凸显。此外，JuiceFS 的运维成本极低，地瓜机器人当前仅需一名工程师即可负责整个云平台与存储系统的运维工作，远低于传统方案所需的人员投入。</p>
<h2 data-id="heading-2">03 从社区版到企业版，应对更大规模场景需求</h2>
<p>随着业务的不断扩展，我们在使用 Redis 作为元数据引擎时，发现物理内存容量限制了数据的扩展。当文件数量接近亿级时，元数据查询的延迟显著增加，进而影响了训练任务的并发效率。在使用 clone 功能后，元数据的量大幅增加，另外我们在跨云场景中对元数据同步和镜像文件系统的能力提出了更高要求。同时，我们还希望在目录级别进行更细粒度的容量限制和权限管理。</p>
<p>考虑到这些需求，以及希望利用 GPU 机器本地 SSD 构建分布式缓存层来提升性能，我们决定并行部署 JuiceFS 企业版，将超大规模目录管理、多机协同训练等核心场景迁移至该版本。通过这种场景化拆分，我们有效提升了整体存储系统的适配性，并为未来的业务增长提供坚实的基础。以下是我们在实际场景中应用的企业版关键特性。</p>
<p><strong>特性 1- 高性能元数据引擎：解决超大规模目录检索瓶颈</strong><br/>
针对亿级文件目录下的遍历、深分页查询等高频操作，我们曾遇到传统存储方案 “越查越慢” 的问题 —— <strong>单目录文件量突破千万后，分页查询偏移量超过 10 万条时，响应延迟会从百毫秒级飙升至秒级，严重影响数据筛选效率</strong>。</p>
<p>切换至 JuiceFS 企业版后，其元数据的原生目录树形存储架构发挥了关键作用：不同于扁平化 KV 对文件元数据的无序存储，这种树形结构可直接定位目录层级，减少元数据扫描范围。我们实际测试中，单目录 1.2 亿文件的深分页查询（偏移量 50 万条），延迟从原来的 3.8 秒降至 210 毫秒，完全满足大规模数据集的检索需求；同时，该引擎支持单卷千亿级文件存储，目前我们已基于此支撑 3 个 PB 级训练数据集的稳定管理，匹配业务增长预期。</p>
<p><strong>特性 2- 企业级分布式缓存：提升多机多卡训练数据共享效率</strong><br/>
在多机多卡训练场景中，我们曾面临 “缓存命中率低、跨节点带宽拥堵” 的问题 —— 开源版仅支持节点本地缓存，当多节点同时拉取同一数据集时，每个节点都需要访问对象存储，导致单节点带宽占用率超过 90%，训练任务启动延迟平均达 20 分钟。借助 JuiceFS 企业版的分布式缓存功能，我们通过 3 行命令在 12 台训练节点组成的局域网内搭建了分布式缓存，数据集只需要从对象存储拉取一次，并缓存在节点本地 SSD 组成的缓存池中。<strong>多机协同训练的缓存命中率从原来的 45% 提升至 92%，跨节点带宽占用率降至 15% 以下，训练任务启动时间缩短至 3 分钟内，大幅提升了算力利用率</strong>。</p>
<p><strong>特性 3- 增强型跨云协同：构建低运维成本的跨云数据底座</strong><br/>
由于我们的研发环境分布在阿里云、百度云两个平台，此前存在 “跨云数据同步慢、运维成本高” 的痛点 —— 通过传统同步工具实现两地数据一致，需配置 8 个定时任务，同步延迟平均达 4 小时，且需专人每周排查同步失败问题。基于 JuiceFS sync 工具，结合内部 AI 运维工具实现了同步策略自动化配置：系统可根据数据热度自动调整同步优先级，跨云数据延迟控制在 10 分钟内；<strong>同时，同步任务的失败重试、日志告警等均实现自动化，无需专人值守，运维投入减少 70%，目前已稳定支撑两个云平台多个训练项目共享同一套数据集。后续，将使用企业版的镜像文件系统功能来应对跨云数据协同</strong>。</p>
<h2 data-id="heading-3">04 JuiceFS 调优攻略</h2>
<p><strong>客户端缓存与写入性能调优实践</strong><br/>
需重点关注缓存策略与 Kubernetes 资源限额之间的兼容性问题。如使用内存作为本地缓存路径，配置不合理可能引发 Mount Pod 内存异常增长，或因资源配额预留不足，导致长周期训练任务出现检查点丢失、文件句柄写入异常等情况。</p>
<p>在写入性能调优方面，开启 writeback 模式可在一定程度上提升小文件写入吞吐，但结合生产环境对数据一致性的要求，我们仍采用 write-through 同步写入模式，以降低极端宕机场景下的数据风险。建议仅在对数据可靠性要求较低的临时计算、离线数据清洗等场景中，根据实际需求谨慎启用 writeback 模式以提升写入效率。</p>
<p><strong>部署与网络拓扑优化</strong><br/>
为获得更稳定的性能表现，在部署时强烈建议将元数据引擎与计算节点规划在同一 region 区域内。实际运行中观察到，跨 region 部署会使元数据操作延迟出现数倍至十倍的上升，对数据解压等 I/O 密集型操作的效率影响较为明显。将元数据服务与 GPU 计算资源部署在同一 region 内，有助于在保障性能的同时控制网络传输成本，提升整体资源利用效率。</p>
<p><strong>数据预热与缓存优化策略</strong><br/>
在万兆网络环境下，可充分利用 JuiceFS 的数据预热机制，结合业务场景合理调整数据块大小，以更好地发挥网络带宽能力，提升读吞吐量。配合分布式缓存架构，可有效改善多机并发场景下的数据共享效率，提升高并发读取时的缓存命中率，从而优化大规模 AI 训练任务的整体运行表现。</p>
<p><strong>资源配额与高可用保障策略</strong><br/>
企业级多角色运维、存储职责分离场景下，为规避配置不一致的运行风险，建议精细化管控 K8s 环境中 JuiceFS CSI 驱动的资源配额。通过合理设置 Mount Pod 的 CPU 与内存 Request/Limit，可减少因资源抢占导致的 Pod 重启或节点异常，实际使用中可根据集群负载动态调整资源预留比例。</p>
<p>同时，对业务连续性要求较高的场景，可开启 Mount Pod 的挂载点自动恢复功能，实现存储服务的自动化故障恢复，进一步保证底层存储的稳定性。</p>
<p><strong>多租户实践</strong><br/>
我们为大型企业客户提供独立文件系统和存储桶，并通过子目录级别的目录隔离和权限管控实现中小型企业客户与终端用户的隔离。大型企业客户可以灵活扩展吞吐量和容量，避免共享存储桶带来的性能瓶颈。对于中小型企业和终端用户，我们通过子目录隔离和权限管控确保数据安全与独立性，同时实现精确计量与计费。这一架构在保障租户隔离的同时，也能灵活调配资源，提高系统管理效率。</p>
<p><strong>版本管理</strong><br/>
通过 <code>juicefs clone</code> 命令，可以快速创建原始数据集的副本，并独立修改，而不影响原数据。克隆操作仅复制文件的元数据，数据则只额外存储变更部分，节省底层存储空间。此功能支持管理多个版本，便于回滚和恢复，确保数据的安全性和版本控制。</p>
<h2 data-id="heading-4">05 小结与展望</h2>
<p>JuiceFS 在元数据性能、扩展能力、跨云适配性与综合成本效率等方面的特性，支撑其成为我们构建统一存储层的选择。目前地瓜科技采用 JuiceFS 社区版与企业版并行部署的模式，适配不同业务场景下的差异化存储诉求。</p>
<p>未来，我们计划将 JuiceFS 进一步落地至具身智能领域，针对性解决该场景下的专属存储需求，包括时序数据高吞吐处理、多模态数据精准对齐、边缘与云端协同存储及仿真与真实场景数据的融合管理等。后续积累更多实践经验后，我们将持续分享具身机器人场景下的存储实践心得。关于 AI 场景的存储实践与技术探索，欢迎评论区一起交流探讨。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenClaw对接聊天APP及AI助手工具]]></title>    <link>https://juejin.cn/post/7603309951227084850</link>    <guid>https://juejin.cn/post/7603309951227084850</guid>    <pubDate>2026-02-06T07:53:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951227084850" data-draft-id="7603393977476890650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenClaw对接聊天APP及AI助手工具"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-02-06T07:53:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenClaw对接聊天APP及AI助手工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:53:20.000Z" title="Fri Feb 06 2026 07:53:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>OpenClaw对接聊天APP及AI助手工具</p>
<h2 data-id="heading-0"><strong>1、对接飞书聊天APP</strong></h2>
<h3 data-id="heading-1">openclaw配置</h3>
<p>此处以飞书为例，输入插件下载安装命令：</p>
<pre><code class="hljs language-bash" lang="bash">openclaw plugins install @m1heng-clawd/feishu  
<span class="hljs-built_in">cd</span> /root/.openclaw/extensions/feishu/ 
npm install --verbose  <span class="hljs-comment">#此步骤安装时间较强长，请耐心等待。</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4514ce834424f8e8d1261763a68010f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=tim0A43wIW8etJ3OUbeobTvJPIM%3D" alt="图片.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/747da7234bc54720888528bf2091cb83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=MNnU4T6x6rispqa%2FBOo6I8v91IA%3D" alt="图片.png" loading="lazy"/></p>
<p>等下载安装完成后。在命令行下运行openclaw图形配置界面。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">open</span> channels <span class="hljs-keyword">add</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3c11c79c7754fb1a00f79e40aa06f8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=4oyiQOd17mZFH1F%2BYUroTUtuO8s%3D" alt="图片.png" loading="lazy"/></p>
<p>回车</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1e3044a666844848b496d5b1c6effd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=hs2bio0WUw4HuH0b%2BHikGtNMi%2FY%3D" alt="图片.png" loading="lazy"/></p>
<p>回车后，根据提示输入飞书App ID和App Secret。</p>
<p>在飞书开放平台应用凭证获取，打开飞书（<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fapp%2F" target="_blank" title="https://open.feishu.cn/app/" ref="nofollow noopener noreferrer">open.feishu.cn/app/</a>），点击左边凭证基础信息，在页面中找到 “App ID” 和 “App Secret” 两个数据，分别点击右侧 “复制” 按钮，将其复制到openclaw配置界面。飞书配置参考下一章节。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62d44babed384246ac0b55b478c926cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=hHPBKt8DuZs3HcsYGJEVfl9JK2s%3D" alt="图片.png" loading="lazy"/></p>
<p>输入应用凭证后，回车完成配置。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a27a0f7cc64748b388a4d091fcef6f70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=KOemJopiS%2Bl%2F21ec05R1TVNd4Oo%3D" alt="图片.png" loading="lazy"/></p>
<p>openclaw gateway restart ，重启网关服务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f574ab973086452fb93b0d089936ae84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=1B1vejYY3HkoDKE%2FtqwK4iMqx%2BM%3D" alt="图片.png" loading="lazy"/></p>
<p>运行openclaw status，查看状态是否正常。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75a9ffdda41d46d2b4b39491d46c549f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=vhvT1dqzfRvy86KdmAo0P9do8Pg%3D" alt="图片.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60ba2cb3573746d697a903ba0142b3fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=vPib4UqRE5aX%2FG0GwOtg%2FsylBjI%3D" alt="图片.png" loading="lazy"/></p>
<h3 data-id="heading-2"><strong>验证飞书接入</strong></h3>
<ol>
<li>打开手机或电脑端飞书 APP，登录与飞书开发者平台相同的账号；</li>
<li>在飞书首页，找到 “工作台” 入口，点击进入，在工作台列表中找到已发布的 openclaw 应用（如 “openclaw 助手”），点击进入；</li>
<li>系统将自动启动私聊窗口，发送任意消息（如 “你好”“查询今日日程”）；</li>
<li>验证结果：如果收到 openclaw 的回复，即为飞书接入成功</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c84335223aa546cf89242b582223d1d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=6VLMJECO2Icr%2B8um5jZU2bpGvZo%3D" alt="图片.png" loading="lazy"/></p>
<p>以上配置完成后，即可上手使用。快上京东云开启一键部署，让 openclaw 成为你专属的 24 小时数字员工！</p>
<h3 data-id="heading-3"><strong>飞书机器人配置</strong></h3>
<p><strong>创建飞书企业自建应用</strong></p>
<ol>
<li>访问飞书开发者平台（<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fapp%3Flang%3Dzh-CN%25EF%25BC%2589%25EF%25BC%259B" target="_blank" title="https://open.feishu.cn/app?lang=zh-CN%EF%BC%89%EF%BC%9B" ref="nofollow noopener noreferrer">open.feishu.cn/app?lang=zh…</a></li>
<li>登录后，点击 “创建企业自建应用”；</li>
<li>填写应用基础信息：应用名称（如 “openclaw 助手”），选择应用图标，点击 “创建” 按钮，进入应用管理页面。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/070c99d6ea104352a7028380962cc58f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=foNq%2Fa0%2BOuA2iZMAOiEH%2Bt4wzaE%3D" alt="图片.png" loading="lazy"/></p>
<ol>
<li>添加机器人能力：在应用管理页左侧导航栏，找到并点击 “添加应用能力”，在弹出的列表中选择 “机器人”，点击 “添加”。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b36f728ee9664f90aa8c1c90595b20b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=k8LIYe3TPtuTlU9ocCytbbn5sW4%3D" alt="图片.png" loading="lazy"/></p>
<ol>
<li>点击上方的创建版本并发布。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91e42d5d1948451a84b440caf17ac169~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=6nSYJhVU4LyTVKCbKbBfyXXaV1I%3D" alt="图片.png" loading="lazy"/></p>
<p>飞书应用权限与事件配置</p>
<p>此步骤分为「事件配置」「权限配置」「应用发布」三部分，全程在飞书开发者平台操作，按顺序执行：</p>
<h3 data-id="heading-4">（1）事件配置</h3>
<ol>
<li>在飞书应用管理页，左侧导航栏找到 “事件与回调” 栏目，点击进入；</li>
<li>事件配置：在页面中选择 “长连接”，点击 “保存”；</li>
</ol>
<p>⚠️如果这一步提示 <strong>“未建立长连接”，</strong> 请检查自己的APP ID和APP Secret是否已正确配置。</p>
<p>（操作见上一步：添加飞书channel配置-配置APP ID与APP Secret）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67eef6305499496a9799fa949d8d755c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=BT9x4K7evtFWcw4%2BAnt5J2FPEGs%3D" alt="图片.png" loading="lazy"/></p>
<ol>
<li>添加事件：点击页面中的 “添加事件”，在弹出的事件列表中，选择 “消息与群组” 分类，勾选 “接收消息”，点击 “确定”，完成事件订阅。</li>
</ol>
<p><img src="" alt="" loading="lazy"/></p>
<ol>
<li>回调配置：订阅方式选择 “使用长连接”，无需填写其他地址，配置自动生效。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fe5ac63bfcd4d18a9c70a7aa87736b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=RqgvrOvYZIMXxteaQWPqSGembaI%3D" alt="图片.png" loading="lazy"/></p>
<h3 data-id="heading-5">（2）权限配置</h3>
<ol>
<li>在飞书应用管理页，左侧导航栏找到 “权限管理” 栏目，点击进入；</li>
<li>点击页面中的 “批量导入权限” 按钮，弹出权限导入窗口；</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69ae719e876b4da1a4547e504a25568d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=Wsb7VJyp9sEa8O3rm6UEj46g0YM%3D" alt="图片.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fd5fbc2def840f3930c6188c4827fcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=y7u%2Fe6n1nufGhXykpIo4zqWtwUY%3D" alt="图片.png" loading="lazy"/></p>
<p>3.复制以下 JSON 代码，粘贴到导入窗口的输入框中，点击 “导入” 按钮，等待权限导入完成：</p>
<p>代码语言：txt</p>
<p>AI代码解释</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>  
 <span class="hljs-attr">"scopes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>     <span class="hljs-attr">"tenant"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>       
 <span class="hljs-string">"contact:user.base:readonly"</span><span class="hljs-punctuation">,</span>    
    <span class="hljs-string">"im:chat"</span><span class="hljs-punctuation">,</span>       
    <span class="hljs-string">"im:chat:read"</span><span class="hljs-punctuation">,</span>     
    <span class="hljs-string">"im:chat:update"</span><span class="hljs-punctuation">,</span>      
    <span class="hljs-string">"im:message"</span><span class="hljs-punctuation">,</span>       
    <span class="hljs-string">"im:message.group_at_msg:readonly"</span><span class="hljs-punctuation">,</span>       
    <span class="hljs-string">"im:message.p2p_msg:readonly"</span><span class="hljs-punctuation">,</span>       
    <span class="hljs-string">"im:message:send_as_bot"</span><span class="hljs-punctuation">,</span>       
    <span class="hljs-string">"im:resource"</span>     <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>     
    <span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>   <span class="hljs-punctuation">}</span> <span class="hljs-punctuation">}</span>
</code></pre>
<p>4.导入验证：页面显示 “导入成功”，且权限列表中出现上述导入的权限，即为配置完成。</p>
<h3 data-id="heading-6">（3）发布应用</h3>
<ol>
<li>在飞书应用管理页，左侧导航栏找到 “版本管理与发布” 栏目，点击进入；</li>
<li>点击右上角的新建版本；</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6388d20db1a94e08ab81c921542873da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=svGMizJKfzpOaoNuP9Pbtm4k3%2BU%3D" alt="图片.png" loading="lazy"/></p>
<p>填写版本号与描述后，保存并发布；</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c692fc723b847debe350c84487e4a88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=O2ijQ656quJDuK5vmKBDhcPZQss%3D" alt="图片.png" loading="lazy"/></p>
<h2 data-id="heading-7"><strong>2、更换模型</strong></h2>
<p>openclaw onboard</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0127aa7b4a534e479c4b9af5af2048a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=zu2HrDMfEDcrud3n3Dyt80kteR8%3D" alt="图片.png" loading="lazy"/></p>
<p>按键盘上左右方向键，选择到“Yes”后，按回车键开始配置。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfef0a0591224877bb7bcb41f81bd10d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=O9kGV6w0LmGrkSNrtpivx4ZrIgg%3D" alt="图片.png" loading="lazy"/></p>
<p>Onboarding mode 选 QuickStart。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57c79076090541f2be845832ee53fd30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=UvQjVbb3bNsS3Pv4lkYARuO1Abw%3D" alt="图片.png" loading="lazy"/></p>
<p>选择Qwen等模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/657e79f4854d4c3d83b61c19747e41eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=4620lqgdmpx%2FbOpfR52qzQWXrrY%3D" alt="图片.png" loading="lazy"/></p>
<p>回车确认。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81016332a40a4c22aabe6793cd776e3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=VPaRUvpZlHi%2BmASAj4E7Agu9v8Q%3D" alt="图片.png" loading="lazy"/></p>
<p>复制地址在浏览器中打开，后登录账号确认通过。（需要先注册账号<a href="https://link.juejin.cn?target=https%3A%2F%2Fchat.qwen.ai%2F" target="_blank" title="https://chat.qwen.ai/" ref="nofollow noopener noreferrer">chat.qwen.ai/</a>）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c9243ef4d744f76b7c0aa87535226a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=MgMB8nofYS0L8gU07R9gFyZlrfQ%3D" alt="图片.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61543afed7b04724805708489dd13b47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=JYQJ7BNN8Sr1jviwaIYXMo%2Fksts%3D" alt="图片.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ce5ec2b96f24245b5250b52f1bf5c0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=ys8q3cgIvo8sfX6TPk4O%2FV%2Fj8uo%3D" alt="图片.png" loading="lazy"/></p>
<p>选择默认模型后，回车确认。选择选择重启网关服务后即生效。</p>
<p>技能包（Skill）配置</p>
<p>新手暂时无需添加额外技能包，选中 “No” 跳过，按回车键确认；</p>
<p>Hooks 配置</p>
<p>选中 “session-memory”（启用记忆功能，支持多轮对话上下文关联，避免每次聊天都需要重复说明需求），其他两项可根据需求选择。按回车键确认；</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd10fb1420664b75862d28a0ba7e67ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969200&amp;x-signature=QrE4pg%2BpYhB%2F5N0MSsk6dOBAy7I%3D" alt="图片.png" loading="lazy"/></p>
<h2 data-id="heading-8">3、常用命令汇总</h2>





















































<table><thead><tr><th>查看版本</th><th>openclaw --version</th></tr></thead><tbody><tr><td>查看运行状态</td><td>openclaw status</td></tr><tr><td>启停Bot</td><td>openclaw start/stop/restart</td></tr><tr><td>启动openclaw配置</td><td>openclaw onboard</td></tr><tr><td>启动Openclaw的TUI</td><td>openclaw tui</td></tr><tr><td>通过SSH连接TUI</td><td>ssh root@公网IP</td></tr><tr><td>重启网关</td><td>openclaw gateway restart</td></tr><tr><td>查看已安装插件</td><td>openclaw plugins list</td></tr><tr><td>安装插件</td><td>openclaw plugins install 插件名</td></tr><tr><td>更新插件</td><td>openclaw plugins update 插件名</td></tr><tr><td>卸载插件</td><td>openclaw plugins uninstall 插件名</td></tr><tr><td>查看帮助</td><td>openclaw --help</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenClaw闪电部署，立即体验AI助手]]></title>    <link>https://juejin.cn/post/7603352117638938633</link>    <guid>https://juejin.cn/post/7603352117638938633</guid>    <pubDate>2026-02-06T07:52:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603352117638938633" data-draft-id="7603376587651694642" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenClaw闪电部署，立即体验AI助手"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-02-06T07:52:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenClaw闪电部署，立即体验AI助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T07:52:27.000Z" title="Fri Feb 06 2026 07:52:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>OpenClaw是少数真正具备系统级操作能力的个人智能助理：</p>
<ul>
<li>本地长期记忆（对话数据自主可控）</li>
<li>跨平台推送（支持对接通讯类软件）</li>
<li>真实任务执行（文件整理、表单提交、代码生成）</li>
</ul>
<p>这样一个强大又敏感的 AI 助手，该运行在哪里？更安全、更稳定的方式，是将其部署在独立、隔离的云端环境中。</p>
<p>京东云全面上线 openclaw(Clawbot)！京东云轻量云主机现已预置 openclaw 应用镜像，无需手动配置环境，2步即可完成部署，让你的 AI 助手秒级上线、全天候待命。</p>
<h2 data-id="heading-0"><strong>第一步：一键创建实例</strong></h2>
<p>在京东云控制台创建轻量云主机，选择：</p>
<p>镜像名称：openclaw（Clawdbot）</p>
<p>规格建议：2 核 2G 起 <strong>（推荐 2 核 4G 以获得更佳体验）</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/785bfc8a05fc4c4683adef1e67cda3bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=5LspjJ51r2oMhbL4QvXi%2B1zLVKI%3D" alt="图片.png" loading="lazy"/></p>
<p>创建成功后，进入云主机列表页，点击右边<strong>操作列</strong>的【查看】，打开18789端口。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/293eb1ebc38244fdb04ba575318b15e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=j7HLMkpxkG5XhxCGMabFIiM7rds%3D" alt="图片.png" loading="lazy"/></p>
<p>点击【防火墙】，打开后点击【添加规则】。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ef05a967fa54c0c8ab21d553e65aba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=3gahUPR6iXbRlz0lvNokO3QbdqE%3D" alt="图片.png" loading="lazy"/></p>
<p>在目标端口中输入18789，源IP输入0.0.0.0/0，点击【保存】。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95c8d49e883b4d7f866c2ceb8a9a1ed7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=FGizS7FSLaJPiqLBQ8xlBhrrjO8%3D" alt="图片.png" loading="lazy"/></p>
<p>再次转到轻量云主机列表，<strong>记录下公网IP地址</strong>，点击【登录】。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adc01369550e4cc3963abfb7c2c86858~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=0Vum3Lip4ehNjgkB5URhvSYesb4%3D" alt="图片.png" loading="lazy"/></p>
<p>通过WebTerminal登录云主机。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b660d88dd957415aa78b8bccab34d878~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=2RTK%2FBVLi7jFiz9zp3HVMb5h4EQ%3D" alt="图片.png" loading="lazy"/></p>
<p>进入配置界面。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce77cb7950c74565ab329f05adce6b65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=1HUrJcNrouc8851RuLlzt1FEWlU%3D" alt="图片.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>第二步：配置openclaw</strong></h2>
<p>通过webTerminal登录系统后，执行下面的命令。</p>
<p>bash init-openclaw.sh 18789 pk-03bf0b76-8326-4ad7-91bf-293c5dd35c8d 公网IP    </p>
<p>#红色部分替换成你的API-KEY，API-KEY获取步骤参考下方【<strong>获取API-KEY</strong>】章节。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/683a7bb4d99c498fbbf386ea48ec5810~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=BrTl8NexCHWTmV2gDi5lCehHu7c%3D" alt="图片.png" loading="lazy"/></p>
<p>回车后，生成可以直接访问的地址【<a href="https://link.juejin.cn?target=http%3A%2F%2F%25E5%2585%25AC%25E7%25BD%2591IP%3A18789%3Ftokan%3D%25E5%25AD%2597%25E7%25AC%25A6%25E4%25B8%25B2" target="_blank" title="http://%E5%85%AC%E7%BD%91IP:18789?tokan=%E5%AD%97%E7%AC%A6%E4%B8%B2" ref="nofollow noopener noreferrer">http://公网IP:18789?tokan=字符串</a>】。复制在Web浏览器中回车打开。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e24008346cb4ecfaf87850f77824392~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=%2FxWyewLqq%2BCbpuVbOXr43BmwQIE%3D" alt="图片.png" loading="lazy"/></p>
<p>出现openclaw的web交互网站，可以直接和AI助手对话了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44c84f82463748d0b523b7a56d91b6bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=%2FS0ud5dRtVbcZPqU1gJHVP92frk%3D" alt="图片.png" loading="lazy"/></p>
<h3 data-id="heading-2"><strong>获取API-KEY</strong></h3>
<p>登录京东云JoyBuilder 模型开发平台 2.0，进入API-KEY 管理页面：</p>
<p>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fjoybuilder-console.jdcloud.com%2Fsystem%2Fapi-key%2Flist" target="_blank" title="https://joybuilder-console.jdcloud.com/system/api-key/list" ref="nofollow noopener noreferrer">joybuilder-console.jdcloud.com/system/api-…</a>）</p>
<p>1、点击【创建】按钮，生成新的 API-Key；</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22fe26bc30d34983ba4ca2f443597820~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=9pK6F7eU5vcxdpMoA%2BS0WgWEZzk%3D" alt="图片.png" loading="lazy"/></p>
<p>2、选择长期有效，点击【确定】。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3f9e9cc67ce4efa9a6c720eaa3ea3a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=YEcTdpabR8RW4pR3RYabEJZLrV4%3D" alt="图片.png" loading="lazy"/></p>
<p>3、生成长期的API-KEY，点击右边复制图标复制API-KEY。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91360bace9de45faa351b125c9c38444~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=Pb8fZQc5huqoVCMye3jGmVmCx3o%3D" alt="图片.png" loading="lazy"/></p>
<p>4、在“修改 API-KEY”页面中，为该 Key 配置可访问的模型服务，必须包含以下模型：DeepSeek-V3-0324、DeepSeek-V3.2、DeepSeek-v3、Qwen3-235B-A22B、Kimi-K2-0905-jcloud</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1a30aa141a1417a95f88105d09bd79e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=HALFeJyHRPLsSKY9IGlnlHTQvXU%3D" alt="图片.png" loading="lazy"/></p>
<p>5、选择需要的模型，或者全部选上。点击【确定】完成模型绑定。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51090a363363461a9d98b01f20e7330d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=OyAyVET%2FQTA%2FQTM97kGzmfWwATY%3D" alt="图片.png" loading="lazy"/></p>
<p>6、为了保证模型正常工作，需要至少保证账户中有金额。点击充值完成京东云账号充值。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47bd494403a74bd7b606087b69c94341~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969150&amp;x-signature=yeugBviN%2FfEIDCePpkxIW6vHKjc%3D" alt="图片.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[春节流量洪峰将至，你的AI应用“扛得住”吗？]]></title>    <link>https://juejin.cn/post/7603389033041952822</link>    <guid>https://juejin.cn/post/7603389033041952822</guid>    <pubDate>2026-02-06T08:00:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603389033041952822" data-draft-id="7603352061506633734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="春节流量洪峰将至，你的AI应用“扛得住”吗？"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-02-06T08:00:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            春节流量洪峰将至，你的AI应用“扛得住”吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T08:00:46.000Z" title="Fri Feb 06 2026 08:00:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>用户指尖轻点，AI生成专属祝福视频；</p>
<p>语音唤醒，智能助手实时解读春晚梗；</p>
<p>顺手一拍，生成惊艳的 3D 空间视频。</p>
<p>——当千万人春节同时涌入AI应用，请求排队、生成卡顿、页面加载失败……如果没有强大的算力做底座，**结果往往只有两个：要么卡顿掉线，要么直接宕机。**企业辛苦拉来的新用户，就在漫长的加载圈和 502 报错里流失了。</p>
<p><strong>这不是科幻场景，这是AI 团队真实面临的焦虑。</strong></p>
<p>据行业测算，仅除夕当晚，主流AI红包活动的交互量将突破千亿次，瞬时并发峰值或达10亿次/秒。每一次对话、每一帧生成、每一次交互，背后都是GPU集群的高速运转。对很多AI企业而言，这种瞬时迸发的算力需求，无疑是一场前所未有的“期末大考”，而大多数传统云服务商，根本没有能力接住这波流量冲击。</p>
<p>而有一家创业公司，在去年一场真实的“流量海啸”中，不仅稳稳接住了，还完成了一次漂亮的技术支撑。这个故事的主角，是全球3D内容应用头部企业——Remy。</p>
<h2 data-id="heading-0"><strong>一、Remy：3D内容“全民化”的先锋</strong></h2>
<p>Remy是KIRI Innovation（麒砺创新）旗下产品，由创始人王正男（Jack）于2018年在加拿大多伦多创立，团队七年深耕，只做“降低3D内容创作门槛”一件事。从全球首创手机外接3D扫描仪Phiz，到2021年战略转型推出纯手机应用KIRI Engine，借助NeRF等先进算法实现高质量3D建模；从深耕海外市场，用技术长视频积累上万核心用户，到2024年将高斯泼溅技术工程化，9天获得100万下载量的手机应用——<strong>Remy的每一步，都在打破3D技术的专业壁垒。</strong></p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4cedecb90e942acae8808cd6a7aba67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969646&amp;x-signature=htsPYg%2FLq8tjOxnCCSRitUXDJ4k%3D" alt="" loading="lazy"/></p>
<p>去年在华为HarmonyOS 6 的发布会现场，Remy 惊艳亮相。创始人兼 CEO 王正男现场演示，仅用一段手机环绕视频，就生成了可在手机里自由查看的沉浸式 3D 空间。发布会结束仅数小时，Remy 的下载量便一路飙升，直冲华为应用市场第一。</p>
<p>**Remy 让 3D 内容真正走向大众。**无需专业设备，也不用建模基础，一部普通智能手机，对准实物拍摄一段视频，五分钟后就能生成一个可 360° 查看、可社交分享的沉浸式 3D 空间。曾经只有专业工作室才能具备的能力，如今被装进了每一位华为用户的口袋。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67d976aac5124c7885ca98b68d07fa9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969646&amp;x-signature=WcU7SbUzzIxQfRS%2BEC%2BrFePcc2o%3D" alt="" loading="lazy"/></p>
<p><strong>高光时刻，也是生死考验。</strong></p>
<p>汹涌的用户瞬间涌入，每秒都有成千上万条视频等待被“3D 化”。后台算力需求呈指数级飙升，服务器压力骤增。对于一家创业公司而言，这是梦寐以求的高光，也是一场关乎存亡的极限压力测试：如果用户点开应用却迟迟无法生成，刚点燃的市场热情将迅速冷却。</p>
<p><strong>关键时刻，KIRI 的底层算力合作伙伴</strong>**-<strong><strong>共绩科技启动了</strong></strong>秒<strong><strong>级</strong></strong>响应机制****。**通过弹性算力调度系统，在 48 小时内将支撑 Remy 的 GPU 集群规模从百卡极速扩容至 1900 张卡，稳稳接住了50小时内50万用户的集中登录冲击！</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a34ba087fa4e4dc38764032295ae8526~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770969646&amp;x-signature=cfvCJ5BmZpqqwnLSSFxBn46RBBw%3D" alt="" loading="lazy"/></p>
<p>流量洪峰再猛，Remy 的用户体验依然丝滑，没有掉链子。</p>
<p>这背后，正是共绩科技的核心能力：<strong>极速、稳定的算力弹性扩缩容。</strong></p>
<h2 data-id="heading-1">二、算力如水：按需调度，秒级扩缩</h2>
<p>共绩的核心团队来自清华，他们做的，简单说，就是打造了一张“智能算力电网”。</p>
<p>这恰好完美匹配了 AI 应用春节期间的“心跳曲线”：</p>
<ul>
<li><strong>秒级弹性：</strong> 流量高峰来了，算力自动跟上；高峰过去，资源自动释放。你只需为实际使用量付费，无需为“可能用得上”的峰值容量提前买单。</li>
<li><strong>极致稳定：</strong> 通过智能容错和高可用架构，保障关键任务 SLA 高达 99.99%。春节值守，你可以更安心地关注业务本身，而不是后台的负载告警。</li>
<li><strong>简单易用：</strong> 提供 Serverless GPU 服务，支持 Docker 容器化一键部署，预置主流 AI 框架。你无需关心底层运维，像用水用电一样，专注你的 AI 创意。</li>
</ul>
<p>很多 AI 圈的同行习惯了传统云厂商的包年包月模式，为了春节那 1% 的突发流量，不得不闲置 99% 的算力资源，成本高昂且浪费严重。</p>
<p>但在 AI 时代，尤其是面对春节这种不可预测的流量爆发，“固定”就是最大的风险，“弹性”才是硬核的生存能力。共绩做算力的初衷很简单：<strong>别让算力成为创新的瓶颈，也别为了防范 1% 的突发流量，浪费 99% 的预算在闲置资源上。</strong></p>
<h2 data-id="heading-2">三、找靠谱的战友，过个安心年</h2>
<p>春节的流量洪峰，从来都不是单纯的挑战，更是弯道超车的机遇。它考验着产品的吸引力，更考验着企业的“底层内力”——算力支撑的厚度，直接决定了你能接住多少流量、留住多少用户。</p>
<p><strong>Remy 的故事，很可能在今年的春节，以更大的规模、在更多的 AI 应用上重演。</strong></p>
<p>与其在焦虑中祈祷服务器稳定，不如在节前为你的 AI 应用找一个靠谱的“战友”。让共绩这个专业的“算力守护者”，帮你解决弹性扩缩容的核心难题，扛住春节流量洪峰。</p>
<p>毕竟，在 AI 竞赛的下半场，稳定的用户体验，才是最好的新春祝福。</p>
<p>春节流量大战在即，愿每一家 AI 企业都能专心做产品、冲流量，至于算力这件事，交给共绩就好——你只管乘风破浪，它帮你扛住算力压力，守住每一波流量红利，过一个安心年。<br/>
通过邀请链接注册能免费使用4090卡6小时：<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.suanli.cn%2Fauth%2Flogin%3Finvite_code%3DJFzx9q0WZ1" target="_blank" title="https://console.suanli.cn/auth/login?invite_code=JFzx9q0WZ1" ref="nofollow noopener noreferrer">console.suanli.cn/auth/login?…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分享前端项目常用的三个Skills--Vue、React 与 UI 核心 Skills | 掘金一周 2.5]]></title>    <link>https://juejin.cn/post/7603160727717609523</link>    <guid>https://juejin.cn/post/7603160727717609523</guid>    <pubDate>2026-02-05T08:40:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603160727717609523" data-draft-id="7602935146707337262" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分享前端项目常用的三个Skills--Vue、React 与 UI 核心 Skills | 掘金一周 2.5"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2026-02-05T08:40:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金一周"/> <meta itemprop="url" content="https://juejin.cn/user/53218623894222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分享前端项目常用的三个Skills--Vue、React 与 UI 核心 Skills | 掘金一周 2.5
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/53218623894222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金一周
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T08:40:11.000Z" title="Thu Feb 05 2026 08:40:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><em>本文字数1500+ ，阅读时间大约需要 4分钟。</em></p>
<blockquote>
<p>【掘金一周】本期亮点：</p>
</blockquote>
<ul>
<li>
<p><a href="https://juejin.cn/post/7599641289887055918" target="_blank" title="https://juejin.cn/post/7599641289887055918">分享前端项目常用的三个Skills--Vue、React 与 UI 核心 Skills</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7598921649888968731" target="_blank" title="https://juejin.cn/post/7598921649888968731">供应链系统中的 Web 打印方案的探索实践</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7600238071038197769" target="_blank" title="https://juejin.cn/post/7600238071038197769">Clawdbot 完整对接飞书教程 手把手搭建你的专属 AI 助手</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7598737609494855699" target="_blank" title="https://juejin.cn/post/7598737609494855699">血压飙升，Flutter &amp; Dart 2025 年度巨坑回顾</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7599970244786864191" target="_blank" title="https://juejin.cn/post/7599970244786864191">从零开始搭建部署 Moltbot/Clawdbot 完整攻略</a></p>
</li>
</ul>
<blockquote>
<p><strong>「上榜规则」</strong>：文章发布时间在本期「掘金一周」发布时间的前一周内；且符合各个栏目的内容定位和要求。 如发现文章有抄袭、洗稿等违反社区规则的行为，将取消当期及后续上榜资格。</p>
</blockquote>
<h2 data-id="heading-0">一周“金”选</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73d5bf990a124e3a87cffb06443ad9ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5LiA5ZGo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770885743&amp;x-signature=pvexyGP3pjpEg0Fli4%2Fh4yfoMXQ%3D" alt="掘金一周 文章头图 1303x734.jpg" loading="lazy"/></p>
<p><em>内容评审们会在过去的一周内对社区深度技术好文进行挖掘和筛选，优质的技术文章有机会出现在下方榜单中，排名不分先后。</em></p>
<h3 data-id="heading-1">前端</h3>
<p><a href="https://juejin.cn/post/7599641289887055918" target="_blank" title="https://juejin.cn/post/7599641289887055918">分享前端项目常用的三个Skills--Vue、React 与 UI 核心 Skills</a><a href="https://juejin.cn/user/598569647873805/posts" target="_blank" title="https://juejin.cn/user/598569647873805/posts">@去伪存真</a></p>
<blockquote>
<p>文章介绍前端项目常用技能包。Vue-Skills 解决 Vue 3 开发痛点；React-Skills 涵盖组件组合、性能优化等规则；UI-Skills 提供多元风格、适配多技术栈。Skills 让开发者转变角色，提升开发效率与代码质量。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7598921649888968731" target="_blank" title="https://juejin.cn/post/7598921649888968731">供应链系统中的 Web 打印方案的探索实践</a><a href="https://juejin.cn/user/3233040624266695/posts" target="_blank" title="https://juejin.cn/user/3233040624266695/posts">@古茗前端团队</a></p>
<blockquote>
<p>本文围绕供应链系统中的Web打印方案展开。调研了基于DOM、可视化模板、本地打印控件三类主流方案并对比。重点分析window.print，给出指定区域与批量打印思路，介绍核心CSS打印配置，指出其仍是高性价比方案。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7599586891084726306" target="_blank" title="https://juejin.cn/post/7599586891084726306">我接手了一个 10 年前的 jQuery 老项目，用 Web Components 给它续了命</a><a href="https://juejin.cn/user/3878732754331096/posts" target="_blank" title="https://juejin.cn/user/3878732754331096/posts">@ErpanOmer</a></p>
<blockquote>
<p>作者接手 2015 年上线的 jQuery 老 CRM 项目，需添加 AI 智能客服功能。因业务时间紧，选择 Web Components，利用其 Shadow DOM 解决 CSS 污染。介绍组件定义与使用，该方案侵入性零、框架无关、可渐进迁移，还给出避坑指南。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7600581247020253193" target="_blank" title="https://juejin.cn/post/7600581247020253193">手把手教你使用LangChain（前端开发程序员版）</a><a href="https://juejin.cn/user/2788017220891128/posts" target="_blank" title="https://juejin.cn/user/2788017220891128/posts">@前端小豆</a></p>
<blockquote>
<p>本文是面向前端开发者的LangChain教程。先介绍前置准备，接着从环境搭建、核心功能实操、前端项目集成展开教学，还给出避坑指南，最后指明进阶方向，助前端开发者用JS/TS集成AI能力，打造智能应用。</p>
</blockquote>
<h3 data-id="heading-2">后端</h3>
<p><a href="https://juejin.cn/post/7600238071038197769" target="_blank" title="https://juejin.cn/post/7600238071038197769">Clawdbot 完整对接飞书教程 手把手搭建你的专属 AI 助手</a><a href="https://juejin.cn/user/993614242266077/posts" target="_blank" title="https://juejin.cn/user/993614242266077/posts">@BingoGo</a></p>
<blockquote>
<p>本文是 Moltbot（原 Clawdbot）对接飞书的教程。先介绍在 Linux 系统安装，包括 Git、Node.js 及 Moltbot 安装步骤，还提及查看服务和访问 Web UI 面板方法。接着说明对接飞书流程，含插件安装、参数配置、权限设置等，完成后可与机器人对话。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7600994087588053011" target="_blank" title="https://juejin.cn/post/7600994087588053011">Agent Skills工作流：从入门到实战</a><a href="https://juejin.cn/user/694547077666606/posts" target="_blank" title="https://juejin.cn/user/694547077666606/posts">@雨中飘荡的记忆</a></p>
<blockquote>
<p>本文围绕Agent Skills工作流展开，先介绍核心概念与架构设计，接着阐述核心组件、基础技能实现，还涉及交互机制、多Agent协作。以智能数据分析系统为例实战，给出部署、测试策略与设计原则，展现其结合AI与传统开发的优势。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7599237603976134699" target="_blank" title="https://juejin.cn/post/7599237603976134699">性能告警惊四座 神器出手伏恶龙</a><a href="https://juejin.cn/user/2586510420095944/posts" target="_blank" title="https://juejin.cn/user/2586510420095944/posts">@Hello_world_</a></p>
<blockquote>
<p>2025年12月29日服务出现CPU阈值告警，作者从代码、流量、JVM维度排查，未找到根本原因。后用神器Arthas分析，发现是业务代码中序列化/反序列化代码使用不当所致。修改代码后，CPU利用率大幅降低。</p>
</blockquote>
<h3 data-id="heading-3">Android</h3>
<p><a href="https://juejin.cn/post/7598737609494855699" target="_blank" title="https://juejin.cn/post/7598737609494855699">血压飙升，Flutter &amp; Dart 2025 年度巨坑回顾</a><a href="https://juejin.cn/user/817692379985752/posts" target="_blank" title="https://juejin.cn/user/817692379985752/posts">@恋猫de小郭</a></p>
<blockquote>
<p>本文先提及 Google 发布的 Flutter &amp; Dart 2025 高光回顾，随后着重盘点该年 Flutter 经典巨坑，如宏功能暂停、线程合并问题等，其中超半数为 iOS 相关问题，虽官方积极解决，但平台升级坑多。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7600787795478134830" target="_blank" title="https://juejin.cn/post/7600787795478134830">Compose中的IntrinsicSize实战指南</a><a href="https://juejin.cn/user/2788017216685784/posts" target="_blank" title="https://juejin.cn/user/2788017216685784/posts">@稀有猿诉</a></p>
<blockquote>
<p>本文围绕Compose中的IntrinsicSize展开，以构建重叠卡片式UI为例，指出weight修饰符导致布局问题的原因，介绍了IntrinsicSize打破循环依赖的原理，列举常见用例，还提及性能注意事项，强调其对复杂UI构建的重要性。</p>
</blockquote>
<h3 data-id="heading-4">人工智能</h3>
<p><a href="https://juejin.cn/post/7599970244786864191" target="_blank" title="https://juejin.cn/post/7599970244786864191">从零开始搭建部署 Moltbot/Clawdbot 完整攻略</a><a href="https://juejin.cn/user/4388906150921614/posts" target="_blank" title="https://juejin.cn/user/4388906150921614/posts">@出门不下雨</a></p>
<blockquote>
<p>本文是 Moltbot/Clawdbot 搭建部署攻略。介绍其为支持多模型、多平台的 AI 助手框架，阐述系统要求，给出 Windows、Mac 安装步骤，涵盖首次配置、常用指令、日常维护、故障排除及进阶配置内容，还解答常见问题。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7599604510366236710" target="_blank" title="https://juejin.cn/post/7599604510366236710">Agent Skills 傻瓜式教程，26 年最火 AI 技术就这？</a><a href="https://juejin.cn/user/2444938365386621/posts" target="_blank" title="https://juejin.cn/user/2444938365386621/posts">@程序员鱼皮</a></p>
<blockquote>
<p>本文围绕 Agent Skills 展开，它是 Anthropic 推出的开放标准，可让 AI 学习专业技能。介绍了入门实战、内部原理、跨工具使用、创建方法，还对比了与 MCP、斜杠命令区别，因其开放复用且降低门槛而大火。</p>
</blockquote>
<p><a href="https://juejin.cn/post/7598918127578972194" target="_blank" title="https://juejin.cn/post/7598918127578972194">Agent Skills完全指南：核心概念丨设计模式丨实战代码</a><a href="https://juejin.cn/user/3140624091453053/posts" target="_blank" title="https://juejin.cn/user/3140624091453053/posts">@大模型真好玩</a></p>
<blockquote>
<p>本文围绕 Agent Skills 展开，它是渐进式披露的提示词管理机制，能降低 Token 消耗。以 Claude Code 为例，介绍安装、使用及进阶方法。还对比了与 MCP 的区别，助开发者构建强大智能体。</p>
</blockquote>
<h2 data-id="heading-5">📖 投稿专区</h2>
<blockquote>
<p>大家可以在评论区推荐认为不错的文章，并附上链接和推荐理由，有机会呈现在下一期。文章创建日期必须在下期掘金一周发布前一周以内；可以推荐自己的文章、也可以推荐他人的文章。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[10分钟速览Android开发者需要关注的 Kotlin 更新]]></title>    <link>https://juejin.cn/post/7602824293164941327</link>    <guid>https://juejin.cn/post/7602824293164941327</guid>    <pubDate>2026-02-05T00:42:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602824293164941327" data-draft-id="7602634187284660234" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="10分钟速览Android开发者需要关注的 Kotlin 更新"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2026-02-05T00:42:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            10分钟速览Android开发者需要关注的 Kotlin 更新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:42:57.000Z" title="Thu Feb 05 2026 00:42:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3799bf045f9147809c80a685fc00e648~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856976&amp;x-signature=yJ33XXrcEn7wd%2FqsRv23b8lh4Js%3D" alt="2_0.png" loading="lazy"/></p>
<p>Kotlin 2.3.0 带来了稳定的时间 API、显式幕后字段、改进的 Swift 互操作性以及更完善的工具链。</p>
<p>下面我们来一起浏览那些对于 Android 开发者需要关注的新特性。</p>
<h2 data-id="heading-0">稳定的时间 API：Clock 与 Instant</h2>
<p><code>kotlin.time.Clock</code> 和 <code>kotlin.time.Instant</code> API 现已正式稳定，无需再添加 <code>@OptIn</code> 注解即可使用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.time.*

<span class="hljs-comment">// 获取当前时间</span>
<span class="hljs-keyword">val</span> now: Instant = Clock.System.now()

<span class="hljs-comment">// 计算时间差</span>
<span class="hljs-keyword">val</span> eventTime = Instant.parse(<span class="hljs-string">"2025-12-25T10:00:00Z"</span>)
<span class="hljs-keyword">val</span> timeUntilEvent: Duration = eventTime - now
println(<span class="hljs-string">"距离活动开始还有：<span class="hljs-subst">${timeUntilEvent.inWholeHours}</span> 小时"</span>)

<span class="hljs-comment">// 通过时间分量创建 Instant</span>
<span class="hljs-keyword">val</span> deadline = Instant.fromEpochSeconds(<span class="hljs-number">1735084800</span>)

<span class="hljs-comment">// 比较时间</span>
<span class="hljs-keyword">if</span> (now &gt; deadline) {
    println(<span class="hljs-string">"截止时间已过！"</span>)
}
</code></pre>
<p><strong>Android 场景建议</strong>：用它替代 <code>System.currentTimeMillis()</code>，实现更简洁、类型安全的时间处理。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SessionManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> sessionStart: Instant? = <span class="hljs-literal">null</span>

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startSession</span><span class="hljs-params">()</span></span> {
        sessionStart = Clock.System.now()
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getSessionDuration</span><span class="hljs-params">()</span></span>: Duration {
        <span class="hljs-keyword">val</span> start = sessionStart ?: <span class="hljs-keyword">return</span> Duration.ZERO
        <span class="hljs-keyword">return</span> Clock.System.now() - start
    }
}
</code></pre>
<h2 data-id="heading-1">显式幕后字段（实验性）</h2>
<p><em>我终于可以摆脱命名两个变量的困局了！</em></p>
<p>你可以定义与暴露属性类型不同的幕后字段，无需再单独声明私有属性来实现这一点：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@OptIn(ExperimentalBackingFields::class)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserPreferences</span> {
    <span class="hljs-comment">// 幕后字段是可变列表，但对外暴露为不可变列表</span>
    <span class="hljs-keyword">val</span> recentSearches: List&lt;String&gt;
        field = mutableListOf()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addSearch</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span> {
        recentSearches.add(query) <span class="hljs-comment">// 直接修改幕后字段</span>
        <span class="hljs-keyword">if</span> (recentSearches.size &gt; <span class="hljs-number">10</span>) {
            recentSearches.removeAt(<span class="hljs-number">0</span>)
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">val</span> prefs = UserPreferences()
prefs.addSearch(<span class="hljs-string">"kotlin 2.3"</span>)
prefs.addSearch(<span class="hljs-string">"coroutines"</span>)
<span class="hljs-comment">// 外头是无法使用幕后字段的</span>
<span class="hljs-comment">// prefs.recentSearches.add("flow")</span>
println(prefs.recentSearches) <span class="hljs-comment">// [kotlin 2.3, coroutines]</span>
</code></pre>
<p>Kotlin 2.3 之前你需要这样做（我确实对这个感到厌烦）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserPreferences</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _recentSearches = mutableListOf&lt;String&gt;()
    <span class="hljs-keyword">val</span> recentSearches: List&lt;String&gt; <span class="hljs-keyword">get</span>() = _recentSearches.toList()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addSearch</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span> {
        _recentSearches.add(query)
    }
}
</code></pre>
<p>如果你对实现方法感到好奇：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16b983eecc6648d9a0d01360945316c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856976&amp;x-signature=wsu2JBYeIkg2kNGEZ6ziwbMKTkA%3D" alt="2_2.jpg" loading="lazy"/></p>
<p>其实就是增加了一个 <code>private</code> 的字段用于类的内部使用。</p>
<p>当然，作为实验性功能，你需要添加额外的编译条件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">kotlin {
    compilerOptions {
        freeCompilerArgs.add(<span class="hljs-string">"-Xexplicit-backing-fields"</span>)
    }
}
</code></pre>
<h2 data-id="heading-2">未使用返回值检查器（实验性）</h2>
<p>当你忘记使用某个接口的返回值时，该功能可以帮你捕获这类不易察觉的潜在 Bug。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// 有潜在问题的用法</span>
<span class="hljs-meta">@OptIn(ExperimentalUnusedReturnValueChecker::class)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">badprocess</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> list = mutableListOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)

    <span class="hljs-comment">// 警告：'remove' 的返回值未被使用</span>
    list.remove(<span class="hljs-number">2</span>) <span class="hljs-comment">// 你是否需要检查删除是否成功？</span>

    <span class="hljs-comment">// 警告：'plus' 的返回值未被使用</span>
    list.plus(<span class="hljs-number">4</span>) <span class="hljs-comment">// Bug！此操作不会修改原列表，而是返回一个新列表</span>

   <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 正确用法</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">goodprocess</span><span class="hljs-params">()</span></span> {
    
    <span class="hljs-keyword">val</span> removed = list.remove(<span class="hljs-number">2</span>)
    <span class="hljs-keyword">if</span> (!removed) println(<span class="hljs-string">"元素未找到"</span>)

    <span class="hljs-keyword">val</span> newList = list + <span class="hljs-number">4</span> <span class="hljs-comment">// 使用返回的新列表</span>
}
</code></pre>
<p>当一个表达式返回的不是 <code>Unit</code> 或 <code>Nothing</code> 类型的值，且没有被传递给其他函数、用于条件判断或以其他方式使用时，它就会发出警告。</p>
<p>该功能会帮助开发者检查可能存在的 Bug：</p>

























<table><thead><tr><th>表达式</th><th>Bug</th><th>修复方案</th></tr></thead><tbody><tr><td><code>list.plus(item)</code></td><td>返回新列表，不会修改原列表</td><td><code>list = list + item</code> 或 <code>list.add(item)</code></td></tr><tr><td><code>string.replace("a", "b")</code></td><td>返回新字符串，不会修改原字符串</td><td><code>val result = string.replace(...)</code></td></tr><tr><td><code>map.minus(key)</code></td><td>返回新映射，不会修改原映射</td><td><code>map = map - key</code></td></tr></tbody></table>
<p>额外的编译条件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">kotlin {
    compilerOptions {
        freeCompilerArgs.add(<span class="hljs-string">"-Xreturn-value-checker=check"</span>)
    }
}
</code></pre>
<h2 data-id="heading-3">增强的 UUID 支持（实验性）</h2>
<p>原生支持生成 v4（随机）和 v7（基于时间）类型的 <code>UUID</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlin.uuid.*

<span class="hljs-meta">@OptIn(ExperimentalUuidApi::class)</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">generateIds</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 随机 UUID（v4）</span>
    <span class="hljs-keyword">val</span> randomId = Uuid.random()
    println(randomId) <span class="hljs-comment">// 示例：550e8400-e29b-41d4-a716-446655440000</span>

    <span class="hljs-comment">// 基于时间的 UUID（v7）- 可按创建时间排序</span>
    <span class="hljs-keyword">val</span> timeBasedId = Uuid.randomV7()

    <span class="hljs-comment">// 基于特定时间戳生成 v7 UUID</span>
    <span class="hljs-keyword">val</span> instant = Clock.System.now()
    <span class="hljs-keyword">val</span> historicalId = Uuid.randomV7(instant)

    <span class="hljs-comment">// 安全解析（无效时返回 null 而非抛出异常）</span>
    <span class="hljs-keyword">val</span> parsed: Uuid? = Uuid.parseOrNull(<span class="hljs-string">"invalid-uuid"</span>)

    <span class="hljs-comment">// 按时间顺序比较 v7 UUID</span>
    <span class="hljs-keyword">val</span> id1 = Uuid.randomV7()
    delay(<span class="hljs-number">100</span>)
    <span class="hljs-keyword">val</span> id2 = Uuid.randomV7()
    println(id1 &lt; id2) <span class="hljs-comment">// true - v7 UUID 支持按时间排序</span>
}
</code></pre>
<p>下面提供一个速查表帮助你如何选择合适的 UUID 版本：</p>

















<table><thead><tr><th>UUID 版本</th><th>使用场景</th></tr></thead><tbody><tr><td>v4 (<code>random()</code>)</td><td>通用唯一 ID，无需排序的场景</td></tr><tr><td>v7 (<code>randomV7()</code>)</td><td>数据库主键（可排序）、事件 ID 等需要按创建时间排序的场景</td></tr></tbody></table>
<p>额外的编译条件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">kotlin {
    compilerOptions {
        freeCompilerArgs.add(<span class="hljs-string">"-opt-in=kotlin.uuid.ExperimentalUuidApi"</span>)
    }
}
</code></pre>
<h2 data-id="heading-4">表达式体函数中支持 return</h2>
<p>在具有显式返回类型的单表达式函数中，可以使用 <code>return</code> 语句。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// userId 如果为空，函数返回 "default"</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getDisplayNameOrDefault</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>?)</span></span>: String = getDisplayName(userId ?: <span class="hljs-keyword">return</span> <span class="hljs-string">"default"</span>)

<span class="hljs-comment">// 复杂校验场景</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">validateEmail</span><span class="hljs-params">(email: <span class="hljs-type">String</span>)</span></span>: ValidationResult =
    <span class="hljs-keyword">when</span> {
        email.isBlank() -&gt; <span class="hljs-keyword">return</span> ValidationResult.Error(<span class="hljs-string">"Email required"</span>)
        !email.contains(<span class="hljs-string">"@"</span>) -&gt; <span class="hljs-keyword">return</span> ValidationResult.Error(<span class="hljs-string">"Invalid format"</span>)
        <span class="hljs-keyword">else</span> -&gt; ValidationResult.Success
    }
</code></pre>
<h2 data-id="heading-5">嵌套类型别名</h2>
<p>现在类型别名可以引用其他类型别名。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 基础类型别名</span>
<span class="hljs-keyword">typealias</span> UserId = String
<span class="hljs-keyword">typealias</span> ProductId = String

<span class="hljs-comment">// 嵌套类型别名</span>
<span class="hljs-keyword">typealias</span> UserProducts = Map&lt;UserId, List&lt;ProductId&gt;&gt;
<span class="hljs-keyword">typealias</span> UserProductsCallback = (UserProducts) -&gt; <span class="hljs-built_in">Unit</span>

<span class="hljs-comment">// 使用案例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductRepository</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserProducts</span><span class="hljs-params">(callback: <span class="hljs-type">UserProductsCallback</span>)</span></span> {
        <span class="hljs-keyword">val</span> products: UserProducts = mapOf(
            <span class="hljs-string">"user_1"</span> to listOf(<span class="hljs-string">"prod_a"</span>, <span class="hljs-string">"prod_b"</span>),
            <span class="hljs-string">"user_2"</span> to listOf(<span class="hljs-string">"prod_c"</span>)
        )
        callback(products)
    }
}
</code></pre>
<h2 data-id="heading-6">改进的 Swift 互操作性</h2>
<p>Kotlin 枚举现在会导出为原生 Swift 枚举，并且可变参数（<code>vararg</code>）函数可以正常工作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Kotlin 代码</span>
<span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentStatus</span> {
    PENDING, COMPLETED, FAILED, REFUNDED
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processPayments</span><span class="hljs-params">(<span class="hljs-keyword">vararg</span> payments: <span class="hljs-type">Payment</span>)</span></span>: List&lt;Receipt&gt; {
    <span class="hljs-keyword">return</span> payments.map { process(it) }
}
</code></pre>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Swift 代码 - 现在可以自然调用</span>
<span class="hljs-keyword">let</span> status: <span class="hljs-type">PaymentStatus</span> <span class="hljs-operator">=</span> .completed
<span class="hljs-keyword">switch</span> status {
    <span class="hljs-keyword">case</span> .pending: <span class="hljs-built_in">print</span>(<span class="hljs-string">"Waiting..."</span>)
    <span class="hljs-keyword">case</span> .completed: <span class="hljs-built_in">print</span>(<span class="hljs-string">"Done!"</span>)
    <span class="hljs-keyword">case</span> .failed: <span class="hljs-built_in">print</span>(<span class="hljs-string">"Error"</span>)
    <span class="hljs-keyword">case</span> .refunded: <span class="hljs-built_in">print</span>(<span class="hljs-string">"Money back"</span>)
}

<span class="hljs-comment">// 可变参数也能直接使用</span>
<span class="hljs-keyword">let</span> receipts <span class="hljs-operator">=</span> processPayments(payment1, payment2, payment3)
</code></pre>
<h2 data-id="heading-7">Compose 编译器：Release 版本支持清晰堆栈追踪</h2>
<p>借助反混淆的堆栈信息，你可以在生产环境中调试 Compose 的崩溃问题。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build.gradle.kts</span>
composeCompiler {
    <span class="hljs-comment">// 启用组键格式的堆栈追踪（2.3 版本默认开启）</span>
    includeSourceInformation = <span class="hljs-literal">true</span>
}
</code></pre>
<p><strong>优化前</strong>：Release 包中的崩溃日志是混淆后的，难以定位问题。</p>
<p><strong>优化后</strong>：生成清晰的 Compose 组键，可通过 R8 映射文件关联到你的源代码，大幅提升调试效率。</p>
<h2 data-id="heading-8">Gradle 与 AGP 更新</h2>
<p><em>我现在看到 AGP 的更新，只想喊田文镜！</em></p>
<p>版本要求：</p>

























<table><thead><tr><th>工具</th><th>最低版本</th><th>最高版本</th></tr></thead><tbody><tr><td>Gradle</td><td>7.6.3</td><td>9.0.0</td></tr><tr><td>AGP（Android Gradle 插件）</td><td>8.2.2</td><td>8.13.0</td></tr><tr><td>Java</td><td>8</td><td>25</td></tr></tbody></table>
<p>AGP 9.0+ 的一个重要变更：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 旧写法 - 在 AGP 9.0+ 中不再生效</span>
plugins {
    id(<span class="hljs-string">"com.android.application"</span>)
    id(<span class="hljs-string">"kotlin-android"</span>) <span class="hljs-comment">// 需要移除这一行！</span>
}

<span class="hljs-comment">// 新写法 - kotlin-android 已内置到 AGP 9.0+</span>
plugins {
    id(<span class="hljs-string">"com.android.application"</span>)
    <span class="hljs-comment">// Kotlin 支持已自动启用</span>
}
</code></pre>
<h2 data-id="heading-9">数据流的穷举 when 表达式</h2>
<p>更智能的穷举检查，能够理解你的代码执行流程。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : Result&lt;T&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Loading : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleResult</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
    <span class="hljs-comment">// 编译器能识别所有分支已被覆盖</span>
    <span class="hljs-keyword">when</span> (result) {
        <span class="hljs-keyword">is</span> Result.Success -&gt; println(result.<span class="hljs-keyword">data</span>)
        <span class="hljs-keyword">is</span> Result.Error -&gt; println(result.message)
        Result.Loading -&gt; println(<span class="hljs-string">"Loading..."</span>)
        <span class="hljs-comment">// 无需写 'else' 分支 — 编译器会验证穷举性</span>
    }
}

<span class="hljs-comment">// 具备数据流感知能力</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">process</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt;?)</span></span> {
    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-comment">// 编译器知道此处 result 不为 null</span>
    <span class="hljs-keyword">when</span> (result) {
        <span class="hljs-keyword">is</span> Result.Success -&gt; {}
        <span class="hljs-keyword">is</span> Result.Error -&gt; {}
        Result.Loading -&gt; {}
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getPermissionLevel</span><span class="hljs-params">(role: <span class="hljs-type">UserRole</span>)</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-comment">// 覆盖了 when 表达式之外的 Admin 场景</span>
    <span class="hljs-keyword">if</span> (role == UserRole.ADMIN) <span class="hljs-keyword">return</span> <span class="hljs-number">99</span>

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (role) {
        UserRole.MEMBER -&gt; <span class="hljs-number">10</span>
        UserRole.GUEST -&gt; <span class="hljs-number">1</span>
        <span class="hljs-comment">// 你不再需要编写这个 else 分支了 </span>
        <span class="hljs-comment">// else -&gt; throw IllegalStateException()</span>
    }
}
</code></pre>
<h2 data-id="heading-10">总结</h2>
<p>Kotlin 2.3.0 主要致力于稳定实验性特性，并改进多平台互操作性。</p>
<p>其中，稳定的时间 API 和显式幕后字段是对 Android 开发者而言最亮眼的更新。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent核心能力载体：Skills技能模块从基础到实战全指南]]></title>    <link>https://juejin.cn/post/7603347438012514339</link>    <guid>https://juejin.cn/post/7603347438012514339</guid>    <pubDate>2026-02-06T06:17:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603347438012514339" data-draft-id="7603355275256938536" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent核心能力载体：Skills技能模块从基础到实战全指南"/> <meta itemprop="keywords" content="后端,AI编程"/> <meta itemprop="datePublished" content="2026-02-06T06:17:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent核心能力载体：Skills技能模块从基础到实战全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T06:17:16.000Z" title="Fri Feb 06 2026 06:17:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI Agent核心能力载体：Skills技能模块从基础到实战全指南</h2>
<p>在AI智能体（Agent）从“概念落地”到“规模化应用”的过程中，Skills（技能模块）逐渐成为决定Agent能力边界与体验上限的核心载体。当MCP因上下文冗余、性能损耗等问题逐渐退居小众场景，Skills以“轻量、高效、可复用”的优势，成为Anthropic、OpenAI等大厂主推的Agent技能扩展方案，也成为开发者落地智能体项目的首选。</p>
<p>什么是Skills？它与传统工具调用有何区别？如何设计高质量的Skills？怎样快速实现Agent与Skills的集成落地？本文将彻底拆解Skills的核心逻辑，搭配可直接复用的Java实战代码、设计规范与避坑指南，助力开发者快速掌握Skills开发技巧，让Agent真正具备“解决实际问题”的能力。</p>
<h3 data-id="heading-1">一、核心认知：读懂Skills，先分清3个关键问题</h3>
<p>很多开发者容易将Skills与“工具API”“MCP Server”混淆，实则Skills是更贴近Agent、更轻量化的技能单元，其核心价值在于“让Agent具备可复用、可扩展的具体能力”。我们先从3个核心问题入手，理清Skills的本质。</p>
<h4 data-id="heading-2">1. 什么是Skills？——Agent的“可插拔技能插件”</h4>
<p>Skills（技能模块）是为AI Agent设计的、聚焦单一功能的模块化组件，本质是“将具体业务逻辑封装成Agent可直接调用的接口”，无需依赖外部服务协议适配，可快速集成到各类Agent中，实现能力扩展。</p>
<p>简单来说，Skills就像Agent的“手机APP”：Agent本身是“手机硬件”（具备决策、交互能力），每个Skill是一个“APP”（聚焦一个功能，如“拍照”“导航”），Agent可根据需求“安装”（加载）或“卸载”（移除）Skills，无需修改自身核心逻辑，就能快速获得对应能力。</p>
<p>核心定位：<strong>Agent的能力扩展单元，连接Agent决策与实际业务逻辑的桥梁</strong>。</p>
<h4 data-id="heading-3">2. Skills vs MCP vs 普通API：核心区别在哪？</h4>
<p>开发者最易混淆的就是Skills与MCP、普通API，三者看似都是“实现功能调用”，但定位、设计逻辑和使用场景截然不同，一张表格彻底区分：</p>









































<table><thead><tr><th>核心维度</th><th>Skills（技能模块）</th><th>MCP（工具协议）</th><th>普通API</th></tr></thead><tbody><tr><td>核心定位</td><td>Agent专属的轻量技能组件</td><td>跨Agent的工具共享协议</td><td>通用的服务调用接口</td></tr><tr><td>依赖关系</td><td>与Agent深度集成，无外部依赖</td><td>依赖外部MCP Server，需协议适配</td><td>依赖API服务，需单独适配调用</td></tr><tr><td>调用成本</td><td>极低，直接调用，不占用过多上下文</td><td>较高，需携带协议信息，占用上下文</td><td>中等，需处理请求/响应格式，适配成本高</td></tr><tr><td>复用性</td><td>高，可在同类Agent中直接复用，支持组合</td><td>高，多Agent可共享同一MCP Server</td><td>低，需为不同Agent单独编写适配代码</td></tr><tr><td>适用场景</td><td>单一Agent的具体功能实现（如生成文档、数据分析）</td><td>多Agent共享同一工具（如多AI共用企业内部工具）</td><td>非Agent场景的服务调用，或简单工具接入</td></tr></tbody></table>
<p>关键结论：Skills不是“替代”MCP和API，而是“优化”Agent的能力调用方式——对于Agent开发，优先用Skills封装核心功能，需多Agent共享时搭配MCP，简单外部服务调用可适配普通API。</p>
<h4 data-id="heading-4">3. Skills的核心特征：为什么能成为Agent的首选？</h4>
<p>Skills之所以能快速取代MCP成为Agent技能扩展的主流方案，核心在于其贴合Agent开发需求的5大特征，也是我们设计Skills的核心准则：</p>
<ul>
<li><strong>轻量无依赖</strong>：无需搭建外部Server，无需遵循复杂协议，封装后可直接嵌入Agent，调用时不占用大量上下文token，避免模型注意力稀释。</li>
<li><strong>单一职责聚焦</strong>：每个Skill仅实现一个具体功能（如“Excel读取”“文本翻译”“日期计算”），不追求“大而全”，确保代码简洁、可维护、无冗余。</li>
<li><strong>高可复用性</strong>：遵循统一规范设计的Skills，可在不同Agent中直接复用（如“文本生成Skill”可同时用于客服Agent、办公Agent），大幅降低重复开发成本。</li>
<li><strong>可组合扩展</strong>：多个Skills可组合成复杂功能（如“数据读取Skill + 数据统计Skill + 报告生成Skill”，实现自动化数据分析报告），灵活适配复杂业务需求。</li>
<li><strong>安全可控</strong>：与Agent深度集成，可精细化管控权限（如“文件操作Skill”仅开放读取权限），避免MCP协议粗放权限带来的安全风险。</li>
</ul>
<h3 data-id="heading-5">二、Skills设计规范：打造高质量可复用技能模块</h3>
<p>高质量的Skills不仅能提升Agent的执行效率，还能降低维护成本；反之，设计混乱、冗余的Skills会导致Agent调用混乱、性能下降。以下是开发者必须遵循的设计规范，附具体示例。</p>
<h4 data-id="heading-6">1. 命名规范：语义清晰，一眼识别功能</h4>
<p>Skills的命名需遵循“功能类型+具体操作”的格式，避免模糊化、缩写化，确保开发者和Agent能快速识别其功能，建议采用“小写字母+冒号分隔”的前缀分类法。</p>
<ul>
<li>推荐命名：excel:read（Excel读取）、text:translate（文本翻译）、ppt:generate（PPT生成）、data:statistic（数据统计）；</li>
<li>禁止命名：Skill1、MySkill、ExcelSkill（模糊不清，无法快速识别具体功能）。</li>
</ul>
<h4 data-id="heading-7">2. 接口规范：统一标准，确保可复用</h4>
<p>所有Skills需实现统一的接口，定义固定的调用方法和参数格式，避免因接口不一致导致的复用困难。以Java语言为例，定义通用Skill接口：</p>
<pre><code class="hljs language-arduino" lang="arduino">
<span class="hljs-comment">// 通用Skill接口：所有Skill必须实现该接口，确保调用规范统一</span>
<span class="hljs-keyword">public</span> interface Skill {
    <span class="hljs-comment">// 1. 获取技能唯一标识（遵循命名规范）</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">getSkillId</span><span class="hljs-params">()</span></span>;
    
    <span class="hljs-comment">// 2. 获取技能描述（用于Agent决策时参考，如“用于读取Excel文件，返回数据列表”）</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">getDescription</span><span class="hljs-params">()</span></span>;
    
    <span class="hljs-comment">// 3. 执行技能核心逻辑</span>
    <span class="hljs-comment">// params：输入参数（统一用Map封装，适配不同Skill的参数差异）</span>
    <span class="hljs-comment">// return：执行结果（统一返回String，复杂结果可序列化为JSON字符串）</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">execute</span><span class="hljs-params">(Map&lt;<span class="hljs-type">String</span>, Object&gt; params)</span></span>;
    
    <span class="hljs-comment">// 4. 获取参数说明（用于校验输入参数，避免调用失败）</span>
    <span class="hljs-function">Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">String</span>&gt; <span class="hljs-title">getParamDesc</span><span class="hljs-params">()</span></span>;
}
    
</code></pre>
<h4 data-id="heading-8">3. 参数规范：简洁必要，有校验有默认</h4>
<p>参数设计遵循“最小必要原则”，避免冗余参数；同时需添加参数校验和默认值，确保Agent调用时不会因参数缺失、格式错误导致失败。</p>
<ul>
<li>参数封装：统一用Map&lt;String, Object&gt;封装输入参数，key为参数名（语义清晰），value为参数值；</li>
<li>参数校验：在execute方法开头校验参数的存在性、格式正确性，异常时返回明确的错误提示；</li>
<li>默认值设置：非必填参数需设置合理默认值，减少Agent调用时的参数传递成本。</li>
</ul>
<h4 data-id="heading-9">4. 异常规范：捕获全面，提示清晰</h4>
<p>Skills执行过程中可能出现各类异常（如文件不存在、参数格式错误、网络异常），需全面捕获异常，返回清晰的错误提示，便于Agent判断是否重试、如何调整策略，禁止直接抛出未捕获异常导致Agent崩溃。</p>
<h4 data-id="heading-10">5. 示例：符合规范的Skills实现（文本翻译Skill）</h4>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">HashMap</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Map</span>;

<span class="hljs-comment">// 文本翻译Skill：符合所有设计规范，可直接复用</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextTranslateSkill</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Skill</span> {

    <span class="hljs-comment">// 技能唯一标识（遵循命名规范）</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getSkillId</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"text:translate"</span>;
    }

    <span class="hljs-comment">// 技能描述（清晰说明功能、适用场景）</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDescription</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"用于文本翻译，支持中文与英文互译，输入文本和目标语言，返回翻译结果"</span>;
    }

    <span class="hljs-comment">// 参数说明（明确参数名、类型、是否必填、说明）</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">getParamDesc</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Map</span>&amp;lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&amp;gt; paramDesc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        paramDesc.<span class="hljs-title function_">put</span>(<span class="hljs-string">"text"</span>, <span class="hljs-string">"必填，String类型，需要翻译的文本"</span>);
        paramDesc.<span class="hljs-title function_">put</span>(<span class="hljs-string">"targetLang"</span>, <span class="hljs-string">"非必填，String类型，目标语言（zh=中文，en=英文），默认en"</span>);
        <span class="hljs-keyword">return</span> paramDesc;
    }

    <span class="hljs-comment">// 核心执行逻辑（含参数校验、异常捕获）</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params"><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">Object</span>&gt; params</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 参数校验</span>
            <span class="hljs-keyword">if</span> (!params.<span class="hljs-title function_">containsKey</span>(<span class="hljs-string">"text"</span>) || params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"text"</span>) == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"参数错误：缺少必填参数「text」（需要翻译的文本）"</span>;
            }
            <span class="hljs-title class_">String</span> text = params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"text"</span>).<span class="hljs-title function_">toString</span>();
            <span class="hljs-title class_">String</span> targetLang = params.<span class="hljs-title function_">getOrDefault</span>(<span class="hljs-string">"targetLang"</span>, <span class="hljs-string">"en"</span>).<span class="hljs-title function_">toString</span>();

            <span class="hljs-comment">// 2. 校验目标语言格式</span>
            <span class="hljs-keyword">if</span> (!<span class="hljs-string">"zh"</span>.<span class="hljs-title function_">equals</span>(targetLang) &amp;&amp; !<span class="hljs-string">"en"</span>.<span class="hljs-title function_">equals</span>(targetLang)) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"参数错误：目标语言「targetLang」仅支持zh（中文）和en（英文）"</span>;
            }

            <span class="hljs-comment">// 3. 核心翻译逻辑（模拟，实际可调用百度翻译、谷歌翻译API）</span>
            <span class="hljs-title class_">String</span> result = <span class="hljs-title function_">translate</span>(text, targetLang);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"翻译成功："</span> + result;

        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            <span class="hljs-comment">// 捕获异常，返回清晰提示</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">"技能执行失败："</span> + e.<span class="hljs-title function_">getMessage</span>();
        }
    }

    <span class="hljs-comment">// 模拟文本翻译逻辑</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">translate</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> text, <span class="hljs-built_in">String</span> targetLang</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"en"</span>.<span class="hljs-title function_">equals</span>(targetLang)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Translated: "</span> + text; <span class="hljs-comment">// 模拟英译中（此处简化，实际需调用真实翻译逻辑）</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"翻译："</span> + text; <span class="hljs-comment">// 模拟中译英</span>
        }
    }
}
    
</code></pre>
<h3 data-id="heading-11">三、实战落地：Agent + Skills 完整开发示例（可直接复用）</h3>
<p>结合前文的设计规范，我们以“多功能办公Agent”为例，实现3个常用Skills（文本翻译、Excel读取、PPT生成），演示Agent如何加载、决策、调用Skills，完成用户需求，全程基于Java语言，聚焦核心逻辑，可直接复制到项目中使用。</p>
<h4 data-id="heading-12">实战需求</h4>
<p>开发一个办公Agent，具备以下3个功能：1. 文本翻译（中译英/英译中）；2. 读取Excel文件数据；3. 生成办公汇报PPT，Agent可根据用户需求，自主识别需要调用的Skill，执行并返回结果。</p>
<h4 data-id="heading-13">1. 实现3个核心Skills（遵循规范）</h4>
<p>除了前文的文本翻译Skill，再实现Excel读取Skill和PPT生成Skill，均遵循统一接口规范。</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-comment">// Excel读取Skill</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExcelReadSkill</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Skill</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getSkillId</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"excel:read"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDescription</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"用于读取Excel文件数据，输入文件路径，返回文件中的数据条数和前3条数据预览"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">getParamDesc</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Map</span>&amp;lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&amp;gt; paramDesc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        paramDesc.<span class="hljs-title function_">put</span>(<span class="hljs-string">"filePath"</span>, <span class="hljs-string">"必填，String类型，Excel文件的绝对路径"</span>);
        <span class="hljs-keyword">return</span> paramDesc;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params"><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">Object</span>&gt; params</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 参数校验</span>
            <span class="hljs-keyword">if</span> (!params.<span class="hljs-title function_">containsKey</span>(<span class="hljs-string">"filePath"</span>) || params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"filePath"</span>) == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"参数错误：缺少必填参数「filePath」（Excel文件路径）"</span>;
            }
            <span class="hljs-title class_">String</span> filePath = params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"filePath"</span>).<span class="hljs-title function_">toString</span>();

            <span class="hljs-comment">// 模拟Excel读取逻辑（实际开发中可调用POI工具类）</span>
            <span class="hljs-comment">// 此处模拟：读取文件，返回数据条数和前3条预览</span>
            int dataCount = <span class="hljs-number">50</span>; <span class="hljs-comment">// 模拟数据条数</span>
            <span class="hljs-title class_">String</span> preview = <span class="hljs-string">"第1条：张三,25,工程师；第2条：李四,28,产品经理；第3条：王五,30,设计师"</span>;

            <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(<span class="hljs-string">"Excel读取成功！文件路径：%s，共%d条数据，前3条预览：%s"</span>,
                    filePath, dataCount, preview);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"技能执行失败："</span> + e.<span class="hljs-title function_">getMessage</span>();
        }
    }
}
    
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-comment">// PPT生成Skill</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PptGenerateSkill</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Skill</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getSkillId</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ppt:generate"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDescription</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"用于生成办公汇报PPT，输入标题和每页内容，返回PPT生成结果和保存路径"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">getParamDesc</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">Map</span>&amp;lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&amp;gt; paramDesc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        paramDesc.<span class="hljs-title function_">put</span>(<span class="hljs-string">"title"</span>, <span class="hljs-string">"必填，String类型，PPT标题"</span>);
        paramDesc.<span class="hljs-title function_">put</span>(<span class="hljs-string">"contents"</span>, <span class="hljs-string">"必填，List&lt;String&gt;类型，PPT每页的内容列表"</span>);
        paramDesc.<span class="hljs-title function_">put</span>(<span class="hljs-string">"savePath"</span>, <span class="hljs-string">"非必填，String类型，PPT保存路径，默认：/data/ppt/"</span>);
    
</code></pre>
<h4 data-id="heading-14">2. 实现办公Agent（加载Skills + 自主决策 + 调用执行）</h4>
<p>Agent的核心逻辑是“解析用户需求 → 匹配对应Skill → 调用Skill执行 → 返回结果”，此处模拟需求解析（实际开发中可结合大模型API实现精准解析），添加Skills加载、决策、异常处理逻辑。</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.*;

<span class="hljs-comment">// 多功能办公Agent</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OfficeAgent</span> {
    <span class="hljs-comment">// Agent名称</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> agentName;
    <span class="hljs-comment">// 加载的Skills集合（key：skillId，value：Skill实例）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">Map</span>&amp;lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Skill</span>&amp;gt; skillMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 初始化Agent，加载指定Skills</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">OfficeAgent</span>(<span class="hljs-title class_">String</span> agentName, <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Skill</span>&gt; skillList) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">agentName</span> = agentName;
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Skill</span> skill : skillList) {
            skillMap.<span class="hljs-title function_">put</span>(skill.<span class="hljs-title function_">getSkillId</span>(), skill);
            <span class="hljs-comment">// 打印加载的Skills信息，便于调试</span>
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-string">"Agent加载Skill：%s（%s）%n"</span>, skill.<span class="hljs-title function_">getSkillId</span>(), skill.<span class="hljs-title function_">getDescription</span>());
        }
    }

    <span class="hljs-comment">// 核心方法：解析用户需求，自主匹配并调用Skill</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">processRequest</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userRequest</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-string">"%n用户需求：%s%n"</span>, userRequest);

        <span class="hljs-comment">// 1. 模拟需求解析（实际开发中可调用Claude、GPT等大模型API，精准匹配Skill）</span>
        <span class="hljs-title class_">SkillMatchResult</span> matchResult = <span class="hljs-title function_">matchSkill</span>(userRequest);
        <span class="hljs-keyword">if</span> (!matchResult.<span class="hljs-title function_">isMatch</span>()) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"无法识别您的需求，当前Agent支持的功能："</span> + <span class="hljs-title function_">getSupportSkillsDesc</span>();
        }

        <span class="hljs-comment">// 2. 获取匹配的Skill和参数</span>
        <span class="hljs-title class_">Skill</span> targetSkill = matchResult.<span class="hljs-title function_">getTargetSkill</span>();
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; params = matchResult.<span class="hljs-title function_">getParams</span>();

        <span class="hljs-comment">// 3. 调用Skill执行，并返回结果</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-string">"匹配到Skill：%s%n"</span>, targetSkill.<span class="hljs-title function_">getSkillId</span>());
        <span class="hljs-title class_">String</span> result = targetSkill.<span class="hljs-title function_">execute</span>(params);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"执行结果："</span> + result;
    }

    <span class="hljs-comment">// 辅助方法：需求与Skill匹配逻辑</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">SkillMatchResult</span> <span class="hljs-title function_">matchSkill</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> userRequest</span>) {
        <span class="hljs-title class_">SkillMatchResult</span> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SkillMatchResult</span>();
        <span class="hljs-comment">// 文本翻译需求匹配</span>
        <span class="hljs-keyword">if</span> (userRequest.<span class="hljs-title function_">contains</span>(<span class="hljs-string">"翻译"</span>) &amp;&amp; (userRequest.<span class="hljs-title function_">contains</span>(<span class="hljs-string">"中文"</span>) || userRequest.<span class="hljs-title function_">contains</span>(<span class="hljs-string">"英文"</span>))) {
            result.<span class="hljs-title function_">setMatch</span>(<span class="hljs-literal">true</span>);
            result.<span class="hljs-title function_">setTargetSkill</span>(skillMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">"text:translate"</span>));
            <span class="hljs-comment">// 封装参数（模拟解析用户需求中的文本和目标语言）</span>
            <span class="hljs-title class_">Map</span>&amp;lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&amp;gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            params.<span class="hljs-title function_">put</span>(<span class="hljs-string">"text"</span>, userRequest.<span class="hljs-title function_">split</span>(<span class="hljs-string">"翻译"</span>)[<span class="hljs-number">1</span>].<span class="hljs-title function_">trim</span>()); <span class="hljs-comment">// 提取需要翻译的文本</span>
            params.<span class="hljs-title function_">put</span>(<span class="hljs-string">"targetLang"</span>, userRequest.<span class="hljs-title function_">contains</span>(<span class="hljs-string">"英文"</span>) ? <span class="hljs-string">"en"</span> : <span class="hljs-string">"zh"</span>);
            result.<span class="hljs-title function_">setParams</span>(params);
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-comment">// Excel读取需求匹配</span>
        <span class="hljs-keyword">if</span> (userRequest.<span class="hljs-title function_">contains</span>(<span class="hljs-string">"读取"</span>) &amp;&amp; userRequest.<span class="hljs-title function_">contains</span>(<span class="hljs-string">"Excel"</span>)) {
            result.<span class="hljs-title function_">setMatch</span>(<span class="hljs-literal">true</span>);
            result.<span class="hljs-title function_">setTargetSkill</span>(skillMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">"excel:read"</span>));
            <span class="hljs-title class_">Map</span>&amp;lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&amp;gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            params.<span class="hljs-title function_">put</span>(<span class="hljs-string">"filePath"</span>, <span class="hljs-string">"/data/办公数据.xlsx"</span>); <span class="hljs-comment">// 模拟解析文件路径</span>
            result.<span class="hljs-title function_">setParams</span>(params);
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-comment">// PPT生成需求匹配</span>
        <span class="hljs-keyword">if</span> (userRequest.<span class="hljs-title function_">contains</span>(<span class="hljs-string">"生成"</span>) &amp;&amp; userRequest.<span class="hljs-title function_">contains</span>(<span class="hljs-string">"PPT"</span>)) {
            result.<span class="hljs-title function_">setMatch</span>(<span class="hljs-literal">true</span>);
            result.<span class="hljs-title function_">setTargetSkill</span>(skillMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">"ppt:generate"</span>));
            <span class="hljs-title class_">Map</span>&amp;lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&amp;gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            params.<span class="hljs-title function_">put</span>(<span class="hljs-string">"title"</span>, <span class="hljs-string">"办公汇报PPT"</span>);
            params.<span class="hljs-title function_">put</span>(<span class="hljs-string">"contents"</span>, <span class="hljs-title class_">Arrays</span>.<span class="hljs-title function_">asList</span>(<span class="hljs-string">"工作概述"</span>, <span class="hljs-string">"成果展示"</span>, <span class="hljs-string">"后续计划"</span>));
            result.<span class="hljs-title function_">setParams</span>(params);
            <span class="hljs-keyword">return</span> result;
        }

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">// 辅助方法：获取Agent支持的Skills描述</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getSupportSkillsDesc</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">StringBuilder</span> desc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Skill</span> skill : skillMap.<span class="hljs-title function_">values</span>()) {
            desc.<span class="hljs-title function_">append</span>(skill.<span class="hljs-title function_">getSkillId</span>()).<span class="hljs-title function_">append</span>(<span class="hljs-string">"（"</span>).<span class="hljs-title function_">append</span>(skill.<span class="hljs-title function_">getDescription</span>()).<span class="hljs-title function_">append</span>(<span class="hljs-string">"），"</span>);
        }
        <span class="hljs-keyword">return</span> desc.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, desc.<span class="hljs-title function_">length</span>() - <span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 辅助类：Skill匹配结果封装</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SkillMatchResult</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-built_in">boolean</span> match;
        <span class="hljs-keyword">private</span> <span class="hljs-title class_">Skill</span> targetSkill;
        <span class="hljs-keyword">private</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; params;

        <span class="hljs-comment">// getter/setter方法（简化，实际开发中可完善）</span>
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">isMatch</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> match; }
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setMatch</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> match</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">match</span> = match; }
        <span class="hljs-keyword">public</span> <span class="hljs-title class_">Skill</span> <span class="hljs-title function_">getTargetSkill</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> targetSkill; }
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setTargetSkill</span>(<span class="hljs-params">Skill targetSkill</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetSkill</span> = targetSkill; }
        <span class="hljs-keyword">public</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; <span class="hljs-title function_">getParams</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> params; }
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setParams</span>(<span class="hljs-params"><span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">Object</span>&gt; params</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">params</span> = params; }
    }

    <span class="hljs-comment">// 测试方法：运行Agent，模拟用户需求</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// 1. 加载3个核心Skills</span>
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Skill</span>&gt; skillList = <span class="hljs-title class_">Arrays</span>.<span class="hljs-title function_">asList</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextTranslateSkill</span>(),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExcelReadSkill</span>(),
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">PptGenerateSkill</span>()
        );

        <span class="hljs-comment">// 2. 创建办公Agent</span>
        <span class="hljs-title class_">OfficeAgent</span> officeAgent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OfficeAgent</span>(<span class="hljs-string">"多功能办公Agent"</span>, skillList);

        <span class="hljs-comment">// 3. 模拟3个不同的用户需求，测试Agent执行效果</span>
        <span class="hljs-title class_">String</span> request1 = <span class="hljs-string">"帮我翻译这句话：AI技能模块很实用，目标语言是英文"</span>;
        <span class="hljs-title class_">String</span> request2 = <span class="hljs-string">"帮我读取Excel文件中的数据"</span>;
        <span class="hljs-title class_">String</span> request3 = <span class="hljs-string">"帮我生成一份办公汇报PPT"</span>;

        <span class="hljs-comment">// 4. 执行需求并输出结果</span>
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(officeAgent.<span class="hljs-title function_">processRequest</span>(request1));
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(officeAgent.<span class="hljs-title function_">processRequest</span>(request2));
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(officeAgent.<span class="hljs-title function_">processRequest</span>(request3));
    }
}
    
</code></pre>
<h4 data-id="heading-15">3. 执行结果与解析</h4>
<p>运行Agent的main方法，控制台输出如下（清晰展示Skills加载、需求匹配、执行结果的完整流程）：</p>
<pre><code class="hljs language-makefile" lang="makefile">
<span class="hljs-section">Agent加载Skill：text:translate（用于文本翻译，支持中文与英文互译，输入文本和目标语言，返回翻译结果）</span>
<span class="hljs-section">Agent加载Skill：excel:read（用于读取Excel文件数据，输入文件路径，返回文件中的数据条数和前3条数据预览）</span>
<span class="hljs-section">Agent加载Skill：ppt:generate（用于生成办公汇报PPT，输入标题和每页内容，返回PPT生成结果和保存路径）</span>

用户需求：帮我翻译这句话：AI技能模块很实用，目标语言是英文
<span class="hljs-section">匹配到Skill：text:translate</span>
<span class="hljs-section">执行结果：翻译成功：Translated: AI技能模块很实用</span>

用户需求：帮我读取Excel文件中的数据
<span class="hljs-section">匹配到Skill：excel:read</span>
执行结果：Excel读取成功！文件路径：/data/办公数据.xlsx，共50条数据，前3条预览：第1条：张三,25,工程师；第2条：李四,28,产品经理；第3条：王五,30,设计师

用户需求：帮我生成一份办公汇报PPT
<span class="hljs-section">匹配到Skill：ppt:generate</span>
执行结果：PPT生成成功！标题：办公汇报PPT，共3页，保存路径：/data/ppt/办公汇报PPT.pptx
</code></pre>
<p>解析：Agent成功加载3个Skills，根据用户需求自主匹配对应Skill，调用执行后返回清晰结果，完全符合办公场景的实际需求；若用户输入未识别的需求，Agent会返回支持的功能列表，提升用户体验。</p>
<h3 data-id="heading-16">四、Skills进阶技巧：从基础使用到高级应用</h3>
<p>掌握基础的Skills开发后，可通过以下进阶技巧，进一步提升Skills的灵活性、可扩展性，适配更复杂的Agent场景，打造更强大的智能体。</p>
<h4 data-id="heading-17">1. Skills组合：实现复杂功能拆解与复用</h4>
<p>单一Skills仅能实现简单功能，通过Skills组合，可拆解复杂业务需求，实现“1+1&gt;2”的效果，且组合后的逻辑可复用，无需重复开发。</p>
<p>示例：实现“自动化数据分析报告”功能，组合3个Skills：</p>
<ul>
<li>第一步：调用excel:read（Excel读取Skill），读取数据源文件；</li>
<li>第二步：调用data:statistic（数据统计Skill），对读取的数据进行统计（求和、平均值、占比）；</li>
<li>第三步：调用doc:generate（文档生成Skill），将统计结果生成数据分析报告。</li>
</ul>
<p>可封装一个“组合Skill”，将上述流程固化，Agent调用该组合Skill即可直接完成复杂功能，代码复用性大幅提升。</p>
<h4 data-id="heading-18">2. 动态加载与卸载：优化Agent性能</h4>
<p>Agent无需一次性加载所有Skills，可根据用户需求、使用场景，动态加载所需Skills，使用完成后卸载，减少内存占用，优化Agent性能。</p>
<p>示例：办公Agent在工作日加载“Excel读取”“PPT生成”等办公Skills，在节假日加载“节日祝福生成”“日程提醒”等Skills，通过动态加载实现资源优化。</p>
<h4 data-id="heading-19">3. Skills版本管理：适配迭代与兼容性</h4>
<p>随着业务需求迭代，Skills也需要不断优化升级，为避免升级后影响Agent调用，需做好版本管理，建议在SkillId中添加版本号（如text:translate:v2）。</p>
<p>核心要点：新版本Skills兼容旧版本参数，旧版本Skills暂时保留（逐步淘汰），Agent可根据需求选择调用对应版本的Skills，避免迭代导致的调用失败。</p>
<h4 data-id="heading-20">4. 外部API集成：扩展Skills能力边界</h4>
<p>Skills可集成外部API（如翻译API、地图API、支付API），扩展自身能力边界，无需重复开发复杂逻辑。例如，文本翻译Skill可集成百度翻译API，实现更精准的多语言翻译；地图Skill可集成高德地图API，实现地理位置查询。</p>
<p>避坑提醒：集成外部API时，需添加超时重试、异常捕获逻辑，避免API调用失败导致Skills执行崩溃；同时做好API密钥管理，避免泄露。</p>
<h3 data-id="heading-21">五、Skills高频避坑指南：避开这些开发陷阱</h3>
<p>结合大量实战经验，梳理开发者在Skills开发、使用过程中的高频坑点，附上具体规避方案，避免踩坑浪费开发时间，提升Skills质量和Agent稳定性。</p>
<h4 data-id="heading-22">坑点1：Skills功能冗余，违背单一职责原则</h4>
<p><strong>现象</strong>：一个Skill实现多个功能（如“Excel读取+数据统计+报告生成”），导致代码臃肿、难以维护、复用性差，Agent调用时容易出现异常。</p>
<p><strong>规避方案</strong>：严格遵循单一职责原则，一个Skill仅实现一个功能，复杂功能拆分为多个独立Skills，通过组合实现，确保每个Skill简洁、可维护。</p>
<h4 data-id="heading-23">坑点2：参数设计混乱，无校验、无默认值</h4>
<p><strong>现象</strong>：参数过多、冗余，无明确说明，缺少参数校验，非必填参数无默认值，导致Agent调用时频繁出现参数错误，调试成本高。</p>
<p><strong>规避方案</strong>：遵循“最小必要原则”设计参数，添加参数说明（getParamDesc方法），实现参数校验逻辑，非必填参数设置合理默认值，异常时返回清晰的错误提示。</p>
<h4 data-id="heading-24">坑点3：忽视异常捕获，导致Agent崩溃</h4>
<p><strong>现象</strong>：Skills执行过程中未全面捕获异常（如文件不存在、API调用超时、参数格式错误），直接抛出未捕获异常，导致Agent崩溃，影响整体使用。</p>
<p><strong>规避方案</strong>：在execute方法中添加try-catch捕获所有可能出现的异常，返回清晰的错误提示，便于Agent判断是否重试、如何调整策略，禁止直接抛出未捕获异常。</p>
<h4 data-id="heading-25">坑点4：Skills命名模糊，Agent无法精准匹配</h4>
<p><strong>现象</strong>：Skills命名模糊（如MySkill、Skill2），Agent无法根据用户需求精准匹配对应Skill，导致功能执行失败，用户体验差。</p>
<p><strong>规避方案</strong>：严格遵循命名规范，采用“功能类型+具体操作”的格式，语义清晰，让Agent和开发者能快速识别Skill功能，提升匹配准确率。</p>
<h4 data-id="heading-26">坑点5：Skills无复用性，重复开发</h4>
<p><strong>现象</strong>：不同Agent中实现相同功能的Skills，接口不统一、逻辑不通用，导致重复开发，维护成本高，不符合Skills的核心价值。</p>
<p><strong>规避方案</strong>：遵循统一的接口规范、命名规范、参数规范开发Skills，打造可复用的Skills组件库，不同Agent可直接复用，减少重复开发成本。</p>
<h3 data-id="heading-27">六、总结：Skills是AI Agent规模化落地的关键</h3>
<p>AI Agent的核心竞争力，不在于“能自主决策”，而在于“能高效完成具体任务”——而Skills，正是让Agent具备“完成任务能力”的核心载体。从MCP的遇冷到Skills的崛起，本质是AI开发从“追求通用”到“回归实用”的转变，Skills的轻量、高效、可复用，完美契合了Agent规模化落地的需求。</p>
<p>对于开发者而言，掌握Skills的设计规范、实战技巧与避坑要点，不仅能提升Agent开发效率、降低维护成本，更能打造出体验更优、能力更强的智能体产品。未来，随着AI Agent的普及，高质量的Skills组件库将成为开发者的“核心资产”，而遵循规范、聚焦实用，正是打造优秀Skills的关键。</p>
<p>无论是办公自动化、客服接待，还是工业质检、智能运维，Skills都能成为Agent的“得力助手”，让AI真正走出“概念”，落地到每一个实际场景中，为开发者减负，为用户创造价值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【 2025 年终总结】被推着走的一年，需要停下来思考]]></title>    <link>https://juejin.cn/post/7603004323870326827</link>    <guid>https://juejin.cn/post/7603004323870326827</guid>    <pubDate>2026-02-05T01:12:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603004323870326827" data-draft-id="7602814773497331754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【 2025 年终总结】被推着走的一年，需要停下来思考"/> <meta itemprop="keywords" content="年终总结,Trae"/> <meta itemprop="datePublished" content="2026-02-05T01:12:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="别惹CC"/> <meta itemprop="url" content="https://juejin.cn/user/4095037267779687"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【 2025 年终总结】被推着走的一年，需要停下来思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4095037267779687/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    别惹CC
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T01:12:39.000Z" title="Thu Feb 05 2026 01:12:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="hybrid">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1d1f21}.hljs::selection,.hljs span::selection{background:#373b41}.hljs::-moz-selection,.hljs span::-moz-selection{background:#373b41}.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#c5c8c6}.hljs-name,.hljs-title{color:#f0c674}.hljs-comment,.hljs-meta,.hljs-meta .hljs-keyword{color:#707880}.hljs-deletion,.hljs-link,.hljs-literal,.hljs-number,.hljs-symbol{color:#c66}.hljs-addition,.hljs-doctag,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string{color:#b5bd68}.hljs-attribute,.hljs-code,.hljs-selector-id{color:#b294bb}.hljs-bullet,.hljs-keyword,.hljs-selector-tag,.hljs-tag{color:#81a2be}.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-variable{color:#8abeb7}.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-selector-class,.hljs-type{color:#de935f}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">生活从不按计划</h2>
<p>从 2025 年底开始规划，一直到 2026 年 2 月的一天深夜，我才真正开始动笔。第三年写年终总结—按四舍五入的算法，也算是工作的第三年。</p>
<p>回看 2024 年立下的 Flag，最接近“完成”的，竟然还是「持续输出博客」。其他的计划，不是没开始，就是被现实挤到角落里：转产品带来的节奏变化、AI 发展带来的认知刷新、以及工作强度对生活空间的吞噬，都在一点点改写我原本的设想。</p>
<p>所以今年我不立那种漂亮的 Flag 了。2026 年只定几个大方向：把节奏找回来，把身体拉回正轨，把注意力放在真正会复利的事上。</p>
<h2 data-id="heading-1">写博客带来的正向反馈</h2>
<p>转产品之后，我本来打算把技术博客慢慢降频。不是不喜欢写，而是觉得工作之外的精力应该更多投向产品相关的输入输出。但 3 月份，我收到了一个读者发来的邮件。那一瞬间很奇妙：你以为自己在对着空气讲话，突然有人从很远的地方走过来，认真地告诉你：<strong>你写的东西，真的帮到我了。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3a7afcc3cb0430b978d28db9014f658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=nMHrvLat5GMPWXuWNxVMUmwkoIk%3D" alt="1.png" loading="lazy"/></p>
<p>于是即使后面忙到爆炸，我依旧在挤时间更新。更新频率虽然不算夸张，但基本维持了“每月都有动静”的状态，也顺带把国内几大主流技术社区的「专家博主」之类认证收集齐了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8eb9a394e304f658ca66c5897ab4081~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=PTkjb%2BL0dxLmMfbee49L7%2FFi1L8%3D" alt="2.png" loading="lazy"/></p>
<p>另外，靠“笔杆子”接到了自己的第一个推广合作。钱不多，但意义对我来说很重：<strong>这是我第一次感受到，输出不只是一种自我记录，它也能在现实里被交换、被认可。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea7713d3e8b348b9940ff3d096895f4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=vUMndRtDqqzIVuAqfqoX%2BovYleI%3D" alt="3.png" loading="lazy"/></p>
<p>不过我也得诚实地讲：2026 年技术博客更新频率大概率会更低一点。不是不写，而是我确实需要把更多精力投向当下的本职能力——尤其是产品能力。</p>
<h2 data-id="heading-2">被 Trae 官方采访</h2>
<p>3 月参加了一场黑客松，用的是 Trae。虽然没拿上名次，但作品本身有可圈可点的地方，所以很荣幸被 Trae 官方采访，最后上了他们的公众号。</p>
<p>这是我第一次在“博客以外”的地方表达自己，也第一次把一些产品观讲得更公开。现在回看，那些观点确实还有些稚嫩，但我反而更能接受这种稚嫩：它说明那时的我站在那个阶段，确实认真想过、认真说过。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/354bd6ff8a69454d841e4115caf3bcc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=RlWAZhWZiVO8ws608pTTvQC8cRw%3D" alt="4.png" loading="lazy"/></p>
<p>虽然后面切换到了 <code>Claude Code</code>，Trae 用得少了，但更新我其实一直有在关注，也看过他们产品负责人的采访，能感受到团队在工程侧的投入。也祝愿他们越做越好——说不定哪天产品打磨到某个点，我还能从 CC 再切回去。</p>
<h2 data-id="heading-3">今年看过的“五月天”</h2>
<p>作为一个 wmls ，今年一共看了三场：<strong>香港 → 长沙 → 大湾区</strong>，其中大湾区还是阿信生日场，满足感拉满。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6230fde44f89418e97b6dfd287f78972~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=cyErKQWzpw9FrXThek%2BY8Wcohy8%3D" alt="5.png" loading="lazy"/></p>
<p>今年我也意外发现：去一个新城市看演唱会，顺便“当一天游客”，会让这趟奔赴更立体。长沙的小炒真的下饭，很对我的胃口——也算是“音乐 + 城市 + 食物”的一次完整体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bbc8f524510425e841fdc781f99446e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=KSitoSICQJcEysk8ngbY6oNaaGo%3D" alt="6.png" loading="lazy"/></p>
<p>2026 年的话，我应该会多去大湾区以外的地方继续追。前提是：我得先把自己的节奏和体力还给自己。</p>
<h2 data-id="heading-4">真格00后做分享</h2>
<p>11 月机缘巧合下受邀参加了真格基金在深圳举办的「真格 00 后」分享，分享了我对 AI 应用方向的一些看法。回头看，至少到目前为止，openclaw（原 clawdbot）的爆火以及各大厂商的跟进，和我当时整体的判断方向基本一致。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c254f04b34d44d5e9c10fe74db78dac6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=hlkdVS5AJE1qkt9yxK%2BNAHoSWA8%3D" alt="7.png" loading="lazy"/></p>
<p>参加这个活动更大的价值，不是“被听见”，而是“看见别人”。看到一些同龄人在做的事，会让你突然明白：世界比你想象得更快，而你能做的不是焦虑，而是把自己该补的那部分补起来。</p>
<p>也是在这个过程里，我发现自己好像有一点“能把话讲清楚”的天赋。后面我又在 2 个小型 AI 相关 meetup 做了分享——输出倒逼输入，交流本身也是输入。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/091937a7f3bf4179a2e67ddf3994877d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=LW64%2FSdGSUKUXnuK2CPlhpuratc%3D" alt="8.png" loading="lazy"/></p>
<h2 data-id="heading-5">参加 Vue Conf 2025</h2>
<p>虽然已经转产品，不再以技术作为主业，但业余对 code 的热爱其实没停。</p>
<p>看到今年 Vue Conf 的消息，我几乎没犹豫就买票了。去年知道太晚没去成是个遗憾，今年恰好还在深圳，也见到了尤大本人。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eba4c2da1ee42988c90bc18db832b4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=juQSEbS%2F02%2BXgZw0Ec9r%2BMGGAsQ%3D" alt="9.png" loading="lazy"/></p>
<p>有些喜欢不需要证明，它只会在你愿意的时候，把你带回现场。</p>
<h2 data-id="heading-6">成为铲屎官</h2>
<p>今年整体都在一种很紧凑的工作节奏里度过，几乎没什么真正意义上的休息时间。年底我养了一只小猫，给它取名叫 <strong>哈哈</strong>，希望它能给我带来快乐，也希望我自己能每天快快乐乐的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46e5c46c4d62424cb3fb1c55aa2afeab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=1UEKXi%2Ba93qvsOqyHxUAAJ8naJc%3D" alt="10.png" loading="lazy"/></p>
<p>每天晚上回家，它会在门口等我。有了它的陪伴，生活确实不太一样了：你会多一种“有人在等你”的感觉。</p>
<h2 data-id="heading-7">关于个人</h2>
<p>个人层面来看，全年大部分时间都在工作上。今年开始独立负责一条业务线之后，很多小事和开不完的会几乎榨干了我所有精力。节假日我只想躺着休息，所以今年除了看演唱会，基本没实现去年的旅行规划，这是遗憾。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/455fc16400c64eeebbd214f29bc583d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=uVmL4xQiYTh9b6OnWGAhdG5GyoU%3D" alt="11.png" loading="lazy"/></p>
<p>但我也开始慢慢有了掌控感，并且更能理解那句话：<strong>要学会在工作中休息</strong>。不然休息只会变成更深的疲惫。</p>
<p>还有就是体重问题。毕业这两年多胖了近 40 斤，我安慰自己是“过劳肥”——当然可能有这部分影响，但也得承认：压力大的时候，嘴确实更容易失控。现在的大体重爬个梧桐山都要了老命。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f47584cd340c4bcbb2c556f89ae32a9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=5GUoCsVto6lhBZ3%2BSeKjQCj7mCU%3D" alt="12.png" loading="lazy"/></p>
<p>这一年给我的一个很朴素的结论是：<strong>心态真的很重要</strong>。不是“想开点”那种空话，而是你不调整，它会通过睡眠、饮食、体重，换一种方式让你付账。</p>
<h2 data-id="heading-8">AI时代的焦虑</h2>
<p>25 年大模型和 AI 应用更新越来越快，社媒上的焦虑也越来越密：好像不马上学就会被淘汰。</p>
<p>但回过头看，很多东西在试用后一两周效果一般，就被我们悄悄遗忘了。最后到年底，真正留在我工作流里的仍然是那几款工具。</p>
<p>我们做产品常讲“把需求转为解决方案”。其实个人层面也一样：<strong>当你在工作或生活里遇到问题卡点了，再去找 AI 对你有没有帮助就好</strong>，不用过度关注所有信息流的更新。</p>
<p>焦虑不会让你变强，它只会让你变散。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5358f6d13cbd41ec884938add0348e0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858801&amp;x-signature=rlQLl5FVrlQjFgnUo5qdbf2uLYw%3D" alt="13.png" loading="lazy"/></p>
<h2 data-id="heading-9">尾言</h2>
<p>所以今年我不想立一些Flag 了。更现实一点：先把节奏重新掌握回来，先做出改变。</p>
<p>2026 年我给自己定的大方向大概是：</p>
<ol>
<li><strong>把产品能力做实</strong>：业务理解、表达、协作、推进。</li>
<li><strong>把 AI 当工具</strong>：围绕真实问题构建稳定工作流，而不是追热点。</li>
<li><strong>把身体拉回正轨</strong>：运动、饮食、睡眠，至少先把体重刹住。</li>
<li><strong>把输出留下来</strong>：不为更新而更新，但持续记录和沉淀。</li>
</ol>
<p>也祝你、祝我、祝我们：<strong>2026 年都能更稳一点、更开心一点。</strong></p>
<p>于 2026年2月5日 凌晨3点写完。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 AI 生成高质量 Mock 数据的实践]]></title>    <link>https://juejin.cn/post/7603004323870851115</link>    <guid>https://juejin.cn/post/7603004323870851115</guid>    <pubDate>2026-02-05T02:39:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603004323870851115" data-draft-id="7602816610932932671" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 AI 生成高质量 Mock 数据的实践"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-05T02:39:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="转转技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/606586148237431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 AI 生成高质量 Mock 数据的实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/606586148237431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    转转技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T02:39:04.000Z" title="Thu Feb 05 2026 02:39:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在前后端分离的研发模式下，Mock 数据是并行开发的基础设施。本文介绍一套 Mock 工具的技术实现，核心解决四个问题：请求拦截、规则匹配、数据质量、团队共享。</p>
</blockquote>
<h2 data-id="heading-0">背景</h2>
<p>在实际业务开发中，前端和测试同学经常遇到这些问题：</p>
<ul>
<li><strong>联调阻塞</strong>：后端接口未就绪时，前端只能等待或硬编码 <code>if (true) { ... }</code></li>
<li><strong>场景覆盖难</strong>：想模拟边缘场景（异常、空数据、分页），往往需要后端改数据库</li>
<li><strong>Mock 数据质量差</strong>：Mock.js 生成的 <code>@cname</code>、<code>@integer</code> 缺乏业务语义，和真实数据差距大</li>
<li><strong>数据难共享</strong>：Mock 数据存在本地，换台电脑或换个同事就用不了</li>
</ul>
<p>我们需要一套工具解决这些问题：</p>
<ul>
<li>不侵入业务代码，npm 包引入即可</li>
<li>支持参数级别的规则匹配，同一接口可配置多个场景</li>
<li>根据接口文档自动生成符合业务语义的数据</li>
<li>支持团队共享 Mock 配置</li>
</ul>
<hr/>
<h2 data-id="heading-1">业界常见方案</h2>



































<table><thead><tr><th>方案</th><th>优点</th><th>不足</th></tr></thead><tbody><tr><td>硬编码 Mock</td><td>简单直接</td><td>侵入业务代码，发布前需手动删除</td></tr><tr><td>Mock.js</td><td>有数据生成能力</td><td>规则配置繁琐，数据缺乏业务语义</td></tr><tr><td>whistle 代理</td><td>不侵入业务，使用简单</td><td>数据保存在本地，无法团队共享，无法匹配复杂场景</td></tr><tr><td>MSW (Service Worker)</td><td>网络层拦截</td><td>需注册 sw.js，依赖 HTTPS，接入成本高</td></tr><tr><td>浏览器插件</td><td>使用简单 无侵入式</td><td>规则在本地，无法接入内部接口平台</td></tr></tbody></table>
<p>这些方案都无法同时满足"低侵入"、"规则灵活"、"数据质量高"、"团队可共享"四个需求。</p>
<hr/>
<h2 data-id="heading-2">整体架构</h2>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────┐
│                        业务项目                              │
│   import { mockInit } <span class="hljs-selector-tag">from</span> '<span class="hljs-keyword">@zz-common</span>/ai_mock'             │
│   mockInit({ rules: [<span class="hljs-string">'api.example.com'</span>] })                  │
└────────────────────────────┬────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────┐
│                    ai_mock (npm 包)                         │
│      XHR/Fetch 拦截  →  规则匹配引擎  →  返回 Mock 数据         │
└────────────────────────────┬────────────────────────────────┘
                             │ 动态加载 sdk + CustomEvent 通信
┌────────────────────────────▼────────────────────────────────┐
│                  mock-sdk (可视化面板)                        │
│        请求列表  |  规则管理  |  Monaco Editor 编辑器           │
└────────────────────────────┬────────────────────────────────┘
                             │ HTTP
┌────────────────────────────▼────────────────────────────────┐
│                   node (后端服务)                            │
│         接口文档获取  →  AI 生成  →  数据持久化                 │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p>核心设计：</p>
<ul>
<li><code>ai_mock</code> 只负责拦截和匹配，不包含 UI 代码</li>
<li><code>mock-sdk</code> 通过 CDN 动态注入，不增加业务包体积</li>
<li>两者通过 <code>CustomEvent</code> 松耦合通信</li>
<li>仅在非生产环境启用</li>
</ul>
<hr/>
<h2 data-id="heading-3">核心实现一：请求拦截</h2>
<h3 data-id="heading-4">问题</h3>
<p>现代前端应用混合使用 <code>XMLHttpRequest</code> 和 <code>fetch</code>。拦截时需要解决：</p>
<ol>
<li>同时拦截 XHR 和 Fetch，且不破坏第三方库（如 Sentry）的监听逻辑</li>
<li>XHR 的 <code>readyState</code>、<code>status</code>、<code>responseText</code> 是只读属性，无法直接赋值</li>
<li>拦截后发送真实请求会再次进入拦截逻辑，造成无限递归</li>
</ol>
<h3 data-id="heading-5">实现</h3>
<p>通过重写 <code>XMLHttpRequest.prototype.send</code> 和 <code>window.fetch</code> 实现拦截：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 保存原始方法</span>
<span class="hljs-keyword">const</span> xhrSendNative = <span class="hljs-title class_">XMLHttpRequest</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">send</span>
<span class="hljs-keyword">const</span> originalFetch = <span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span>

<span class="hljs-comment">// 防递归：标记真实请求</span>
<span class="hljs-keyword">const</span> isRealRequest = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>&lt;<span class="hljs-title class_">XMLHttpRequest</span>, <span class="hljs-built_in">boolean</span>&gt;()

<span class="hljs-title class_">XMLHttpRequest</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">send</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
  <span class="hljs-keyword">const</span> xhr = <span class="hljs-variable language_">this</span>
  <span class="hljs-keyword">const</span> url = <span class="hljs-title function_">sliceUrlPath</span>(xhr.<span class="hljs-property">originRequestUrl</span>)
  
  <span class="hljs-comment">// 检查是否为标记的真实请求，防止无限递归</span>
  <span class="hljs-keyword">if</span> (isRealRequest.<span class="hljs-title function_">get</span>(xhr)) {
    <span class="hljs-keyword">return</span> xhrSendNative.<span class="hljs-title function_">apply</span>(xhr, args)
  }
  
  <span class="hljs-comment">// 检查是否命中 Mock 规则</span>
  <span class="hljs-keyword">if</span> (mockInterface[url]?.<span class="hljs-property">isOpen</span>) {
    <span class="hljs-keyword">const</span> mockResult = <span class="hljs-title function_">getMockData</span>(url, requestData)
    
    <span class="hljs-keyword">if</span> (mockResult.<span class="hljs-property">matched</span>) {
      <span class="hljs-comment">// 1. 立即返回 Mock 响应给业务层</span>
      <span class="hljs-title function_">applyMockResponseToXhr</span>(xhr, mockResult.<span class="hljs-property">data</span>, mockResult.<span class="hljs-property">httpStatusCode</span>)
      
      <span class="hljs-comment">// 2. 后台发送真实请求（用于数据对照，不触发业务回调）</span>
      <span class="hljs-keyword">const</span> realXhr = <span class="hljs-title function_">cloneXHR</span>(xhr, <span class="hljs-literal">false</span>)  <span class="hljs-comment">// 不复制事件监听器</span>
      isRealRequest.<span class="hljs-title function_">set</span>(realXhr, <span class="hljs-literal">true</span>)       <span class="hljs-comment">// 标记，防止递归</span>
      xhrSendNative.<span class="hljs-title function_">apply</span>(realXhr, args)
      <span class="hljs-keyword">return</span>
    }
  }
  
  <span class="hljs-comment">// 未命中：执行原生请求</span>
  xhrSendNative.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
}
</code></pre>
<p><strong>覆写只读属性</strong>：XHR 的 <code>readyState</code>、<code>status</code> 等属性是只读的，通过 <code>Object.defineProperties</code> 解决：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">applyMockResponseToXhr</span> = (<span class="hljs-params">
  xhr: XMLHttpRequest,
  responseData: <span class="hljs-built_in">any</span>,
  statusCode: <span class="hljs-built_in">number</span>
</span>) =&gt; {
  <span class="hljs-keyword">const</span> responseText = <span class="hljs-keyword">typeof</span> responseData === <span class="hljs-string">'string'</span> 
    ? responseData 
    : <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(responseData)
  
  <span class="hljs-comment">// 通过 defineProperties 覆写只读属性</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperties</span>(xhr, {
    <span class="hljs-attr">readyState</span>: { <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-number">4</span>, <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-attr">status</span>: { <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> statusCode, <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-attr">response</span>: { <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> responseData, <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span> },
    <span class="hljs-attr">responseText</span>: { <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> responseText, <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span> }
  })
  
  <span class="hljs-comment">// 触发标准事件序列</span>
  xhr.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'readystatechange'</span>))
  xhr.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'load'</span>))
  xhr.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>(<span class="hljs-string">'loadend'</span>))
}
</code></pre>
<p><strong>立即响应 + 真实请求</strong>：开启 Mock 后，业务层立即拿到 Mock 数据，同时后台会发送一份真实请求用于数据对照。面板提供「加载真实数据」按钮，可以一键将真实响应填入编辑器，方便基于真实数据微调。</p>
<hr/>
<h2 data-id="heading-6">核心实现二：规则匹配引擎</h2>
<h3 data-id="heading-7">问题</h3>
<p>实际业务中，同一个接口需要根据不同参数返回不同数据：</p>
<ul>
<li><code>page=1</code> 返回第一页，<code>page=2</code> 返回第二页</li>
<li><code>userId=vip</code> 返回 VIP 数据，<code>userId=normal</code> 返回普通数据</li>
<li><code>header</code> 中带某个标识时返回调试数据</li>
</ul>
<p>参数可能在 URL Query、Request Body、Header、Cookie、Path 中，需要一套灵活的规则匹配机制。</p>
<h3 data-id="heading-8">规则数据结构</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MockRule</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">priority</span>: <span class="hljs-built_in">number</span>;  <span class="hljs-comment">// 优先级，数字越小越优先</span>
  <span class="hljs-attr">enabled</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-attr">type</span>: <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span>;   <span class="hljs-comment">// 1=本地草稿，2=个人云端，3=团队共享</span>
  <span class="hljs-attr">paramConditions</span>: <span class="hljs-title class_">ParamCondition</span>[];  <span class="hljs-comment">// 参数条件</span>
  <span class="hljs-attr">mockData</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-attr">httpStatusCode</span>: <span class="hljs-built_in">number</span>;
  delay?: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ParamCondition</span> {
  <span class="hljs-attr">location</span>: <span class="hljs-string">'query'</span> | <span class="hljs-string">'body'</span> | <span class="hljs-string">'header'</span> | <span class="hljs-string">'cookie'</span> | <span class="hljs-string">'path'</span>;
  <span class="hljs-attr">paramName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">operator</span>: <span class="hljs-string">'equals'</span> | <span class="hljs-string">'notEquals'</span> | <span class="hljs-string">'contains'</span> | <span class="hljs-string">'notContains'</span> | 
            <span class="hljs-string">'greaterThan'</span> | <span class="hljs-string">'lessThan'</span> | <span class="hljs-string">'greaterOrEqual'</span> | <span class="hljs-string">'lessOrEqual'</span>;
  <span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span>;
}
</code></pre>
<h3 data-id="heading-9">匹配算法</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">matchRule</span>(<span class="hljs-params">rules: MockRule[], request: RequestInfo</span>): <span class="hljs-title class_">MatchResult</span> {
  <span class="hljs-comment">// 只匹配已启用的期望，按优先级排序</span>
  <span class="hljs-keyword">const</span> enabledRules = rules
    .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">rule</span> =&gt;</span> rule.<span class="hljs-property">enabled</span>)
    .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">priority</span> - b.<span class="hljs-property">priority</span>);

  <span class="hljs-keyword">const</span> matched = enabledRules.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">rule</span> =&gt;</span> <span class="hljs-title function_">isRuleMatched</span>(rule, request));
  
  <span class="hljs-keyword">return</span> matched 
    ? { <span class="hljs-attr">matched</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">rule</span>: matched, <span class="hljs-attr">delay</span>: matched.<span class="hljs-property">delay</span> ?? <span class="hljs-number">0</span> }
    : { <span class="hljs-attr">matched</span>: <span class="hljs-literal">false</span> };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">isRuleMatched</span>(<span class="hljs-params">rule: MockRule, request: RequestInfo</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-comment">// 没有参数条件，匹配所有请求</span>
  <span class="hljs-keyword">if</span> (!rule.<span class="hljs-property">paramConditions</span>?.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  
  <span class="hljs-comment">// 所有条件都满足才匹配（AND 关系）</span>
  <span class="hljs-keyword">return</span> rule.<span class="hljs-property">paramConditions</span>.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">condition</span> =&gt;</span>
    <span class="hljs-title function_">matchParamCondition</span>(condition, request)
  );
}
</code></pre>
<h3 data-id="heading-10">参数值获取</h3>
<p>根据 <code>location</code> 从不同位置取值：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getParamValue</span>(<span class="hljs-params">location: <span class="hljs-built_in">string</span>, paramName: <span class="hljs-built_in">string</span>, request: RequestInfo</span>): <span class="hljs-built_in">any</span> {
  <span class="hljs-keyword">switch</span> (location) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'query'</span>:
      <span class="hljs-keyword">return</span> request.<span class="hljs-property">query</span>?.[paramName];
    <span class="hljs-keyword">case</span> <span class="hljs-string">'body'</span>:
      <span class="hljs-comment">// 支持嵌套路径，如 body.user.id</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">getNestedValue</span>(<span class="hljs-title function_">parseBody</span>(request.<span class="hljs-property">body</span>), paramName);
    <span class="hljs-keyword">case</span> <span class="hljs-string">'header'</span>:
      <span class="hljs-keyword">return</span> request.<span class="hljs-property">headers</span>?.[paramName];
    <span class="hljs-keyword">case</span> <span class="hljs-string">'cookie'</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">parseCookie</span>(request.<span class="hljs-property">headers</span>?.<span class="hljs-property">cookie</span>, paramName);
    <span class="hljs-keyword">case</span> <span class="hljs-string">'path'</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">extractPathParam</span>(request.<span class="hljs-property">url</span>, paramName);
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;
  }
}
</code></pre>
<p>比较时会做类型兼容处理，比如 <code>1</code> 和 <code>"1"</code> 视为相等，避免因类型不一致导致匹配失败。</p>
<h3 data-id="heading-11">使用示例</h3>






























<table><thead><tr><th>请求参数</th><th>规则配置</th><th>结果</th></tr></thead><tbody><tr><td><code>?page=1</code></td><td><code>query.page equals 1</code></td><td>返回第一页数据</td></tr><tr><td><code>?page=2</code></td><td><code>query.page equals 2</code></td><td>返回第二页数据</td></tr><tr><td><code>body: {"user":{"type":"vip"}}</code></td><td><code>body.user.type equals "vip"</code></td><td>返回 VIP 数据</td></tr><tr><td><code>Header: X-Debug: true</code></td><td><code>header.X-Debug equals "true"</code></td><td>返回调试数据</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-12">核心实现三：AI 生成高质量数据</h2>
<h3 data-id="heading-13">问题</h3>
<p>Mock.js 生成的数据缺乏业务语义：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Mock.js 生成</span>
{ <span class="hljs-attr">name</span>: <span class="hljs-string">"xxx"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">82</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">3</span> }

<span class="hljs-comment">// 期望的业务数据</span>
{ <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">28</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">1</span> }  <span class="hljs-comment">// status: 0=待审核, 1=已通过, 2=已拒绝</span>
</code></pre>
<p>我们希望根据接口文档中的字段描述、枚举说明、字段命名来生成符合业务语义的数据, 这样文档备注越详细 字段名定义越清晰 生成数据会越准确。</p>
<h3 data-id="heading-14">实现思路</h3>
<p>后端服务从 API文档平台 获取接口的 JSON Schema，构建 Prompt 调用 AI 生成数据。</p>
<p><strong>核心 Prompt 设计</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> systemPrompt = <span class="hljs-string">`
你是 Mock 数据生成专家，根据 JSON Schema 生成符合业务场景的数据。

【生成规则 - 按优先级排序】
1. 若 description 中存在枚举说明（如 "0:成功, 1:失败"），优先使用枚举值本身（如 0、1）
2. 若无 description，则根据字段名的语义生成合理值
3. 数组类型默认生成 5 条数据
4. 若 description 中枚举值较多，数组应覆盖所有枚举值

【默认值规则】
- respCode / code：成功场景为 0，失败场景为 -1
- errorMsg：成功场景为 null，失败场景为 "系统异常"
- 图片 URL：使用统一的占位图地址
- 普通 URL：使用统一的域名地址

【输出格式】
仅输出 JSON，不附加任何解释文字
`</span>;
</code></pre>
<p><strong>关键设计点</strong>：</p>
<ol>
<li><strong>description 优先</strong>：接口文档中 <code>status: 0=待审核, 1=已通过</code> 这类描述会被优先使用</li>
<li><strong>字段名语义</strong>：<code>userName</code> 生成中文姓名，<code>price</code> 生成合理价格</li>
<li><strong>枚举覆盖</strong>：数组字段会尽量覆盖所有枚举值，便于测试</li>
<li><strong>默认成功场景</strong>：除非用户指定，否则生成正常数据</li>
</ol>
<h3 data-id="heading-15">数据校验</h3>
<p>AI 生成的 JSON 可能格式有问题，通过 <code>jsonrepair</code> 验证修复：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> jsonMatch = result.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\{[\s\S]*\}/</span>);
<span class="hljs-keyword">if</span> (jsonMatch) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">jsonrepair</span>(jsonMatch[<span class="hljs-number">0</span>]);
}
</code></pre>
<p>生成后对比 Schema 和实际数据，字段缺失时发送告警。</p>
<h3 data-id="heading-16">生成模式</h3>
<ul>
<li><strong>整体生成</strong>：根据完整 Schema 生成所有字段</li>
<li><strong>选区生成</strong>：只替换选中的字段，保留其他字段不变</li>
<li><strong>自定义 Prompt</strong>：用户可输入额外要求，如"生成 VIP 用户数据"、"价格在 100-500 之间"、"生成10条数据"、"生成某个场景值的数据"等</li>
</ul>
<hr/>
<h2 data-id="heading-17">核心实现四：三层作用域</h2>
<h3 data-id="heading-18">问题</h3>
<p>Mock 数据存在本地的问题：</p>
<ul>
<li>换台电脑就没了</li>
<li>同事想用同一套数据，只能手动复制</li>
<li>团队标准测试数据无法统一管理</li>
</ul>
<h3 data-id="heading-19">设计</h3>
<p>三层作用域解决不同场景的需求：</p>





























<table><thead><tr><th>作用域</th><th>存储位置</th><th>可见性</th><th>典型场景</th></tr></thead><tbody><tr><td>本地草稿</td><td>IndexedDB</td><td>仅当前设备</td><td>临时调试</td></tr><tr><td>个人云端</td><td>远程数据库</td><td>仅创建者</td><td>跨设备同步</td></tr><tr><td>团队共享</td><td>远程数据库</td><td>所有团队成员</td><td>标准测试数据</td></tr></tbody></table>
<p><strong>关键设计</strong>：</p>
<ol>
<li><strong>优先级和启用状态仅在本地维护</strong>：避免团队成员互相干扰</li>
<li><strong>云端只存期望内容</strong>：每个人独立控制"哪些期望启用、优先级如何排序"</li>
<li><strong>规则缓存</strong>：加载后缓存在 <code>window.__mockRulesCache</code>，避免重复读取 IndexedDB</li>
</ol>
<h3 data-id="heading-20">数据结构</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MockRule</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span>;  <span class="hljs-comment">// 1=本地草稿，2=个人云端，3=团队共享</span>
  <span class="hljs-attr">enabled</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 本地维护</span>
  <span class="hljs-attr">priority</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 本地维护</span>
  <span class="hljs-comment">// ... 其他字段</span>
}
</code></pre>
<h3 data-id="heading-21">事件通信</h3>
<p>SDK 与 UI 面板通过 CustomEvent 通信：</p>

























<table><thead><tr><th>事件名</th><th>方向</th><th>用途</th></tr></thead><tbody><tr><td><code>mock-request-end</code></td><td>SDK → UI</td><td>请求完成上报</td></tr><tr><td><code>mock-interface-switch</code></td><td>UI → SDK</td><td>单接口开关控制</td></tr><tr><td><code>mock-rules-updated</code></td><td>UI → SDK</td><td>规则更新通知</td></tr></tbody></table>
<h3 data-id="heading-22">数据清理</h3>
<p>自动清理 30 天未使用的本地数据，自动清理非活跃的数据 避免存储膨胀：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">await</span> <span class="hljs-title function_">cleanupInactiveData</span>(<span class="hljs-number">30</span>);
</code></pre>
<hr/>
<h2 data-id="heading-23">动态模板语法</h2>
<p>支持在 Mock 数据中引用请求参数，实现"响应随请求变化"：</p>



































<table><thead><tr><th>语法</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>{{Date.now()}}</code></td><td>当前时间戳</td><td><code>1706432400000</code></td></tr><tr><td><code>{{uuid()}}</code></td><td>生成 UUID</td><td><code>"a1b2c3d4-..."</code></td></tr><tr><td><code>{{request.query.xxx}}</code></td><td>获取 URL 参数</td><td><code>{{request.query.page}}</code></td></tr><tr><td><code>{{request.body.xxx}}</code></td><td>获取请求体字段</td><td><code>{{request.body.userId}}</code></td></tr><tr><td><code>{{request.headers.xxx}}</code></td><td>获取请求头</td><td><code>{{request.headers.token}}</code></td></tr></tbody></table>
<p>示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"requestId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{uuid()}}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{Date.now()}}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"userId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{request.body.userId}}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"page"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{request.query.page}}"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">快速开始</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 安装</span>
npm install <span class="hljs-meta">@zz</span>-common/ai_mock

<span class="hljs-comment">// 2. 初始化</span>
<span class="hljs-keyword">import</span> { mockInit } <span class="hljs-keyword">from</span> <span class="hljs-string">'@zz-common/ai_mock'</span>

<span class="hljs-title function_">mockInit</span>({
  <span class="hljs-attr">rules</span>: [<span class="hljs-string">'api.example.com'</span>],      <span class="hljs-comment">// 拦截的域名</span>
  <span class="hljs-attr">excludeRules</span>: [<span class="hljs-regexp">/static/</span>, <span class="hljs-regexp">/cdn/</span>]  <span class="hljs-comment">// 排除的资源</span>
})
</code></pre>
<h2 data-id="heading-25">推荐工作流</h2>
<p>下面演示从请求采集到 AI 生成 Mock 数据的完整流程：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/412918b4575440488ee46ab82d54fb31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2s6L2s5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770863944&amp;x-signature=%2BY5Ha6UIl1%2Bn86hwo0z%2B0DpXwjY%3D" alt="24182e81-01bc-11f1-83a0-e2f0e015208e.gif" loading="lazy"/></p>
<ol>
<li><strong>接入 npm 包</strong>：在非生产环境启用拦截</li>
<li><strong>从真实请求创建 Mock</strong>：打开面板，点击请求日志的"创建期望"</li>
<li><strong>配置参数条件</strong>：同一接口不同参数返回不同数据</li>
<li><strong>AI 生成补充</strong>：用 AI 生成符合业务语义的数据</li>
<li><strong>团队共享</strong>：将稳定的测试数据推送到团队共享</li>
</ol>
<hr/>
<h2 data-id="heading-26">总结</h2>
<p>本文介绍的 Mock 工具解决了四个核心问题：</p>

























<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>请求拦截</td><td>Monkey Patch 重写 XHR/Fetch，通过 WeakMap 防递归</td></tr><tr><td>规则匹配</td><td>支持 5 种参数位置 × 8 种操作符，按优先级排序</td></tr><tr><td>数据质量</td><td>AI 根据接口文档的 description、字段名语义生成数据</td></tr><tr><td>团队共享</td><td>三层作用域，本地维护启用状态和优先级</td></tr></tbody></table>
<p>目前这套工具已在公司内部使用，可以减少联调阻塞、提高场景覆盖率。</p>
<h2 data-id="heading-27">未来规划</h2>
<ul>
<li><strong>流量录制回放</strong>：基于真实流量生成 Mock 数据，数据更贴近线上场景</li>
<li><strong>AI生成数据时基于真实数据</strong>：进一步提升AI生成数据质量 贴近真实业务场景</li>
<li><strong>移动端支持</strong>：真机环境下配合 PC 端使用 Mock 数据验证</li>
<li><strong>规则推荐</strong>：基于历史请求，自动推荐可能需要的 Mock 场景</li>
</ul>
<blockquote>
<p>转转研发中心及业界小伙伴们的技术学习交流平台，定期分享一线的实战经验及业界前沿的技术话题。 关注公众号「转转技术」（综合性）、「大转转FE」（专注于FE）、「转转QA」（专注于QA），更多干货实践，欢迎交流分享~</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows 也能跑 OpenClaw！最完整安装教程 + 飞书接入，全程避坑]]></title>    <link>https://juejin.cn/post/7603142147642196011</link>    <guid>https://juejin.cn/post/7603142147642196011</guid>    <pubDate>2026-02-05T07:58:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603142147642196011" data-draft-id="7603030564837392438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows 也能跑 OpenClaw！最完整安装教程 + 飞书接入，全程避坑"/> <meta itemprop="keywords" content="程序员,AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-02-05T07:58:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="别惹CC"/> <meta itemprop="url" content="https://juejin.cn/user/4095037267779687"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows 也能跑 OpenClaw！最完整安装教程 + 飞书接入，全程避坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4095037267779687/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    别惹CC
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T07:58:42.000Z" title="Thu Feb 05 2026 07:58:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    22
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>⚠️ 小贴士：在开始之前，有一个非常重要的提醒：由于此类工具涉及自动化操作和环境配置，如果你的电脑存有重要的商业/资产或个人隐私信息，<strong>强烈建议弄一台干净的备用设备，或者直接租用一个云端虚拟机（VPS）来运行。</strong> 这样既能保护隐私，也能避免环境冲突。</p>
</blockquote>
<p>最近 <strong>OpenClaw</strong> 热度很高，但官方对 <strong>Windows 原生环境</strong>并不算友好，很多人会卡在 Node 环境、权限、路径、插件安装等问题上。下面我把自己完整跑通的流程整理成一篇“照做就能成”的教程：从环境准备 → OpenClaw 安装 → 初始化配置 → <strong>接入飞书机器人</strong>，最后再补一份常用排错命令。</p>
<h2 data-id="heading-0">一、环境准备</h2>
<h3 data-id="heading-1">1）安装 nvm for Windows（建议用最新版）</h3>
<p><strong>Windows 用户</strong> 到 GitHub Releases 下载 <code>nvm-setup.exe</code>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcoreybutler%2Fnvm-windows%2Freleases" target="_blank" title="https://github.com/coreybutler/nvm-windows/releases" ref="nofollow noopener noreferrer">github.com/coreybutler…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37bc339dcc8c43cb9bb38a0668f7fcaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=Q6lBtDlUjyc3vQNc1NP0QO8ayqo%3D" alt="1.png" loading="lazy"/></p>
<p>安装过程一路 Next 即可。安装成功后建议你用 <strong>管理员权限</strong>打开 PowerShell：</p>
<ul>
<li>按 <strong>Win 键 + S</strong></li>
<li>搜索 <strong>PowerShell</strong></li>
<li>鼠标右键 → <strong>以管理员身份运行</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18d05ee8ba88475bb627d4c764fcfb60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=i4b8aliQj5Ut7P9bamHVH9HGBKY%3D" alt="2.png" loading="lazy"/></p>
<h3 data-id="heading-2">2）安装 node.js 22.22.0 版本</h3>
<p>按照顺序分别在 <code>powershell</code> 中运行下列指令。</p>
<pre><code class="hljs language-powershell" lang="powershell"># 安装指令
nvm install 22

# 使用指令
nvm use 22.22.0
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a96291aab9274019af9d0cd804cae559~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=miqHTIbR1V5uVKInOeujWdNNeBc%3D" alt="3.png" loading="lazy"/></p>
<p>成功后会看到类似提示：<code>Now using node v22.22.0</code></p>
<blockquote>
<p>如果你仍然下载失败，或者公司网络拦截了下载，也可以手动去官网下载安装：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fzh-cn%2Fdownload" target="_blank" title="https://nodejs.org/zh-cn/download" ref="nofollow noopener noreferrer">nodejs.org/zh-cn/downl…</a></p>
</blockquote>
<h2 data-id="heading-3">二、安装 + 配置 OpenClaw</h2>
<h3 data-id="heading-4">1）一键安装（PowerShell）</h3>
<p>在 <strong>管理员 PowerShell</strong> 中运行：</p>
<pre><code class="hljs language-powershell" lang="powershell">iwr -useb https://openclaw.ai/install.ps1 | iex
</code></pre>
<p>如果遇到执行策略报错（常见于首次运行脚本），在 PowerShell 输入：</p>
<pre><code class="hljs language-powershell" lang="powershell">Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1e1a8aa13404874aa31b1b8a71fcaec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=jxvG0Nzfj14RiqxsCL%2FCNgaVczE%3D" alt="4.png" loading="lazy"/></p>
<h3 data-id="heading-5">2）初始化配置</h3>
<p>安装完成后通常会自动进入配置流程。
如果你不小心关闭了 PowerShell，重新打开后执行：</p>
<pre><code class="hljs language-powershell" lang="powershell">openclaw onboard --flow quickstart
</code></pre>
<p>第一个风险提示：</p>
<blockquote>
<p>I understand this is powerful and inherently risky. Continue?</p>
</blockquote>
<p>选择 <strong>Yes</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fb74ec6a75441f7b11b96f96ba4dfc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=JWjuEX4E9xKQX9nSm1Iw85pT1mE%3D" alt="5.png" loading="lazy"/></p>
<p>如果有小伙伴遇到这个问题：系统不知道它被安装在哪里了。处理方式通常很简单：</p>
<blockquote>
<ul>
<li><strong>关闭当前 PowerShell</strong></li>
<li><strong>重新用管理员方式打开 PowerShell</strong></li>
<li>一般 <code>nvm</code>/环境变量会自动刷新路径，问题即可消失</li>
</ul>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49925214147e446f90a6c7c403e07ce4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=mG9Z1GH9drEfOgIk%2BylLL5eyrQg%3D" alt="7.png" loading="lazy"/></p>
<p>之后按提示选择模型。我这里示例用的是 <strong>Kimi</strong>，你也可以按自己习惯选择。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/605f91a9d9924256a68a83d883dff7ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=qhnQ3Ebjxwgeh9NLaZba970L06I%3D" alt="8.png" loading="lazy"/></p>
<p>可以看下配置，主要输入API  key，其他都可以默认。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e19602e5230742e284b0e69ad4c0d020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=woNnCQLgHmdWa1v3un6lrm55idQ%3D" alt="9.png" loading="lazy"/></p>
<p>接着配置通讯工具，虽然官方这里直接可以选飞书，但官方文档明确建议 <strong>Windows 通过 WSL2 运行</strong>，并且提到原生 Windows 未测试、更容易出问题。并且我实测这里下载插件会报错，所以我们这里先跳过，后续再安装。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a7ad10229ca4b329d81bb6adb4e9b6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=VmZC7Vc98cRaRz9Y%2BsYGUVMQWz8%3D" alt="11.png" loading="lazy"/></p>
<p>skill也先跳过，后续咱们在使用过程中根据自己的工作流慢慢迭代自己的skill。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc4331d063754f92ad641c657cda633d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=Smb9vF5H%2FuegUnNoMVlTFBDJOQQ%3D" alt="12.png" loading="lazy"/></p>
<p>安装启动网关后，它会自动新开一个 PowerShell 窗口，都不要关闭。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbbe48a09c064117aad539748ad8c130~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=hRn3BIKJDywlhdls%2BdHN26JvW6g%3D" alt="13.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b06d6a5211dc4b3baecb867c7e7b0360~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=iWEbZmPwuv%2BAkf33zm5GuFKAo50%3D" alt="14.png" loading="lazy"/></p>
<p>浏览器会自动打开控制台。后续你也可以直接访问：<a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A18789%2F" target="_blank" title="http://127.0.0.1:18789/" ref="nofollow noopener noreferrer">http://127.0.0.1:18789/</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b29ea936ddc1486eae25ec47ccaba6b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=sqiLd8A7OEiiSpl7YI9b7tc6nww%3D" alt="15.png" loading="lazy"/></p>
<p>发消息测试，有回复就说明安装成功：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b3db6be653243069073215c181f80e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=52tYS8iTN23Rl5eqr0cPXzf2jWo%3D" alt="16.png" loading="lazy"/></p>
<h2 data-id="heading-6">三、配置连接飞书</h2>
<p>整体思路是两步：</p>
<ol>
<li>在 OpenClaw 里安装飞书插件</li>
<li>在飞书开放平台创建应用 → 配权限/事件 → 发布版本 → 回到 OpenClaw 填 AppID/Secret</li>
</ol>
<h3 data-id="heading-7">1）安装飞书插件</h3>
<p>你可以在控制台里让它帮你执行安装命令：</p>
<pre><code class="hljs language-powershell" lang="powershell">openclaw plugins install @m1heng-clawd/feishu
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92eb563ef66046f99663e0b783cf7dc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=Y2drbEqAL4eNsL%2FaQ7RoWQITTq4%3D" alt="17.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8655dae9cb7d4f6a824d7afa1b40c46f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=WN%2Bp7RB%2FoZ3j%2BcZ1bLW3zjhMoAU%3D" alt="18.png" loading="lazy"/></p>
<blockquote>
<p>插件安装可能要等一会儿，这段时间你可以去飞书开放平台把应用先建好。</p>
</blockquote>
<h3 data-id="heading-8">2）飞书开放平台创建应用</h3>
<p>进入飞书开放平台：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2F%25EF%25BC%258C%25E5%2588%259B%25E5%25BB%25BA%25E4%25B8%2580%25E4%25B8%25AA%25E5%25BA%2594%25E7%2594%25A8%25EF%25BC%258C%25E5%25B9%25B6%25E6%25B7%25BB%25E5%258A%25A0%25E6%259C%25BA%25E5%2599%25A8%25E4%25BA%25BA%25E5%25BA%2594%25E7%2594%25A8%25E8%2583%25BD%25E5%258A%259B%25E3%2580%2582" target="_blank" title="https://open.feishu.cn/%EF%BC%8C%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%BA%94%E7%94%A8%EF%BC%8C%E5%B9%B6%E6%B7%BB%E5%8A%A0%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%BA%94%E7%94%A8%E8%83%BD%E5%8A%9B%E3%80%82" ref="nofollow noopener noreferrer">open.feishu.cn/，创建一个应用，并添加…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de92703fe3854d6a991f5d24628f0a3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=wXtD2oSWiRIX9%2BwDE7voeBctYME%3D" alt="19.png" loading="lazy"/></p>
<p>然后把 <strong>App ID</strong> 和 <strong>App Secret</strong> 复制出来备用：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/960d82e1c33546959f087c49364cf475~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=mRcf6dEw9jLlmAivmUhYkYSulyM%3D" alt="20.png" loading="lazy"/></p>
<p>把这两项提供给 OpenClaw ，让它完成配置：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30220fa6129047eba58d3c062163064e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=GVYpUb8XqyFrcl3AaJHIImGZs8k%3D" alt="20-1.png" loading="lazy"/></p>
<h3 data-id="heading-9">3）批量导入权限</h3>
<p>进入 <strong>权限管理</strong> → 找到「批量导入导出权限」→ 权限配置 JSON → 粘贴导入：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scopes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tenant"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"aily:file:read"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"aily:file:write"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"application:application.app_message_stats.overview:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"application:application:self_manage"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"application:bot.menu:write"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"contact:user.employee_id:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"corehr:file:download"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"event:ip_list"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:chat.access_event.bot_p2p_chat:read"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:chat.members:bot_access"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message.group_at_msg:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message.p2p_msg:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message:readonly"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:message:send_as_bot"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"im:resource"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"user"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"aily:file:read"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"aily:file:write"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"im:chat.access_event.bot_p2p_chat:read"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>导入完成后点击「确认新增权限」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb41ddaca6dc48fda9561c0ca1a96072~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=rszLgU3oPMIKwRJ9moLAs6ISxWE%3D" alt="21.png" loading="lazy"/></p>
<h3 data-id="heading-10">4）事件订阅</h3>
<p>进入「事件与回调」页面：</p>
<ul>
<li>「事件配置」→「订阅方式」</li>
<li>选择：<strong>使用长连接接收事件</strong></li>
<li>保存</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a900916b4654ffeb7ece91fae52d655~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=ESwmYT4KwMLq15pbt4NaInJTdSQ%3D" alt="22.png" loading="lazy"/></p>
<blockquote>
<p>如果提示“没有建立长连接”：</p>
<ul>
<li>先别慌，通常等 1～2 分钟再点保存就好</li>
<li>如果等很久仍不行，优先检查 <strong>OpenClaw 网关是否正常运行</strong>，并查看日志（下面第四部分给了命令）</li>
</ul>
</blockquote>
<h3 data-id="heading-11">5）添加接收消息事件</h3>
<p>在「事件配置」页面点击「添加事件」，搜索并添加：</p>
<ul>
<li><code>im.message.receive_v1</code></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfc212bebfeb4ddfa56522801cfd0234~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=GlZfyEQLruArpBwJzJJunFMB29I%3D" alt="23.png" loading="lazy"/></p>
<blockquote>
<p>不添加这个事件，机器人就无法收到你的消息。</p>
</blockquote>
<h3 data-id="heading-12">6）发布版本</h3>
<p>进入「版本管理与发布」：</p>
<ul>
<li>创建版本</li>
<li>发布</li>
</ul>
<p>只有发布后，前面的配置才会真正生效。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51bbee8f79aa438cba32668d7326cae5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=xmQmSlkFAVX2ti2ftOgm8q5510M%3D" alt="24.png" loading="lazy"/></p>
<p>然后在飞书里找到你刚创建的机器人，发送一条消息，它会自动回复一个配对码</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f7e0fa260f5419587638caa4a680261~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=4DI2yL%2FuZVyJXpFKuXMlqea5hyw%3D" alt="25.png" loading="lazy"/></p>
<p>复制这个配对码，打开 Clawdbot 的 Web UI（就是前面那个控制台），把配对码发给它，Clawdbot 会自动完成绑定。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f2177ca181c4b889deb7aab211272fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=%2BR0zUdiDGZQabkLfPvoODt72hfE%3D" alt="26.png" loading="lazy"/></p>
<p>绑定成功后，你就可以在飞书里跟 Clawdbot 愉快交流了，也可以把机器人拉到公司群里，让所有小伙伴都能用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/633ab41e53e347918d013af6c3c54c40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yir5oO5Q0M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770884825&amp;x-signature=oyyf1ayhQNPbpBWC1ZbSW0tN1gU%3D" alt="27.png" loading="lazy"/></p>
<h2 data-id="heading-13">四、常用命令（排查/修复必备）</h2>
<p>下面这些命令非常实用：配置过程中遇到卡死、插件异常、网关没起等问题，优先用它们自查。</p>
<pre><code class="hljs language-powershell" lang="powershell"># 启动网关
openclaw gateway start

# 重启网关（刷新机器人状态）
openclaw gateway restart

# 重置/更改 API 等配置
openclaw config

# 诊断检查
openclaw doctor

# 实时查看日志（强烈推荐：出 bug 基本都靠它定位）
openclaw logs follow
</code></pre>
<p>好了，这就是整个安装和配置流程。</p>
<p>如果你觉得对你有帮助的话，可以帮我点个赞👍，也可以转发给其他你觉得需要的朋友们。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[春哥的Agent通关秘籍05：工具调用 Function Calling【知识与思路篇】]]></title>    <link>https://juejin.cn/post/7602800677712019490</link>    <guid>https://juejin.cn/post/7602800677712019490</guid>    <pubDate>2026-02-05T00:14:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602800677712019490" data-draft-id="7602800677712003106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="春哥的Agent通关秘籍05：工具调用 Function Calling【知识与思路篇】"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-05T00:14:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="摸鱼的春哥"/> <meta itemprop="url" content="https://juejin.cn/user/1714893870865303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            春哥的Agent通关秘籍05：工具调用 Function Calling【知识与思路篇】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893870865303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    摸鱼的春哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:14:48.000Z" title="Thu Feb 05 2026 00:14:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><p>LLM 问世之后，很长一段时间，人们发现了很多用例可以证明：</p>
<blockquote>
<p>AI不行啊，不是人工智能，而是人工智障。</p>
</blockquote>
<p>比方说，最经典的一个问题就是：</p>
<pre><code class="hljs">7.11 和 7.9 哪个数字更大？
</code></pre>
<p><img src="https://pic.zhangshichun.top/pic/20260201161528631.png" alt="" loading="lazy"/></p>
<p>你也可以修改我们第一节课【春哥的Agent通关秘籍02：搭建环境及语言选择】里的 <code>check_env.py</code>代码，问AI："今天是几月几日？"</p>
<p><code>deepseek</code> 会自信地回答你：</p>
<p><img src="https://pic.zhangshichun.top/pic/20260201161737903.png" alt="" loading="lazy"/></p>
<p>早期的AI对于这样的用例毫无防备，闹了很多笑话。</p>
<p>但是，在Agent时代，这些根本不是问题，你可以稳定解决所有加减乘除，可以准确比较大小，可以知道今天是几月几日。</p>
<p>比如，无论你去deepseek官网，或者是豆包，提问"今天是几月几日？"</p>
<p>都能得到准确而正确的回答：</p>
<p><img src="https://pic.zhangshichun.top/pic/20260201161852635.png" alt="" loading="lazy"/></p>
<p>这是为什么？</p>
<p>因为官网和APP都利用了我们今天要学习的内容：Function Calling。</p>
<p><strong>工具调用</strong>。</p>
<h2 data-id="heading-0">一、Function Call的历史及现状</h2>
<p>为了解决早期大语言模型无法做精细活儿，无法应对准确计算和实时信息获取的问题。</p>
<p>2023年6月13日 ，<code>OPENAI</code> 在发布 gpt-4-0613 和 gpt-3.5-turbo-0613 版本时，推出了一项轰动世界的设计和能力：</p>
<p><strong>Function Calling</strong>。</p>
<h3 data-id="heading-1">发布这个功能之前</h3>
<p>开发者（包括早期的 LangChain 用户）想要让 AI 调用工具，必须使用 ReAct 模式。</p>
<p>做法：你在 System Prompt 里写一大段话：“你是一个可以使用工具的 AI。如果你想用计算器，请输出 Action: Calculator, Input: 1+1。”</p>
<p>痛点：</p>
<ul>
<li>
<p>不稳定：AI 经常忘了格式，或者多打了个标点符号。</p>
</li>
<li>
<p>解析难：开发者必须写复杂的正则表达式（Regex）去抓取 AI 的回复。</p>
</li>
<li>
<p>Token 浪费：你需要把工具的描述写在 Prompt 里，占用大量上下文。</p>
</li>
</ul>
<h3 data-id="heading-2">OpenAI的创新</h3>
<p>OpenAI 受Meta的Toolformer启发，通过微调（Fine-tuning），让模型在底层“原生”支持了调用外部工具的能力。</p>
<p>你不再需要在 Prompt 里求 AI “请按格式输出”。你只需要把 JSON Schema 传给 API，模型就能极度稳定地输出结构化的 JSON 调用指令。</p>
<p>可以说：<strong>Function Calling 是 OpenAI 将“学术界的 Tool Learning”转化为“工业级 API 标准”的产物。</strong></p>
<p>它标志着 AI Agent 开发从“手搓 Prompt 的黑客时代”进入了“标准化工程开发时代”。现在，Anthropic (Claude)、Google (Gemini)、DeepSeek 等主流模型厂商都跟随并支持了这一标准。</p>
<h2 data-id="heading-3">二、Function Calling 基本流程</h2>
<p>我画了一张图，给大家解释当用户输入“北京今天天气如何”之后，整个的架构流转：</p>
<p><img src="https://pic.zhangshichun.top/pic/20260201203345449.png" alt="" loading="lazy"/></p>
<p>你会发现一个重要的定律：</p>
<pre><code class="hljs language-sql" lang="sql">LLM 对于 Agent 而言，其实是无状态的。

当Agent朝LLM发起会话时，需要每次都携带历史记录，以完成多轮会话。

每次都需要携带注册到agent中的<span class="hljs-keyword">function</span>列表，每次都需要写代<span class="hljs-keyword">system</span> prompt。
</code></pre>
<p><img src="https://pic.zhangshichun.top/pic/20260201204006127.png" alt="" loading="lazy"/></p>
<blockquote>
<p>你可以把它想象成电影《初恋50次》里的女主角，或者是一条只有 7 秒记忆的金鱼。 无论你们之前聊得多么热火朝天，当你发起的 HTTP 请求结束那一刻，它就把你彻底忘了。</p>
</blockquote>
<p>因此，这带来了三个很大的负担问题：</p>
<ol>
<li>人设负担
<ul>
<li>每次会话都要重新声明一次人设，不然LLM就会不知道该信息。</li>
</ul>
</li>
<li>技能树负担
<ul>
<li>每次会话都要重新声明一次所有Agent拥有的全技能Json Schema，这会占用巨大的Token。</li>
</ul>
</li>
<li>记忆负担
<ul>
<li>随着对话进行，messages 列表会越来越长。</li>
</ul>
</li>
</ol>
<p>这会导致以下几个问题：</p>
<ul>
<li>费钱：LLM 是按 Input Token 收费的。第 1 句的历史，在第 100 轮对话时被重复计费了 100 次。</li>
<li>变慢：处理的文字越多，首字延迟（TTFT）越高。</li>
<li>溢出：一旦超过模型的上下文上限（比如 32k 或 128k），模型就会报错或强制截断，导致“失忆”。</li>
<li>变蠢：一旦token过长，LLM在巨大的token里关于会话里的关键信息的注意力会被稀释。</li>
</ul>
<p>如何解决这个问题，是所有Agent开发必须面对的。这里不过多展开了，先提一下。</p>
<p><img src="https://pic.zhangshichun.top/pic/20260202181054274.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">三、工具定义与注册</h2>
<p>在让AI知道应该在何时调用工具的第一步，相当于你需要在每次会话里附带一个目录，告诉AI：</p>
<blockquote>
<p>嗨，牢A，我这里有一个名叫<code>get_current_time</code>的工具，它是个方法，作用是“获取当前准确的时间”。</p>
</blockquote>
<p>这样，当没有记忆的LLM面对“当前准确时间是什么”的时候，它才会知道要调用这个工具。</p>
<p>很巧，上节课我们才介绍了 JSON Schema，这节课的 <code>Function Calling</code> 注册工具，也需要用到JSON Schema。</p>
<p>但它不是完全标准的 JSON Schema，你可以先看看结构：</p>
<pre><code class="hljs language-python" lang="python">tools = [
    {
        <span class="hljs-comment"># 1. 类型：目前仅支持 "function"</span>
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
        <span class="hljs-comment"># 2. 函数定义主体</span>
        <span class="hljs-string">"function"</span>: {
            <span class="hljs-comment"># 2.1 (必填) 函数名</span>
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"..."</span>,
            <span class="hljs-comment"># 2.2 (强烈推荐) 给 AI 看的函数说明书</span>
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"..."</span>,
            <span class="hljs-comment"># 2.3 (必填) 参数定义，遵循 JSON Schema 标准</span>
            <span class="hljs-string">"parameters"</span>: {        
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: { ... },
                <span class="hljs-string">"required"</span>: [...]
            },
            <span class="hljs-comment"># (可选) DeepSeek/OpenAI 支持的严格模式，设为 True 强制输出符合 Schema</span>
            <span class="hljs-string">"strict"</span>: <span class="hljs-literal">True</span> 
        }
    }
]
</code></pre>
<p>如果想找官方文档的话，国内开发者优先建议参考 <code>deepseek</code> 的 <code>Function Calling</code> 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi-docs.deepseek.com%2Fzh-cn%2Fguides%2Ffunction_calling" target="_blank" title="https://api-docs.deepseek.com/zh-cn/guides/function_calling" ref="nofollow noopener noreferrer">api-docs.deepseek.com/zh-cn/guide…</a></p>
<p>其中提到：</p>
<blockquote>
<p>用户需要设置 base_url="<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.deepseek.com%2Fbeta" target="_blank" title="https://api.deepseek.com/beta" ref="nofollow noopener noreferrer">api.deepseek.com/beta</a>" 来开启 Beta 功能</p>
</blockquote>
<p>嗯，看到这里，我们可以默默地去修改一下我们 <code>.env</code> 文件的 BASE_URL 参数，以求获得更稳定的返回结构。</p>
<p>另外还可以参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.openai.com%2Fdocs%2Fguides%2Ffunction-calling" target="_blank" title="https://platform.openai.com/docs/guides/function-calling" ref="nofollow noopener noreferrer">platform.openai.com/docs/guides…</a></p>
<p>让我们根据上面学到的，随手注册两个工具方法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定义工具列表 </span>
tools = [
    <span class="hljs-comment"># 方法A：获取当前精准时间</span>
    {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
        <span class="hljs-string">"function"</span>: {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"get_current_time"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"获取当前精确时间"</span>,
            <span class="hljs-string">"parameters"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>, <span class="hljs-string">"properties"</span>: {}}
        }
    },
    <span class="hljs-comment"># 方法B：计算两个数的乘积</span>
    {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"function"</span>,
        <span class="hljs-string">"function"</span>: {
            <span class="hljs-string">"name"</span>: <span class="hljs-string">"calculate_multiply"</span>,
            <span class="hljs-string">"description"</span>: <span class="hljs-string">"计算两个数的乘积"</span>,
            <span class="hljs-string">"parameters"</span>: {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"a"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"第一个数字"</span>},
                    <span class="hljs-string">"b"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"第二个数字"</span>}
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>]
            }
        }
    }
]
</code></pre>
<p>有了 <code>Schema</code>，如何添加到会话里去呢？</p>
<p>非常简单！</p>
<pre><code class="hljs language-python" lang="python">response = client.chat.completions.create(
    model=<span class="hljs-string">"deepseek-chat"</span>,
    messages=messages,
    tools=tools, <span class="hljs-comment"># 【关键】把工具箱递给它</span>
)
</code></pre>
<h2 data-id="heading-5">四、识别AI的返回，调用具体的方法</h2>
<p>刚刚我们在请求里附带了tools清单。</p>
<p>那么，怎么识别AI在什么时候需要调用我们的tools呢?</p>
<p>很简单：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 获取 AI 的回复消息</span>
ai_msg = response.choices[<span class="hljs-number">0</span>].message
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"ai_msg.tool_calls：<span class="hljs-subst">{ai_msg.tool_calls}</span>"</span>)
</code></pre>
<p>在ai_msg这个LLM 返回值信息里，我们需要重点关注 <code>ai_msg.tool_calls</code> 这个字段。</p>
<p>如果它是None或者空数组，则表示AI没有想要调用的<code>Function</code>，否则的话，即代表：</p>
<blockquote>
<p>刚才这一次会话，AI没有得到结论，而是希望调用一个或者多个Function。</p>
</blockquote>
<p>所以，我们可以先写出如下的大致逻辑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> ai_msg.tool_calls:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🤖 AI 决定调用工具！"</span>)
    
    <span class="hljs-comment"># 必须把 AI 的这句“我想调用工具”加入对话历史</span>
    <span class="hljs-comment"># 否则后面通过工具结果回复时，AI 会失忆</span>
    messages.append(ai_msg)

    <span class="hljs-comment"># === 你的代码介入：执行工具 ===</span>
    <span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> ai_msg.tool_calls:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🤖 AI 决定调用工具: <span class="hljs-subst">{tool_call.function.name}</span>"</span>)
        func_name = tool_call.function.name
        <span class="hljs-comment"># 解析参数 (JSON 字符串 -&gt; 字典)</span>
        func_args = json.loads(tool_call.function.arguments)
<span class="hljs-keyword">else</span>:
    <span class="hljs-comment"># AI 觉得不需要工具，直接回答</span>
    <span class="hljs-keyword">return</span> ai_msg.content
</code></pre>
<p>拿到方法名与方法参数后，接下来要做的就是执行方法，得到结果，这一点连刚接触编程的新手都知道怎么写了。</p>
<p>拿到结果后，只需要再次执行：</p>
<pre><code class="hljs language-ini" lang="ini">messages.append({
    "role": "tool",
    "tool_call_id": tool_call.id,
    "content": tool_result
})
<span class="hljs-comment"># === 第二轮交互 ===</span>
<span class="hljs-attr">final_response</span> = client.chat.completions.create(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"deepseek-chat"</span>,
    <span class="hljs-attr">messages</span>=messages,
    <span class="hljs-attr">tools</span>=tools
)
</code></pre>
<p>为什么这里的第二轮交互里还要带上 <code>tools</code>？</p>
<p>因为Agent并不知道LLM是否会再发起一次Function Calling，如果不携带tools，LLM就非常可能在遇到问题时无奈地瞎编或者报错。</p>
<p>所以，很显然，我们需要递归，或者循环。</p>
<p>这就涉及到了一个新的，深刻的，重要的，难以规避的核心问题：</p>
<blockquote>
<p>在Agent开发中，应该如何统一AI的思考与行动，并巧妙设计这个循环。</p>
</blockquote>
<p>下一节课再见！</p>
<h2 data-id="heading-6">下一步预告</h2>
<p>下节课，我们将探索 Agent 编程的一个核心问题：</p>
<blockquote>
<p>思考范式。</p>
</blockquote>
<p>敬请期待！</p>
<p><img src="https://pic.zhangshichun.top/pic/ScreenShot_2026-01-26_082327_821.png" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[10万数据点可视化：Echarts性能优化实战]]></title>    <link>https://juejin.cn/post/7602834985902145586</link>    <guid>https://juejin.cn/post/7602834985902145586</guid>    <pubDate>2026-02-05T00:37:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602834985902145586" data-draft-id="7602910573404553254" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="10万数据点可视化：Echarts性能优化实战"/> <meta itemprop="keywords" content="ECharts,性能优化"/> <meta itemprop="datePublished" content="2026-02-05T00:37:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谢小飞"/> <meta itemprop="url" content="https://juejin.cn/user/2717648473034823"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            10万数据点可视化：Echarts性能优化实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648473034823/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谢小飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:37:54.000Z" title="Thu Feb 05 2026 00:37:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><p>　　最近在工作中遇到了一个颇具挑战的需求，需要在Web页面上通过Echarts图表渲染超过10万条点位数据。对于前端开发来说，大数据量的可视化渲染一直是个棘手的问题，尤其是当数据量达到10万级别时，不仅浏览器请求响应速度变慢，浏览器的渲染性能瓶颈会变得非常明显；因此，本文我们就看下如果在工作中遇到这种场景，应该如何处理。</p>
<p>　　首先介绍一下实际的场景，我们团队最近接到一个物联网设备数据分析需求：业务方需要查看特定设备一段时间范围内的运行状态趋势。这看起来似乎是个简单的折线图需求，但当我们深入了解数据规模时，发现了巨大的挑战。</p>
<p>　　首先是业务方要求不限制时间范围，例如可以跨数年的范围，从2021年到2025年；这对我们前后端来说，意味着查询和渲染数据量会非常庞大，因为设备采集一般都是按照固定的时间频率采集的；比如如果设备每隔15分钟就会采集发送一次数据，一天的数据量就是24小时 × (60分钟/15分钟) = 96个数据点/天，如果查询4年的数据就是4年* 365天* 96个数据点 = 14余万条数据。</p>
<p>　　业务人员给我们的需求很明确："我们需要在这张图上看到四年的完整趋势，能够快速发现异常波动，并且可以随意缩放查看任意时间段的细节"。他们补充道："之前试过按天聚合的数据，但那样会丢失很多重要信息。比如设备在某个具体时间点的瞬时异常，在日度数据中就看不出来了。"</p>
<p>　　我们最初的尝试非常直接，一次性加载所有的数据，然后通过Echarts渲染。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9f9c7295154459fa6306939e5b45d0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=7dN38vp3w2aDzjwTpSYRaEZujqw%3D" alt="一次性加载" loading="lazy"/></p>
<p>　　但是请求接口的时间就达到了14秒，数据响应时浏览器内存占用激增，非常容易崩溃卡死，完全没有用户体验可言。</p>
<h2 data-id="heading-0">数据分割：化整为零的策略</h2>
<p>　　于是，根据业务需求，我们首先尝试数据分割，将数据按天维度进行分割，然后分别请求数据；下面是分割的核心函数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> dayjs <span class="hljs-keyword">from</span> <span class="hljs-string">"dayjs"</span>;
<span class="hljs-comment">/**
 * 按指定天数分割日期区间
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} startDate 开始日期
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} endDate 结束日期
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} num 分割天数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">separateDate</span>(<span class="hljs-params">startDate, endDate, num = <span class="hljs-number">180</span></span>) {
  <span class="hljs-comment">// 使用dayjs.js创建日期对象</span>
  <span class="hljs-keyword">const</span> start = <span class="hljs-title function_">dayjs</span>(startDate);
  <span class="hljs-keyword">const</span> end = <span class="hljs-title function_">dayjs</span>(endDate);

  <span class="hljs-comment">// 验证日期有效性</span>
  <span class="hljs-keyword">if</span> (!start.<span class="hljs-title function_">isValid</span>() || !end.<span class="hljs-title function_">isValid</span>()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'无效的日期格式'</span>);
  }

  <span class="hljs-comment">// 确保开始日期早于或等于结束日期</span>
  <span class="hljs-keyword">if</span> (start.<span class="hljs-title function_">isAfter</span>(end)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'开始日期不能晚于结束日期'</span>);
  }

  <span class="hljs-comment">// 计算总天数</span>
  <span class="hljs-keyword">const</span> totalDays = end.<span class="hljs-title function_">diff</span>(start, <span class="hljs-string">'days'</span>);

  <span class="hljs-comment">// 如果总天数小于等于最大分割天数，直接返回一个区间</span>
  <span class="hljs-keyword">if</span> (totalDays &lt;= num) {
    <span class="hljs-keyword">return</span> [
      {
        <span class="hljs-attr">segmentStartDate</span>: start.<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD'</span>),
        <span class="hljs-attr">segmentEndDate</span>: end.<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD'</span>),
        <span class="hljs-attr">segmentStartDay</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">segmentEndDay</span>: totalDays,
      },
    ];
  }
}
</code></pre>
<p>　　在处理时，我们会先校验参数格式并计算总天数，若总天数未超过最大分割天数，则将直接返回该日期区间，不再进行分割处理。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">separateDate</span>(<span class="hljs-params">startDate, endDate, num = <span class="hljs-number">180</span></span>) {
  <span class="hljs-comment">// 省略其他代码...</span>

  <span class="hljs-comment">// 计算需要分割的区间数量</span>
  <span class="hljs-keyword">const</span> numIntervals = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(totalDays / num);

  <span class="hljs-keyword">const</span> result = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; numIntervals; i++) {
    <span class="hljs-comment">// 计算当前区间的开始日期</span>
    <span class="hljs-keyword">const</span> iStart = start.<span class="hljs-title function_">clone</span>().<span class="hljs-title function_">add</span>(i * num, <span class="hljs-string">'days'</span>);

    <span class="hljs-comment">// 计算当前区间的结束日期（最后一个区间使用实际结束日期）</span>
    <span class="hljs-keyword">const</span> iEnd = i === numIntervals - <span class="hljs-number">1</span> ? end : start.<span class="hljs-title function_">clone</span>().<span class="hljs-title function_">add</span>((i + <span class="hljs-number">1</span>) * num - <span class="hljs-number">1</span>, <span class="hljs-string">'days'</span>);

    <span class="hljs-comment">// 确保结束日期不超过实际结束日期</span>
    <span class="hljs-keyword">const</span> actualEnd = iEnd.<span class="hljs-title function_">isAfter</span>(end) ? end : iEnd;

    <span class="hljs-comment">// 计算相对于开始日期的天数</span>
    <span class="hljs-keyword">const</span> segmentStartDay = iStart.<span class="hljs-title function_">diff</span>(start, <span class="hljs-string">'days'</span>);
    <span class="hljs-keyword">const</span> segmentEndDay = actualEnd.<span class="hljs-title function_">diff</span>(start, <span class="hljs-string">'days'</span>);

    result.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">segmentStartDate</span>: iStart.<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD'</span>),
      <span class="hljs-attr">segmentEndDate</span>: actualEnd.<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD'</span>),
      segmentStartDay,
      segmentEndDay,
    });
  }

  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>　　然后通过<code>Math.ceil</code>将数字向上舍入到最接近的整数，得到numIntervals，也就是我们区间的数量。此外在separateDate返回的数据每个分片中，包含了segmentStartDay和segmentEndDay，对应了时间区间的开始和结束的天数，方便后续的数据合并处理。</p>
<p>　　这里<code>separateDate函数</code>是我们整个优化方案的核心基础，它将长时间跨度的数据请求分解为多个可管理的子请求；startDate和endDate接收日历📅组件传入的用户选择的开始和结束日期；num参数默认设置为180天，这个值基于我们后端响应效率和速度的最优分段时长，如果单个时间跨度太长，则达不到分段的效果，而如果太短，则分段数量过多，请求次数太频繁。</p>
<p>　　正是基于separateDate函数分割出的这些独立、合规的日期区间，我们后续的所有优化操作才得以展开；接下来，每一个子区间的数据会进行独立的处理和加载，从而将原本庞大而笨重的单次请求，转化为一次次高效、可管理的并行任务流。</p>
<h2 data-id="heading-1">WebWorker：开辟“第二战线”</h2>
<p>　　在上一节，我们实现了数据的分割，成功将14万+的数据请求分解为多个小请求；但是即使数据分片了，每一分片数据量仍然可能很大（最多180天×96个点/天=17280个点）；如果直接在主线程中处理这些数据，仍然会导致UI卡顿。这时候，Web Worker就派上用场了。</p>
<p>　　<code>Web Worker</code>是HTML5提供的API，允许在浏览器后台运行JavaScript脚本，与主线程并行执行。这意味着我们可以在Worker线程中执行繁重的数据处理任务，而不会阻塞用户界面；如果说主线程是“前台服务员”，既要响应客人（用户）的点击，又要去后厨炒菜（计算），那么Web Worker就是雇来的“专职后厨”；它有以下几个特点：</p>
<ul>
<li>独立线程：运行在独立的线程中，与主线程并行</li>
<li>无DOM访问权限：不能直接操作DOM或访问window对象</li>
<li>通过消息通信：与主线程通过postMessage和onmessage通信</li>
<li>生命周期独立：关闭标签页或Worker脚本执行完毕才会终止</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9ad8b7a99db4ff5999640a54f77f306~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=o9WAa3hD7Z2zGa3FtCCq%2FeAri4Q%3D" alt="WebWorker" loading="lazy"/></p>
<p>　　首先，我们需要创建一个专门处理数据的Worker文件<code>data-processor.worker.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript">self.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
  <span class="hljs-keyword">var</span> list = e.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>;

  <span class="hljs-keyword">const</span> listHandled = list.<span class="hljs-property">value</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> {
    <span class="hljs-comment">// 对数据进行一系列耗时计算</span>
  });

  self.<span class="hljs-title function_">postMessage</span>({
    <span class="hljs-attr">list</span>: listHandled,
  });
};
</code></pre>
<p>　　这里我们定义了一个专用Worker线程，负责执行所有阻塞型的计算任务，负责对数据进行一些耗时的处理，例如原始数据清洗、复杂指标计算等等，并返回处理后的数据；主线程则专注于UI交互与流畅渲染，仅在需要时（分割数据返回）向Worker派发任务并异步接收其返回的、可直接用于图表（如ECharts）的轻量化结果。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadEchartData</span>(<span class="hljs-params">rangeItem</span>) {
  <span class="hljs-keyword">const</span> { segmentStartDate, segmentEndDate } = rangeItem;
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchListData</span>({
    <span class="hljs-attr">startDate</span>: segmentStartDate,
    <span class="hljs-attr">endDate</span>: segmentEndDate,
  });
  <span class="hljs-keyword">if</span> (res &amp;&amp; res.<span class="hljs-property">data</span>) {
    <span class="hljs-keyword">const</span> { list } = res.<span class="hljs-property">data</span>;

    <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">"/data-processor.worker.js"</span>);
    worker.<span class="hljs-title function_">postMessage</span>({
      <span class="hljs-attr">data</span>: list,
    });
    worker.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
      <span class="hljs-keyword">const</span> { list } = e.<span class="hljs-property">data</span>;
      <span class="hljs-title function_">renderChart</span>(list);
    };
  }
}
</code></pre>
<p>　　我们将前面分割好的数据区间，分发为并发的数据请求进行加载。待数据返回后，主线程会实例化一个Worker线程，并通过postMessage函数，将原始数据调度至Worker进行后续处理。</p>
<p>　　这里还涉及一个数据返回后拼接的问题，我们在循环调用loadEchartData请求数据时，由于是异步返回，分片数据返回的时候，数据会乱序返回，因此不能直接通过数组的push来添加数据。</p>
<p>　　我们在全局定义x轴和y轴两个数组，在页面初始化的时候，根据业务需求，提前预估计算出数组的长度，并使用默认数据进行填充：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">_xList</span>: <span class="hljs-built_in">string</span>[] = []
<span class="hljs-keyword">const</span> <span class="hljs-attr">_yList</span>: <span class="hljs-built_in">number</span>[] = []

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; diffDay; i++) {
    <span class="hljs-keyword">const</span> nowDate = <span class="hljs-title function_">dayjs</span>(startDate.<span class="hljs-property">value</span>).<span class="hljs-title function_">add</span>(i, <span class="hljs-string">'days'</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">96</span>; j++) {
        _xList.<span class="hljs-title function_">push</span>(
            nowDate.<span class="hljs-title function_">add</span>(i * <span class="hljs-number">15</span>, <span class="hljs-string">'minutes'</span>)
            .<span class="hljs-title function_">format</span>(<span class="hljs-string">'YYYY-MM-DD HH:mm'</span>)
        )
        _yList.<span class="hljs-title function_">push</span>(<span class="hljs-number">0</span>)
    }
}
</code></pre>
<p>　　当响应数据返回后，我们只需要将数据添加到对应的位置即可：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadEchartData</span>(<span class="hljs-params">rangeItem</span>) {
  <span class="hljs-keyword">const</span> { segmentStartDay } = rangeItem;
  <span class="hljs-keyword">if</span> (res &amp;&amp; res.<span class="hljs-property">data</span>) {
    <span class="hljs-keyword">const</span> { list } = res.<span class="hljs-property">data</span>;
    <span class="hljs-keyword">const</span> startIndex = segmentStartDay * <span class="hljs-number">96</span>;
    <span class="hljs-comment">// 在对应索引处添加数据</span>
    _yList.<span class="hljs-title function_">splice</span>(startIndex, list.<span class="hljs-property">length</span>, ...list);
  }
}
</code></pre>
<h2 data-id="heading-2">Echarts渲染优化：让大数据飞起来</h2>
<p>　　至此，我们已经通过分割、处理与加载的优化，为海量数据的渲染搭建了一条高效的前置管线。。然而，当数据最终抵达浏览器并准备在ECharts中绘制时，性能的“最终挑战”才真正开始。如何让ECharts“消化”这数万个数据点并保持流畅交互？本节将深入ECharts的渲染层，拆解那些让图表“飞起来”的关键优化策略。</p>
<p>　　在大数据量的前提下，我们首先需要确保，echarts的渲染器是canvas而不是SVG，因为SVG图像在处理复杂图形时可能会导致性能问题，因此确保你的图表使用canvas进行渲染：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// renderer不是svg</span>
echarts.<span class="hljs-title function_">init</span>(domElement, <span class="hljs-literal">null</span>, { <span class="hljs-attr">renderer</span>: <span class="hljs-string">'canvas'</span> });
</code></pre>
<h3 data-id="heading-3">降采样策略</h3>
<p>　　什么是数据采样？数据采样是ECharts中处理大数据量的优化技术，当图表需要展示的数据点过多时（通常超过几千个点），浏览器渲染性能会显著下降。采样算法可以在保持图表大致趋势不变的前提下，减少实际渲染的数据点数。</p>
<p>　　例如，通过对一万个原始数据点进行分层抽样，我们将渲染节点的数量直接从10,000个缩减至1,000个。这一优化直接带来了渲染性能的激增，帧率得到显著提升。Echarts提供了多种数据采样算法，包括如下：</p>
<ul>
<li>sum：取过滤点的和</li>
<li>average：取过滤点的平均值</li>
<li>min： 取过滤点的最小值</li>
<li>max： 取过滤点最大的值</li>
<li>minmax：取过滤点绝对值的最大极值 (从 v5.5.0 开始支持)</li>
<li>lttb：采用<code>Largest-Triangle-Three-Bucket</code>算法，可以最大程度保证采样后线条的趋势，形状和极值。</li>
</ul>
<p>　　使用时，通过配置series的sampling属性，指定数据采样算法：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">series</span>: [
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"bar"</span>,
      <span class="hljs-attr">sampling</span>: <span class="hljs-string">"lttb"</span>,
      <span class="hljs-attr">data</span>: yourData,
    },
  ];
}
</code></pre>
<p>　　我们对柱状图进行lttb算法采样后，效果如下，我们能够明显看到柱子的密度有些稀疏：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9fd6c129a4f42cea9dbfdfad8fc2bc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=VFD4Bhg7AkvSr7S7evzj%2BaXHSa0%3D" alt="柱状图的lttb采样效果" loading="lazy"/></p>
<blockquote>
<p><strong>需要注意</strong>的是，数据经过采样后，数据点会减少，采样会丢失细节，因此不适合需要精确值的场景；同时由于数据点的减少，一些图表的交互功能，如tooltip，也会受到影响。</p>
</blockquote>
<p>　　针对折线图，我们也应用了lttb算法进行下采样。从如下效果图中可以观察到，算法在大幅减少数据点的同时，仍保持了原始曲线的核心趋势与形状，整体还原效果非常好。其主要误差出现在变化剧烈的边界区域或极值点附近，导致局部拟合不够平滑。</p>
<p>　　相较之下，在之前柱状图的测试中，lttb算法因会改变离散柱的分布位置而导致信息失真，因此它更适用于折线图这类强连续性的序列数据可视化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c923f7edcec4841820c839306104a05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=e56y8qdbKJhEXmeh%2FcjjLq5KPLc%3D" alt="折线图的lttb采样效果" loading="lazy"/></p>
<h4 data-id="heading-4">lttb算法原理</h4>
<p>　　鉴于LTTB算法在降采样中表现出的出色效果，我们有必要深入探究其核心实现原理。作为ECharts等主流可视化库采用的关键算法，其核心步骤是将数据点分组为多个连续的“桶”，并在每个桶内仅筛选一个最具代表性的点。那么，这个代表点是如何被选定的？要回答这个问题，关键在于理解其“最大三角形面积”的筛选准则。</p>
<pre><code class="hljs language-text" lang="text">数据点分布：
   ▲
   │                                  
   │             桶A          桶B          桶C
   │          ┌──────┐    ┌──────┐    ┌──────┐
   │          │      │    │      │    │      │
   │          │  •   │    │  •   │    │  •   │
   │          │  •   │    │  •   │    │  •   │
   │          │  • • │    │•  •  │    │  • • │
   │         •│ •  • │   •│•   • │   •│•   • │
   │       • •│•    •│ • •│•    •│• • │•    •│
   │     • •  │     •│• • │     •│• • │     •│
   │   • •    │      │• • │      │• • │      │
   └──────────┴──────┴────┴──────┴────┴──────┴──▶
   0          10     20    30     40    50     60
                 frameSize = 10个点/桶
</code></pre>
<p>　　我们第一个桶A的点选择初始位置的点，当我们开始选取下一个桶B时点时，再下一个桶C的点，我们暂定为这个桶的平均值；这样，我们前后桶的点都确定了，让我们回到桶B点的选择上来；这个时候，我们遍历桶B的所有点，计算ABC三个桶的点形成三角形的面积，并选择面积最大的点作为这个桶的点。</p>
<p>　　为什么面积大的点就能代表这个桶呢？我们想像一下，如果B点靠近了AC连线上，那么B点几乎就没有提供了新的信息了。</p>
<pre><code class="hljs language-text" lang="text">   A─────B─────C
面积 ≈ 0（三点几乎共线）
</code></pre>
<p>　　但是如果B点远离AC连线，那么B点就提供了新的信息，那么B点就可以代表这个桶的点。</p>
<pre><code class="hljs language-text" lang="text">         B
        / \
       /   \
      /     \
     A       C
面积很大，B点代表了重要特征
</code></pre>
<p>　　当我们已知二维平面上上三个点的坐标，利用初中的知识就能推导三角形的面积为：</p>
<blockquote>
<p>三角形面积 = 0.5 × |AB × AC| = 0.5 × |(x2-x1)(y3-y1) - (x3-x1)(y2-y1)|</p>
</blockquote>
<p>　　下面是一个简单的推导过程:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/620a8b7454224f43a51fef951efedc3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=l8uMBJfaWpv4o%2FZluo0OR0EIjdk%3D" alt="三角形面积公式" loading="lazy"/></p>
<p>　　我们访问Echarts仓库中查看源码，发现lttb算法代码在<code>src/data/DataStore.ts</code>的lttbDownSample函数中实现；有了上面理论的支撑，我们下面就来好好的拆解拆解这个函数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * Large data down sampling using largest-triangle-three-buckets
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">valueDimension</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">targetCount</span>
 */</span>
<span class="hljs-title function_">lttbDownSample</span>(<span class="hljs-params">
    valueDimension: DimensionIndex,
    rate: <span class="hljs-built_in">number</span>
</span>){
  <span class="hljs-comment">// 总数据点数，如 10000</span>
  <span class="hljs-keyword">const</span> len = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">count</span>();

  <span class="hljs-comment">// 每个桶的大小，如rate = 0.1，则frameSize = 10</span>
  <span class="hljs-keyword">const</span> frameSize = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-number">1</span> / rate);
}
</code></pre>
<p>　　首先上面的代码中，我们首先获取数据点的总数，并计算每个桶的大小；这里传入的valueDimension代表值的维度，如果直接传入数据列表，会导致内存占用过高，因此这里的做法是传入数据维度，通过维度来获取数据，从而提高性能。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; len - <span class="hljs-number">1</span>; i += frameSize) {
  <span class="hljs-comment">// 下一个桶的边界</span>
  <span class="hljs-keyword">const</span> nextFrameStart = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(i + frameSize, len - <span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> nextFrameEnd = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(i + frameSize * <span class="hljs-number">2</span>, len);

  <span class="hljs-comment">// 计算下一个桶的平均点</span>
  <span class="hljs-keyword">const</span> avgX = (nextFrameEnd + nextFrameStart) / <span class="hljs-number">2</span>; <span class="hljs-comment">// X坐标平均值</span>
  <span class="hljs-keyword">let</span> avgY = <span class="hljs-number">0</span>; <span class="hljs-comment">// Y坐标平均值</span>
}
</code></pre>
<p>　　然后我们开始遍历数据点，我们发现i是从1开始的，因为我们默认第一个点就是第一个桶的选择点；接着，在当前桶遍历下，我们先要计算出下一个桶C的平均点（avgX， avgY）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; len - <span class="hljs-number">1</span>; i += frameSize) {
  <span class="hljs-comment">// 省略上面代码</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> idx = nextFrameStart; idx &lt; nextFrameEnd; idx++) {
      <span class="hljs-comment">// 获取下一个桶上面每一个点的值</span>
      <span class="hljs-keyword">const</span> y = dimStore[rawIndex] <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;
      avgY += y <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;
  }
  avgY /= (nextFrameEnd - nextFrameStart);
}
</code></pre>
<p>　　然后，我们开始遍历下一个C桶中的每一个数据点，并计算出下一个桶的平均值。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> maxArea;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; len - <span class="hljs-number">1</span>; i += frameSize) {
  <span class="hljs-comment">// 当前桶的起始索引</span>
  <span class="hljs-keyword">const</span> frameStart = i;
  <span class="hljs-comment">// 当前桶的结束索引</span>
  <span class="hljs-keyword">const</span> frameEnd = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(i + frameSize, len);

  <span class="hljs-comment">// 上一个点的X坐标</span>
  <span class="hljs-keyword">const</span> pointAX = i - <span class="hljs-number">1</span>;
  <span class="hljs-comment">// 上一个点的Y值</span>
  <span class="hljs-keyword">const</span> pointAY = dimStore[currentRawIndex] <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;

  <span class="hljs-comment">// 当前桶最大的面积</span>
  maxArea = -<span class="hljs-number">1</span>;
}
</code></pre>
<p>　　紧接着，我们为当前桶B点的遍历准备一下数据，frameStart和frameEnd是当前桶B的边界，pointAX和pointAY是上一个桶A的坐标。</p>
<blockquote>
<p>我们发现这里的pointAX取得是上一个桶最后一个点的坐标i - 1，而不是每次都将上一个桶的选择点存起来使用，这其实是Echarts为了性能优化，牺牲了一点精度，减少变量跟踪。</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 循环遍历每个桶</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; len - <span class="hljs-number">1</span>; i += frameSize) {
  <span class="hljs-comment">// 省略上面代码</span>
  <span class="hljs-comment">// 循环遍历桶B中的数据点</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> idx = frameStart; idx &lt; frameEnd; idx++) {
    <span class="hljs-comment">// 当前点的X坐标</span>
    <span class="hljs-keyword">const</span> rawIndex = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRawIndex</span>(idx);
    <span class="hljs-comment">// 当前点的Y坐标</span>
    <span class="hljs-keyword">const</span> y = dimStore[rawIndex] <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;
    <span class="hljs-comment">// 计算三角形的面积</span>
    area = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>((pointAX - avgX) * (y - pointAY)
      - (pointAX - idx) * (avgY - pointAY)
    );
    <span class="hljs-keyword">if</span> (area &gt; maxArea) {
      maxArea = area;
      nextRawIndex = rawIndex;
    }
  }

  newIndices[sampledIndex++] = nextRawIndex;
}
</code></pre>
<p>　　最后这个代码是整个算法的核心代码,也是最精妙的地方；基于之前桶的循环，我们在当前桶内，遍历桶中每个数据点，rawIndex和y表示当前点的坐标；而这里的area就是我们上面介绍的三角形的计算公式，经过之前对于桶A、桶B、桶C的点准备，相信这里的area计算相信大家都能够理解了；最后如果area超出了记录的最大面积maxArea，则将当前点加入到新的采样数据中进行数据留存。</p>
<p>　　纸上得来终觉浅，算法的精妙，非得亲手试一下不可。为此，笔者写了一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fgallery.xieyufei.com%2Fcase%2Falgorithm%2Flttb" target="_blank" title="https://gallery.xieyufei.com/case/algorithm/lttb" ref="nofollow noopener noreferrer">简单的页面</a>来演示LTTB算法的实际效果，默认设置采样率rate为0.1，同时对折线图数据进行采样对比，就能看到和原始数据之间的细微差异：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68032c1dcb8c4c43a7dae545906e4145~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=f63zVFdEVw2%2Bhpm6bXwoEBljbME%3D" alt="手写lttb算法采样的效果" loading="lazy"/></p>
<h3 data-id="heading-5">dataZoom分块渲染</h3>
<p>　　在处理海量数据时，启用<code>dataZoom组件</code>是实现性能跃升的核心策略之一。它将渲染模式从一次性承载全量数据，转变为动态的窗口化渲染。初始化时仅加载视口范围内的数据，随着用户滚动或缩放再动态加载其他部分。这种方式将渲染压力分散到多次轻量级操作中，从根本上避免了单次渲染卡顿，大幅提升了交互响应速度。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> option = {
  <span class="hljs-attr">dataZoom</span>: [
    { 
      <span class="hljs-attr">type</span>: <span class="hljs-string">"inside"</span>,
      <span class="hljs-attr">start</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">end</span>: <span class="hljs-number">20</span>
    },
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"slider"</span>,
      <span class="hljs-attr">start</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">end</span>: <span class="hljs-number">20</span>,
    },
  ],
  <span class="hljs-attr">series</span>:[
    <span class="hljs-comment">//...</span>
  ]
};
</code></pre>
<p>　　然而，这里存在一个状态冲突问题，每次从接口获取新数据并重渲染图表时，dataZoom都会被强制重置到初始的[0, 20]区间。如果用户在之前已经通过拖拽缩放浏览了其他数据区域，这个行为就会破坏其探索状态，导致用户体验割裂。</p>
<p>　　第一种常规的解决方案是，我们在核心的图表渲染函数<code>renderChart</code>中引入一个守卫参数isInitial。只有当 isInitial 为 true（例如初次渲染时），才设置dataZoom的区间。在常规的数据更新渲染中，则保留用户当前交互状态，仅刷新数据而不触动缩放组件。</p>
<p>　　另一种解决方案是，在setOption时，使用<code>replaceMerge</code>参数，告诉ECharts只替换指定的组件，其他组件（如 dataZoom）保持不变：</p>
<pre><code class="hljs language-javascript" lang="javascript">echartsInst.<span class="hljs-title function_">setOption</span>({
  <span class="hljs-attr">dataZoom</span>: [
    { 
      <span class="hljs-attr">type</span>: <span class="hljs-string">"inside"</span>,
      <span class="hljs-attr">start</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">end</span>: <span class="hljs-number">20</span>
    },
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"slider"</span>,
      <span class="hljs-attr">start</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">end</span>: <span class="hljs-number">20</span>,
    },
  ],
  <span class="hljs-attr">series</span>:[
    <span class="hljs-comment">//...</span>
  ]
}, {
  <span class="hljs-attr">notMerge</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">replaceMerge</span>: [<span class="hljs-string">"xAxis"</span>, <span class="hljs-string">"series"</span>],
})
</code></pre>
<p>　　这样即使多次setOption也不会重置dataZoom的区间。</p>
<h3 data-id="heading-6">大数据模式与渐进式渲染</h3>
<p>　　经常查看Echarts官方文档的小伙伴，相信都看到过large和progressive等属性，但是什么情况下需要用到large和progressive呢？相信很多小伙伴都一头雾水，这一节，我们就来好好说道说道。</p>
<p>　　<code>large属性</code>是ECharts为海量数据渲染设计的专用性能优化开关，通常指数据量在数万到数百万级别； 当你的数据量预计达到此规模时，开启此选项将直接调用底层优化算法，从而获得显著的渲染性能提升，下面我们通过表格实际感受一下10w+级的实测对比数据：</p>






























<table><thead><tr><th>指标</th><th>未开启 large</th><th>开启 large</th></tr></thead><tbody><tr><td>FPS</td><td>3-10</td><td>51-60</td></tr><tr><td>MS(渲染一帧所需的毫秒数)</td><td>179-246</td><td>17-28</td></tr><tr><td>内存占用(MB)</td><td>277-305</td><td>53-59</td></tr><tr><td>交互响应</td><td>卡顿明显</td><td>基本流畅</td></tr></tbody></table>
<p>　　<code>largeThreshold</code>是与large属性配合使用的阈值参数，它定义了启用大规模优化模式的数据量下限。当且仅当数据项数超过此阈值时，优化绘制逻辑才会生效；反之，系统将使用标准渲染流程，避免不必要的开销；大多数情况下无需手动调整。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">setOption</span>({
  <span class="hljs-attr">series</span>: [
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"bar"</span>,
      data,
      <span class="hljs-attr">large</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">largeThreshold</span>: <span class="hljs-number">1000</span>,
    },
  ],
});
</code></pre>
<blockquote>
<p><strong>需要注意</strong>的是，不是每种类型的图表都支持large和largeThreshold属性的，目前仅有bar和scatter图表支持。</p>
</blockquote>
<p>　　需要指出的是，在large模式下，Echarts出于性能优化的考虑，无法为单个数据点设置独立样式，所有数据点将共享同一套样式配置；比如下面代码中，我们为最后一个数据项单独设置的itemStyle就不会生效：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">setOption</span>({
  <span class="hljs-attr">series</span>: [
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"bar"</span>,
      <span class="hljs-attr">data</span>: [
        <span class="hljs-number">10</span>,
        <span class="hljs-number">20</span>,
        <span class="hljs-number">30</span>,
        <span class="hljs-comment">// 这个不会生效</span>
        { <span class="hljs-attr">value</span>: <span class="hljs-number">40</span>, <span class="hljs-attr">itemStyle</span>: { <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span> } }
      ],
      <span class="hljs-attr">large</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">largeThreshold</span>: <span class="hljs-number">1000</span>,
      <span class="hljs-attr">itemStyle</span>: {
        <span class="hljs-comment">// 所有柱子都是这个颜色</span>
        <span class="hljs-attr">color</span>: <span class="hljs-string">'#fff'</span>
      }
    },
  ],
});
</code></pre>
<p>　　<code>progressive属性</code>本质是开启“分片渲染”模式，用以解决超大规模图形元素（数千至千万级）造成的浏览器瞬时阻塞风险。启用后，ECharts会将庞大的数据集自动分割为多个小块（chunk），在多个动画帧中依次渲染，从而将一次性的沉重负载分散为平缓的增量任务。我们在散点图上实测此功能，可以清晰地观察到数万个数据点如同雨点般在画布上逐渐浮现：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">Array</span>&lt;[<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>]&gt; = [];
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
  data.<span class="hljs-title function_">push</span>([
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>, 
    <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>
  ]);
}

<span class="hljs-title function_">setOption</span>({
  <span class="hljs-attr">series</span>: [
    {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"scatter"</span>,
        data,
        <span class="hljs-attr">progressive</span>: <span class="hljs-number">100</span>,
        <span class="hljs-attr">progressiveThreshold</span>: <span class="hljs-number">3000</span>,
        <span class="hljs-attr">progressiveChunkMode</span>: <span class="hljs-string">'mod'</span>
    },
  ],
});
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c802f9023f1c40b7a4fb8beb81f4aeef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LCi5bCP6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770856674&amp;x-signature=DyhW2X74eyMmE1K356VMb3xs2dc%3D" alt="progressive属性效果" loading="lazy"/></p>
<p>　　<code>progressive属性</code>控制渐进式渲染的 “粒度”，其值为每一帧渲染的图形数量，默认值为400，设为0，则相当于关闭此功能；而<code>progressiveThreshold属性</code>则设定了启用此功能的 “门槛”。仅当图形总数超过此阈值时，progressive的配置才会生效，开始分帧渲染。</p>
<blockquote>
<p>开启large默认会开启progressive渐进渲染。</p>
</blockquote>
<h2 data-id="heading-7">总结</h2>
<p>　　到这里，我的Echarts性能优化三部曲总算告一段落了；当看到业务方在流畅渲染着四年设备数据的图表前露出满意笑容时，我就知道，这次优化的努力没有白费。</p>
<p>　　我们首先构建了数据分割机制。当用户选择跨年度的查询范围时，系统不再傻乎乎地一次性请求所有数据，而是像一位细心的图书管理员，将厚厚的历史档案按时间章节分册取出。这个简单的策略，将原本长达14秒的接口响应时间分解为多个毫秒级的快速请求，从根本上避免了浏览器的内存过载和界面冻结。</p>
<p>　　接着我们引入了Web Worker并行计算。这相当于给数据处理流程雇佣了一位专属的后台助理。所有耗时的数据清洗、格式转换和指标计算都被转移到独立线程中执行，主线程得以保持轻盈，继续流畅地响应用户的每一次点击和滑动。这种前后台分工协作的模式，让数据处理从“阻塞性任务”变成了“后台服务”。</p>
<p>　　最后，我们在Echarts渲染层施展了一系列组合优化。通过LTTB采样算法，我们在保留数据趋势灵魂的同时，巧妙地减少了渲染负担；借助dataZoom的视口动态加载，我们实现了“所见即所得”的按需渲染；而启用large和progressive模式，则是给图表引擎装上了涡轮增压，让万级数据点的绘制也能达到60帧的流畅体验。</p>
<p>　　现在回顾这段旅程，让我深刻认识到数据可视化的本质——它不仅仅是数据的图形化呈现，更是信息与洞察的艺术表达。好了，我的优化之旅暂告一段落，但技术的探索永无止境。那么，你的项目中是否也藏着需要被驯服的“数据巨兽”呢？带上这份实战心得，开始你的优化之旅吧！</p>
<p>如果觉得写得还不错，请关注我的<a href="//juejin.im/user/580038cebf22ec0064bd0b2d" target="_blank" title="//juejin.im/user/580038cebf22ec0064bd0b2d">掘金主页</a>。更多文章请访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fxieyufei.com" target="_blank" title="https://xieyufei.com" ref="nofollow noopener noreferrer">谢小飞的博客</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你不知道的 v-on]]></title>    <link>https://juejin.cn/post/7603355275256954920</link>    <guid>https://juejin.cn/post/7603355275256954920</guid>    <pubDate>2026-02-06T06:18:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603355275256954920" data-draft-id="7603308967124795392" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你不知道的 v-on"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-02-06T06:18:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SuperEugene"/> <meta itemprop="url" content="https://juejin.cn/user/2366613652515256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你不知道的 v-on
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2366613652515256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SuperEugene
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T06:18:24.000Z" title="Fri Feb 06 2026 06:18:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>v-on</code> 是 <code>Vue</code> 的<strong>事件绑定指令</strong>，近期在使用<code>Vxe Table</code>组件库的时候看见了一个就职公司项目场景不常用的写法，在此分享给同样不常用或不知道的同学们。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//此处复制的是vxetbale组件库的示例代码</span>
&lt;vxe-grid v-bind=<span class="hljs-string">"gridOptions"</span> v-on=<span class="hljs-string">"gridEvents"</span>&gt;&lt;/vxe-grid&gt;

<span class="hljs-keyword">const</span> <span class="hljs-attr">gridEvents</span>: <span class="hljs-title class_">VxeGridListeners</span> = { 
    pageChange ({ pageSize, currentPage }) { 
        pagerVO.<span class="hljs-property">currentPage</span> = currentPage
        pagerVO.<span class="hljs-property">pageSize</span> = pageSize
        <span class="hljs-title function_">loadList</span>()
    } 
}
</code></pre>
<p>v-on绝大部分人只知道是vue提供的事件绑定api，通常用法：<code>v-on:click="getInfo"</code> 或者简写 <code>@click="handleClick"</code>。在上述案例代码中<code>v-on</code>后面直接就是<code>="gridEvents"</code>这并不是错误写法， 而是<code>v-on</code>的<strong>对象式事件绑定</strong>写法。和常用的 <code>@click="handleClick"</code> 属于同一套事件绑定机制，仅写法形式不同。</p>
<h2 data-id="heading-0">两种写法对比</h2>
<h3 data-id="heading-1">1. 单个事件（常规熟悉写法）</h3>
<p><code>@</code> 是 <code>v-on:</code> 的语法糖，两种写法完全等价：</p>
<pre><code class="hljs language-ts" lang="ts">&lt;button <span class="hljs-meta">@click</span>=<span class="hljs-string">"handleClick"</span>&gt;点击&lt;/button&gt;
&lt;!-- 等价于 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">v-on:click</span>=<span class="hljs-string">"handleClick"</span>&gt;</span>点击<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-2">2. 对象式绑定（v-on="对象" 用法）</h3>
<p>直接通过 <code>v-on</code> 绑定一个事件对象，适用于多个事件绑定的场景：</p>
<pre><code class="hljs language-ts" lang="ts">&lt;vxe-grid v-on=<span class="hljs-string">"gridEvents"</span>&gt;&lt;/vxe-grid&gt;
</code></pre>
<p>其中 <code>gridEvents</code> 是一个<strong>键值对对象</strong>：</p>
<ul>
<li>键：事件名（如 <code>pageChange</code>、<code>cellClick</code>）</li>
<li>值：该事件对应的处理函数<code>Vue</code> 会自动遍历这个对象，将每个键值对解析为「<code>v-on:事件名=处理函数</code>」的形式完成绑定。</li>
</ul>
<h2 data-id="heading-3">在代码中的实际含义</h2>
<p>以 <code>vxe-table</code>的分页事件为例，实际定义的事件对象如下（包含<code>TypeScript</code>类型约束）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">gridEvents</span>: <span class="hljs-title class_">VxeGridListeners</span> = {
  <span class="hljs-title function_">pageChange</span>(<span class="hljs-params">{ pageSize, currentPage }</span>) {
    pagerVO.<span class="hljs-property">currentPage</span> = currentPage
    pagerVO.<span class="hljs-property">pageSize</span> = pageSize
    <span class="hljs-title function_">loadList</span>()
  },
}
</code></pre>
<p>此时 <code>v-on="gridEvents"</code> 完全等价于<strong>单个事件绑定的写法</strong>：</p>
<pre><code class="hljs language-ts" lang="ts">&lt;vxe-grid v-<span class="hljs-attr">on</span>:pageChange=<span class="hljs-string">"gridEvents.pageChange"</span>&gt;&lt;/vxe-grid&gt;
</code></pre>
<p>如果 <code>gridEvents</code> 中包含<strong>多个事件</strong>，<code>Vue</code>会自动完成所有事件的批量绑定，例如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 包含多个事件的处理对象</span>
<span class="hljs-keyword">const</span> gridEvents = {
  <span class="hljs-attr">pageChange</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> { ... },
  <span class="hljs-attr">editClosed</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> { ... },
  <span class="hljs-attr">cellClick</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> { ... },
}
</code></pre>
<p>等价于手动为每个事件单独绑定：</p>
<pre><code class="hljs language-ts" lang="ts">&lt;vxe-grid
  v-<span class="hljs-attr">on</span>:pageChange=<span class="hljs-string">"gridEvents.pageChange"</span>
  v-<span class="hljs-attr">on</span>:editClosed=<span class="hljs-string">"gridEvents.editClosed"</span>
  v-<span class="hljs-attr">on</span>:cellClick=<span class="hljs-string">"gridEvents.cellClick"</span>
&gt;&lt;/vxe-grid&gt;
</code></pre>
<h2 data-id="heading-4">为什么使用对象式事件绑定写法？</h2>
<ol>
<li><strong>事件多时更简洁</strong>：无需在模板中重复书写大量 <code>v-on:xxx="xxx"</code>，仅需一个 <code>v-on="对象"</code> 即可完成批量绑定，简化模板代码；</li>
<li><strong>便于维护</strong>：所有事件的处理函数都集中在一个对象中，事件名和对应逻辑一一对应，后续新增 / 修改 / 删除事件时，只需操作该对象，无需改动模板；</li>
<li><strong>适配组件库场景</strong>： <code>vxe-table</code>、<code>Element Plus</code>这类 UI 组件库的复杂组件（如表格、树形控件）通常提供大量事件，使用对象统一配置事件，代码结构会更清晰。</li>
</ol>
<p>以上便是对<code>v-on</code>的分享，欢迎大家指正讨论，与大家共勉。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 的 ViewTransition 元素]]></title>    <link>https://juejin.cn/post/7602811649126891571</link>    <guid>https://juejin.cn/post/7602811649126891571</guid>    <pubDate>2026-02-05T00:58:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602811649126891571" data-draft-id="7602850166731472905" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 的 ViewTransition 元素"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-02-05T00:58:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金安东尼"/> <meta itemprop="url" content="https://juejin.cn/user/1521379823340792"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 的 ViewTransition 元素
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379823340792/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金安东尼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T00:58:23.000Z" title="Thu Feb 05 2026 00:58:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontendmasters.com%2Fblog%2Freacts-viewtransition-element%2F" target="_blank" title="https://frontendmasters.com/blog/reacts-viewtransition-element/" ref="nofollow noopener noreferrer">React’s ViewTransition Element</a></p>
<p>作者：Chris Coyier</p>
<p>日期：2026年1月30日</p>
<p>翻译：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN" target="_blank" title="https://github.com/TUARAN" ref="nofollow noopener noreferrer">TUARAN</a></p>
<blockquote>
<p>欢迎关注 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTUARAN%2Ffrontend-weekly-digest-cn" target="_blank" title="https://github.com/TUARAN/frontend-weekly-digest-cn" ref="nofollow noopener noreferrer">前端周刊</a>，每周更新国外论坛的前端热门文章，紧跟时事，掌握前端技术动态。</p>
</blockquote>
<p>作为一个 View Transitions 的爱好者，同时又在用 React，我自然会关注 React 现在直接提供了一个 <code>&lt;ViewTransition&gt;</code> 元素（目前在 “Canary” 预发布版本中）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4728576e2e7349779a5eccab31609eed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5a6J5Lic5bC8:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770857902&amp;x-signature=hqNZ4FAkvFqE8mSdYaKtNgOokAk%3D" alt="image.png" loading="lazy"/></p>
<p>我想看看它到底怎么用，但在开始之前，我们先……<strong>别</strong>用它。View Transitions 是 Web 平台本身的特性，不属于任何框架。所以 React 也无法阻止我们使用它。直接用其实也不算奇怪。</p>
<h2 data-id="heading-0">在 React 中使用 View Transitions（经典方式？）</h2>
<p>同页 View Transitions API（对 React 更相关，而不是多页切换的那种）基本是这样：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">startViewTransition</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在这里改 DOM</span>
});
</code></pre>
<p>但改 DOM 这种事……是 React 的工作。它并不喜欢你自己去动它。所以与其直接操作 DOM，我们不如做些“更 React 的事”，比如更新 state。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DemoOne</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [buttonExpanded, setButtonExpanded] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleButton</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">startViewTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setButtonExpanded</span>(!buttonExpanded);
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">button</span> ${<span class="hljs-attr">buttonExpanded</span> ? "<span class="hljs-attr">expanded</span>" <span class="hljs-attr">:</span> ""}`}
      <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleButton}</span>
    &gt;</span>
      Button
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<p>视觉效果由 CSS 完成。状态变化触发 class 变化，而 class 改变按钮的样式。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.button</span> {
  <span class="hljs-comment">/* button styles */</span>

  &amp;<span class="hljs-selector-class">.expanded</span> {
    scale: <span class="hljs-number">1.4</span>;
    rotate: -<span class="hljs-number">6deg</span>;
  }
}
</code></pre>
<h2 data-id="heading-1">准备使用 <code>&lt;ViewTransition&gt;</code></h2>
<p>写这篇文章时，这个元素还只存在于 React 的 “Canary” 版本，所以你得显式安装：</p>
<pre><code class="hljs language-bash" lang="bash">npm install react@canary
</code></pre>
<p>你的 <code>package.json</code> 会把版本写成 <code>canary</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"canary"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"react-dom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"canary"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>如果你在客户端用 React，也可以用 CDN 的 import map：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"importmap"</span>&gt;</span><span class="javascript">
{
  <span class="hljs-string">"imports"</span>: {
    <span class="hljs-string">"react"</span>: <span class="hljs-string">"https://esm.sh/react@canary"</span>,
    <span class="hljs-string">"react-dom"</span>: <span class="hljs-string">"https://esm.sh/react-dom@canary"</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">在 React 中使用 <code>&lt;ViewTransition&gt;</code></h2>
<p>现在我们可以导入 <code>ViewTransition</code>，并把它作为 JSX 元素使用，同时配合它的搭档 <code>startTransition</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { startTransition, <span class="hljs-title class_">ViewTransition</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [buttonExpanded, setButtonExpanded] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleButton</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 以更“React”的方式改变 DOM</span>
      <span class="hljs-title function_">setButtonExpanded</span>(!buttonExpanded);
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ViewTransition</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">button</span> ${<span class="hljs-attr">buttonExpanded</span> ? "<span class="hljs-attr">expanded</span>" <span class="hljs-attr">:</span> ""}`}
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{toggleButton}</span>
        &gt;</span>
          Button
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">ViewTransition</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span>
  );
}
</code></pre>
<p>CSS 和上面一样，因为本质还是切换 class。注意我们没有用 <code>.classList.toggle("expanded")</code> 这种直接 DOM 操作，而是让 React 走自己的渲染流程。</p>
<h2 data-id="heading-3">所以……两种方式都能用？</h2>
<p>是的，至少在这些简单 demo 里都没问题。甚至同页混用也可以。</p>
<p>一个小差异是：如果你直接用 <code>document.startViewTransition</code>，需要自己加 <code>view-transition-name</code>；而 <code>&lt;ViewTransition&gt;</code> 会自动帮你加。这算是 <code>&lt;ViewTransition&gt;</code> 的一个小加分点。</p>
<h3 data-id="heading-4">我“讨厌”的那部分</h3>
<p>有一部分我并不喜欢这个方案。React 并没有给出太多额外价值，它只是要求你用一种不破坏框架运行方式的写法。如果你花了很多时间去学它（而且<a href="https://link.juejin.cn?target=https%3A%2F%2Freact.dev%2Freference%2Freact%2FViewTransition%23my-viewtransition-is-not-activating" target="_blank" title="https://react.dev/reference/react/ViewTransition#my-viewtransition-is-not-activating" ref="nofollow noopener noreferrer">确实有不少内容</a>），这些知识并不太能迁移到其他地方。</p>
<h3 data-id="heading-5">我“勉强接受”的那部分</h3>
<p>React 一直以来就希望自己掌控 DOM，这是它的核心卖点。也正因为如此，你必须让它来做一些协调工作。这意味着使用 <code>&lt;ViewTransition&gt;</code> 可以“自动与渲染生命周期、Suspense 边界、并发特性协调”，完成批量更新、防冲突、嵌套管理等你我不想操心的事情。</p>
<p>此外，<code>&lt;ViewTransition&gt;</code> 有一点点更“声明式”：你明确包裹了要过渡的区域，更符合很多人的心智模型。但你仍然需要调用 <code>startTransition</code>，所以仍然是偏命令式的。在更复杂的嵌套 UI 中，如何组织它可能会有些困惑。</p>
<p>我倒是挺喜欢 <code>&lt;ViewTransition&gt;</code> 上像 <code>enter</code>、<code>exit</code> 这样的明确属性，它对应“自带的” CSS view transition class，比起自己通过 <code>:only-child</code> 技巧推断要直观一些。</p>
<p>总之，以上就是我的看法。更多示例请参见原文。</p>
<h2 data-id="heading-6">推荐</h2>
<p><strong>React 的 <code>&lt;ViewTransition&gt;</code> 把 Web 原生 View Transitions 纳入 React 的渲染与并发体系中。</strong></p>
<p>直接使用 <code>document.startViewTransition</code> 已经足够灵活，而 <code>&lt;ViewTransition&gt;</code> 的价值更多体现在与 React 生命周期、Suspense、并发更新的自动协同上，代价是多了一层框架语义，学习成本也更偏 React 私有。它更像是一种“安全封装”，而不是必选能力。</p>
<p>如果你需要把这类新特性快速做成 <strong>示例页、技术文章或 Demo 站点</strong>，可以用 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rollcode.cn%2F%3Fsource%3Dba%26id%3Datn" target="_blank" title="https://www.rollcode.cn/?source=ba&amp;id=atn" ref="nofollow noopener noreferrer">RollCode 低代码平台</a></strong> 快速搭建展示页面，把实验、讲解和转化路径一次性跑通，而不用在工程脚手架上消耗精力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[冷热钱包系统设计实战（下）：核心代码实现与部署]]></title>    <link>https://juejin.cn/post/7602850166731718665</link>    <guid>https://juejin.cn/post/7602850166731718665</guid>    <pubDate>2026-02-05T01:14:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7602850166731718665" data-draft-id="7602824293164548111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="冷热钱包系统设计实战（下）：核心代码实现与部署"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-02-05T01:14:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            冷热钱包系统设计实战（下）：核心代码实现与部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-05T01:14:48.000Z" title="Thu Feb 05 2026 01:14:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">冷热钱包系统设计实战（下）：核心代码实现与部署</h2>
<blockquote>
<p>深入代码层面，学习冷热钱包系统的核心实现、并发控制机制和部署方案。</p>
</blockquote>
<hr/>
<p><strong>本文分为上下两篇，这是下篇。</strong></p>
<p><strong>上篇回顾：</strong></p>
<ol>
<li>引言：为什么需要冷热钱包？</li>
<li>冷热钱包的由来：从比特币说起</li>
<li>问题场景：一次真实的线上事故</li>
<li>冷热钱包架构：小白也能懂的方案</li>
<li>系统架构设计</li>
</ol>
<p><strong>本篇内容：</strong>
6. 核心代码实现</p>
<ol start="7">
<li>完整交易流程</li>
<li>并发控制机制</li>
<li>部署与运维</li>
<li>总结与展望</li>
</ol>
<hr/>
<h3 data-id="heading-1">六、核心代码实现</h3>
<h4 data-id="heading-2">6.1 核心常量配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 用户账户服务实现
 * 核心逻辑：冷热钱包扣款机制
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserAccountServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserAccountService</span> {

    <span class="hljs-comment">/**
     * 热钱包阈值
     * 当热钱包余额低于此值时，自动从冷钱包补充
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">HOT_WALLET_THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"10000"</span>);

    <span class="hljs-comment">/**
     * 热钱包补充金额
     * 从冷钱包调拨到热钱包的固定金额
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">HOT_WALLET_RECHARGE_AMOUNT</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"50000"</span>);
    
}
</code></pre>
<h4 data-id="heading-3">6.2 处理充值</h4>
<p>充值是用户资金流入的主要方式，所有充值直接进入冷钱包：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 处理充值
 * 充值金额直接进入冷钱包
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processRecharge</span><span class="hljs-params">(UserAccount account, TransactionRequest request,
                            TransactionResponse response)</span> {
    <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">amount</span> <span class="hljs-operator">=</span> request.getAmount();

    <span class="hljs-comment">// 增加冷钱包余额（使用乐观锁）</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> userAccountMapper.addColdBalance(
        account.getUserId(),
        amount.longValue(),
        account.getVersion()
    );

    <span class="hljs-keyword">if</span> (rows == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"充值失败，并发冲突"</span>);
    }

    <span class="hljs-comment">// 更新账户对象</span>
    account.setColdBalance(account.getColdBalance().add(amount));

    <span class="hljs-comment">// 记录交易</span>
    saveTransactionRecord(account, request, response,
                         TransactionType.RECHARGE,
                         account.getColdBalance(),
                         account.getHotBalance());
}
</code></pre>
<h4 data-id="heading-4">6.3 处理消费（核心逻辑）</h4>
<p>这是整个系统最核心的逻辑：<strong>优先从热钱包扣款，热钱包不足时自动从冷钱包调拨</strong>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 处理消费（核心逻辑）
 * 优先从热钱包扣款，热钱包不足时自动从冷钱包调拨
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processConsume</span><span class="hljs-params">(UserAccount account, TransactionRequest request,
                           TransactionResponse response)</span> {
    <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">amount</span> <span class="hljs-operator">=</span> request.getAmount();

    <span class="hljs-comment">// 1. 检查总余额是否足够</span>
    <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">totalBalance</span> <span class="hljs-operator">=</span> account.getColdBalance().add(account.getHotBalance());
    <span class="hljs-keyword">if</span> (totalBalance.compareTo(amount) &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"余额不足"</span>);
    }

    <span class="hljs-comment">// 2. 如果热钱包余额不足，先从冷钱包调拨</span>
    <span class="hljs-keyword">if</span> (account.getHotBalance().compareTo(amount) &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">needTransfer</span> <span class="hljs-operator">=</span> amount.subtract(account.getHotBalance());
        transferColdToHot(account, needTransfer);

        <span class="hljs-comment">// 重新查询账户以获取最新的版本号</span>
        LambdaQueryWrapper&lt;UserAccount&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
        wrapper.eq(UserAccount::getUserId, account.getUserId());
        <span class="hljs-type">UserAccount</span> <span class="hljs-variable">freshAccount</span> <span class="hljs-operator">=</span> userAccountMapper.selectOne(wrapper);
        account.setVersion(freshAccount.getVersion());
        account.setColdBalance(freshAccount.getColdBalance());
        account.setHotBalance(freshAccount.getHotBalance());
    }

    <span class="hljs-comment">// 3. 从热钱包扣款（使用乐观锁）</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> userAccountMapper.deductHotBalance(
        account.getUserId(),
        amount.longValue(),
        account.getVersion()
    );

    <span class="hljs-keyword">if</span> (rows == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"扣款失败，并发冲突"</span>);
    }

    <span class="hljs-comment">// 更新账户对象</span>
    account.setHotBalance(account.getHotBalance().subtract(amount));

    <span class="hljs-comment">// 记录交易</span>
    saveTransactionRecord(account, request, response, TransactionType.CONSUME,
                         account.getColdBalance(), account.getHotBalance());
}
</code></pre>
<h4 data-id="heading-5">6.4 冷热钱包调拨</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 冷钱包转热钱包（内部调拨）
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transferColdToHot</span><span class="hljs-params">(UserAccount account, BigDecimal amount)</span> {
    log.info(<span class="hljs-string">"开始调拨: userId={}, amount=冷转热{}"</span>, account.getUserId(), amount);

    <span class="hljs-comment">// 1. 检查冷钱包余额</span>
    <span class="hljs-keyword">if</span> (account.getColdBalance().compareTo(amount) &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"冷钱包余额不足"</span>);
    }

    <span class="hljs-comment">// 2. 扣减冷钱包</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">rows1</span> <span class="hljs-operator">=</span> userAccountMapper.deductColdBalance(
        account.getUserId(),
        amount.longValue(),
        account.getVersion()
    );
    <span class="hljs-keyword">if</span> (rows1 == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"调拨失败，并发冲突"</span>);
    }
    account.setColdBalance(account.getColdBalance().subtract(amount));

    <span class="hljs-comment">// 重新查询获取最新版本号</span>
    LambdaQueryWrapper&lt;UserAccount&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
    wrapper.eq(UserAccount::getUserId, account.getUserId());
    <span class="hljs-type">UserAccount</span> <span class="hljs-variable">freshAccount</span> <span class="hljs-operator">=</span> userAccountMapper.selectOne(wrapper);
    account.setVersion(freshAccount.getVersion());
    account.setColdBalance(freshAccount.getColdBalance());
    account.setHotBalance(freshAccount.getHotBalance());

    <span class="hljs-comment">// 3. 增加热钱包</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">rows2</span> <span class="hljs-operator">=</span> userAccountMapper.addHotBalance(
        account.getUserId(),
        amount.longValue(),
        account.getVersion()
    );
    <span class="hljs-keyword">if</span> (rows2 == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"调拨失败，并发冲突"</span>);
    }
    account.setHotBalance(account.getHotBalance().add(amount));

    log.info(<span class="hljs-string">"调拨完成: coldBalance={}, hotBalance={}"</span>,
             account.getColdBalance(), account.getHotBalance());
}
</code></pre>
<h4 data-id="heading-6">6.5 自动充值热钱包</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 自动充值热钱包
 * 当热钱包余额低于阈值时，自动从冷钱包补充
 */</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoRechargeHotWallet</span><span class="hljs-params">(UserAccount account)</span> {
    <span class="hljs-comment">// 重新查询获取最新余额（在消费后）</span>
    LambdaQueryWrapper&lt;UserAccount&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
    wrapper.eq(UserAccount::getUserId, account.getUserId());
    <span class="hljs-type">UserAccount</span> <span class="hljs-variable">freshAccount</span> <span class="hljs-operator">=</span> userAccountMapper.selectOne(wrapper);
    account.setColdBalance(freshAccount.getColdBalance());
    account.setHotBalance(freshAccount.getHotBalance());
    account.setVersion(freshAccount.getVersion());

    <span class="hljs-keyword">if</span> (account.getHotBalance().compareTo(HOT_WALLET_THRESHOLD) &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> (account.getColdBalance().compareTo(HOT_WALLET_RECHARGE_AMOUNT) &gt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">try</span> {
                transferColdToHot(account, HOT_WALLET_RECHARGE_AMOUNT);
                log.info(<span class="hljs-string">"自动补充热钱包: userId={}, amount={}"</span>,
                        account.getUserId(), HOT_WALLET_RECHARGE_AMOUNT);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.warn(<span class="hljs-string">"自动补充热钱包失败: {}"</span>, e.getMessage());
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-7">6.6 开始调拨</h4>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@DistributedLock(key = "#request.userId", waitTime = 3, leaseTime = 10)</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> TransactionResponse <span class="hljs-title function_">transfer</span><span class="hljs-params">(TransferRequest request)</span> {
        log.info(<span class="hljs-string">"开始调拨: userId={}, amount={}, type={}"</span>,
                request.getUserId(), request.getAmount(), request.getTransferType());

        <span class="hljs-comment">// 1. 查询账户</span>
        LambdaQueryWrapper&lt;UserAccount&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
        wrapper.eq(UserAccount::getUserId, request.getUserId());
        <span class="hljs-type">UserAccount</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> userAccountMapper.selectOne(wrapper);

        <span class="hljs-keyword">if</span> (account == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"账户不存在"</span>);
        }

        <span class="hljs-comment">// 保存调拨前余额</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">beforeColdBalance</span> <span class="hljs-operator">=</span> account.getColdBalance();
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">beforeHotBalance</span> <span class="hljs-operator">=</span> account.getHotBalance();

        <span class="hljs-comment">// 2. 生成调拨流水号</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">transferNo</span> <span class="hljs-operator">=</span> <span class="hljs-string">"TF"</span> + LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyyMMddHHmmss"</span>))
                + String.format(<span class="hljs-string">"%04d"</span>, (<span class="hljs-type">int</span>)(Math.random() * <span class="hljs-number">10000</span>));

        <span class="hljs-comment">// 3. 执行调拨</span>
        <span class="hljs-type">TransferType</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> TransferType.getByCode(request.getTransferType());
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">amount</span> <span class="hljs-operator">=</span> request.getAmount();

        <span class="hljs-keyword">if</span> (type == TransferType.COLD_TO_HOT) {
            <span class="hljs-comment">// 冷转热</span>
            <span class="hljs-keyword">if</span> (account.getColdBalance().compareTo(amount) &lt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"冷钱包余额不足"</span>);
            }
            transferColdToHot(account, amount);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 热转冷</span>
            <span class="hljs-keyword">if</span> (account.getHotBalance().compareTo(amount) &lt; <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"热钱包余额不足"</span>);
            }
            <span class="hljs-comment">// 扣减热钱包</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">rows1</span> <span class="hljs-operator">=</span> userAccountMapper.deductHotBalance(
                    account.getUserId(),
                    amount.longValue(),
                    account.getVersion()
            );
            <span class="hljs-keyword">if</span> (rows1 == <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"调拨失败"</span>);
            }
            account.setHotBalance(account.getHotBalance().subtract(amount));
            account.setVersion(account.getVersion() + <span class="hljs-number">1</span>);

            <span class="hljs-comment">// 增加冷钱包</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">rows2</span> <span class="hljs-operator">=</span> userAccountMapper.addColdBalance(
                    account.getUserId(),
                    amount.longValue(),
                    account.getVersion()
            );
            <span class="hljs-keyword">if</span> (rows2 == <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"调拨失败"</span>);
            }
            account.setColdBalance(account.getColdBalance().add(amount));
        }

        <span class="hljs-comment">// 4. 记录调拨</span>
        <span class="hljs-type">WalletTransfer</span> <span class="hljs-variable">transfer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletTransfer</span>();
        transfer.setTransferNo(transferNo);
        transfer.setUserId(request.getUserId());
        transfer.setTransferType(request.getTransferType());
        transfer.setAmount(amount);
        transfer.setBeforeColdBalance(BigDecimal.ZERO);
        transfer.setAfterColdBalance(account.getColdBalance());
        transfer.setBeforeHotBalance(BigDecimal.ZERO);
        transfer.setAfterHotBalance(account.getHotBalance());
        transfer.setStatus(TransactionStatus.SUCCESS.getCode());
        transfer.setCreateTime(LocalDateTime.now());
        transfer.setUpdateTime(LocalDateTime.now());
        walletTransferMapper.insert(transfer);

        <span class="hljs-comment">// 5. 发送调拨审计消息</span>
        sendTransferAuditMessage(request.getUserId(), transferNo, type,
                amount, beforeColdBalance, beforeHotBalance,
                account.getColdBalance(), account.getHotBalance(),
                request.getOperatorId(), request.getOperatorName());

        <span class="hljs-comment">// 6. 返回结果</span>
        <span class="hljs-type">TransactionResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionResponse</span>();
        response.setTransactionNo(transferNo);
        response.setUserId(request.getUserId());
        response.setAmount(amount);
        response.setStatus(TransactionStatus.SUCCESS.getCode());
        response.setStatusDesc(TransactionStatus.SUCCESS.getDesc());
        response.setColdBalance(account.getColdBalance());
        response.setHotBalance(account.getHotBalance());
        response.setMessage(<span class="hljs-string">"调拨成功"</span>);
        response.setCreateTime(LocalDateTime.now());

        <span class="hljs-keyword">return</span> response;
    }
</code></pre>
<h3 data-id="heading-8">七、完整交易流程</h3>
<h3 data-id="heading-9">7.1 交易流程图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/944f4886303247af93013b2f3b0214a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858888&amp;x-signature=oNcO3V2pAugua0mUNseTQVlBRk8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">7.2 时序图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4ccd763adf843cd9d86d3f10a76bfcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858888&amp;x-signature=fPVwfGrYHm7UgwWhUQNavBukNSE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-11">7.3 典型交易场景</h4>
<h5 data-id="heading-12">场景1：正常消费（热钱包充足）</h5>
<pre><code class="hljs language-markdown" lang="markdown">用户余额：冷钱包=100000，热钱包=20000
消费金额：5000

流程：
<span class="hljs-bullet">1.</span> 检查热钱包余额(20000) &gt;= 消费金额(5000)？ ✓ 是
<span class="hljs-bullet">2.</span> 直接从热钱包扣款
<span class="hljs-bullet">3.</span> 最终：冷钱包=100000，热钱包=15000
</code></pre>
<h5 data-id="heading-13">场景2：热钱包不足</h5>
<pre><code class="hljs language-markdown" lang="markdown">用户余额：冷钱包=100000，热钱包=5000
消费金额：15000

流程：
<span class="hljs-bullet">1.</span> 检查热钱包余额(5000) &gt;= 消费金额(15000)？ ✗ 否
<span class="hljs-bullet">2.</span> 计算需要调拨：15000 - 5000 = 10000
<span class="hljs-bullet">3.</span> 从冷钱包调拨10000到热钱包
<span class="hljs-bullet">4.</span> 从热钱包扣款15000
<span class="hljs-bullet">5.</span> 最终：冷钱包=90000，热钱包=0
</code></pre>
<h5 data-id="heading-14">场景3：触发自动补充</h5>
<pre><code class="hljs language-markdown" lang="markdown">用户余额：冷钱包=100000，热钱包=5000
消费金额：1000
热钱包阈值：10000
自动补充金额：50000

流程：
<span class="hljs-bullet">1.</span> 从热钱包扣款1000
<span class="hljs-bullet">2.</span> 扣款后热钱包=4000，低于阈值(10000)
<span class="hljs-bullet">3.</span> 触发自动补充：从冷钱包调拨50000到热钱包
<span class="hljs-bullet">4.</span> 最终：冷钱包=50000，热钱包=54000
</code></pre>
<hr/>
<h3 data-id="heading-15">八、并发控制机制</h3>
<h4 data-id="heading-16">8.1 并发控制机制图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73133b1dadc24ef19f4f790598cf0d81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858888&amp;x-signature=V6IuPzkIR68OX3%2F3lRea%2BGL%2FIpw%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-17">8.2 双重并发保护</h4>
<p>本系统采用<strong>双重并发保护机制</strong>：</p>
<h5 data-id="heading-18">第一层：Redis分布式锁</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.wallet.aspect;

<span class="hljs-keyword">import</span> java.lang.annotation.*;

<span class="hljs-comment">/**
 * 分布式锁注解
 * 用于防止同一用户的并发操作
 */</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> DistributedLock {

    <span class="hljs-comment">/**
     * 锁的key前缀
     */</span>
    String <span class="hljs-title function_">prefix</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"wallet:lock:"</span>;

    <span class="hljs-comment">/**
     * 锁的key表达式，支持SpEL表达式
     */</span>
    String <span class="hljs-title function_">key</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;

    <span class="hljs-comment">/**
     * 等待时间（秒）
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">waitTime</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">3</span>;

    <span class="hljs-comment">/**
     * 锁超时时间（秒）
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">leaseTime</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">10</span>;
}


<span class="hljs-keyword">package</span> com.wallet.aspect;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Around;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hljs-keyword">import</span> org.aspectj.lang.reflect.MethodSignature;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> java.lang.reflect.Method;
<span class="hljs-keyword">import</span> java.util.UUID;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * 分布式锁切面
 * 使用Redis实现分布式锁，防止同一用户的并发操作
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedLockAspect</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;

    <span class="hljs-meta">@Around("@annotation(com.wallet.aspect.DistributedLock)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint joinPoint)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">MethodSignature</span> <span class="hljs-variable">signature</span> <span class="hljs-operator">=</span> (MethodSignature) joinPoint.getSignature();
        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> signature.getMethod();
        <span class="hljs-type">DistributedLock</span> <span class="hljs-variable">distributedLock</span> <span class="hljs-operator">=</span> method.getAnnotation(DistributedLock.class);

        <span class="hljs-comment">// 获取锁的key</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> getLockKey(distributedLock, joinPoint);

        <span class="hljs-comment">// 生成唯一的锁值</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockValue</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();

        <span class="hljs-comment">// 尝试获取锁</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">acquired</span> <span class="hljs-operator">=</span> Boolean.TRUE.equals(stringRedisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, distributedLock.leaseTime(), TimeUnit.SECONDS));

        <span class="hljs-keyword">if</span> (!acquired) {
            <span class="hljs-comment">// 尝试等待</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-type">long</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> distributedLock.waitTime() * <span class="hljs-number">1000L</span>;

            <span class="hljs-keyword">while</span> (System.currentTimeMillis() - startTime &lt; timeout) {
                acquired = Boolean.TRUE.equals(stringRedisTemplate.opsForValue()
                        .setIfAbsent(lockKey, lockValue, distributedLock.leaseTime(), TimeUnit.SECONDS));
                <span class="hljs-keyword">if</span> (acquired) {
                    <span class="hljs-keyword">break</span>;
                }
                Thread.sleep(<span class="hljs-number">50</span>);
            }

            <span class="hljs-keyword">if</span> (!acquired) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"操作频繁，请稍后重试"</span>);
            }
        }

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"获取分布式锁成功: {}"</span>, lockKey);
            <span class="hljs-keyword">return</span> joinPoint.proceed();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 释放锁</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">currentValue</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(lockKey);
            <span class="hljs-keyword">if</span> (lockValue.equals(currentValue)) {
                stringRedisTemplate.delete(lockKey);
                log.info(<span class="hljs-string">"释放分布式锁成功: {}"</span>, lockKey);
            }
        }
    }

    <span class="hljs-comment">/**
     * 获取锁的key
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getLockKey</span><span class="hljs-params">(DistributedLock distributedLock, ProceedingJoinPoint joinPoint)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> distributedLock.key();
        <span class="hljs-keyword">if</span> (key.isEmpty()) {
            <span class="hljs-comment">// 默认使用第一个参数作为key</span>
            Object[] args = joinPoint.getArgs();
            <span class="hljs-keyword">if</span> (args.length &gt; <span class="hljs-number">0</span> &amp;&amp; args[<span class="hljs-number">0</span>] != <span class="hljs-literal">null</span>) {
                key = String.valueOf(args[<span class="hljs-number">0</span>]);
            } <span class="hljs-keyword">else</span> {
                key = <span class="hljs-string">"default"</span>;
            }
        }
        <span class="hljs-keyword">return</span> distributedLock.prefix() + key;
    }
}


<span class="hljs-comment">// 使用示例</span>
 <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@DistributedLock(key = "#request.userId", waitTime = 3, leaseTime = 10)</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> TransactionResponse <span class="hljs-title function_">processTransaction</span><span class="hljs-params">(TransactionRequest request)</span> {
        <span class="hljs-comment">// 记录交易开始时间</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        TRANSACTION_START_TIME.set(startTime);

        log.info(<span class="hljs-string">"开始处理交易: userId={}, amount={}, type={}"</span>,
                request.getUserId(), request.getAmount(), request.getTransactionType());

        <span class="hljs-comment">// 1. 查询账户（加锁）</span>
        LambdaQueryWrapper&lt;UserAccount&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQueryWrapper</span>&lt;&gt;();
        wrapper.eq(UserAccount::getUserId, request.getUserId());
        <span class="hljs-type">UserAccount</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> userAccountMapper.selectOne(wrapper);

        <span class="hljs-keyword">if</span> (account == <span class="hljs-literal">null</span>) {
            sendTransactionFailureNotification(request.getUserId(), <span class="hljs-literal">null</span>, request,
                    <span class="hljs-string">"账户不存在"</span>, startTime);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"账户不存在"</span>);
        }

        <span class="hljs-comment">// 保存交易前余额</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">beforeColdBalance</span> <span class="hljs-operator">=</span> account.getColdBalance();
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">beforeHotBalance</span> <span class="hljs-operator">=</span> account.getHotBalance();

        <span class="hljs-comment">// 2. 检查账户状态</span>
        <span class="hljs-keyword">if</span> (account.getStatus() != AccountStatus.NORMAL.getCode()) {
            sendTransactionFailureNotification(request.getUserId(), <span class="hljs-literal">null</span>, request,
                    <span class="hljs-string">"账户状态异常，无法进行交易"</span>, startTime);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WalletException</span>(<span class="hljs-string">"账户状态异常，无法进行交易"</span>);
        }
    }     
</code></pre>
<h5 data-id="heading-19">第二层：数据库乐观锁</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.wallet.entity;

<span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.*;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-comment">/**
 * 用户账户实体
 * 冷钱包 - 存储用户的主要余额
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("user_account")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserAccount</span> {

    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-comment">/**
     * 用户ID
     */</span>
    <span class="hljs-keyword">private</span> Long userId;

    <span class="hljs-comment">/**
     * 用户名
     */</span>
    <span class="hljs-keyword">private</span> String username;

    <span class="hljs-comment">/**
     * 冷钱包余额（主账户余额）
     * 用户的主要资金存储
     */</span>
    <span class="hljs-keyword">private</span> BigDecimal coldBalance;

    <span class="hljs-comment">/**
     * 热钱包余额（可用余额）
     * 用于日常交易和快速扣款
     */</span>
    <span class="hljs-keyword">private</span> BigDecimal hotBalance;

    <span class="hljs-comment">/**
     * 账户状态：1-正常 2-冻结 3-注销
     */</span>
    <span class="hljs-keyword">private</span> Integer status;

    <span class="hljs-comment">/**
     * 创建时间
     */</span>
    <span class="hljs-keyword">private</span> LocalDateTime createTime;

    <span class="hljs-comment">/**
     * 更新时间
     */</span>
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;

    <span class="hljs-comment">/**
     * 版本号（乐观锁）
     */</span>
    <span class="hljs-meta">@Version</span>
    <span class="hljs-keyword">private</span> Integer version;

    <span class="hljs-comment">/**
     * 逻辑删除标记
     */</span>
    <span class="hljs-meta">@TableLogic</span>
    <span class="hljs-keyword">private</span> Integer deleted;
}


<span class="hljs-comment">/**
 * 扣款操作（使用乐观锁）
 */</span>
UPDATE user_account
<span class="hljs-type">SET</span> <span class="hljs-variable">hot_balance</span> <span class="hljs-operator">=</span> hot_balance - #{amount},
    version = version + <span class="hljs-number">1</span>,
    update_time = NOW()
<span class="hljs-type">WHERE</span> <span class="hljs-variable">user_id</span> <span class="hljs-operator">=</span> #{userId}
  AND hot_balance &gt;= #{amount}
  <span class="hljs-type">AND</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> #{version}
  <span class="hljs-type">AND</span> <span class="hljs-variable">deleted</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
</code></pre>
<h4 data-id="heading-20">8.3 为什么需要双重保护？</h4>
<pre><code class="hljs language-erlang" lang="erlang">┌─────────────────────────────────────────────────────────────┐
│  双重保护的必要性                                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  单靠Redis锁的问题：                                          │
│  ├─ Redis宕机时锁失效                                        │
│  ├─ 网络分区时可能出现脑裂                                   │
│  └─ 无法防止DB层面的直接更新                                 │
│                                                             │
│  单靠数据库锁的问题：                                         │
│  ├─ 大量请求时DB连接耗尽                                     │
│  ├─ 事务等待时间长                                          │
│  └─ 系统吞吐量低                                            │
│                                                             │
│  双重保护的优势：                                            │
│  ├─ Redis锁：挡住<span class="hljs-number">99</span><span class="hljs-comment">%的并发请求                               │</span>
│  ├─ DB锁：挡住漏网的<span class="hljs-number">1</span><span class="hljs-comment">%                                      │</span>
│  ├─ 容错性强：任一层失效都能保证数据正确                      │
│  └─ 性能优异：大部分请求在Redis层就被拦截                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-21">8.4 系统交互图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f26f6b6d642a4fea866c9e8b4d227ef7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858888&amp;x-signature=J%2FXI52aSWljxWuc4KMyLuJou8Is%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-22">九、部署与运维</h3>
<h4 data-id="heading-23">9.1 生产环境部署图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cc67f6c796147f5a609937151af59d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770858888&amp;x-signature=e%2BtBSuSEQSq2rvncPJKq5LcEGp8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-24">9.2 Docker Compose 配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-comment"># MySQL数据库</span>
  <span class="hljs-attr">mysql:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">wallet-mysql</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3306:3306"</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">wallet_db</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql-data:/var/lib/mysql</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./src/main/resources/schema.sql:/docker-entrypoint-initdb.d/schema.sql</span>

  <span class="hljs-comment"># Redis缓存</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">redis:6.0</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">wallet-redis</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6379:6379"</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">redis-server</span> <span class="hljs-string">--appendonly</span> <span class="hljs-literal">yes</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis-data:/data</span>

  <span class="hljs-comment"># 应用服务</span>
  <span class="hljs-attr">wallet-app:</span>
    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">wallet-app</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:8080"</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">SPRING_DATASOURCE_URL:</span> <span class="hljs-string">jdbc:mysql://mysql:3306/wallet_db</span>
      <span class="hljs-attr">SPRING_REDIS_HOST:</span> <span class="hljs-string">redis</span>
      <span class="hljs-attr">SPRING_REDIS_PORT:</span> <span class="hljs-number">6379</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">mysql-data:</span>
  <span class="hljs-attr">redis-data:</span>
</code></pre>
<h4 data-id="heading-25">9.3 关键配置</h4>
<h5 data-id="heading-26">application.yml</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-comment"># 数据源配置</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">com.alibaba.druid.pool.DruidDataSource</span>
    <span class="hljs-attr">druid:</span>
      <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
      <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/wallet_db?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
      <span class="hljs-comment"># 连接池配置</span>
      <span class="hljs-attr">initial-size:</span> <span class="hljs-number">5</span>
      <span class="hljs-attr">min-idle:</span> <span class="hljs-number">5</span>
      <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span>
      <span class="hljs-attr">max-wait:</span> <span class="hljs-number">60000</span>
      <span class="hljs-attr">test-while-idle:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">validation-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>

  <span class="hljs-comment"># Redis配置</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">lettuce:</span>
      <span class="hljs-attr">pool:</span>
        <span class="hljs-attr">max-active:</span> <span class="hljs-number">8</span>
        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span>
        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span>
        <span class="hljs-attr">max-wait:</span> <span class="hljs-string">-1ms</span>

  <span class="hljs-comment"># 事务配置</span>
  <span class="hljs-attr">transaction:</span>
    <span class="hljs-attr">rollback-on-commit-failure:</span> <span class="hljs-literal">true</span>

<span class="hljs-comment"># MyBatis Plus配置</span>
<span class="hljs-attr">mybatis-plus:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.wallet.entity</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">log-impl:</span> <span class="hljs-string">org.apache.ibatis.logging.stdout.StdOutImpl</span>
</code></pre>
<h4 data-id="heading-27">9.4 性能优化建议</h4>








































<table><thead><tr><th align="center">优化项</th><th align="left">具体措施</th><th align="left">预期效果</th></tr></thead><tbody><tr><td align="center"><strong>数据库索引</strong></td><td align="left">user_id、transaction_no等字段建立索引</td><td align="left">查询速度提升10倍+</td></tr><tr><td align="center"><strong>连接池优化</strong></td><td align="left">合理设置初始大小、最大连接数</td><td align="left">避免连接创建开销</td></tr><tr><td align="center"><strong>Redis缓存</strong></td><td align="left">热点账户信息缓存</td><td align="left">减少DB查询80%</td></tr><tr><td align="center"><strong>异步处理</strong></td><td align="left">交易日志异步写入</td><td align="left">响应时间减少50%</td></tr><tr><td align="center"><strong>SQL优化</strong></td><td align="left">使用批量操作、避免SELECT *</td><td align="left">减少网络传输</td></tr><tr><td align="center"><strong>JVM调优</strong></td><td align="left">合理设置堆内存、GC策略</td><td align="left">减少STW时间</td></tr></tbody></table>
<h3 data-id="heading-28">十、总结</h3>
<h4 data-id="heading-29">10.1 核心要点回顾</h4>
<pre><code class="hljs language-erlang" lang="erlang">┌─────────────────────────────────────────────────────────────┐
│              冷热钱包系统核心要点总结                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  一、设计思想                                                │
│  ├─ 冷热钱包分离：安全性与流动性平衡                          │
│  ├─ 空间换时间：用架构换性能                                  │
│  └─ 竞争变协作：把串行变并行                                  │
│                                                             │
│  二、核心技术                                                │
│  ├─ Redis分布式锁：应用层并发控制                            │
│  ├─ 数据库乐观锁：数据层最终保障                              │
│  ├─ 自动调拨机制：用户体验优化                                │
│  └─ 事务管理：数据一致性保证                                 │
│                                                             │
│  三、实施效果                                                │
│  ├─ 并发能力：提升<span class="hljs-number">10</span>倍以上                                   │
│  ├─ 响应时间：降低到<span class="hljs-number">100</span>ms以内                                │
│  ├─ 系统稳定性：<span class="hljs-number">99.9</span><span class="hljs-comment">%可用性                                  │</span>
│  └─ 用户体验：交易成功率接近<span class="hljs-number">100</span><span class="hljs-comment">%                             │</span>
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-30">10.2 适用场景</h4>
<p>冷热钱包架构适用于以下场景：</p>






























<table><thead><tr><th align="left">场景</th><th align="center">适用性</th><th align="left">原因</th></tr></thead><tbody><tr><td align="left"><strong>电商平台</strong></td><td align="center">⭐⭐⭐⭐⭐</td><td align="left">高并发秒杀、订单支付</td></tr><tr><td align="left"><strong>在线支付</strong></td><td align="center">⭐⭐⭐⭐⭐</td><td align="left">实时转账、钱包余额</td></tr><tr><td align="left"><strong>O2O服务</strong></td><td align="center">⭐⭐⭐⭐</td><td align="left">预付款、会员余额</td></tr><tr><td align="left"><strong>共享经济</strong></td><td align="center">⭐⭐⭐</td><td align="left">押金、余额管理</td></tr></tbody></table>
<h4 data-id="heading-31">10.3 写在最后</h4>
<p>冷热钱包架构是支付系统设计中的经典方案，它巧妙地平衡了<strong>安全性、性能和用户体验</strong>三者之间的关系。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AppLovin 危机升级：SDK 安全争议未平，建议移除为妙]]></title>    <link>https://juejin.cn/post/7603283691457527818</link>    <guid>https://juejin.cn/post/7603283691457527818</guid>    <pubDate>2026-02-06T06:33:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603283691457527818" data-draft-id="7603347438012547107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AppLovin 危机升级：SDK 安全争议未平，建议移除为妙"/> <meta itemprop="keywords" content="APP,Apple,uni-app"/> <meta itemprop="datePublished" content="2026-02-06T06:33:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS研究院"/> <meta itemprop="url" content="https://juejin.cn/user/1421041942671774"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AppLovin 危机升级：SDK 安全争议未平，建议移除为妙
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1421041942671774/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS研究院
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T06:33:45.000Z" title="Fri Feb 06 2026 06:33:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>继 1 月做空机构 CapitalWatch 指控 AppLovin 深度涉入洗钱网络、关联东南亚 “杀猪盘” 后，这场资本风波的余震仍在持续。最新市场数据显示，截至 2026 年 2 月 5 日，AppLovin（股票代码：APP）股价已从 2025 年 11 月 10 日的 651.32 美元跌至 375.23 美元，<strong>三个月累计跌幅达 42.39%</strong> ；仅 2 月前 5 个交易日，股价就从 483 美元跌至 375.23 美元，单周跌幅超 22%，换手率最高达 6.65%，市场恐慌情绪可见一斑。</p>
<h3 data-id="heading-1">争议再发酵：从股东合规到 SDK 技术风险</h3>
<p>此前 CapitalWatch 的报告已指出，AppLovin 主要股东 Hao Tang、Ling Tang（被指为 Hao Tang 亲属）及关联方合计持股超 28%，涉嫌通过广告业务协助转移团贷网非法集资款、东南亚诈骗资金。尽管 AppLovin 全盘否认指控，称 “无法控制个人股票买卖”，但市场对其<strong>股东层面的合规失职</strong>质疑未消 —— 作为上市公司，对主要股东的背景审查、反洗钱流程是否到位，至今仍是未解之谜。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8534212848f540dc82e963b5ac96cf13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaU9T56CU56m26Zmi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964425&amp;x-signature=HiKXXc7USyyqiTXHWzlAf0HPWcg%3D" alt="" loading="lazy"/></p>
<p>更关键的是，这场争议已直接波及普通开发者。有行业分析指出，AppLovin 的 SDK 存在两大核心风险：一是<strong>技术合规问题</strong>，其 SDK 被曝包含指纹追踪、静默安装功能，前者可能违反用户隐私保护法规（如 GDPR、CCPA），后者则可能绕过用户授权强制安装应用，存在被应用商店下架的隐患；二是<strong>连带风险</strong>，若后续监管部门（如美国司法部、SEC）对 AppLovin 启动调查，或要求平台自查涉事 SDK，开发者可能面临 “猝不及防的下架压力”，影响应用正常运营。</p>
<h3 data-id="heading-2">股价暴跌背后：多重利空下的市场信心崩塌</h3>
<p>从股价走势看，AppLovin 的颓势并非偶然。除了洗钱、SDK 合规争议，其商业模式本身也存在隐忧。此前已有做空机构指出，AppLovin 约 35% 的广告收入来自超休闲游戏，而这类业务的<strong>虚假点击占比或达 20%</strong> ；同时，公司 60% 的流量依赖 Meta 和 Google，若上游平台调整政策，收入可能面临断崖式下跌。</p>
<p>叠加最新的合规风险，机构对其估值的分歧持续扩大。截至 2 月，尽管仍有 9 家机构给出 “强力推荐” 评级，但最低目标价仅 80 美元，较当前股价隐含 75.8% 的跌幅。空头仓位也在激增，1 月 3 日单日做空量占比达 21.36%，累计空头仓位超流通股 15%，逼近熔断阈值，市场对其信心已降至冰点。</p>
<h3 data-id="heading-3">开发者应对指南：规避风险刻不容缓</h3>
<p>面对 AppLovin 的多重危机，开发者需优先考虑业务稳定性，避免踩入合规 “雷区”：</p>
<ul>
<li><strong>评估替换方案</strong>：若当前应用集成了 AppLovin SDK，建议尽快调研广告聚合平台，通过接入多渠道广告源，降低对单一 SDK 的依赖，避免因 SDK 下架导致收入断层；</li>
<li><strong>自查合规细节</strong>：重点检查 AppLovin SDK 的指纹追踪、静默安装功能是否关闭，确保用户数据收集、应用安装流程符合当地隐私法规（如 GDPR 的用户同意要求）；</li>
<li><strong>跟踪监管动态</strong>：密切关注美国司法部、SEC 及应用商店（如苹果 App Store、Google Play）的最新政策，若出现针对 AppLovin 的调查或下架通知，需第一时间启动应急方案。</li>
</ul>
<p>AppLovin 的案例也为整个行业敲响警钟：在选择第三方 SDK 时，除了关注流量、收益，更需穿透式审查合规情况。</p>
<p>毕竟，<strong>一次合规危机带来的损失，可能远超过去的收益</strong>。</p>
<p><code>遵守规则，方得长治久安</code>，最后祝大家大吉大利，今晚过审！</p>
<h3 data-id="heading-4">相关推荐</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FURmC_4vxQv5ttOg8yYe7Eg" target="_blank" title="https://mp.weixin.qq.com/s/URmC_4vxQv5ttOg8yYe7Eg" ref="nofollow noopener noreferrer"># 苹果开发者续费大坑及成功续费方案！亲测有效</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F1bAA90Tzpx03tTHZbdg3aw" target="_blank" title="https://mp.weixin.qq.com/s/1bAA90Tzpx03tTHZbdg3aw" ref="nofollow noopener noreferrer"># AppStore敏感词排查手册，多维度分析Guideline 2.3.1隐藏功能，轻松过审。</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FV2F4BaEYh5HfeUUHm1tI6Q" target="_blank" title="https://mp.weixin.qq.com/s/V2F4BaEYh5HfeUUHm1tI6Q" ref="nofollow noopener noreferrer"># 如何主动提防苹果3.2f的进攻，自查防御手册（代码篇）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FLs3su8fmMckTocPwMmFaNQ" target="_blank" title="https://mp.weixin.qq.com/s/Ls3su8fmMckTocPwMmFaNQ" ref="nofollow noopener noreferrer"># 如何主动提防苹果3.2f的进攻，自查防御手册（ASO篇）</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484371%26idx%3D1%26sn%3D33568c58e90a5bf4d2612d803ecb2a27%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484371&amp;idx=1&amp;sn=33568c58e90a5bf4d2612d803ecb2a27&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果加急审核是“绿色通道”还是“死亡陷阱”？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484362%26idx%3D1%26sn%3Dea61bd42d5ae8b99d2a56cbfb8d91e88%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484362&amp;idx=1&amp;sn=ea61bd42d5ae8b99d2a56cbfb8d91e88&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 苹果开发者邮箱，突然收到11.2通知严重么？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484413%26idx%3D1%26sn%3D82870d4c8892fa65803a8e05fd5ac938%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484413&amp;idx=1&amp;sn=82870d4c8892fa65803a8e05fd5ac938&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 不想被苹果卡审最好错开这两个提审时间</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484349%26idx%3D1%26sn%3D1c75a6b08cb5de64ddf41a88b61ff108%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484349&amp;idx=1&amp;sn=1c75a6b08cb5de64ddf41a88b61ff108&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 手撕苹果审核4.3是代码问题还是设计问题？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUxMTkxNzAzMw%3D%3D%26mid%3D2247484344%26idx%3D1%26sn%3D4399eb8d8bf82e9c5df26a18b8564cfb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUxMTkxNzAzMw==&amp;mid=2247484344&amp;idx=1&amp;sn=4399eb8d8bf82e9c5df26a18b8564cfb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer"># 有幸和Appstore审核人员进行了一场视频会议特此记录。</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI卖广告，吵到了超级碗：全球网友围观奥特曼破防]]></title>    <link>https://juejin.cn/post/7603347438012629027</link>    <guid>https://juejin.cn/post/7603347438012629027</guid>    <pubDate>2026-02-06T06:35:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603347438012629027" data-draft-id="7603347438012612643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI卖广告，吵到了超级碗：全球网友围观奥特曼破防"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-02-06T06:35:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI卖广告，吵到了超级碗：全球网友围观奥特曼破防
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T06:35:39.000Z" title="Fri Feb 06 2026 06:35:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>高端商战，往往就是这么朴实无华。</p>
<p>OpenAI 上个月才宣布要在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2651012368%26idx%3D1%26sn%3D44c0709a46446f8b67df438d68c17815%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2651012368&amp;idx=1&amp;sn=44c0709a46446f8b67df438d68c17815&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">ChatGPT 里加广告</a>，Anthropic 就挑了个超级碗的时间节点，播出嘲讽 ChatGPT 的广告。</p>
<p>「意有所指」的超级碗广告</p>
<p>在这支颇具讽刺意味的广告中，一个男子在健身教练旁边艰难地做引体向上。</p>
<p>这位健身教练是 AI 助手的化身，当男子向他请教制定健身计划时，「助手」却突然插入了一条保健品广告，让男子一脸懵逼。</p>
<p>最绝的是，广告末尾来了这么一句话：Ads are coming to Al. But not to Claude.（AI 正在迎来广告，但 Claude 不会。）</p>
<p>字字不提 ChatGPT，但字字都指向 ChatGPT，你就说妙不妙吧。</p>
<p>难怪有网友想去见见 Claude 的公关团队。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24fe3e6e1ec8440a93eb325e66c866f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964539&amp;x-signature=LePZEwIT2d0JxjOEjGF9SlTglhU%3D" alt="图片" loading="lazy"/></p>
<p>配合这则广告，Anthropic 在周三发布博客正式宣布：Claude 将永久保持无广告状态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b56c7e61c3cf4707a4c5f057fdb49406~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964539&amp;x-signature=FOjJCf2VS04etBjfRYgrBGLLmO8%3D" alt="图片" loading="lazy"/></p>
<p>「有很多适合做广告的好地方，但跟 Claude 聊天的地儿，真的不合适塞广告。」Anthropic 认为，在 AI 对话中植入广告与 Claude「一个真正有助于工作和深度思考助手」的定位不兼容。</p>
<p>这一立场被很多人解读为对着 OpenAI 「贴脸开大」。</p>
<p>因为上个月 OpenAI 宣布开始在免费用户和 ChatGPT Go 订阅用户中测试横幅广告，这些广告会出现在回复底部，但不会影响聊天机器人的实际答案。而付费订阅 Plus、Pro、Business 和 Enterprise 套餐的用户则不会看到广告。</p>
<p>Anthropic 在博文中强调：「我们希望 Claude 明确无误地为用户利益行事，所以我们做出了选择：Claude 将保持无广告状态。我们的用户不会在与 Claude 的对话旁边看到赞助链接，Claude 的回复也不会受到广告商的影响，或包含用户没有要求的第三方产品植入。」</p>
<p>公司进一步解释了这一决定背后的考量。</p>
<p>内部分析显示，许多 Claude 对话涉及「敏感或深度私人」的话题，或需要持续专注于复杂任务。在这些场景下，广告的出现会显得「不协调、甚至在很多情况下是不恰当的」。</p>
<p>Anthropic 还指出，广告会引入可能与提供真正有用建议相冲突的激励机制。</p>
<p>他们举了个例子：当用户提到睡眠问题时，无广告助手会探索各种可能的原因，而有广告支持的助手可能会将对话引向某个交易。</p>
<p>「用户不应该需要去猜测 AI 是真正在帮助他们，还是在巧妙地将对话引向可以变现的方向。」</p>
<p>不过，Anthropic 并非完全拒绝商业化。</p>
<p>他们表示 AI 将越来越多地与商业互动，公司期待以帮助用户的方式支持这一点。他们特别看好「代理式商务」，即 Claude 代表用户全程代理完成购买或预订等操作。</p>
<p>公司还在探索更多方式让 Claude 成为提高生产力的专注空间，用户已经可以连接 Figma、Asana、Canva 等第三方工具，并直接在 Claude 中与它们交互。所有第三方交互都将遵循同一个核心设计原则：由用户发起，而非由广告商发起。</p>
<p>奥特曼的反击「小作文」</p>
<p>对此，OpenAI CEO 萨姆・奥特曼迅速发布一篇反击小作文。</p>
<p>他开篇先承认：「首先说好的一面：Anthropic 的广告确实很有趣，我笑了。」但紧接着话锋一转，直接质疑 Anthropic 为何要采用「如此明显不诚实」的手法。</p>
<p>奥特曼强调，OpenAI 关于广告的最重要原则就是不会像 Anthropic 所描绘的那样做。「我们不傻，我们知道用户会拒绝那样的做法。」</p>
<p>他表示，Anthropic 一贯的双重标准倒是挺符合品牌形象的，「用欺骗性广告来批评实际上并不存在的理论上的欺骗性广告，但我没想到他们会把这招用在超级碗广告上。」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c984618029c44aaba576b83b5220583~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964539&amp;x-signature=I1ln2QZq7iNtL0hYP8208RcU56s%3D" alt="图片" loading="lazy"/></p>
<p>奥特曼还将这场争论上升到了 AI 普惠的高度。</p>
<p>「我们相信每个人都应该使用 AI，并致力于提供免费访问，因为我们相信访问权创造了能动性。」他披露了一个数据：仅在德克萨斯州免费使用 ChatGPT 的人数就超过了全美使用 Claude 的总人数，因此 OpenAI 面临着与 Anthropic「不同的问题」。他补充道，对于付费订阅 Plus 或 Pro 的用户，OpenAI 不会显示广告。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a9c16fa790540a5aabcbcc5d2f6a591~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964539&amp;x-signature=H7KrFeUpavCJ8ZH%2FIKi4zJjmzfE%3D" alt="图片" loading="lazy"/></p>
<p>随后，奥特曼的批评变得更加尖锐。他指责 Anthropic「服务于富人的昂贵产品」，并且「想要控制人们如何使用 AI」。</p>
<p>具体来说，Anthropic 屏蔽不喜欢的公司使用其编码产品（包括 OpenAI），想要自己制定 AI 使用规则，现在还想告诉其他公司该采用什么商业模式。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/116f7ceba7a34d65806c1ae04f1720b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964539&amp;x-signature=zh17SE1%2BXd7u71SynVDosR9fUE8%3D" alt="图片" loading="lazy"/></p>
<p>「我们致力于广泛的民主决策和访问权。我们也致力于为先进 AI 构建最具韧性的生态系统，」奥特曼写道，「我们非常关心安全、广泛有益的 AGI，我们知道实现这一目标的唯一途径是与世界合作做好准备。」</p>
<p>他声称：「一家独裁公司无法单独实现这一目标，更不用说其他明显的风险了。这是一条黑暗的道路。」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9bef1111e51478b8dffa3c01280f357~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964539&amp;x-signature=oDby10wqiW9yXDMDGkP9xwkvcjA%3D" alt="图片" loading="lazy"/></p>
<p>网友评论：一场各执一词的大辩论</p>
<p>这个事在社交媒体上也引发了激烈讨论。</p>
<p>知名博主 Yuchen Jin 认为：「AI 广告这事本身就很讽刺。Anthropic 不需要广告，它专注于编码和 B2B 业务；谷歌靠广告为生，也不需要 LLM 广告来获得短期收入；嘲笑 OpenAI 的广告反而成了他们最好的广告。」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5acea6dfecdc4e37a00a5a9225b9d915~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964539&amp;x-signature=0y9MUF8%2B%2BWJH9HL4NN2p755kATg%3D" alt="图片" loading="lazy"/></p>
<p>X 平台博主 @scaling01 则站在了 Anthropic 一边，对奥特曼的承诺表示强烈质疑。</p>
<p>他转发奥特曼的文章并评论道：「OpenAI 又在做它最擅长的事了，对他们的『广告原则』做出空洞的承诺。只要投资者稍微推一把，你们就会像纸牌屋一样不堪一击。OpenAI 已经一次又一次地证明了这一点，你们每次都选择利润，削弱非营利性。」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a1c164efadf493ea58a8a6256f18ae8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964539&amp;x-signature=f%2BmRAOkUi4AlwXg0BtjiLpe73Fs%3D" alt="图片" loading="lazy"/></p>
<p>不过也有人对 Anthropic 的动机提出了质疑。</p>
<p>风投机构 Wing_VC 的合伙人 Tanay Jaipuria 认为，Anthropic 声称 Claude 将保持无广告状态，是在争取本・汤普森所说的「战略信用」。</p>
<p>「现实是，相对于 ChatGPT，Claude 的免费用户基数非常小，而且与他们的企业战略无关，所以在其中投放广告对他们来说本就毫无意义。」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5ae822695404e818dbef061a4b12f99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964539&amp;x-signature=eMTsfGAFhBkWYuguKSbQtORkRiQ%3D" alt="图片" loading="lazy"/></p>
<p>这场「论战」背后，是两家公司截然不同的发展困境和商业选择。</p>
<p>OpenAI 这边，在 2025 年签订了价值超过 1.4 万亿美元的基础设施交易。根据《华尔街日报》获得的文件显示，OpenAI 预计今年将烧掉大约90亿美元，同时产生130亿美元的收入。ChatGPT 的 8 亿周活跃用户中，只有大约 5% 会付费订阅。</p>
<p>巨大的财务压力让奥特曼改变了此前的立场。他在 2024 年哈佛大学的一次采访中曾表示，广告与 AI 对话的结合「异常令人不安」，他不想「弄清楚到底是谁在付费影响我看到的内容」。</p>
<p>另一边的 Anthropic，同样尚未盈利，但预计会比 OpenAI 更快实现盈利。Anthropic 没有试图通过大规模建设数据中心来覆盖全球，其商业模式主要依赖企业合同和付费订阅。据 Axios 报道，Claude Code 和 Cowork 已经带来了至少 10 亿美元的收入。</p>
<p>私以为，这场口水仗没有绝对的对错，OpenAI 和 Anthropic 都在用自己的方式回答一个问题：AI 公司到底该怎么活下去，并且活得体面？</p>
<p>参考链接：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farstechnica.com%2Fai%2F2026%2F02%2Fshould-ai-chatbots-have-ads-anthropic-says-no%2F" target="_blank" title="https://arstechnica.com/ai/2026/02/should-ai-chatbots-have-ads-anthropic-says-no/" ref="nofollow noopener noreferrer">arstechnica.com/ai/2026/02/…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fclaude-is-a-space-to-think" target="_blank" title="https://www.anthropic.com/news/claude-is-a-space-to-think" ref="nofollow noopener noreferrer">www.anthropic.com/news/claude…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsama%2Fstatus%2F2019139174339928189" target="_blank" title="https://x.com/sama/status/2019139174339928189" ref="nofollow noopener noreferrer">x.com/sama/status…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch 9.X Java客户端API实战指南（入门教学版）]]></title>    <link>https://juejin.cn/post/7603263490342862857</link>    <guid>https://juejin.cn/post/7603263490342862857</guid>    <pubDate>2026-02-06T06:36:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603263490342862857" data-draft-id="7603393977476235290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch 9.X Java客户端API实战指南（入门教学版）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T06:36:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch 9.X Java客户端API实战指南（入门教学版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T06:36:28.000Z" title="Fri Feb 06 2026 06:36:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在现代搜索与数据分析场景中，Elasticsearch（以下简称ES）早已成为核心组件，广泛应用于日志分析、<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269982258%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%2585%25A8%25E6%2596%2587%25E6%25A3%2580%25E7%25B4%25A2%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269982258&amp;content_type=Article&amp;match_order=1&amp;q=%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2&amp;zhida_source=entity" ref="nofollow noopener noreferrer">全文检索</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269982258%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2595%25B0%25E6%258D%25AE%25E5%258F%25AF%25E8%25A7%2586%25E5%258C%2596%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269982258&amp;content_type=Article&amp;match_order=1&amp;q=%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%86%E5%8C%96&amp;zhida_source=entity" ref="nofollow noopener noreferrer">数据可视化</a>等领域。随着ES 9.X版本的正式发布，其官方Java客户端API迎来了重大更新——<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269982258%26content_type%3DArticle%26match_order%3D1%26q%3DRestHighLevelClient%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269982258&amp;content_type=Article&amp;match_order=1&amp;q=RestHighLevelClient&amp;zhida_source=entity" ref="nofollow noopener noreferrer">RestHighLevelClient</a>被彻底废弃</strong>，取而代之的是全新的<code>elasticsearch-java</code>客户端。</p>
<p>对于习惯了低版本ES与旧客户端的开发者而言，这次更新无疑增加了上手成本。官方新客户端采用了更简洁的Fluent DSL语法，更轻量的依赖设计，且能与ES服务端API实时同步演进，从根本上解决了旧客户端依赖耦合重、请求构建臃肿、与REST文档脱节的痛点。</p>
<p>本文专为ES 9.X新手打造，摒弃复杂理论，聚焦实际开发场景，详细讲解新Java客户端的基础依赖配置与核心API使用（含文档CRUD、检索、聚合、分页排序），所有代码均可直接复制运行，助力开发者快速上手新客户端。</p>
<h2 data-id="heading-1">一、环境准备与<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269982258%26content_type%3DArticle%26match_order%3D2%26q%3D%25E4%25BE%259D%25E8%25B5%2596%25E9%2585%258D%25E7%25BD%25AE%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269982258&amp;content_type=Article&amp;match_order=2&amp;q=%E4%BE%9D%E8%B5%96%E9%85%8D%E7%BD%AE&amp;zhida_source=entity" ref="nofollow noopener noreferrer">依赖配置</a></h2>
<p>使用ES 9.X Java客户端前，需确保本地/服务器已部署ES 9.X版本（客户端版本需与服务端版本严格一致，避免版本冲突引发异常），本文以<code>9.1.0</code>版本为例进行演示。</p>
<h3 data-id="heading-2">1.1 Maven依赖（更推荐）</h3>
<p>在项目<code>pom.xml</code>中引入以下依赖，核心依赖为<code>elasticsearch-java</code>，额外引入<code>lombok</code>简化实体类开发（可选，若不使用可手动实现getter/setter）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ES 9.X Java客户端核心依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>co.elastic.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Lombok依赖（简化实体类，可选） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 可选：Jackson依赖（若JSON序列化异常可添加） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.15.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">1.2 Gradle依赖</h3>
<p>若项目使用Gradle构建，添加以下依赖至<code>build.gradle</code>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// ES 9.X Java客户端核心依赖</span>
implementation <span class="hljs-string">'co.elastic.clients:elasticsearch-java:9.1.0'</span>
<span class="hljs-comment">// Lombok依赖（可选）</span>
compileOnly <span class="hljs-string">'org.projectlombok:lombok:1.18.24'</span>
annotationProcessor <span class="hljs-string">'org.projectlombok:lombok:1.18.24'</span>
<span class="hljs-comment">// 可选：Jackson依赖</span>
implementation <span class="hljs-string">'com.fasterxml.jackson.core:jackson-databind:2.15.2'</span>
</code></pre>
<h3 data-id="heading-4">1.3 依赖注意事项</h3>
<ul>
<li>核心依赖<code>elasticsearch-java</code>版本必须与ES服务端版本一致（如ES服务端为9.1.0，客户端也需为9.1.0），否则会出现版本兼容异常（如<code>NoSuchMethodError</code>、未知参数异常）。</li>
<li>无需额外引入ES服务端核心包，新客户端已彻底解耦旧客户端的强依赖问题，体积更轻量。</li>
<li>多模块项目中，需确保所有子模块的ES客户端版本统一，避免出现多个客户端实例冲突的情况。</li>
</ul>
<h2 data-id="heading-5">二、核心API实战（基础必学）</h2>
<p>本文以「商品（Product）」为示例实体，模拟实际业务场景，讲解新客户端的各项基础操作。所有代码均包含完整注释，新手可直接复制到项目中测试（需替换ES服务端地址、账号密码）。</p>
<h3 data-id="heading-6">2.1 定义示例实体类</h3>
<p>创建商品实体类<code>Product</code>，对应ES中的<code>products</code>索引，字段含义：<code>sku</code>（商品唯一标识）、<code>name</code>（商品名称）、<code>price</code>（商品价格）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> lombok.<span class="hljs-property">AllArgsConstructor</span>;
<span class="hljs-keyword">import</span> lombok.<span class="hljs-property">Data</span>;
<span class="hljs-keyword">import</span> lombok.<span class="hljs-property">NoArgsConstructor</span>;

<span class="hljs-comment">/**
 * 商品实体类（对应ES的products索引）
 * 注：<span class="hljs-doctag">@Data</span>注解等价于<span class="hljs-doctag">@Getter</span>+<span class="hljs-doctag">@Setter</span>+<span class="hljs-doctag">@ToString</span>+<span class="hljs-doctag">@EqualsAndHashCode</span>+<span class="hljs-doctag">@RequiredArgsConstructor</span>
 * 若不使用Lombok，需手动实现getter/setter方法
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@AllArgsConstructor</span>  <span class="hljs-comment">// 全参构造方法</span>
<span class="hljs-meta">@NoArgsConstructor</span>   <span class="hljs-comment">// 无参构造方法（JSON反序列化必须）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-comment">// 商品唯一标识（对应ES文档id）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> sku;
    <span class="hljs-comment">// 商品名称（可用于全文检索、精确检索）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
    <span class="hljs-comment">// 商品价格（可用于范围查询、聚合统计）</span>
    <span class="hljs-keyword">private</span> double price;
}
</code></pre>
<h3 data-id="heading-7">2.2 创建ES客户端（核心步骤）</h3>
<p>ES 9.X Java客户端通过<code>ElasticsearchClient</code>类实现与服务端的连接，支持配置服务端地址、账号密码、超时时间等参数。客户端为重量级对象，建议全局单例创建，避免频繁创建/销毁导致资源泄露。</p>
<p><strong>2.2.1 基础创建（简洁版）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.ElasticsearchClient;
<span class="hljs-keyword">import</span> co.elastic.clients.json.jackson.JacksonJsonpMapper;
<span class="hljs-keyword">import</span> co.elastic.clients.transport.rest_client.RestClientTransport;
<span class="hljs-keyword">import</span> org.elasticsearch.client.RestClient;

<span class="hljs-keyword">import</span> java.net.URI;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EsClientUtil</span> {
    <span class="hljs-comment">// 单例客户端实例</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ElasticsearchClient esClient;

    <span class="hljs-comment">// 初始化客户端（静态代码块，项目启动时执行一次）</span>
    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 配置ES服务端地址（单机：单个URI；集群：多个URI用逗号分隔）</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">serverUrl</span> <span class="hljs-operator">=</span> <span class="hljs-string">"http://127.0.0.1:9200"</span>; <span class="hljs-comment">// 替换为你的ES服务端地址</span>
            <span class="hljs-comment">// 2. 创建RestClient（底层HTTP连接）</span>
            <span class="hljs-type">RestClient</span> <span class="hljs-variable">restClient</span> <span class="hljs-operator">=</span> RestClient.builder(URI.create(serverUrl))
                    <span class="hljs-comment">// 配置账号密码（若ES未开启权限验证，可省略此步骤）</span>
                    .setBasicAuth(<span class="hljs-string">"elastic"</span>, <span class="hljs-string">"123456"</span>) <span class="hljs-comment">// 替换为你的ES账号密码</span>
                    .build();

            <span class="hljs-comment">// 3. 创建传输层（指定JSON序列化方式，Jackson为默认推荐）</span>
            <span class="hljs-type">RestClientTransport</span> <span class="hljs-variable">transport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestClientTransport</span>(
                    restClient, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JacksonJsonpMapper</span>()
            );

            <span class="hljs-comment">// 4. 创建最终的ES客户端</span>
            esClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ElasticsearchClient</span>(transport);
            System.out.println(<span class="hljs-string">"ES 9.X客户端初始化成功！"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"ES客户端初始化失败，请检查服务端地址和账号密码"</span>);
        }
    }

    <span class="hljs-comment">// 获取客户端实例（对外提供统一访问入口）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ElasticsearchClient <span class="hljs-title function_">getEsClient</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> esClient;
    }

    <span class="hljs-comment">// 关闭客户端（项目停止时调用，释放资源）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeClient</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (esClient != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 关闭传输层和RestClient</span>
                esClient._transport().close();
                esClient._transport().restClient().close();
                System.out.println(<span class="hljs-string">"ES客户端已关闭"</span>);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
}

<span class="hljs-comment">// 使用方式（任何地方直接调用）</span>
<span class="hljs-comment">// ElasticsearchClient client = EsClientUtil.getEsClient();</span>
</code></pre>
<p><strong>2.2.2 进阶配置（超时、集群）</strong></p>
<p>若需配置连接超时、读取超时，或连接ES集群，可修改客户端初始化逻辑，示例如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 集群配置+超时配置（替换上面的静态代码块）</span>
<span class="hljs-keyword">static</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 集群地址（多个节点用逗号分隔）</span>
        String[] serverUrls = {<span class="hljs-string">"http://127.0.0.1:9200"</span>, <span class="hljs-string">"http://127.0.0.1:9201"</span>, <span class="hljs-string">"http://127.0.0.1:9202"</span>};
        <span class="hljs-comment">// 构建RestClientBuilder</span>
        RestClient.<span class="hljs-type">Builder</span> <span class="hljs-variable">restClientBuilder</span> <span class="hljs-operator">=</span> RestClient.builder(
                Arrays.stream(serverUrls).map(URI::create).toArray(URI[]::<span class="hljs-keyword">new</span>)
        );

        <span class="hljs-comment">// 配置账号密码</span>
        restClientBuilder.setBasicAuth(<span class="hljs-string">"elastic"</span>, <span class="hljs-string">"123456"</span>);

        <span class="hljs-comment">// 配置超时时间（可选，根据业务调整）</span>
        restClientBuilder.setRequestConfigCallback(requestConfigBuilder -&gt; 
                requestConfigBuilder
                        .setConnectTimeout(<span class="hljs-number">5000</span>)  <span class="hljs-comment">// 连接超时：5秒</span>
                        .setSocketTimeout(<span class="hljs-number">10000</span>) <span class="hljs-comment">// 读取超时：10秒</span>
        );

        <span class="hljs-comment">// 后续步骤（传输层、客户端创建）与基础版一致</span>
        <span class="hljs-type">RestClient</span> <span class="hljs-variable">restClient</span> <span class="hljs-operator">=</span> restClientBuilder.build();
        <span class="hljs-type">RestClientTransport</span> <span class="hljs-variable">transport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestClientTransport</span>(restClient, <span class="hljs-keyword">new</span> <span class="hljs-title class_">JacksonJsonpMapper</span>());
        esClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ElasticsearchClient</span>(transport);
        System.out.println(<span class="hljs-string">"ES集群客户端初始化成功！"</span>);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        e.printStackTrace();
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"ES客户端初始化失败"</span>);
    }
}
</code></pre>
<h3 data-id="heading-8">2.3 文档操作（CRUD核心）</h3>
<p>ES文档操作是基础，新客户端提供两种请求构建方式：<strong>Fluent DSL</strong>（简洁优雅，推荐）和<strong>Builder模式</strong>（灵活，适合复杂场景），以下分别演示。</p>
<p><strong>2.3.1 插入文档（单条）</strong></p>
<p>插入文档即向ES索引中添加一条数据，可指定文档id（推荐用业务唯一标识，如商品sku），也可让ES自动生成id。</p>
<p><strong>方式1：Fluent DSL（推荐）</strong></p>
<pre><code class="hljs language-csharp" lang="csharp">import co.elastic.clients.elasticsearch.core.IndexRequest;
import co.elastic.clients.elasticsearch.core.IndexResponse;

<span class="hljs-comment">/**
 * 单条插入文档（Fluent DSL方式）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EsDocumentInsert</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 获取ES客户端</span>
            ElasticsearchClient client = EsClientUtil.getEsClient();

            <span class="hljs-comment">// 2. 构建商品数据（模拟业务数据）</span>
            Product product = <span class="hljs-keyword">new</span> Product(<span class="hljs-string">"sku001"</span>, <span class="hljs-string">"苹果14 Pro"</span>, <span class="hljs-number">7999.0</span>);

            <span class="hljs-comment">// 3. 构建插入请求（Fluent DSL语法，链式调用）</span>
            IndexRequest&lt;Product&gt; request = IndexRequest.of(i -&gt; i
                    .index(<span class="hljs-string">"products"</span>)          <span class="hljs-comment">// 指定索引名称（若索引不存在，ES会自动创建，建议提前创建）</span>
                    .id(product.getSku())       <span class="hljs-comment">// 指定文档id（与商品sku一致，便于后续查询和修改）</span>
                    .document(product)          <span class="hljs-comment">// 传入要插入的实体对象（自动序列化为JSON）</span>
                    .refresh(<span class="hljs-literal">true</span>)              <span class="hljs-comment">// 插入后立即刷新索引（便于立即查询到，生产环境可根据性能调整）</span>
            );

            <span class="hljs-comment">// 4. 执行插入操作，获取响应结果</span>
            IndexResponse response = client.index(request);

            <span class="hljs-comment">// 5. 解析响应结果</span>
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"文档插入成功！"</span>);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"索引名称："</span> + response.index());
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"文档id："</span> + response.id());
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"插入状态："</span> + response.result()); <span class="hljs-comment">// created（新增）/ updated（覆盖）</span>

        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"文档插入失败："</span> + e.getMessage());
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 项目停止时关闭客户端（实际开发中可在Spring销毁方法中调用）</span>
            <span class="hljs-comment">// EsClientUtil.closeClient();</span>
        }
    }
}
</code></pre>
<p><strong>方式2：Builder模式</strong></p>
<p>Builder模式更灵活，可动态设置请求参数（如条件判断后设置refresh、timeout等）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.core.IndexRequest;

<span class="hljs-comment">/**
 * 单条插入文档（Builder模式）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EsDocumentInsertByBuilder</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ElasticsearchClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> EsClientUtil.getEsClient();

            <span class="hljs-comment">// 1. 构建商品数据</span>
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"sku002"</span>, <span class="hljs-string">"华为Mate 60"</span>, <span class="hljs-number">6999.0</span>);

            <span class="hljs-comment">// 2. 构建插入请求Builder</span>
            IndexRequest.Builder&lt;Product&gt; requestBuilder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>.Builder&lt;Product&gt;();
            requestBuilder.index(<span class="hljs-string">"products"</span>);          <span class="hljs-comment">// 指定索引</span>
            requestBuilder.id(product.getSku());       <span class="hljs-comment">// 指定文档id</span>
            requestBuilder.document(product);          <span class="hljs-comment">// 传入实体对象</span>
            requestBuilder.refresh(<span class="hljs-literal">true</span>);              <span class="hljs-comment">// 立即刷新</span>

            <span class="hljs-comment">// 3. 构建请求并执行</span>
            <span class="hljs-type">IndexResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.index(requestBuilder.build());

            <span class="hljs-comment">// 4. 解析响应</span>
            System.out.println(<span class="hljs-string">"Builder模式插入成功，文档id："</span> + response.id());

        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p><strong>2.3.2 批量插入文档</strong></p>
<p>当需要插入多条文档时（如数据导入），使用批量插入可大幅提升效率，避免单条插入频繁请求ES服务端。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.core.BulkRequest;
<span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.core.BulkResponse;
<span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.core.bulk.BulkOperation;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 批量插入文档（推荐用于多条数据导入场景）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EsDocumentBulkInsert</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ElasticsearchClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> EsClientUtil.getEsClient();

            <span class="hljs-comment">// 1. 模拟批量商品数据（实际开发中可从数据库、文件中读取）</span>
            List&lt;Product&gt; productList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
            productList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"sku003"</span>, <span class="hljs-string">"小米14"</span>, <span class="hljs-number">4999.0</span>));
            productList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"sku004"</span>, <span class="hljs-string">"OPPO Find X7"</span>, <span class="hljs-number">5999.0</span>));
            productList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"sku005"</span>, <span class="hljs-string">"vivo X100"</span>, <span class="hljs-number">5499.0</span>));

            <span class="hljs-comment">// 2. 构建批量请求Builder</span>
            BulkRequest.<span class="hljs-type">Builder</span> <span class="hljs-variable">bulkBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BulkRequest</span>.Builder();

            <span class="hljs-comment">// 3. 遍历商品列表，添加批量操作（每条数据对应一个index操作）</span>
            <span class="hljs-keyword">for</span> (Product product : productList) {
                bulkBuilder.operations(op -&gt; op
                        .index(idx -&gt; idx          <span class="hljs-comment">// 每条操作都是插入操作</span>
                                .index(<span class="hljs-string">"products"</span>)  <span class="hljs-comment">// 指定索引</span>
                                .id(product.getSku()) <span class="hljs-comment">// 指定文档id</span>
                                .document(product)  <span class="hljs-comment">// 传入商品数据</span>
                        )
                );
            }

            <span class="hljs-comment">// 4. 执行批量插入，获取响应</span>
            <span class="hljs-type">BulkResponse</span> <span class="hljs-variable">bulkResponse</span> <span class="hljs-operator">=</span> client.bulk(bulkBuilder.build());

            <span class="hljs-comment">// 5. 解析批量响应结果（批量操作可能部分成功、部分失败，需校验）</span>
            <span class="hljs-keyword">if</span> (bulkResponse.errors()) {
                System.out.println(<span class="hljs-string">"批量插入存在失败项，详情如下："</span>);
                bulkResponse.items().forEach(item -&gt; {
                    <span class="hljs-keyword">if</span> (item.error() != <span class="hljs-literal">null</span>) {
                        System.out.println(<span class="hljs-string">"文档id："</span> + item.id() + <span class="hljs-string">"，插入失败："</span> + item.error().reason());
                    }
                });
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"批量插入全部成功！"</span>);
                System.out.println(<span class="hljs-string">"插入总数："</span> + productList.size());
            }

        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
            System.out.println(<span class="hljs-string">"批量插入失败："</span> + e.getMessage());
        }
    }
}
</code></pre>
<p><strong>2.3.3 补充：创建索引（推荐提前创建）</strong></p>
<p>虽然ES会自动创建不存在的索引，但自动创建的索引字段类型可能不符合预期（如price可能被识别为text类型，无法进行范围查询），建议提前手动创建索引，指定字段类型：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.indices.CreateIndexRequest;
<span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.indices.CreateIndexResponse;

<span class="hljs-comment">/**
 * 手动创建products索引（指定字段类型，推荐提前创建）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EsIndexCreate</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ElasticsearchClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> EsClientUtil.getEsClient();

            <span class="hljs-comment">// 构建创建索引请求，指定字段映射（mapping）</span>
            <span class="hljs-type">CreateIndexRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> CreateIndexRequest.of(c -&gt; c
                    .index(<span class="hljs-string">"products"</span>)          <span class="hljs-comment">// 索引名称</span>
                    .mappings(m -&gt; m            <span class="hljs-comment">// 字段映射配置</span>
                            .properties(<span class="hljs-string">"sku"</span>, p -&gt; p.keyword())  <span class="hljs-comment">// sku：keyword类型（精确匹配，不分词）</span>
                            .properties(<span class="hljs-string">"name"</span>, p -&gt; p.text())     <span class="hljs-comment">// name：text类型（支持全文检索，分词）</span>
                            .properties(<span class="hljs-string">"price"</span>, p -&gt; p.double_()) <span class="hljs-comment">// price：double类型（支持数值运算、范围查询）</span>
                    )
            );

            <span class="hljs-comment">// 执行创建操作</span>
            <span class="hljs-type">CreateIndexResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.indices().create(request);

            <span class="hljs-keyword">if</span> (response.acknowledged()) {
                System.out.println(<span class="hljs-string">"products索引创建成功！"</span>);
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"products索引创建失败！"</span>);
            }

        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 若索引已存在，会抛出异常，可忽略或捕获处理</span>
            <span class="hljs-keyword">if</span> (e.getMessage().contains(<span class="hljs-string">"resource_already_exists_exception"</span>)) {
                System.out.println(<span class="hljs-string">"products索引已存在，无需重复创建！"</span>);
            } <span class="hljs-keyword">else</span> {
                e.printStackTrace();
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-9">2.4 检索操作（核心重点）</h3>
<p>ES的核心优势在于检索，新客户端支持全文检索、精确检索、组合检索等常见场景，以下结合商品场景详细演示，所有示例均基于<code>products</code>索引和批量插入的数据。</p>
<p><strong>2.4.1 全文检索（matchAll/match）</strong></p>
<p>全文检索适用于模糊查询场景（如根据商品名称搜索），ES会对查询关键词进行分词，匹配所有包含分词结果的文档。</p>
<p><strong>场景1：查询所有文档（matchAll）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.core.SearchRequest;
<span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.core.SearchResponse;
<span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.core.search.Hit;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 全文检索 - 查询所有文档（matchAll）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EsSearchMatchAll</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ElasticsearchClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> EsClientUtil.getEsClient();

            <span class="hljs-comment">// 1. 构建查询请求（查询products索引下所有文档）</span>
            <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> SearchRequest.of(s -&gt; s
                    .index(<span class="hljs-string">"products"</span>)          <span class="hljs-comment">// 指定索引</span>
                    .query(q -&gt; q.matchAll(m -&gt; m)) <span class="hljs-comment">// 全文检索 - 匹配所有文档</span>
            );

            <span class="hljs-comment">// 2. 执行查询，获取响应</span>
            SearchResponse&lt;Product&gt; response = client.search(request, Product.class);

            <span class="hljs-comment">// 3. 解析响应结果（获取命中的文档列表）</span>
            List&lt;Hit&lt;Product&gt;&gt; hits = response.hits().hits();
            System.out.println(<span class="hljs-string">"查询到的文档总数："</span> + response.hits().total().value());
            System.out.println(<span class="hljs-string">"查询结果详情："</span>);

            <span class="hljs-comment">// 遍历文档列表，获取商品信息</span>
            <span class="hljs-keyword">for</span> (Hit&lt;Product&gt; hit : hits) {
                <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> hit.source(); <span class="hljs-comment">// 反序列化为Product实体</span>
                System.out.println(<span class="hljs-string">"文档id："</span> + hit.id() + <span class="hljs-string">"，商品信息："</span> + product);
            }

        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p><strong>场景2：根据关键词模糊查询（match）</strong></p>
<p>根据商品名称模糊查询（如搜索“14”，会匹配“苹果14 Pro”、“小米14”）：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">/**
 * 全文检索 - 关键词模糊查询（match）
 */</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">EsSearchMatch</span> {
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">ElasticsearchClient</span> <span class="hljs-selector-tag">client</span> = <span class="hljs-selector-tag">EsClientUtil</span><span class="hljs-selector-class">.getEsClient</span>();

            <span class="hljs-comment">// 1. 构建查询请求（根据商品名称模糊查询，关键词：14）</span>
            <span class="hljs-selector-tag">SearchRequest</span> <span class="hljs-selector-tag">request</span> = <span class="hljs-selector-tag">SearchRequest</span><span class="hljs-selector-class">.of</span>(s -&gt; s
                    .<span class="hljs-built_in">index</span>(<span class="hljs-string">"products"</span>)
                    .<span class="hljs-built_in">query</span>(q -&gt; q
                            .<span class="hljs-built_in">match</span>(m -&gt; m
                                    .<span class="hljs-built_in">field</span>(<span class="hljs-string">"name"</span>)     <span class="hljs-comment">// 检索的字段（商品名称）</span>
                                    .<span class="hljs-built_in">query</span>(<span class="hljs-string">"14"</span>)       <span class="hljs-comment">// 检索关键词</span>
                                    .<span class="hljs-built_in">fuzziness</span>(<span class="hljs-string">"AUTO"</span>) <span class="hljs-comment">// 模糊匹配（允许轻微拼写错误，如14写成15，可根据需求关闭）</span>
                            )
                    )
            );

            <span class="hljs-comment">// 2. 执行查询</span>
            <span class="hljs-selector-tag">SearchResponse</span>&lt;<span class="hljs-selector-tag">Product</span>&gt; <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">client</span><span class="hljs-selector-class">.search</span>(request, Product.class);

            <span class="hljs-comment">// 3. 解析结果</span>
            <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Hit</span>&lt;<span class="hljs-selector-tag">Product</span>&gt;&gt; <span class="hljs-selector-tag">hits</span> = <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.hits</span>()<span class="hljs-selector-class">.hits</span>();
            <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"匹配到的商品数量："</span> + hits.<span class="hljs-built_in">size</span>());
            <span class="hljs-selector-tag">hits</span><span class="hljs-selector-class">.forEach</span>(hit -&gt; {
                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"商品："</span> + hit.<span class="hljs-built_in">source</span>().<span class="hljs-built_in">getName</span>() + <span class="hljs-string">"，价格："</span> + hit.<span class="hljs-built_in">source</span>().<span class="hljs-built_in">getPrice</span>());
            });

        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">e</span><span class="hljs-selector-class">.printStackTrace</span>();
        }
    }
}
</code></pre>
<p><strong>2.4.2 精确检索（term/range）</strong></p>
<p>精确检索适用于无需分词、精准匹配的场景，常见两种类型：<code>term</code>（词条精确匹配）和<code>range</code>（范围匹配）。</p>
<p><strong>场景1：term精确匹配（keyword字段推荐）</strong></p>
<p>适用于匹配固定词条（如根据sku查询商品、根据商品名称精确匹配），注意：text类型字段使用term查询可能无法匹配（因text会分词），推荐用于keyword字段。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
 * 精确检索 - term词条匹配（适用于keyword字段）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EsSearchTerm</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-keyword">try</span> {
            ElasticsearchClient client = EsClientUtil.getEsClient();

            <span class="hljs-comment">// 1. 构建查询请求（根据sku精确查询商品，sku为keyword字段）</span>
            SearchRequest request = SearchRequest.of(s -&gt; s
                    .index(<span class="hljs-string">"products"</span>)
                    .query(q -&gt; q
                            .term(t -&gt; t
                                    .field(<span class="hljs-string">"sku"</span>)      <span class="hljs-comment">// 检索字段（sku，keyword类型）</span>
                                    .<span class="hljs-keyword">value</span>(<span class="hljs-string">"sku001"</span>)   <span class="hljs-comment">// 精确匹配的值</span>
                            )
                    )
            );

            <span class="hljs-comment">// 2. 执行查询</span>
            SearchResponse&lt;Product&gt; response = client.search(request, Product.<span class="hljs-keyword">class</span>);

            <span class="hljs-comment">// 3. 解析结果</span>
            List&lt;Hit&lt;Product&gt;&gt; hits = response.hits().hits();
            <span class="hljs-keyword">if</span> (hits.isEmpty()) {
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"未查询到对应商品！"</span>);
            } <span class="hljs-keyword">else</span> {
                Product product = hits.<span class="hljs-keyword">get</span>(<span class="hljs-number">0</span>).source();
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"精确查询到的商品："</span> + product);
            }

        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p><strong>场景2：range范围查询（数值字段推荐）</strong></p>
<p>适用于数值、日期等字段的范围匹配（如查询价格在5000-8000之间的商品），ES 9.X中数值类型的range查询需使用<code>number</code>函数，避免踩坑！</p>
<pre><code class="hljs language-ini" lang="ini">import co.elastic.clients.elasticsearch.core.search.RangeQuery<span class="hljs-comment">;</span>

/**
 * 精确检索 - range范围查询（适用于数值、日期字段）
 */
public class EsSearchRange {
    public static void main(String<span class="hljs-section">[]</span> args) {
        try {
            ElasticsearchClient <span class="hljs-attr">client</span> = EsClientUtil.getEsClient()<span class="hljs-comment">;</span>

            // 1. 构建range查询条件（价格范围：5000 ≤ price ≤ 8000）
            RangeQuery <span class="hljs-attr">rangeQuery</span> = RangeQuery.of(r -&gt; r
                    .number(n -&gt; n            // 必须使用number函数（数值类型专用），不可直接用field
                            .field("price")  // 检索字段（price，double类型）
                            .gte(5000.0)     // 大于等于（<span class="hljs-attr">gte</span> = greater than or equal）
                            .lte(8000.0)     // 小于等于（<span class="hljs-attr">lte</span> = less than or equal）
                            // 可选：gt（大于）、lt（小于）
                    )
            )<span class="hljs-comment">;</span>

            // 2. 构建查询请求，传入range查询条件
            SearchRequest <span class="hljs-attr">request</span> = SearchRequest.of(s -&gt; s
                    .index("products")
                    .query(q -&gt; q.range(rangeQuery)) // 执行range查询
            )<span class="hljs-comment">;</span>

            // 3. 执行查询并解析结果
            SearchResponse&lt;Product&gt; <span class="hljs-attr">response</span> = client.search(request, Product.class)<span class="hljs-comment">;</span>
            List&lt;Hit&lt;Product&gt;&gt; <span class="hljs-attr">hits</span> = response.hits().hits()<span class="hljs-comment">;</span>
            System.out.println("价格在5000-8000之间的商品数量：" + hits.size())<span class="hljs-comment">;</span>
            hits.forEach(hit -&gt; {
                Product <span class="hljs-attr">product</span> = hit.source()<span class="hljs-comment">;</span>
                System.out.println("商品名称：" + product.getName() + "，价格：" + product.getPrice())<span class="hljs-comment">;</span>
            })<span class="hljs-comment">;</span>

        } catch (Exception e) {
            e.printStackTrace()<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<p><strong>2.4.3 组合检索（Bool Query）</strong></p>
<p>实际业务中，检索条件往往是多个条件的组合（如“商品名称包含14”且“价格在5000以上”且“排除sku001”），此时需使用<code>Bool Query</code>组合多个查询条件。</p>
<p>Bool Query核心子句（必懂）：</p>
<ul>
<li><code>must</code>：必须满足该条件（参与评分，影响查询结果排序）</li>
<li><code>mustNot</code>：必须不满足该条件（不参与评分）</li>
<li><code>filter</code>：必须满足该条件（不参与评分，可缓存，提升查询性能）</li>
<li><code>should</code>：可选满足该条件（满足会增加评分，不满足不影响）</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.core.search.BoolQuery;
<span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.core.search.MatchQuery;
<span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.core.search.Query;
<span class="hljs-keyword">import</span> co.elastic.clients.elasticsearch.core.search.TermQuery;

<span class="hljs-comment">/**
 * 组合检索 - Bool Query（多条件组合查询，实际业务高频使用）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EsSearchBool</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ElasticsearchClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> EsClientUtil.getEsClient();

            <span class="hljs-comment">// 1. 构建子查询条件</span>
            <span class="hljs-comment">// 子查询1：商品名称包含"14"（must，必须满足，参与评分）</span>
            <span class="hljs-type">Query</span> <span class="hljs-variable">nameQuery</span> <span class="hljs-operator">=</span> MatchQuery.of(m -&gt; m
                    .field(<span class="hljs-string">"name"</span>)
                    .query(<span class="hljs-string">"14"</span>)
            )._toQuery(); <span class="hljs-comment">// 转换为通用Query类型</span>

            <span class="hljs-comment">// 子查询2：价格大于5000（filter，必须满足，不参与评分，提升性能）</span>
            <span class="hljs-type">RangeQuery</span> <span class="hljs-variable">priceRangeQuery</span> <span class="hljs-operator">=</span> RangeQuery.of(r -&gt; r
                    .number(n -&gt; n
                            .field(<span class="hljs-string">"price"</span>)
                            .gt(<span class="hljs-number">5000.0</span>) <span class="hljs-comment">// 大于5000（gt = greater than）</span>
                    )
            );
            <span class="hljs-type">Query</span> <span class="hljs-variable">priceFilterQuery</span> <span class="hljs-operator">=</span> priceRangeQuery._toQuery();

            <span class="hljs-comment">// 子查询3：排除sku001（mustNot，必须不满足）</span>
            <span class="hljs-type">Query</span> <span class="hljs-variable">excludeSkuQuery</span> <span class="hljs-operator">=</span> TermQuery.of(t -&gt; t
                    .field(<span class="hljs-string">"sku"</span>)
                    .value(<span class="hljs-string">"sku001"</span>)
            )._toQuery();

            <span class="hljs-comment">// 2. 组合Bool Query（将多个子查询组合起来）</span>
            <span class="hljs-type">BoolQuery</span> <span class="hljs-variable">boolQuery</span> <span class="hljs-operator">=</span> BoolQuery.of(b -&gt; b
                    .must(nameQuery)           <span class="hljs-comment">// 必须满足：名称包含14</span>
                    .filter(priceFilterQuery)  <span class="hljs-comment">// 必须满足：价格&gt;5000（过滤，不评分）</span>
                    .mustNot(excludeSkuQuery)  <span class="hljs-comment">// 必须不满足：sku != sku001</span>
            );

            <span class="hljs-comment">// 3. 构建查询请求，执行Bool查询</span>
            <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> SearchRequest.of(s -&gt; s
                    .index(<span class="hljs-string">"products"</span>)
                    .query(q -&gt; q.bool(boolQuery)) <span class="hljs-comment">// 传入组合好的Bool查询</span>
            );

            <span class="hljs-comment">// 4. 执行查询并解析结果</span>
            SearchResponse&lt;Product&gt; response = client.search(request, Product.class);
            List&lt;Hit&lt;Product&gt;&gt; hits = response.hits().hits();
            System.out.println(<span class="hljs-string">"组合查询匹配到的商品数量："</span> + hits.size());
            hits.forEach(hit -&gt; {
                <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> hit.source();
                System.out.println(<span class="hljs-string">"商品："</span> + product.getName() + <span class="hljs-string">"，sku："</span> + product.getSku() + <span class="hljs-string">"，价格："</span> + product.getPrice());
            });

        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<h3 data-id="heading-10">2.5 分页与排序</h3>
<p>实际开发中，检索结果往往需要分页（如前端列表分页）和排序（如按价格升序/降序），ES 9.X客户端支持灵活的分页排序配置，以下结合商品场景演示。</p>
<p><strong>2.5.1 基础分页排序（from+size）</strong></p>
<p>适用于浅分页场景（数据量较小，分页深度较浅），核心参数：</p>
<ul>
<li><code>from</code>：起始偏移量（从第几条数据开始查询，默认0）</li>
<li><code>size</code>：每页显示条数</li>
<li><code>sort</code>：排序配置（指定排序字段和排序方向）</li>
</ul>
<p>注意：from+size方式在深度分页（如from=10000，size=10）时会存在严重性能瓶颈，因为ES需要从每个分片读取10010条数据，再聚合排序后截取结果，大数据量场景建议使用Search After或Scroll API。</p>
<pre><code class="hljs language-csharp" lang="csharp">import co.elastic.clients.elasticsearch.core.search.SortOrder;

<span class="hljs-comment">/**
 * 分页与排序（基础from+size方式，适用于浅分页）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EsSearchPageSort</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-keyword">try</span> {
            ElasticsearchClient client = EsClientUtil.getEsClient();

            <span class="hljs-comment">// 1. 模拟前端分页参数（实际开发中从前端接收）</span>
            <span class="hljs-built_in">int</span> currentPage = <span class="hljs-number">1</span>;       <span class="hljs-comment">// 当前页码（前端默认从1开始，ES从0开始）</span>
            <span class="hljs-built_in">int</span> pageSize = <span class="hljs-number">2</span>;          <span class="hljs-comment">// 每页显示条数</span>
            String sortField = <span class="hljs-string">"price"</span>;<span class="hljs-comment">// 排序字段（商品价格）</span>
            String sortOrder = <span class="hljs-string">"desc"</span>; <span class="hljs-comment">// 排序方向（desc：降序；asc：升序）</span>

            <span class="hljs-comment">// 2. 计算起始偏移量（from = (当前页码-1) * 每页条数）</span>
            <span class="hljs-built_in">int</span> <span class="hljs-keyword">from</span> = (currentPage - <span class="hljs-number">1</span>) * pageSize;

            <span class="hljs-comment">// 3. 构建查询请求（分页+排序+条件查询）</span>
            SearchRequest request = SearchRequest.of(s -&gt; s
                    .index(<span class="hljs-string">"products"</span>)
                    .<span class="hljs-keyword">from</span>(<span class="hljs-keyword">from</span>)                <span class="hljs-comment">// 起始偏移量</span>
                    .size(pageSize)            <span class="hljs-comment">// 每页条数</span>
                    .sort(so -&gt; so             <span class="hljs-comment">// 排序配置</span>
                            .field(f -&gt; f
                                    .field(sortField)  <span class="hljs-comment">// 排序字段</span>
                                    <span class="hljs-comment">// 排序方向：根据前端参数动态设置</span>
                                    .order(<span class="hljs-string">"desc"</span>.<span class="hljs-keyword">equals</span>(sortOrder) ? SortOrder.Desc : SortOrder.Asc)
                            )
                    )
                    .query(q -&gt; q              <span class="hljs-comment">// 可选：添加查询条件（如价格&gt;5000）</span>
                            .range(r -&gt; r
                                    .number(n -&gt; n
                                            .field(<span class="hljs-string">"price"</span>)
                                            .gt(<span class="hljs-number">5000.0</span>)
                                    )
                            )
                    )
            );

            <span class="hljs-comment">// 4. 执行查询并解析结果</span>
            SearchResponse&lt;Product&gt; response = client.search(request, Product.<span class="hljs-keyword">class</span>);
            List&lt;Hit&lt;Product&gt;&gt; hits = response.hits().hits();

            <span class="hljs-comment">// 解析分页相关信息</span>
            <span class="hljs-built_in">long</span> total = response.hits().total().<span class="hljs-keyword">value</span>(); <span class="hljs-comment">// 总条数</span>
            <span class="hljs-built_in">long</span> totalPage = (total + pageSize - <span class="hljs-number">1</span>) / pageSize; <span class="hljs-comment">// 总页数</span>

            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"分页查询结果："</span>);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"总条数："</span> + total + <span class="hljs-string">"，总页数："</span> + totalPage + <span class="hljs-string">"，当前页码："</span> + currentPage);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"当前页商品："</span>);
            hits.forEach(hit -&gt; {
                Product product = hit.source();
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"商品："</span> + product.getName() + <span class="hljs-string">"，价格："</span> + product.getPrice());
            });

        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p><strong>2.5.2 补充：深度分页解决方案</strong></p>
<p>针对大数据量深度分页场景，推荐使用以下两种方案，避免from+size的性能瓶颈：</p>
<ol>
<li><strong>Search After（推荐实时深度分页）</strong> ：基于上一页最后一条数据的排序值作为“锚点”，避免计算偏移量，支持实时查询，适合前端列表分页（如APP商品列表翻页）。</li>
<li><strong>Scroll API（适合批量导出/批处理）</strong> ：创建查询快照，通过游标批量获取结果，不支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269982258%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%25AE%259E%25E6%2597%25B6%25E6%2595%25B0%25E6%258D%25AE%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269982258&amp;content_type=Article&amp;match_order=1&amp;q=%E5%AE%9E%E6%97%B6%E6%95%B0%E6%8D%AE&amp;zhida_source=entity" ref="nofollow noopener noreferrer">实时数据</a>（快照创建后的数据变更不会体现），适合全量数据导出、ETL流程等离线场景。</li>
</ol>
<h3 data-id="heading-11">2.6 聚合操作（统计分析）</h3>
<p>聚合操作适用于<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D269982258%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2595%25B0%25E6%258D%25AE%25E7%25BB%259F%25E8%25AE%25A1%25E5%2588%2586%25E6%259E%2590%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=269982258&amp;content_type=Article&amp;match_order=1&amp;q=%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1%E5%88%86%E6%9E%90&amp;zhida_source=entity" ref="nofollow noopener noreferrer">数据统计分析</a>场景（如商品价格平均值、不同类别的商品数量统计），ES 9.X客户端支持基础聚合和多级嵌套聚合，以下结合示例演示。</p>
<p><strong>2.6.1 基础聚合（stats/terms）</strong></p>
<p>常见基础聚合类型：</p>
<ul>
<li><code>stats</code>：统计聚合（计算字段的平均值、最大值、最小值、总和、计数）</li>
<li><code>terms</code>：分组聚合（根据字段分组，统计每组的文档数量）</li>
</ul>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.Aggregate</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.StatsAggregate</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.StringTermsAggregate</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.StringTermsBucket</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Map</span>;

<span class="hljs-comment">/**
 * 基础聚合操作（stats统计聚合 + terms分组聚合）
 */</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">EsAggregationBasic</span> {
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">ElasticsearchClient</span> <span class="hljs-selector-tag">client</span> = <span class="hljs-selector-tag">EsClientUtil</span><span class="hljs-selector-class">.getEsClient</span>();

            <span class="hljs-comment">// 1. 构建基础查询条件（可选：过滤需要统计的数据）</span>
            <span class="hljs-selector-tag">RangeQuery</span> <span class="hljs-selector-tag">rangeQuery</span> = <span class="hljs-selector-tag">RangeQuery</span><span class="hljs-selector-class">.of</span>(r -&gt; r
                    .<span class="hljs-built_in">number</span>(n -&gt; n
                            .<span class="hljs-built_in">field</span>(<span class="hljs-string">"price"</span>)
                            .<span class="hljs-built_in">gte</span>(<span class="hljs-number">5000.0</span>)
                            .<span class="hljs-built_in">lte</span>(<span class="hljs-number">10000.0</span>)
                    )
            );

            <span class="hljs-comment">// 2. 构建查询请求，添加聚合操作</span>
            <span class="hljs-selector-tag">SearchRequest</span> <span class="hljs-selector-tag">request</span> = <span class="hljs-selector-tag">SearchRequest</span><span class="hljs-selector-class">.of</span>(s -&gt; s
                    .<span class="hljs-built_in">index</span>(<span class="hljs-string">"products"</span>)
                    .<span class="hljs-built_in">query</span>(q -&gt; q.<span class="hljs-built_in">range</span>(rangeQuery)) <span class="hljs-comment">// 基础过滤条件（价格5000-10000）</span>
                    .<span class="hljs-built_in">from</span>(<span class="hljs-number">0</span>).<span class="hljs-built_in">size</span>(<span class="hljs-number">10</span>)               <span class="hljs-comment">// 分页：只查询前10条文档（聚合结果不受影响）</span>
                    <span class="hljs-comment">// 聚合1：价格统计（stats），聚合名称：price_stats</span>
                    .<span class="hljs-built_in">aggregations</span>(<span class="hljs-string">"price_stats"</span>, a -&gt; a
                            .<span class="hljs-built_in">stats</span>(st -&gt; st.<span class="hljs-built_in">field</span>(<span class="hljs-string">"price"</span>))
                    )
                    <span class="hljs-comment">// 聚合2：按商品类别分组（terms），聚合名称：category_terms（此处假设存在category字段）</span>
                    .<span class="hljs-built_in">aggregations</span>(<span class="hljs-string">"category_terms"</span>, a -&gt; a
                            .<span class="hljs-built_in">terms</span>(t -&gt; t
                                    .<span class="hljs-built_in">field</span>(<span class="hljs-string">"category.keyword"</span>) <span class="hljs-comment">// category字段需为keyword类型（分组聚合推荐）</span>
                                    .<span class="hljs-built_in">size</span>(<span class="hljs-number">10</span>)                  <span class="hljs-comment">// 只显示前10个分组</span>
                            )
                    )
            );

            <span class="hljs-comment">// 3. 执行查询，获取响应</span>
            <span class="hljs-selector-tag">SearchResponse</span>&lt;<span class="hljs-selector-tag">Product</span>&gt; <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">client</span><span class="hljs-selector-class">.search</span>(request, Product.class);

            <span class="hljs-comment">// 4. 解析聚合结果（核心步骤）</span>
            <span class="hljs-selector-tag">if</span> (response.<span class="hljs-built_in">aggregations</span>() != null) {
                <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Aggregate</span>&gt; <span class="hljs-selector-tag">aggregations</span> = <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.aggregations</span>();

                <span class="hljs-comment">// 4.1 解析价格统计聚合（stats）</span>
                <span class="hljs-selector-tag">StatsAggregate</span> <span class="hljs-selector-tag">priceStats</span> = <span class="hljs-selector-tag">aggregations</span><span class="hljs-selector-class">.get</span>(<span class="hljs-string">"price_stats"</span>)<span class="hljs-selector-class">.stats</span>();
                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"商品价格统计（5000-10000元）："</span>);
                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"平均价格："</span> + String.<span class="hljs-built_in">format</span>(<span class="hljs-string">"%.2f"</span>, priceStats.<span class="hljs-built_in">avg</span>()));
                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"最高价格："</span> + priceStats.<span class="hljs-built_in">max</span>());
                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"最低价格："</span> + priceStats.<span class="hljs-built_in">min</span>());
                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"价格总和："</span> + priceStats.<span class="hljs-built_in">sum</span>());
                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"统计商品数量："</span> + priceStats.<span class="hljs-built_in">count</span>());

                <span class="hljs-comment">// 4.2 解析类别分组聚合（terms）</span>
                <span class="hljs-selector-tag">StringTermsAggregate</span> <span class="hljs-selector-tag">categoryTerms</span> = <span class="hljs-selector-tag">aggregations</span><span class="hljs-selector-class">.get</span>(<span class="hljs-string">"category_terms"</span>)<span class="hljs-selector-class">.sterms</span>();
                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"\n商品类别分组统计："</span>);
                <span class="hljs-selector-tag">for</span> (StringTermsBucket <span class="hljs-attribute">bucket </span>: categoryTerms.<span class="hljs-built_in">buckets</span>().<span class="hljs-built_in">array</span>()) {
                    <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">category</span> = <span class="hljs-selector-tag">bucket</span><span class="hljs-selector-class">.key</span>(); <span class="hljs-comment">// 分组名称（类别）</span>
                    <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">count</span> = <span class="hljs-selector-tag">bucket</span><span class="hljs-selector-class">.docCount</span>(); <span class="hljs-comment">// 该类别的商品数量</span>
                    <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"类别："</span> + category + <span class="hljs-string">"，商品数量："</span> + count);
                }
            }

            <span class="hljs-comment">// 5. 解析文档结果（可选）</span>
            <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.hits</span>()<span class="hljs-selector-class">.hits</span>()<span class="hljs-selector-class">.forEach</span>(hit -&gt; {
                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"\n文档详情："</span> + hit.<span class="hljs-built_in">source</span>());
            });

        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">e</span><span class="hljs-selector-class">.printStackTrace</span>();
        }
    }
}
</code></pre>
<p><strong>2.6.2 多级嵌套聚合（terms+range+avg/sum）</strong></p>
<p>多级嵌套聚合适用于复杂统计场景（如“按商品类别分组 → 每组内按价格区间分组 → 统计每个价格区间的平均评分和销售总量”），以下修复原始代码bug，演示完整嵌套聚合。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.AvgAggregate</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.RangeAggregate</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.RangeBucket</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.StringTermsAggregate</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.StringTermsBucket</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.TopHitsAggregate</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.SearchHit</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.json</span><span class="hljs-selector-class">.JsonData</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">co</span><span class="hljs-selector-class">.elastic</span><span class="hljs-selector-class">.clients</span><span class="hljs-selector-class">.elasticsearch</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.search</span><span class="hljs-selector-class">.SortOrder</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Map</span>;

<span class="hljs-comment">/**
 * 多级嵌套聚合（terms分组 → range分组 → avg/sum统计）
 */</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">EsAggregationNested</span> {
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">ElasticsearchClient</span> <span class="hljs-selector-tag">client</span> = <span class="hljs-selector-tag">EsClientUtil</span><span class="hljs-selector-class">.getEsClient</span>();

            <span class="hljs-comment">// 1. 构建基础过滤条件（调整价格范围，覆盖后续所有区间，避免统计不到数据）</span>
            <span class="hljs-selector-tag">RangeQuery</span> <span class="hljs-selector-tag">rangeQuery</span> = <span class="hljs-selector-tag">RangeQuery</span><span class="hljs-selector-class">.of</span>(r -&gt; r
                    .<span class="hljs-built_in">number</span>(n -&gt; n
                            .<span class="hljs-built_in">field</span>(<span class="hljs-string">"price"</span>)
                            .<span class="hljs-built_in">gte</span>(<span class="hljs-number">0.0</span>)       <span class="hljs-comment">// 覆盖低价区间</span>
                            .<span class="hljs-built_in">lte</span>(<span class="hljs-number">200.0</span>)     <span class="hljs-comment">// 覆盖高价区间</span>
                    )
            );

            <span class="hljs-comment">// 2. 构建多级嵌套聚合查询请求</span>
            <span class="hljs-selector-tag">SearchRequest</span> <span class="hljs-selector-tag">request</span> = <span class="hljs-selector-tag">SearchRequest</span><span class="hljs-selector-class">.of</span>(s -&gt; s
                    .<span class="hljs-built_in">index</span>(<span class="hljs-string">"products"</span>)
                    .<span class="hljs-built_in">query</span>(q -&gt; q.<span class="hljs-built_in">range</span>(rangeQuery))  <span class="hljs-comment">// 基础过滤条件，筛选有效商品</span>
                    .<span class="hljs-built_in">size</span>(<span class="hljs-number">0</span>)                          <span class="hljs-comment">// 不返回具体文档，只关注聚合结果（提升查询性能）</span>
                    <span class="hljs-comment">// 第一级聚合：按商品类别分组（terms），聚合名称：category_analysis</span>
                    .<span class="hljs-built_in">aggregations</span>(<span class="hljs-string">"category_analysis"</span>, a -&gt; a
                            .<span class="hljs-built_in">terms</span>(t -&gt; t
                                    .<span class="hljs-built_in">field</span>(<span class="hljs-string">"category.keyword"</span>) <span class="hljs-comment">// 按类别分组（keyword类型，确保分组精准）</span>
                                    .<span class="hljs-built_in">size</span>(<span class="hljs-number">10</span>)                  <span class="hljs-comment">// 显示前10个类别，可根据需求调整</span>
                            )
                            <span class="hljs-comment">// 第二级聚合1：按价格区间分组（range），聚合名称：price_ranges</span>
                            .<span class="hljs-built_in">aggregations</span>(<span class="hljs-string">"price_ranges"</span>, a2 -&gt; a2
                                    .<span class="hljs-built_in">range</span>(r -&gt; r
                                            .<span class="hljs-built_in">field</span>(<span class="hljs-string">"price"</span>)  <span class="hljs-comment">// 价格区间分组字段（数值类型）</span>
                                            .<span class="hljs-built_in">ranges</span>(         <span class="hljs-comment">// 定义3个价格区间，清晰区分低/中/高价</span>
                                                    range -&gt; range.<span class="hljs-built_in">key</span>(<span class="hljs-string">"low"</span>).<span class="hljs-built_in">from</span>(<span class="hljs-number">0.0</span>).<span class="hljs-built_in">to</span>(<span class="hljs-number">50.0</span>),      <span class="hljs-comment">// 0-50元（低价）</span>
                                                    range -&gt; range.<span class="hljs-built_in">key</span>(<span class="hljs-string">"medium"</span>).<span class="hljs-built_in">from</span>(<span class="hljs-number">50.0</span>).<span class="hljs-built_in">to</span>(<span class="hljs-number">100.0</span>),  <span class="hljs-comment">// 50-100元（中价）</span>
                                                    range -&gt; range.<span class="hljs-built_in">key</span>(<span class="hljs-string">"high"</span>).<span class="hljs-built_in">from</span>(<span class="hljs-number">100.0</span>).<span class="hljs-built_in">to</span>(<span class="hljs-number">200.0</span>)  <span class="hljs-comment">// 100-200元（高价）</span>
                                            )
                                    )
                                    <span class="hljs-comment">// 第三级聚合1：每个价格区间的平均评分（avg）</span>
                                    .<span class="hljs-built_in">aggregations</span>(<span class="hljs-string">"avg_rating"</span>, a3 -&gt; a3
                                            .<span class="hljs-built_in">avg</span>(avg -&gt; avg.<span class="hljs-built_in">field</span>(<span class="hljs-string">"rating"</span>)) <span class="hljs-comment">// 假设存在rating（商品评分）字段</span>
                                    )
                                    <span class="hljs-comment">// 第三级聚合2：每个价格区间的销售总量（sum）</span>
                                    .<span class="hljs-built_in">aggregations</span>(<span class="hljs-string">"total_sales"</span>, a3 -&gt; a3
                                            .<span class="hljs-built_in">sum</span>(sum -&gt; sum.<span class="hljs-built_in">field</span>(<span class="hljs-string">"sales"</span>)) <span class="hljs-comment">// 假设存在sales（商品销量）字段</span>
                                    )
                            )
                            <span class="hljs-comment">// 第二级聚合2：每个类别下的热门商品（topHits），取销量前3</span>
                            .<span class="hljs-built_in">aggregations</span>(<span class="hljs-string">"top_products"</span>, a2 -&gt; a2
                                    .<span class="hljs-built_in">topHits</span>(th -&gt; th
                                            .<span class="hljs-built_in">size</span>(<span class="hljs-number">3</span>) <span class="hljs-comment">// 每个类别显示前3个热门商品</span>
                                            .<span class="hljs-built_in">sort</span>(so -&gt; so
                                                    .<span class="hljs-built_in">field</span>(f -&gt; f
                                                            .<span class="hljs-built_in">field</span>(<span class="hljs-string">"sales"</span>) <span class="hljs-comment">// 按销量降序排序，筛选热门</span>
                                                            .<span class="hljs-built_in">order</span>(SortOrder.Desc)
                                                    )
                                            )
                                    )
                            )
                    )
            );

            <span class="hljs-comment">// 3. 执行查询，获取响应结果</span>
            <span class="hljs-selector-tag">SearchResponse</span>&lt;<span class="hljs-selector-tag">Product</span>&gt; <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">client</span><span class="hljs-selector-class">.search</span>(request, Product.class);

            <span class="hljs-comment">// 4. 解析多级嵌套聚合结果（修复原始bug，完善路径获取和非空校验）</span>
            <span class="hljs-selector-tag">if</span> (response.<span class="hljs-built_in">aggregations</span>() != null) {
                <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Aggregate</span>&gt; <span class="hljs-selector-tag">rootAggregations</span> = <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.aggregations</span>();

                <span class="hljs-comment">// 4.1 获取第一级聚合：按商品类别分组（terms聚合），非空校验避免空指针</span>
                <span class="hljs-selector-tag">if</span> (rootAggregations.<span class="hljs-built_in">containsKey</span>(<span class="hljs-string">"category_analysis"</span>)) {
                    <span class="hljs-selector-tag">StringTermsAggregate</span> <span class="hljs-selector-tag">categoryAgg</span> = <span class="hljs-selector-tag">rootAggregations</span><span class="hljs-selector-class">.get</span>(<span class="hljs-string">"category_analysis"</span>)<span class="hljs-selector-class">.sterms</span>();

                    <span class="hljs-comment">// 4.2 遍历每个类别桶（第一级聚合结果）</span>
                    <span class="hljs-selector-tag">for</span> (StringTermsBucket <span class="hljs-attribute">categoryBucket </span>: categoryAgg.<span class="hljs-built_in">buckets</span>().<span class="hljs-built_in">array</span>()) {
                        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">category</span> = <span class="hljs-selector-tag">categoryBucket</span><span class="hljs-selector-class">.key</span>(); <span class="hljs-comment">// 商品类别名称</span>
                        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">categoryDocCount</span> = <span class="hljs-selector-tag">categoryBucket</span><span class="hljs-selector-class">.docCount</span>(); <span class="hljs-comment">// 该类别的商品总数</span>
                        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"=== 商品类别："</span> + category + <span class="hljs-string">"（商品总数："</span> + categoryDocCount + <span class="hljs-string">"）==="</span>);

                        <span class="hljs-comment">// 4.3 获取第二级聚合：该类别下的价格区间分组（range聚合）</span>
                        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Aggregate</span>&gt; <span class="hljs-selector-tag">categoryAggregations</span> = <span class="hljs-selector-tag">categoryBucket</span><span class="hljs-selector-class">.aggregations</span>();
                        <span class="hljs-selector-tag">if</span> (categoryAggregations.<span class="hljs-built_in">containsKey</span>(<span class="hljs-string">"price_ranges"</span>)) {
                            <span class="hljs-selector-tag">RangeAggregate</span> <span class="hljs-selector-tag">priceRangeAgg</span> = <span class="hljs-selector-tag">categoryAggregations</span><span class="hljs-selector-class">.get</span>(<span class="hljs-string">"price_ranges"</span>)<span class="hljs-selector-class">.range</span>();

                            <span class="hljs-comment">// 4.4 遍历每个价格区间桶（第二级聚合结果）</span>
                            <span class="hljs-selector-tag">for</span> (RangeBucket <span class="hljs-attribute">priceBucket </span>: priceRangeAgg.<span class="hljs-built_in">buckets</span>().<span class="hljs-built_in">array</span>()) {
                                <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">priceRange</span> = <span class="hljs-selector-tag">priceBucket</span><span class="hljs-selector-class">.key</span>(); <span class="hljs-comment">// 价格区间标识（low/medium/high）</span>
                                <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">priceDocCount</span> = <span class="hljs-selector-tag">priceBucket</span><span class="hljs-selector-class">.docCount</span>(); <span class="hljs-comment">// 该价格区间的商品数量</span>
                                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"  价格区间："</span> + priceRange + <span class="hljs-string">"（商品数量："</span> + priceDocCount + <span class="hljs-string">"）"</span>);

                                <span class="hljs-comment">// 4.5 获取第三级聚合1：该价格区间的平均评分（avg聚合）</span>
                                <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Aggregate</span>&gt; <span class="hljs-selector-tag">priceAggregations</span> = <span class="hljs-selector-tag">priceBucket</span><span class="hljs-selector-class">.aggregations</span>();
                                <span class="hljs-selector-tag">if</span> (priceAggregations.<span class="hljs-built_in">containsKey</span>(<span class="hljs-string">"avg_rating"</span>)) {
                                    <span class="hljs-selector-tag">Aggregate</span> <span class="hljs-selector-tag">avgRatingAgg</span> = <span class="hljs-selector-tag">priceAggregations</span><span class="hljs-selector-class">.get</span>(<span class="hljs-string">"avg_rating"</span>);
                                    <span class="hljs-selector-tag">if</span> (avgRatingAgg != null &amp;&amp; avgRatingAgg.<span class="hljs-built_in">isAvg</span>()) {
                                        <span class="hljs-selector-tag">AvgAggregate</span> <span class="hljs-selector-tag">avgRating</span> = <span class="hljs-selector-tag">avgRatingAgg</span><span class="hljs-selector-class">.avg</span>();
                                        <span class="hljs-comment">// 安全校验，避免null值异常，保留2位小数，提升可读性</span>
                                        <span class="hljs-selector-tag">double</span> <span class="hljs-selector-tag">avg</span> = <span class="hljs-selector-tag">avgRating</span><span class="hljs-selector-class">.value</span>() != <span class="hljs-selector-tag">null</span> ? <span class="hljs-selector-tag">avgRating</span><span class="hljs-selector-class">.value</span>() : <span class="hljs-number">0.0</span>;
                                        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"    平均评分："</span> + String.<span class="hljs-built_in">format</span>(<span class="hljs-string">"%.2f"</span>, avg));
                                    }
                                }

                                <span class="hljs-comment">// 4.6 获取第三级聚合2：该价格区间的销售总量（sum聚合）</span>
                                <span class="hljs-selector-tag">if</span> (priceAggregations.<span class="hljs-built_in">containsKey</span>(<span class="hljs-string">"total_sales"</span>)) {
                                    <span class="hljs-selector-tag">Aggregate</span> <span class="hljs-selector-tag">totalSalesAgg</span> = <span class="hljs-selector-tag">priceAggregations</span><span class="hljs-selector-class">.get</span>(<span class="hljs-string">"total_sales"</span>);
                                    <span class="hljs-selector-tag">if</span> (totalSalesAgg != null &amp;&amp; totalSalesAgg.<span class="hljs-built_in">isSum</span>()) {
                                        <span class="hljs-comment">// 解析sum聚合结果，兼容数值类型</span>
                                        <span class="hljs-selector-tag">JsonData</span> <span class="hljs-selector-tag">salesData</span> = <span class="hljs-selector-tag">totalSalesAgg</span><span class="hljs-selector-class">.sum</span>()<span class="hljs-selector-class">.value</span>();
                                        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">totalSales</span> = <span class="hljs-selector-tag">salesData</span> != <span class="hljs-selector-tag">null</span> ? <span class="hljs-selector-tag">salesData</span><span class="hljs-selector-class">.toLong</span>() : <span class="hljs-number">0</span>;
                                        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"    销售总量："</span> + totalSales);
                                    }
                                }
                            }
                        }

                        <span class="hljs-comment">// 4.7 获取第二级聚合2：该类别下的热门商品（topHits聚合）</span>
                        <span class="hljs-selector-tag">if</span> (categoryAggregations.<span class="hljs-built_in">containsKey</span>(<span class="hljs-string">"top_products"</span>)) {
                            <span class="hljs-selector-tag">Aggregate</span> <span class="hljs-selector-tag">topProductsAgg</span> = <span class="hljs-selector-tag">categoryAggregations</span><span class="hljs-selector-class">.get</span>(<span class="hljs-string">"top_products"</span>);
                            <span class="hljs-selector-tag">if</span> (topProductsAgg != null &amp;&amp; topProductsAgg.<span class="hljs-built_in">isTopHits</span>()) {
                                <span class="hljs-selector-tag">TopHitsAggregate</span> <span class="hljs-selector-tag">topHits</span> = <span class="hljs-selector-tag">topProductsAgg</span><span class="hljs-selector-class">.topHits</span>();
                                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"  该类别热门商品（销量前3）："</span>);
                                <span class="hljs-comment">// 遍历热门商品，反序列化为Product实体</span>
                                <span class="hljs-selector-tag">for</span> (SearchHit&lt;Product&gt; <span class="hljs-attribute">hit </span>: topHits.<span class="hljs-built_in">hits</span>().<span class="hljs-built_in">hits</span>()) {
                                    <span class="hljs-selector-tag">Product</span> <span class="hljs-selector-tag">product</span> = <span class="hljs-selector-tag">hit</span><span class="hljs-selector-class">.source</span>();
                                    <span class="hljs-selector-tag">if</span> (product != null) {
                                        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"    - 商品："</span> + product.<span class="hljs-built_in">getName</span>() + <span class="hljs-string">"，价格："</span> + product.<span class="hljs-built_in">getPrice</span>() + <span class="hljs-string">"，销量："</span> + hit.<span class="hljs-built_in">fields</span>().<span class="hljs-built_in">get</span>(<span class="hljs-string">"sales"</span>).<span class="hljs-built_in">value</span>());
                                    }
                                }
                            }
                        }
                        <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(); <span class="hljs-comment">// 换行，区分不同类别，提升可读性</span>
                    }
                } <span class="hljs-selector-tag">else</span> {
                    <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"未查询到商品类别聚合数据，请检查category字段是否存在且为keyword类型"</span>);
                }
            } <span class="hljs-selector-tag">else</span> {
                <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"未查询到任何聚合结果，请检查索引数据或查询条件"</span>);
            }

        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">e</span><span class="hljs-selector-class">.printStackTrace</span>();
            <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(<span class="hljs-string">"多级嵌套聚合查询失败："</span> + e.<span class="hljs-built_in">getMessage</span>());
        } <span class="hljs-selector-tag">finally</span> {
            <span class="hljs-comment">// 项目停止时关闭客户端（实际开发中可在Spring销毁方法、Tomcat关闭钩子中调用）</span>
            <span class="hljs-comment">// EsClientUtil.closeClient();</span>
        }
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[硬碰硬！Claude Opus 4.6与GPT-5.3-Codex同时发布]]></title>    <link>https://juejin.cn/post/7603308967125204992</link>    <guid>https://juejin.cn/post/7603308967125204992</guid>    <pubDate>2026-02-06T06:34:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603308967125204992" data-draft-id="7603308967125188608" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="硬碰硬！Claude Opus 4.6与GPT-5.3-Codex同时发布"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-02-06T06:34:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            硬碰硬！Claude Opus 4.6与GPT-5.3-Codex同时发布
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T06:34:34.000Z" title="Fri Feb 06 2026 06:34:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在春节来临之前，海外大模型先来了一波硬碰硬的发布。</p>
<p>北京时间 2 月 6 日凌晨，Anthropic 与 OpenAI 相继推出了新版本基础大模型，分别是 Claude Opus 4.6 与 GPT-5.3-Codex。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67495078d79d44b8ae8494fcfb9b99d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964473&amp;x-signature=DYKfkEeGPoJTymGqg3biWNWXF3I%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1a9be215f214624a87e3eb808f1bc17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964473&amp;x-signature=Yrpk7kIZsIdgMp92L0cGbWhaT3I%3D" alt="图片" loading="lazy"/></p>
<p>昨天两家还在因为 AI 里面的广告而论战，今天在大模型发布上又撞车了。话不多说，直接看他们的模型能力如何。</p>
<p>Claude Opus 4.6</p>
<p>Claude Opus 4.6 是 Anthropic 对其旗舰人工智能模型的一次重大升级。在这代模型上，规划更加谨慎，能够维持更长时间的自主工作流程，并在关键的企业基准测试中超越了包括 GPT-5.2 在内的竞争对手。</p>
<p>新模型首次拥有 100 万 token 的上下文窗口，使 AI 能够处理和推理比以往版本多得多的信息。Anthropic 还在 Claude Code 中引入了类似于 Kimi K2.5 的「智能体团队」功能 —— 一项研究预览功能，它允许多个 AI 智能体同时处理编码项目的不同方面，并进行自主协调。</p>
<p>Anthropic 强调，Opus 4.6 可将其增强的功能应用于一系列日常工作任务，包括运行财务分析、进行研究以及使用和创建文档、电子表格和演示文稿。现在在 Cowork 环境中，Claude 可以自主地执行多任务，Opus 4.6 可以代表人类运用所有这些技能。</p>
<p>Opus 4.6 在多项评估中均表现出色。例如，它在智能体编码评估工具 Terminal-Bench 2.0 中取得了最高分，并在「人类最后的考试」（一项复杂的多学科推理测试）中领先于所有其他前沿模型。在 GDPval-AA（一项评估模型在金融、法律和其他领域中具有经济价值的知识工作任务上的表现的测试）中， Opus 4.6 的表现比业界次优模型（OpenAI 的 GPT-5.2）高出约 144 个 Elo 分数，比其前身（Claude Opus 4.5）高出 190 分。此外，Opus 4.6 在 BrowseComp 测试中也优于其他所有模型，该测试用于衡量模型在线查找难寻信息的能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a5e25d3eb074c109f4d0f328044f42c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964473&amp;x-signature=J5pX6ckpk6QROCUDtIMwSlVonZc%3D" alt="图片" loading="lazy"/></p>
<p>Claude Opus 4.6 现已在 claude.ai、API 以及所有主流云平台上线，定价保持不变，每百万 token 5 美元 / 25 美元。</p>
<p>目前大模型的一个常见问题是「上下文腐烂」，即当对话 token 数量超过一定阈值时，模型性能会下降。Opus 4.6 的性能显著优于其前代产品：在 MRCR v2 的 8 针 1M 变体测试中（该测试如同大海捞针），Opus 4.6 的得分为 76%，而 Sonnet 4.5 的得分仅为 18.5%。这标志着模型在保持最佳性能的同时，能够利用的上下文信息量发生了质的飞跃。</p>
<p>为了证明 Opus 4.6 的强大智能体能力，Anthropic 的一名研究员使用 16 个智能体从零开始构建了一个基于 Rust 的 C 语言编译器，设定任务后就基本放手不管了。最后 AI 输出的代码长达 10 万行，可以编译 Linux 内核，耗资 2 万美元，超过 2000 次 Claude Code 会话，历时两周。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9864581632034172806fb0378f11dd4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964473&amp;x-signature=bSD%2B%2BiU2I73CqK%2FlNyycC%2FE%2BLtA%3D" alt="图片" loading="lazy"/></p>
<p>该编译器可以在 x86、ARM 和 RISC-V 上构建可启动的 Linux 6.9，它通过了 GCC 99% 的压力测试，可以编译 FFmpeg、Redis、PostgreSQL、QEMU，还通过了开发者的终极考验：编译并运行了 Doom 游戏。</p>
<p>该编译器的代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fclaudes-c-compiler" target="_blank" title="https://github.com/anthropics/claudes-c-compiler" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p>虽然没有人类参与编写代码，但研究人员不断重新设计测试，在智能体程序互相干扰时构建 CI 管道，并在所有 16 个智能体程序都卡在同一个 bug 时创建变通方法。</p>
<p>看起来，在未来加入 AI 的工作流程中，人的角色已经从编写代码转变为构建让 AI 能够编写代码的环境。</p>
<p>GPT-5.3-Codex</p>
<p>在 OpenAI 这边，新一代模型 GPT-5.3-Codex 的发布紧随其后。奥特曼称其拥有目前最佳的编码性能，进一步释放了 Codex 的潜能。</p>
<p>GPT-5.3-Codex 在多项基准上刷新纪录：在 SWE-Bench Pro 上达到 56.8%，在 Terminal-Bench 2.0 上达到 77.3%，同时相比此前版本运行更快、消耗的 token 更少。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/319461355643478c92fed8479a4a27f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964473&amp;x-signature=B7R2zt5Q3ljEkssNnpJ%2B3yQqMaQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33d86f3e893c4a5a93edbb33b388ec17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964473&amp;x-signature=w0KnXpsYBm9rKYXF16eQeaZPoJc%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3179e4d80f9549d18fb41434d2b9632e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964473&amp;x-signature=MKJAEuG%2FQ3XxLB3j8YBYJcw5kOI%3D" alt="图片" loading="lazy"/></p>
<p>OpenAI 表示，该模型融合了 GPT-5.2-Codex 的前沿编码性能和 GPT-5.2 的推理及专业知识能力，速度提升了 25%。这使其能够胜任需要研究、工具使用和复杂执行的长时间任务。</p>
<p>它就像一位真正的同事一样，你可以在 GPT-5.3-Codex 工作时对其进行指导和交互，而不会丢失上下文信息。借助 GPT-5.3-Codex，Codex 从一个能够编写和审查代码的代理，变成了一个几乎可以执行开发人员和专业人士在计算机上的任何操作的代理。</p>
<p>除了更加强大的编码能力外，GPT-5.2-Codex 在 OpenAI 长期关注的美学方面又一次有了长足的进步。</p>
<p>在这次发布中，OpenAI 让 GPT-5.3-Codex 构建了两款游戏：一款是 Codex 应用发布时推出的赛车游戏的第二版，另一款是潜水游戏。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2fdd3c798d340018c49435059aa01e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964473&amp;x-signature=qiJVuUx9drR3vswUmlSN4j8jduk%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/117b4ef90eca47d194bf1a5726d84d04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964473&amp;x-signature=jFfrRuAGoXPvpveYo07pXh%2B892g%3D" alt="图片" loading="lazy"/></p>
<p>OpenAI 表示，GPT-5.3-Codex 利用其网页游戏开发技能以及预先设定的通用后续提示（例如「修复错误」或「改进游戏」），自主地迭代开发了数百万个 token。</p>
<p>这次发布的 GPT-5.3-Codex ，OpenAI 对其的期望远不止步于一个智能编码模型，而是一个能够「Beyond coding」，实现工作助理的智能体。</p>
<p>GPT-5.3-Codex 能够支持软件生命周期中的所有工作 —— 调试、部署、监控、编写产品需求文档、编辑文案、用户研究、测试、指标分析等等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c44cada1a7554d46b9d72a477b9e8a2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964473&amp;x-signature=xF3nIlIqfTI2L%2FMhMcrp5YUKir8%3D" alt="图片" loading="lazy"/></p>
<p>GPT-5.3-Codex 输出净值分析表格示例</p>
<p>OpenAI 认为，随着模型能力的不断增强，差距不再仅仅在于智能体能够做什么，而是在于人类如何轻松地与多个并行工作的智能体进行交互、指导和监督。鉴于此，Codex 应用可以让管理和指导智能体变得更加便捷，而 GPT-5.3-Codex 的加入更使其交互性更强。</p>
<p>借助新模型，Codex 会频繁更新，让你随时了解关键决策和进展。人们无需等待最终输出，即可实时互动 —— 提出问题、讨论方法，并共同探索解决方案。GPT-5.3-Codex 会语音播报其运行过程，响应反馈，并让你从始至终掌握整个流程。</p>
<p>最后，OpenAI 表示，GPT-5.3-Codex 的训练和部署使用了 Codex，OpenAI 的许多研究人员和工程师都表示，他们现在的工作与两个月前相比发生了根本性的变化。</p>
<p>例如，研究团队使用 Codex 来监控和调试本次版本的训练运行。它不仅加速了基础设施问题的调试，还帮助追踪整个训练过程中的模式，对交互质量进行深入分析，提出修复方案，并构建了丰富的应用程序，使研究人员能够精确地了解模型行为与先前模型之间的差异。</p>
<p>工程团队使用 Codex 对 GPT-5.3-Codex 框架进行了优化和适配。当出现影响用户的异常极端情况时，团队成员利用 Codex 识别上下文渲染错误，并找出缓存命中率低的根本原因。在整个发布过程中，GPT-5.3-Codex 通过动态扩展 GPU 集群来应对流量高峰并保持延迟稳定，持续为团队提供支持。</p>
<p>在 Alpha 测试期间，一位研究人员想要了解 GPT-5.3-Codex 每回合能完成多少额外工作，以及由此带来的生产力提升。GPT-5.3-Codex 生成了几个简单的正则表达式分类器，用于估算用户澄清请求的频率、正面和负面反馈以及任务进度，然后将这些分类器可扩展地应用于所有会话日志，并生成一份包含结论的报告。</p>
<p>GPT-5.3-Codex 已包含在 ChatGPT 的付费套餐中，但 API 还需要等待一段时间。</p>
<p>OpenAI 报告说，由于基础设施和推理堆栈的改进，Codex 用户现在运行 GPT-5.3-Codex 的速度也提高了 25%，从而实现了更快的交互和更快的结果。</p>
<p>结语</p>
<p>海外的大模型已经轮番上阵，在春节前的最后这几天，国内大模型也必然会卷起来，包括 DeepSeek v4 也许即将到来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c0c4f7651384ffab54e25d5ab4eb0b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770964473&amp;x-signature=M2AicEL0qSn9c7%2Bevr0p56GWnY4%3D" alt="图片" loading="lazy"/></p>
<p>你期待住了吗？</p>
<p>参考内容：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fclaude-opus-4-6" target="_blank" title="https://www.anthropic.com/news/claude-opus-4-6" ref="nofollow noopener noreferrer">www.anthropic.com/news/claude…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fbuilding-c-compiler" target="_blank" title="https://www.anthropic.com/engineering/building-c-compiler" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fintroducing-gpt-5-3-codex%2F" target="_blank" title="https://openai.com/index/introducing-gpt-5-3-codex/" ref="nofollow noopener noreferrer">openai.com/index/intro…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拆解 Cursor Agent Prompt v1.2：顶级 AI 工具是如何写系统提示词的？]]></title>    <link>https://juejin.cn/post/7603261102795587610</link>    <guid>https://juejin.cn/post/7603261102795587610</guid>    <pubDate>2026-02-06T06:37:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603261102795587610" data-draft-id="7603261102795522074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拆解 Cursor Agent Prompt v1.2：顶级 AI 工具是如何写系统提示词的？"/> <meta itemprop="keywords" content="AI编程,Cursor"/> <meta itemprop="datePublished" content="2026-02-06T06:37:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狼爷"/> <meta itemprop="url" content="https://juejin.cn/user/2418581314208279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拆解 Cursor Agent Prompt v1.2：顶级 AI 工具是如何写系统提示词的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2418581314208279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狼爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T06:37:37.000Z" title="Fri Feb 06 2026 06:37:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><blockquote>
<p>当你还在反复调试「这句话的Prompt到底能不能出效果」时，Cursor已经把Prompt写成了可复用、可扩展的<strong>工程系统</strong>。</p>
</blockquote>
<p>用过Cursor的同学都知道，它的Agent Prompt（v1.2）从不是简单一句“你是一个AI编程助手”，而是一套能约束、可维护、可迭代的大模型行为规范——这才是Prompt Engineering的核心精髓。</p>
<p>这篇文章不逐句翻译Prompt原文（没意义），只拆解它背后可直接复用的8个工程化技巧。不管你是做AI编程助手、Agent系统，还是想摆脱“Prompt靠感觉”的内耗，看完都能直接落地。</p>
<p>👉 适合人群（对号入座）：</p>
<ul>
<li>做AI编程助手、Agent系统开发的开发者</li>
<li>搭建自动化工作流，需要精准Prompt的从业者</li>
<li>厌倦“Prompt玄学”，想把它升级为“可落地工程”的人</li>
<li>刚入门Prompt Engineering，想找优质案例拆解的新手</li>
</ul>
<hr/>
<h2 data-id="heading-0">一、Prompt第一原则：别只“说清楚”，更要“定边界”</h2>
<p>Cursor Prompt最反常识的一点：开篇不教模型“怎么回答”，而是先把3件事说死——这也是普通Prompt和工程级Prompt的第一个差距。</p>
<p><strong>你是谁、你能做什么、你不能做什么</strong>，这3个边界，直接决定了Prompt的稳定性。</p>
<h3 data-id="heading-1">❌ 常见低效写法（90%的人都在踩坑）</h3>
<pre><code class="hljs">你是一个聪明的AI编程助手，请帮助我写代码
</code></pre>
<p>问题在哪？太模糊！“聪明”没有标准，“写代码”没有边界，模型很容易输出无关内容、过度发挥，甚至跑偏。</p>
<h3 data-id="heading-2">✅ Cursor风格（抓本质，可直接复用模板）</h3>
<pre><code class="hljs">你是一个专注于代码理解、修改和生成的AI Agent，
仅在用户明确请求时执行操作，
不得擅自更改未被请求的文件，
不得输出任何与任务无关的解释、冗余话术。
</code></pre>
<p>👉 核心技巧（划重点，记下来）：</p>
<p>Prompt的价值，从来不是“给模型赋予能力”，而是“收敛模型的自由度”——边界越清晰，模型输出越稳定，越不需要反复调试。</p>
<hr/>
<h2 data-id="heading-3">二、结构化Prompt：把“一段话”改成“配置文件”</h2>
<p>Cursor Agent Prompt的核心亮点，就是<strong>彻底结构化</strong>。它没有用大段自然语言堆砌，而是拆成了多个职责单一的模块，像写配置文件一样写Prompt。</p>
<p>比如这样拆分（简化版，保留核心逻辑）：</p>
<ul>
<li>role：明确模型身份（不可模糊）</li>
<li>rules：约束模型行为（不可违反）</li>
<li>tool：规定工具使用（什么时候用、怎么用）</li>
<li>output：约定输出格式（统一标准，可消费）</li>
<li>context：说明上下文范围（避免失忆）</li>
</ul>
<p>为什么要这么做？因为大模型天生擅长遵守“结构化规则”，模块越清晰、职责越单一，模型越不容易混乱，后续维护和迭代也更简单。</p>
<h3 data-id="heading-4">✅ 可直接复用的结构化示例（简化版）</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">role</span>&gt;</span></span>
你是一个专注于代码重构的AI Agent，仅处理Python代码相关任务
<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">role</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">rules</span>&gt;</span></span>
<span class="hljs-bullet">1.</span>  代码修改必须遵循“最小改动”原则，不新增无关功能
<span class="hljs-bullet">2.</span>  不修改用户未明确提及的文件、函数
<span class="hljs-bullet">3.</span>  遇到歧义时，不擅自猜测，需提示用户确认
<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">rules</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">output</span>&gt;</span></span>
<span class="hljs-bullet">1.</span>  先输出修改摘要（1-2句话），再输出完整代码块
<span class="hljs-bullet">2.</span>  代码块必须使用Markdown格式，标注语言类型为Python
<span class="hljs-bullet">3.</span>  不输出任何多余解释、寒暄话术
<span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">output</span>&gt;</span></span>
</code></pre>
<p>👉 关键启示：你要学的不是XML标签，而是“模块化思维”——一段Prompt对应一个模块，一个模块对应一个职责，告别“一锅粥”式Prompt。</p>
<hr/>
<h2 data-id="heading-5">三、能力≠工具：显式告诉模型“什么时候用什么”</h2>
<p>很多人做Agent时会遇到一个坑：模型明明有能力，却要么不用工具，要么乱调用工具——核心原因就是：Prompt没说清楚“什么时候该用工具”。</p>
<p>Cursor Prompt最值得学的一点，就是<strong>把“模型能力”和“工具使用”拆得明明白白</strong>，替模型做好“决策”，而不是让它自己猜。</p>
<p>它会在Prompt中明确3件事，缺一不可：</p>
<ol>
<li>当前可用的工具列表（有什么）</li>
<li>每个工具的核心用途（解决什么问题）</li>
<li>触发工具调用的具体场景（什么时候用）</li>
</ol>
<h3 data-id="heading-6">✅ 抽象版示例（可直接适配自己的Agent）</h3>
<pre><code class="hljs language-markdown" lang="markdown">【工具使用规则】
<span class="hljs-bullet">1.</span>  当需要读取本地文件内容时，仅调用read<span class="hljs-emphasis">_file工具，需传入文件路径参数
2.  当需要修改代码、修复Bug时，仅调用apply_</span>patch工具，需附上修改说明
<span class="hljs-bullet">3.</span>  当需要查询API文档时，仅调用search<span class="hljs-emphasis">_api工具，需明确查询关键词
4.  无需工具即可完成的任务（如简单代码解释），禁止调用任何工具
</span></code></pre>
<p>👉 分水岭总结：</p>
<p>普通Prompt：让模型“自己判断该不该用工具”；工程级Prompt：<strong>替模型做决策，明确“场景-工具”的对应关系</strong>，减少无效调用。</p>
<hr/>
<h2 data-id="heading-7">四、先计划，再执行：高级Agent的核心素养</h2>
<p>Cursor Prompt反复强调一个逻辑：<strong>复杂任务，先出计划，再执行</strong>——这也是区分普通Agent和高级Agent的关键。</p>
<p>为什么要这么做？懂大模型的都知道，模型一次性执行复杂任务（比如多文件重构、复杂代码生成），很容易跑偏、遗漏步骤；但如果拆分成“计划+执行”两步，稳定性会提升80%。</p>
<h3 data-id="heading-8">✅ 可直接复用的“计划-执行”模式</h3>
<pre><code class="hljs language-markdown" lang="markdown">在执行任何复杂操作（多文件修改、代码重构、功能开发）前，必须先输出执行计划，格式如下：
<span class="hljs-bullet">1.</span>  任务分析：明确用户核心需求，拆解关键步骤（不超过5步）
<span class="hljs-bullet">2.</span>  执行顺序：标注每一步的先后逻辑、依赖关系
<span class="hljs-bullet">3.</span>  风险提示：说明可能出现的问题及应对方案
执行计划需经用户确认后，再逐步执行，禁止未确认直接操作。
</code></pre>
<p>👉 复用场景：不管是写代码、做重构，还是搭建自动化工作流，这个“先计划后执行”的Prompt模板，都能直接用，大幅降低模型跑偏概率。</p>
<hr/>
<h2 data-id="heading-9">五、输出不是“好看”，而是“可消费”</h2>
<p>很多人写Prompt，会纠结“输出怎么写才好看、才详细”，但Cursor Prompt告诉你：Agent的输出，核心是“可消费”，而不是“看着爽”。</p>
<p>什么是“可消费”？就是输出能直接被下一个系统、下一个步骤复用，不需要人工再整理、再修改——这也是Prompt从“对话级”升级为“系统级”的关键一步。</p>
<p>所以Cursor Prompt对输出格式的要求，苛刻到极致，比如：</p>
<ul>
<li>必须用Markdown代码块包裹代码，标注语言类型</li>
<li>禁止输出任何冗余解释、寒暄话术（如“好的，我来帮你修改”）</li>
<li>修改代码时，必须先输出修改摘要，再输出完整代码</li>
<li>出现错误时，仅输出错误原因和解决方案，不附加其他内容</li>
</ul>
<h3 data-id="heading-10">✅ 输出规范示例（可直接复用）</h3>
<pre><code class="hljs language-markdown" lang="markdown">【输出规范】
<span class="hljs-bullet">1.</span>  所有代码输出必须使用Markdown代码块，标注对应语言类型（如Python、JavaScript）
<span class="hljs-bullet">2.</span>  仅输出最终结果，禁止包含推理过程、思考逻辑、寒暄话术
<span class="hljs-bullet">3.</span>  代码修改后，需附加1句话修改摘要，说明“修改了什么、解决了什么问题”
<span class="hljs-bullet">4.</span>  若无法完成任务，仅输出“无法完成：+具体原因”，不添加多余解释
</code></pre>
<hr/>
<h2 data-id="heading-11">六、上下文管理：解决AI“失忆”的关键</h2>
<p>用ChatGPT写代码时，你有没有遇到过这种情况：写着写着，模型就忘了之前的对话内容、忘了你打开的文件、忘了光标位置——这就是上下文管理缺失的问题。</p>
<p>Cursor Prompt专门加入了“上下文管理”模块，明确告诉模型：哪些是当前上下文（必须关注），哪些可以忽略（无需关注），从根源上解决“失忆”问题。</p>
<h3 data-id="heading-12">✅ 上下文管理示例（简化版）</h3>
<pre><code class="hljs language-markdown" lang="markdown">【上下文说明】
<span class="hljs-bullet">1.</span>  当前上下文包含：用户当前打开的文件（路径：/src/main.py）、光标所在位置（第50行，函数foo内部）、最近3次修改记录
<span class="hljs-bullet">2.</span>  你仅需关注当前上下文内的内容，无需关注历史对话中已完成的任务、已关闭的文件
<span class="hljs-bullet">3.</span>  若用户修改了文件内容，需实时更新上下文认知，优先以最新内容为准
<span class="hljs-bullet">4.</span>  无关的系统提示、历史冗余对话，无需处理、无需回应
</code></pre>
<p>👉 核心技巧：上下文管理的关键，不是“让模型记住所有内容”，而是“让模型知道该记住什么、该忽略什么”——减少模型的记忆负担，才能提升响应精度。</p>
<hr/>
<h2 data-id="heading-13">七、规则分层：避免指令冲突，让Prompt可维护</h2>
<p>如果你的Prompt里，规则都是杂乱堆砌的，很容易出现“子规则覆盖主规则”“用户指令和全局规则冲突”的问题——这也是很多Prompt越改越乱、无法维护的原因。</p>
<p>Cursor Prompt的解决方案：<strong>分层约束</strong>，给规则设定优先级，像做系统权限一样做Prompt规则。</p>
<p>它的规则层级（从高到低，优先级递减），可直接复用：</p>
<ol>
<li>全局行为规则（最高优先级，不可违反）：比如“禁止输出无关内容、禁止擅自修改文件”</li>
<li>工具调用规则（次高优先级）：比如“什么场景用什么工具、禁止乱调用工具”</li>
<li>场景级规则（中等优先级）：比如“代码重构的规则、Bug修复的规则”</li>
<li>用户指令（最低优先级）：用户的具体需求，需在前面3层规则的约束下执行</li>
</ol>
<p>👉 一句话总结：Prompt也需要“权限系统”，分层规则能避免指令冲突，让后续的修改、迭代更轻松，真正实现“可维护”。</p>
<hr/>
<h2 data-id="heading-14">八、可演进设计：Prompt能升级，才是真工程</h2>
<p>为什么Cursor的Agent Prompt能从v1.0迭代到v1.2，还能保持稳定？核心是它具备“可演进”的三个特征——这也是Prompt从“一次性话术”升级为“工程系统”的终极标志。</p>
<ul>
<li><strong>模块化</strong>：每个功能、每个规则都是独立模块，修改一个模块不影响其他模块，可替换、可复用</li>
<li><strong>可扩展</strong>：新增工具、新增规则时，只需新增对应模块，无需重构整个Prompt</li>
<li><strong>可版本化</strong>：每次迭代都有明确的边界，记录修改内容、修改原因，可回滚、可追溯</li>
</ul>
<p>这也是为什么，Cursor的Agent越来越像“专业工程师”，而不是“只会聊天的机器人”——它的Prompt不是固定不变的话术，而是可持续升级的工程系统。</p>
<hr/>
<h2 data-id="heading-15">九、核心技巧总结（表格版，收藏可直接复用）</h2>


















































<table><thead><tr><th>Prompt工程技巧</th><th>核心本质</th><th>可复用场景</th></tr></thead><tbody><tr><td>明确角色与边界</td><td>收敛模型自由度，减少跑偏</td><td>所有Agent、AI助手类Prompt</td></tr><tr><td>结构化Prompt（模块化）</td><td>把Prompt当配置文件，可维护、可迭代</td><td>复杂Agent、系统级Prompt</td></tr><tr><td>工具显式映射</td><td>替模型做决策，规范工具调用</td><td>带工具的Agent、自动化工作流</td></tr><tr><td>先计划后执行</td><td>提升复杂任务稳定性，减少遗漏</td><td>代码重构、多步骤任务</td></tr><tr><td>严格输出规范</td><td>让输出可消费，适配系统衔接</td><td>所有需要系统复用输出的场景</td></tr><tr><td>上下文管理</td><td>解决AI失忆，提升响应精度</td><td>多轮对话、文件操作类Prompt</td></tr><tr><td>分层规则</td><td>避免指令冲突，提升可维护性</td><td>复杂规则类Prompt、可迭代Prompt</td></tr><tr><td>可演进设计</td><td>实现Prompt工程化，支持持续升级</td><td>长期维护的Agent、AI系统</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-16">写在最后</h2>
<p>在社区，我们见过太多同学纠结“Prompt怎么写才有效”，试过无数话术，却始终摆脱不了“靠感觉、看运气”的玄学困境。</p>
<p>而Cursor Agent Prompt给我们的最大启发是：<strong>真正高级的Prompt，从来不是“一句话技巧”，而是“行为规范+决策边界+工具编排”的工程系统</strong>。</p>
<p>如果你正在做Agent、做AI编程助手，或者只是想提升自己的Prompt能力，建议你收藏这篇文章——把里面的8个技巧、模板，直接套用到自己的场景里，少走弯路。</p>
<p>也欢迎在评论区交流：你平时写Prompt时，最头疼的问题是什么？有没有自己的独家技巧？</p>
<h2 data-id="heading-17">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fx1xhlol%2Fsystem-prompts-and-models-of-ai-tools%2Fblob%2Fmain%2FCursor%2520Prompts%2FAgent%2520Prompt%2520v1.2.txt" target="_blank" title="https://github.com/x1xhlol/system-prompts-and-models-of-ai-tools/blob/main/Cursor%20Prompts/Agent%20Prompt%20v1.2.txt" ref="nofollow noopener noreferrer">github.com/x1xhlol/sys…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么我说CSS-in-JS是前端“最佳”的糟粕设计？]]></title>    <link>https://juejin.cn/post/7603321550246477874</link>    <guid>https://juejin.cn/post/7603321550246477874</guid>    <pubDate>2026-02-06T06:49:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603321550246477874" data-draft-id="7603393977476399130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么我说CSS-in-JS是前端“最佳”的糟粕设计？"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2026-02-06T06:49:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员_June"/> <meta itemprop="url" content="https://juejin.cn/user/395479916219517"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么我说CSS-in-JS是前端“最佳”的糟粕设计？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479916219517/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员_June
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T06:49:04.000Z" title="Fri Feb 06 2026 06:49:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你是一名前端开发者，特别是React开发者，你一定听说过或使用过CSS-in-JS方案。从Styled-components到Emotion，这些库在短短几年内迅速流行，被无数项目采用。</p>
<p>但今天，我要冒着被喷的风险说一句：<strong>CSS-in-JS是个糟糕的设计，它解决了不存在的问题，却创造了真实的新问题。</strong></p>
<hr/>
<h2 data-id="heading-0">一、CSS-in-JS的“美好”承诺</h2>
<p>支持者们会告诉你CSS-in-JS有多棒：</p>
<ul>
<li><strong>组件化</strong>：样式与组件绑定，不再担心样式污染</li>
<li><strong>动态样式</strong>：基于props的动态样式轻而易举</li>
<li><strong>自动处理前缀</strong>：不再需要手动写-webkit-</li>
<li><strong>代码简洁</strong>：不再需要在不同文件间跳转</li>
</ul>
<p>听起来很美好，不是吗？但这些“好处”背后，隐藏着巨大的代价。</p>
<hr/>
<h2 data-id="heading-1">二、现实中的七宗罪</h2>
<h3 data-id="heading-2">运行时开销：性能的隐形杀手</h3>
<p>CSS-in-JS在运行时解析样式、生成类名、注入到文档中。这意味着用户访问你的网站时，JavaScript必须完成这些额外工作才能显示样式。</p>
<p><strong>对比一下：</strong></p>
<ul>
<li><strong>传统CSS</strong>：浏览器直接解析和应用样式</li>
<li><strong>CSS-in-JS</strong>：JavaScript执行 → 解析样式 → 生成类名 → 注入样式 → 浏览器应用</li>
</ul>
<p>在慢速设备或网络条件下，这种差异尤为明显。而这一切，只是为了实现原本浏览器原生就能处理的事情。</p>
<h3 data-id="heading-3">开发体验的倒退</h3>
<p>“在JavaScript中写CSS”听起来很酷，直到你真正开始使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Button</span> = styled.<span class="hljs-property">button</span><span class="hljs-string">`
  background: <span class="hljs-subst">${props =&gt; props.primary ? <span class="hljs-string">'blue'</span> : <span class="hljs-string">'white'</span>}</span>;
  color: <span class="hljs-subst">${props =&gt; props.primary ? <span class="hljs-string">'white'</span> : <span class="hljs-string">'blue'</span>}</span>;
  
  &amp;:hover {
    background: <span class="hljs-subst">${props =&gt; props.primary ? <span class="hljs-string">'darkblue'</span> : <span class="hljs-string">'lightgray'</span>}</span>;
  }
  
  @media (max-width: 768px) {
    font-size: 14px;
    padding: 8px 16px;
  }
`</span>;
</code></pre>
<p>这段代码里，你失去了：</p>
<ul>
<li>CSS语法高亮（除非额外安装插件）</li>
<li>CSS自动补全</li>
<li>CSS linting检查</li>
<li>浏览器DevTools的直接编辑能力</li>
</ul>
<h3 data-id="heading-4">可维护性噩梦</h3>
<p>当样式逻辑复杂时，你最终会得到这样的代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ComplexComponent</span> = styled.<span class="hljs-property">div</span><span class="hljs-string">`
  <span class="hljs-subst">${({ theme, variant, size, disabled }) =&gt; {
    // 一大堆JavaScript逻辑
    <span class="hljs-keyword">let</span> styles = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> (variant === <span class="hljs-string">'primary'</span>) {
      styles += <span class="hljs-string">`background: <span class="hljs-subst">${theme.colors.primary}</span>;`</span>;
    }
    <span class="hljs-keyword">if</span> (size === <span class="hljs-string">'large'</span>) {
      styles += <span class="hljs-string">`padding: 20px; font-size: 18px;`</span>;
    }
    <span class="hljs-keyword">if</span> (disabled) {
      styles += <span class="hljs-string">`opacity: 0.5; cursor: not-allowed;`</span>;
    }
    <span class="hljs-keyword">return</span> styles;
  }}</span>
`</span>;
</code></pre>
<p>这不再是“在JS中写CSS”，而是“用JS逻辑生成CSS字符串”。可读性和可维护性急剧下降。</p>
<h3 data-id="heading-5">学习成本陡增</h3>
<p>新开发者需要学习：</p>
<ol>
<li>CSS本身</li>
<li>JavaScript</li>
<li>React</li>
<li>特定CSS-in-JS库的语法和API</li>
<li>如何调试这个独特的系统</li>
</ol>
<p>而他们学到的大多数知识，在离开这个特定技术栈后毫无用处。</p>
<h3 data-id="heading-6">SSR和静态生成的复杂性</h3>
<p>服务器端渲染变得复杂：</p>
<ul>
<li>需要收集使用的样式</li>
<li>需要在HTML中注入样式</li>
<li>需要处理hydration不匹配</li>
<li>增加了包大小和内存使用</li>
</ul>
<p>而这一切对于纯CSS来说，都是不存在的。</p>
<h3 data-id="heading-7">调试困难</h3>
<p>在浏览器DevTools中，你会看到这样的类名：<code>.sc-1a2b3c4d</code>。想根据类名找到对应的组件？祝你好运。</p>
<p>想了解某个样式来自哪个组件？你需要：</p>
<ol>
<li>打开DevTools</li>
<li>找到元素</li>
<li>查看混乱的类名</li>
<li>在代码中搜索这个生成的类名</li>
<li>或者安装专门的浏览器扩展</li>
</ol>
<hr/>
<h2 data-id="heading-8">三、更好的替代方案</h2>
<p>CSS-in-JS试图解决的问题，其实有更优雅的解决方案：</p>
<h3 data-id="heading-9">方案一：CSS Modules（真正的组件化CSS）</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* Button.module.css */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background</span>: blue;
  <span class="hljs-attribute">color</span>: white;
}

<span class="hljs-selector-class">.primary</span> {
  <span class="hljs-attribute">background</span>: darkblue;
}

<span class="hljs-selector-class">.button</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">background</span>: lightblue;
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">'./Button.module.css'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">{ primary }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">styles.button</span>} ${<span class="hljs-attr">primary</span> ? <span class="hljs-attr">styles.primary</span> <span class="hljs-attr">:</span> ''}`}&gt;</span>
      Click me
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>真正的局部作用域</li>
<li>零运行时开销</li>
<li>保持CSS原生能力</li>
<li>易于调试</li>
</ul>
<h3 data-id="heading-10">方案二：Utility-First CSS（如Tailwind）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">{ primary }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`
      <span class="hljs-attr">px-4</span> <span class="hljs-attr">py-2</span> <span class="hljs-attr">rounded</span>
      ${<span class="hljs-attr">primary</span> 
        ? '<span class="hljs-attr">bg-blue-600</span> <span class="hljs-attr">text-white</span> <span class="hljs-attr">hover:bg-blue-700</span>' 
        <span class="hljs-attr">:</span> '<span class="hljs-attr">bg-gray-200</span> <span class="hljs-attr">text-gray-800</span> <span class="hljs-attr">hover:bg-gray-300</span>'
      }
    `}&gt;</span>
      Click me
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>极小的CSS输出</li>
<li>高度一致的设计系统</li>
<li>极少的上下文切换</li>
<li>优秀的性能特性</li>
</ul>
<h3 data-id="heading-11">方案三：纯CSS + 现代特性</h3>
<p>现代CSS已经解决了大多数“CSS难题”：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 使用CSS自定义属性实现主题 */</span>
<span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-attr">--primary-color</span>: blue;
  <span class="hljs-attr">--spacing-unit</span>: <span class="hljs-number">8px</span>;
}

<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--primary-color);
  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--spacing-unit) * <span class="hljs-number">2</span>);
}

<span class="hljs-comment">/* 容器查询 - 即将成为标准 */</span>
<span class="hljs-keyword">@container</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">400px</span>) {
  <span class="hljs-selector-class">.button</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-12">四、历史的教训</h2>
<p>我们见过这种模式：</p>
<ol>
<li><strong>过度抽象</strong>：为了解决“复杂”的CSS，我们创建了更复杂的系统</li>
<li><strong>技术债积累</strong>：短期便利，长期维护噩梦</li>
</ol>
<p>CSS-in-JS可能最终会像其他过度抽象的技术一样，在热情消退后，留下技术债务和后悔的开发者。</p>
<hr/>
<h2 data-id="heading-13">结语</h2>
<p>有时候，最简单的解决方案就是最好的解决方案。CSS已经存在了25年，浏览器厂商投入了无数资源优化它。也许，我们应该相信这些专家，而不是试图在JavaScript中重新发明轮子。</p>
<p><strong>前端开发的进步，不应该以牺牲Web的根本原则为代价。</strong></p>
<p>简洁、可维护、高性能的代码，才是对我们用户和同事的真正尊重。</p>
<hr/>
<p><strong>互动话题</strong>：你在项目中使用过CSS-in-JS吗？遇到了哪些问题？欢迎在评论区分享你的经验！</p>
<p><em>关注我，获取更多前端技术文章</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[代码协作的“后悔药”：Git 合并后回退操作全攻略]]></title>    <link>https://juejin.cn/post/7603263490342993929</link>    <guid>https://juejin.cn/post/7603263490342993929</guid>    <pubDate>2026-02-06T06:53:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603263490342993929" data-draft-id="7603263490342977545" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="代码协作的“后悔药”：Git 合并后回退操作全攻略"/> <meta itemprop="keywords" content="Git"/> <meta itemprop="datePublished" content="2026-02-06T06:53:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新晨437"/> <meta itemprop="url" content="https://juejin.cn/user/3957868231143133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            代码协作的“后悔药”：Git 合并后回退操作全攻略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3957868231143133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新晨437
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T06:53:05.000Z" title="Fri Feb 06 2026 06:53:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">代码协作的“后悔药”：Git 合并后回退操作全攻略</h2>
<blockquote>
<p>当你执行了 <code>git commit</code> 后紧接着 <code>git pull</code>，却发现合并的结果不是自己想要的——这种困境在团队协作中屡见不鲜。本文将为你提供清晰的操作指南，帮助你在代码合并后安全回退，掌控版本控制的主动权。</p>
</blockquote>
<p>在团队协作开发中，Git 是最常用的版本控制工具。然而，当我们在分支上提交了更改后执行 <code>git pull</code> 拉取远程代码时，常常会遇到冲突或对合并结果不满意的情况。</p>
<p>面对这种情况，不要慌张，Git 提供了多种“后悔药”让你安全回退到理想状态。</p>
<hr/>
<h3 data-id="heading-1">1. 场景回顾：典型的合并困境</h3>
<p>假设你在 <code>knowledge</code> 分支上进行开发，执行了以下操作：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 本地提交更改</span>
git commit -m “完成某个功能模块”

<span class="hljs-comment"># 拉取远程更改（可能产生冲突）</span>
git pull origin knowledge
</code></pre>
<p>操作后，终端显示如下状态：</p>
<pre><code class="hljs language-bash" lang="bash">On branch knowledge
Your branch and <span class="hljs-string">'origin/knowledge'</span> have diverged,
and have 1 and 1 different commits each, respectively.
All conflicts fixed but you are still merging.
</code></pre>
<p>这表明你的本地分支和远程分支各自有一个不同的提交，并且 Git 已经自动解决了部分冲突，但合并过程尚未完成。</p>
<hr/>
<h3 data-id="heading-2">2. 诊断当前状态</h3>
<p>在采取任何行动前，先要准确了解当前的 Git 状态：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前状态</span>
git status

<span class="hljs-comment"># 查看提交历史</span>
git <span class="hljs-built_in">log</span> --oneline

<span class="hljs-comment"># 查看操作记录</span>
git reflog
</code></pre>
<p><code>git reflog</code> 命令特别有用，它会显示 HEAD 指针的所有变动历史，让你能看到 <code>git pull</code> 之前的状态位置。</p>
<hr/>
<h3 data-id="heading-3">3. 三种解决方案对比</h3>
<p>根据不同的需求和场景，你有以下三种主要选择：</p>





























<table><thead><tr><th>方案</th><th>适用场景</th><th>核心命令</th><th>风险等级</th></tr></thead><tbody><tr><td><strong>完成合并</strong></td><td>接受远程更改，继续协作开发</td><td><code>git commit</code> → <code>git push</code></td><td>低</td></tr><tr><td><strong>放弃合并</strong></td><td>发现合并方向错误，想重新开始</td><td><code>git merge --abort</code> → <code>git reset --hard</code></td><td>中</td></tr><tr><td><strong>完全重置</strong></td><td>想彻底丢弃本地更改，使用远程代码</td><td><code>git merge --abort</code> → <code>git reset --hard origin/branch</code></td><td>高</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-4">4. 方案一：完成合并（推荐用于团队协作）</h3>
<p>如果你解决了冲突且认可合并结果，这是最直接的选择：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 提交合并结果</span>
git commit -m “Merge branch <span class="hljs-string">'knowledge'</span> of origin”

<span class="hljs-comment"># 推送到远程</span>
git push origin knowledge
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>你已经解决了所有冲突</li>
<li>合并结果符合预期</li>
<li>团队协作环境中需要保持提交历史完整</li>
</ul>
<hr/>
<h3 data-id="heading-5">5. 方案二：放弃合并，回退到合并前</h3>
<p>当合并方向错误或你想重新评估合并策略时：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 放弃当前的合并操作</span>
git merge --abort

<span class="hljs-comment"># 2. 查看操作历史，找到合并前的状态</span>
git reflog

<span class="hljs-comment"># 3. 回退到合并前的提交（假设合并前是 HEAD@{1}）</span>
git reset --hard HEAD@{1}

<span class="hljs-comment"># 4. 重新拉取并手动合并（如果需要）</span>
git pull origin knowledge --no-commit
</code></pre>
<p><strong>关键提示</strong>：</p>
<ul>
<li><code>git merge --abort</code> 只有在合并未完成时才有效</li>
<li>使用 <code>git reflog</code> 可以找到确切的回退点</li>
<li><code>--no-commit</code> 参数让 <code>git pull</code> 只合并不提交，给你审查的机会</li>
</ul>
<hr/>
<h3 data-id="heading-6">6. 方案三：完全重置到远程状态</h3>
<p>如果你想彻底丢弃本地所有更改，完全采用远程代码：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 放弃当前合并（如果处于合并中）</span>
git merge --abort

<span class="hljs-comment"># 2. 备份本地更改（安全措施）</span>
git stash

<span class="hljs-comment"># 3. 强制重置到远程分支状态</span>
git fetch origin
git reset --hard origin/knowledge

<span class="hljs-comment"># 4. 清理未跟踪文件（谨慎使用）</span>
git clean -fd
</code></pre>
<p><strong>警告与建议</strong>：</p>
<ul>
<li><code>git reset --hard</code> 会<strong>永久删除</strong>所有未提交的更改</li>
<li><code>git clean -fd</code> 会删除所有未跟踪的文件和目录</li>
<li>在执行前，建议先用 <code>git stash</code> 备份当前状态</li>
</ul>
<hr/>
<h3 data-id="heading-7">7. 当代码已推送至远程的特殊处理</h3>
<p>如果你已经将不满意的合并推送到远程仓库，需要额外步骤：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 本地回退到目标版本</span>
git reset --hard &lt;目标commit-hash&gt;

<span class="hljs-comment"># 2. 强制推送到远程（覆盖历史）</span>
git push --force origin knowledge
</code></pre>
<p><strong>重要警告</strong>：</p>
<ul>
<li><code>--force</code> 推送会覆盖远程历史，可能影响其他协作者</li>
<li>仅限个人分支或已与团队沟通后使用</li>
<li>考虑使用 <code>--force-with-lease</code>（更安全，检查是否有他人推送）</li>
</ul>
<hr/>
<h3 data-id="heading-8">8. 最佳实践与预防措施</h3>
<p>为了避免频繁陷入合并回退的困境，建议遵循以下实践：</p>
<ol>
<li>
<p><strong>养成良好习惯</strong>：</p>
<ul>
<li>在 <code>git pull</code> 前先 <code>git fetch</code> 查看远程变化</li>
<li>使用 <code>git pull --no-commit</code> 给自己留出审查空间</li>
<li>频繁提交，小步快跑，减少大范围合并冲突</li>
</ul>
</li>
<li>
<p><strong>配置合适的工作流</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置 pull 策略为 rebase 而非 merge</span>
git config pull.rebase <span class="hljs-literal">true</span>

<span class="hljs-comment"># 或者每次手动使用</span>
git pull --rebase origin knowledge
</code></pre>
</li>
<li>
<p><strong>使用可视化工具</strong>：</p>
<ul>
<li>GitKraken、Sourcetree 等工具提供直观的合并界面</li>
<li>VS Code、IntelliJ IDEA 等编辑器的 Git 集成也很强大</li>
</ul>
</li>
<li>
<p><strong>建立团队协议</strong>：</p>
<ul>
<li>明确分支合并规范</li>
<li>约定何时可以强制推送</li>
<li>建立代码审查流程</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-9">9. 总结</h3>
<p>Git 合并后的回退操作是版本控制中的高级技能，理解不同方案的适用场景至关重要：</p>
<ul>
<li><strong>轻量级调整</strong>：使用 <code>git merge --abort</code> 和 <code>git reset --soft</code></li>
<li><strong>完全重新开始</strong>：使用 <code>git reset --hard</code> 回到特定节点</li>
<li><strong>团队协作时</strong>：优先完成合并，必要时沟通后强制推送</li>
</ul>
<p>记住，Git 的核心理念是“一切皆可恢复”。即使是 <code>reset --hard</code> 删除的内容，只要曾经提交过，通常都能从 reflog 中找回。大胆尝试，谨慎操作，版本控制的灵活性正是 Git 强大的体现。</p>
<p><strong>最好的“后悔药”其实是预防</strong>。通过良好的协作习惯和适当的工具使用，你可以大大减少需要“回退”的场景，让团队协作更加流畅高效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[拆解LangChain执行引擎] Channel——驱动Node执行的原力]]></title>    <link>https://juejin.cn/post/7603314759757922323</link>    <guid>https://juejin.cn/post/7603314759757922323</guid>    <pubDate>2026-02-06T06:54:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603314759757922323" data-draft-id="7603383059150405674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[拆解LangChain执行引擎] Channel——驱动Node执行的原力"/> <meta itemprop="keywords" content="LangChain"/> <meta itemprop="datePublished" content="2026-02-06T06:54:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JaydenAI"/> <meta itemprop="url" content="https://juejin.cn/user/3001011641261209"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [拆解LangChain执行引擎] Channel——驱动Node执行的原力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3001011641261209/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JaydenAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T06:54:49.000Z" title="Fri Feb 06 2026 06:54:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Pregel由Node和Channel这两个核心部件组成，Channel不仅维护了整个图的状态，还是驱动Node执行的 “原力” 。在前面演示的一系列实例中，我们已经使用了三种Channel类型，包括频繁使用的LastValue，能够将所有添加的值保留下来的BinaryOperatorAggregate，以及帮助我们轻松解决多Node依赖问题的NamedBarrierValue。为什么Channel有这么多类型，我们应该在何种场景中使用何种类型的Channel，要回答这个问题，就无法回避（BSP：Bulk Synchronous Parallel）这一个算法模式，毫不夸张地说，整个Pregel就是围绕BSP进行设计的。</p>
<h2 data-id="heading-0">1. BSP</h2>
<p>我们知道一个Agent利用作为决策者的LLM和一系列作为执行者的Tool协助完成指定的任务。LLM（这里主要指基于文本生成的GPT）由于其逐Token的生成机制，加上各种工具可能涉及到大数据的处理、IO读写、跨网络的交互等耗时操作，所以要确保Agent能够提供可接受的性能保障，并行计算是唯一的解决方案。考虑到对并行计算的 “钢需” ，那么Pregel为什么选择Actor模型来实现也就很容易理解了，因为高并发正式Actor模型最擅长的领域。BSP中的BP（Bulk Parallel）可以理解为Pregel多个Node在同一时段的并行执行，那么S（Synchronous）有作何理解呢？</p>
<p>在很多典型的Actor模型里，Actor大多是有状态的，但是作为Pregel的Actor，其Node对象是完全无状态的。开始执行之前，他从注册的Channel读取数据，执行结果以最终输出到相应的Channel。我们知道高并发、低延时和数据一致性是三个永远不可能同时兼顾的指标，如果要兼顾其中两个，就不得不牺牲第三个。大部分系统的架构与设计都是在对三者作一个平衡，Pregel亦是如此。</p>
<p>由于多个并行执行的Node会涉及针对同一份数据（Channel）的读写，如果要保证数据的完整性，就不得不施加相应的同步机制，比如各种不同类型的锁。不论多轻量级的锁，它们都是高并发最强的杀手，那么能否实现无锁的解决方案呢？BSP就是答案，而这其中又涉及一个名为Superstep（Super Step，由于这一个概念会频繁提及，后续内容直接将Superstep视为一个专有名词来指代这一个概念）的概念，我们可以将其视为整个图有条不紊向前推进的一个单步，是Pregel执行引擎的一个脉冲，是所有Node执行的“节拍”，每个Superstep具有一个自增的序号。</p>
<p>在每个Superstep结束之后，每个Channel的状态被固定下来，引擎根据Node针对Channel的订阅和Channel在当前Superstep内的更新情况确定在下一Superstep需要执行的Node，并为它们创建创建相应的任务。这些任务在新的Superstep开始是并发执行，而且它们只能访问前一超步固化下来的值。这一策略确保输入的一致性，保证所有并发执行的Node所见的状态都是一样的；另一方面Channel在Superstep内保持只读状态就完全不用考虑并发脏读的问题了。</p>
<p>并发执行的Node不允许对任何Channel实施写入，它只能将写入诉求提交给执行引擎，后者按照提交的顺序存储下来。让所有任务成功执行后，Superstep进入一个同步屏障，执行引擎将对收集到的Channel写入请求按照顺序统一应用，使所有Channel最终能准确地体现Superstep结束后的状态。然后再确定下一Superstep的任务，如此反复，周而复始。</p>
<p>第一个Superstep的序号是从-1开始计数的，这个所谓的“创世超步”开始于针对Pregel兑现的常规调用，引擎利用这一Superstep将原始输入写入对应的Channel，并计算需要在Superstep 0中执行的任务，所以Node的首次执行是在Superstep 0中执行的。</p>
<p>由于Agent可以涉及一个需要长时间执行的处理流程，而且这个过程还可能出现中断，此中断可能是由于系统故障，也可能是需要认为介入导致，所以Agent的状态不可能常驻内容。而且Agent还提供了 “时间旅行” 的功能，这一个功能使我们从过去的某个时间点开启一个新的分支来执行流程，这相当于开启一个 “平行世界” 。所有的这一切都离不开针对状态的持久化，这是整个Pregel最复杂的部分。</p>
<p>我们将在后续内容详细介绍Pregel针对状态持久化的设计与实现，这里我们做一个概括性介绍。当Superstep进入同步屏障之后，持久化发生在 “解析待执行任务” 之后，此时引擎会针对当前Channel的状态创建一份名为Checkpoint快照并利用注册的Checkpointer记录下来。</p>
<p>每个被记录的Checkpoint不仅具有一个唯一标识，还登记了当前的Superstep序号，还有一个能够精确描述当前Agent对应的图在整个执行图中的位置（多Agent应用中，一个Agent可作为 “子Agent” 被调用，对应的图就是整张执行图的 “子图” ）和调用顺序的 “命名空间” 。完整的标识体系的唯一左右就是，在Agent从某个点恢复执行的时候，相应的Checkpointer能够准确地提取对应的Checkpoint来 “恢复现场” 。下图基本反映了Pregel针对单一Superstep的执行流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f34dbd6f05204b2888c96e28201f8837~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF5ZGVuQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770965689&amp;x-signature=%2B3lutbYKYEa6sX29pmi00Xmx7wE%3D" alt="image.png" loading="lazy"/>
但是很多文档中你看到他们将Superstep划分为“计划”、“执行”、“更新”和“持久化”，看起来合理，但是和真正的执行流程是有出入的。计划阶段得到其实不是当前Superstep待执行的任务，而是下一Superstep待执行的任务，因为这有这样采用解释为什么针对Superstep -1的Checkpoint会包含任务列表，这些任务分明是在Superstep 0中才会被执行。实际上Checkpoint中的任务列表反映的都是下一Superstep待执行的操作，所以唯独最后一个Checkpoint才不会存在任务列表。表示状态快照的StateSnapshot将返回任务名称列表的字段命名为next，我想也应该是处于这个原因。</p>
<h2 data-id="heading-1">2. BaseChannel</h2>
<p>所有的Channel类型都派生于如下这个名为BaseChannel的抽象类，它的泛型类型参数Value和Update分别表示存储类型、更新时提供的值类型，我们可以利用属性ValueType和UpdateType获取前两种类型。抽象方法get和update提供针对这两个类型的读写,update方法返回的布尔值表示是否具有实质性的更新，引擎由此判断Channel的值是否发生改变。另一个泛型类型参数Checkpoint与持久化有关，引擎在恢复执行时会从持久化的快照中提取对应的数据并将其转换成此对象，最终调用from_checkpoint方法恢复Channel的状态，在进行持久化时，引擎会调用checkpoint方法将自身的状态转换成该类型，并提交给Checkpointer实施持久化。</p>
<pre><code class="hljs language-python" lang="python">Value = TypeVar(<span class="hljs-string">"Value"</span>)
Update = TypeVar(<span class="hljs-string">"Update"</span>)
Checkpoint = TypeVar(<span class="hljs-string">"Checkpoint"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseChannel</span>(<span class="hljs-type">Generic</span>[Value, Update, Checkpoint], ABC):
    __slots__ = (<span class="hljs-string">"key"</span>, <span class="hljs-string">"typ"</span>)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, typ: <span class="hljs-type">Any</span>, key: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span></span>) -&gt; <span class="hljs-literal">None</span>

<span class="hljs-meta">    @property</span>
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ValueType</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Any</span>
<span class="hljs-meta">    @property</span>
<span class="hljs-meta">    @abstractmethod</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">UpdateType</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Any</span>
    
<span class="hljs-meta">    @abstractmethod</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self</span>) -&gt; Value
<span class="hljs-meta">    @abstractmethod</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, values: <span class="hljs-type">Sequence</span>[Update]</span>) -&gt; <span class="hljs-built_in">bool</span>

<span class="hljs-meta">    @abstractmethod</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">from_checkpoint</span>(<span class="hljs-params">self, checkpoint: Checkpoint | <span class="hljs-type">Any</span></span>) -&gt; Self
<span class="hljs-keyword">def</span> <span class="hljs-title function_">checkpoint</span>(<span class="hljs-params">self</span>) -&gt; Checkpoint | <span class="hljs-type">Any</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">copy</span>(<span class="hljs-params">self</span>) -&gt; Self    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">consume</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>	
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_available</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span> 
</code></pre>
<p>除此之外，BaseChannel还定义了其他几个方法，其中copy方法会根据自身状态创建一个新Channel对象，默认实现会先调用checkpoint方法，然后将返回值作为参数调用from_checkpoint方法，后者调用的结果就是copy方法的返回值，所以这是一个深拷贝。在所有任务执行完成后，触发它们的所有Channel的consume方法会被执行，Channel可以利用这个机会做一些清除工作以防止相同的数据被重复消费。consume方法的返回值旨在告诉 引擎该通道的内部数据是否已经发生了实质性改变（被消费或者清空）。如果返回True，意味着Channel的状态已被更新，其版本会被提升。</p>
<p>Channel的值并非在每个时间点都是可用的，比如对于某些Channel，在Superstep N中写入的值只能在Superstep N+1中可用，Channel的可用性由is_available方法决定。finish是一个“钩子（Hook）”方法，引擎会在每个Superstep完成时调用此方法，对应的Channel可用利用此方法做一些类似于“可用性控制”的操作。指的一体的是，只有在当前Superstep中被更新的且被Node订阅的Channel，它们的finish方法才会被调用。</p>
<h2 data-id="heading-2">3. Channel</h2>
<p>Pregel提供了若干预定义的Channel类型，它们的读写行为以及可用性上都有差异，我们需要根据数据或者状态的特性选择适合的Channel类型。</p>
<h2 data-id="heading-3">3.1	LastValue</h2>
<p>LastValue只存储单值，并且采用后来居上的策略，存储最后一个提交更新的值。从如下提供的具体实现可用看出，LastValue的值类型、更新类型和Checkpoint类型三者合一，所以只通过字段value维护唯一的值。get、checkpoint和update方法实现了针对该字段的读写，如果没有对value字段显式赋值，is_available方法会返回False，get方法也会抛出异常。copy和from_checkpoint方法返回的都是一个新的LastValue对象，提供的值会为其value字段赋值。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LastValue</span>(<span class="hljs-type">Generic</span>[Value], BaseChannel[Value, Value, Value]):
    __slots__ = (<span class="hljs-string">"value"</span>,)
    value: Value | <span class="hljs-type">Any</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, typ: <span class="hljs-type">Any</span>, key: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-built_in">super</span>().__init__(typ, key)
        self.value = MISSING

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__eq__</span>(<span class="hljs-params">self, value: <span class="hljs-built_in">object</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">isinstance</span>(value, LastValue)

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">ValueType</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">type</span>[Value]:
        <span class="hljs-keyword">return</span> self.typ

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">UpdateType</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">type</span>[Value]:
        <span class="hljs-keyword">return</span> self.typ

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">copy</span>(<span class="hljs-params">self</span>) -&gt; Self:
        empty = self.__class__(self.typ, self.key)
        empty.value = self.value
        <span class="hljs-keyword">return</span> empty

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">from_checkpoint</span>(<span class="hljs-params">self, checkpoint: Value</span>) -&gt; Self:
        empty = self.__class__(self.typ, self.key)
        <span class="hljs-keyword">if</span> checkpoint <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> MISSING:
            empty.value = checkpoint
        <span class="hljs-keyword">return</span> empty

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, values: <span class="hljs-type">Sequence</span>[Value]</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(values) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(values) != <span class="hljs-number">1</span>:
            msg = create_error_message(
                message=<span class="hljs-string">f"At key '<span class="hljs-subst">{self.key}</span>': Can receive only one value per step. Use an Annotated key to handle multiple values."</span>,
                error_code=ErrorCode.INVALID_CONCURRENT_GRAPH_UPDATE,
            )
            <span class="hljs-keyword">raise</span> InvalidUpdateError(msg)

        self.value = values[-<span class="hljs-number">1</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self</span>) -&gt; Value:
        <span class="hljs-keyword">if</span> self.value <span class="hljs-keyword">is</span> MISSING:
            <span class="hljs-keyword">raise</span> EmptyChannelError()
        <span class="hljs-keyword">return</span> self.value

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_available</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">return</span> self.value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> MISSING

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">checkpoint</span>(<span class="hljs-params">self</span>) -&gt; Value:
        <span class="hljs-keyword">return</span> self.value

MISSING = <span class="hljs-built_in">object</span>()
</code></pre>
<p>我们说LastValue这个使用频率最高的Channel针对多个更新采用“后来居上”的策略，只存储最后一次更新的提供的值，但这里所谓的多次更新只得时跨越不同Superstep针对Channel得多次写入，因为它根本不支持在单个Superstep针对它得多次更新，update方法得实现已经体现了这一点。在如下这个演示程序中，我们让三个并行执行得Node在同一Superstep内更新命名为“output”的这个LastValue类型的Channel，给定的断言证实了update方法中抛出InvalidUpdateError异常的逻辑。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue
<span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder
<span class="hljs-keyword">from</span> langgraph.errors <span class="hljs-keyword">import</span> InvalidUpdateError

<span class="hljs-keyword">def</span> <span class="hljs-title function_">build</span>(<span class="hljs-params">node_name:<span class="hljs-built_in">str</span></span>)-&gt;NodeBuilder:
    <span class="hljs-keyword">return</span> (NodeBuilder()
            .subscribe_to(<span class="hljs-string">"start"</span>)
            .do(<span class="hljs-keyword">lambda</span> _:node_name)
            .write_to(<span class="hljs-string">"output"</span>))

app = Pregel(
    nodes={name: build(name) <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> [<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"baz"</span>]},
    channels={
        <span class="hljs-string">"start"</span>: LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"output"</span>: LastValue(<span class="hljs-built_in">str</span>),
    },
    input_channels=[<span class="hljs-string">"start"</span>],
    output_channels=[<span class="hljs-string">"output"</span>],
)

<span class="hljs-keyword">try</span>:
    app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"start"</span>: <span class="hljs-literal">None</span>})
    <span class="hljs-keyword">assert</span> <span class="hljs-literal">False</span>, <span class="hljs-string">"Expected InvalidUpdateError"</span>
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(e, InvalidUpdateError)
</code></pre>
<h3 data-id="heading-4">3.2	AnyValue</h3>
<p>AnyValue类型的Channel同样是用于存储单值，所以它的实现于LastValue在很多地方都类似。两者之间最大的不同在于，AnyValue支持同一个Superstep的多次更新，但是将所有的更新视为等效，所以它的update方法会使用最后一个更新提供的值。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AnyValue</span>(<span class="hljs-type">Generic</span>[Value], BaseChannel[Value, Value, Value]):
    __slots__ = (<span class="hljs-string">"typ"</span>, <span class="hljs-string">"value"</span>)

    value: Value | <span class="hljs-type">Any</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, typ: <span class="hljs-type">Any</span>, key: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-built_in">super</span>().__init__(typ, key)
        self.value = MISSING
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, values: <span class="hljs-type">Sequence</span>[Value]</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(values) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">if</span> self.value <span class="hljs-keyword">is</span> MISSING:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            <span class="hljs-keyword">else</span>:
                self.value = MISSING
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        self.value = values[-<span class="hljs-number">1</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
</code></pre>
<p>虽然AnyValue针对同一Superstep内的多次更新会选择最后一次更新，但是这个更新的顺序是无法通过程序控制的，我们也不能对更新顺序作任何假设。如下的演示程序很清晰地说明了这一点，我们按照上一个例子相似的方式并行执行“foo” 、 “bar” 和 “baz” 三个Node，它们在完成执行后会更新 “output” 这个AnyValue类型的Channel。由于我们为“bar” 和 “baz” 的处理函数做了1秒的休眠，按照“常理”推断，“foo”提供的更新应该先被收集和应用，但事实却未必如此。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue,AnyValue
<span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> partial

changes: <span class="hljs-built_in">list</span>[<span class="hljs-type">Any</span>] = []
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExtendedAnyValue</span>(<span class="hljs-title class_ inherited__">AnyValue</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, values: <span class="hljs-built_in">list</span>[<span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">global</span> changes
        changes = values
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().update(values)
    
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">node_name:<span class="hljs-built_in">str</span>, args:<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>,<span class="hljs-type">Any</span>]</span>)-&gt;<span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">if</span> node_name != <span class="hljs-string">"foo"</span>:
        time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># Simulate some processing delay</span>
    <span class="hljs-keyword">return</span> node_name

<span class="hljs-keyword">def</span> <span class="hljs-title function_">build</span>(<span class="hljs-params">node_name:<span class="hljs-built_in">str</span></span>)-&gt;NodeBuilder:
    <span class="hljs-keyword">return</span> (NodeBuilder()
            .subscribe_to(<span class="hljs-string">"start"</span>)
            .do(partial(handle, node_name))
            .write_to(<span class="hljs-string">"output"</span>))

app = Pregel(
    nodes={name: build(name) <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> [<span class="hljs-string">"foo"</span>,<span class="hljs-string">"bar"</span>, <span class="hljs-string">"baz"</span>]},
    channels={
        <span class="hljs-string">"start"</span>: LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"output"</span>: ExtendedAnyValue(<span class="hljs-built_in">str</span>),
    },
    input_channels=[<span class="hljs-string">"start"</span>],
    output_channels=[<span class="hljs-string">"output"</span>], 
)

result =  app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"start"</span>: <span class="hljs-literal">None</span>})
<span class="hljs-built_in">print</span>(<span class="hljs-string">"collected changes:"</span>, changes)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"channel value:"</span>, result[<span class="hljs-string">"output"</span>])
</code></pre>
<p>我们通过继承AnyValue定义了一个ExtendedAnyValue类型，重写的update方法在调用基类同名方法前，我们将values参数赋值给全局变量changes。“output” 现在盖用现在这个类型。在完成正常调用后，我们将changes变量承载的更新次序和Channel最终的值打印出来。从如下的输出结果可以看出，本应该最先完成的 “foo” 节点提供的更新反而放在最后，但是Channel最后的值确实是提取的最后一个。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">collected</span> <span class="hljs-selector-tag">changes</span>: <span class="hljs-selector-attr">[<span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>, <span class="hljs-string">'foo'</span>]</span>
<span class="hljs-selector-tag">channel</span> <span class="hljs-selector-tag">value</span>: <span class="hljs-selector-tag">foo</span>
</code></pre>
<h3 data-id="heading-5">3.3	LastValueAfterFinish</h3>
<p>LastValueAfterFinish类型的Channel弥补了LastValue在同一Superstep中不能多次更新的不足，它的update方法采用了与AnyValue类似的逻辑，总是会提取最后提交的更新。不过我们在前面已经说过，我们不应该对更新顺序作任何假设，所以它是选择第一个还是最后一个其实都没有什么不同。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LastValueAfterFinish</span>(
    <span class="hljs-type">Generic</span>[Value], BaseChannel[Value, Value, <span class="hljs-built_in">tuple</span>[Value, <span class="hljs-built_in">bool</span>]]):
    value: Value | <span class="hljs-type">Any</span>
    finished: <span class="hljs-built_in">bool</span>	
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, typ: <span class="hljs-type">Any</span>, key: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-built_in">super</span>().__init__(typ, key)
        self.value = MISSING
        self.finished = <span class="hljs-literal">False</span>   

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, values: <span class="hljs-type">Sequence</span>[Value | <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(values) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

        self.finished = <span class="hljs-literal">False</span>
        self.value = values[-<span class="hljs-number">1</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">consume</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">if</span> self.finished:
            self.finished = <span class="hljs-literal">False</span>
            self.value = MISSING
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">finish</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.finished <span class="hljs-keyword">and</span> self.value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> MISSING:
            self.finished = <span class="hljs-literal">True</span>
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self</span>) -&gt; Value:
        <span class="hljs-keyword">if</span> self.value <span class="hljs-keyword">is</span> MISSING <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> self.finished:
            <span class="hljs-keyword">raise</span> EmptyChannelError()
        <span class="hljs-keyword">return</span> self.value

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_available</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">return</span> self.value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> MISSING <span class="hljs-keyword">and</span> self.finished
</code></pre>
<p>LastValueAfterFinish最为典型的特性是针对它的更新只有在Superstep完成之后才会生效，所以在Superstep N中的更新只能等到Superstep N+1才能被读取。我们可以从LastValueAfterFinish的定义看出它利用finished字段判断Superstep是否完成，这个字段会在update和finish方法中分别被设置成False和True。is_available方法在做出可用性判断的时候会同时评估值是否存在和这个finished字段的值。</p>
<p>赋予了LastValueAfterFinish “跨步延迟” 的可见性，我们可以从如下这个演示程序看出它和LastValue的不同之处。如代码片段所示，Pregel唯一的Node订阅了“foo”和“bar”这两个Channel，其类型分别为LastValue和LastValueAfterFinish。在Superstep -1提供的两个输入foo和bar，前者在Superstep -1可见，所以会在Superstep 0触发节点执行，此时后者是不可用的状态。等到Superstep 0结束，finish方法被调用之后，bar变得可用，其更新触发节点与Superstep 1中再次执行。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue,LastValueAfterFinish
<span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>

inputs:<span class="hljs-built_in">list</span> = []
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">args:<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>,<span class="hljs-type">Any</span>], config: RunnableConfig</span>)-&gt;<span class="hljs-literal">None</span>:
    step = config.get(<span class="hljs-string">"metadata"</span>, {}).get(<span class="hljs-string">"langgraph_step"</span>)
    inputs.append((step, args.get(<span class="hljs-string">"foo"</span>), args.get(<span class="hljs-string">"bar"</span>)))

node = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"foo"</span>,<span class="hljs-string">"bar"</span>, read=<span class="hljs-literal">True</span>)
    .do(handle))

app =  Pregel(
    nodes={<span class="hljs-string">"body"</span>: node},
    channels={
        <span class="hljs-string">"foo"</span>: LastValue(<span class="hljs-built_in">str</span>), 
        <span class="hljs-string">"bar"</span>: LastValueAfterFinish(<span class="hljs-built_in">str</span>),  
    },
    input_channels=[<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>],
    output_channels=[],
)
app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"foo"</span>: <span class="hljs-string">"123"</span>, <span class="hljs-string">"bar"</span>: <span class="hljs-string">"456"</span>,})
<span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(inputs) == <span class="hljs-number">2</span>
<span class="hljs-keyword">assert</span> inputs[<span class="hljs-number">0</span>] == (<span class="hljs-number">0</span>, <span class="hljs-string">"123"</span>, <span class="hljs-literal">None</span>)
<span class="hljs-keyword">assert</span> inputs[<span class="hljs-number">1</span>] == (<span class="hljs-number">1</span>, <span class="hljs-string">"123"</span>, <span class="hljs-string">"456"</span>)
</code></pre>
<p>如下这种Node根据无法被触发执行的问题，也正是源于LastValueAfterFinish这种“跨步延迟” 的可见性造成的。由于作为输入Channel的类型为LastValueAfterFinish，所以在Superstep -1中处于不可用的状态，所以引擎任务下一步没有需要执行的节点，整个流程就直接结束了。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue,LastValueAfterFinish
<span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder

node = (NodeBuilder()
        .subscribe_only(<span class="hljs-string">"input"</span>)
        .do(<span class="hljs-keyword">lambda</span> args:args)
        .write_to(<span class="hljs-string">"output"</span>))
app =  Pregel(
    nodes={<span class="hljs-string">"body"</span>: node},
    channels={
       <span class="hljs-string">"input"</span>: LastValueAfterFinish(<span class="hljs-built_in">str</span>), 
       <span class="hljs-string">"output"</span>: LastValue(<span class="hljs-built_in">str</span>),
    },
    input_channels=[<span class="hljs-string">"input"</span>],
    output_channels=[<span class="hljs-string">"output"</span>],
)
result = app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"input"</span>: <span class="hljs-string">"foobar"</span>})
<span class="hljs-keyword">assert</span> result == <span class="hljs-literal">None</span>
</code></pre>
<p>从给出的定义我们还发现，LastValueAfterFinish还重写了consume，并将finished字段重置为False，并将值抹除。这个实现赋予了LastValueAfterFinish “阅后即焚” 的特性。</p>
<h3 data-id="heading-6">3.4	EphemeralValue</h3>
<p>EphemeralValue是一种专门用于短寿命数据传递的Channel类型，因为它的核心特性就是 “更新数据邻步有效” 。EphemeralValue在默认情况下也像LastValue一样不支持通过Superstep中的多个更新，但是我们可用在构造函数中将guard参数设置为False来关闭这个限制。如果允许单个Superstep内的多次更新，它也只会选择最后一次更新提供的值。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">EphemeralValue</span>(<span class="hljs-type">Generic</span>[Value], BaseChannel[Value, Value, Value]):
    __slots__ = (<span class="hljs-string">"value"</span>, <span class="hljs-string">"guard"</span>)
    value: Value | <span class="hljs-type">Any</span>
    guard: <span class="hljs-built_in">bool</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, typ: <span class="hljs-type">Any</span>, guard: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-built_in">super</span>().__init__(typ)
        self.guard = guard
        self.value = MISSING    

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, values: <span class="hljs-type">Sequence</span>[Value]</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(values) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">if</span> self.value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> MISSING:
                self.value = MISSING
                <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(values) != <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> self.guard:
            <span class="hljs-keyword">raise</span> InvalidUpdateError(
                <span class="hljs-string">f"At key '<span class="hljs-subst">{self.key}</span>': EphemeralValue(guard=True) can receive only one value per step. Use guard=False if you want to store any one of multiple values."</span>
            )

        self.value = values[-<span class="hljs-number">1</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
</code></pre>
<p>EphemeralValue所谓的 “邻步有效” 的更新有效性策略实现在它的update方法中。如上面的代码片段所示，如果当前Superstep内无更新，update方法的values参数为空，此时它会将之前设置的值清空。如下的演示程序充分体现了这一点：在Super step -1输入到 “bar” 这个EphemeralValue类型的Channel，它的值只能Superstep 0中执行的Node（ “node1” ）读取，在Superstep中的Node（ “node2” ）试试图读取时已被清空。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue,EphemeralValue
<span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>

inputs:<span class="hljs-built_in">list</span> = []
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle</span>(<span class="hljs-params">args:<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>,<span class="hljs-type">Any</span>], config: RunnableConfig</span>)-&gt;<span class="hljs-literal">None</span>:
    step = config.get(<span class="hljs-string">"metadata"</span>, {}).get(<span class="hljs-string">"langgraph_step"</span>)
    inputs.append((step, args.get(<span class="hljs-string">"foo"</span>), args.get(<span class="hljs-string">"bar"</span>)))

node1 = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"node1"</span>, read=<span class="hljs-literal">False</span>)
    .read_from(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>)
    .do(handle)
    .write_to(node2= <span class="hljs-literal">None</span>))

node2 = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"node2"</span>, read=<span class="hljs-literal">False</span>)
    .read_from(<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>)
    .do(handle))

app =  Pregel(
    nodes={<span class="hljs-string">"node1"</span>: node1, <span class="hljs-string">"node2"</span>: node2},
    channels={
        <span class="hljs-string">"foo"</span>: LastValue(<span class="hljs-built_in">str</span>), 
        <span class="hljs-string">"bar"</span>: EphemeralValue(<span class="hljs-built_in">str</span>),  
        <span class="hljs-string">"node1"</span>: LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"node2"</span>: LastValue(<span class="hljs-literal">None</span>),
    },
    input_channels=[<span class="hljs-string">"node1"</span>,<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>],
    output_channels=[],
)

app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"node1"</span>: <span class="hljs-literal">None</span>,<span class="hljs-string">"foo"</span>: <span class="hljs-string">"123"</span>, <span class="hljs-string">"bar"</span>: <span class="hljs-string">"456"</span>,})
<span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(inputs) == <span class="hljs-number">2</span>
<span class="hljs-keyword">assert</span> inputs[<span class="hljs-number">0</span>] == (<span class="hljs-number">0</span>, <span class="hljs-string">"123"</span>, <span class="hljs-string">"456"</span>)
<span class="hljs-keyword">assert</span> inputs[<span class="hljs-number">1</span>] == (<span class="hljs-number">1</span>, <span class="hljs-string">"123"</span>, <span class="hljs-literal">None</span>)
</code></pre>
<h3 data-id="heading-7">3.5	UntrackedValue</h3>
<p>UntrackedValue是一种特殊的Channel类型，其核心特性在于它的 “非持久性” 和 “不可追踪性” 。写入UntrackedValue的值常驻内存，并会参与持久化。这一特性体现在的checkpoint和from_checkpoint方法上，前者为持久化提供一个空值，后者直接放弃从持久化存储加载的值。与EphemeralValue一样，UntrackedValue也通过构造函数的guard参数决定是否允许同一Superstep的多次写入。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UntrackedValue</span>(<span class="hljs-type">Generic</span>[Value], BaseChannel[Value, Value, Value]):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">checkpoint</span>(<span class="hljs-params">self</span>) -&gt; Value | <span class="hljs-type">Any</span>:
        <span class="hljs-keyword">return</span> MISSING
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">from_checkpoint</span>(<span class="hljs-params">self, checkpoint: Value</span>) -&gt; Self:
        empty = self.__class__(self.typ, self.guard)
        empty.key = self.key
        <span class="hljs-keyword">return</span> empty
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, values: <span class="hljs-type">Sequence</span>[Value]</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(values) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(values) != <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> self.guard:
            <span class="hljs-keyword">raise</span> InvalidUpdateError(
                <span class="hljs-string">f"At key '<span class="hljs-subst">{self.key}</span>': UntrackedValue(guard=True) can receive only one value per step. Use guard=False if you want to store any one of multiple values."</span>
            )

        self.value = values[-<span class="hljs-number">1</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
</code></pre>
<p>在复杂的智能体工作流中，并非所有数据都适合或需要持久化。使用UntrackedValue的主要原因包括：</p>
<ul>
<li>
<p>安全性与隐私：某些敏感信息（如临时访问令牌、API Keys 或用户私密凭证）不应写入磁盘或持久化数据库的快照中。</p>
</li>
<li>
<p>性能优化：如果某些数据量极大（如大型图像 Buffer、大型文件流或复杂的对象实例），且这些数据在系统崩溃后可以重新生成或不再需要，排除它们可以显著减小 Checkpoint 的体积，提升存储性能。</p>
</li>
<li>
<p>对象非序列化兼容：有些 Python 对象（如打开的文件句柄、数据库连接、正在运行的线程或特定的第三方库对象）是无法被序列化的。将它们放入UntrackedValueChannel可以避免图在保存状态时报错。</p>
</li>
</ul>
<p>UntrackedValueChannel不参与持久化的特性可用通过如下这个程序来验证。如代码片段所示，我们分别定义了一个组输入Channel（foo和bar）和输出Channel（baz和qux），每组中一个是常规的LastValue，另一个则是UntrackedValueChannel。我们为Pregel对象指定了Checkpointer, 并在调用时利用RunnableConfig指定了Thread ID，那么调用的历史将会被持久化下来。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue,UntrackedValue
<span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver

node = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"foo"</span>,<span class="hljs-string">"bar"</span>)
    .do(<span class="hljs-keyword">lambda</span> args:args)
    .write_to(baz=<span class="hljs-keyword">lambda</span> r: r[<span class="hljs-string">"foo"</span>], qux=<span class="hljs-keyword">lambda</span> r: r[<span class="hljs-string">"bar"</span>]))
app =  Pregel(
    nodes={<span class="hljs-string">"body"</span>: node},
    channels={
        <span class="hljs-string">"foo"</span>: LastValue(<span class="hljs-built_in">str</span>), 
        <span class="hljs-string">"bar"</span>: UntrackedValue(<span class="hljs-built_in">str</span>), 
        <span class="hljs-string">"baz"</span>: LastValue(<span class="hljs-built_in">str</span>), 
        <span class="hljs-string">"qux"</span>: UntrackedValue(<span class="hljs-built_in">str</span>),
    },
    input_channels=[<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>],
    output_channels=[<span class="hljs-string">"baz"</span>, <span class="hljs-string">"qux"</span>],
    checkpointer= InMemorySaver()
)
config:RunnableConfig = {<span class="hljs-string">"configurable"</span>:{<span class="hljs-string">"thread_id"</span>:<span class="hljs-string">"123"</span>}}
app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"start"</span>: <span class="hljs-literal">None</span>,<span class="hljs-string">"foo"</span>: <span class="hljs-string">"123"</span>, <span class="hljs-string">"bar"</span>: <span class="hljs-string">"456"</span>,}, config=config)
<span class="hljs-keyword">for</span> state <span class="hljs-keyword">in</span> app.get_state_history(config=config):
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"step <span class="hljs-subst">{state.metadata[<span class="hljs-string">'step'</span>]}</span>: <span class="hljs-subst">{state.values}</span>"</span>)
</code></pre>
<p>我们调用Pregel的get_state_history方法提取持久化的历史，并输出每个Checkpoint中存储的Channel值。从如下的输出结果可用看出，被持久化的Checkpoint不会保留类型为UntrackedValueChannel的Channel状态，不论它是输入还是输出。</p>
<pre><code class="hljs language-arduino" lang="arduino">step <span class="hljs-number">0</span>: {<span class="hljs-string">'foo'</span>: <span class="hljs-string">'123'</span>, <span class="hljs-string">'baz'</span>: <span class="hljs-string">'123'</span>}
step <span class="hljs-number">-1</span>: {<span class="hljs-string">'foo'</span>: <span class="hljs-string">'123'</span>}
</code></pre>
<h3 data-id="heading-8">3.6	BinaryOperatorAggregate</h3>
<p>BinaryOperatorAggregate是功能最强大的Channel类型。首先，它支持同一Superstep中针对它的多次写入；其次，我们可用利用它来存储不同类型的数据，可以是单值，也可以是列表、集合胡总和字典，因为最终存储的值是由我们提供的一个二元操作符决定的。这个操作符体现为一个Callable[[Value, Value], Value] 对象，两个输入参数分别表示现有的值和新写入的值，这个可执行对象的返回值最终写入Channel的值。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BinaryOperatorAggregate</span>(<span class="hljs-type">Generic</span>[Value], BaseChannel[Value, Value, Value]):
    __slots__ = (<span class="hljs-string">"value"</span>, <span class="hljs-string">"operator"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, typ: <span class="hljs-built_in">type</span>[Value], operator: <span class="hljs-type">Callable</span>[[Value, Value], Value]</span>):
        <span class="hljs-built_in">super</span>().__init__(typ)
        self.operator = operator
        …
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, values: <span class="hljs-type">Sequence</span>[Value]</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> values:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> self.value <span class="hljs-keyword">is</span> MISSING:
            self.value = values[<span class="hljs-number">0</span>]
            values = values[<span class="hljs-number">1</span>:]
        seen_overwrite: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> values:
            is_overwrite, overwrite_value = _get_overwrite(value)
            <span class="hljs-keyword">if</span> is_overwrite:
                <span class="hljs-keyword">if</span> seen_overwrite:
                    msg = create_error_message(
                        message=<span class="hljs-string">"Can receive only one Overwrite value per super-step."</span>,
                        error_code=ErrorCode.INVALID_CONCURRENT_GRAPH_UPDATE,
                    )
                    <span class="hljs-keyword">raise</span> InvalidUpdateError(msg)
                self.value = overwrite_value
                seen_overwrite = <span class="hljs-literal">True</span>
                <span class="hljs-keyword">continue</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> seen_overwrite:
                self.value = self.operator(self.value, value)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
</code></pre>
<p>BinaryOperatorAggregate的核心全部体现update方法上。在正常情况下，它会遍历每个待写入的值，并将value字段表示的当前值和待写入的值作为参数调用二元操作，最后将返回结果赋值给value字段。我们已经在前面的演示实例中多次使用过这个类型，比如我们通过如下的方式将所有写入的值全部保存下来。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue,BinaryOperatorAggregate
<span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder
<span class="hljs-keyword">import</span> operator

<span class="hljs-keyword">def</span> <span class="hljs-title function_">build_node</span>(<span class="hljs-params">node_name:<span class="hljs-built_in">str</span></span>)-&gt;NodeBuilder:
    <span class="hljs-keyword">return</span> (NodeBuilder()
        .subscribe_to(<span class="hljs-string">"start"</span>, read=<span class="hljs-literal">False</span>)
        .do(<span class="hljs-keyword">lambda</span> _: [node_name])
        .write_to(<span class="hljs-string">"result"</span>))

app = Pregel(
    nodes={name: build_node(name) <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> [<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"baz"</span>]},
    channels={
        <span class="hljs-string">"start"</span>: LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"result"</span>: BinaryOperatorAggregate(<span class="hljs-built_in">list</span>, operator.add),
    },
    input_channels=[<span class="hljs-string">"start"</span>],
    output_channels=[<span class="hljs-string">"result"</span>],
)

result = app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"start"</span>: <span class="hljs-literal">None</span>})
<span class="hljs-keyword">assert</span> <span class="hljs-built_in">all</span>(x <span class="hljs-keyword">in</span> result[<span class="hljs-string">"result"</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"baz"</span>])
</code></pre>
<p>对于上面这个例子，由于我们Channel存储的数据类型是列表，而operator.add要求两个输入参数均为列表，所以我们不得不让Node将单值封装成列表。虽然BinaryOperatorAggregate以“泛型” 的形式定义，作为操作的可执行对象也定义Callable[[Value, Value], Value]类型，貌似要求存储类型和待更新数据类型一致，但我们知道泛型在运行时是没有约束力的，所以我们可以根据具体的需求自由发挥。比如如下这个例子用于构造BinaryOperatorAggregate是我们自定义的append函数，它及支持列表，也支持单值。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue,BinaryOperatorAggregate
<span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">build_node</span>(<span class="hljs-params">node_name:<span class="hljs-built_in">str</span></span>)-&gt;NodeBuilder:
    <span class="hljs-keyword">return</span> (NodeBuilder()
        .subscribe_to(<span class="hljs-string">"start"</span>, read=<span class="hljs-literal">False</span>)
        .do(<span class="hljs-keyword">lambda</span> _: node_name)
        .write_to(<span class="hljs-string">"result"</span>))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">append</span>(<span class="hljs-params">a:<span class="hljs-built_in">list</span>,b:<span class="hljs-type">Any</span></span>)-&gt;<span class="hljs-built_in">list</span>:
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(b,<span class="hljs-built_in">list</span>):
        <span class="hljs-keyword">return</span> a + b
    <span class="hljs-keyword">else</span>:
        a.append(b)
        <span class="hljs-keyword">return</span> a

app = Pregel(
    nodes={name: build_node(name) <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> [<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"baz"</span>]},
    channels={
        <span class="hljs-string">"start"</span>: LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"result"</span>: BinaryOperatorAggregate(<span class="hljs-built_in">list</span>, append),
    },
    input_channels=[<span class="hljs-string">"start"</span>],
    output_channels=[<span class="hljs-string">"result"</span>],
)

result = app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"start"</span>: <span class="hljs-literal">None</span>})
<span class="hljs-keyword">assert</span> <span class="hljs-built_in">all</span>(x <span class="hljs-keyword">in</span> result[<span class="hljs-string">"result"</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>, <span class="hljs-string">"baz"</span>])
</code></pre>
<p>我们从BinaryOperatorAggregate的update方法的定义还发现了它执行“覆盖（override）”的功能。按照代码反映的逻辑，如果提供的是一个Overwrite对象，指定的二元操作将被忽略，update方法会直接使用该对象的value字段覆盖现有的值。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@dataclass(<span class="hljs-params">slots=<span class="hljs-literal">True</span></span>)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Overwrite</span>:
    value: <span class="hljs-type">Any</span>
</code></pre>
<p>比如下面的演示程序中，率先执行的节点foo将自己的名称添加到名为“output”的这个BinaryOperatorAggregate通道中，但是节点bar执行之后会将最终的值以覆盖的方式改写成["bar"]。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue,BinaryOperatorAggregate
<span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> Overwrite

foo = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"foo"</span>, read=<span class="hljs-literal">False</span>)
    .write_to(output = [<span class="hljs-string">"foo"</span>], bar=<span class="hljs-literal">None</span>))
bar = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"bar"</span>, read=<span class="hljs-literal">False</span>)
    .do(<span class="hljs-keyword">lambda</span> _: Overwrite(value=[<span class="hljs-string">"bar"</span>]))
    .write_to(<span class="hljs-string">"output"</span>))

app = Pregel(
    nodes={<span class="hljs-string">"foo"</span>: foo, <span class="hljs-string">"bar"</span>: bar},
    channels={
        <span class="hljs-string">"foo"</span>: LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"bar"</span>: LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"output"</span>: BinaryOperatorAggregate(<span class="hljs-built_in">list</span>, <span class="hljs-keyword">lambda</span> a,b: a + b),
    },
    input_channels=[<span class="hljs-string">"foo"</span>],
    output_channels=[<span class="hljs-string">"output"</span>],
)

result = app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"foo"</span>: <span class="hljs-literal">None</span>}, interrupt_after= <span class="hljs-string">"foo"</span>)
<span class="hljs-keyword">assert</span> result == {<span class="hljs-string">"output"</span>: [<span class="hljs-string">"foo"</span>]}

result = app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"foo"</span>: <span class="hljs-literal">None</span>})
<span class="hljs-keyword">assert</span> result == {<span class="hljs-string">"output"</span>: [<span class="hljs-string">"bar"</span>]}
</code></pre>
<p>这种覆盖性质的写还可以按照如下的方写入一个特殊的字典来实现。这个字典只包含一个Key为 “<strong>overwrite</strong>” 的键值对，它的值将用于覆盖现有的值。值得一提的是，在一个Superstep中，这样的覆盖操作只能进行一次。如果多次提供这样的字典和Overwrite对象，update方法会抛出一个InvalidUpdateError异常。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue,BinaryOperatorAggregate
<span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder

foo = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"foo"</span>, read=<span class="hljs-literal">False</span>)
    .write_to(output = [<span class="hljs-string">"foo"</span>], bar=<span class="hljs-literal">None</span>))
bar = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"bar"</span>, read=<span class="hljs-literal">False</span>)
    .do(<span class="hljs-keyword">lambda</span> _: {<span class="hljs-string">"__overwrite__"</span>: [<span class="hljs-string">"bar"</span>]})
    .write_to(<span class="hljs-string">"output"</span>))

app = Pregel(
    nodes={<span class="hljs-string">"foo"</span>: foo, <span class="hljs-string">"bar"</span>: bar},
    channels={
        <span class="hljs-string">"foo"</span>: LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"bar"</span>: LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"output"</span>: BinaryOperatorAggregate(<span class="hljs-built_in">list</span>, <span class="hljs-keyword">lambda</span> a,b: a + b),
    },
    input_channels=[<span class="hljs-string">"foo"</span>],
    output_channels=[<span class="hljs-string">"output"</span>],
)

result = app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"foo"</span>: <span class="hljs-literal">None</span>}, interrupt_after= <span class="hljs-string">"foo"</span>)
<span class="hljs-keyword">assert</span> result == {<span class="hljs-string">"output"</span>: [<span class="hljs-string">"foo"</span>]}

result = app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"foo"</span>: <span class="hljs-literal">None</span>})
<span class="hljs-keyword">assert</span> result == {<span class="hljs-string">"output"</span>: [<span class="hljs-string">"bar"</span>]}
</code></pre>
<h3 data-id="heading-9">3.7	NamedBarrierValue</h3>
<p>我们在前面的演示实例中利用NamedBarrierValue这个特殊的Channel解决了“多Node依赖”的问题，我们从中也能大致知道它的工作原理：它内部维护两个集合，一个是初始化指定的名称集合，另一个写入填充的集合，等两个集合一致的时候该Channel才变得可用。这两个集合对应NamedBarrierValue如下所示的names和seen集合。当update在应用更新的时候，如果提供的名称没有在names集合中，会直接抛出InvalidUpdateError异常。如果已经在seen集合中，它会直接忽略并返回False，否则才会将其添加到seen集合中，并返回True。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NamedBarrierValue</span>(<span class="hljs-type">Generic</span>[Value], BaseChannel[Value, Value, <span class="hljs-built_in">set</span>[Value]]):

    names: <span class="hljs-built_in">set</span>[Value]
    seen: <span class="hljs-built_in">set</span>[Value]

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, typ: <span class="hljs-built_in">type</span>[Value], names: <span class="hljs-built_in">set</span>[Value]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-built_in">super</span>().__init__(typ)
        self.names = names
        self.seen: <span class="hljs-built_in">set</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-built_in">set</span>()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">checkpoint</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">set</span>[Value]:
        <span class="hljs-keyword">return</span> self.seen

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">from_checkpoint</span>(<span class="hljs-params">self, checkpoint: <span class="hljs-built_in">set</span>[Value]</span>) -&gt; Self:
        empty = self.__class__(self.typ, self.names)
        empty.key = self.key
        <span class="hljs-keyword">if</span> checkpoint <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> MISSING:
            empty.seen = checkpoint
        <span class="hljs-keyword">return</span> empty

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, values: <span class="hljs-type">Sequence</span>[Value]</span>) -&gt; <span class="hljs-built_in">bool</span>:
        updated = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> values:
            <span class="hljs-keyword">if</span> value <span class="hljs-keyword">in</span> self.names:
                <span class="hljs-keyword">if</span> value <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.seen:
                    self.seen.add(value)
                    updated = <span class="hljs-literal">True</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">raise</span> InvalidUpdateError(
                    <span class="hljs-string">f"At key '<span class="hljs-subst">{self.key}</span>': Value <span class="hljs-subst">{value}</span> not in <span class="hljs-subst">{self.names}</span>"</span>
                )
        <span class="hljs-keyword">return</span> updated

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">self</span>) -&gt; Value:
        <span class="hljs-keyword">if</span> self.seen != self.names:
            <span class="hljs-keyword">raise</span> EmptyChannelError()
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_available</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">return</span> self.seen == self.names

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">consume</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-keyword">if</span> self.seen == self.names:
            self.seen = <span class="hljs-built_in">set</span>()
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<p>为了保留填充的名称，用于持久化的checkpoint方法会直接提供seen集合，而对应的from_checkpoint方法则将Checkpoint提供的内容赋值给seen集合。由于NamedBarrierValue的目的仅仅是在等到希望的名称被填满是对外发出信号，该条件体现在is_available方法上。如果此条件不满足，它的get方法会直接抛出EmptyChannelError异常。在条件满足后，get方法返回的值也不重要，所以它直接返回None。和LastValueAfterFinish一样，NamedBarrierValue同样在重写的consume方法中清空了seen集合，达到了 “阅后即焚” 的效果。</p>
<h3 data-id="heading-10">3.8	NamedBarrierValueAfterFinish</h3>
<p>NamedBarrierValueAfterFinish在NamedBarrierValue基础上添加了基于 “AfterFinish” 的可用性限制。即使names和seen集合导致一致状态，其生效的时机会延后致下一个Superstep。NamedBarrierValueAfterFinish会在内部维护一个finished状态，当seen被填充满时针对finish方法的调用会将此状态设置为True。在达到可用条件后针对consume方法的调用会将此状态设置为False。实现的逻辑基本上与和LastValueAfterFinish一致。</p>
<h3 data-id="heading-11">3.9	Topic</h3>
<p>Topic类型的Channel就相当于一个消息队列，它会保留所有提供的数据。在默认情况下，在完成基于Superstep的更新应用之前，这个对象会被清空。如果在初始化的时候利用accumulate参数开启了 “累积” 模式，数据在跨越Superstep时会被保留。这个逻辑体现在如下所示的update方法上。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Topic</span>(
    <span class="hljs-type">Generic</span>[Value],
    BaseChannel[<span class="hljs-type">Sequence</span>[Value], Value | <span class="hljs-built_in">list</span>[Value], <span class="hljs-built_in">list</span>[Value]]):

    __slots__ = (<span class="hljs-string">"values"</span>, <span class="hljs-string">"accumulate"</span>)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, typ: <span class="hljs-built_in">type</span>[Value], accumulate: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-built_in">super</span>().__init__(typ)
        self.accumulate = accumulate
        self.values = <span class="hljs-built_in">list</span>[Value]()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">self, values: <span class="hljs-type">Sequence</span>[Value | <span class="hljs-built_in">list</span>[Value]]</span>) -&gt; <span class="hljs-built_in">bool</span>:
        updated = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.accumulate:
            updated = <span class="hljs-built_in">bool</span>(self.values)
            self.values = <span class="hljs-built_in">list</span>[Value]()
        <span class="hljs-keyword">if</span> flat_values := <span class="hljs-built_in">tuple</span>(_flatten(values)):
            updated = <span class="hljs-literal">True</span>
            self.values.extend(flat_values)
        <span class="hljs-keyword">return</span> updated
</code></pre>
<p>如下的代码体现了是否开启“累积效应”之间的差异。如代码片段所示，我们由四个Node（node1、node2、node3和node4）构建了一个Pregel。四个Node分两个Superstep完成，其中node1和node2先执行，node3和node4后执行，具体实现借助了一个NamedBarrierValue类型的Channel（trigger）。这四个Node都会将自己的名称写入foo和bar两个Topic类型的通道，其中bar开启了累积模式。所有从最后的调用结果可用看出，通道foo只保留了最后Superstep写入的内容，而通道bar则把整个执行流程写入的数据都保留了下来。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.channels <span class="hljs-keyword">import</span> LastValue,NamedBarrierValue, Topic
<span class="hljs-keyword">from</span> langgraph.pregel <span class="hljs-keyword">import</span> Pregel, NodeBuilder

node1 = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"start"</span>, read=<span class="hljs-literal">False</span>)
    .write_to(trigger=<span class="hljs-string">"node1"</span>, foo=<span class="hljs-string">"node1"</span>, bar=<span class="hljs-string">"node1"</span>))
node2 = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"start"</span>, read=<span class="hljs-literal">False</span>)
    .write_to(trigger=<span class="hljs-string">"node2"</span>, foo=<span class="hljs-string">"node2"</span>, bar=<span class="hljs-string">"node2"</span>))

node3 = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"trigger"</span>, read=<span class="hljs-literal">False</span>)
    .write_to(foo=<span class="hljs-string">"node3"</span>, bar=<span class="hljs-string">"node3"</span>))
node4 = (NodeBuilder()
    .subscribe_to(<span class="hljs-string">"trigger"</span>, read=<span class="hljs-literal">False</span>)
    .write_to(foo=<span class="hljs-string">"node4"</span>, bar=<span class="hljs-string">"node4"</span>))

app = Pregel(
    nodes={<span class="hljs-string">"node1"</span>: node1, <span class="hljs-string">"node2"</span>: node2, <span class="hljs-string">"node3"</span>: node3, <span class="hljs-string">"node4"</span>: node4},
    channels={
        <span class="hljs-string">"start"</span>: LastValue(<span class="hljs-literal">None</span>),
        <span class="hljs-string">"trigger"</span>: NamedBarrierValue(<span class="hljs-built_in">list</span>,names={<span class="hljs-string">"node1"</span>, <span class="hljs-string">"node2"</span>}),
        <span class="hljs-string">"foo"</span>: Topic(<span class="hljs-built_in">list</span>),
        <span class="hljs-string">"bar"</span>: Topic(<span class="hljs-built_in">list</span>, accumulate=<span class="hljs-literal">True</span>),
    },
    input_channels=[<span class="hljs-string">"start"</span>],
    output_channels=[<span class="hljs-string">"foo"</span>, <span class="hljs-string">"bar"</span>],
)   

result = app.invoke(<span class="hljs-built_in">input</span>={<span class="hljs-string">"start"</span>: <span class="hljs-literal">None</span>})
<span class="hljs-keyword">assert</span> <span class="hljs-built_in">set</span>(result[<span class="hljs-string">"foo"</span>]) == {<span class="hljs-string">"node3"</span>, <span class="hljs-string">"node4"</span>}
<span class="hljs-keyword">assert</span> <span class="hljs-built_in">set</span>(result[<span class="hljs-string">"bar"</span>]) == {<span class="hljs-string">"node1"</span>, <span class="hljs-string">"node2"</span>, <span class="hljs-string">"node3"</span>, <span class="hljs-string">"node4"</span>}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Requests库入门指南]]></title>    <link>https://juejin.cn/post/7603282168137842707</link>    <guid>https://juejin.cn/post/7603282168137842707</guid>    <pubDate>2026-02-06T05:15:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603282168137842707" data-draft-id="7603352061505650694" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Requests库入门指南"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2026-02-06T05:15:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小张说故事"/> <meta itemprop="url" content="https://juejin.cn/user/741501567509111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Requests库入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/741501567509111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小张说故事
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T05:15:00.000Z" title="Fri Feb 06 2026 05:15:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 库的概览与核心价值</h2>
<p>想象一下,在网络世界中,如果你想与各种网站和服务进行通信,就像是用传统的信件往来。你需要手动打包数据、编写地址、处理回复编码,这些繁琐的细节会让简单的任务变得复杂。<code>requests</code>库正是为解决这些问题而生的工具。</p>
<p>Requests是Python中最流行的HTTP客户端库,它的设计哲学是"为人类设计"。它将复杂的HTTP协议细节封装在简洁的API之下,让开发者能够用最少的代码完成网络请求。与Python标准库中的<code>urllib</code>相比,Requests的使用体验提升了90%以上——你不再需要手动处理URL编码、表单数据序列化、连接池管理等底层细节。</p>
<p>Requests在Python生态系统中占据着不可或缺的地位。据PyPI官方统计,它的下载量每月超过10亿次,超过50万个开源项目依赖它。无论是调用REST API、构建网络爬虫、自动化测试,还是开发微服务客户端,Requests都是首选工具。它支持HTTP/1.1的所有特性,包括连接池管理、Cookie持久化、SSL验证、自动内容解码等,让HTTP请求变得前所未有的简单。</p>
<h2 data-id="heading-1">2. 环境搭建与"Hello, World"</h2>
<h3 data-id="heading-2">安装说明</h3>
<p>Requests不是Python标准库的一部分,需要通过包管理器安装:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用pip安装(推荐)</span>
pip install requests

<span class="hljs-comment"># 使用conda安装</span>
conda install requests

<span class="hljs-comment"># 使用Python模块方式安装</span>
python -m pip install requests
</code></pre>
<p>Requests官方支持Python 3.9+版本,同时也兼容PyPy解释器。如果在安装过程中遇到权限问题,可以尝试使用<code>--user</code>参数或创建虚拟环境。</p>
<h3 data-id="heading-3">最简示例</h3>
<p>以下是一个简单的"Hello, World"示例,展示如何发送GET请求并获取响应:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests

<span class="hljs-comment"># 发送GET请求到GitHub API</span>
response = requests.get(<span class="hljs-string">'https://api.github.com/events'</span>)

<span class="hljs-comment"># 打印响应状态码</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"状态码: <span class="hljs-subst">{response.status_code}</span>"</span>)

<span class="hljs-comment"># 打印响应内容的前100个字符</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"响应内容: <span class="hljs-subst">{response.text[:<span class="hljs-number">100</span>]}</span>"</span>)
</code></pre>
<h3 data-id="heading-4">逐行解释</h3>
<ol>
<li><code>import requests</code> - 导入Requests库,使其功能在当前脚本中可用。</li>
<li><code>response = requests.get('https://api.github.com/events')</code> - 调用<code>get()</code>方法向GitHub API发送GET请求,返回的<code>Response</code>对象包含了服务器的全部响应信息。</li>
<li><code>print(f"状态码: {response.status_code}")</code> - 访问<code>Response</code>对象的<code>status_code</code>属性,获取HTTP状态码(200表示成功)。</li>
<li><code>print(f"响应内容: {response.text[:100]}")</code> - 通过<code>text</code>属性获取响应的文本内容,并切片显示前100个字符。</li>
</ol>
<h3 data-id="heading-5">运行结果</h3>
<p>程序运行后会输出类似以下内容:</p>
<pre><code class="hljs language-json" lang="json">状态码<span class="hljs-punctuation">:</span> <span class="hljs-number">200</span>
响应内容<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"25698765432"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"PushEvent"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"actor"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-number">12345678</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"login"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"userna
</span></code></pre>
<p>这个简单的例子展示了Requests的核心优势:用三行代码就完成了一次完整的HTTP请求,自动处理了连接建立、数据传输、响应解码等所有细节。</p>
<h2 data-id="heading-6">3. 核心概念解析</h2>
<p>Requests库围绕几个核心概念构建,理解这些概念有助于你更灵活地使用它。</p>
<h3 data-id="heading-7">3.1 请求方法(Request Methods)</h3>
<p>HTTP协议定义了多种请求方法,Requests为每种方法都提供了对应的函数:</p>
<ul>
<li><code>requests.get()</code> - 获取资源</li>
<li><code>requests.post()</code> - 提交数据</li>
<li><code>requests.put()</code> - 更新资源(完整替换)</li>
<li><code>requests.patch()</code> - 更新资源(部分修改)</li>
<li><code>requests.delete()</code> - 删除资源</li>
<li><code>requests.head()</code> - 获取响应头</li>
<li><code>requests.options()</code> - 获取服务器支持的方法</li>
</ul>
<h3 data-id="heading-8">3.2 响应对象(Response Object)</h3>
<p>每次请求后,Requests都会返回一个<code>Response</code>对象,它包含了服务器的完整响应信息:</p>
<ul>
<li><code>response.status_code</code> - HTTP状态码</li>
<li><code>response.text</code> - 响应的文本内容(自动解码)</li>
<li><code>response.content</code> - 响应的字节内容(原始二进制)</li>
<li><code>response.json()</code> - 将JSON响应解析为Python字典</li>
<li><code>response.headers</code> - 响应头信息(字典形式)</li>
<li><code>response.cookies</code> - 服务器设置的Cookie</li>
</ul>
<h3 data-id="heading-9">3.3 会话对象(Session Object)</h3>
<p><code>Session</code>对象允许你在多个请求之间保持某些参数(如Cookies、认证信息),并复用TCP连接,显著提高性能:</p>
<pre><code class="hljs language-python" lang="python">session = requests.Session()
session.headers.update({<span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'My App'</span>})

<span class="hljs-comment"># 第一个请求会保存Cookies</span>
response1 = session.get(<span class="hljs-string">'https://httpbin.org/cookies/set/sessionid/123'</span>)

<span class="hljs-comment"># 第二个请求会自动携带之前保存的Cookies</span>
response2 = session.get(<span class="hljs-string">'https://httpbin.org/cookies'</span>)
</code></pre>
<h3 data-id="heading-10">概念关系图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[requests库] --&gt; B[请求方法]
    A --&gt; C[响应对象]
    A --&gt; D[会话对象]
    
    B --&gt; B1[get/post/put/delete等]
    B --&gt; B2[参数传递: params/data/json]
    
    C --&gt; C1[status_code - 状态码]
    C --&gt; C2[text/content/json - 响应内容]
    C --&gt; C3[headers/cookies - 元信息]
    
    D --&gt; D1[保持Cookie和认证信息]
    D --&gt; D2[复用TCP连接]
    D --&gt; D3[提高请求性能]
    
    B1 --&gt; C
    B2 --&gt; C
    D --&gt; B
</code></pre>
<p>这个图表展示了Requests库的核心概念及其关系:请求方法用于发送请求,响应对象用于接收和处理服务器的回应,而会话对象则在多个请求之间提供状态保持和连接复用。</p>
<h2 data-id="heading-11">4. 实战演练:解决一个典型问题</h2>
<h3 data-id="heading-12">需求分析</h3>
<p>假设我们需要开发一个天气查询应用,能够获取指定城市的当前天气信息。我们将使用免费的天气API,通过发送HTTP请求来获取数据,并解析返回的JSON响应。</p>
<h3 data-id="heading-13">方案设计</h3>
<p>这个项目将展示Requests库的几个核心功能:</p>
<ol>
<li>使用<code>requests.get()</code>发送带参数的GET请求</li>
<li>通过<code>params</code>参数传递查询参数(城市名称)</li>
<li>使用<code>response.json()</code>解析JSON响应</li>
<li>实现错误处理和异常捕获</li>
<li>展示响应数据的提取和格式化</li>
</ol>
<h3 data-id="heading-14">代码实现</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> requests.exceptions <span class="hljs-keyword">import</span> RequestException

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city</span>):
    <span class="hljs-string">"""
    获取指定城市的天气信息
    
    Args:
        city (str): 城市名称,例如"Beijing"或"Shanghai"
    
    Returns:
        dict: 包含天气信息的字典,失败时返回None
    """</span>
    <span class="hljs-comment"># 使用免费的天气API(示例使用httpbin.org模拟)</span>
    base_url = <span class="hljs-string">"https://httpbin.org/get"</span>
    params = {
        <span class="hljs-string">'city'</span>: city,
        <span class="hljs-string">'units'</span>: <span class="hljs-string">'metric'</span>
    }
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 发送GET请求,设置超时时间为5秒</span>
        response = requests.get(base_url, params=params, timeout=<span class="hljs-number">5</span>)
        
        <span class="hljs-comment"># 检查响应状态码,如果不是2xx则抛出异常</span>
        response.raise_for_status()
        
        <span class="hljs-comment"># 解析JSON响应</span>
        data = response.json()
        
        <span class="hljs-comment"># 提取天气信息(这里模拟真实API的数据结构)</span>
        weather_info = {
            <span class="hljs-string">'city'</span>: data.get(<span class="hljs-string">'args'</span>, {}).get(<span class="hljs-string">'city'</span>, city),
            <span class="hljs-string">'temperature'</span>: <span class="hljs-number">25</span>,  <span class="hljs-comment"># 模拟数据</span>
            <span class="hljs-string">'condition'</span>: <span class="hljs-string">'晴朗'</span>,
            <span class="hljs-string">'humidity'</span>: <span class="hljs-number">45</span>,
            <span class="hljs-string">'wind_speed'</span>: <span class="hljs-number">3.2</span>
        }
        
        <span class="hljs-keyword">return</span> weather_info
        
    <span class="hljs-keyword">except</span> requests.exceptions.Timeout:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误: 请求超时,无法获取<span class="hljs-subst">{city}</span>的天气信息"</span>)
    <span class="hljs-keyword">except</span> requests.exceptions.HTTPError <span class="hljs-keyword">as</span> err:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"HTTP错误: <span class="hljs-subst">{err.response.status_code}</span>"</span>)
    <span class="hljs-keyword">except</span> requests.exceptions.RequestException <span class="hljs-keyword">as</span> err:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"请求出错: <span class="hljs-subst">{err}</span>"</span>)
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数:获取并显示多个城市的天气"""</span>
    cities = [<span class="hljs-string">'Beijing'</span>, <span class="hljs-string">'Shanghai'</span>, <span class="hljs-string">'Guangzhou'</span>]
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 天气查询系统 ===\n"</span>)
    
    <span class="hljs-keyword">for</span> city <span class="hljs-keyword">in</span> cities:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"正在查询 <span class="hljs-subst">{city}</span> 的天气..."</span>)
        weather = get_weather(city)
        
        <span class="hljs-keyword">if</span> weather:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{weather[<span class="hljs-string">'city'</span>]}</span> 天气信息:"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  温度: <span class="hljs-subst">{weather[<span class="hljs-string">'temperature'</span>]}</span>°C"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  天气: <span class="hljs-subst">{weather[<span class="hljs-string">'condition'</span>]}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  湿度: <span class="hljs-subst">{weather[<span class="hljs-string">'humidity'</span>]}</span>%"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  风速: <span class="hljs-subst">{weather[<span class="hljs-string">'wind_speed'</span>]}</span> m/s"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    main()
</code></pre>
<h3 data-id="heading-15">运行说明</h3>
<ol>
<li>确保已安装Requests库: <code>pip install requests</code></li>
<li>将代码保存为<code>weather_app.py</code></li>
<li>运行程序: <code>python weather_app.py</code></li>
</ol>
<p>程序会依次查询三个城市的天气信息,并格式化输出结果。虽然示例使用了httpbin.org模拟数据,但代码结构可以直接适配真实的天气API(如OpenWeatherMap、和风天气等),只需修改<code>base_url</code>和数据提取逻辑即可。</p>
<h3 data-id="heading-16">关键点解析</h3>
<ul>
<li><strong>参数传递</strong>: 使用<code>params</code>字典传递查询参数,Requests会自动进行URL编码</li>
<li><strong>超时设置</strong>: <code>timeout=5</code>参数防止请求无限期等待</li>
<li><strong>错误处理</strong>: 使用<code>raise_for_status()</code>自动检查状态码,并捕获各类异常</li>
<li><strong>JSON解析</strong>: <code>response.json()</code>将JSON响应直接转换为Python字典</li>
<li><strong>模块化设计</strong>: 将核心功能封装为函数,便于复用和测试</li>
</ul>
<h2 data-id="heading-17">5. 最佳实践与常见陷阱</h2>
<h3 data-id="heading-18">常见错误及规避方法</h3>
<h4 data-id="heading-19">错误1:不检查状态码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ❌ 错误做法</span>
response = requests.get(<span class="hljs-string">'https://api.example.com/data'</span>)
data = response.json()  <span class="hljs-comment"># 如果状态码不是200,这里可能抛出异常</span>

<span class="hljs-comment"># ✅ 正确做法</span>
response = requests.get(<span class="hljs-string">'https://api.example.com/data'</span>)
response.raise_for_status()  <span class="hljs-comment"># 检查状态码,非2xx时抛出HTTPError</span>
data = response.json()
</code></pre>
<h4 data-id="heading-20">错误2:不设置超时时间</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ❌ 错误做法</span>
response = requests.get(<span class="hljs-string">'https://api.example.com/data'</span>)
<span class="hljs-comment"># 如果网络故障或服务器无响应,程序会无限期等待</span>

<span class="hljs-comment"># ✅ 正确做法</span>
response = requests.get(<span class="hljs-string">'https://api.example.com/data'</span>, timeout=<span class="hljs-number">10</span>)
<span class="hljs-comment"># 10秒后超时,抛出Timeout异常</span>
</code></pre>
<h4 data-id="heading-21">错误3:在循环中重复创建会话</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ❌ 错误做法</span>
<span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> url_list:
    response = requests.get(url)  <span class="hljs-comment"># 每次都建立新连接,效率低下</span>

<span class="hljs-comment"># ✅ 正确做法</span>
<span class="hljs-keyword">with</span> requests.Session() <span class="hljs-keyword">as</span> session:
    <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> url_list:
        response = session.get(url)  <span class="hljs-comment"># 复用连接,性能更高</span>
</code></pre>
<h3 data-id="heading-22">最佳实践建议</h3>
<ol>
<li>
<p><strong>始终使用会话(Session)</strong>: 对于向同一域名发送多个请求的场景,使用Session可以复用TCP连接,减少握手开销,提高性能。</p>
</li>
<li>
<p><strong>合理设置超时</strong>: 建议为所有请求设置超时参数,可以使用元组分别设置连接超时和读取超时,例如<code>timeout=(3, 10)</code>。</p>
</li>
<li>
<p><strong>处理JSON解析异常</strong>: 并非所有API响应都是有效的JSON,使用<code>response.json()</code>时应该捕获<code>JSONDecodeError</code>:</p>
</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json

<span class="hljs-keyword">try</span>:
    data = response.json()
<span class="hljs-keyword">except</span> json.JSONDecodeError:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"响应不是有效的JSON格式"</span>)
    data = <span class="hljs-literal">None</span>
</code></pre>
<ol start="4">
<li><strong>使用User-Agent标识</strong>: 某些网站会检查请求头中的User-Agent,建议设置一个合理的标识:</li>
</ol>
<pre><code class="hljs language-python" lang="python">headers = {
    <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'MyWeatherApp/1.0 (https://myapp.com)'</span>
}
response = requests.get(url, headers=headers)
</code></pre>
<ol start="5">
<li><strong>HTTPS证书验证</strong>: 生产环境中应该验证SSL证书,仅在测试环境或特定场景下禁用:</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 生产环境:验证证书(默认行为)</span>
response = requests.get(<span class="hljs-string">'https://example.com'</span>)

<span class="hljs-comment"># 测试环境:禁用证书验证</span>
response = requests.get(<span class="hljs-string">'https://example.com'</span>, verify=<span class="hljs-literal">False</span>)
</code></pre>
<ol start="6">
<li><strong>使用环境变量管理敏感信息</strong>: API密钥、令牌等敏感信息应该存储在环境变量中,而不是硬编码在代码里:</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os

api_key = os.environ.get(<span class="hljs-string">'MY_API_KEY'</span>)
headers = {<span class="hljs-string">'Authorization'</span>: <span class="hljs-string">f'Bearer <span class="hljs-subst">{api_key}</span>'</span>}
</code></pre>
<h3 data-id="heading-23">注意事项</h3>
<ul>
<li>Requests默认使用连接池,会自动处理Keep-Alive,无需手动管理连接</li>
<li>下载大文件时,使用<code>stream=True</code>参数逐步读取,避免内存溢出</li>
<li>处理重定向时,可以通过<code>allow_redirects=False</code>禁用自动重定向</li>
<li>对于需要认证的API,优先使用Session对象的<code>auth</code>参数或<code>headers</code>参数,而不是在每个请求中重复设置</li>
</ul>
<h2 data-id="heading-24">6. 进阶指引</h2>
<h3 data-id="heading-25">高级功能</h3>
<p>Requests提供了许多高级功能,可以应对复杂的HTTP交互场景:</p>
<ul>
<li><strong>认证处理</strong>: 支持Basic认证、Digest认证、OAuth等多种认证方式</li>
<li><strong>代理配置</strong>: 通过<code>proxies</code>参数配置HTTP/SOCKS代理</li>
<li><strong>流式上传/下载</strong>: 处理大文件传输时避免内存问题</li>
<li><strong>事件钩子</strong>: 在请求的不同阶段注册回调函数</li>
<li><strong>自定义适配器</strong>: 实现自定义的传输协议或连接逻辑</li>
</ul>
<h3 data-id="heading-26">生态扩展</h3>
<p>Requests的生态丰富,有许多扩展库可以增强其功能:</p>
<ul>
<li><code>requests-oauthlib</code>: OAuth认证支持</li>
<li><code>requests-cache</code>: 响应缓存,减少重复请求</li>
<li><code>requests-toolbelt</code>: 实用工具集合,如Multipart上传、流式请求等</li>
<li><code>grequests</code>: 基于gevent的异步请求</li>
<li><code>requests-threads</code>: 多线程请求支持</li>
</ul>
<h3 data-id="heading-27">学习路径</h3>
<p>如果你想深入学习Requests,建议按以下路径进行:</p>
<ol>
<li><strong>掌握基础API</strong>: 熟悉所有请求方法和Response对象的属性</li>
<li><strong>理解HTTP协议</strong>: 学习HTTP/1.1规范,理解状态码、请求头、响应头的含义</li>
<li><strong>探索高级特性</strong>: 研究Session对象、连接池、SSL验证等高级功能</li>
<li><strong>阅读源代码</strong>: Requests的代码结构清晰,阅读源码有助于理解其实现原理</li>
<li><strong>实践项目</strong>: 开发一个完整的爬虫或API客户端项目</li>
</ol>
<h3 data-id="heading-28">学习资源</h3>
<ul>
<li><strong>官方文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.python-requests.org" target="_blank" title="https://docs.python-requests.org" ref="nofollow noopener noreferrer">docs.python-requests.org</a> (最权威、最完整的资源)</li>
<li><strong>GitHub仓库</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpsf%2Frequests" target="_blank" title="https://github.com/psf/requests" ref="nofollow noopener noreferrer">github.com/psf/request…</a> (源码、Issue、讨论)</li>
<li><strong>Stack Overflow</strong>: 搜索标签[python-requests]找到常见问题的解答</li>
<li><strong>社区博客</strong>: 许多开发者分享了Requests的实战经验和技巧</li>
</ul>
<p>Requests库的设计理念是"简单即美",但它的背后是HTTP协议的复杂性和网络编程的挑战。掌握了Requests,你就掌握了与网络世界沟通的基本技能。继续探索,你会发现HTTP请求的世界远比你想象的更加丰富和有趣。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch：ES|QL 支持 dense vector 搜索]]></title>    <link>https://juejin.cn/post/7603252259561783332</link>    <guid>https://juejin.cn/post/7603252259561783332</guid>    <pubDate>2026-02-06T03:37:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603252259561783332" data-draft-id="7603282168137498643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch：ES|QL 支持 dense vector 搜索"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2026-02-06T03:37:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch：ES|QL 支持 dense vector 搜索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:37:36.000Z" title="Fri Feb 06 2026 03:37:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fcarlos-delgado" title="https://www.elastic.co/search-labs/author/carlos-delgado" target="_blank" ref="nofollow noopener noreferrer">Carlos Delgado</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/973046f2739744829b510c37e824b6d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953856&amp;x-signature=LffbOsVLWQflbKxWV6Nyp4%2F2NZA%3D" alt="" loading="lazy"/></p>
<p>在 ES|QL 中对你的 dense_vector 数据进行向量搜索。</p>
<p>更多阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F152597172" title="https://elasticstack.blog.csdn.net/article/details/152597172" target="_blank" ref="nofollow noopener noreferrer">Elasticsearch：使用推理端点及语义搜索演示</a></p>
<p>动手体验 Elasticsearch：查看我们的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch-labs%3Ftab%3Dreadme-ov-file" title="https://github.com/elastic/elasticsearch-labs?tab=readme-ov-file" target="_blank" ref="nofollow noopener noreferrer">sample notebooks</a>，开始<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Fcloud-trial-overview" title="https://www.elastic.co/cloud/cloud-trial-overview" target="_blank" ref="nofollow noopener noreferrer">免费的 cloud trial</a>，或者在<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143747798" title="https://elasticstack.blog.csdn.net/article/details/143747798" target="_blank" ref="nofollow noopener noreferrer">本地机器</a>上试用 Elastic。</p>
<hr/>
<p>你现在可以使用 Elasticsearch Query Language (<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Fquery-filter%2Flanguages%2Fesql" title="https://www.elastic.co/docs/explore-analyze/query-filter/languages/esql" target="_blank" ref="nofollow noopener noreferrer">ES|QL</a>) 进行 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fintroduction-to-vector-search" title="https://www.elastic.co/search-labs/blog/introduction-to-vector-search" target="_blank" ref="nofollow noopener noreferrer">vector 搜索</a>！ES|QL 可以检索、过滤并评分 dense_vector 字段。使用 k-nearest neighbors (KNN) 查询进行快速、近似的最近邻搜索，适合大规模数据。使用 vector similarity 函数进行精确搜索和自定义评分。</p>
<p>在 ES|QL 中使用 KNN 比在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Fquery-filter%2Flanguages%2Fquerydsl" title="https://www.elastic.co/docs/explore-analyze/query-filter/languages/querydsl" target="_blank" ref="nofollow noopener noreferrer">Query DSL</a> 中更简单。prefilters 和每个 shard 要检索的结果数量会从 ES|QL 查询自动推断。</p>
<h2 data-id="heading-0">什么是 vector 搜索？</h2>
<p>现代搜索不再仅限于精确的 keyword 匹配。用户希望系统能理解含义，而不仅仅是文本。这就是向量 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F134748014" title="https://elasticstack.blog.csdn.net/article/details/134748014" target="_blank" ref="nofollow noopener noreferrer">embeddings</a> 和 Elasticsearch 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fdense-vector" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/dense-vector" target="_blank" ref="nofollow noopener noreferrer">dense_vector</a> 字段类型的用武之地。</p>
<p>在 Elasticsearch 中使用 vector 搜索最简单的方法是使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fsemantic-text" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/semantic-text" target="_blank" ref="nofollow noopener noreferrer">semantic_text 字段类型</a>。它允许你自动生成 text embeddings、执行语义搜索，并处理 chunking。然而，当以下情况出现时，你可能想使用 dense_vector：</p>
<ul>
<li>你已经在使用 dense_vector 字段。</li>
<li>你使用的是非文本数据，比如 images、sound 或 video。</li>
<li>你需要在向 Elasticsearch ingestion 之前单独生成 embeddings。</li>
<li>你需要执行自定义或高级评分。</li>
<li>你希望进行精确的 nearest neighbors 搜索。</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fdense-vector" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/dense-vector" target="_blank" ref="nofollow noopener noreferrer">dense_vector</a> 存储由 machine learning models 生成的数值 embeddings。这些 embeddings 捕捉语义相似性：含义相近的文档在高维空间中向量彼此接近。</p>
<p>使用 vectors，你可以构建：</p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Fsemantic-search" title="https://www.elastic.co/docs/solutions/search/semantic-search" target="_blank" ref="nofollow noopener noreferrer">语义文本搜索</a>，用于查找与某个问题相关的文档。</p>
</li>
<li>
<p>Retrieval-augmented generation (<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F134396254" title="https://elasticstack.blog.csdn.net/article/details/134396254" target="_blank" ref="nofollow noopener noreferrer">RAG</a>)。</p>
</li>
<li>
<p>推荐系统。</p>
</li>
</ul>
<p>ES|QL 为 Elasticsearch 带来了 query-piped 体验的强大功能。对 dense_vector 字段的一流支持意味着你现在可以在 ES|QL 中直接使用 vectors 检索、过滤、评分和搜索，同时处理文本和非文本数据。</p>
<p>本文将演示如何在 ES|QL 中使用 dense_vector 字段，从基本检索到近似和精确相似度搜索，以及如何将 vector 搜索作为 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F145697606" title="https://elasticstack.blog.csdn.net/article/details/145697606" target="_blank" ref="nofollow noopener noreferrer">hybrid search</a> 策略的一部分。</p>
<h2 data-id="heading-1">基础：检索 vector 数据</h2>
<p>假设你有一个 mapping 类似于：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  {
2.    <span class="hljs-string">"mappings"</span>: {
3.      <span class="hljs-string">"properties"</span>: {
4.        <span class="hljs-string">"title"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span> },
5.        <span class="hljs-string">"category"</span>: { <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span> },
6.        <span class="hljs-string">"content_vector"</span>: {
7.          <span class="hljs-string">"type"</span>: <span class="hljs-string">"dense_vector"</span>,
8.          <span class="hljs-string">"dims"</span>: 384,
9.          <span class="hljs-string">"similarity"</span>: <span class="hljs-string">"cosine"</span>
10.        }
11.      }
12.    }
13.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>你可以像检索其他列一样检索 vector 字段：</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  FROM documents
<span class="hljs-bullet">2.</span>  | KEEP title, content<span class="hljs-emphasis">_vector
3.  | LIMIT 5

`AI写代码
</span></code></pre>
<p>请记住，vectors 可能很大。用于探索和调试时，检索 vector 数据可能有用，但在生产环境中，除非确实必要，否则应避免返回完整的 vector 数据。</p>
<p>你可以使用熟悉的 ES|QL 构造来检查有多少行包含 vector 信息：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> documents
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> content_vector <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
<span class="hljs-number">3.</span>  <span class="hljs-operator">|</span> STATS non_null <span class="hljs-operator">=</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)

`AI写代码
</code></pre>
<h2 data-id="heading-2">近似搜索使用 KNN</h2>
<p>Vector search 意味着找到与给定 query vector 最相似的 vectors。</p>
<p>对于大型数据集，最常见的方法是近似最近邻（<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F138368674" title="https://elasticstack.blog.csdn.net/article/details/138368674" target="_blank" ref="nofollow noopener noreferrer">approximate nearest neighbor</a> - ANN）搜索。ANN 通过使用允许快速计算相似 vectors 的数据结构来寻找最相似的 vectors，但不能保证考虑到所有 vectors。</p>
<p>ES|QL 通过 KNN 函数提供近似搜索：</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  FROM documents MEDATADATA <span class="hljs-emphasis">_score
2.  | WHERE KNN(content_</span>vector, [0.12, -0.03, 0.98, ...])
<span class="hljs-bullet">3.</span>  | SORT <span class="hljs-emphasis">_score DESC
4.  | KEEP title, _</span>score
<span class="hljs-bullet">5.</span>  | LIMIT 10

`AI写代码
</code></pre>
<p>这个简单示例：</p>
<ul>
<li>在 content_vector 字段上搜索。</li>
<li>使用密集向量查询 [0.12, -0.03, 0.98, ...] 来搜索与其相似的向量。</li>
<li>按分数排序，使用 <code>KNN</code> 函数填充的 METADATA _score 属性。</li>
<li>仅保留 title 和 score，因为 content_vector 字段不需要返回，这样可以避免加载它的内容。</li>
<li>使用 LIMIT 检索前 10 个元素，这会自动将 KNN 函数的 k 设置为 10。</li>
</ul>
<p>KNN 函数可以通过以下选项进一步自定义：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> documents MEDATADATA _score
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> KNN(content_vector, [<span class="hljs-number">0.12</span>, <span class="hljs-number">-0.03</span>, <span class="hljs-number">0.98</span>, ...], {"k": <span class="hljs-number">20</span>, "min_candidates": <span class="hljs-number">100</span>, "rescore_oversample": <span class="hljs-number">4.0</span>})
<span class="hljs-number">3.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> KEEP title, _score
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>

`AI写代码
</code></pre>
<p>查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-knn" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-knn" target="_blank" ref="nofollow noopener noreferrer">KNN 函数</a>的命名参数，可以获得可用参数的完整说明。</p>
<h3 data-id="heading-3">将 KNN 与过滤器结合使用</h3>
<p>你可以缩小向量搜索的候选集合：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> documents METADATA _score
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> category <span class="hljs-operator">=</span><span class="hljs-operator">=</span> "tutorial"
<span class="hljs-number">3.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> KNN(content_vector, [<span class="hljs-number">0.12</span>, <span class="hljs-number">-0.03</span>, <span class="hljs-number">0.98</span>, ...])
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>
<span class="hljs-number">6.</span>  <span class="hljs-operator">|</span> KEEP title, category, _score

`AI写代码
</code></pre>
<p>当然，你可以使用任何其他 WHERE 子句来过滤结果，或者将 KNN 作为过滤表达式的一部分：</p>
<pre><code class="hljs language-scss" lang="scss">`

<span class="hljs-number">1</span>.  FROM documents METADATA _score
<span class="hljs-number">2</span>.  | WHERE published_date &gt; <span class="hljs-built_in">NOW</span>() - <span class="hljs-number">1</span> hour AND <span class="hljs-built_in">LENGTH</span>(category) &gt; <span class="hljs-number">10</span> AND <span class="hljs-built_in">KNN</span>(content_vector, [<span class="hljs-number">0.12</span>, -<span class="hljs-number">0.03</span>, <span class="hljs-number">0.98</span>, ...])

`AI写代码
</code></pre>
<h3 data-id="heading-4">KNN 使用简单</h3>
<p>在 ES|QL 中使用 KNN 更简单。你不需要显式地为查询指定 prefilters 或 k。</p>
<p>Prefilters 用于确保 KNN 查询返回预期数量的结果。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fquery-dsl%2Fquery-dsl-knn-query%23knn-query-filtering" title="https://www.elastic.co/docs/reference/query-languages/query-dsl/query-dsl-knn-query#knn-query-filtering" target="_blank" ref="nofollow noopener noreferrer">Prefilters</a> 会直接应用于 KNN 搜索，而不是在查询之后应用。</p>
<p>请记住，KNN 会返回请求的 top k 结果。如果在 KNN 查询之后应用过滤器，查询返回的一些结果可能会被过滤掉。如果发生这种情况，我们将检索到的结果数量少于预期。</p>
<p>Query DSL 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fquery-dsl%2Fquery-dsl-knn-query" title="https://www.elastic.co/docs/reference/query-languages/query-dsl/query-dsl-knn-query" target="_blank" ref="nofollow noopener noreferrer">knn 查询</a>包含一个用于指定 prefilters 的部分：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  POST my-image-index/_search
2.  {
3.    <span class="hljs-string">"query"</span> : {
4.      <span class="hljs-string">"knn"</span>: {
5.        <span class="hljs-string">"field"</span>: <span class="hljs-string">"content_vector"</span>,
6.        <span class="hljs-string">"query_vector"</span>: [0.12, -0.03, 0.98, ...],
7.        <span class="hljs-string">"filter"</span> : {
8.          <span class="hljs-string">"term"</span> : { <span class="hljs-string">"category"</span> : <span class="hljs-string">"tutorial"</span> }
9.        }
10.      }
11.    }
12.  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>在 ES|QL 中使用 KNN 时，你不需要关心 prefilters。所有过滤器都会作为 KNN 函数的 prefilters 应用，所以不需要将它们作为特定选项或命令指定；只需使用 <code>WHERE</code>，让 ES|QL 自动处理即可！</p>
<p>KNN 还允许指定每个 shard 检索的结果数量，也就是 k 参数。类似于 Query DSL，k 默认等于查询中指定的 LIMIT。</p>
<h2 data-id="heading-5">精确搜索使用 vector similarity 函数</h2>
<p>KNN 的设计目标是快速，这使它非常适合大规模数据集（数十万到数百万个向量）和对延迟敏感的应用。代价是结果是近似的，但通常非常准确。</p>
<p>有时你希望进行精确相似度计算，而不是近似搜索，例如：</p>
<ul>
<li>当你的数据集较小时。</li>
<li>当查询中使用的过滤器非常严格，只选择数据集的小子集时。</li>
</ul>
<p>ES|QL 提供了以下 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions" target="_blank" ref="nofollow noopener noreferrer">vector similarity 函数</a>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-v_cosine" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-v_cosine" target="_blank" ref="nofollow noopener noreferrer">V_COSINE</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-v_dot_product" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-v_dot_product" target="_blank" ref="nofollow noopener noreferrer">V_DOT_PRODUCT</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-v_hamming" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-v_hamming" target="_blank" ref="nofollow noopener noreferrer">V_HAMMING</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-v_l1_norm" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-v_l1_norm" target="_blank" ref="nofollow noopener noreferrer">V_L1_NORM</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-v_l2_norm" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-v_l2_norm" target="_blank" ref="nofollow noopener noreferrer">V_L2_NORM</a></li>
</ul>
<p>使用这些函数，你可以计算查询向量与查询检索到的所有向量的相似度。</p>
<p>下面的查询使用与上面 KNN 示例相同的 mapping，但使用余弦相似度进行精确搜索：</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  FROM documents
<span class="hljs-bullet">2.</span>  | EVAL similarity = V<span class="hljs-emphasis">_COSINE(content_</span>vector, [0.12, -0.03, 0.98, ...])
<span class="hljs-bullet">3.</span>  | SORT similarity DESC
<span class="hljs-bullet">4.</span>  | KEEP title, similarity
<span class="hljs-bullet">5.</span>  | LIMIT 10

`AI写代码
</code></pre>
<p>这个查询：</p>
<ul>
<li>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-v_cosine" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-v_cosine" target="_blank" ref="nofollow noopener noreferrer">V_COSINE</a> 向量相似度函数计算相似度。</li>
<li>根据计算出的相似度进行排序。</li>
<li>保留前 10 个最相似的结果。</li>
</ul>
<h2 data-id="heading-6">语义搜索</h2>
<p>进行语义搜索时，你会尝试将文本查询与向量匹配。当然，你可以先计算 embeddings 来获取查询向量，然后将查询向量直接提供给向量搜索。</p>
<p>但更简单的方法是让 Elasticsearch 使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-text_embedding" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-text_embedding" target="_blank" ref="nofollow noopener noreferrer">TEXT_EMBEDDING</a> 函数为你计算 embeddings：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> documents METADATA _score
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> KNN(content_vector, TEXT_EMBEDDING("my semantic query", inference_id)
<span class="hljs-number">3.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> KEEP title, _score

`AI写代码
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-text_embedding" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-text_embedding" target="_blank" ref="nofollow noopener noreferrer">TEXT_EMBEDDING</a> 使用已经存在的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Fsemantic-search%2Fsemantic-search-inference" title="https://www.elastic.co/docs/solutions/search/semantic-search/semantic-search-inference" target="_blank" ref="nofollow noopener noreferrer">inference endpoint</a> 自动计算 embeddings 并在你的查询中使用它们。</p>
<h2 data-id="heading-7">混合搜索</h2>
<p>大多数搜索不仅依赖 vector 数据；它们还需要结合 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F134111585" title="https://elasticstack.blog.csdn.net/article/details/134111585" target="_blank" ref="nofollow noopener noreferrer">lexical search</a>，这样才能兼顾两者优势：</p>
<ul>
<li>Lexical 信息适合精确匹配单词和同义词，并提供用户正在寻找特定词的强信号。</li>
<li>Vectors 捕捉含义和意图，使用相似短语或不在词汇上相关的术语。</li>
</ul>
<p>结合 vector search 和 lexical search 最好使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffork" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fork" target="_blank" ref="nofollow noopener noreferrer">FORK</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffuse" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fuse" target="_blank" ref="nofollow noopener noreferrer">FUSE</a>：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> documents METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK
<span class="hljs-number">3.</span>  (<span class="hljs-keyword">WHERE</span> KNN(content_vector, TEXT_EMBEDDING("my query")) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>)
<span class="hljs-number">4.</span>  (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(title, "my query") <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>)
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> FUSE
<span class="hljs-number">6.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">7.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>

`AI写代码
</code></pre>
<p>上面的查询：</p>
<ul>
<li>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffork" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fork" target="_blank" ref="nofollow noopener noreferrer">FORK</a> 执行两个查询：
<ul>
<li>对 <code>dense_vector</code> 字段进行 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fdense-vector-functions%23esql-knn" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/dense-vector-functions#esql-knn" target="_blank" ref="nofollow noopener noreferrer">KNN</a> 查询。</li>
<li>对文本字段进行 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Ffunctions-operators%2Fsearch-functions%23esql-match" title="https://www.elastic.co/docs/reference/query-languages/esql/functions-operators/search-functions#esql-match" target="_blank" ref="nofollow noopener noreferrer">MATCH</a> 查询。</li>
<li>两个查询都按分数排序，并各自返回前 10 个结果。</li>
</ul>
</li>
<li>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffuse" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fuse" target="_blank" ref="nofollow noopener noreferrer">FUSE</a> 将查询结果混合在一起，默认使用倒数排序融合 (<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F151765742" title="https://elasticstack.blog.csdn.net/article/details/151765742" target="_blank" ref="nofollow noopener noreferrer">RRF</a>)。</li>
</ul>
<p>这允许你完全控制想执行的查询、每个查询要获取的结果数量，以及如何组合结果。</p>
<p>查看我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F156750993" title="https://elasticstack.blog.csdn.net/article/details/156750993" target="_blank" ref="nofollow noopener noreferrer">多阶段检索</a>博客文章，了解现代搜索的工作原理以及通过 ES|QL 实现的简便方式。</p>
<h2 data-id="heading-8">自定义评分</h2>
<p>使用 ES|QL 计算自定义评分很容易！只需使用 _score 元数据字段来计算你的自定义评分：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> documents METADATA _score
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> KNN(content_vector, TEXT_EMBEDDING("my semantic query", inference_id)
<span class="hljs-number">3.</span>  <span class="hljs-operator">|</span> EVAL my_custom_score <span class="hljs-operator">=</span> _score <span class="hljs-operator">*</span> <span class="hljs-number">1.5</span> <span class="hljs-operator">+</span> ...
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> SORT my_custom_score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>

`AI写代码
</code></pre>
<p>如果你使用的是精确搜索，你已经有了向量相似度的评估，可以对其进行微调：</p>
<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  FROM documents
<span class="hljs-bullet">2.</span>  | EVAL similarity = V<span class="hljs-emphasis">_COSINE(content_</span>vector, [0.12, -0.03, 0.98, ...])
<span class="hljs-bullet">3.</span>  | EVAL my<span class="hljs-emphasis">_custom_</span>score = similarity * 1.5 + ...
<span class="hljs-bullet">4.</span>  | SORT my<span class="hljs-emphasis">_custom_</span>score DESC
<span class="hljs-bullet">5.</span>  | LIMIT 10

`AI写代码
</code></pre>
<p>与 Query DSL 的 script_score 相比，这种方法更简单、更迭代，并且完美适合 ES|QL 的执行流程。</p>
<h2 data-id="heading-9">使用 query 参数</h2>
<p>在使用查询向量时，你可以像之前的示例那样直接在查询中指定它。但你可能已经注意到，我们使用了省略号（...）来表示还有更多数据。</p>
<p>Dense vectors 通常是高维的；它们可能有数百或数千个维度，因此在查询中直接复制粘贴查询向量会让理解或推理变得困难，因为你会在屏幕上看到成千上万的数值。</p>
<p>记住，你可以使用 ES|QL query 参数来为查询提供参数：</p>
<pre><code class="hljs language-python" lang="python">`

<span class="hljs-number">1.</span>  POST _query
<span class="hljs-number">2.</span>  {
<span class="hljs-number">3.</span>    <span class="hljs-string">"query"</span>: <span class="hljs-string">"""
4.  FROM documents
5.  | WHERE KNN(content_vector, ?query_vector)
6.  | SORT _score DESC
7.  | KEEP title, _score
8.  | LIMIT 10
9.     """</span>,
<span class="hljs-number">10.</span>   <span class="hljs-string">"params"</span>: [{<span class="hljs-string">"query_vector"</span> : [<span class="hljs-number">0.12</span>, -<span class="hljs-number">0.03</span>, <span class="hljs-number">0.98</span>, ...]}]
<span class="hljs-number">11.</span>  }

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<p>这有助于将查询逻辑与参数分离，让你可以专注于查询逻辑，而不是被具体参数束缚。</p>
<p>对向量使用 query 参数也更高效，因为这样通过 request parser 解析向量比通过 ES|QL parser 更快。</p>
<h2 data-id="heading-10">结论</h2>
<p>ES|QL 不仅支持 vector search，还将其自然地融入数据查询方式中。它允许你用单一强大的语法处理文本、向量及二者之间的一切，包括：</p>
<ul>
<li>Vector search，包括 approximate 和 exact。</li>
<li>Semantic search，使用文本对向量数据进行搜索。</li>
<li>Hybrid search，结合文本搜索和向量搜索的最佳结果。</li>
<li>Custom vector scoring，使用 EVAL 和 ES|QL 构造函数。</li>
</ul>
<p>ES|QL 中的 vector search 比 Query DSL 更简单，通过推断 prefilters 和参数，并与 ES|QL 提供的丰富表达式无缝集成。</p>
<p>将 KNN 定义为<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F156750993" title="https://elasticstack.blog.csdn.net/article/details/156750993" target="_blank" ref="nofollow noopener noreferrer">多阶段检索</a>管道的一部分只是查询的一环；你可以继续使用 filters，与其他文本函数结合进行 hybrid search，并在向量结果上应用 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143352429" title="https://elasticstack.blog.csdn.net/article/details/143352429" target="_blank" ref="nofollow noopener noreferrer">reranking</a> 或 query completion。</p>
<p>我们将继续增加向量函数，用于 dense vectors 的向量运算和聚合，让你充分利用 ES|QL 的全部功能操作向量数据。</p>
<p>祝你 (vector) 搜索愉快！</p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fdense-vector-search-elasticsearch-query-language" title="https://www.elastic.co/search-labs/blog/dense-vector-search-elasticsearch-query-language" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/search-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[能本地跑，复杂文档识别，0.9B小模型，GLM-OCR开源即巅峰（附源码）]]></title>    <link>https://juejin.cn/post/7603267434502635535</link>    <guid>https://juejin.cn/post/7603267434502635535</guid>    <pubDate>2026-02-06T03:33:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603267434502635535" data-draft-id="7603283380554186786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="能本地跑，复杂文档识别，0.9B小模型，GLM-OCR开源即巅峰（附源码）"/> <meta itemprop="keywords" content="后端,ChatGLM (智谱),开源"/> <meta itemprop="datePublished" content="2026-02-06T03:33:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            能本地跑，复杂文档识别，0.9B小模型，GLM-OCR开源即巅峰（附源码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:33:50.000Z" title="Fri Feb 06 2026 03:33:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小悟。</p>
<p>直接说正事，智谱把自家的新一代OCR模型 GLM-OCR 直接开源了，而且一上来就是“小身材、大能量”的路线。</p>
<p>参数只有0.9B，却在权威的 OmniDocBench V1.5 榜单上拿了 94.6 分，在文本、公式、表格、信息抽取这几项里都冲到了 SOTA。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfdaa9a511cb4ddda8ad8ce807b4ed35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=gIOpVtLKNaF1kFti5%2B5Z5gdieWM%3D" alt="图片" loading="lazy"/></p>
<p><strong>🤯 痛点：传统OCR的“老大难”</strong></p>
<p>用过传统OCR工具的朋友，大概率都遇到过这些场景：</p>
<p>扫描版PDF：稍微模糊一点，或者表格跨页，出来的结果就是一团乱码，不是缺行少列，就是数字对不上。</p>
<p>手写体：学生的作业、医生的处方，识别率直接“跳水”，最后还是得靠人肉校对。</p>
<p>复杂表格：合并单元格、多层表头，识别出来就是一维文本，想还原成可用的表格，得手动调整半天。</p>
<p>公式截图：好不容易拍清楚，OCR 出来的却是一串看不懂的符号，想转成 LaTeX 更是奢望。</p>
<p>印章与文本重叠：盖章文件要提取信息，常常被印章盖住关键字段，传统方法很难把两者干净地分开。</p>
<p>多语言混排：中英文、数字、符号挤在一起，识别结果经常出现“串台”的尴尬情况。</p>
<p>很多方案为了效果，模型动辄几个B、几十B的参数，部署起来对显卡和内存要求很高，普通开发者和小团队只能望而却步。</p>
<p>成本也是个现实问题，按量计费、并发限制，处理海量历史文档时，账单会让人心头一紧。</p>
<p>所以，当我看到 GLM-OCR 的参数和定位时，心里想的是：这模型，能顶。</p>
<p><strong>🧠 GLM-OCR：麻雀虽小，五脏俱全</strong></p>
<p>GLM-OCR 是智谱基于 GLM-V 系列“视觉编码器 + 语言解码器”思路，专门为文档理解打造的一款多模态OCR模型。它的核心特点可以概括为：小、准、全、快、便宜。</p>
<p>小：模型总参数约 0.9B（其中视觉编码器约 400M，语言解码器约 0.5B），体积和显存占用都控制得很好，普通显卡甚至 CPU 环境都有机会跑起来。</p>
<p>准：在 OmniDocBench V1.5 综合榜单上拿到 94.6 分，在文本、公式、表格、信息抽取等多个子任务中都达到了 SOTA 或接近 SOTA 的水平。</p>
<p>全：它不只是“识字”，而是能理解整个文档的版式。官方重点优化了六大真实业务场景：代码文档、复杂表格、手写体、多语言、印章识别、票据提取。</p>
<p>快：官方测试数据显示，单副本单并发下，处理 PDF 的吞吐量约 1.86 页/秒，处理图片约 0.67 张/秒，速度在同类小参数模型里很有竞争力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a84b85d8e75f44859878c4bdcbe58fa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=vA58lyCIfOOn5%2FlFa3Y8YFaTBAQ%3D" alt="图片" loading="lazy"/></p>
<p>便宜：官方 API 定价为 0.2 元/百万 Tokens，1 块钱大概能处理 2000 张 A4 扫描图或 200 份 10 页的 PDF，成本约为传统 OCR 方案的十分之一。</p>
<p>从技术架构上看，GLM-OCR 采用了“视觉编码器 → 跨模态连接层 → 语言解码器”的三级结构。</p>
<p>并引入了多 Tokens 预测损失（MTP）和全任务强化学习等训练策略，让模型在有限参数下也能学到更强的上下文理解和泛化能力。</p>
<p><strong>🚀 核心功能：不止于“识字”</strong></p>
<p>GLM-OCR 的功能覆盖了从简单识别到复杂理解的多个层次，实用性很强。</p>
<p>通用文本识别</p>
<p>支持照片、截图、扫描件、PDF 等多种输入，能较好地应对手写体、印章、代码截图等特殊内容。</p>
<p>对于学生、科研人员、程序员等需要数字化笔记或文档的人来说，非常友好。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba853d4c2336462ea8d853d6a1351f88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=bFdbofQhcahjUOm%2F0OXwF7HXQOU%3D" alt="图片" loading="lazy"/></p>
<p>复杂表格解析</p>
<p>能理解合并单元格、多层表头、斜线表头等复杂结构，并直接输出 HTML 表格代码，无需二次制表。</p>
<p>对于财务、运营、数据分析等经常处理报表的岗位，这能节省大量时间。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c03943f9d33440daab5877444e54f174~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=MRzgbrR8vJYtiVN6WBELQOtZhG8%3D" alt="图片" loading="lazy"/></p>
<p>手写公式识别</p>
<p>能将手写或打印的公式截图准确地转换成 LaTeX 格式，保留上下标、分式、根号等复杂结构。</p>
<p>对于理工科师生和科研人员，这简直是“解放生产力”的神器。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beb0d7ba1e304e8b9e0cd9d7555dd8e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=NHtu9UJ0WmFkxerJowZ5ohmGza0%3D" alt="图片" loading="lazy"/></p>
<p>信息结构化提取</p>
<p>支持通过 JSON Schema 模板，从发票、证件、报关单等文档中自动提取关键字段并输出结构化 JSON 数据。</p>
<p>这对于需要对接业务系统、构建自动化流程的开发者来说，价值巨大。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9055a4b0fb184412beec7af0274e8b84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=3EFp4fGJFl7noNoS2DzxmX37R6k%3D" alt="图片" loading="lazy"/></p>
<p>批量处理与 RAG 支持</p>
<p>支持大批量文档解析，其高精度和规整的输出格式，非常适合作为检索增强生成（RAG）系统的前置文档解析模块，为上层大模型提供高质量的“燃料”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d732cea09fdb497ea8bbb441c4f4fcae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=1E0ffiqAko%2FbYr7ZEEs1PXRoJbE%3D" alt="图片" loading="lazy"/></p>
<p><strong>💻 使用体验：本地与云端部署</strong></p>
<p>GLM-OCR 提供了多种灵活的接入方式，无论是开发者还是普通用户，都能找到适合自己的玩法。</p>
<p>本地/私有化部署：支持 vLLM、SGLang、Ollama多种主流框架。对于注重数据隐私或有本地化部署需求的用户，非常友好。</p>
<p>云端 API 调用：智谱开放平台提供了标准的 API 接口，按量计费，接入成本和使用门槛都很低。</p>
<p>本地安装</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Install from source</span>
git <span class="hljs-built_in">clone</span> https://github.com/zai-org/glm-ocr.git
<span class="hljs-built_in">cd</span> glm-ocr
uv venv --python 3.12 --seed &amp;&amp; <span class="hljs-built_in">source</span> .venv/bin/activate
uv pip install -e .
<span class="hljs-comment"># Install transformers from source</span>
uv pip install git+https://github.com/huggingface/transformers.git


<span class="hljs-comment"># Parse a single image</span>
glmocr parse examples/source/code.png


<span class="hljs-comment"># Parse a directory</span>
glmocr parse examples/source/


<span class="hljs-comment"># Set output directory</span>
glmocr parse examples/source/code.png --output ./results/


<span class="hljs-comment"># Use a custom config</span>
glmocr parse examples/source/code.png --config my_config.yaml


<span class="hljs-comment"># Enable debug logging with profiling</span>
glmocr parse examples/source/code.png --log-level DEBUG


from glmocr import GlmOcr, parse


<span class="hljs-comment"># Simple function</span>
result = parse(<span class="hljs-string">"image.png"</span>)
result = parse([<span class="hljs-string">"img1.png"</span>, <span class="hljs-string">"img2.jpg"</span>])
result = parse(<span class="hljs-string">"https://example.com/image.png"</span>)
result.save(output_dir=<span class="hljs-string">"./results"</span>)


<span class="hljs-comment"># Note: a list is treated as pages of a single document.</span>


<span class="hljs-comment"># Class-based API</span>
with GlmOcr() as parser:
    result = parser.parse(<span class="hljs-string">"image.png"</span>)
    <span class="hljs-built_in">print</span>(result.json_result)
    result.save()
</code></pre>
<p>开源社区</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">1</span>.开源地址
<span class="hljs-title class_">Github</span>：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/zai</span>-org/<span class="hljs-variable constant_">GLM</span>-<span class="hljs-variable constant_">OCR</span>
<span class="hljs-title class_">Hugging</span> <span class="hljs-title class_">Face</span>：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/huggingface.co/zai</span>-org/<span class="hljs-variable constant_">GLM</span>-<span class="hljs-variable constant_">OCR</span>

<span class="hljs-number">2</span>.模型<span class="hljs-variable constant_">API</span>
智谱开放平台：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/docs.bigmodel.cn/cn</span><span class="hljs-regexp">/guide/models</span><span class="hljs-regexp">/vlm/glm</span>-ocr
特惠尝鲜礼包上线，<span class="hljs-number">2.9</span>元享<span class="hljs-number">5000</span>万<span class="hljs-title class_">Tokens</span>：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/bigmodel.cn/special</span>_area
Z.ai：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/docs.z.ai/guides</span><span class="hljs-regexp">/vlm/glm</span>-ocr

<span class="hljs-number">3</span>.在线体验
Z.ai：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/ocr.z.ai
</span></code></pre>
<p><strong>👍 为什么推荐它？</strong></p>
<p>结合我自己的感受，推荐 GLM-OCR 的理由主要有以下几点：</p>
<p>开源免费，自主可控：基于 Apache-2.0 license 协议开源，个人和企业都可以免费使用、二次开发和商用。</p>
<p>性能强劲，性价比高：0.9B 的小参数，却在多个权威榜单上取得了顶尖成绩，真正做到了“小而美”。</p>
<p>同时，无论是本地部署的成本还是云端 API 的定价，都极具竞争力。</p>
<p>场景覆盖广，实用性强：从日常办公到科研学习，从简单识别到复杂结构化提取，GLM-OCR 都能提供出色的支持，具有很强的通用性。</p>
<p>工程友好，易于集成：提供了完整的 SDK 和推理工具链，支持多种主流部署方式，无论是开发者还是普通用户，都能快速上手。</p>
<p>国产模型，本土化优势：对于中文用户来说，GLM-OCR 在处理中文文档、票据等本土化场景时，具有天然的优势。</p>
<p><strong>🎯 最后</strong></p>
<p>GLM-OCR 的出现，为 OCR 领域带来了一股新的活力。</p>
<p>“小身材”撬动了“高精度”，用“开源”降低了技术门槛，让更多人能够享受到 AI 带来的便利。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73acc37c5084496185123433e92a42a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953629&amp;x-signature=D1HEhIE1M7Izu%2FUfu8b2a66oX9E%3D" alt="图片" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot + AWS Lambda / 阿里云 FC：事件驱动架构下，轻量函数处理异步任务]]></title>    <link>https://juejin.cn/post/7603282168137891859</link>    <guid>https://juejin.cn/post/7603282168137891859</guid>    <pubDate>2026-02-06T05:29:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603282168137891859" data-draft-id="7600333405979361321" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot + AWS Lambda / 阿里云 FC：事件驱动架构下，轻量函数处理异步任务"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T05:29:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我爱娃哈哈"/> <meta itemprop="url" content="https://juejin.cn/user/1398234522335383"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot + AWS Lambda / 阿里云 FC：事件驱动架构下，轻量函数处理异步任务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234522335383/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我爱娃哈哈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T05:29:05.000Z" title="Fri Feb 06 2026 05:29:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">传统异步任务的挑战</h2>
<p>在我们的日常开发工作中，经常会遇到这样的场景：</p>
<ul>
<li>用户上传文件后需要异步处理，但长时间占用应用服务器资源</li>
<li>订单状态变更需要通知多个下游系统，同步调用影响主流程性能</li>
<li>日志分析、数据统计等批量任务需要在后台运行</li>
<li>图片压缩、视频转码等计算密集型任务消耗大量CPU</li>
</ul>
<p>传统的异步任务处理方式要么需要维护额外的服务器资源，要么架构复杂度高。今天我们就来聊聊如何用Serverless函数计算优雅地解决这些问题。
<a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.jiangyi.space%2Farticles%2F2026%2F01%2F30%2F1769664610418.html" target="_blank" title="http://www.jiangyi.space/articles/2026/01/30/1769664610418.html" ref="nofollow noopener noreferrer">阅读原文</a></p>
<h2 data-id="heading-1">Serverless函数计算的优势</h2>
<p>相比传统的异步任务处理方案，Serverless有以下显著优势：</p>
<ul>
<li><strong>按需付费</strong>：只对实际执行时间付费，闲置时不收费</li>
<li><strong>弹性伸缩</strong>：根据负载自动扩缩容，无需人工干预</li>
<li><strong>免运维</strong>：无需关心服务器运维，专注业务逻辑</li>
<li><strong>快速部署</strong>：秒级部署，快速响应业务需求</li>
</ul>
<h2 data-id="heading-2">核心实现思路</h2>
<h3 data-id="heading-3">1. 事件驱动架构</h3>
<p>Serverless函数天然适合事件驱动架构：</p>
<ul>
<li><strong>事件源</strong>：消息队列、数据库变更、API调用等</li>
<li><strong>事件处理</strong>：函数接收事件并处理</li>
<li><strong>事件响应</strong>：处理结果可以触发后续事件</li>
</ul>
<h3 data-id="heading-4">2. SpringBoot与Serverless集成</h3>
<p>我们可以通过多种方式将SpringBoot应用与Serverless函数集成：</p>
<ul>
<li><strong>消息队列桥接</strong>：SpringBoot应用发送消息到队列，函数消费</li>
<li><strong>HTTP回调</strong>：函数处理完成后回调SpringBoot接口</li>
<li><strong>数据库状态同步</strong>：通过数据库状态变更触发函数执行</li>
</ul>
<h2 data-id="heading-5">实践方案详解</h2>
<h3 data-id="heading-6">1. AWS Lambda集成</h3>
<h4 data-id="heading-7">函数编写</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskFunction</span> {
    
    <span class="hljs-keyword">public</span> APIGatewayProxyResponseEvent <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(
            APIGatewayProxyRequestEvent input, Context context)</span> {
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 解析事件数据</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">eventBody</span> <span class="hljs-operator">=</span> input.getBody();
            <span class="hljs-type">AsyncTaskEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> JsonUtils.fromJson(eventBody, AsyncTaskEvent.class);
            
            <span class="hljs-comment">// 执行具体任务</span>
            <span class="hljs-keyword">switch</span> (event.getTaskType()) {
                <span class="hljs-keyword">case</span> <span class="hljs-string">"FILE_PROCESSING"</span>:
                    processFile(event);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"IMAGE_COMPRESSION"</span>:
                    compressImage(event);
                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">case</span> <span class="hljs-string">"DATA_ANALYSIS"</span>:
                    analyzeData(event);
                    <span class="hljs-keyword">break</span>;
            }
            
            <span class="hljs-comment">// 返回成功响应</span>
            <span class="hljs-keyword">return</span> createSuccessResponse(<span class="hljs-string">"Task completed"</span>);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            context.getLogger().log(<span class="hljs-string">"Error processing task: "</span> + e.getMessage());
            <span class="hljs-keyword">return</span> createErrorResponse(e.getMessage());
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processFile</span><span class="hljs-params">(AsyncTaskEvent event)</span> {
        <span class="hljs-comment">// 文件处理逻辑</span>
        <span class="hljs-type">S3Client</span> <span class="hljs-variable">s3Client</span> <span class="hljs-operator">=</span> S3Client.create();
        <span class="hljs-comment">// ... 具体处理逻辑</span>
    }
}
</code></pre>
<h4 data-id="heading-8">部署配置</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># serverless.yml</span>
<span class="hljs-attr">service:</span> <span class="hljs-string">async-task-service</span>

<span class="hljs-attr">provider:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">aws</span>
  <span class="hljs-attr">runtime:</span> <span class="hljs-string">java11</span>
  <span class="hljs-attr">region:</span> <span class="hljs-string">us-east-1</span>

<span class="hljs-attr">functions:</span>
  <span class="hljs-attr">fileProcessor:</span>
    <span class="hljs-attr">handler:</span> <span class="hljs-string">com.example.AsyncTaskFunction::handleRequest</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-number">300</span>
    <span class="hljs-attr">memorySize:</span> <span class="hljs-number">1024</span>
    <span class="hljs-attr">events:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">sqs:</span>
          <span class="hljs-attr">arn:</span> <span class="hljs-type">!GetAtt</span> <span class="hljs-string">TaskQueue.Arn</span>
</code></pre>
<h3 data-id="heading-9">2. 阿里云函数计算集成</h3>
<h4 data-id="heading-10">函数实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FCTaskProcessor</span> {
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(InputStream input, OutputStream output, Context context)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 读取输入流</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">eventJson</span> <span class="hljs-operator">=</span> StreamUtils.copyToString(input, StandardCharsets.UTF_8);
            <span class="hljs-type">AsyncTaskEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> JsonUtils.fromJson(eventJson, AsyncTaskEvent.class);
            
            <span class="hljs-comment">// 根据任务类型执行不同逻辑</span>
            <span class="hljs-type">TaskResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> executeTask(event);
            
            <span class="hljs-comment">// 写入输出流</span>
            <span class="hljs-keyword">return</span> JsonUtils.toJson(result);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            context.getLogger().info(<span class="hljs-string">"Task execution failed: "</span> + e.getMessage());
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        }
    }
    
    <span class="hljs-keyword">private</span> TaskResult <span class="hljs-title function_">executeTask</span><span class="hljs-params">(AsyncTaskEvent event)</span> {
        <span class="hljs-keyword">switch</span> (event.getTaskType()) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"NOTIFICATION"</span>:
                <span class="hljs-keyword">return</span> sendNotification(event);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"REPORT_GENERATION"</span>:
                <span class="hljs-keyword">return</span> generateReport(event);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Unknown task type: "</span> + event.getTaskType());
        }
    }
}
</code></pre>
<h3 data-id="heading-11">3. SpringBoot事件发布</h3>
<p>在SpringBoot应用中发布事件到函数计算：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventPublisherService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SqsTemplate sqsTemplate;  <span class="hljs-comment">// AWS SQS</span>
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;  <span class="hljs-comment">// 阿里云RocketMQ</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishAsyncTask</span><span class="hljs-params">(AsyncTaskEvent event)</span> {
        <span class="hljs-comment">// 发布到消息队列，由函数消费</span>
        <span class="hljs-keyword">if</span> (isUsingAWS()) {
            sqsTemplate.convertAndSend(<span class="hljs-string">"async-task-queue"</span>, event);
        } <span class="hljs-keyword">else</span> {
            rocketMQTemplate.convertAndSend(<span class="hljs-string">"async-task-topic"</span>, event);
        }
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">triggerLambdaDirectly</span><span class="hljs-params">(AsyncTaskEvent event)</span> {
        <span class="hljs-comment">// 直接调用Lambda函数</span>
        <span class="hljs-type">InvokeRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> InvokeRequest.builder()
                .functionName(<span class="hljs-string">"async-task-function"</span>)
                .payload(JsonUtils.toJson(event).getBytes())
                .build();
                
        lambdaClient.invoke(request);
    }
}
</code></pre>
<h3 data-id="heading-12">4. 任务状态管理</h3>
<p>为了更好地管理异步任务状态，我们可以结合数据库：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "async_task")</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTask</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-keyword">private</span> String taskId;
    <span class="hljs-keyword">private</span> String eventType;
    <span class="hljs-keyword">private</span> String status;  <span class="hljs-comment">// PENDING, PROCESSING, SUCCESS, FAILED</span>
    <span class="hljs-keyword">private</span> String result;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskService</span> {
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createAndPublishTask</span><span class="hljs-params">(AsyncTaskEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        
        <span class="hljs-comment">// 保存任务记录</span>
        <span class="hljs-type">AsyncTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncTask</span>();
        task.setTaskId(taskId);
        task.setEventType(event.getType());
        task.setStatus(<span class="hljs-string">"PENDING"</span>);
        task.setCreateTime(LocalDateTime.now());
        asyncTaskRepository.save(task);
        
        <span class="hljs-comment">// 发布到函数计算</span>
        eventPublisherService.publishAsyncTask(event);
        
        <span class="hljs-keyword">return</span> taskId;
    }
    
    <span class="hljs-keyword">public</span> AsyncTask <span class="hljs-title function_">getTaskStatus</span><span class="hljs-params">(String taskId)</span> {
        <span class="hljs-keyword">return</span> asyncTaskRepository.findById(taskId).orElse(<span class="hljs-literal">null</span>);
    }
}
</code></pre>
<h2 data-id="heading-13">高级特性实现</h2>
<h3 data-id="heading-14">1. 函数冷启动优化</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedFunction</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> 
        Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 预热逻辑</span>
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmup</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 预加载常用资源</span>
        initializeResources();
    }
    
    <span class="hljs-keyword">public</span> APIGatewayProxyResponseEvent <span class="hljs-title function_">handleRequest</span><span class="hljs-params">(...)</span> {
        <span class="hljs-comment">// 使用线程池处理任务，减少冷启动影响</span>
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">return</span> processTask();
        }, executor).join();
    }
}
</code></pre>
<h3 data-id="heading-15">2. 错误重试机制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryableTaskProcessor</span> {
    
    <span class="hljs-meta">@Retryable(value = {Exception.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000))</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processTask</span><span class="hljs-params">(AsyncTaskEvent event)</span> {
        <span class="hljs-comment">// 任务处理逻辑</span>
        executeTask(event);
    }
    
    <span class="hljs-meta">@Recover</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recover</span><span class="hljs-params">(Exception ex, AsyncTaskEvent event)</span> {
        <span class="hljs-comment">// 重试失败后的处理</span>
        log.error(<span class="hljs-string">"Task failed after retries: {}"</span>, event.getTaskId(), ex);
        updateTaskStatus(event.getTaskId(), <span class="hljs-string">"FAILED"</span>);
    }
}
</code></pre>
<h3 data-id="heading-16">3. 监控与告警</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FunctionMetricsCollector</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MeterRegistry meterRegistry;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordTaskExecution</span><span class="hljs-params">(String taskType, <span class="hljs-type">long</span> duration, <span class="hljs-type">boolean</span> success)</span> {
        Timer.<span class="hljs-type">Sample</span> <span class="hljs-variable">sample</span> <span class="hljs-operator">=</span> Timer.start(meterRegistry);
        
        <span class="hljs-type">Tags</span> <span class="hljs-variable">tags</span> <span class="hljs-operator">=</span> Tags.of(<span class="hljs-string">"task_type"</span>, taskType, <span class="hljs-string">"success"</span>, String.valueOf(success));
        
        sample.stop(Timer.builder(<span class="hljs-string">"function.task.duration"</span>)
                 .tags(tags)
                 .register(meterRegistry));
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorFunctionHealth</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 监控函数执行成功率、延迟等指标</span>
    }
}
</code></pre>
<h2 data-id="heading-17">最佳实践建议</h2>
<ol>
<li><strong>函数设计原则</strong>：函数应该短小精悍，专注单一职责</li>
<li><strong>状态管理</strong>：避免在函数中维护状态，使用外部存储</li>
<li><strong>错误处理</strong>：完善的错误处理和重试机制</li>
<li><strong>资源限制</strong>：合理设置内存和执行时间限制</li>
<li><strong>安全性</strong>：确保函数调用的安全性，防止未授权访问</li>
</ol>
<p>通过Serverless函数计算，我们可以构建高效、弹性的异步任务处理系统，让应用架构更加现代化。</p>
<hr/>
<p>以上就是本期分享的内容，希望对你有所帮助。更多技术干货，请关注服务端技术精选，我们下期再见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[tsconfig.json 到底配置了个啥？——从凡人到元婴的修仙指南]]></title>    <link>https://juejin.cn/post/7603227363822256154</link>    <guid>https://juejin.cn/post/7603227363822256154</guid>    <pubDate>2026-02-06T03:37:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603227363822256154" data-draft-id="7603215839582470154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="tsconfig.json 到底配置了个啥？——从凡人到元婴的修仙指南"/> <meta itemprop="keywords" content="TypeScript,前端工程化"/> <meta itemprop="datePublished" content="2026-02-06T03:37:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="polaris_tl"/> <meta itemprop="url" content="https://juejin.cn/user/4142615545513224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            tsconfig.json 到底配置了个啥？——从凡人到元婴的修仙指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4142615545513224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    polaris_tl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:37:47.000Z" title="Fri Feb 06 2026 03:37:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">tsconfig.json 到底配置了个啥？——从凡人到元婴的修仙指南</h2>
<h3 data-id="heading-1">1、凡人入道：七玄门里的“藏宝图”</h3>
<p>最近笔者在倒腾一个 <strong>Monorepo</strong> 大工程（全栈开发），不可避免地撞上了 <code>tsconfig.json</code>。盯着里面密密麻麻的配置项，我陷入了沉思：我只是想让 <code>tsc</code> 帮我把代码翻译翻译，为什么需要这么多繁琐的指令？</p>
<p>作为一个老牌“码农修仙者”，以前配置这玩意儿全靠<strong>搜魂术</strong>（Ctrl+C/V），大不了请出<strong>AI邪修</strong>强行破阵。但为了修得正果，我决定深入禁地，扒一扒这本“编译器操作手册”背后的底层逻辑。</p>
<p><strong>本文不复读文档!!</strong>，只论道法。各位道友，请随我入阵！🫡</p>
<hr/>
<h3 data-id="heading-2">2、炼气奠基：诸神黄昏与模块化的恩怨</h3>
<p>要想修仙修得好，<strong>因果背景</strong>不能少。</p>
<p><code>tsconfig.json</code> 之所以复杂，全怪 JS 那些年留下的“情债”。在 JS 道祖开天辟地之初，根本没有模块化。后来江湖大乱，<strong>CommonJS</strong>、<strong>AMD</strong>、<strong>UMD</strong> 割据一方。直到 ES6（2015年），官方才推出了 <strong>ES Module (ESM)</strong> 试图大一统。</p>
<p>但问题来了：即便现在已是 2026 年，npm 生态里依然残留着海量的 CommonJS 老古董。</p>
<p><strong>TypeScript 作为 JS 的超集，它最核心的痛苦就在于：</strong> 它得当一个“翻译官”，协调这些互不兼容的模块体系。</p>
<p>这就是 <code>tsconfig.json</code> 存在的根本意义——<strong>它在告诉编译器：在不同模块体系交火时，该如何“拉偏架”！</strong></p>
<p>JSON</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"CommonJS"</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// 告诉 TS：编译出的代码用哪种方言说话</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 告诉 TS：去哪里寻找那些失散的模块</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 给 ESM 和 CJS 之间搭个桥，别让他们打架</span>
    <span class="hljs-attr">"allowSyntheticDefaultImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-comment">// 即使对方没写 default，也允许我“默认”导入</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">3、筑基风云：深入理解核心阵法</h3>
<h4 data-id="heading-4">3.1 核心作用：它到底管什么？</h4>
<p>简单来说，<code>tsconfig.json</code> 负责两件事： <strong>“管人”</strong> （哪些文件参战）和 <strong>“管事”</strong> （怎么打仗）。</p>
<ul>
<li>
<p><strong>文件管理（管人）：</strong></p>
<p>通过 <code>include</code>、<code>exclude</code>、<code>files</code> 划定势力范围。比如：编译 <code>src</code> 里的天才（源码），踢出 <code>node_modules</code> 里的路人。</p>
</li>
<li>
<p><strong>编译规则（管事）：</strong></p>
<ul>
<li><strong>宿主环境</strong>：<code>target</code> 决定你是要在老旧的浏览器（ES5）里爬行，还是在现代引擎（ESNext）里飞升。</li>
<li><strong>模块体系</strong>：<code>module</code> 决定输出的形状。</li>
<li><strong>检查强度</strong>：<code>strict</code> 模式。开启后，编译器就像严师，一丝一毫的类型模糊（any）都可能让你道心破碎。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">3.2 配置继承：分身之术（Extends）</h4>
<p>在 Monorepo 或 Vite 项目中，你会看到 <code>tsconfig.app.json</code>、<code>tsconfig.node.json</code>。</p>
<ul>
<li><strong>extends</strong>：为了避免每个子项目都写一遍冗长的配置，我们可以搞个“祖传秘籍”（base.json），子项直接继承，只需微调（比如前端需要 <code>DOM</code> 库，后端需要 <code>Node</code> 库）。</li>
</ul>
<h4 data-id="heading-6">3.3 路径解析：缩地成寸（Paths）</h4>
<p>受够了 <code>import { tool } from "../../../../../utils"</code> 这种“僵尸路径”？</p>
<p>通过 <code>baseUrl</code> 和 <code>paths</code>，你可以施展<strong>缩地成寸</strong>：</p>
<p>JSON</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>道友请留步：</strong> 这只是给 <code>tsc</code> 看的“幻术”。如果你没配合 Vite/Webpack 进行物理层面的路径映射，代码运行到 JS 环境时会因为找不到路而走火入魔。</p>
<h4 data-id="heading-7">3.4 模块查找：现代修仙的新法门</h4>
<p>到了 TS 5.x 时代，有两个配置值得重点关注：</p>
<ul>
<li><strong>moduleResolution: "bundler"</strong> ：这是给 Vite/Webpack 打包工具量身定制的模式。它更聪明，知道现在的开发者不喜欢写 <code>.js</code> 后缀，也懂得如何处理 <code>package.json</code> 里的各种复杂导出。</li>
<li><strong>verbatimModuleSyntax</strong>：这是<strong>高性能开关</strong>。它要求你明确标记 <code>import type</code>。编译器看到 type 直接“物理删除”，不费脑子去猜，编译速度突飞猛进。</li>
</ul>
<hr/>
<h3 data-id="heading-8">4、结丹：道法总结</h3>
<p>要真正掌握 <code>tsconfig.json</code>，只需记住：</p>
<ol>
<li>它是<strong>输入的准则</strong>：界定哪些文件是你的“门徒”。</li>
<li>它是<strong>运行的蓝图</strong>：决定代码翻译成什么样。</li>
<li>它是<strong>类型的心法</strong>：决定静态检查有多狠。</li>
</ol>
<hr/>
<h3 data-id="heading-9">5、元婴出世：下一步挑战</h3>
<p>修炼至此，你已经识破了 <code>tsconfig.json</code> 的伪装。面对深不可测的 Monorepo 配置，你已经具备了初步的抗性。</p>
<p>好了，现在各位可以去挑战韩老魔了，加油~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bc61c7825bc4585bf1b27adeb33205e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcG9sYXJpc190bA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953868&amp;x-signature=FoI2RYE6MB2bLBIngeVIQajwPj4%3D" alt="honey.jpeg" loading="lazy"/></p>
<p>参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fdocs%2Fhandbook%2Fmodules%2Ftheory.html%23module-resolution" target="_blank" title="https://www.typescriptlang.org/docs/handbook/modules/theory.html#module-resolution" ref="nofollow noopener noreferrer">www.typescriptlang.org/docs/handbo…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 DeFi 新范式：意图金融（Intent-Centric）深度解析与实战]]></title>    <link>https://juejin.cn/post/7603227363822436378</link>    <guid>https://juejin.cn/post/7603227363822436378</guid>    <pubDate>2026-02-06T04:28:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603227363822436378" data-draft-id="7602914378388750346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 DeFi 新范式：意图金融（Intent-Centric）深度解析与实战"/> <meta itemprop="keywords" content="智能合约,Solidity,web3"/> <meta itemprop="datePublished" content="2026-02-06T04:28:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木西"/> <meta itemprop="url" content="https://juejin.cn/user/2436173496845549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 DeFi 新范式：意图金融（Intent-Centric）深度解析与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173496845549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T04:28:47.000Z" title="Fri Feb 06 2026 04:28:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>“意图金融”（Intent-Centric Finance）是去中心化金融（DeFi）领域的革命性交互范式，其核心逻辑实现了从“过程导向”到“结果导向”的根本性转变。用户无需手动执行授权、跨链、路径筛选等复杂操作，仅需向系统声明最终目标（即“意图”）及约束条件，剩余的执行流程由专业“求解者”（Solvers/Searchers）完成，大幅降低了Web3金融的使用门槛。</p>
</blockquote>
<h2 data-id="heading-1">一、 趋势背景：从“操作导向”到“结果导向”</h2>
<p>在传统的 DeFi 交互中，用户必须充当“操作员”：</p>
<ol>
<li><strong>寻找路径</strong>：去哪个 DEX 换币？用哪个跨链桥？</li>
<li><strong>管理细节</strong>：设置滑点、计算 Gas 费、处理多步授权。</li>
<li><strong>承担风险</strong>：手动操作失误或遭受 MEV 夹击。</li>
</ol>
<p><strong>意图金融 (Intent-Centric Finance)</strong>  在 2026 年彻底改变了这一现状。用户不再提交具体的交易步骤，而是签署一个 <strong>“意图”（Intent）</strong> ——即声明“我想要的结果”，而将“如何达成结果”的过程外包给专业的<strong>求解者（Solvers）</strong> 。</p>
<hr/>
<h2 data-id="heading-2">二、 意图金融 vs. 传统交易 </h2>






























<table><thead><tr><th>维度 </th><th>传统 DeFi 交易 (Imperative)</th><th>意图金融 (Declarative)</th></tr></thead><tbody><tr><td><strong>用户操作</strong></td><td>手动操作：桥接→换 Gas→授权→交换</td><td>声明目标：“我要用100100100USDC 换到最多的 ETH”</td></tr><tr><td><strong>交互复杂性</strong></td><td>用户必须理解各种底层协议和 Gas 优化</td><td><strong>抽象化底层</strong>，用户像“打车”一样，只给目的地</td></tr><tr><td><strong>执行效率</strong></td><td>路径单一，可能因失误导致滑点高或失败</td><td>多个“求解者”竞争，寻找<strong>全网最优路径</strong></td></tr><tr><td><strong>MEV 保护</strong></td><td>易受机器人夹击攻击（MEV）</td><td>通常具备 <strong>MEV 抗性</strong>，风险转嫁给求解者</td></tr></tbody></table>
<h2 data-id="heading-3">三、 意图金融的核心架构</h2>
<p>意图架构由三个核心组件构成：</p>





















<table><thead><tr><th>组件</th><th>职能</th></tr></thead><tbody><tr><td><strong>用户 (User)</strong></td><td>签署包含约束条件（价格、时效、Nonce）的声明，不需支付 Gas 或了解路径。</td></tr><tr><td><strong>求解者 (Solvers)</strong></td><td>链下竞争者，寻找最优执行路径（聚合流动性、跨链、自营资金补足），并代付 Gas。</td></tr><tr><td><strong>结算合约 (Executor)</strong></td><td>链上验证器，确保求解者的结果严格满足用户意图，否则拒绝执行。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">四. 2026 年的主流应用场景 </h2>
<p>随着技术成熟，意图金融在2026年已落地多个核心场景，实现从“极客工具”到“大众金融”的跨越：</p>
<ul>
<li><strong>无缝跨链交易</strong>：以Across协议为代表，用户在A链支付原资产后，可直接在B链接收目标资产，无需手动操作跨链桥的繁琐步骤，实现跨链交互“零门槛”。</li>
<li><strong>最优价格聚合交易</strong>：UniswapX、CoW Swap等平台借助意图机制，自动扫描全网流动性池，整合中心化交易所与去中心化协议资源，为用户达成最优成交价格。</li>
<li><strong>智能收益策略管理</strong>：依托Anoma等底层协议，用户仅需声明收益目标（如“稳定币年化收益＞10%”），系统即可自动在不同DeFi协议间调度资金，动态适配最优收益策略。</li>
</ul>
<h2 data-id="heading-5">五、意图金融智能合约开发、测试、部署</h2>
<h4 data-id="heading-6">一、智能合约</h4>
<p><strong>代币合约</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
<span class="hljs-comment">// Compatible with OpenZeppelin Contracts ^5.5.0</span>
pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.24</span>;

<span class="hljs-keyword">import</span> {<span class="hljs-title class_">ERC20</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/token/ERC20/ERC20.sol"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">ERC20Burnable</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/token/ERC20/extensions/ERC20Burnable.sol"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">ERC20Permit</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/token/ERC20/extensions/ERC20Permit.sol"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">Ownable</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"@openzeppelin/contracts/access/Ownable.sol"</span>;

contract <span class="hljs-title class_">BoykaYuriToken</span> is <span class="hljs-title class_">ERC20</span>, <span class="hljs-title class_">ERC20Burnable</span>, <span class="hljs-title class_">Ownable</span>, <span class="hljs-title class_">ERC20Permit</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">address recipient, address initialOwner</span>)
        <span class="hljs-title class_">ERC20</span>(<span class="hljs-string">"MyToken"</span>, <span class="hljs-string">"MTK"</span>)
        <span class="hljs-title class_">Ownable</span>(initialOwner)
        <span class="hljs-title class_">ERC20Permit</span>(<span class="hljs-string">"MyToken"</span>)
    {
        <span class="hljs-title function_">_mint</span>(recipient, <span class="hljs-number">1000000</span> * <span class="hljs-number">10</span> ** <span class="hljs-title function_">decimals</span>());
    }
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">mint</span>(<span class="hljs-params">address to, uint256 amount</span>) public onlyOwner {
        <span class="hljs-title function_">_mint</span>(to, amount);
    }
}
</code></pre>
<p><strong>意图金融合约</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-number">.24</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">"@openzeppelin/contracts/utils/cryptography/ECDSA.sol"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"@openzeppelin/contracts/utils/cryptography/MessageHashUtils.sol"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"@openzeppelin/contracts/utils/ReentrancyGuard.sol"</span>; <span class="hljs-comment">// 引入防重入库</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"@openzeppelin/contracts/token/ERC20/IERC20.sol"</span>;

contract IntentExecutor is ReentrancyGuard { <span class="hljs-comment">// 必须在这里显式继承</span>
    <span class="hljs-keyword">using</span> ECDSA <span class="hljs-keyword">for</span> bytes32;
    <span class="hljs-keyword">using</span> MessageHashUtils <span class="hljs-keyword">for</span> bytes32;

    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Intent</span> {
        address user;
        address tokenIn;
        uint256 amountIn;
        address tokenOut;
        uint256 minAmountOut;
        uint256 nonce;
        uint256 deadline;
    }

    <span class="hljs-built_in">mapping</span>(address =&gt; uint256) <span class="hljs-keyword">public</span> nonces;

    <span class="hljs-function">event <span class="hljs-title">IntentFulfilled</span><span class="hljs-params">(bytes32 indexed intentHash, address indexed solver)</span></span>;

    <span class="hljs-function">function <span class="hljs-title">getIntentHash</span><span class="hljs-params">(Intent memory intent)</span> <span class="hljs-keyword">public</span> pure <span class="hljs-title">returns</span> <span class="hljs-params">(bytes32)</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">keccak256</span>(abi.<span class="hljs-built_in">encode</span>(
            intent.user,
            intent.tokenIn,
            intent.amountIn,
            intent.tokenOut,
            intent.minAmountOut,
            intent.nonce,
            intent.deadline
        ));
    }

    <span class="hljs-comment">/**
     * 注意：OpenZeppelin V5 的修饰器是 nonReentrant (小驼峰)
     */</span>
    <span class="hljs-function">function <span class="hljs-title">executeIntent</span><span class="hljs-params">(Intent calldata intent, bytes calldata signature)</span> 
        external 
        nonReentrant <span class="hljs-comment">// 修正此处：从 non_reentrant 改为 nonReentrant</span>
    </span>{
        <span class="hljs-built_in">require</span>(block.timestamp &lt;= intent.deadline, <span class="hljs-string">"Intent expired"</span>);
        <span class="hljs-built_in">require</span>(intent.nonce == nonces[intent.user], <span class="hljs-string">"Invalid nonce"</span>);

        <span class="hljs-comment">// 验证签名</span>
        bytes32 hash = <span class="hljs-built_in">getIntentHash</span>(intent).<span class="hljs-built_in">toEthSignedMessageHash</span>();
        <span class="hljs-built_in">require</span>(hash.<span class="hljs-built_in">recover</span>(signature) == intent.user, <span class="hljs-string">"Invalid signature"</span>);

        <span class="hljs-comment">// 更新 Nonce 防止重放</span>
        nonces[intent.user]++;

        <span class="hljs-comment">// 执行意图逻辑</span>
        <span class="hljs-comment">// 1. 从用户处转入资产到 Solver (需用户提前 approve 本合约)</span>
        <span class="hljs-built_in">IERC20</span>(intent.tokenIn).<span class="hljs-built_in">transferFrom</span>(intent.user, msg.sender, intent.amountIn);

        <span class="hljs-comment">// 2. Solver 必须确保用户收到目标资产</span>
        <span class="hljs-comment">// 在意图金融中，由 Solver 保证结果的最终性</span>
        <span class="hljs-built_in">require</span>(
            <span class="hljs-built_in">IERC20</span>(intent.tokenOut).<span class="hljs-built_in">transferFrom</span>(msg.sender, intent.user, intent.minAmountOut),
            <span class="hljs-string">"Solver failed to provide minAmountOut"</span>
        );

        <span class="hljs-function">emit <span class="hljs-title">IntentFulfilled</span><span class="hljs-params">(getIntentHash(intent), msg.sender)</span></span>;
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-7">二、意图金融测试脚本</h4>
<p><strong>测试说明</strong>：</p>
<ol>
<li><strong>Solver 应该能够执行有效的用户意图</strong></li>
<li><strong>过期的意图应该执行失败</strong></li>
<li><strong>Nonce 不匹配应该防止重放攻击</strong></li>
</ol>
<pre><code class="hljs language-php" lang="php">import assert <span class="hljs-keyword">from</span> <span class="hljs-string">"node:assert/strict"</span>;
import { describe, it, beforeEach } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:test"</span>;
import { parseEther, formatEther, keccak256, encodeAbiParameters, hashMessage } <span class="hljs-keyword">from</span> <span class="hljs-string">'viem'</span>;
import { network } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;

<span class="hljs-title function_ invoke__">describe</span>(<span class="hljs-string">"IntentExecutor 意图金融合约测试"</span>, function () {
    let IntentExecutor: any, MockTokenA: any, MockTokenB: any;
    let publicClient: any, testClient: any;
    let user: any, solver: any, owner: any;

    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">AMOUNT_IN</span> = <span class="hljs-title function_ invoke__">parseEther</span>(<span class="hljs-string">"100"</span>); <span class="hljs-comment">// 用户想出的 100 A</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MIN_AMOUNT_OUT</span> = <span class="hljs-title function_ invoke__">parseEther</span>(<span class="hljs-string">"0.05"</span>); <span class="hljs-comment">// 用户要求的最低回报 0.05 B</span>

    <span class="hljs-title function_ invoke__">beforeEach</span>(async function () {
        <span class="hljs-keyword">const</span> { viem } = await network.<span class="hljs-title function_ invoke__">connect</span>();
        publicClient = await viem.<span class="hljs-title function_ invoke__">getPublicClient</span>();
        testClient = await viem.<span class="hljs-title function_ invoke__">getTestClient</span>();
        [owner, user, solver] = await viem.<span class="hljs-title function_ invoke__">getWalletClients</span>();

        <span class="hljs-comment">// 1. 部署两个 Mock 代币模拟交换</span>
        <span class="hljs-comment">// 使用你的 BoykaYuriToken 或标准 ERC20</span>
        MockTokenA = await viem.<span class="hljs-title function_ invoke__">deployContract</span>(<span class="hljs-string">"BoykaYuriToken"</span>, [owner.account.address, owner.account.address]);
        MockTokenB = await viem.<span class="hljs-title function_ invoke__">deployContract</span>(<span class="hljs-string">"BoykaYuriToken"</span>, [owner.account.address, owner.account.address]);

        <span class="hljs-comment">// 2. 部署意图执行合约</span>
        IntentExecutor = await viem.<span class="hljs-title function_ invoke__">deployContract</span>(<span class="hljs-string">"IntentExecutor"</span>, []);

        <span class="hljs-comment">// 3. 初始资金分配</span>
        <span class="hljs-comment">// 给用户发 TokenA</span>
        await MockTokenA.write.<span class="hljs-title function_ invoke__">transfer</span>([user.account.address, AMOUNT_IN], { <span class="hljs-attr">account</span>: owner.account });
        <span class="hljs-comment">// 给 Solver 发 TokenB (用于履行意图)</span>
        await MockTokenB.write.<span class="hljs-title function_ invoke__">transfer</span>([solver.account.address, <span class="hljs-title function_ invoke__">parseEther</span>(<span class="hljs-string">"10"</span>)], { <span class="hljs-attr">account</span>: owner.account });

        <span class="hljs-comment">// 4. 授权：用户和 Solver 都需要授权给 IntentExecutor 合约</span>
        await MockTokenA.write.<span class="hljs-title function_ invoke__">approve</span>([IntentExecutor.address, AMOUNT_IN], { <span class="hljs-attr">account</span>: user.account });
        await MockTokenB.write.<span class="hljs-title function_ invoke__">approve</span>([IntentExecutor.address, <span class="hljs-title function_ invoke__">parseEther</span>(<span class="hljs-string">"10"</span>)], { <span class="hljs-attr">account</span>: solver.account });
    });

    <span class="hljs-title function_ invoke__">it</span>(<span class="hljs-string">"Solver 应该能够执行有效的用户意图"</span>, async function () {
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">nonce</span> = await IntentExecutor.read.<span class="hljs-title function_ invoke__">nonces</span>([user.account.address]);
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">deadline</span> = <span class="hljs-title function_ invoke__">BigInt</span>(Math.<span class="hljs-title function_ invoke__">floor</span>(Date.<span class="hljs-title function_ invoke__">now</span>() / <span class="hljs-number">1000</span>) + <span class="hljs-number">3600</span>);

        <span class="hljs-comment">// 1. 构建意图对象 (必须与 Solidity Struct 顺序一致)</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">intent</span> = {
            user: user.account.address,
            tokenIn: MockTokenA.address,
            amountIn: AMOUNT_IN,
            tokenOut: MockTokenB.address,
            minAmountOut: MIN_AMOUNT_OUT,
            nonce: nonce,
            deadline: deadline
        };

        <span class="hljs-comment">// 2. 链下计算哈希 (对应合约 getIntentHash)</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">structHash</span> = <span class="hljs-title function_ invoke__">keccak256</span>(
            <span class="hljs-title function_ invoke__">encodeAbiParameters</span>(
                [
                    { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> },
                    { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }
                ],
                [intent.user, intent.tokenIn, intent.amountIn, intent.tokenOut, intent.minAmountOut, intent.nonce, intent.deadline]
            )
        );

        <span class="hljs-comment">// 3. 用户进行 EIP-191 签名</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">signature</span> = await user.<span class="hljs-title function_ invoke__">signMessage</span>({
            <span class="hljs-attr">message</span>: { <span class="hljs-attr">raw</span>: structHash },
        });

        <span class="hljs-comment">// 4. Solver 提交交易</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">hash</span> = await IntentExecutor.write.<span class="hljs-title function_ invoke__">executeIntent</span>([intent, signature], { <span class="hljs-attr">account</span>: solver.account });
        await publicClient.<span class="hljs-title function_ invoke__">waitForTransactionReceipt</span>({ hash });

        <span class="hljs-comment">// 5. 验证资产转移</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">userFinalBalanceB</span> = await MockTokenB.read.<span class="hljs-title function_ invoke__">balanceOf</span>([user.account.address]);
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">solverFinalBalanceA</span> = await MockTokenA.read.<span class="hljs-title function_ invoke__">balanceOf</span>([solver.account.address]);

        console.<span class="hljs-title function_ invoke__">log</span>(`意图达成！用户收到 <span class="hljs-attr">TokenB</span>: ${<span class="hljs-title function_ invoke__">formatEther</span>(userFinalBalanceB)}`);
        
        assert.<span class="hljs-title function_ invoke__">equal</span>(userFinalBalanceB, MIN_AMOUNT_OUT, <span class="hljs-string">"用户收到的代币数量不符合意图"</span>);
        assert.<span class="hljs-title function_ invoke__">equal</span>(solverFinalBalanceA, AMOUNT_IN, <span class="hljs-string">"Solver 未收到用户的代币"</span>);
    });
       <span class="hljs-title function_ invoke__">it</span>(<span class="hljs-string">"过期的意图应该执行失败"</span>, async function () {
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">latestBlock</span> = await publicClient.<span class="hljs-title function_ invoke__">getBlock</span>({ <span class="hljs-attr">blockTag</span>: <span class="hljs-string">'latest'</span> });
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">currentChainTime</span> = latestBlock.timestamp;
        
        <span class="hljs-comment">// 1. 明确设置一个已经过期的时间</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">expiredDeadline</span> = currentChainTime - <span class="hljs-number">1000</span>n;
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">currentNonce</span> = await IntentExecutor.read.<span class="hljs-title function_ invoke__">nonces</span>([user.account.address]);

        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">intent</span> = {
            user: user.account.address,
            tokenIn: MockTokenA.address,
            amountIn: AMOUNT_IN,
            tokenOut: MockTokenB.address,
            minAmountOut: MIN_AMOUNT_OUT,
            nonce: currentNonce,
            deadline: expiredDeadline
        };

        <span class="hljs-comment">// 2. 生成合法签名（确保错误不是由签名解析引起的）</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">structHash</span> = <span class="hljs-title function_ invoke__">keccak256</span>(
            <span class="hljs-title function_ invoke__">encodeAbiParameters</span>(
                [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }],
                [intent.user, intent.tokenIn, intent.amountIn, intent.tokenOut, intent.minAmountOut, intent.nonce, intent.deadline]
            )
        );
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">signature</span> = await user.<span class="hljs-title function_ invoke__">signMessage</span>({ <span class="hljs-attr">message</span>: { <span class="hljs-attr">raw</span>: structHash } });

        <span class="hljs-comment">// 3. 执行测试</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用 simulateContract 尝试执行</span>
            await publicClient.<span class="hljs-title function_ invoke__">simulateContract</span>({
                <span class="hljs-attr">address</span>: IntentExecutor.address,
                <span class="hljs-attr">abi</span>: IntentExecutor.abi,
                <span class="hljs-attr">functionName</span>: <span class="hljs-string">'executeIntent'</span>,
                <span class="hljs-attr">args</span>: [intent, signature],
                <span class="hljs-attr">account</span>: solver.account,
            });
            assert.<span class="hljs-title function_ invoke__">fail</span>(<span class="hljs-string">"意图已过期，但合约未抛出异常"</span>);
        } <span class="hljs-keyword">catch</span> (error: any) {
            <span class="hljs-comment">// 在 2026 开发实践中，如果无法解析原因，我们通过排除法确认错误</span>
            <span class="hljs-comment">// 只要错误信息包含 "reverted" 或 "RPC error"，且我们已知 deadline 已过</span>
            <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">isReverted</span> = error.message.<span class="hljs-title function_ invoke__">includes</span>(<span class="hljs-string">"reverted"</span>) || 
                               error.details?.<span class="hljs-title function_ invoke__">includes</span>(<span class="hljs-string">"reverted"</span>) ||
                               error.message.<span class="hljs-title function_ invoke__">includes</span>(<span class="hljs-string">"RPC error"</span>);
            
            assert.<span class="hljs-title function_ invoke__">ok</span>(isReverted, `应该触发合约 Revert，实际收到: ${error.message}`);
            console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"✅ 成功捕获到过期导致的合约拦截 (即使 Hardhat 无法解析具体字符串)"</span>);
        }
    });
    <span class="hljs-title function_ invoke__">it</span>(<span class="hljs-string">"Nonce 不匹配应该防止重放攻击"</span>, async function () {
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">deadline</span> = <span class="hljs-title function_ invoke__">BigInt</span>(Math.<span class="hljs-title function_ invoke__">floor</span>(Date.<span class="hljs-title function_ invoke__">now</span>() / <span class="hljs-number">1000</span>) + <span class="hljs-number">3600</span>);
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">intent</span> = {
            user: user.account.address,
            tokenIn: MockTokenA.address,
            amountIn: AMOUNT_IN,
            tokenOut: MockTokenB.address,
            minAmountOut: MIN_AMOUNT_OUT,
            nonce: <span class="hljs-number">0</span>n,
            deadline: deadline
        };

        <span class="hljs-comment">// 第一次执行成功</span>
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">structHash</span> = <span class="hljs-title function_ invoke__">keccak256</span>(<span class="hljs-title function_ invoke__">encodeAbiParameters</span>(
            [{ <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'address'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }, { <span class="hljs-attr">type</span>: <span class="hljs-string">'uint256'</span> }],
            [intent.user, intent.tokenIn, intent.amountIn, intent.tokenOut, intent.minAmountOut, intent.nonce, intent.deadline]
        ));
        <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">signature</span> = await user.<span class="hljs-title function_ invoke__">signMessage</span>({ <span class="hljs-attr">message</span>: { <span class="hljs-attr">raw</span>: structHash } });
        await IntentExecutor.write.<span class="hljs-title function_ invoke__">executeIntent</span>([intent, signature], { <span class="hljs-attr">account</span>: solver.account });

        <span class="hljs-comment">// 尝试再次使用同一个意图/签名进行第二次执行</span>
        <span class="hljs-keyword">try</span> {
            await IntentExecutor.write.<span class="hljs-title function_ invoke__">executeIntent</span>([intent, signature], { <span class="hljs-attr">account</span>: solver.account });
            assert.<span class="hljs-title function_ invoke__">fail</span>(<span class="hljs-string">"不应允许重复使用同一个 Nonce"</span>);
        } <span class="hljs-keyword">catch</span> (error: any) {
            assert.<span class="hljs-title function_ invoke__">ok</span>(error.message.<span class="hljs-title function_ invoke__">includes</span>(<span class="hljs-string">"Invalid nonce"</span>), <span class="hljs-string">"应该提示 Nonce 无效"</span>);
        }
    });
});

</code></pre>
<h4 data-id="heading-8">三、 部署脚本</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// scripts/deploy.js</span>
<span class="hljs-keyword">import</span> { network, artifacts } <span class="hljs-keyword">from</span> <span class="hljs-string">"hardhat"</span>;
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 连接网络</span>
  <span class="hljs-keyword">const</span> { viem } = <span class="hljs-keyword">await</span> network.<span class="hljs-title function_">connect</span>({ <span class="hljs-attr">network</span>: network.<span class="hljs-property">name</span> });<span class="hljs-comment">//指定网络进行链接</span>
  
  <span class="hljs-comment">// 获取客户端</span>
  <span class="hljs-keyword">const</span> [deployer] = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">getWalletClients</span>();
  <span class="hljs-keyword">const</span> publicClient = <span class="hljs-keyword">await</span> viem.<span class="hljs-title function_">getPublicClient</span>();
 
  <span class="hljs-keyword">const</span> deployerAddress = deployer.<span class="hljs-property">account</span>.<span class="hljs-property">address</span>;
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"部署者的地址:"</span>, deployerAddress);
  <span class="hljs-comment">// 加载合约</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">BoykaYuriTokenAArtifact</span> = <span class="hljs-keyword">await</span> artifacts.<span class="hljs-title function_">readArtifact</span>(<span class="hljs-string">"BoykaYuriToken"</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">BoykaYuriTokenBArtifact</span> = <span class="hljs-keyword">await</span> artifacts.<span class="hljs-title function_">readArtifact</span>(<span class="hljs-string">"BoykaYuriToken"</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">IntentExecutorArtifact</span> = <span class="hljs-keyword">await</span> artifacts.<span class="hljs-title function_">readArtifact</span>(<span class="hljs-string">"IntentExecutor"</span>);
 
  <span class="hljs-comment">// 部署（构造函数参数：recipient, initialOwner）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">BoykaYuriTokenAHash</span> = <span class="hljs-keyword">await</span> deployer.<span class="hljs-title function_">deployContract</span>({
    <span class="hljs-attr">abi</span>: <span class="hljs-title class_">BoykaYuriTokenAArtifact</span>.<span class="hljs-property">abi</span>,<span class="hljs-comment">//获取abi</span>
    <span class="hljs-attr">bytecode</span>: <span class="hljs-title class_">BoykaYuriTokenAArtifact</span>.<span class="hljs-property">bytecode</span>,<span class="hljs-comment">//硬编码</span>
    <span class="hljs-attr">args</span>: [deployerAddress,deployerAddress],<span class="hljs-comment">//部署者地址，初始所有者地址</span>
  });
   <span class="hljs-keyword">const</span> <span class="hljs-title class_">BoykaYuriTokenAReceipt</span> = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: <span class="hljs-title class_">BoykaYuriTokenAHash</span> });
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"代币a合约地址:"</span>, <span class="hljs-title class_">BoykaYuriTokenAReceipt</span>.<span class="hljs-property">contractAddress</span>);
<span class="hljs-comment">//</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">BoykaYuriTokenBHash</span> = <span class="hljs-keyword">await</span> deployer.<span class="hljs-title function_">deployContract</span>({
    <span class="hljs-attr">abi</span>: <span class="hljs-title class_">BoykaYuriTokenBArtifact</span>.<span class="hljs-property">abi</span>,<span class="hljs-comment">//获取abi</span>
    <span class="hljs-attr">bytecode</span>: <span class="hljs-title class_">BoykaYuriTokenBArtifact</span>.<span class="hljs-property">bytecode</span>,<span class="hljs-comment">//硬编码</span>
    <span class="hljs-attr">args</span>: [deployerAddress,deployerAddress],<span class="hljs-comment">//部署者地址，初始所有者地址</span>
  });
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">BoykaYuriTokenBReceipt</span> = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: <span class="hljs-title class_">BoykaYuriTokenBHash</span> });
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"代币b合约地址:"</span>, <span class="hljs-title class_">BoykaYuriTokenBReceipt</span>.<span class="hljs-property">contractAddress</span>);
<span class="hljs-comment">//</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">IntentExecutorHash</span> = <span class="hljs-keyword">await</span> deployer.<span class="hljs-title function_">deployContract</span>({
    <span class="hljs-attr">abi</span>: <span class="hljs-title class_">IntentExecutorArtifact</span>.<span class="hljs-property">abi</span>,<span class="hljs-comment">//获取abi</span>
    <span class="hljs-attr">bytecode</span>: <span class="hljs-title class_">IntentExecutorArtifact</span>.<span class="hljs-property">bytecode</span>,<span class="hljs-comment">//硬编码</span>
    <span class="hljs-attr">args</span>: [],<span class="hljs-comment">//</span>
  });
  <span class="hljs-comment">// 等待确认并打印地址</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">IntentExecutorReceipt</span> = <span class="hljs-keyword">await</span> publicClient.<span class="hljs-title function_">waitForTransactionReceipt</span>({ <span class="hljs-attr">hash</span>: <span class="hljs-title class_">IntentExecutorHash</span> });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"意图执行器合约地址:"</span>, <span class="hljs-title class_">IntentExecutorReceipt</span>.<span class="hljs-property">contractAddress</span>);
}

<span class="hljs-title function_">main</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
</code></pre>
<hr/>
<h2 data-id="heading-9">七、 2026 DeFi 玩法的核心创新总结</h2>
<ol>
<li><strong>Gas 抽象化</strong>：用户只需“签名”，由求解者支付 Gas。这消除了用户钱包必须持有原生代币（如 ETH）的痛点。</li>
<li><strong>MEV 保护</strong>：意图交易通常在链下内存池（Match-making）完成撮合，减少了链上公开套利机会，保护用户免受夹击攻击。</li>
<li><strong>跨链无缝化</strong>：求解者可以在链 A 接收用户的代币，并在链 B 直接履行结果。用户无需感知跨链桥的存在。</li>
<li><strong>智能流动性</strong>：意图不再受限于单一池子，求解者可以动用 CEX 库存、OTC 渠道或其他链的流动性来满足用户的 <code>minAmountOut</code>。</li>
</ol>
<h2 data-id="heading-10">八、 结语</h2>
<p>意图金融标志着 Web3 交互从“编程模型”向“用户心理模型”的飞跃。到 2026 年，这种“只看结果，不问过程”的模式将使 DeFi 的体验真正媲美 Web2 银行应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次 CloudFront 缓存配置错误导致的用户数据泄露事故]]></title>    <link>https://juejin.cn/post/7603308967124598784</link>    <guid>https://juejin.cn/post/7603308967124598784</guid>    <pubDate>2026-02-06T03:41:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603308967124598784" data-draft-id="7603288778678534179" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次 CloudFront 缓存配置错误导致的用户数据泄露事故"/> <meta itemprop="keywords" content="前端,AWS"/> <meta itemprop="datePublished" content="2026-02-06T03:41:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="易码当先"/> <meta itemprop="url" content="https://juejin.cn/user/2875978146916199"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次 CloudFront 缓存配置错误导致的用户数据泄露事故
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978146916199/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    易码当先
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:41:45.000Z" title="Fri Feb 06 2026 03:41:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一次 CloudFront 缓存配置错误导致的用户数据泄露事故</h2>
<blockquote>
<p>记录一次由于 CDN 缓存配置不当，导致不同用户看到彼此私有数据的严重安全问题。</p>
</blockquote>
<h3 data-id="heading-1">🔥 事故的开端</h3>
<p>那是一个平常的下午，QA 同学在测试环境发现了一个诡异的现象：</p>
<p><strong>"为什么我的会话列表显示的是别人的数据？"</strong></p>
<p>起初我以为是前端缓存的问题，让他清除浏览器缓存试试。但是清除后问题依旧。更奇怪的是，当我用 curl 测试同一个接口时，返回的却是正确的数据。</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># curl 请求 - 返回正确数据</span>

curl <span class="hljs-string">'https://example.com/api/user/sessions'</span> \

    -H <span class="hljs-string">'authorization: Bearer TOKEN_A'</span>

<span class="hljs-comment"># 返回：用户 A 的数据（15 条会话）</span>

</code></pre>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 浏览器 fetch - 返回错误数据</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://example.com/api/user/sessions'</span>, {

    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'authorization'</span>: <span class="hljs-string">'Bearer TOKEN_A'</span> }

})

  


<span class="hljs-comment">// 返回：用户 B 的数据（23 条会话）❌</span>

</code></pre>
<p>这下我意识到，问题可能没那么简单。</p>
<hr/>
<h3 data-id="heading-2">🕵️ 开始排查</h3>
<h4 data-id="heading-3">第一步：检查响应头</h4>
<p>我首先查看了浏览器请求的响应头：</p>
<pre><code class="hljs language-http" lang="http">
HTTP/2 200

cache-control: (null) ⚠️

x-cache: Hit from cloudfront ⚠️

age: 1545 ⚠️

via: 1.1 xxx.cloudfront.net (CloudFront)

</code></pre>
<p>看到这三个关键信息，我心里一凉：</p>
<ol>
<li>
<p><strong>cache-control 为空</strong> - 后端没有设置缓存控制策略</p>
</li>
<li>
<p><strong>x-cache: Hit from cloudfront</strong> - 请求命中了 CloudFront 缓存</p>
</li>
<li>
<p><strong>age: 1545</strong> - 这个缓存已经存在了 1545 秒（约 26 分钟）</p>
</li>
</ol>
<p>问题找到了：<strong>CloudFront 把用户的私有数据缓存了！</strong></p>
<h4 data-id="heading-4">第二步：验证假设</h4>
<p>我用不同的方式测试了几次：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 测试 1: 不带 Cookie，只带 Authorization</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user/sessions'</span>, {

    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'authorization'</span>: <span class="hljs-string">'Bearer TOKEN_A'</span> },

    <span class="hljs-attr">credentials</span>: <span class="hljs-string">'omit'</span>

})

<span class="hljs-comment">// 结果：返回用户 B 的数据（缓存）</span>


<span class="hljs-comment">// 测试 2: 带上 Cookie</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user/sessions'</span>, {

    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'authorization'</span>: <span class="hljs-string">'Bearer TOKEN_A'</span> },

    <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>

})

<span class="hljs-comment">// 结果：还是用户 B 的数据（缓存）</span>


<span class="hljs-comment">// 测试 3: 添加随机参数绕过缓存</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/sessions?_t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>, {

    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'authorization'</span>: <span class="hljs-string">'Bearer TOKEN_A'</span> }

})

<span class="hljs-comment">// 结果：返回正确的用户 A 数据 ✓</span>

</code></pre>
<p>第三个测试证实了我的猜测：CloudFront 缓存键中没有包含 Authorization header！</p>
<hr/>
<h3 data-id="heading-5">💡 问题根源分析</h3>
<h4 data-id="heading-6">我们的系统架构</h4>
<pre><code class="hljs language-javascript" lang="javascript">
用户浏览器

↓ 请求: <span class="hljs-regexp">/api/u</span>ser/sessions

↓ <span class="hljs-title class_">Header</span>: <span class="hljs-title class_">Authorization</span>: <span class="hljs-title class_">Bearer</span> &lt;token&gt;

<span class="hljs-title class_">CloudFront</span> <span class="hljs-variable constant_">CDN</span> (全球边缘节点)

↓ 缓存键 = 域名 + <span class="hljs-variable constant_">URL</span> 路径

↓ ⚠️ 不包含 <span class="hljs-title class_">Authorization</span> header!

前端服务器

↓ <span class="hljs-title class_">Rewrite</span>: <span class="hljs-regexp">/api/</span>* → backend-api.<span class="hljs-property">com</span><span class="hljs-comment">/*

后端 API 服务器

↓ 根据 Authorization 识别用户

↓ 返回对应用户的数据

</span></code></pre>
<h4 data-id="heading-7">CloudFront 默认缓存行为</h4>
<p>CloudFront 默认的缓存键由以下部分组成：</p>
<pre><code class="hljs">
缓存键 = 域名 + URL 路径 + 查询参数

</code></pre>
<p><strong>不包含：</strong></p>
<ul>
<li>
<p>❌ 请求头（包括 Authorization）</p>
</li>
<li>
<p>❌ Cookie（除非显式配置）</p>
</li>
<li>
<p>❌ 请求体</p>
</li>
</ul>
<h4 data-id="heading-8">问题是如何发生的？</h4>
<p>让我用时间线来还原整个过程：</p>
<pre><code class="hljs language-makefile" lang="makefile">
<span class="hljs-section">10:00 - 用户 A 登录，token_A</span>

<span class="hljs-section">10:01 - 用户 A 请求 /api/user/sessions</span>

        → CloudFront: 缓存 Miss

        → 转发到后端，带上 Authorization: Bearer token_A

        → 后端识别用户 A，返回用户 A 的数据

        → CloudFront 缓存这个响应（缓存键 = /api/user/sessions）

  


<span class="hljs-section">10:15 - 用户 B 登录，token_B</span>

<span class="hljs-section">10:16 - 用户 B 请求 /api/user/sessions</span>

        → CloudFront: 缓存 Hit! (因为 URL 相同)

        → 直接返回缓存（用户 A 的数据）❌

        → 请求根本没有到达后端

        → 后端无法识别 token_B

</code></pre>
<p><strong>这就是问题的本质：不同用户请求同一个 URL，CloudFront 认为它们是同一个请求，直接返回了缓存的内容。</strong></p>
<hr/>
<h3 data-id="heading-9">🤔 为什么 curl 返回正确数据？</h3>
<p>这是一个有趣的问题。可能的原因：</p>
<ol>
<li>
<p><strong>请求头差异</strong>：curl 和浏览器的请求头不同，可能形成了不同的缓存键</p>
</li>
<li>
<p><strong>时机问题</strong>：curl 测试时缓存可能已经过期</p>
</li>
<li>
<p><strong>Vary 响应头</strong>：如果后端设置了某些 Vary 头，curl 可能命中了不同的缓存</p>
</li>
</ol>
<p>但无论如何，<strong>这都说明了缓存策略的不确定性和危险性</strong>。</p>
<hr/>
<h3 data-id="heading-10">🔧 解决方案探索</h3>
<h4 data-id="heading-11">方案对比</h4>
<p>我考虑了三个方案：</p>
<h5 data-id="heading-12">方案 1：修改 CloudFront Cache Policy，将 Authorization 加入缓存键</h5>
<p><strong>想法</strong>：让每个 token 有独立的缓存。</p>
<p><strong>问题</strong>：</p>
<pre><code class="hljs language-css" lang="css">
用户 <span class="hljs-selector-tag">A</span> (token_A) → 缓存 <span class="hljs-selector-tag">A</span>

用户 <span class="hljs-selector-tag">B</span> (token_B) → 缓存 <span class="hljs-selector-tag">B</span>

...

</code></pre>
<ul>
<li>
<p>❌ 用户数据仍然会被缓存在 CDN 边缘节点（安全风险）</p>
</li>
<li>
<p>❌ 缓存数量爆炸（每个用户一份缓存）</p>
</li>
<li>
<p>❌ 如果 token 刷新，缓存会失效，浪费资源</p>
</li>
<li>
<p>❌ 需要修改 CloudFront 配置（由于我们有前端 rewrite，很容易配错导致 502）</p>
</li>
</ul>
<p><strong>结论</strong>：不推荐</p>
<h5 data-id="heading-13">方案 2：在 CloudFront 禁用 /api/* 路径的缓存</h5>
<p><strong>想法</strong>：直接禁用 API 路径的缓存。</p>
<p><strong>问题</strong>：</p>
<ul>
<li>
<p>⚠️ 由于我们的架构（前端服务器做了 rewrite），配置 <code>/api/*</code> 的 Cache Behavior 会绕过前端服务器，直接转发到后端</p>
</li>
<li>
<p>💥 后端没有 <code>/api/*</code> 这个路径，导致 502 错误（我们实际遇到了这个问题）</p>
</li>
</ul>
<p><strong>结论</strong>：不适用于我们的架构</p>
<h5 data-id="heading-14">方案 3：在后端设置 Cache-Control 响应头 ⭐</h5>
<p><strong>想法</strong>：让后端明确告诉 CloudFront："这个响应不要缓存！"</p>
<pre><code class="hljs language-http" lang="http">
Cache-Control: private, no-cache, no-store, must-revalidate

Pragma: no-cache

Expires: 0

</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>
<p>✅ 最根本的解决方案</p>
</li>
<li>
<p>✅ 不需要修改 CloudFront 配置</p>
</li>
<li>
<p>✅ 对所有中间层（CDN、代理、浏览器）都生效</p>
</li>
<li>
<p>✅ 符合 HTTP 标准和最佳实践</p>
</li>
</ul>
<p><strong>结论</strong>：采用！</p>
<hr/>
<h3 data-id="heading-15">🛠️ 具体实现</h3>
<h4 data-id="heading-16">1. 后端添加中间件</h4>
<p>我们使用 Go + Gin 框架，实现很简单：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// middleware/nocache.go</span>

<span class="hljs-keyword">package</span> middleware

<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/gin-gonic/gin"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NoCacheMiddleware</span><span class="hljs-params">()</span></span> gin.HandlerFunc {

    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {

        c.Header(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"private, no-cache, no-store, must-revalidate"</span>)

        c.Header(<span class="hljs-string">"Pragma"</span>, <span class="hljs-string">"no-cache"</span>)

        c.Header(<span class="hljs-string">"Expires"</span>, <span class="hljs-string">"0"</span>)

        c.Next()

    }

}

</code></pre>
<p>在路由中应用：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// router/router.go</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">SetupRouter</span><span class="hljs-params">()</span></span> *gin.Engine {

    r := gin.Default()

    <span class="hljs-comment">// 对所有需要身份验证的路由应用</span>

    authRoutes := r.Group(<span class="hljs-string">"/"</span>)

    authRoutes.Use(middleware.AuthMiddleware())

    authRoutes.Use(middleware.NoCacheMiddleware()) <span class="hljs-comment">// 关键！</span>

    {

        authRoutes.GET(<span class="hljs-string">"/user/sessions"</span>, handlers.GetUserSessions)

        authRoutes.GET(<span class="hljs-string">"/user/quota"</span>, handlers.GetUserQuota)

        authRoutes.GET(<span class="hljs-string">"/user/profile"</span>, handlers.GetUserProfile)

    }

    <span class="hljs-keyword">return</span> r

}

</code></pre>
<h4 data-id="heading-17">2. 清除 CloudFront 现有缓存</h4>
<p>代码部署后，还需要清除已经存在的缓存：</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># AWS CLI 方式</span>

aws cloudfront create-invalidation \

    --distribution-id E1234567890ABC \

    --paths <span class="hljs-string">"/*"</span>


<span class="hljs-comment"># 或者在 AWS Console 中操作：</span>

<span class="hljs-comment"># CloudFront → Distributions → Invalidations → Create</span>

<span class="hljs-comment"># Path: /*</span>

</code></pre>
<h4 data-id="heading-18">3. 验证修复</h4>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 等待 5-10 分钟后测试</span>

curl -I <span class="hljs-string">'https://example.com/api/user/sessions'</span> \

    -H <span class="hljs-string">'authorization: Bearer YOUR_TOKEN'</span>

</code></pre>
<p>期望看到：</p>
<pre><code class="hljs language-http" lang="http">
HTTP/2 200

cache-control: private, no-cache, no-store, must-revalidate ✓

pragma: no-cache ✓

expires: 0 ✓

x-cache: Miss from cloudfront ✓

age: (不存在) ✓

</code></pre>
<p>多次请求应该都是 <code>Miss from cloudfront</code>，而不是 <code>Hit</code>。</p>
<hr/>
<h3 data-id="heading-19">📚 深入理解 Cache-Control</h3>
<p>这次事故让我重新审视了 HTTP 缓存机制。让我详细解释一下这些响应头：</p>
<h4 data-id="heading-20">Cache-Control 指令详解</h4>
<pre><code class="hljs language-http" lang="http">
Cache-Control: private, no-cache, no-store, must-revalidate

</code></pre>
<ul>
<li>
<p><strong><code>private</code></strong>：响应只能被浏览器缓存，不能被 CDN 等共享缓存存储</p>
</li>
<li>
<p>即使后续有人设置了代理缓存，也不会缓存这个响应</p>
</li>
<li>
<p><strong><code>no-cache</code></strong>：可以缓存，但使用前必须向服务器验证</p>
</li>
<li>
<p>看起来矛盾？其实是"not without revalidation"的意思</p>
</li>
<li>
<p>主要用于需要实时验证但允许存储的场景</p>
</li>
<li>
<p><strong><code>no-store</code></strong>：完全不缓存，任何情况下都不存储</p>
</li>
<li>
<p>最严格的禁止缓存指令</p>
</li>
<li>
<p>用于高度敏感的数据</p>
</li>
<li>
<p><strong><code>must-revalidate</code></strong>：缓存过期后必须向服务器验证，不能使用过期内容</p>
</li>
<li>
<p>防止在网络故障时使用过期缓存</p>
</li>
</ul>
<h4 data-id="heading-21">Pragma 和 Expires</h4>
<pre><code class="hljs language-http" lang="http">
Pragma: no-cache

Expires: 0

</code></pre>
<p>这两个是为了兼容 HTTP/1.0 的老旧客户端和代理服务器。虽然现在大多数系统都支持 HTTP/1.1，但加上它们没有坏处。</p>
<h4 data-id="heading-22">为什么需要这么多指令？</h4>
<p>因为缓存层级很多：</p>
<pre><code class="hljs">
浏览器缓存

↓

正向代理（公司代理）

↓

CDN 边缘节点

↓

CDN 中心节点

↓

反向代理（Nginx）

↓

后端服务器

</code></pre>
<p>每一层都可能缓存，所以需要明确告诉它们："这个响应不要缓存！"</p>
<hr/>
<h3 data-id="heading-23">🎯 经验教训</h3>
<h4 data-id="heading-24">1. 用户数据永远不要被 CDN 缓存</h4>
<p><strong>原则：需要身份验证的接口 = 私有数据 = 禁止缓存</strong></p>
<p>即使你认为"缓存可以提高性能"，也不要这样做。因为：</p>
<ul>
<li>
<p>用户数据随时可能变化</p>
</li>
<li>
<p>Token 可能被刷新或撤销</p>
</li>
<li>
<p>存在数据泄露风险</p>
</li>
<li>
<p>可能违反数据保护法规（GDPR、CCPA）</p>
</li>
</ul>
<h4 data-id="heading-25">2. 明确区分可缓存和不可缓存的内容</h4>
<p>在设计 API 时，就应该考虑缓存策略：</p>
<pre><code class="hljs language-bash" lang="bash">
✓ 可以缓存：

    /public/articles - 公开文章列表

    /static/logo.png - 静态资源

    /api/public/config - 公开配置

  


✗ 禁止缓存：

    /api/user/* - 用户数据

    /api/auth/* - 认证相关

    /api/admin/* - 管理接口

</code></pre>
<h4 data-id="heading-26">3. 不要依赖 CDN 的默认行为</h4>
<p>CloudFront 的默认缓存策略是：</p>
<ul>
<li>
<p>对 GET/HEAD 请求缓存成功的响应（200、301、404 等）</p>
</li>
<li>
<p>缓存键只包含 URL 和查询参数</p>
</li>
</ul>
<p><strong>这对静态资源很好，但对 API 可能是灾难。</strong></p>
<h4 data-id="heading-27">4. 后端要对响应负责</h4>
<p>不要期望运维或前端来配置正确的缓存策略。后端应该明确告诉客户端和中间层如何处理响应：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-comment">// 好的做法：创建统一的响应函数</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RespondJSON</span><span class="hljs-params">(c *gin.Context, code <span class="hljs-type">int</span>, data <span class="hljs-keyword">interface</span>{})</span></span> {

    <span class="hljs-comment">// 自动添加安全的响应头</span>

    c.Header(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"private, no-cache, no-store, must-revalidate"</span>)

    c.Header(<span class="hljs-string">"Pragma"</span>, <span class="hljs-string">"no-cache"</span>)

    c.Header(<span class="hljs-string">"Expires"</span>, <span class="hljs-string">"0"</span>)

    c.JSON(code, data)

}

</code></pre>
<h4 data-id="heading-28">5. 测试要覆盖缓存场景</h4>
<p>在测试用例中应该包含：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// test/api-cache.test.js</span>

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'API Caching'</span>, <span class="hljs-function">() =&gt;</span> {

    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not cache user data'</span>, <span class="hljs-keyword">async</span> () =&gt; {

        <span class="hljs-comment">// 第一次请求</span>

        <span class="hljs-keyword">const</span> res1 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user/sessions'</span>, {

            <span class="hljs-attr">headers</span>: { <span class="hljs-attr">authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token1}</span>`</span> }

        });

        <span class="hljs-keyword">const</span> data1 = <span class="hljs-keyword">await</span> res1.<span class="hljs-title function_">json</span>();

        <span class="hljs-comment">// 第二次请求（不同用户）</span>

        <span class="hljs-keyword">const</span> res2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user/sessions'</span>, {

            <span class="hljs-attr">headers</span>: { <span class="hljs-attr">authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token2}</span>`</span> }

        });

        <span class="hljs-keyword">const</span> data2 = <span class="hljs-keyword">await</span> res2.<span class="hljs-title function_">json</span>();

        <span class="hljs-comment">// 验证返回的是不同用户的数据</span>

        <span class="hljs-title function_">expect</span>(data1.<span class="hljs-property">userId</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toBe</span>(data2.<span class="hljs-property">userId</span>);

        <span class="hljs-comment">// 验证响应头</span>

        <span class="hljs-title function_">expect</span>(res1.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'cache-control'</span>)).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'no-cache'</span>);

        <span class="hljs-title function_">expect</span>(res2.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'cache-control'</span>)).<span class="hljs-title function_">toContain</span>(<span class="hljs-string">'no-cache'</span>);

    });

    <span class="hljs-title function_">it</span>(<span class="hljs-string">'should not be cached by CDN'</span>, <span class="hljs-keyword">async</span> () =&gt; {

        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user/sessions'</span>, {

        <span class="hljs-attr">headers</span>: { <span class="hljs-attr">authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span> }

        });

        <span class="hljs-comment">// 验证没有命中 CDN 缓存</span>

        <span class="hljs-title function_">expect</span>(res.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'x-cache'</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'Miss from cloudfront'</span>);

        <span class="hljs-title function_">expect</span>(res.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'age'</span>)).<span class="hljs-title function_">toBeNull</span>();

    });

});

</code></pre>
<hr/>
<h3 data-id="heading-29">🔍 排查技巧分享</h3>
<h4 data-id="heading-30">如何快速判断是否是缓存问题？</h4>
<p><strong>1. 查看响应头</strong></p>
<pre><code class="hljs language-bash" lang="bash">
curl -I <span class="hljs-string">'https://example.com/api/user/sessions'</span> \

    -H <span class="hljs-string">'authorization: Bearer TOKEN'</span>

</code></pre>
<p>关键字段：</p>
<ul>
<li>
<p><code>x-cache: Hit</code> - 命中缓存</p>
</li>
<li>
<p><code>age: 数字</code> - 缓存存在的时间</p>
</li>
<li>
<p><code>cache-control: null</code> - 没有缓存策略（危险！）</p>
</li>
</ul>
<p><strong>2. 添加随机参数测试</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 如果这个返回正确数据，说明是缓存问题</span>

<span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/user/sessions?_t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>)

</code></pre>
<p><strong>3. 使用不同的客户端测试</strong></p>
<ul>
<li>
<p>浏览器 → 可能命中缓存</p>
</li>
<li>
<p>curl → 可能绕过缓存</p>
</li>
<li>
<p>Postman → 可能有独立的缓存</p>
</li>
</ul>
<p>如果不同客户端返回不同的数据，很可能是缓存问题。</p>
<h4 data-id="heading-31">使用 Chrome DevTools 检查</h4>
<ol>
<li>
<p>打开 Network 标签</p>
</li>
<li>
<p>刷新页面</p>
</li>
<li>
<p>点击对应的请求</p>
</li>
<li>
<p>查看 Response Headers</p>
</li>
</ol>
<p>重点关注：</p>
<ul>
<li>
<p><code>CF-Cache-Status: HIT</code> (Cloudflare)</p>
</li>
<li>
<p><code>X-Cache: Hit from cloudfront</code> (CloudFront)</p>
</li>
<li>
<p><code>X-Cache-Lookup: HIT from xxx</code> (其他 CDN)</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-32">🛡️ 预防措施</h3>
<h4 data-id="heading-33">1. 建立监控告警</h4>
<p><strong>监控指标</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// CloudWatch Logs Insights 查询</span>

fields @timestamp, request_path, cache_status

| filter cache_status = <span class="hljs-string">"Hit"</span>

and request_path like /^\/api\<span class="hljs-comment">//</span>

and request_path not like /^\/api\/public\<span class="hljs-comment">//</span>

| stats <span class="hljs-title function_">count</span>() by request_path

</code></pre>
<p><strong>告警规则</strong>：</p>
<ul>
<li>
<p>如果私有 API 出现缓存命中 → 立即告警</p>
</li>
<li>
<p>如果 API 响应缺少 <code>Cache-Control</code> 头 → 告警</p>
</li>
</ul>
<h4 data-id="heading-34">2. 代码审查检查项</h4>
<p>在 Code Review 时，检查：</p>
<ul class="contains-task-list">
<li class="task-list-item">
<p><input type="checkbox" disabled="disabled"/> 新的 API endpoint 是否添加了 no-cache 响应头？</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled="disabled"/> 是否使用了统一的响应函数？</p>
</li>
<li class="task-list-item">
<p><input type="checkbox" disabled="disabled"/> 是否有测试覆盖缓存场景？</p>
</li>
</ul>
<h4 data-id="heading-35">3. 架构层面的防护</h4>
<p><strong>前端服务器添加安全响应头</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// next.config.js</span>

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {

    <span class="hljs-keyword">async</span> <span class="hljs-title function_">headers</span>(<span class="hljs-params"/>) {

        <span class="hljs-keyword">return</span> [

            {

                <span class="hljs-attr">source</span>: <span class="hljs-string">'/api/:path*'</span>,

                <span class="hljs-attr">headers</span>: [

                    {

                        <span class="hljs-attr">key</span>: <span class="hljs-string">'Cache-Control'</span>,

                        <span class="hljs-attr">value</span>: <span class="hljs-string">'private, no-cache, no-store, must-revalidate'</span>,

                    },

                ],

            },

        ];

    },

};

</code></pre>
<p>这样即使后端忘记设置，前端也会添加安全的响应头（双重保险）。</p>
<h4 data-id="heading-36">4. 定期安全审计</h4>
<p>每个季度检查：</p>
<ul>
<li>
<p>哪些 API 可以被缓存？</p>
</li>
<li>
<p>缓存的内容是否包含敏感信息？</p>
</li>
<li>
<p>CDN 配置是否正确？</p>
</li>
<li>
<p>是否有新的 API 没有设置缓存策略？</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-37">📊 影响分析</h3>
<p>这次事故的影响范围：</p>
<h4 data-id="heading-38">受影响的接口</h4>
<p>我们排查了所有 API，发现以下接口都有同样的问题：</p>
<pre><code class="hljs language-bash" lang="bash">
✓ 已修复：

/api/user/sessions - 用户会话列表

/api/user/quota - 用户配额

/api/user/profile - 用户资料

/api/user/settings - 用户设置

</code></pre>
<h4 data-id="heading-39">潜在的数据泄露</h4>
<ul>
<li>
<p><strong>时间窗口</strong>：从部署到发现，约 2 周</p>
</li>
<li>
<p><strong>受影响用户</strong>：所有活跃用户</p>
</li>
<li>
<p><strong>泄露数据类型</strong>：会话信息、配额使用情况、用户设置</p>
</li>
<li>
<p><strong>严重程度</strong>：高（虽然没有密码等核心数据，但仍然是隐私信息）</p>
</li>
</ul>
<h4 data-id="heading-40">合规性问题</h4>
<p>根据 GDPR 和 CCPA：</p>
<ul>
<li>
<p>用户数据被缓存在第三方服务器（CloudFront 边缘节点）</p>
</li>
<li>
<p>用户没有被告知数据会被如此处理</p>
</li>
<li>
<p>存在未经授权的数据访问</p>
</li>
</ul>
<p>幸运的是，我们在测试环境发现了这个问题，没有影响到生产环境。</p>
<hr/>
<h3 data-id="heading-41">💭 反思</h3>
<h4 data-id="heading-42">为什么会犯这个错误？</h4>
<ol>
<li><strong>对 CDN 的理解不够深入</strong></li>
</ol>
<ul>
<li>
<p>我们知道 CDN 会缓存，但没想到会缓存 API 响应</p>
</li>
<li>
<p>以为"有 Authorization header 就不会缓存"</p>
</li>
</ul>
<ol start="2">
<li><strong>缺少完整的测试</strong></li>
</ol>
<ul>
<li>
<p>功能测试只关注"能否返回正确数据"</p>
</li>
<li>
<p>没有测试"不同用户是否会看到彼此的数据"</p>
</li>
</ul>
<ol start="3">
<li><strong>架构变更时没有充分评估</strong></li>
</ol>
<ul>
<li>
<p>引入 CloudFront 时，只考虑了性能提升</p>
</li>
<li>
<p>没有评估对 API 的影响</p>
</li>
</ul>
<ol start="4">
<li><strong>缺少安全意识</strong></li>
</ol>
<ul>
<li>
<p>没有建立"默认禁止缓存私有数据"的原则</p>
</li>
<li>
<p>没有代码规范要求必须设置 Cache-Control</p>
</li>
</ul>
<h4 data-id="heading-43">如果重来一次，我会怎么做？</h4>
<ol>
<li><strong>在架构设计阶段就明确缓存策略</strong></li>
</ol>
<pre><code class="hljs">
静态资源 → CDN 缓存

公开 API → CDN 缓存（短时间）

私有 API → 禁止缓存

</code></pre>
<ol start="2">
<li><strong>建立统一的响应规范</strong></li>
</ol>
<ul>
<li>
<p>创建标准的响应函数</p>
</li>
<li>
<p>自动添加正确的响应头</p>
</li>
<li>
<p>不允许手动设置响应头</p>
</li>
</ul>
<ol start="3">
<li><strong>完善测试覆盖</strong></li>
</ol>
<ul>
<li>
<p>添加缓存测试用例</p>
</li>
<li>
<p>添加跨用户数据隔离测试</p>
</li>
<li>
<p>在 CI/CD 中检查响应头</p>
</li>
</ul>
<ol start="4">
<li><strong>部署前的安全审计</strong></li>
</ol>
<ul>
<li>
<p>检查所有新的 API endpoint</p>
</li>
<li>
<p>验证响应头是否正确</p>
</li>
<li>
<p>使用不同用户 token 测试</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-44">🎓 拓展阅读</h3>
<h4 data-id="heading-45">关于 HTTP 缓存</h4>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTTP%2FCaching" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching" ref="nofollow noopener noreferrer">MDN - HTTP 缓存</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7234" target="_blank" title="https://tools.ietf.org/html/rfc7234" ref="nofollow noopener noreferrer">RFC 7234 - HTTP/1.1 Caching</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Fhttp-cache%2F" target="_blank" title="https://web.dev/http-cache/" ref="nofollow noopener noreferrer">Web.dev - HTTP Caching</a></p>
</li>
</ul>
<h4 data-id="heading-46">关于 CloudFront</h4>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2FAmazonCloudFront%2Flatest%2FDeveloperGuide%2Fcontrolling-the-cache-key.html" target="_blank" title="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/controlling-the-cache-key.html" ref="nofollow noopener noreferrer">CloudFront 缓存键和策略</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.aws.amazon.com%2FAmazonCloudFront%2Flatest%2FDeveloperGuide%2FResponseHeadersPolicies.html" target="_blank" title="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/ResponseHeadersPolicies.html" ref="nofollow noopener noreferrer">CloudFront 响应头策略</a></p>
</li>
</ul>
<h4 data-id="heading-47">关于 Web 安全</h4>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fowasp.org%2Fwww-project-top-ten%2F" target="_blank" title="https://owasp.org/www-project-top-ten/" ref="nofollow noopener noreferrer">OWASP Top 10</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fowasp.org%2Fwww-project-api-security%2F" target="_blank" title="https://owasp.org/www-project-api-security/" ref="nofollow noopener noreferrer">OWASP API Security Top 10</a></p>
</li>
</ul>
<hr/>
<h3 data-id="heading-48">✨ 总结</h3>
<p>这次事故给我上了深刻的一课：</p>
<p><strong>1. CDN 是双刃剑</strong></p>
<ul>
<li>
<p>能提升性能，但配置不当会导致严重的安全问题</p>
</li>
<li>
<p>理解 CDN 的缓存机制是必须的</p>
</li>
</ul>
<p><strong>2. 后端要明确告诉客户端如何处理响应</strong></p>
<ul>
<li>
<p>不要依赖默认行为</p>
</li>
<li>
<p>使用 <code>Cache-Control</code> 明确控制缓存策略</p>
</li>
</ul>
<p><strong>3. 安全测试很重要</strong></p>
<ul>
<li>
<p>功能测试 + 安全测试</p>
</li>
<li>
<p>不同用户的数据隔离测试</p>
</li>
</ul>
<p><strong>4. 建立防护机制</strong></p>
<ul>
<li>
<p>监控告警</p>
</li>
<li>
<p>代码规范</p>
</li>
<li>
<p>自动化检查</p>
</li>
</ul>
<h4 data-id="heading-49">核心原则</h4>
<blockquote>
<p><strong>需要身份验证的 API，永远不要被 CDN 缓存。</strong></p>
</blockquote>
<p>如果你的系统也使用了 CloudFront、Cloudflare 或其他 CDN，建议立即检查一下你的 API 响应头。方法很简单：</p>
<pre><code class="hljs language-bash" lang="bash">
curl -I <span class="hljs-string">'https://your-api.com/api/user/data'</span> \

-H <span class="hljs-string">'authorization: Bearer YOUR_TOKEN'</span> \

| grep -i cache

</code></pre>
<p>如果看到 <code>x-cache: Hit</code> 或者 <code>cache-control: null</code>，那你可能也面临同样的问题。</p>
<hr/>
<h3 data-id="heading-50">🙏 致谢</h3>
<p>感谢 QA 团队发现了这个问题，感谢团队快速响应和修复。这次事故虽然是在测试环境发现的，但也提醒我们：</p>
<p><strong>再小的问题也可能导致严重的后果，安全无小事。</strong></p>
<hr/>
<p><strong>你遇到过类似的缓存问题吗？欢迎在评论区分享你的经验。</strong></p>
<hr/>
<p><em>本文技术栈：CloudFront + Next.js + Go，但原理适用于所有 CDN + API 的架构。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Chrome 浏览器底层架构学习笔记（补充篇）]]></title>    <link>https://juejin.cn/post/7603309951226298418</link>    <guid>https://juejin.cn/post/7603309951226298418</guid>    <pubDate>2026-02-06T05:35:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603309951226298418" data-draft-id="7603283691457101834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Chrome 浏览器底层架构学习笔记（补充篇）"/> <meta itemprop="keywords" content="Chrome"/> <meta itemprop="datePublished" content="2026-02-06T05:35:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不会敲代码1"/> <meta itemprop="url" content="https://juejin.cn/user/1927884034804425"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Chrome 浏览器底层架构学习笔记（补充篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1927884034804425/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不会敲代码1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T05:35:00.000Z" title="Fri Feb 06 2026 05:35:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Chrome 浏览器底层架构学习笔记（补充篇）</h2>
<h3 data-id="heading-1">九、进程与线程的执行模式对比</h3>
<p>在理解 Chrome 的多进程架构时，理解<strong>单线程</strong>与<strong>多线程</strong>的执行差异至关重要。</p>
<h4 data-id="heading-2">1. 单线程处理模型（进程 A）</h4>
<p>在单线程模型中，所有任务都按顺序在一个线程中执行：</p>
<pre><code class="hljs language-css" lang="css">时间线：任务<span class="hljs-number">1</span> → 任务<span class="hljs-number">2</span> → 任务<span class="hljs-number">3</span> → 任务<span class="hljs-number">4</span> → 显示结果
       <span class="hljs-selector-attr">[主线程依次执行所有任务]</span>
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>简单易实现，避免并发冲突</li>
<li>但 CPU 利用率低，一个耗时任务会阻塞后续所有任务</li>
<li>早期的 JavaScript 执行环境采用这种模型</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13c194f611b743368f3a55cf549f46ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Lya5pWy5Luj56CBMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770960901&amp;x-signature=OLc55NTHjgwFBRFUUOQWxFwd0uw%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">2. 多线程处理模型（进程 B）</h4>
<p>在多线程模型中，任务可以并行分配给不同线程：</p>
<pre><code class="hljs language-scss" lang="scss">时间线：
线程<span class="hljs-number">1</span>：任务<span class="hljs-number">1</span>(<span class="hljs-number">1</span>+<span class="hljs-number">2</span>)
线程<span class="hljs-number">2</span>：任务<span class="hljs-number">2</span>(<span class="hljs-number">20</span>/<span class="hljs-number">5</span>)
线程<span class="hljs-number">3</span>：任务<span class="hljs-number">3</span>(<span class="hljs-number">7</span>*<span class="hljs-number">8</span>)
<span class="hljs-selector-attr">[所有线程并行执行]</span>
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>充分利用多核 CPU，提高执行效率</li>
<li>复杂任务可并行处理，减少总执行时间</li>
<li>但需要处理线程同步和资源竞争问题</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f70352a512dd44e9b7d5ec05a7914ad0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Lya5pWy5Luj56CBMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770960901&amp;x-signature=NtxnAszYK45k%2FiNSLqB9fOQSa28%3D" alt="image.png" loading="lazy"/></p>
<p><strong>示例计算任务：</strong></p>
<ul>
<li>任务1: 1+2 = 3</li>
<li>任务2: 20/5 = 4</li>
<li>任务3: 7*8 = 56</li>
</ul>
<p>在单线程中，这三个计算需要顺序执行；而在多线程中，它们可以同时进行。</p>
<h3 data-id="heading-4">十、线程间的数据共享与通信</h3>
<p>多线程模型中，一个重要概念是<strong>线程共享进程资源</strong>。这意味着：</p>
<h4 data-id="heading-5">1. 共享内存空间</h4>
<p>多个线程可以访问进程的同一内存区域，这需要<strong>线程同步机制</strong>来避免数据冲突。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af581f23796146f38da2e5cd5bfe1f51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Lya5pWy5Luj56CBMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770960901&amp;x-signature=huKVHvRa5HYs%2BFjdlJwR1AegOMQ%3D" alt="屏幕截图 2026-02-05 191232.png" loading="lazy"/></p>
<h4 data-id="heading-6">2. 线程同步示例</h4>
<p>如示意图所示，当多个线程需要写入共享变量"A"时：</p>
<ul>
<li>线程1可能写入值3</li>
<li>线程2可能执行1+2的计算</li>
<li>需要同步机制确保数据一致性</li>
</ul>
<h3 data-id="heading-7">十一、单进程浏览器 vs 多进程浏览器</h3>
<h4 data-id="heading-8">1. 单进程浏览器架构</h4>
<p>早期的浏览器（如旧版 IE）采用单进程架构：</p>
<pre><code class="hljs language-markdown" lang="markdown">单进程浏览器
├── 代码区
├── 数据区
├── 文件区
└── 线程：
<span class="hljs-code">    ├── 网络线程
    ├── 页面线程（核心）
    │   ├── 页面渲染
    │   ├── 页面展现
    │   ├── JavaScript环境
    │   └── 插件运行
    └── 其他线程
</span></code></pre>
<p><strong>问题：</strong></p>
<ul>
<li><strong>稳定性差</strong>：一个标签页崩溃会导致整个浏览器崩溃</li>
<li><strong>安全性低</strong>：恶意页面可能访问其他页面数据</li>
<li><strong>性能瓶颈</strong>：所有任务共享同一个进程资源</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c24db6861d56469289bb264cc6244355~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Lya5pWy5Luj56CBMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770960901&amp;x-signature=J7SYwwz2fYgchgTMuwDQHc2230c%3D" alt="屏幕截图 2026-02-05 191958.png" loading="lazy"/></p>
<h4 data-id="heading-9">2. 现代 Chrome 的多进程架构</h4>
<p>Chrome 将不同功能模块拆分为独立的进程：</p>
<pre><code class="hljs language-scss" lang="scss">Chrome 多进程架构：
┌─────────────────────────────────────┐
│        浏览器主进程                  │
│  (Browser Process)                  │
│  • 界面管理                         │
│  • 用户交互                         │
│  • 子进程管理                       │
└───────────┬─────────────────────────┘
            │ IPC通信
┌───────────┼─────────────────────────┐
│ 渲染进程  │  网络进程   │  GPU进程   │
│ (多个)    │ (独立)     │ (独立)     │
│ • 页面渲染│ • 资源加载 │ • 图形处理 │
│ • JS执行  │           │ • <span class="hljs-number">3</span>D加速   │
└───────────┴───────────┴─────────────┘
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li><strong>稳定性增强</strong>：单个页面崩溃不影响其他页面</li>
<li><strong>安全性提升</strong>：进程间内存隔离，沙箱机制</li>
<li><strong>性能优化</strong>：专用进程处理专门任务</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/686169a0bdce47329575fdbfdd5bd3ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Lya5pWy5Luj56CBMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770960901&amp;x-signature=JKebnXHIlJIpphelL2SgBUodkAQ%3D" alt="屏幕截图 2026-02-05 193001.png" loading="lazy"/></p>
<h3 data-id="heading-10">十二、Chrome 进程架构演进细节</h3>
<h4 data-id="heading-11">1. 进程独立化趋势</h4>
<p>Chrome 在发展过程中，逐渐将关键功能从浏览器主进程中独立出来：</p>
<ul>
<li><strong>网络进程</strong>：原本属于浏览器进程，现独立以优化网络请求处理</li>
<li><strong>GPU进程</strong>：为支持更复杂的图形渲染和硬件加速而独立</li>
<li><strong>存储进程</strong>：专门处理本地存储和缓存</li>
</ul>
<h4 data-id="heading-12">2. 沙箱（Sandbox）安全机制</h4>
<p>在支持的系统上，Chrome 为渲染进程等启用沙箱机制：</p>
<ul>
<li>限制进程的权限，防止恶意代码访问系统资源</li>
<li>即使渲染进程被攻破，攻击者也难以突破沙箱限制</li>
</ul>
<h3 data-id="heading-13">十三、对前端开发的启示</h3>
<h4 data-id="heading-14">1. 性能优化策略</h4>
<ul>
<li><strong>减少主线程阻塞</strong>：避免长时间的 JavaScript 计算</li>
<li><strong>合理使用 Web Workers</strong>：将计算密集型任务移至后台线程</li>
<li><strong>注意内存管理</strong>：页面关闭时进程会释放内存，但长时间运行的 SPA 需注意内存泄漏</li>
</ul>
<h4 data-id="heading-15">2. 调试技巧</h4>
<ul>
<li>使用 Chrome 任务管理器识别内存泄漏</li>
<li>通过 <code>chrome://process-internals</code> 查看详细进程信息</li>
<li>利用 Performance 面板分析页面线程活动</li>
</ul>
<h3 data-id="heading-16">十四、总结：Chrome 架构设计的演进思想</h3>
<p>Chrome 的多进程架构代表了现代浏览器的发展方向：</p>
<ol>
<li><strong>模块化</strong>：将复杂系统拆分为独立的、功能单一的模块</li>
<li><strong>隔离性</strong>：通过进程隔离提高安全性和稳定性</li>
<li><strong>专业化</strong>：专用进程处理专门任务，提高效率</li>
<li><strong>可扩展性</strong>：便于添加新功能和优化现有模块</li>
</ol>
<p>这种架构虽然增加了内存开销，但换来了更好的用户体验和更高的安全性，这也是 Chrome 能成为主流浏览器的重要原因。</p>
<hr/>
<p>理解这些底层原理不仅有助于调试和优化网页性能，也能让我们更好地理解现代 Web 技术栈的设计思想，为构建高性能 Web 应用打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android系统APN(Access Point Name)加载流程详解]]></title>    <link>https://juejin.cn/post/7603294029531660339</link>    <guid>https://juejin.cn/post/7603294029531660339</guid>    <pubDate>2026-02-06T05:23:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603294029531660339" data-draft-id="7603263490342453257" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android系统APN(Access Point Name)加载流程详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T05:23:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android系统APN(Access Point Name)加载流程详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T05:23:56.000Z" title="Fri Feb 06 2026 05:23:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>基于代码分析，我将详细讲解Android系统如何加载和管理APN配置。</p>
<h3 data-id="heading-0">整体架构</h3>
<pre><code class="hljs">APN配置文件 → XML解析 → 数据库存储 → 应用程序查询
</code></pre>
<hr/>
<h3 data-id="heading-1">第一阶段：APN配置文件来源</h3>
<h4 data-id="heading-2">1.1 文件存储位置（优先级顺序）</h4>
<p>TelephonyProvider查找APN配置文件时按照以下优先级顺序：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// TelephonyProvider.java: 887-896 行</span>
private File <span class="hljs-title function_">getApnConfFile</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 1. 默认系统文件 (最低优先级)</span>
    File confFile = new File(Environment.getRootDirectory(), PARTNER_APNS_PATH);
    <span class="hljs-comment">// = /system/etc/apns-conf.xml</span>
    
    <span class="hljs-comment">// 2. OEM定制文件 (更高优先级)</span>
    File oemConfFile = new File(Environment.getOemDirectory(), OEM_APNS_PATH);
    <span class="hljs-comment">// = /oem/telephony/apns-conf.xml</span>
    
    <span class="hljs-comment">// 3. 产品配置文件</span>
    File productConfFile = new File(Environment.getProductDirectory(), PARTNER_APNS_PATH);
    <span class="hljs-comment">// = /product/etc/apns-conf.xml</span>
    
    <span class="hljs-comment">// 4. OTA更新文件 (最高优先级)</span>
    File updatedConfFile = new File(Environment.getDataDirectory(), OTA_UPDATED_APNS_PATH);
    <span class="hljs-comment">// = /data/misc/apns/apns-conf.xml</span>
    
    <span class="hljs-comment">// 按优先级选择</span>
    confFile = pickSecondIfExists(confFile, oemConfFile);
    confFile = pickSecondIfExists(confFile, productConfFile);
    confFile = pickSecondIfExists(confFile, updatedConfFile);  <span class="hljs-comment">// 最终优先级最高</span>
    <span class="hljs-keyword">return</span> confFile;
}
</code></pre>
<p><strong>优先级关系：</strong></p>
<pre><code class="hljs">OTA文件 &gt; 产品文件 &gt; OEM文件 &gt; 系统默认文件
</code></pre>
<h4 data-id="heading-3">1.2 文件结构</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">apns</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"8"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 每条APN配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">apn</span>
        <span class="hljs-attr">mcc</span>=<span class="hljs-string">"310"</span>
        <span class="hljs-attr">mnc</span>=<span class="hljs-string">"04"</span>
        <span class="hljs-attr">carrier</span>=<span class="hljs-string">"Verizon"</span>
        <span class="hljs-attr">apn</span>=<span class="hljs-string">"vzwinternet"</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"default,hipri"</span>
        <span class="hljs-attr">protocol</span>=<span class="hljs-string">"IP"</span>
        <span class="hljs-attr">roaming_protocol</span>=<span class="hljs-string">"IP"</span>
        <span class="hljs-attr">proxy</span>=<span class="hljs-string">"0.0.0.0"</span>
        <span class="hljs-attr">port</span>=<span class="hljs-string">"0"</span>
        <span class="hljs-attr">mmsproxy</span>=<span class="hljs-string">"0.0.0.0"</span>
        <span class="hljs-attr">mmsport</span>=<span class="hljs-string">"0"</span>
        <span class="hljs-attr">mmsc</span>=<span class="hljs-string">""</span>
        <span class="hljs-attr">carrier_enabled</span>=<span class="hljs-string">"true"</span>
        <span class="hljs-attr">user_editable</span>=<span class="hljs-string">"true"</span>
        <span class="hljs-attr">user_visible</span>=<span class="hljs-string">"true"</span>
        <span class="hljs-attr">authtype</span>=<span class="hljs-string">"3"</span>
        <span class="hljs-attr">bearer_bitmask</span>=<span class="hljs-string">"0"</span>
    /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">apns</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">第二阶段：初始化阶段</h3>
<h4 data-id="heading-5">2.1 数据库初始化时机</h4>
<p>当TelephonyProvider首次启动或数据库版本变化时，触发初始化：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 918-998 行</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initDatabase</span><span class="hljs-params">(SQLiteDatabase db)</span> {
    <span class="hljs-comment">// 步骤1：加载系统内置APN</span>
    <span class="hljs-comment">// 步骤2：加载OEM/Partner提供的APN</span>
    <span class="hljs-comment">// 步骤3：清理已删除的APN</span>
}
</code></pre>
<h4 data-id="heading-6">2.2 校验和检查</h4>
<p>为了避免不必要的数据库重新加载，系统使用校验和机制：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 905-911 行</span>
<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">apnDbUpdateNeeded</span><span class="hljs-params">()</span> {
    <span class="hljs-type">File</span> <span class="hljs-variable">confFile</span> <span class="hljs-operator">=</span> getApnConfFile();
    <span class="hljs-type">long</span> <span class="hljs-variable">newChecksum</span> <span class="hljs-operator">=</span> getChecksum(confFile);        <span class="hljs-comment">// 计算新校验和</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">oldChecksum</span> <span class="hljs-operator">=</span> getApnConfChecksum();         <span class="hljs-comment">// 读取旧校验和</span>
    
    <span class="hljs-keyword">if</span> (DBG) log(<span class="hljs-string">"newChecksum: "</span> + newChecksum);
    <span class="hljs-keyword">if</span> (DBG) log(<span class="hljs-string">"oldChecksum: "</span> + oldChecksum);
    
    <span class="hljs-keyword">return</span> newChecksum != oldChecksum;  <span class="hljs-comment">// 校验和不同则需要更新</span>
}
</code></pre>
<p><strong>存储位置：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SharedPreferences中</span>
<span class="hljs-type">SharedPreferences</span> <span class="hljs-variable">sp</span> <span class="hljs-operator">=</span> mContext.getSharedPreferences(PREF_FILE, Context.MODE_PRIVATE);
sp.getLong(APN_CONF_CHECKSUM, -<span class="hljs-number">1</span>);  <span class="hljs-comment">// "apn_conf_checksum"</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">第三阶段：加载流程</h3>
<h4 data-id="heading-8">3.1 两层APN数据源</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 918-936 行</span>
<span class="hljs-comment">// 第一层：系统内置APN</span>
<span class="hljs-type">Resources</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> mContext.getResources();
<span class="hljs-type">XmlResourceParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> r.getXml(com.android.internal.R.xml.apns);
<span class="hljs-keyword">try</span> {
    XmlUtils.beginDocument(parser, <span class="hljs-string">"apns"</span>);
    <span class="hljs-type">int</span> <span class="hljs-variable">publicversion</span> <span class="hljs-operator">=</span> Integer.parseInt(parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"version"</span>));
    loadApns(db, parser, <span class="hljs-literal">true</span>);  <span class="hljs-comment">// 加载内置APN (isOverlay=true)</span>
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 第二层：OEM/Partner提供的APN</span>
<span class="hljs-type">File</span> <span class="hljs-variable">confFile</span> <span class="hljs-operator">=</span> getApnConfFile();
<span class="hljs-type">FileReader</span> <span class="hljs-variable">confreader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(confFile);
<span class="hljs-type">XmlPullParser</span> <span class="hljs-variable">confparser</span> <span class="hljs-operator">=</span> Xml.newPullParser();
confparser.setInput(confreader);

<span class="hljs-comment">// 版本校验：内置版本必须与外部配置版本一致</span>
<span class="hljs-type">int</span> <span class="hljs-variable">confversion</span> <span class="hljs-operator">=</span> Integer.parseInt(confparser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"version"</span>));
<span class="hljs-keyword">if</span> (publicversion != confversion) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Internal APNS file version doesn't match"</span>);
}

loadApns(db, confparser, <span class="hljs-literal">false</span>);  <span class="hljs-comment">// 加载外部APN (isOverlay=false)</span>
</code></pre>
<h4 data-id="heading-9">3.2 XML解析和数据提取</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 2716-2831 行</span>
<span class="hljs-keyword">private</span> ContentValues <span class="hljs-title function_">getRow</span><span class="hljs-params">(XmlPullParser parser, <span class="hljs-type">boolean</span> isOverlay)</span> {
    <span class="hljs-type">ContentValues</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();
    
    <span class="hljs-comment">// 必需字段：MCC/MNC</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">mcc</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"mcc"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">mnc</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"mnc"</span>);
    <span class="hljs-type">String</span> <span class="hljs-variable">numeric</span> <span class="hljs-operator">=</span> mcc + mnc;  <span class="hljs-comment">// 如: "31004" (Verizon)</span>
    
    map.put(NUMERIC, numeric);
    map.put(MCC, mcc);
    map.put(MNC, mnc);
    
    <span class="hljs-comment">// 基本信息</span>
    map.put(NAME, parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"carrier"</span>));
    map.put(APN, parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"apn"</span>));
    
    <span class="hljs-comment">// 网络参数</span>
    addStringAttribute(parser, <span class="hljs-string">"proxy"</span>, map, PROXY);
    addStringAttribute(parser, <span class="hljs-string">"port"</span>, map, PORT);
    
    <span class="hljs-comment">// MMS参数</span>
    addStringAttribute(parser, <span class="hljs-string">"mmsproxy"</span>, map, MMSPROXY);
    addStringAttribute(parser, <span class="hljs-string">"mmsport"</span>, map, MMSPORT);
    addStringAttribute(parser, <span class="hljs-string">"mmsc"</span>, map, MMSC);
    
    <span class="hljs-comment">// 认证信息</span>
    addStringAttribute(parser, <span class="hljs-string">"user"</span>, map, USER);
    addStringAttribute(parser, <span class="hljs-string">"password"</span>, map, PASSWORD);
    addIntAttribute(parser, <span class="hljs-string">"authtype"</span>, map, AUTH_TYPE);
    
    <span class="hljs-comment">// APN类型 (default, mms, supl, hipri, fota, ims, ia, dun等)</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">apnType</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"type"</span>);
    <span class="hljs-keyword">if</span> (apnType != <span class="hljs-literal">null</span>) {
        apnType = apnType.replaceAll(<span class="hljs-string">"\\s+"</span>, <span class="hljs-string">""</span>);  <span class="hljs-comment">// 移除空格</span>
        map.put(TYPE, apnType);
    }
    
    <span class="hljs-comment">// 协议配置</span>
    addStringAttribute(parser, <span class="hljs-string">"protocol"</span>, map, PROTOCOL);              <span class="hljs-comment">// IP/IPV6/IPV4V6</span>
    addStringAttribute(parser, <span class="hljs-string">"roaming_protocol"</span>, map, ROAMING_PROTOCOL);
    
    <span class="hljs-comment">// 网络技术支持</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">networkTypeBitmask</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">networkTypeList</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"network_type_bitmask"</span>);
    <span class="hljs-keyword">if</span> (networkTypeList != <span class="hljs-literal">null</span>) {
        networkTypeBitmask = getBitmaskFromString(networkTypeList);
    }
    map.put(NETWORK_TYPE_BITMASK, networkTypeBitmask);
    
    <span class="hljs-comment">// 承载网络类型</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">bearerBitmask</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">bearerList</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"bearer_bitmask"</span>);
    <span class="hljs-keyword">if</span> (bearerList != <span class="hljs-literal">null</span>) {
        bearerBitmask = getBitmaskFromString(bearerList);
    }
    map.put(BEARER_BITMASK, bearerBitmask);
    
    <span class="hljs-comment">// 高级配置</span>
    addBoolAttribute(parser, <span class="hljs-string">"carrier_enabled"</span>, map, CARRIER_ENABLED);
    addBoolAttribute(parser, <span class="hljs-string">"user_visible"</span>, map, USER_VISIBLE);
    addBoolAttribute(parser, <span class="hljs-string">"user_editable"</span>, map, USER_EDITABLE);
    addBoolAttribute(parser, <span class="hljs-string">"modem_cognitive"</span>, map, MODEM_PERSIST);
    addBoolAttribute(parser, <span class="hljs-string">"always_on"</span>, map, ALWAYS_ON);
    
    <span class="hljs-comment">// MVNO配置 (虚拟运营商)</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">mvno_type</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"mvno_type"</span>);
    <span class="hljs-keyword">if</span> (mvno_type != <span class="hljs-literal">null</span>) {
        <span class="hljs-type">String</span> <span class="hljs-variable">mvno_match_data</span> <span class="hljs-operator">=</span> parser.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">"mvno_match_data"</span>);
        <span class="hljs-keyword">if</span> (mvno_match_data != <span class="hljs-literal">null</span>) {
            map.put(MVNO_TYPE, mvno_type);        <span class="hljs-comment">// gid, spn, imsi等</span>
            map.put(MVNO_MATCH_DATA, mvno_match_data);
        }
    }
    
    <span class="hljs-keyword">return</span> map;
}
</code></pre>
<p><strong>提取的关键字段：</strong></p>


















































<table><thead><tr><th>字段名</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td>numeric</td><td>MCC+MNC</td><td>31004 (Verizon)</td></tr><tr><td>apn</td><td>接入点名称</td><td>vzwinternet</td></tr><tr><td>type</td><td>APN类型</td><td>default,hipri,mms</td></tr><tr><td>protocol</td><td>协议</td><td>IP/IPV6/IPV4V6</td></tr><tr><td>proxy</td><td>代理地址</td><td>0.0.0.0</td></tr><tr><td>mmsc</td><td>MMS中心地址</td><td><a href="https://link.juejin.cn?target=http%3A%2F%2Fmms.verizon.com" target="_blank" title="http://mms.verizon.com" ref="nofollow noopener noreferrer">mms.verizon.com</a></td></tr><tr><td>user/password</td><td>认证凭证</td><td>(可选)</td></tr><tr><td>bearer_bitmask</td><td>网络技术</td><td>LTE, 3G等</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10">第四阶段：数据库插入</h3>
<h4 data-id="heading-11">4.1 事务化插入</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 2865-2888 行</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadApns</span><span class="hljs-params">(SQLiteDatabase db, XmlPullParser parser, <span class="hljs-type">boolean</span> isOverlay)</span> {
    <span class="hljs-keyword">if</span> (parser != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">try</span> {
            db.beginTransaction();  <span class="hljs-comment">// 开始事务</span>
            XmlUtils.nextElement(parser);
            
            <span class="hljs-comment">// 循环解析每条APN</span>
            <span class="hljs-keyword">while</span> (parser.getEventType() != XmlPullParser.END_DOCUMENT) {
                <span class="hljs-type">ContentValues</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> getRow(parser, isOverlay);  <span class="hljs-comment">// 解析一条APN</span>
                <span class="hljs-keyword">if</span> (row == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlPullParserException</span>(<span class="hljs-string">"Expected 'apn' tag"</span>, parser, <span class="hljs-literal">null</span>);
                }
                insertAddingDefaults(db, row);  <span class="hljs-comment">// 插入数据库</span>
                XmlUtils.nextElement(parser);
            }
            
            db.setTransactionSuccessful();  <span class="hljs-comment">// 提交事务</span>
        } <span class="hljs-keyword">catch</span> (XmlPullParserException | IOException | SQLException e) {
            <span class="hljs-comment">// 异常处理</span>
        } <span class="hljs-keyword">finally</span> {
            db.endTransaction();
        }
    }
}
</code></pre>
<h4 data-id="heading-12">4.2 冲突处理</h4>
<p>当APN已存在时，系统采用合并策略：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 2891-2931 行</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertAddingDefaults</span><span class="hljs-params">(SQLiteDatabase db, ContentValues row)</span> {
    row = setDefaultValue(row);  <span class="hljs-comment">// 设置默认值</span>
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 尝试插入 (CONFLICT_ABORT: 如果冲突则中止)</span>
        db.insertWithOnConflict(CARRIERS_TABLE, <span class="hljs-literal">null</span>, row, SQLiteDatabase.CONFLICT_ABORT);
    } <span class="hljs-keyword">catch</span> (SQLException e) {
        <span class="hljs-comment">// 插入失败 - 检查是否存在冲突的APN</span>
        <span class="hljs-type">Cursor</span> <span class="hljs-variable">oldRow</span> <span class="hljs-operator">=</span> selectConflictingRow(db, CARRIERS_TABLE, row);
        <span class="hljs-keyword">if</span> (oldRow != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">ContentValues</span> <span class="hljs-variable">mergedValues</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();
            <span class="hljs-type">int</span> <span class="hljs-variable">edited</span> <span class="hljs-operator">=</span> oldRow.getInt(oldRow.getColumnIndex(EDITED_STATUS));
            
            <span class="hljs-comment">// 处理编辑状态</span>
            <span class="hljs-keyword">if</span> (edited == USER_DELETED) {
                <span class="hljs-comment">// 用户删除但在XML中存在 -&gt; 标记为 USER_DELETED_BUT_PRESENT_IN_XML</span>
                edited = USER_DELETED_BUT_PRESENT_IN_XML;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (edited == CARRIER_DELETED) {
                edited = CARRIER_DELETED_BUT_PRESENT_IN_XML;
            }
            mergedValues.put(EDITED_STATUS, edited);
            
            <span class="hljs-comment">// 合并字段并更新数据库</span>
            mergeFieldsAndUpdateDb(db, CARRIERS_TABLE, oldRow, row, 
                                   mergedValues, <span class="hljs-literal">false</span>, mContext);
        }
    }
}
</code></pre>
<h4 data-id="heading-13">4.3 APN编辑状态</h4>
<p>系统跟踪APN的编辑状态：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java</span>
UNEDITED = <span class="hljs-number">0</span>                                    <span class="hljs-comment">// 未编辑（系统APN）</span>
USER_EDITED = <span class="hljs-number">1</span>                                <span class="hljs-comment">// 用户编辑</span>
USER_DELETED = <span class="hljs-number">2</span>                               <span class="hljs-comment">// 用户删除</span>
CARRIER_EDITED = <span class="hljs-number">3</span>                             <span class="hljs-comment">// 运营商编辑</span>
CARRIER_DELETED = <span class="hljs-number">4</span>                            <span class="hljs-comment">// 运营商删除</span>
USER_DELETED_BUT_PRESENT_IN_XML = <span class="hljs-number">5</span>           <span class="hljs-comment">// 用户删除但在XML中存在</span>
CARRIER_DELETED_BUT_PRESENT_IN_XML = <span class="hljs-number">6</span>        <span class="hljs-comment">// 运营商删除但在XML中存在</span>
</code></pre>
<p><strong>清理规则：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 973-984 行</span>
<span class="hljs-comment">// 加载完成后清理已删除的APN</span>

<span class="hljs-comment">// 删除用户/运营商明确删除的APN</span>
db.delete(CARRIERS_TABLE, IS_USER_DELETED + <span class="hljs-string">" or "</span> + IS_CARRIER_DELETED, <span class="hljs-literal">null</span>);

<span class="hljs-comment">// 将"删除但在XML中存在"状态改为"已删除"</span>
<span class="hljs-type">ContentValues</span> <span class="hljs-variable">cv</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContentValues</span>();
cv.put(EDITED_STATUS, USER_DELETED);
db.update(CARRIERS_TABLE, cv, IS_USER_DELETED_BUT_PRESENT_IN_XML, <span class="hljs-literal">null</span>);
</code></pre>
<hr/>
<h3 data-id="heading-14">第五阶段：字段合并策略</h3>
<p>当新旧APN冲突时，系统采用智能合并策略：</p>
<h4 data-id="heading-15">5.1 APN类型合并</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 2938-2982 行</span>
<span class="hljs-comment">// 如果类型不同，合并所有唯一的类型</span>
<span class="hljs-comment">// 例如：</span>
<span class="hljs-comment">// oldType = "default,hipri"</span>
<span class="hljs-comment">// newType = "default,mms"</span>
<span class="hljs-comment">// mergedType = "default,hipri,mms"</span>

<span class="hljs-keyword">if</span> (!oldType.equalsIgnoreCase(newType)) {
    String[] oldTypes = oldType.toLowerCase(Locale.ROOT).split(<span class="hljs-string">","</span>);
    String[] newTypes = newType.toLowerCase(Locale.ROOT).split(<span class="hljs-string">","</span>);
    
    ArrayList&lt;String&gt; mergedTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;String&gt;();
    mergedTypes.addAll(Arrays.asList(oldTypes));
    
    <span class="hljs-keyword">for</span> (String s : newTypes) {
        <span class="hljs-keyword">if</span> (!mergedTypes.contains(s.trim())) {
            mergedTypes.add(s);  <span class="hljs-comment">// 添加新类型</span>
        }
    }
    
    <span class="hljs-comment">// 重新组合</span>
    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">mergedType</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mergedTypes.size(); i++) {
        mergedType.append((i == <span class="hljs-number">0</span> ? <span class="hljs-string">""</span> : <span class="hljs-string">","</span>) + mergedTypes.get(i));
    }
    newRow.put(TYPE, mergedType.toString());
}
</code></pre>
<h4 data-id="heading-16">5.2 Bearer/NetworkType位掩码合并</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TelephonyProvider.java: 2985-3009 行</span>
<span class="hljs-comment">// 位掩码按位或操作合并</span>
<span class="hljs-comment">// 例如：</span>
<span class="hljs-comment">// oldBearer = 0x0001 (GSM)</span>
<span class="hljs-comment">// newBearer = 0x0002 (CDMA)</span>
<span class="hljs-comment">// mergedBearer = 0x0003 (GSM | CDMA)</span>

<span class="hljs-keyword">if</span> (oldBearer != newBearer) {
    <span class="hljs-keyword">if</span> (oldBearer == <span class="hljs-number">0</span> || newBearer == <span class="hljs-number">0</span>) {
        newRow.put(BEARER_BITMASK, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 0表示所有网络</span>
    } <span class="hljs-keyword">else</span> {
        newRow.put(BEARER_BITMASK, (oldBearer | newBearer));  <span class="hljs-comment">// 按位或</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-17">第六阶段：OTA更新机制</h3>
<h4 data-id="heading-18">6.1 系统更新安装</h4>
<p>OTA更新可以推送新的APN配置文件：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ApnDbInstallReceiver.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApnDbInstallReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ConfigUpdateInstallReceiver</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ApnDbInstallReceiver</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>(<span class="hljs-string">"/data/misc/apns/"</span>,      <span class="hljs-comment">// 安装目录</span>
              <span class="hljs-string">"apns-conf.xml"</span>,          <span class="hljs-comment">// 文件名</span>
              <span class="hljs-string">"metadata/"</span>,              <span class="hljs-comment">// 元数据目录</span>
              <span class="hljs-string">"version"</span>);               <span class="hljs-comment">// 版本文件</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postInstall</span><span class="hljs-params">(Context context, Intent intent)</span> {
        <span class="hljs-comment">// 安装后触发数据库更新</span>
        <span class="hljs-type">ContentResolver</span> <span class="hljs-variable">resolver</span> <span class="hljs-operator">=</span> context.getContentResolver();
        resolver.delete(UPDATE_APN_DB, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);  <span class="hljs-comment">// 触发更新</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-19">第七阶段：应用查询APN</h3>
<h4 data-id="heading-20">7.1 通过ContentProvider查询</h4>
<p>应用程序通过标准ContentProvider查询APN：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 示例代码</span>
<span class="hljs-type">Cursor</span> <span class="hljs-variable">cursor</span> <span class="hljs-operator">=</span> resolver.query(
    Telephony.Carriers.CONTENT_URI,
    <span class="hljs-literal">null</span>,
    Telephony.Carriers.NUMERIC + <span class="hljs-string">"=?"</span>,
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]{<span class="hljs-string">"31004"</span>},  <span class="hljs-comment">// MCC+MNC</span>
    <span class="hljs-literal">null</span>
);

<span class="hljs-comment">// 获取特定MNC的所有APN</span>
<span class="hljs-keyword">while</span> (cursor.moveToNext()) {
    <span class="hljs-type">String</span> <span class="hljs-variable">apn</span> <span class="hljs-operator">=</span> cursor.getString(cursor.getColumnIndex(Telephony.Carriers.APN));
    <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> cursor.getString(cursor.getColumnIndex(Telephony.Carriers.TYPE));
    <span class="hljs-type">String</span> <span class="hljs-variable">mmsc</span> <span class="hljs-operator">=</span> cursor.getString(cursor.getColumnIndex(Telephony.Carriers.MMSC));
}
</code></pre>
<h4 data-id="heading-21">7.2 优先级选择</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ContentProvider支持查询首选APN</span>
<span class="hljs-comment">// 表中有preferred字段，值为1的APN被视为首选</span>
</code></pre>
<hr/>
<h3 data-id="heading-22">数据库存储结构</h3>
<p>APN数据存储在<code>carriers</code>表中：</p>







































































































































<table><thead><tr><th>字段名</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>_id</td><td>INTEGER PRIMARY KEY</td><td>行ID</td></tr><tr><td>numeric</td><td>TEXT</td><td>MCC+MNC</td></tr><tr><td>mcc</td><td>TEXT</td><td>Mobile Country Code</td></tr><tr><td>mnc</td><td>TEXT</td><td>Mobile Network Code</td></tr><tr><td>apn</td><td>TEXT</td><td>接入点名称</td></tr><tr><td>name</td><td>TEXT</td><td>运营商名称</td></tr><tr><td>proxy</td><td>TEXT</td><td>代理地址</td></tr><tr><td>port</td><td>TEXT</td><td>代理端口</td></tr><tr><td>mmsproxy</td><td>TEXT</td><td>MMS代理</td></tr><tr><td>mmsport</td><td>TEXT</td><td>MMS端口</td></tr><tr><td>mmsc</td><td>TEXT</td><td>MMS中心URL</td></tr><tr><td>user</td><td>TEXT</td><td>用户名</td></tr><tr><td>password</td><td>TEXT</td><td>密码</td></tr><tr><td>server</td><td>TEXT</td><td>服务器</td></tr><tr><td>type</td><td>TEXT</td><td>APN类型</td></tr><tr><td>protocol</td><td>TEXT</td><td>协议</td></tr><tr><td>roaming_protocol</td><td>TEXT</td><td>漫游协议</td></tr><tr><td>authtype</td><td>INTEGER</td><td>认证类型 (0-PAP, 1-CHAP, 3-PAP/CHAP)</td></tr><tr><td>bearer_bitmask</td><td>INTEGER</td><td>网络技术位掩码</td></tr><tr><td>network_type_bitmask</td><td>INTEGER</td><td>网络类型位掩码</td></tr><tr><td>edited</td><td>INTEGER</td><td>编辑状态 (0-未编辑, 1-用户编辑等)</td></tr><tr><td>user_editable</td><td>BOOLEAN</td><td>用户是否可编辑</td></tr><tr><td>user_visible</td><td>BOOLEAN</td><td>用户是否可见</td></tr><tr><td>carrier_enabled</td><td>BOOLEAN</td><td>是否启用</td></tr><tr><td>modem_cognitive</td><td>BOOLEAN</td><td>Modem持久化</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-23">APN类型详解</h3>
<pre><code class="hljs language-scss" lang="scss">default      - 默认数据连接
mms          - 彩信(MMS)
supl         - <span class="hljs-selector-tag">A</span>-GPS (Assisted GPS)
hipri        - 高优先级数据连接
fota         - Firmware Over-The-Air更新
ims          - IP Multimedia Subsystem
ia           - Initial Attach (初始附着)
dun          - Dial-Up Networking
cbs          - Carrier Branded Services
</code></pre>
<hr/>
<h3 data-id="heading-24">完整的APN加载时序</h3>
<pre><code class="hljs language-scss" lang="scss">启动时序：
│
├─ <span class="hljs-selector-attr">[1]</span> TelephonyProvider<span class="hljs-selector-class">.onCreate</span>()
│    └─→ DatabaseHelper<span class="hljs-selector-class">.getReadableDatabase</span>()
│
├─ <span class="hljs-selector-attr">[2]</span> 检查校验和
│    └─→ <span class="hljs-built_in">apnDbUpdateNeeded</span>()?
│
├─ <span class="hljs-selector-attr">[3]</span> 如果需要更新，执行<span class="hljs-built_in">initDatabase</span>()
│    │
│    ├─ 加载系统内置APN
│    │  └─→ Resources<span class="hljs-selector-class">.getXml</span>(R.xml.apns)
│    │
│    ├─ 加载外部APN配置
│    │  └─→ <span class="hljs-built_in">getApnConfFile</span>() (优先选择最新的)
│    │      ├─ /data/misc/apns/apns-conf<span class="hljs-selector-class">.xml</span> (OTA)
│    │      ├─ /product/etc/apns-conf<span class="hljs-selector-class">.xml</span>
│    │      ├─ /oem/telephony/apns-conf<span class="hljs-selector-class">.xml</span>
│    │      └─ /system/etc/apns-conf<span class="hljs-selector-class">.xml</span>
│    │
│    ├─ 事务化插入数据库
│    │  └─→ <span class="hljs-built_in">loadApns</span>(db, parser)
│    │      ├─ <span class="hljs-built_in">getRow</span>() 解析每条APN
│    │      └─ <span class="hljs-built_in">insertAddingDefaults</span>() 插入或合并
│    │
│    └─ 清理已删除的APN
│        └─→ 删除USER_DELETED/CARRIER_DELETED
│
├─ <span class="hljs-selector-attr">[4]</span> 更新校验和
│    └─→ <span class="hljs-built_in">setApnConfChecksum</span>()
│
└─ <span class="hljs-selector-attr">[5]</span> 应用程序可以查询APN
     └─→ ContentProvider查询
</code></pre>
<hr/>
<h3 data-id="heading-25">关键设计点</h3>
<ol>
<li><strong>多源支持</strong> - 支持系统、OEM、Product、OTA等多个来源</li>
<li><strong>版本校验</strong> - 内置版本必须与外部版本一致</li>
<li><strong>智能合并</strong> - 新旧APN冲突时智能合并而不是覆盖</li>
<li><strong>编辑跟踪</strong> - 区分用户编辑、运营商编辑和系统APN</li>
<li><strong>校验和优化</strong> - 避免无必要的数据库重新加载</li>
<li><strong>事务保证</strong> - 确保APN加载的原子性</li>
<li><strong>向后兼容</strong> - 数据库升级时保留用户和运营商编辑</li>
</ol>
<p>这就是Android系统的完整APN加载机制！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Telephony通话状态更新消息上报流程]]></title>    <link>https://juejin.cn/post/7603288778678812707</link>    <guid>https://juejin.cn/post/7603288778678812707</guid>    <pubDate>2026-02-06T04:29:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603288778678812707" data-draft-id="7603283380554530850" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Telephony通话状态更新消息上报流程"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T04:29:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户341408199125"/> <meta itemprop="url" content="https://juejin.cn/user/570004686782272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Telephony通话状态更新消息上报流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/570004686782272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户341408199125
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T04:29:07.000Z" title="Fri Feb 06 2026 04:29:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我来详细分析Android Telephony中通话状态更新消息的上报流程。</p>
<p>现在让我查看更多AT指令的处理和上报流程：</p>
<p>现在让我查看更多关于AT命令处理和轮询的细节：</p>
<p>现在让我查看frameworks层的处理，以了解完整的上报流程：</p>
<p>基于我对代码的分析，这个流程涉及多个层次的交互，我将详细讲解从Modem到上层应用的完整路径。</p>
<h3 data-id="heading-0">整体架构概览</h3>
<p>通话状态更新的上报流程包括以下主要环节：</p>
<pre><code class="hljs">Modem → HAL → RIL Framework → HIDL Service → Java Framework → Phone/CallTracker → Application
</code></pre>
<hr/>
<h3 data-id="heading-1">第一阶段：Modem端的主动上报</h3>
<h4 data-id="heading-2">1.1 Modem主动上报（Unsolicited Response）</h4>
<p>Modem在通话状态发生变化时，主动向基带驱动发送未经请求的回复信息。常见的主动上报包括：</p>
<ul>
<li><strong>RING</strong>: 来电铃声指示</li>
<li><strong>+CRING</strong>: GSM特定的铃声格式（如"VOICE"）</li>
<li><strong>NO CARRIER</strong>: 通话结束，载波消失</li>
<li><strong>+CCWA</strong>: 来电等待指示</li>
<li><strong>+CREG</strong>: 网络注册状态变化</li>
<li><strong>+CGREG</strong>: GPRS网络注册状态变化</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// reference-ril.c: 3490-3497 行</span>
<span class="hljs-comment">// 当Modem发来上述指示时，Reference RIL解析并上报</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strStartsWith(s,<span class="hljs-string">"+CRING:"</span>)
            || strStartsWith(s,<span class="hljs-string">"RING"</span>)
            || strStartsWith(s,<span class="hljs-string">"NO CARRIER"</span>)
            || strStartsWith(s,<span class="hljs-string">"+CCWA"</span>)
) {
    RIL_onUnsolicitedResponse (
        RIL_UNSOL_RESPONSE_CALL_STATE_CHANGED,
        <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
}
</code></pre>
<hr/>
<h3 data-id="heading-3">第二阶段：Vendor RIL处理</h3>
<h4 data-id="heading-4">2.1 Vendor RIL的AT指令处理</h4>
<p>Vendor RIL运行在独立的进程中，通过以下步骤处理Modem的主动上报：</p>
<ol>
<li><strong>AT Reader线程</strong> 持续从Modem读取数据</li>
<li><strong>未经请求的响应处理</strong> (<code>onUnsolicitedResponse</code>回调)</li>
<li><strong>调用RIL_onUnsolicitedResponse</strong>将消息上报给RIL Framework</li>
</ol>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// reference-ril.c: 3490-3497</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">onUnsolicited</span> <span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *sms_pdu)</span>
{
    <span class="hljs-comment">// ... 解析AT指令 ...</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strStartsWith(s,<span class="hljs-string">"+CRING:"</span>)
                || strStartsWith(s,<span class="hljs-string">"RING"</span>)
                || strStartsWith(s,<span class="hljs-string">"NO CARRIER"</span>)
                || strStartsWith(s,<span class="hljs-string">"+CCWA"</span>)
    ) {
        RIL_onUnsolicitedResponse (
            RIL_UNSOL_RESPONSE_CALL_STATE_CHANGED,
            <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-5">第三阶段：RIL Framework处理</h3>
<h4 data-id="heading-6">3.1 RIL_onUnsolicitedResponse函数</h4>
<p>这是RIL Framework的核心处理函数，在<code>libril/ril.cpp</code>中实现：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ril.cpp: 722-729 行</span>
<span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RIL_onUnsolicitedResponse</span><span class="hljs-params">(<span class="hljs-type">int</span> unsolResponse, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *data,
                                <span class="hljs-type">size_t</span> datalen, RIL_SOCKET_ID socket_id)</span>
</span></code></pre>
<p><strong>主要处理步骤：</strong></p>
<ol>
<li>
<p><strong>Wakelock管理</strong> - 根据消息类型获取Partial Wakelock，防止CPU休眠</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ril.cpp: 757-761 行</span>
<span class="hljs-keyword">switch</span> (s_unsolResponses[unsolResponseIndex].wakeType) {
    <span class="hljs-keyword">case</span> WAKE_PARTIAL:
        <span class="hljs-built_in">grabPartialWakeLock</span>();
        shouldScheduleTimeout = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">break</span>;
}
</code></pre>
</li>
<li>
<p><strong>HIDL指示分发</strong> - 通过HIDL接口将消息转发给上层</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ril.cpp: 793-797 行</span>
<span class="hljs-keyword">if</span> (s_unsolResponses[unsolResponseIndex].responseFunction) {
    ret = s_unsolResponses[unsolResponseIndex].<span class="hljs-built_in">responseFunction</span>(
            (<span class="hljs-type">int</span>) soc_id, responseType, <span class="hljs-number">0</span>, RIL_E_SUCCESS, 
            <span class="hljs-built_in">const_cast</span>&lt;<span class="hljs-type">void</span>*&gt;(data), datalen);
}
</code></pre>
</li>
<li>
<p><strong>Wakelock释放</strong> - 设置超时后释放Wakelock（默认200ms）</p>
</li>
</ol>
<h4 data-id="heading-7">3.2 未经请求响应映射表</h4>
<p>在<code>ril_unsol_commands.h</code>中定义了消息类型到处理函数的映射：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ril_unsol_commands.h: 17-19 行</span>
{RIL_UNSOL_RESPONSE_RADIO_STATE_CHANGED, radio::radioStateChangedInd, WAKE_PARTIAL},
{RIL_UNSOL_RESPONSE_CALL_STATE_CHANGED, radio::callStateChangedInd, WAKE_PARTIAL},
{RIL_UNSOL_RESPONSE_VOICE_NETWORK_STATE_CHANGED, radio::networkStateChangedInd, WAKE_PARTIAL},
</code></pre>
<hr/>
<h3 data-id="heading-8">第四阶段：HIDL服务处理</h3>
<h4 data-id="heading-9">4.1 callStateChangedInd函数</h4>
<p>在<code>ril_service.cpp</code>中实现HIDL指示处理：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ril_service.cpp: 6758-6773 行</span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">radio::callStateChangedInd</span><span class="hljs-params">(<span class="hljs-type">int</span> slotId,
                               <span class="hljs-type">int</span> indicationType, <span class="hljs-type">int</span> token, RIL_Errno e, <span class="hljs-type">void</span> *response,
                               <span class="hljs-type">size_t</span> responseLen)</span> </span>{
    <span class="hljs-keyword">if</span> (radioService[slotId] != <span class="hljs-literal">NULL</span> &amp;&amp; radioService[slotId]-&gt;mRadioIndication != <span class="hljs-literal">NULL</span>) {
        Return&lt;<span class="hljs-type">void</span>&gt; retStatus = radioService[slotId]-&gt;mRadioIndication-&gt;<span class="hljs-built_in">callStateChanged</span>(
                <span class="hljs-built_in">convertIntToRadioIndicationType</span>(indicationType));
        radioService[slotId]-&gt;<span class="hljs-built_in">checkReturnStatus</span>(retStatus);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>获取对应Slot的HIDL Indication实例</li>
<li>调用HIDL接口的<code>callStateChanged</code>方法</li>
<li>将消息转发给Java层</li>
</ul>
<hr/>
<h3 data-id="heading-10">第五阶段：Java Framework处理</h3>
<h4 data-id="heading-11">5.1 VoiceIndication接收</h4>
<p>在<code>VoiceIndication.java</code>的<code>callStateChanged</code>方法中处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// VoiceIndication.java: 94-99 行</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">callStateChanged</span><span class="hljs-params">(<span class="hljs-type">int</span> indicationType)</span> {
    mRil.processIndication(HAL_SERVICE_VOICE, indicationType);

    <span class="hljs-keyword">if</span> (mRil.isLogOrTrace()) mRil.unsljLog(RIL_UNSOL_RESPONSE_CALL_STATE_CHANGED);

    mRil.mCallStateRegistrants.notifyRegistrants();
}
</code></pre>
<p><strong>处理流程：</strong></p>
<ol>
<li>处理指示类型（标记为已处理）</li>
<li>记录日志</li>
<li><strong>通知所有已注册的监听者</strong></li>
</ol>
<h4 data-id="heading-12">5.2 CallStateRegistrants通知</h4>
<p><code>mCallStateRegistrants</code>是一个<code>RegistrantList</code>，包含所有对通话状态变化感兴趣的监听者（如<code>GsmCdmaCallTracker</code>）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// BaseCommands.java: 292-294 行</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerForCallStateChanged</span><span class="hljs-params">(Handler h, <span class="hljs-type">int</span> what, Object obj)</span> {
    mCallStateRegistrants.addUnique(h, what, obj);
}
</code></pre>
<p>GsmCdmaCallTracker在初始化时注册：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 160-171 行</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">GsmCdmaCallTracker</span><span class="hljs-params">(GsmCdmaPhone phone, FeatureFlags featureFlags)</span> {
    <span class="hljs-comment">// ...</span>
    mCi = phone.mCi;
    mCi.registerForCallStateChanged(<span class="hljs-built_in">this</span>, EVENT_CALL_STATE_CHANGE, <span class="hljs-literal">null</span>);
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-13">第六阶段：CallTracker轮询当前通话列表</h3>
<h4 data-id="heading-14">6.1 触发getCurrentCalls请求</h4>
<p>当接收到<code>EVENT_CALL_STATE_CHANGE</code>消息时，GsmCdmaCallTracker不会直接使用该消息，而是<strong>主动轮询</strong>当前的通话列表：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CallTracker.java: 91-98 行</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pollCallsWhenSafe</span><span class="hljs-params">()</span> {
    mNeedsPoll = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">if</span> (checkNoOperationsPending()) {
        mLastRelevantPoll = obtainMessage(EVENT_POLL_CALLS_RESULT);
        mCi.getCurrentCalls(mLastRelevantPoll);
    }
}
</code></pre>
<p><strong>为什么需要轮询？</strong></p>
<ul>
<li>Modem上报的只是"状态有变化"的信号，不包含具体的通话列表数据</li>
<li>必须通过AT+CLCC命令主动查询当前的通话详情</li>
</ul>
<h4 data-id="heading-15">6.2 RIL.getCurrentCalls请求</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// RIL.java: 1640-1655 行</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getCurrentCalls</span><span class="hljs-params">(Message result)</span> {
    <span class="hljs-type">RadioVoiceProxy</span> <span class="hljs-variable">voiceProxy</span> <span class="hljs-operator">=</span> getRadioServiceProxy(RadioVoiceProxy.class);
    <span class="hljs-keyword">if</span> (!canMakeRequest(<span class="hljs-string">"getCurrentCalls"</span>, voiceProxy, result, RADIO_HAL_VERSION_1_4)) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-type">RILRequest</span> <span class="hljs-variable">rr</span> <span class="hljs-operator">=</span> obtainRequest(RIL_REQUEST_GET_CURRENT_CALLS, result, mRILDefaultWorkSource);

    <span class="hljs-keyword">if</span> (RILJ_LOGD) {
        riljLog(rr.serialString() + <span class="hljs-string">"&gt; "</span> + RILUtils.requestToString(rr.mRequest));
    }

    radioServiceInvokeHelper(HAL_SERVICE_VOICE, rr, <span class="hljs-string">"getCurrentCalls"</span>, () -&gt; {
        voiceProxy.getCurrentCalls(rr.mSerial);
    });
}
</code></pre>
<hr/>
<h3 data-id="heading-16">第七阶段：解析通话列表</h3>
<h4 data-id="heading-17">7.1 Modem响应getCurrentCalls</h4>
<p>Modem响应AT+CLCC命令，返回当前通话列表。每条通话的格式为：</p>
<pre><code class="hljs language-xml" lang="xml">+CLCC: <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>,<span class="hljs-tag">&lt;<span class="hljs-name">dir</span>&gt;</span>,<span class="hljs-tag">&lt;<span class="hljs-name">stat</span>&gt;</span>,<span class="hljs-tag">&lt;<span class="hljs-name">bearer</span>&gt;</span>,<span class="hljs-tag">&lt;<span class="hljs-name">mpty</span>&gt;</span>[,<span class="hljs-tag">&lt;<span class="hljs-name">number</span>&gt;</span>,<span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>[,<span class="hljs-tag">&lt;<span class="hljs-name">alpha</span>&gt;</span>]]
</code></pre>
<p>例如：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">+<span class="hljs-built_in">CLCC</span>: <span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-string">"10086"</span>,<span class="hljs-number">129</span>
+<span class="hljs-built_in">CLCC</span>: <span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>
</code></pre>
<h4 data-id="heading-18">7.2 handlePollCalls处理结果</h4>
<p>当RIL返回通话列表后，<code>handlePollCalls</code>在<code>GsmCdmaCallTracker</code>中处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 848-863 行</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlePollCalls</span><span class="hljs-params">(AsyncResult ar)</span> {
    List polledCalls;

    <span class="hljs-keyword">if</span> (VDBG) log(<span class="hljs-string">"handlePollCalls"</span>);
    <span class="hljs-keyword">if</span> (ar.exception == <span class="hljs-literal">null</span>) {
        polledCalls = (List)ar.result;  <span class="hljs-comment">// DriverCall列表</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isCommandExceptionRadioNotAvailable(ar.exception)) {
        polledCalls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
    } <span class="hljs-keyword">else</span> {
        pollCallsAfterDelay();
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// ... 处理通话列表 ...</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-19">第八阶段：更新通话状态和通知上层</h3>
<h4 data-id="heading-20">8.1 遍历并更新通话对象</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 878-1070 行</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, curDC = <span class="hljs-number">0</span>, dcSize = polledCalls.size(); i &lt; mConnections.length; i++) {
    <span class="hljs-type">GsmCdmaConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> mConnections[i];
    <span class="hljs-type">DriverCall</span> <span class="hljs-variable">dc</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    
    <span class="hljs-comment">// 获取Modem返回的通话信息</span>
    <span class="hljs-keyword">if</span> (curDC &lt; dcSize) {
        dc = (DriverCall) polledCalls.get(curDC);
        <span class="hljs-keyword">if</span> (dc.index == i+<span class="hljs-number">1</span>) {
            curDC++;
        } <span class="hljs-keyword">else</span> {
            dc = <span class="hljs-literal">null</span>;
        }
    }
    
    <span class="hljs-comment">// 比较本地记录和Modem状态</span>
    <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">null</span> &amp;&amp; dc != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 新通话出现 - 创建新的GsmCdmaConnection</span>
        mConnections[i] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GsmCdmaConnection</span>(mPhone, dc, <span class="hljs-built_in">this</span>, i);
        newRinging = checkMtFindNewRinging(dc, i);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span> &amp;&amp; dc == <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 通话已被删除 - 标记为已丢弃</span>
        mDroppedDuringPoll.add(conn);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span> &amp;&amp; dc != <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 通话存在，更新其状态</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">changed</span> <span class="hljs-operator">=</span> conn.update(dc);
        hasNonHangupStateChanged = hasNonHangupStateChanged || changed;
    }
}
</code></pre>
<h4 data-id="heading-21">8.2 更新Phone状态</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 1201-1202 行</span>
updatePhoneState();
</code></pre>
<p>这个函数根据通话列表确定Phone的总体状态（IDLE、RINGING、OFFHOOK）。</p>
<h4 data-id="heading-22">8.3 通知监听者</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 1215-1218 行</span>
<span class="hljs-keyword">if</span> (hasNonHangupStateChanged || newRinging != <span class="hljs-literal">null</span> || hasAnyCallDisconnected) {
    mPhone.notifyPreciseCallStateChanged();
    updateMetrics(mConnections);
}
</code></pre>
<hr/>
<h3 data-id="heading-23">第九阶段：上层应用感知</h3>
<h4 data-id="heading-24">9.1 Phone层的通知</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 1117 行</span>
<span class="hljs-keyword">if</span> (newRinging != <span class="hljs-literal">null</span>) {
    mPhone.notifyNewRingingConnection(newRinging);
}
</code></pre>
<p>通知Phone有新的来电。</p>
<h4 data-id="heading-25">9.2 应用层感知</h4>
<p>应用程序通过以下方式感知通话状态变化：</p>
<ol>
<li><strong>TelephonyCallback监听</strong> （推荐方式）</li>
<li><strong>PhoneStateListener</strong> （已废弃）</li>
<li><strong>TelephonyRegistry</strong> （系统级通知）</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 应用层代码示例</span>
<span class="hljs-type">TelephonyManager</span> <span class="hljs-variable">tm</span> <span class="hljs-operator">=</span> context.getSystemService(TelephonyManager.class);
tm.registerTelephonyCallback(executor, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TelephonyCallback</span>.CallStateListener() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCallStateChanged</span><span class="hljs-params">(<span class="hljs-type">int</span> state)</span> {
        <span class="hljs-comment">// 处理通话状态变化</span>
    }
});
</code></pre>
<hr/>
<h2 data-id="heading-26">完整的消息流时序图</h2>
<pre><code class="hljs language-scss" lang="scss">时间轴 ────────────────────────────────────────────────────────────────
│
├─ <span class="hljs-selector-attr">[1]</span> Modem检测到通话状态变化
│       └─→ 发送未经请求的回复 (RING, NO CARRIER, etc.)
│
├─ <span class="hljs-selector-attr">[2]</span> Vendor RIL接收AT指示
│       └─→ 调用 <span class="hljs-built_in">RIL_onUnsolicitedResponse</span>()
│
├─ <span class="hljs-selector-attr">[3]</span> RIL Framework处理
│       ├─→ 获取Partial Wakelock
│       └─→ 调用HIDL response handler (callStateChangedInd)
│
├─ <span class="hljs-selector-attr">[4]</span> HIDL Service转发
│       └─→ RadioIndication<span class="hljs-selector-class">.callStateChanged</span>() (AIDL)
│
├─ <span class="hljs-selector-attr">[5]</span> Java Framework接收
│       └─→ VoiceIndication<span class="hljs-selector-class">.callStateChanged</span>()
│           └─→ RIL<span class="hljs-selector-class">.mCallStateRegistrants</span><span class="hljs-selector-class">.notifyRegistrants</span>()
│
├─ <span class="hljs-selector-attr">[6]</span> CallTracker感知状态变化
│       └─→ EVENT_CALL_STATE_CHANGE handler
│           └─→ <span class="hljs-built_in">pollCallsWhenSafe</span>()
│               └─→ RIL<span class="hljs-selector-class">.getCurrentCalls</span>() <span class="hljs-selector-attr">[同步轮询]</span>
│
├─ <span class="hljs-selector-attr">[7]</span> Modem返回通话列表
│       └─→ AT+CLCC响应 (多条+CLCC行)
│
├─ <span class="hljs-selector-attr">[8]</span> GsmCdmaCallTracker处理
│       ├─→ EVENT_POLL_CALLS_RESULT handler
│       ├─→ <span class="hljs-built_in">handlePollCalls</span>(AsyncResult ar)
│       ├─→ 比较并更新mConnections<span class="hljs-selector-attr">[]</span>数组
│       ├─→ <span class="hljs-built_in">updatePhoneState</span>()
│       ├─→ mPhone<span class="hljs-selector-class">.notifyPreciseCallStateChanged</span>()
│       └─→ mPhone<span class="hljs-selector-class">.notifyNewRingingConnection</span>()
│
├─ <span class="hljs-selector-attr">[9]</span> Phone层通知
│       └─→ TelephonyRegistry广播
│           └─→ 通知系统服务和应用
│
└─ <span class="hljs-selector-attr">[10]</span> 应用层获得通话状态更新
        └─→ TelephonyCallback<span class="hljs-selector-class">.onCallStateChanged</span>()
</code></pre>
<hr/>
<h2 data-id="heading-27">关键数据结构</h2>
<h3 data-id="heading-28">1. RIL_Call 结构体</h3>
<p>定义单个通话的状态信息：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ril.h</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-type">int</span> index;              <span class="hljs-comment">// 通话索引</span>
    <span class="hljs-type">int</span> isMT;               <span class="hljs-comment">// 1=来电, 0=去电</span>
    RIL_CallState state;    <span class="hljs-comment">// 通话状态 (ACTIVE/HOLDING/DIALING/等)</span>
    <span class="hljs-type">int</span> mode;               <span class="hljs-comment">// 通话模式 (0=语音, 1=数据, 等)</span>
    <span class="hljs-type">int</span> mpty;               <span class="hljs-comment">// 0=非多方通话, 1=多方通话</span>
    <span class="hljs-comment">// ... 其他字段 ...</span>
} RIL_Call;
</code></pre>
<h3 data-id="heading-29">2. DriverCall 结构体（Java端）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DriverCall</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">State</span> {
        ACTIVE, HOLDING, DIALING, ALERTING, INCOMING, WAITING
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> index;
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> isMT;       <span class="hljs-comment">// Mobile Terminated (incoming)</span>
    <span class="hljs-keyword">public</span> State state;
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> number;
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> type;
    <span class="hljs-comment">// ... 其他字段 ...</span>
}
</code></pre>
<h3 data-id="heading-30">3. GsmCdmaConnection 类</h3>
<p>代表一条逻辑通话连接，维护其状态、时间戳等信息。</p>
<hr/>
<h2 data-id="heading-31">Wakelock机制</h2>
<p>为了防止CPU因接收Unsolicited Response而过度休眠/唤醒，RIL Framework采用了Wakelock机制：</p>
<ol>
<li><strong>Unsolicited Response到达时</strong> → 获取Partial Wakelock</li>
<li><strong>消息处理完成后</strong> → 设置200ms超时</li>
<li><strong>超时后</strong> → 释放Wakelock，允许CPU休眠</li>
</ol>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// ril.cpp: 700-718 行</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">wakeTimeoutCallback</span> <span class="hljs-params">(<span class="hljs-type">void</span> *param)</span> </span>{
    <span class="hljs-keyword">if</span> (s_callbacks.version &gt;= <span class="hljs-number">13</span>) {
        <span class="hljs-keyword">if</span> (param == <span class="hljs-literal">NULL</span>) {
            s_wakelock_count = <span class="hljs-number">0</span>;
            <span class="hljs-built_in">release_wake_lock</span>(ANDROID_WAKE_LOCK_NAME);
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-32">性能优化点</h2>
<ol>
<li><strong>Partial Wakelock</strong> - 只唤醒CPU，不点亮屏幕</li>
<li><strong>轮询延迟</strong> - 对于未完成状态（DIALING/ALERTING/INCOMING/WAITING），设置轮询延迟（通常500ms）</li>
<li><strong>去重机制</strong> - 冗余或重复的通话状态消息被容忍（如文档中所说）</li>
<li><strong>异步处理</strong> - 所有操作都在RIL事件循环中异步进行</li>
</ol>
<hr/>
<h2 data-id="heading-33">异常处理</h2>
<p>当Radio不可用时：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// GsmCdmaCallTracker.java: 854-857 行</span>
<span class="hljs-keyword">if</span> (ar.exception == <span class="hljs-literal">null</span>) {
    polledCalls = (List)ar.result;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isCommandExceptionRadioNotAvailable(ar.exception)) {
    polledCalls = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();  <span class="hljs-comment">// 清空通话列表</span>
} <span class="hljs-keyword">else</span> {
    pollCallsAfterDelay();  <span class="hljs-comment">// 稍后重试</span>
}
</code></pre>
<hr/>
<p>这个流程展示了Android Telephony系统的高度分层设计，从底层Modem事件到上层应用通知，涉及多个进程间的通信和同步机制。</p>
<p>我已经为你详细总结了<strong>Android Telephony通话状态更新消息的完整上报流程</strong>。这个分析涵盖了从Modem底层到上层应用的9个关键阶段：</p>
<h2 data-id="heading-34">核心要点速览：</h2>
<ol>
<li><strong>Modem主动上报</strong> - 发送RING/NO CARRIER等未经请求的回复</li>
<li><strong>Vendor RIL处理</strong> - 解析AT指令，调用RIL_onUnsolicitedResponse</li>
<li><strong>RIL Framework</strong> - 获取Wakelock，通过HIDL转发消息</li>
<li><strong>HIDL Service</strong> - 将C++消息转换为Java AIDL调用</li>
<li><strong>Java Framework</strong> - VoiceIndication通知CallStateRegistrants</li>
<li><strong>CallTracker轮询</strong> - 主动调用getCurrentCalls查询通话列表</li>
<li><strong>解析通话列表</strong> - 处理Modem返回的AT+CLCC响应</li>
<li><strong>状态更新</strong> - GsmCdmaCallTracker更新本地通话对象</li>
<li><strong>应用感知</strong> - 通过TelephonyCallback通知上层应用</li>
</ol>
<p>关键的<strong>设计模式</strong>包括：</p>
<ul>
<li>✅ <strong>主动轮询</strong> - 上报只是信号，通话详情需轮询获取</li>
<li>✅ <strong>Wakelock管理</strong> - 防止CPU过度休眠</li>
<li>✅ <strong>分层通信</strong> - Native/HAL/Java各层清晰解耦</li>
<li>✅ <strong>异步处理</strong> - 所有操作都在事件循环中进行</li>
</ul>
<p>如果你需要深入了解特定阶段（如AT指令的详细解析、HIDL消息转换、或特定通话操作的实现），我可以提供更详细的代码分析！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue Router导航守卫中使用ElMessageBox的坑点与解决方案]]></title>    <link>https://juejin.cn/post/7603294029531725875</link>    <guid>https://juejin.cn/post/7603294029531725875</guid>    <pubDate>2026-02-06T05:37:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603294029531725875" data-draft-id="7603294029531693107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue Router导航守卫中使用ElMessageBox的坑点与解决方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-06T05:37:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="puhaha"/> <meta itemprop="url" content="https://juejin.cn/user/2665652787090318"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue Router导航守卫中使用ElMessageBox的坑点与解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2665652787090318/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    puhaha
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T05:37:14.000Z" title="Fri Feb 06 2026 05:37:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题背景</h2>
<p>在Vue 3 + Vue Router项目中，我们经常需要在用户离开页面前进行确认，特别是当表单有未保存的更改时。<code>onBeforeRouteLeave</code> 与 Element Plus 的 <code>ElMessageBox.confirm</code> 结合使用是一个常见方案，但在实际应用中存在不少坑点。</p>
<h2 data-id="heading-1">直接上代码</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">onBeforeRouteLeave</span>(<span class="hljs-keyword">async</span> (to, <span class="hljs-keyword">from</span>, next) =&gt; {
  <span class="hljs-keyword">if</span> (!modelDirty.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span> <span class="hljs-title function_">next</span>()
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">'还未保存，离开会丢失，确定继续吗？'</span>, <span class="hljs-string">'提示'</span>, {
      <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'确定'</span>,
      <span class="hljs-attr">cancelButtonText</span>: <span class="hljs-string">'取消'</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
      <span class="hljs-attr">closeOnHashChange</span>: <span class="hljs-literal">false</span>
    })
    modelDirty.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    <span class="hljs-title function_">next</span>()
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-title function_">next</span>(<span class="hljs-literal">false</span>)
  }
})
</code></pre>
<h2 data-id="heading-2">坑点梳理</h2>
<h3 data-id="heading-3">坑点1：<code>next()</code> 调用时机问题</h3>
<p><strong>问题描述</strong>：在异步操作中忘记调用 <code>next()</code>，或者重复调用</p>
<p>javascript</p>
<pre><code class="hljs language-vbnet" lang="vbnet">// ❌ 错误示例：可能在某些路径下未调用<span class="hljs-keyword">next</span>
onBeforeRouteLeave(<span class="hljs-keyword">async</span> (<span class="hljs-keyword">to</span>, <span class="hljs-keyword">from</span>, <span class="hljs-keyword">next</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!dirty) {
    // 这里没有调用 <span class="hljs-keyword">next</span>()！
    <span class="hljs-keyword">return</span>
  }
  // ...其他逻辑
})
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确示例：确保所有路径都调用next</span>
<span class="hljs-title function_">onBeforeRouteLeave</span>(<span class="hljs-keyword">async</span> (to, <span class="hljs-keyword">from</span>, next) =&gt; {
  <span class="hljs-keyword">if</span> (!modelDirty.<span class="hljs-property">value</span>) {
    <span class="hljs-title function_">next</span>() <span class="hljs-comment">// 确保这里也调用next</span>
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-comment">// ...其他逻辑</span>
})
</code></pre>
<h3 data-id="heading-4">坑点2：<code>closeOnHashChange</code> 设置的必要性</h3>
<p><strong>问题描述</strong>：用户点击浏览器前进/后退按钮时，hash变化可能导致MessageBox意外关闭</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 必须设置 closeOnHashChange: false</span>
<span class="hljs-keyword">await</span> <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">'提示内容'</span>, <span class="hljs-string">'标题'</span>, {
  <span class="hljs-comment">// ...其他配置</span>
  <span class="hljs-attr">closeOnHashChange</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 防止路由hash变化自动关闭</span>
  <span class="hljs-attr">closeOnClickModal</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 防止点击遮罩层关闭</span>
  <span class="hljs-attr">closeOnPressEscape</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 防止ESC键关闭（可选）</span>
})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 Hash 到 HyperLogLog：Redis 海量 UV 统计的 3 种高阶玩法]]></title>    <link>https://juejin.cn/post/7603227363822567450</link>    <guid>https://juejin.cn/post/7603227363822567450</guid>    <pubDate>2026-02-06T05:42:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603227363822567450" data-draft-id="7603283691457150986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 Hash 到 HyperLogLog：Redis 海量 UV 统计的 3 种高阶玩法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-06T05:42:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 Hash 到 HyperLogLog：Redis 海量 UV 统计的 3 种高阶玩法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T05:42:51.000Z" title="Fri Feb 06 2026 05:42:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">真实业务场景</h2>
<p>假设我们正在开发一个电商大促活动页，产品经理提了一个“简单”的需求：我们需要实时显示“当前正在浏览商品的用户数”。这个数字每秒可能变化数万次。在 10 万级并发下，传统关系型数据库会面临什么问题？</p>
<p><strong>经典错误场景：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Java 初学者的常见做法</span>
public synchronized void <span class="hljs-built_in">addCount</span>() {
    int count = <span class="hljs-built_in">getFromMySQL</span>();
    <span class="hljs-built_in">updateMySQL</span>(count + <span class="hljs-number">1</span>);
}
</code></pre>
<p>上述代码在高并发下会导致：</p>
<ol>
<li>数据库连接池过载（超时错误）</li>
<li>行锁竞争（死锁风险）</li>
<li>CPU 飙升至 100%（性能崩溃）</li>
</ol>
<p>这正是我们需要设计 Redis 统计方案的核心原因——在这种场景下，关系型数据库的 ACID 特性反而成了负担。</p>
<h2 data-id="heading-1">Redis 方案的演进</h2>
<h3 data-id="heading-2">阶段 1：Hash 方案——精确统计的起点</h3>
<p><strong>原理：</strong> 使用哈希表记录每个独立访客，适用于对精度要求高、中小型规模的场景。</p>
<pre><code class="hljs language-ini" lang="ini">// 将用户访问记录添加到 Hash
Jedis <span class="hljs-attr">jedis</span> = new Jedis(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)<span class="hljs-comment">;</span>
String <span class="hljs-attr">pageKey</span> = <span class="hljs-string">"page_visit_count:examplePage"</span><span class="hljs-comment">; // 页面访问计数 Key</span>
String <span class="hljs-attr">userId</span> = <span class="hljs-string">"user_123"</span><span class="hljs-comment">; // 已登录用户</span>
String <span class="hljs-attr">visitorId</span> = <span class="hljs-string">"visitor_abc123"</span><span class="hljs-comment">; // 未登录用户</span>

// 使用 HSET 命令添加数据，值简单设为 "1"
jedis.hset(pageKey, userId, "1")<span class="hljs-comment">;</span>
jedis.hset(pageKey, visitorId, "1")<span class="hljs-comment">;</span>

// 统计访问量，直接使用 HLEN 命令获取字段数量
long <span class="hljs-attr">visitCount</span> = jedis.hlen(pageKey)<span class="hljs-comment">;</span>
System.out.println("The page visit count is: " + visitCount)<span class="hljs-comment">;</span>
</code></pre>
<p>这种方法的优点是简单直接——实现容易，查询方便，且精度极高。但缺点也显而易见。</p>
<p>随着访问页面的增加，Key 像滚雪球一样膨胀，链表变长，内存占用迅速飙升，性能逐渐下降。</p>
<p>因此，这种方法更适合流量相对较低的页面，作为初期的尝试。</p>
<h3 data-id="heading-3">阶段 2：Bitmap 方案——空间与性能的平衡</h3>
<p>当用户基数变大时，使用 Hash 在空间上就显得有些浪费了。</p>
<p>这正是 Bitmap 大显身手的时候，它是空间效率的大师。它巧妙地利用了 32 位 int 类型——不再存储一个完整的用户 ID，而是拆解 32 位，每一位代表一个用户，直接节省了 32 倍的空间。</p>
<p>对于已登录用户，其 ID 直接映射到 Bitmap 中的特定位。对于未登录用户，通过哈希算法将随机字符串标识符转换为哈希值**，再映射到特定位。例如，用户 ID 为 5，对应 Bitmap 第 5 位；随机字符串哈希值为 10，对应第 10 位。</p>
<pre><code class="hljs language-ini" lang="ini">// 使用 Bitmap 统计页面访问量
Jedis <span class="hljs-attr">jedis</span> = new Jedis(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)<span class="hljs-comment">;</span>
String <span class="hljs-attr">pageKey</span> = <span class="hljs-string">"bitmap_visit_count:examplePage"</span><span class="hljs-comment">; // Bitmap 访问计数 Key</span>
String <span class="hljs-attr">loginUserId</span> = <span class="hljs-string">"5"</span><span class="hljs-comment">; // 已登录用户 ID</span>
String <span class="hljs-attr">nonLoginUserKey</span> = <span class="hljs-string">"random_str_123"</span><span class="hljs-comment">; // 未登录用户的随机 Key</span>

// 对于已登录用户，直接设置对应位
jedis.setbit(pageKey, Long.parseLong(loginUserId), true)<span class="hljs-comment">;</span>

// 对于未登录用户，先对 Key 进行哈希，再设置位
String <span class="hljs-attr">hashValue</span> = DigestUtils.md5DigestAsHex(nonLoginUserKey.getBytes())<span class="hljs-comment">;</span>
long <span class="hljs-attr">hashBitIndex</span> = Long.parseLong(hashValue.substring(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>), <span class="hljs-number">16</span>) % Long.MAX_VALUE<span class="hljs-comment">;</span>
jedis.setbit(pageKey, hashBitIndex, true)<span class="hljs-comment">;</span>

// 使用 BITCOUNT 命令统计访问量
long <span class="hljs-attr">visitCount</span> = jedis.bitcount(pageKey)<span class="hljs-comment">;</span>
System.out.println("The page visit count is: " + visitCount)<span class="hljs-comment">;</span>
</code></pre>
<p>这种方法的优势在于极小的内存占用和便捷的查询，甚至可以检查特定用户是否访问过页面。</p>
<p>但也存在明显的缺点。多个用户可能会碰撞到同一位上，导致统计略有偏差。此外，如果用户分布稀疏——例如用户 ID 是 1 亿——则需要分配 1 亿个位，可能会造成内存浪费。</p>
<p>因此，这种方法更适合用户分布相对密集的场景。</p>
<h3 data-id="heading-4">阶段 3：HyperLogLog 方案——超大数据量的“量子”统计</h3>
<p><strong>突破性思维：</strong> 通常，系统不需要绝对精确的数据，可以用可控的误差换取内存和性能的巨大提升。</p>
<p>它不再追求记录每个用户的确切计数，而是使用概率算法估算近似访问量，误差控制在 0.81% 以内，这在实际应用中通常已经足够。</p>
<pre><code class="hljs language-ini" lang="ini">// 使用 HyperLogLog 统计页面访问量
Jedis <span class="hljs-attr">jedis</span> = new Jedis(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)<span class="hljs-comment">;</span>
String <span class="hljs-attr">pageKey</span> = <span class="hljs-string">"hyperloglog_visit_count:examplePage"</span><span class="hljs-comment">; // HyperLogLog 访问计数 Key</span>
String <span class="hljs-attr">userId</span> = <span class="hljs-string">"user_456"</span><span class="hljs-comment">; // 用户标识，可以是 ID 或其他唯一标识</span>

// 使用 PFADD 命令添加用户访问记录
jedis.pfadd(pageKey, userId)<span class="hljs-comment">;</span>

// 使用 PFCOUNT 命令统计访问量
long <span class="hljs-attr">approxVisitCount</span> = jedis.pfcount(pageKey)<span class="hljs-comment">;</span>
System.out.println("The approximate page visit count is: " + approxVisitCount)<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-5">总结</h2>
<p>这三种方案各有所长。</p>
<p>Hash 就像一本细致的账本，适用于小规模、高精度的统计。Bitmap 是空间压缩的大师，适合用户分布密集的才中等规模场景。HyperLogLog 则是概率统计专家，专为超高并发、高流量的网站设计。</p>
<p>在实际项目中，我们需要根据业务场景灵活选择，从而在并发战场中掌控全局，精准高效地统计用户访问量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Ansible实现免密钥的原理]]></title>    <link>https://juejin.cn/post/7603252259561734180</link>    <guid>https://juejin.cn/post/7603252259561734180</guid>    <pubDate>2026-02-06T03:20:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603252259561734180" data-draft-id="7602512064976289855" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Ansible实现免密钥的原理"/> <meta itemprop="keywords" content="Linux,运维"/> <meta itemprop="datePublished" content="2026-02-06T03:20:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sheffield"/> <meta itemprop="url" content="https://juejin.cn/user/362164852109770"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Ansible实现免密钥的原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/362164852109770/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sheffield
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:20:50.000Z" title="Fri Feb 06 2026 03:20:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>SSH 免密是自动化运维的基础，Ansible远程管控、脚本自动执行都得靠它。用大白话讲清免密核心原理，拆解3个核心步骤，内容极简、好懂、能直接用。</p>
<h2 data-id="heading-0">一、SSH 免密核心原理</h2>
<p>SSH 免密靠<strong>非对称加密</strong>，全程无明文密码传输，控制端Rsync（172.16.0.61）免密控制被控制端NFS/DataBase（172.16.0.41），核心就3点：</p>
<ol>
<li>控制端生成<strong>密钥对</strong>：私钥（id_rsa）留本地，相当于「个人身份证」，绝不能泄露；公钥（id_rsa.pub）可公开，相当于「免密授权函」。</li>
<li>把控制端的<strong>公钥</strong>，放到被控制端的「免密白名单」（/root/.ssh/authorized_keys）里。</li>
<li>控制端连被控制端时，用私钥做身份验证，被控制端用白名单里的公钥验证，匹配上就直接连接，不用输密码。</li>
</ol>
<h2 data-id="heading-1">二、你的实战Playbook</h2>
<p>实现<strong>172.16.0.61 免密控制 172.16.0.41</strong>的极简Playbook，也是我个人环境的写法，重复执行不报错：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">实现SSH免密登录</span>
  <span class="hljs-attr">hosts:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.0</span><span class="hljs-number">.61</span>  <span class="hljs-comment"># 控制端（生成密钥的机器）</span>
  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span>
  <span class="hljs-attr">tasks:</span>
    <span class="hljs-comment"># 步骤1：控制端生成密钥对，已存在则跳过</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">生成密钥</span>
      <span class="hljs-attr">command:</span> <span class="hljs-string">ssh-keygen</span> <span class="hljs-string">-t</span> <span class="hljs-string">rsa</span> <span class="hljs-string">-N</span> <span class="hljs-string">""</span> <span class="hljs-string">-f</span> <span class="hljs-string">/root/.ssh/id_rsa</span>
      <span class="hljs-attr">args:</span>
        <span class="hljs-attr">creates:</span> <span class="hljs-string">/root/.ssh/id_rsa</span>

    <span class="hljs-comment"># 步骤2：读取控制端公钥，注册为变量</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">读取公钥</span>
      <span class="hljs-attr">slurp:</span>
        <span class="hljs-attr">src:</span> <span class="hljs-string">/root/.ssh/id_rsa.pub</span>
      <span class="hljs-attr">register:</span> <span class="hljs-string">id_rsa_pub</span>

    <span class="hljs-comment"># 步骤3：把公钥写入被控制端41的免密白名单</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">免密控制41</span>
      <span class="hljs-attr">authorized_key:</span>
        <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
        <span class="hljs-attr">key:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ id_rsa_pub.content | b64decode }}</span>"</span>
      <span class="hljs-attr">delegate_to:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.0</span><span class="hljs-number">.41</span>
</code></pre>
<h2 data-id="heading-2">三、3 步拆解：每一步做什么？为什么这么做？</h2>
<h3 data-id="heading-3">步骤 1：控制端生成密钥对</h3>
<p><strong>核心作用</strong>：给控制端生成「身份证+授权函」，命令<code>ssh-keygen -t rsa -N "" -f /root/.ssh/id_rsa</code>：</p>
<ul>
<li><code>-t rsa</code>：用最常用的 RSA 加密算法，安全又兼容；</li>
<li><code>-N ""</code>：密钥无密码，自动化场景必须加，否则会弹窗输密码中断任务；</li>
<li><code>creates: /root/.ssh/id_rsa</code>：关键！如果密钥已存在，直接跳过，避免重复生成提示覆盖文件。</li>
</ul>
<p><strong>执行结果</strong>：控制端<code>/root/.ssh/</code>下生成 2 个文件 ——<code>id_rsa</code>（私钥，权限 600，严禁泄露）、<code>id_rsa.pub</code>（公钥，可自由传输）。</p>
<h3 data-id="heading-4">步骤 2：读取公钥并注册变量</h3>
<p><strong>核心作用</strong>：把公钥内容读出来，供后续步骤使用。</p>
<ul>
<li>用<code>slurp</code>模块而非简单的<code>cat</code>命令：自动对内容做Base64编码，跨机传输不丢内容、无编码问题；</li>
<li><code>register: id_rsa_pub</code>：把编码后的公钥存到变量里，后续直接调用就行。</li>
</ul>
<h3 data-id="heading-5">步骤 3：写入被控制端免密白名单</h3>
<p><strong>核心作用</strong>：把控制端的「授权函」，放到被控制端41的白名单里，实现免密。</p>
<ul>
<li><code>authorized_key</code>：Ansible专用管理免密白名单的模块，自动校验公钥格式，避免重复写入，比手动敲命令安全；</li>
<li><code>{{ id_rsa_pub.content | b64decode }}</code>：把步骤2编码的公钥解码为原始内容，正常写入白名单；</li>
<li><code>delegate_to: 172.16.0.41</code>：核心指令！把这个任务的执行目标，从控制端61切换到被控制端41，不用手动登录41操作；</li>
<li><code>user: root</code>：公钥写入41服务器root用户的白名单，控制端后续以root身份免密连接41。</li>
</ul>
<h2 data-id="heading-6">四、一键验证：免密是否生效？</h2>
<p>在控制端61执行以下命令，<strong>不用输密码</strong>就能连接41，说明配置成功：
运行</p>
<pre><code class="hljs language-css" lang="css">ssh root<span class="hljs-keyword">@172</span>.16.0.41
</code></pre>
<h2 data-id="heading-7">五、快速扩展：一键免密多台服务器</h2>
<p>如果需要同时免密41、31，只需把步骤3改成遍历IP，一行搞定多台：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">免密控制多台服务器</span>
  <span class="hljs-attr">authorized_key:</span>
    <span class="hljs-attr">user:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">key:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ id_rsa_pub.content | b64decode }}</span>"</span>
  <span class="hljs-attr">delegate_to:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ item }}</span>"</span>
  <span class="hljs-attr">with_items:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-number">172.16</span><span class="hljs-number">.0</span><span class="hljs-number">.41</span>
    <span class="hljs-bullet">-</span> <span class="hljs-number">172.16</span><span class="hljs-number">.0</span><span class="hljs-number">.31</span>
</code></pre>
<h2 data-id="heading-8">总结</h2>
<ol>
<li>SSH免密核心：<strong>控制端生密钥对，公钥写入被控制端的 /root/.ssh/authorized_keys</strong>；</li>
<li>Ansible实现3步：<strong>生成密钥→读取公钥→写入远端白名单</strong>，全程自动化，重复执行不报错；</li>
<li>关键要点：<code>creates</code>防重复生成、<code>slurp</code>保公钥完整、<code>delegate_to</code>切执行目标，这是生产环境规范写法。</li>
</ol>
<h2 data-id="heading-9">最后人话举个栗子🌰：由于此时此刻的运维机对控制的两台机器都做了免密，我们把其中一台称为小明，一台称为小美，运维机有两家智能锁的编辑权限。某一天，小明要去小美家修家电，但是小美家的智能锁不认识小明，小明怎么按指纹都无济于事。这个时候，运维机就可以向小明要手指指纹，然后保存一下，进入小美家的智能锁后台系统，输入小明的指纹。于是，小明再次按压指纹，就可以进入小美的家中了，也可以操控小美家的电灯电视洗衣机了🤭</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent应用开发初探]]></title>    <link>https://juejin.cn/post/7603352061469442090</link>    <guid>https://juejin.cn/post/7603352061469442090</guid>    <pubDate>2026-02-06T03:38:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7603352061469442090" data-draft-id="7603352061469425706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent应用开发初探"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-02-06T03:38:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户7694900413493"/> <meta itemprop="url" content="https://juejin.cn/user/442428164682333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent应用开发初探
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/442428164682333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户7694900413493
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-06T03:38:03.000Z" title="Fri Feb 06 2026 03:38:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-06
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">一、从 LLM 到 Agent</h2>
<p>LLM：基于Transform + 大参数量 + 大数据量 =&gt; 从概率上预测文本接下来的内容，使文本得到合理的“延续”，最终表现为像有思考能力的“大脑🧠”一样，能够基于问题回答问题。</p>
<p>Agent：基于LLM能力，提供“四肢”，使得像人一样，不仅能思考还能行动。所谓的“四肢”，可以理解为由用户实时数据+工具，使得LLM与现实建立连接，并且能对现实产生影响。</p>
<h2 data-id="heading-1">二、AI Agent的系统组成</h2>
<h3 data-id="heading-2">1. 上下文(Context &amp; Memory)</h3>
<blockquote>
<p>上下文：历史对话记录，通常表现为User-AI一问一答的形式</p>
<p>记忆：AI回复能够基于历史对话进行回复，像拥有记忆一样</p>
</blockquote>
<h4 data-id="heading-3">1. 记忆实现</h4>
<p>每次请求模型时，携带历史对话窗口信息，当作query的一部分。</p>
<p>对话窗口通常实现为滑动窗口，维护最近n轮对话信息。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3706679e3e541fdbbd6209eb7d4702c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=RtPvizwYThLHIabxM7ougJyhwDU%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h4 data-id="heading-4">2. 上下文维护</h4>
<p>在最简单（滑动窗口）实现的<strong>短期</strong>记忆基础上，考虑如何<strong>更高效维护长短记忆（降低成本</strong> <strong>token</strong> <strong>消耗</strong>）、<strong>维护长期记忆</strong>。</p>
<p><strong>降低成本：</strong></p>
<ol>
<li>多轮对话改写：将<strong>能够</strong>压缩的多轮对话，精简至一条。</li>
<li>阶段总结：总结窗口内前m轮对话为一条，最近n-m条不变。</li>
</ol>
<p><strong>维护长期记忆：</strong></p>
<ol>
<li>滚动摘要：每n轮对话，总结一次对话内容，将总结结果维护至系统提示词or向量化嵌入，进行文档召回。</li>
</ol>
<h3 data-id="heading-5">2. 检索增强 (RAG)</h3>
<blockquote>
<p>提供<strong>外部数据源信息</strong>作为模型生成内容时的参考。</p>
</blockquote>
<p>文档：用户提供的文本信息，欲为模型提供信息（外部数据源）。</p>
<p>文档解析：读取文档中的文本内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1e3bf1f6e3f4f1e8ecad0224cf763df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=l9UtxII6Kts6P0j6PAR7lMCEks4%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>文档切分：将文本内容切分成小的一段（chunk）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4a2298fd5d84731aa6f718c81e11f3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=7MB%2FQvkklg9NsA%2FrGiygwmK9bPM%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>向量化：通过向量化模型将文本解析成多维向量。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fe99e552afd4d02b586fd7b069e5205~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=NZtC8373h%2FMSSSjJWWKAHSR7Acg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>嵌入：向量存储到向量数据库的动作。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bad3f22608184fc9983441fcfa3b9b63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=yaGrLw%2B8nvxIu40ECGi0rrsFuMw%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>文档召回：根据query，将query向量化，从向量化数据库中根据<strong>向量相似度计算</strong>进行文档召回。</p>
<p>重排序：应用于文档召回的结果，再做一次<strong>精排</strong>过滤。</p>
<p>向量与文本之间的关系：</p>
<ol>
<li>
<p>向量时是文本在<strong>语义空间</strong>里的<strong>位置坐标</strong>。</p>
</li>
<li>
<p>每一个维度表示一种语义，用来区分文本的表达，同时向量维度越高，表达力越高，同时对向量化模型的能力与向量的存储要求也高。</p>
</li>
</ol>
<p>eg.</p>
<p>文本：你是谁</p>
<p>[   0.02134, -0.11782,  0.33491, -0.05217,  0.90831, -0.44102,  0.12944, -0.77230,   0.05681,  0.24899, -0.31540,  0.60127, -0.04498,  0.18733,  0.09211, -0.50988,   0.41102, -0.03277,  0.27561, -0.19844,  0.00321,  0.81277, -0.62108,  0.14419,   ...   -0.08211,  0.19344, -0.44720,  0.06177 ]</p>
<p>RAG核心流程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc4966c39f40411f83842e0d4e2b31f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=CMKZEhYgmRIl6uBHFv9aaeb8pOo%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h3 data-id="heading-6">3. 工具调用 (Function calling)</h3>
<blockquote>
<p>给模型提供的工具，使得能够与外界进行<strong>交互与应用</strong>，实现<strong>数据交换</strong>或<strong>产生影响。</strong></p>
<p>模型通过开发者对工具的定义，判断什么情况下需要调用工具。</p>
</blockquote>
<p>function calling流程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6ceffcdf7b5452486799b0952969e27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=DnH1iKQr0A%2B8wEeSlmzUTtIVbIc%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>1次工具调用 =&gt; 与至少模型交互2回合</p>
<h4 data-id="heading-7">MCP</h4>
<blockquote>
<p>大模型与外界数据源交互的统一协议。</p>
</blockquote>
<p>在agent应用中，本质也是一种工具调用（function calling），就是规范协议，方便开发者接入与开发。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16200b11e2514f018ec48668260e9a0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=v9ULzqraeHYScSFzC9woqF0KG60%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<h2 data-id="heading-8">三、大模型应用框架</h2>
<blockquote>
<p>引言：</p>
<p>模型只提供生成能力，以工程的角度来看就是提供一个对话API，包含模型超参、上下文信息、是否开启流式等等。</p>
<p>但仅依赖模型原生能力，难以构建具备<strong>拟人性、可用性和工程可靠性</strong>的对话系统，因此在实际应用中，还需要围绕模型引入一系列工程能力，包括：</p>
<p>记忆实现、记忆（上下文）维护、提示词工程、检索增强（RAG）、工具调用（辅助生成/产生影响）。</p>
<p>为了更关注工程实现，避免重复实现这些通用能力，就有了大模型应用框架，对上述能力统一进行了抽象和封装，</p>
<p>让开发逻辑聚焦于需要实现什么样的对话能力，而不是控制如何跟模型交互。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50def9559929483eb79972f3738fad16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=1TflBqmvQDoF7dYkSWPhty07TRc%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
</blockquote>
<h3 data-id="heading-9">业内主流应用框架</h3>













































<table><thead><tr><th/><th/><th/><th/><th/><th/></tr></thead><tbody><tr><td><strong>维度</strong></td><td><strong>LangChain</strong></td><td><strong>LangChain4j</strong></td><td><strong>Spring AI</strong></td><td><strong>Eino</strong></td><td/></tr><tr><td>语言</td><td>Python</td><td>Java</td><td>Java</td><td>Go</td><td/></tr><tr><td>定位</td><td>LLM 应用框架</td><td>LangChain 的 Java 生态实现</td><td>Spring 体系下的 AI 抽象层</td><td>Go 生态的 LLM 应用框架</td><td/></tr><tr><td>与业务框架融合</td><td>弱（偏独立库）</td><td>中等</td><td>强（Spring 原生）</td><td>中等</td><td/></tr></tbody></table>
<h3 data-id="heading-10">Langchain4j</h3>
<h4 data-id="heading-11">1. 聊天</h4>
<p><strong>语言模型</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1753cc1148c447ddb87d47f72b011a7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=Y%2BhNwRiZ2JCAO4XkI7RngV1Bc4E%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<pre><code class="hljs language-scss" lang="scss">OpenAiChatModel model = OpenAiChatModel<span class="hljs-selector-class">.builder</span>()
        <span class="hljs-selector-class">.apiKey</span>(System.getenv("OPENAI_API_KEY"))
        <span class="hljs-selector-class">.modelName</span>("gpt-<span class="hljs-number">4</span>o-mini")
        <span class="hljs-selector-class">.temperature</span>(<span class="hljs-number">0.3</span>)
        <span class="hljs-selector-class">.timeout</span>(ofSeconds(<span class="hljs-number">60</span>))
        <span class="hljs-selector-class">.build</span>();
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>聊天消息类型</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a49db446dc7d46e68e0e9ce8d43cdd28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=sUulENE6dhTJNWj02ZWfLJJeYl4%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p><strong>聊天记忆</strong></p>
<p>ChatMemory接口提供聊天对话存储能力（记忆），可以自实现接口实现持久化存储。langchain4j提供了两种实现：</p>
<ul>
<li><code>MessageWindowChatMemory：</code> 滑动窗口，仅保留最近窗口内的N条对话记录。</li>
</ul>

<ul>
<li><code>MessageWindowChatMemory：</code> 也是滑动窗口，但专注于保留最近N个Token。</li>
</ul>
<p>当有新消息时，会自动回调ChatMemory接口中相关的方法，同步更新对话上下文存储。</p>
<p><strong>聊天示例：</strong></p>
<pre><code class="hljs language-scss" lang="scss">interface Assistant {
    String <span class="hljs-built_in">chat</span>(String message);
}

public static void <span class="hljs-selector-tag">main</span>(String[] args) {
    <span class="hljs-comment">// 1. 最近对话(记忆)存储器</span>
    ChatMemory chatMemory = MessageWindowChatMemory<span class="hljs-selector-class">.withMaxMessages</span>(<span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 2. 语言模型</span>
    ChatModel model = OpenAiChatModel<span class="hljs-selector-class">.builder</span>()
            <span class="hljs-selector-class">.apiKey</span>(ApiKeys.OPENAI_API_KEY)
            <span class="hljs-selector-class">.modelName</span>(GPT_4_O_MINI)
            <span class="hljs-selector-class">.build</span>();
    
    <span class="hljs-comment">// 3. ai服务</span>
    Assistant assistant = AiServices<span class="hljs-selector-class">.builder</span>(Assistant.class)
            <span class="hljs-selector-class">.chatModel</span>(model)
            <span class="hljs-selector-class">.chatMemory</span>(chatMemory)
            <span class="hljs-selector-class">.build</span>();

    String answer = assistant<span class="hljs-selector-class">.chat</span>("你好，我叫小明");
    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(answer); <span class="hljs-comment">// 小明你好，有什么可以帮助你的吗？</span>

    String answerWithName = assistant<span class="hljs-selector-class">.chat</span>("我的名字叫啥");
    System<span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(answerWithName); <span class="hljs-comment">// 你叫小明</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-12">2. 工具调用</h4>
<h5 data-id="heading-13"><strong>1. 工具定义</strong></h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Tool("对给定的 2 个数字求和")</span>
<span class="hljs-type">double</span> <span class="hljs-title function_">sum</span><span class="hljs-params">(<span class="hljs-type">double</span> a, <span class="hljs-type">double</span> b)</span> {
    <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-meta">@Tool("返回给定数字的平方根")</span>
<span class="hljs-type">double</span> <span class="hljs-title function_">squareRoot</span><span class="hljs-params">(<span class="hljs-type">double</span> x)</span> {
    <span class="hljs-keyword">return</span> Math.sqrt(x);
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-14"><strong>2. 工具注册</strong></h5>
<pre><code class="hljs language-arduino" lang="arduino">interface MathGenius {
    
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">ask</span><span class="hljs-params">(<span class="hljs-type">String</span> question)</span></span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Calculator</span> {
    
    @<span class="hljs-function">Tool
    <span class="hljs-type">double</span> <span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> </span>{
        <span class="hljs-keyword">return</span> a + b;
    }

    @<span class="hljs-function">Tool
    <span class="hljs-type">double</span> <span class="hljs-title">squareRoot</span><span class="hljs-params">(<span class="hljs-type">double</span> x)</span> </span>{
        <span class="hljs-keyword">return</span> Math.<span class="hljs-built_in">sqrt</span>(x);
    }
}

MathGenius mathGenius = AiServices.<span class="hljs-built_in">builder</span>(MathGenius.<span class="hljs-keyword">class</span>)
    .<span class="hljs-built_in">chatLanguageModel</span>(model)
    .<span class="hljs-built_in">tools</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Calculator</span>())
    .<span class="hljs-built_in">build</span>();

<span class="hljs-type">String</span> answer = mathGenius.<span class="hljs-built_in">ask</span>(<span class="hljs-string">"475695037565 的平方根是多少？"</span>);

System.out.<span class="hljs-built_in">println</span>(answer); <span class="hljs-comment">// 475695037565 的平方根是 689706.486532。</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-15"><strong>3. 调用过程</strong></h5>
<pre><code class="hljs language-markdown" lang="markdown">请求 1：
<span class="hljs-bullet">-</span> 消息：
<span class="hljs-bullet">    -</span> UserMessage：
<span class="hljs-bullet">        -</span> 文本：475695037565 的平方根是多少？
<span class="hljs-bullet">-</span> 工具：
<span class="hljs-bullet">    -</span> sum(double a, double b)：对给定的 2 个数字求和
<span class="hljs-bullet">    -</span> squareRoot(double x)：返回给定数字的平方根

响应 1：
<span class="hljs-bullet">-</span> AiMessage：
<span class="hljs-bullet">    -</span> toolExecutionRequests：
<span class="hljs-bullet">        -</span> squareRoot(475695037565)


请求 2：
<span class="hljs-bullet">-</span> 消息：
<span class="hljs-bullet">    -</span> UserMessage：
<span class="hljs-bullet">        -</span> 文本：475695037565 的平方根是多少？
<span class="hljs-bullet">    -</span> AiMessage：
<span class="hljs-bullet">        -</span> toolExecutionRequests：
<span class="hljs-bullet">            -</span> squareRoot(475695037565)
<span class="hljs-bullet">    -</span> ToolExecutionResultMessage：
<span class="hljs-bullet">        -</span> 文本：689706.486532

响应 2：
<span class="hljs-bullet">-</span> AiMessage：
<span class="hljs-bullet">    -</span> 文本：475695037565 的平方根是 689706.486532。
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-16">4. MCP接入</h5>
<blockquote>
<p>框架提供mcp客户端的封装，只需要注册mcp客户端，即可像调工具一样调用mcp服务。</p>
</blockquote>
<p><strong>接入示例</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">McpDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">String</span> dashscopeApiKey = <span class="hljs-string">"api-key"</span>;
        
        <span class="hljs-comment">// 0. mcp客户端鉴权</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; headers = <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">of</span>(
            <span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Bearer "</span> + dashscopeApiKey,
            <span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"application/json"</span>
        );
        
        <span class="hljs-comment">// 1. mcp（联网搜索）封装</span>
        <span class="hljs-title class_">McpTransport</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamableHttpMcpTransport</span>.<span class="hljs-title class_">Builder</span>()
            .<span class="hljs-title function_">url</span>(<span class="hljs-string">"https://dashscope.aliyuncs.com/api/v1/mcps/WebSearch/sse"</span>)
            .<span class="hljs-title function_">customHeaders</span>(headers)
            .<span class="hljs-title function_">logRequests</span>(<span class="hljs-literal">true</span>)
            .<span class="hljs-title function_">logResponses</span>(<span class="hljs-literal">true</span>)
            .<span class="hljs-title function_">build</span>();
        
        <span class="hljs-comment">// 2. mcp注册</span>
        <span class="hljs-title class_">McpClient</span> mcpClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMcpClient</span>.<span class="hljs-title class_">Builder</span>()
            .<span class="hljs-title function_">transport</span>(transport)
            .<span class="hljs-title function_">build</span>();

        <span class="hljs-title class_">McpToolProvider</span> toolProvider = <span class="hljs-title class_">McpToolProvider</span>.<span class="hljs-title function_">builder</span>()
            .<span class="hljs-title function_">mcpClients</span>(<span class="hljs-title class_">List</span>.<span class="hljs-title function_">of</span>(mcpClient))
            .<span class="hljs-title function_">build</span>();
        
        <span class="hljs-comment">// 3. 带有联网搜索能力的ai服务</span>
        <span class="hljs-title class_">Bot</span> bot = <span class="hljs-title class_">AiServices</span>.<span class="hljs-title function_">builder</span>(<span class="hljs-title class_">Bot</span>.<span class="hljs-property">class</span>)
            .<span class="hljs-title function_">chatLanguageModel</span>(model)
            .<span class="hljs-title function_">toolProvider</span>(toolProvider)
            .<span class="hljs-title function_">build</span>()
            .<span class="hljs-title function_">getService</span>();
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-17">3. RAG</h4>
<p><strong>关键词解释</strong></p>
<p>Query：用户输入</p>
<p>Embedding Model： 向量化模型</p>
<p>Embedding Store： 向量化数据库</p>
<p>Relevant Segments： 检索（召回）结果</p>
<p>Retrieval Augmentor： 检索增强器，所有RAG相关的组件封装在该类中。</p>
<p>QueryTransformer： 问题拆分器，如果一次query包含多个问题，会被拆分成子问题。</p>
<p>Content Retrieval：内容检索器，从给定数据源（向量数据库）中检索。</p>
<p>Query Router：query路由器，将拆分的子问题智能路由到检索器中。</p>
<p>Content Aggregator：内容聚合器，规定如何将多个内容检索器的结果聚合。</p>
<p>Content Injector：规定检索结果如何嵌入到原始query中。</p>
<h5 data-id="heading-18">检索流程</h5>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f159996386943c586c680e610eae538~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=OxmUW%2Fv0FS7h30LD68yd5id%2Flmg%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p><strong>作业流程</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/223bb2ecdd754898b8bf335a776f2b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzY5NDkwMDQxMzQ5Mw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770953882&amp;x-signature=xmA%2BJGT4%2BMY9Cr35qPIdrJqdIsI%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>