<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[【2025】加入 uniapp 的一年]]></title>    <link>https://juejin.cn/post/7605174711181951039</link>    <guid>https://juejin.cn/post/7605174711181951039</guid>    <pubDate>2026-02-11T09:04:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605174711181951039" data-draft-id="7605150769008558123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【2025】加入 uniapp 的一年"/> <meta itemprop="keywords" content="前端,uni-app"/> <meta itemprop="datePublished" content="2026-02-11T09:04:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="笨笨狗吞噬者"/> <meta itemprop="url" content="https://juejin.cn/user/245921884145240"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【2025】加入 uniapp 的一年
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/245921884145240/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    笨笨狗吞噬者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:04:48.000Z" title="Wed Feb 11 2026 09:04:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文主要分享过去一年自己入职 uniapp 的经历。</p>
<h2 data-id="heading-1">经历</h2>
<h3 data-id="heading-2">未雨绸缪的离职</h3>
<p>2025 年过完年之后，因为各种原因，我打定了离职的想法。经历了一段时间的折腾，拿到了一个 offer，当时感觉还可以，已经打算去了。</p>
<p>后面，耗子哥联系我说 uniapp 在招人，问我要不要试试，当时也没多想，反正试试又不要钱，走了朋友的内推，顺利通过了两轮面试，四月初就入职了。</p>
<h3 data-id="heading-3">压力山大的实习</h3>
<p>情况并没有我想象的那么好，甚至可以说是相当糟糕。</p>
<p>公司要做的东西不是常规业务，加上自己对 vue 的编译时、运行时等等也不熟悉，想修复社区的问题也是相当难受，因为我压根不了解 uniapp 的使用，上家公司用 uniapp vue2 做了微信小程序，对它的印象糟糕透了，也就没花功夫去学习下。</p>
<p>不过，对我而言，还是有些好的消息。</p>
<ul>
<li>内推我的同事对我很好，不懂的内容都可以去请教他；前端组的同事实力很强，也必较耐心</li>
<li>之前写过 rollup、vite、eslint 和 vscode 插件，维护过不少开源项目，不至于对于 node、编译相关的东西一窍不通</li>
</ul>
<p>大概入职一周左右，我开始尝试提交第一个pr，这个修复成为了我那几天的噩梦，uniapp 还是挺复杂的，很多东西我根本就不明白，设计，实现，修复和验证的流程等等。</p>
<p>我花了不少时间，可是还没解决那个app端的问题，当时很沮丧，都有点打退堂鼓的意思了。</p>
<p>后面我开始尝试其他端问题的修复，领导也跟我说让我解决小程序相关的问题，我就开始了打怪升级之路。</p>
<p>试用期是三个月，大概六月底，就开始了转正答辩，中间也是折腾了很久，这里就不赘述了（说多了都是泪）。</p>
<p>我的答辩 md 文件我是存储在了 github 上，截一部分当时做的内容。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ab4cd8781fd43b4827c43fe0ef63dd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56yo56yo54uX5ZCe5Zms6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771405488&amp;x-signature=doVxRiOpZeSdvTF1R1auKYVPRwk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">慢慢成长的转正</h3>
<p>转正之后，随着工作的进行，对于 uniapp 也越来越熟悉，自己的能力也得到了不少提升，在掘金和uniapp的ask社区也写了一些小程序相关的文章。</p>
<p>上家公司当时写小程序被包体积超出的问题来回折磨，回头想想，自己目前会的应该能极大地缓解这个问题。</p>
<p>github 的 uniapp 仓库我刚刚查了一下，大概有 400 多次提交（包含 dev分支 (vue2)、next分支 （vue3）），不知道什么时候能超过前面的辛宝哥。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83a81073286b432fac5e0bf0fade41f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56yo56yo54uX5ZCe5Zms6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771405488&amp;x-signature=zGioiR1XAfLKKBSLNrz7rTkE2cc%3D" alt="image.png" loading="lazy"/></p>
<p>因为自己主要负责小程序方面，这段时间对于 uniapp 和 小程序有了更多的了解，还荣幸地加入了 uni-helper 社区。</p>
<p>除了技术，终于在年底拿到了驾照。</p>
<p>我大概在7-8月份报考了海淀驾校，那个时候顶着炎炎烈日去驾校练车，基本都是周末的时间，真的太遭罪了。</p>
<p>每学一次车，一天的时间都要花费在这上面了，不过好在结局不错，顺利一把过，拿到了驾照。</p>
<h2 data-id="heading-5">结语</h2>
<p>新的一年，希望大家都能更好。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java学习第36天 - 响应式编程、虚拟线程与现代化技术栈]]></title>    <link>https://juejin.cn/post/7605214360084398116</link>    <guid>https://juejin.cn/post/7605214360084398116</guid>    <pubDate>2026-02-11T09:04:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605214360084398116" data-draft-id="7605214360084348964" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java学习第36天 - 响应式编程、虚拟线程与现代化技术栈"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-02-11T09:04:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="浮游本尊"/> <meta itemprop="url" content="https://juejin.cn/user/2533726710668696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java学习第36天 - 响应式编程、虚拟线程与现代化技术栈
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2533726710668696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    浮游本尊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:04:53.000Z" title="Wed Feb 11 2026 09:04:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、学习目标</h3>
<ul>
<li>掌握 <strong>Reactor</strong> 的核心概念与常用操作符（Mono、Flux、背压、map/flatMap/zip/then 等）。</li>
<li>掌握 <strong>Spring WebFlux</strong> 的基本使用：响应式 Controller、R2DBC、WebClient。</li>
<li>理解 <strong>虚拟线程（Virtual Threads，Java 21+）</strong> 与 <strong>结构化并发（Structured Concurrency）</strong> 的基本用法。</li>
<li>理解并实践 <strong>可观测性</strong>：指标（Metrics）、链路追踪（Tracing）、结构化日志（Logging）。</li>
<li>能够在现有 Spring MVC 项目中，逐步引入 WebFlux、虚拟线程和可观测性，完成现代化改造雏形。</li>
</ul>
<hr/>
<h3 data-id="heading-1">二、响应式编程基础（Reactor）</h3>
<h4 data-id="heading-2">2.1 核心概念：Publisher / Subscriber / 背压</h4>
<ol>
<li>
<p>响应式流标准（Reactive Streams）包含四个核心接口：</p>
<ul>
<li><code>Publisher</code>：数据发布者</li>
<li><code>Subscriber</code>：数据订阅者</li>
<li><code>Subscription</code>：订阅关系</li>
<li><code>Processor</code>：既是 Publisher 又是 Subscriber</li>
</ul>
</li>
<li>
<p>Reactor 中常用类型：</p>
<ul>
<li><code>Mono&lt;T&gt;</code>：0 或 1 个元素</li>
<li><code>Flux&lt;T&gt;</code>：0 到 N 个元素</li>
</ul>
</li>
<li>
<p>基本示例：</p>
</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactorBasics</span> {

    <span class="hljs-comment">// Mono：0 或 1 个元素</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Mono&lt;String&gt; <span class="hljs-title function_">monoExample</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-string">"Hello"</span>)
                .map(String::toUpperCase)
                .doOnNext(s -&gt; System.out.println(<span class="hljs-string">"Mono: "</span> + s))
                .doOnSuccess(s -&gt; System.out.println(<span class="hljs-string">"Mono 完成"</span>));
    }

    <span class="hljs-comment">// Flux：0~N 个元素</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Flux&lt;Integer&gt; <span class="hljs-title function_">fluxExample</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)
                .map(i -&gt; i * <span class="hljs-number">2</span>)
                .doOnNext(i -&gt; System.out.println(<span class="hljs-string">"Flux: "</span> + i))
                .doOnComplete(() -&gt; System.out.println(<span class="hljs-string">"Flux 完成"</span>));
    }

    <span class="hljs-comment">// 从 Optional 创建 Mono</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Mono&lt;String&gt; <span class="hljs-title function_">fromOptional</span><span class="hljs-params">(Optional&lt;String&gt; opt)</span> {
        <span class="hljs-keyword">return</span> Mono.justOrEmpty(opt);
    }

    <span class="hljs-comment">// 背压示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">backpressureExample</span><span class="hljs-params">()</span> {
        Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)
                .log()
                .limitRate(<span class="hljs-number">10</span>) <span class="hljs-comment">// 每次最多请求 10 个</span>
                .subscribe(
                        i -&gt; System.out.println(<span class="hljs-string">"onNext: "</span> + i),
                        err -&gt; err.printStackTrace(),
                        () -&gt; System.out.println(<span class="hljs-string">"完成"</span>)
                );
    }

    <span class="hljs-comment">// 错误处理：onErrorResume / onErrorReturn</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Mono&lt;String&gt; <span class="hljs-title function_">errorHandlingExample</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Mono.&lt;String&gt;error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"模拟错误"</span>))
                .onErrorResume(e -&gt; {
                    System.out.println(<span class="hljs-string">"发生错误: "</span> + e.getMessage());
                    <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-string">"降级值"</span>);
                })
                .onErrorReturn(<span class="hljs-string">"默认值"</span>);
    }
}
</code></pre>
<h4 data-id="heading-3">2.2 常用操作符：map、flatMap、zip、then、buffer</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-keyword">import</span> java.time.Duration;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactorOperators</span> {

    <span class="hljs-comment">// map：同步转换</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Flux&lt;String&gt; <span class="hljs-title function_">mapExample</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>)
                .map(String::toUpperCase);
    }

    <span class="hljs-comment">// flatMap：异步转换</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Flux&lt;String&gt; <span class="hljs-title function_">flatMapExample</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
                .flatMap(i -&gt;
                        Mono.just(<span class="hljs-string">"item-"</span> + i)
                                .delayElement(Duration.ofMillis(<span class="hljs-number">100</span>))
                );
    }

    <span class="hljs-comment">// zip：组合多个 Publisher</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Mono&lt;String&gt; <span class="hljs-title function_">zipExample</span><span class="hljs-params">()</span> {
        Mono&lt;String&gt; first = Mono.just(<span class="hljs-string">"Hello"</span>);
        Mono&lt;String&gt; second = Mono.just(<span class="hljs-string">"Reactor"</span>);
        <span class="hljs-keyword">return</span> Mono.zip(first, second)
                .map(tuple -&gt; tuple.getT1() + <span class="hljs-string">" "</span> + tuple.getT2());
    }

    <span class="hljs-comment">// then：只关心前面完成信号，不关心值</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Mono&lt;Void&gt; <span class="hljs-title function_">thenExample</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-string">"step1"</span>)
                .doOnNext(System.out::println)
                .then(Mono.just(<span class="hljs-string">"step2"</span>).doOnNext(System.out::println))
                .then();
    }

    <span class="hljs-comment">// merge / concat：合并流</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Flux&lt;Integer&gt; <span class="hljs-title function_">mergeExample</span><span class="hljs-params">()</span> {
        Flux&lt;Integer&gt; even = Flux.just(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>);
        Flux&lt;Integer&gt; odd = Flux.just(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>);
        <span class="hljs-keyword">return</span> Flux.merge(even, odd);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Flux&lt;Integer&gt; <span class="hljs-title function_">concatExample</span><span class="hljs-params">()</span> {
        Flux&lt;Integer&gt; first = Flux.just(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);
        Flux&lt;Integer&gt; second = Flux.just(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>);
        <span class="hljs-keyword">return</span> Flux.concat(first, second);
    }

    <span class="hljs-comment">// buffer：缓冲</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Flux&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">bufferExample</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>).buffer(<span class="hljs-number">3</span>); <span class="hljs-comment">// [1,2,3], [4,5,6], [7,8,9], [10]</span>
    }
}
</code></pre>
<h4 data-id="heading-4">2.3 调度器（Scheduler）与线程模型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> reactor.core.publisher.Flux;
<span class="hljs-keyword">import</span> reactor.core.scheduler.Schedulers;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactorSchedulers</span> {

    <span class="hljs-comment">// subscribeOn：影响数据源执行线程</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Flux&lt;Integer&gt; <span class="hljs-title function_">subscribeOnBoundedElastic</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)
                .subscribeOn(Schedulers.boundedElastic())
                .map(i -&gt; {
                    System.out.println(<span class="hljs-string">"subscribeOn 线程: "</span> + Thread.currentThread().getName());
                    <span class="hljs-keyword">return</span> i;
                });
    }

    <span class="hljs-comment">// publishOn：影响后续操作符执行线程</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Flux&lt;Integer&gt; <span class="hljs-title function_">publishOnParallel</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)
                .publishOn(Schedulers.parallel())
                .map(i -&gt; {
                    System.out.println(<span class="hljs-string">"publishOn 线程: "</span> + Thread.currentThread().getName());
                    <span class="hljs-keyword">return</span> i;
                });
    }

    <span class="hljs-comment">// 组合使用</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Flux&lt;Integer&gt; <span class="hljs-title function_">mixedSchedulers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)
                .subscribeOn(Schedulers.boundedElastic())
                .map(i -&gt; i * <span class="hljs-number">2</span>)
                .publishOn(Schedulers.parallel())
                .map(i -&gt; i + <span class="hljs-number">1</span>);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-5">三、Spring WebFlux 与响应式 Web</h3>
<h4 data-id="heading-6">3.1 依赖与启动类</h4>
<p>（以 Maven 为例）</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 引入 WebFlux 与 R2DBC --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-r2dbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;

<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebFluxApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(WebFluxApplication.class, args);
    }
}
</code></pre>
<h4 data-id="heading-7">3.2 响应式 Controller（使用 Mono / Flux）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;
<span class="hljs-keyword">import</span> org.springframework.http.MediaType;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;
<span class="hljs-keyword">import</span> org.springframework.web.server.ResponseStatusException;
<span class="hljs-keyword">import</span> reactor.core.publisher.Mono;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-keyword">import</span> javax.validation.Valid;
<span class="hljs-keyword">import</span> java.time.Duration;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/reactive")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveUserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReactiveUserService userService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReactiveUserController</span><span class="hljs-params">(ReactiveUserService userService)</span> {
        <span class="hljs-built_in">this</span>.userService = userService;
    }

    <span class="hljs-meta">@GetMapping("/users/{id}")</span>
    <span class="hljs-keyword">public</span> Mono&lt;UserDTO&gt; <span class="hljs-title function_">getById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-keyword">return</span> userService.findById(id)
                .switchIfEmpty(Mono.error(
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResponseStatusException</span>(HttpStatus.NOT_FOUND, <span class="hljs-string">"用户不存在"</span>)
                ));
    }

    <span class="hljs-meta">@GetMapping("/users")</span>
    <span class="hljs-keyword">public</span> Flux&lt;UserDTO&gt; <span class="hljs-title function_">list</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam(defaultValue = "0")</span> <span class="hljs-type">int</span> page,
            <span class="hljs-meta">@RequestParam(defaultValue = "10")</span> <span class="hljs-type">int</span> size)</span> {
        <span class="hljs-keyword">return</span> userService.findAll(page, size);
    }

    <span class="hljs-meta">@PostMapping("/users")</span>
    <span class="hljs-keyword">public</span> Mono&lt;UserDTO&gt; <span class="hljs-title function_">create</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> <span class="hljs-meta">@Valid</span> UserCreateRequest request)</span> {
        <span class="hljs-keyword">return</span> userService.create(request);
    }

    <span class="hljs-comment">// SSE：流式推送用户数据</span>
    <span class="hljs-meta">@GetMapping(value = "/users/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span>
    <span class="hljs-keyword">public</span> Flux&lt;UserDTO&gt; <span class="hljs-title function_">stream</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userService.findAllStream()
                .delayElements(Duration.ofSeconds(<span class="hljs-number">1</span>)); <span class="hljs-comment">// 模拟每秒推送一条</span>
    }
}
</code></pre>
<h4 data-id="heading-8">3.3 响应式 Service 与 R2DBC Repository</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.domain.PageRequest;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> reactor.core.publisher.Mono;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveUserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReactiveUserRepository repository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReactiveUserService</span><span class="hljs-params">(ReactiveUserRepository repository)</span> {
        <span class="hljs-built_in">this</span>.repository = repository;
    }

    <span class="hljs-keyword">public</span> Mono&lt;UserDTO&gt; <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> repository.findById(id).map(<span class="hljs-built_in">this</span>::toDTO);
    }

    <span class="hljs-keyword">public</span> Flux&lt;UserDTO&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">(<span class="hljs-type">int</span> page, <span class="hljs-type">int</span> size)</span> {
        <span class="hljs-keyword">return</span> repository
                .findAllBy(PageRequest.of(page, size))
                .map(<span class="hljs-built_in">this</span>::toDTO);
    }

    <span class="hljs-keyword">public</span> Mono&lt;UserDTO&gt; <span class="hljs-title function_">create</span><span class="hljs-params">(UserCreateRequest request)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        entity.setUsername(request.getUsername());
        entity.setEmail(request.getEmail());
        <span class="hljs-comment">// 其他字段...</span>

        <span class="hljs-keyword">return</span> repository.save(entity).map(<span class="hljs-built_in">this</span>::toDTO);
    }

    <span class="hljs-keyword">public</span> Flux&lt;UserDTO&gt; <span class="hljs-title function_">findAllStream</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> repository.findAll().map(<span class="hljs-built_in">this</span>::toDTO);
    }

    <span class="hljs-keyword">private</span> UserDTO <span class="hljs-title function_">toDTO</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">dto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDTO</span>();
        dto.setId(user.getId());
        dto.setUsername(user.getUsername());
        dto.setEmail(user.getEmail());
        <span class="hljs-keyword">return</span> dto;
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.domain.Pageable;
<span class="hljs-keyword">import</span> org.springframework.data.repository.reactive.ReactiveCrudRepository;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ReactiveUserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ReactiveCrudRepository</span>&lt;User, Long&gt; {

    Flux&lt;User&gt; <span class="hljs-title function_">findAllBy</span><span class="hljs-params">(Pageable pageable)</span>;
}
</code></pre>
<h4 data-id="heading-9">3.4 WebClient：替代 RestTemplate 的响应式 HTTP 客户端</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.http.HttpHeaders;
<span class="hljs-keyword">import</span> org.springframework.http.MediaType;
<span class="hljs-keyword">import</span> org.springframework.http.HttpStatusCode;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.web.reactive.function.client.WebClient;
<span class="hljs-keyword">import</span> reactor.core.publisher.Mono;
<span class="hljs-keyword">import</span> reactor.core.publisher.Flux;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReactiveOrderClient</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WebClient webClient;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReactiveOrderClient</span><span class="hljs-params">(WebClient.Builder builder)</span> {
        <span class="hljs-built_in">this</span>.webClient = builder
                .baseUrl(<span class="hljs-string">"http://order-service"</span>)
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .build();
    }

    <span class="hljs-keyword">public</span> Mono&lt;OrderDTO&gt; <span class="hljs-title function_">getOrderById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> webClient.get()
                .uri(<span class="hljs-string">"/api/orders/{id}"</span>, id)
                .retrieve()
                .onStatus(HttpStatusCode::is4xxClientError,
                        resp -&gt; Mono.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单不存在"</span>)))
                .bodyToMono(OrderDTO.class);
    }

    <span class="hljs-keyword">public</span> Flux&lt;OrderDTO&gt; <span class="hljs-title function_">getOrdersByUserId</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-keyword">return</span> webClient.get()
                .uri(uriBuilder -&gt; uriBuilder
                        .path(<span class="hljs-string">"/api/orders"</span>)
                        .queryParam(<span class="hljs-string">"userId"</span>, userId)
                        .build())
                .retrieve()
                .bodyToFlux(OrderDTO.class);
    }

    <span class="hljs-keyword">public</span> Mono&lt;OrderDTO&gt; <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderCreateRequest request)</span> {
        <span class="hljs-keyword">return</span> webClient.post()
                .uri(<span class="hljs-string">"/api/orders"</span>)
                .bodyValue(request)
                .retrieve()
                .bodyToMono(OrderDTO.class);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-10">四、虚拟线程（Java 21+）与结构化并发</h3>
<h4 data-id="heading-11">4.1 虚拟线程的创建与使用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.Executors;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThreadDemo</span> {

    <span class="hljs-comment">// 方式一：虚拟线程池</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runWithVirtualThreads</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newVirtualThreadPerTaskExecutor()) {
            executor.submit(() -&gt;
                    System.out.println(<span class="hljs-string">"Task 1, virtual="</span> + Thread.currentThread().isVirtual()));
            executor.submit(() -&gt;
                    System.out.println(<span class="hljs-string">"Task 2, virtual="</span> + Thread.currentThread().isVirtual()));
        }
    }

    <span class="hljs-comment">// 方式二：直接创建虚拟线程</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">threadOfVirtual</span><span class="hljs-params">()</span> {
        Thread.ofVirtual()
                .name(<span class="hljs-string">"vt-"</span>, <span class="hljs-number">0</span>)
                .start(() -&gt;
                        System.out.println(<span class="hljs-string">"虚拟线程名称: "</span> + Thread.currentThread().getName()));
    }
}
</code></pre>
<h4 data-id="heading-12">4.2 结构化并发（StructuredTaskScope）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.StructuredTaskScope;
<span class="hljs-keyword">import</span> java.util.concurrent.StructuredTaskScope.ShutdownOnFailure;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StructuredConcurrencyDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span> {
        String user;
        String order;
        String product;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title function_">fetchUserOrderProduct</span><span class="hljs-params">(<span class="hljs-type">long</span> userId, <span class="hljs-type">long</span> orderId, <span class="hljs-type">long</span> productId)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShutdownOnFailure</span>()) {
            <span class="hljs-type">var</span> <span class="hljs-variable">userTask</span> <span class="hljs-operator">=</span> scope.fork(() -&gt; fetchUser(userId));
            <span class="hljs-type">var</span> <span class="hljs-variable">orderTask</span> <span class="hljs-operator">=</span> scope.fork(() -&gt; fetchOrder(orderId));
            <span class="hljs-type">var</span> <span class="hljs-variable">productTask</span> <span class="hljs-operator">=</span> scope.fork(() -&gt; fetchProduct(productId));

            scope.join();          <span class="hljs-comment">// 等待所有子任务完成</span>
            scope.throwIfFailed(); <span class="hljs-comment">// 任一失败则抛异常</span>

            <span class="hljs-type">Result</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>();
            r.user = userTask.get();
            r.order = orderTask.get();
            r.product = productTask.get();
            <span class="hljs-keyword">return</span> r;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">fetchUser</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        Thread.sleep(<span class="hljs-number">100</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"User-"</span> + id;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">fetchOrder</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        Thread.sleep(<span class="hljs-number">150</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Order-"</span> + id;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">fetchProduct</span><span class="hljs-params">(<span class="hljs-type">long</span> id)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        Thread.sleep(<span class="hljs-number">80</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Product-"</span> + id;
    }
}
</code></pre>
<h4 data-id="heading-13">4.3 Spring Boot 中启用虚拟线程</h4>
<p><code>application.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">threads:</span>
    <span class="hljs-attr">virtual:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>自定义异步任务使用虚拟线程：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.scheduling.annotation.Async;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;
<span class="hljs-keyword">import</span> java.util.concurrent.Executor;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThreadConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">virtualThreadExecutor</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Executors.newVirtualThreadPerTaskExecutor();
    }
}

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncService</span> {

    <span class="hljs-meta">@Async("virtualThreadExecutor")</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">asyncTask</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(
                <span class="hljs-string">"run on: "</span> + Thread.currentThread().getName() +
                        <span class="hljs-string">", virtual="</span> + Thread.currentThread().isVirtual()
        );
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-14">五、可观测性：指标、链路追踪与结构化日志</h3>
<h4 data-id="heading-15">5.1 Micrometer + Prometheus 指标</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.micrometer.core.instrument.Counter;
<span class="hljs-keyword">import</span> io.micrometer.core.instrument.Timer;
<span class="hljs-keyword">import</span> io.micrometer.core.instrument.MeterRegistry;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.time.Duration;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderMetricsService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter orderCreatedCounter;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Timer orderCreateTimer;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderMetricsService</span><span class="hljs-params">(MeterRegistry registry)</span> {
        <span class="hljs-built_in">this</span>.orderCreatedCounter = registry.counter(<span class="hljs-string">"order.created"</span>, <span class="hljs-string">"env"</span>, <span class="hljs-string">"dev"</span>);
        <span class="hljs-built_in">this</span>.orderCreateTimer = registry.timer(<span class="hljs-string">"order.create.duration"</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordOrderCreated</span><span class="hljs-params">()</span> {
        orderCreatedCounter.increment();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordOrderCreateDuration</span><span class="hljs-params">(Runnable runnable)</span> {
        orderCreateTimer.record(runnable);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordOrderCreateDuration</span><span class="hljs-params">(Duration duration)</span> {
        orderCreateTimer.record(duration);
    }
}
</code></pre>
<p><code>application.yml</code> 配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">health,info,prometheus</span>
  <span class="hljs-attr">endpoint:</span>
    <span class="hljs-attr">prometheus:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">metrics:</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-attr">application:</span> <span class="hljs-string">${spring.application.name}</span>
</code></pre>
<h4 data-id="heading-16">5.2 链路追踪：Micrometer Tracing + Zipkin</h4>
<p>依赖示例：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.micrometer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>micrometer-tracing-bridge-brave<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.zipkin.reporter2<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>zipkin-reporter-brave<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>配置示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">management:</span>
  <span class="hljs-attr">tracing:</span>
    <span class="hljs-attr">sampling:</span>
      <span class="hljs-attr">probability:</span> <span class="hljs-number">1.0</span>
  <span class="hljs-attr">zipkin:</span>
    <span class="hljs-attr">tracing:</span>
      <span class="hljs-attr">endpoint:</span> <span class="hljs-string">http://localhost:9411/api/v2/spans</span>
</code></pre>
<p>在业务代码中打 Span：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.micrometer.tracing.Tracer;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Tracer tracer;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(Tracer tracer)</span> {
        <span class="hljs-built_in">this</span>.tracer = tracer;
    }

    <span class="hljs-keyword">public</span> OrderDTO <span class="hljs-title function_">createOrder</span><span class="hljs-params">(CreateOrderRequest request)</span> {
        <span class="hljs-type">var</span> <span class="hljs-variable">span</span> <span class="hljs-operator">=</span> tracer.nextSpan().name(<span class="hljs-string">"createOrder"</span>).start();
        <span class="hljs-keyword">try</span> (Tracer.<span class="hljs-type">SpanInScope</span> <span class="hljs-variable">ws</span> <span class="hljs-operator">=</span> tracer.withSpan(span)) {
            span.tag(<span class="hljs-string">"order.userId"</span>, String.valueOf(request.getUserId()));
            <span class="hljs-comment">// 订单创建逻辑...</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDTO</span>();
        } <span class="hljs-keyword">finally</span> {
            span.end();
        }
    }
}
</code></pre>
<h4 data-id="heading-17">5.3 结构化日志（JSON + MDC）</h4>
<p><code>logback-spring.xml</code> 简化示例：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"org/springframework/boot/logging/logback/defaults.xml"</span>/&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"JSON"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"net.logstash.logback.encoder.LogstashEncoder"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">includeMdcKeyName</span>&gt;</span>traceId<span class="hljs-tag">&lt;/<span class="hljs-name">includeMdcKeyName</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">root</span> <span class="hljs-attr">level</span>=<span class="hljs-string">"INFO"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">appender-ref</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"JSON"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">root</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<p>在拦截器中写入 traceId：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.slf4j.MDC;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;

<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> java.util.UUID;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MdcInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TRACE_ID</span> <span class="hljs-operator">=</span> <span class="hljs-string">"traceId"</span>;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">traceId</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">"X-Trace-Id"</span>);
        <span class="hljs-keyword">if</span> (traceId == <span class="hljs-literal">null</span> || traceId.isEmpty()) {
            traceId = UUID.randomUUID().toString();
        }
        MDC.put(TRACE_ID, traceId);
        response.setHeader(<span class="hljs-string">"X-Trace-Id"</span>, traceId);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,
                                Object handler, Exception ex)</span> {
        MDC.remove(TRACE_ID);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-18">六、综合实战：MVC + WebFlux + 虚拟线程混合</h3>
<h4 data-id="heading-19">6.1 在传统 MVC 项目中引入 WebClient</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> reactor.core.publisher.Mono;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderFacadeService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderService orderService;           <span class="hljs-comment">// 传统阻塞 service</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReactiveOrderClient reactiveClient;  <span class="hljs-comment">// 响应式 HTTP 客户端</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderFacadeService</span><span class="hljs-params">(OrderService orderService,
                              ReactiveOrderClient reactiveClient)</span> {
        <span class="hljs-built_in">this</span>.orderService = orderService;
        <span class="hljs-built_in">this</span>.reactiveClient = reactiveClient;
    }

    <span class="hljs-comment">// 阻塞式接口内部使用 WebClient（建议放在虚拟线程中）</span>
    <span class="hljs-keyword">public</span> OrderAggregateDTO <span class="hljs-title function_">getOrderWithDetails</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.getById(orderId);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> order.getUserId();
        <span class="hljs-type">Long</span> <span class="hljs-variable">productId</span> <span class="hljs-operator">=</span> order.getProductId();

        Mono&lt;UserDTO&gt; userMono = reactiveClient.getUserById(userId);
        Mono&lt;ProductDTO&gt; productMono = reactiveClient.getProductById(productId);

        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMono.block();       <span class="hljs-comment">// 在虚拟线程中阻塞开销更小</span>
        <span class="hljs-type">ProductDTO</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> productMono.block();

        <span class="hljs-type">OrderAggregateDTO</span> <span class="hljs-variable">agg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderAggregateDTO</span>();
        agg.setOrder(order);
        agg.setUser(user);
        agg.setProduct(product);
        <span class="hljs-keyword">return</span> agg;
    }
}
</code></pre>
<h4 data-id="heading-20">6.2 健康检查与就绪探针</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.boot.actuate.health.Health;
<span class="hljs-keyword">import</span> org.springframework.boot.actuate.health.HealthIndicator;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> javax.sql.DataSource;
<span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomHealthIndicator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HealthIndicator</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataSource dataSource;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedisConnectionFactory redisConnectionFactory;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CustomHealthIndicator</span><span class="hljs-params">(DataSource dataSource,
                                 RedisConnectionFactory redisConnectionFactory)</span> {
        <span class="hljs-built_in">this</span>.dataSource = dataSource;
        <span class="hljs-built_in">this</span>.redisConnectionFactory = redisConnectionFactory;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Health <span class="hljs-title function_">health</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            dataSource.getConnection().close();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> Health.down().withException(e).build();
        }
        <span class="hljs-keyword">try</span> {
            redisConnectionFactory.getConnection().ping();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> Health.down().withException(e).build();
        }
        <span class="hljs-keyword">return</span> Health.up().build();
    }
}
</code></pre>
<p><code>application.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoint:</span>
    <span class="hljs-attr">health:</span>
      <span class="hljs-attr">probes:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">health:</span>
    <span class="hljs-attr">livenessState:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">readinessState:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[射线法判断一个坐标点（经纬度）是否在一个多边形区域内部]]></title>    <link>https://juejin.cn/post/7605173538417917962</link>    <guid>https://juejin.cn/post/7605173538417917962</guid>    <pubDate>2026-02-11T09:06:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605173538417917962" data-draft-id="7605173538417885194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="射线法判断一个坐标点（经纬度）是否在一个多边形区域内部"/> <meta itemprop="keywords" content="后端,算法"/> <meta itemprop="datePublished" content="2026-02-11T09:06:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深紫色的三北六号"/> <meta itemprop="url" content="https://juejin.cn/user/4101625032221256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            射线法判断一个坐标点（经纬度）是否在一个多边形区域内部
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4101625032221256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深紫色的三北六号
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:06:10.000Z" title="Wed Feb 11 2026 09:06:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、问题</h2>
<p>在 GIS、无人机巡检、电子围栏、地图系统等场景中，经常需要判断：</p>
<p><code>一个点是否位于某个多边形区域内？</code></p>
<p>关于这一问题，可以使用射线法判断。</p>
<h2 data-id="heading-1">二、射线法核心思想</h2>
<ol>
<li>从待判断的点出发，向右画一条水平射线；</li>
<li>统计这条射线与多边形边的交点个数；</li>
<li>如果交点数为奇数 → 点在多边形内部；</li>
<li>如果交点数为偶数 → 点在多边形外部。</li>
</ol>
<h2 data-id="heading-2">三、代码实现</h2>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">/**
     * 判断一个点是否在一个区域中
     * <span class="hljs-doctag">@param</span> point
     * <span class="hljs-doctag">@param</span> polygon
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isPointInPolygon</span><span class="hljs-params">(Point point, List&lt;Point&gt; polygon)</span> {
        <span class="hljs-type">boolean</span> <span class="hljs-variable">inside</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> polygon.size();

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, j = n - <span class="hljs-number">1</span>; i &lt; n; j = i++) {
            <span class="hljs-type">double</span> <span class="hljs-variable">xi</span> <span class="hljs-operator">=</span> polygon.get(i).getLongitude();
            <span class="hljs-type">double</span> <span class="hljs-variable">yi</span> <span class="hljs-operator">=</span> polygon.get(i).getLatitude();
            <span class="hljs-type">double</span> <span class="hljs-variable">xj</span> <span class="hljs-operator">=</span> polygon.get(j).getLongitude();
            <span class="hljs-type">double</span> <span class="hljs-variable">yj</span> <span class="hljs-operator">=</span> polygon.get(j).getLatitude();

            <span class="hljs-type">boolean</span> <span class="hljs-variable">intersect</span> <span class="hljs-operator">=</span>
                    ((yi &gt; point.getLatitude()) != (yj &gt; point.getLatitude())) &amp;&amp;
                            (point.getLongitude() &lt;
                                    (xj - xi) * (point.getLatitude() - yi) / (yj - yi) + xi);

            <span class="hljs-keyword">if</span> (intersect) {
                inside = !inside;
            }
        }
        <span class="hljs-keyword">return</span> inside;
    }
</code></pre>
<h2 data-id="heading-3">四、代码说明</h2>
<p>这段代码的核心在于判断：
<code>射线是否与当前边产生一次有效交点。</code>
关键逻辑如下：</p>
<pre><code class="hljs language-java" lang="java">((yi &gt; point.getLatitude()) != (yj &gt; point.getLatitude()))
</code></pre>
<p>这一步用于判断：</p>
<ul>
<li>边的两个端点是否一个在点的上方，一个在点的下方。</li>
<li>如果两个端点都在射线同一侧，则一定不会相交。</li>
</ul>
<hr/>
<pre><code class="hljs language-java" lang="java">(xj - xi) * (point.getLatitude() - yi) / (yj - yi) + xi
</code></pre>
<p>这一公式用于计算：
<code>射线与当前边的交点的 x 坐标。</code>
其推导来自线性插值公式：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">x</span> = xi + (xj - xi) * (y - yi) / (yj - yi)
</code></pre>
<p>最后比较：</p>
<pre><code class="hljs language-java" lang="java">point.getLongitude() &lt; 交点x坐标
</code></pre>
<p>表示：
<code>交点是否在点的右侧。</code>
如果满足条件，则说明发生了一次有效相交。</p>
<hr/>
<p>每遇到一次相交：</p>
<pre><code class="hljs language-java" lang="java">inside = !inside;
</code></pre>
<p>进行一次布尔翻转。</p>
<ul>
<li>第 1 次相交 → true</li>
<li>第 2 次相交 → false</li>
<li>第 3 次相交 → true
最终得到奇偶结果。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebGL 初探：让你的网页拥有3D魔法]]></title>    <link>https://juejin.cn/post/7605136148593131547</link>    <guid>https://juejin.cn/post/7605136148593131547</guid>    <pubDate>2026-02-11T09:10:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605136148593131547" data-draft-id="7605157203591544859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebGL 初探：让你的网页拥有3D魔法"/> <meta itemprop="keywords" content="WebGL,前端"/> <meta itemprop="datePublished" content="2026-02-11T09:10:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王校长"/> <meta itemprop="url" content="https://juejin.cn/user/2295436010076631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebGL 初探：让你的网页拥有3D魔法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436010076631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王校长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:10:55.000Z" title="Wed Feb 11 2026 09:10:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">WebGL的前世今生：从插件时代到开放标准</h2>
<p>还记得那些年我们用过的Flash吗？在WebGL出现之前，如果想在网页上展示3D效果，我们不得不依赖Adobe Flash、微软SilverLight这些浏览器插件。就像过去我们想要听音乐必须安装专门的播放器一样，这些插件就像一道门槛，限制了3D网页的发展。</p>
<p>但是，聪明的程序员们不甘于此！他们联手打造了一个开放标准——WebGL，让我们的浏览器原生支持3D图形渲染，再也不需要额外安装任何插件了。</p>
<h2 data-id="heading-1">WebGL到底是什么？用最简单的话说清楚</h2>
<p>想象一下，你正在玩一个3D游戏，那些栩栩如生的场景、流畅的角色动作，背后都是GPU（显卡）在默默工作。WebGL就是一座桥梁，让你可以用JavaScript直接和GPU对话，告诉它"嘿，帮我渲染一个红色的三角形"或者"给我一个旋转的立方体"。</p>
<p><strong>简单来说：</strong></p>
<ul>
<li>WebGL是一套3D图形API（应用程序接口）</li>
<li>它让你的JavaScript代码可以直接控制GPU</li>
<li>你可以用它创建3D图表、网页游戏、3D地图、虚拟现实等精彩应用</li>
</ul>
<h2 data-id="heading-2">WebGL的工作原理：就像工厂的流水线</h2>
<p>想象一下汽车制造厂的流水线：</p>
<ol>
<li>工人准备好零件（顶点数据）</li>
<li>每个工位对零件进行加工（顶点着色器）</li>
<li>零件被组装成车门（图元装配）</li>
<li>车门表面涂漆（光栅化）</li>
<li>最后贴上标志（片元着色器）</li>
</ol>
<p>WebGL的渲染过程也是这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这是JavaScript部分，准备数据</span>
<span class="hljs-keyword">const</span> vertices = [
  -<span class="hljs-number">0.5</span>, -<span class="hljs-number">0.5</span>,  <span class="hljs-comment">// 三角形左下角</span>
   <span class="hljs-number">0.5</span>, -<span class="hljs-number">0.5</span>,  <span class="hljs-comment">// 三角形右下角</span>
   <span class="hljs-number">0.0</span>,  <span class="hljs-number">0.5</span>   <span class="hljs-comment">// 三角形顶部</span>
];

<span class="hljs-comment">// 这是顶点着色器，告诉GPU如何放置顶点</span>
<span class="hljs-keyword">const</span> vertexShaderSource = <span class="hljs-string">`
attribute vec2 a_position;  // 接收顶点位置
void main() {
  gl_Position = vec4(a_position, 0.0, 1.0);  // 设置顶点位置
}
`</span>;

<span class="hljs-comment">// 这是片元着色器，告诉GPU如何上色</span>
<span class="hljs-keyword">const</span> fragmentShaderSource = <span class="hljs-string">`
void main() {
  gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);  // 设置为红色
}
`</span>;
</code></pre>
<p><strong>渲染管线的四个关键步骤：</strong></p>
<ol>
<li><strong>顶点着色器</strong>：处理每个顶点的位置</li>
<li><strong>图元装配</strong>：把顶点连成三角形</li>
<li><strong>光栅化</strong>：把三角形变成像素</li>
<li><strong>片元着色器</strong>：给每个像素上色</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d45948e6597f453199b6abf610c9cac5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5qCh6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771406047&amp;x-signature=jaiTqW6mCb%2FSWOdo907NxKhuA5g%3D" alt="wechat_2026-02-11_164451_306.png" loading="lazy"/></p>
<h2 data-id="heading-3">WebGL开发需要掌握的技能</h2>
<p>如果你已经会HTML、CSS、JavaScript，那么恭喜你，你已经完成了80%的准备工作！WebGL开发还需要：</p>
<h3 data-id="heading-4">1. HTML基础（你已经有了）</h3>
<p>只需要知道怎么使用<code>&lt;canvas&gt;</code>标签就够了：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"webgl-canvas"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"800"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"600"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">2. JavaScript（你已经精通了）</h3>
<p>负责：</p>
<ul>
<li>获取WebGL上下文</li>
<li>处理顶点数据（坐标、颜色、法向量等）</li>
<li>将数据传递给GPU</li>
<li>加载和解析模型文件</li>
</ul>
<h3 data-id="heading-6">3. GLSL着色器语言（新的挑战）</h3>
<p>这是运行在GPU上的小程序，语法类似C语言，但专门为图形处理设计：</p>
<pre><code class="hljs language-glsl" lang="glsl">// 顶点着色器示例
attribute vec4 position;
uniform mat4 u_matrix;
void main() {
  gl_Position = u_matrix * position;  // 矩阵变换
}
</code></pre>
<h3 data-id="heading-7">4. 3D数学知识（最重要的基础）</h3>
<ul>
<li>向量：表示方向和距离</li>
<li>矩阵：进行坐标变换（平移、旋转、缩放）</li>
<li>这是WebGL的核心，理解了数学原理，你就掌握了3D世界的钥匙</li>
</ul>
<h2 data-id="heading-8">着色器程序：让GPU听懂你的话</h2>
<p>WebGL中有两种着色器：</p>
<h3 data-id="heading-9">顶点着色器（Vertex Shader）</h3>
<ul>
<li>处理每个顶点的位置信息</li>
<li>执行坐标变换（移动、旋转、缩放等）</li>
</ul>
<h3 data-id="heading-10">片元着色器（Fragment Shader）</h3>
<ul>
<li>决定每个像素的颜色</li>
<li>处理光照、纹理等效果</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 完整的简单示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initWebGL</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'webgl-canvas'</span>);
  <span class="hljs-keyword">const</span> gl = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'webgl'</span>);
  
  <span class="hljs-keyword">if</span> (!gl) {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'你的浏览器不支持WebGL'</span>);
    <span class="hljs-keyword">return</span>;
  }
  
  <span class="hljs-comment">// 创建着色器程序...</span>
  <span class="hljs-comment">// 绘制图形...</span>
}
</code></pre>
<h2 data-id="heading-11">WebGL的魅力在哪里？</h2>
<p><strong>想象一下你能做到的事情：</strong></p>
<ul>
<li>创建震撼的3D数据可视化</li>
<li>开发浏览器内的3D游戏</li>
<li>构建虚拟现实体验</li>
<li>实现复杂的图像处理效果</li>
<li>优化传统2D应用性能</li>
</ul>
<h2 data-id="heading-12">总结：开启3D世界的大门</h2>
<p>WebGL不仅仅是技术，更是创造力的延伸。它让你有能力：</p>
<ul>
<li>用JavaScript控制GPU的强大计算能力</li>
<li>将数学知识转化为视觉艺术</li>
<li>为用户提供沉浸式的3D体验</li>
<li>在浏览器中实现以前不可能的效果</li>
</ul>
<p>记住，WebGL的学习曲线虽然陡峭，但一旦掌握，你就能创造出令人惊叹的视觉效果。让我们一起踏上这段精彩的3D之旅吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用搜搜果GEO工具批量监测品牌AI表现：国产ProFound实战Python教程]]></title>    <link>https://juejin.cn/post/7605174711181967423</link>    <guid>https://juejin.cn/post/7605174711181967423</guid>    <pubDate>2026-02-11T09:05:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605174711181967423" data-draft-id="7605214360084381732" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用搜搜果GEO工具批量监测品牌AI表现：国产ProFound实战Python教程"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-02-11T09:05:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户81329210265"/> <meta itemprop="url" content="https://juejin.cn/user/555681661333802"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用搜搜果GEO工具批量监测品牌AI表现：国产ProFound实战Python教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/555681661333802/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户81329210265
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:05:06.000Z" title="Wed Feb 11 2026 09:05:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着AI搜索逐渐成为信息入口，品牌在AI回答中的呈现直接影响用户认知和决策。如何量化品牌在AI搜索平台的表现，成为企业品牌管理的新需求。</p>
<p>**搜搜果GEO工具（<a href="https://link.juejin.cn?target=https%3A%2F%2Fsousougeo.com" target="_blank" title="https://sousougeo.com" ref="nofollow noopener noreferrer">sousougeo.com</a>）**是国产版ProFound逻辑的数据工具代表，可以帮助企业：</p>
<ul>
<li>监测品牌在AI平台的引用次数</li>
<li>批量分析竞品表现</li>
<li>检测关键词调用和正面比例</li>
<li>构建品牌认知画像和口碑风险</li>
<li>生成可视化分析报告</li>
</ul>
<p>本文演示如何用Python调用搜搜果GEO工具API进行批量品牌监测，并生成可视化数据。</p>
<hr/>
<h2 data-id="heading-0">1. 安装依赖</h2>
<pre><code class="hljs">pip install requests pandas matplotlib
</code></pre>
<ul>
<li><code>requests</code>：API请求</li>
<li><code>pandas</code>：数据处理</li>
<li><code>matplotlib</code>：可视化</li>
</ul>
<hr/>
<h2 data-id="heading-1">2. 获取单个品牌数据</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd

api_url = <span class="hljs-string">"https://api.sousougeo.com/v1/brand_monitor"</span>
params = {
    <span class="hljs-string">"brand"</span>: <span class="hljs-string">"示例品牌"</span>,
    <span class="hljs-string">"platforms"</span>: [<span class="hljs-string">"deepseek"</span>, <span class="hljs-string">"豆包"</span>, <span class="hljs-string">"千问"</span>, <span class="hljs-string">"元宝"</span>, <span class="hljs-string">"文心"</span>]
}

response = requests.<span class="hljs-keyword">get</span>(api_url, params=params)
<span class="hljs-keyword">data</span> = response.json()
print(<span class="hljs-keyword">data</span>)
</code></pre>
<p>返回示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"brand"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"示例品牌"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"platforms"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"deepseek"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"引用次数"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">120</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"正面比例"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.82</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"豆包"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"引用次数"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">95</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"正面比例"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.78</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"千问"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"引用次数"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">110</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"正面比例"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"元宝"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"引用次数"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">85</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"正面比例"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.72</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"文心"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"引用次数"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">105</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"正面比例"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.79</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-2">3. 数据处理与可视化</h2>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">platforms</span> = data[<span class="hljs-string">'platforms'</span>]
<span class="hljs-attr">df</span> = pd.DataFrame(platforms).T
df<span class="hljs-section">['品牌']</span> = data<span class="hljs-section">['brand']</span>
print(df)

import matplotlib.pyplot as plt

<span class="hljs-comment"># 引用次数柱状图</span>
plt.figure(<span class="hljs-attr">figsize</span>=(<span class="hljs-number">8</span>,<span class="hljs-number">4</span>))
plt.bar(df.index, df<span class="hljs-section">['引用次数']</span>, <span class="hljs-attr">color</span>=<span class="hljs-string">'skyblue'</span>)
plt.title(f"{data<span class="hljs-section">['brand']</span>} 在AI平台的引用次数")
plt.ylabel("引用次数")
plt.show()

<span class="hljs-comment"># 正面比例柱状图</span>
plt.figure(<span class="hljs-attr">figsize</span>=(<span class="hljs-number">8</span>,<span class="hljs-number">4</span>))
plt.bar(df.index, df<span class="hljs-section">['正面比例']</span>, <span class="hljs-attr">color</span>=<span class="hljs-string">'lightgreen'</span>)
plt.title(f"{data<span class="hljs-section">['brand']</span>} 在AI平台的正面比例")
plt.ylabel("正面比例")
plt.ylim(0,1)
plt.show()
</code></pre>
<hr/>
<h2 data-id="heading-3">4. 批量监测多个品牌</h2>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">brands</span> = [<span class="hljs-string">"品牌A"</span>, <span class="hljs-string">"品牌B"</span>, <span class="hljs-string">"品牌C"</span>]
<span class="hljs-attr">all_results</span> = []

for brand in brands:
    params<span class="hljs-section">['brand']</span> = brand
    <span class="hljs-attr">resp</span> = requests.get(api_url, params=params).json()
    <span class="hljs-attr">df_temp</span> = pd.DataFrame(resp[<span class="hljs-string">'platforms'</span>]).T
    df_temp<span class="hljs-section">['品牌']</span> = brand
    all_results.append(df_temp)

<span class="hljs-attr">df_all</span> = pd.concat(all_results)
print(df_all)
</code></pre>
<p>通过批量监测，可以快速分析多个品牌在AI平台的表现，便于竞品对比和策略优化。</p>
<hr/>
<p>使用国产ProFound逻辑的数据工具——<strong>搜搜果GEO工具（<a href="https://link.juejin.cn?target=https%3A%2F%2Fsousougeo.com" target="_blank" title="https://sousougeo.com" ref="nofollow noopener noreferrer">sousougeo.com</a>）</strong> ，企业可以实现：</p>
<ul>
<li>品牌在AI搜索平台表现量化</li>
<li>竞品横向对比</li>
<li>关键词调用与口碑风险分析</li>
<li>可视化报告生成</li>
</ul>
<p>在AI搜索时代，品牌竞争不仅是流量，更是<strong>在AI回答中被正确理解和呈现</strong>。<br/>
使用搜搜果GEO工具，企业可以让品牌管理更数据化、更智能。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenCode + oh-my-opencode 体验（使用自搭建模型）]]></title>    <link>https://juejin.cn/post/7605187300134027299</link>    <guid>https://juejin.cn/post/7605187300134027299</guid>    <pubDate>2026-02-11T09:04:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605187300134027299" data-draft-id="7604881286037766196" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenCode + oh-my-opencode 体验（使用自搭建模型）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-11T09:04:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="juejin_cn"/> <meta itemprop="url" content="https://juejin.cn/user/3016715636324125"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenCode + oh-my-opencode 体验（使用自搭建模型）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3016715636324125/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    juejin_cn
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:04:18.000Z" title="Wed Feb 11 2026 09:04:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">安装oh-my-opencode</h2>
<pre><code class="hljs language-perl" lang="perl">npm install oh-<span class="hljs-keyword">my</span>-opencode-windows-x64 -g
bunx oh-<span class="hljs-keyword">my</span>-opencode install
</code></pre>
<h2 data-id="heading-1">配置自搭建模型</h2>
<p><code>.config\opencode\opencode.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"$schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://opencode.ai/config.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"plugin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"oh-my-opencode@3.5.1"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"AIX-code"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"npm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"@ai-sdk/openai-compatible"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX Code"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"baseURL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:8000"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"apiKey"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"xxx"</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"AIX_CODER"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-Coder-Self"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX_CODER"</span> <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<h2 data-id="heading-2">设置模型</h2>
<p><code>AIX-code/AIX-Coder-Self</code></p>
<p><code>AIX-code</code> 是 provider key，<code>AIX-Coder-Self</code> 是模型 id</p>
<p><code>.config\opencode\oh-my-opencode.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"$schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://raw.githubusercontent.com/code-yeongyu/oh-my-opencode/master/assets/oh-my-opencode.schema.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"agents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"sisyphus"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"hephaestus"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"oracle"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"librarian"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"explore"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"multimodal-looker"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prometheus"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"metis"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"momus"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"atlas"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"categories"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"visual-engineering"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ultrabrain"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"deep"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"artistry"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"quick"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"unspecified-low"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"unspecified-high"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"writing"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"AIX-code/AIX-Coder-Self"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-3">运行</h2>
<p><code>opencode web</code> 打开 Web 网页，选择 <code>Sisyphus</code> 智能体和自搭建模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7fda99615114cf3affea39c17894418~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVlamluX2Nu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771405458&amp;x-signature=HRJTnPzRaJGuwKHEv8JxYv%2Bp75Y%3D" alt="image.png" loading="lazy"/></p>
<p><code>oh-my-opencode</code> 是什么，直接问下它</p>
<ul>
<li><code>你调用的是哪个大模型</code></li>
</ul>
<blockquote>
<p>用户问我调用的是哪个大模型。根据系统提示中的信息，我使用的是 "AIX-Coder-Self" 模型，具体的模型 ID 是 "AIX-code/AIX-Coder-Self"。</p>
<p>我应该直接回答这个问题。 </p>
<p>AIX-code/AIX-Coder-Self</p>
</blockquote>
<ul>
<li><code>你有哪些能力</code></li>
</ul>
<blockquote>
<p>用户问我有哪些能力。这是一个关于我的能力的问题，我应该简洁地回答。</p>
<p>根据系统提示，我是"Sisyphus" - 一个具有编排能力的AI代理。我应该列出我的主要能力，但不要过于详细或夸大。</p>
<p>让我简洁地总结我的核心能力：</p>
<ol>
<li>代码编写和编辑</li>
<li>文件操作（读取、写入、搜索）</li>
<li>Git操作</li>
<li>执行bash命令</li>
<li>任务委托给子代理</li>
<li>Web搜索和信息获取</li>
<li>代码分析和重构</li>
<li>测试和验证</li>
</ol>
<p>我应该用简洁的方式回答这个问题。 </p>
<p>我是 Sisyphus，一个具有编排能力的 AI 编程助手。以下是我的核心能力：</p>
<p><strong>代码操作</strong></p>
<ul>
<li>读取、编写、编辑文件</li>
<li>代码搜索（grep、AST 搜索、LSP）</li>
<li>代码重构和修复</li>
<li>类型检查和 linting</li>
</ul>
<p><strong>执行能力</strong></p>
<ul>
<li>执行 bash 命令（安装、测试、构建）</li>
<li>Git 操作（提交、分支、PR）</li>
<li>运行测试套件</li>
</ul>
<p><strong>分析能力</strong></p>
<ul>
<li>理解项目结构和代码库</li>
<li>查找符号定义和引用</li>
<li>诊断代码问题</li>
</ul>
<p><strong>任务委托</strong></p>
<ul>
<li>调用专门的子代理（explore、librarian、oracle 等）</li>
<li>并行执行多个任务</li>
<li>使用用户安装的技能</li>
</ul>
<p><strong>信息获取</strong></p>
<ul>
<li>Web 搜索</li>
<li>获取文档（Context7）</li>
<li>GitHub 代码搜索</li>
</ul>
<p><strong>会话管理</strong></p>
<ul>
<li>跨会话保持上下文</li>
<li>跟踪待办事项</li>
<li>管理后台任务</li>
</ul>
<p>需要我帮你做什么？</p>
</blockquote>
<ul>
<li><code>你有哪些子代理，用处是什么</code></li>
</ul>
<blockquote>
<p>用户问我有哪些子代理以及它们的用途。根据系统提示中的信息，我应该详细介绍可用的子代理（agents）。</p>
<p>让我整理一下系统提示中提到的子代理：</p>
<ol>
<li><strong>explore</strong> - 上下文grep，用于搜索代码库</li>
<li><strong>librarian</strong> - 外部参考grep，搜索文档、OSS等</li>
<li><strong>oracle</strong> - 只读高智商顾问，用于调试和架构</li>
<li><strong>metis</strong> - 预规划顾问，分析请求识别隐藏意图</li>
<li><strong>momus</strong> - 专家评审员，评估工作计划</li>
</ol>
<p>还有通过 task() 函数可用的预定义类别：</p>
<ul>
<li>visual-engineering - 前端、UI/UX</li>
<li>ultrabrain - 困难逻辑任务</li>
<li>deep - 目标导向自主问题解决</li>
<li>artistry - 复杂创意问题解决</li>
<li>quick - 简单任务</li>
<li>unspecified-low/unspecified-high - 不适合其他类别</li>
<li>writing - 文档、技术写作</li>
</ul>
<p>以及技能：</p>
<ul>
<li>playwright - 浏览器自动化</li>
<li>frontend-ui-ux - UI/UX设计开发</li>
<li>git-master - Git操作</li>
<li>dev-browser - 浏览器自动化</li>
</ul>
<p>我应该清晰地列出这些子代理及其用途。 </p>
<p>我目前可用的子代理（Agents）如下：</p>
<h2 data-id="heading-4">核心子代理</h2>



































<table><thead><tr><th>子代理</th><th>用途</th><th>触发场景</th></tr></thead><tbody><tr><td><strong>explore</strong></td><td>上下文grep，搜索内部代码库</td><td>查找现有代码模式、结构、风格</td></tr><tr><td><strong>librarian</strong></td><td>外部参考grep，搜索文档/OSS/开源实现</td><td>不熟悉的库、最佳实践、官方文档</td></tr><tr><td><strong>oracle</strong></td><td>只读高智商顾问，用于调试和架构决策</td><td>复杂架构、2+次修复失败后、不熟悉的模式</td></tr><tr><td><strong>metis</strong></td><td>预规划顾问，分析请求识别隐藏意图</td><td>复杂任务、需要澄清范围、模糊需求</td></tr><tr><td><strong>momus</strong></td><td>专家评审员，评估工作计划</td><td>工作计划评审、质量保证、catch漏洞</td></tr></tbody></table>
<h2 data-id="heading-5">任务类别（Category）</h2>





































<table><thead><tr><th>类别</th><th>最佳用于</th></tr></thead><tbody><tr><td><strong>visual-engineering</strong></td><td>前端、UI/UX、设计、样式、动画</td></tr><tr><td><strong>ultrabrain</strong></td><td>真正困难的逻辑任务（仅此用途）</td></tr><tr><td><strong>deep</strong></td><td>目标导向的问题解决，需要深入研究</td></tr><tr><td><strong>artistry</strong></td><td>复杂创意问题解决，超出标准模式</td></tr><tr><td><strong>quick</strong></td><td>简单任务 - 单文件修改、拼写错误、简单修改</td></tr><tr><td><strong>unspecified-low/high</strong></td><td>不适合其他类别</td></tr><tr><td><strong>writing</strong></td><td>文档、散文、技术写作</td></tr></tbody></table>
<h2 data-id="heading-6">技能（Skills）</h2>

























<table><thead><tr><th>技能</th><th>用途</th></tr></thead><tbody><tr><td><strong>playwright</strong></td><td>浏览器自动化 - 验证、浏览、信息抓取、测试、截图</td></tr><tr><td><strong>frontend-ui-ux</strong></td><td>设计驱动的UI/UX开发</td></tr><tr><td><strong>git-master</strong></td><td>Git操作 - 原子提交、rebase/squash、历史搜索</td></tr><tr><td><strong>dev-browser</strong></td><td>浏览器自动化 - 持续页面状态、导航、表单、截图</td></tr></tbody></table>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[synchronized]]></title>    <link>https://juejin.cn/post/7605213691910733850</link>    <guid>https://juejin.cn/post/7605213691910733850</guid>    <pubDate>2026-02-11T09:17:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605213691910733850" data-draft-id="7605135197167239218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" synchronized"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T09:17:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="砍材农夫"/> <meta itemprop="url" content="https://juejin.cn/user/4126885865862187"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             synchronized
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4126885865862187/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    砍材农夫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:17:53.000Z" title="Wed Feb 11 2026 09:17:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jysemel.top%2Finterview%2Fjava%2Flock%2Fsynchronized.html%23%25E5%2587%25A0%25E7%25A7%258D%25E6%2596%25B9%25E5%25BC%258F" target="_blank" title="https://www.jysemel.top/interview/java/lock/synchronized.html#%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F" ref="nofollow noopener noreferrer">几种方式</a>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jysemel.top%2Finterview%2Fjava%2Flock%2Fsynchronized.html%23%25E4%25BF%25AE%25E9%25A5%25B0%25E6%2596%25B9%25E6%25B3%2595" target="_blank" title="https://www.jysemel.top/interview/java/lock/synchronized.html#%E4%BF%AE%E9%A5%B0%E6%96%B9%E6%B3%95" ref="nofollow noopener noreferrer">修饰方法</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jysemel.top%2Finterview%2Fjava%2Flock%2Fsynchronized.html%23%25E4%25BF%25AE%25E9%25A5%25B0%25E9%259D%2599%25E6%2580%2581%25E6%2596%25B9%25E6%25B3%2595" target="_blank" title="https://www.jysemel.top/interview/java/lock/synchronized.html#%E4%BF%AE%E9%A5%B0%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95" ref="nofollow noopener noreferrer">修饰静态方法</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jysemel.top%2Finterview%2Fjava%2Flock%2Fsynchronized.html%23%25E4%25BF%25AE%25E9%25A5%25B0%25E4%25BB%25A3%25E7%25A0%2581%25E5%259D%2597-%25E5%2590%258C%25E6%25AD%25A5%25E4%25BB%25A3%25E7%25A0%2581%25E5%259D%2597" target="_blank" title="https://www.jysemel.top/interview/java/lock/synchronized.html#%E4%BF%AE%E9%A5%B0%E4%BB%A3%E7%A0%81%E5%9D%97-%E5%90%8C%E6%AD%A5%E4%BB%A3%E7%A0%81%E5%9D%97" ref="nofollow noopener noreferrer">修饰代码块(同步代码块)</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jysemel.top%2Finterview%2Fjava%2Flock%2Fsynchronized.html%23%25E4%25BF%25AE%25E9%25A5%25B0%25E4%25BB%25A3%25E7%25A0%2581%25E5%259D%2597-this%25E5%2592%258C%25E7%25B1%25BB" target="_blank" title="https://www.jysemel.top/interview/java/lock/synchronized.html#%E4%BF%AE%E9%A5%B0%E4%BB%A3%E7%A0%81%E5%9D%97-this%E5%92%8C%E7%B1%BB" ref="nofollow noopener noreferrer">修饰代码块(this和类)</a></li>
</ul>
</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jysemel.top%2Finterview%2Fjava%2Flock%2Fsynchronized.html%23%25E9%2594%2581%25E5%258D%2587%25E7%25BA%25A7" target="_blank" title="https://www.jysemel.top/interview/java/lock/synchronized.html#%E9%94%81%E5%8D%87%E7%BA%A7" ref="nofollow noopener noreferrer">锁升级</a>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jysemel.top%2Finterview%2Fjava%2Flock%2Fsynchronized.html%23synchronized-%25E7%259A%2584%25E9%2594%2581%25E5%258D%2587%25E7%25BA%25A7%25E8%25BF%2587%25E7%25A8%258B%25E6%2580%25BB%25E7%25BB%2593" target="_blank" title="https://www.jysemel.top/interview/java/lock/synchronized.html#synchronized-%E7%9A%84%E9%94%81%E5%8D%87%E7%BA%A7%E8%BF%87%E7%A8%8B%E6%80%BB%E7%BB%93" ref="nofollow noopener noreferrer">synchronized 的锁升级过程总结</a></li>
</ul>
</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jysemel.top%2Finterview%2Fjava%2Flock%2Fsynchronized.html%23%25E6%25BA%2590%25E7%25A0%2581" target="_blank" title="https://www.jysemel.top/interview/java/lock/synchronized.html#%E6%BA%90%E7%A0%81" ref="nofollow noopener noreferrer">源码</a></li>
</ul>
<h3 data-id="heading-0">几种方式</h3>
<h4 data-id="heading-1">修饰方法</h4>
<blockquote>
<p>同一个实例，同一时间只能有一个线程访问该方法 作用域是同一个实例</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.jysemel.java.basic.thread.lock;

<span class="hljs-keyword">import</span> lombok.SneakyThrows;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedDemo1</span> {

    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">say</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"static1 -------------"</span> + Thread.currentThread().getName());
        TimeUnit.SECONDS.sleep(<span class="hljs-number">10</span>);
        System.out.println(<span class="hljs-string">"static1-----------------end"</span> + Thread.currentThread().getName());
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 同一个实例</span>
        <span class="hljs-type">SynchronizedDemo1</span> <span class="hljs-variable">demo1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedDemo1</span>();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(demo1::say).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(demo1::say).start();

        <span class="hljs-comment">// 不同实例</span>
        <span class="hljs-type">SynchronizedDemo1</span> <span class="hljs-variable">demo2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedDemo1</span>();
        <span class="hljs-type">SynchronizedDemo1</span> <span class="hljs-variable">demo3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedDemo1</span>();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(demo2::say).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(demo3::say).start();

    }
}
</code></pre>
<h4 data-id="heading-2">修饰静态方法</h4>
<blockquote>
<p>作用域全局</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.jysemel.java.basic.thread.lock;

<span class="hljs-keyword">import</span> lombok.SneakyThrows;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedDemo2</span> {

    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">say</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"static1 -------------"</span> + Thread.currentThread().getName());
        TimeUnit.SECONDS.sleep(<span class="hljs-number">10</span>);
        System.out.println(<span class="hljs-string">"static1-----------------end"</span> + Thread.currentThread().getName());
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(SynchronizedDemo2::say).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(SynchronizedDemo2::say).start();
    }
}
</code></pre>
<h4 data-id="heading-3">修饰代码块(同步代码块)</h4>
<blockquote>
<p>同一个实例，同一时间只能有一个线程访问该方法 如果是静态对象，则作用域全局</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.jysemel.java.basic.thread.lock;

<span class="hljs-keyword">import</span> lombok.SneakyThrows;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedDemo3</span> {


    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Object</span> <span class="hljs-variable">staticObj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();

    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">say</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">synchronized</span> (obj) {
            System.out.println(name + <span class="hljs-string">"say -------------"</span> + Thread.currentThread().getName());
            TimeUnit.SECONDS.sleep(<span class="hljs-number">10</span>);
            System.out.println(name + <span class="hljs-string">"say-----------------end "</span> + Thread.currentThread().getName());
        }
    }

    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticSay</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">synchronized</span> (staticObj) {
            System.out.println(name + <span class="hljs-string">"staticSay -------------"</span> + Thread.currentThread().getName());
            TimeUnit.SECONDS.sleep(<span class="hljs-number">10</span>);
            System.out.println(name + <span class="hljs-string">"staticSay-----------------end "</span> + Thread.currentThread().getName());
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
<span class="hljs-comment">//        // 同一个实例</span>
<span class="hljs-comment">//        SynchronizedDemo3 demo1 = new SynchronizedDemo3();</span>
<span class="hljs-comment">//        new Thread( () -&gt; demo1.say("thread1 ")).start();</span>
<span class="hljs-comment">//        new Thread( () -&gt; demo1.say("thread2 ")).start();</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//        //不同实例</span>
<span class="hljs-comment">//        SynchronizedDemo3 demo2 = new SynchronizedDemo3();</span>
<span class="hljs-comment">//        SynchronizedDemo3 demo3 = new SynchronizedDemo3();</span>
<span class="hljs-comment">//        new Thread( () -&gt; demo2.say("thread3 ")).start();</span>
<span class="hljs-comment">//        new Thread( () -&gt; demo3.say("thread4 ")).start();</span>

        <span class="hljs-comment">//不同实例，静态对象</span>
        <span class="hljs-type">SynchronizedDemo3</span> <span class="hljs-variable">demo4</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedDemo3</span>();
        <span class="hljs-type">SynchronizedDemo3</span> <span class="hljs-variable">demo5</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedDemo3</span>();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>( () -&gt; demo4.staticSay(<span class="hljs-string">"thread4 "</span>)).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>( () -&gt; demo5.staticSay(<span class="hljs-string">"thread5 "</span>)).start();

        System.out.println(<span class="hljs-string">"finished"</span>);

    }

}
</code></pre>
<h4 data-id="heading-4">修饰代码块(this和类)</h4>
<blockquote>
<p>同一个实例，同一时间只能有一个线程访问该方法 类，则作用域全局</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.jysemel.java.basic.thread.lock;

<span class="hljs-keyword">import</span> lombok.SneakyThrows;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedDemo4</span> {

    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">say</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
            System.out.println(name + <span class="hljs-string">"say -------------"</span> + Thread.currentThread().getName());
            TimeUnit.SECONDS.sleep(<span class="hljs-number">10</span>);
            System.out.println(name + <span class="hljs-string">"say-----------------end "</span> + Thread.currentThread().getName());
        }
    }

    <span class="hljs-meta">@SneakyThrows</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticSay</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">synchronized</span> (SynchronizedDemo4.class) {
            System.out.println(name + <span class="hljs-string">"staticSay -------------"</span> + Thread.currentThread().getName());
            TimeUnit.SECONDS.sleep(<span class="hljs-number">10</span>);
            System.out.println(name + <span class="hljs-string">"staticSay-----------------end "</span> + Thread.currentThread().getName());
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 同一个实例</span>
        <span class="hljs-type">SynchronizedDemo3</span> <span class="hljs-variable">demo1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedDemo3</span>();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>( () -&gt; demo1.say(<span class="hljs-string">"thread1 "</span>)).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>( () -&gt; demo1.say(<span class="hljs-string">"thread2 "</span>)).start();

        <span class="hljs-comment">//不同实例</span>
        <span class="hljs-type">SynchronizedDemo3</span> <span class="hljs-variable">demo2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedDemo3</span>();
        <span class="hljs-type">SynchronizedDemo3</span> <span class="hljs-variable">demo3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronizedDemo3</span>();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>( () -&gt; demo2.say(<span class="hljs-string">"thread3 "</span>)).start();
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>( () -&gt; demo3.say(<span class="hljs-string">"thread4 "</span>)).start();

        <span class="hljs-comment">//不同实例，静态对象</span>
<span class="hljs-comment">//        SynchronizedDemo4 demo4 = new SynchronizedDemo4();</span>
<span class="hljs-comment">//        SynchronizedDemo4 demo5 = new SynchronizedDemo4();</span>
<span class="hljs-comment">//        new Thread( () -&gt; demo4.staticSay("thread4 ")).start();</span>
<span class="hljs-comment">//        new Thread( () -&gt; demo5.staticSay("thread5 ")).start();</span>

        System.out.println(<span class="hljs-string">"finished"</span>);

    }

}
</code></pre>
<h3 data-id="heading-5">锁升级</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09bd72aa4b7e4237b111f0b61c3a1570~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CN5p2Q5Yac5aSr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771406272&amp;x-signature=jG%2BCY9RQs0BE0iVh9eYr4afn0OU%3D" alt="Image text" loading="lazy"/></p>
<h4 data-id="heading-6">synchronized 的锁升级过程总结</h4>
<ul>
<li>偏向锁</li>
</ul>
<blockquote>
<p>记录线程 ID，无竞争快速获取 单线程访问</p>
</blockquote>
<ul>
<li>轻量级锁</li>
</ul>
<blockquote>
<p>CAS 自旋，避免阻塞 低并发，短时间竞争</p>
</blockquote>
<ul>
<li>重量级锁</li>
</ul>
<blockquote>
<p>阻塞线程，性能低 高并发激烈竞争</p>
</blockquote>
<h3 data-id="heading-7">源码</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fjysemel-java%2Fjdk-series" target="_blank" title="https://gitee.com/jysemel-java/jdk-series" ref="nofollow noopener noreferrer">源码</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 GPUI 实现 WebScoket 服务端之 UI 篇]]></title>    <link>https://juejin.cn/post/7605150769009164331</link>    <guid>https://juejin.cn/post/7605150769009164331</guid>    <pubDate>2026-02-11T09:19:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605150769009164331" data-draft-id="7605051886434598975" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 GPUI 实现 WebScoket 服务端之 UI 篇"/> <meta itemprop="keywords" content="Rust"/> <meta itemprop="datePublished" content="2026-02-11T09:19:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Payton"/> <meta itemprop="url" content="https://juejin.cn/user/3342151211040622"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 GPUI 实现 WebScoket 服务端之 UI 篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3342151211040622/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Payton
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:19:51.000Z" title="Wed Feb 11 2026 09:19:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、概述</h2>
<p>最近在学习 Rust 和 gpui，基于我学到的和遇到的问题，总结了一下，也顺便记录一下。</p>
<h3 data-id="heading-1">1、创建项目并用 Zed 打开</h3>
<pre><code class="hljs language-cmd" lang="cmd">cargo new ws-gpui
zed ws-gpui
</code></pre>
<h3 data-id="heading-2">2、安装依赖</h3>
<pre><code class="hljs language-cmd" lang="cmd">cargo add gpui
</code></pre>
<h3 data-id="heading-3">3、创建一个空窗口</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">use</span> gpui::{
    App, Application, Bounds, Empty, Entity, Window, WindowBounds, WindowOptions, prelude::*, px,
    size,
};

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">WebSocketUi</span> {}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">WebSocketUi</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> {}
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Render</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">WebSocketUi</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, _window: &amp;<span class="hljs-keyword">mut</span> Window, _cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoElement</span> {
        Empty {}
    }
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">build_root_view</span>(_window: &amp;<span class="hljs-keyword">mut</span> Window, cx: &amp;<span class="hljs-keyword">mut</span> App) <span class="hljs-punctuation">-&gt;</span> Entity&lt;WebSocketUi&gt; {
    cx.<span class="hljs-title function_ invoke__">new</span>(|_cx| WebSocketUi::<span class="hljs-title function_ invoke__">new</span>())
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_finish_launching</span>(cx: &amp;<span class="hljs-keyword">mut</span> App) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">bounds</span> = Bounds::<span class="hljs-title function_ invoke__">centered</span>(<span class="hljs-literal">None</span>, <span class="hljs-title function_ invoke__">size</span>(<span class="hljs-title function_ invoke__">px</span>(<span class="hljs-number">500</span>.), <span class="hljs-title function_ invoke__">px</span>(<span class="hljs-number">250.0</span>)), cx);
    cx.<span class="hljs-title function_ invoke__">open_window</span>(
        WindowOptions {
            window_bounds: <span class="hljs-title function_ invoke__">Some</span>(WindowBounds::<span class="hljs-title function_ invoke__">Windowed</span>(bounds)),
            ..<span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>()
        },
        build_root_view,
    )
    .<span class="hljs-title function_ invoke__">unwrap</span>();
}

<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">app</span> = Application::<span class="hljs-title function_ invoke__">new</span>();
    app.<span class="hljs-title function_ invoke__">run</span>(on_finish_launching);
}
</code></pre>
<h2 data-id="heading-4">二、拆开来看看</h2>
<h3 data-id="heading-5">1、创建 app 并运行</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">app</span> = Application::<span class="hljs-title function_ invoke__">new</span>();
    app.<span class="hljs-title function_ invoke__">run</span>(on_finish_launching);
}
</code></pre>
<h3 data-id="heading-6">2、app 运行后，创建一个窗口。</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_finish_launching</span>(cx: &amp;<span class="hljs-keyword">mut</span> App) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">bounds</span> = Bounds::<span class="hljs-title function_ invoke__">centered</span>(<span class="hljs-literal">None</span>, <span class="hljs-title function_ invoke__">size</span>(<span class="hljs-title function_ invoke__">px</span>(<span class="hljs-number">500</span>.), <span class="hljs-title function_ invoke__">px</span>(<span class="hljs-number">250.0</span>)), cx);
    cx.<span class="hljs-title function_ invoke__">open_window</span>(
        WindowOptions {
            window_bounds: <span class="hljs-title function_ invoke__">Some</span>(WindowBounds::<span class="hljs-title function_ invoke__">Windowed</span>(bounds)),
            ..<span class="hljs-built_in">Default</span>::<span class="hljs-title function_ invoke__">default</span>()
        },
        build_root_view,
    )
    .<span class="hljs-title function_ invoke__">unwrap</span>();
}
</code></pre>
<p>创建一个在主显示器居中的，500px * 250px 的窗口，窗口的其它选项用默认的。</p>
<h3 data-id="heading-7">3、窗口打开后，实例化一个实体（Entity）, T -&gt; WebSocketUi</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">build_root_view</span>(_window: &amp;<span class="hljs-keyword">mut</span> Window, cx: &amp;<span class="hljs-keyword">mut</span> App) <span class="hljs-punctuation">-&gt;</span> Entity&lt;WebSocketUi&gt; {
    cx.<span class="hljs-title function_ invoke__">new</span>(|_cx| WebSocketUi::<span class="hljs-title function_ invoke__">new</span>())
}
</code></pre>
<h3 data-id="heading-8">4、WebScoketUi 需要实现 Render</h3>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Render</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">WebSocketUi</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, _window: &amp;<span class="hljs-keyword">mut</span> Window, _cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoElement</span> {
        Empty {}
    }
}
</code></pre>
<p>render 方法现在是返回一个 <code>Empty</code> ，所以窗口里面什么内容都没有。</p>
<h3 data-id="heading-9">5、运行看看效果。</h3>
<pre><code class="hljs language-cmd" lang="cmd">cargo run
</code></pre>
<h3 data-id="heading-10">6、效果</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ea39ab2786f4d44a15512ceff452dfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF5dG9u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771406390&amp;x-signature=a88EJKc2isSJK7%2BjL94W%2F5ap3bg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">三、实现业务需要的 UI</h2>
<h3 data-id="heading-12">1、创建一个简单示例。</h3>
<h4 data-id="heading-13">1.1、创建背景和示例文字</h4>
<p>需要创建一个内容撑满窗口的白色背景的内边距是 16px 的 UI。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Render</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">WebSocketUi</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, _window: &amp;<span class="hljs-keyword">mut</span> Window, _cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoElement</span> {
        <span class="hljs-title function_ invoke__">div</span>()
            .<span class="hljs-title function_ invoke__">size_full</span>()
            .<span class="hljs-title function_ invoke__">p_4</span>()
            .<span class="hljs-title function_ invoke__">bg</span>(<span class="hljs-title function_ invoke__">rgb</span>(<span class="hljs-number">0xffffff</span>))
            .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-string">"Hello gpui"</span>)
    }
}
</code></pre>
<p>如果你熟悉 <code>Tailwind CSS</code>，你应该对这种语法很熟悉。请参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2Fdocs%2Fstyling-with-utility-classes" target="_blank" title="https://tailwindcss.com/docs/styling-with-utility-classes" ref="nofollow noopener noreferrer">Tailwind CSS</a></p>
<h4 data-id="heading-14">1.2、看看效果</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1adce3f77b54db3a8e740fe3b828bf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF5dG9u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771406390&amp;x-signature=KaDjKa%2Bi765ve3RuoGwUz1tVNfg%3D" alt="2.png" loading="lazy"/></p>
<h3 data-id="heading-15">2、创建整体结构</h3>
<h4 data-id="heading-16">2.1、代码实现</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">Render</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">WebSocketUi</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, _window: &amp;<span class="hljs-keyword">mut</span> Window, _cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoElement</span> {
        <span class="hljs-title function_ invoke__">div</span>().<span class="hljs-title function_ invoke__">size_full</span>().<span class="hljs-title function_ invoke__">p_4</span>().<span class="hljs-title function_ invoke__">bg</span>(<span class="hljs-title function_ invoke__">rgb</span>(<span class="hljs-number">0xffffff</span>)).<span class="hljs-title function_ invoke__">child</span>(
            <span class="hljs-title function_ invoke__">div</span>()
                .<span class="hljs-title function_ invoke__">flex</span>()
                .<span class="hljs-title function_ invoke__">flex_col</span>()
                .<span class="hljs-title function_ invoke__">gap_4</span>()
                .<span class="hljs-title function_ invoke__">size_full</span>()
                .<span class="hljs-title function_ invoke__">justify_center</span>()
                .<span class="hljs-title function_ invoke__">items_center</span>()
                .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-string">"服务运行状态栏在这里"</span>)
                .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-string">"状态信息栏在这里"</span>)
                .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-string">"操作栏在这里"</span>),
        )
    }
}
</code></pre>
<p>这种代码对前端开发来说特别<code>亲切</code>。</p>
<h4 data-id="heading-17">2.2、看看效果</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f791dafc8e44f3384e62383e2767f2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF5dG9u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771406390&amp;x-signature=U5vJu6FSUqkaR3SNBTNkAEX7wXE%3D" alt="3.png" loading="lazy"/></p>
<h3 data-id="heading-18">3、实现服务运行状态栏。</h3>
<h4 data-id="heading-19">3.1、代码实现</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">WebSocketUi</span> {
    is_running: <span class="hljs-type">bool</span>, <span class="hljs-comment">// 组件状态，和 React 的 const [isRunning, setIsRunning] = useState(false) 有点像</span>
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">WebSocketUi</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> { is_running: <span class="hljs-literal">false</span> }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">status_bar</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, _window: &amp;<span class="hljs-keyword">mut</span> Window, _cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoElement</span> {
        <span class="hljs-keyword">let</span> (connection_status, status_color) = <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.is_running {
            (<span class="hljs-string">"已开启"</span>, <span class="hljs-title function_ invoke__">rgb</span>(<span class="hljs-number">0x00ff00</span>))
        } <span class="hljs-keyword">else</span> {
            (<span class="hljs-string">"未开启"</span>, <span class="hljs-title function_ invoke__">rgb</span>(<span class="hljs-number">0xff0000</span>))
        };
        
        <span class="hljs-title function_ invoke__">div</span>()
            .<span class="hljs-title function_ invoke__">flex</span>()
            .<span class="hljs-title function_ invoke__">items_center</span>()
            .<span class="hljs-title function_ invoke__">gap_2</span>()
            .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-string">"服务状态:"</span>)
            .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-title function_ invoke__">div</span>().<span class="hljs-title function_ invoke__">w_4</span>().<span class="hljs-title function_ invoke__">h_4</span>().<span class="hljs-title function_ invoke__">rounded_full</span>().<span class="hljs-title function_ invoke__">bg</span>(status_color))
            .<span class="hljs-title function_ invoke__">child</span>(connection_status)
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Render</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">WebSocketUi</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, window: &amp;<span class="hljs-keyword">mut</span> Window, cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoElement</span> {
        <span class="hljs-title function_ invoke__">div</span>().<span class="hljs-title function_ invoke__">size_full</span>().<span class="hljs-title function_ invoke__">p_4</span>().<span class="hljs-title function_ invoke__">bg</span>(<span class="hljs-title function_ invoke__">rgb</span>(<span class="hljs-number">0xffffff</span>)).<span class="hljs-title function_ invoke__">child</span>(
            <span class="hljs-title function_ invoke__">div</span>()
                .<span class="hljs-title function_ invoke__">flex</span>()
                .<span class="hljs-title function_ invoke__">flex_col</span>()
                .<span class="hljs-title function_ invoke__">gap_4</span>()
                .<span class="hljs-title function_ invoke__">size_full</span>()
                .<span class="hljs-title function_ invoke__">justify_center</span>()
                .<span class="hljs-title function_ invoke__">items_center</span>()
                .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">status_bar</span>(window, cx))
                .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-string">"状态信息栏在这里"</span>)
                .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-string">"操作栏在这里"</span>),
        )
    }
}
</code></pre>
<h4 data-id="heading-20">3.2、看看效果</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/967ce4f37b074696bc7c72bed6c9c706~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF5dG9u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771406390&amp;x-signature=5sy5LiTytQZWW%2FXnjcRqLfef2Cw%3D" alt="4.png" loading="lazy"/></p>
<h3 data-id="heading-21">4、实现状态信息栏</h3>
<h4 data-id="heading-22">4.1、代码实现</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">WebSocketUi</span> {
    is_running: <span class="hljs-type">bool</span>,
    status_message: <span class="hljs-type">String</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">WebSocketUi</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> {
            is_running: <span class="hljs-literal">false</span>,
            status_message: <span class="hljs-string">"未开启"</span>.<span class="hljs-title function_ invoke__">into</span>(),
        }
    }
    
    <span class="hljs-comment">// 省略了 status_bar 方法</span>
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Render</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">WebSocketUi</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, window: &amp;<span class="hljs-keyword">mut</span> Window, cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoElement</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">status_message</span> = <span class="hljs-keyword">self</span>.status_message.<span class="hljs-title function_ invoke__">clone</span>();

        <span class="hljs-title function_ invoke__">div</span>().<span class="hljs-title function_ invoke__">size_full</span>().<span class="hljs-title function_ invoke__">p_4</span>().<span class="hljs-title function_ invoke__">bg</span>(<span class="hljs-title function_ invoke__">rgb</span>(<span class="hljs-number">0xffffff</span>)).<span class="hljs-title function_ invoke__">child</span>(
            <span class="hljs-title function_ invoke__">div</span>()
                <span class="hljs-comment">// 省略了一些代码</span>
                .<span class="hljs-title function_ invoke__">child</span>(status_message)
                .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-string">"操作栏在这里"</span>),
        )
    }
}
</code></pre>
<h4 data-id="heading-23">4.2、看看效果</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9604f3d0a72b49a5beadef811ec19e33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF5dG9u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771406390&amp;x-signature=fxqG%2F8NyPSKFCJcvJKSJv4qqL%2Fc%3D" alt="5.png" loading="lazy"/></p>
<h3 data-id="heading-24">5、实现操作栏</h3>
<h4 data-id="heading-25">5.1、代码实现</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">impl</span> <span class="hljs-title class_">WebSocketUi</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">start</span>(this: &amp;<span class="hljs-keyword">mut</span> WebSocketUi, _evt: &amp;ClickEvent, _win: &amp;<span class="hljs-keyword">mut</span> Window, cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-keyword">Self</span>&gt;) {
        <span class="hljs-keyword">if</span> !this.is_running {
            this.is_running = <span class="hljs-literal">true</span>;
            this.status_message = <span class="hljs-string">"已连接"</span>.<span class="hljs-title function_ invoke__">into</span>();
            cx.<span class="hljs-title function_ invoke__">notify</span>();
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">disconnect</span>(
        this: &amp;<span class="hljs-keyword">mut</span> WebSocketUi,
        _evt: &amp;ClickEvent,
        _win: &amp;<span class="hljs-keyword">mut</span> Window,
        cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-keyword">Self</span>&gt;,
    ) {
        <span class="hljs-keyword">if</span> this.is_running {
            this.is_running = <span class="hljs-literal">false</span>;
            this.status_message = <span class="hljs-string">"未连接"</span>.<span class="hljs-title function_ invoke__">into</span>();
            cx.<span class="hljs-title function_ invoke__">notify</span>();
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">send_test_message</span>(
        this: &amp;<span class="hljs-keyword">mut</span> WebSocketUi,
        _evt: &amp;ClickEvent,
        _win: &amp;<span class="hljs-keyword">mut</span> Window,
        cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-keyword">Self</span>&gt;,
    ) {
        <span class="hljs-keyword">if</span> this.is_running {
            this.status_message = <span class="hljs-string">"消息已发送"</span>.<span class="hljs-title function_ invoke__">into</span>();
            cx.<span class="hljs-title function_ invoke__">notify</span>();
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">actions_bar</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, _window: &amp;<span class="hljs-keyword">mut</span> Window, cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoElement</span> {
        <span class="hljs-keyword">let</span> (start_cursor, start_bg, stop_cursor, stop_bg) = <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.is_running {
            (
                CursorStyle::OperationNotAllowed,
                gpui::<span class="hljs-title function_ invoke__">black</span>().<span class="hljs-title function_ invoke__">opacity</span>(<span class="hljs-number">0.4</span>),
                CursorStyle::PointingHand,
                gpui::<span class="hljs-title function_ invoke__">black</span>(),
            )
        } <span class="hljs-keyword">else</span> {
            (
                CursorStyle::PointingHand,
                gpui::<span class="hljs-title function_ invoke__">black</span>(),
                CursorStyle::OperationNotAllowed,
                gpui::<span class="hljs-title function_ invoke__">black</span>().<span class="hljs-title function_ invoke__">opacity</span>(<span class="hljs-number">0.4</span>),
            )
        };

        <span class="hljs-title function_ invoke__">div</span>()
            .<span class="hljs-title function_ invoke__">flex</span>()
            .<span class="hljs-title function_ invoke__">gap_2</span>()
            .<span class="hljs-title function_ invoke__">child</span>(
                <span class="hljs-title function_ invoke__">div</span>()
                    .<span class="hljs-title function_ invoke__">id</span>(<span class="hljs-string">"connect"</span>) <span class="hljs-comment">// 这里要注意，和用户交互的 div 必须要加上 id，比如点击、滚动</span>
                    .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-string">"开启"</span>)
                    .<span class="hljs-title function_ invoke__">text_color</span>(gpui::<span class="hljs-title function_ invoke__">white</span>())
                    .<span class="hljs-title function_ invoke__">bg</span>(start_bg)
                    .<span class="hljs-title function_ invoke__">rounded_md</span>()
                    .<span class="hljs-title function_ invoke__">py_0p5</span>()
                    .<span class="hljs-title function_ invoke__">px_1</span>()
                    .<span class="hljs-title function_ invoke__">cursor</span>(start_cursor)
                    .<span class="hljs-title function_ invoke__">on_click</span>(cx.<span class="hljs-title function_ invoke__">listener</span>(<span class="hljs-keyword">Self</span>::start)),
            )
            .<span class="hljs-title function_ invoke__">child</span>(
                <span class="hljs-title function_ invoke__">div</span>()
                    .<span class="hljs-title function_ invoke__">id</span>(<span class="hljs-string">"disconnect"</span>)
                    .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-string">"关闭"</span>)
                    .<span class="hljs-title function_ invoke__">text_color</span>(gpui::<span class="hljs-title function_ invoke__">white</span>())
                    .<span class="hljs-title function_ invoke__">bg</span>(stop_bg)
                    .<span class="hljs-title function_ invoke__">rounded_md</span>()
                    .<span class="hljs-title function_ invoke__">py_0p5</span>()
                    .<span class="hljs-title function_ invoke__">px_1</span>()
                    .<span class="hljs-title function_ invoke__">cursor</span>(stop_cursor)
                    .<span class="hljs-title function_ invoke__">on_click</span>(cx.<span class="hljs-title function_ invoke__">listener</span>(<span class="hljs-keyword">Self</span>::disconnect)),
            )
            .<span class="hljs-title function_ invoke__">child</span>(
                <span class="hljs-title function_ invoke__">div</span>()
                    .<span class="hljs-title function_ invoke__">id</span>(<span class="hljs-string">"send"</span>)
                    .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-string">"发送测试消息"</span>)
                    .<span class="hljs-title function_ invoke__">text_color</span>(gpui::<span class="hljs-title function_ invoke__">white</span>())
                    .<span class="hljs-title function_ invoke__">bg</span>(stop_bg)
                    .<span class="hljs-title function_ invoke__">rounded_md</span>()
                    .<span class="hljs-title function_ invoke__">py_0p5</span>()
                    .<span class="hljs-title function_ invoke__">px_1</span>()
                    .<span class="hljs-title function_ invoke__">cursor</span>(stop_cursor)
                    .<span class="hljs-title function_ invoke__">on_click</span>(cx.<span class="hljs-title function_ invoke__">listener</span>(<span class="hljs-keyword">Self</span>::send_test_message)),
            )
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Render</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">WebSocketUi</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, window: &amp;<span class="hljs-keyword">mut</span> Window, cx: &amp;<span class="hljs-keyword">mut</span> Context&lt;<span class="hljs-keyword">Self</span>&gt;) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">impl</span> <span class="hljs-title class_">IntoElement</span> {
        <span class="hljs-title function_ invoke__">div</span>().<span class="hljs-title function_ invoke__">size_full</span>().<span class="hljs-title function_ invoke__">p_4</span>().<span class="hljs-title function_ invoke__">bg</span>(<span class="hljs-title function_ invoke__">rgb</span>(<span class="hljs-number">0xffffff</span>)).<span class="hljs-title function_ invoke__">child</span>(
            <span class="hljs-title function_ invoke__">div</span>()
               <span class="hljs-comment">// 省略了一些代码</span>
                .<span class="hljs-title function_ invoke__">child</span>(<span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">actions_bar</span>(window, cx)),
        )
    }
}
</code></pre>
<h4 data-id="heading-26">5.2、看看效果</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dffeb04c3e94eac83335009fc280fc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGF5dG9u:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771406390&amp;x-signature=IXrNt0ZXFdu9PuVY76ultR6exQo%3D" alt="6.png" loading="lazy"/></p>
<h2 data-id="heading-27">四、总结</h2>
<h3 data-id="heading-28">1、分清楚不同的 Context（cx）</h3>




















<table><thead><tr><th>上下文类型</th><th>线程</th><th>主要用途</th></tr></thead><tbody><tr><td>AppContext</td><td>主线程</td><td>应用启动、打开窗口</td></tr><tr><td>Context&lt;T&gt;</td><td>主线程</td><td>组件逻辑、UI 更新</td></tr></tbody></table>
<h3 data-id="heading-29">2、熟悉 <a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2Fdocs%2Fstyling-with-utility-classes" target="_blank" title="https://tailwindcss.com/docs/styling-with-utility-classes" ref="nofollow noopener noreferrer">Tailwind CSS</a></h3>
<h3 data-id="heading-30">3、熟悉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzed-industries%2Fzed%2Ftree%2Fmain%2Fcrates%2Fgpui%2Fexamples" target="_blank" title="https://github.com/zed-industries/zed/tree/main/crates/gpui/examples" ref="nofollow noopener noreferrer">gpui 的例子</a></h3>
<p>对于做前端的我来说，实现 UI 还是很容易的，把它和 WebScoket 服务集成在一起，才是最有挑战的。</p>
<p>等我有空了，我再写另一篇文章记录一下我掉进的深坑（主要是不熟悉多线程、异步任务）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 与前端开发的对比：构建、调试与平台兼容性差异]]></title>    <link>https://juejin.cn/post/7605174711182262335</link>    <guid>https://juejin.cn/post/7605174711182262335</guid>    <pubDate>2026-02-11T09:28:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605174711182262335" data-draft-id="7605128056485888015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 与前端开发的对比：构建、调试与平台兼容性差异"/> <meta itemprop="keywords" content="Flutter,前端"/> <meta itemprop="datePublished" content="2026-02-11T09:28:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月亮有石头"/> <meta itemprop="url" content="https://juejin.cn/user/3526889032395613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 与前端开发的对比：构建、调试与平台兼容性差异
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889032395613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月亮有石头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:28:10.000Z" title="Wed Feb 11 2026 09:28:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为一个传统前端开发者，最近接手了一个老的flutter项目，说实话感觉并不容易。Flutter 不仅仅是一个 UI 框架，它涉及到原生开发的诸多细节，平台兼容性、构建流程和调试方式都与传统前端开发有很大不同。</p>
<p>这篇文章将对比<strong>Flutter</strong>与传统前端框架（特别是 Vue 和 React）在<strong>构建、调试和平台兼容性</strong>方面的差异。让你了解从前端转向 Flutter 开发时，需要调整的思维和工具。</p>
<h2 data-id="heading-0">构建流程：Flutter 与前端框架的不同</h2>
<p>Flutter 构建流程不仅要支持 Web，还支持原生平台（Android 和 iOS）。它的构建过程需要涉及原生代码的编译、资源打包等，以下是每一步 Flutter 构建流程与前端构建流程中相应步骤和命令的对比。</p>
<h3 data-id="heading-1"><strong>1. 构建命令</strong></h3>
<h4 data-id="heading-2"><strong>Flutter：</strong> <code>flutter build</code> 命令</h4>
<p>Flutter 构建应用时，使用 <code>flutter build</code> 命令来生成不同平台的输出。以下是常用的构建命令：</p>
<ul>
<li><strong><code>flutter build apk</code></strong>：构建 Android 应用，生成 APK 文件。</li>
<li><strong><code>flutter build ios</code></strong>：构建 iOS 应用，生成 IPA 文件。</li>
<li><strong><code>flutter build web</code></strong>：构建 Web 应用，生成浏览器可以使用的静态文件（HTML、CSS、JS）。</li>
</ul>
<h4 data-id="heading-3"><strong>对比前端构建：</strong> <code>npm run build</code>（以 Vue/React 为例）</h4>
<p>前端开发（如 Vue 或 React）的构建流程通常依赖于 Webpack、Vite 等构建工具。这些工具会将代码打包、压缩并生成静态文件，适合在浏览器中运行。</p>
<ul>
<li><strong><code>npm run build</code></strong>：通过 Webpack 或 Vite 将前端应用编译成静态文件。通常会生成 <code>dist/</code> 或 <code>build/</code> 文件夹，里面包含 HTML、CSS 和 JavaScript 文件。</li>
</ul>
<h3 data-id="heading-4"><strong>2. 原生代码编译与优化</strong></h3>
<h4 data-id="heading-5"><strong>Flutter：</strong> AOT 编译</h4>
<p>Flutter 将 Dart 代码通过 AOT（Ahead-of-Time）编译为原生代码，这意味着 Flutter 会将应用的代码在构建时转换为可以直接在 Android 或 iOS 上执行的机器码。</p>
<ul>
<li><strong><code>flutter build apk</code></strong>：通过 AOT 编译生成 Android 平台的原生代码（APK）。</li>
<li><strong><code>flutter build ios</code></strong>：通过 AOT 编译生成 iOS 平台的原生代码（IPA）。</li>
</ul>
<h4 data-id="heading-6"><strong>对比前端编译：</strong> 编译和压缩</h4>
<p>前端框架（如 Vue 或 React）将 JavaScript 代码进行编译和压缩，以优化加载速度和减少文件大小。这个过程通常包括代码分割、模块合并等，确保最终的静态文件可以高效运行。</p>
<ul>
<li>
<p><strong>Webpack/Vite 编译</strong>：通过 Webpack 或 Vite，将 JavaScript、CSS 和图片等资源进行优化，生成静态文件。</p>
<ul>
<li><strong>代码分割</strong>：前端项目会根据需要将代码拆分成多个模块，按需加载。</li>
<li><strong>压缩和混淆</strong>：压缩 JavaScript、CSS 和图片，减少资源体积，提升加载速度。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7"><strong>3. 依赖管理</strong></h3>
<h4 data-id="heading-8"><strong>Flutter：</strong> <code>pubspec.yaml</code></h4>
<p>Flutter 使用 <code>pubspec.yaml</code> 文件来管理依赖，它与前端项目中的 <code>package.json</code> 文件类似。Flutter 项目的依赖不仅包括 Dart 包，还包括原生代码库的集成。</p>
<ul>
<li><strong><code>flutter pub get</code></strong>：安装 <code>pubspec.yaml</code> 中声明的依赖。</li>
<li><strong><code>flutter pub upgrade</code></strong>：升级依赖到最新版本。</li>
<li><strong><code>flutter pub outdated</code></strong>：查看过期的依赖，帮助进行版本管理。</li>
</ul>
<h4 data-id="heading-9"><strong>对比前端：</strong> <code>package.json</code> 和 <code>npm install</code></h4>
<p>前端项目通过 <code>package.json</code> 文件来管理 JavaScript 库和工具，类似于 Flutter 中的 <code>pubspec.yaml</code> 文件。<code>npm</code> 或 <code>yarn</code> 是前端项目的包管理工具，帮助安装和更新依赖。</p>
<ul>
<li><strong><code>npm install</code></strong>：安装 <code>package.json</code> 中列出的所有依赖。</li>
<li><strong><code>npm update</code></strong>：升级所有依赖到最新版本。</li>
<li><strong><code>npm outdated</code></strong>：查看过期的依赖和版本更新。</li>
</ul>
<h3 data-id="heading-10"><strong>4. 输出文件：平台特定的构建结果</strong></h3>
<h4 data-id="heading-11"><strong>Flutter：</strong> 原生应用（APK、IPA）和 Web 输出</h4>
<p>Flutter 会根据平台生成不同的输出文件：</p>
<ul>
<li><strong>Android：</strong> 生成 APK 文件，可以直接安装到 Android 设备上。</li>
<li><strong>iOS：</strong> 生成 IPA 文件，可以通过 Xcode 部署到 iOS 设备上。</li>
<li><strong>Web：</strong> 生成 HTML、CSS 和 JavaScript 文件，可以直接部署到 Web 服务器上。</li>
</ul>
<h4 data-id="heading-12"><strong>对比前端构建产物：</strong> 静态文件（HTML、CSS、JS）</h4>
<p>前端项目在构建后生成适用于浏览器的静态文件，包括：</p>
<ul>
<li><strong>HTML</strong>：基础页面结构。</li>
<li><strong>CSS</strong>：样式表，定义页面样式。</li>
<li><strong>JavaScript</strong>：行为脚本，控制页面交互。</li>
</ul>
<p>这些文件最终通过 HTTP 或其他协议加载并渲染在浏览器中。</p>
<h3 data-id="heading-13"><strong>总结对比：Flutter 与前端构建的差异</strong></h3>






























<table><thead><tr><th><strong>构建步骤</strong></th><th><strong>Flutter</strong></th><th><strong>前端（Vue/React）</strong></th></tr></thead><tbody><tr><td><strong>构建命令</strong></td><td><code>flutter build apk/ios/web</code></td><td><code>npm run build</code></td></tr><tr><td><strong>原生代码编译</strong></td><td>使用 AOT 编译 Dart 代码生成原生 APK/IPA</td><td>使用 Webpack/Vite 对 JS、CSS 进行编译和压缩</td></tr><tr><td><strong>依赖管理</strong></td><td><code>pubspec.yaml</code> 管理依赖，使用 <code>flutter pub get</code> 等命令</td><td><code>package.json</code> 管理依赖，使用 <code>npm install</code> 等命令</td></tr><tr><td><strong>输出文件</strong></td><td>输出 APK、IPA 或 Web 文件</td><td>输出静态文件（HTML、CSS、JS）</td></tr></tbody></table>
<ul>
<li><strong>构建工具</strong>：Flutter 的构建工具需要处理多个平台的构建（Android、iOS、Web），而前端框架的构建工具主要聚焦于 Web 构建（尽管有些框架支持静态网站生成等）。</li>
<li><strong>原生代码编译</strong>：Flutter 需要进行 AOT 编译，将 Dart 代码转化为原生代码，而前端框架主要依赖 JavaScript 打包和优化。</li>
<li><strong>依赖管理</strong>：Flutter 和前端项目都通过配置文件（<code>pubspec.yaml</code> 和 <code>package.json</code>）管理依赖，但 Flutter 还涉及到原生库和插件的集成，增加了依赖管理的复杂度。</li>
</ul>
<p>虽然 Flutter 和前端框架（如 Vue 和 React）在构建和依赖管理上有一些相似之处，但 Flutter 的构建流程涉及更多平台特定的操作，复杂度较高。</p>
<h2 data-id="heading-14">调试：Flutter 与前端框架的调试差异</h2>
<h4 data-id="heading-15"><strong>前端框架调试（Vue/React）</strong></h4>
<p>在前端框架中，调试流程非常简便，主要依赖浏览器的开发者工具和热重载功能。</p>
<ul>
<li><strong>浏览器调试</strong>：前端开发中的调试，绝大多数依赖浏览器的开发者工具（DevTools）。通过查看控制台日志、断点调试和网络请求分析，我们可以轻松地调试 Vue 和 React 应用。</li>
<li><strong>热重载</strong>：前端框架的热重载非常快捷，修改代码后，开发服务器会自动刷新页面，立即看到效果。</li>
</ul>
<h4 data-id="heading-16"><strong>Flutter 调试</strong></h4>
<p>Flutter 的调试方式更为复杂，主要依赖于 Android Studio 或 Visual Studio Code 中的插件支持。</p>
<ul>
<li><strong>Flutter DevTools</strong>：Flutter 提供了专门的 DevTools，支持调试 Dart 代码、查看性能、内存使用情况、UI 渲染等。通过 Flutter DevTools，我们可以深入了解应用的行为，特别是在性能和资源管理方面。</li>
<li><strong>热重载</strong>：Flutter 也有热重载功能，当修改代码时，Flutter 会迅速重新加载应用的界面，保持应用状态，避免重新启动应用。</li>
<li><strong>原生调试</strong>：在调试 Android 和 iOS 应用时，我们还需要使用 Android Studio 或 Xcode，查看原生代码和日志，调试更为繁琐。</li>
</ul>
<h5 data-id="heading-17"><strong>总结</strong>：</h5>
<ul>
<li><strong>调试工具</strong>：前端框架的调试通常依赖于浏览器开发者工具，而 Flutter 调试则需要借助专门的 DevTools 和原生开发工具（Android Studio、Xcode）。</li>
<li><strong>调试体验</strong>：前端开发的调试过程相对简洁，而 Flutter 的调试不仅涉及到 Dart 代码，还涉及到原生平台的调试，因此调试过程更为复杂。</li>
</ul>
<h2 data-id="heading-18">平台兼容性：Flutter 与前端框架的差异</h2>
<h4 data-id="heading-19"><strong>前端框架的跨平台兼容性</strong></h4>
<p>前端框架（如 Vue 和 React）主要运行在 Web 浏览器中，其跨平台的核心在于浏览器的支持。浏览器已经高度标准化，现代浏览器对 HTML、CSS 和 JavaScript 的支持非常广泛，确保了 Web 应用能够在不同操作系统和设备上运行。</p>
<ul>
<li><strong>兼容性</strong>：前端框架通过响应式设计、CSS 媒体查询和现代 JavaScript 的特性来适配不同的屏幕尺寸和设备。</li>
<li><strong>限制</strong>：尽管前端框架可以跨平台，但它们只能运行在支持现代浏览器的设备上，且性能可能受限于浏览器引擎。</li>
</ul>
<h4 data-id="heading-20"><strong>Flutter 的跨平台兼容性</strong></h4>
<p>Flutter 的跨平台兼容性比前端框架复杂得多，因为它不仅支持 Web 端，还支持 Android 和 iOS 等原生平台。</p>
<ul>
<li><strong>跨平台编译</strong>：Flutter 通过 Dart 代码与平台之间的桥接，提供一次开发，多平台运行的能力。Flutter 会将代码编译成每个平台的原生代码，因此可以获得原生应用的性能。</li>
<li><strong>平台适配</strong>：Flutter 提供了大量的 Material 和 Cupertino 组件来帮助适配不同平台的 UI 样式，但开发者仍然需要关注不同平台间的差异，尤其是在 Android 和 iOS 之间。</li>
<li><strong>Web 支持</strong>：Flutter Web 虽然在不断发展，但相比原生 Android/iOS，Web 的性能和兼容性仍然存在差距，尤其是在处理大量动画和复杂 UI 时，性能可能不如原生应用。</li>
</ul>
<h5 data-id="heading-21"><strong>总结</strong>：</h5>
<ul>
<li><strong>兼容性</strong>：前端框架主要在浏览器中运行，平台兼容性问题较少；而 Flutter 需要在多个平台上进行编译和适配，尤其是 Android 和 iOS 的差异需要额外关注。</li>
<li><strong>跨平台实现</strong>：前端框架通过浏览器实现跨平台，而 Flutter 通过编译为原生代码实现跨平台，性能上可能优于纯 Web 应用，但开发成本和复杂度也较高。
是的，<strong>签名</strong>（尤其是在移动应用开发中）确实和传统前端开发有很大的不同，特别是在 Flutter 中，涉及到 <strong>Android</strong> 和 <strong>iOS</strong> 应用的 <strong>签名</strong> 配置。</li>
</ul>
<h2 data-id="heading-22">签名</h2>
<p>在传统的 <strong>前端开发</strong> 中，通常并不需要考虑签名问题，前端项目的发布主要是生成静态文件（如 HTML、CSS、JavaScript）并部署到服务器上，这个过程通常不涉及到身份认证、签名等操作。签名在前端更多地出现在 API 调用的身份验证中，比如使用 JWT（Json Web Token）进行请求授权。</p>
<p>而在 <strong>Flutter</strong> 中，特别是涉及 <strong>Android</strong> 和 <strong>iOS</strong> 原生应用的构建时，<strong>签名</strong> 是必须要处理的步骤之一。签名的主要作用是确保应用的安全性，防止应用被恶意篡改，并保证应用发布的身份可信。</p>
<h3 data-id="heading-23"><strong>1. Android 签名</strong></h3>
<p>对于 <strong>Android</strong> 应用，签名是发布应用到 <strong>Google Play Store</strong> 或直接安装到设备的必要步骤。签名确保了 APK 文件的完整性和安全性。</p>
<ul>
<li><strong>debug.keystore</strong>：Flutter 项目默认提供了一个 <strong>debug</strong> 签名（<code>debug.keystore</code>），用于开发过程中调试应用。</li>
<li><strong>release.keystore</strong>：发布应用时，必须使用发布版的 <strong>release.keystore</strong> 进行签名。这是一个包含私钥的文件，只有正确的私钥才能签署 APK 文件，使其能够被安装和分发。</li>
</ul>
<p>签名配置通常在 <strong>Android</strong> 项目的 <code>build.gradle</code> 文件中进行设置。例如：</p>
<pre><code class="hljs language-js" lang="js">android {
    signingConfigs {
        release {
            storeFile <span class="hljs-title function_">file</span>(<span class="hljs-string">'path_to_your_keystore_file/release.keystore'</span>)
            storePassword <span class="hljs-string">'your_keystore_password'</span>
            keyAlias <span class="hljs-string">'your_key_alias'</span>
            keyPassword <span class="hljs-string">'your_key_password'</span>
        }
    }

    buildTypes {
        release {
            signingConfig signingConfigs.<span class="hljs-property">release</span>
        }
    }
}
</code></pre>
<p>通过上述配置，Flutter 会在构建发布版 APK 时自动使用配置中的签名信息。</p>
<h3 data-id="heading-24"><strong>2. iOS 签名</strong></h3>
<p>在 <strong>iOS</strong> 平台上，签名过程更加严格，所有的 iOS 应用都必须通过 <strong>Apple</strong> 的签名机制进行签名，否则无法安装到设备上，且不能在 <strong>App Store</strong> 上发布。</p>
<p><strong>iOS 签名流程</strong>：</p>
<ul>
<li><strong>开发者证书</strong>：需要通过 <strong>Apple Developer Program</strong> 注册并获取一个开发者证书。</li>
<li><strong>Provisioning Profile</strong>：为应用创建一个有效的 Provisioning Profile，关联应用标识符、设备和证书。</li>
<li><strong>Xcode 配置</strong>：在 <strong>Xcode</strong> 中配置签名信息，确保应用使用正确的证书和 Profile。</li>
</ul>
<p>在 <strong>Flutter</strong> 中，构建 <strong>iOS</strong> 应用时，你需要配置好证书、签名文件（如 <code>*.p12</code>）和 <strong>Provisioning Profile</strong>。签名设置通常通过 <strong>Xcode</strong> 来完成。配置文件在 <strong>Flutter</strong> 项目中 <code>ios/Runner.xcodeproj</code> 下进行处理。</p>
<h3 data-id="heading-25"><strong>3. 签名与前端开发的不同</strong></h3>
<h4 data-id="heading-26"><strong>前端开发：</strong></h4>
<p>在前端项目中，<strong>签名</strong> 不涉及应用的发布和安装过程。前端应用的发布通常是将文件上传到服务器（如 <strong>Netlify</strong>、<strong>Vercel</strong> 或传统服务器），并通过 <strong>HTTPS</strong> 安全传输。前端的“签名”更多是在 <strong>API</strong> 调用中使用 <strong>OAuth</strong> 或 <strong>JWT</strong> 等令牌进行身份认证和授权。</p>
<h4 data-id="heading-27"><strong>Flutter 开发：</strong></h4>
<p>在 <strong>Flutter</strong> 中，尤其是发布 <strong>Android</strong> 和 <strong>iOS</strong> 应用时，签名是必须处理的步骤。它涉及：</p>
<ul>
<li><strong>生成签名文件</strong>（如 <code>debug.keystore</code> 或 <code>release.keystore</code>，以及 iOS 的开发者证书）。</li>
<li><strong>配置签名文件</strong>，确保只有合法的密钥才能对应用进行签名和发布。</li>
<li><strong>签名的验证</strong>：签名文件确保应用的完整性，防止恶意篡改和伪造，尤其是对于 Android 和 iOS 平台，只有经过签名的 APK 或 IPA 文件才能在设备上安装。</li>
</ul>
<p><strong>签名</strong> 是 Flutter 开发中与传统前端开发最显著的差异之一。在 <strong>前端开发</strong> 中，签名通常出现在 <strong>API 认证</strong> 上，而在 <strong>Flutter</strong> 中，签名更重要的是涉及到 <strong>应用的发布与分发</strong>，特别是对于 <strong>Android</strong> 和 <strong>iOS</strong> 应用。</p>
<p>理解这些签名机制及其配置方式，对从传统前端转向 <strong>Flutter</strong> 开发的开发者至关重要。</p>
<h2 data-id="heading-28">Flutter 开发中的核心术语</h2>
<ul>
<li>
<p><strong>Dart</strong>：Flutter 使用的编程语言，面向对象，支持并发和异步操作，专为客户端开发设计。</p>
</li>
<li>
<p><strong>Kotlin</strong>：用于 <strong>Android</strong> 开发的现代编程语言，Flutter 与原生 <strong>Android</strong> 交互时常用。</p>
</li>
<li>
<p><strong>AOT 编译（Ahead-of-Time 编译）</strong> ：在构建时将 <strong>Dart</strong> 代码编译为原生机器码，提升应用启动速度和运行性能。</p>
</li>
<li>
<p><strong>JIT 编译（Just-in-Time 编译）</strong> ：运行时动态编译代码，支持开发模式下的热重载。</p>
</li>
<li>
<p><strong>Flutter Engine</strong>：Flutter 的底层渲染引擎，负责 UI 渲染、事件处理、平台交互等核心功能。</p>
</li>
<li>
<p><strong>Flutter SDK</strong>：开发者使用的工具包，包含 <strong>Flutter Engine</strong>、Dart SDK 和构建工具，支持跨平台开发。</p>
</li>
<li>
<p><strong>Flutter DevTools</strong>：Flutter 提供的调试工具，帮助开发者分析性能、内存使用、UI 渲染等。</p>
</li>
<li>
<p><strong>Hot Reload</strong>：Flutter 的开发模式功能，修改代码后无需重启应用即可即时更新 UI，保持应用状态。</p>
</li>
<li>
<p><strong>Hot Restart</strong>：完全重新启动应用并丢失当前状态，适用于需要清除应用状态的场景。</p>
</li>
<li>
<p><strong>Platform Channels</strong>：Flutter 与原生平台（Android/iOS）交互的通信机制，支持双向数据传递。</p>
</li>
<li>
<p><strong>pubspec.yaml</strong>：Flutter 项目的配置文件，类似于前端的 <code>package.json</code>，用于管理依赖、资源等。管理 <strong>Dart 包</strong> 和 <strong>Flutter 插件</strong>，其中插件允许与 <strong>Android</strong> 和 <strong>iOS</strong> 的原生代码进行集成。</p>
</li>
<li>
<p><strong>Widget</strong>：Flutter 中的基本 UI 组件，所有的 UI 元素（如按钮、文本、布局等）都是通过 <strong>Widget</strong> 构建的。</p>
</li>
<li>
<p><strong>Flutter Build System</strong>：Flutter 用于构建应用的工具系统，支持生成 APK、IPA 或 Web 应用。</p>
</li>
<li>
<p><strong>Dart VM</strong>：Dart 的虚拟机，执行运行时的 <strong>Dart</strong> 代码，支持 JIT 编译和调试功能。</p>
</li>
<li>
<p><strong>fastlane</strong>：一个自动化构建和发布工具，广泛用于 <strong>iOS</strong> 和 <strong>Android</strong> 应用的构建、测试、发布和提交流程，简化了 CI/CD 流程。</p>
</li>
<li>
<p><strong>Flutter Plugin</strong>：一种 Flutter 插件，用于扩展 Flutter 的功能，通过与原生平台的代码进行交互，提供相机、定位、传感器等设备功能。</p>
</li>
<li>
<p><strong>Gradle</strong>：一个强大的构建自动化工具，Flutter 使用 <strong>Gradle</strong> 来构建 <strong>Android</strong> 应用，负责依赖管理、编译、打包等任务。</p>
</li>
<li>
<p><strong>Xcode</strong>：苹果公司开发的集成开发环境（IDE），用于开发 <strong>iOS</strong> 和 <strong>macOS</strong> 应用，Flutter 用来构建和部署 <strong>iOS</strong> 应用。</p>
</li>
<li>
<p><strong>Android Studio</strong>：Google 提供的官方 IDE，用于开发 <strong>Android</strong> 应用。</p>
</li>
<li>
<p><strong>DartPad</strong>：一个在线 Dart 代码编辑器，允许开发者在浏览器中快速编写和测试 <strong>Dart</strong> 代码，适合初学者和快速原型开发。</p>
</li>
<li>
<p><strong>App Bundle</strong>：一种 <strong>Android</strong> 应用的发布格式（<code>.aab</code> 文件），比 APK 文件更小，支持更高效的 APK 打包和分发。</p>
</li>
<li>
<p><strong>Flutter Channels</strong>：用于选择不同的开发版本，如 <strong>stable</strong>、<strong>beta</strong>、<strong>dev</strong> 和 <strong>master</strong>，以便根据不同渠道，选择稳定版或试验版。</p>
</li>
<li>
<p><strong>FlutterTest</strong>：Flutter 提供的单元测试框架，用于编写和运行 Dart 代码和 Flutter 应用的单元测试，确保代码质量和功能正确。</p>
</li>
<li>
<p><strong>Flutter Driver</strong> 允许开发者模拟用户与应用的交互，验证 UI 和用户体验方面的功能。</p>
</li>
<li>
<p><strong>Dart DevTools</strong>：Flutter 的调试工具，帮助开发者监控应用性能，分析内存和 CPU 使用情况，查看 UI 渲染和调试信息。</p>
</li>
<li>
<p><strong>CI/CD</strong>（Continuous Integration/Continuous Delivery）：持续集成和持续交付，是开发流程的一部分，旨在自动化代码构建、测试和发布的过程，<strong>Flutter</strong> 可以与工具如 <strong>Jenkins</strong>、<strong>GitLab CI</strong>、<strong>Bitrise</strong> 等集成实现自动化。</p>
</li>
<li>
<p><strong>Widget Tree</strong>：Flutter 中的 UI 组件是通过 <strong>Widget</strong> 组成的树形结构，称为 <strong>Widget Tree</strong>，通过树形结构管理视图层次关系。</p>
</li>
<li>
<p><strong>Skia</strong>：Flutter 使用的高性能渲染引擎，负责将 UI 绘制到屏幕上，确保 Flutter 应用能够在多个平台上渲染一致的 UI。</p>
</li>
<li>
<p><strong>Dart FFI</strong>（Foreign Function Interface）：Dart 提供的接口，使 Dart 代码能够与其他语言（如 <strong>C</strong>、<strong>C++</strong> ）编写的库进行交互，通常用于性能优化或访问低级平台功能。</p>
</li>
<li>
<p><strong>Hotfix</strong>：Flutter 支持在应用运行时热修复，即无需重新编译和发布，直接对应用进行快速修复，适用于修复小的 bug 或问题。</p>
</li>
</ul>
<h2 data-id="heading-29">结论：从前端到 Flutter，最需要调整的是思维</h2>
<ul>
<li><strong>构建差异</strong>：Flutter 需要涉及原生平台的构建和编译，而前端框架只关注浏览器端的构建。</li>
<li><strong>调试差异</strong>：前端开发依赖浏览器的开发者工具，Flutter 调试涉及 Dart 代码和原生代码的调试工具。</li>
<li><strong>平台兼容性</strong>：前端框架通过 Web 浏览器实现跨平台，而 Flutter 则通过原生代码实现跨平台，支持更多的原生功能，但也带来了更高的开发复杂度。</li>
</ul>
<p>对于从纯前端转向 Flutter 开发，最大的挑战是从浏览器端的简单构建转向涉及原生开发的构建流程，同时需要适应更多的原生平台差异。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥从"打补丁"到"换思路"：一次企业级 AI Agent 的架构拐点]]></title>    <link>https://juejin.cn/post/7605145921618362420</link>    <guid>https://juejin.cn/post/7605145921618362420</guid>    <pubDate>2026-02-11T09:36:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605145921618362420" data-draft-id="7605114266023968819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥从&quot;打补丁&quot;到&quot;换思路&quot;：一次企业级 AI Agent 的架构拐点"/> <meta itemprop="keywords" content="Agent,前端,面试"/> <meta itemprop="datePublished" content="2026-02-11T09:36:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sailing"/> <meta itemprop="url" content="https://juejin.cn/user/307518988100237"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥从"打补丁"到"换思路"：一次企业级 AI Agent 的架构拐点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/307518988100237/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sailing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:36:44.000Z" title="Wed Feb 11 2026 09:36:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在做企业级 AI Agent 时，我踩过一个非常典型的坑。</p>
<p>一开始我以为只是个“小逻辑问题”。后来我发现，那是一次<strong>架构认知的分水岭</strong>。</p>
<p>这篇文章，讲的不是“消息补全”。讲的是一个更重要的问题：</p>
<blockquote>
<p>当规则开始打补丁时，你是不是已经选错了工具？</p>
</blockquote>
<div align="center">
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e63cb79f09a43df977a5c4aa646456e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FpbGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771407403&amp;x-signature=H6D3Oc6P5ekWOaJvhFtXRLDWbuU%3D" width="100%" loading="lazy"/>
</div>
<h2 data-id="heading-0">问题很简单：AI 听不懂 “...这个呢”</h2>
<p>我们在做一个企业内部智能运维助手 LUI Agent。能力很清晰：</p>
<ul>
<li>查询域名状态</li>
<li>查询 Pod 数</li>
<li>搜索内部文档</li>
<li>......</li>
</ul>
<p>在实现多轮对话时，出现了一个极其常见的问题：</p>
<pre><code class="hljs language-text" lang="text">用户：查询域名 bbb.com 的状态
AI：该域名 QPS 为 120，P99 为 45ms...

用户：yyy.com 这个呢
AI：？？？
</code></pre>
<p>第二句话——</p>
<blockquote>
<p>“yyy.com 这个呢”</p>
</blockquote>
<p>从人类视角看，毫无歧义。<br/>
但从工具调用视角看，这是一个<strong>不完整的句子</strong>。</p>
<p>下游网关服务根本不知道用户要干什么。</p>
<p>所以我们需要一个能力：</p>
<blockquote>
<p>在调用工具前，把“不完整的问题”补全为完整问题。</p>
</blockquote>
<h2 data-id="heading-1">第一反应：规则一定能搞定（踩坑之路）</h2>
<p>作为一个开发者，我的第一反应非常自然：这不就是模式匹配吗？</p>
<p>于是写了第一版规则:</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">private</span> <span class="hljs-title function_">isIncompleteMessage</span>(<span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">const</span> trimmed = message.<span class="hljs-title function_">trim</span>();

  <span class="hljs-keyword">if</span> (trimmed.<span class="hljs-property">length</span> &lt; <span class="hljs-number">8</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/呢[？?]?$/</span>.<span class="hljs-title function_">test</span>(trimmed)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/吗[？?]?$/</span>.<span class="hljs-title function_">test</span>(trimmed)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^(这个|那个|这|那)/</span>.<span class="hljs-title function_">test</span>(trimmed)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p>看起来很优雅：</p>
<ul>
<li>短消息？拦截。</li>
<li>追问句式？拦截。</li>
<li>指代开头？拦截。</li>
</ul>
<p>覆盖三大类问题。我当时甚至觉得设计得挺漂亮。</p>
<div align="center">
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/221389664956484d94725b1b37b2f4dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FpbGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771407403&amp;x-signature=mlwfXs9hd2e82K%2BN2zd%2FxfdyN5s%3D" width="45%" loading="lazy"/>
</div>
<h2 data-id="heading-2">然后，规则开始失控</h2>
<p>测试几轮后，问题很快暴露：</p>
<h3 data-id="heading-3">Case 1</h3>
<pre><code class="hljs">yyy.com这个呢
</code></pre>
<p>长度 19,不符合 <code>&lt; 8</code>。</p>
<p>规则顺序导致被判定为“完整问题”。</p>
<p>我开始加补丁。</p>
<h3 data-id="heading-4">Case 2</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.com</span>也查一下
</code></pre>
<p>好，加一个“也 + 动词”规则。</p>
<h3 data-id="heading-5">Case 3</h3>
<pre><code class="hljs">yyy.com呢
</code></pre>
<p>好，再扩展域名 + 呢。</p>
<h3 data-id="heading-6">Case 4</h3>
<pre><code class="hljs">这个应用有几个pod
</code></pre>
<p>以“这个”开头，但其实是完整问题。误判。</p>
<h3 data-id="heading-7">Case 5</h3>
<pre><code class="hljs">这个功能很好用
</code></pre>
<p>被误判为“不完整问题”。假阳性。</p>
<hr/>
<p>那一刻我突然意识到：</p>
<blockquote>
<p>我已经开始写“例外规则”了。</p>
</blockquote>
<p>而当你开始写例外规则的时候，你已经失去了规则系统的简洁性。</p>
<p>规则不再是“设计”，它开始变成“修修补补”。（越来越不好维护！）</p>
<div align="center">
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/981451833f854abfac1026d7fc9ded26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FpbGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771407403&amp;x-signature=oAmvr6AercCRw4%2BQo3BbRRKrXK4%3D" width="40%" loading="lazy"/>
</div>
<h2 data-id="heading-8">真正的问题：这不是字符串问题</h2>
<p>我突然意识到一个更本质的问题：我在用规则解决一个语义问题。</p>
<ol>
<li>“这个呢” 不是句法问题，是指代问题。</li>
<li>不是字符串匹配问题，是上下文理解问题。</li>
</ol>
<p>这本质上是一个<strong>语义理解任务</strong>。而我在用规则解决语义，这就像用 if/else 写一个自然语言理解系统，注定会崩。</p>
<p>相反，正是 LLM 天生擅长的领域。</p>
<h2 data-id="heading-9">意图识别</h2>
<h3 data-id="heading-10">换思路：让 LLM 做意图补全</h3>
<p>我加了一层“消息预处理”。在真正调用 agent 工具前，让 LLM 判断：</p>
<ul>
<li>当前问题是否完整？</li>
<li>是否是追问？</li>
<li>是否需要结合历史补全？</li>
</ul>
<p>核心逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 预处理消息：使用 LLM 判断并补全不完整的问题
 */</span>
private <span class="hljs-keyword">async</span> <span class="hljs-title function_">preprocessMessage</span>(
  <span class="hljs-attr">message</span>: string, 
  <span class="hljs-attr">history</span>: <span class="hljs-title class_">BaseMessage</span>[], 
  <span class="hljs-attr">agentId</span>: string, 
  requestId?: string
): <span class="hljs-title class_">Promise</span>&lt;string&gt; {
  <span class="hljs-comment">// 没有历史对话，无需补全</span>
  <span class="hljs-keyword">if</span> (history.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> message;
  }
  
  <span class="hljs-keyword">const</span> llm = <span class="hljs-title function_">getLLM</span>();
  
  <span class="hljs-comment">// 取最近的对话历史</span>
  <span class="hljs-keyword">const</span> recentHistory = history.<span class="hljs-title function_">slice</span>(-<span class="hljs-number">6</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">msg</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> role = msg <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HumanMessage</span> ? <span class="hljs-string">'用户'</span> : <span class="hljs-string">'助手'</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${role}</span>: <span class="hljs-subst">${<span class="hljs-built_in">String</span>(msg.content).substring(<span class="hljs-number">0</span>, <span class="hljs-number">200</span>)}</span>`</span>;
  }).<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>);
  
  <span class="hljs-keyword">const</span> prompt = <span class="hljs-string">`你是一个意图分析助手。判断用户当前输入是否需要根据对话历史补全。

## 对话历史
<span class="hljs-subst">${recentHistory}</span>

## 用户当前输入
<span class="hljs-subst">${message}</span>

## 任务
1. 判断当前输入是否是一个完整、独立的问题
2. 如果是完整问题，直接返回原文
3. 如果是追问、指代、省略句式（如"这个呢"、"xxx也查一下"、"状态如何"），结合历史补全为完整问题

## 输出
只返回最终的问题（补全后或原文），不要任何解释。`</span>;

  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llm.<span class="hljs-title function_">invoke</span>(prompt);
  <span class="hljs-keyword">const</span> completed = <span class="hljs-keyword">typeof</span> response.<span class="hljs-property">content</span> === <span class="hljs-string">'string'</span> 
    ? response.<span class="hljs-property">content</span>.<span class="hljs-title function_">trim</span>() 
    : message;
  
  <span class="hljs-comment">// 记录是否进行了补全</span>
  <span class="hljs-keyword">if</span> (completed !== message) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'消息已补全'</span>, { <span class="hljs-attr">original</span>: message, completed });
  }
  
  <span class="hljs-keyword">return</span> completed || message;
}
</code></pre>
<p>核心 Prompt 起了很大作用：</p>
<pre><code class="hljs language-md" lang="md">你是一个意图分析助手。判断用户当前输入是否需要根据对话历史补全。

<span class="hljs-section">## 任务</span>
<span class="hljs-bullet">1.</span> 判断当前输入是否是一个完整、独立的问题
<span class="hljs-bullet">2.</span> 如果是完整问题，直接返回原文
<span class="hljs-bullet">3.</span> 如果是追问、指代、省略句式（如"这个呢"、"xxx也查一下"、"状态如何"），结合历史补全为完整问题
</code></pre>
<h3 data-id="heading-11">效果对比：规则 vs 语义</h3>
<p>对话历史：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户: 查询域名 xxx.com 的状态</span>
<span class="hljs-section">助手: 该域名 QPS 为 120，响应时间 P99 为 45ms...</span>

<span class="hljs-section">用户输入: yyy.com这个呢</span>
LLM 补全: 查询域名 yyy.com 的状态 ✅
</code></pre>
<p>对话历史：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户: 这个应用有几个pod</span>
<span class="hljs-section">助手: 当前应用 yyy.com 有 3 个 Pod...</span>

<span class="hljs-section">用户输入: 这个应用呢（切换了应用）</span>
LLM 补全: 这个应用有几个pod ✅
</code></pre>
<p>对话历史：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户: 查询 xxx.com 的 QPS</span>
<span class="hljs-section">助手: xxx.com 的 QPS 为 50...</span>

<span class="hljs-section">用户输入: yyy.com 也查一下</span>
LLM 补全: 查询 yyy.com 的 QPS ✅
</code></pre>
<p>完美！LLM 能够理解语义，自动处理各种追问句式。</p>
<ul>
<li>没有新增规则。</li>
<li>没有顺序依赖。</li>
<li>没有边界爆炸。</li>
</ul>
<p>它理解了语义。</p>
<h3 data-id="heading-12">但 LLM 不是银弹</h3>
<p>LLM 问题也随之而来：</p>
<ul>
<li>延迟增加 500ms ~ 1s。</li>
<li>Token 成本增加。</li>
<li>输出不可 100% 可控。</li>
</ul>
<p>所以，我没有“全盘 LLM 化”。而是做了一个分层架构。</p>
<div align="center">
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85f96f9266af4be89eaaff162757646a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FpbGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771407403&amp;x-signature=5TGmlGnOLIEJZbuicbKEavy2YfY%3D" width="60%" loading="lazy"/>
</div>
<h2 data-id="heading-13">混合架构：规则前置，LLM兜底</h2>
<p>在实际项目中，采用了"规则快速拦截 + LLM 深度分析"的混合策略：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 意图分析流程</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">analyzeIntent</span>(<span class="hljs-params">message: string, history: BaseMessage[]</span>) {
  <span class="hljs-comment">// 1. 规则快速拦截（&lt; 1ms）</span>
  <span class="hljs-keyword">const</span> quickResult = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">quickIntercept</span>(message);
  <span class="hljs-keyword">if</span> (quickResult.<span class="hljs-property">confident</span>) {
    <span class="hljs-keyword">return</span> quickResult;
  }
  
  <span class="hljs-comment">// 2. LLM 深度分析（500ms - 3s）</span>
  <span class="hljs-keyword">const</span> llmResult = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">llmAnalyze</span>(message, history);
  <span class="hljs-keyword">return</span> llmResult;
}

<span class="hljs-comment">// 规则快速拦截</span>
private <span class="hljs-title function_">quickIntercept</span>(<span class="hljs-params">message: string</span>) {
  <span class="hljs-comment">// 问候语</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^(你好|hi|hello|嗨)/i</span>.<span class="hljs-title function_">test</span>(message)) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">agentId</span>: <span class="hljs-string">'general'</span>, <span class="hljs-attr">confident</span>: <span class="hljs-literal">true</span> };
  }
  <span class="hljs-comment">// 身份询问</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/你是谁|你叫什么/</span>.<span class="hljs-title function_">test</span>(message)) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">agentId</span>: <span class="hljs-string">'general'</span>, <span class="hljs-attr">confident</span>: <span class="hljs-literal">true</span> };
  }
  <span class="hljs-comment">// 导航意图（明确的跳转词）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^(跳转|打开|进入|去)(到)?/</span>.<span class="hljs-title function_">test</span>(message)) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">agentId</span>: <span class="hljs-string">'navigation'</span>, <span class="hljs-attr">confident</span>: <span class="hljs-literal">true</span> };
  }
  <span class="hljs-comment">// 不确定，交给 LLM</span>
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">confident</span>: <span class="hljs-literal">false</span> };
}
</code></pre>
<h3 data-id="heading-14">规则适合：</h3>
<ul>
<li>问候语（例如：你好、你是）</li>
<li>明确跳转（例如：打开**、跳转**）</li>
<li>格式校验</li>
<li>固定关键词</li>
</ul>
<h3 data-id="heading-15">LLM 适合：</h3>
<ul>
<li>指代</li>
<li>追问</li>
<li>模糊表达</li>
<li>语义补全</li>
</ul>
<p>规则保证速度，LLM 保证理解。<strong>这才是企业级 Agent 的现实架构。</strong></p>
<h2 data-id="heading-16">更隐蔽的一次教训：历史丢失</h2>
<p>后来，我还踩了一个更隐蔽的坑。</p>
<p>日志显示：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable constant_">API</span> <span class="hljs-attr">historyLength</span>: <span class="hljs-number">10</span>
<span class="hljs-title class_">MasterAgent</span> <span class="hljs-attr">historyLength</span>: <span class="hljs-number">6</span>
</code></pre>
<p>丢了 4 条。原因：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-literal">undefined</span>) <span class="hljs-comment">// -&gt; undefined</span>
</code></pre>
<p>某些结构化消息没有 content 字段，被我写的代码逻辑给过滤掉了。</p>
<p><strong>修复方式：</strong> 直接 stringify 化</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getMessageContent</span>(<span class="hljs-params">msg</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> msg.<span class="hljs-property">content</span> === <span class="hljs-string">'string'</span>) <span class="hljs-keyword">return</span> msg.<span class="hljs-property">content</span>;

  <span class="hljs-keyword">const</span> { role, timestamp, ...rest } = msg;
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(rest);
}
</code></pre>
<p><strong>让 LLM 自己理解结构化数据</strong>。</p>
<p>这件事让我学到一个重要认知：</p>
<blockquote>
<p>不要低估 LLM 对结构化信息的理解能力。<br/>
信息别丢，比格式完美更重要。</p>
</blockquote>
<h2 data-id="heading-17">总结</h2>
<p>这不是一个“补全功能优化”的故事，这是一个架构边界判断问题：</p>
<ul>
<li>规则系统适合确定性边界</li>
<li>语义系统适合模糊边界</li>
</ul>
<p>当你发现：</p>
<ul>
<li>规则在不断打补丁</li>
<li>误判越来越多</li>
<li>例外规则越来越复杂</li>
</ul>
<p>那很可能 —— <strong>你在用规则解决语义问题</strong>。</p>
<p>很多人做 Agent，沉迷 Prompt。但真正重要的不是 Prompt 写多长。而是学会判断：</p>
<blockquote>
<p>什么时候该用规则；<br/>
什么时候该交给语义（LLM 意图识别）。</p>
</blockquote>
<p>如果你也在做 Agent，你现在的系统，是规则在膨胀？还是语义在进化？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccb41d45c44842c28dc48967f9b71cef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2FpbGluZw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771407403&amp;x-signature=TAvkg%2FXN2BNh4fwnqmCR6Nls4SY%3D" alt="WX20230928-110017@2x.png" loading="lazy"/></p>
<p><strong>note：</strong> 我最近一直在做 <strong>前端转全栈</strong>、<strong>前端转 AI Agent</strong> 开发方向的工作，后续我会持续分享这两方面的文章。欢迎大家随时来交流～～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[先建“语义基座”，再谈运维智能！阿里云以 Operation Intelligence 定义 AIOps 新范式]]></title>    <link>https://juejin.cn/post/7605150769009492011</link>    <guid>https://juejin.cn/post/7605150769009492011</guid>    <pubDate>2026-02-11T09:46:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605150769009492011" data-draft-id="7605140481488977961" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="先建“语义基座”，再谈运维智能！阿里云以 Operation Intelligence 定义 AIOps 新范式"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2026-02-11T09:46:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            先建“语义基座”，再谈运维智能！阿里云以 Operation Intelligence 定义 AIOps 新范式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:46:34.000Z" title="Wed Feb 11 2026 09:46:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：鸢玮</p>
<p>大模型的出现，给许多行业带来了颠覆性的改变，运维这个向来被视为稳定、保守的领域也不例外。虽然“AIOps”这个概念早在 2016 年由 Gartner 提出，但早期的智能运维更多是利用大数据和机器学习对传统运维流程进行效率上的提升。十年后的今天，大模型的强大能力，正推动着 AIOps 从辅助工具，演进为数智化转型中不可或缺的核心基础设施，让运维真正迈入智能化的深水区。</p>
<p><strong>阿里云云原生应用平台事业部总经理、资深技术专家周琦</strong>作为这一变革的深度参与者，对 AIOps 的本质有着深刻洞察。“AIOps 这个词已经被广泛使用，但我更倾向于用 Operation Intelligence 来定义它。”周琦在采访中强调，“它的核心是发现与沉淀运维操作中的智慧，让工程师从重复繁琐的劳动中解放出来，聚焦于更高价值的创造。”</p>
<h2 data-id="heading-0">十年演进，重塑 AIOps 底层逻辑</h2>
<p>在传统的运维时代，更多依赖人工被动处理故障，效率低下；而后进入到自动化运维时代，借助工具实现任务自动化，缩短了故障恢复时间；到了小模型运维时代，通过机器学习实现异常检测与根因分析，运维也初步具备智能化特征；如今进入到大模型时代，运维才真正开始走向真正的智能化。</p>
<p>回顾 AIOps 过去十年的发展，周琦认为有两个关键转折点重塑了其底层逻辑。<strong>第一个转折点是通用大模型的到来。</strong> 在此之前，所谓的智能运维更多是通过垂类 AI 模型来解决告警治理、异常检测等单一、点状的问题。这种方式虽然有用，但难以规模化。大模型的通用特性，像是一个巨大的杠杆，将 AIOps 的能力从“点状解决”扩展到“面状全域覆盖”，凭借其强大的泛化能力可以应对千变万化的碎片化运维任务。</p>
<p><strong>第二个转折点则在于数据整合技术的突破。</strong> 过去，运维工作呈现高度碎片化特征，数据和引擎往往由不同供应商提供，形成了天然的数据孤岛。周琦表示，想要建设统一的 AIOps 体系，首先就要跨过这道鸿沟。如今，存储、计算与分析技术的进步，实现了异构数据的关联与串联，将分散在各个系统中的数据整合在一起，为全域智能运维奠定了坚实基础。</p>
<p>技术的演进也推动了企业对 AIOps 认知的转变。周琦观察到，早期，企业引入 AIOps 的核心诉求只是保障系统的稳定性，关注的焦点集中在故障修复、告警处理等基础功能方面。但现在，企业的需求维度大大拓宽了，安全性、可扩展性、延时、用户体验等这些过去容易被忽略的“隐性成本”，正受到前所未有的关注。这种认知的升级带来需求的延伸，AIOps 不再仅是运维工程师的工具，还需要满足企业管理者对系统成熟度、跨模块依赖关系等深层因素的考量，真正覆盖多角色、多维度的运营需求。<strong>真正的 AIOps，不是让人去适应工具，而是让工具主动理解人、服务人、成就人。</strong></p>
<h2 data-id="heading-1">能力跃迁，让系统“能感知、会思考、可行动”</h2>
<p>大模型时代的到来，让 AIOps 具备了前所未有的智能化能力。那么，大模型究竟为运维领域带来了哪些质变？周琦用一个生动的比喻来解释，给 AI 装上“摄像头”。传统运维在很大程度上依赖于工程师的个体经验，一位经验丰富的老师傅心中通常有一张无形的系统拓扑图，知道哪里容易出问题、该如何分析。但这种宝贵的经验附着于个体，难以沉淀、复制和规模化。大模型的出现，结合阿里云构建的实时数据采集与分析引擎，相当于为 AI 赋予了感知能力，使其能够真正能“看懂”系统、“理解”故障、“思考”方案。</p>
<p>这带来了运维能力的根本性跃迁。机器不再是机械地匹配预设规则、触发阈值告警，而是开始能够“读懂”告警信息背后的语义，“理解”系统当前真实的运行状态，甚至能“归纳”历史故障的复杂模式，并主动生成可供执行的修复建议。为此，<strong>阿里云提出 Operation Intelligence 理念</strong>，把人的经验变成系统的智慧，把个体的直觉转化为组织的资产，让系统具备“类人决策”能力，周琦将阿里云践行的 Operation Intelligence 理念概括为三个层面的能力进化。</p>
<ul>
<li><strong>在感知层面</strong>，目标是突破传统监控中常见的“数据孤岛”，构建从终端设备到业务流程的全链路感知网络。</li>
<li><strong>在认知层面</strong>，关键在于融合大模型的通用理解能力与专用领域算法，将海量、原始的观测数据转化为可解释、可推理的系统关系图谱。</li>
<li>最终，<strong>在行动层面</strong>，通过模型与算法的协同驱动，实现自动化的处置闭环，推动运维从“人工救火”向“系统自愈”转变，通过高效的人机协同大幅提升整体运营效能。</li>
</ul>
<p>当然，大模型并非万能，针对大模型“幻觉”问题，阿里云设计了一套双重保障机制。周琦介绍说，在技术层面，通过强化多源数据的交叉验证，将数据采集、清洗、预处理等基础但繁重的工作交由传统工具完成，让大模型聚焦在最核心的推理环节，从源头减少幻觉产生的可能性。在应用层面，系统支持企业外挂自身的私有知识库，利用行业或企业特有的领域知识来补充和修正通用大模型可能存在的认知盲区，确保建议的准确性与合规性。</p>
<h2 data-id="heading-2">构建智能运维新范式，解放人力聚焦高价值</h2>
<p>理想与现实之间总是存在挑战。周琦坦言，阿里云在自身的大规模实践中深刻体会到两大核心难题。其一是数据层面的挑战，包括异构系统形成的数据孤岛、数据洪流带来的存储与算力压力。其二是认知层面的挑战，不同团队、不同系统之间存在的“语义鸿沟”，以及对系统拓扑、故障根因逻辑链的理解不一致问题。</p>
<p>为了系统性地解决这些问题，<strong>阿里云将内部的实践经验产品化，形成了一套帮助企业在大模型时代构建智能运维新范式，并且在可观测产品中落地。</strong></p>
<p>这套架构分为三层，底层是以<strong>日志服务 SLS</strong> 为核心引擎构建的统一可观测数据平台，实现日志、指标、链路、事件等多类型数据的统一接入与存储。该引擎具备 EB 级存储规模和秒级千亿行查询能力，能轻松应对每天数百 PB 数据，在保障数据完整性的同时，综合成本较自建方案降低 50% 以上。更重要的是，它支持全栈、实时、无侵入的数据接入，覆盖从移动端到基础设施的 200 多种组件，让企业无需重构现有系统即可完成数据整合。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b4f8f40c5d24957a6bed5a4c053d657~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771407994&amp;x-signature=ENYmfx9XmrCN%2FpMxITFKECxtALs%3D" alt="图片" loading="lazy"/></p>
<p>中层通过 <strong>UModel 统一模型</strong>构建 IT 系统的 “数字孪生”，这是阿里云可观测性产品的核心建模框架。UModel 基于本体论，提供了一套观测实体及实体关系的定义，覆盖从用户体验、应用服务、容器到底层基础设施的每一层表征。UModel 就像给整个 IT 系统建立一套通用语言词典，让应用、容器、网络等不同组件能用同一套语义对话，彻底告别“你说你的指标，我说我的日志”的沟通困境。周琦表示，这套标准化建模彻底消除了语义歧义，让不同部门、不同系统之间的协作更高效，也让运维人员的经验得以沉淀为可复用的组织资产，而非随人员流动流失。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b785d2f281d40e5abf36eba597ea514~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771407994&amp;x-signature=5vLJirqGJBHxf6xqxmFBgpaBwG0%3D" alt="图片" loading="lazy"/></p>
<p>上层则是以 AI Agent 为智能核心，实现“工具适应人”的新范式。Agent 采用自然语言交互方式，支持全场景上下文感知，用户可在任意界面随时召唤，直接通过自然语言提问，无需掌握复杂的查询指令。AIOps Agent 基于阿里云可观测平台的多源数据采集、存储、分析能力，采用“统一数据平台 + UModel + 传统算法 + 生成式 AI”的混合处理架构，能够自主规划、调用工具、执行分析并反思优化，可以提供从自然语言交互到自动化巡检的全流程运维辅助能力，解决各类开放和未知的运维难题，将运维人员从重复的查询、分析工作中解放出来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c4c5918d5554617b9137a8fcabd1731~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771407994&amp;x-signature=ir1U1ioZyER6pxyCbV5SzafwFw0%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p><strong>周琦形象地说，</strong> “希望运维未来可以高度自动化，让 AIOps 把那些又脏又累的活儿做了。”这意味着，企业客户无需再投入大量宝贵的人力资源去完成数据采集、清洗、对齐等基础且繁琐的工程工作，阿里云的平台已经将这些“隐形工程”承担下来。</p>
</blockquote>
<p>如今，阿里云 AIOps Agent 已在 6000 多家企业落地，帮助大型企业客户实现故障 MTTR 从小时级降至小于 15 分钟。</p>
<p>对于企业而言，部署 AIOps 的终极价值远不止于减轻运维团队的负担，而是它能释放出宝贵的研发与创新资源，让技术人才能够专注于业务价值创造。同时，它也能帮助企业系统性地管理那些以往容易被忽视的隐性成本与合规风险，从长远角度优化 IT 投资的整体回报。</p>
<h2 data-id="heading-3">开源引领生态共建，推动“技术平权”愿景</h2>
<p>阿里云深知，“语义基座”的价值在于普及，而开源与生态建设是实现“技术平权”的关键，更能让全行业运维人员共同成长。为此，阿里云在开源布局、标准建设和生态协同上持续发力，推动 AIOps 行业整体进步。</p>
<p><strong>在开源布局方面</strong>，阿里云计划将 UModel 统一语义语言开源至社区，并向 OpenTelemetry 社区贡献了探针、采集器等核心工具。这些工具已被滴滴等公司开发人员广泛采用，大幅降低了行业重复开发成本。其中，无侵入探针的代码已开源在 GitHub 上，经过众多企业实战验证，在安全性和稳定性上备受认可，让中小企业无需自行研发即可获得高质量的数据采集能力。</p>
<p><strong>在标准建设方面</strong>，阿里云正在构建 AIOps 成熟度 Benchmark 榜单，构建了从数据分析到复杂异常检测的分级标准，涵盖基础任务处理、异常发现、根因分析、隐形问题挖掘、自主修复等不同阶段，让企业能够清晰评估自身能力水平，找到明确的进阶路径。周琦表示，希望可以和业界一起共创，攻克智能运维领域的难题，推动 AIOps 标准落地，促进整个可观测性领域的快速发展。</p>
<p><strong>在生态协同方面</strong>，阿里云通过大赛联动高校、企业，将工业界高频问题转化为赛题，促进产学研深度融合。通过大赛的方式，阿里云将标准 Benchmark 和真实场景赛题提供给参赛者，让高校学生、企业开发者都能在实战中提升能力，同时为行业贡献创新方案。</p>
<p>周琦表示，阿里云通过开放共建的模式，打破技术壁垒，让不同规模、不同行业的企业都可以落地 AIOps，实现“技术平权”，让中小企业也能调用顶级“隐形工程师团队”，让每个运维人员都能借助智能工具发挥更大价值，向“智能运营专家”演进。</p>
<h2 data-id="heading-4">未来趋势：自主 Agent 协同，运维能力重构</h2>
<p>展望未来，周琦从不同时间维度来做出判断。短期来看，低风险任务将实现全自动化闭环，如 IP 封禁、简单扩容等操作可由 AI 自主完成，而重要操作仍保留人机协同决策模式，确保系统安全。同时，多角色 Agent 协同雏形将逐步显现，运维、安全、成本控制等不同领域的 Agent 将共享统一数据视图，提升跨域运营效率。</p>
<p>中长期来看，AIOps 将与 AI Coding、测试等环节深度打通，最终形成开发、测试到运维的全生命周期智能闭环。周琦解释道，AI Coding 目前在开发态做的非常有效，但从一个演示应用到企业级系统，部署后能稳定运行，还需要很长时间。“我们希望能够将 AI Coding 和 AIOps 串联，实现全局优化。让应用系统不光能跑起来，还能跑得更好、更稳，把运行态的状况实时反馈给 AI Coding。”</p>
<p>技术的演进必然带来运维人员角色与能力的重构。周琦表示，过去，运维人员是“救火队员”，整天忙于处理各类故障；未来，他们将转变为“系统教练”，而他们的核心能力不再是重复的操作经验，而是架构设计、业务理解、多维度决策等高阶能力。未来的运维人员需要平衡安全、成本、合规、可扩展性等多重诉求，专注于系统长期价值的优化。</p>
<h2 data-id="heading-5">结语</h2>
<p>在阿里云可观测团队的定义中，智能运维是一场深刻的范式转移。它以大模型为驱动，基于统一的数据平台与领域知识模型，实现了从“人适应工具”到“将人类创造力注入系统智能之中”的本质转变，最终构建起数据、认知与行动闭环融合的智能体系。</p>
<p>纵观这场由 Operation Intelligence 引领的变革，其核心在于将运维智慧从依赖个人的隐性经验，沉淀为可复制、可迭代的组织数字资产，推动工程师从重复劳作中解放，实现价值的创造性升维。</p>
<p>阿里云始终致力于通过自身实践与生态共建，让任何规模的企业都能获得顶级“隐形工程师”团队的支持，在数智化浪潮中聚焦核心创造，实现个人与企业的共同成长。</p>
<p>正如周琦所言，“未来的运维竞争，将不再是工具的竞争，而是人的创造力与战略眼光的竞争”。当统一语言打通系统与智能的鸿沟，技术真正服务于人的价值释放，这场变革便不止于运维效率的提升，更将成为企业创新加速、行业持续进步的核心动力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析Kratos服务注册：从框架入口到Consul落地实现]]></title>    <link>https://juejin.cn/post/7605326543686975497</link>    <guid>https://juejin.cn/post/7605326543686975497</guid>    <pubDate>2026-02-11T09:35:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605326543686975497" data-draft-id="7605213691910799386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析Kratos服务注册：从框架入口到Consul落地实现"/> <meta itemprop="keywords" content="Go,后端"/> <meta itemprop="datePublished" content="2026-02-11T09:35:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="下次一定x"/> <meta itemprop="url" content="https://juejin.cn/user/3722294009017404"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析Kratos服务注册：从框架入口到Consul落地实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3722294009017404/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    下次一定x
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:35:17.000Z" title="Wed Feb 11 2026 09:35:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在微服务架构中，服务注册是实现服务发现、负载均衡的基础前提，其稳定性直接决定了整个微服务集群的可用性。<code>Kratos</code> 作为开源的高性能微服务框架，其服务注册机制遵循“简洁、解耦、可扩展”的设计理念，深度融合框架自身的函数选项模式，形成了一套从入口初始化到注册中心落地的完整闭环。要彻底理解 <code>Kratos</code> 的服务注册逻辑，我们需从框架入口出发，逐层拆解App实例初始化、服务实例构建、注册接口实现到 <code>Consul</code> 具体落地的每一个核心环节，下文将结合源码逐点剖析，帮你吃透 <code>Kratos</code> 服务注册的底层逻辑（函数选项模式我之前的文章已详细讲解，本文不再赘述）。</p>
<h2 data-id="heading-1">App结构体：服务注册的核心载体</h2>
<p><code>Kratos</code> 的服务注册逻辑并非孤立存在，而是围绕App实例展开，<code>App</code> 作为主程序返回的核心实例，封装了服务注册所需的全部配置、上下文、互斥锁及服务实例信息，是串联整个注册流程的“中枢”。其核心设计思路是将配置逻辑与目标结构体解耦，通过内嵌<code>options</code>结构体存放所有注册相关配置，同时通过<code>instance</code>字段存储注册到注册中心的服务实例，为后续注册操作提供数据支撑。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 主程序返回的实例</span>
<span class="hljs-keyword">type</span> App <span class="hljs-keyword">struct</span> {
	opts     options   <span class="hljs-comment">// 这里的 options 是一个结构体 用于存放配置 本质上是让配置逻辑与目标结构体解耦</span>
	ctx      context.Context
	cancel   context.CancelFunc <span class="hljs-comment">// 上下文取消函数</span>
	mu       sync.Mutex       <span class="hljs-comment">// 互斥锁保护 instance 的并发读写</span>
	instance *registry.ServiceInstance <span class="hljs-comment">// 重要 注册到注册中心的服务实例信息 是 kratos 自己定义的 方便自己使用</span>
}

<span class="hljs-comment">// 创建 App 实例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">(opts ...Option)</span></span> *App {
    <span class="hljs-comment">// 默认值</span>
	o := options{
		ctx:              context.Background(),
		sigs:             []os.Signal{syscall.SIGTERM, syscall.SIGQUIT, syscall.SIGINT}, <span class="hljs-comment">// 优雅退出</span>
		registrarTimeout: <span class="hljs-number">10</span> * time.Second,  <span class="hljs-comment">// 注册超时时间</span>
	}
    <span class="hljs-comment">// 生成 唯一 ID 比如注册到 Consul 上的唯一 ID</span>
	<span class="hljs-keyword">if</span> id, err := uuid.NewUUID(); err == <span class="hljs-literal">nil</span> {
		o.id = id.String()
	}
    <span class="hljs-comment">// 我们用户 调用 New 函数 自己加的配置 可覆盖默认值 提高灵活性</span>
	<span class="hljs-keyword">for</span> _, opt := <span class="hljs-keyword">range</span> opts {
		opt(&amp;o)
	}
    <span class="hljs-comment">// 用户是否传入自己的 log 传了就使用用户的 log</span>
	<span class="hljs-keyword">if</span> o.logger != <span class="hljs-literal">nil</span> {
		log.SetLogger(o.logger)
	}
    <span class="hljs-comment">// 全局 cancel </span>
	ctx, cancel := context.WithCancel(o.ctx)
    
    <span class="hljs-comment">// 返回 主程序的实例</span>
	<span class="hljs-keyword">return</span> &amp;App{
		ctx:    ctx,
		cancel: cancel,
		opts:   o,
	}
}

</code></pre>
<h3 data-id="heading-2"><code>Run()</code> 函数</h3>
<p><code>Run</code> 函数是 <code>Kratos</code> 主程序的入口，也是服务注册逻辑的核心执行环节。该函数串联起“服务实例构建、前置钩子执行、服务启动、服务注册、信号监听、优雅退出”的全流程，其中服务注册是该函数的核心步骤之一，在所有服务（<code>HTTP</code> / <code>gRPC</code> 等）启动完成后，通过调用注册中心的 <code>Register</code> 方法，将服务实例注册到指定注册中心。同时，该函数通过 <code>errgroup</code> 管理协程、<code>sync.WaitGroup</code> 保证服务启动顺序、上下文控制优雅退出，全方位保障服务注册的稳定性和可靠性。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *App)</span></span> Run() <span class="hljs-type">error</span> {
	<span class="hljs-comment">// 构建服务注册实例 后续有代码讲解</span>
	instance, err := a.buildInstance()
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err
	}
	a.mu.Lock()
	a.instance = instance <span class="hljs-comment">// 保存实例信息  供后续使用</span>
	a.mu.Unlock()

	<span class="hljs-comment">/* 
	函数内容是 context.WithValue(ctx, appKey{}, a)
	本质上让应用的任意层级代码都能获取 App 的核心信息，而不需要显式传递 App 实例。
	如果显式的去传 App 实例的话，每个函数的形参都要多一个，导致参数膨胀
	*/</span>
	sctx := NewContext(a.ctx, a) <span class="hljs-comment">// 将 app 例存入上下文</span>

	<span class="hljs-comment">// 初始化 errgroup 我之前文章介绍过</span>
	eg, ctx := errgroup.WithContext(sctx) 
	wg := sync.WaitGroup{} <span class="hljs-comment">//这个就为了应对 没有 goroutine 给到 servers 一直阻塞 但主程序一直向下走是不行的</span>

	<span class="hljs-comment">// 执行启动前置钩子   比如说 数据库的初始化，redis 的初始化等 用户传入</span>
	<span class="hljs-keyword">for</span> _, fn := <span class="hljs-keyword">range</span> a.opts.beforeStart {
		<span class="hljs-keyword">if</span> err = fn(sctx); err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> err <span class="hljs-comment">// 钩子执行失败，直接退出 比如数据库的初始化都失败了 程序没必要执行</span>
		}
	}

	<span class="hljs-comment">// 启动所有服务  HTTP / gRPC 等 </span>
	octx := NewContext(a.opts.ctx, a)  <span class="hljs-comment">// 这里要分开 App 生命周期上下文 和 Server 生命周期上下文</span>
	<span class="hljs-keyword">for</span> _, srv := <span class="hljs-keyword">range</span> a.opts.servers {
		server := srv <span class="hljs-comment">// 循环变量捕获问题 避免 goroutine 中使用同一个变量</span>
        
		<span class="hljs-comment">// 子goroutine 监听停止信号，优雅停止服务</span>
		eg.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
			&lt;-ctx.Done() <span class="hljs-comment">// 等待停止信号</span>
			<span class="hljs-comment">// 构建停止上下文</span>
			stopCtx := context.WithoutCancel(octx)
			<span class="hljs-comment">// 设置停止超时时间 防止服务卡死</span>
			<span class="hljs-keyword">if</span> a.opts.stopTimeout &gt; <span class="hljs-number">0</span> {
				<span class="hljs-keyword">var</span> cancel context.CancelFunc
				stopCtx, cancel = context.WithTimeout(stopCtx, a.opts.stopTimeout)
				<span class="hljs-keyword">defer</span> cancel() <span class="hljs-comment">// 确保超时后释放资源</span>
			}
			<span class="hljs-keyword">return</span> server.Stop(stopCtx) <span class="hljs-comment">// 停止当前服务</span>
		})

		<span class="hljs-comment">// 子 goroutine 启动当前服务</span>
		wg.Add(<span class="hljs-number">1</span>)
		eg.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
			wg.Done() <span class="hljs-comment">// 标记启动逻辑已开始 防止 goroutine 阻塞 然后程序向下执行</span>
			<span class="hljs-keyword">return</span> server.Start(octx) <span class="hljs-comment">// 启动服务</span>
		})
	}
	wg.Wait() <span class="hljs-comment">// 等待所有服务的启动 goroutine 开始执行</span>
	
	<span class="hljs-comment">// 重点 注册服务到注册中心</span>
	<span class="hljs-keyword">if</span> a.opts.registrar != <span class="hljs-literal">nil</span> {
		<span class="hljs-comment">// 注册超时控制</span>
		rctx, rcancel := context.WithTimeout(ctx, a.opts.registrarTimeout)
		<span class="hljs-keyword">defer</span> rcancel()
        <span class="hljs-comment">// 重要函数 后续讲解</span>
		<span class="hljs-keyword">if</span> err = a.opts.registrar.Register(rctx, instance); err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> err <span class="hljs-comment">// 注册失败，直接退出</span>
		}
	}

	<span class="hljs-comment">// 执行启动后置钩子 比如缓存预热等</span>
	<span class="hljs-keyword">for</span> _, fn := <span class="hljs-keyword">range</span> a.opts.afterStart {
		<span class="hljs-keyword">if</span> err = fn(sctx); err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> err
		}
	}

	<span class="hljs-comment">// 监听系统信号，处理优雅退出</span>
	c := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> os.Signal, <span class="hljs-number">1</span>)
	signal.Notify(c, a.opts.sigs...) <span class="hljs-comment">// 监听指定的系统信号</span>
	eg.Go(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">error</span> {
		<span class="hljs-keyword">select</span> {
		<span class="hljs-keyword">case</span> &lt;-ctx.Done(): <span class="hljs-comment">// 其他 goroutine 出错，ctx 被取消</span>
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
		<span class="hljs-keyword">case</span> &lt;-c: 			  <span class="hljs-comment">// 收到系统停止信号 </span>
			<span class="hljs-keyword">return</span> a.Stop() 	<span class="hljs-comment">// 触发应用停止流程</span>
		}
	})

	<span class="hljs-comment">// 等待所有 goroutine 执行完成</span>
	<span class="hljs-keyword">if</span> err = eg.Wait(); err != <span class="hljs-literal">nil</span> &amp;&amp; !errors.Is(err, context.Canceled) {
		<span class="hljs-keyword">return</span> err 
	}

	<span class="hljs-comment">// 执行停止后置钩子  清理服务运行过程中占用的资源</span>
	err = <span class="hljs-literal">nil</span>
	<span class="hljs-keyword">for</span> _, fn := <span class="hljs-keyword">range</span> a.opts.afterStop {
		err = fn(sctx) 		<span class="hljs-comment">// 即使一个钩子出错，也执行完所有钩子</span>
	}
	<span class="hljs-keyword">return</span> err
}
</code></pre>
<h3 data-id="heading-3"><code> buildInstance()</code> 函数</h3>
<p><code>buildInstance</code> 函数是 <code>kratos</code> 框架中<strong>服务注册到注册中心的核心数据构造函数</strong>，它的唯一目的是构建 <code>registry.ServiceInstance</code> 实例 注册中心识别服务的身份凭证，核心逻辑是优先使用用户显式配置的端点，无显式配置则从服务实例自动提取，保证服务注册信息的准确性和灵活性。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(a *App)</span></span> buildInstance() (*registry.ServiceInstance, <span class="hljs-type">error</span>) {

    <span class="hljs-comment">// 预分配容量：len(a.opts.endpoints)，减少切片扩容的内存开销</span>
    endpoints := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(a.opts.endpoints))
    <span class="hljs-comment">// 遍历用户显式配置的 endpoints，转为字符串格式</span>
    <span class="hljs-keyword">for</span> _, e := <span class="hljs-keyword">range</span> a.opts.endpoints {
        endpoints = <span class="hljs-built_in">append</span>(endpoints, e.String())
    }

    <span class="hljs-comment">// 如果用户未显式配置 endpoints，从 servers 自动提取</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(endpoints) == <span class="hljs-number">0</span> {
        <span class="hljs-comment">// 遍历所有已注册的 Server（HTTP/gRPC 等）</span>
        <span class="hljs-keyword">for</span> _, srv := <span class="hljs-keyword">range</span> a.opts.servers {
            <span class="hljs-comment">// 接口断言：判断当前 Server 是否实现了 Endpointer 接口  kratos 内置 Server 都实现了</span>
            <span class="hljs-keyword">if</span> r, ok := srv.(transport.Endpointer); ok {
                <span class="hljs-comment">// 调用 Endpoint() 方法，获取该 Server 的端点信息（如 HTTP 服务的 8080 端口）</span>
                e, err := r.Endpoint()
                <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
                    <span class="hljs-comment">// 提取端点失败直接返回错误：注册中心必须有正确的端点，否则注册无意义</span>
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
                }
                <span class="hljs-comment">// 将端点转为标准字符串，加入切片</span>
                endpoints = <span class="hljs-built_in">append</span>(endpoints, e.String())
            }
      
        }
    }

    <span class="hljs-comment">// 构造并返回注册中心需要的 ServiceInstance</span>
    <span class="hljs-keyword">return</span> &amp;registry.ServiceInstance{
        ID:        a.opts.id,       <span class="hljs-comment">// 应用唯一 ID（UUID，New 函数中生成）</span>
        Name:      a.opts.name,     <span class="hljs-comment">// 服务名称（如 "order-service"）</span>
        Version:   a.opts.version,  <span class="hljs-comment">// 服务版本（如 "v1.0.0"）</span>
        Metadata:  a.opts.metadata, <span class="hljs-comment">// 服务元数据（如 env:prod、region:cn-beijing）</span>
        Endpoints: endpoints,       <span class="hljs-comment">// 核心：服务的访问端点</span>
    }, <span class="hljs-literal">nil</span>
}
</code></pre>
<h2 data-id="heading-4"><code>Kratos</code> 服务注册的接口设计与 <code>Consul</code> 实现</h2>
<p><code>Kratos</code> 采用“接口定义+具体实现”的设计模式，将服务注册的核心逻辑抽象为Registrar接口，屏蔽了不同注册中心（<code>Consul</code>、<code>Etcd</code> 、<code>Nacos</code> 等）的实现差异，实现了注册逻辑与注册中心解耦，让用户可以根据业务需求灵活切换注册中心。其中，<code>Consul</code> 作为主流的服务注册与发现工具，是<code>Kratos</code> 最常用的注册中心落地方案，<code>Kratos</code> 通过 <code>Registry</code> 结构体封装 <code>Consul</code> 客户端、健康检查配置、服务缓存等信息，实现了<code>Registrar</code> 接口的 <code>Register</code> 和 <code>Deregister</code> 方法，完成服务在 <code>Consul</code> 中的注册与注销。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 服务注册 </span>
<span class="hljs-keyword">type</span> Registrar <span class="hljs-keyword">interface</span> {

	Register(ctx context.Context, service *ServiceInstance) <span class="hljs-type">error</span>

	Deregister(ctx context.Context, service *ServiceInstance) <span class="hljs-type">error</span>
}

<span class="hljs-comment">// 服务发现</span>
<span class="hljs-keyword">type</span> Discovery <span class="hljs-keyword">interface</span> {
    
	GetService(ctx context.Context, serviceName <span class="hljs-type">string</span>) ([]*ServiceInstance, <span class="hljs-type">error</span>)
    
	Watch(ctx context.Context, serviceName <span class="hljs-type">string</span>) (Watcher, <span class="hljs-type">error</span>)
    
}
</code></pre>
<h3 data-id="heading-5">consul 实现细节</h3>
<p><code>Kratos</code> 通过New函数创建 <code>Consul</code> 的 <code>Registry</code> 实例，初始化 <code>Consul</code> 客户端、默认健康检查配置、服务缓存等信息，并支持用户通过函数选项模式覆盖默认配置，适配不同的 <code>Consul</code> 集群环境。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Registry <span class="hljs-keyword">struct</span> {
	cli               *Client   <span class="hljs-comment">// consul 客户端</span>
	enableHealthCheck <span class="hljs-type">bool</span>      <span class="hljs-comment">// 是否为注册的服务启用健康检查</span>
	registry          <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*serviceSet <span class="hljs-comment">// 服务注册缓存  key=服务名称，value=该服务的实例集合</span>
	lock              sync.RWMutex          <span class="hljs-comment">// 保护registry缓存的读写安全</span>
	timeout           time.Duration         <span class="hljs-comment">// 超时时间</span>
}
<span class="hljs-comment">// 用该函数去创建 kratos 声明接口的实现类 ( consul )</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">New</span><span class="hljs-params">(apiClient *api.Client, opts ...Option)</span></span> *Registry {
	<span class="hljs-comment">// 初始化Registry默认值</span>
	r := &amp;Registry{
		registry:          <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*serviceSet), <span class="hljs-comment">// 初始化服务缓存 map</span>
		enableHealthCheck: <span class="hljs-literal">true</span>,                         <span class="hljs-comment">// 默认开启健康检查</span>
		timeout:           <span class="hljs-number">10</span> * time.Second,             <span class="hljs-comment">// 默认超时10秒</span>
		<span class="hljs-comment">// 初始化内部的Consul Client</span>
		cli: &amp;Client{
			dc:                             SingleDatacenter, <span class="hljs-comment">// 默认单数据中心</span>
			cli:                            apiClient,        <span class="hljs-comment">// 外部传入的Consul原生API Client  解耦</span>
			resolver:                       defaultResolver,  <span class="hljs-comment">// 默认地址解析器（解析端点为Consul可识别的格式）</span>
			healthcheckInterval:            <span class="hljs-number">10</span>,               <span class="hljs-comment">// 默认健康检查间隔10秒</span>
			heartbeat:                      <span class="hljs-literal">true</span>,             <span class="hljs-comment">// 默认启用TTL心跳</span>
			deregisterCriticalServiceAfter: <span class="hljs-number">600</span>,              <span class="hljs-comment">// 异常后600秒  注销服务</span>
			cancelers:                      <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*canceler), <span class="hljs-comment">// goroutine 的取消器缓存</span>
		},
	}
	<span class="hljs-comment">//  应用用户自定义Option  覆盖默认配置</span>
	<span class="hljs-keyword">for</span> _, o := <span class="hljs-keyword">range</span> opts {
		o(r)
	}
	<span class="hljs-keyword">return</span> r
}

<span class="hljs-comment">// 重点  这个就是 Run() 函数中调用的 Register  前提是你要传入 Consul 的实例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Registry)</span></span> Register(ctx context.Context, svc *registry.ServiceInstance) <span class="hljs-type">error</span> {
	<span class="hljs-keyword">return</span> r.cli.Register(ctx, svc, r.enableHealthCheck)
}

<span class="hljs-comment">// 注销</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(r *Registry)</span></span> Deregister(ctx context.Context, svc *registry.ServiceInstance) <span class="hljs-type">error</span> {
	<span class="hljs-keyword">return</span> r.cli.Deregister(ctx, svc.ID)
}
</code></pre>
<h3 data-id="heading-6"><code>Register()</code> 函数</h3>
<p><code>Register</code> 函数是 <code>Consul</code> 注册的最终执行环节，也是整个服务注册流程的“最后一公里”。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Client)</span></span> Register(_ context.Context, svc *registry.ServiceInstance, enableHealthCheck <span class="hljs-type">bool</span>) <span class="hljs-type">error</span> {
    
	<span class="hljs-comment">// 地址格式转换  kratos → Consul  把 ServiceInstance 类型 变成 consul 需要的类型</span>
	addresses := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]api.ServiceAddress, <span class="hljs-built_in">len</span>(svc.Endpoints))
	<span class="hljs-comment">// checkAddresses：存储所有需要做健康检查的地址（host:port格式）</span>
	checkAddresses := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(svc.Endpoints))

	<span class="hljs-comment">// 遍历 kratos 服务实例的所有端点 比如 "http://127.0.0.1:8080", "grpc://127.0.0.1:9090"]</span>
	<span class="hljs-keyword">for</span> _, endpoint := <span class="hljs-keyword">range</span> svc.Endpoints { 
		<span class="hljs-comment">// 解析端点URL：把 "http://127.0.0.1:8080" 解析为 url.URL 对象 Scheme=http, Host=127.0.0.1:8080等</span>
		raw, err := url.Parse(endpoint) 
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> err <span class="hljs-comment">// 解析失败直接返回，注册流程终止</span>
		}
		<span class="hljs-comment">// 提取主机名</span>
		addr := raw.Hostname()         
		<span class="hljs-comment">// 提取端口并转换为uint16</span>
		port, _ := strconv.ParseUint(raw.Port(), <span class="hljs-number">10</span>, <span class="hljs-number">16</span>) 

		<span class="hljs-comment">// 拼接健康检查地址（格式：host:port，如127.0.0.1:8080），用于TCP健康检查</span>
		checkAddresses = <span class="hljs-built_in">append</span>(checkAddresses, net.JoinHostPort(addr, strconv.FormatUint(port, <span class="hljs-number">10</span>)))
		<span class="hljs-comment">// 填充 Addresses  它的key 当作 tag 用于筛选</span>
		addresses[raw.Scheme] = api.ServiceAddress{Address: endpoint, Port: <span class="hljs-type">int</span>(port)} 
	}

	<span class="hljs-comment">// 构造 Consul 核心注册对象 </span>
	asr := &amp;api.AgentServiceRegistration{
		ID:              svc.ID,               <span class="hljs-comment">// 服务唯一ID  kratos生成的UUID</span>
		Name:            svc.Name,             <span class="hljs-comment">// 服务名称	如"order-service"，Consul按名称分组服务</span>
		Meta:            svc.Metadata,         <span class="hljs-comment">// 服务元数据</span>
		Tags:            []<span class="hljs-type">string</span>{fmt.Sprintf(<span class="hljs-string">"version=%s"</span>, svc.Version)}, 
		TaggedAddresses: addresses,            <span class="hljs-comment">//   标签化地址</span>
	}

	<span class="hljs-comment">// 设置Consul UI展示的基础地址 拿第一个</span>
	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(checkAddresses) &gt; <span class="hljs-number">0</span> {
		<span class="hljs-comment">// 拆分host和port（如127.0.0.1:8080 → host=127.0.0.1, portRaw=8080）</span>
		host, portRaw, _ := net.SplitHostPort(checkAddresses[<span class="hljs-number">0</span>])
		port, _ := strconv.ParseInt(portRaw, <span class="hljs-number">10</span>, <span class="hljs-number">32</span>)
		asr.Address = host <span class="hljs-comment">// 主地址</span>
		asr.Port = <span class="hljs-type">int</span>(port) <span class="hljs-comment">// 主端口</span>
	}

	<span class="hljs-comment">// 配置Consul健康检查</span>
	<span class="hljs-keyword">if</span> enableHealthCheck {
		<span class="hljs-comment">// TCP 健康检查 检测端口是否存活</span>
		<span class="hljs-keyword">for</span> _, address := <span class="hljs-keyword">range</span> checkAddresses {
			asr.Checks = <span class="hljs-built_in">append</span>(asr.Checks, &amp;api.AgentServiceCheck{
				TCP:                            address, <span class="hljs-comment">//  检查地址</span>
				Interval:                       fmt.Sprintf(<span class="hljs-string">"%ds"</span>, c.healthcheckInterval), <span class="hljs-comment">// 检查间隔</span>
                <span class="hljs-comment">// 异常后多久注销</span>
				DeregisterCriticalServiceAfter: fmt.Sprintf(<span class="hljs-string">"%ds"</span>, c.deregisterCriticalServiceAfter), 
				Timeout:                        <span class="hljs-string">"5s"</span>, <span class="hljs-comment">// 超时时间</span>
			})
		}
	}
    
	<span class="hljs-keyword">if</span> c.heartbeat {
		<span class="hljs-comment">// 上报健康状态</span>
		asr.Checks = <span class="hljs-built_in">append</span>(asr.Checks, &amp;api.AgentServiceCheck{
			CheckID:                        <span class="hljs-string">"service:"</span> + svc.ID,  <span class="hljs-comment">// 检查唯一 ID</span>
			<span class="hljs-comment">// TTL 设为检查间隔的2倍：给网络抖动留缓冲，避免一次调度延迟就误判服务异常</span>
			TTL:                            fmt.Sprintf(<span class="hljs-string">"%ds"</span>, c.healthcheckInterval*<span class="hljs-number">2</span>), 
			DeregisterCriticalServiceAfter: fmt.Sprintf(<span class="hljs-string">"%ds"</span>, c.deregisterCriticalServiceAfter),
		})
	}
    
	<span class="hljs-comment">// 追加用户自定义检查</span>
	asr.Checks = <span class="hljs-built_in">append</span>(asr.Checks, c.serviceChecks...)

	<span class="hljs-comment">// 调用 Consul API 完成服务注册 </span>
	err := c.cli.Agent().ServiceRegister(asr)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-keyword">return</span> err <span class="hljs-comment">// 注册失败直接返回</span>
	}

	<span class="hljs-comment">// 启动 goroutine 主动上报健康状态</span>
	<span class="hljs-keyword">if</span> c.heartbeat {
		<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
			<span class="hljs-comment">// 延迟1秒：避免 Consul 还没完成注册，就更新 TTL 导致失败</span>
			time.Sleep(time.Second) 
			<span class="hljs-comment">// 首次更新 TTL 为 "pass"</span>
			err = c.cli.Agent().UpdateTTL(<span class="hljs-string">"service:"</span>+svc.ID, <span class="hljs-string">"pass"</span>, <span class="hljs-string">"pass"</span>)
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
				log.Errorf(<span class="hljs-string">"[Consul]update ttl heartbeat to consul failed!err:=%v"</span>, err)
			}
			<span class="hljs-comment">// 创建定时器   每隔 healthcheckInterval 秒更新一次 TTL</span>
			ticker := time.NewTicker(time.Second * time.Duration(c.healthcheckInterval))
			<span class="hljs-keyword">defer</span> ticker.Stop() 	<span class="hljs-comment">// goroutine 退出时停止定时器（避免内存泄漏）</span>
			<span class="hljs-keyword">for</span> {
				<span class="hljs-keyword">select</span> {
				<span class="hljs-keyword">case</span> &lt;-ticker.C: 		<span class="hljs-comment">// 定时触发TTL更新</span>
					err = c.cli.Agent().UpdateTTL(<span class="hljs-string">"service:"</span>+svc.ID, <span class="hljs-string">"pass"</span>, <span class="hljs-string">"pass"</span>)
					<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
						log.Errorf(<span class="hljs-string">"[Consul]update ttl heartbeat to consul failed!err:=%v"</span>, err)
					}
				<span class="hljs-keyword">case</span> &lt;-c.ctx.Done(): 		<span class="hljs-comment">// 上下文取消 </span>
					<span class="hljs-keyword">return</span> 			<span class="hljs-comment">// 退出 goroutine，停止心跳</span>
				}
			}
		}()
	}
	<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<h2 data-id="heading-7">总结</h2>
<p>综上，<code>kratos</code>的服务注册机制是一套入口统一、配置灵活、接口解耦、落地可靠的完整体系，其核心流程可概括为：通过 <code>New</code> 函数初始化App实例及注册配置，然后通过 <code>Run</code> 函数启动服务并触发注册逻辑，再通过 <code>buildInstance</code> 函数构建服务实例身份凭证，之后再通过 <code>Registrar</code> 接口调用 <code>Consul</code> 实现类，最后通过 <code>Register</code> 函数完成格式转换、健康配置及最终注册，形成从初始化到落地的全闭环。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析Spring Boot中的@ConfigurationProperties注解]]></title>    <link>https://juejin.cn/post/7605140481489190953</link>    <guid>https://juejin.cn/post/7605140481489190953</guid>    <pubDate>2026-02-11T09:38:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605140481489190953" data-draft-id="7605174711182327871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析Spring Boot中的@ConfigurationProperties注解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T09:38:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="java进阶之路2023"/> <meta itemprop="url" content="https://juejin.cn/user/954805959001486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析Spring Boot中的@ConfigurationProperties注解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/954805959001486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    java进阶之路2023
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:38:39.000Z" title="Wed Feb 11 2026 09:38:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0">深入解析Spring Boot中的@ConfigurationProperties注解</h5>
<p>在Spring Boot框架中，配置管理是一个核心功能。Spring Boot提供了多种方式来处理外部配置，其中<code>@ConfigurationProperties</code>注解是一个非常强大且灵活的工具。本文将深入探讨<code>@ConfigurationProperties</code>注解的概念、用法、工作原理、配置绑定、类型安全以及如何在实际开发中应用它。</p>
<h6 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>什么是@ConfigurationProperties？</h6>
<p><code>@ConfigurationProperties</code>是Spring Boot提供的一个注解，用于将外部配置属性绑定到Java对象上。通过使用这个注解，开发者可以将配置文件（如<code>application.properties</code>或<code>application.yml</code>）中的属性值自动映射到Java类的字段上，从而实现配置的集中管理和类型安全。</p>
<h6 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>@ConfigurationProperties的作用</h6>
<ol>
<li><strong>配置绑定</strong>：将配置文件中的属性值绑定到Java类的字段上，实现配置的自动映射。</li>
<li><strong>类型安全</strong>：提供类型安全的配置绑定，避免类型转换错误。</li>
<li><strong>复杂配置</strong>：支持复杂配置结构的绑定，如嵌套对象、集合、Map等。</li>
<li><strong>配置校验</strong>：结合<code>@Valid</code>注解，实现配置属性的校验。</li>
</ol>
<h6 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>@ConfigurationProperties的基本用法</h6>
<h6 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1. 定义配置类</h6>
<p>首先，定义一个Java类，用于绑定配置属性。使用<code>@ConfigurationProperties</code>注解标记该类，并指定前缀（prefix）。</p>
<p><strong>示例代码：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">yicrm</span>.<span class="hljs-property">biz</span>.<span class="hljs-property">config</span>;


<span class="hljs-keyword">import</span> lombok.<span class="hljs-property">Data</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">context</span>.<span class="hljs-property">properties</span>.<span class="hljs-property">ConfigurationProperties</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Component</span>;

<span class="hljs-comment">/**
 * &lt;p&gt;
 * uops-service配置
 * &lt;/p&gt;
 *
 * <span class="hljs-doctag">@author</span> <span class="hljs-variable">zhaozhijun</span>
 * <span class="hljs-doctag">@since</span> 2026-01-07
 */</span>

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"media-service"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaServiceConfig</span> {

    <span class="hljs-comment">//短视频路径</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> path;

    <span class="hljs-comment">//短视频路径-特殊租户</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> path2;

    <span class="hljs-comment">//直播路径</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> broadcastPath;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> broadcastPath2;
    <span class="hljs-comment">//token</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> token;

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> userId;

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> companyId;
}
</code></pre>
<p><strong>解释：</strong></p>
<ul>
<li><code>@ConfigurationProperties(prefix = "app")</code>：指定配置属性的前缀为<code>app</code>。</li>
<li><code>@Component</code>：将该类注册为Spring Bean，使其可以被Spring容器管理。</li>
</ul>
<h6 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 配置文件</h6>
<p>在<code>application.properties</code>或<code>application.yml</code>文件中定义配置属性。</p>
<p><strong>示例代码（application.properties）：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">media-service:</span>
  <span class="hljs-attr">path:</span> <span class="hljs-string">https://***.ai/media-service/internal/dataApi/video/getCompanyCoreMetrics</span>
  <span class="hljs-attr">token:</span> <span class="hljs-string">a5a6ae52b97f08e6847bbaf9bc054c13af797525</span>
  <span class="hljs-attr">userId:</span> <span class="hljs-number">3569</span>
  <span class="hljs-attr">companyId:</span> <span class="hljs-number">311</span>
</code></pre>
<h6 data-id="heading-6">3. 启用配置属性支持</h6>
<p>在Spring Boot应用的主类或配置类上，使用<code>@EnableConfigurationProperties</code>注解启用配置属性支持。</p>
<pre><code class="hljs language-arduino" lang="arduino">
package com.yicrm;

<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;
<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;

<span class="hljs-comment">/**
 * 启动程序
 */</span>
@<span class="hljs-built_in">SpringBootApplication</span>(exclude = {DataSourceAutoConfiguration.<span class="hljs-keyword">class</span>})
@<span class="hljs-built_in">EnableConfigurationProperties</span>(AppProperties.<span class="hljs-keyword">class</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">YiCrmApplication</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        <span class="hljs-comment">// System.setProperty("spring.devtools.restart.enabled", "false");</span>
        <span class="hljs-comment">// 关闭 PageHelper banner</span>
        System.<span class="hljs-built_in">setProperty</span>(<span class="hljs-string">"pagehelper.banner"</span>, <span class="hljs-string">"false"</span>);
<span class="hljs-comment">//        // 设置无头模式，避免在无图形界面的服务器环境中出现 X11FontManager 初始化错误</span>
<span class="hljs-comment">//        System.setProperty("java.awt.headless", "true");</span>
        SpringApplication.<span class="hljs-built_in">run</span>(YiCrmApplication.<span class="hljs-keyword">class</span>, args);
        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"(♥◠‿◠)ﾉﾞ  YI-CRM启动成功   ლ(´ڡ`ლ)ﾞ"</span>);
    }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从AWS SDK for Java 2.x 调用 AWS 服务]]></title>    <link>https://juejin.cn/post/7605214360084987940</link>    <guid>https://juejin.cn/post/7605214360084987940</guid>    <pubDate>2026-02-11T09:53:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605214360084987940" data-draft-id="7605140481489207337" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从AWS SDK for Java 2.x 调用 AWS 服务"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T09:53:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="java进阶之路2023"/> <meta itemprop="url" content="https://juejin.cn/user/954805959001486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从AWS SDK for Java 2.x 调用 AWS 服务
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/954805959001486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    java进阶之路2023
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:53:49.000Z" title="Wed Feb 11 2026 09:53:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>从AWS SDK for Java 2.x 调用 AWS 服务</p>
<h2 data-id="heading-0">1、JAR包引入</h2>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-comment">&lt;!-- AWS SDK v2 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>software.amazon.awssdk<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>s3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.20.162<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>software.amazon.awssdk<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>auth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.20.162<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>software.amazon.awssdk<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>apache-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.20.162<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

</code></pre>
<h2 data-id="heading-1">2、配置</h2>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-comment">#上传配置</span>
<span class="hljs-attr">upload:</span>
  <span class="hljs-attr">aws:</span> <span class="hljs-comment">#aws上传</span>
    <span class="hljs-attr">secretId:</span> <span class="hljs-string">AKIA6666</span>
    <span class="hljs-attr">secretKey:</span> <span class="hljs-string">daEiuKneDT1111</span>
    <span class="hljs-attr">bucket:</span> <span class="hljs-string">live</span>
    <span class="hljs-attr">region:</span> <span class="hljs-string">ap-4544-1</span>
    <span class="hljs-attr">rootPath:</span>  <span class="hljs-string">/crm-drd</span>  <span class="hljs-comment"># 文件存储根路径</span>
    <span class="hljs-attr">days:</span> <span class="hljs-number">7</span>   <span class="hljs-comment"># 预签名URL有效期（天数）</span>
    <span class="hljs-attr">awsHost:</span> <span class="hljs-string">https://45454545-1.amazonaws.com</span>
    <span class="hljs-attr">proxyHost:</span> <span class="hljs-string">https://wewewet.ai</span>
    <span class="hljs-attr">enabled :</span> <span class="hljs-literal">true</span>
</code></pre>
<h2 data-id="heading-2">3、读取配置</h2>
<pre><code class="hljs language-arduino" lang="arduino">package com.yicrm.common.config;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-comment">/**
 * AWS S3 配置属性
 *
 * @author yicrm
 * @since 2026-01-29
 */</span>
@Data
@Component
@<span class="hljs-built_in">ConfigurationProperties</span>(prefix = <span class="hljs-string">"upload.aws"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AwsProperties</span> {

    <span class="hljs-comment">/**
     * 是否启用 AWS S3
     */</span>
    <span class="hljs-keyword">private</span> Boolean enabled = <span class="hljs-literal">false</span>;

    <span class="hljs-comment">/**
     * Access Key ID
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> secretId;

    <span class="hljs-comment">/**
     * Secret Access Key
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> secretKey;

    <span class="hljs-comment">/**
     * 区域
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> region = <span class="hljs-string">"ap-southeast-1"</span>;

    <span class="hljs-comment">/**
     * 存储桶名称
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> bucket;

    <span class="hljs-comment">/**
     * 根路径前缀
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> rootPath = <span class="hljs-string">""</span>;

    <span class="hljs-comment">/**
     * aws域名
     * */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> awsHost;

    <span class="hljs-comment">/**
     * 代理域名（用于替换 S3 URL 的域名）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> proxyHost;

    <span class="hljs-comment">/**
     * 预签名 URL 有效期（天数）
     */</span>
    <span class="hljs-keyword">private</span> Integer days = <span class="hljs-number">7</span>;

    <span class="hljs-comment">/**
     * 端点 URL（用于兼容 S3 兼容的存储服务）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> endpoint;
}
</code></pre>
<h2 data-id="heading-3">4、AwsUtils方法实现</h2>
<pre><code class="hljs language-scss" lang="scss">
package com<span class="hljs-selector-class">.yicrm</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.utils</span><span class="hljs-selector-class">.aws</span>;

import com<span class="hljs-selector-class">.yicrm</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.config</span><span class="hljs-selector-class">.AwsProperties</span>;
import lombok<span class="hljs-selector-class">.extern</span><span class="hljs-selector-class">.slf4j</span><span class="hljs-selector-class">.Slf4j</span>;
import org<span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.commons</span><span class="hljs-selector-class">.lang3</span><span class="hljs-selector-class">.StringUtils</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.beans</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Autowired</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Component</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.multipart</span><span class="hljs-selector-class">.MultipartFile</span>;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.auth</span><span class="hljs-selector-class">.credentials</span><span class="hljs-selector-class">.AwsBasicCredentials</span>;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.auth</span><span class="hljs-selector-class">.credentials</span><span class="hljs-selector-class">.StaticCredentialsProvider</span>;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.ResponseInputStream</span>;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.sync</span><span class="hljs-selector-class">.RequestBody</span>;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.http</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.ApacheHttpClient</span>;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.regions</span><span class="hljs-selector-class">.Region</span>;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.services</span><span class="hljs-selector-class">.s3</span><span class="hljs-selector-class">.S3Client</span>;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.services</span><span class="hljs-selector-class">.s3</span><span class="hljs-selector-class">.model</span>.*;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.services</span><span class="hljs-selector-class">.s3</span><span class="hljs-selector-class">.presigner</span><span class="hljs-selector-class">.S3Presigner</span>;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.services</span><span class="hljs-selector-class">.s3</span><span class="hljs-selector-class">.presigner</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.GetObjectPresignRequest</span>;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.services</span><span class="hljs-selector-class">.s3</span><span class="hljs-selector-class">.presigner</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.PresignedGetObjectRequest</span>;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.services</span><span class="hljs-selector-class">.s3</span><span class="hljs-selector-class">.presigner</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.PresignedPutObjectRequest</span>;
import software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.services</span><span class="hljs-selector-class">.s3</span><span class="hljs-selector-class">.presigner</span><span class="hljs-selector-class">.model</span><span class="hljs-selector-class">.PutObjectPresignRequest</span>;

import javax<span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.PostConstruct</span>;
import javax<span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.PreDestroy</span>;
import java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.File</span>;
import java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.FileOutputStream</span>;
import java<span class="hljs-selector-class">.io</span><span class="hljs-selector-class">.InputStream</span>;
import java<span class="hljs-selector-class">.net</span><span class="hljs-selector-class">.URL</span>;
import java<span class="hljs-selector-class">.net</span><span class="hljs-selector-class">.URLEncoder</span>;
import java<span class="hljs-selector-class">.nio</span><span class="hljs-selector-class">.file</span><span class="hljs-selector-class">.Files</span>;
import java<span class="hljs-selector-class">.nio</span><span class="hljs-selector-class">.file</span><span class="hljs-selector-class">.StandardCopyOption</span>;
import java<span class="hljs-selector-class">.time</span><span class="hljs-selector-class">.Duration</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.UUID</span>;

<span class="hljs-comment">/**
 * AWS S3 工具类
 *
 * @author yicrm
 * @since 2026-01-29
 */</span>
<span class="hljs-keyword">@Slf</span>4j
<span class="hljs-keyword">@Component</span>
public class AwsUtils {

    <span class="hljs-keyword">@Autowired</span>(required = false)
    private AwsProperties awsProperties;

    private S3Client s3Client;
    private S3Presigner s3Presigner;

    <span class="hljs-keyword">@PostConstruct</span>
    public void init() {
        if (awsProperties != null &amp;&amp; Boolean.TRUE.equals(awsProperties.getEnabled())) {
            try {
                AwsBasicCredentials awsCreds = AwsBasicCredentials<span class="hljs-selector-class">.create</span>(
                        awsProperties.getSecretId(),
                        awsProperties<span class="hljs-selector-class">.getSecretKey</span>()
                );

                software<span class="hljs-selector-class">.amazon</span><span class="hljs-selector-class">.awssdk</span><span class="hljs-selector-class">.services</span><span class="hljs-selector-class">.s3</span><span class="hljs-selector-class">.S3ClientBuilder</span> s3ClientBuilder = S3Client<span class="hljs-selector-class">.builder</span>()
                        <span class="hljs-selector-class">.region</span>(Region.of(awsProperties.getRegion()))
                        <span class="hljs-selector-class">.credentialsProvider</span>(StaticCredentialsProvider.create(awsCreds))
                        <span class="hljs-selector-class">.httpClient</span>(ApacheHttpClient.builder()<span class="hljs-selector-class">.build</span>());

                <span class="hljs-comment">// 如果配置了自定义端点，使用自定义端点</span>
                if (StringUtils.isNotBlank(awsProperties.getEndpoint())) {
                    s3ClientBuilder<span class="hljs-selector-class">.endpointOverride</span>(new URL(awsProperties.getEndpoint())<span class="hljs-selector-class">.toURI</span>());
                }

                s3Client = s3ClientBuilder<span class="hljs-selector-class">.build</span>();

                S3Presigner<span class="hljs-selector-class">.Builder</span> presignerBuilder = S3Presigner<span class="hljs-selector-class">.builder</span>()
                        <span class="hljs-selector-class">.region</span>(Region.of(awsProperties.getRegion()))
                        <span class="hljs-selector-class">.credentialsProvider</span>(StaticCredentialsProvider.create(awsCreds));

                if (StringUtils.isNotBlank(awsProperties.getEndpoint())) {
                    presignerBuilder<span class="hljs-selector-class">.endpointOverride</span>(new URL(awsProperties.getEndpoint())<span class="hljs-selector-class">.toURI</span>());
                }

                s3Presigner = presignerBuilder<span class="hljs-selector-class">.build</span>();

                log<span class="hljs-selector-class">.info</span>("AWS S3 客户端初始化成功");
            } catch (Exception e) {
                log<span class="hljs-selector-class">.error</span>("AWS S3 客户端初始化失败", e);
            }
        }
    }

    <span class="hljs-keyword">@PreDestroy</span>
    public void destroy() {
        if (s3Client != null) {
            s3Client<span class="hljs-selector-class">.close</span>();
        }
        if (s3Presigner != null) {
            s3Presigner<span class="hljs-selector-class">.close</span>();
        }
    }

    <span class="hljs-comment">/**
     * 检查 AWS 是否启用
     */</span>
    public boolean <span class="hljs-built_in">isEnabled</span>() {
        return awsProperties != null &amp;&amp; Boolean<span class="hljs-selector-class">.TRUE</span><span class="hljs-selector-class">.equals</span>(awsProperties.getEnabled()) &amp;&amp; s3Client != null;
    }

    <span class="hljs-comment">/**
     * 上传文件到 S3
     *
     * @param file 文件
     * @return 上传结果
     */</span>
    public AwsUploadResult <span class="hljs-built_in">uploadFile</span>(MultipartFile file) {
        if (!isEnabled()) {
            throw new <span class="hljs-built_in">IllegalStateException</span>("AWS S3 未启用或未正确配置");
        }

        try {
            String originalFilename = file<span class="hljs-selector-class">.getOriginalFilename</span>();
            String fileExtension = "";
            if (originalFilename != null &amp;&amp; originalFilename.contains(".")) {
                fileExtension = originalFilename<span class="hljs-selector-class">.substring</span>(originalFilename.lastIndexOf(".") + <span class="hljs-number">1</span>)<span class="hljs-selector-class">.toLowerCase</span>();
            }

            String key = UUID<span class="hljs-selector-class">.randomUUID</span>()<span class="hljs-selector-class">.toString</span>()<span class="hljs-selector-class">.replace</span>("-", "");
            String newFileName = key + (StringUtils.isNotBlank(fileExtension) ? "." + fileExtension : <span class="hljs-string">""</span>);

            <span class="hljs-comment">// 构建对象键</span>
            String rootPath = StringUtils<span class="hljs-selector-class">.isNotBlank</span>(awsProperties.getRootPath()) 
                    ? awsProperties<span class="hljs-selector-class">.getRootPath</span>()<span class="hljs-selector-class">.endsWith</span>("/") 
                        ? awsProperties<span class="hljs-selector-class">.getRootPath</span>() 
                        : awsProperties.<span class="hljs-built_in">getRootPath</span>() + <span class="hljs-string">"/"</span>
                    : <span class="hljs-string">""</span>;
            String objectKey = rootPath + newFileName;

            <span class="hljs-comment">// 创建临时文件</span>
            File tempFile = File<span class="hljs-selector-class">.createTempFile</span>(key, StringUtils.isNotBlank(fileExtension) ? "." + fileExtension : <span class="hljs-string">""</span>);
            try {
                Files<span class="hljs-selector-class">.copy</span>(file.getInputStream(), tempFile<span class="hljs-selector-class">.toPath</span>(), StandardCopyOption<span class="hljs-selector-class">.REPLACE_EXISTING</span>);

                <span class="hljs-comment">// 上传到 S3</span>
                PutObjectRequest putObjectRequest = PutObjectRequest<span class="hljs-selector-class">.builder</span>()
                        <span class="hljs-selector-class">.bucket</span>(awsProperties.getBucket())
                        <span class="hljs-selector-class">.key</span>(objectKey)
                        <span class="hljs-selector-class">.contentType</span>("application/octet-stream")
                        <span class="hljs-selector-class">.contentDisposition</span>("attachment")
                        <span class="hljs-selector-class">.contentLength</span>(file.getSize())
                        <span class="hljs-selector-class">.build</span>();

                s3Client<span class="hljs-selector-class">.putObject</span>(putObjectRequest, RequestBody.fromFile(tempFile));

                <span class="hljs-comment">// 生成文件访问 URL</span>
                String fileUrl = <span class="hljs-built_in">generatePresignedUrl</span>(objectKey, true);

                AwsUploadResult result = new <span class="hljs-built_in">AwsUploadResult</span>();
                result<span class="hljs-selector-class">.setKey</span>(objectKey);
                result<span class="hljs-selector-class">.setUrl</span>(fileUrl);
                result<span class="hljs-selector-class">.setOriginalFilename</span>(originalFilename);
                result<span class="hljs-selector-class">.setSize</span>(file.getSize());
                result<span class="hljs-selector-class">.setContentType</span>(file.getContentType());
                log<span class="hljs-selector-class">.info</span>("AWS S3 文件上传成功: key={}, url={}", objectKey, fileUrl);
                return result;
            } finally {
                <span class="hljs-comment">// 删除临时文件</span>
                if (tempFile.exists()) {
                    tempFile<span class="hljs-selector-class">.delete</span>();
                }
            }
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("AWS S3 文件上传失败", e);
            throw new <span class="hljs-built_in">RuntimeException</span>("文件上传失败: " + e.getMessage(), e);
        }
    }

    <span class="hljs-comment">/**
     * 上传文件到 S3（使用文件对象）
     *
     * @param file 文件
     * @param objectKey 对象键
     * @return 上传结果
     */</span>
    public AwsUploadResult <span class="hljs-built_in">uploadFile</span>(File file, String objectKey) {
        if (!isEnabled()) {
            throw new <span class="hljs-built_in">IllegalStateException</span>("AWS S3 未启用或未正确配置");
        }

        try {
            PutObjectRequest putObjectRequest = PutObjectRequest<span class="hljs-selector-class">.builder</span>()
                    <span class="hljs-selector-class">.bucket</span>(awsProperties.getBucket())
                    <span class="hljs-selector-class">.key</span>(objectKey)
                    <span class="hljs-selector-class">.contentLength</span>(file.length())
                    <span class="hljs-selector-class">.build</span>();

            s3Client<span class="hljs-selector-class">.putObject</span>(putObjectRequest, RequestBody.fromFile(file));

            String fileUrl = <span class="hljs-built_in">generatePresignedUrl</span>(objectKey, true);

            AwsUploadResult result = new <span class="hljs-built_in">AwsUploadResult</span>();
            result<span class="hljs-selector-class">.setKey</span>(objectKey);
            result<span class="hljs-selector-class">.setUrl</span>(fileUrl);
            result<span class="hljs-selector-class">.setOriginalFilename</span>(file.getName());
            result<span class="hljs-selector-class">.setSize</span>(file.length());

            log<span class="hljs-selector-class">.info</span>("AWS S3 文件上传成功: key={}, url={}", objectKey, fileUrl);
            return result;
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("AWS S3 文件上传失败: key={}", objectKey, e);
            throw new <span class="hljs-built_in">RuntimeException</span>("文件上传失败: " + e.getMessage(), e);
        }
    }

    <span class="hljs-comment">/**
     * 下载文件
     *
     * @param objectKey 对象键
     * @param targetPath 目标文件路径
     * @return 下载的文件
     */</span>
    public File <span class="hljs-built_in">downloadFile</span>(String objectKey, String targetPath) {
        if (!isEnabled()) {
            throw new <span class="hljs-built_in">IllegalStateException</span>("AWS S3 未启用或未正确配置");
        }

        try {
            GetObjectRequest getObjectRequest = GetObjectRequest<span class="hljs-selector-class">.builder</span>()
                    <span class="hljs-selector-class">.bucket</span>(awsProperties.getBucket())
                    <span class="hljs-selector-class">.key</span>(objectKey)
                    <span class="hljs-selector-class">.build</span>();

            ResponseInputStream&lt;GetObjectResponse&gt; response = s3Client<span class="hljs-selector-class">.getObject</span>(getObjectRequest);
            File targetFile = new <span class="hljs-built_in">File</span>(targetPath);

            <span class="hljs-comment">// 确保目标文件的父目录存在</span>
            File parentDir = targetFile<span class="hljs-selector-class">.getParentFile</span>();
            if (parentDir != null &amp;&amp; !parentDir.exists()) {
                parentDir<span class="hljs-selector-class">.mkdirs</span>();
            }

            <span class="hljs-comment">// 将响应流写入文件</span>
            try (FileOutputStream fos = new FileOutputStream(targetFile);
                 InputStream inputStream = response) {
                byte<span class="hljs-selector-attr">[]</span> buffer = new byte<span class="hljs-selector-attr">[8192]</span>;
                int bytesRead;
                while ((bytesRead = inputStream.read(buffer)) != -<span class="hljs-number">1</span>) {
                    fos<span class="hljs-selector-class">.write</span>(buffer, <span class="hljs-number">0</span>, bytesRead);
                }
            }

            log<span class="hljs-selector-class">.info</span>("AWS S3 文件下载成功: key={}, path={}", objectKey, targetPath);
            return targetFile;
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("AWS S3 文件下载失败: key={}, path={}", objectKey, targetPath, e);
            throw new <span class="hljs-built_in">RuntimeException</span>("文件下载失败: " + e.getMessage(), e);
        }
    }

    <span class="hljs-comment">/**
     * 获取文件输入流
     *
     * @param objectKey 对象键
     * @return 文件输入流
     */</span>
    public InputStream <span class="hljs-built_in">getFileInputStream</span>(String objectKey) {
        if (!isEnabled()) {
            throw new <span class="hljs-built_in">IllegalStateException</span>("AWS S3 未启用或未正确配置");
        }

        try {
            GetObjectRequest getObjectRequest = GetObjectRequest<span class="hljs-selector-class">.builder</span>()
                    <span class="hljs-selector-class">.bucket</span>(awsProperties.getBucket())
                    <span class="hljs-selector-class">.key</span>(objectKey)
                    <span class="hljs-selector-class">.build</span>();

            ResponseInputStream&lt;GetObjectResponse&gt; response = s3Client<span class="hljs-selector-class">.getObject</span>(getObjectRequest);
            log<span class="hljs-selector-class">.info</span>("AWS S3 文件流获取成功: key={}", objectKey);
            return response;
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("AWS S3 文件流获取失败: key={}", objectKey, e);
            throw new <span class="hljs-built_in">RuntimeException</span>("文件流获取失败: " + e.getMessage(), e);
        }
    }

    <span class="hljs-comment">/**
     * 删除文件
     *
     * @param objectKey 对象键
     */</span>
    public void <span class="hljs-built_in">deleteFile</span>(String objectKey) {
        if (!isEnabled()) {
            throw new <span class="hljs-built_in">IllegalStateException</span>("AWS S3 未启用或未正确配置");
        }

        try {
            DeleteObjectRequest deleteObjectRequest = DeleteObjectRequest<span class="hljs-selector-class">.builder</span>()
                    <span class="hljs-selector-class">.bucket</span>(awsProperties.getBucket())
                    <span class="hljs-selector-class">.key</span>(objectKey)
                    <span class="hljs-selector-class">.build</span>();

            s3Client<span class="hljs-selector-class">.deleteObject</span>(deleteObjectRequest);
            log<span class="hljs-selector-class">.info</span>("AWS S3 文件删除成功: key={}", objectKey);
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("AWS S3 文件删除失败: key={}", objectKey, e);
            throw new <span class="hljs-built_in">RuntimeException</span>("文件删除失败: " + e.getMessage(), e);
        }
    }

    <span class="hljs-comment">/**
     * 检查文件是否存在
     *
     * @param objectKey 对象键
     * @return 是否存在
     */</span>
    public boolean <span class="hljs-built_in">fileExists</span>(String objectKey) {
        if (!isEnabled()) {
            return false;
        }

        try {
            HeadObjectRequest headObjectRequest = HeadObjectRequest<span class="hljs-selector-class">.builder</span>()
                    <span class="hljs-selector-class">.bucket</span>(awsProperties.getBucket())
                    <span class="hljs-selector-class">.key</span>(objectKey)
                    <span class="hljs-selector-class">.build</span>();

            s3Client<span class="hljs-selector-class">.headObject</span>(headObjectRequest);
            return true;
        } catch (NoSuchKeyException e) {
            return false;
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("AWS S3 检查文件存在性失败: key={}", objectKey, e);
            return false;
        }
    }

    <span class="hljs-comment">/**
     * 生成预签名 URL（用于下载）
     *
     * @param objectKey 对象键
     * @param forceInline 是否强制内联显示（用于预览）
     * @return 预签名 URL
     */</span>
    public String <span class="hljs-built_in">generatePresignedUrl</span>(String objectKey, boolean forceInline) {
        if (!isEnabled()) {
            throw new <span class="hljs-built_in">IllegalStateException</span>("AWS S3 未启用或未正确配置");
        }

        try {
            GetObjectRequest<span class="hljs-selector-class">.Builder</span> requestBuilder = GetObjectRequest<span class="hljs-selector-class">.builder</span>()
                    <span class="hljs-selector-class">.bucket</span>(awsProperties.getBucket())
                    <span class="hljs-selector-class">.key</span>(objectKey);

            if (forceInline) {
                requestBuilder<span class="hljs-selector-class">.responseContentDisposition</span>("inline");
            }

            GetObjectRequest objectRequest = requestBuilder<span class="hljs-selector-class">.build</span>();

            GetObjectPresignRequest presignRequest = GetObjectPresignRequest<span class="hljs-selector-class">.builder</span>()
                    <span class="hljs-selector-class">.signatureDuration</span>(Duration.ofDays(awsProperties.getDays()))
                    <span class="hljs-selector-class">.getObjectRequest</span>(objectRequest)
                    <span class="hljs-selector-class">.build</span>();

            PresignedGetObjectRequest presignedRequest = s3Presigner<span class="hljs-selector-class">.presignGetObject</span>(presignRequest);
            String url = presignedRequest<span class="hljs-selector-class">.url</span>()<span class="hljs-selector-class">.toString</span>();

            <span class="hljs-comment">// 如果配置了代理域名，替换 URL 中的域名</span>
            if (StringUtils.isNotBlank(awsProperties.getProxyHost())) {
                url = <span class="hljs-built_in">replaceUrlDomain</span>(url, awsProperties.getProxyHost());
            }

            log<span class="hljs-selector-class">.info</span>("生成预签名 URL: key={}, url={}", objectKey, url);
            return url;
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("生成预签名 URL 失败: key={}", objectKey, e);
            throw new <span class="hljs-built_in">RuntimeException</span>("生成预签名 URL 失败: " + e.getMessage(), e);
        }
    }

    <span class="hljs-comment">/**
     * 生成预签名下载 URL（用于文件下载）
     *
     * @param objectKey 对象键
     * @return 预签名下载 URL
     */</span>
    public String <span class="hljs-built_in">generatePresignedDownloadUrl</span>(String objectKey) {
        return <span class="hljs-built_in">generatePresignedDownloadUrl</span>(objectKey, null, null);
    }

    <span class="hljs-comment">/**
     * 生成预签名下载 URL（用于文件下载，支持自定义文件名）
     *
     * @param objectKey 对象键
     * @param filename 下载时的文件名（可选）
     * @return 预签名下载 URL
     */</span>
    public String <span class="hljs-built_in">generatePresignedDownloadUrl</span>(String objectKey, String filename) {
        return <span class="hljs-built_in">generatePresignedDownloadUrl</span>(objectKey, filename, null);
    }

    <span class="hljs-comment">/**
     * 生成预签名下载 URL（用于文件下载，支持自定义文件名和有效期）
     *
     * @param objectKey 对象键
     * @param filename 下载时的文件名（可选，如果为空则使用默认文件名）
     * @param days 有效期（天数，如果为空则使用配置的默认值）
     * @return 预签名下载 URL
     */</span>
    public String <span class="hljs-built_in">generatePresignedDownloadUrl</span>(String objectKey, String filename, Integer days) {
        if (!isEnabled()) {
            throw new <span class="hljs-built_in">IllegalStateException</span>("AWS S3 未启用或未正确配置");
        }

        try {
            GetObjectRequest<span class="hljs-selector-class">.Builder</span> requestBuilder = GetObjectRequest<span class="hljs-selector-class">.builder</span>()
                    <span class="hljs-selector-class">.bucket</span>(awsProperties.getBucket())
                    <span class="hljs-selector-class">.key</span>(objectKey);

            <span class="hljs-comment">// 如果指定了文件名，设置下载时的文件名</span>
            if (StringUtils.isNotBlank(filename)) {
                requestBuilder<span class="hljs-selector-class">.responseContentDisposition</span>("attachment; filename="" + filename + """);
            } else {
                <span class="hljs-comment">// 默认设置为附件下载</span>
                requestBuilder<span class="hljs-selector-class">.responseContentDisposition</span>("attachment");
            }

            GetObjectRequest objectRequest = requestBuilder<span class="hljs-selector-class">.build</span>();

            <span class="hljs-comment">// 使用指定的有效期或配置的默认值</span>
            int signatureDays = days != null ? days : awsProperties.<span class="hljs-built_in">getDays</span>();
            GetObjectPresignRequest presignRequest = GetObjectPresignRequest<span class="hljs-selector-class">.builder</span>()
                    <span class="hljs-selector-class">.signatureDuration</span>(Duration.ofDays(signatureDays))
                    <span class="hljs-selector-class">.getObjectRequest</span>(objectRequest)
                    <span class="hljs-selector-class">.build</span>();

            PresignedGetObjectRequest presignedRequest = s3Presigner<span class="hljs-selector-class">.presignGetObject</span>(presignRequest);
            String url = presignedRequest<span class="hljs-selector-class">.url</span>()<span class="hljs-selector-class">.toString</span>();

            <span class="hljs-comment">// 如果配置了代理域名，替换 URL 中的域名</span>
            if (StringUtils.isNotBlank(awsProperties.getProxyHost())) {
                url = <span class="hljs-built_in">replaceUrlDomain</span>(url, awsProperties.getProxyHost());
            }

            log<span class="hljs-selector-class">.info</span>("生成预签名下载 URL: key={}, filename={}, days={}, url={}", objectKey, filename, signatureDays, url);
            return url;
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("生成预签名下载 URL 失败: key={}, filename={}", objectKey, filename, e);
            throw new <span class="hljs-built_in">RuntimeException</span>("生成预签名下载 URL 失败: " + e.getMessage(), e);
        }
    }

    <span class="hljs-comment">/**
     * 生成预签名上传 URL
     *
     * @param objectKey 对象键
     * @return 预签名上传 URL
     */</span>
    public String <span class="hljs-built_in">generatePresignedPutUrl</span>(String objectKey) {
        if (!isEnabled()) {
            throw new <span class="hljs-built_in">IllegalStateException</span>("AWS S3 未启用或未正确配置");
        }

        try {
            PutObjectRequest putObjectRequest = PutObjectRequest<span class="hljs-selector-class">.builder</span>()
                    <span class="hljs-selector-class">.bucket</span>(awsProperties.getBucket())
                    <span class="hljs-selector-class">.key</span>(objectKey)
                    <span class="hljs-selector-class">.build</span>();

            PutObjectPresignRequest presignRequest = PutObjectPresignRequest<span class="hljs-selector-class">.builder</span>()
                    <span class="hljs-selector-class">.signatureDuration</span>(Duration.ofDays(awsProperties.getDays()))
                    <span class="hljs-selector-class">.putObjectRequest</span>(putObjectRequest)
                    <span class="hljs-selector-class">.build</span>();

            PresignedPutObjectRequest presignedRequest = s3Presigner<span class="hljs-selector-class">.presignPutObject</span>(presignRequest);
            String url = presignedRequest<span class="hljs-selector-class">.url</span>()<span class="hljs-selector-class">.toString</span>();

            log<span class="hljs-selector-class">.info</span>("生成预签名上传 URL: key={}, url={}", objectKey, url);
            return url;
        } catch (Exception e) {
            log<span class="hljs-selector-class">.error</span>("生成预签名上传 URL 失败: key={}", objectKey, e);
            throw new <span class="hljs-built_in">RuntimeException</span>("生成预签名上传 URL 失败: " + e.getMessage(), e);
        }
    }

    <span class="hljs-comment">/**
     * 替换 URL 中的域名
     *
     * @param originalUrl 原始 URL
     * @param targetDomain 目标域名
     * @return 替换后的 URL
     */</span>
    private String <span class="hljs-built_in">replaceUrlDomain</span>(String originalUrl, String targetDomain) {
        try {
            URL url = new <span class="hljs-built_in">URL</span>(originalUrl);
            String targetDomainClean = targetDomain<span class="hljs-selector-class">.replaceAll</span>("^https?://", "")<span class="hljs-selector-class">.replaceAll</span>("/$", "");
            String protocol = url<span class="hljs-selector-class">.getProtocol</span>();
            String newUrl = protocol + "://<span class="hljs-string">" + targetDomainClean + url.getPath();
            if (url.getQuery() != null) {
                newUrl += "</span>?<span class="hljs-string">" + url.getQuery();
            }
            return newUrl;
        } catch (Exception e) {
            log.warn("</span>替换 URL 域名失败: originalUrl={}, targetDomain={}", originalUrl, targetDomain, e);
            return originalUrl;
        }
    }
}

</code></pre>
<h2 data-id="heading-4">5、文件上传限制</h2>
<pre><code class="hljs language-kotlin" lang="kotlin">

file:
  upload:
    formatList: pdf
    size: <span class="hljs-number">52428800</span>


<span class="hljs-keyword">package</span> com.yicrm.common.config;

<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-comment">/**
 * 文件上传配置属性
 *
 * <span class="hljs-doctag">@author</span> yicrm
 * <span class="hljs-doctag">@since</span> 2026-01-29
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@ConfigurationProperties(prefix = <span class="hljs-string">"file.upload"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileUploadProperties</span> {

    <span class="hljs-comment">/**
     * 允许的文件格式列表（逗号分隔，如：pdf,doc,docx）
     */</span>
    <span class="hljs-keyword">private</span> String formatList = <span class="hljs-string">""</span>;

    <span class="hljs-comment">/**
     * 文件大小限制（字节），默认 50MB
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> size = <span class="hljs-number">50</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024L</span>;
}
</code></pre>
<h2 data-id="heading-5">6、AWS实现类</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.yicrm.biz.service.business;

<span class="hljs-keyword">import</span> com.yicrm.common.config.FileUploadProperties;
<span class="hljs-keyword">import</span> com.yicrm.common.core.domain.AjaxResult;
<span class="hljs-keyword">import</span> com.yicrm.common.utils.aws.AwsUploadResult;
<span class="hljs-keyword">import</span> com.yicrm.common.utils.aws.AwsUtils;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.apache.commons.lang3.StringUtils;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;

<span class="hljs-keyword">import</span> javax.<span class="hljs-keyword">annotation</span>.Resource;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/**
 * 文件上传下载业务服务
 *
 * <span class="hljs-doctag">@author</span> yicrm
 * <span class="hljs-doctag">@since</span> 2026-01-29
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FileUploadBusinessService</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> AwsUtils awsUtils;

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> FileUploadProperties fileUploadProperties;

    <span class="hljs-comment">/**
     * AWS S3 文件上传（单个）
     *
     * <span class="hljs-doctag">@param</span> file 文件
     * <span class="hljs-doctag">@return</span> 上传结果
     */</span>
    <span class="hljs-keyword">public</span> AjaxResult uploadFile(MultipartFile file) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (file == <span class="hljs-literal">null</span> || file.isEmpty()) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"文件不能为空"</span>);
            }

            <span class="hljs-comment">// 验证文件格式和大小</span>
            AjaxResult validationResult = validateFile(file);
            <span class="hljs-keyword">if</span> (validationResult != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> validationResult;
            }

            <span class="hljs-keyword">if</span> (!awsUtils.isEnabled()) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"AWS S3 未启用或未正确配置"</span>);
            }

            AwsUploadResult result = awsUtils.uploadFile(file);

            Map&lt;String, Object&gt; <span class="hljs-keyword">data</span> = new HashMap&lt;&gt;();
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"key"</span>, result.getKey());
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"url"</span>, result.getUrl());
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"fileName"</span>, result.getKey());
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"originalFilename"</span>, result.getOriginalFilename());
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"size"</span>, result.getSize());
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"contentType"</span>, result.getContentType());
<span class="hljs-comment">//            data.put("contentType", "application/octet-stream");</span>
<span class="hljs-comment">//            data.put("Content-Disposition", "attachment; filename="+result.getOriginalFilename());</span>

            <span class="hljs-keyword">return</span> AjaxResult.success(<span class="hljs-string">"文件上传成功"</span>, <span class="hljs-keyword">data</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"AWS S3 文件上传失败"</span>, e);
            <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"文件上传失败: "</span> + e.getMessage());
        }
    }

    <span class="hljs-comment">/**
     * AWS S3 文件上传（多个）
     *
     * <span class="hljs-doctag">@param</span> files 文件列表
     * <span class="hljs-doctag">@return</span> 上传结果
     */</span>
    <span class="hljs-keyword">public</span> AjaxResult uploadFiles(List&lt;MultipartFile&gt; files) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (files == <span class="hljs-literal">null</span> || files.isEmpty()) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"文件列表不能为空"</span>);
            }

            <span class="hljs-keyword">if</span> (!awsUtils.isEnabled()) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"AWS S3 未启用或未正确配置"</span>);
            }

            List&lt;Map&lt;String, Object&gt;&gt; results = new ArrayList&lt;&gt;();
            List&lt;String&gt; keys = new ArrayList&lt;&gt;();
            List&lt;String&gt; urls = new ArrayList&lt;&gt;();
            List&lt;String&gt; fileNames = new ArrayList&lt;&gt;();
            List&lt;String&gt; originalFilenames = new ArrayList&lt;&gt;();

            <span class="hljs-keyword">for</span> (MultipartFile file : files) {
                <span class="hljs-keyword">if</span> (file.isEmpty()) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-comment">// 验证文件格式和大小</span>
                AjaxResult validationResult = validateFile(file);
                <span class="hljs-keyword">if</span> (validationResult != <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// 如果验证失败，返回错误信息</span>
                    <span class="hljs-keyword">return</span> validationResult;
                }

                AwsUploadResult result = awsUtils.uploadFile(file);

                Map&lt;String, Object&gt; <span class="hljs-keyword">data</span> = new HashMap&lt;&gt;();
                <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"key"</span>, result.getKey());
                <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"url"</span>, result.getUrl());
                <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"fileName"</span>, result.getKey());
                <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"originalFilename"</span>, result.getOriginalFilename());
                <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"size"</span>, result.getSize());
                <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"contentType"</span>, result.getContentType());

                results.add(<span class="hljs-keyword">data</span>);
                keys.add(result.getKey());
                urls.add(result.getUrl());
                fileNames.add(result.getKey());
                originalFilenames.add(result.getOriginalFilename());
            }

            Map&lt;String, Object&gt; responseData = new HashMap&lt;&gt;();
            responseData.put(<span class="hljs-string">"results"</span>, results);
            responseData.put(<span class="hljs-string">"keys"</span>, StringUtils.join(keys, <span class="hljs-string">","</span>));
            responseData.put(<span class="hljs-string">"urls"</span>, StringUtils.join(urls, <span class="hljs-string">","</span>));
            responseData.put(<span class="hljs-string">"fileNames"</span>, StringUtils.join(fileNames, <span class="hljs-string">","</span>));
            responseData.put(<span class="hljs-string">"originalFilenames"</span>, StringUtils.join(originalFilenames, <span class="hljs-string">","</span>));

            <span class="hljs-keyword">return</span> AjaxResult.success(<span class="hljs-string">"文件上传成功"</span>, responseData);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"AWS S3 批量文件上传失败"</span>, e);
            <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"文件上传失败: "</span> + e.getMessage());
        }
    }

    <span class="hljs-comment">/**
     * 生成 AWS S3 预签名下载 URL
     *
     * <span class="hljs-doctag">@param</span> key 对象键（S3 中的文件路径）
     * <span class="hljs-doctag">@param</span> filename 下载时的文件名（可选）
     * <span class="hljs-doctag">@param</span> days 有效期（天数，可选，默认使用配置值）
     * <span class="hljs-doctag">@return</span> 预签名下载 URL
     */</span>
    <span class="hljs-keyword">public</span> AjaxResult generateDownloadUrl(String key, String filename, Integer days) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (StringUtils.isBlank(key)) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"对象键不能为空"</span>);
            }

            <span class="hljs-keyword">if</span> (!awsUtils.isEnabled()) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"AWS S3 未启用或未正确配置"</span>);
            }

            String downloadUrl;
            <span class="hljs-keyword">if</span> (filename != <span class="hljs-literal">null</span> &amp;&amp; days != <span class="hljs-literal">null</span>) {
                downloadUrl = awsUtils.generatePresignedDownloadUrl(key, filename, days);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (filename != <span class="hljs-literal">null</span>) {
                downloadUrl = awsUtils.generatePresignedDownloadUrl(key, filename);
            } <span class="hljs-keyword">else</span> {
                downloadUrl = awsUtils.generatePresignedDownloadUrl(key);
            }

            Map&lt;String, Object&gt; <span class="hljs-keyword">data</span> = new HashMap&lt;&gt;();
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"url"</span>, downloadUrl);
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"key"</span>, key);
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"filename"</span>, filename);

            <span class="hljs-keyword">return</span> AjaxResult.success(<span class="hljs-string">"生成下载 URL 成功"</span>, <span class="hljs-keyword">data</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"生成 AWS S3 下载 URL 失败: key={}"</span>, key, e);
            <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"生成下载 URL 失败: "</span> + e.getMessage());
        }
    }

    <span class="hljs-comment">/**
     * 生成 AWS S3 预签名预览 URL
     *
     * <span class="hljs-doctag">@param</span> key 对象键（S3 中的文件路径）
     * <span class="hljs-doctag">@return</span> 预签名预览 URL
     */</span>
    <span class="hljs-keyword">public</span> AjaxResult generatePreviewUrl(String key) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (StringUtils.isBlank(key)) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"对象键不能为空"</span>);
            }

            <span class="hljs-keyword">if</span> (!awsUtils.isEnabled()) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"AWS S3 未启用或未正确配置"</span>);
            }

            String previewUrl = awsUtils.generatePresignedUrl(key, <span class="hljs-literal">true</span>);

            Map&lt;String, Object&gt; <span class="hljs-keyword">data</span> = new HashMap&lt;&gt;();
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"url"</span>, previewUrl);
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"key"</span>, key);

            <span class="hljs-keyword">return</span> AjaxResult.success(<span class="hljs-string">"生成预览 URL 成功"</span>, <span class="hljs-keyword">data</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"生成 AWS S3 预览 URL 失败: key={}"</span>, key, e);
            <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"生成预览 URL 失败: "</span> + e.getMessage());
        }
    }

    <span class="hljs-comment">/**
     * 删除 AWS S3 文件
     *
     * <span class="hljs-doctag">@param</span> key 对象键（S3 中的文件路径）
     * <span class="hljs-doctag">@return</span> 删除结果
     */</span>
    <span class="hljs-keyword">public</span> AjaxResult deleteFile(String key) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (StringUtils.isBlank(key)) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"对象键不能为空"</span>);
            }

            <span class="hljs-keyword">if</span> (!awsUtils.isEnabled()) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"AWS S3 未启用或未正确配置"</span>);
            }

            awsUtils.deleteFile(key);

            <span class="hljs-keyword">return</span> AjaxResult.success(<span class="hljs-string">"文件删除成功"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"删除 AWS S3 文件失败: key={}"</span>, key, e);
            <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"文件删除失败: "</span> + e.getMessage());
        }
    }

    <span class="hljs-comment">/**
     * 检查 AWS S3 文件是否存在
     *
     * <span class="hljs-doctag">@param</span> key 对象键（S3 中的文件路径）
     * <span class="hljs-doctag">@return</span> 是否存在
     */</span>
    <span class="hljs-keyword">public</span> AjaxResult checkFileExists(String key) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (StringUtils.isBlank(key)) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"对象键不能为空"</span>);
            }

            <span class="hljs-keyword">if</span> (!awsUtils.isEnabled()) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"AWS S3 未启用或未正确配置"</span>);
            }

            boolean exists = awsUtils.fileExists(key);

            Map&lt;String, Object&gt; <span class="hljs-keyword">data</span> = new HashMap&lt;&gt;();
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"exists"</span>, exists);
            <span class="hljs-keyword">data</span>.put(<span class="hljs-string">"key"</span>, key);

            <span class="hljs-keyword">return</span> AjaxResult.success(<span class="hljs-string">"检查完成"</span>, <span class="hljs-keyword">data</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"检查 AWS S3 文件存在性失败: key={}"</span>, key, e);
            <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"检查失败: "</span> + e.getMessage());
        }
    }

    <span class="hljs-comment">/**
     * 验证文件格式和大小
     *
     * <span class="hljs-doctag">@param</span> file 文件
     * <span class="hljs-doctag">@return</span> 验证失败返回错误结果，验证成功返回 null
     */</span>
    <span class="hljs-keyword">private</span> AjaxResult validateFile(MultipartFile file) {
        <span class="hljs-comment">// 验证文件大小</span>
        <span class="hljs-keyword">if</span> (fileUploadProperties.getSize() != <span class="hljs-literal">null</span> &amp;&amp; file.getSize() &gt; fileUploadProperties.getSize()) {
            long maxSizeMB = fileUploadProperties.getSize() / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>;
            <span class="hljs-keyword">return</span> AjaxResult.error(String.format(<span class="hljs-string">"文件大小超出限制，允许的最大文件大小为：%d MB"</span>, maxSizeMB));
        }

        <span class="hljs-comment">// 验证文件格式</span>
        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(fileUploadProperties.getFormatList())) {
            String originalFilename = file.getOriginalFilename();
            <span class="hljs-keyword">if</span> (StringUtils.isBlank(originalFilename)) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"文件名不能为空"</span>);
            }

            <span class="hljs-comment">// 获取文件扩展名</span>
            String extension = getFileExtension(originalFilename);
            <span class="hljs-keyword">if</span> (StringUtils.isBlank(extension)) {
                <span class="hljs-keyword">return</span> AjaxResult.error(<span class="hljs-string">"文件格式不支持，无法识别文件类型"</span>);
            }

            <span class="hljs-comment">// 解析允许的格式列表</span>
            String[] allowedFormats = fileUploadProperties.getFormatList().split(<span class="hljs-string">","</span>);
            List&lt;String&gt; allowedFormatList = new ArrayList&lt;&gt;();
            <span class="hljs-keyword">for</span> (String format : allowedFormats) {
                String trimmedFormat = format.trim().toLowerCase();
                <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(trimmedFormat)) {
                    allowedFormatList.add(trimmedFormat);
                }
            }

            <span class="hljs-comment">// 检查文件格式是否在允许列表中</span>
            <span class="hljs-keyword">if</span> (!allowedFormatList.isEmpty() &amp;&amp; !allowedFormatList.contains(extension.toLowerCase())) {
                <span class="hljs-keyword">return</span> AjaxResult.error(String.format(<span class="hljs-string">"文件格式不支持，允许的格式为：%s，当前文件格式：%s"</span>,
                        fileUploadProperties.getFormatList(), extension));
            }
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 验证通过</span>
    }

    <span class="hljs-comment">/**
     * 获取文件扩展名
     *
     * <span class="hljs-doctag">@param</span> filename 文件名
     * <span class="hljs-doctag">@return</span> 扩展名（不包含点）
     */</span>
    <span class="hljs-keyword">private</span> String getFileExtension(String filename) {
        <span class="hljs-keyword">if</span> (StringUtils.isBlank(filename)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        }
        int lastDotIndex = filename.lastIndexOf(<span class="hljs-string">'.'</span>);
        <span class="hljs-keyword">if</span> (lastDotIndex &gt; <span class="hljs-number">0</span> &amp;&amp; lastDotIndex &lt; filename.length() - <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> filename.substring(lastDotIndex + <span class="hljs-number">1</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
    }
}
</code></pre>
<h2 data-id="heading-6">7、controller实现</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">package</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.yicrm</span><span class="hljs-selector-class">.biz</span><span class="hljs-selector-class">.controller</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.yicrm</span><span class="hljs-selector-class">.biz</span><span class="hljs-selector-class">.service</span><span class="hljs-selector-class">.business</span><span class="hljs-selector-class">.FileUploadBusinessService</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.yicrm</span><span class="hljs-selector-class">.common</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.domain</span><span class="hljs-selector-class">.AjaxResult</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">io</span><span class="hljs-selector-class">.swagger</span><span class="hljs-selector-class">.v3</span><span class="hljs-selector-class">.oas</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.Operation</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">io</span><span class="hljs-selector-class">.swagger</span><span class="hljs-selector-class">.v3</span><span class="hljs-selector-class">.oas</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.media</span><span class="hljs-selector-class">.Content</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">io</span><span class="hljs-selector-class">.swagger</span><span class="hljs-selector-class">.v3</span><span class="hljs-selector-class">.oas</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.media</span><span class="hljs-selector-class">.Schema</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">io</span><span class="hljs-selector-class">.swagger</span><span class="hljs-selector-class">.v3</span><span class="hljs-selector-class">.oas</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.responses</span><span class="hljs-selector-class">.ApiResponse</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">io</span><span class="hljs-selector-class">.swagger</span><span class="hljs-selector-class">.v3</span><span class="hljs-selector-class">.oas</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.responses</span><span class="hljs-selector-class">.ApiResponses</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">io</span><span class="hljs-selector-class">.swagger</span><span class="hljs-selector-class">.v3</span><span class="hljs-selector-class">.oas</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.tags</span><span class="hljs-selector-class">.Tag</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.security</span><span class="hljs-selector-class">.access</span><span class="hljs-selector-class">.prepost</span><span class="hljs-selector-class">.PreAuthorize</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span>.*;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.multipart</span><span class="hljs-selector-class">.MultipartFile</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">javax</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Resource</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;

<span class="hljs-comment">/**
 * 文件上传下载控制器
 *
 * @author yicrm
 * @since 2026-01-29
 */</span>
@<span class="hljs-selector-tag">RestController</span>
@<span class="hljs-selector-tag">RequestMapping</span>(<span class="hljs-string">"/file"</span>)
@<span class="hljs-selector-tag">Tag</span>(name = <span class="hljs-string">"文件上传下载"</span>)
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">FileUploadController</span> {

    <span class="hljs-variable">@Resource</span>
    private FileUploadBusinessService fileUploadBusinessService;

    <span class="hljs-comment">/**
     * AWS S3 文件上传（单个）
     *
     * @param file 文件
     * @return 上传结果
     */</span>
    <span class="hljs-variable">@Operation</span>(summary = <span class="hljs-string">"AWS S3 文件上传（单个）"</span>, description = <span class="hljs-string">"上传单个文件到 AWS S3"</span>)
    <span class="hljs-variable">@ApiResponses</span>({
            <span class="hljs-variable">@ApiResponse</span>(responseCode = <span class="hljs-string">"200"</span>, description = <span class="hljs-string">"上传成功"</span>,
                    content = <span class="hljs-variable">@Content</span>(schema = <span class="hljs-variable">@Schema</span>(implementation = AjaxResult.class))),
            <span class="hljs-variable">@ApiResponse</span>(responseCode = <span class="hljs-string">"500"</span>, description = <span class="hljs-string">"上传失败"</span>)
    })
    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/aws/upload"</span>)
<span class="hljs-comment">//    @PreAuthorize("@ss.hasPermi('file:upload')")</span>
    public AjaxResult <span class="hljs-built_in">uploadFileToAws</span>(<span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"file"</span>) MultipartFile file) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">fileUploadBusinessService</span><span class="hljs-selector-class">.uploadFile</span>(file);
    }

    <span class="hljs-comment">/**
     * AWS S3 文件上传（多个）
     *
     * @param files 文件列表
     * @return 上传结果
     */</span>
    @<span class="hljs-selector-tag">Operation</span>(summary = <span class="hljs-string">"AWS S3 文件上传（多个）"</span>, description = <span class="hljs-string">"批量上传多个文件到 AWS S3"</span>)
    @<span class="hljs-selector-tag">ApiResponses</span>({
            <span class="hljs-variable">@ApiResponse</span>(responseCode = <span class="hljs-string">"200"</span>, description = <span class="hljs-string">"上传成功"</span>,
                    content = <span class="hljs-variable">@Content</span>(schema = <span class="hljs-variable">@Schema</span>(implementation = AjaxResult.class))),
            <span class="hljs-variable">@ApiResponse</span>(responseCode = <span class="hljs-string">"500"</span>, description = <span class="hljs-string">"上传失败"</span>)
    })
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/aws/uploads"</span>)
<span class="hljs-comment">//    @PreAuthorize("@ss.hasPermi('file:upload')")</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">AjaxResult</span> <span class="hljs-selector-tag">uploadFilesToAws</span>(<span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"files"</span>) List&lt;MultipartFile&gt; files) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">fileUploadBusinessService</span><span class="hljs-selector-class">.uploadFiles</span>(files);
    }

    <span class="hljs-comment">/**
     * 生成 AWS S3 预签名下载 URL
     *
     * @param key 对象键（S3 中的文件路径）
     * @param filename 下载时的文件名（可选）
     * @param days 有效期（天数，可选，默认使用配置值）
     * @return 预签名下载 URL
     */</span>
    @<span class="hljs-selector-tag">Operation</span>(summary = <span class="hljs-string">"生成 AWS S3 预签名下载 URL"</span>, description = <span class="hljs-string">"生成用于文件下载的预签名 URL"</span>)
    @<span class="hljs-selector-tag">ApiResponses</span>({
            <span class="hljs-variable">@ApiResponse</span>(responseCode = <span class="hljs-string">"200"</span>, description = <span class="hljs-string">"生成成功"</span>,
                    content = <span class="hljs-variable">@Content</span>(schema = <span class="hljs-variable">@Schema</span>(implementation = AjaxResult.class))),
            <span class="hljs-variable">@ApiResponse</span>(responseCode = <span class="hljs-string">"500"</span>, description = <span class="hljs-string">"生成失败"</span>)
    })
    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/aws/download/url"</span>)
<span class="hljs-comment">//    @PreAuthorize("@ss.hasPermi('file:download')")</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">AjaxResult</span> <span class="hljs-selector-tag">generateDownloadUrl</span>(
            <span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"key"</span>) String key,
            <span class="hljs-variable">@RequestParam</span>(value = <span class="hljs-string">"filename"</span>, required = false) String filename,
            <span class="hljs-variable">@RequestParam</span>(value = <span class="hljs-string">"days"</span>, required = false) Integer days) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">fileUploadBusinessService</span><span class="hljs-selector-class">.generateDownloadUrl</span>(key, filename, days);
    }

    <span class="hljs-comment">/**
     * 生成 AWS S3 预签名预览 URL
     *
     * @param key 对象键（S3 中的文件路径）
     * @return 预签名预览 URL
     */</span>
    @<span class="hljs-selector-tag">Operation</span>(summary = <span class="hljs-string">"生成 AWS S3 预签名预览 URL"</span>, description = <span class="hljs-string">"生成用于文件预览的预签名 URL"</span>)
    @<span class="hljs-selector-tag">ApiResponses</span>({
            <span class="hljs-variable">@ApiResponse</span>(responseCode = <span class="hljs-string">"200"</span>, description = <span class="hljs-string">"生成成功"</span>,
                    content = <span class="hljs-variable">@Content</span>(schema = <span class="hljs-variable">@Schema</span>(implementation = AjaxResult.class))),
            <span class="hljs-variable">@ApiResponse</span>(responseCode = <span class="hljs-string">"500"</span>, description = <span class="hljs-string">"生成失败"</span>)
    })
    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/aws/preview/url"</span>)
<span class="hljs-comment">//    @PreAuthorize("@ss.hasPermi('file:preview')")</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">AjaxResult</span> <span class="hljs-selector-tag">generatePreviewUrl</span>(<span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"key"</span>) String key) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">fileUploadBusinessService</span><span class="hljs-selector-class">.generatePreviewUrl</span>(key);
    }

    <span class="hljs-comment">/**
     * 删除 AWS S3 文件
     *
     * @param key 对象键（S3 中的文件路径）
     * @return 删除结果
     */</span>
    @<span class="hljs-selector-tag">Operation</span>(summary = <span class="hljs-string">"删除 AWS S3 文件"</span>, description = <span class="hljs-string">"从 AWS S3 删除指定文件"</span>)
    @<span class="hljs-selector-tag">ApiResponses</span>({
            <span class="hljs-variable">@ApiResponse</span>(responseCode = <span class="hljs-string">"200"</span>, description = <span class="hljs-string">"删除成功"</span>,
                    content = <span class="hljs-variable">@Content</span>(schema = <span class="hljs-variable">@Schema</span>(implementation = AjaxResult.class))),
            <span class="hljs-variable">@ApiResponse</span>(responseCode = <span class="hljs-string">"500"</span>, description = <span class="hljs-string">"删除失败"</span>)
    })
    @<span class="hljs-selector-tag">DeleteMapping</span>(<span class="hljs-string">"/aws/delete"</span>)
<span class="hljs-comment">//    @PreAuthorize("@ss.hasPermi('file:delete')")</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">AjaxResult</span> <span class="hljs-selector-tag">deleteFileFromAws</span>(<span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"key"</span>) String key) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">fileUploadBusinessService</span><span class="hljs-selector-class">.deleteFile</span>(key);
    }

    <span class="hljs-comment">/**
     * 检查 AWS S3 文件是否存在
     *
     * @param key 对象键（S3 中的文件路径）
     * @return 是否存在
     */</span>
    @<span class="hljs-selector-tag">Operation</span>(summary = <span class="hljs-string">"检查 AWS S3 文件是否存在"</span>, description = <span class="hljs-string">"检查指定文件是否存在于 AWS S3"</span>)
    @<span class="hljs-selector-tag">ApiResponses</span>({
            <span class="hljs-variable">@ApiResponse</span>(responseCode = <span class="hljs-string">"200"</span>, description = <span class="hljs-string">"检查完成"</span>,
                    content = <span class="hljs-variable">@Content</span>(schema = <span class="hljs-variable">@Schema</span>(implementation = AjaxResult.class))),
            <span class="hljs-variable">@ApiResponse</span>(responseCode = <span class="hljs-string">"500"</span>, description = <span class="hljs-string">"检查失败"</span>)
    })
    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/aws/exists"</span>)
<span class="hljs-comment">//    @PreAuthorize("@ss.hasPermi('file:query')")</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">AjaxResult</span> <span class="hljs-selector-tag">checkFileExists</span>(<span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"key"</span>) String key) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">fileUploadBusinessService</span><span class="hljs-selector-class">.checkFileExists</span>(key);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【NestJs】如何使用Prisma实现@Transactional装饰器开启事务并且跨Service传递]]></title>    <link>https://juejin.cn/post/7605213691910930458</link>    <guid>https://juejin.cn/post/7605213691910930458</guid>    <pubDate>2026-02-11T09:57:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605213691910930458" data-draft-id="7605173538417360906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【NestJs】如何使用Prisma实现@Transactional装饰器开启事务并且跨Service传递"/> <meta itemprop="keywords" content="NestJS"/> <meta itemprop="datePublished" content="2026-02-11T09:57:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="None321"/> <meta itemprop="url" content="https://juejin.cn/user/2663468644966576"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【NestJs】如何使用Prisma实现@Transactional装饰器开启事务并且跨Service传递
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2663468644966576/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    None321
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:57:53.000Z" title="Wed Feb 11 2026 09:57:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在NestJs中我们要开启Prisma事务要这样</p>
<pre><code class="hljs language-ts" lang="ts">    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.$transaction(<span class="hljs-function"><span class="hljs-params">tx</span>=&gt;</span>{
        <span class="hljs-comment">//通过tx传递使用事务 </span>
        tx.<span class="hljs-property">user</span>.<span class="hljs-property">update</span> ... 
        <span class="hljs-comment">//当我这样调用transaction还无法进行事务传递 当然这个可以通过Proxy代理实现 这里就不做演示了</span>
        ts.<span class="hljs-property">$transaction</span>
    })
</code></pre>
<p>传统的事务开启方式非常复杂，而且当我们跨方法时需要重复的去开启事务，导致数据库事务开关导致一定的消耗，并且业务代码看的也不是很舒服。</p>
<pre><code class="hljs language-typescript" lang="typescript">    <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestService</span> {
        <span class="hljs-meta">@Inject</span>(prisma)
        <span class="hljs-keyword">private</span> <span class="hljs-attr">prisma</span>:<span class="hljs-title class_">PrismaService</span>
        <span class="hljs-title function_">updateUser</span>(<span class="hljs-params"/>){
           <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.$transaction(<span class="hljs-function"><span class="hljs-params">tx</span>=&gt;</span>{
               <span class="hljs-comment">//开启事务</span>
               <span class="hljs-comment">//...模拟user中进行了很多操作</span>
               tx.<span class="hljs-property">user</span>.<span class="hljs-property">update</span>...
               tx.<span class="hljs-property">user</span>.<span class="hljs-property">create</span>...
               <span class="hljs-comment">//接着需要在order中执行操作</span>
               <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateOrder</span>()
           
           })
        }
        
        <span class="hljs-title function_">updateOrder</span>(<span class="hljs-params"/>){
            <span class="hljs-comment">//order执行操作必须得重新开启事务</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.$transaction(<span class="hljs-function"><span class="hljs-params">tx</span>=&gt;</span>{
                tx.<span class="hljs-property">order</span>.<span class="hljs-property">update</span> ...
            })
        }
    }
    
</code></pre>
<p>从代码中可以看出我们在跨方法或者跨Service中去执行事务数据库操作需要通过Prisma重复的去开启事务。
我现在期望这样实现事务</p>
<pre><code class="hljs language-typescript" lang="typescript">    <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestService</span> {
        <span class="hljs-meta">@Inject</span>(prisma)
        <span class="hljs-keyword">private</span> <span class="hljs-attr">prisma</span>:<span class="hljs-title class_">PrismaService</span>
        
        <span class="hljs-meta">@Transaction</span>() <span class="hljs-comment">//加入@Transaction()装饰器一键开启事务 并且可跨服务传递</span>
        <span class="hljs-title function_">updateUser</span>(<span class="hljs-params"/>){
               <span class="hljs-comment">//无需手动开启事务 直接使用prisma实例</span>
               <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-property">update</span>...
               <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-property">create</span>...
               <span class="hljs-comment">//接着需要在order中执行操作</span>
               <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateOrder</span>()

        }
        
        <span class="hljs-title function_">updateOrder</span>(<span class="hljs-params"/>){
            <span class="hljs-comment">//直接调用prisma执行</span>
            tthis.<span class="hljs-property">prisma</span>.<span class="hljs-property">order</span>.<span class="hljs-property">update</span> ...
        }
    }
    
</code></pre>
<p>如何实现呢？</p>
<p>最简单的方式是可以通过第三方包<code>nestjs-cls + @nestjs-cls/transactional-adapter-prisma </code>实现，这里通过第三方包实现就不做讲解了 有兴趣可以自己去npm上查看，秉持着学习的心态我想自己去了解如何实现这样的功能。</p>
<p>首先要使用到<code>AsyncLocalStorage</code> 是 Node.js 提供的重要的异步上下文管理工具，<code>AsyncLocalStorage</code> 让上下文像“线程本地变量”（ThreadLocal）一样跟随异步执行上下文自动传播。
让我们出创建第一个文件</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// transaction/transaction-context.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncLocalStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:async_hooks'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span>, <span class="hljs-title class_">Prisma</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/client'</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">PrismaTx</span> = <span class="hljs-title class_">Prisma</span>.<span class="hljs-property">TransactionClient</span>;<span class="hljs-comment">//定义类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">TransactionOptions</span> = { maxWait?: <span class="hljs-built_in">number</span>, timeout?: <span class="hljs-built_in">number</span>, isolationLevel?: <span class="hljs-title class_">Prisma</span>.<span class="hljs-property">TransactionIsolationLevel</span> };
<span class="hljs-keyword">const</span> storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLocalStorage</span>&lt;{ <span class="hljs-attr">tx</span>: <span class="hljs-title class_">PrismaTx</span> }&gt;();<span class="hljs-comment">//创建context 保存事务tx的prisma实例</span>

<span class="hljs-comment">/**
 * 在事务context中执行代码
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> runInTransaction&lt;T&gt;(
  <span class="hljs-attr">prisma</span>: <span class="hljs-title class_">PrismaClient</span>,
  <span class="hljs-attr">fn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;,
  options?: <span class="hljs-title class_">TransactionOptions</span>,
): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
  <span class="hljs-keyword">return</span> prisma.$transaction(<span class="hljs-keyword">async</span> (tx) =&gt; {
    <span class="hljs-keyword">return</span> storage.<span class="hljs-title function_">run</span>({ tx }, fn);
  }, options);
}

<span class="hljs-comment">/**
 * 获取当前事务上下文中的 Prisma TransactionClient
 * 如果不在事务中，返回 null
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCurrentTx</span>(<span class="hljs-params"/>): <span class="hljs-title class_">PrismaTx</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">const</span> store = storage.<span class="hljs-title function_">getStore</span>();
  <span class="hljs-keyword">return</span> store?.<span class="hljs-property">tx</span> ?? <span class="hljs-literal">null</span>;
}
</code></pre>
<p>创建装饰器</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// transaction/transactional.decorator.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SetMetadata</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Prisma</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/client'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TransactionOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./transaction-context'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TRANSACTIONAL_KEY</span> = <span class="hljs-string">'transactional'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">Transactional</span> = (<span class="hljs-params">options: TransactionOptions = {}</span>) =&gt;
  <span class="hljs-title class_">SetMetadata</span>(<span class="hljs-variable constant_">TRANSACTIONAL_KEY</span>, options);
</code></pre>
<p>接下来肯定是要通过拦截器去拦截请求，然后通过Reflect去获取元数据拿到事务的options，最后再通过<code>runInTransaction</code>这个方法去调用就可以了</p>
<p>Interceptor拦截器实现</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// transaction/transaction.interceptor.ts</span>
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">CallHandler</span>,
  <span class="hljs-title class_">ExecutionContext</span>,
  <span class="hljs-title class_">Injectable</span>,
  <span class="hljs-title class_">NestInterceptor</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Reflector</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Observable</span>, <span class="hljs-keyword">from</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">TRANSACTIONAL_KEY</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./transactional.decorator'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../prisma/prisma.service'</span>; <span class="hljs-comment">// 调整路径</span>
<span class="hljs-keyword">import</span> { runInTransaction } <span class="hljs-keyword">from</span> <span class="hljs-string">'./transaction-context'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> reflector: Reflector,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> prisma: PrismaService,
  </span>) {}

  <span class="hljs-title function_">intercept</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">ExecutionContext</span>, <span class="hljs-attr">next</span>: <span class="hljs-title class_">CallHandler</span>): <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-built_in">any</span>&gt; {
    <span class="hljs-keyword">const</span> options = <span class="hljs-variable language_">this</span>.<span class="hljs-property">reflector</span>.<span class="hljs-property">getAllAndOverride</span>&lt;<span class="hljs-title class_">Prisma</span>.<span class="hljs-property">TransactionOptions</span> | <span class="hljs-literal">true</span>&gt;(
      <span class="hljs-variable constant_">TRANSACTIONAL_KEY</span>,
      [context.<span class="hljs-title function_">getHandler</span>(), context.<span class="hljs-title function_">getClass</span>()],
    );

    <span class="hljs-comment">// 没有装饰器 → 直接放行</span>
    <span class="hljs-keyword">if</span> (!options) {
      <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
    }

    <span class="hljs-keyword">const</span> txOptions = options === <span class="hljs-literal">true</span> ? <span class="hljs-literal">undefined</span> : options;

    <span class="hljs-comment">// 用 runInTransaction 包裹整个方法</span>
    <span class="hljs-keyword">const</span> promise = <span class="hljs-title function_">runInTransaction</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>, <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>().<span class="hljs-property">toPromise</span>?.() ?? next.<span class="hljs-title function_">handle</span>();
    }, txOptions);

    <span class="hljs-keyword">return</span> <span class="hljs-title function_">from</span>(promise);
  }
}
</code></pre>
<p>传统的拦截器通过在请求响应的生命周期中获取到元数据执行了我们需要的transaction逻辑，但是我们这个事务的执行本身并不强行依赖HTTP上下文，如果在未开启<code>@Transactional()</code>的情况下依旧会重复的在HTTP生命周期中请求这个拦截器。</p>
<p>Prisma事务开启本身是业务方法级别的需求，且不限于HTTP接口，也可能是定时任务或者消息队列的消费者等等，所以这里我学习到了另外一种Injector的方法，采用的是<code>Module Init + Proxy </code>的方式实现，来自于一个开源项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyikart%2FAiToEarn" target="_blank" title="https://github.com/yikart/AiToEarn" ref="nofollow noopener noreferrer">github.com/yikart/AiTo…</a>
接下来我们完成<code>transaction.injector.ts</code>的实现吧</p>
<p>Injector实现</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common/interfaces'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">InstanceWrapper</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core/injector/instance-wrapper'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">InjectableDec</span>, <span class="hljs-title class_">Logger</span>, <span class="hljs-title class_">OnModuleInit</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MetadataScanner</span>, <span class="hljs-title class_">ModulesContainer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>
<span class="hljs-keyword">import</span> { runInTransaction, <span class="hljs-title class_">TransactionOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./transaction-context'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">TRANSACTIONAL_KEY</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./transactional.decorator'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../prisma.service'</span>
<span class="hljs-comment">/**
 * 事务注入器
 * 在模块初始化时扫描所有带有 <span class="hljs-doctag">@Transactional</span> 装饰器的方法，
 * 并为这些方法注入事务处理逻辑
 */</span>
<span class="hljs-meta">@InjectableDec</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionalInjector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnModuleInit</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-title class_">TransactionalInjector</span>.<span class="hljs-property">name</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">metadataScanner</span>: <span class="hljs-title class_">MetadataScanner</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MetadataScanner</span>()
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> prisma: PrismaService,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> modulesContainer: ModulesContainer,
  </span>) {}

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onModuleInit</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> provider <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getProviders</span>()) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">injectToProvider</span>(provider)
    }
  }

  <span class="hljs-keyword">private</span>* <span class="hljs-title function_">getProviders</span>(): <span class="hljs-title class_">Generator</span>&lt;<span class="hljs-title class_">InstanceWrapper</span>&lt;<span class="hljs-title class_">Injectable</span>&gt;&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">modulesContainer</span>.<span class="hljs-title function_">values</span>()) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> provider <span class="hljs-keyword">of</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">providers</span>.<span class="hljs-title function_">values</span>()) {
        <span class="hljs-keyword">if</span> (provider &amp;&amp; provider.<span class="hljs-property">metatype</span>?.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) {
          <span class="hljs-keyword">yield</span> provider <span class="hljs-keyword">as</span> <span class="hljs-title class_">InstanceWrapper</span>&lt;<span class="hljs-title class_">Injectable</span>&gt;
        }
      }
    }
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">injectToProvider</span>(<span class="hljs-attr">wrapper</span>: <span class="hljs-title class_">InstanceWrapper</span>&lt;<span class="hljs-title class_">Injectable</span>&gt;): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> { metatype } = wrapper
    <span class="hljs-keyword">if</span> (!metatype)
      <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">const</span> prototype = metatype.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
    <span class="hljs-keyword">const</span> methodNames = <span class="hljs-variable language_">this</span>.<span class="hljs-property">metadataScanner</span>.<span class="hljs-title function_">getAllMethodNames</span>(prototype)

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> methodName <span class="hljs-keyword">of</span> methodNames) {
      <span class="hljs-keyword">const</span> method = prototype[methodName]
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isDecorated</span>(method)) {
        <span class="hljs-keyword">const</span> options = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDecoratorOptions</span>(method)
        <span class="hljs-keyword">const</span> wrappedMethod = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">wrapMethod</span>(method, methodName, prototype.<span class="hljs-property">constructor</span>.<span class="hljs-property">name</span>, options)
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">reDecorate</span>(method, wrappedMethod)
        prototype[methodName] = wrappedMethod
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Injected transaction to <span class="hljs-subst">${prototype.constructor.name}</span>.<span class="hljs-subst">${methodName}</span>`</span>)
      }
    }
  }

  <span class="hljs-comment">/**
   * 判断方法是否携带了Transactional装饰器
   * <span class="hljs-doctag">@param</span> target 方法
   * <span class="hljs-doctag">@returns</span> 是否携带了Transactional装饰器
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">isDecorated</span>(<span class="hljs-attr">target</span>: <span class="hljs-built_in">object</span>): <span class="hljs-built_in">boolean</span> { 
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">hasMetadata</span>(<span class="hljs-variable constant_">TRANSACTIONAL_KEY</span>, target)
  }
  
  <span class="hljs-comment">/**
   * 获取携带的Transactional的options
   * <span class="hljs-doctag">@param</span> target 方法
   * <span class="hljs-doctag">@returns</span> Transactional的options
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">getDecoratorOptions</span>(<span class="hljs-attr">target</span>: <span class="hljs-built_in">object</span>): <span class="hljs-title class_">TransactionOptions</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-variable constant_">TRANSACTIONAL_KEY</span>, target)
  }

  <span class="hljs-comment">/**
   * 重新装饰方法
   * <span class="hljs-doctag">@param</span> source 源方法
   * <span class="hljs-doctag">@param</span> destination 目标方法
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">reDecorate</span>(<span class="hljs-attr">source</span>: <span class="hljs-built_in">object</span>, <span class="hljs-attr">destination</span>: <span class="hljs-built_in">object</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadataKeys</span>(source)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> keys) {
      <span class="hljs-keyword">const</span> meta = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(key, source)
      <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">defineMetadata</span>(key, meta, destination)
    }
  }

  <span class="hljs-comment">/**
   * 包装方法
   * <span class="hljs-doctag">@param</span> originalMethod 原方法
   * <span class="hljs-doctag">@param</span> methodName 方法名
   * <span class="hljs-doctag">@param</span> className 类名
   * <span class="hljs-doctag">@param</span> options 选项
   * <span class="hljs-doctag">@returns</span> 包装后的方法
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">wrapMethod</span>(
    <span class="hljs-attr">originalMethod</span>: <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">unknown</span>[]</span>) =&gt;</span> <span class="hljs-built_in">unknown</span>,
    <span class="hljs-attr">methodName</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">className</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">options</span>: <span class="hljs-title class_">TransactionOptions</span>,
  ): <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">unknown</span>[]</span>) =&gt;</span> <span class="hljs-built_in">unknown</span> {
    <span class="hljs-comment">// 创建一个代理对象，用于包装原始方法，实现对方法的拦截和增强</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(originalMethod, {
      <span class="hljs-comment">// 定义代理对象的行为，特别是 apply 方法，用于拦截对原始方法的调用</span>
      <span class="hljs-attr">apply</span>: <span class="hljs-keyword">async</span> (target, thisArg, <span class="hljs-attr">args</span>: <span class="hljs-built_in">unknown</span>[]) =&gt; {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">debug</span>(<span class="hljs-string">`Executing transactional method: <span class="hljs-subst">${className}</span>.<span class="hljs-subst">${methodName}</span>`</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">runInTransaction</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>, <span class="hljs-keyword">async</span> () =&gt; {
          <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">apply</span>(target, thisArg, args) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">unknown</span>&gt;
        }, options);
      },
    })
  }
}
</code></pre>
<p>最后我们修改PrismaService中的get current方法，让在调用this.prisma的时候返回正确实例。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">OnModuleInit</span>, <span class="hljs-title class_">OnModuleDestroy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'prismaClients'</span>;
<span class="hljs-keyword">import</span> { getCurrentTx } <span class="hljs-keyword">from</span> <span class="hljs-string">'./transaction/transaction-context'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrismaService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PrismaClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnModuleInit</span>, <span class="hljs-title class_">OnModuleDestroy</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">onModuleInit</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Prisma连接配置: DATABASE_URL=<span class="hljs-subst">${process.env.DATABASE_URL}</span>`</span>);
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$connect();
    }
    
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">onModuleDestroy</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.$disconnect();
    }

    <span class="hljs-comment">/**
     * 修改获取当前PrismaClient实例方法，支持事务。
     */</span>
    <span class="hljs-keyword">get</span> <span class="hljs-title function_">current</span>(){
        <span class="hljs-keyword">const</span> tx = <span class="hljs-title function_">getCurrentTx</span>();
        <span class="hljs-keyword">if</span>(!tx)<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
        <span class="hljs-comment">// 返回一个 Proxy，让调用自动转发到 tx</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-variable language_">this</span>, {
            <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">symbol</span>, receiver</span>) {
                <span class="hljs-comment">// 如果 tx 有这个方法/属性，优先使用 tx 的（绑定 this 为 tx）</span>
                <span class="hljs-keyword">if</span> (prop <span class="hljs-keyword">in</span> tx) {
                    <span class="hljs-keyword">const</span> value = (tx <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)[prop];
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'function'</span>) {
                        <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">bind</span>(tx);
                    }
                    <span class="hljs-keyword">return</span> value;
                }
                <span class="hljs-comment">// 否则 fallback 到原始 PrismaClient（$connect、$on 等）</span>
                <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, prop, receiver);
            },
            }) <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">PrismaClient</span>, <span class="hljs-string">"$connect"</span> | <span class="hljs-string">"$disconnect"</span> | <span class="hljs-string">"$on"</span> | <span class="hljs-string">"$transaction"</span> | <span class="hljs-string">"$use"</span> | <span class="hljs-string">"$extends"</span>&gt;;
        }
    }

</code></pre>
<p>到这里整体的代码就编写完成了
接下来在PrismaModule中正常导入注册Providers</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Global</span>, <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./prisma.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TransactionalInjector</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./transaction/transactional.injector'</span>;

<span class="hljs-meta">@Global</span>()
<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">PrismaService</span>, <span class="hljs-title class_">TransactionalInjector</span>],
  <span class="hljs-attr">exports</span>:[<span class="hljs-title class_">PrismaService</span>]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrismaModule</span> {}
</code></pre>
<p>测试代码</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span>{
    <span class="hljs-meta">@Injecet</span>(<span class="hljs-title class_">PrismaSerivce</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-attr">prisma</span>:<span class="hljs-title class_">PrismaService</span>;
    
    <span class="hljs-meta">@Transactional</span>({
        <span class="hljs-attr">maxWait</span>:<span class="hljs-number">10</span>,<span class="hljs-comment">//这里我们设置10ms超时</span>
        <span class="hljs-attr">timeout</span>:<span class="hljs-number">10</span>
    })
    <span class="hljs-title function_">updateUser</span>(<span class="hljs-params"/>){
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-property">update</span>... <span class="hljs-comment">//调用更新user方法</span>
    }
}

</code></pre>
<p>通过上述代码测试得到了报错信息 也就是Prisma的事务执行超时报错 也证明我们的事务已经正常开启了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00031cef9d3949ac85b6c789c0b6adf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9uZTMyMQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771408795&amp;x-signature=ov1%2FWsZmt4mMyCV%2F%2FDAIw5bsEcU%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebGL 从零开始：绘制你的第一个3D点]]></title>    <link>https://juejin.cn/post/7605326543687008265</link>    <guid>https://juejin.cn/post/7605326543687008265</guid>    <pubDate>2026-02-11T09:36:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605326543687008265" data-draft-id="7605401415855964210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebGL 从零开始：绘制你的第一个3D点"/> <meta itemprop="keywords" content="前端,WebGL"/> <meta itemprop="datePublished" content="2026-02-11T09:36:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王校长"/> <meta itemprop="url" content="https://juejin.cn/user/2295436010076631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebGL 从零开始：绘制你的第一个3D点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436010076631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王校长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T09:36:05.000Z" title="Wed Feb 11 2026 09:36:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">WebGL程序的两大核心组件</h2>
<p>WebGL程序就像一台精密的机器，需要两个关键部件协同工作才能正常运行：</p>
<p><strong>JavaScript程序</strong> - 负责控制和数据处理</p>
<p><strong>着色器程序</strong> - 负责图形渲染</p>
<p>这两个部分缺一不可，就像汽车需要发动机和方向盘一样。</p>
<h2 data-id="heading-1">从最简单的红点开始</h2>
<p>我们的第一个目标很明确：在屏幕中心绘制一个红色的点，大小为10像素。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfa2408c3b2f44b991d3dcd24fba04c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5qCh6ZW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771407531&amp;x-signature=ioJ4IqCmpKIyDuvRcENWUa5O2mY%3D" alt="ScreenShot_2026-02-11_173444_693.png" loading="lazy"/></p>
<h3 data-id="heading-2">顶点着色器：告诉GPU在哪里画点</h3>
<pre><code class="hljs language-glsl" lang="glsl">void main(){
    // 告诉GPU在裁剪坐标系原点画点
    gl_Position = vec4(0.0, 0.0, 0.0, 1.0);
    // 设置点的大小为10像素
    gl_PointSize = 10.0;
}
</code></pre>
<p>这里用到了GLSL语言的几个重要概念：</p>
<ul>
<li><code>gl_Position</code>是内置变量，用来设置顶点位置</li>
<li><code>gl_PointSize</code>专门控制点的大小</li>
<li><code>vec4</code>是包含4个浮点数的向量容器</li>
</ul>
<h3 data-id="heading-3">片元着色器：告诉GPU用什么颜色画</h3>
<pre><code class="hljs language-glsl" lang="glsl">void main(){
    // 设置像素颜色为红色
    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0); 
}
</code></pre>
<p>注意颜色值的表示方法：</p>
<ul>
<li>WebGL中颜色分量范围是0-1，不是0-255</li>
<li>红色表示为(1.0, 0.0, 0.0, 1.0)</li>
<li>对应CSS中的rgb(255, 0, 0)</li>
</ul>
<h2 data-id="heading-4">完整的HTML结构</h2>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 顶点着色器源码 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"shader-source"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"vertexShader"</span>&gt;</span><span class="javascript">
     <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>){
        gl_Position = <span class="hljs-title function_">vec4</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);
        gl_PointSize = <span class="hljs-number">10.0</span>;
    }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 片元着色器源码 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"shader-source"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"fragmentShader"</span>&gt;</span><span class="javascript">
     <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>){
        gl_FragColor = <span class="hljs-title function_">vec4</span>(<span class="hljs-number">1.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>); 
    }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    
    <span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"canvas"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
</code></pre>
<h2 data-id="heading-5">JavaScript核心代码实现</h2>
<h3 data-id="heading-6">第一步：获取WebGL绘图环境</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取canvas元素</span>
<span class="hljs-keyword">var</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#canvas'</span>);
<span class="hljs-comment">// 获取WebGL上下文（兼容处理）</span>
<span class="hljs-keyword">var</span> gl = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'webgl'</span>) || canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"experimental-webgl"</span>);
</code></pre>
<h3 data-id="heading-7">第二步：创建和编译着色器</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取顶点着色器源码</span>
<span class="hljs-keyword">var</span> vertexShaderSource = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#vertexShader'</span>).<span class="hljs-property">innerHTML</span>;
<span class="hljs-comment">// 创建顶点着色器对象</span>
<span class="hljs-keyword">var</span> vertexShader = gl.<span class="hljs-title function_">createShader</span>(gl.<span class="hljs-property">VERTEX_SHADER</span>);
<span class="hljs-comment">// 将源码分配给着色器对象</span>
gl.<span class="hljs-title function_">shaderSource</span>(vertexShader, vertexShaderSource);
<span class="hljs-comment">// 编译顶点着色器程序</span>
gl.<span class="hljs-title function_">compileShader</span>(vertexShader);

<span class="hljs-comment">// 片元着色器创建过程类似</span>
<span class="hljs-keyword">var</span> fragmentShaderSource = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#fragmentShader'</span>).<span class="hljs-property">innerHTML</span>;
<span class="hljs-keyword">var</span> fragmentShader = gl.<span class="hljs-title function_">createShader</span>(gl.<span class="hljs-property">FRAGMENT_SHADER</span>);
gl.<span class="hljs-title function_">shaderSource</span>(fragmentShader, fragmentShaderSource);
gl.<span class="hljs-title function_">compileShader</span>(fragmentShader);
</code></pre>
<h3 data-id="heading-8">第三步：创建和链接着色器程序</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建着色器程序</span>
<span class="hljs-keyword">var</span> program = gl.<span class="hljs-title function_">createProgram</span>();
<span class="hljs-comment">// 将顶点着色器挂载到程序上</span>
gl.<span class="hljs-title function_">attachShader</span>(program, vertexShader); 
<span class="hljs-comment">// 将片元着色器挂载到程序上</span>
gl.<span class="hljs-title function_">attachShader</span>(program, fragmentShader);
<span class="hljs-comment">// 链接着色器程序</span>
gl.<span class="hljs-title function_">linkProgram</span>(program);
<span class="hljs-comment">// 启用着色器程序</span>
gl.<span class="hljs-title function_">useProgram</span>(program);
</code></pre>
<h3 data-id="heading-9">第四步：执行绘制操作</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 设置清空画布颜色为黑色</span>
gl.<span class="hljs-title function_">clearColor</span>(<span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>);
<span class="hljs-comment">// 用设置的颜色清空画布</span>
gl.<span class="hljs-title function_">clear</span>(gl.<span class="hljs-property">COLOR_BUFFER_BIT</span>);
<span class="hljs-comment">// 绘制点图元</span>
gl.<span class="hljs-title function_">drawArrays</span>(gl.<span class="hljs-property">POINTS</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
</code></pre>
<h2 data-id="heading-10">让点动起来：交互式绘制</h2>
<p>静态点不够有趣，让我们实现点击画布就在点击位置绘制彩色点的功能。</p>
<h3 data-id="heading-11">改进的着色器程序</h3>
<pre><code class="hljs language-glsl" lang="glsl">// 顶点着色器 - 接收外部数据
precision mediump float;
// 接收点在canvas坐标系上的坐标
attribute vec2 a_Position;
// 接收canvas的宽高尺寸
attribute vec2 a_Screen_Size;

void main(){
    // 将屏幕坐标转换为裁剪坐标
    vec2 position = (a_Position / a_Screen_Size) * 2.0 - 1.0; 
    position = position * vec2(1.0, -1.0);
    gl_Position = vec4(position, 0, 1);
    gl_PointSize = 10.0;
}

// 片元着色器 - 接收颜色数据
precision mediump float;
// 接收JavaScript传过来的颜色值
uniform vec4 u_Color;

void main(){
    // 将颜色值转换为WebGL格式
    vec4 color = u_Color / vec4(255, 255, 255, 1);
    gl_FragColor = color; 
}
</code></pre>
<h3 data-id="heading-12">交互式JavaScript实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取着色器变量位置</span>
<span class="hljs-keyword">var</span> a_Position = gl.<span class="hljs-title function_">getAttribLocation</span>(program, <span class="hljs-string">'a_Position'</span>);
<span class="hljs-keyword">var</span> a_Screen_Size = gl.<span class="hljs-title function_">getAttribLocation</span>(program, <span class="hljs-string">'a_Screen_Size'</span>);
<span class="hljs-keyword">var</span> u_Color = gl.<span class="hljs-title function_">getUniformLocation</span>(program, <span class="hljs-string">'u_Color'</span>);

<span class="hljs-comment">// 传递canvas尺寸信息</span>
gl.<span class="hljs-title function_">vertexAttrib2f</span>(a_Screen_Size, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);

<span class="hljs-comment">// 存储点击位置的数组</span>
<span class="hljs-keyword">var</span> points = [];

<span class="hljs-comment">// 绑定点击事件</span>
canvas.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
    <span class="hljs-keyword">var</span> x = e.<span class="hljs-property">pageX</span>;
    <span class="hljs-keyword">var</span> y = e.<span class="hljs-property">pageY</span>;
    <span class="hljs-keyword">var</span> color = {<span class="hljs-attr">r</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()*<span class="hljs-number">255</span>, <span class="hljs-attr">g</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()*<span class="hljs-number">255</span>, <span class="hljs-attr">b</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>()*<span class="hljs-number">255</span>, <span class="hljs-attr">a</span>: <span class="hljs-number">255</span>};
    points.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">x</span>: x, <span class="hljs-attr">y</span>: y, <span class="hljs-attr">color</span>: color });
    
    <span class="hljs-comment">// 清空画布并重新绘制所有点</span>
    gl.<span class="hljs-title function_">clearColor</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1.0</span>);
    gl.<span class="hljs-title function_">clear</span>(gl.<span class="hljs-property">COLOR_BUFFER_BIT</span>);
    
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; points.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-comment">// 传递颜色数据</span>
        gl.<span class="hljs-title function_">uniform4f</span>(u_Color, points[i].<span class="hljs-property">color</span>.<span class="hljs-property">r</span>, points[i].<span class="hljs-property">color</span>.<span class="hljs-property">g</span>, points[i].<span class="hljs-property">color</span>.<span class="hljs-property">b</span>, points[i].<span class="hljs-property">color</span>.<span class="hljs-property">a</span>);
        <span class="hljs-comment">// 传递位置数据</span>
        gl.<span class="hljs-title function_">vertexAttrib2f</span>(a_Position, points[i].<span class="hljs-property">x</span>, points[i].<span class="hljs-property">y</span>);
        <span class="hljs-comment">// 绘制点</span>
        gl.<span class="hljs-title function_">drawArrays</span>(gl.<span class="hljs-property">POINTS</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
    }
});
</code></pre>
<h2 data-id="heading-13">核心知识点总结</h2>
<h3 data-id="heading-14">GLSL语言基础</h3>
<ul>
<li><code>attribute</code>变量：只能在顶点着色器中使用，接收顶点数据</li>
<li><code>uniform</code>变量：可在顶点和片元着色器中使用，接收全局数据</li>
<li><code>varying</code>变量：在顶点着色器和片元着色器间传递插值数据</li>
<li>向量运算：vec2、vec3、vec4等容器类型的运算规则</li>
</ul>
<h3 data-id="heading-15">WebGL API核心方法</h3>
<ul>
<li><code>createShader()</code>：创建着色器对象</li>
<li><code>shaderSource()</code>：提供着色器源码</li>
<li><code>compileShader()</code>：编译着色器</li>
<li><code>createProgram()</code>：创建着色器程序</li>
<li><code>attachShader()</code>：绑定着色器到程序</li>
<li><code>linkProgram()</code>：链接着色器程序</li>
<li><code>useProgram()</code>：启用着色器程序</li>
<li><code>drawArrays()</code>：执行绘制操作</li>
</ul>
<h3 data-id="heading-16">坐标系转换</h3>
<p>从canvas坐标系到裁剪坐标系的转换公式：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">position</span> = (canvas_position / canvas_size) * <span class="hljs-number">2.0</span> - <span class="hljs-number">1.0</span>
</code></pre>
<p>这个转换将浏览器坐标映射到WebGL的标准化设备坐标系(NDC)，其中x、y坐标范围都是[-1, 1]。</p>
<h2 data-id="heading-17">性能优化提示</h2>
<p>直接使用<code>gl.vertexAttrib2f</code>逐个传递数据效率较低。后续章节我们会学习使用缓冲区(Buffer)来批量传递顶点数据，这能显著提升渲染性能。</p>
<p>现在你已经掌握了WebGL的基础绘制技能，准备好迎接更复杂的三角形绘制挑战了吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Visual Studio Code 1.109 版本更新总结（总览）]]></title>    <link>https://juejin.cn/post/7605114266024460339</link>    <guid>https://juejin.cn/post/7605114266024460339</guid>    <pubDate>2026-02-11T07:44:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605114266024460339" data-draft-id="7605135197166633010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Visual Studio Code 1.109 版本更新总结（总览）"/> <meta itemprop="keywords" content="Visual Studio Code"/> <meta itemprop="datePublished" content="2026-02-11T07:44:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只叁木Meow"/> <meta itemprop="url" content="https://juejin.cn/user/231371762837604"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Visual Studio Code 1.109 版本更新总结（总览）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/231371762837604/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只叁木Meow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:44:26.000Z" title="Wed Feb 11 2026 07:44:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>💡 更多技术分享，欢迎访问我的博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsanmu7.com%2F" target="_blank" title="https://sanmu7.com/" ref="nofollow noopener noreferrer">叁木の小屋</a></p>
</blockquote>
<blockquote>
<p><strong>发布日期</strong>：2026年2月4日</p>
<p><strong>主题</strong>：多智能体开发的家园（Home for Multi-Agent Development）</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一句话总结</h2>
<p>VS Code 1.109 是一个里程碑版本，标志着 VS Code 演进为<strong>统一的多智能体开发平台</strong>，核心围绕 AI 智能体的全生命周期管理展开。</p>
<hr/>
<h2 data-id="heading-1">核心更新速览表</h2>

































































<table><thead><tr><th>类别</th><th>核心更新</th><th>关键亮点</th></tr></thead><tbody><tr><td><strong>聊天体验</strong></td><td>Anthropic 思维令牌、Mermaid 图表、Plan Agent</td><td>四阶段工作流、<code>/plan</code> 快捷命令</td></tr><tr><td><strong>会话管理</strong></td><td>智能体类型切换、子智能体并行运行</td><td>本地/后台/云端统一视图、状态指示器</td></tr><tr><td><strong>智能体定制</strong></td><td><code>/init</code> 命令、Agent Skills 正式发布</td><td>组织级说明、技能文件夹管理</td></tr><tr><td><strong>扩展性</strong></td><td>Claude Agent 支持、智能体编排</td><td>MCP Apps、Anthropic Messages API</td></tr><tr><td><strong>优化</strong></td><td>Copilot Memory、外部索引</td><td>非 GitHub 工作区远程索引、并行依赖任务</td></tr><tr><td><strong>安全</strong></td><td>终端沙盒、自动审批规则</td><td>文件/网络访问限制、安全命令白名单</td></tr><tr><td><strong>终端</strong></td><td>Kitty 键盘协议、粘性滚动</td><td>选择性忽略命令、移除 winpty</td></tr><tr><td><strong>编辑器</strong></td><td>括号匹配颜色、双击选择</td><td>幽灵文本虚线下划线、shebang 检测</td></tr><tr><td><strong>工作台</strong></td><td>集成浏览器（预览）</td><td>持久化存储、完整 DevTools、元素发送到聊天</td></tr><tr><td><strong>API</strong></td><td>Quick Input 按钮位置 API、Chat 配置</td><td>模型提供程序配置架构、提示文件 API</td></tr><tr><td><strong>工程</strong></td><td>macOS DMG、Windows 安装布局重设计</td><td>Copilot 扩展弃用、codicons npm 包</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">分篇阅读指南</h2>
<p>本系列共分为 5 篇，涵盖 VS Code 1.109 的所有更新内容：</p>



































<table><thead><tr><th>篇目</th><th>地址</th><th>内容概览</th></tr></thead><tbody><tr><td><strong>第一篇</strong></td><td><a href="https://juejin.cn/post/7605135197166731314" target="_blank" title="https://juejin.cn/post/7605135197166731314">VS Code 1.109 更新解读（一）：聊天体验与会话管理</a></td><td>聊天 UX、智能体会话管理</td></tr><tr><td><strong>第二篇</strong></td><td><a href="https://juejin.cn/post/7605135197166747698" target="_blank" title="https://juejin.cn/post/7605135197166747698">VS Code 1.109 更新解读（二）：智能体定制与扩展性</a></td><td>智能体定制、扩展性、编排</td></tr><tr><td><strong>第三篇</strong></td><td><a href="https://juejin.cn/post/7605401415855259698" target="_blank" title="https://juejin.cn/post/7605401415855259698">VS Code 1.109 更新解读（三）：智能体优化与安全</a></td><td>Copilot Memory、终端沙盒、安全与信任</td></tr><tr><td><strong>第四篇</strong></td><td><a href="https://juejin.cn/post/7605173538417442826" target="_blank" title="https://juejin.cn/post/7605173538417442826">VS Code 1.109 更新解读（四）：终端、编辑器与工作台</a></td><td>终端增强、编码与编辑器、工作台生产力</td></tr><tr><td><strong>第五篇</strong></td><td><a href="https://juejin.cn/post/7605157203591282715" target="_blank" title="https://juejin.cn/post/7605157203591282715">VS Code 1.109 更新解读（五）：API 与工程改进</a></td><td>扩展 API、工程改进、值得注意的修复</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-3">精简分项总结</h2>
<h3 data-id="heading-4">一、聊天体验（Chat UX）</h3>





































<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>Anthropic 思维令牌</td><td>显示模型推理过程，支持详细/紧凑两种风格</td></tr><tr><td>Mermaid 图表</td><td>聊天中渲染交互式流程图、序列图</td></tr><tr><td>提问工具</td><td>Agent 可主动提出澄清问题</td></tr><tr><td>Plan Agent</td><td>四阶段工作流：发现→对齐→设计→完善</td></tr><tr><td>上下文窗口指示器</td><td>实时显示令牌使用情况</td></tr><tr><td>终端命令输出增强</td><td>语法高亮、工作目录、流式输出</td></tr><tr><td>新主题实验</td><td>VS Code Light/Dark 实验性主题</td></tr></tbody></table>
<h3 data-id="heading-5">二、智能体会话管理</h3>

































<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>类型切换器</td><td>本地/后台/云端智能体一键切换</td></tr><tr><td>状态指示器</td><td>显示进行中/未读/需关注的会话</td></tr><tr><td>子智能体并行</td><td>显著加快多任务处理速度</td></tr><tr><td>搜索子智能体</td><td>隔离循环中迭代优化搜索</td></tr><tr><td>云智能体</td><td>支持模型选择、第三方智能体</td></tr><tr><td>后台智能体</td><td>每轮自动提交、支持附加图片</td></tr></tbody></table>
<h3 data-id="heading-6">三、智能体定制</h3>

































<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td><code>/init</code> 命令</td><td>根据代码库自动生成工作区说明</td></tr><tr><td>Agent Skills</td><td>正式发布，默认启用</td></tr><tr><td>组织级说明</td><td>GitHub 组织范围的自定义指导</td></tr><tr><td>调用控制</td><td><code>user-invokable</code>、<code>disable-model-invocation</code> 等属性</td></tr><tr><td>多模型支持</td><td>指定多个模型作为回退选项</td></tr><tr><td>定制诊断</td><td>右键查看所有加载的定制文件状态</td></tr></tbody></table>
<h3 data-id="heading-7">四、智能体扩展性</h3>





























<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>智能体编排</td><td>多个专业智能体协作完成复杂任务</td></tr><tr><td>Claude Agent</td><td>使用 Anthropic 官方 SDK，预览中</td></tr><tr><td>Anthropic 增强</td><td>Messages API 交错思考、工具搜索</td></tr><tr><td>MCP Apps</td><td>服务器显示丰富交互式 UI</td></tr><tr><td>自定义注册表</td><td>支持私有/替代包注册表</td></tr></tbody></table>
<h3 data-id="heading-8">五、智能体优化</h3>

























<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>Copilot Memory</td><td>跨会话存储和检索重要信息</td></tr><tr><td>外部索引</td><td>非 GitHub 工作区远程语义索引</td></tr><tr><td>读取工作区外文件</td><td>获得许可后可访问外部文件</td></tr><tr><td>性能改进</td><td>大型聊天更流畅、并行依赖任务处理</td></tr></tbody></table>
<h3 data-id="heading-9">六、智能体安全与信任</h3>





















<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>终端沙盒</td><td>限制文件系统/网络访问（macOS/Linux）</td></tr><tr><td>终端生命周期</td><td><code>timeout</code>、<code>awaitTerminal</code>、<code>killTerminal</code> 工具</td></tr><tr><td>自动审批</td><td>安全命令如 <code>npm</code>、<code>docker</code> 自动审批</td></tr></tbody></table>
<h3 data-id="heading-10">七、终端增强</h3>

























<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>选择性忽略粘性滚动</td><td>可自定义忽略的命令列表</td></tr><tr><td>移除 winpty</td><td>不再支持 Win10 1809 之前版本</td></tr><tr><td>Kitty 键盘协议</td><td>修复击键编码限制，实验性</td></tr><tr><td>Win32 输入模式</td><td>针对 Windows 和 ConPTY 优化，实验性</td></tr></tbody></table>
<h3 data-id="heading-11">八、编码与编辑器</h3>

































<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>括号匹配前景色</td><td>可自定义匹配括号的文本颜色</td></tr><tr><td>双击选择内容</td><td>括号或字符串内容快速选择</td></tr><tr><td>TypeScript 重命名建议</td><td>输入覆盖时也能触发重命名建议</td></tr><tr><td>幽灵文本可见性</td><td>短建议显示虚线下划线</td></tr><tr><td>代码段文件模式</td><td><code>include</code>/<code>exclude</code> 控制出现范围</td></tr><tr><td>shebang 检测</td><td>改进 <code>/usr/bin/env</code> 支持</td></tr></tbody></table>
<h3 data-id="heading-12">九、工作台与生产力</h3>

































<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>集成浏览器（预览）</td><td>完整浏览器体验，支持 DevTools</td></tr><tr><td>恢复编辑器控制</td><td>可选择是否恢复上次打开的编辑器</td></tr><tr><td>高级设置</td><td>始终显示高级设置选项</td></tr><tr><td>拖放导入配置文件</td><td><code>.code-profile</code> 文件拖放导入</td></tr><tr><td>问题过滤</td><td>按来源过滤诊断信息</td></tr><tr><td>无障碍改进</td><td>屏幕阅读器支持增强</td></tr></tbody></table>
<h3 data-id="heading-13">十、扩展与 API</h3>





























<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>Quick Input 按钮</td><td>位置 API、切换 API 正式确定</td></tr><tr><td>Chat Model Provider</td><td>配置架构声明 API</td></tr><tr><td>Chat Prompt Files</td><td>动态聊天资源提供 API</td></tr><tr><td>Chat Item Controller</td><td>新的基于控制器的 API</td></tr><tr><td>Portable Mode 检测</td><td><code>env.isAppPortable</code> 属性</td></tr></tbody></table>
<h3 data-id="heading-14">十一、工程改进</h3>





























<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>macOS DMG 镜像</td><td>原生拖放安装体验</td></tr><tr><td>Windows 安装重设计</td><td>版本化包路径，提高更新可靠性</td></tr><tr><td>避免连续更新</td><td>使旧更新无效，应用新更新</td></tr><tr><td>Copilot 扩展弃用</td><td>功能整合到 Copilot Chat 扩展</td></tr><tr><td>codicons npm 包</td><td>从 <code>@vscode/codicons</code> 包消费</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Repo 撤销当前修改]]></title>    <link>https://juejin.cn/post/7605114376803729448</link>    <guid>https://juejin.cn/post/7605114376803729448</guid>    <pubDate>2026-02-11T07:51:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605114376803729448" data-draft-id="7605114376803713064" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Repo 撤销当前修改"/> <meta itemprop="keywords" content="C++,Android"/> <meta itemprop="datePublished" content="2026-02-11T07:51:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sTone87375"/> <meta itemprop="url" content="https://juejin.cn/user/2946346894764584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Repo 撤销当前修改
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2946346894764584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sTone87375
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:51:42.000Z" title="Wed Feb 11 2026 07:51:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>repo</code> 提供了快速撤销所有仓库修改的命令，以下是几种常用方式：</p>
<hr/>
<h2 data-id="heading-0">一键撤销所有修改</h2>
<h3 data-id="heading-1">方式一：最常用（推荐）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 撤销所有仓库的所有修改（包括暂存区和工作区）</span>
repo forall -c <span class="hljs-string">'git reset --hard HEAD &amp;&amp; git clean -fdx'</span>
</code></pre>





















<table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td><code>repo forall</code></td><td>对所有仓库执行命令</td></tr><tr><td><code>git reset --hard HEAD</code></td><td>强制回退到最新提交，丢弃所有修改</td></tr><tr><td><code>git clean -fdx</code></td><td>删除所有未跟踪的文件和目录</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-2">方式二：分步执行（更安全，可先检查）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 先查看哪些仓库有修改</span>
repo status

<span class="hljs-comment"># 2. 只撤销特定仓库（示例：frameworks/base）</span>
repo forall frameworks/base -c <span class="hljs-string">'git reset --hard HEAD'</span>

<span class="hljs-comment"># 3. 撤销所有仓库</span>
repo forall -c <span class="hljs-string">'git reset --hard HEAD'</span>
repo forall -c <span class="hljs-string">'git clean -fdx'</span>
</code></pre>
<hr/>
<h3 data-id="heading-3">方式三：保留未跟踪文件（仅撤销修改）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只撤销跟踪文件的修改，保留新建的文件</span>
repo forall -c <span class="hljs-string">'git checkout -- .'</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">对比：不同清理强度</h2>






























<table><thead><tr><th>命令</th><th>效果</th><th>适用场景</th></tr></thead><tbody><tr><td><code>git checkout -- .</code></td><td>撤销跟踪文件的修改</td><td>保留新文件，只恢复旧文件</td></tr><tr><td><code>git reset --hard HEAD</code></td><td>回退到 HEAD，丢弃所有提交</td><td>彻底回退到最新提交</td></tr><tr><td><code>git clean -fd</code></td><td>删除未跟踪的文件/目录</td><td>清理编译生成的文件</td></tr><tr><td><code>git clean -fdx</code></td><td>删除未跟踪文件 + 忽略的文件</td><td><strong>最彻底清理</strong>（推荐）</td></tr></tbody></table>
<blockquote>
<p><code>-f</code> = 强制，<code>-d</code> = 包含目录，<code>-x</code> = 包含 <code>.gitignore</code> 忽略的文件</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">常用组合命令</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 完整清理（最常用）</span>
repo forall -c <span class="hljs-string">'git reset --hard HEAD &amp;&amp; git clean -fdx'</span>

<span class="hljs-comment"># 简写形式</span>
repo forall -c <span class="hljs-string">'git reset --hard &amp;&amp; git clean -fdx'</span>

<span class="hljs-comment"># 清理后重新同步</span>
repo forall -c <span class="hljs-string">'git reset --hard HEAD &amp;&amp; git clean -fdx'</span> &amp;&amp; repo <span class="hljs-built_in">sync</span> -c
</code></pre>
<hr/>
<h2 data-id="heading-6">注意事项</h2>





















<table><thead><tr><th>⚠️ 警告</th><th>说明</th></tr></thead><tbody><tr><td><strong>不可恢复</strong></td><td><code>reset --hard</code> 和 <code>clean -fdx</code> 删除的文件<strong>无法找回</strong></td></tr><tr><td><strong>先备份</strong></td><td>如有重要修改，先 <code>repo diff</code> 导出补丁</td></tr><tr><td><strong>子模块</strong></td><td>如需清理子模块，加 <code>--recursive</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">导出修改（清理前备份）</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 导出所有修改到补丁文件</span>
repo diff &gt; my_changes.patch

<span class="hljs-comment"># 之后可以重新应用</span>
git apply my_changes.patch
</code></pre>
<hr/>
<p><strong>总结</strong>：日常开发最常用的是：</p>
<pre><code class="hljs language-bash" lang="bash">repo forall -c <span class="hljs-string">'git reset --hard HEAD &amp;&amp; git clean -fdx'</span>
</code></pre>
<p>一键回到干净状态，然后重新 <code>repo sync</code>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[「2025 年终总结」在所有失去的人中，我最怀念我自己]]></title>    <link>https://juejin.cn/post/7605174711181410367</link>    <guid>https://juejin.cn/post/7605174711181410367</guid>    <pubDate>2026-02-11T08:03:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605174711181410367" data-draft-id="7605142381152747583" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「2025 年终总结」在所有失去的人中，我最怀念我自己"/> <meta itemprop="keywords" content="后端,前端,年终总结"/> <meta itemprop="datePublished" content="2026-02-11T08:03:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Coredump"/> <meta itemprop="url" content="https://juejin.cn/user/1654082381026734"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「2025 年终总结」在所有失去的人中，我最怀念我自己
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1654082381026734/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Coredump
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:03:24.000Z" title="Wed Feb 11 2026 08:03:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 2026 的开始，我并没有许下什么新年愿望，似乎每一年都没有，但每一年都会经历很多难忘的事情。</p>
<p>这一年终究要过去了，我对 2025 的唯一感觉就是：<strong>年费会员快要到期了，该交钱了</strong>。</p>
<p>今年比往年要好很多，烟花凌空绽放，整座城市隆隆作响，极尽所能地宣告新年的到来，往年只有电视机里主持人带着职业假笑，高声呐喊这的倒计时，现在打开窗户，迎面扑来的是久违的焰火气息，让我想起遥远的过去。</p>
<p>尤记得初春，微雨悄然而至，零星的雨滴中，傍晚树下自行车的铃声随风轻轻荡漾，街角的灯光微黄，宛如一位老友向我低语，有些东西，永远的遗留在了过去。可能是在留在了初高中，或者本科，亦或者是研究生，无从知晓。</p>
<p>那时西边红霞满天，我却只顾东行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94923f296f1a4349915c66b32dcd8702~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=e8QUaTPtrHp0mKj9Evev0LCMBso%3D" alt="7623766c8e19a6e0cbd1497c97a4b53e" loading="lazy"/></p>
<h2 data-id="heading-0">#01 夏</h2>
<p>暑期实习挺不顺利的，人很丧，没自信，没目标，也错过了很多机会...</p>
<p>想回到暑期前重新开始，但没办法，回不去了，这就是人生，只有错过点什么，你才学得会珍惜</p>
<p>就好像我这辈子也回不到大一大二的学习状态一样，或者说，人这一生，都不能走回头路</p>
<p>很多年来，我一直持续在问自己一个问题，怎么就变成这样了呢？</p>
<p>最近，这个问题变成了，害，那又能有什么办法呢 😮‍💨</p>
<p>暑期最有希望也是最想去的华子也泡死在池子里了，那个组的方向我是真感兴趣，可惜最后还是没能等来 offer。</p>
<p>看到一个北大的哥们，比我晚入池，过几天就开奖了，HR 和我说，或许这就是北大的魅力吧。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49386daf91f5446c97fc89ed6ce84156~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=Zw3Ep4MrXstP3Qcpvvf22%2BERlhI%3D" alt="image-20250628032513786" loading="lazy"/></p>
<p>也不知道为什么，这些年，身边的人总会有种觉得我很厉害的错觉，拜托，我要是真厉害，我还用发愁这些毕业、就业的事么，这样我就不用吃生活的苦了</p>
<p>有时候就觉得自己活得很荒谬，三天两头垂头丧气跟失恋似的</p>
<p>朋友问我怎么情绪不对，我总不能告诉他最近暑期挂麻了，看不到未来吧</p>
<p>突然想明白了为什么互联网公司互相称呼同学，国企互相称呼老师，<strong>因为同学会毕业，早晚而已</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fd5898f6d7840e1b3b97e8c242c60a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=efkFDs%2FM8ceRr8HxPtS0MTQj8NA%3D" alt="94628a820e12dc46f30efd54d788a640" loading="lazy"/></p>
<p><strong>这并不是一份多么值得让人羡慕和追逐的工作</strong></p>
<p><strong>在这里，人也并没有太多的时间想以前和以后</strong></p>
<p>那段颓废在宿舍刷视频的时间，经常刷到蜡笔小新和海绵宝宝，不得不说在那个年代，做得是真好</p>
<p>小学的时候是最应该看蜡笔小新的时候</p>
<p>高中的时候是最应该看斗破苍穹的时候</p>
<p>但我研究生的时候才开始沉迷这俩玩意</p>
<p>不过仔细一想，我现在和高中时候确实有点不一样了，比如高中时候我玩英雄联盟宁死不投，现在我看打不过了 15 分钟就上票了，不能让对面虐菜爽</p>
<p><strong>能打过我的人，我不给他们打</strong> ...</p>
<p>人总应该是有点变化的，但我最近又有些新的理解了，成长是一件很难的事，它甚至意味着从头去修改你的一部分人生意义</p>
<p>打个比方：你连体重都控制不了，怎么能控制自己的人生呢？</p>
<p>朋友说没办法，现在大伙都找着了工作，体重确实不好减</p>
<p>真不好减，最近东子、团子和阿里打外卖价格战，快给我喝出糖尿病了</p>
<p>暑期有个好朋友跑北京实习了，还有一个去了杭州，读书时哥几个总是经常打哈哈，不过一到上班，感受又不一样了</p>
<p>出发前几天，我说了一句“今日一别，小半年又见不到了，不过咱们的学生生涯好像也就一年多了”，他们没说话，也许是我们经历这寻常的分别太多了，本来早就习惯了，这时候突然来了个人对你说：</p>
<p>嘿，你已经和这么多人走散了呀</p>
<p>大多数人分开后就不会再见了，而有些人或许还有再见的机会</p>
<p>回忆会陪你一生，即使再模糊，你还是忘不掉</p>
<p><strong>聚散离合，此乃常态，你要习惯</strong></p>
<p>纵观个人的命运，当然要靠自我奋斗，但也要考虑到历史的行程，但不幸的是，现在历史的进程并不乐观。</p>
<p>在比较小的时候，大约就是初中高中吧，我对自己人生结果充满幻想和期待。但慢慢长大之后，方才意识到生活是如此复杂，我不得不学着对内心的期望放手，曾经的梦想在残酷的现实面前变得褪色。慢慢发现有些事并不是一件需要被解决的事情，而是一件需要被接受的事情，或者说，绝大多数的事情，都只是需要接受的事情，你解决不了。</p>
<p>比如在地球 online 度过的这二十几年来看，改变的话起码要拿年来衡量，或者十年来衡量。</p>
<p>此时，怜悯自己显得很重要，或许你可以对自己说“我也想要做得更好”以及“就让它这样吧，其实这样也好”。</p>
<p>是的，我已经做得足够好了，因为至少现在我还爱着自己｡</p>
<h2 data-id="heading-1">#02 秋</h2>
<p>其实，我从来没想过要如何准备才能在秋招拿到大厂的 offer，或是白菜，或是 SP、SSP</p>
<p>我一直以来去实习，一是想顺道去别的城市看一看，二来，也是一直都想真正的写出一些好的代码，被重视的代码，听起来很理想化，但这也让我阴差阳错的实习了不少段</p>
<p><strong>在我过往的十年中，凡是我努力追逐的事，往往都无法实现，而那些真正实现的，其实都是意料之外</strong></p>
<p>所以我觉得如果一件事有 100% 的把握，就没有去做的兴致了</p>
<p>🧑‍💻面试官：这就是你笔试只做出来一半的原因吗？</p>
<blockquote>
<p>后来看到个段子，很后悔没给面试官发：</p>
<p>“这代码我有三不写”</p>
<ul>
<li>第一：不能复制的我不写，因为别人的轮子写好了我干嘛不用</li>
<li>第二：不让我用 ChatGPT "辅助"的我不写，因为基础的东西我都会，写了没意义</li>
<li>第三：太难写的我不写，因为我还没有到那个境界，写不明白</li>
</ul>
</blockquote>
<p>现实就是这么残酷，还没来得及从暑期实习的失落中走出来，秋招就开始了，比 emo 更难受的事情是，不能 emo 太久。</p>
<p>朋友说，当一个人过得不好时，才会怀念过去。难怪秋天刚开始，我就已经在怀念夏天了。</p>
<blockquote>
<p>这过日子就是问题叠着问题，我唯一能做的，就是迎接这些问题。  ——《士兵突击》</p>
</blockquote>
<p>几十年前，似乎呢群领图灵奖的巨佬总会在领奖的时候很自豪的说，我是一名程序员</p>
<p>但现在提起程序员，我总会想到 CSDN 上那只秃头虚弱无力的猿猴趴在电脑前，用巨大的手敲打着键盘</p>
<p>所以我很不喜欢 CSDN，当然 CSDN 也确实做的很烂，也算没有辜负我的感情</p>
<p>我没那么喜欢互联网，互联网是一种很割裂的存在，特别是在国内，比如互联网的 OKR，很有意思的是，在互联网 OKR 本来就是要完不成的，如果有一天你完成了你的 OKR，不是说你超出预期，而是说明你的 OKR 制定的有问题</p>
<p>我很想说这个行业病了，但其实我也改变不了啥，唯一改变的就是工作越来越难找了，同龄人之间要更卷了而已</p>
<p>没有乌托邦，只有维也纳在等我们</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d0518cc58074c2fad7013ce556698ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=wh0RW4svuXR0GhpK5HMKGCJQeIM%3D" alt="Screenshot 2025-08-10 at 15.42.18" loading="lazy"/></p>
<p>但我喜欢编程，我就想工作得能开心点，从来没想过在互联网待一辈子，<strong>而且即使我想，我的老板可能也不想</strong></p>
<p>面试很短，这几十钟其实是看不出来我的优点的，我每次面完都感觉没有发挥得尽兴，没有展示出来给面试官最好的一面</p>
<p>但我的缺点还是一览无余的</p>
<p>有一次面 HR 面的时候，HR 让我给一个词来形容自己，我说的是重感情</p>
<p>HR 说第一次见到这样的回答，让我举个例子</p>
<p>我想了想，说如果你司招我，那我会先考虑你司</p>
<p>也不知道 HR 满不满意这个回答</p>
<p>想起来本科的老学长，从闲鱼跳去了美团，换了个 base，最近经常加班，有人问是为了什么</p>
<p>学长说是为了爱情，真好，那时候有那么一瞬间，我很羡慕，似乎这一切都和技术没有关系，与世俗的荣誉，权力都没有关系</p>
<p><strong>我喜欢纯粹的东西，面试也是</strong></p>
<p>我如果觉得一个面试官不真诚，我就不会去这家公司，如果我有选择的话</p>
<p>以前觉得做选择时兴趣没有那么重要，但现在看来，那一点平日里微不足道的热爱，会成为在动摇时至关重要的那一份权重</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e7e3c7c9f94a17ba8327556ffcb6a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=oq6Fe%2FO4Ot6XskJTJyYXBzvxbqo%3D" alt="image-20260206171454503" loading="lazy"/></p>
<p>有时候想毕业直接回到老家，又觉得辜负了自己的初心和一身技术</p>
<p>朋友说不对，<strong>你现在没啥技术，谈不上辜负</strong></p>
<p>说的也对，走一步看一步算了😄</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5aa37161c8e40f4af5c03a57b00f122~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=dgmyWhfkt2dA31J3IC5q1lgGi00%3D" alt="img" loading="lazy"/></p>
<p>不过程序员有一大悲哀就是，成为了程序员就会只把自己当成程序员，因为身在这个环境中，但其实如<strong>果跳出这个环境，发现还是正常生活的人多</strong>。</p>
<p>计算机是严格理性与规范的学科，但我觉得也很浪漫，我们穷尽所有去提高技术，无论是设计模式，还是渐渐的模块化，微服务化，容器化，<strong>都是为了在未来一天，我们可以更好的被取代</strong>，这个工作，在一开始，便注定了悲壮和浪漫。</p>
<p>但有时我会想，这个行业，值不值得我投入如此的热忱，我是个没有梦想也能生存的人，高中的朋友总喜欢找一个梦想中的学校，一个梦想中追赶的人，一个梦想中的行业。但我这些都没有，朋友总觉得我是靠意志力撑过高三那段艰苦的岁月，其实不是，有没有梦想对我来说并不是那么重要。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c44abc56ec824475b0394da7c65bfdeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=fZzpUaq6YInt0Ckh%2BOLEj1QA%2FTc%3D" alt="img" loading="lazy"/></p>
<p>朋友说，假设阳的挂掉一半，全国会失去大概 50% 的人口，不过很快又会恢复如初（生物小知识嗷：种群数量达到环境容纳量一半，即 K / 2 时，种群的增长速率最大），最终无数人的喜怒哀乐，生死离别，成为历史书上的轻如鸿毛的一笔，无论描写的多么惨绝人寰，也只是一笔罢了，而地球上所有惊天动地的大事，也不及宇宙中的一粒尘埃。</p>
<p>有时候在想生命的意义是什么，我想不明白，就像高三老师问我的梦想一样，问我想要当一个什么职业，成为一个什么样的人，我说我不知道，但一定不是以后拿 20w 年薪，30w 年薪，50w 年薪或者 100w 年薪。</p>
<p>因此不想卷了，是因为没有了卷的动力，其实最终不就是为了拿一份高薪的工作，我连对这个结果都没了兴致，又何谈过程，倒不是懒得奋斗，只不过什么时候奋斗渐渐的成了一种贬义词，我只是觉得途中的代价太大，不只是我一个人付出的，而是和我的朋友们一同付出的。</p>
<p><strong>无论是什么样的结果，我都觉得难以配得上这一路走来的失去</strong></p>
<p><strong>人行走江湖，就是不断的相遇和失去，第一次相遇是自己的生命，最后一次失去也是，有始有终</strong></p>
<p>我已经不喜欢再和别人卷了，但是到了一定程度后，身在其中，由不得我，不过，也算是一种磨练心境吧，倒也未必不是好事。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3997647fdc5748358f0b6dc09769e320~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=NVxcGWeZCOcs78mLmIwx0BZIggI%3D" alt="Screenshot 2025-08-10 at 15.37.42" loading="lazy"/></p>
<p>所以生命的意义是什么，我不知道，但是我会期待下一次和朋友相遇，在大学中遇到新的朋友，新的乒乓球友，我会和以前一样期待，但是不会再像以前一样严格规划我的人生了，比如某个时间点非做某件事不可，非要达到某个成就不可。</p>
<p>在学校的时候，如果不是很忙我就喜欢到外面去吃个鸡锅，如果忙的话就推到明天去吃，明天忙就推到后天，<strong>人总是寄希望于后来，也习惯把这辈子没有得到的人和事寄予到下辈子，总会说我下辈子要怎样怎样。可如果这辈子就是你上辈子说的下辈子，那怎么办呢</strong>？</p>
<p>所以我现在选择想吃鸡锅的时候就直接去吃😋</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11c3affdfcf548719d52c7bcf2aea815~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=mvvcM4s8LVMYwPjwDCrENrTLQMA%3D" alt="image-20260206182133446" loading="lazy"/></p>
<p>那我会呆在哪里呢？HR 也问过我这个问题。</p>
<p>我说大概是厦门吧，我的爱人、挚友都在那里，或者是在那里陪伴过我一段很长很长的时间，比我在杭州西安待的时间加起来还要长很多</p>
<p>面试官笑得有些深意</p>
<blockquote>
<p>几年后被末尾淘汰的那一天，一切都将作废，之前的加班作废，之前从池子中挣扎出来的惊喜作废，之前的领导同事作废，之前的薪资待遇也作废，鼠标也会作废，键盘也会作废，所有的承诺也统统作废。从那一天开始，我不再需要电脑，不再需要八股，我的人生不再有 hello world。我知道是秋招那年的那场大雪覆盖了我前半生的荒唐，覆盖了我本科的学历，我和 985 硕一起进入阿里，我仿佛从其中看到了希望，但生活在无边的大雪中又何尝不是一种荒唐，当我真正走出这片大雪后，我肚子有些饿了，此时我才意识到，原来码农烧烤才是人生的归属。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/898b60f4917546b08c17f4e9c4476c50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=rQP92X569EX9PC33lxHXAc3oJTs%3D" alt="IMG_8164" loading="lazy"/></p>
<p>其实我也经常黑厦门的，我很难喜欢上某个城市，比起城市的高低贵贱，电子博弈，我更在意的是我与谁一起经历过什么，到过哪里，见过哪里的风景</p>
<p>我经常说厦门那地方，典型的工资低，物价高</p>
<p>朋友说他不是本地人，每次买海鲜都感觉买的很贵很贵，听厦大的学长说去码头买能便宜很多</p>
<p>我说不是，码头有一定概率买到新鲜的，而且很难买到便宜的</p>
<p>为什么说有概率买到新鲜的，因为那海鲜，你不清楚是刚从海里拉上来的，还是昨天搁市场溜了一圈又拉回去的，反正在人看来，都是刚从船上拉下去，带着新鲜的海水和被折腾的半死不活的鱼</p>
<p>至于价格，人们一般都会吹鼓自己的是野生的，众所周知的道理，野生的更贵，<strong>也没有手段证明它是不是真的野生鱼，除了价格</strong></p>
<h2 data-id="heading-2">#03 厦</h2>
<p>读了好多年书，如果能顺利毕业的话我就要毕业了，<strong>这话看起来没什么信息量，和我读的硕士一样</strong>。</p>
<p>看树洞有人问保研和考研哪个更辛苦，我不用点开都知道评论区铁定开战了</p>
<p>一个老哥说的很有意思，差点看破防了</p>
<p><strong>读研更辛苦</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/507e271cdd05427db7b53d329c40b117~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=kmb34zq22PDdqFjfiQSspj5bAXA%3D" alt="b1aa7170df5fcb1ed7046ec6c77874fe" loading="lazy"/></p>
<p>记得有一天发研究生补助的时候我还在和朋友聊天</p>
<p>朋友说他感觉人生只剩下了银行卡里的一串串数字，收入和支出，感觉像是把灵魂卖给了社会，照镜子的时候感觉双眼都变得浑浊了</p>
<p>我看了眼屏幕里那一堆减号里面的醒目的“➕600”，还是国家赏饭，我应该是肉身和灵魂都卖给了学校，还是那种 19 世纪美国南方黑哥摘棉花的价格</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb09d2d1fbfb494aac60e52c3f88c57f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=HHHnK1cGSPsU4ekRXXyye1yRw1g%3D" alt="IMG_5800" loading="lazy"/></p>
<p>和朋友闲聊，如果能再选一次的话我一定不会读研，哈哈</p>
<p>人就是这样，总会在某个时期觉得自己曾经做的事情不正确，说不定再过几年我又觉得现在做的不正确了</p>
<p>不过话说回来，当年觉得自己能保研可厉害了，现在想想就和网上那种看着小时候一面墙的奖状一样，叹息之墙</p>
<p>人还是不要美化从未走过的那条路，不然就会一直纠结和后悔，然后发现这辈子然后很快就过去了</p>
<p>也慢慢觉得自己老了，因为回过头看，发现自己已经配不上过去的自己了</p>
<p>如果在当年知道未来是这样，或许根本撑不过高考那段时光</p>
<p>多年之后，我又梦到那天，画面遥远，仿佛回到高考那一天</p>
<p>感觉，稍微有点生不逢时罢了</p>
<p>想起来前段时间公司宣讲，说我们赶上了一个很好的时代，因为有 AI，可是 AI 并没有发挥它应有的作用，并没有让工作量减少，工作时长减少，也没有降低生活成本，房价物价，看病还是一样昂贵，大家的压力也都还是很大，甚至更焦虑了，我们并没有因此变得更幸福</p>
<p>长期来讲，我很看好 AI，但此时此刻，并不觉得这是一个多么好的时代，即使见证了从传统 CV、NLP 到大模型的蜕变。大模型发展得太快了，还记得 22 年刚出 GPT-3.5 的时候，有人感慨涌现就像宇宙给的礼物一样神奇，现在已经没有人再发出这种感慨了，默认大模型就存在和人类差不多甚至更强的智力了，没有上古时期 NLP 用 BERT 胡言乱语的折磨</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1677b05db35482cbff65058ee3ae914~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=RhB9cz8cw7ORToR4TQIta0vvMKA%3D" alt="33d3a6e6a7db04a50aead8040afc78b1" loading="lazy"/></p>
<p>想起个很好笑的事，以前研究生方向不是 CV 就是 NLP，现在 CV 还有点，感觉 NLP 已经绝迹了，虽然大模型也算是一种 NLP 吧，但已经没有哪个老师招生的时候会给你说：同学，我的研究方向是 NLP 🤣</p>
<p>现在已经到 AI Agent 时代了，国内外的 AI 产品层出不穷抢占市场，也不得不感叹国内 AI 大战的朴素，一代人有一代人的鸡蛋要领</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aed3c4a7a6b64877b33771be93454380~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=NJiBUua6zd%2BhRyllZLoh0GLjrkk%3D" alt="140c831cdcc83abd3e65bf054a050db3" loading="lazy"/></p>
<p>感觉我们的世界对慢节奏的人很不友好，那种田园牧歌的时代早就一去不复返了。我曾经对科研的憧憬完全来自于牛顿和苹果树，康德漫步于小径，梭罗隐居瓦尔登湖，而不是坐在电脑面前，脊柱侧弯、屁股很酸、眼睛散光，和计算机打交道，未来只有吃不完的苦。</p>
<p>我曾经觉得我是会喜欢科研的，在我想出老师也没想出来的课题的时候，提出不一样的见解的时候，在组会分享论文的时候，做出耳目一新的 PPT 的时候。</p>
<p>也许我确实是，但是我连打游戏都没法一天八小时持续一个月，社交不行，跑步不行，吉他也不行，唯一成功坚持过的看似也只有读书，读高中的时候，但也得考虑到咱们学六门课呢，而且真是差点就死了。</p>
<p><strong>我不喜欢科研，至少暂时不喜欢</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7e7d336a8b64f15930f1a65ac44b57b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=B%2F82IrtTeqV7gh2dBeRsOPKQheU%3D" alt="IMG_3128" loading="lazy"/></p>
<p>人擅长什么领域，就会在心中的价值天平上给它加码，以确保自己的价值在自己心中过得去。我想高考之于我几乎所有的意义就在于此了。我确认自己的才能、价值、潜力，我知道我的头脑不会背叛我。</p>
<p>不过我也因此发现，无论一篇论文写得多好，总能挑出来毛病，只要我想挑毛病</p>
<p>不是我有多么丰富的知识和见解，而是我必须得挑，因为组会轮到我分享论文了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72112686cd51449eb92a293a5727dfb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=c8fCfAru7%2BOx%2BSVQk6rLoViaqe0%3D" alt="IMG_2423" loading="lazy"/></p>
<p>我时常惊叹于我朋友的学习能力和科研水平，也惊叹于我朋友为人处事的八面玲珑。</p>
<p>从小到大我见过的成绩好的人太多了，然而天下英雄如过江之鲫，即使你万里挑一，在这里也有 14 万个，更何况世界不止中国。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42c9c3e34ec244a4bdf95438024619be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=vTqAkgrVK1Al%2FpbltG%2F%2Fao1ShN8%3D" alt="Screenshot 2025-08-10 at 15.34.22" loading="lazy"/></p>
<p>然而幸福是一种独立于客观存在的能力，就像物债二分法，所有权的变动无效并不意味着买卖合同无效 —— 你看到什么，听到什么，感受到什么，才是最重要的，跟客观世界是什么样的、跟别人怎么看你无关。</p>
<p>所以幸福不是那种一下被人流推到癫狂的短暂欢乐，而是一种长期平和的满足。就按一线城市人均寿命 80 岁来算，扣除最后几年没有质量的生命，再扣除已经过去的 18 年，以及 4 年本科、3 年硕士占据现有生命的份额，又能剩下多少年的人生呢？</p>
<p>既然人生永远没有岸，你的体验难道就不重要吗？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecd40e9a5c04462fb6af820a73682881~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=Oa7j8PUBMSo%2BkLlViX1vLrDPmQo%3D" alt="Screenshot 2025-08-10 at 15.40.13" loading="lazy"/></p>
<p>有时会想，到底什么样的人生是幸福的人生呢？</p>
<p>有项研究表明，一个人在年老的时候身体和灵魂都很健康，还对自己很满意的话，他的人生就是幸福的。这里既包含了个人对自己的评估，也要考量医生和心理学家的评估。</p>
<p>这个研究的好处是把幸福的人生具体化了。不过，研究也表明，你可能等不及到退休的时候再来评估自己的一生。</p>
<p>所以朋友说他在犹豫交不交养老保险，他感觉活不到退休，即使活到了，按当前生育率推断，也是大概率没人给我们交养老金。</p>
<p>总觉得人生路很长，未来还可以做很多事，我想了想<strong>也未必很长，人很难说什么时候会死</strong>，朝生夕死也并非不可能</p>
<p>我们总是以对未来美好的憧憬，来假释当下的苦难，只是美好一直没有到来，竞争倒是永无止息</p>
<p>我不想这样，但有时候又没得选</p>
<h2 data-id="heading-3">#04 倒带人生</h2>
<p>从我记事起，就记得姥姥家的院子里，种着一颗大银杏树。每年春夏，枝头总是挂着一片绿意。等秋天一到，金灿灿的叶子就在风中招摇。风将落叶带去远方，天空飘着的云很是明亮。我只是安静地看着，邻居家那只爱趴在我家屋檐上，呼呼大睡的猫咪，就能虚度一下午的时光。</p>
<p>我这人很简单</p>
<p>如果有星巴克和瑞幸，我一定会去喝瑞幸，因为我喝不出他们有什么区别</p>
<p>但如果是瑞幸和库迪，我一定会去喝瑞幸，哪怕瑞幸十几块一瓶，因为我喝得出来区别</p>
<p>我喜欢没有意义的东西，或者说纯粹的东西，比如喜剧片或悬疑片，我不喜欢对我说教的，蕴含深刻道理的喜剧，这种还不如让我去看黑马程序员网课和国考 980 系统班</p>
<p>小时候我看了好几次东邪西毒，但当时看不懂，所以更喜欢东成西就这样纯粹的荒谬与欢笑，大话西游这样的刻骨铭心的感情</p>
<p>在王家卫的电影哲学里，武侠、江湖皆成摆设，唯有爱与孤独才是亘古不变的精神主题</p>
<p>父母总说长大后就能看懂，但我已经很久没有再看了，因为我觉得我还是看不懂</p>
<p>有些东西，我并不觉得会随着阅历或者经验的增长而改变</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10bb350ff4784eb4863e17859eb4536c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=lC09ahfDbgQQPTFGFUOcU952HKs%3D" alt="Screenshot 2025-08-10 at 15.39.55" loading="lazy"/></p>
<p>一次偶然，初中同学聊天，他说我变了，其实好多人也说过，到初中之后就开始了</p>
<p>不过他们总会对外貌成绩一类的感兴趣，或者感到惊讶</p>
<p>其实人真正改变的是内心，内心的改变是几乎不会表露在外的</p>
<p>所以我一般都把他们的话当耳旁风</p>
<p><strong>因为从来没有人问过我经历过什么</strong></p>
<p>我有时会想到一个高中时很好的朋友身前，一个和我在大大小小的考试中对于名次较劲的人</p>
<p>我曾经很想问问他，你看我有几分像从前</p>
<p>但是已经觉得有些意兴阑珊，坚如磐石的友谊也会在岁月下磨损，最终消逝</p>
<p>极少数人属于木桶中的美酒，岁月流逝后，反而越发醇香</p>
<p>很明显，即使是他，也属于前者</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c47a5f0abcbe48fc867dbfe9a457c39f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=lGzUYH57ID7JiCy6ph3vPEPpb9A%3D" alt="Screenshot 2025-08-10 at 15.34.59" loading="lazy"/></p>
<p>我一直觉得，我以前和现在，本质上并没有太大的变化，直到我看到曾经自己写的日寄</p>
<p>我需要承认，我和以前不一样了</p>
<p>我不再敢打敢拼，不再义无反顾，我会犹豫，会权衡利弊，会害怕未来，会怀疑自己</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef9a78845f994e47a2ebd458abde97e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=2fyiSUxs5mhYNeZZTKlcI5iNaB0%3D" alt="Screenshot 2025-08-10 at 15.31.15" loading="lazy"/></p>
<p>很久以前看 anlin 老师的文章，记得评论区有句话说，说是如果有一天 anlin 老师不再更新文章了，说不定不是一件坏事，因为这说明 anlin 老师在努力生活，或者过得不错，所以不再写日寄了</p>
<p><strong>可我不是</strong></p>
<p>我想把这句话改改，我的日寄大多数时候都很丧，其中虽然有我个人的原因在，但也有深夜写文章的 buff 加成，我希望有一天，大家都能过得不错，这样就不用看我的文章来找一些什么精神共鸣了，但我还是希望提供一些其他东西在，比如我的失败经历、我的踩坑经验，也希望对你有些帮助</p>
<p>有时候总在想人到底为了什么而活</p>
<p>我问家里一个长辈，他说是为了他女儿，我觉得太俗套</p>
<p>我问还在上高中快要高考的表妹，她说是为了自己，我觉得太热血</p>
<p>我问了不少人，大多说法都很千篇一律</p>
<p>我想到问一个大学时候很中二的朋友，他说我脑子是不是进水了</p>
<p>我说我在思考人生，这是个大事</p>
<p>他说福州有家日料自助打折了，准备找空去吃</p>
<p>我也在看自助，但是自助的价格总是很贵</p>
<p>但是要是能睡前买一张自助餐票，然后睡醒了去坐一段不长不短的地铁，狠狠地吃一顿</p>
<p>这样活着也还不错</p>
<p>但人总会告别这个世界，如果是生病的话，应该会有一个时间周期，如果真有这么一天，我不希望你遇到我时，和我说你有多舍不得我，什么没我不行，什么明明知道没有希望还鼓励我的话，什么没有你日子怎么过，你有什么事情还没有做，等你好了我们一起去怎样怎样...</p>
<p>我更想听的是，你有多么怀念我，我这辈子已经完成了什么，告诉我接下来的日子没有我你们仍然会好好过</p>
<p>这就足够了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f48ccdb5a603468da441529dee154ea6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=UAgfYnwYj5eLexlxGZeEydKMD9I%3D" alt="image-20260207193109269" loading="lazy"/></p>
<p>最近贼有意思，朋友和对象吵架要分手，朋友的对象问：那我们之前的回忆算什么？</p>
<p>TA 说这算你记性好</p>
<p>女生又说：如果未来再相见呢？</p>
<p>TA 说那算你运气好</p>
<p>我的运气就挺点背的，说了再见的人基本没能再见过</p>
<p>有些缘分就像北平的秋雨，不贪心便是落叶轻覆的思念，过分执着就成了望不穿的绵绵水帘</p>
<p><strong>一生很长，很多人不会永远在我的生活里，但会永远在我的故事里</strong></p>
<p>朋友说酒是万能的，配什么都能喝，也没什么忌口</p>
<p>我说也不一定，和头孢就能起反应</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9089c51e340438da5ec47ee465d1a1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=vBEF5oRh5Y%2BtwFANeHePW6rkMkE%3D" alt="Screenshot 2025-08-10 at 15.38.56" loading="lazy"/></p>
<p>最近快放假了，我朋友说好久没来见过我了，问我有没有空，说是想我了</p>
<p>我发现人可以用懒这个词解释很多事情，特别是在现代社会</p>
<p>比如懒得起了，懒得学了，懒得卷了，懒得见了</p>
<p>摆烂这个词挺好，可以称得上是立体防御</p>
<p>什么时候等我摆明白了，或许就看开了</p>
<p>有时也会想在寒假去见一见多年未见的朋友，有时又觉得不值得</p>
<p>比如舍弃一些实习的机会，科研的时间</p>
<p><strong>为了所谓的正确、成功，人们不断失去</strong></p>
<p>我是那种会因为预料到将来的离别而去珍惜与当下朋友相处时间的人</p>
<p>但不是所有人都这样，所以大多数情况下我都是在浪费感情</p>
<p>这是一个流行离开的世界，但是我们都不擅长告别，时间不会抚平悲伤，只会让人淡然</p>
<p>我是个计划性比较强的人，但唯一不可能计划的便是生命的长度，我们往往在追寻其中忽视了它的宽度，忘记去创造更多的价值，我们不知道自己生命的长短，但我们现在还在这个世界上，就应该好好生活。生命本来就不长，焦虑也是一天，开心也是一天，为何不开开心心的过</p>
<p>最近看过一句话，不知道出自哪里，说是“今天可以死，明天也可以活”，这种境界是很高的</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b974f2769bc4898ae20e8f4e9d96bd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=xQTAF6X9IXhZAd8d4kI88JLPK%2FU%3D" alt="img" loading="lazy"/></p>
<p>当我在写这篇年终时，正在为学习和生活上的一地鸡毛而烦恼着。</p>
<p>不知你们会不会也像我一样，在过去或未来的某个时刻，也在怀念着那个无忧的年代。</p>
<p><strong>落叶随着风一阵摆动，家乡的银杏树一直都在，可是我已经回不去了</strong></p>
<h2 data-id="heading-4">#05 生活碎片</h2>
<p>人的烦恼就是记性太好，如果可以把所有事都忘掉，以后每一天都是个新开始，你说多好</p>
<p><strong>时间改变了太多东西了</strong></p>
<blockquote>
<p>总要做点什么自己认为正确的事</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aefb24def2154712a20d8df727975885~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=k0EDhpRy%2FsTAEWbYpjbryhYpgKU%3D" alt="IMG_8178" loading="lazy"/></p>
<blockquote>
<p>依旧 Eason</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1599e47c29245d5892cad8e40881a06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=RPcXJhwDmxE5yvf5RRizvD3Fqj4%3D" alt="IMG_8174" loading="lazy"/></p>
<blockquote>
<p>JayChou 今年倒是听少了</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f3e5001b47649ffa620b4caf928cfd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=HLbJhggceaT5SETpGAL0iKoAlW4%3D" alt="IMG_8176" loading="lazy"/></p>
<blockquote>
<p>LeetCode 2025</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f7ac0d3e7694c1eaaaa2063cb6c3c00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=08KccyO5wWpv%2B7FdaaCnSps5WDo%3D" alt="IMG_6507" loading="lazy"/></p>
<blockquote>
<p>📷 摄影是我割舍不去的爱好</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cc0127d12d748448da1bfa1ae067bab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=bk8iDW3OgAfVHJeL7caoYTQ%2FN1g%3D" alt="6fba819e71870abe011e10ee428f6b07" loading="lazy"/></p>
<blockquote>
<p>略懂些游戏</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/725f4bc1dbd6491b91c04ad54ce837a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=nI0wumjcI%2B0hMJ230qg8rPG5xBg%3D" alt="e8bd49c009317151783585ea76dba568" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bffa5e86e0004c8a99b1a94afa109ba2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=hgwxQHzU%2BTVXAwAFCkKbeJy85Ug%3D" alt="858436270d98ea632151263fcf4daf5b" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67bf1e74508b409ea7dba074d54d18f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=Gjw%2FFFqN%2Fzx3JhBD7ok0AwoJ1Hk%3D" alt="IMG_8172" loading="lazy"/></p>
<blockquote>
<p>晚霞</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4227ccd5f044f67a3e891165bd824a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=7fnqgj8grBZz3lM6JjEYvd01Q6Y%3D" alt="8a743a6c20cd75acedb7908bfd0d1397" loading="lazy"/></p>
<blockquote>
<p>跨年晚会</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/518557190e9d4bd3b75e914eaf0b5ab0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=zN1IUVImVxC0cC7O91xKY9uuvdA%3D" alt="P1000439" loading="lazy"/></p>
<p>夜晚有风，但不冷，白天的余温还没散去，风吹来只觉得凉爽</p>
<p>很像大三刚保研完在湖边吹风的那个夜晚，意气风发</p>
<p>不过意气风发这个词仿佛永远都不再适合我了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b29c54f0a1fe454898e8fbb26242afbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29yZWR1bXA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771401803&amp;x-signature=gKGvdqrD9fIR%2FWd%2B0pKuDQMbm0g%3D" alt="2e24ee37470ef4910e30365fd81c4659" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[设计模式-行为型]]></title>    <link>https://juejin.cn/post/7605174711181443135</link>    <guid>https://juejin.cn/post/7605174711181443135</guid>    <pubDate>2026-02-11T08:08:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605174711181443135" data-draft-id="7605142381152763967" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="设计模式-行为型"/> <meta itemprop="keywords" content="前端,后端,设计模式"/> <meta itemprop="datePublished" content="2026-02-11T08:08:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="牛奶"/> <meta itemprop="url" content="https://juejin.cn/user/1169536100866487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            设计模式-行为型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1169536100866487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    牛奶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:08:48.000Z" title="Wed Feb 11 2026 08:08:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">设计模式-行为型</h2>
<blockquote>
<p>本文主要介绍下行为型设计模式，包括<code>策略模式</code>、<code>模板方法模式</code>、<code>观察者模式</code>、<code>迭代器模式</code>、<code>责任链模式</code>、<code>命令模式</code>、<code>备忘录模式</code>、<code>状态模式</code>、<code>访问者模式</code>、<code>中介者模式</code>和<code>解释器模式</code>，提供前端场景和 ES6 代码的实现过程。
供自己以后查漏补缺，也欢迎同道朋友交流学习。</p>
</blockquote>
<h3 data-id="heading-1">引言</h3>
<p>本文主要介绍下行为型设计模式，包括<code>策略模式</code>、<code>模板方法模式</code>、<code>观察者模式</code>、<code>迭代器模式</code>、<code>责任链模式</code>、<code>命令模式</code>、<code>备忘录模式</code>、<code>状态模式</code>、<code>访问者模式</code>、<code>中介者模式</code>和<code>解释器模式</code>，提供前端场景和 ES6 代码的实现过程。</p>
<h3 data-id="heading-2">什么是行为型</h3>
<p>行为型模式（<code>Behavioral Patterns</code>）主要关注对象之间的<code>通信</code>和<code>职责分配</code>。这些模式描述了对象之间如何<code>协作</code>共同完成任务，以及如何<code>分配职责</code>。行为型模式不仅关注类和对象的结构，更关注它们之间的<code>相互作用</code>，通过定义清晰的通信机制，解决系统中复杂的<code>控制流</code>问题，使得代码更加清晰、灵活和易于维护。</p>
<h3 data-id="heading-3">行为型模式</h3>
<h3 data-id="heading-4">策略模式（Strategy）</h3>
<p>策略模式（<code>Strategy Pattern</code>）定义一系列的算法，把它们一个个封装起来，并使它们可以<code>相互替换</code>。策略模式让算法独立于使用它的客户而变化。</p>
<h4 data-id="heading-5">前端中的策略模式场景</h4>
<ul>
<li><strong>表单验证</strong>：将不同的验证规则（如非空、邮箱格式、手机号格式）封装成策略，根据需要选择验证策略。</li>
<li><strong>不同业务逻辑处理</strong>：例如，根据用户权限（普通用户、VIP、管理员）展示不同的 UI 或执行不同的逻辑。</li>
<li><strong>缓动动画算法</strong>：在动画库中，提供多种缓动函数（如 <code>linear</code>、<code>ease-in</code>、<code>ease-out</code>）供用户选择。</li>
</ul>
<h4 data-id="heading-6">策略模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 策略对象</span>
<span class="hljs-keyword">const</span> strategies = {
  <span class="hljs-string">"S"</span>: <span class="hljs-function">(<span class="hljs-params">salary</span>) =&gt;</span> salary * <span class="hljs-number">4</span>,
  <span class="hljs-string">"A"</span>: <span class="hljs-function">(<span class="hljs-params">salary</span>) =&gt;</span> salary * <span class="hljs-number">3</span>,
  <span class="hljs-string">"B"</span>: <span class="hljs-function">(<span class="hljs-params">salary</span>) =&gt;</span> salary * <span class="hljs-number">2</span>
};

<span class="hljs-comment">// 环境类（Context）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Bonus</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">salary, strategy</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">salary</span> = salary;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">strategy</span> = strategy;
  }

  <span class="hljs-title function_">getBonus</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> strategies[<span class="hljs-variable language_">this</span>.<span class="hljs-property">strategy</span>](<span class="hljs-variable language_">this</span>.<span class="hljs-property">salary</span>);
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> bonusS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bonus</span>(<span class="hljs-number">10000</span>, <span class="hljs-string">"S"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bonusS.<span class="hljs-title function_">getBonus</span>()); <span class="hljs-comment">// 40000</span>

<span class="hljs-keyword">const</span> bonusA = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bonus</span>(<span class="hljs-number">10000</span>, <span class="hljs-string">"A"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bonusA.<span class="hljs-title function_">getBonus</span>()); <span class="hljs-comment">// 30000</span>
</code></pre>
<h3 data-id="heading-7">模板方法模式（Template Method）</h3>
<p>模板方法模式（<code>Template Method Pattern</code>）定义一个操作中的算法的<code>骨架</code>，而将一些步骤<code>延迟</code>到子类中实现。</p>
<p>模板方法使得子类可以在不改变算法结构的情况下，重新定义算法的某些步骤。</p>
<h4 data-id="heading-8">前端中的模板方法模式场景</h4>
<ul>
<li><strong>UI组件生命周期</strong>：<code>Vue</code> 或 <code>React</code> 组件的生命周期钩子（如 <code>componentDidMount</code>、<code>created</code>）就是模板方法模式的应用。框架定义了组件渲染的整体流程，开发者在特定的钩子中实现自定义逻辑。</li>
<li><strong>HTTP请求封装</strong>：定义一个基础的请求类，处理通用的配置（如 URL、Headers），子类实现具体的请求逻辑（如 GET、POST 参数处理）。</li>
</ul>
<h4 data-id="heading-9">模板方法模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 抽象父类：饮料</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Beverage</span> {
  <span class="hljs-comment">// 模板方法，定义算法骨架</span>
  <span class="hljs-title function_">makeBeverage</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">boilWater</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">brew</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pourInCup</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addCondiments</span>();
  }

  <span class="hljs-title function_">boilWater</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"煮沸水"</span>);
  }

  <span class="hljs-title function_">pourInCup</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"倒进杯子"</span>);
  }

  <span class="hljs-comment">// 抽象方法，子类必须实现</span>
  <span class="hljs-title function_">brew</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"抽象方法不能调用"</span>);
  }

  <span class="hljs-title function_">addCondiments</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"抽象方法不能调用"</span>);
  }
}

<span class="hljs-comment">// 具体子类：咖啡</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Coffee</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Beverage</span> {
  <span class="hljs-title function_">brew</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"用沸水冲泡咖啡"</span>);
  }

  <span class="hljs-title function_">addCondiments</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"加糖和牛奶"</span>);
  }
}

<span class="hljs-comment">// 具体子类：茶</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Tea</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Beverage</span> {
  <span class="hljs-title function_">brew</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"用沸水浸泡茶叶"</span>);
  }

  <span class="hljs-title function_">addCondiments</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"加柠檬"</span>);
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> coffee = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Coffee</span>();
coffee.<span class="hljs-title function_">makeBeverage</span>();
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 煮沸水</span>
<span class="hljs-comment">// 用沸水冲泡咖啡</span>
<span class="hljs-comment">// 倒进杯子</span>
<span class="hljs-comment">// 加糖和牛奶</span>

<span class="hljs-keyword">const</span> tea = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Tea</span>();
tea.<span class="hljs-title function_">makeBeverage</span>();
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 煮沸水</span>
<span class="hljs-comment">// 用沸水浸泡茶叶</span>
<span class="hljs-comment">// 倒进杯子</span>
<span class="hljs-comment">// 加柠檬</span>
</code></pre>
<h3 data-id="heading-10">观察者模式（Observer）</h3>
<p>观察者模式（<code>Observer Pattern</code>）定义对象间的一种<code>一对多</code>的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。</p>
<h4 data-id="heading-11">前端中的观察者模式场景</h4>
<ul>
<li><strong>DOM事件监听</strong>：<code>document.addEventListener</code> 就是最典型的观察者模式。</li>
<li><strong>Promise</strong>：<code>then</code> 方法也是一种观察者模式，当 Promise 状态改变时，执行相应的回调。</li>
<li><strong>Vue响应式系统</strong>：<code>Dep</code>（目标）和 <code>Watcher</code>（观察者）实现了数据的响应式更新。</li>
<li><strong>RxJS</strong>：基于观察者模式的响应式编程库。</li>
<li><strong>Event Bus</strong>：事件总线。</li>
</ul>
<h4 data-id="heading-12">观察者模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 目标对象（Subject）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Subject</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observers</span> = [];
  }

  <span class="hljs-title function_">addObserver</span>(<span class="hljs-params">observer</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observers</span>.<span class="hljs-title function_">push</span>(observer);
  }

  <span class="hljs-title function_">removeObserver</span>(<span class="hljs-params">observer</span>) {
    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-property">observers</span>.<span class="hljs-title function_">indexOf</span>(observer);
    <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">observers</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
    }
  }

  <span class="hljs-title function_">notify</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observers</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">observer</span> =&gt;</span> {
      observer.<span class="hljs-title function_">update</span>(data);
    });
  }
}

<span class="hljs-comment">// 观察者对象（Observer）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 收到通知: <span class="hljs-subst">${data}</span>`</span>);
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> subject = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>();
<span class="hljs-keyword">const</span> observer1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>(<span class="hljs-string">"观察者1"</span>);
<span class="hljs-keyword">const</span> observer2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>(<span class="hljs-string">"观察者2"</span>);

subject.<span class="hljs-title function_">addObserver</span>(observer1);
subject.<span class="hljs-title function_">addObserver</span>(observer2);

subject.<span class="hljs-title function_">notify</span>(<span class="hljs-string">"更新数据了！"</span>);
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 观察者1 收到通知: 更新数据了！</span>
<span class="hljs-comment">// 观察者2 收到通知: 更新数据了！</span>
</code></pre>
<h3 data-id="heading-13">迭代器模式（Iterator）</h3>
<p>迭代器模式（<code>Iterator Pattern</code>）提供一种方法<code>顺序访问</code>一个聚合对象中的各个元素，而又不暴露其内部的表示。</p>
<h4 data-id="heading-14">前端中的迭代器模式场景</h4>
<ul>
<li><strong>数组遍历</strong>：<code>forEach</code>、<code>map</code> 等数组方法。</li>
<li><strong>ES6 Iterator</strong>：<code>Symbol.iterator</code> 接口，使得对象可以使用 <code>for...of</code> 循环遍历。</li>
<li><strong>Generators</strong>：生成器函数可以生成迭代器。</li>
</ul>
<h4 data-id="heading-15">迭代器模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 自定义迭代器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Iterator</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">items</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = items;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-title function_">hasNext</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-property">length</span>;
  }

  <span class="hljs-title function_">next</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>++];
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> items = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> iterator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Iterator</span>(items);

<span class="hljs-keyword">while</span> (iterator.<span class="hljs-title function_">hasNext</span>()) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iterator.<span class="hljs-title function_">next</span>());
}
<span class="hljs-comment">// 输出：1 2 3</span>

<span class="hljs-comment">// ES6 Iterator 示例</span>
<span class="hljs-keyword">const</span> iterableObj = {
  <span class="hljs-attr">items</span>: [<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>],
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]() {
    <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">next</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-property">length</span>) {
          <span class="hljs-keyword">return</span> { <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>[index++], <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> };
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">return</span> { <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> };
        }
      }
    };
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> iterableObj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item);
}
<span class="hljs-comment">// 输出：10 20 30</span>
</code></pre>
<h3 data-id="heading-16">责任链模式（Chain of Responsibility）</h3>
<p>责任链模式（<code>Chain of Responsibility Pattern</code>）使多个对象都有机会处理请求，从而避免请求的发送者和接收者之间的耦合关系。将这些对象连成一条链，并沿着这条链传递该请求，直到有一个对象处理它为止。</p>
<h4 data-id="heading-17">前端中的责任链模式场景</h4>
<ul>
<li><strong>事件冒泡</strong>：DOM 事件在 DOM 树中的冒泡机制就是责任链模式。</li>
<li><strong>中间件</strong>：<code>Express</code>、<code>Koa</code>、<code>Redux</code> 中的中间件机制。</li>
<li><strong>拦截器</strong>：<code>Axios</code> 的请求和响应拦截器。</li>
</ul>
<h4 data-id="heading-18">责任链模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 处理器基类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Handler</span> {
  <span class="hljs-title function_">setNext</span>(<span class="hljs-params">handler</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nextHandler</span> = handler;
    <span class="hljs-keyword">return</span> handler; <span class="hljs-comment">// 返回 handler 以支持链式调用</span>
  }

  <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">request</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">nextHandler</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">nextHandler</span>.<span class="hljs-title function_">handleRequest</span>(request);
    }
  }
}

<span class="hljs-comment">// 具体处理器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HandlerA</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Handler</span> {
  <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">request</span>) {
    <span class="hljs-keyword">if</span> (request === <span class="hljs-string">'A'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"HandlerA 处理了请求"</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">handleRequest</span>(request);
    }
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HandlerB</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Handler</span> {
  <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">request</span>) {
    <span class="hljs-keyword">if</span> (request === <span class="hljs-string">'B'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"HandlerB 处理了请求"</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">handleRequest</span>(request);
    }
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HandlerC</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Handler</span> {
  <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">request</span>) {
    <span class="hljs-keyword">if</span> (request === <span class="hljs-string">'C'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"HandlerC 处理了请求"</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"没有处理器处理该请求"</span>);
    }
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> handlerA = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerA</span>();
<span class="hljs-keyword">const</span> handlerB = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerB</span>();
<span class="hljs-keyword">const</span> handlerC = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerC</span>();

handlerA.<span class="hljs-title function_">setNext</span>(handlerB).<span class="hljs-title function_">setNext</span>(handlerC);

handlerA.<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'A'</span>); <span class="hljs-comment">// HandlerA 处理了请求</span>
handlerA.<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'B'</span>); <span class="hljs-comment">// HandlerB 处理了请求</span>
handlerA.<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'C'</span>); <span class="hljs-comment">// HandlerC 处理了请求</span>
handlerA.<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'D'</span>); <span class="hljs-comment">// 没有处理器处理该请求</span>
</code></pre>
<h3 data-id="heading-19">命令模式（Command）</h3>
<p>命令模式（<code>Command Pattern</code>）将一个<code>请求封装</code>为一个对象，从而使用户可用不同的请求对客户进行参数化；对请求排队或记录请求日志，以及支持可撤销的操作。</p>
<h4 data-id="heading-20">前端中的命令模式场景</h4>
<ul>
<li><strong>富文本编辑器</strong>：执行加粗、斜体、下划线等操作，并支持撤销（Undo）和重做（Redo）。</li>
<li><strong>菜单和按钮</strong>：将菜单项或按钮的操作封装成命令对象。</li>
</ul>
<h4 data-id="heading-21">命令模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 接收者：执行实际命令</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Receiver</span> {
  <span class="hljs-title function_">execute</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"执行命令"</span>);
  }
}

<span class="hljs-comment">// 命令对象</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Command</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">receiver</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">receiver</span> = receiver;
  }

  <span class="hljs-title function_">execute</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">receiver</span>.<span class="hljs-title function_">execute</span>();
  }
}

<span class="hljs-comment">// 调用者：发起命令</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Invoker</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">command</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">command</span> = command;
  }

  <span class="hljs-title function_">invoke</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"调用者发起请求"</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">command</span>.<span class="hljs-title function_">execute</span>();
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> receiver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Receiver</span>();
<span class="hljs-keyword">const</span> command = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Command</span>(receiver);
<span class="hljs-keyword">const</span> invoker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Invoker</span>(command);

invoker.<span class="hljs-title function_">invoke</span>();
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// 调用者发起请求</span>
<span class="hljs-comment">// 执行命令</span>
</code></pre>
<h3 data-id="heading-22">备忘录模式（Memento）</h3>
<p>备忘录模式（<code>Memento Pattern</code>）在不破坏封装性的前提下，捕获一个对象的内部状态，并在该对象之外保存这个状态。这样以后就可将该对象恢复到原先保存的状态。</p>
<h4 data-id="heading-23">前端中的备忘录模式场景</h4>
<ul>
<li><strong>状态管理</strong>：<code>Redux</code> 等状态管理库的时间旅行（Time Travel）功能。</li>
<li><strong>表单草稿</strong>：保存用户输入的表单内容，以便下次恢复。</li>
<li><strong>撤销/重做</strong>：编辑器中的撤销和重做功能。</li>
</ul>
<h4 data-id="heading-24">备忘录模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 备忘录：保存状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Memento</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">state</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = state;
  }

  <span class="hljs-title function_">getState</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;
  }
}

<span class="hljs-comment">// 发起人：需要保存状态的对象</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Originator</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">""</span>;
  }

  <span class="hljs-title function_">setState</span>(<span class="hljs-params">state</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = state;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前状态: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.state}</span>`</span>);
  }

  <span class="hljs-title function_">saveStateToMemento</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Memento</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);
  }

  <span class="hljs-title function_">getStateFromMemento</span>(<span class="hljs-params">memento</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = memento.<span class="hljs-title function_">getState</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`恢复状态: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.state}</span>`</span>);
  }
}

<span class="hljs-comment">// 管理者：管理备忘录</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Caretaker</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mementos</span> = [];
  }

  <span class="hljs-title function_">add</span>(<span class="hljs-params">memento</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mementos</span>.<span class="hljs-title function_">push</span>(memento);
  }

  <span class="hljs-title function_">get</span>(<span class="hljs-params">index</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">mementos</span>[index];
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> originator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Originator</span>();
<span class="hljs-keyword">const</span> caretaker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Caretaker</span>();

originator.<span class="hljs-title function_">setState</span>(<span class="hljs-string">"状态1"</span>);
originator.<span class="hljs-title function_">setState</span>(<span class="hljs-string">"状态2"</span>);
caretaker.<span class="hljs-title function_">add</span>(originator.<span class="hljs-title function_">saveStateToMemento</span>()); <span class="hljs-comment">// 保存状态2</span>

originator.<span class="hljs-title function_">setState</span>(<span class="hljs-string">"状态3"</span>);
caretaker.<span class="hljs-title function_">add</span>(originator.<span class="hljs-title function_">saveStateToMemento</span>()); <span class="hljs-comment">// 保存状态3</span>

originator.<span class="hljs-title function_">setState</span>(<span class="hljs-string">"状态4"</span>);

originator.<span class="hljs-title function_">getStateFromMemento</span>(caretaker.<span class="hljs-title function_">get</span>(<span class="hljs-number">0</span>)); <span class="hljs-comment">// 恢复到状态2</span>
originator.<span class="hljs-title function_">getStateFromMemento</span>(caretaker.<span class="hljs-title function_">get</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">// 恢复到状态3</span>
</code></pre>
<h3 data-id="heading-25">状态模式（State）</h3>
<p>状态模式（<code>State Pattern</code>）允许一个对象在其内部状态改变时改变它的行为。对象看起来似乎修改了它的类。</p>
<h4 data-id="heading-26">前端中的状态模式场景</h4>
<ul>
<li><strong>有限状态机（FSM）</strong>：例如，Promise 的状态（Pending, Fulfilled, Rejected）。</li>
<li><strong>组件状态管理</strong>：例如，一个按钮可能有 <code>loading</code>、<code>disabled</code>、<code>default</code> 等状态，不同状态下点击行为不同。</li>
<li><strong>游戏开发</strong>：角色的不同状态（如站立、奔跑、跳跃、攻击）。</li>
</ul>
<h4 data-id="heading-27">状态模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 状态接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span> {
  <span class="hljs-title function_">handle</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"抽象方法不能调用"</span>);
  }
}

<span class="hljs-comment">// 具体状态A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteStateA</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">State</span> {
  <span class="hljs-title function_">handle</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"当前是状态A"</span>);
    context.<span class="hljs-title function_">setState</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcreteStateB</span>());
  }
}

<span class="hljs-comment">// 具体状态B</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteStateB</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">State</span> {
  <span class="hljs-title function_">handle</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"当前是状态B"</span>);
    context.<span class="hljs-title function_">setState</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcreteStateA</span>());
  }
}

<span class="hljs-comment">// 上下文</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Context</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcreteStateA</span>();
  }

  <span class="hljs-title function_">setState</span>(<span class="hljs-params">state</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = state;
  }

  <span class="hljs-title function_">request</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">handle</span>(<span class="hljs-variable language_">this</span>);
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Context</span>();
context.<span class="hljs-title function_">request</span>(); <span class="hljs-comment">// 当前是状态A</span>
context.<span class="hljs-title function_">request</span>(); <span class="hljs-comment">// 当前是状态B</span>
context.<span class="hljs-title function_">request</span>(); <span class="hljs-comment">// 当前是状态A</span>
</code></pre>
<h3 data-id="heading-28">访问者模式（Visitor）</h3>
<p>访问者模式（<code>Visitor Pattern</code>）表示一个作用于某对象结构中的各元素的操作。它使你可以在不改变各元素的类的前提下定义作用于这些元素的新操作。</p>
<h4 data-id="heading-29">前端中的访问者模式场景</h4>
<ul>
<li><strong>AST遍历</strong>：<code>Babel</code> 插件开发中，通过访问者模式遍历和修改 AST（抽象语法树）节点。</li>
<li><strong>复杂数据结构处理</strong>：对树形结构或图形结构进行不同的操作（如渲染、序列化、验证）。</li>
</ul>
<h4 data-id="heading-30">访问者模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 元素类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Element</span> {
  <span class="hljs-title function_">accept</span>(<span class="hljs-params">visitor</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"抽象方法不能调用"</span>);
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteElementA</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Element</span> {
  <span class="hljs-title function_">accept</span>(<span class="hljs-params">visitor</span>) {
    visitor.<span class="hljs-title function_">visitConcreteElementA</span>(<span class="hljs-variable language_">this</span>);
  }

  <span class="hljs-title function_">operationA</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"ElementA"</span>;
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteElementB</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Element</span> {
  <span class="hljs-title function_">accept</span>(<span class="hljs-params">visitor</span>) {
    visitor.<span class="hljs-title function_">visitConcreteElementB</span>(<span class="hljs-variable language_">this</span>);
  }

  <span class="hljs-title function_">operationB</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"ElementB"</span>;
  }
}

<span class="hljs-comment">// 访问者类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Visitor</span> {
  <span class="hljs-title function_">visitConcreteElementA</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`访问者访问 <span class="hljs-subst">${element.operationA()}</span>`</span>);
  }

  <span class="hljs-title function_">visitConcreteElementB</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`访问者访问 <span class="hljs-subst">${element.operationB()}</span>`</span>);
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> elementA = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcreteElementA</span>();
<span class="hljs-keyword">const</span> elementB = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcreteElementB</span>();
<span class="hljs-keyword">const</span> visitor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Visitor</span>();

elementA.<span class="hljs-title function_">accept</span>(visitor); <span class="hljs-comment">// 访问者访问 ElementA</span>
elementB.<span class="hljs-title function_">accept</span>(visitor); <span class="hljs-comment">// 访问者访问 ElementB</span>
</code></pre>
<h3 data-id="heading-31">中介者模式（Mediator）</h3>
<p>中介者模式（<code>Mediator Pattern</code>）用一个<code>中介对象</code>来封装一系列的对象交互。中介者使各对象不需要显式地相互引用，从而使其耦合松散，而且可以独立地改变它们之间的交互。</p>
<h4 data-id="heading-32">前端中的中介者模式场景</h4>
<ul>
<li><strong>MVC/MVVM框架</strong>：Controller 或 ViewModel 充当中介者，协调 View 和 Model 之间的交互。</li>
<li><strong>复杂表单交互</strong>：例如，选择省份后，城市下拉框需要更新；选择城市后，区县下拉框需要更新。使用中介者统一管理这些联动逻辑。</li>
<li><strong>聊天室</strong>：用户之间不直接发送消息，而是通过服务器（中介者）转发。</li>
</ul>
<h4 data-id="heading-33">中介者模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 中介者</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatMediator</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span> = [];
  }

  <span class="hljs-title function_">addUser</span>(<span class="hljs-params">user</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>.<span class="hljs-title function_">push</span>(user);
    user.<span class="hljs-title function_">setMediator</span>(<span class="hljs-variable language_">this</span>);
  }

  <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params">message, user</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">u</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (u !== user) {
        u.<span class="hljs-title function_">receive</span>(message);
      }
    });
  }
}

<span class="hljs-comment">// 用户类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mediator</span> = <span class="hljs-literal">null</span>;
  }

  <span class="hljs-title function_">setMediator</span>(<span class="hljs-params">mediator</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mediator</span> = mediator;
  }

  <span class="hljs-title function_">send</span>(<span class="hljs-params">message</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 发送消息: <span class="hljs-subst">${message}</span>`</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mediator</span>.<span class="hljs-title function_">sendMessage</span>(message, <span class="hljs-variable language_">this</span>);
  }

  <span class="hljs-title function_">receive</span>(<span class="hljs-params">message</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 收到消息: <span class="hljs-subst">${message}</span>`</span>);
  }
}

<span class="hljs-comment">// 客户端调用</span>
<span class="hljs-keyword">const</span> mediator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatMediator</span>();
<span class="hljs-keyword">const</span> user1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"User1"</span>);
<span class="hljs-keyword">const</span> user2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"User2"</span>);
<span class="hljs-keyword">const</span> user3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"User3"</span>);

mediator.<span class="hljs-title function_">addUser</span>(user1);
mediator.<span class="hljs-title function_">addUser</span>(user2);
mediator.<span class="hljs-title function_">addUser</span>(user3);

user1.<span class="hljs-title function_">send</span>(<span class="hljs-string">"大家好！"</span>);
<span class="hljs-comment">// 输出：</span>
<span class="hljs-comment">// User1 发送消息: 大家好！</span>
<span class="hljs-comment">// User2 收到消息: 大家好！</span>
<span class="hljs-comment">// User3 收到消息: 大家好！</span>
</code></pre>
<h3 data-id="heading-34">解释器模式（Interpreter）</h3>
<p>解释器模式（<code>Interpreter Pattern</code>）给定一个语言，定义它的文法的一种表示，并定义一个解释器，该解释器用来解释语言中的句子。</p>
<h4 data-id="heading-35">前端中的解释器模式场景</h4>
<ul>
<li><strong>模板引擎</strong>：<code>Mustache</code>、<code>Handlebars</code> 等模板引擎，解析模板字符串并生成 HTML。</li>
<li><strong>编译器前端</strong>：将代码解析为 AST。</li>
<li><strong>数学表达式计算</strong>：解析并计算字符串形式的数学表达式。</li>
</ul>
<h4 data-id="heading-36">解释器模式-JS实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 抽象表达式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Expression</span> {
  <span class="hljs-title function_">interpret</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"抽象方法不能调用"</span>);
  }
}

<span class="hljs-comment">// 终结符表达式：数字</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberExpression</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Expression</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">number</span>) {
    <span class="hljs-variable language_">super</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">number</span> = number;
  }

  <span class="hljs-title function_">interpret</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">number</span>;
  }
}

<span class="hljs-comment">// 非终结符表达式：加法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AddExpression</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Expression</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">left, right</span>) {
    <span class="hljs-variable language_">super</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">left</span> = left;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">right</span> = right;
  }

  <span class="hljs-title function_">interpret</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">left</span>.<span class="hljs-title function_">interpret</span>(context) + <span class="hljs-variable language_">this</span>.<span class="hljs-property">right</span>.<span class="hljs-title function_">interpret</span>(context);
  }
}

<span class="hljs-comment">// 非终结符表达式：减法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SubtractExpression</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Expression</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">left, right</span>) {
    <span class="hljs-variable language_">super</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">left</span> = left;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">right</span> = right;
  }

  <span class="hljs-title function_">interpret</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">left</span>.<span class="hljs-title function_">interpret</span>(context) - <span class="hljs-variable language_">this</span>.<span class="hljs-property">right</span>.<span class="hljs-title function_">interpret</span>(context);
  }
}

<span class="hljs-comment">// 客户端调用：计算 10 + 5 - 2</span>
<span class="hljs-keyword">const</span> expression = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SubtractExpression</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddExpression</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NumberExpression</span>(<span class="hljs-number">10</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">NumberExpression</span>(<span class="hljs-number">5</span>)),
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">NumberExpression</span>(<span class="hljs-number">2</span>)
);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(expression.<span class="hljs-title function_">interpret</span>()); <span class="hljs-comment">// 13</span>
</code></pre>
<h3 data-id="heading-37">项目地址</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fcangnaiwen%2Fdesign-patterns-study" target="_blank" title="https://gitee.com/cangnaiwen/design-patterns-study" ref="nofollow noopener noreferrer">design-patterns-study</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-75、买卖股票的最好时机]]></title>    <link>https://juejin.cn/post/7605173538417672202</link>    <guid>https://juejin.cn/post/7605173538417672202</guid>    <pubDate>2026-02-11T08:33:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605173538417672202" data-draft-id="7603567912592982043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="剑指offer-75、买卖股票的最好时机"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-02-11T08:33:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            剑指offer-75、买卖股票的最好时机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:33:24.000Z" title="Wed Feb 11 2026 08:33:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>假设你有⼀个数组 prices ，⻓度为 n ，其中 prices[i] 是股票在第 i 天的价格，请根据这个价格数组，返回买卖股票能获得的最⼤收益</p>
<ol>
<li>你可以买⼊⼀次股票和卖出⼀次股票，并⾮每天都可以买⼊或卖出⼀次，总共只能买⼊和卖出⼀次，且买⼊必须在卖出的前⾯的某⼀天</li>
<li>如果不能获取到任何利润，请返回 0</li>
<li>假设买⼊卖出均⽆⼿续费</li>
</ol>
<p>示例1：
输⼊：[8,9,2,5,4,7,1]
返回值: 5
说明: 在第3天(股票价格 = 2)的时候买⼊，在第6天(股票价格 = 7)的时候卖出，最⼤利润 = 7-2 = 5，不能选择在第2天买⼊，第3天卖出，这样就亏损7了；同时，你也不能在买⼊前卖出股票。</p>
<p>示例2：
输⼊：[2,4,1]
返回值: 2</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">暴⼒穷举</h3>
<p>这⾥涉及的节点⽆⾮是买⼊，卖出，那么我们遍历所有的数据，作为买⼊⽇期，同时将该⽇期后⾯每⼀个都作为卖出⽇期来计算，只要维护最⼤的利润即可。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">maxProfit</span><span class="hljs-params">(<span class="hljs-type">int</span>[] prices)</span> {
        <span class="hljs-keyword">if</span> (prices == <span class="hljs-literal">null</span> || prices.length &lt; <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">maxProfit</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> prices.length;
        
        <span class="hljs-comment">// 外层循环：遍历所有可能的买入点</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; n - <span class="hljs-number">1</span>; i++) {
            <span class="hljs-comment">// 内层循环：遍历所有可能的卖出点（必须在买入点之后）</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i + <span class="hljs-number">1</span>; j &lt; n; j++) {
                <span class="hljs-type">int</span> <span class="hljs-variable">profit</span> <span class="hljs-operator">=</span> prices[j] - prices[i];
                <span class="hljs-keyword">if</span> (profit &gt; maxProfit) {
                    maxProfit = profit;
                }
            }
        }
        
        <span class="hljs-keyword">return</span> maxProfit;
    }
}
</code></pre>
<ul>
<li>时间复杂度： O(n2)</li>
<li>空间复杂度：O(1)</li>
</ul>
<h3 data-id="heading-3">贪⼼法（最优解）</h3>
<p>我们要想得到⼀个最⼤的利润，其实就是要两者差值最⼤。如果让差值最⼤，假设在当天卖出，那么什么时候买⼊最好呢？</p>
<p>当然是在前⾯找到最⼩的买⼊点，⽐如：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0f36a140e7443779a0d9c86d2d1ade9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771403603&amp;x-signature=SdVHt45usGYycHkkW3DT3wW257k%3D" alt="" loading="lazy"/></p>
<p>⽽前⾯的最⼩值，其实我们在遍历的时候是可以不断维护的，所以我们只要遍历⼀次数组即可。</p>
<p><strong>关键思想：</strong></p>
<ul>
<li>最大利润 = 某日价格 - 该日之前的最低价格</li>
<li>只需维护两个变量：
<ul>
<li><code>minPrice</code>：遍历过程中遇到的最低价格</li>
<li><code>maxProfit</code>：当前能获得的最大利润</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution63</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">maxProfit</span><span class="hljs-params">(<span class="hljs-type">int</span>[] prices)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">min</span> <span class="hljs-operator">=</span> Integer.MAX_VALUE;
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> value: prices) {
            <span class="hljs-comment">// 维护最⼩值</span>
            min = Math.min(min, value);
            <span class="hljs-comment">// 当前值减去前⾯最⼩值，与利润最⼤值对⽐，维护好利润最⼤值</span>
            result = Math.max(result, value - min);
        }
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，只需遍历一次数组</li>
<li><strong>空间复杂度</strong>：O(1)，只使用常数空间</li>
</ul>
<p>执行过程示例（prices = [8,9,2,5,4,7,1]）</p>
<pre><code class="hljs language-text" lang="text">i=0: price=8, minPrice=8, maxProfit=0
i=1: price=9, minPrice=8, maxProfit=1
i=2: price=2, minPrice=2, maxProfit=1
i=3: price=5, minPrice=2, maxProfit=3
i=4: price=4, minPrice=2, maxProfit=3
i=5: price=7, minPrice=2, maxProfit=5
i=6: price=1, minPrice=1, maxProfit=5
结果：5
</code></pre>
<h3 data-id="heading-4">动态规划</h3>
<p>dp[i]表示前i天的最大利润，状态转移基于前i-1天的结果</p>
<p><strong>状态定义：</strong></p>
<ul>
<li><code>minPrice[i]</code>：前i天的最低价格</li>
<li><code>maxProfit[i]</code>：前i天能获得的最大利润</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">maxProfit</span><span class="hljs-params">(<span class="hljs-type">int</span>[] prices)</span> {
        <span class="hljs-keyword">if</span> (prices == <span class="hljs-literal">null</span> || prices.length &lt; <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">minPrice</span> <span class="hljs-operator">=</span> prices[<span class="hljs-number">0</span>];
        <span class="hljs-type">int</span> <span class="hljs-variable">maxProfit</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; prices.length; i++) {
            <span class="hljs-comment">// 状态转移方程：</span>
            <span class="hljs-comment">// 前i天的最大利润 = max(前i-1天的最大利润, 第i天价格-前i-1天的最低价格)</span>
            maxProfit = Math.max(maxProfit, prices[i] - minPrice);
            minPrice = Math.min(minPrice, prices[i]);
        }
        
        <span class="hljs-keyword">return</span> maxProfit;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，单次遍历</li>
<li><strong>空间复杂度</strong>：O(1)，优化后只需两个变量</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我是如何把 API 响应时间从 200ms 压到了 10ms]]></title>    <link>https://juejin.cn/post/7605213691910422554</link>    <guid>https://juejin.cn/post/7605213691910422554</guid>    <pubDate>2026-02-11T08:29:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605213691910422554" data-draft-id="7605157203591331867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我是如何把 API 响应时间从 200ms 压到了 10ms"/> <meta itemprop="keywords" content="前端,后端,Node.js"/> <meta itemprop="datePublished" content="2026-02-11T08:29:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="该用户已不存在"/> <meta itemprop="url" content="https://juejin.cn/user/64217584778579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我是如何把 API 响应时间从 200ms 压到了 10ms
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/64217584778579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    该用户已不存在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:29:36.000Z" title="Wed Feb 11 2026 08:29:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>少年呀，当你遇到这样的情况：API 慢得像蜗牛，P95 延迟超高，服务器在凌晨 3 点因为流量突发而崩溃，你是选择花三个月用 Rust 重写所有东西，还是选择看着用户流失呢。</p>
<p>或者，你可以像我一样，用一种作弊的方式，把 Bun 的极致速度嫁接到 Node.js 的庞大生态上。</p>
<p>别笑，我是认真的。我就能在不重写 5 年陈旧业务逻辑的前提下，把一个臃肿的后端接口压进 10ms 以内的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5af8346a754340069b77dc23a39e8006~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771403376&amp;x-signature=1vtEujIofNuir51EZLRTBr8a9Tk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-0">边缘侧使用 Bun，通过 IPC 唤醒 Node 进程池</h3>
<p>众所周知，Node 处理 HTTP 请求的开销太大了，但我的业务逻辑里全是依赖 <code>crypto</code> 和老旧 SDK 的代码，根本没法移植到 Bun。</p>
<p>所以我的解决办法是前店后厂。</p>
<p>我用 Bun 搭建了一个极薄的 HTTP 层，专门负责路由、参数校验和挡掉无效请求。只有真正需要那个老旧业务逻辑时，我才通过 IPC（进程间通信）把任务扔给后台常驻的 Node 进程。</p>
<p>千万别在请求来的时候才 <code>spawn</code> 一个 Node 进程，那样比单用 Node 还慢。你要做的是预先启动一组 Node Worker，要先预热才行。。</p>
<p><strong>Bun 端（前台）：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// bun-gateway.ts</span>
<span class="hljs-keyword">const</span> textDecoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();
<span class="hljs-keyword">const</span> textEncoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextEncoder</span>();

<span class="hljs-comment">// 启动一个常驻的 Node 进程，而不是每次请求都启动</span>
<span class="hljs-keyword">const</span> nodeWorker = <span class="hljs-title class_">Bun</span>.<span class="hljs-title function_">spawn</span>([<span class="hljs-string">"node"</span>, <span class="hljs-string">"heavy-lifter.js"</span>], {
  <span class="hljs-attr">stdin</span>: <span class="hljs-string">"pipe"</span>,
  <span class="hljs-attr">stdout</span>: <span class="hljs-string">"pipe"</span>,
});

<span class="hljs-comment">// 这是一个简单的读写封装，把复杂的脏活扔过去</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">askNode</span>(<span class="hljs-params">payload: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">const</span> msg = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload) + <span class="hljs-string">"\n"</span>;
  nodeWorker.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">write</span>(textEncoder.<span class="hljs-title function_">encode</span>(msg));
  
  <span class="hljs-comment">// 这里简化了读取逻辑，生产环境记得处理粘包</span>
  <span class="hljs-keyword">const</span> reader = nodeWorker.<span class="hljs-property">stdout</span>.<span class="hljs-title function_">getReader</span>();
  <span class="hljs-keyword">const</span> { value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>(); 
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(textDecoder.<span class="hljs-title function_">decode</span>(value));
}

<span class="hljs-title class_">Bun</span>.<span class="hljs-title function_">serve</span>({
  <span class="hljs-attr">port</span>: <span class="hljs-number">3000</span>,
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">req</span>) {
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">"/fast"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">"Bun is fast!"</span>);
    
    <span class="hljs-comment">// 只有这种重活才找 Node</span>
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">"/heavy"</span>)) {
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">json</span>();
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">askNode</span>(data);
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>.<span class="hljs-title function_">json</span>(result);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">"404"</span>, { <span class="hljs-attr">status</span>: <span class="hljs-number">404</span> });
  },
});
</code></pre>
<p><strong>Node 端（后台）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// heavy-lifter.js</span>
<span class="hljs-keyword">const</span> readline = <span class="hljs-built_in">require</span>(<span class="hljs-string">'readline'</span>);

<span class="hljs-keyword">const</span> rl = readline.<span class="hljs-title function_">createInterface</span>({
  <span class="hljs-attr">input</span>: process.<span class="hljs-property">stdin</span>,
  <span class="hljs-attr">output</span>: process.<span class="hljs-property">stdout</span>,
  <span class="hljs-attr">terminal</span>: <span class="hljs-literal">false</span>
});

rl.<span class="hljs-title function_">on</span>(<span class="hljs-string">'line'</span>, <span class="hljs-function">(<span class="hljs-params">line</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(line);
  <span class="hljs-comment">// 假装我们在做一个很重的加密运算</span>
  <span class="hljs-comment">// Node 生态里的老代码都在这儿跑，不用改</span>
  <span class="hljs-keyword">const</span> result = { <span class="hljs-attr">processed</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">echo</span>: data };
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result));
});
</code></pre>
<p>这样搞，路由和 I/O 也是亚毫秒级的，而 Node 只需要处理纯计算，效率直接翻倍。</p>
<h3 data-id="heading-1">别让 CPU 搬砖，学会利用 Bun 的零拷贝特性</h3>
<p>我发现服务器 CPU 居高不下，居然是因为我们在读取本地的配置文件和静态 JSON，然后序列化发给用户。</p>
<p>在 Node 里，通常会 <code>fs.readFile</code> 然后 <code>res.send</code>。这中间发生了好几次数据拷贝：从磁盘到内核，到用户空间 buffer，再到 socket。</p>
<p>在 Bun 里，我改用 <code>Bun.file()</code>。这不仅是写法上的区别，这是直接告诉操作系统：“把这个文件扔到网卡上去，别经过我的手。”</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 别再 readFile 了，直接流式传输</span>
<span class="hljs-title class_">Bun</span>.<span class="hljs-title function_">serve</span>({
  <span class="hljs-title function_">fetch</span>(<span class="hljs-params">req</span>) {
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">"/config"</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-title class_">Bun</span>.<span class="hljs-title function_">file</span>(<span class="hljs-string">"./big-config.json"</span>));
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">"404"</span>);
  }
});
</code></pre>
<p>这一行代码改动，让我的静态资源吞吐量提升了 3 倍。</p>
<h3 data-id="heading-2">排好队，微批处理（Micro-batching）</h3>
<p>高并发最可怕的是什么？是 1000 个请求同时涌进来，每个都要单独去调一次数据库或者调一次 Node 进程。就像刚下课，一堆学生全涌到食堂打饭。</p>
<p>而我加了一个极小的缓冲窗口。</p>
<p>如果在 3 毫秒内来了 50 个请求，我把它们打包成一个数组，一次性发给 Node 或者数据库。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">buffer</span>: <span class="hljs-built_in">any</span>[] = [];
<span class="hljs-keyword">let</span> <span class="hljs-attr">timer</span>: <span class="hljs-title class_">Timer</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processBatch</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> currentBatch = buffer;
  buffer = [];
  timer = <span class="hljs-literal">null</span>;
  <span class="hljs-comment">// 一次性把 50 个任务发给 Node，而不是发 50 次</span>
  <span class="hljs-title function_">askNode</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'batch'</span>, <span class="hljs-attr">items</span>: currentBatch });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">enqueue</span>(<span class="hljs-params">item: <span class="hljs-built_in">any</span></span>) {
  buffer.<span class="hljs-title function_">push</span>(item);
  <span class="hljs-comment">// 只有在第一次推进来时启动计时器</span>
  <span class="hljs-keyword">if</span> (!timer) {
    timer = <span class="hljs-built_in">setTimeout</span>(processBatch, <span class="hljs-number">3</span>); <span class="hljs-comment">// 3ms 的延迟用户无感，但吞吐量巨大提升</span>
  }
}
</code></pre>
<p>这 3 毫秒的等待，换来的是 CPU 负载降低 60%。</p>
<h3 data-id="heading-3">别在循环里 <code>new</code> 对象，求你了</h3>
<p>我审查代码时发现，很多人喜欢在 <code>fetch</code> 或者 <code>handleRequest</code> 里写 <code>const db = new DatabaseClient()</code> 或者 <code>const regex = new RegExp(...)</code>。</p>
<p>每次请求都重新分配内存、建立连接、编译正则，GC（垃圾回收）不炸才怪。</p>
<p>把所有能复用的东西——数据库连接池、<code>TextEncoder</code>、正则表达式、加密 Key，全部提到全局作用域。在 Bun 和 Node 混合架构里，这一点非常重要，因为我们追求的是极致的低延迟。</p>
<h3 data-id="heading-4">双层缓存：内存不够，磁盘来凑</h3>
<p>以前我只用 Redis，但网络请求还是有开销。后来我发现，Bun 读取文件的速度超级快。</p>
<p>于是我搞了个双层缓存：</p>
<ol>
<li><strong>L1 内存缓存</strong>：用 LRU 存最热的 1000 个 Key，微秒级响应。</li>
<li><strong>L2 文件缓存</strong>：把稍微冷一点的数据直接写成 JSON 文件放在 <code>/tmp/cache/</code> 下。</li>
</ol>
<p>检查文件是否存在，比发起一个 TCP 请求去连 Redis 要快得多。</p>
<h3 data-id="heading-5">丢掉那些臃肿的 npm 包</h3>
<p>以前在 Node 里，为了生成个 UUID 或者解析个参数，我们习惯性 <code>npm install uuid</code> 或者 <code>qs</code>。</p>
<p>在 Bun 里（其实现代 Node 也是），<code>crypto.randomUUID()</code>、<code>URLSearchParams</code> 都是内置的，而且是 C++ 层面优化的。</p>
<p>我把代码里所有非必要的 npm 依赖全部剔除，改用原生 API。这不仅让冷启动快了，更重要的是减少了 <code>node_modules</code> 的 I/O 噩梦。</p>
<h3 data-id="heading-6">解决精神分裂的开发环境</h3>
<p>这一套架构就是Bun 做网关，Node 做计算。但在本地开发时，我差点崩溃。</p>
<p>我的电脑上本来跑着 Node 22，为了维护老项目，又要装 Node 14，还要装 Bun，甚至偶尔还要用 Deno 跑个脚本。</p>
<p><code>nvm</code> 切换来切换去让我心力交瘁，端口冲突、路径报错、环境变量乱成一锅粥。我经常是修好了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Ffeatures" target="_blank" title="https://www.servbay.com/features" ref="nofollow noopener noreferrer">Bun 环境</a>，Node 的老项目又跑不起来了。</p>
<p>直到我发现了 ServBay，开发者的救命稻草，它不是那种简陋的版本切换器，它是一个完整的、隔离的运行环境平台。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9411342f832407786acd42584bc59a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771403376&amp;x-signature=rBplZLWVhD%2Fb3lXGskCm4YyS93k%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>多版本并存</strong>：我可以同时开启 Node 14、Node 22 和 Bun 1.1 的环境，它们之间完全隔离，互不打架。</li>
<li><strong>一键全家桶</strong>：我需要的 Redis（做缓存）、PostgreSQL（存数据）、Caddy（做反代），它全都能一键安装并运行。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbad57b03a0747999936558ec5442fb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771403376&amp;x-signature=Y9wdnU3O5tNhAEpvgeRhvqbzZXY%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>零配置</strong>：我不由得感叹，以前为了配 Docker 和 Homebrew 浪费了不少时间啊。</li>
</ul>
<p>有了 ServBay，我在本地完美复刻了线上的混合架构：Bun 监听 3000 端口，Node 监听内部管道，Redis 跑在后台。我再也不用担心这是环境问题还是代码问题了。</p>
<h3 data-id="heading-7">总结</h3>
<p>只要能把响应时间压进 10ms，我不在乎混用多少种运行时。</p>
<p>Bun 给了我速度，Node 给了我稳定性，ServBay 给了我一个不发疯的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com" target="_blank" title="https://www.servbay.com" ref="nofollow noopener noreferrer">开发环境</a>。</p>
<p>别再纠结用 Bun 还是用 Node.js了，都成年人了，为什么不能两个都要。把它们结合起来，现在就去把你的 API 延迟砍掉 90%。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决 IntelliJ IDEA 运行 Spring Boot 测试时“命令行过长”错误]]></title>    <link>https://juejin.cn/post/7605213691910455322</link>    <guid>https://juejin.cn/post/7605213691910455322</guid>    <pubDate>2026-02-11T08:32:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605213691910455322" data-draft-id="7605213691910438938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决 IntelliJ IDEA 运行 Spring Boot 测试时“命令行过长”错误"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T08:32:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大黄评测"/> <meta itemprop="url" content="https://juejin.cn/user/714024404135696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决 IntelliJ IDEA 运行 Spring Boot 测试时“命令行过长”错误
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/714024404135696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大黄评测
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:32:08.000Z" title="Wed Feb 11 2026 08:32:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">解决 IntelliJ IDEA 运行 Spring Boot 测试时“命令行过长”错误</h2>
<p>在使用 IntelliJ IDEA 开发 Spring Boot 项目时，不少开发者会遇到一个令人头疼的问题：<strong>运行单元测试或集成测试时提示“命令行过长”（Command line is too long）</strong> 。这个问题通常出现在 Windows 系统上，尤其当项目依赖较多、类路径（classpath）非常长时更容易触发。</p>
<p>本文将深入分析该问题的成因，并提供几种实用有效的解决方案，帮助你快速恢复开发效率。</p>
<hr/>
<h3 data-id="heading-1">一、问题现象</h3>
<p>当你尝试在 IDEA 中运行某个 Spring Boot 测试类（如 <code>@SpringBootTest</code> 标注的测试）时，控制台可能输出如下错误：</p>
<pre><code class="hljs language-arduino" lang="arduino">Error running <span class="hljs-string">'MyApplicationTests'</span>: Command line is too <span class="hljs-type">long</span>. Shorten command line <span class="hljs-keyword">for</span> MyApplicationTests <span class="hljs-keyword">or</span> also <span class="hljs-keyword">for</span> Application <span class="hljs-keyword">default</span> configuration.
</code></pre>
<p>IDEA 会弹出提示框，建议你“缩短命令行”。</p>
<hr/>
<h3 data-id="heading-2">二、问题原因</h3>
<p>该错误的根本原因在于 <strong>操作系统对命令行长度的限制</strong>：</p>
<ul>
<li>在 Windows 系统中，命令行最大长度通常为 <strong>32767 个字符</strong>。</li>
<li>当项目依赖较多（尤其是微服务项目或使用了大量 starter）时，JVM 启动参数中的 <code>-classpath</code> 会变得极其冗长。</li>
<li>IDEA 默认使用“完整 classpath”方式启动测试进程，导致命令行超出系统限制。</li>
</ul>
<p>macOS 和 Linux 系统虽然限制较宽松，但在极端情况下也可能出现类似问题。</p>
<hr/>
<h3 data-id="heading-3">三、解决方案</h3>
<h4 data-id="heading-4">✅ 方法一：修改运行配置的“Shorten command line”选项（推荐）</h4>
<p>这是最简单直接的解决方式：</p>
<ol>
<li>
<p>在 IDEA 中，点击右上角运行配置下拉菜单，选择 <strong>Edit Configurations...</strong> 。</p>
</li>
<li>
<p>在左侧选择你的测试类（或 Application 默认配置）。</p>
</li>
<li>
<p>找到 <strong>“Shorten command line”</strong> 选项（通常在 Environment 或 Environment variables 下方）。</p>
</li>
<li>
<p>将其值从默认的 <strong>“none”</strong> 改为以下任一选项：</p>
<ul>
<li><strong>JAR manifest</strong>（推荐）：将 classpath 写入临时 JAR 的 MANIFEST.MF 文件中。</li>
<li><strong>classpath file</strong>：将 classpath 写入一个临时文件，通过 <code>@argfile</code> 方式传入（适用于 JDK 9+）。</li>
</ul>
</li>
<li>
<p>点击 <strong>OK</strong>，重新运行测试。</p>
</li>
</ol>
<blockquote>
<p>💡 提示：你也可以在 <strong>Run → Edit Configurations → Templates → JUnit</strong> 中修改默认模板，避免每次新建测试都需手动设置。</p>
</blockquote>
<hr/>
<h4 data-id="heading-5">✅ 方法二：全局修改默认运行配置</h4>
<p>如果你希望所有新创建的测试类都自动应用该设置：</p>
<ol>
<li>打开 <strong>Run → Edit Configurations...</strong></li>
<li>在左侧展开 <strong>Templates → JUnit</strong></li>
<li>修改 <strong>Shorten command line</strong> 为 <strong>JAR manifest</strong> 或 <strong>classpath file</strong></li>
<li>保存后，所有后续新建的测试都会继承此配置。</li>
</ol>
<hr/>
<h4 data-id="heading-6">✅ 方法三：使用 Gradle / Maven 命令行运行测试（绕过 IDEA）</h4>
<p>如果暂时不想调整 IDEA 设置，也可以直接通过终端运行测试：</p>
<ul>
<li>
<p><strong>Maven 项目</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">./mvnw <span class="hljs-built_in">test</span> -Dtest=MyApplicationTests
</code></pre>
</li>
<li>
<p><strong>Gradle 项目</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">./gradlew <span class="hljs-built_in">test</span> --tests <span class="hljs-string">"com.example.MyApplicationTests"</span>
</code></pre>
</li>
</ul>
<p>这种方式完全绕过 IDEA 的 JVM 启动机制，自然不会受命令行长度限制。</p>
<hr/>
<h4 data-id="heading-7">⚠️ 注意事项</h4>
<ul>
<li><strong>JAR manifest 方式</strong> 要求临时 JAR 的 MANIFEST.MF 中 classpath 不能超过 72 字符/行（Java 规范），但 IDEA 会自动处理换行，一般无需担心。</li>
<li>如果使用 <strong>远程调试</strong> 或 <strong>自定义 JVM 参数</strong>，确保这些参数不会进一步加剧命令行膨胀。</li>
<li>某些旧版 IDEA（如 2020 之前）可能不支持 <code>@argfile</code>（classpath file），建议优先使用 <strong>JAR manifest</strong>。</li>
</ul>
<hr/>
<h3 data-id="heading-8">四、总结</h3>
<p>“命令行过长”是 IDEA 在 Windows 上运行大型 Java 项目时的常见问题，尤其在 Spring Boot 项目中更为突出。通过合理配置 <strong>Shorten command line</strong> 选项，即可轻松绕过系统限制，无需修改代码或项目结构。</p>
<blockquote>
<p><strong>最佳实践</strong>：在团队协作中，建议将默认测试运行配置统一设为 “JAR manifest”，并通过 <code>.idea/runConfigurations</code> 提交共享配置（可选），提升团队开发体验。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 整合 LibreOffice：本地调用、远程服务与 Docker 一体化部署实战]]></title>    <link>https://juejin.cn/post/7605135197166977074</link>    <guid>https://juejin.cn/post/7605135197166977074</guid>    <pubDate>2026-02-11T08:36:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605135197166977074" data-draft-id="7605157203591512091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 整合 LibreOffice：本地调用、远程服务与 Docker 一体化部署实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T08:36:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大鹏1988"/> <meta itemprop="url" content="https://juejin.cn/user/2526022571922992"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 整合 LibreOffice：本地调用、远程服务与 Docker 一体化部署实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2526022571922992/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大鹏1988
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:36:09.000Z" title="Wed Feb 11 2026 08:36:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring Boot 整合 LibreOffice：本地调用、远程服务与 Docker 一体化部署实战</h2>
<p>在企业级应用中，文档格式转换（如 Word 转 PDF、Excel 转 HTML）是常见需求。LibreOffice 作为开源、免费且功能强大的办公套件，提供了命令行接口，非常适合集成到 Java 应用中实现自动化文档处理。</p>
<p>本文将详细介绍 <strong>Spring Boot 项目整合 LibreOffice 的两种主流方式</strong>：</p>
<ol>
<li><strong>调用本地安装的 LibreOffice（适用于单机或轻量场景）</strong></li>
<li><strong>调用远程 LibreOffice 服务（适用于微服务、高并发或容器化架构）</strong></li>
</ol>
<p>并进一步演示如何通过 <strong>Docker Compose</strong> 将 Spring Boot 应用与 LibreOffice 容器 <strong>一体化部署</strong>，实现开箱即用的文档转换服务。</p>
<hr/>
<h3 data-id="heading-1">一、准备工作</h3>
<h4 data-id="heading-2">技术栈</h4>
<ul>
<li>Spring Boot 3.x（Java 17+）</li>
<li>LibreOffice 7.0+</li>
<li>Docker &amp; Docker Compose</li>
<li>Apache Commons IO（用于文件操作）</li>
</ul>
<h4 data-id="heading-3">Maven 依赖（<code>pom.xml</code>）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.15.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">二、方式一：调用本地 LibreOffice（进程调用）</h3>
<p>适用于开发环境或单机部署，直接通过 <code>ProcessBuilder</code> 调用系统中已安装的 LibreOffice。</p>
<h4 data-id="heading-5">1. 安装 LibreOffice（Linux 示例）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># Ubuntu/Debian</span>
sudo apt-<span class="hljs-keyword">get</span> install libreoffice

<span class="hljs-meta"># CentOS/RHEL</span>
sudo yum install libreoffice-headless
</code></pre>
<blockquote>
<p>⚠️ 生产环境建议安装 <code>libreoffice-headless</code>（无图形界面版本），节省资源。</p>
</blockquote>
<h4 data-id="heading-6">2. 编写转换工具类</h4>
<pre><code class="hljs language-arduino" lang="arduino">@Service
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalLibreOfficeService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> LIBREOFFICE_PATH = <span class="hljs-string">"/usr/bin/libreoffice"</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">convertToPdf</span><span class="hljs-params">(<span class="hljs-built_in">File</span> inputFile, <span class="hljs-built_in">File</span> outputFile)</span> throws IOException, InterruptedException </span>{
        <span class="hljs-type">String</span> outputDir = outputFile.<span class="hljs-built_in">getParent</span>();

        ProcessBuilder builder = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ProcessBuilder</span>(
            LIBREOFFICE_PATH,
            <span class="hljs-string">"--headless"</span>,
            <span class="hljs-string">"--convert-to"</span>, <span class="hljs-string">"pdf"</span>,
            <span class="hljs-string">"--outdir"</span>, outputDir,
            inputFile.<span class="hljs-built_in">getAbsolutePath</span>()
        );

        <span class="hljs-built_in">Process</span> process = builder.<span class="hljs-built_in">start</span>();
        <span class="hljs-type">int</span> exitCode = process.<span class="hljs-built_in">waitFor</span>();

        <span class="hljs-keyword">if</span> (exitCode != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"LibreOffice conversion failed with exit code: "</span> + exitCode);
        }

        <span class="hljs-comment">// 重命名生成的文件（LibreOffice 默认保留原文件名）</span>
        <span class="hljs-built_in">File</span> generated = <span class="hljs-keyword">new</span> <span class="hljs-built_in">File</span>(outputDir, 
            FilenameUtils.<span class="hljs-built_in">getBaseName</span>(inputFile.<span class="hljs-built_in">getName</span>()) + <span class="hljs-string">".pdf"</span>);
        <span class="hljs-keyword">if</span> (!generated.<span class="hljs-built_in">renameTo</span>(outputFile)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"Failed to rename output file"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-7">3. 控制器示例</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/convert/local"</span>)
public ResponseEntity&lt;Resource&gt; <span class="hljs-built_in">convertLocal</span>(<span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"file"</span>) MultipartFile file) 
    throws IOException, InterruptedException {
    
    <span class="hljs-selector-tag">File</span> <span class="hljs-selector-tag">input</span> = <span class="hljs-selector-tag">File</span><span class="hljs-selector-class">.createTempFile</span>(<span class="hljs-string">"input_"</span>, <span class="hljs-string">"."</span> + <span class="hljs-built_in">getExtension</span>(file.<span class="hljs-built_in">getOriginalFilename</span>()));
    <span class="hljs-selector-tag">File</span> <span class="hljs-selector-tag">output</span> = <span class="hljs-selector-tag">File</span><span class="hljs-selector-class">.createTempFile</span>(<span class="hljs-string">"output_"</span>, <span class="hljs-string">".pdf"</span>);

    <span class="hljs-selector-tag">file</span><span class="hljs-selector-class">.transferTo</span>(input);
    <span class="hljs-selector-tag">localLibreOfficeService</span><span class="hljs-selector-class">.convertToPdf</span>(input, output);

    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>()
        <span class="hljs-selector-class">.contentType</span>(MediaType.APPLICATION_PDF)
        <span class="hljs-selector-class">.body</span>(new <span class="hljs-built_in">ByteArrayResource</span>(Files.<span class="hljs-built_in">readAllBytes</span>(output.<span class="hljs-built_in">toPath</span>())));
}
</code></pre>
<p>✅ <strong>优点</strong>：简单直接，无需额外服务<br/>
❌ <strong>缺点</strong>：耦合本地环境，难以横向扩展，多进程竞争资源</p>
<hr/>
<h3 data-id="heading-8">三、方式二：调用远程 LibreOffice 服务（推荐生产使用）</h3>
<p>将 LibreOffice 封装为独立的 REST 服务（或使用现成方案如 <strong>unoconv + Flask</strong> 或 <strong>Gotenberg</strong>），Spring Boot 通过 HTTP 调用。</p>
<blockquote>
<p>本文采用 <strong>Gotenberg</strong> —— 一个基于 Docker 的现代化文档转换微服务，支持 LibreOffice、Chrome 等引擎。</p>
</blockquote>
<h4 data-id="heading-9">1. 启动 Gotenberg 服务（Docker）</h4>
<pre><code class="hljs language-bash" lang="bash">docker run --<span class="hljs-built_in">rm</span> -p 3000:3000 thecodingmachine/gotenberg:8
</code></pre>
<p>Gotenberg 提供 <code>/forms/libreoffice/convert</code> 接口用于文档转换。</p>
<h4 data-id="heading-10">2. Spring Boot 调用远程服务</h4>
<pre><code class="hljs language-arduino" lang="arduino">@Service
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteLibreOfficeService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RestTemplate restTemplate;
    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> GOTENBERG_URL = <span class="hljs-string">"http://localhost:3000"</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RemoteLibreOfficeService</span><span class="hljs-params">(RestTemplate restTemplate)</span> </span>{
        <span class="hljs-keyword">this</span>.restTemplate = restTemplate;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] <span class="hljs-built_in">convertToPdf</span>(MultipartFile file) {
        LinkedMultiValueMap&lt;<span class="hljs-type">String</span>, Object&gt; map = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;&gt;();
        map.<span class="hljs-built_in">add</span>(<span class="hljs-string">"files"</span>, <span class="hljs-keyword">new</span> <span class="hljs-built_in">ByteArrayResource</span>(file.<span class="hljs-built_in">getBytes</span>()) {
            @Override
            <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-built_in">getFilename</span>() {
                <span class="hljs-keyword">return</span> file.<span class="hljs-built_in">getOriginalFilename</span>();
            }
        });

        HttpHeaders headers = <span class="hljs-keyword">new</span> <span class="hljs-built_in">HttpHeaders</span>();
        headers.<span class="hljs-built_in">setContentType</span>(MediaType.MULTIPART_FORM_DATA);

        HttpEntity&lt;LinkedMultiValueMap&lt;<span class="hljs-type">String</span>, Object&gt;&gt; request = 
            <span class="hljs-keyword">new</span> HttpEntity&lt;&gt;(map, headers);

        <span class="hljs-keyword">return</span> restTemplate.<span class="hljs-built_in">postForObject</span>(
            GOTENBERG_URL + <span class="hljs-string">"/forms/libreoffice/convert"</span>,
            request,
            <span class="hljs-type">byte</span>[].<span class="hljs-keyword">class</span>
        );
    }
}
</code></pre>
<h4 data-id="heading-11">3. 控制器调用</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/convert/remote"</span>)
public ResponseEntity&lt;Resource&gt; <span class="hljs-built_in">convertRemote</span>(<span class="hljs-variable">@RequestParam</span>(<span class="hljs-string">"file"</span>) MultipartFile file) {
    <span class="hljs-selector-tag">byte</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">pdfBytes</span> = <span class="hljs-selector-tag">remoteLibreOfficeService</span><span class="hljs-selector-class">.convertToPdf</span>(file);
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>()
        <span class="hljs-selector-class">.contentType</span>(MediaType.APPLICATION_PDF)
        <span class="hljs-selector-class">.body</span>(new <span class="hljs-built_in">ByteArrayResource</span>(pdfBytes));
}
</code></pre>
<p>✅ <strong>优点</strong>：</p>
<ul>
<li>解耦应用与 LibreOffice</li>
<li>可独立扩缩容</li>
<li>支持多种格式（PDF、PNG、TXT 等）</li>
<li>内置重试、超时、限流机制（可通过 Nginx 或服务网格增强）</li>
</ul>
<hr/>
<h3 data-id="heading-12">四、Docker 一体化部署：Spring Boot + LibreOffice</h3>
<p>为了实现“一键部署”，我们使用 <strong>Docker Compose</strong> 同时启动应用和 LibreOffice 服务。</p>
<blockquote>
<p>方案选择：<strong>Gotenberg 容器 + 自定义 Spring Boot 容器</strong></p>
</blockquote>
<h4 data-id="heading-13">1. <code>Dockerfile</code>（Spring Boot 应用）</h4>
<pre><code class="hljs language-bash" lang="bash">FROM eclipse-temurin:17-jre-alpine
COPY target/app.jar /app.jar
EXPOSE 8080
ENTRYPOINT [<span class="hljs-string">"java"</span>, <span class="hljs-string">"-jar"</span>, <span class="hljs-string">"/app.jar"</span>]
</code></pre>
<h4 data-id="heading-14">2. <code>docker-compose.yml</code></h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">app:</span>
    <span class="hljs-attr">build:</span> <span class="hljs-string">.</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:8080"</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">gotenberg</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">GOTENBERG_URL=http://gotenberg:3000</span>

  <span class="hljs-attr">gotenberg:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">thecodingmachine/gotenberg:8</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3000:3000"</span>
</code></pre>
<h4 data-id="heading-15">3. 修改 Spring Boot 配置（支持动态 URL）</h4>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># application.yml</span>
<span class="hljs-symbol">gotenberg:</span>
  <span class="hljs-symbol">url:</span> <span class="hljs-variable">${</span><span class="hljs-variable constant_">GOTENBERG_URL</span><span class="hljs-symbol">:http</span><span class="hljs-symbol">://localhost</span><span class="hljs-symbol">:</span><span class="hljs-number">3000</span>}
</code></pre>
<p>并在 <code>RemoteLibreOfficeService</code> 中注入配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Value(<span class="hljs-string">"<span class="hljs-subst">${gotenberg.url}</span>"</span>)</span>
<span class="hljs-keyword">private</span> String gotenbergUrl;
</code></pre>
<h4 data-id="heading-16">4. 构建并启动</h4>
<pre><code class="hljs language-lua" lang="lua">./mvnw clean <span class="hljs-built_in">package</span> -DskipTests
docker-compose up <span class="hljs-comment">--build</span>
</code></pre>
<p>访问：</p>
<ul>
<li>应用：<code>http://localhost:8080/convert/remote</code></li>
<li>Gotenberg UI：<code>http://localhost:3000</code></li>
</ul>
<hr/>
<h3 data-id="heading-17">五、对比总结</h3>

































<table><thead><tr><th>方式</th><th>适用场景</th><th>扩展性</th><th>维护成本</th><th>推荐度</th></tr></thead><tbody><tr><td>本地调用</td><td>开发、测试、小型单机应用</td><td>差</td><td>低</td><td>⭐⭐</td></tr><tr><td>远程服务（Gotenberg）</td><td>微服务、生产环境、高并发</td><td>高</td><td>中</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>Docker 一体化</td><td>快速交付、CI/CD、演示环境</td><td>高</td><td>低（容器化后）</td><td>⭐⭐⭐⭐</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">六、注意事项</h3>
<ol>
<li><strong>文件安全</strong>：上传文件需校验类型、大小，防止恶意文档攻击。</li>
<li><strong>临时文件清理</strong>：使用 <code>@Scheduled</code> 定期清理 <code>/tmp</code> 中的临时文件。</li>
<li><strong>超时控制</strong>：LibreOffice 转换大文件可能耗时较长，需设置合理超时（如 60s）。</li>
<li><strong>并发限制</strong>：LibreOffice 单实例并发能力有限，高并发场景建议部署多个 Gotenberg 实例 + 负载均衡。</li>
</ol>
<hr/>
<h3 data-id="heading-19">结语</h3>
<p>通过本文，你已掌握 Spring Boot 与 LibreOffice 集成的 <strong>三种部署形态</strong>：从简单的本地调用，到解耦的远程服务，再到容器化的一体化部署。无论你是构建内部工具还是对外 SaaS 产品，都能找到合适的方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始搭建 Hadoop 完全分布式集群（超详细图文指南）]]></title>    <link>https://juejin.cn/post/7605136148592853019</link>    <guid>https://juejin.cn/post/7605136148592853019</guid>    <pubDate>2026-02-11T08:35:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605136148592853019" data-draft-id="7605136148592820251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始搭建 Hadoop 完全分布式集群（超详细图文指南）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T08:35:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大尚来也"/> <meta itemprop="url" content="https://juejin.cn/user/1681597639955488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始搭建 Hadoop 完全分布式集群（超详细图文指南）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1681597639955488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大尚来也
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:35:15.000Z" title="Wed Feb 11 2026 08:35:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零开始搭建 Hadoop 完全分布式集群（超详细图文指南）</h2>
<blockquote>
<p>面向零基础用户，手把手教你部署一个可运行的 Hadoop 完全分布式环境</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、前言：什么是“完全分布式”？</h3>
<p>Hadoop 支持三种运行模式：</p>
<ul>
<li><strong>本地模式（Standalone）</strong> ：单机运行，无 HDFS，仅用于调试。</li>
<li><strong>伪分布式模式（Pseudo-Distributed）</strong> ：单机模拟多进程，所有守护进程运行在同一台机器上。</li>
<li><strong>完全分布式模式（Fully Distributed）</strong> ：真正的集群部署，NameNode、DataNode、ResourceManager 等角色分布在多台物理或虚拟机上。</li>
</ul>
<p>本文将带你从零开始，在 <strong>3 台 Linux 虚拟机</strong> 上搭建一个最小可用的 Hadoop 完全分布式集群（1 个 NameNode + 2 个 DataNode），适合学习、实验和小型开发环境。</p>
<hr/>
<h3 data-id="heading-2">二、准备工作</h3>
<h4 data-id="heading-3">1. 硬件与软件要求</h4>

























<table><thead><tr><th>组件</th><th>要求</th></tr></thead><tbody><tr><td>操作系统</td><td>CentOS 7 / Ubuntu 20.04（推荐 CentOS 7）</td></tr><tr><td>虚拟机数量</td><td>3 台（内存建议 ≥2GB/台）</td></tr><tr><td>JDK</td><td>OpenJDK 8 或 Oracle JDK 8（Hadoop 3.x 不兼容 JDK 11+ 的部分特性）</td></tr><tr><td>Hadoop 版本</td><td>Hadoop 3.3.6（稳定版）</td></tr></tbody></table>
<blockquote>
<p>💡 提示：本文以 <strong>CentOS 7 + Hadoop 3.3.6 + OpenJDK 8</strong> 为例。</p>
</blockquote>
<h4 data-id="heading-4">2. 节点规划</h4>

























<table><thead><tr><th>主机名</th><th>IP 地址</th><th>角色</th></tr></thead><tbody><tr><td>hadoop101</td><td>192.168.10.101</td><td>NameNode, ResourceManager</td></tr><tr><td>hadoop102</td><td>192.168.10.102</td><td>DataNode, NodeManager</td></tr><tr><td>hadoop103</td><td>192.168.10.103</td><td>DataNode, NodeManager</td></tr></tbody></table>
<blockquote>
<p>✅ 建议使用固定 IP，避免 DHCP 变化导致集群失效。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">三、基础环境配置（每台机器都要做）</h3>
<h4 data-id="heading-6">步骤 1：设置主机名</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 在 hadoop101 上执行</span>
sudo hostnamectl <span class="hljs-keyword">set</span>-hostname hadoop101

<span class="hljs-meta"># 在 hadoop102 上执行</span>
sudo hostnamectl <span class="hljs-keyword">set</span>-hostname hadoop102

<span class="hljs-meta"># 在 hadoop103 上执行</span>
sudo hostnamectl <span class="hljs-keyword">set</span>-hostname hadoop103
</code></pre>
<h4 data-id="heading-7">步骤 2：配置 hosts 文件（三台机器同步）</h4>
<p>编辑 <code>/etc/hosts</code>，添加以下内容：</p>
<pre><code class="hljs">192.168.10.101 hadoop101
192.168.10.102 hadoop102
192.168.10.103 hadoop103
</code></pre>
<blockquote>
<p>✅ 执行 <code>ping hadoop102</code> 测试是否能解析。</p>
</blockquote>
<h4 data-id="heading-8">步骤 3：关闭防火墙（实验环境）</h4>
<pre><code class="hljs language-arduino" lang="arduino">sudo systemctl stop firewalld
sudo systemctl disable firewalld
</code></pre>
<blockquote>
<p>🔒 生产环境应配置安全组或 iptables 规则，而非直接关闭。</p>
</blockquote>
<h4 data-id="heading-9">步骤 4：安装 OpenJDK 8</h4>
<pre><code class="hljs">sudo yum install -y java-1.8.0-openjdk-devel
</code></pre>
<p>验证安装：</p>
<pre><code class="hljs">java -version
javac -version
</code></pre>
<h4 data-id="heading-10">步骤 5：配置 SSH 免密登录（关键！）</h4>
<p>Hadoop 集群依赖 SSH 进行节点间通信。需在 <strong>NameNode（hadoop101）</strong> 上生成密钥，并分发到所有节点。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 在 hadoop101 上操作</span>
ssh-keygen -t rsa -P <span class="hljs-string">''</span> -f ~/.ssh/id_rsa

<span class="hljs-comment"># 分发公钥到所有节点（包括自己）</span>
ssh-copy-<span class="hljs-built_in">id</span> hadoop101
ssh-copy-<span class="hljs-built_in">id</span> hadoop102
ssh-copy-<span class="hljs-built_in">id</span> hadoop103
</code></pre>
<p>测试免密登录：</p>
<pre><code class="hljs language-bash" lang="bash">ssh hadoop102  <span class="hljs-comment"># 应无需密码直接登录</span>
</code></pre>
<blockquote>
<p>⚠️ 若提示“Permission denied”，请确保目标机器的 <code>/etc/ssh/sshd_config</code> 中 <code>PubkeyAuthentication yes</code> 已启用，并重启 sshd：<code>sudo systemctl restart sshd</code></p>
</blockquote>
<hr/>
<h3 data-id="heading-11">四、安装与配置 Hadoop</h3>
<h4 data-id="heading-12">步骤 1：下载并解压 Hadoop</h4>
<p>在 <strong>hadoop101</strong> 上操作：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /opt
wget https://archive.apache.org/dist/hadoop/core/hadoop-3.3.6/hadoop-3.3.6.tar.gz
tar -zxvf hadoop-3.3.6.tar.gz
<span class="hljs-built_in">mv</span> hadoop-3.3.6 hadoop
</code></pre>
<h4 data-id="heading-13">步骤 2：配置环境变量</h4>
<p>编辑 <code>~/.bashrc</code>（或 <code>/etc/profile</code>）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> HADOOP_HOME=/opt/hadoop
<span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$HADOOP_HOME</span>/bin:<span class="hljs-variable">$HADOOP_HOME</span>/sbin
<span class="hljs-built_in">export</span> HADOOP_CONF_DIR=<span class="hljs-variable">$HADOOP_HOME</span>/etc/hadoop
</code></pre>
<p>生效配置：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">source</span> ~/.bashrc
</code></pre>
<h4 data-id="heading-14">步骤 3：分发 Hadoop 到其他节点</h4>
<pre><code class="hljs language-bash" lang="bash">scp -r /opt/hadoop hadoop102:/opt/
scp -r /opt/hadoop hadoop103:/opt/
</code></pre>
<p>并在 hadoop102、hadoop103 上同样配置 <code>~/.bashrc</code> 中的环境变量。</p>
<hr/>
<h3 data-id="heading-15">五、核心配置文件修改（在 hadoop101 上操作）</h3>
<p>进入 <code>$HADOOP_HOME/etc/hadoop</code> 目录，修改以下文件：</p>
<h4 data-id="heading-16">1. <code>core-site.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>fs.defaultFS<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hdfs://hadoop101:9000<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>hadoop.tmp.dir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>/opt/hadoop/data/tmp<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-17">2. <code>hdfs-site.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.replication<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span> <span class="hljs-comment">&lt;!-- 副本数不超过 DataNode 数量 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.namenode.name.dir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>/opt/hadoop/data/namenode<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>dfs.datanode.data.dir<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>/opt/hadoop/data/datanode<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-18">3. <code>yarn-site.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.aux-services<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>mapreduce_shuffle<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.resourcemanager.hostname<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hadoop101<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>yarn.nodemanager.vmem-check-enabled<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span> <span class="hljs-comment">&lt;!-- 避免内存检查失败 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-19">4. <code>mapred-site.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>mapreduce.framework.name<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>yarn<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-20">5. <code>workers</code> 文件（替代旧版 slaves）</h4>
<pre><code class="hljs">hadoop102
hadoop103
</code></pre>
<blockquote>
<p>✅ 注意：Hadoop 3.x 使用 <code>workers</code> 文件定义 DataNode 和 NodeManager 节点。</p>
</blockquote>
<hr/>
<h3 data-id="heading-21">六、格式化 NameNode 并启动集群</h3>
<h4 data-id="heading-22">1. 格式化 HDFS（仅首次执行！）</h4>
<pre><code class="hljs language-lua" lang="lua">hdfs namenode -<span class="hljs-built_in">format</span>
</code></pre>
<blockquote>
<p>⚠️ 重复执行会清空 HDFS 数据！</p>
</blockquote>
<h4 data-id="heading-23">2. 启动 HDFS</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">start</span><span class="hljs-operator">-</span>dfs.sh
</code></pre>
<h4 data-id="heading-24">3. 启动 YARN</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">start</span><span class="hljs-operator">-</span>yarn.sh
</code></pre>
<h4 data-id="heading-25">4. 验证进程</h4>
<ul>
<li><strong>hadoop101</strong> 应有：NameNode、SecondaryNameNode、ResourceManager</li>
<li><strong>hadoop102 / hadoop103</strong> 应有：DataNode、NodeManager</li>
</ul>
<p>使用 <code>jps</code> 命令查看。</p>
<h4 data-id="heading-26">5. Web UI 验证</h4>
<ul>
<li>HDFS 管理界面：<a href="https://link.juejin.cn?target=http%3A%2F%2Fhadoop101%3A9870" target="_blank" title="http://hadoop101:9870" ref="nofollow noopener noreferrer">http://hadoop101:9870</a></li>
<li>YARN 资源管理器：<a href="https://link.juejin.cn?target=http%3A%2F%2Fhadoop101%3A8088" target="_blank" title="http://hadoop101:8088" ref="nofollow noopener noreferrer">http://hadoop101:8088</a></li>
</ul>
<blockquote>
<p>✅ 若无法访问，请检查防火墙或网络配置。</p>
</blockquote>
<hr/>
<h3 data-id="heading-27">七、运行 WordCount 示例测试</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建 HDFS 目录</span>
hdfs dfs -<span class="hljs-built_in">mkdir</span> /input

<span class="hljs-comment"># 上传本地文件</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"hello hadoop hello world"</span> &gt; /tmp/test.txt
hdfs dfs -put /tmp/test.txt /input

<span class="hljs-comment"># 运行 MapReduce 任务</span>
hadoop jar <span class="hljs-variable">$HADOOP_HOME</span>/share/hadoop/mapreduce/hadoop-mapreduce-examples-3.3.6.jar wordcount /input /output

<span class="hljs-comment"># 查看结果</span>
hdfs dfs -<span class="hljs-built_in">cat</span> /output/*
</code></pre>
<p>若输出：</p>
<pre><code class="hljs">hadoop	1
hello	2
world	1
</code></pre>
<p>说明集群运行成功！</p>
<hr/>
<h3 data-id="heading-28">八、常见问题排查</h3>

























<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>DataNode 无法启动</td><td>检查 <code>workers</code> 文件、SSH 免密、时间同步</td></tr><tr><td>NameNode 格式化失败</td><td>删除 <code>hadoop.tmp.dir</code> 目录后重试</td></tr><tr><td>Web UI 无法访问</td><td>关闭防火墙或开放 9870/8088 端口</td></tr><tr><td>“NativeIO” 报错</td><td>忽略（不影响功能），或编译 native 库</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-29">九、结语</h3>
<p>通过本文，你已成功搭建了一个 <strong>3 节点的 Hadoop 完全分布式集群</strong>。虽然步骤较多，但每一步都是理解 Hadoop 架构的关键。掌握此过程，不仅有助于学习大数据生态（如 Hive、HBase、Spark），也为后续深入分布式系统打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[离线安装Nginx（Linux环境且无root权限）]]></title>    <link>https://juejin.cn/post/7605206033266573347</link>    <guid>https://juejin.cn/post/7605206033266573347</guid>    <pubDate>2026-02-11T08:37:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605206033266573347" data-draft-id="7605114376803893288" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="离线安装Nginx（Linux环境且无root权限）"/> <meta itemprop="keywords" content="Nginx"/> <meta itemprop="datePublished" content="2026-02-11T08:37:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小闫同学yxy"/> <meta itemprop="url" content="https://juejin.cn/user/2455659411145513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            离线安装Nginx（Linux环境且无root权限）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2455659411145513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小闫同学yxy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:37:05.000Z" title="Wed Feb 11 2026 08:37:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">📂 第一步：准备安装包（在有网络的电脑上操作）</h3>
<p>下载以下文件（可根据实际需求调整），并将它们上传到服务器的 <code>/home/mca/</code> 目录下。</p>
<ol>
<li>
<p><strong>Nginx</strong>: 下载 <code>.tar.gz</code> 压缩包。</p>
<ul>
<li>例如：<code>nginx-1.22.1.tar.gz</code></li>
</ul>
</li>
<li>
<p><strong>Nginx 依赖库</strong>（必须！因为离线且无权限）：</p>
<ul>
<li><code>pcre-8.45.tar.gz</code> (用于解析正则表达式)</li>
<li><code>zlib-1.2.13.tar.gz</code> (用于 gzip 压缩)</li>
<li><code>openssl-1.1.1w.tar.gz</code> (用于 HTTPS)</li>
</ul>
</li>
</ol>
<h3 data-id="heading-1">🛠️ 第二步：登录服务器并创建目录结构</h3>
<p>假设已经将上述 4 个文件上传到了 <code>/home/mca/</code> 目录。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建必要的目录结构</span>
<span class="hljs-built_in">cd</span> /home/mca/
<span class="hljs-built_in">mkdir</span> -p software  <span class="hljs-comment"># 用于存放安装包</span>
<span class="hljs-built_in">mkdir</span> -p app       <span class="hljs-comment"># 用于存放编译/解压后的程序</span>
​
<span class="hljs-comment"># 2. 将上传的安装包移动到 software 目录（如果还没在该目录下）</span>
<span class="hljs-built_in">mv</span> *.tar.gz software/
<span class="hljs-built_in">cd</span> software
</code></pre>
<h3 data-id="heading-2">🌐 第三步：编译安装 Nginx（关键步骤）</h3>
<p>由于是离线且无 <code>root</code> 权限，必须在 <code>configure</code> 阶段指定依赖库的源码路径和安装路径。</p>
<ol start="0">
<li>
<p><strong>解压 Nginx 和依赖</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /home/mca/software
<span class="hljs-comment"># 解压 Nginx</span>
tar -zxvf nginx-1.22.1.tar.gz
<span class="hljs-comment"># 解压依赖库（必须解压在 software 目录下，方便 Nginx 找到）</span>
tar -zxvf pcre-8.45.tar.gz
tar -zxvf zlib-1.2.13.tar.gz
tar -zxvf openssl-1.1.1w.tar.gz
</code></pre>
</li>
<li>
<p><strong>编译安装</strong></p>
<ul>
<li>
<p>进入 Nginx 源码目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> nginx-1.22.1
</code></pre>
</li>
<li>
<p>执行配置命令（关键：<code>--prefix</code> 指定安装到有权限的目录）：</p>
<pre><code class="hljs language-ini" lang="ini">./configure \
<span class="hljs-attr">--prefix</span>=/home/mca/app/nginx \
<span class="hljs-attr">--with-pcre</span>=../pcre-<span class="hljs-number">8.45</span> \
<span class="hljs-attr">--with-zlib</span>=../zlib-<span class="hljs-number">1.2</span>.<span class="hljs-number">13</span> \
<span class="hljs-attr">--with-openssl</span>=../openssl-<span class="hljs-number">1.1</span>.<span class="hljs-number">1</span>w \
--with-http_ssl_module
</code></pre>
</li>
<li>
<p>如果上面命令报错，通常是因为缺少 <code>gcc</code> 编译器。请确认 <code>gcc --version</code> 是否能运行（这需要管理员在离线环境下安装 <code>gcc</code> RPM 包，属于系统基础环境，不属于应用安装包）。</p>
</li>
<li>
<p>编译并安装：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-built_in">make</span> &amp;&amp; <span class="hljs-built_in">make</span> install
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>配置和启动 Nginx</strong></p>
<ul>
<li>
<p>进入安装目录的 <code>sbin</code> 目录：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /home/mca/app/nginx/sbin
</code></pre>
</li>
<li>
<p>修改配置文件（如果需要）：编辑 <code>/home/mca/app/nginx/conf/nginx.conf</code>，将 <code>listen 80;</code> 改为 <code>listen 8081;</code>（或其他大于 1024 的端口，因为非 root 用户不能使用 1-1024 端口）。</p>
</li>
<li>
<p>启动：</p>
<pre><code class="hljs language-bash" lang="bash">./nginx
</code></pre>
</li>
<li>
<p>重新加载配置（修改 conf 后）：</p>
<pre><code class="hljs language-bash" lang="bash">./nginx -s reload
</code></pre>
</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">📌 总结与检查</h3>
<ul>
<li>
<p><strong>目录结构</strong>：</p>
<ul>
<li><code>/home/mca/software/</code>：存放所有 <code>.tar.gz</code> 源文件。</li>
<li><code>/home/mca/app/</code>：存放解压/编译后的 Nginx。</li>
</ul>
</li>
<li>
<p><strong>权限</strong>：所有操作都在 <code>mca</code> 用户下完成，无需 <code>sudo</code> 或 <code>root</code>。</p>
</li>
<li>
<p><strong>端口</strong>：Nginx 默认 80（需手动改配置大于 1024 的端口，因为非 root 用户不能使用 1-1024 端口）。同时确保服务器防火墙（如果有）放行这些端口。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C/C++连接MySQL实战指南：执行SQL请求详解]]></title>    <link>https://juejin.cn/post/7605173538417721354</link>    <guid>https://juejin.cn/post/7605173538417721354</guid>    <pubDate>2026-02-11T08:38:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605173538417721354" data-draft-id="7605135197167009842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C/C++连接MySQL实战指南：执行SQL请求详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T08:38:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大黄评测"/> <meta itemprop="url" content="https://juejin.cn/user/714024404135696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C/C++连接MySQL实战指南：执行SQL请求详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/714024404135696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大黄评测
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:38:26.000Z" title="Wed Feb 11 2026 08:38:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发高性能或系统级应用时，C/C++因其接近硬件、运行效率高的特点被广泛使用。而当这类应用需要与数据库交互时，MySQL 提供了官方的 C API（即 MySQL Connector/C），使得开发者可以直接在 C/C++ 程序中连接、查询和操作 MySQL 数据库。</p>
<p>本文将聚焦于 <strong>如何使用 C/C++ 连接 MySQL 并发送 SQL 请求</strong>，涵盖从环境准备到执行查询的完整流程，并提供可直接运行的示例代码。</p>
<hr/>
<h3 data-id="heading-0">一、准备工作</h3>
<h4 data-id="heading-1">1. 安装 MySQL 开发库</h4>
<p>在 Linux 系统（如 Ubuntu/Debian）上，可通过以下命令安装 MySQL 客户端开发库：</p>
<pre><code class="hljs language-arduino" lang="arduino">sudo apt-get install libmysqlclient-dev
</code></pre>
<p>在 CentOS/RHEL 上：</p>
<pre><code class="hljs language-bash" lang="bash">sudo yum install mysql-devel
<span class="hljs-comment"># 或（较新版本）</span>
sudo dnf install mysql-devel
</code></pre>
<p>Windows 用户可从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdownloads%2Fc-api%2F" target="_blank" title="https://dev.mysql.com/downloads/c-api/" ref="nofollow noopener noreferrer">MySQL 官网</a> 下载 Connector/C。</p>
<h4 data-id="heading-2">2. 编译链接选项</h4>
<p>编译时需链接 <code>libmysqlclient</code> 库。例如：</p>
<pre><code class="hljs">gcc -o myapp myapp.c -lmysqlclient
</code></pre>
<hr/>
<h3 data-id="heading-3">二、基本流程概览</h3>
<p>使用 C API 操作 MySQL 的典型步骤如下：</p>
<ol>
<li>初始化 MySQL 连接句柄（<code>mysql_init()</code>）</li>
<li>连接到数据库（<code>mysql_real_connect()</code>）</li>
<li>发送 SQL 请求（<code>mysql_query()</code> 或 <code>mysql_real_query()</code>）</li>
<li>处理结果集（如有）（<code>mysql_store_result()</code> / <code>mysql_use_result()</code>）</li>
<li>释放资源并关闭连接（<code>mysql_close()</code>）</li>
</ol>
<hr/>
<h3 data-id="heading-4">三、连接数据库</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mysql/mysql.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    MYSQL *conn;
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *server = <span class="hljs-string">"localhost"</span>;
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *user = <span class="hljs-string">"your_user"</span>;
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *password = <span class="hljs-string">"your_password"</span>;
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *database = <span class="hljs-string">"test_db"</span>;

    <span class="hljs-comment">// 初始化连接结构</span>
    conn = mysql_init(<span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (conn == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"mysql_init() failed\n"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-comment">// 连接数据库</span>
    <span class="hljs-keyword">if</span> (mysql_real_connect(conn, server, user, password, database, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>) == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Connection failed: %s\n"</span>, mysql_error(conn));
        mysql_close(conn);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }

    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Connected to MySQL successfully!\n"</span>);

    <span class="hljs-comment">// 后续操作...</span>

    mysql_close(conn);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<blockquote>
<p>注意：请将 <code>your_user</code>、<code>your_password</code> 和 <code>test_db</code> 替换为实际值。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">四、发送 SQL 请求</h3>
<h4 data-id="heading-6">1. 执行非查询语句（INSERT / UPDATE / DELETE）</h4>
<p>这些语句不返回结果集，只需检查是否执行成功：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *sql = <span class="hljs-string">"INSERT INTO users (name, email) VALUES ('Alice', 'alice@example.com')"</span>;
<span class="hljs-keyword">if</span> (mysql_query(conn, sql)) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Query error: %s\n"</span>, mysql_error(conn));
} <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Insert successful. Affected rows: %llu\n"</span>, mysql_affected_rows(conn));
}
</code></pre>
<h4 data-id="heading-7">2. 执行查询语句（SELECT）</h4>
<p>查询会返回结果集，需进一步处理：</p>
<pre><code class="hljs language-ini" lang="ini">const char *<span class="hljs-attr">query</span> = <span class="hljs-string">"SELECT id, name, email FROM users"</span><span class="hljs-comment">;</span>
if (mysql_query(conn, query)) {
    fprintf(stderr, "SELECT error: %s\n", mysql_error(conn))<span class="hljs-comment">;</span>
    return 1<span class="hljs-comment">;</span>
}

MYSQL_RES *<span class="hljs-attr">result</span> = mysql_store_result(conn)<span class="hljs-comment">;</span>
if (<span class="hljs-attr">result</span> == NULL) {
    fprintf(stderr, "Store result error: %s\n", mysql_error(conn))<span class="hljs-comment">;</span>
    return 1<span class="hljs-comment">;</span>
}

// 获取字段数量
int <span class="hljs-attr">num_fields</span> = mysql_num_fields(result)<span class="hljs-comment">;</span>

// 遍历每一行
MYSQL_ROW row<span class="hljs-comment">;</span>
while ((<span class="hljs-attr">row</span> = mysql_fetch_row(result))) {
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; num_fields; i++) {</span>
        printf("%s\t", row<span class="hljs-section">[i]</span> ? row<span class="hljs-section">[i]</span> : "NULL")<span class="hljs-comment">;</span>
    }
    printf("\n")<span class="hljs-comment">;</span>
}

// 释放结果集
mysql_free_result(result)<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>使用 <code>mysql_store_result()</code> 会一次性将全部结果加载到内存，适用于数据量较小的场景；若处理大量数据，可考虑 <code>mysql_use_result()</code> 流式读取。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">五、错误处理建议</h3>
<ul>
<li>始终检查 <code>mysql_query()</code> 的返回值。</li>
<li>使用 <code>mysql_error(conn)</code> 获取详细错误信息。</li>
<li>在程序退出前务必调用 <code>mysql_close()</code> 释放连接资源。</li>
</ul>
<hr/>
<h3 data-id="heading-9">六、编译与运行示例</h3>
<p>假设源文件为 <code>mysql_demo.c</code>，编译命令如下：</p>
<pre><code class="hljs language-css" lang="css">gcc -o mysql_demo mysql_demo<span class="hljs-selector-class">.c</span> $(mysql_config <span class="hljs-attr">--cflags</span> <span class="hljs-attr">--libs</span>)
</code></pre>
<blockquote>
<p><code>mysql_config</code> 是 MySQL 提供的工具，可自动输出正确的编译和链接参数。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">七、小结</h3>
<p>通过 MySQL 的 C API，C/C++ 程序可以高效地与数据库交互。虽然相比高级语言（如 Python、Java）略显繁琐，但在对性能、资源控制有严格要求的场景下，C/C++ 仍是不可替代的选择。</p>
<p>掌握连接、发送请求、处理结果这三个核心环节，即可构建出稳定可靠的数据库客户端程序。后续还可深入学习预处理语句（<code>mysql_stmt_*</code> 系列函数）以提升安全性和效率，防止 SQL 注入。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SQL性能优化三大核心原则：精简、驱动、集合]]></title>    <link>https://juejin.cn/post/7605173538417737738</link>    <guid>https://juejin.cn/post/7605173538417737738</guid>    <pubDate>2026-02-11T08:39:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605173538417737738" data-draft-id="7605136148592885787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SQL性能优化三大核心原则：精简、驱动、集合"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T08:39:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大尚来也"/> <meta itemprop="url" content="https://juejin.cn/user/1681597639955488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SQL性能优化三大核心原则：精简、驱动、集合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1681597639955488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大尚来也
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:39:10.000Z" title="Wed Feb 11 2026 08:39:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据库开发与运维实践中，SQL 性能问题往往是系统瓶颈的“罪魁祸首”。面对慢查询、高 CPU、锁等待等现象，许多开发者习惯于盲目添加索引或调整配置，却忽略了 SQL 语句本身的结构与执行逻辑。事实上，<strong>高效的 SQL 优化并非依赖奇技淫巧，而是回归本质——遵循三条核心原则：精简之道、驱动为王、集合为本</strong>。</p>
<p>这“三板斧”看似朴素，却是经验沉淀后的高效方法论。掌握它们，可让你在纷繁复杂的 SQL 调优中迅速抓住关键，事半功倍。</p>
<hr/>
<h3 data-id="heading-0">一、精简之道：只取所需，杜绝冗余</h3>
<blockquote>
<p><strong>“少即是多”在 SQL 优化中尤为适用。</strong></p>
</blockquote>
<h4 data-id="heading-1">常见问题：</h4>
<ul>
<li><code>SELECT *</code> 拉取全部字段，即使业务只需其中两三个；</li>
<li>在 <code>WHERE</code> 中使用复杂函数或表达式，导致索引失效；</li>
<li>子查询嵌套过深，逻辑重复计算。</li>
</ul>
<h4 data-id="heading-2">优化建议：</h4>
<ol>
<li>
<p><strong>明确字段列表</strong><br/>
避免 <code>SELECT *</code>，仅选择真正需要的列。这不仅能减少网络传输量，还能提升缓存命中率，甚至触发覆盖索引（Covering Index）。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 不推荐</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>;

<span class="hljs-comment">-- ✅ 推荐</span>
<span class="hljs-keyword">SELECT</span> order_id, create_time, amount <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>;
</code></pre>
</li>
<li>
<p><strong>简化过滤条件</strong><br/>
尽量将计算移出 <code>WHERE</code> 子句。例如，不要写 <code>WHERE YEAR(create_time) = 2025</code>，而应写成范围查询：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 索引失效</span>
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">YEAR</span>(create_time) <span class="hljs-operator">=</span> <span class="hljs-number">2025</span>

<span class="hljs-comment">-- ✅ 可用索引</span>
<span class="hljs-keyword">WHERE</span> create_time <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01'</span> <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">&lt;</span> <span class="hljs-string">'2026-01-01'</span>
</code></pre>
</li>
<li>
<p><strong>避免无谓的 JOIN 或子查询</strong><br/>
每多一张表，执行计划复杂度指数级上升。确认每个关联是否必要。</p>
</li>
</ol>
<blockquote>
<p><strong>精简的本质是“最小化数据处理量”——从源头减少 I/O、CPU 和内存开销。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-3">二、驱动为王：让小结果集驱动大表</h3>
<blockquote>
<p><strong>“谁先查，谁主导”——驱动表的选择决定执行效率。</strong></p>
</blockquote>
<p>在多表关联（JOIN）中，数据库优化器会决定哪张表作为“驱动表”（即外层循环），其余为“被驱动表”（内层）。理想情况下，<strong>应让结果集最小的表作为驱动表</strong>，从而减少对大表的重复访问次数。</p>
<h4 data-id="heading-4">示例场景：</h4>
<p>假设有两张表：</p>
<ul>
<li><code>users</code>（100 万行）</li>
<li><code>orders</code>（1000 万行）</li>
</ul>
<p>需求：查询最近 7 天下单的用户信息。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 写法 A：以 users 为驱动表（低效）</span>
<span class="hljs-keyword">SELECT</span> u.name, o.amount
<span class="hljs-keyword">FROM</span> users u
<span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> u.id <span class="hljs-operator">=</span> o.user_id
<span class="hljs-keyword">WHERE</span> o.create_time <span class="hljs-operator">&gt;=</span> NOW() <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">7</span> <span class="hljs-keyword">DAY</span>;

<span class="hljs-comment">-- 写法 B：以 orders 为驱动表（高效）</span>
<span class="hljs-keyword">SELECT</span> u.name, o.amount
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> users u <span class="hljs-keyword">ON</span> o.user_id <span class="hljs-operator">=</span> u.id
<span class="hljs-keyword">WHERE</span> o.create_time <span class="hljs-operator">&gt;=</span> NOW() <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">7</span> <span class="hljs-keyword">DAY</span>;
</code></pre>
<p>在写法 B 中，<code>orders</code> 表先通过时间条件过滤出少量记录（如 1 万条），再回查 <code>users</code> 表，效率远高于遍历全部 100 万用户去匹配订单。</p>
<h4 data-id="heading-5">优化技巧：</h4>
<ul>
<li>利用 <code>EXPLAIN</code> 查看执行计划，确认驱动表是否合理；</li>
<li>在 <code>WHERE</code> 中尽早过滤大表数据；</li>
<li>必要时使用 <code>STRAIGHT_JOIN</code>（MySQL）强制指定驱动顺序（慎用）。</li>
</ul>
<blockquote>
<p><strong>驱动为王的核心思想是：用最小代价启动查询，逐步放大结果，而非反向暴力扫描。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-6">三、集合为本：用集合思维替代过程式操作</h3>
<blockquote>
<p><strong>SQL 是声明式语言，不是过程式语言——要“告诉数据库做什么”，而不是“一步步怎么做”。</strong></p>
</blockquote>
<p>许多开发者受编程思维影响，习惯用循环、逐行处理的方式写 SQL，例如：</p>
<ul>
<li>在应用层循环执行单条 UPDATE；</li>
<li>使用游标（Cursor）逐行处理；</li>
<li>多次小查询拼接结果。</li>
</ul>
<p>这些做法严重违背了数据库的“集合处理”优势。</p>
<h4 data-id="heading-7">正确姿势：批量、向量化、一次搞定</h4>
<p>✅ <strong>批量更新代替循环更新</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 应用层循环 1000 次</span>
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> price <span class="hljs-operator">=</span> ? <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> ?;

<span class="hljs-comment">-- ✅ 一次批量更新（使用 CASE 或临时表）</span>
<span class="hljs-keyword">UPDATE</span> products
<span class="hljs-keyword">SET</span> price <span class="hljs-operator">=</span> <span class="hljs-keyword">CASE</span> id
    <span class="hljs-keyword">WHEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">100</span>
    <span class="hljs-keyword">WHEN</span> <span class="hljs-number">2</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">200</span>
    ...
<span class="hljs-keyword">END</span>
<span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, ...);
</code></pre>
<p>✅ <strong>用 JOIN 替代子查询或多次查询</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet">-- ❌ 多次查询或相关子查询
<span class="hljs-keyword">SELECT</span> name, (<span class="hljs-keyword">SELECT</span> COUNT(*) <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id = u.id) <span class="hljs-keyword">AS</span> order_cnt
<span class="hljs-keyword">FROM</span> users u;

-- ✅ 一次 <span class="hljs-keyword">JOIN</span> + <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
<span class="hljs-keyword">SELECT</span> u.name, COUNT(o.id) <span class="hljs-keyword">AS</span> order_cnt
<span class="hljs-keyword">FROM</span> users u
LEFT <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> u.id = o.user_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> u.id, u.name;
</code></pre>
<p>✅ <strong>善用窗口函数、CTE 等现代 SQL 特性</strong><br/>
避免自连接或临时表，用更简洁的集合逻辑表达复杂需求。</p>
<blockquote>
<p><strong>集合为本，就是发挥数据库引擎的并行与批处理能力，把“一行一行做”变成“一批一起做”。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-8">结语：回归本质，方得高效</h3>
<p>SQL 优化没有银弹，但有章可循。“精简之道、驱动为王、集合为本”这三大原则，分别对应：</p>
<ul>
<li><strong>数据量最小化</strong>（精简），</li>
<li><strong>执行路径最优化</strong>（驱动），</li>
<li><strong>处理方式集约化</strong>（集合）。</li>
</ul>
<p>当你下次面对一条慢 SQL 时，不妨自问：</p>
<ol>
<li>我是否只取了必要的数据？</li>
<li>驱动表是否是最小结果集？</li>
<li>是否用集合操作替代了过程式逻辑？</li>
</ol>
<p>答案若皆为“是”，性能自然水到渠成。</p>
<blockquote>
<p><strong>好的 SQL，不在于多聪明，而在于多克制。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自签名 SSL 证书生成与Chorme证书信任配置指南]]></title>    <link>https://juejin.cn/post/7605213691910570010</link>    <guid>https://juejin.cn/post/7605213691910570010</guid>    <pubDate>2026-02-11T08:47:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605213691910570010" data-draft-id="7605401415855521842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自签名 SSL 证书生成与Chorme证书信任配置指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T08:47:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Oneslide"/> <meta itemprop="url" content="https://juejin.cn/user/4424904652631624"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自签名 SSL 证书生成与Chorme证书信任配置指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4424904652631624/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Oneslide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:47:29.000Z" title="Wed Feb 11 2026 08:47:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发和测试环境中，我们经常需要为内部网站生成自签名 SSL 证书。本文将详细介绍如何生成包含 IP 地址和域名的 SSL 证书，并配置浏览器信任该证书。</p>
<h2 data-id="heading-0">脚本解析</h2>
<p>以下是一个完整的自签名 SSL 证书生成脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 进入证书目录</span>
<span class="hljs-built_in">cd</span> /root/certs

<span class="hljs-comment"># 定义 IP 地址（替换为您的实际 IP）</span>
IP_ADDRESS=<span class="hljs-string">"36.xx.xx.xx"</span>

<span class="hljs-comment"># 创建证书配置文件，包含 IP 地址</span>
<span class="hljs-built_in">cat</span> &gt; server_ext.cnf &lt;&lt;<span class="hljs-string">EOF
[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[req_distinguished_name]
C = CN
ST = Beijing
L = Beijing
O = YourCompany
CN = www.sample.com

[v3_req]
basicConstraints = CA:FALSE
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1 = www.sample.com
DNS.2 = sample.com
IP.1 = ${IP_ADDRESS}
EOF</span>

<span class="hljs-comment"># 重新生成私钥</span>
openssl genrsa -out server.key 2048

<span class="hljs-comment"># 生成证书签名请求</span>
openssl req -new -key server.key -out server.csr -config server_ext.cnf

<span class="hljs-comment"># 生成证书（包含扩展）</span>
openssl x509 -req -days 3650 -<span class="hljs-keyword">in</span> server.csr \
  -signkey server.key -out server.crt \
  -extensions v3_req -extfile server_ext.cnf

<span class="hljs-comment"># 检查证书扩展</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 检查证书扩展 ==="</span>
openssl x509 -<span class="hljs-keyword">in</span> server.crt -text -noout | grep -A 10 <span class="hljs-string">"X509v3 Subject Alternative Name"</span>

<span class="hljs-comment"># 重启 Nginx</span>
<span class="hljs-comment"># systemctl restart nginx</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"证书已重新生成，包含 IP 地址: <span class="hljs-variable">${IP_ADDRESS}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"请重新导入 server.crt 到 Chrome 的受信任根证书颁发机构"</span>
</code></pre>
<h3 data-id="heading-1">脚本关键部分解析</h3>
<h4 data-id="heading-2">1. 证书配置文件 (server_ext.cnf)</h4>
<p>配置文件包含以下几个关键部分：</p>
<ul>
<li>
<p><strong>[req] 部分</strong>: 定义证书请求的基本参数</p>
<ul>
<li><code>distinguished_name</code>: 指定 DN（可分辨名称）配置节</li>
<li><code>req_extensions</code>: 指定要使用的扩展节（v3_req）</li>
<li><code>prompt = no</code>: 禁用交互式提示，使用预设值</li>
</ul>
</li>
<li>
<p><strong>[req_distinguished_name] 部分</strong>: 定义证书主题信息</p>
<ul>
<li><code>C</code>: 国家（Country）</li>
<li><code>ST</code>: 州/省（State/Province）</li>
<li><code>L</code>: 城市（Locality）</li>
<li><code>O</code>: 组织（Organization）</li>
<li><code>CN</code>: 通用名称（Common Name）- 主要域名</li>
</ul>
</li>
<li>
<p><strong>[v3_req] 部分</strong>: 证书扩展配置</p>
<ul>
<li><code>basicConstraints = CA:FALSE</code>: 表示这不是 CA 证书</li>
<li><code>keyUsage</code>: 密钥用法，这里指定数字签名和密钥加密</li>
<li><code>extendedKeyUsage</code>: 扩展密钥用法，指定为服务器身份验证</li>
<li><code>subjectAltName = @alt_names</code>: 引用 alt_names 节中的 SAN 值</li>
</ul>
</li>
<li>
<p><strong>[alt_names] 部分</strong>: SAN（主题备用名称）定义</p>
<ul>
<li><code>DNS.1</code>, <code>DNS.2</code>: DNS 名称条目</li>
<li><code>IP.1</code>: IP 地址条目，允许通过 IP 访问</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">2. OpenSSL 命令解析</h4>
<ol>
<li>
<p><strong>生成私钥</strong>: <code>openssl genrsa -out server.key 2048</code></p>
<ul>
<li>生成 2048 位的 RSA 私钥</li>
</ul>
</li>
<li>
<p><strong>生成 CSR</strong>: <code>openssl req -new -key server.key -out server.csr -config server_ext.cnf</code></p>
<ul>
<li>使用私钥和配置文件生成证书签名请求</li>
</ul>
</li>
<li>
<p><strong>生成证书</strong>: <code>openssl x509 -req -days 3650 ...</code></p>
<ul>
<li>使用 CSR 和私钥生成有效期为 10 年的自签名证书</li>
<li>应用 v3_req 扩展中的配置</li>
</ul>
</li>
</ol>
<h2 data-id="heading-4">证书基本结构解析</h2>
<h3 data-id="heading-5">证书的层次结构</h3>
<ol>
<li><strong>版本号</strong>: X.509 v3（当前标准）</li>
<li><strong>序列号</strong>: 证书的唯一标识符</li>
<li><strong>签名算法</strong>: 用于签名证书的算法（如 sha256WithRSAEncryption）</li>
<li><strong>颁发者</strong>: 颁发证书的实体（自签名时与主题相同）</li>
<li><strong>有效期</strong>: 证书的有效起止时间</li>
<li><strong>主题</strong>: 证书持有者的信息</li>
<li><strong>公钥信息</strong>: 持有者的公钥和算法</li>
<li><strong>扩展域</strong>: 包含各种扩展信息（最重要的部分）</li>
</ol>
<h3 data-id="heading-6">关键扩展字段</h3>
<h4 data-id="heading-7">1. 基本约束 (basicConstraints)</h4>
<ul>
<li><code>CA:FALSE</code> 表示这是终端实体证书，不能用作 CA 证书</li>
<li><code>CA:TRUE</code> 表示这是 CA 证书，可以签发其他证书</li>
</ul>
<h4 data-id="heading-8">2. 密钥用法 (keyUsage)</h4>
<p>定义证书中公钥的用途：</p>
<ul>
<li><strong>digitalSignature</strong>: 允许进行数字签名操作（TLS 握手必需）</li>
<li><strong>keyEncipherment</strong>: 允许密钥交换时加密密钥</li>
</ul>
<h4 data-id="heading-9">3. 扩展密钥用法 (extendedKeyUsage)</h4>
<p>进一步限制证书用途：</p>
<ul>
<li><strong>serverAuth</strong>: TLS Web 服务器身份验证</li>
<li><strong>clientAuth</strong>: TLS Web 客户端身份验证</li>
<li><strong>codeSigning</strong>: 代码签名</li>
</ul>
<h4 data-id="heading-10">4. 主题备用名称 (subjectAltName)</h4>
<p>现代 TLS 实现中最重要的扩展之一：</p>
<ul>
<li><strong>DNS 名称</strong>: <code>DNS:example.com</code></li>
<li><strong>IP 地址</strong>: <code>IP:192.168.1.1</code></li>
<li><strong>电子邮件</strong>: <code>email:user@example.com</code></li>
</ul>
<h3 data-id="heading-11">为什么需要 SAN？</h3>
<ol>
<li><strong>兼容性</strong>: 现代浏览器（Chrome 58+）已不检查 CN 字段，只检查 SAN</li>
<li><strong>灵活性</strong>: 一个证书可以保护多个域名和 IP 地址</li>
<li><strong>安全性</strong>: 防止证书误用，明确指定有效名称</li>
</ol>
<h2 data-id="heading-12">浏览器导入证书指南</h2>
<p>打开Chrome浏览器:</p>
<ol>
<li>打开设置-&gt; 隐私和安全</li>
<li>选择安全-&gt; 管理证书</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/942aa73f595340189fc00652b69797aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lc2xpZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771404513&amp;x-signature=S0zkFCl9CnsBgib%2FnbcK1l2tPQY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9dcaf0b45b540508b2e26b7193ef7d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lc2xpZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771404513&amp;x-signature=H3CBehlyNwh6zkGmTq6D%2FIxzKgE%3D" alt="image.png" loading="lazy"/></p>
<ol start="3">
<li>选择"管理Windows导入的证书",点击"受信任的证书颁发机构",导入<code>server.crt</code>文件</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac6d29eeb3ad41a699b2ffcc85e26a14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lc2xpZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771404513&amp;x-signature=8tV5OANizZzjut9BDyWQwWasBbM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43b2690225584a1f97ebbaa71cdfe98d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lc2xpZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771404513&amp;x-signature=frrFSNZqrGOoLZkAJRnZHUMOfEM%3D" alt="image.png" loading="lazy"/></p>
<ol start="4">
<li>重启Chrome</li>
</ol>
<h3 data-id="heading-13">验证导入结果</h3>
<ol>
<li>重启 Chrome，访问 <code>chrome://settings/certificates</code></li>
<li>选择<strong>受信任的根证书颁发机构</strong>选项卡</li>
<li>查找颁发者为 <code>www.sample.com</code> 的证书</li>
</ol>
<h3 data-id="heading-14">重启并测试</h3>
<ol>
<li>完全关闭所有 Chrome 窗口</li>
<li>重新打开 Chrome</li>
<li>访问以下地址测试：
<ul>
<li><code>https://www.sample.com:8443</code></li>
<li><code>https://xx.xx.xx.xx:8443</code></li>
</ul>
</li>
</ol>
<p>https证书将不报错:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47735afd81b74e46ab98c44cd43cfc12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lc2xpZGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771404513&amp;x-signature=gY9JBk5tnVK4fr2%2FJS66IjE45Is%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-15">Nginx 配置示例</h2>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen       8443 ssl;
    listen       [::]:8443 ssl;
    server_name  www.sample.com 36.xx.xx.xx;
    
    root         /usr/share/nginx/html;
    
    # SSL 证书配置
    ssl_certificate /root/certs/server.crt;
    ssl_certificate_key /root/certs/server.key;
    
    # SSL 协议配置
    ssl_protocols TLSv1.2 TLSv1.3;

    
    # 默认文件
    index index.html index.htm;
    
    location / {
        try_files $uri $uri/ =404;
    }
}
</code></pre>
<h2 data-id="heading-16">常见问题与解决方案</h2>
<h3 data-id="heading-17">1. 证书仍然显示不安全</h3>
<p><strong>可能原因</strong>:</p>
<ul>
<li>证书未正确导入到受信任的根证书颁发机构</li>
<li>证书缺少必要的扩展</li>
<li>浏览器缓存了旧的证书信息,未重启Chrome</li>
</ul>
<p><strong>解决方案</strong>:</p>
<ul>
<li>重新导入证书并确保选择正确的存储位置</li>
<li>检查证书是否包含 <code>digitalSignature</code> 密钥用法</li>
<li>清除浏览器 SSL 状态缓存</li>
</ul>
<p>通过遵循本指南，您可以创建一个既支持域名又支持 IP 地址访问的 HTTPS 环境，消除浏览器安全警告，提高开发和测试效率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[详解JS的?.（可选链操作符）和 ??（空值合并操作符）]]></title>    <link>https://juejin.cn/post/7605184380610936884</link>    <guid>https://juejin.cn/post/7605184380610936884</guid>    <pubDate>2026-02-11T08:31:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605184380610936884" data-draft-id="7605184380610707508" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="详解JS的?.（可选链操作符）和 ??（空值合并操作符）"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2026-02-11T08:31:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SuperEugene"/> <meta itemprop="url" content="https://juejin.cn/user/2366613652515256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            详解JS的?.（可选链操作符）和 ??（空值合并操作符）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2366613652515256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SuperEugene
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:31:54.000Z" title="Wed Feb 11 2026 08:31:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>这是一段我看从别人的<code>Axios</code>代码里看到的代码片段</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> msg = error.<span class="hljs-property">response</span>?.<span class="hljs-property">data</span>?.<span class="hljs-property">msg</span> ?? error.<span class="hljs-property">response</span>?.<span class="hljs-property">data</span>?.<span class="hljs-property">message</span> ?? error.<span class="hljs-property">message</span>
</code></pre>
<p>起初这个<code>?</code>的用法，我只在定义接口的时候用过</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserInfo</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> 
  <span class="hljs-attr">pwd</span>: <span class="hljs-built_in">string</span>  <span class="hljs-comment">// 密码</span>
  <span class="hljs-attr">nickname</span>: <span class="hljs-built_in">string</span> <span class="hljs-comment">// 用户名称</span>
  wechatCode?: <span class="hljs-built_in">string</span>  <span class="hljs-comment">// 微信号</span>
}
</code></pre>
<p>表示：wechatCode是可选的，有也行没有也行。其他的都是一定要有的。</p>
<p><code>error.response?.data</code> 我还能理解，表示<code>error</code>中是否有<code>response</code>，如果有就再<code>.data</code>如果没有就返回<code>空</code>嘛。但是<code>??</code>我就不能理解啦。怀揣着好奇心学习了一下，分享给同样不知道的同学们。</p>
<h2 data-id="heading-1">一、关键语法讲解</h2>
<ol>
<li>可选链操作符 <code>?.</code>
作用：安全地访问嵌套对象的属性，如果访问路径上的某个属性是 <code>null</code> 或 <code>undefined</code>，不会报错，而是直接返回 <code>undefined</code>。</li>
</ol>
<ul>
<li>传统写法：如果直接写 <code>error.response.data.msg</code>，如果 <code>error.response</code> 是 <code>undefined</code>，会抛出 <code>Cannot read properties of undefined (reading 'data')</code> 错误。</li>
<li>可选链写法：<code>error.response?.data?.msg</code> 会先检查 <code>error.response</code> 是否存在（<code>非 null</code>/<code>undefined</code>），存在才继续访问 <code>data</code>，再检查 <code>data</code> 存在才访问 <code>msg</code>，任何一步不存在就返回 <code>undefined</code>。</li>
</ul>
<p>2.空值合并操作符 <code>??</code></p>
<p>作用：只在左边的值是 <code>null</code> 或 <code>undefined</code> 时，才返回右边的值（区别于 <code>||</code>，<code>||</code> 会把 <code>''</code>、<code>0</code>、<code>false</code> 等 “假值” 也判定为无效）。</p>
<ul>
<li>例子：
<ul>
<li><code>undefined ?? '默认值'</code> → <code>返回 '默认值'</code>；</li>
<li><code>'' ?? '默认值'</code> → <code>返回 ''</code>（因为 '' 不是 <code>null</code>/<code>undefined</code>）。</li>
</ul>
</li>
<li>对比 <code>||</code>：<code>'' || '默认值'</code> → <code>返回 '默认值'</code>，这是两者的核心区别。</li>
</ul>
<h2 data-id="heading-2">二、整行代码分析</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> msg = error.<span class="hljs-property">response</span>?.<span class="hljs-property">data</span>?.<span class="hljs-property">msg</span> ?? error.<span class="hljs-property">response</span>?.<span class="hljs-property">data</span>?.<span class="hljs-property">message</span> ?? error.<span class="hljs-property">message</span>
</code></pre>
<p>这行代码的核心目的是：按优先级从 <code>error</code> 对象中提取错误提示信息，确保最终拿到一个有效的、非空的错误文本，查找优先级如下：</p>
<p>1、第一优先级：<code>error.response?.data?.msg</code>
先尝试从 <code>error</code> 的 <code>response.data</code> 里找 <code>msg</code> 属性（很多后端接口返回的错误信息字段是 <code>msg</code>）。</p>
<p>2、第二优先级：<code>error.response?.data?.message</code>
如果第一步的结果是 <code>null/undefined</code>（比如接口返回的错误字段是 <code>message</code> 而不是 <code>msg</code>），就尝试找 <code>response.data</code> 里的 <code>message</code> 属性。</p>
<p>3、最后兜底：<code>error.message</code>
如果前两步都没找到（比如没有 <code>response</code> 层级，比如前端自身抛出的错误），就取 <code>error</code> 本身的 <code>message </code>属性（<code>JS</code> 原生 <code>Error</code> 对象默认有 <code>message</code> 字段）。</p>
<h2 data-id="heading-3">三、举例子讲解加深印象</h2>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> msg = error.<span class="hljs-property">response</span>?.<span class="hljs-property">data</span>?.<span class="hljs-property">msg</span> ?? error.<span class="hljs-property">response</span>?.<span class="hljs-property">data</span>?.<span class="hljs-property">message</span> ?? error.<span class="hljs-property">message</span>
</code></pre>
<p>还是这个代码，用三种不同的接口情况返回让你更好的理解。下面的三个例子要和这条代码对照起来看。</p>
<p>假设有三种不同的 <code>error</code> 结构，看 <code>msg</code> 的取值结果：</p>
<p>例子 1：接口返回 <code>msg </code>字段</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> error = {
  <span class="hljs-attr">response</span>: {
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">msg</span>: <span class="hljs-string">'用户名已存在'</span> }
  }
};
<span class="hljs-comment">// 执行代码后，msg = '用户名已存在'（取第一优先级）</span>
</code></pre>
<p>例子 2：接口返回 <code>message </code>字段</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> error = {
  <span class="hljs-attr">response</span>: {
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">message</span>: <span class="hljs-string">'密码错误'</span> }
  }
};
<span class="hljs-comment">// 第一步 msg 是 undefined → 第二步取 message → msg = '密码错误'</span>
</code></pre>
<p>例子 3：前端原生错误（无 <code>response</code> 层级）</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'网络请求超时'</span>);
<span class="hljs-comment">// 前两步都是 undefined → 取 error.message → msg = '网络请求超时'</span>
</code></pre>
<h2 data-id="heading-4">四、总结</h2>
<ol>
<li><code>?.</code> 是为了安全访问嵌套属性，避免因某个属性不存在导致代码报错；</li>
<li><code>??</code> 是为了精准判断 “无值”（仅 <code>null</code>/<code>undefined</code>），优先使用接口返回的错误信息，兜底用原生错误信息；</li>
<li>整行代码的核心逻辑是：按 <code>msg</code> → <code>message</code>（接口层级）→ <code>message</code>（错误对象层级）的优先级，提取有效的错误提示文本。</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> msg = error.<span class="hljs-property">response</span>?.<span class="hljs-property">data</span>?.<span class="hljs-property">msg</span> ?? error.<span class="hljs-property">response</span>?.<span class="hljs-property">data</span>?.<span class="hljs-property">message</span> ?? error.<span class="hljs-property">message</span>
</code></pre>
<p>通过本次学习，再结合案例分析一下。这个写法似乎是前端处理异步请求（如 <code>Axios</code>）错误信息的常用最佳实践，能兼容不同格式的错误返回，保证代码的健壮性。</p>
<p>以上就是本次对JS的<code>?.</code>（可选链操作符）和<code> ??</code>（空值合并操作符）的学习分享。欢迎大家指正讨论，与大家共勉。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 组件通信全解析]]></title>    <link>https://juejin.cn/post/7605184380610986036</link>    <guid>https://juejin.cn/post/7605184380610986036</guid>    <pubDate>2026-02-11T08:35:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605184380610986036" data-draft-id="7605128056486002703" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 组件通信全解析"/> <meta itemprop="keywords" content="前端,面试,Vue.js"/> <meta itemprop="datePublished" content="2026-02-11T08:35:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不想秃头的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2754702534251820"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 组件通信全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2754702534251820/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不想秃头的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:35:55.000Z" title="Wed Feb 11 2026 08:35:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>组件通信是 Vue 开发中绕不开的核心知识点，尤其是 Vue3 组合式 API 普及后，通信方式相比 Vue2 有了不少变化和优化。本文将抛开 TypeScript，用最通俗易懂的方式，带你梳理 Vue3 中所有常用的组件通信方式，从基础的父子通信到复杂的跨层级通信，每一种都配实战示例，新手也能轻松上手。</p>
<h2 data-id="heading-0">一、父子组件通信（最基础也最常用）</h2>
<p>父子组件通信是日常开发中使用频率最高的场景，Vue3 为这种场景提供了清晰且高效的解决方案。</p>
<h3 data-id="heading-1">1. 父传子：Props</h3>
<p>Props 是父组件向子组件传递数据的官方标准方式，子组件通过定义 props 接收父组件传递的值。</p>
<p><strong>父组件（Parent.vue）</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我是父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 向子组件传递数据 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> 
      <span class="hljs-attr">:msg</span>=<span class="hljs-string">"parentMsg"</span> 
      <span class="hljs-attr">:user-info</span>=<span class="hljs-string">"userInfo"</span>
      <span class="hljs-attr">:list</span>=<span class="hljs-string">"fruitList"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 引入子组件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Child.vue'</span>
<span class="hljs-keyword">import</span> { ref, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 定义要传递给子组件的数据</span>
<span class="hljs-keyword">const</span> parentMsg = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'来自父组件的问候'</span>)
<span class="hljs-keyword">const</span> userInfo = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
})
<span class="hljs-keyword">const</span> fruitList = <span class="hljs-title function_">ref</span>([<span class="hljs-string">'苹果'</span>, <span class="hljs-string">'香蕉'</span>, <span class="hljs-string">'橙子'</span>])
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p><strong>子组件（Child.vue）</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>我是子组件<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>父组件传递的字符串：{{ msg }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>父组件传递的对象：{{ userInfo.name }} - {{ userInfo.age }}岁<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>父组件传递的数组：{{ list.join('、') }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 定义props接收父组件数据</span>
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-comment">// 字符串类型</span>
  <span class="hljs-attr">msg</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-string">'默认值'</span>
  },
  <span class="hljs-comment">// 对象类型</span>
  <span class="hljs-attr">userInfo</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> ({}) <span class="hljs-comment">// 对象/数组默认值必须用函数返回</span>
  },
  <span class="hljs-comment">// 数组类型</span>
  <span class="hljs-attr">list</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Array</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> []
  }
})

<span class="hljs-comment">// 在脚本中使用props（组合式API中可直接用props.xxx）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(props.<span class="hljs-property">msg</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-2">2. 子传父：自定义事件（Emits）</h3>
<p>子组件通过触发自定义事件，将数据传递给父组件，父组件通过监听事件接收数据。</p>
<p><strong>子组件（Child.vue）</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>我是子组件<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"sendToParent"</span>&gt;</span>向父组件传递数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 声明要触发的自定义事件（可选，但推荐）</span>
<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'childMsg'</span>, <span class="hljs-string">'updateInfo'</span>])

<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendToParent</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 触发事件并传递数据（第一个参数是事件名，后续是要传递的数据）</span>
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'childMsg'</span>, <span class="hljs-string">'来自子组件的消息'</span>)
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'updateInfo'</span>, {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'李四'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>
  })
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p><strong>父组件（Parent.vue）</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我是父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 监听子组件的自定义事件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> 
      @<span class="hljs-attr">childMsg</span>=<span class="hljs-string">"handleChildMsg"</span>
      @<span class="hljs-attr">updateInfo</span>=<span class="hljs-string">"handleUpdateInfo"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>子组件传递的消息：{{ childMsg }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>子组件更新的信息：{{ newUserInfo.name }} - {{ newUserInfo.age }}岁<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Child.vue'</span>
<span class="hljs-keyword">import</span> { ref, reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> childMsg = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> newUserInfo = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">0</span>
})

<span class="hljs-comment">// 处理子组件的消息</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChildMsg</span> = (<span class="hljs-params">msg</span>) =&gt; {
  childMsg.<span class="hljs-property">value</span> = msg
}

<span class="hljs-comment">// 处理子组件的信息更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleUpdateInfo</span> = (<span class="hljs-params">info</span>) =&gt; {
  newUserInfo.<span class="hljs-property">name</span> = info.<span class="hljs-property">name</span>
  newUserInfo.<span class="hljs-property">age</span> = info.<span class="hljs-property">age</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-3">二、跨层级组件通信</h2>
<p>当组件嵌套层级较深（比如爷孙组件、跨多级组件），使用 props + emits 会非常繁琐，这时需要更高效的跨层级通信方案。</p>
<h3 data-id="heading-4">1. provide /inject（依赖注入）</h3>
<p>provide 用于父组件（或祖先组件）提供数据，inject 用于子孙组件注入数据，支持任意层级的组件通信。</p>
<p><strong>祖先组件（GrandParent.vue）</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"grand-parent"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>我是祖先组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Parent</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Parent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Parent.vue'</span>
<span class="hljs-keyword">import</span> { ref, reactive, provide } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 提供基本类型数据</span>
<span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'dark'</span>)
<span class="hljs-title function_">provide</span>(<span class="hljs-string">'theme'</span>, theme)

<span class="hljs-comment">// 提供对象类型数据</span>
<span class="hljs-keyword">const</span> globalConfig = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">fontSize</span>: <span class="hljs-string">'16px'</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">'#333'</span>
})
<span class="hljs-title function_">provide</span>(<span class="hljs-string">'globalConfig'</span>, globalConfig)

<span class="hljs-comment">// 提供方法（支持双向通信）</span>
<span class="hljs-title function_">provide</span>(<span class="hljs-string">'changeTheme'</span>, <span class="hljs-function">(<span class="hljs-params">newTheme</span>) =&gt;</span> {
  theme.<span class="hljs-property">value</span> = newTheme
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p><strong>孙组件（Child.vue）</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>我是孙组件<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>祖先组件提供的主题：{{ theme }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>全局配置：{{ globalConfig.fontSize }} / {{ globalConfig.color }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeTheme('light')"</span>&gt;</span>切换为亮色主题<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { inject } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 注入祖先组件提供的数据（第二个参数是默认值）</span>
<span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'theme'</span>, <span class="hljs-string">'light'</span>)
<span class="hljs-keyword">const</span> globalConfig = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'globalConfig'</span>, {})
<span class="hljs-keyword">const</span> changeTheme = <span class="hljs-title function_">inject</span>(<span class="hljs-string">'changeTheme'</span>, <span class="hljs-function">() =&gt;</span> {})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-5">2. Vuex/Pinia（全局状态管理）</h3>
<p>当多个不相关的组件需要共享状态，或者项目规模较大时，推荐使用官方的状态管理库，Vue3 中更推荐 Pinia（比 Vuex 更简洁）。</p>
<h4 data-id="heading-6">示例：Pinia 实现全局通信</h4>
<p><strong>1. 安装 Pinia</strong></p>
<pre><code class="hljs language-js" lang="js">npm install pinia
</code></pre>
<p><strong>2. 创建 Pinia 实例（main.js）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">createPinia</span>())
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p><strong>3. 创建 Store（stores/user.js）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-comment">// 定义并导出store</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'user'</span>, {
  <span class="hljs-comment">// 状态</span>
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">username</span>: <span class="hljs-string">'默认用户名'</span>,
    <span class="hljs-attr">token</span>: <span class="hljs-string">''</span>
  }),
  <span class="hljs-comment">// 计算属性</span>
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-comment">// 处理用户名格式</span>
    <span class="hljs-attr">formatUsername</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-string">`【<span class="hljs-subst">${state.username}</span>】`</span>
    }
  },
  <span class="hljs-comment">// 方法（修改状态）</span>
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-comment">// 更新用户信息</span>
    <span class="hljs-title function_">updateUserInfo</span>(<span class="hljs-params">newInfo</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">username</span> = newInfo.<span class="hljs-property">username</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">token</span> = newInfo.<span class="hljs-property">token</span>
    },
    <span class="hljs-comment">// 清空用户信息</span>
    <span class="hljs-title function_">clearUserInfo</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">username</span> = <span class="hljs-string">''</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">token</span> = <span class="hljs-string">''</span>
    }
  }
})
</code></pre>
<p><strong>4. 组件中使用 Store</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>全局状态管理示例<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>用户名：{{ userStore.formatUsername }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Token：{{ userStore.token }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"updateUser"</span>&gt;</span>更新用户信息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"clearUser"</span>&gt;</span>清空用户信息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>

<span class="hljs-comment">// 获取store实例</span>
<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()

<span class="hljs-comment">// 更新用户信息</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">updateUser</span> = (<span class="hljs-params"/>) =&gt; {
  userStore.<span class="hljs-title function_">updateUserInfo</span>({
    <span class="hljs-attr">username</span>: <span class="hljs-string">'掘金用户'</span>,
    <span class="hljs-attr">token</span>: <span class="hljs-string">'123456789'</span>
  })
}

<span class="hljs-comment">// 清空用户信息</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">clearUser</span> = (<span class="hljs-params"/>) =&gt; {
  userStore.<span class="hljs-title function_">clearUserInfo</span>()
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-7">三、其他常用通信方式</h2>
<h3 data-id="heading-8">1. v-model 双向绑定</h3>
<p>Vue3 中 v-model 支持自定义绑定属性，可实现父子组件的双向数据绑定，简化子传父的操作。</p>
<p><strong>子组件（Child.vue）</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"child"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
      <span class="hljs-attr">:value</span>=<span class="hljs-string">"modelValue"</span> 
      @<span class="hljs-attr">input</span>=<span class="hljs-string">"emit('update:modelValue', $event.target.value)"</span>
    /&gt;</span>
    <span class="hljs-comment">&lt;!-- 支持多个v-model --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span> 
      <span class="hljs-attr">:value</span>=<span class="hljs-string">"age"</span> 
      @<span class="hljs-attr">input</span>=<span class="hljs-string">"emit('update:age', $event.target.value)"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-title function_">defineProps</span>([<span class="hljs-string">'modelValue'</span>, <span class="hljs-string">'age'</span>])
<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'update:modelValue'</span>, <span class="hljs-string">'update:age'</span>])
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p><strong>父组件（Parent.vue）</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>父组件<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> 
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"username"</span>
      <span class="hljs-attr">v-model:age</span>=<span class="hljs-string">"userAge"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>用户名：{{ username }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>年龄：{{ userAge }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Child.vue'</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> username = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> userAge = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-9">2. 事件总线（mitt）</h3>
<p>Vue3 移除了 Vue2 的 <code>$on/$emit</code> 事件总线，可使用第三方库 <code>mitt</code> 实现任意组件间的通信。</p>
<p><strong>1. 安装 mitt</strong></p>
<pre><code class="hljs">npm install mitt
</code></pre>
<p><strong>2. 创建事件总线（utils/bus.js）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> mitt <span class="hljs-keyword">from</span> <span class="hljs-string">'mitt'</span>
<span class="hljs-keyword">const</span> bus = <span class="hljs-title function_">mitt</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> bus
</code></pre>
<p><strong>3. 组件 A 发送事件</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"sendMsg"</span>&gt;</span>发送消息到组件B<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> bus <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/bus'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendMsg</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 触发自定义事件并传递数据</span>
  bus.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'msgEvent'</span>, <span class="hljs-string">'来自组件A的消息'</span>)
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p><strong>4. 组件 B 接收事件</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>组件A传递的消息：{{ msg }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> bus <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/bus'</span>

<span class="hljs-keyword">const</span> msg = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)

<span class="hljs-comment">// 挂载时监听事件</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  bus.<span class="hljs-title function_">on</span>(<span class="hljs-string">'msgEvent'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
    msg.<span class="hljs-property">value</span> = data
  })
})

<span class="hljs-comment">// 卸载时移除监听（避免内存泄漏）</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  bus.<span class="hljs-title function_">off</span>(<span class="hljs-string">'msgEvent'</span>)
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-10">四、通信方式选型建议</h2>
<p>表格</p>





























<table><thead><tr><th>通信场景</th><th>推荐方式</th></tr></thead><tbody><tr><td>父传子</td><td>Props</td></tr><tr><td>子传父</td><td>自定义事件（Emits）/v-model</td></tr><tr><td>爷孙 / 跨层级</td><td>provide / inject</td></tr><tr><td>全局共享状态</td><td>Pinia</td></tr><tr><td>任意组件临时通信</td><td>mitt 事件总线</td></tr></tbody></table>
<h2 data-id="heading-11">总结</h2>
<ol>
<li>Vue3 中父子组件通信优先使用 <strong>Props + Emits</strong>，v-model 可简化双向绑定场景；</li>
<li>跨层级通信推荐 <strong>provide / inject</strong>，全局状态管理首选 <strong>Pinia</strong>；</li>
<li>临时的任意组件通信可使用 <strong>mitt</strong> 事件总线，注意及时移除监听避免内存泄漏。</li>
</ol>
<p>组件通信的核心是 “数据流向清晰”，无论选择哪种方式，都要保证数据的传递路径可追溯，避免滥用全局通信导致代码维护困难。希望本文能帮助你彻底掌握 Vue3 组件通信，少走弯路～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端将 HTML 转成 Word 文档的踩坑记录（从 html-docx-js到html-to-docx 到 docx）]]></title>    <link>https://juejin.cn/post/7605135197167124530</link>    <guid>https://juejin.cn/post/7605135197167124530</guid>    <pubDate>2026-02-11T08:46:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605135197167124530" data-draft-id="7605135197166993458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端将 HTML 转成 Word 文档的踩坑记录（从 html-docx-js到html-to-docx 到 docx）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-11T08:46:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沈小闹"/> <meta itemprop="url" content="https://juejin.cn/user/2154698523023415"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端将 HTML 转成 Word 文档的踩坑记录（从 html-docx-js到html-to-docx 到 docx）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2154698523023415/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沈小闹
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:46:52.000Z" title="Wed Feb 11 2026 08:46:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端将 HTML 转成 Word 文档的踩坑记录（从 html-docx-js 到 docx）</h2>
<p>在项目中，我需要实现一个功能：<br/>
👉 <strong>将页面渲染出来的 HTML 内容导出为 Word 文档（.docx）</strong></p>
<p>看起来很简单，但真正落地时踩了不少坑。<br/>
这篇文章记录一下从插件选择到最终解决方案的全过程。</p>
<hr/>
<h2 data-id="heading-1">一、插件选型对比</h2>
<h3 data-id="heading-2">1️⃣ html-docx-js</h3>
<p>最早尝试的是 <code>html-docx-js</code>。</p>
<p>优点：</p>
<ul>
<li>使用简单</li>
<li>直接将 HTML 字符串转换成 Word</li>
</ul>
<p>但是很快遇到了问题：</p>
<h4 data-id="heading-3">❗ 多层级有序列表在 WPS 中显示异常</h4>
<p>当 HTML 中存在：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">ol</span>&gt;
  &lt;<span class="hljs-selector-tag">li</span>&gt;一级&lt;/<span class="hljs-selector-tag">li</span>&gt;
  &lt;<span class="hljs-selector-tag">li</span>&gt;
    二级
    &lt;<span class="hljs-selector-tag">ol</span>&gt;
      &lt;<span class="hljs-selector-tag">li</span>&gt;子级&lt;/<span class="hljs-selector-tag">li</span>&gt;
    &lt;/<span class="hljs-selector-tag">ol</span>&gt;
  &lt;/<span class="hljs-selector-tag">li</span>&gt;
&lt;/<span class="hljs-selector-tag">ol</span>&gt;
</code></pre>
<p>在 <strong>Microsoft Word</strong> 中显示正常，<br/>
但在 <strong>WPS</strong> 中会出现：</p>
<ul>
<li>序号错乱</li>
<li>层级缩进异常</li>
<li>列表结构被打乱</li>
</ul>
<p>也就是说：</p>
<blockquote>
<p>html-docx-js 在生成的 docx 结构中，列表兼容性并不稳定。</p>
</blockquote>
<p>对于需要兼容 WPS 的场景来说，这是不可接受的。</p>
<hr/>
<h3 data-id="heading-4">2️⃣ html-to-docx / htmltodoc</h3>
<p>后来尝试 <code>html-to-docx</code> 这一类库。</p>
<p>问题也很明显：</p>
<h4 data-id="heading-5">❗ 不支持 canvas 图片</h4>
<p>如果页面中有：</p>
<ul>
<li>canvas 图表</li>
<li>图形绘制</li>
<li>Echarts</li>
<li>GPT 可视化图表</li>
</ul>
<p>导出后：</p>
<blockquote>
<p>图片为空白</p>
</blockquote>
<p>原因是：</p>
<ul>
<li>这些库只识别 <code>&lt;img&gt;</code></li>
<li>不会处理 <code>&lt;canvas&gt;</code> 的内容</li>
<li>不会主动把 canvas 转成图片</li>
</ul>
<p>在图表场景下，这几乎无法使用。</p>
<hr/>
<h3 data-id="heading-6">3️⃣ 最终选择：docx</h3>
<p>最后选择了 <code>docx</code>（dolanmiu/docx）。</p>
<p>原因：</p>
<ul>
<li>底层生成真实 docx 结构</li>
<li>可控性强</li>
<li>可自定义 ImageRun / Paragraph</li>
<li>兼容性更好</li>
</ul>
<p>但同时：</p>
<blockquote>
<p>自己要负责 HTML → docx 的映射逻辑。</p>
</blockquote>
<p>这也是后面踩坑的开始。</p>
<hr/>
<h2 data-id="heading-7">二、使用 docx 时踩到的坑</h2>
<hr/>
<h2 data-id="heading-8">坑 1：canvas 图片第一次导出是空白</h2>
<p>现象：</p>
<ul>
<li>页面中 canvas 渲染正常</li>
<li>第一次导出 Word，图片是空白</li>
<li>第二次导出却正常</li>
</ul>
<h4 data-id="heading-9">原因</h4>
<p><code>docx</code> 需要的是：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Uint8Array</span>（二进制图片数据）
</code></pre>
<p>而 canvas：</p>
<ul>
<li>是绘图上下文</li>
<li>不是图片资源</li>
<li>如果在 clone 之后再去读取，很可能上下文已经丢失</li>
</ul>
<p>尤其是：</p>
<pre><code class="hljs language-arduino" lang="arduino">element.<span class="hljs-built_in">cloneNode</span>(<span class="hljs-literal">true</span>)
</code></pre>
<p>克隆出来的 canvas：</p>
<blockquote>
<p>不包含绘制内容</p>
</blockquote>
<h4 data-id="heading-10">正确做法</h4>
<p>必须在克隆 HTML 之前：</p>
<ol>
<li>遍历所有 canvas</li>
<li>调用 <code>canvas.toDataURL()</code></li>
<li>缓存结果</li>
<li>在 clone 后替换成 <code>&lt;img src="dataURL"&gt;</code></li>
</ol>
<p>核心原则：</p>
<blockquote>
<p>canvas 先转图片，再克隆 DOM。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">坑 2：ImageRun 被嵌套在 Paragraph 中，图片直接消失</h2>
<p>这是最隐蔽、最坑的一个问题。</p>
<p>现象：</p>
<ul>
<li>图片数据正确</li>
<li>不跨域</li>
<li>二进制正常</li>
<li>但导出 Word 后图片消失</li>
<li>有时 Office Word 还会提示文件有问题</li>
</ul>
<p>打印结构后发现：</p>
<pre><code class="hljs language-markdown" lang="markdown">Paragraph
  └─ Paragraph
<span class="hljs-code">       └─ ImageRun
</span></code></pre>
<p>也就是说：</p>
<blockquote>
<p>ImageRun 外面包了两层 Paragraph。</p>
</blockquote>
<h4 data-id="heading-12">问题本质</h4>
<p>在 docx 结构中：</p>
<ul>
<li><code>Paragraph</code> 是块级元素</li>
<li><code>Paragraph</code> 不能嵌套 <code>Paragraph</code></li>
<li><code>ImageRun</code> 必须直接存在于 Paragraph.children 中</li>
</ul>
<p>非法结构虽然可以被创建，但：</p>
<blockquote>
<p>Word 会忽略或报结构错误。</p>
</blockquote>
<h4 data-id="heading-13">正确结构</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">new</span> <span class="hljs-built_in">Paragraph</span>({
  children: [
    <span class="hljs-keyword">new</span> <span class="hljs-built_in">ImageRun</span>(...)
  ]
})
</code></pre>
<p>而不是：</p>
<pre><code class="hljs language-css" lang="css">new Paragraph({
  children: [
    new <span class="hljs-built_in">Paragraph</span>({
      children: [
        new <span class="hljs-built_in">ImageRun</span>(...)
      ]
    })
  ]
})
</code></pre>
<hr/>
<h2 data-id="heading-14">坑 3：HTML 的结构 ≠ docx 的结构</h2>
<p>在 Markdown 渲染后，HTML 往往是这样：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span>&gt;
  &lt;<span class="hljs-selector-tag">p</span>&gt;
    文字
    &lt;<span class="hljs-selector-tag">img</span> /&gt;
  &lt;/<span class="hljs-selector-tag">p</span>&gt;
&lt;/<span class="hljs-selector-tag">div</span>&gt;
</code></pre>
<p>但 docx 并不是 DOM 树结构。</p>
<p>docx 的正确模型更像是：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">Section</span>
 ├─ Paragraph
 ├─ Paragraph
 ├─ Paragraph
</code></pre>
<p>是一个扁平结构。</p>
<p>因此正确做法是：</p>
<ul>
<li>文字 → 一个 Paragraph</li>
<li>图片 → 一个 Paragraph</li>
<li>保持顺序</li>
<li>不强行还原 HTML 嵌套</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">p</span>&gt;hello &lt;<span class="hljs-selector-tag">img</span> /&gt; world&lt;/<span class="hljs-selector-tag">p</span>&gt;
</code></pre>
<p>应转换为：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">Paragraph</span>("hello")
<span class="hljs-built_in">Paragraph</span>(Image)
<span class="hljs-built_in">Paragraph</span>("world")
</code></pre>
<p>而不是试图在一个 Paragraph 里混排。</p>
<hr/>
<h2 data-id="heading-15">三、最终总结</h2>
<p>在前端做 HTML → Word 导出时，需要注意：</p>
<h4 data-id="heading-16">插件层面</h4>
<ul>
<li>html-docx-js：WPS 兼容性问题</li>
<li>html-to-docx：不支持 canvas</li>
<li>docx：可控但需要自己处理结构</li>
</ul>
<h4 data-id="heading-17">使用 docx 时必须注意</h4>
<ol>
<li>canvas 必须提前转为图片</li>
<li>不要嵌套 Paragraph</li>
<li>ImageRun 必须直接在 Paragraph.children 中</li>
<li>不要试图 1:1 还原 HTML 结构</li>
</ol>
<hr/>
<h2 data-id="heading-18">四、核心经验</h2>
<blockquote>
<p>Word 文档不是浏览器。<br/>
HTML 的语义嵌套不能直接映射到 docx。</p>
</blockquote>
<p>当你开始：</p>
<ul>
<li>把结构扁平化</li>
<li>图片独立成段</li>
<li>主动控制文档结构</li>
</ul>
<p>问题就会变得清晰很多。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 多环境设计最佳实践：从混乱切换到工程化管理]]></title>    <link>https://juejin.cn/post/7605213691910602778</link>    <guid>https://juejin.cn/post/7605213691910602778</guid>    <pubDate>2026-02-11T08:48:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605213691910602778" data-draft-id="7605213691910586394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 多环境设计最佳实践：从混乱切换到工程化管理"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2026-02-11T08:48:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小孩子不可以喝可乐1"/> <meta itemprop="url" content="https://juejin.cn/user/462260169356039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 多环境设计最佳实践：从混乱切换到工程化管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/462260169356039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小孩子不可以喝可乐1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:48:54.000Z" title="Wed Feb 11 2026 08:48:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter 多环境设计最佳实践：从混乱切换到工程化管理</h2>
<p>在实际 Flutter 项目中，几乎都会遇到多环境问题：</p>
<ul>
<li>开发环境（dev）</li>
<li>测试环境（staging / test）</li>
<li>生产环境（prod）</li>
</ul>
<p>环境差异通常包括：</p>
<ul>
<li>接口地址不同</li>
<li>日志等级不同</li>
<li>功能开关不同</li>
<li>第三方服务 key 不同</li>
</ul>
<p>很多人一开始是这样做的：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">baseUrl</span> = <span class="hljs-string">"http://test-api.xxx.com"</span><span class="hljs-comment">;</span>
</code></pre>
<p>发版前手动改成：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">baseUrl</span> = <span class="hljs-string">"https://api.xxx.com"</span><span class="hljs-comment">;</span>
</code></pre>
<p>这种方式看似简单，但存在严重问题：</p>
<ul>
<li>容易误发测试接口到生产</li>
<li>每次发版都要改代码</li>
<li>无法自动化 CI/CD</li>
<li>无法规范团队协作</li>
</ul>
<p>那么 Flutter 项目中，<strong>正确的多环境设计方式是什么？</strong></p>
<p>本文将给出一套工程化解决方案。</p>
<hr/>
<h2 data-id="heading-1">一、环境设计的核心思想</h2>
<p>Flutter 多环境设计的本质不是“切换地址”，而是：</p>
<blockquote>
<p>将环境控制权从代码中剥离，交给构建流程。</p>
</blockquote>
<p>完整逻辑可以拆成三层：</p>
<pre><code class="hljs">构建层 → 决定环境
配置层 → 存储差异
访问层 → 统一管理
</code></pre>
<hr/>
<h2 data-id="heading-2">二、推荐方案：单入口 + dart-define</h2>
<p>很多文章会推荐使用多个 <code>main.dart</code> 或 Android 原生 flavor。</p>
<p>但如果你只是需要：</p>
<ul>
<li>切换接口</li>
<li>切换 debug 开关</li>
<li>切换日志等级</li>
</ul>
<p><strong>完全没必要增加原生复杂度。</strong></p>
<p>更推荐：</p>
<blockquote>
<p>单入口 + dart-define + JSON 配置文件</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">三、完整实现步骤</h2>
<h3 data-id="heading-4">1️⃣ 创建环境配置文件</h3>
<pre><code class="hljs language-arduino" lang="arduino">assets/config/env/
  ├── dev.json
  ├── staging.json
  └── prod.json
</code></pre>
<p>示例：</p>
<h4 data-id="heading-5">dev.json</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:3000"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"debug"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-6">prod.json</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"https://api.xxx.com"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"timeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8000</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"debug"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">2️⃣ 注册 assets</h3>
<p>在 <code>pubspec.yaml</code> 中：</p>
<pre><code class="hljs language-arduino" lang="arduino">flutter:
  assets:
    - assets/config/env/dev.json
    - assets/config/env/staging.json
    - assets/config/env/prod.json
</code></pre>
<hr/>
<h3 data-id="heading-8">3️⃣ 定义配置模型</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EnvConfig</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> baseUrl;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> timeout;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> debug;

  EnvConfig({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.baseUrl,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.timeout,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.debug,
  });

  <span class="hljs-keyword">factory</span> EnvConfig.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) {
    <span class="hljs-keyword">return</span> EnvConfig(
      baseUrl: json[<span class="hljs-string">'baseUrl'</span>],
      timeout: json[<span class="hljs-string">'timeout'</span>],
      debug: json[<span class="hljs-string">'debug'</span>],
    );
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">4️⃣ 创建环境管理类</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'dart:convert'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/services.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'env_config.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Env</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">late</span> EnvConfig _config;

  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; init() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-built_in">String</span> flavor =
        <span class="hljs-built_in">String</span>.fromEnvironment(<span class="hljs-string">'FLAVOR'</span>, defaultValue: <span class="hljs-string">'dev'</span>);

    <span class="hljs-keyword">final</span> path = <span class="hljs-string">'assets/config/env/<span class="hljs-subst">$flavor</span>.json'</span>;

    <span class="hljs-keyword">final</span> jsonStr = <span class="hljs-keyword">await</span> rootBundle.loadString(path);
    <span class="hljs-keyword">final</span> jsonMap = json.decode(jsonStr);

    _config = EnvConfig.fromJson(jsonMap);
  }

  <span class="hljs-keyword">static</span> <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> baseUrl =&gt; _config.baseUrl;
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-keyword">get</span> timeout =&gt; _config.timeout;
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> debug =&gt; _config.debug;
}
</code></pre>
<hr/>
<h3 data-id="heading-10">5️⃣ 在 main.dart 初始化</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span>() <span class="hljs-keyword">async</span></span> {
  WidgetsFlutterBinding.ensureInitialized();
  <span class="hljs-keyword">await</span> Env.<span class="hljs-keyword">init</span>();
  runApp(<span class="hljs-function"><span class="hljs-keyword">const</span> <span class="hljs-title">MyApp</span>())</span>;
}
</code></pre>
<hr/>
<h3 data-id="heading-11">6️⃣ 构建时切换环境</h3>
<p>开发环境：</p>
<pre><code class="hljs language-ini" lang="ini">flutter run <span class="hljs-attr">--dart-define</span>=FLAVOR=dev
</code></pre>
<p>测试环境：</p>
<pre><code class="hljs language-ini" lang="ini">flutter run <span class="hljs-attr">--dart-define</span>=FLAVOR=staging
</code></pre>
<p>生产环境：</p>
<pre><code class="hljs language-ini" lang="ini">flutter build apk <span class="hljs-attr">--dart-define</span>=FLAVOR=prod
</code></pre>
<hr/>
<h2 data-id="heading-12">四、为什么推荐 dart-define？</h2>
<p><code>String.fromEnvironment()</code> 是：</p>
<blockquote>
<p>编译期常量</p>
</blockquote>
<p>意味着：</p>
<ul>
<li>构建时写死</li>
<li>运行时不能修改</li>
<li>无额外性能损耗</li>
<li>非运行时判断</li>
</ul>
<p>这是一种工程化设计，而不是业务层 if 判断。</p>
<hr/>
<h2 data-id="heading-13">五、方案对比</h2>



































<table><thead><tr><th>方案</th><th>单入口 + dart-define</th><th>多 main + 原生 flavor</th></tr></thead><tbody><tr><td>维护成本</td><td>低</td><td>高</td></tr><tr><td>原生配置</td><td>不需要</td><td>需要</td></tr><tr><td>CI/CD</td><td>简单</td><td>复杂</td></tr><tr><td>多包名支持</td><td>不支持</td><td>支持</td></tr><tr><td>多图标支持</td><td>不支持</td><td>支持</td></tr></tbody></table>
<p>结论：</p>
<ul>
<li>只切接口 → 用 dart-define</li>
<li>多包名多图标 → 用原生 flavor</li>
</ul>
<hr/>
<h2 data-id="heading-14">六、工程化原则总结</h2>
<ol>
<li>环境 ≠ 业务逻辑</li>
<li>环境差异文件化</li>
<li>构建期决定环境</li>
<li>运行期只读取配置</li>
<li>统一 Env 管理访问</li>
</ol>
<hr/>
<h2 data-id="heading-15">七、安全提醒</h2>
<p>不要在 JSON 中存储：</p>
<ul>
<li>私钥</li>
<li>支付密钥</li>
<li>第三方 secret</li>
</ul>
<p>Flutter 包是可反编译的。</p>
<hr/>
<h2 data-id="heading-16">八、进阶思考</h2>
<p>当你理解了这套设计后，可以继续演进：</p>
<ul>
<li>与 CI/CD 集成自动构建</li>
<li>支持灰度发布</li>
<li>支持远程动态配置</li>
<li>与 Android flavor 结合实现多包名</li>
</ul>
<hr/>
<h2 data-id="heading-17">结语</h2>
<p>Flutter 多环境设计的核心不是切换地址，</p>
<p>而是：</p>
<blockquote>
<p>将环境控制权从代码转移到构建流程。</p>
</blockquote>
<p>当你开始从“写代码”转向“设计工程结构”，<br/>
你的思维层级就已经发生变化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Markdown常用标准语法]]></title>    <link>https://juejin.cn/post/7605140481488830505</link>    <guid>https://juejin.cn/post/7605140481488830505</guid>    <pubDate>2026-02-11T08:41:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605140481488830505" data-draft-id="7605214360084234276" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Markdown常用标准语法"/> <meta itemprop="keywords" content="代码规范"/> <meta itemprop="datePublished" content="2026-02-11T08:41:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tinghui"/> <meta itemprop="url" content="https://juejin.cn/user/3968587001244187"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Markdown常用标准语法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3968587001244187/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tinghui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:41:59.000Z" title="Wed Feb 11 2026 08:41:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Markdown 是轻量级标记语言，语法简单且跨平台通用（几乎所有笔记 / 文档工具都支持），且是现在AI提示词的主流格式，以下是<strong>通用标准语法</strong>（不含各平台扩展语法）：</p>
<hr/>
<h3 data-id="heading-0">1. 标题</h3>
<p>用<code>#</code>表示标题级别，<code>#</code>数量对应 1-6 级标题，<code>#</code>和文字之间必须加<strong>空格</strong>（新手易出错）。</p>
<p>markdown</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">一级标题（最大）</span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 二级标题</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">## 三级标题</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">### 四级标题</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#### 五级标题</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">##### 六级标题（最小）</span></span>
</code></pre>
<p>日常使用中 1-3 级标题最常用，六级标题几乎很少用到。</p>
<h3 data-id="heading-1">2. 文本强调（粗体 / 斜体 / 删除线）</h3>
<p>表格</p>



































<table><thead><tr><th>效果</th><th>语法</th><th>示例</th><th>渲染效果</th></tr></thead><tbody><tr><td>粗体</td><td><code>**文字**</code></td><td><code>**重要内容**</code></td><td><strong>重要内容</strong></td></tr><tr><td>斜体</td><td><code>*文字*</code></td><td><code>*备注信息*</code></td><td><em>备注信息</em></td></tr><tr><td>粗斜体</td><td><code>***文字***</code></td><td><code>***核心重点***</code></td><td><em><strong>核心重点</strong></em></td></tr><tr><td>删除线</td><td><code>~~文字~~</code></td><td><code>~~作废内容~~</code></td><td><del>作废内容</del></td></tr></tbody></table>
<h3 data-id="heading-2">3. 列表（无序 / 有序 / 嵌套）</h3>
<h4 data-id="heading-3">无序列表</h4>
<p>用<code>-</code>/<code>+</code>/<code>*</code>开头（选一种即可），符号后加空格：</p>
<p>markdown</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">-</span> 列表项1
<span class="hljs-bullet">-</span> 列表项2
<span class="hljs-bullet">  -</span> 嵌套子项（缩进2个空格）
<span class="hljs-bullet">+</span> 另一种无序列表
</code></pre>
<h4 data-id="heading-4">有序列表</h4>
<p>用<code>数字.</code>开头，符号后加空格：</p>
<p>markdown</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 第一步
<span class="hljs-bullet">2.</span> 第二步
<span class="hljs-bullet">   1.</span> 嵌套子步骤
<span class="hljs-bullet">3.</span> 第三步
</code></pre>
<h3 data-id="heading-5">4. 链接与图片</h3>
<h4 data-id="heading-6">链接</h4>
<ul>
<li>
<p>行内链接（最常用）：<code>[链接文字](链接地址 "可选标题")</code></p>
<p>markdown</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-attr">[百度]</span>(<span class="hljs-attribute">https</span>:<span class="hljs-comment">//www.baidu.com "百度首页")</span>
</code></pre>
</li>
<li>
<p>锚点链接（跳转到文档内位置）：<code>[回到顶部](#一级标题)</code></p>
</li>
</ul>
<h4 data-id="heading-7">图片</h4>
<p>语法和链接类似，只是开头多一个<code>!</code>：</p>
<p>markdown</p>
<pre><code class="hljs language-less" lang="less">!<span class="hljs-selector-attr">[图片替代文字]</span>(图片URL <span class="hljs-string">"可选标题"</span>)
# 替代文字：图片加载失败时显示的文字；标题：鼠标悬停时显示
!<span class="hljs-selector-attr">[示例图]</span>(<span class="hljs-attribute">https</span>:<span class="hljs-comment">//example.com/img.jpg "这是一张示例图")</span>
</code></pre>
<h3 data-id="heading-8">5. 代码（行内 / 块级）</h3>
<h4 data-id="heading-9">行内代码</h4>
<p>用单个反引号<code>`</code>包裹，适合标注少量代码 / 命令：</p>
<p>markdown</p>
<pre><code class="hljs language-css" lang="css">执行`python <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.py</span>`命令启动程序
</code></pre>
<h4 data-id="heading-10">代码块</h4>
<p>用三个反引号 ``` 包裹，指定语言可实现语法高亮：</p>
<p>markdown</p>
<pre><code class="hljs language-scss" lang="scss">```python
# 这是Python代码示例
def <span class="hljs-built_in">hello</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello Markdown!"</span>)
<span class="hljs-built_in">hello</span>()
</code></pre>
<p>plaintext</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">## 6. 引用</span></span>
用`&gt;`开头，嵌套引用加多个`&gt;`：
```markdown
<span class="hljs-meta prompt_">&gt; </span><span class="bash">一级引用（比如引用他人观点）</span>
<span class="hljs-meta prompt_">&gt;</span><span class="bash">&gt; 二级嵌套引用</span>
<span class="hljs-meta prompt_">&gt;</span><span class="bash">&gt;&gt; 三级嵌套引用</span>
</code></pre>
<h3 data-id="heading-11">7. 分割线</h3>
<p>用连续的 3 个及以上<code>-</code>/<code>*</code>/<code>_</code>（单独一行，前后空行）：</p>
<p>markdown</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-string">***</span>
<span class="hljs-string">___</span>
</code></pre>
<p>⚠️ 注意：不要混写（比如<code>-*-</code>），保持统一更规范。</p>
<h3 data-id="heading-12">8. 表格</h3>
<p>用<code>|</code>分隔列，第二行用<code>-</code>分隔表头和内容，<code>:</code>控制对齐：</p>
<p>markdown</p>
<pre><code class="hljs language-ruby" lang="ruby">|<span class="hljs-params"> 姓名 </span>| 年龄 |<span class="hljs-params"> 城市 </span>|
|<span class="hljs-params"> :--- </span>| <span class="hljs-symbol">:--</span>: |<span class="hljs-params"> ---: </span>|
|<span class="hljs-params"> 张三 </span>| <span class="hljs-number">20</span>   |<span class="hljs-params"> 北京 </span>|
|<span class="hljs-params"> 李四 </span>| <span class="hljs-number">25</span>   |<span class="hljs-params"> 上海 </span>|
<span class="hljs-comment"># 对齐规则：:---（左对齐）、:--:（居中）、---:（右对齐）</span>
</code></pre>
<h3 data-id="heading-13">9. 转义字符</h3>
<p>如果想显示 Markdown 特殊符号（比如<code>#</code>/<code>*</code>/<code>[ ]</code>），用``转义：</p>
<p>markdown</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 这不是标题（原本#是标题符号，转义后仅显示#）</span>
<span class="hljs-bullet">*</span> 这不是斜体
</code></pre>
<hr/>
<h3 data-id="heading-14">总结</h3>
<ol>
<li>Markdown 核心是 “符号 + 空格” 的组合，<strong>符号与文字间的空格</strong>是新手最容易忽略的关键；</li>
<li>常用语法优先掌握：标题、粗体 / 斜体、列表、代码块、链接，能满足 80% 的日常使用场景；</li>
<li>标准语法跨平台通用（如 Typora、VS Code、GitHub），扩展语法（如任务列表）需看编辑器支持。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[嵌入式之Ubuntu22.04构建XMOS]]></title>    <link>https://juejin.cn/post/7605140481488846889</link>    <guid>https://juejin.cn/post/7605140481488846889</guid>    <pubDate>2026-02-11T08:42:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605140481488846889" data-draft-id="7604793276907569215" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="嵌入式之Ubuntu22.04构建XMOS"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2026-02-11T08:42:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="K神"/> <meta itemprop="url" content="https://juejin.cn/user/160945808873534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            嵌入式之Ubuntu22.04构建XMOS
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/160945808873534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    K神
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T08:42:24.000Z" title="Wed Feb 11 2026 08:42:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你好呀，我的老朋友！我是老寇，跟我一起学习构建XMOS</p>
<p>基于命令构建，花了几天时间才完成构建，希望对你有所帮助。</p>
<p>XMOS地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.xmos.com" target="_blank" title="https://www.xmos.com" ref="nofollow noopener noreferrer">www.xmos.com</a></p>
<p>XMOS是一家英国的半导体公司，致力于帮助人们构建任何事物。XCORE®芯片是生成式系统级芯片（GenSoC）平台——高性能、高确定性的多处理平台，可无限重构，在单个器件中集成控制、I/O、DSP和AI等功能。</p>
<p><strong>我们主要是用于对声音的前置处理，比如降噪等等。</strong></p>
<h6 data-id="heading-0">初始化安装插件</h6>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">切换root用户</span>
su root
<span class="hljs-meta prompt_">
# </span><span class="bash">安装SSH</span>
apt install openssh-server
<span class="hljs-meta prompt_">
# </span><span class="bash">开机启用ssh</span>
systemctl enable ssh
<span class="hljs-meta prompt_">
# </span><span class="bash">安装gcc和cmake</span>
apt update
apt install build-essential
apt install cmake
<span class="hljs-meta prompt_">
# </span><span class="bash">查看gcc版本</span>
gcc --version
<span class="hljs-meta prompt_">
# </span><span class="bash">安装g++</span>
apt install g++
<span class="hljs-meta prompt_">
# </span><span class="bash">查看g++版本</span>
g++ --version
<span class="hljs-meta prompt_">
# </span><span class="bash">安装pkg-config</span>
apt update
apt install pkg-config
<span class="hljs-meta prompt_">
# </span><span class="bash">查看pkg-config</span>
pkg-config --version
<span class="hljs-meta prompt_">
# </span><span class="bash">安装libusb</span>
apt install libusb-1.0-0-dev
<span class="hljs-meta prompt_">
# </span><span class="bash">查看libusb版本</span>
pkg-config --modversion libusb-1.0
</code></pre>
<h2 data-id="heading-1">安装XMOS</h2>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">创建XMOS目录</span>
mkdir -p /home/a/app/xmos
<span class="hljs-meta prompt_">
# </span><span class="bash">进入目录</span>
cd /home/a/xmos
<span class="hljs-meta prompt_">
# </span><span class="bash">下载XMOS Tools</span>
<span class="hljs-meta prompt_"># </span><span class="bash">文档地址：https://www.xmos.com/xtc-install-guide</span>
wget https://www.xmos.com/file/tools-15-linux-64?version=latest
<span class="hljs-meta prompt_">
# </span><span class="bash">安装XMOS Tools</span>
<span class="hljs-meta prompt_"># </span><span class="bash">安装目录：/home/a/XMOS/..</span>
tar -xf tools-15-linux-15-3-1.tgz -C ~
<span class="hljs-meta prompt_">
# </span><span class="bash">添加环境变量【根据实际情况而定，找到你安装XMOS的路径】</span>
<span class="hljs-meta prompt_"># </span><span class="bash">每一次都需要手动这样执行，不然会告诉你找不到xcc命令</span>
cd /home/a/XMOS/XTC/15.3.1
source SetEnv
<span class="hljs-meta prompt_">
# </span><span class="bash">查看xcc版本，有结果输出就是安装成功</span>
xcc --version
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c33f1f1a85564ab299053d3349d3d1a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS-elng==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771404143&amp;x-signature=W%2BaO0xfGV22BkD3SOUPWT9zYVso%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-2">安装目标板和xTAG</h6>
<p>使用两根USB线连接开发版即可
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f48d2262add641f099c0df1612d07eda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS-elng==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771404143&amp;x-signature=bxF5ADw5l1qM77jK3WwevZQE07s%3D" alt="25c8d85d25481dc59981a2831758bc89.jpg" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">切换a用户</span>
su a
<span class="hljs-meta prompt_"># </span><span class="bash">进入XMOS脚本目录</span>
cd /home/a/XMOS/XTC/15.3.1/scripts
<span class="hljs-meta prompt_"># </span><span class="bash">安装</span>
sudo ./setup_xmos_devices.sh
<span class="hljs-meta prompt_"># </span><span class="bash">检查</span>
./check_xmos_devices.sh
<span class="hljs-meta prompt_"># </span><span class="bash">重启设备，查看运行状态</span>
xrun -l
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26cf78597da045ccbb6a453f245bae7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS-elng==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771404143&amp;x-signature=uoaJ6xDl1m2qPAcD0ofMAsQnlTQ%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-3">运行例子</h6>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">切换root用户</span>
su root
<span class="hljs-meta prompt_">
# </span><span class="bash">进入xmos目录</span>
cd /home/a/xmos
<span class="hljs-meta prompt_">
# </span><span class="bash">安装git</span>
apt install git
<span class="hljs-meta prompt_">
# </span><span class="bash">拉取源码【需要配置SSH密钥】</span>
git clone --recurse-submodules git@github.com:xmos/sln_voice.git
<span class="hljs-meta prompt_">
# </span><span class="bash">查看/home/a/app/xmos/sln_voice/examples/ffva/READ.rts</span>
<span class="hljs-meta prompt_"># </span><span class="bash">查看/home/a/app/xmos/sln_voice/examples/ffva/READ.rts</span>
<span class="hljs-meta prompt_"># </span><span class="bash">查看/home/a/app/xmos/sln_voice/examples/ffva/READ.rts</span>
<span class="hljs-meta prompt_">
# </span><span class="bash">安装 venv</span>
sudo apt install python3-venv python3-full
<span class="hljs-meta prompt_">
# </span><span class="bash">创建虚拟环境</span>
python3 -m venv venv
<span class="hljs-meta prompt_">
# </span><span class="bash">激活</span>
source venv/bin/activate
<span class="hljs-meta prompt_">
# </span><span class="bash">安装ninja</span>
pip install ninja
<span class="hljs-meta prompt_">
# </span><span class="bash">新增环境变量</span>
SET "XMOS_TOOL_PATH=/home/a/XMOS/XTC/15.3.1"
<span class="hljs-meta prompt_">
# </span><span class="bash">构建/opt/xmos/bin</span>
cmake -B build_host
cd build_host
make install -j
<span class="hljs-meta prompt_">
# </span><span class="bash">回到上级目录</span>
cd ..
<span class="hljs-meta prompt_">
# </span><span class="bash">构建固件</span>
pip install -r requirements.txt
cmake -B build --toolchain xmos_cmake_toolchain/xs3a.cmake
cd build
make example_ffva_ua_adec_altarch -j
make example_ffva_int_fixed_delay -j
make example_ffva_int_cyberon_fixed_delay -j
<span class="hljs-meta prompt_">
# </span><span class="bash">烧录固件</span>
xflash --factory example_ffva_int_cyberon_fixed_delay.xe
xflash --factory example_ffva_int_fixed_delay.xe
xflash --factory example_ffva_ua_adec_altarch.xe
<span class="hljs-meta prompt_">
# </span><span class="bash">运行固件</span>
xrun --xscope example_ffva_ua_adec_altarch.xe
xrun --xscope example_ffva_int_fixed_delay.xe
xrun --xscope example_ffva_int_cyberon_fixed_delay.xe
<span class="hljs-meta prompt_">
# </span><span class="bash">xgdb调试固件</span>
xgdb -ex "conn --xscope" -ex "r" example_ffva_ua_adec_altarch.xe
xgdb -ex "conn --xscope" -ex "r" example_ffva_int_fixed_delay.xe
xgdb -ex "conn --xscope" -ex "r" example_ffva_int_cyberon_fixed_delay.xe
</code></pre>
<p>我是老寇，我们下次再见啦！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VS Code 1.109 更新解读（四）：终端、编辑器与工作台]]></title>    <link>https://juejin.cn/post/7605173538417442826</link>    <guid>https://juejin.cn/post/7605173538417442826</guid>    <pubDate>2026-02-11T07:45:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605173538417442826" data-draft-id="7605401415855161394" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VS Code 1.109 更新解读（四）：终端、编辑器与工作台"/> <meta itemprop="keywords" content="Visual Studio Code"/> <meta itemprop="datePublished" content="2026-02-11T07:45:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一只叁木Meow"/> <meta itemprop="url" content="https://juejin.cn/user/231371762837604"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VS Code 1.109 更新解读（四）：终端、编辑器与工作台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/231371762837604/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一只叁木Meow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:45:30.000Z" title="Wed Feb 11 2026 07:45:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>💡 更多技术分享，欢迎访问我的博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsanmu7.com%2F" target="_blank" title="https://sanmu7.com/" ref="nofollow noopener noreferrer">叁木の小屋</a></p>
</blockquote>
<blockquote>
<p><strong>系列索引</strong>：<a href="https://juejin.cn/post/7605114266024460339" target="_blank" title="https://juejin.cn/post/7605114266024460339">总览</a> | <a href="https://juejin.cn/post/7605135197166731314" target="_blank" title="https://juejin.cn/post/7605135197166731314">（一）</a>| <a href="https://juejin.cn/post/7605135197166747698" target="_blank" title="https://juejin.cn/post/7605135197166747698">（二）</a> | <a href="https://juejin.cn/post/7605401415855259698" target="_blank" title="https://juejin.cn/post/7605401415855259698">（三）</a> | <strong>（四）</strong> | <a href="https://juejin.cn/post/7605157203591282715" target="_blank" title="https://juejin.cn/post/7605157203591282715">（五）</a></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">本篇概要</h2>
<p>除了 AI 功能，VS Code 1.109 也带来了大量终端、编辑器和工作台的改进：</p>
<ul>
<li>Kitty 键盘协议支持</li>
<li>括号匹配前景色定制</li>
<li>集成浏览器（预览）</li>
<li>工作台生产力增强</li>
</ul>
<hr/>
<h2 data-id="heading-1">一、终端增强</h2>
<h3 data-id="heading-2">1.1 选择性忽略粘性滚动</h3>
<p><strong>设置</strong>：<code>terminal.integrated.stickyScroll.ignoredCommands</code></p>
<p>可自定义哪些命令不显示在粘性滚动中。</p>
<p><strong>默认忽略</strong>：<code>copilot</code>、<code>claude</code>、<code>codex</code>、<code>gemini</code> 等 AI CLI</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"terminal.integrated.stickyScroll.ignoredCommands"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"clear"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"copilot"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"claude"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"codex"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"gemini"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-3">1.2 移除 winpty 支持</h3>
<p>不再支持 Windows 10 版本 1809 之前的版本。</p>
<p>建议升级到 Windows 10 最新版本或 Windows 11。</p>
<h3 data-id="heading-4">1.3 允许在受限工作区打开终端</h3>
<p><strong>设置</strong>：<code>terminal.integrated.allowInUntrustedWorkspace</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"terminal.integrated.allowInUntrustedWorkspace"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>⚠️ 仅在了解风险且已配置安全 shell 时启用</p>
</blockquote>
<h3 data-id="heading-5">1.4 Kitty 键盘协议（实验性）</h3>
<p><strong>设置</strong>：<code>terminal.integrated.enableKittyKeyboardProtocol</code></p>
<p>修复传统击键编码的许多限制：</p>





















<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>更多修饰键</td><td>不仅限于 alt 和 ctrl</td></tr><tr><td>按下/释放事件</td><td>支持检测按键释放</td></tr><tr><td>消除歧义</td><td>如 Escape 不再与转义序列混淆</td></tr></tbody></table>
<p><strong>立即可见的好处</strong>：Shift+Enter 在某些 AI CLI 中无需额外设置即可工作。</p>
<h3 data-id="heading-6">1.5 Win32 输入模式（实验性）</h3>
<p><strong>设置</strong>：<code>terminal.integrated.enableWin32InputMode</code></p>
<p>针对 Windows 和 ConPTY 调整的类似功能，本版本中保持关闭。</p>
<hr/>
<h2 data-id="heading-7">二、编码与编辑器</h2>
<h3 data-id="heading-8">2.1 括号匹配前景色</h3>
<p>可自定义匹配括号的文本颜色（不仅仅是背景和边框）。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"workbench.colorCustomizations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editorBracketMatch.foreground"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#ff0000"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-9">2.2 双击选择括号或字符串内容</h3>
<pre><code class="hljs language-arduino" lang="arduino">[  选择这个内容  ]    <span class="hljs-string">"选择这个内容"</span>
   ↑              ↑
开括号后/闭括号前    开引号后/闭引号前
</code></pre>
<h3 data-id="heading-10">2.3 TypeScript 重命名建议</h3>
<p>输入覆盖现有声明时也能触发重命名建议：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">index</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
     ↓ 输入 chunkIndex
let <span class="hljs-attr">chunkIndex</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
     ↓ Shift+Tab 应用重命名
// 其他地方的 index 也变为 chunkIndex
</code></pre>
<blockquote>
<p>⚠️ 目前仅支持 TypeScript</p>
</blockquote>
<h3 data-id="heading-11">2.4 改进的幽灵文本可见性</h3>
<p>少于三个连续非空白字符的短建议显示<strong>虚线下划线</strong>：</p>
<pre><code class="hljs language-c" lang="c">console.<span class="hljs-built_in">log</span>▼
            └─ 虚线下划线表示幽灵文本
</code></pre>
<h3 data-id="heading-12">2.5 代码段文件模式</h3>
<p>使用 <code>include</code> 和 <code>exclude</code> 控制代码段出现范围：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"Travis CI node_js"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">".travis.yml"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prefix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"language: node_js"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"node_js:"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">" - $1"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Node.js configuration for Travis CI"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"Exclude from tests"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*.test.*"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"prefix"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"debug"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"body"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"console.log($1);"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Debug logging (excluded from tests)"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-13">2.6 改进的 shebang 语言检测</h3>
<p>改进对 <code>/usr/bin/env</code> 和附加标志的支持：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/usr/bin/env -S deno -A</span>
<span class="hljs-comment"># 现在能正确识别为 TypeScript</span>
</code></pre>
<hr/>
<h2 data-id="heading-14">三、工作台与生产力</h2>
<h3 data-id="heading-15">3.1 集成浏览器（预览）</h3>
<p><strong>设置</strong>：</p>
<ul>
<li><code>workbench.browser.openLocalhostLinks</code></li>
<li><code>simpleBrowser.useIntegratedBrowser</code></li>
<li><code>livePreview.useIntegratedBrowser</code></li>
</ul>
<p>VS Code 桌面版新增完整浏览器体验：</p>

































<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>持久化存储</td><td>可配置全局/工作区/临时存储</td></tr><tr><td>添加元素到聊天</td><td>选择元素发送给智能体</td></tr><tr><td>完整 DevTools</td><td>所有开发者工具</td></tr><tr><td>键盘快捷键</td><td>完整键盘导航</td></tr><tr><td>页面查找</td><td>内置搜索功能</td></tr><tr><td>网站登录</td><td>支持 Cookie 和认证</td></tr></tbody></table>
<p><strong>启动命令</strong>：<code>Browser: Open Integrated Browser</code></p>
<h3 data-id="heading-16">3.2 工作区打开时恢复编辑器</h3>
<p><strong>设置</strong>：<code>workbench.editor.restoreEditors</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"workbench.editor.restoreEditors"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>  <span class="hljs-comment">// 启动时不清空编辑器</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>未保存的编辑器始终会恢复，防止数据丢失</p>
</blockquote>
<h3 data-id="heading-17">3.3 高级设置</h3>
<p><strong>设置</strong>：<code>workbench.settings.showAdvancedSettings</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"workbench.settings.showAdvancedSettings"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>  <span class="hljs-comment">// 始终显示高级设置</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-18">3.4 拖放导入配置文件</h3>
<p>可直接拖放 <code>.code-profile</code> 文件到 VS Code 窗口导入配置。</p>
<h3 data-id="heading-19">3.5 输出面板过滤改进</h3>
<p>支持否定模式和多个过滤器：</p>
<pre><code class="hljs language-lua" lang="lua">typescript          只显示包含 <span class="hljs-string">"typescript"</span> 的行
!<span class="hljs-built_in">debug</span>              隐藏包含 <span class="hljs-string">"debug"</span> 的行
typescript, !<span class="hljs-built_in">debug</span>  组合过滤
</code></pre>
<h3 data-id="heading-20">3.6 按来源过滤问题</h3>
<p>问题面板支持按诊断来源过滤：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">source</span>:ts        仅显示 TypeScript 诊断
!<span class="hljs-built_in">source</span>:cSpell   隐藏拼写检查器警告
<span class="hljs-built_in">source</span>:eslint    仅显示 ESLint 诊断
</code></pre>
<h3 data-id="heading-21">3.7 Git 增强</h3>

























<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td>折叠所有</td><td>SCM 视图中一键折叠所有目录</td></tr><tr><td>Delete 命令</td><td><code>Git: Delete</code> 直接 <code>git rm</code> 文件</td></tr><tr><td>blame 悬停</td><td>可禁用 blame 装饰的悬停弹出</td></tr><tr><td>worktree 文件</td><td>指定额外文件复制到 worktree</td></tr></tbody></table>
<h3 data-id="heading-22">3.8 自动任务默认禁用</h3>
<p><strong>设置</strong>：<code>task.allowAutomaticTasks</code></p>
<p>现在默认为 <code>off</code>，提高安全性：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"task.allowAutomaticTasks"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"on"</span>  <span class="hljs-comment">// 恢复旧行为</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-23">3.9 无障碍改进</h3>





























<table><thead><tr><th>改进</th><th>说明</th></tr></thead><tbody><tr><td>动态流式聊天</td><td>屏幕阅读器实时跟随 AI 响应</td></tr><tr><td>稳定光标位置</td><td>防止焦点变化干扰导航</td></tr><tr><td>ARIA 警报</td><td>新聊天会话通知</td></tr><tr><td>改进工具调用信息</td><td>更容易理解 AI 操作</td></tr><tr><td>公告光标位置</td><td>Ctrl/Cmd+Alt+Shift+G</td></tr></tbody></table>
<h3 data-id="heading-24">3.10 企业改进</h3>
<p><strong>改进的 GitHub 组织策略执行</strong>：</p>
<ul>
<li>根据首选 Copilot 账户正确应用策略</li>
<li>启动时网络不可用也能一致执行策略</li>
</ul>
<hr/>
<h2 data-id="heading-25">快速配置参考</h2>
<h3 data-id="heading-26">终端配置</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"terminal.integrated.enableKittyKeyboardProtocol"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"terminal.integrated.stickyScroll.ignoredCommands"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"clear"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"npm"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-27">括号匹配颜色</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"workbench.colorCustomizations"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editorBracketMatch.foreground"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#00ff00"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-28">集成浏览器</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"workbench.browser.openLocalhostLinks"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"integrated"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"simpleBrowser.useIntegratedBrowser"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-29">工作区恢复</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"workbench.editor.restoreEditors"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-30">下一篇预告</h2>
<p><strong><a href="https://juejin.cn/post/7605157203591282715" target="_blank" title="https://juejin.cn/post/7605157203591282715">（五）API与工程改进</a></strong> 将深入探讨：</p>
<ul>
<li>Quick Input 按钮位置 API</li>
<li>Chat Model Provider 配置</li>
<li>macOS DMG 镜像</li>
<li>Windows 安装重设计</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解析 Temperature 与 Top P：如何掌控大模型的输出随机性]]></title>    <link>https://juejin.cn/post/7605051886435287103</link>    <guid>https://juejin.cn/post/7605051886435287103</guid>    <pubDate>2026-02-11T07:04:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605051886435287103" data-draft-id="7605142381152370751" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解析 Temperature 与 Top P：如何掌控大模型的输出随机性"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-11T07:04:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解析 Temperature 与 Top P：如何掌控大模型的输出随机性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:04:47.000Z" title="Wed Feb 11 2026 07:04:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    25
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">前言</h4>
<img src="https://p1.ssl.qhimg.com/d/inn/d231d4dc137f/WechatIMG7050.jpg" loading="lazy"/>
<p>在AI时代，大语言模型（LLM）如 <code>ChatGPT</code> 或<code>Gemini </code> 已成为我们的“数字大脑”。如果你经常使用这些大模型，那你肯定见过Temperature 和 TopP 这两个参数。比如 <code>ChatGPT</code> 的API文档就有介绍：</p>
<p>根据描述：</p>
<p><strong>Temperature（温度）：</strong> 取值在 0 到 2 之间。较高的值（如 0.8）将使输出更加随机，而较低的值（如 0.2）将使输出更加集中和确定。</p>
<p><strong>Top P（核采样）：</strong> 温度采样的替代方法。模型仅考虑概率质量排名前 P% 的标记的结果。例如，0.1 表示仅考虑概率排名前 10% 的标记。</p>
<p>看到这里，你可能觉得已经懂了：<em>它们就是控制随机性的开关嘛。值越高越发散，值越低越保守。</em></p>
<p>但仔细一想，问题来了：</p>
<ol>
<li><strong>为什么</strong>值越高越随机，越低越稳定？背后的数学原理是什么？</li>
<li>如果它们控制的都是随机性，<strong>为什么需要两个参数</strong>？</li>
<li>如果把一个调高，另一个调低，效果会中和吗？</li>
<li>它们是协同工作，还是在完全不同的维度产生影响？</li>
</ol>
<p>带着这些问题，我们将拆解这两个“黑盒子”，从大模型的底层生成原理出发，彻底搞懂它们如何掌控 AI 的每一次开口。</p>
<h4 data-id="heading-1">大模型回答的“三步走”流程</h4>
<p>要搞懂这两个参数，必须先看大模型是如何预测下一个字的。本质上，Transformer 的核心任务朴素得像猜谜：<strong>根据上文，预测下一个最有可能出现的词（Token），重复此过程直到生成结束符。</strong></p>
<p>这个过程可以拆解为三个关键步骤：<strong>生成分数 (Logits)</strong> --&gt; <strong>转换概率 (Softmax)</strong>  --&gt;<strong>加权采样 (Sampling)</strong>。</p>
<img src="https://p3.ssl.qhimg.com/d/inn/6ecebc3b945b/resource.png" alt="截屏2025-12-04 11.03.52" loading="lazy"/>
<p><strong>步骤1: 生成分数（<code>Logits</code>）</strong></p>
<p>我们用一个简单例子说明：当用户提问“<strong>帮我推荐一个学习 AI 大模型技术的频道</strong>”时，模型会扫描它词表里成千上万个词，并为每一个词打分。这个分数在 AI 领域被称为 <strong>Logits</strong>。</p>
<p>假设模型打分后，排名前五的词如下：</p>
<ul>
<li>AI：4.2</li>
<li>科技：4.1</li>
<li>奇舞：3.9</li>
<li>自行车：1.8</li>
<li>Hello：1.4</li>
</ul>
<p>打分过程比较复杂，好在跟我们今天的内容关系不大，我们可以暂且忽略。</p>
<blockquote>
<p>需要注意的是，在大模型预测下一个词时，会给它所认识的所有词打分，词的总数量大概是在几万到几十万左右。为了方便理解，我们这里只显示分数最高的前五个，其余的全部省略。</p>
</blockquote>
<p>在大型语言模型（LLM）完成对所有词汇的评分后，下一步的关键在于如何从这些分数中选择最合适的词作为输出。一种直观且常用的方法是选择得分最高的词。</p>
<p>例如，假设模型在预测序列中的下一个词时，对词汇表中的每个词都进行了评分，比如上面例子中的 "AI" 这个词获得了最高分。那么，模型会选择 "AI" 作为当前步骤的输出。</p>
<p>接下来，模型会将 "AI" 这个词添加到输入序列中，并再次进行下一个词的预测。这意味着模型会重新评估词汇表中的每个词，并为它们分配新的分数。同样，模型会选择得分最高的词作为下一个输出。</p>
<p>这个过程会不断重复，模型逐个输出每一个词，并将每个新生成的词添加到输入序列中，以影响后续词的预测。这种迭代式的生成过程会持续进行，直到模型输出一个特殊的结束标识符（例如 ""）为止。结束标识符的出现标志着文本生成的完成。</p>
<p><img src="https://p4.ssl.qhimg.com/d/inn/b5fa6dc9ef61/theory.png" alt="截屏2025-12-08 11.10.08" loading="lazy"/></p>
<p>虽然选择得分最高的词是一种简单直接的解码策略，但它也存在一些局限性：</p>
<ul>
<li><strong>缺乏多样性：</strong> 这种策略倾向于选择最常见的词，导致生成的文本缺乏多样性和创造性。模型可能会陷入重复的模式，生成平淡无奇的内容。</li>
<li><strong>对噪声敏感：</strong> 如果模型在某个步骤中给出了错误的高分，那么这个错误可能会被放大，导致后续生成的文本偏离预期。</li>
<li><strong>忽略上下文：</strong> 虽然模型会将之前生成的词作为输入，但简单地选择最高分可能会忽略更长远的上下文信息，导致生成的文本不连贯或不自然。</li>
</ul>
<p>这样简单的选择分数最高的词显然是不合适的，我们需要给其他词，比如“科技”或“奇舞”一定机会。聪明的你肯定想到了，把这些词的分数转为概率，让模型按照概率来预测下一个词。提到转换概率，这就轮到大名鼎鼎的 <strong>Softmax 函数</strong> 登场了。</p>
<p><strong>步骤2: 转换概率（Softmax函数）</strong></p>
<p><code>Softmax</code> 公式：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Softmax</mtext><mo stretchy="false">(</mo><msub><mi>z</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><msup><mi>e</mi><mrow><msub><mi>z</mi><mi>i</mi></msub><mi mathvariant="normal">/</mi><mi>T</mi></mrow></msup><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msup><mi>e</mi><mrow><msub><mi>z</mi><mi>j</mi></msub><mi mathvariant="normal">/</mi><mi>T</mi></mrow></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{Softmax}(z_i) = \frac{e^{z_i/T}}{\sum_{j=1}^{K} e^{z_j/T}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.872em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.565em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8301em;"><span style="top:-3.0051em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.888em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>解析一下这个函数，它这里面的 <code>z_i</code> 代表的就是第 <code>i</code> 个词的分数，<code>K</code> 代表的是词的总数量，而这个输出值就代表第 <code>i</code> 个词的概率了。这里的 <code>T</code> 就是 <code>Temperature</code>，可以先把 <code>T</code>设置为默认值 <code>T = 1</code>，那么这个公式就变为了：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>Softmax</mtext><mo stretchy="false">(</mo><msub><mi>z</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mfrac><msup><mi>e</mi><msub><mi>z</mi><mi>i</mi></msub></msup><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msup><mi>e</mi><msub><mi>z</mi><mi>j</mi></msub></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{Softmax}(z_i) = \frac{e^{z_i}}{\sum_{j=1}^{K} e^{z_j}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">Softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.6484em;vertical-align:-1.307em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3414em;"><span style="top:-2.1288em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6065em;"><span style="top:-3.0051em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.307em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>还是以上面的词为例，上面五个词的分数为：<code>z_1（AI） = 4.2、z_2（科技）= 4.1、z_3（奇舞）= 3.9、z_4（自行车）= 1.8、z_5（Hello）= 1.4</code>，那么计算 <code>z_1</code>这个词的概率，上面的公式展开为：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub><mo>=</mo><mfrac><msup><mi>e</mi><mn>4.2</mn></msup><mrow><msup><mi>e</mi><mn>4.2</mn></msup><mo>+</mo><msup><mi>e</mi><mn>4.1</mn></msup><mo>+</mo><msup><mi>e</mi><mn>3.9</mn></msup><mo>+</mo><msup><mi>e</mi><mn>1.8</mn></msup><mo>+</mo><msup><mi>e</mi><mn>1.4</mn></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">P_1 = \frac{e^{4.2}}{e^{4.2} + e^{4.1}+e^{3.9}+e^{1.8}+e^{1.4}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.2604em;vertical-align:-0.7693em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4911em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4.2</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4.1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3.9</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1.8</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7401em;"><span style="top:-2.989em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1.4</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4.2</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.7693em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<img src="https://p1.ssl.qhimg.com/d/inn/8022f6754328/formula.png" alt="截屏2025-12-04 21.36.38" loading="lazy"/>
<p><strong>e ≈ 2.718</strong>，大致得到的概率如下：</p>
<ul>
<li><strong>AI</strong>：36%</li>
<li><strong>科技</strong>：32%</li>
<li><strong>奇舞</strong>：26%</li>
<li><strong>自行车</strong>：3%</li>
<li><strong>Hello</strong>：2%</li>
</ul>
<p><code>Softmax</code> 函数会保证所有词的概率相加为100%。</p>
<p><strong>步骤3：加权采样</strong></p>
<p>得到了每个词的概率后，就需要根据概率来生成下一个预测的值。一般称这个通过概率来生成预测值的过程为: <strong>加权采样</strong>。可以用一个从0到100这个区间的横轴来举例。</p>
<p>”AI“这个词的概率为36%，那么在横轴上给它分配0到36这段区间，科技的概率是32%，我们就给它分配随后的长度为32的这段区间，以此类推。</p>
<p><img src="https://p3.ssl.qhimg.com/d/inn/e95dd5159b0f/WechatIMG6955.jpg" alt="WechatIMG6955" loading="lazy"/></p>
<p>然后生成一个0到100的随机数。比如说随机数是8，落到了这个[0,36]这个区间，我们就选择 <code>AI</code>。这个就叫做给每个词分配与概率相等的机会。这意味着，虽然“AI”概率最高，但模型也有机会选择“科技”或“奇舞”。这种机制保证了回答的合理性，同时赋予了 AI 创造力和变化。</p>
<h4 data-id="heading-2">Temperature 对大模型的作用</h4>
<p><img src="https://p1.ssl.qhimg.com/d/inn/d9d7b0cdadfc/resurece_1.png" alt="截屏2025-12-06 15.13.53" loading="lazy"/></p>
<p>在概率转换模块，我们对 <code>Softmax</code> 函数进行了简化，设置了 <code>T(Temperature)</code> 的取值为1，完整版中，所有的 <code>z</code> 值都会先除以 T，再加入到整体的运算过程中。假如调整 T 的值，会发生什么？</p>
<p>我们对比一下 T=0.1（低温）、T=1.0（标准）、T=2.0（高温）时的概率变化：</p>









































<table><thead><tr><th>词</th><th>T=0.1 (低温)</th><th>T=1.0 (中性)</th><th>T=2.0 (高温)</th></tr></thead><tbody><tr><td>AI</td><td>71%</td><td>36%</td><td>30%</td></tr><tr><td>科技</td><td>26%</td><td>32%</td><td>28%</td></tr><tr><td>奇舞</td><td>4%</td><td>26%</td><td>26%</td></tr><tr><td>自行车</td><td>0.0%</td><td>3%</td><td>9%</td></tr><tr><td>Hello</td><td>0.0%</td><td>2%</td><td>7%</td></tr></tbody></table>
<p><strong>核心结论</strong>：</p>
<p><strong>T &lt; 1 (低温状态)：赢家通吃</strong></p>
<ul>
<li><strong>原理</strong>：当 T 很小时（如 0.1），分数被放大（除以小数等于乘以大数）。指数函数 <code>e^x</code> 会急剧放大差异。高分词的优势被无限拔高，低分词的概率被压缩至近乎为 0。</li>
<li><strong>效果</strong>：概率分布变得极度<strong>尖锐</strong>。模型几乎只选第一名，输出极度稳定、保守。</li>
<li><strong>物理比喻</strong>：低温下分子运动缓慢，状态固定（冰）。</li>
<li><strong>适用</strong>：代码生成、数学解题（严谨，不容出错）。</li>
</ul>
<p><strong>T &gt; 1 (高温状态)：众生平等</strong></p>
<ul>
<li><strong>原理</strong>：当 T 很大时（如 2.0），分数被缩小。差异被拉平，指数运算后的结果差别不大。</li>
<li><strong>效果</strong>：概率分布变得<strong>平缓</strong>。高分词优势不再明显，长尾词（如“自行车”）也有了被选中的机会。</li>
<li><strong>物理比喻</strong>：高温下分子运动剧烈，状态混乱且不可预测（沸水）。</li>
<li><strong>适用</strong>：创意写作、头脑风暴（需要惊喜，容忍偏差）。</li>
</ul>
<p>通过上面的计算对比，<strong>一句话总结 Temperature：它控制的是“贫富差距”。低 T 拉大差距，高 T 缩小差距。</strong></p>
<h4 data-id="heading-3">Top P 对大模型的作用</h4>
<p><strong>Top P 并不改变概率本身，而是改变选择的范围</strong>。<code>Top P</code> 作用在上面的采样环节。在加权采样环节，根据每一个词的概率给它们分配了对等的区间，然后生成了一个随机数，随机数落到哪个区间，就输出哪个区间的值，这样回答就会变得多种多样，但是这也埋下了隐患。</p>
<p>虽然"自行车"只有3%的概率，但只要你试的次数足够多，大模型最后还是很有可能输出"自行车"这三个字的。这肯定不是你想要的答案。大模型的词汇表里面有几十万个词，除了头部的几个合理词，后面基本上都是拖着长长的一串低概率的垃圾词。我们管这些词叫做<strong>长尾词</strong>。</p>
<p>比如在上面的例子中："自行车"与 "Hello" 就是长尾词，为了防止模型去选这些长尾词，就需要一个保安, 把这些离谱的选项都拦在门外，这就是 Top P 的作用了。</p>
<p><strong>机制详解：</strong></p>
<p>Top P 的全称为：<strong>Top Cumulative Probability</strong>（最高累加概率），P指的就是一个概率阈值。模型从高分词开始往下累加概率，一旦累加值超过 P，后面的词全部切掉。</p>
<p>假设我们设置 <strong>Top P = 0.9</strong>：</p>
<ol>
<li><strong>AI</strong> (36%) -&gt; 累加 36% (&lt;90%，保留)</li>
<li><strong>科技</strong> (32%) -&gt; 累加 68% (&lt;90%，保留)</li>
<li><strong>奇舞</strong> (26%) -&gt; 累加 94% (<strong>&gt;90%，触发阈值！</strong>) -&gt; <strong>保留“奇舞”，截断后续所有词。</strong></li>
</ol>
<p>结果：“自行车”、“Hello”等长尾词直接被丢弃。剩下的三个词重新归一化概率，然后在它们之间进行采样。</p>
<img src="https://p2.ssl.qhimg.com/d/inn/f0bab89f4759/Wechat.jpg" loading="lazy"/>
<p><strong>核心结论</strong></p>
<p>Top P 就像一个<strong>动态的门槛</strong>。</p>
<ul>
<li><strong>Top P 低 (e.g., 0.1)</strong>：只保留最头部的几个词，极度保守。</li>
<li><strong>Top P 高 (e.g., 0.9)</strong>：允许更多可能性的词进入候选池，保留多样性，同时切除极不靠谱的尾部。</li>
</ul>
<p>所以总结一下：</p>


























<table><thead><tr><th>参数</th><th>低值效果</th><th>高值效果</th><th>适用场景</th><th>与另一参数区别</th></tr></thead><tbody><tr><td>Temperature</td><td>差距放大，赢家通吃，稳定</td><td>差距缩小，均等，多样</td><td>低：代码/数学；高：小说/idea</td><td>全局概率分布</td></tr><tr><td>Top P</td><td>头部窄，切长尾，保守</td><td>门槛宽，兼容，随机</td><td>低：专业Q&amp;A；高：开放讨论</td><td>尾部过滤阈值</td></tr></tbody></table>
<h4 data-id="heading-4">建议</h4>
<ol>
<li><strong>通常只调整其中一个</strong>：虽然可以同时调整，但为了控制变量，主流建议是固定一个（如 Top P = 1），只调另一个。</li>
<li><strong>发散思维场景</strong>（写小说、想点子）：
<ul>
<li><strong>推荐</strong>：设置 <code>0.8 &lt;= T &lt;= 1.2</code> 左右 或 设置 Top P 为 0.9左右。</li>
<li>让模型“发散”一会儿，但别太离谱。</li>
</ul>
</li>
<li><strong>严谨逻辑场景</strong>（写代码、提取数据）：
<ul>
<li><strong>推荐</strong>：设置 <code>0.0 &lt;= T &lt;= 0.2</code>  或  <code>0.1 &lt;= Top P &lt;= 0.2</code> 左右。</li>
<li>确保模型只选概率最高的那个词，保证逻辑的连贯和语法的正确。</li>
</ul>
</li>
</ol>
<p>理解了这两个参数，你就不是在盲目地“炼丹”，而是在精准地调试你的数字引擎。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring监听器（ApplicationEvent）：比MQ更轻的异步神器！]]></title>    <link>https://juejin.cn/post/7605136148592394267</link>    <guid>https://juejin.cn/post/7605136148592394267</guid>    <pubDate>2026-02-11T07:11:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605136148592394267" data-draft-id="7605164560711680026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring监听器（ApplicationEvent）：比MQ更轻的异步神器！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T07:11:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring监听器（ApplicationEvent）：比MQ更轻的异步神器！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:11:09.000Z" title="Wed Feb 11 2026 07:11:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">引言：当咖啡店遭遇程序员</h3>
<blockquote>
<p>“顾客挤爆柜台时，优秀的店长不会催促咖啡师加速，而是启动一套科学的协作机制——<br/>
就像<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D267240109%26content_type%3DArticle%26match_order%3D1%26q%3DSpring%25E4%25BA%258B%25E4%25BB%25B6%25E9%25A9%25B1%25E5%258A%25A8%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=267240109&amp;content_type=Article&amp;match_order=1&amp;q=Spring%E4%BA%8B%E4%BB%B6%E9%A9%B1%E5%8A%A8&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Spring事件驱动</a>，用**<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D267240109%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%258F%2591%25E5%25B8%2583-%25E8%25AE%25A2%25E9%2598%2585%25E6%25A8%25A1%25E5%25BC%258F%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=267240109&amp;content_type=Article&amp;match_order=1&amp;q=%E5%8F%91%E5%B8%83-%E8%AE%A2%E9%98%85%E6%A8%A1%E5%BC%8F&amp;zhida_source=entity" ref="nofollow noopener noreferrer">发布-订阅模式</a>**让系统像顶级咖啡团队般优雅应对洪峰流量”</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、咖啡店里的监听器：3位灵魂角色</h3>
<p><strong>真实战场还原</strong>（每秒1000订单的咖啡店）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dfd00f842a94dc1afdadf5700036f83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398668&amp;x-signature=VpRDGs7r7VU1pms23hN7WDGuhuo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">1. 事件定义：咖啡店的「订单小票」</h3>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ApplicationEvent</span> </span>{
    <span class="hljs-comment">// final修饰的订单ID：就像咖啡师绝不涂改的订单小票</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> orderId;  
    
    <span class="hljs-comment">// 创建时间：记录订单诞生时刻（线程安全不可变）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">LocalDateTime</span> createTime = <span class="hljs-type">LocalDateTime</span>.now(); 

    <span class="hljs-comment">// 无setter：防止多线程并发篡改订单</span>
}
</code></pre>
<h3 data-id="heading-3">2. 事件发布：店长的「广播系统」</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-comment">// 店长的麦克风（构造器注入更优雅）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ApplicationEventPublisher eventPublisher; 

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 核心业务：生成订单（咖啡店接单）</span>
        eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderEvent</span>(<span class="hljs-built_in">this</span>, order.getId())); <span class="hljs-comment">// 📢 广播订单</span>
    }
}
</code></pre>
<h3 data-id="heading-4">3. 事件监听：咖啡团队的「技能响应」</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Component</span>
public class CoffeeMakerListener {
    <span class="hljs-variable">@EventListener</span> 
    <span class="hljs-variable">@Order</span>(<span class="hljs-number">1</span>) <span class="hljs-comment">// 优先级：先做咖啡再推荐甜点</span>
    public void <span class="hljs-built_in">makeCoffee</span>(OrderEvent event) {
        <span class="hljs-comment">// 专注做咖啡，不关心谁结账</span>
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"咖啡师：开始制作订单{}的拿铁..."</span>, event.<span class="hljs-built_in">getOrderId</span>());
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-5">二、扛住亿级流量的3把利器</h3>
<h3 data-id="heading-6">🔥 <strong>场景1：冷启动缓存预加载（防雪崩）</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachePreloader</span> {
    <span class="hljs-comment">// 在Spring容器"开店准备完成"时触发</span>
    <span class="hljs-meta">@EventListener(ContextRefreshedEvent.class)</span> 
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initCache</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 异步加载省时30%（实测数据）</span>
        CompletableFuture.runAsync(() -&gt; {
            provinceService.loadProvincesToCache(); 
            productService.preloadHotProducts();
        });
    }
}
</code></pre>
<h3 data-id="heading-7">💡 <strong>场景2：事务成功后的缓存清理（保一致性）</strong></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 只在数据库提交成功后执行（避免脏清理）</span>
<span class="hljs-meta">@TransactionalEventListener</span>(phase = <span class="hljs-title class_">TransactionPhase</span>.<span class="hljs-property">AFTER_COMMIT</span>)
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">cleanCache</span>(<span class="hljs-params">OrderUpdateEvent event</span>) {
    <span class="hljs-comment">// 异步清理：不阻塞结账队伍</span>
    redisTemplate.<span class="hljs-title function_">executeAsync</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisCallback</span>&lt;&gt;() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-title class_">Void</span> <span class="hljs-title function_">doInRedis</span>(<span class="hljs-params">RedisConnection connection</span>) {
            connection.<span class="hljs-title function_">del</span>((<span class="hljs-string">"order:"</span> + event.<span class="hljs-title function_">getId</span>()).<span class="hljs-title function_">getBytes</span>());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    });
}
</code></pre>
<h3 data-id="heading-8">🚀 <strong>场景3：无侵入式功能扩展</strong></h3>
<p><strong>改造前（臃肿的收银台）</strong> ：</p>
<pre><code class="hljs language-scss" lang="scss">public void <span class="hljs-built_in">pay</span>() {
    paymentService<span class="hljs-selector-class">.pay</span>();   <span class="hljs-comment">// 核心支付</span>
    auditService<span class="hljs-selector-class">.log</span>();     <span class="hljs-comment">// 审计代码入侵</span>
    riskService<span class="hljs-selector-class">.check</span>();    <span class="hljs-comment">// 风控代码耦合</span>
    marketingService<span class="hljs-selector-class">.addPoints</span>(); <span class="hljs-comment">// 新增需求污染核心</span>
}
</code></pre>
<p><strong>事件驱动改造后</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 纯净支付核心（专注收钱）</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">pay</span>(<span class="hljs-params">Long orderId</span>) {
    paymentService.<span class="hljs-title function_">process</span>(orderId);
    eventPublisher.<span class="hljs-title function_">publishEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaymentSuccessEvent</span>(orderId)); <span class="hljs-comment">// 📢 广播支付成功</span>
}

<span class="hljs-comment">// 新增积分模块（无需修改支付代码）</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PointListener</span> {
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">addPoints</span>(<span class="hljs-params">PaymentSuccessEvent event</span>) {
        <span class="hljs-comment">// 积分服务独立演进</span>
        pointService.<span class="hljs-title function_">award</span>(event.<span class="hljs-title function_">getOrderId</span>(), <span class="hljs-number">100</span>); 
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">三、血泪教训：3个深夜加班事故</h3>
<h3 data-id="heading-10">🚫 <strong>事故1：多线程篡改事件（订单混乱）</strong></h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 错误！事件必须是只读的</span>
@EventListener
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handle</span>(<span class="hljs-params">OrderEvent <span class="hljs-keyword">event</span></span>)</span> {
    <span class="hljs-keyword">event</span>.setStatus(<span class="hljs-string">"MODIFIED"</span>); <span class="hljs-comment">// ⚠️ 多线程并发修改引发订单错乱</span>
}
</code></pre>
<blockquote>
<p><strong>正确做法</strong>：事件类设计为final字段 + 无setter</p>
</blockquote>
<h3 data-id="heading-11">🚫 <strong>事故2：异步事件丢失（顾客投诉）</strong></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-meta">@EnableAsync</span> <span class="hljs-comment">// 必须显式开启异步</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-meta">@Bean</span>(<span class="hljs-string">"eventExecutor"</span>) 
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Executor</span> <span class="hljs-title function_">taskExecutor</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 关键参数：拒绝策略用CallerRunsPolicy（避免丢单）</span>
        <span class="hljs-title class_">ThreadPoolTaskExecutor</span> executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
        executor.<span class="hljs-title function_">setRejectedExecutionHandler</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.<span class="hljs-title class_">CallerRunsPolicy</span>());
        <span class="hljs-keyword">return</span> executor;
    }
}

<span class="hljs-comment">// 指定线程池执行</span>
<span class="hljs-meta">@Async</span>(<span class="hljs-string">"eventExecutor"</span>) 
<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">asyncHandle</span>(<span class="hljs-params">OrderEvent event</span>) {...}
</code></pre>
<h3 data-id="heading-12">🚫 <strong>事故3：事件循环调用（咖啡师卡死）</strong></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 错误：在事件处理中发布新事件</span>
<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleA</span>(<span class="hljs-params">EventA a</span>) {
    publisher.<span class="hljs-title function_">publishEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EventB</span>()); 
}

<span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleB</span>(<span class="hljs-params">EventB b</span>) {
    publisher.<span class="hljs-title function_">publishEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">EventA</span>()); <span class="hljs-comment">// ♻️ 死循环！</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-13">四、关键抉择：监听器 vs MQ 架构对垒</h3>



































<table><thead><tr><th>维度</th><th>Spring监听器</th><th>MQ消息队列</th></tr></thead><tbody><tr><td>适用场景</td><td>单机事务协作 ✅</td><td>跨服务通信 ✅</td></tr><tr><td>可靠性</td><td>进程宕机事件消失 ❌</td><td>持久化/重试 ✅</td></tr><tr><td>吞吐量</td><td>内存级传输，10w+/s 🚀</td><td>受网络限制，1w/s ⚠️</td></tr><tr><td>开发效率</td><td>免搭建MQ，注解即用 ✅</td><td>需部署中间件 ❌</td></tr><tr><td>数据一致性</td><td>本地事务保障 ✅</td><td>需分布式事务 ⚠️</td></tr></tbody></table>
<blockquote>
<p><strong>黄金决策树</strong>：<br/>
同JVM事务操作 → Spring监听器（开发效率王炸）<br/>
跨服务最终一致 → <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D267240109%26content_type%3DArticle%26match_order%3D1%26q%3DRocketMQ%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=267240109&amp;content_type=Article&amp;match_order=1&amp;q=RocketMQ&amp;zhida_source=entity" ref="nofollow noopener noreferrer">RocketMQ</a>（可靠性担当）</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">五、性能调优：监听器的涡轮增压</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a85cb1c8bdeb497ab3e4b14d0750168c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398668&amp;x-signature=%2BHQjbpnZkOjLB5Edq7zbCdK4Tnk%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-15">六、最佳实践：5条生存法则</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5847a6a2c4b14d2ab91a8d04fa665f80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398668&amp;x-signature=%2BaI6ZNi45bhAMrtniHeoN%2B%2F0v6w%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a21ac721a9da489a9ea6eb6377c3eb60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398668&amp;x-signature=dW57MkBOc%2BqHAiOjZvQSipC9msY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16">结语：事件驱动的艺术</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/495b2972c6ff43ef97da9e139322332e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We5aWH5bCP5rGk5ZyG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398668&amp;x-signature=HFTBFBQkZjXr6JRe35Es9ZYAtaI%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入浅出的聊下MCP]]></title>    <link>https://juejin.cn/post/7605142381152534591</link>    <guid>https://juejin.cn/post/7605142381152534591</guid>    <pubDate>2026-02-11T07:16:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605142381152534591" data-draft-id="7605142381152485439" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入浅出的聊下MCP"/> <meta itemprop="keywords" content="Cursor,人工智能"/> <meta itemprop="datePublished" content="2026-02-11T07:16:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端的阶梯"/> <meta itemprop="url" content="https://juejin.cn/user/2604076678261512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入浅出的聊下MCP
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2604076678261512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端的阶梯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:16:37.000Z" title="Wed Feb 11 2026 07:16:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、MCP 底层框架全景解读：协议层与传输层如何解耦</h2>
<p>Model Context Protocol（MCP）并不是一个简单的“工具调用协议”，而是一套 面向智能体（Agent）场景的通用通信框架。它通过清晰的分层设计，把「协议语义」与「通信方式」彻底解耦，使同一套 Agent 协议既能跑在本地进程，也能运行在浏览器、微服务乃至实时双向系统中。</p>
<p><strong>1、整体架构：三层解耦设计</strong></p>
<p>从架构上看，MCP 可以清晰拆分为三层：</p>
<p>上层应用层：Agent、Tools、Resources、Prompts 等业务能力</p>
<p>协议层（Protocol Layer）：基于 JSON-RPC 2.0 的会话协议</p>
<p>传输层（Transport Layer）：负责消息在不同通道中的实际传输</p>
<p>这三层的边界非常明确：</p>
<p>协议层只关心「消息语义与会话状态」，</p>
<p>传输层只关心「消息如何收发」，</p>
<p>上层应用完全不需要感知底层通信细节。</p>
<p><strong>2、协议层：把 JSON-RPC 变成“会话协议”</strong></p>
<p>（1）BaseSession：MCP 的通信引擎</p>
<p>协议层的核心是 BaseSession。它并不是简单封装 JSON-RPC，而是解决了 Agent 场景下最关键的几件事：</p>
<ul>
<li>统一请求（Request）、响应（Response）、通知（Notification）模型</li>
<li>自动维护请求–响应的 ID 关联，支持并发调用</li>
<li>屏蔽底层读写流差异（stdio / HTTP / WebSocket）</li>
<li>提供统一的错误与异常处理机制</li>
</ul>
<p>可以理解为：BaseSession 把“字节流通信”升级成了“可靠的会话通信”。</p>
<p>（2）ClientSession 与 ServerSession：角色语义补全</p>
<p>在 BaseSession 之上，MCP 分别为客户端和服务端补齐角色语义：</p>
<p>ClientSession</p>
<ul>
<li>主动发起 <code>initialize</code> 请求</li>
<li>声明自身能力（capabilities）</li>
<li>在握手完成后才能进行正常调用</li>
</ul>
<p>ServerSession</p>
<ul>
<li>内嵌初始化状态机，严格约束交互顺序</li>
<li>校验客户端能力，决定是否允许某些通知或功能</li>
<li>确保协议执行的安全性与一致性</li>
</ul>
<p>这种设计使 MCP 的通信过程具备 明确的生命周期和状态约束，而不是“随便发消息”。</p>
<p><strong>3、标准交互流程：三阶段模型</strong></p>
<p>从通信流程上看，MCP 的完整交互可以抽象为三个阶段：</p>
<p>（1）握手初始化</p>
<p>Client 发送 <code>initialize</code>，双方交换协议版本与能力集，并通过 <code>initialized</code> 确认完成。</p>
<p>（2）正常通信</p>
<p>双方可双向发送 Request–Response（同步调用）或 Notification（异步事件）。</p>
<p>（3）优雅收尾</p>
<p>任意一端可主动关闭会话，或由底层通道断开触发清理。</p>
<p>这一流程确保了 MCP 在复杂 Agent 场景下仍然具备可控的通信秩序。</p>
<p><strong>4、传输层：多形态通信的统一承载</strong></p>
<p>MCP 在传输层提供了多种实现，以适配不同部署与性能需求，但所有传输方式都严格遵循同一套协议层逻辑。</p>
<p>（1）Stdio Transport</p>
<p>基于标准输入/输出的本地进程通信，极其轻量，适合 CLI 工具、编辑器插件和本地 Agent。</p>
<p>（2）HTTP + SSE</p>
<p>通过 HTTP POST 发送消息，SSE 单向推送结果，浏览器友好，适合前后端分离和轻量微服务场景。</p>
<p>（3）Streamable HTTP</p>
<p>在同一路径上混合 POST 与 SSE，支持会话管理、断线重连和流式响应，是更偏生产级的 HTTP 方案。</p>
<p>（4）WebSocket</p>
<p>真正的全双工通道，低延迟、高频交互，适合实时 Agent 与前端嵌入式 Copilot 场景。</p>
<p>可以看到，传输层的差异只影响“怎么连”，不影响“怎么用”。</p>
<p><strong>5、总结：为什么 MCP 适合作为 Agent 通信底座</strong></p>
<p>从整体设计来看，MCP 的核心价值在于：</p>
<ul>
<li>用 JSON-RPC 2.0 构建了有状态、可并发、可扩展的会话协议</li>
<li>通过能力声明与初始化握手，保障交互顺序与安全边界</li>
<li>彻底解耦协议与传输，使 Agent 能在本地、浏览器和生产微服务环境中复用同一通信模型</li>
</ul>
<p>这也是 MCP 能成为 Agent 时代“通用通信底座”的关键原因。</p>
<h2 data-id="heading-1">二、MCP 的三大核心概念：Tools、Resources 与 Prompts</h2>
<p>在 MCP（Model Context Protocol）中，并不是所有能力都通过“工具调用”来完成。为了清晰地划分 谁来控制、谁来决策、谁来执行，MCP 将 Agent 可用的能力抽象为三类核心原语：</p>
<p>Prompt 负责“如何提问”</p>
<p>Resource 负责“提供背景”</p>
<p>Tool 负责“执行操作”</p>
<p>这三者共同构成了 MCP 中 模型、客户端与服务端之间的职责边界。</p>
<p><strong>1、Resources：为模型提供“可控上下文”</strong></p>
<p>资源（Resources） 是 MCP 中用于向 LLM 暴露上下文数据的核心原语之一。</p>
<p>它的本质不是“能力”，而是可被读取的背景信息。</p>
<p>资源可以是任意类型的数据，包括但不限于：</p>
<ul>
<li>文件内容（文档、日志）</li>
<li>数据库记录（结构化数据）</li>
<li>API 响应</li>
<li>实时系统状态</li>
<li>截图、图片、音频、视频等二进制内容</li>
</ul>
<p>（1）资源的核心特征</p>
<p>URI 唯一标识</p>
<p>每个资源都通过 URI 定位，例如：</p>
<p>代码语言：javascript</p>
<hr/>
<p>AI代码解释</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">file:</span>/<span class="hljs-regexp">//home</span><span class="hljs-regexp">/user/docs</span><span class="hljs-regexp">/report.pdfpostgres:/</span><span class="hljs-regexp">/db.example.com/customers</span><span class="hljs-regexp">/schemascreen:/</span><span class="hljs-regexp">/localhost/display</span>
</code></pre>
<p>应用控制（App-controlled）</p>
<p>资源由客户端应用决定：</p>
<ul>
<li>何时暴露</li>
<li>暴露哪些</li>
<li>是否提供给模型作为上下文</li>
</ul>
<p>换句话说：模型不能“主动索取资源”，只能使用 Host 给它的上下文。</p>
<p>（2）静态资源与动态资源</p>
<p>静态资源</p>
<p>URI 在服务提供时已明确，例如某个日志文件、固定路径文档。</p>
<p>动态资源</p>
<p>通过 URI Template（RFC 6570）定义，资源内容随参数变化：</p>
<p>代码语言：javascript</p>
<hr/>
<p>AI代码解释</p>
<pre><code class="hljs language-ini" lang="ini">logs://recent?<span class="hljs-attr">timeframe</span>={duration}
</code></pre>
<p>客户端只需填充参数即可构造具体资源 URI。</p>
<p>（3）资源能力声明（Capabilities）</p>
<p>支持资源的 MCP Server 需要在初始化阶段声明能力，例如：</p>
<p>代码语言：javascript</p>
<hr/>
<p>AI代码解释</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"subscribe"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<p><code>subscribe</code>：是否支持订阅单个资源的变更</p>
<p><code>listChanged</code>：资源列表变化时是否主动通知客户端</p>
<p>（4）资源的设计定位</p>
<p>资源的设计目标是：</p>
<p>为模型提供“事实背景”，而不是“执行能力”</p>
<p>如果你希望服务端主动驱动模型行为，那么应该使用 Tools，而不是 Resources。</p>
<p><strong>2、Tools：模型可控的“执行能力”</strong></p>
<p>工具（Tools） 是 MCP 中唯一允许模型直接触发“动作”的原语。</p>
<p>与资源不同，工具不是被读取，而是被 调用（call）。</p>
<p>（1）Tool 的核心定位</p>
<p>模型控制（Model-controlled）用于执行：</p>
<p>API 调用</p>
<ul>
<li>数据更新</li>
<li>查询、计算</li>
<li>外部系统操作</li>
</ul>
<p>但需要注意：</p>
<p>模型只是“决定是否调用工具”，真正的调用由客户端完成。</p>
<p>这正是 MCP 所强调的：</p>
<p>模型主控，客户端驱动（Model decides, Client executes）</p>
<p>（2）Tool 的定义结构</p>
<p>每个工具包含以下信息：</p>
<ul>
<li><code>name：唯一标识</code></li>
<li><code>description：功能说明</code></li>
<li><code>inputSchema：参数结构（JSON Schema）</code></li>
<li><code>annotations（可选）：行为说明</code></li>
</ul>
<p>（3）Tool 的调用机制</p>
<p>在 MCP 中：</p>
<ul>
<li>列出工具：<code>tools/list</code></li>
<li>调用工具：<code>tools/call</code></li>
<li>返回结果：标准 JSON-RPC 响应</li>
</ul>
<p>整个过程完全协议化、可审计、可拦截。</p>
<p><strong>3、Prompts：标准化的“提问模板”</strong></p>
<p>在 MCP 中，Prompt 是继 Resources 和 Tools 之后的第三个核心原语，但它关注的不是数据，也不是执行，而是——</p>
<p>如何把用户意图组织成“模型更容易理解和执行”的输入结构</p>
<p>Prompt 本质上是由 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fproduct%2Fcvm%3Ffrom_column%3D20065%26from%3D20065" target="_blank" title="https://cloud.tencent.com/product/cvm?from_column=20065&amp;from=20065" ref="nofollow noopener noreferrer">服务器</a>端预先定义的一组可复用对话模板与交互流程。</p>
<p>（1）Prompt 的设计理念</p>
<p>用户控制（User-controlled）</p>
<p>Prompt 必须由用户或 UI 显式选择触发</p>
<p>协议不绑定交互方式</p>
<p>可以是 Slash 命令、菜单、按钮或表单</p>
<p>强调结构化而非自由发挥</p>
<hr/>
<p>（2）Prompt 的核心能力</p>
<p>参数化：支持动态输入（如时间范围、语言、主题）</p>
<p>资源整合：可嵌入资源作为上下文</p>
<p>多轮交互：适合诊断、教学、引导式任务</p>
<p>统一发现：通过 <code>prompts/list</code>、<code>prompts/get</code> 统一管理</p>
<p>UI 友好：天然适合产品化封装</p>
<p>典型 Prompt 定义结构如下：</p>
<p>代码语言：javascript</p>
<hr/>
<p>AI代码解释</p>
<pre><code class="hljs language-css" lang="css">{  name: string;  description: string;  arguments: [    {      name: string;      description: string;      required: boolean;    }  ];}
</code></pre>
<p>（3）一个典型应用场景</p>
<p>例如在教学或企业知识场景中：</p>
<ul>
<li>教学设计者在 MCP Server 中预置 Prompt 模板</li>
<li>教师通过自然语言或菜单选择 Prompt</li>
<li>系统自动填参并引导多轮对话</li>
<li>即使非技术用户，也能“调动”智能体完成复杂任务</li>
</ul>
<p>Prompt 解决的是 “经验如何被标准化复用” 的问题。</p>
<p><strong>4、三大原语的角色分工</strong></p>
<p>最后，用三句话总结 MCP 的核心原语设计：</p>
<p>Prompt 关注 “如何提问”，让复杂任务变得可复用、可引导</p>
<p>Resource 提供 “背景事实”，让模型有上下文可依</p>
<p>Tool 承担 “执行动作”，让模型真正影响外部世界</p>
<p>这三者共同构成了 MCP 中 安全、可控、可产品化的 Agent 能力体系。</p>
<h2 data-id="heading-2">三、MCP三个核心概念实战演示</h2>
<p>以下是github上大拿编写的测试Demo，代码是claude code用javascripts写的，有兴趣可以看下。代码仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwangjoey2012-sudo%2Fmcp-demos" target="_blank" title="https://github.com/wangjoey2012-sudo/mcp-demos" ref="nofollow noopener noreferrer">github.com/wangjoey201…</a></p>
<p><strong>1、Tools</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82faaca76a8a4c6689c981a97db1df24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv55qE6Zi25qKv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398997&amp;x-signature=PpQmiLUrAARfdofincpI4q%2FOFZY%3D" alt="" loading="lazy"/></p>
<p><strong>2、Resources</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a1adaa4d3364ebd94660c5fad3ba61e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv55qE6Zi25qKv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398997&amp;x-signature=OT6SvjbcA%2Bxcq8oB%2BadLGiP1mZA%3D" alt="" loading="lazy"/></p>
<p><strong>3、Prompts</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01db62c23eea4cec8465e7fcdf9472dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv55qE6Zi25qKv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398997&amp;x-signature=xUdhJXk4MBXG%2BpQipYMTc2izV7s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">四、结语</h2>
<p>本文深入浅出的介绍了MCP底层实现的一些框架及协议，希望对大家了解mcp有帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一看就懂的 Haskell 教程 - 类型类]]></title>    <link>https://juejin.cn/post/7605145921617559604</link>    <guid>https://juejin.cn/post/7605145921617559604</guid>    <pubDate>2026-02-11T06:58:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605145921617559604" data-draft-id="7604574877035986987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一看就懂的 Haskell 教程 - 类型类"/> <meta itemprop="keywords" content="Haskell"/> <meta itemprop="datePublished" content="2026-02-11T06:58:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Anita_Sun"/> <meta itemprop="url" content="https://juejin.cn/user/1811635884786839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一看就懂的 Haskell 教程 - 类型类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1811635884786839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Anita_Sun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:58:58.000Z" title="Wed Feb 11 2026 06:58:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>类型类是Haskell最具辨识度的设计，核心是<strong>把“行为”和“数据”彻底分开</strong>——先定义“能做什么”（行为规则），再给任意类型（内置/自定义）绑定“具体怎么做”（行为实现），完全摆脱面向对象继承的束缚，实现极致灵活的多态。</p>
<h2 data-id="heading-0">一、为什么Haskell需要类型类？——摆脱OOP继承的坑</h2>
<p>Haskell设计类型类的根本目的，是解决面向对象（OOP）继承体系的三大核心问题，让“行为扩展”更灵活。</p>
<h3 data-id="heading-1">1. OOP继承的3个致命问题</h3>
<p>OOP把“行为（方法）”绑死在“数据（类）”上，导致：</p>
<ul>
<li><strong>改不了内置类型</strong>：比如Java想给<code>int</code>加个自定义打印方法，根本改不了<code>int</code>的源码；</li>
<li><strong>类越写越多</strong>：想给“数字”加“负数判断”，得新建<code>NegativeInt</code>、<code>NegativeFloat</code>等子类，类爆炸；</li>
<li><strong>代码重复</strong>：<code>Int</code>和<code>Double</code>都要实现“加法”，得在两个类里各写一遍，没法复用。</li>
</ul>
<h3 data-id="heading-2">2. 类型类的核心思路：先定行为，再绑类型</h3>
<p>类型类反其道而行之，核心是“<strong>行为和数据解耦</strong>”：</p>
<ol>
<li>抽离通用行为：把“能相加”“能打印”“能比较”这类行为做成独立的“规则手册”（类型类）；</li>
<li>灵活绑定类型：给任意类型（比如内置的<code>Int</code>、你写的<code>User</code>）绑定这个规则，不用改类型源码；</li>
<li>无层级束缚：一个类型能绑定多个行为，一个行为能适配多个类型，没有继承的“父子关系”。</li>
</ol>
<h3 data-id="heading-3">3. 类型类≠OOP接口（核心区别）</h3>
<p>很多人会把类型类和接口混淆，其实二者设计逻辑完全不同：</p>






























<table><thead><tr><th>对比维度</th><th>Haskell类型类</th><th>OOP接口</th></tr></thead><tbody><tr><td>核心逻辑</td><td>行为“贴”到任意类型上（无需改类型）</td><td>行为必须由子类继承实现（改不了父类）</td></tr><tr><td>内置类型支持</td><td>直接给<code>Int</code>/<code>String</code>加行为，不用改源码</td><td>必须新建子类（如<code>MyString</code>）才能加行为</td></tr><tr><td>默认实现</td><td>原生支持（写一次，所有类型可复用）</td><td>部分支持（如Java 8后才加默认方法）</td></tr><tr><td>多参数支持</td><td>支持（需解决歧义）</td><td>无原生多参数接口设计</td></tr></tbody></table>
<p><strong>举个直观例子</strong>：</p>
<p>想让字符串能比较大小，OOP要写<code>ComparableString</code>子类并实现接口；Haskell直接给原生<code>String</code>绑定“可比较”行为就行，一步到位。</p>
<h2 data-id="heading-4">二、类型类的3个核心环节：定义→实现→使用</h2>
<p>类型类的使用就三步，每一步都围绕“行为抽象”展开，逻辑清晰且灵活。</p>
<h3 data-id="heading-5">1. 第一步：定义类型类——写“行为规则手册”</h3>
<p>类型类定义是“只说要做什么，不说怎么做”的接口声明，用<code>class</code>关键字实现。</p>
<h4 data-id="heading-6">（1）基础定义：核心方法+默认方法</h4>
<pre><code class="hljs language-rust" lang="rust">-- 定义“可打印”规则手册：a代表任意能实现该行为的类型
class Printable a <span class="hljs-keyword">where</span>
  -- 核心方法：无默认实现，必须由类型实现
  printVal :: a <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">IO</span> ()
  
  -- 辅助方法：带默认实现，可复用也可重写
  printWithPrefix :: <span class="hljs-type">String</span> <span class="hljs-punctuation">-&gt;</span> a <span class="hljs-punctuation">-&gt;</span> <span class="hljs-title function_ invoke__">IO</span> ()
  -- 默认逻辑：加前缀后调用核心方法printVal
  printWithPrefix prefix x = <span class="hljs-keyword">do</span>
    putStr prefix
    printVal x
</code></pre>
<ul>
<li><strong>类型变量（a）</strong> ：代表“所有能遵守这个规则的类型”，是多态的核心；</li>
<li><strong>方法签名</strong>：只声明输入输出（比如<code>printVal</code>是“把a类型的值打印出来”），不写具体代码；</li>
<li><strong>默认方法</strong>：避免重复代码——实例只需实现核心方法，就能自动拥有辅助方法的能力。</li>
</ul>
<h4 data-id="heading-7">（2）进阶：解决多参数类型类的“歧义问题”</h4>
<p>有些行为涉及两种类型（比如“把a类型转成b类型”），需要多参数类型类，但会导致编译器“分不清推导方向”，Haskell提供两种解决方案：</p>
<h5 data-id="heading-8">问题场景：编译器不知道目标类型</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 定义“类型转换”规则手册：a=源类型，b=目标类型</span>
class <span class="hljs-keyword">Convert</span> a b <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">convert</span> :: a <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> b

<span class="hljs-comment">-- 实例1：Int转String</span>
instance <span class="hljs-keyword">Convert</span> <span class="hljs-type">Int</span> String <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">convert</span> n <span class="hljs-operator">=</span> "数字：" <span class="hljs-operator">+</span><span class="hljs-operator">+</span> <span class="hljs-keyword">show</span> n

<span class="hljs-comment">-- 实例2：Int转Bool</span>
instance <span class="hljs-keyword">Convert</span> <span class="hljs-type">Int</span> Bool <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">convert</span> <span class="hljs-number">0</span> <span class="hljs-operator">=</span> <span class="hljs-literal">False</span>
  <span class="hljs-keyword">convert</span> _ <span class="hljs-operator">=</span> <span class="hljs-literal">True</span>

<span class="hljs-comment">-- 调用时编译器蒙圈：只知道a=Int，不知道b是String还是Bool</span>
<span class="hljs-comment">-- test = convert 123  -- 直接报错：类型歧义</span>
</code></pre>
<h5 data-id="heading-9">解决方案1：函数依赖——告诉编译器“谁决定谁”</h5>
<pre><code class="hljs language-sql" lang="sql">{<span class="hljs-operator">-</span># <span class="hljs-keyword">LANGUAGE</span> FunctionalDependencies #<span class="hljs-operator">-</span>} <span class="hljs-comment">-- 启用扩展（必须加）</span>

<span class="hljs-comment">-- 关键：| a -&gt; b 声明“源类型a唯一决定目标类型b”</span>
class <span class="hljs-keyword">Convert</span> a b <span class="hljs-operator">|</span> a <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> b <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">convert</span> :: a <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> b

<span class="hljs-comment">-- 合法实例：Int只能对应String（符合a-&gt;b约束）</span>
instance <span class="hljs-keyword">Convert</span> <span class="hljs-type">Int</span> String <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">convert</span> n <span class="hljs-operator">=</span> "数字：" <span class="hljs-operator">+</span><span class="hljs-operator">+</span> <span class="hljs-keyword">show</span> n

<span class="hljs-comment">-- ❌ 报错：同一个a不能对应多个b（Int不能既转String又转Bool）</span>
<span class="hljs-comment">-- instance Convert Int Bool where ...</span>

<span class="hljs-comment">-- ✅ 正常调用：编译器知道a=Int，就能确定b=String</span>
test1 :: String
test1 <span class="hljs-operator">=</span> <span class="hljs-keyword">convert</span> <span class="hljs-number">123</span>  <span class="hljs-comment">-- 输出："数字：123"</span>
</code></pre>
<h5 data-id="heading-10">解决方案2：关联类型——给源类型绑定“专属目标类型”</h5>
<pre><code class="hljs language-sql" lang="sql">{<span class="hljs-operator">-</span># <span class="hljs-keyword">LANGUAGE</span> TypeFamilies #<span class="hljs-operator">-</span>} <span class="hljs-comment">-- 启用扩展（必须加）</span>

<span class="hljs-comment">-- 类型类只有一个参数a，目标类型变成a的“附属品”</span>
class <span class="hljs-keyword">Convert</span> a <span class="hljs-keyword">where</span>
  <span class="hljs-comment">-- 核心：为每个a定义唯一的TargetType（关联类型）</span>
  type TargetType a  
  <span class="hljs-comment">-- 输出类型固定为a的TargetType，无歧义</span>
  <span class="hljs-keyword">convert</span> :: a <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> TargetType a

<span class="hljs-comment">-- 实例：Int的专属目标类型是String</span>
instance <span class="hljs-keyword">Convert</span> <span class="hljs-type">Int</span> <span class="hljs-keyword">where</span>
  type TargetType <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> String
  <span class="hljs-keyword">convert</span> n <span class="hljs-operator">=</span> "数字：" <span class="hljs-operator">+</span><span class="hljs-operator">+</span> <span class="hljs-keyword">show</span> n

<span class="hljs-comment">-- ✅ 正常调用：两种写法都可行</span>
test2 :: TargetType <span class="hljs-type">Int</span>  <span class="hljs-comment">-- 等价于 String</span>
test2 <span class="hljs-operator">=</span> <span class="hljs-keyword">convert</span> <span class="hljs-number">123</span>

test3 :: String
test3 <span class="hljs-operator">=</span> <span class="hljs-keyword">convert</span> <span class="hljs-number">123</span>
</code></pre>
<h3 data-id="heading-11">2. 第二步：实现实例——给类型“绑定行为”</h3>
<p>实例（Instance）是类型类的“具体实现”，用<code>instance</code>关键字把“规则手册”落地到具体类型上。</p>
<h4 data-id="heading-12">（1）基础实例：给单个类型绑定行为</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 给Int实现Printable：只实现核心方法，复用默认辅助方法</span>
instance Printable <span class="hljs-type">Int</span> <span class="hljs-keyword">where</span>
  printVal n <span class="hljs-operator">=</span> putStrLn $ "整数：" <span class="hljs-operator">+</span><span class="hljs-operator">+</span> <span class="hljs-keyword">show</span> n

<span class="hljs-comment">-- 给String实现Printable：重写辅助方法，定制逻辑</span>
instance Printable String <span class="hljs-keyword">where</span>
  printVal s <span class="hljs-operator">=</span> putStrLn $ "字符串：" <span class="hljs-operator">+</span><span class="hljs-operator">+</span> s
  <span class="hljs-comment">-- 重写前缀方法：自定义格式</span>
  printWithPrefix prefix s <span class="hljs-operator">=</span> putStrLn $ prefix <span class="hljs-operator">+</span><span class="hljs-operator">+</span> " | " <span class="hljs-operator">+</span><span class="hljs-operator">+</span> s
</code></pre>
<ul>
<li>必须实现：类型类中无默认的核心方法（如<code>printVal</code>）；</li>
<li>可选实现：有默认的辅助方法（如<code>printWithPrefix</code>），需定制才重写。</li>
</ul>
<h4 data-id="heading-13">（2）条件实例：泛型类型的“条件绑定”</h4>
<p>想让列表、<code>Maybe</code>这类泛型类型实现行为，可加“条件约束”——只有满足条件的泛型类型才生效：</p>
<pre><code class="hljs language-ini" lang="ini">-- 约束：只有列表里的元素a能打印，整个列表才能打印
instance Printable <span class="hljs-attr">a</span> =&gt; Printable [a] where
  printVal <span class="hljs-attr">xs</span> = mapM_ printVal xs  -- 遍历列表，逐个打印元素

-- ✅ 合法：Int能打印，所以<span class="hljs-section">[Int]</span>能打印
printVal <span class="hljs-section">[1,2,3]</span>
-- ❌ 报错：Bool没实现Printable，所以<span class="hljs-section">[Bool]</span>不能打印
-- printVal <span class="hljs-section">[True, False]</span>
</code></pre>
<h4 data-id="heading-14">（3）通用/特化实例：覆盖不同场景</h4>
<ul>
<li>
<p><strong>通用实例</strong>：适配所有满足约束的泛型类型（如所有<code>Show a</code>的<code>Maybe a</code>）；</p>
<ul>
<li>
<pre><code class="hljs language-sql" lang="sql">instance <span class="hljs-keyword">Show</span> a <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Show</span> (Maybe a) <span class="hljs-keyword">where</span>
  <span class="hljs-keyword">show</span> Nothing <span class="hljs-operator">=</span> "Nothing"
  <span class="hljs-keyword">show</span> (Just x) <span class="hljs-operator">=</span> "Just " <span class="hljs-operator">+</span><span class="hljs-operator">+</span> <span class="hljs-keyword">show</span> x
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>特化实例</strong>：为具体类型定制逻辑（需启用<code>OverlappingInstances</code>扩展），优先级高于通用实例；</p>
<ul>
<li>
<pre><code class="hljs language-ini" lang="ini">{-<span class="hljs-comment"># LANGUAGE OverlappingInstances #-}</span>
-- 只为<span class="hljs-section">[Int]</span>定制打印逻辑，覆盖通用的<span class="hljs-section">[a]</span>实例
instance Printable <span class="hljs-section">[Int]</span> where
  printVal <span class="hljs-attr">xs</span> = putStrLn $ <span class="hljs-string">"整数列表："</span> ++ show xs
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-15">3. 第三步：使用约束——限制函数“只认有行为的类型”</h3>
<p>用<code>=&gt;</code>给函数加约束，确保传入的类型“有对应的行为资格”，编译期就能校验合法性。</p>
<h4 data-id="heading-16">（1）基础约束：单个/多个约束</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">--</span> 单个约束：<span class="hljs-selector-tag">a</span>必须能打印，才能调用这个函数
<span class="hljs-selector-tag">printAll</span> :: <span class="hljs-selector-tag">Printable</span> <span class="hljs-selector-tag">a</span> =&gt; <span class="hljs-selector-attr">[a]</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">IO</span> ()
<span class="hljs-selector-tag">printAll</span> <span class="hljs-selector-tag">xs</span> = <span class="hljs-selector-tag">mapM_</span> <span class="hljs-selector-tag">printVal</span> <span class="hljs-selector-tag">xs</span>

<span class="hljs-selector-tag">--</span> 多个约束：<span class="hljs-selector-tag">a</span>既要能做数值运算，又要能打印
<span class="hljs-selector-tag">calcAndPrint</span> :: (Num a, Printable a) =&gt; <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">IO</span> ()
<span class="hljs-selector-tag">calcAndPrint</span> <span class="hljs-selector-tag">x</span> <span class="hljs-selector-tag">y</span> = <span class="hljs-selector-tag">printVal</span> (x + y)

<span class="hljs-selector-tag">--</span> ✅ 合法调用：<span class="hljs-selector-tag">Int</span>同时满足<span class="hljs-selector-tag">Num</span>和<span class="hljs-selector-tag">Printable</span>
<span class="hljs-selector-tag">calcAndPrint</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span>
<span class="hljs-selector-tag">--</span> ❌ 报错：<span class="hljs-selector-tag">String</span>满足<span class="hljs-selector-tag">Printable</span>但不满足<span class="hljs-selector-tag">Num</span>
<span class="hljs-selector-tag">--</span> <span class="hljs-selector-tag">calcAndPrint</span> "<span class="hljs-selector-tag">a</span>" "<span class="hljs-selector-tag">b</span>"
</code></pre>
<h4 data-id="heading-17">（2）约束的继承传递</h4>
<p>如果类型类B继承自类型类A，那么<code>B a</code>会自动包含<code>A a</code>的约束：</p>
<pre><code class="hljs language-rust" lang="rust">-- <span class="hljs-built_in">Ord</span>继承<span class="hljs-built_in">Eq</span>，所以<span class="hljs-built_in">Ord</span> a 等价于 (<span class="hljs-built_in">Ord</span> a, <span class="hljs-built_in">Eq</span> a)
compareAndCheck :: <span class="hljs-built_in">Ord</span> a =&gt; a <span class="hljs-punctuation">-&gt;</span> a <span class="hljs-punctuation">-&gt;</span> Bool
compareAndCheck x y = x &gt; y &amp;&amp; x /= y  -- 同时用<span class="hljs-built_in">Ord</span>的&gt;和<span class="hljs-built_in">Eq</span>的/=
</code></pre>
<h2 data-id="heading-18">三、类型类的避坑指南+最佳实践</h2>
<p>类型类虽灵活，但用不好会导致代码难维护，记住这些“避坑点”和“黄金法则”。</p>
<h3 data-id="heading-19">1. 常见陷阱（别踩！）</h3>
<ul>
<li><strong>孤儿实例</strong>：类型类和类型不在同一个模块（比如在A模块给B模块的<code>User</code>实现C模块的<code>Show</code>）→ 易冲突、难追踪；</li>
<li><strong>重叠实例</strong>：多个实例能匹配同一个类型（比如<code>[a]</code>和<code>[Int]</code>都实现<code>Printable</code>）→ 编译器不知道用哪个；</li>
<li><strong>默认方法误用</strong>：默认方法依赖未实现的方法（比如<code>methodA</code>默认用<code>methodB</code>，但实例只写了<code>methodA</code>）→ 调用时报错。</li>
</ul>
<h3 data-id="heading-20">2. 最佳实践（记这3条就够）</h3>
<ul>
<li><strong>接口要“单一”</strong> ：一个类型类只管一类行为（比如<code>Printable</code>只负责打印，别加计算逻辑）；</li>
<li><strong>实现要“最小”</strong> ：只实现类型类的核心方法，默认方法能复用就复用，别重复写；</li>
<li><strong>别过度抽象</strong>：只有多个类型需要复用同一行为时，才写类型类；优先用标准库的<code>Num</code>/<code>Eq</code>等，别重复造轮子。</li>
</ul>
<h2 data-id="heading-21">总结</h2>
<ol>
<li>类型类的核心是<strong>行为抽象优于数据抽象</strong>：先定“能做什么”（规则），再给任意类型绑定“具体怎么做”（实现），解耦行为和数据；</li>
<li>核心使用流程：定义类型类（规则手册）→ 实现实例（绑定行为）→ 使用约束（校验资格），三者协同实现灵活多态；</li>
<li>标准库核心类型类（Num/Eq/Ord/Functor）覆盖大部分场景，优先直接使用；</li>
<li>避坑关键：避开孤儿实例、重叠实例，遵循“单一职责、最小实现、不过度抽象”的原则。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OHOS Ace_engine 节点核心类型： UINode]]></title>    <link>https://juejin.cn/post/7605106957134151714</link>    <guid>https://juejin.cn/post/7605106957134151714</guid>    <pubDate>2026-02-11T06:59:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605106957134151714" data-draft-id="7605145921617526836" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OHOS Ace_engine 节点核心类型： UINode"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2026-02-11T06:59:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WeNTaO"/> <meta itemprop="url" content="https://juejin.cn/user/1839932880978572"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OHOS Ace_engine 节点核心类型： UINode
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1839932880978572/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WeNTaO
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:59:52.000Z" title="Wed Feb 11 2026 06:59:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p><code>UINode</code> 是 ACE Engine (ArkUI) 中组件树的基础节点类。它定义了组件树的基本结构（父子关系）和生命周期管理，但<strong>不包含</strong>布局（Layout）和渲染（Render）逻辑（这些由子类 <code>FrameNode</code> 负责）</p>
<ul>
<li>源码位置：
sources/arkui_ace_engine/frameworks/core/components_ng/base/ui_node.h`</li>
<li>继承关系：
<code>AceType</code> -&gt; <code>UINode</code></li>
<li>核心职责：
<ul>
<li>树结构管理**：维护父子节点关系 (<code>AddChild</code>, <code>RemoveChild</code>, <code>parent_</code>, <code>children_</code>)。</li>
<li><strong>生命周期</strong>：挂载/卸载 (<code>AttachToMainTree</code>, <code>DetachFromMainTree</code>)。</li>
<li><strong>上下文关联</strong>：持有 <code>PipelineContext</code>，连接到渲染管线。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">类图</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class AceType {
        &lt;&lt;abstract&gt;&gt;
        +GetTypeName()
        +InstanceOf()
        +DynamicCast()
    }
    
    class UINode {
        &lt;&lt;核心基类&gt;&gt;
        #children_: list~RefPtr~UINode~~
        #parent_: WeakPtr~UINode~
        #context_: PipelineContext*
        #nodeId_: int32_t
        #tag_: string
        
        +AddChild(child, slot)
        +RemoveChild(child)
        +MountToParent(parent, slot)
        +GetParent() RefPtr~UINode~
        +GetChildren() list~RefPtr~UINode~~
        
        +TouchTest(...) HitTestResult
        +MouseTest(...) HitTestResult
        +AxisTest(...) HitTestResult
        
        +MarkDirtyNode(flag)
        +UpdateLayoutPropertyFlag()
        +CreateLayoutWrapper() RefPtr~LayoutWrapperNode~
        
        +AttachContext(context)
        +DetachContext()
        +OnAttachToMainTree()
        +OnDetachFromMainTree()
        
        +GetContext() PipelineContext*
        +GetId() int32_t
        +GetTag() string
    }
    
    class LayoutWrapper {
        &lt;&lt;布局包装器&gt;&gt;
        +Measure()
        +Layout()
    }
    
    class FrameNode {
        &lt;&lt;实际渲染节点&gt;&gt;
        +pattern_: RefPtr~Pattern~
        +layoutProperty_: RefPtr~LayoutProperty~
        +renderContext_: RefPtr~RenderContext~
        +eventHub_: RefPtr~EventHub~
        
        +GetPattern() RefPtr~Pattern~
        +GetLayoutProperty() RefPtr~LayoutProperty~
        +GetRenderContext() RefPtr~RenderContext~
    }
    
    class GroupNode {
        &lt;&lt;组合节点&gt;&gt;
        +AddChildToGroup(child, slot)
        +DeleteChildFromGroup(slot)
    }
    
    class ForEachNode {
        &lt;&lt;语法节点：循环&gt;&gt;
        +CompareAndUpdateChildren()
        +FlushUpdateAndMarkDirty()
    }
    
    class IfElseNode {
        &lt;&lt;语法节点：条件&gt;&gt;
        +UpdateCondition()
    }
    
    class WithThemeNode {
        &lt;&lt;语法节点：主题&gt;&gt;
        +ApplyTheme()
    }
    
    class PipelineContext {
        &lt;&lt;渲染上下文&gt;&gt;
        +GetRootNode() RefPtr~UINode~
        +FlushPipeline()
    }
    
    class LayoutWrapperNode {
        &lt;&lt;布局包装节点&gt;&gt;
        +Measure()
        +Layout()
    }
    
    class FocusHub {
        &lt;&lt;焦点管理&gt;&gt;
        +RequestFocus()
        +LostFocus()
    }
    
    AceType &lt;|-- UINode : virtual继承
    UINode &lt;|-- FrameNode : 继承
    UINode &lt;|-- ForEachNode : 继承
    UINode &lt;|-- IfElseNode : 继承
    UINode &lt;|-- WithThemeNode : 继承
    FrameNode &lt;|-- GroupNode : 继承
    FrameNode --|&gt; LayoutWrapper : 多重继承
    
    UINode --&gt; PipelineContext : 关联
    UINode --&gt; LayoutWrapperNode : 创建
    FrameNode --&gt; FocusHub : 包含
    UINode "1" *-- "0..*" UINode : children
    UINode "0..1" &lt;-- "1" UINode : parent
</code></pre>
<ul>
<li>层次类型：
第一层：基础类型层</li>
</ul>
<ul>
<li><code>AceType</code>：类型系统基类，提供 RTTI 和智能指针支持</li>
</ul>
<p>第二层：节点基类层</p>
<ul>
<li><code>UINode</code>：节点树管理、事件分发、生命周期</li>
</ul>
<p>第三层：具体节点层</p>
<ul>
<li><code>FrameNode</code>：实际渲染节点，包含 Pattern、LayoutProperty、RenderContext</li>
<li><code>SyntaxNode</code> 系列：语法控制节点（ForEach、IfElse、WithTheme 等）</li>
</ul>
<p>第四层：特殊节点层</p>
<ul>
<li><code>GroupNode</code>：组合节点，用于特殊布局场景</li>
</ul>
<h3 data-id="heading-2">关键设计模式</h3>
<ol>
<li><strong>组合模式</strong>：<code>UINode</code> 通过 <code>children_</code> 管理子节点，形成树结构</li>
<li><strong>模板方法</strong>：<code>UINode</code> 定义骨架，子类实现具体行为（如 <code>IsAtomicNode()</code>）</li>
<li><strong>观察者模式</strong>：通过 <code>PipelineContext</code> 管理节点生命周期</li>
<li><strong>策略模式</strong>：<code>Pattern</code> 决定 <code>FrameNode</code> 的行为</li>
</ol>
<h2 data-id="heading-3">3. 核心成员变量</h2>








































<table><thead><tr><th align="left">变量名</th><th align="left">类型</th><th align="left">作用</th></tr></thead><tbody><tr><td align="left"><code>children_</code></td><td align="left"><code>std::list&lt;RefPtr&lt;UINode&gt;&gt;</code></td><td align="left">存储子节点列表。使用链表是为了高效插入和删除。</td></tr><tr><td align="left"><code>parent_</code></td><td align="left"><code>WeakPtr&lt;UINode&gt;</code></td><td align="left">指向父节点。使用<code>WeakPtr</code> 防止循环引用（父-&gt;子，子-&gt;父）。</td></tr><tr><td align="left"><code>context_</code></td><td align="left"><code>PipelineContext*</code></td><td align="left">指向管线上下文，用于访问全局服务（如主题、任务队列）。</td></tr><tr><td align="left"><code>tag_</code></td><td align="left"><code>std::string</code></td><td align="left">组件标签（如 "Column", "Button"）。</td></tr><tr><td align="left"><code>nodeId_</code></td><td align="left"><code>int32_t</code></td><td align="left">全局唯一的节点 ID。</td></tr><tr><td align="left"><code>onMainTree_</code></td><td align="left"><code>bool</code></td><td align="left">标记节点</td></tr></tbody></table>
<h2 data-id="heading-4">4. 核心机制</h2>
<h3 data-id="heading-5">4.1 树操作</h3>
<p>这里我们可以把<code>UINode</code>理解为前端的<code>DOM</code>节点， 提供了相应的API：</p>
<ul>
<li><code>AddChild(child)</code>: 添加子节点。</li>
<li><code>RemoveChild(child)</code>: 移除子节点。</li>
<li><code>MountToParent(parent)</code>: 将自己挂载到指定父节点。</li>
</ul>
<h3 data-id="heading-6">4.2 语法节点 &amp; 渲染节点</h3>
<p>类似前端操作的<code>visibility</code>操作， 很多时候我们需要依据逻辑来控制组件是否显示。 ohos提供了相应的
<code>if/else</code>语义能力（同时， foreach、lazyForeach ）。 为了从底层支持这个能力， UINode 被拆分为两种：</p>
<ul>
<li><strong>FrameNode</strong>：实体节点，有布局和渲染能力（如 <code>Column</code>, <code>Text</code>）。</li>
<li><strong>SyntaxNode</strong>（及其他非 FrameNode 子类）：语法节点，无渲染实体，仅用于控制流（如 <code>IfElseNode</code>, <code>ForEachNode</code>）。</li>
</ul>
<h3 data-id="heading-7">4.3 渲染流程</h3>
<pre><code class="hljs language-scss" lang="scss">PipelineContext (渲染上下文)
    ↓
UINode Tree (节点树)
    ├── FrameNode (实际渲染节点)
    │   ├── Pattern (行为策略)
    │   ├── LayoutProperty (布局属性)
    │   └── RenderContext (渲染上下文)
    └── SyntaxNode (语法控制节点)
        └── 管理子 FrameNode
    ↓
LayoutWrapper (布局计算)
    ↓
RenderNode (渲染节点)
</code></pre>
<h2 data-id="heading-8">5. 核心函数</h2>
<h3 data-id="heading-9">5.1 节点创建</h3>
<pre><code class="hljs language-cpp" lang="cpp">UINode::<span class="hljs-built_in">UINode</span>(<span class="hljs-type">const</span> std::string&amp; tag, <span class="hljs-type">int32_t</span> nodeId, <span class="hljs-type">bool</span> isRoot)
    : <span class="hljs-built_in">tag_</span>(tag), <span class="hljs-built_in">nodeId_</span>(nodeId), <span class="hljs-built_in">accessibilityId_</span>(currentAccessibilityId_++), <span class="hljs-built_in">isRoot_</span>(isRoot)
{
    ++count_; <span class="hljs-comment">// 全局  用来统计当前存活的UINode 数量， 我也不知为什么统计</span>
    <span class="hljs-keyword">if</span> (MultiThreadBuildManager::<span class="hljs-built_in">IsThreadSafeNodeScope</span>()) {<span class="hljs-comment">// 判断线程安全， 这里1.2 会进来， 增量引擎会存在并行化场景</span>
        isThreadSafeNode_ = <span class="hljs-literal">true</span>;
        <span class="hljs-built_in">SetIsFree</span>(<span class="hljs-literal">true</span>);
    } 
    <span class="hljs-keyword">if</span> (AceChecker::<span class="hljs-built_in">IsPerformanceCheckEnabled</span>()) {<span class="hljs-comment">//  存放js 代码位置信息， 用来调试补充。 这里没有考虑cangjie和其他语言 </span>
        <span class="hljs-keyword">auto</span> pos = EngineHelper::<span class="hljs-built_in">GetPositionOnJsCode</span>();
        nodeInfo_ = std::<span class="hljs-built_in">make_unique</span>&lt;PerformanceCheckNode&gt;();
        nodeInfo_-&gt;codeRow = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">1</span>&gt;(pos);
        nodeInfo_-&gt;codeCol = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">2</span>&gt;(pos);
        nodeInfo_-&gt;pagePath = std::<span class="hljs-built_in">get</span>&lt;<span class="hljs-number">0</span>&gt;(pos);
    }
    apiVersion_ = Container::<span class="hljs-built_in">GetCurrentApiTargetVersion</span>();
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> UICAST_COMPONENT_SUPPORTED</span>
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">auto</span> container = Container::<span class="hljs-built_in">Current</span>();
        <span class="hljs-built_in">CHECK_NULL_BREAK</span>(container);
        <span class="hljs-keyword">auto</span> distributedUI = container-&gt;<span class="hljs-built_in">GetDistributedUI</span>();
        <span class="hljs-built_in">CHECK_NULL_BREAK</span>(distributedUI);
        distributedUI-&gt;<span class="hljs-built_in">AddNewNode</span>(nodeId_);
    } <span class="hljs-keyword">while</span> (<span class="hljs-literal">false</span>);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
    instanceId_ = Container::<span class="hljs-built_in">CurrentId</span>();
    nodeStatus_ = ViewStackProcessor::<span class="hljs-built_in">GetInstance</span>()-&gt;<span class="hljs-built_in">IsBuilderNode</span>() ? NodeStatus::BUILDER_NODE_OFF_MAINTREE
                                                                     : NodeStatus::NORMAL_NODE;
    <span class="hljs-keyword">if</span> (SystemProperties::<span class="hljs-built_in">ConfigChangePerform</span>()) {
        <span class="hljs-keyword">auto</span> currentContainer = Container::<span class="hljs-built_in">GetContainer</span>(instanceId_);
        isDarkMode_ = currentContainer ? (currentContainer-&gt;<span class="hljs-built_in">GetColorMode</span>() == ColorMode::DARK) : <span class="hljs-literal">false</span>;
    }
    uiNodeGcEnable_ = FeatureParam::<span class="hljs-built_in">IsUINodeGcEnabled</span>();
}
</code></pre>
<h3 data-id="heading-10">5.2 节点销毁</h3>
<pre><code class="hljs language-cpp" lang="cpp">UINode::~<span class="hljs-built_in">UINode</span>()
{
    --count_;
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> UICAST_COMPONENT_SUPPORTED</span>
    <span class="hljs-keyword">do</span> {
        <span class="hljs-keyword">auto</span> container = Container::<span class="hljs-built_in">Current</span>();
        <span class="hljs-built_in">CHECK_NULL_BREAK</span>(container);
        <span class="hljs-keyword">auto</span> distributedUI = container-&gt;<span class="hljs-built_in">GetDistributedUI</span>();
        <span class="hljs-built_in">CHECK_NULL_BREAK</span>(distributedUI);
        <span class="hljs-keyword">if</span> (hostPageId_ == distributedUI-&gt;<span class="hljs-built_in">GetCurrentPageId</span>()) {
            distributedUI-&gt;<span class="hljs-built_in">AddDeletedNode</span>(nodeId_);
        }
    } <span class="hljs-keyword">while</span> (<span class="hljs-literal">false</span>);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

    <span class="hljs-keyword">if</span> (!removeSilently_) {
        ElementRegister::<span class="hljs-built_in">GetInstance</span>()-&gt;<span class="hljs-built_in">RemoveItem</span>(nodeId_); <span class="hljs-comment">//RemoveItem(nodeId_)：从 map 里删掉，并且把该 nodeId_ 加入 removedItems_（“已删除 id”集合）</span>
    } <span class="hljs-keyword">else</span> {
        ElementRegister::<span class="hljs-built_in">GetInstance</span>()-&gt;<span class="hljs-built_in">RemoveItemSilently</span>(nodeId_); <span class="hljs-comment">// 只从 map 里删，不加入 removedItems_。用于“这个节点马上会用同一个或新 id 再注册”的场景，避免被误当成“已删除”。</span>
    }
    <span class="hljs-keyword">if</span> (isThreadSafeNode_) {
        ElementRegisterMultiThread::<span class="hljs-built_in">GetInstance</span>()-&gt;<span class="hljs-built_in">RemoveThreadSafeNode</span>(nodeId_);
    }
    <span class="hljs-keyword">if</span> (propInspectorId_.<span class="hljs-built_in">has_value</span>()) {
        ElementRegister::<span class="hljs-built_in">GetInstance</span>()-&gt;<span class="hljs-built_in">RemoveFrameNodeByInspectorId</span>(propInspectorId_.<span class="hljs-built_in">value_or</span>(<span class="hljs-string">""</span>), nodeId_);
    }
    <span class="hljs-keyword">if</span> (!onMainTree_) { 
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (context_) {
        context_-&gt;<span class="hljs-built_in">RemoveAttachedNode</span>(<span class="hljs-keyword">this</span>); <span class="hljs-comment">//AttachToMainTree 时会把节点放进 attachedNodeSet_；析构时必须从该集合移除，否则管线会持有已销毁节点的指针，造成悬空引用/未定义行为。</span>
    }
    onMainTree_ = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (nodeStatus_ == NodeStatus::BUILDER_NODE_ON_MAINTREE) {
        nodeStatus_ = NodeStatus::BUILDER_NODE_OFF_MAINTREE;
    }
}
</code></pre>
<h2 data-id="heading-11">6. 其他关键功能</h2>
<h3 data-id="heading-12">6.1 线程安全节点机制（Thread-Safe Node）</h3>
<p>支持非 UI 线程操作节点，主要用于后台构建场景。</p>
<h4 data-id="heading-13">核心方法</h4>





























<table><thead><tr><th>方法</th><th>功能说明</th></tr></thead><tbody><tr><td><code>IsThreadSafeNode()</code></td><td>检查是否为线程安全节点</td></tr><tr><td><code>IsFree()</code></td><td>检查节点是否处于"自由"状态</td></tr><tr><td><code>SetIsFree(bool isFree)</code></td><td>设置节点自由状态</td></tr><tr><td><code>PostAfterAttachMainTreeTask()</code></td><td>提交挂载后的任务</td></tr><tr><td><code>ExecuteAfterAttachMainTreeTasks()</code></td><td>执行挂载后的任务</td></tr></tbody></table>
<h4 data-id="heading-14">关键状态</h4>
<ul>
<li><strong><code>isThreadSafeNode_</code></strong>：标识节点是否支持线程安全操作</li>
<li><strong><code>isFree_</code></strong>：节点处于"自由"状态时，非 UI 线程可以安全操作</li>
<li><strong><code>afterAttachMainTreeTasks_</code></strong>：挂载到主树后需要执行的任务列表</li>
</ul>
<h4 data-id="heading-15">使用场景</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 典型场景：LazyForEach 在后台线程构建节点</span>
<span class="hljs-keyword">if</span> (node-&gt;<span class="hljs-built_in">IsFree</span>()) {
    <span class="hljs-comment">// 非 UI 线程可以安全操作</span>
    node-&gt;<span class="hljs-built_in">AddChild</span>(child);
    <span class="hljs-comment">// ...</span>
    node-&gt;<span class="hljs-built_in">PostAfterAttachMainTreeTask</span>([=]() {
        <span class="hljs-comment">// 挂载到主树后执行的任务</span>
    });
}
</code></pre>
<p>补充： 并行化的时候需要关注， 要修改节点状态，不然没法进入渲染流程。</p>
<h3 data-id="heading-16">6.2 BuilderNode 机制（延迟构建）</h3>
<p>支持延迟构建和动态更新，用于 <code>@Builder</code> 装饰的函数。</p>
<h4 data-id="heading-17">核心方法</h4>









































<table><thead><tr><th>方法</th><th>功能说明</th></tr></thead><tbody><tr><td><code>GetNodeStatus()</code></td><td>获取节点状态</td></tr><tr><td><code>UpdateNodeStatus()</code></td><td>更新节点状态</td></tr><tr><td><code>GetIsRootBuilderNode()</code></td><td>检查是否为根 BuilderNode</td></tr><tr><td><code>SetJsBuilderNodeId()</code></td><td>设置 JS BuilderNode ID</td></tr><tr><td><code>SetBuilderFunc()</code></td><td>设置构建函数</td></tr><tr><td><code>GetBuilderFunc()</code></td><td>获取构建函数</td></tr><tr><td><code>SetUpdateNodeFunc()</code></td><td>设置节点更新函数</td></tr><tr><td><code>SetUpdateNodeConfig()</code></td><td>设置配置更新函数</td></tr></tbody></table>
<h4 data-id="heading-18">节点状态</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">enum class</span> <span class="hljs-title class_">NodeStatus</span> : <span class="hljs-type">char</span> {
    NORMAL_NODE = <span class="hljs-number">0</span>,                    <span class="hljs-comment">// 普通节点</span>
    BUILDER_NODE_OFF_MAINTREE = <span class="hljs-number">1</span>,      <span class="hljs-comment">// BuilderNode，脱离主树</span>
    BUILDER_NODE_ON_MAINTREE = <span class="hljs-number">2</span>        <span class="hljs-comment">// BuilderNode，挂载到主树</span>
};
</code></pre>
<h4 data-id="heading-19">工作流程</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@Builder</span> 函数调用
    ↓
创建 BuilderNode（OFF_MAINTREE）
    ↓
延迟构建（lazyBuilderFunc_）
    ↓
需要时挂载到主树（ON_MAINTREE）
    ↓
动态更新（updateNodeFunc_）
</code></pre>
<p><strong>设计意图</strong>：<code>@Builder</code> 装饰的函数创建的节点可以延迟构建，节点可以脱离主树（OFF_MAINTREE），需要时再挂载（ON_MAINTREE）。</p>
<h3 data-id="heading-20">6.3 回调机制（Callback System）</h3>
<p>多种回调函数，用于与 JS 层交互和延迟构建。</p>
<h4 data-id="heading-21">回调类型</h4>



































<table><thead><tr><th>回调</th><th>类型</th><th>用途</th></tr></thead><tbody><tr><td><code>updateJSInstanceCallback_</code></td><td><code>std::function&lt;void(int32_t)&gt;</code></td><td>实例更新回调</td></tr><tr><td><code>lazyBuilderFunc_</code></td><td><code>std::function&lt;void()&gt;</code></td><td>延迟构建函数</td></tr><tr><td><code>updateNodeFunc_</code></td><td><code>std::function&lt;void(int32_t, RefPtr&lt;UINode&gt;&amp;)&gt;</code></td><td>节点更新函数</td></tr><tr><td><code>updateNodeConfig_</code></td><td><code>std::function&lt;void()&gt;</code></td><td>配置更新函数</td></tr><tr><td><code>destroyCallback_</code></td><td><code>std::function&lt;void(int32_t)&gt;</code></td><td>销毁回调</td></tr></tbody></table>
<h4 data-id="heading-22">使用示例</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 注册回调</span>
node-&gt;<span class="hljs-built_in">RegisterUpdateJSInstanceCallback</span>([=](<span class="hljs-type">int32_t</span> id) {
    <span class="hljs-comment">//  实例更新逻辑</span>
});

node-&gt;<span class="hljs-built_in">SetBuilderFunc</span>([=]() {
    <span class="hljs-comment">// 延迟构建逻辑</span>
});

node-&gt;<span class="hljs-built_in">SetOnNodeDestroyCallback</span>([=](<span class="hljs-type">int32_t</span> id) {
    <span class="hljs-comment">// 节点销毁逻辑</span>
});
</code></pre>
<p><strong>用途</strong>：与前端语言 层交互、延迟构建、节点更新通知、生命周期管理。</p>
<h3 data-id="heading-23">6.4 内存管理机制</h3>
<p>智能指针 + 引用计数，避免泄漏与循环引用。</p>
<h4 data-id="heading-24">关键设计</h4>
<ul>
<li><strong>父方向用 <code>WeakPtr</code></strong>（不增加父的强引用）：
<pre><code class="hljs language-cpp" lang="cpp">WeakPtr&lt;UINode&gt; parent_;       <span class="hljs-comment">// 父节点，使用前需 Upgrade() 判空</span>
WeakPtr&lt;UINode&gt; adoptParent_;  <span class="hljs-comment">// 收养父（如 overlay）</span>
WeakPtr&lt;UINode&gt; ancestor_;     <span class="hljs-comment">// 祖先，插入去重等用</span>
</code></pre>
</li>
<li><strong>子方向用 <code>RefPtr</code></strong>（父拥有子）：
<pre><code class="hljs language-cpp" lang="cpp">std::list&lt;RefPtr&lt;UINode&gt;&gt; children_;
</code></pre>
</li>
<li><strong>释放钩子</strong>：强引用归零时由基类 <code>Referenced::DecRefCount()</code> 调用，子类可干预是否立即 delete：
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">MaybeRelease</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span></span>;  <span class="hljs-comment">// true=立即 delete，false=不在这里删（如交给 GC）</span>
</code></pre>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[linux安装xray]]></title>    <link>https://juejin.cn/post/7605114376803418152</link>    <guid>https://juejin.cn/post/7605114376803418152</guid>    <pubDate>2026-02-11T07:07:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605114376803418152" data-draft-id="7605173538417098762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="linux安装xray"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T07:07:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小悲伤"/> <meta itemprop="url" content="https://juejin.cn/user/1253916569515143"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            linux安装xray
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1253916569515143/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小悲伤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:07:49.000Z" title="Wed Feb 11 2026 07:07:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<p><strong>前置准备</strong></p>
<p>ubuntu服务器和域名</p>
<ul>
<li>
<h3 data-id="heading-1">下载nginx</h3>
</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">sudo apt install nginx -y
</code></pre>
<h5 data-id="heading-2">修改配置文件</h5>
<pre><code class="hljs language-shell" lang="shell">sudo vim /etc/nginx/sites-available/default
</code></pre>
<p>增加内容如下:</p>
<pre><code class="hljs language-js" lang="js">location /xray {  # 自定义路径
    proxy_redirect off;
    proxy_pass <span class="hljs-attr">http</span>:<span class="hljs-comment">//127.0.0.1:10000;  # xRay监听的端口</span>
    proxy_http_version <span class="hljs-number">1.1</span>;
    proxy_set_header <span class="hljs-title class_">Upgrade</span> $http_upgrade;
    proxy_set_header <span class="hljs-title class_">Connection</span> <span class="hljs-string">"upgrade"</span>;
    proxy_set_header <span class="hljs-title class_">Host</span> $host;
}
</code></pre>
<p>至此，nginx的工作就算做完了</p>
<h3 data-id="heading-3">下载xray</h3>
<pre><code class="hljs language-shell" lang="shell">sudo bash -c "$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
</code></pre>
<p>修改配置文件</p>
<p>先准备一个uuid，在配置文件与客户端都需要用到</p>
<pre><code class="hljs language-shell" lang="shell">xray uuid
</code></pre>
<p>将返回的uuid复制下来</p>
<pre><code class="hljs language-shell" lang="shell">sudo vim /usr/local/etc/xray/config.json
</code></pre>
<p>以下是全部内容，可以直接复制使用，按需调整port/uuid/path</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"log"</span>: {
    <span class="hljs-string">"loglevel"</span>: <span class="hljs-string">"warning"</span>
  },
  <span class="hljs-string">"inbounds"</span>: [
    {
      <span class="hljs-string">"port"</span>: <span class="hljs-number">10000</span>, #监听的端口
      <span class="hljs-string">"listen"</span>: <span class="hljs-string">"127.0.0.1"</span>,
      <span class="hljs-string">"protocol"</span>: <span class="hljs-string">"vless"</span>, 
      <span class="hljs-string">"settings"</span>: {
        <span class="hljs-string">"clients"</span>: [
          {
            <span class="hljs-string">"id"</span>: <span class="hljs-string">"UUID"</span> #自定义一个uuid，这里跟客户端一样即可，范围是<span class="hljs-number">1</span>-<span class="hljs-number">30</span>字节的字符（这里就是填刚才获得的uuid，你也可以不使用uuid，随便几个字符串也行）
          }
        ],
        <span class="hljs-string">"decryption"</span>: <span class="hljs-string">"none"</span>
      },
      <span class="hljs-string">"streamSettings"</span>: {
        <span class="hljs-string">"network"</span>: <span class="hljs-string">"ws"</span>,
        <span class="hljs-string">"wsSettings"</span>: {
          <span class="hljs-string">"path"</span>: <span class="hljs-string">"/xray"</span> #nginx的路径
        }
      }
    }
  ],
  <span class="hljs-string">"outbounds"</span>: [
    {
      <span class="hljs-string">"protocol"</span>: <span class="hljs-string">"freedom"</span>,
      <span class="hljs-string">"tag"</span>: <span class="hljs-string">"direct"</span>
    }
  ]
}
</code></pre>
<h3 data-id="heading-4">申请证书</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">安装Certbot</span>
sudo apt install certbot python3-certbot-nginx -y
<span class="hljs-meta prompt_">#</span><span class="bash">申请证书</span>
sudo certbot --nginx -d domian.com #填你的域名
<span class="hljs-meta prompt_">#</span><span class="bash">自动续期</span>
sudo systemctl enable certbot.timer
</code></pre>
<h3 data-id="heading-5">开放端口</h3>
<pre><code class="hljs language-shell" lang="shell">sudo ufw allow 22/tcp  # SSH端口
sudo ufw allow 80/tcp   # HTTP
sudo ufw allow 443/tcp  # HTTPS
sudo ufw allow 10000/tcp #xray的端口
sudo ufw enable  #开启防火墙
</code></pre>
<p>所有准备工作都做完了，现在可以启动我们的xray和nginx服务了</p>
<p>如果之前启动了，那么修改了配置文件之后，记得重启</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash">启动xray</span>
sudo systemctl start xray 
<span class="hljs-meta prompt_">#</span><span class="bash">重启nginx</span>
sudo systemctl start nginx
</code></pre>
<h3 data-id="heading-6">客户端的配置</h3>
<p>下载地址</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F2dust%2Fv2rayN" target="_blank" title="https://github.com/2dust/v2rayN" ref="nofollow noopener noreferrer">GitHub - 2dust/v2rayN: A GUI client for Windows, Linux and macOS, support Xray and sing-box and others</a></p>
<p>在release下载自己的版本就好了，下面以window版举例。</p>
<p>1-点击配置项，添加一个vless服务</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce056785bf8b4f5e84a44529b7e79eb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oKy5Lyk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398469&amp;x-signature=WH73tWXEd9fT0z4wqhNzck3voIY%3D" alt="image.png" loading="lazy"/></p>













































<table><thead><tr><th>标题</th><th>值</th></tr></thead><tbody><tr><td>别名</td><td>随便取一个</td></tr><tr><td>地址</td><td>你的服务器域名</td></tr><tr><td>端口</td><td>443</td></tr><tr><td>用户id</td><td>配置文件的uuid</td></tr><tr><td>传输协议</td><td>ws</td></tr><tr><td>伪装域名</td><td>你的服务器域名</td></tr><tr><td>路径</td><td>nginx配置的路径</td></tr><tr><td>传输层安全</td><td>tls</td></tr><tr><td>SNI</td><td>你的服务器域名</td></tr></tbody></table>
<p>至此，服务端与客户端就搭建好了，最后，在网络设置打开代理模式，</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96e9476495e6496cbd67ca87bdf49bb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oKy5Lyk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398469&amp;x-signature=q%2B6m7nCNiDQA608vUy06cVEN8Iw%3D" alt="image.png" loading="lazy"/></p>
<p>端口为客户端右下角的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ea8321bce67454295f2bc736d3b9cf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5oKy5Lyk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771398469&amp;x-signature=QACwwEwaHaDwOG8hWFAqnPzlcBI%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[连接层里住着一个 HTTP 解析器]]></title>    <link>https://juejin.cn/post/7605105527258136576</link>    <guid>https://juejin.cn/post/7605105527258136576</guid>    <pubDate>2026-02-11T06:41:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605105527258136576" data-draft-id="7605128056485625871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="连接层里住着一个 HTTP 解析器"/> <meta itemprop="keywords" content="程序员,Nginx"/> <meta itemprop="datePublished" content="2026-02-11T06:41:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员洪志道"/> <meta itemprop="url" content="https://juejin.cn/user/879237481367326"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            连接层里住着一个 HTTP 解析器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/879237481367326/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员洪志道
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:41:45.000Z" title="Wed Feb 11 2026 06:41:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前两篇打磨了引擎层——<code>js_epoll_poll()</code> 封装了事件分发，<code>js_engine_t</code> 组装了 epoll 和定时器。引擎层现在很干净。</p>
<p>但往上看一层，我发现了一个不对劲的东西。</p>
<h2 data-id="heading-0">连接结构体里有什么</h2>
<p>看 <code>js_conn_t</code>——这是 jsbench 连接层的核心结构：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">js_conn</span> {</span>
    <span class="hljs-type">js_event_t</span>           socket;
    <span class="hljs-type">conn_state_t</span>         state;
    SSL                 *ssl;

    <span class="hljs-type">const</span> <span class="hljs-type">char</span>          *req_data;
    <span class="hljs-type">size_t</span>               req_len;
    <span class="hljs-type">size_t</span>               req_sent;

    <span class="hljs-type">js_http_response_t</span>   response;   <span class="hljs-comment">/* ← 这是什么？ */</span>

    <span class="hljs-type">uint64_t</span>             start_ns;
    <span class="hljs-type">int</span>                  req_index;
    <span class="hljs-type">void</span>                *udata;
} <span class="hljs-type">js_conn_t</span>;
</code></pre>
<p>socket、状态、TLS、读写缓冲——这些都是连接该有的。但 <code>js_http_response_t response</code> 是什么？一个 HTTP 响应解析器，直接嵌在连接结构体里。</p>
<p>连接结构体里住着一个 HTTP 解析器。这意味着：<strong>这个"连接"，不能离开 HTTP 独立存在。</strong></p>
<p>再看 <code>conn_do_read()</code>——连接层处理读事件的函数：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">conn_do_read</span><span class="hljs-params">(<span class="hljs-type">js_conn_t</span> *c)</span> {
    <span class="hljs-type">char</span> buf[JS_READ_BUF_SIZE];

    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-type">ssize_t</span> n;
        <span class="hljs-keyword">if</span> (c-&gt;ssl) {
            n = js_tls_read(c-&gt;ssl, buf, <span class="hljs-keyword">sizeof</span>(buf));
        } <span class="hljs-keyword">else</span> {
            n = read(c-&gt;socket.fd, buf, <span class="hljs-keyword">sizeof</span>(buf));
        }

        <span class="hljs-comment">/* ... 错误处理 ... */</span>

        <span class="hljs-type">int</span> ret = js_http_response_feed(&amp;c-&gt;response, buf, (<span class="hljs-type">size_t</span>)n);
        <span class="hljs-keyword">if</span> (ret == <span class="hljs-number">1</span>) {
            c-&gt;state = CONN_DONE;    <span class="hljs-comment">/* HTTP 解析完成 → 连接状态变更 */</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }
    }
}
</code></pre>
<p>读数据是连接层的事，解析 HTTP 是协议层的事。但在这个函数里，两件事混在一起，没有边界。</p>
<p>还有 <code>js_conn_keepalive()</code>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">bool</span> <span class="hljs-title function_">js_conn_keepalive</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">js_conn_t</span> *c)</span> {
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *conn_hdr = js_http_response_header(&amp;c-&gt;response, <span class="hljs-string">"Connection"</span>);
    <span class="hljs-keyword">if</span> (conn_hdr &amp;&amp; strcasecmp(conn_hdr, <span class="hljs-string">"close"</span>) == <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p>连接该不该复用，这个函数去读了 HTTP <code>Connection</code> 头。连接层依赖了协议层的知识。</p>
<p>三个地方，同一个问题：<strong>conn 和 http 塌成了一层。</strong></p>
<h2 data-id="heading-1">这意味着什么</h2>
<p>jsbench 从下往上有三层：</p>
<pre><code class="hljs language-markdown" lang="markdown">  ┌─────────────────┐
  │      http        │  协议语义：解析响应、判断 keep-alive
  └────────┬─────────┘
<span class="hljs-code">           │ 依赖
  ┌────────▼─────────┐
  │      conn        │  传输管理：连接、读写、TLS
  └────────┬─────────┘
           │ 依赖
  ┌────────▼─────────┐
  │     engine       │  事件驱动：epoll + timer
  └──────────────────┘
</span></code></pre>
<p>理想状态下，每层做自己的事，依赖方向从上往下。http 用 conn 发数据，conn 用 engine 做 I/O。上层依赖下层，下层不知道上层的存在。</p>
<p>但现在的代码是这样的：</p>
<pre><code class="hljs language-markdown" lang="markdown">  ┌──────────────────────────────┐
  │       conn + http             │
  │                               │
  │  conn 内嵌 http response      │
  │  conn 读 HTTP 头判断 keep-alive│
  │  conn 直接调 http 解析器       │
  └──────────────┬────────────────┘
<span class="hljs-code">                 │
  ┌──────────────▼────────────────┐
  │           engine               │  ← 这层是干净的
  └───────────────────────────────┘
</span></code></pre>
<p>上面两层塌成了一坨。改 HTTP 解析逻辑要动 conn 的代码，改 conn 的读取策略可能碰坏 HTTP 解析。<strong>两层的复杂度不是加在一起，是乘在一起。</strong></p>
<p>对比一下 engine 层。engine 层经过第五、六篇的重构，依赖方向是干净的：<code>js_event_t</code> 不知道上面是谁，通过回调隔离。第六篇引入 <code>js_engine_t</code> 的时候，改 engine 的内部结构（从 thread-local epfd 到显式 engine 参数），上层的连接逻辑完全不受影响。<strong>改下层不影响上层——这就是分层的回报。</strong></p>
<p>conn 层呢？如果你想换一种 HTTP 解析方式，或者想让 jsbench 支持非 HTTP 的协议，你会发现改不动——因为 conn 和 http 的代码纠缠在一起，改哪边都怕碰坏另一边。</p>
<p><strong>分层解决的核心问题是依赖。不是消除依赖，是让依赖单向。</strong> 依赖一旦单向，每层就能独立理解、独立修改、独立演进。</p>
<h2 data-id="heading-2">为什么 AI 会写成这样</h2>
<p>这个问题值得想一想。AI 写代码的目标是"让功能工作"。让一个 HTTP 客户端工作，最直接的方式就是：创建连接、发请求、读数据、解析响应、判断 keep-alive。这些步骤串起来，放在一组函数里，功能确实工作了。</p>
<p>但"让功能工作"和"让系统可演进"是两个不同的目标。分层是为后者服务的。<strong>层间的边界不是功能需求，是架构决策。</strong> AI 不会主动说"这里该切一刀，把传输和协议分开"——因为不切也能工作。</p>
<p>这也是前几篇的经验。第五篇 engine 层的重构，不是因为 AI 改不了 epoll 的代码，而是 AI 不会主动说"epfd 不该是参数，应该是线程的属性"。人给了方向，AI 执行得很好。conn 和 http 的分层也一样：AI 完全有能力做拆分，但"该不该拆、在哪里拆"，是人的判断。</p>
<h2 data-id="heading-3">去掉不合理</h2>
<p>方向明确了：把 conn 和 http 分开。从哪里下手？</p>
<p>改进架构有一个很朴素的方法：<strong>找到不合理的地方，去掉它。</strong> <code>conn_do_read()</code> 不应该做 HTTP 解析——去掉。<code>js_conn_t</code> 不应该内嵌 HTTP 响应——去掉。<code>js_conn_keepalive()</code> 不应该读 HTTP 头——去掉。一个一个去掉，层就自然分开了。</p>
<p>背后的道理很简单：<strong>一个函数做的事越多，它牵扯的概念就越多，改动它的理由也越多。</strong> 这有个经典的名字叫单一职责，但我更愿意用朴素的说法：让每个函数只做一件它该做的事。</p>
<p>当然这不是死规矩。<code>conn_do_write()</code> 写完数据之后设置 <code>c-&gt;state = CONN_READING</code>——写完切换到读，这是连接状态机的自然流转，没必要硬拆。<strong>判断的标准不是"做了几件事"，而是"这些事会不会各自独立变化"。</strong> 读字节和解析 HTTP 显然会——你完全可能换一种协议解析，或者换一种读取策略，它们各自有各自的变化理由。</p>
<h2 data-id="heading-4">第一步：引入 buffer，让读和解析分开</h2>
<p><code>conn_do_read()</code> 要改——让它只做读数据，不做解析。但读到的字节放哪里？</p>
<p>现在用的是栈上临时数组，读完立刻喂给解析器，用完就丢。如果不立刻处理，字节就需要一个地方存着。引入 <code>js_buf_t</code>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
    <span class="hljs-type">char</span>   *data;
    <span class="hljs-type">size_t</span>  len;     <span class="hljs-comment">/* 已有数据的长度 */</span>
    <span class="hljs-type">size_t</span>  cap;     <span class="hljs-comment">/* 分配的容量 */</span>
} <span class="hljs-type">js_buf_t</span>;
</code></pre>
<p>有了 buffer，<code>conn_do_read()</code> 变成了：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">conn_do_read</span><span class="hljs-params">(<span class="hljs-type">js_conn_t</span> *c)</span> {
    <span class="hljs-type">js_buf_t</span> *in = &amp;c-&gt;in;

    <span class="hljs-keyword">for</span> (;;) {
        js_buf_ensure(in, in-&gt;len + JS_READ_BUF_SIZE);

        <span class="hljs-type">ssize_t</span> n;
        <span class="hljs-keyword">if</span> (c-&gt;ssl) {
            n = js_tls_read(c-&gt;ssl, in-&gt;data + in-&gt;len, in-&gt;cap - in-&gt;len);
        } <span class="hljs-keyword">else</span> {
            n = read(c-&gt;socket.fd, in-&gt;data + in-&gt;len, in-&gt;cap - in-&gt;len);
        }

        <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">if</span> (errno == EAGAIN || errno == EWOULDBLOCK) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            c-&gt;state = CONN_ERROR;
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
        }
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">/* 对端关闭 */</span>

        in-&gt;len += (<span class="hljs-type">size_t</span>)n;
    }
}
</code></pre>
<p>没有 <code>js_http_response_feed</code>，没有 <code>c-&gt;state = CONN_DONE</code>，没有任何协议相关的判断。<strong>只做一件事：把字节从 socket 读到 buffer 里。</strong></p>
<p>HTTP 解析搬到了调用方——worker 和 loop 读完之后，从 <code>c-&gt;in</code> 取数据，自己喂给 HTTP 解析器。不再是 conn 推数据给解析器，而是调用者从 conn 的 buffer 里拉数据。<strong>这是整个分层工作中最关键的一步——conn 不再知道 HTTP 的存在。</strong></p>
<p>代码变更: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench%2Fcommit%2F47e4d2c" target="_blank" title="https://github.com/hongzhidao/jsbench/commit/47e4d2c" ref="nofollow noopener noreferrer">47e4d2c</a></p>
<h2 data-id="heading-5">第二步：给 conn 层一个正式的家</h2>
<p>之前连接相关的代码都在 <code>js_http_client.c</code> 里——文件名本身就暴露了问题：一个叫"HTTP 客户端"的文件，怎么能是一个干净的传输层？</p>
<p>新建 <code>js_conn.h</code> 和 <code>js_conn.c</code>，提取 <code>js_conn_read()</code> 作为第一个公开接口。<code>js_http_client.c</code> 里还留着 create、free、write、reuse、reset 这些函数，没有急着一次搬完。</p>
<p>我一直在有意识地避免过度设计。设计不足的代码是诚实的——它告诉你"这里还没想清楚"。过度设计的代码是伪装的——那些抽象可能猜错了未来的方向，等你真的需要改的时候，反而比没有抽象更难动。<strong>在没有足够信息的时候，少做比多做安全。</strong></p>
<p>代码变更: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench%2Fcommit%2F5c8c3bc" target="_blank" title="https://github.com/hongzhidao/jsbench/commit/5c8c3bc" ref="nofollow noopener noreferrer">5c8c3bc</a></p>
<h2 data-id="heading-6">第三步：去掉结构体里不该有的字段</h2>
<p>行为解耦了，模块也有了。但 <code>js_conn_t</code> 里还嵌着 <code>js_http_response_t response</code>。行为上分开了，结构上还绑着。</p>
<p>好的结构体应该是简洁的——<strong>它拥有的每个字段都应该是它需要的，而不是别人需要的。</strong></p>
<p>去掉之后，HTTP 响应放哪里？答案在已有的机制里。<code>js_event_t</code> 有一个 <code>void *data</code> 字段，让调用者自己持有 response，通过 <code>socket.data</code> 关联到连接：</p>
<pre><code class="hljs language-c" lang="c">js_http_response_init(&amp;responses[i]);
conns[i]-&gt;socket.data = &amp;responses[i];
</code></pre>
<p>读事件处理里，从 <code>socket.data</code> 取出 response：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">worker_on_read</span><span class="hljs-params">(<span class="hljs-type">js_event_t</span> *ev)</span> {
    <span class="hljs-type">js_conn_t</span> *c = (<span class="hljs-type">js_conn_t</span> *)ev;
    <span class="hljs-type">js_http_response_t</span> *r = c-&gt;socket.data;
    <span class="hljs-comment">/* ... */</span>
}
</code></pre>
<p><code>js_conn_keepalive()</code> 也搬到 worker 里，变成局部函数 <code>worker_keepalive()</code>。连接层不再需要知道 HTTP 协议的任何细节。</p>
<p>去掉 <code>response</code> 之后的 <code>js_conn_t</code>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">js_conn</span> {</span>
    <span class="hljs-type">js_event_t</span>       socket;
    <span class="hljs-type">conn_state_t</span>     state;
    SSL             *ssl;

    <span class="hljs-type">const</span> <span class="hljs-type">char</span>      *req_data;
    <span class="hljs-type">size_t</span>           req_len;
    <span class="hljs-type">size_t</span>           req_sent;

    <span class="hljs-type">js_buf_t</span>         in;

    <span class="hljs-type">uint64_t</span>         start_ns;
    <span class="hljs-type">int</span>              req_index;
    <span class="hljs-type">void</span>            *udata;
} <span class="hljs-type">js_conn_t</span>;
</code></pre>
<p>没有任何 HTTP 相关的字段。连接就是连接。<strong>结构体的简洁程度，就是分层是否到位的直接体现。</strong></p>
<p>代码变更: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench%2Fcommit%2F0bbe6a3" target="_blank" title="https://github.com/hongzhidao/jsbench/commit/0bbe6a3" ref="nofollow noopener noreferrer">0bbe6a3</a></p>
<h2 data-id="heading-7">第四步：把类型搬回它该在的地方</h2>
<p><code>js_conn_t</code> 不再依赖 <code>js_http_response_t</code>，终于可以从 <code>js_main.h</code> 搬到 <code>js_conn.h</code>。之前搬不了，就是因为 <code>js_http_response_t</code> 定义在 <code>js_main.h</code> 中，内嵌了就搬不走。依赖去掉之后，障碍消失了。</p>
<p>conn 层开始有自己的轮廓了：类型在 <code>js_conn.h</code>，读实现在 <code>js_conn.c</code>，不依赖任何协议层的东西。create、free、write 这些函数还留在 <code>js_http_client.c</code> 里，但方向已经很清楚了。不急，一步一步来。</p>
<p>代码变更: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench%2Fcommit%2Fedc2859" target="_blank" title="https://github.com/hongzhidao/jsbench/commit/edc2859" ref="nofollow noopener noreferrer">edc2859</a></p>
<h2 data-id="heading-8">回头看</h2>
<p>四步做完，回到开头的问题：连接层里还住着那个 HTTP 解析器吗？</p>
<p>不在了。<code>js_conn_t</code> 里没有任何 HTTP 字段，<code>conn_do_read()</code> 不调任何 HTTP 函数，conn 模块有了自己的头文件和实现文件。conn 不知道 http 的存在——就像 engine 不知道 conn 的存在一样。</p>
<p>每一步做的都是同一件事：<strong>找到不合理的依赖，去掉它。</strong> 不需要提前设计完美的分层方案，不需要一次搬完所有代码。看到一个不合理的地方，去掉它，系统就比之前好一点。积累几步，层就自然分开了。</p>
<p>分层不是一种理论，是一种实用的手段。判断分层是否到位，有几个直观的检验方法：</p>
<ul>
<li><strong>看结构体。</strong> 每个字段都是自己需要的，还是替别人拿着的？</li>
<li><strong>看函数。</strong> 它做的事情是否属于同一层？读字节和解析协议不在同一层。</li>
<li><strong>看依赖方向。</strong> 下层有没有引用上层的类型或调用上层的函数？</li>
<li><strong>看头文件。</strong> 一个模块的 <code>.h</code> 能不能不依赖不相关的类型就编译通过？</li>
</ul>
<p>这些检验不需要画架构图，打开代码就能看到。</p>
<hr/>
<p>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhongzhidao%2Fjsbench" target="_blank" title="https://github.com/hongzhidao/jsbench" ref="nofollow noopener noreferrer">github.com/hongzhidao/…</a></p>
<p>更多文章和后续更新，关注微信公众号：<strong>程序员洪志道</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Rnd实现自由拖动与边界检测]]></title>    <link>https://juejin.cn/post/7605131777175371839</link>    <guid>https://juejin.cn/post/7605131777175371839</guid>    <pubDate>2026-02-11T07:28:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605131777175371839" data-draft-id="7589052659435700270" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Rnd实现自由拖动与边界检测"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-02-11T07:28:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码云之上"/> <meta itemprop="url" content="https://juejin.cn/user/1319873957601656"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Rnd实现自由拖动与边界检测
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1319873957601656/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码云之上
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:28:30.000Z" title="Wed Feb 11 2026 07:28:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在<code>AI 问答</code>烂大街的今天，只要是个平台都在搞聊天机器人，主要应用场景无非是问答式的“智能”客服。<br/>
笔者所在小团队维护着一个<code>OA</code>系统(技术栈：<code>react17</code> + <code>webpack5.0</code> + <code>tailwindcss</code> + <code>ArcoDesign</code>)，该系统沉淀了很多知识文档，经过后端同学的努力（据说是用了开源框架实现文档的<code>Embedding</code>）将其文档知识化，搭配司内部署的DeepSeek，基本实现了boss要求的智能问答。</p>
<h2 data-id="heading-0">智能问答UI</h2>
<p>因为是内部OA系统，使用者基本是HR小姐姐，她们给的需求基本是一句话描述，哈哈哈，也挺好，方便笔者自由发挥。
参（抄）考（袭）类似平台的交互，决定采用右侧抽屉的形式底部一个输入框，上方展示消息区：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e80c1fce68e145f2a5c265de3894bb09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=83kqaCnidEFVMwZ1yNQ72v5HSNI%3D" alt="Clipboard_Screenshot_1767011782.png" loading="lazy"/></p>
<h2 data-id="heading-1">搞事1.0</h2>
<p><strong>HR小姐姐：</strong> 这个对话框挺好用的，只是固定在页面左侧，能不能像微信一样自由拖动到屏幕其他位置？<br/>
我：额，这是前端页面，全屏幕拖动可实现不了，在当前页面拖动还可以努力一下。<br/>
<strong>HR小姐姐：</strong> 当前页面拖动不就是在显示屏上拖动嘛，有什么区别呢~<br/>
我：额...</p>
<h3 data-id="heading-2">实现</h3>
<p>要拖动是吧，那还不简单，都2025年了，拖动还不是随便找个库就可以打发实现。<br/>
首先想到的便是 <a href="https://link.juejin.cn?target=https%3A%2F%2Freact-dnd.github.io%2Freact-dnd%2Fabout" target="_blank" title="https://react-dnd.github.io/react-dnd/about" ref="nofollow noopener noreferrer">react-dnd</a> ，但是吧，这个库能力很强大，用来做单组件的拖动太杀鸡用牛刀了。而且笔者不喜欢重复以往的方案，喜欢用点新玩意儿。<br/>
继续 Searching，啊哈，还真找着了一个轻量且合适的库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbokuweb%2Freact-rnd" target="_blank" title="https://github.com/bokuweb/react-rnd" ref="nofollow noopener noreferrer">react-rnd</a><br/>
其文档中的例子和契合本次需求：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1e460d3f644a1195e242cf87708cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=xVTBVBt8pU5gUVfutBILpzrx3Z4%3D" alt="screenshot.gif" loading="lazy"/></p>
<p>说干就干，引入 <code>react-rnd</code>，按照官方文档进行配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Rnd</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-rnd"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DragForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Rnd</span>
      <span class="hljs-attr">default</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">x:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">y:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">width:</span> <span class="hljs-attr">500</span>,
        <span class="hljs-attr">height:</span> <span class="hljs-attr">190</span>,
      }}
      <span class="hljs-attr">minWidth</span>=<span class="hljs-string">{500}</span>
      <span class="hljs-attr">minHeight</span>=<span class="hljs-string">{190}</span>
      <span class="hljs-attr">bounds</span>=<span class="hljs-string">"window"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag__content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">MyForm</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Rnd</span>&gt;</span></span>
  );
}
</code></pre>
<p>优化1完成，交差！</p>
<h2 data-id="heading-3">搞事1.1</h2>
<p><strong>HR小姐姐：</strong> 可以拖动啦，真的很丝滑唉~，能不能支持折叠？有时候我想看页面主体内容但是又不想关掉弹窗，关掉再打开历史记录就没了（当时着急交差，还不支持查看历史会话）。<br/>
好吧，我就知道没那么简单~<br/>
继续优化，折叠嘛，用上 <code>Collapse</code> 组件不就行了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 下面为 demo 代码，使用简易 Form 代替了 Drawer 内容</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DragForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Rnd</span>
      <span class="hljs-attr">default</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">x:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">y:</span> <span class="hljs-attr">0</span>,
        <span class="hljs-attr">width:</span> <span class="hljs-attr">500</span>,
        <span class="hljs-attr">height:</span> <span class="hljs-attr">190</span>,
      }}
      <span class="hljs-attr">minWidth</span>=<span class="hljs-string">{500}</span>
      <span class="hljs-attr">minHeight</span>=<span class="hljs-string">{190}</span>
      <span class="hljs-attr">bounds</span>=<span class="hljs-string">"window"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag__content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Collapse</span> <span class="hljs-attr">expandIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"collapse__header"</span> <span class="hljs-attr">defaultActiveKey</span>=<span class="hljs-string">"1"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">CollapseItem</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">header</span>=<span class="hljs-string">"折叠面板"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">MyForm</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">CollapseItem</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Collapse</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Rnd</span>&gt;</span></span>
  );
}
</code></pre>
<p>嗯，能拖动，能折叠，这回够用了吧。</p>
<h2 data-id="heading-4">搞事2.0</h2>
<p><strong>HR小姐姐：</strong> 不对啊，我这边展开内容后，下面部分被挡住了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e205483dc1a4d9494642a8d9a458bf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=otOviD2BlR5J%2F1geTbQ1g9sRe40%3D" alt="Clipboard_Screenshot_1767014151.png" loading="lazy"/></p>
<p>能不能让被挡住部分自动移动上来？不要让我手工调整位置？<br/>
好吧好吧，继续优化~</p>
<h3 data-id="heading-5">初步优化</h3>
<p>首先分析问题原因：</p>
<blockquote>
<p><code>Collapse</code> 展开、收起时会引发容器高度的变化，但是没有触发 <code>rnd</code> 容器的位置变化，造成内容被遮挡了，所以解决办法是监听 <code>Collapse</code> 的 <code>onChange</code> 事件，在回调里重新定位，防止<code>rnd</code> 容器溢出可视范围。</p>
</blockquote>
<p>效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85c2c056bcc7465b9d92aef5989e5634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=vtWkclYatx26tWxyYskFfc6yFLI%3D" alt="Kapture 2026-02-11 at 15.05.46.gif" loading="lazy"/></p>
<h3 data-id="heading-6">进一步优化</h3>
<p>上面的处理可以解决 <code>Collapse</code> 展开时被遮挡问题，但是用户可以无限制拖动 <code>Collapse</code>，将 <code>Collapse</code> 拖动到视窗之外，所以还需要给拖动加上一个边界，防止内容被拖动到视窗之外。<br/>
这里有两种实现：</p>
<ol>
<li>限定拖动范围，当<code>Collapse</code>离开视窗时禁止拖动</li>
<li>增加兜底逻辑，当最后防止位置不在视窗范围内时，自动将<code>Collapse</code>定位到最低可视范围内</li>
</ol>
<p>综合用户体验，决定采用第二种实现。</p>
<h4 data-id="heading-7">提取工具类</h4>
<p>为了满足拖动后自动定位，需要实现一个工具函数，笔者刚开始写的时候确实是定义了一个function，最后发现内联方法越来越多，最后重构为一个 <code>Class</code>:</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">export</span> interface <span class="hljs-title class_">IPositionData</span> {
  <span class="hljs-attr">x</span>: number;
  <span class="hljs-attr">y</span>: number;
}
<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">ISizeData</span> {
  <span class="hljs-attr">width</span>: number;
  <span class="hljs-attr">height</span>: number;
}

<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">IHelpPanelRectData</span> {
  <span class="hljs-attr">defaultRightOffset</span>: number;
  <span class="hljs-attr">defaultBottomOffset</span>: number;
  <span class="hljs-attr">defaultTopOffset</span>: number;
  <span class="hljs-attr">defaultSize</span>: <span class="hljs-title class_">ISizeData</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getDefaultRect</span> = (<span class="hljs-params">data: IHelpPanelRectData</span>) =&gt; {
  <span class="hljs-keyword">const</span> winWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
  <span class="hljs-keyword">const</span> winHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
  <span class="hljs-keyword">const</span> width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
    winWidth - data.<span class="hljs-property">defaultRightOffset</span>,
    data.<span class="hljs-property">defaultSize</span>.<span class="hljs-property">width</span>
  );
  <span class="hljs-keyword">const</span> height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
    winHeight - data.<span class="hljs-property">defaultBottomOffset</span> - data.<span class="hljs-property">defaultTopOffset</span>,
    data.<span class="hljs-property">defaultSize</span>.<span class="hljs-property">height</span>
  );
  <span class="hljs-keyword">const</span> position = {
    <span class="hljs-attr">x</span>: winWidth - width - data.<span class="hljs-property">defaultRightOffset</span>,
    <span class="hljs-attr">y</span>: winHeight - height - data.<span class="hljs-property">defaultBottomOffset</span>,
  };
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">size</span>: { width, height }, position };
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelpPanelRect</span> {
  <span class="hljs-comment">// 拖动容器最小高度</span>
  public minHeight = <span class="hljs-number">100</span>;
  <span class="hljs-comment">// 拖动容器最小宽度</span>
  public minWidth = <span class="hljs-number">400</span>;
  <span class="hljs-comment">// 拖动容器最大高度</span>
  public maxHeight = <span class="hljs-number">1024</span>;
  <span class="hljs-comment">// 拖动容器最大宽度</span>
  public maxWidth = <span class="hljs-number">1024</span>;
  <span class="hljs-comment">// 默认上边距</span>
  public defaultTopOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 当前上边距</span>
  public topOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 默认右边距</span>
  public defaultRightOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 当前右边距</span>
  public rightOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 默认情况下距底高度，紧贴帮助按钮</span>
  public defaultBottomOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 面板移动之后底部边距，0 表示紧贴窗口</span>
  public bottomOffset = <span class="hljs-number">20</span>;
  <span class="hljs-comment">// 默认大小</span>
  public defaultSize = {
    <span class="hljs-attr">width</span>: <span class="hljs-number">450</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">457</span>,
  };
  <span class="hljs-comment">// 最大大小</span>
  public maxSize = {
    <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxWidth</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxHeight</span>,
  };

  private <span class="hljs-attr">prevSize</span>: <span class="hljs-title class_">ISizeData</span>;
  private <span class="hljs-attr">prevPosition</span>: <span class="hljs-title class_">IPositionData</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data: IHelpPanelRectData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultRightOffset</span> = data.<span class="hljs-property">defaultRightOffset</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultBottomOffset</span> = data.<span class="hljs-property">defaultBottomOffset</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultTopOffset</span> = data.<span class="hljs-property">defaultTopOffset</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSize</span> = data.<span class="hljs-property">defaultSize</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSize</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getDefaultRect</span>(data).<span class="hljs-property">position</span>;
  }

  <span class="hljs-comment">// 点击入口按钮时的初始状态</span>
  <span class="hljs-title function_">getDefaultRect</span>(<span class="hljs-params">data?: IHelpPanelRectData</span>) {
    <span class="hljs-keyword">const</span> defaultRect = data ? <span class="hljs-title function_">getDefaultRect</span>(data) : <span class="hljs-title function_">getDefaultRect</span>(<span class="hljs-variable language_">this</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = defaultRect.<span class="hljs-property">size</span>;
    <span class="hljs-keyword">return</span> {
      ...defaultRect,
    };
  }

  <span class="hljs-comment">/**
   *
   * <span class="hljs-doctag">@param</span> windowIsResize 是否拖动浏览器窗口
   */</span>
  <span class="hljs-title function_">getRectByWindowResize</span>(<span class="hljs-params">windowIsResize = <span class="hljs-literal">false</span></span>) {
    <span class="hljs-keyword">const</span> winWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
    <span class="hljs-keyword">const</span> winHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    <span class="hljs-keyword">let</span> { x, y } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span>;
    y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(y, <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>);

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getMaxHeight</span> = (<span class="hljs-params"/>) =&gt;
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">minHeight</span>,
        <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(winHeight - y - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxHeight</span>)
      );

    <span class="hljs-keyword">let</span> { width, height } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">rightOffset</span> + x + width &gt; winWidth) {
      <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>) {
        x = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(winWidth - width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">rightOffset</span>, <span class="hljs-number">0</span>);
      } <span class="hljs-keyword">else</span> {
        width = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">minWidth</span>,
          <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(winWidth - <span class="hljs-variable language_">this</span>.<span class="hljs-property">rightOffset</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxWidth</span>)
        );
      }
    }

    <span class="hljs-keyword">if</span> (y + height + <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span> &gt; winHeight) {
      <span class="hljs-keyword">if</span> (y &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>) {
        y = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>, winHeight - height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span>);
      } <span class="hljs-keyword">else</span> {
        height = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">minHeight</span>,
          <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
            winHeight - <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span>,
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxHeight</span>
          )
        );
      }
    } <span class="hljs-keyword">else</span> {
      height = windowIsResize
        ? <span class="hljs-title function_">getMaxHeight</span>()
        : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(height, winHeight - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>);
    }

    <span class="hljs-keyword">return</span> { <span class="hljs-attr">size</span>: { width, height }, <span class="hljs-attr">position</span>: { x, y } };
  }

  <span class="hljs-comment">/**
   * 尺寸不变，只调整位置
   * <span class="hljs-doctag">@param</span> position 拖动之后的位置
   */</span>
  <span class="hljs-title function_">getRectByPosition</span>(<span class="hljs-params">position: IPositionData</span>) {
    <span class="hljs-keyword">const</span> winWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
    <span class="hljs-keyword">const</span> winHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    <span class="hljs-keyword">const</span> { width, height } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = {
      <span class="hljs-attr">x</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, position.<span class="hljs-property">x</span>), winWidth - width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">rightOffset</span>),
      <span class="hljs-attr">y</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
        <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">topOffset</span>, position.<span class="hljs-property">y</span>),
        winHeight - height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomOffset</span>
      ),
    };

    <span class="hljs-keyword">return</span> { <span class="hljs-attr">size</span>: { width, height }, <span class="hljs-attr">position</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> };
  }

  <span class="hljs-title function_">getRectByResize</span>(<span class="hljs-params">pos?: IPositionData, s?: ISizeData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = s ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = pos ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span>;

    <span class="hljs-keyword">const</span> { size, position } = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getRectByWindowResize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = size;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = position;
    <span class="hljs-keyword">return</span> { size, position };
  }

  <span class="hljs-title function_">getRect</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">position</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span>, <span class="hljs-attr">size</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> };
  }

  <span class="hljs-title function_">setRect</span>(<span class="hljs-params">position?: IPositionData, size?: ISizeData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = position ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = size ?? <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;
  }

  <span class="hljs-title function_">setDefaultSize</span>(<span class="hljs-params">size: ISizeData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSize</span> = size;
  }

  <span class="hljs-title function_">setSize</span>(<span class="hljs-params">size: ISizeData</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = size;
  }

  <span class="hljs-title function_">resetSize</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultSize</span>;
  }

  <span class="hljs-title function_">resetPosition</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> winWidth = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
    <span class="hljs-keyword">const</span> winHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
    <span class="hljs-keyword">const</span> { height, width } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevSize</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prevPosition</span> = {
      <span class="hljs-attr">x</span>: winWidth - width - <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultRightOffset</span>,
      <span class="hljs-attr">y</span>: winHeight - height - <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultBottomOffset</span>,
    };
  }

  <span class="hljs-comment">/**
   * 重置布局
   */</span>
  <span class="hljs-title function_">resetRect</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resetSize</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resetPosition</span>();
  }
}
</code></pre>
<p>使用示例：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Rnd</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-rnd"</span>;
<span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Form</span>,
  <span class="hljs-title class_">Input</span>,
  <span class="hljs-title class_">Checkbox</span>,
  <span class="hljs-title class_">Button</span>,
  <span class="hljs-title class_">Radio</span>,
  <span class="hljs-title class_">Collapse</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@arco-design/web-react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./DragForm.less"</span>;
<span class="hljs-keyword">import</span> { useRef, useState, useLayoutEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">HelpPanelRect</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"../utils/HelpPanelRect"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">FormItem</span> = <span class="hljs-title class_">Form</span>.<span class="hljs-property">Item</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RadioGroup</span> = <span class="hljs-title class_">Radio</span>.<span class="hljs-property">Group</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CollapseItem</span> = <span class="hljs-title class_">Collapse</span>.<span class="hljs-property">Item</span>;

<span class="hljs-keyword">const</span> helpPanelRect = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HelpPanelRect</span>({
  <span class="hljs-attr">defaultRightOffset</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">defaultBottomOffset</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">defaultTopOffset</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">defaultSize</span>: {
    <span class="hljs-attr">width</span>: <span class="hljs-number">400</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">300</span>,
  },
});

<span class="hljs-comment">/**
 *
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DragForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> panelRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 浮窗大小</span>
  <span class="hljs-keyword">const</span> [floatPanelSize, setFloatPanelSize] = <span class="hljs-title function_">useState</span>(
    helpPanelRect.<span class="hljs-property">defaultSize</span>
  );
  <span class="hljs-comment">// 浮窗坐标</span>
  <span class="hljs-keyword">const</span> [floatPanelPosition, setFloatPanelPosition] = <span class="hljs-title function_">useState</span>(
    helpPanelRect.<span class="hljs-title function_">getDefaultRect</span>().<span class="hljs-property">position</span>
  );

  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!panelRef.<span class="hljs-property">current</span>) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> target = panelRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">const</span> resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
        <span class="hljs-keyword">const</span> { width, height } = entry.<span class="hljs-property">contentRect</span>;
        <span class="hljs-keyword">if</span> (
          width === floatPanelSize.<span class="hljs-property">width</span> &amp;&amp;
          height === floatPanelSize.<span class="hljs-property">height</span>
        ) {
          <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-title function_">setFloatPanelSize</span>({ width, height });
        helpPanelRect.<span class="hljs-title function_">setDefaultSize</span>({ width, height });
        <span class="hljs-comment">// 更新面板高度</span>
        <span class="hljs-keyword">const</span> newSize = {
          ...floatPanelSize,
          height,
        };

        <span class="hljs-comment">// 获取当前位置并调整，确保面板不会超出视口</span>
        <span class="hljs-keyword">const</span> currentRect = helpPanelRect.<span class="hljs-title function_">getRectByResize</span>(
          floatPanelPosition,
          newSize
        );

        <span class="hljs-title function_">setFloatPanelSize</span>(currentRect.<span class="hljs-property">size</span>);
        <span class="hljs-title function_">setFloatPanelPosition</span>(currentRect.<span class="hljs-property">position</span>);
      }
    });
    <span class="hljs-keyword">if</span> (target) {
      resizeObserver.<span class="hljs-title function_">observe</span>(target);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      resizeObserver.<span class="hljs-title function_">disconnect</span>();
    };
  }, [panelRef, floatPanelSize, floatPanelPosition]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Rnd</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">pointerEvents:</span> "<span class="hljs-attr">all</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">101</span>,
      }}
      <span class="hljs-attr">className</span>=<span class="hljs-string">"float-panel"</span>
      <span class="hljs-attr">disableDragging</span>=<span class="hljs-string">{false}</span>
      <span class="hljs-attr">enableResizing</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">bottom:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">bottomLeft:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">bottomRight:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">right:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">top:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">topLeft:</span> <span class="hljs-attr">false</span>,
        <span class="hljs-attr">topRight:</span> <span class="hljs-attr">false</span>,
      }}
      <span class="hljs-attr">position</span>=<span class="hljs-string">{floatPanelPosition}</span>
      <span class="hljs-attr">size</span>=<span class="hljs-string">{floatPanelSize}</span>
      <span class="hljs-attr">maxWidth</span>=<span class="hljs-string">{helpPanelRect.maxWidth}</span>
      <span class="hljs-attr">maxHeight</span>=<span class="hljs-string">{helpPanelRect.maxHeight}</span>
      <span class="hljs-attr">minHeight</span>=<span class="hljs-string">{helpPanelRect.minHeight}</span>
      <span class="hljs-attr">minWidth</span>=<span class="hljs-string">{helpPanelRect.minWidth}</span>
      <span class="hljs-attr">onResizeStop</span>=<span class="hljs-string">{(e,</span> <span class="hljs-attr">direction</span>, <span class="hljs-attr">ref</span>, <span class="hljs-attr">delta</span>, <span class="hljs-attr">position</span>) =&gt;</span> {
        const currentRect = helpPanelRect.getRectByResize(position, {
          width: parseInt(ref.style.width, 10),
          height: parseInt(ref.style.height, 10),
        });
        setFloatPanelSize(currentRect.size);
        setFloatPanelPosition(currentRect.position);
      }}
      onDragStop={(e, data) =&gt; {
        const currentRect = helpPanelRect.getRectByPosition(data);
        setFloatPanelSize(currentRect.size);
        setFloatPanelPosition(currentRect.position);
      }}
      dragHandleClassName="drag__content"
    &gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{panelRef}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag__content"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"drag__header"</span>&gt;</span>拖动区域<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Collapse</span> <span class="hljs-attr">expandIcon</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"collapse__header"</span> <span class="hljs-attr">defaultActiveKey</span>=<span class="hljs-string">"1"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">CollapseItem</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"1"</span> <span class="hljs-attr">header</span>=<span class="hljs-string">"折叠面板"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">MyForm</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">CollapseItem</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Collapse</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Rnd</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Form</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">maxWidth:</span> <span class="hljs-attr">600</span>,
      }}
      <span class="hljs-attr">autoComplete</span>=<span class="hljs-string">"off"</span>
      <span class="hljs-attr">layout</span>=<span class="hljs-string">{</span>"<span class="hljs-attr">vertical</span>"}
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"Layout"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">RadioGroup</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"layout"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Radio</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"horizontal"</span>&gt;</span>horizontal<span class="hljs-tag">&lt;/<span class="hljs-name">Radio</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Radio</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"vertical"</span>&gt;</span>vertical<span class="hljs-tag">&lt;/<span class="hljs-name">Radio</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Radio</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"inline"</span>&gt;</span>inline<span class="hljs-tag">&lt;/<span class="hljs-name">Radio</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">RadioGroup</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"Username"</span>
        <span class="hljs-attr">field</span>=<span class="hljs-string">"username"</span>
        <span class="hljs-attr">tooltip</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Username is required <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        rules={[{ required: true }]}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> <span class="hljs-attr">270</span> }} <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"please enter your name"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"Post"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> <span class="hljs-attr">270</span> }} <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"please enter your post"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">wrapperCol</span>=<span class="hljs-string">{{}}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Checkbox</span>&gt;</span>I have read the manual<span class="hljs-tag">&lt;/<span class="hljs-name">Checkbox</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">FormItem</span> <span class="hljs-attr">wrapperCol</span>=<span class="hljs-string">{{}}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">htmlType</span>=<span class="hljs-string">"submit"</span>&gt;</span>
          Submit
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">FormItem</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Form</span>&gt;</span></span>
  );
}
</code></pre>
<p>上面的代码基本演示了 <code>HelpPanelRect</code> 的使用。</p>
<blockquote>
<p>PS: 第一步优化中监听 <code>Collapse</code> 的 <code>onChange</code> 事件来重新定位的实现被我改成了监听 ResizeObserver，这样可以解决真正展开、收起 <code>Collapse</code> 后误触发重新定位的bug</p>
</blockquote>
<h3 data-id="heading-8">最终效果</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08ebcd5e26dc4e979e7be900d93c5c2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB5LqR5LmL5LiK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399709&amp;x-signature=%2F2sxcZGv2yAKvP%2FmI8t0xFDoNfo%3D" alt="Kapture 2026-02-11 at 15.19.58.gif" loading="lazy"/></p>
<h2 data-id="heading-9">小结</h2>
<ol>
<li>全屏拖拽应该是很常见的功能，社区里也有很多好的实现，但是有特殊位置要求时就需要有额外开发；</li>
<li>文中的工具函数结合<code>react-rnd</code>可以适配很多拖拽时有边界控制的场景，希望给大家带来一点帮助。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent开发应知应会(Langfuse)：1.Langfuse的两种使用方式]]></title>    <link>https://juejin.cn/post/7605135197166272562</link>    <guid>https://juejin.cn/post/7605135197166272562</guid>    <pubDate>2026-02-11T06:04:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605135197166272562" data-draft-id="7605164560711122970" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent开发应知应会(Langfuse)：1.Langfuse的两种使用方式"/> <meta itemprop="keywords" content="LangChain,AI编程,AIGC"/> <meta itemprop="datePublished" content="2026-02-11T06:04:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zaizaizhao"/> <meta itemprop="url" content="https://juejin.cn/user/906425682113933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent开发应知应会(Langfuse)：1.Langfuse的两种使用方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/906425682113933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zaizaizhao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T06:04:08.000Z" title="Wed Feb 11 2026 06:04:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>最近在做一个 Text-to-SQL 的 Agent 项目 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzaizaizhao%2Feasysql" target="_blank" title="https://github.com/zaizaizhao/easysql" ref="nofollow noopener noreferrer">EasySQL</a></strong>，用 LangGraph 搭的状态机，跑通之后遇到一个头疼的问题：Agent 内部 LLM 调了几轮、每轮花了多少 Token、SQL 生成到底在哪一步挂的……全是黑盒，日志翻到眼花也拼不出完整链路。后来接了 Langfuse，瞬间清爽了。这篇文章就把我踩过的坑和两种接入方式整理一下，代码都是从项目里直接搬的。</p>
</blockquote>
<h4 data-id="heading-0">什么是langfuse</h4>
<p>Langfuse 是一个开源的 LLM 可观测性平台（LLM Observability Platform），专门为LLM 应用设计。它能自动捕获：</p>
<ul>
<li>每次 LLM 调用的输入/输出/Token 用量/延迟/成本</li>
<li>Agent 工具调用的完整链路追踪（Trace）</li>
<li>多步骤 Pipeline 中每个节点的耗时和状态</li>
</ul>
<p>可以把 Langfuse 理解为：给你的 AI Agent 装一个"黑匣子记录仪"。它主要做以下四件事</p>
<ol>
<li>Tracing:看到你的 Agent 每一步做了什么、花了多久、用了多少 Token</li>
<li>Evaluation:给每次调用打分——自动(LLM-as-Judge)、手动、或代码评分</li>
<li>Prompt Management:版本控制 prompt，A/B 测试不同 prompt 效果</li>
<li>Metrics &amp; Dashboards:聚合看成本、延迟、质量趋势</li>
</ol>
<p>核心数据模型（这是理解 Langfuse 一切的基础）：</p>
<h4 data-id="heading-1">langfuse核心数据模型</h4>
<p>Langfuse 的可观测性数据模型：</p>






























<table><thead><tr><th>SESSION</th><th>一个用户的多轮对话会话（可选）</th><th>用户打开聊天窗口到关闭的整个过程</th></tr></thead><tbody><tr><td>TRACE</td><td>一次完整的端到端请求</td><td>用户问"查询本月订单"，从接收到返回结果</td></tr><tr><td>SPAN</td><td>一个有开始/结束时间的工作单元</td><td>Schema 检索、Neo4j 查询、Prompt 构建</td></tr><tr><td>GENERATION</td><td>一次 LLM API 调用（最核心的观测类型）</td><td>调用 genimi-3-flash 生成 SQL</td></tr><tr><td>EVENT</td><td>一个时间点事件（无持续时间）</td><td>日志记录、异常捕获</td></tr></tbody></table>
<p>GENERATION 自动捕获的信息：</p>
<ul>
<li>
<p>输入/输出 Token 数</p>
</li>
<li>
<p>成本（$）</p>
</li>
<li>
<p>延迟（ms）</p>
</li>
<li>
<p>使用的模型名称</p>
</li>
<li>
<p>完整的 prompt 和 completion</p>
</li>
</ul>
<p>Observations 可以无限嵌套——一个 SPAN 内可以包含子 SPAN、GENERATION、EVENT 等，形成树状结构。SCORE（评分） 可以附加在 TRACE 或 OBSERVATION 上，支持 NUMERIC（数值）、BOOLEAN（布尔）、CATEGORICAL（分类）三种类型，用于评估质量。</p>
<h3 data-id="heading-2">一. 自动callback实现Langfuse集成</h3>
<h5 data-id="heading-3">原理</h5>
<p>利用 LangChain 框架内置的 callback 机制，Langfuse 提供一个 CallbackHandler，传入 invoke() 的 config 中。LangChain/LangGraph执行过程中的每个事件（LLM 调用、工具调用、链执行等）都会自动触发 callback，Langfuse 据此构建完整的 Trace 树。</p>
<h4 data-id="heading-4">项目使用</h4>
<h5 data-id="heading-5">配置层</h5>
<p>定义配置类</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LangfuseConfig</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    <span class="hljs-string">"""
    Configuration for LangFuse observability.

    LangFuse provides tracing and monitoring for LLM applications.
    All settings can be overridden via LANGFUSE_* environment variables.
    """</span>

    model_config = SettingsConfigDict(env_file=<span class="hljs-string">".env"</span>, env_file_encoding=<span class="hljs-string">"utf-8"</span>, extra=<span class="hljs-string">"ignore"</span>)

    enabled: <span class="hljs-built_in">bool</span> = Field(
        default=<span class="hljs-literal">False</span>, alias=<span class="hljs-string">"langfuse_enabled"</span>, description=<span class="hljs-string">"Enable LangFuse tracing"</span>
    )
    public_key: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Field(
        default=<span class="hljs-literal">None</span>, alias=<span class="hljs-string">"langfuse_public_key"</span>, description=<span class="hljs-string">"LangFuse public key"</span>
    )
    secret_key: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Field(
        default=<span class="hljs-literal">None</span>, alias=<span class="hljs-string">"langfuse_secret_key"</span>, description=<span class="hljs-string">"LangFuse secret key"</span>
    )
    host: <span class="hljs-built_in">str</span> = Field(
        default=<span class="hljs-string">"https://cloud.langfuse.com"</span>,
        alias=<span class="hljs-string">"langfuse_host"</span>,
        description=<span class="hljs-string">"LangFuse host URL (cloud or self-hosted)"</span>,
    )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">is_configured</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""Check if LangFuse is properly configured with required credentials."""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bool</span>(self.enabled <span class="hljs-keyword">and</span> self.public_key <span class="hljs-keyword">and</span> self.secret_key)
</code></pre>
<ul>
<li>enabled：总开关，读取环境变量 LANGFUSE_ENABLED，默认 false</li>
<li>public_key / secret_key：Langfuse 项目的 API 密钥对，在 Langfuse 仪表盘的 Settings → API Keys 中生成</li>
<li>host：Langfuse 服务地址。如果用 Langfuse Cloud 就是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.langfuse.com%25EF%25BC%259B%25E5%25A6%2582%25E6%259E%259C%25E8%2587%25AA%25E5%25BB%25BA%25E5%25B0%25B1%25E5%25A1%25AB%25E4%25BD%25A0%25E8%2587%25AA%25E5%25B7%25B1%25E7%259A%2584%25E5%259C%25B0%25E5%259D%2580%25E5%25A6%2582" target="_blank" title="https://cloud.langfuse.com%EF%BC%9B%E5%A6%82%E6%9E%9C%E8%87%AA%E5%BB%BA%E5%B0%B1%E5%A1%AB%E4%BD%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E5%9C%B0%E5%9D%80%E5%A6%82" ref="nofollow noopener noreferrer">cloud.langfuse.com如果自建就填你自己的地址如</a> <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a></li>
<li>is_configured()：三个条件全满足才算配置完成——enabled=true 且两个 key 都有值</li>
</ul>
<p>代码中通过 get_settings().langfuse.is_configured() 来判断是否启用。</p>
<h5 data-id="heading-6">callback工厂函数</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_langfuse_callbacks</span>() -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-type">Any</span>]:
    <span class="hljs-string">"""Get LangFuse callback handlers if configured."""</span>
    settings = get_settings()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.langfuse.is_configured():
        <span class="hljs-keyword">return</span> []                          <span class="hljs-comment"># ← 未配置则返回空列表，不影响正常运行</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">import</span> os
        <span class="hljs-keyword">from</span> langfuse.langchain <span class="hljs-keyword">import</span> CallbackHandler   <span class="hljs-comment"># ← 关键：LangChain 回调处理器</span>
        os.environ.setdefault(<span class="hljs-string">"LANGFUSE_PUBLIC_KEY"</span>, settings.langfuse.public_key <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>)
        os.environ.setdefault(<span class="hljs-string">"LANGFUSE_SECRET_KEY"</span>, settings.langfuse.secret_key <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>)
        os.environ.setdefault(<span class="hljs-string">"LANGFUSE_HOST"</span>, settings.langfuse.host)
        <span class="hljs-keyword">return</span> [CallbackHandler()]         <span class="hljs-comment"># ← 返回一个 CallbackHandler 实例</span>
    <span class="hljs-keyword">except</span> ImportError:
        logger.warning(<span class="hljs-string">"langfuse package not installed, tracing disabled"</span>)
        <span class="hljs-keyword">return</span> []
</code></pre>
<p>这里发生了什么？</p>
<ol>
<li>先检查配置是否完整，不完整就返回空 []</li>
<li>将配置中的密钥写入环境变量（os.environ.setdefault）。这是因为 CallbackHandler() 在实例化时会自动从环境变量读取 LANGFUSE_PUBLIC_KEY、LANGFUSE_SECRET_KEY、LANGFUSE_HOST</li>
<li>创建 CallbackHandler() 实例并返回。这个 Handler 实现了 LangChain 的 BaseCallbackHandler 接口，会自动拦截所有 LangChain/LangGraph 的事件（LLM 调用开始/结束、工具调用、链执行等）</li>
</ol>
<p>CallbackHandler 能自动捕获什么？</p>
<ul>
<li>每个 LLM 调用的 prompt、completion、model name、token 数、延迟</li>
<li>每个 tool 调用的输入输出</li>
<li>LangGraph 中每个 node 的执行流程</li>
<li>错误和异常</li>
</ul>
<h5 data-id="heading-7">注入到 LangGraph 执行</h5>
<p>首先需要在将上面的callbacks写入到agent调用的传参RunnableConfig对象中。也就是RunnableConfig源码定义中的callbacks中</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RunnableConfig</span>(TypedDict, total=<span class="hljs-literal">False</span>):
    <span class="hljs-string">"""Configuration for a `Runnable`.

    See the [reference docs](https://reference.langchain.com/python/langchain_core/runnables/#langchain_core.runnables.RunnableConfig)
    for more details.
    """</span>

    tags: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>]
    <span class="hljs-string">"""Tags for this call and any sub-calls (e.g. a Chain calling an LLM).

    You can use these to filter calls.
    """</span>

    metadata: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]
    <span class="hljs-string">"""Metadata for this call and any sub-calls (e.g. a Chain calling an LLM).

    Keys should be strings, values should be JSON-serializable.
    """</span>

    callbacks: Callbacks
    <span class="hljs-string">"""Callbacks for this call and any sub-calls (e.g. a Chain calling an LLM).

    Tags are passed to all callbacks, metadata is passed to handle*Start callbacks.
    """</span>

    run_name: <span class="hljs-built_in">str</span>
    <span class="hljs-string">"""Name for the tracer run for this call.

    Defaults to the name of the class."""</span>
</code></pre>
<p>项目代码抽取了一层专门做RunnableConfig配置的构建</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">QueryService</span>:

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, repository: SessionRepository</span>) -&gt; <span class="hljs-literal">None</span>:
        self._graph: <span class="hljs-type">Any</span> = <span class="hljs-literal">None</span>
        self._repo = repository
        self._callbacks: <span class="hljs-built_in">list</span>[<span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">callbacks</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">list</span>[<span class="hljs-type">Any</span>]:
        <span class="hljs-keyword">if</span> self._callbacks <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self._callbacks = get_langfuse_callbacks()   <span class="hljs-comment"># ← 懒加载，只初始化一次</span>
        <span class="hljs-keyword">return</span> self._callbacks

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_make_config</span>(<span class="hljs-params">self, session_id: <span class="hljs-built_in">str</span>, thread_id: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span></span>) -&gt; RunnableConfig:
        effective_thread_id = thread_id <span class="hljs-keyword">or</span> session_id
        config: RunnableConfig = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: effective_thread_id}}
        <span class="hljs-keyword">if</span> self.callbacks:
            config[<span class="hljs-string">"callbacks"</span>] = self.callbacks
            logger.debug(<span class="hljs-string">f"LangFuse callbacks attached: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(self.callbacks)}</span> handler(s)"</span>)
        <span class="hljs-keyword">return</span> config
</code></pre>
<p>agent调用的时候传入</p>
<pre><code class="hljs language-python" lang="python">            <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> self.graph.astream(
                input_state,
                self._make_config(session.session_id, effective_thread_id),
                stream_mode=[<span class="hljs-string">"updates"</span>, <span class="hljs-string">"custom"</span>],
            ):
</code></pre>
<p>graph.astream会发生如下流程</p>
<ol>
<li>LangGraph 内部读取 config["callbacks"]</li>
<li>每个 node/LLM 调用都触发 CallbackHandler 的回调方法</li>
<li>CallbackHandler 将事件发送到 Langfuse 服务</li>
</ol>
<h5 data-id="heading-8">缺点：</h5>
<ul>
<li>只能追踪 LangChain/LangGraph 内部 —— 框架外的自定义 Python 代码（如 Milvus 查询、Neo4j 查询）不可见</li>
<li>Trace 结构由框架决定 —— 控制力有限，命名和层级结构取决于 LangChain 的回调事件</li>
</ul>
<h3 data-id="heading-9">二. 手动Span追踪</h3>
<h4 data-id="heading-10">原理：</h4>
<p>直接使用 Langfuse SDK，通过 <code>@observe()</code> 装饰器或 <code>start_as_current_observation() </code>上下文管理器，手动控制 Trace 和 Span的创建。被装饰的函数自动形成父子嵌套关系。</p>
<h4 data-id="heading-11">我这里为什么需要手动Span</h4>
<p>Agent 内部的多轮迭代中每一步（LLM 调用、工具调用）已经被 CallbackHandler 自动追踪。手动 Span的目的不是追踪这些步骤本身，而是在这些细粒度追踪之上添加一个业务语义的汇总节点——直接记录最终 SQL、是否通过验证、总共迭代了几轮，这样Langfuse UI 中不需要逐条翻看就能快速了解这次 Agent 执行的结果。</p>
<p>也就是说，我希望提供一个结果汇总层，而非追踪流程本身，成功时展示如下</p>
<pre><code class="hljs language-python" lang="python">span.update(output={
      <span class="hljs-string">"sql"</span>: last_sql,
      <span class="hljs-string">"success"</span>: validation_passed,
      <span class="hljs-string">"iterations"</span>: iteration,
  })
</code></pre>
<p>失败时展示如下</p>
<pre><code class="hljs language-python" lang="python">span.update(output={<span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)}, level=<span class="hljs-string">"ERROR"</span>)
</code></pre>
<p>因此手动创建 span 可以：</p>
<ul>
<li>自定义记录初始输入（用户查询、数据库名）</li>
<li>在 Langfuse UI 中清晰地看到"SQL Agent 执行"这个整体以及自定义的信息，而不仅仅是零散的 LLM 调用</li>
</ul>
<h4 data-id="heading-12">项目使用</h4>
<ol>
<li>获取langfuse客户端</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_langfuse_client</span>():
    <span class="hljs-string">"""获取 Langfuse 全局客户端（单例模式）"""</span>
    settings = get_settings()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.langfuse.is_configured():
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">from</span> langfuse <span class="hljs-keyword">import</span> get_client       <span class="hljs-comment"># ← v3 SDK 的单例获取方法</span>
        <span class="hljs-keyword">return</span> get_client()
    <span class="hljs-keyword">except</span> ImportError:
        logger.debug(<span class="hljs-string">"Langfuse not installed, skipping tracing"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.debug(<span class="hljs-string">f"Failed to get Langfuse client: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<ol start="2">
<li>创建Span类型的观察对象</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@contextmanager</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">_langfuse_span</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, **kwargs</span>):
    <span class="hljs-string">"""创建一个 Langfuse Span 的上下文管理器"""</span>
    langfuse = _get_langfuse_client()
    <span class="hljs-keyword">if</span> langfuse <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        <span class="hljs-keyword">yield</span> <span class="hljs-literal">None</span>                             <span class="hljs-comment"># ← 未配置时优雅退化，不影响业务</span>
        <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">with</span> langfuse.start_as_current_observation(
            as_type=<span class="hljs-string">"span"</span>,                    <span class="hljs-comment"># ← 创建 SPAN 类型的观察</span>
            name=name,                         <span class="hljs-comment"># ← Span 名称，如 "sql-agent-execution"</span>
            **kwargs,                          <span class="hljs-comment"># ← 额外参数如 input</span>
        ) <span class="hljs-keyword">as</span> span:
            <span class="hljs-keyword">yield</span> span
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.debug(<span class="hljs-string">f"Langfuse span creation failed: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">yield</span> <span class="hljs-literal">None</span>
</code></pre>
<ol start="3">
<li>使用</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, state, config, *, writer=<span class="hljs-literal">None</span></span>):
    <span class="hljs-comment"># ...</span>
    <span class="hljs-keyword">with</span> _langfuse_span(
        <span class="hljs-string">"sql-agent-execution"</span>,                              <span class="hljs-comment"># ← Span 名称</span>
        <span class="hljs-built_in">input</span>={<span class="hljs-string">"query"</span>: raw_query, <span class="hljs-string">"db_name"</span>: db_name},     <span class="hljs-comment"># ← 记录输入</span>
    ) <span class="hljs-keyword">as</span> span:
        <span class="hljs-comment"># ... SQL Agent 的整个迭代循环在这个 span 内 ...</span>
        <span class="hljs-comment"># 每次迭代：LLM 调用 → 工具调用 → 验证 → 可能修复</span>
        <span class="hljs-comment"># 成功时更新 Span 输出：</span>
        <span class="hljs-keyword">if</span> span:
            span.update(
                output={
                    <span class="hljs-string">"sql"</span>: last_sql,               <span class="hljs-comment"># 最终生成的 SQL</span>
                    <span class="hljs-string">"success"</span>: validation_passed,   <span class="hljs-comment"># 验证是否通过</span>
                    <span class="hljs-string">"iterations"</span>: iteration,        <span class="hljs-comment"># 迭代了几轮</span>
                }
            )
        <span class="hljs-comment"># 异常时标记为错误：</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">if</span> span:
                span.update(output={<span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)}, level=<span class="hljs-string">"ERROR"</span>)
</code></pre>
<p>这段代码做了什么？<br/>
它为整个 SQL Agent 的执行创建了一个命名为 "sql-agent-execution" 的 SPAN。这个 Span：</p>
<ul>
<li>输入：记录用户的原始问题和目标数据库名</li>
<li>输出：记录最终 SQL、是否验证通过、总共迭代了多少轮</li>
<li>错误：如果出异常，标记为 ERROR 级别</li>
</ul>
<p>手动 Span 的价值不在于追踪链路本身（CallbackHandler 已经覆盖了），而在于提供一个汇总视图：在 Langfuse UI 中点开一个 Trace，直接在sql-agent-execution 这个 Span 的 output 里就能看到 {sql: "...", success: true, iterations: 2}，不需要逐个翻看子节点去拼凑结论。</p>
<h4 data-id="heading-13">langfuse界面</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15646f4c4eb64c78af4a76e5570848b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgemFpemFpemhhbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399753&amp;x-signature=%2BuYYTU12LsZG0goVsHVHUcYUy3A%3D" alt="d6daef7046e4b00482ec778023509c8a.png" loading="lazy"/></p>
<ol>
<li>在 sql_agent 节点下多了一个并列的 Span，携带了 input={query, db_name} 和 output={sql, success, iterations} 的汇总信息</li>
<li>但它没有包裹住 LLM 调用和 Tool 调用，所以不构成层级关系</li>
<li>它只是一个独立的"信息标注节点"，挂在 sql_agent 下面</li>
</ol>
<p>如果想让手动 Span 真正成为 LLM 调用和 Tool 调用（如以上validate_sql）的父级，需要让 CallbackHandler 感知到手动 Span 的上下文。Langfuse官方文档中给出的做法是结合 propagate_attributes 使用：</p>
<pre><code class="hljs language-python" lang="python">  <span class="hljs-keyword">from</span> langfuse <span class="hljs-keyword">import</span> get_client, propagate_attributes
  <span class="hljs-keyword">from</span> langfuse.langchain <span class="hljs-keyword">import</span> CallbackHandler
  langfuse = get_client()
  <span class="hljs-keyword">with</span> langfuse.start_as_current_observation(as_type=<span class="hljs-string">"span"</span>, name=<span class="hljs-string">"sql-agent-execution"</span>):
      <span class="hljs-keyword">with</span> propagate_attributes():
          handler = CallbackHandler()  <span class="hljs-comment"># 在这里创建 handler，它会继承当前 span 作为 parent</span>
          <span class="hljs-comment"># 然后把 handler 传入 LLM 调用...</span>
</code></pre>
<p>但我的项目中 CallbackHandler() 是在 get_langfuse_callbacks() 中提前创建好的，然后通过 config["callbacks"] 传入 LangGraph，并非在手动Span 上下文内创建，所以两者无法建立父子关系，而是自定义的Span自动使用了根CallbackHandler()创建的上下文 ，这里就涉及到OpenTelemetry (OTEL)了，OpenTelemetry 是一个厂商中立的开源可观测性框架，它解决问题就是在分布式系统中，把散落在各处的监控数据关联起来，还原出完整的请求路径。</p>
<h6 data-id="heading-14">完整官方示例</h6>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langfuse <span class="hljs-keyword">import</span> observe, get_client, propagate_attributes
<span class="hljs-keyword">from</span> langfuse.langchain <span class="hljs-keyword">import</span> CallbackHandler
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate

<span class="hljs-meta">@observe() </span><span class="hljs-comment"># Automatically log function as a trace to Langfuse</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_user_query</span>(<span class="hljs-params">user_input: <span class="hljs-built_in">str</span></span>):
    langfuse = get_client()

    <span class="hljs-comment"># Propagate trace attributes to all child observations</span>
    <span class="hljs-keyword">with</span> propagate_attributes(
        session_id=<span class="hljs-string">"session-1234"</span>,
        user_id=<span class="hljs-string">"user-5678"</span>,
    ):

      <span class="hljs-comment"># Initialize the Langfuse handler - automatically inherits the current trace context</span>
      langfuse_handler = CallbackHandler()

      <span class="hljs-comment"># Your Langchain code - will be nested under the @observe trace</span>
      llm = ChatOpenAI(model_name=<span class="hljs-string">"gpt-4o"</span>)
      prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"Respond to: {input}"</span>)
      chain = prompt | llm

      result = chain.invoke({<span class="hljs-string">"input"</span>: user_input}, config={<span class="hljs-string">"callbacks"</span>: [langfuse_handler]})

      <span class="hljs-comment"># Update trace with input and final output</span>
      langfuse.update_current_trace(
        name=<span class="hljs-string">"user-query-processing"</span>,
        <span class="hljs-built_in">input</span>={<span class="hljs-string">"query"</span>: user_input},
        output={<span class="hljs-string">"response"</span>: result.content},
        )

    <span class="hljs-keyword">return</span> result.content

<span class="hljs-comment"># Usage</span>
answer = process_user_query(<span class="hljs-string">"What is the capital of France?"</span>)
</code></pre>
<h4 data-id="heading-15">总结</h4>
<p>本文介绍了在 Agent 开发中集成 Langfuse 可观测性的两种方式：</p>























<table><thead><tr><th>方式</th><th>适用场景</th><th>优点</th><th>局限</th></tr></thead><tbody><tr><td><strong>自动 Callback</strong></td><td>快速接入，追踪 LangChain/LangGraph 内部链路</td><td>零侵入、开箱即用</td><td>只能追踪框架内部，自定义逻辑不可见</td></tr><tr><td><strong>手动 Span</strong></td><td>需要业务语义汇总、追踪框架外逻辑</td><td>完全可控，可自定义输入输出</td><td>需要手动管理上下文</td></tr></tbody></table>
<p>实际项目中，<strong>两者结合使用</strong>是最佳实践：Callback 负责自动追踪 LLM 调用和工具调用的细粒度链路，手动 Span 负责在此之上附加业务维度的汇总信息（如最终 SQL、验证结果、迭代轮次），让 Langfuse Dashboard 既有深度又有概览。</p>
<p>以上所有代码示例均来自我的开源项目 <strong>EasySQL</strong> —— 一个 Text-to-SQL 智能体分析应用，项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzaizaizhao%2Feasysql" target="_blank" title="https://github.com/zaizaizhao/easysql" ref="nofollow noopener noreferrer">github.com/zaizaizhao/…</a>。项目主要技术栈包括：</p>
<ul>
<li><strong>LangGraph</strong>：构建多步骤 Agent 状态机，支持条件路由、Human-in-the-Loop 澄清、SQL 生成→验证→修复的迭代循环</li>
<li><strong>LangChain</strong>：LLM 调用抽象与 RunnableConfig 配置传递</li>
<li><strong>Langfuse</strong>：Callback + 手动 Span 双模式可观测性，实现全链路追踪与业务汇总</li>
<li><strong>PostgreSQL + AsyncPostgresSaver</strong>：LangGraph Checkpointer 状态持久化，支持多轮对话上下文</li>
<li><strong>FastAPI + Uvicorn</strong>：异步 API 服务层，提供流式 SSE 响应</li>
<li><strong>Milvus</strong>：向量数据库，用于 Schema 语义检索</li>
<li><strong>Neo4j</strong>： 图数据库，用于知识图谱构建</li>
<li><strong>Pydantic Settings</strong>：类型安全的配置管理，支持环境变量覆盖</li>
</ul>
<p>欢迎 Star ⭐ 和交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Agent Teams使用方法]]></title>    <link>https://juejin.cn/post/7605131777175388223</link>    <guid>https://juejin.cn/post/7605131777175388223</guid>    <pubDate>2026-02-11T07:30:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605131777175388223" data-draft-id="7605051886435188799" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Agent Teams使用方法"/> <meta itemprop="keywords" content="Claude"/> <meta itemprop="datePublished" content="2026-02-11T07:30:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="anjushi"/> <meta itemprop="url" content="https://juejin.cn/user/3479331676363320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Agent Teams使用方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3479331676363320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    anjushi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:30:50.000Z" title="Wed Feb 11 2026 07:30:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Agent Teams</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.claude.com%2Fdocs%2Fzh-CN%2Fagent-teams" target="_blank" title="https://code.claude.com/docs/zh-CN/agent-teams" ref="nofollow noopener noreferrer">code.claude.com/docs/zh-CN/…</a></p>
<p>和 subagent 最本质的区别是：<strong>teammate 之间可以直接通信</strong>。subagent 只能把结果报告给主 Agent，是单向的上报关系；而 Agent Teams 里的队员可以互相发消息</p>
<h3 data-id="heading-1">开启</h3>
<p>设置环境变量： <code>/Users/xxx/.claude/settings.json</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-2">tmux分屏</h3>
<p>官方文档提供了两种使用方式：</p>
<ul>
<li><strong>In-process 模式</strong></li>
<li><strong>Split-pane 模式</strong>（更友好，推荐）</li>
</ul>
<p>默认为 <code>"auto"</code> ——</p>
<ul>
<li>如果在 tmux 会话内：自动使用分屏模式</li>
<li>如果不在 tmux 内：使用 in-process 模式</li>
</ul>
<p>可通过以下方式强制指定：</p>
<ul>
<li>settings.json：<code>"teammateMode": "in-process"</code> 或 <code>"tmux"</code></li>
<li>命令行：<code>claude --teammate-mode in-process</code></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftmux%2Ftmux%2Fwiki%2FInstalling" target="_blank" title="https://github.com/tmux/tmux/wiki/Installing" ref="nofollow noopener noreferrer">github.com/tmux/tmux/w…</a></p>
<p>安装tmux</p>
<pre><code class="hljs">brew install tmux
</code></pre>
<p>新建session</p>
<pre><code class="hljs language-arduino" lang="arduino">tmux <span class="hljs-keyword">new</span> -s team
</code></pre>
<p>重新进入</p>
<pre><code class="hljs language-arduino" lang="arduino">tmux attach -t team
</code></pre>
<p>切换窗格有一个需要注意的地方，Ctrl+B 之后需要<strong>松开键盘</strong>，再通过⬆️⬇️⬅️➡️来选择当前窗格</p>
<h3 data-id="heading-3">使用</h3>
<p>使用如下提示词</p>
<pre><code class="hljs language-diff" lang="diff">创建一个 agent team
<span class="hljs-deletion">- 一个需求分析和提供 </span>
<span class="hljs-deletion">- 一个进行前端开发 </span>
<span class="hljs-deletion">- 一个进行后端开发 </span>
让他们各自开发前后端并进行接口对接，帮我完善我的agent team创建
</code></pre>
<p>需要注意的是，分屏是claudecode自行创建的，不需要手动创建</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7bb5faeb16245e0980a2baeecc98777~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW5qdXNoaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399849&amp;x-signature=IMjOmwIDSOZm84JWSOjmeb9ZLrw%3D" alt="" width="100%" align="center" loading="lazy"/>
<p>可以在team leader中调用，也可以直接和单个agent对话完成任务 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c409a712f05d428cbf69cf4438ad24c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW5qdXNoaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399849&amp;x-signature=hUVcWlarCuJOLVsMBs%2BirZTG4N4%3D" alt="" width="40%" align="center" loading="lazy"/></p>
<p>team生成后会存储在 <code>~/.claude/teams/{team-name}/config.json</code> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/632e62f043d748f7b89065aa60631fc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW5qdXNoaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399849&amp;x-signature=nAt%2B5dwKhBnvDtNb7RsKSEl2888%3D" alt="" width="60%" align="center" loading="lazy"/></p>
<h3 data-id="heading-4">退出agent team</h3>
<p>在team leader也就是主窗口要求关闭，其他分窗口会逐个关闭 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c678ae6e5e0449f84404ec6a13c2887~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW5qdXNoaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399849&amp;x-signature=z4Xw%2BfKdgG9sVazQfpnH3l8TciM%3D" alt="" width="40%" align="center" loading="lazy"/></p>
<p>关闭前的分窗口会显示如下 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34400a5d8ad14203b465568ba29b2898~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYW5qdXNoaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771399849&amp;x-signature=YxZKE6iPPDqhNcrVr%2FB3dRi7%2F6E%3D" alt="" width="80%" align="center" loading="lazy"/></p>
<p>agentteam本质是一次 <strong>workflow run</strong>，不是长期在线团队
最好的使用方法是：<strong>声明仅启动agent但不声明任务，不自动结束</strong>，也就是让这次任务一直在进行中，然后在team leader 或 agent 中下发任务</p>
<p>claude对话也可以暂存，使用如下命令可以重新进入</p>
<pre><code class="hljs language-css" lang="css">claude <span class="hljs-attr">--resume</span>
</code></pre>
<p>需要注意的是，agentteam模式对token的消耗要比普通模式多很多</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mac端为claude code配置ida mcp]]></title>    <link>https://juejin.cn/post/7605140481488306217</link>    <guid>https://juejin.cn/post/7605140481488306217</guid>    <pubDate>2026-02-11T07:23:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605140481488306217" data-draft-id="7605150769008181291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mac端为claude code配置ida mcp"/> <meta itemprop="keywords" content="macOS,Claude"/> <meta itemprop="datePublished" content="2026-02-11T07:23:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逆向APP"/> <meta itemprop="url" content="https://juejin.cn/user/2999123452370679"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mac端为claude code配置ida mcp
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123452370679/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逆向APP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:23:17.000Z" title="Wed Feb 11 2026 07:23:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>（1）在终端进入ida的路径 </p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /Applications/IDA\ Professional\ 9.0.app/Contents/MacOS 

</code></pre>
<p> （2）为ida设置python </p>
<pre><code class="hljs language-bash" lang="bash">./idapyswitch --force-path /opt/homebrew/Cellar/python@3.11/3.11.12/Frameworks/Python.framework/Versions/3.11/Python 
</code></pre>
<p> （3）在终端执行安装ida mcp </p>
<pre><code class="hljs language-arduino" lang="arduino">pip3<span class="hljs-number">.11</span> install --upgrade git+https:<span class="hljs-comment">//github.com/mrexodia/ida-pro-mcp </span>

</code></pre>
<p> 验证：</p>
<pre><code class="hljs language-bash" lang="bash">ida-pro-mcp --<span class="hljs-built_in">help</span> 

</code></pre>
<p> （4）安装Ida插件 </p>
<pre><code class="hljs language-css" lang="css"> ida-pro-mcp <span class="hljs-attr">--install</span> 

</code></pre>
<p>（5）配置ida mcp的信息</p>
<pre><code class="hljs language-css" lang="css">% ida-pro-mcp <span class="hljs-attr">--config</span>
<span class="hljs-selector-attr">[HTTP MCP CONFIGURATION]</span>
{
  "mcpServers": {
    "ida-pro-mcp": {
      "type": <span class="hljs-string">"http"</span>,
      <span class="hljs-string">"url"</span>: <span class="hljs-string">"http://127.0.0.1:13337/mcp"</span>
    }
  }
}

<span class="hljs-selector-attr">[STDIO MCP CONFIGURATION]</span>
{
  "mcpServers": {
    "ida-pro-mcp": {
      "command": <span class="hljs-string">"/opt/homebrew/opt/python@3.11/bin/python3.11"</span>,
      <span class="hljs-string">"args"</span>: [
        <span class="hljs-string">"/opt/homebrew/lib/python3.11/site-packages/ida_pro_mcp/server.py"</span>,
        <span class="hljs-string">"--ida-rpc"</span>,
        <span class="hljs-string">"http://127.0.0.1:13337"</span>
      ]
    }
  }
}
</code></pre>
<p> （6）IDA中启动MCP</p>
<p>插件只是加载了，但默认不会自动启动 RPC。 </p>
<p>你需要在 IDA 里手动启动一次 MCP 插件，端口才会监听。 </p>
<p> 请在 IDA 执行：</p>
<pre><code class="hljs language-rust" lang="rust"> 菜单：Edit <span class="hljs-punctuation">-&gt;</span> Plugins <span class="hljs-punctuation">-&gt;</span> MCP 

</code></pre>
<p>或者快捷键：Ctrl-Alt-M（mac 上 Alt 通常是 Option）</p>
<p>(7)重启Claude Code后，查看可用的MCP列表</p>
<p>输入命令：</p>
<pre><code class="hljs language-arduino" lang="arduino">List available MCP tools

</code></pre>
<p>输出：</p>
<pre><code class="hljs language-arduino" lang="arduino">❯ List available MCP tools                                                                 
                                                                                           
⏺ 以下是当前会话中可用的 IDA Pro MCP 工具列表：                                            
                                                                                           
  查找与导航工具                                                                           
  ┌──────────────────────────────────┬────────────────────────────────┐                    
  │              工具名              │              功能              │                    
  ├──────────────────────────────────┼────────────────────────────────┤                    
  │ mcp__ida-pro-mcp__lookup_funcs   │ 按地址或名称查找函数           │                    
  ├──────────────────────────────────┼────────────────────────────────┤                    
  │ mcp__ida-pro-mcp__list_funcs     │ 列出函数（支持过滤和分页）     │                    
  ├──────────────────────────────────┼────────────────────────────────┤                    
  │ mcp__ida-pro-mcp__list_globals   │ 列出全局变量（支持过滤和分页） │                    
  ├──────────────────────────────────┼────────────────────────────────┤                    
  │ mcp__ida-pro-mcp__imports        │ 列出导入函数                   │                    
  ├──────────────────────────────────┼────────────────────────────────┤                    
  │ mcp__ida-pro-mcp__basic_blocks   │ 获取函数的基本块用于控制流图   │                    
  ├──────────────────────────────────┼────────────────────────────────┤                    
  │ mcp__ida-pro-mcp__search_structs │ 搜索结构体                     │                    
  └──────────────────────────────────┴────────────────────────────────┘                    
  反编译与汇编工具                                                                         
  ┌────────────────────────────────┬────────────────────────┐                              
  │             工具名             │          功能          │                              
  ├────────────────────────────────┼────────────────────────┤                              
  │ mcp__ida-pro-mcp__decompile    │ 将函数反编译为伪代码   │                              
  ├────────────────────────────────┼────────────────────────┤                              
  │ mcp__ida-pro-mcp__disasm       │ 将函数反汇编为汇编指令 │                              
  ├────────────────────────────────┼────────────────────────┤                              
  │ mcp__ida-pro-mcp__declare_type │ 声明类型               │                              
  ├────────────────────────────────┼────────────────────────┤                              
  │ mcp__ida-pro-mcp__infer_types  │ 推断类型               │                              
  └────────────────────────────────┴────────────────────────┘                              
  交叉引用与调用图                                                                         
  ┌──────────────────────────────────┬────────────────────────────┐                        
  │              工具名              │            功能            │                        
  ├──────────────────────────────────┼────────────────────────────┤                        
  │ mcp__ida-pro-mcp__xrefs_to       │ 获取到指定地址的交叉引用   │                        
  ├──────────────────────────────────┼────────────────────────────┤                        
  │ mcp__ida-pro-mcp__xrefs_to_field │ 获取到结构体字段的交叉引用 │                        
  ├──────────────────────────────────┼────────────────────────────┤                        
  │ mcp__ida-pro-mcp__callees        │ 获取指定函数调用的函数     │                        
  ├──────────────────────────────────┼────────────────────────────┤                        
  │ mcp__ida-pro-mcp__callgraph      │ 从根函数构建调用图         │                        
  └──────────────────────────────────┴────────────────────────────┘                        
  搜索工具                                                                                 
  ┌──────────────────────────────┬────────────────────────────┐                            
  │            工具名            │            功能            │                            
  ├──────────────────────────────┼────────────────────────────┤                            
  │ mcp__ida-pro-mcp__find       │ 搜索字节数据               │                            
  ├──────────────────────────────┼────────────────────────────┤                            
  │ mcp__ida-pro-mcp__find_regex │ 使用正则表达式搜索字符串   │                            
  ├──────────────────────────────┼────────────────────────────┤                            
  │ mcp__ida-pro-mcp__find_bytes │ 搜索字节模式（支持通配符） │                            
  └──────────────────────────────┴────────────────────────────┘                            
  内存读取与数据获取                                                                       
  ┌────────────────────────────────────┬────────────────────────────┐                      
  │               工具名               │            功能            │                      
  ├────────────────────────────────────┼────────────────────────────┤                      
  │ mcp__ida-pro-mcp__get_bytes        │ 从内存地址读取字节         │                      
  ├────────────────────────────────────┼────────────────────────────┤                      
  │ mcp__ida-pro-mcp__get_int          │ 从内存地址读取整数值       │                      
  ├────────────────────────────────────┼────────────────────────────┤                      
  │ mcp__ida-pro-mcp__get_string       │ 从内存地址读取字符串       │                      
  ├────────────────────────────────────┼────────────────────────────┤                      
  │ mcp__ida-pro-mcp__get_global_value │ 按地址或名称读取全局变量值 │                      
  ├────────────────────────────────────┼────────────────────────────┤                      
  │ mcp__ida-pro-mcp__read_struct      │ 读取结构体类型并解析内存值 │                      
  └────────────────────────────────────┴────────────────────────────┘                      
  修改与编辑工具                                                                           
  ┌────────────────────────────────┬────────────────────────────────────────────┐          
  │             工具名             │                    功能                    │          
  ├────────────────────────────────┼────────────────────────────────────────────┤          
  │ mcp__ida-pro-mcp__patch        │ 用十六进制数据在内存地址打补丁             │          
  ├────────────────────────────────┼────────────────────────────────────────────┤          
  │ mcp__ida-pro-mcp__patch_asm    │ 用汇编指令在地址打补丁                     │          
  ├────────────────────────────────┼────────────────────────────────────────────┤          
  │ mcp__ida-pro-mcp__put_int      │ 将整数值写入内存地址                       │          
  ├────────────────────────────────┼────────────────────────────────────────────┤          
  │ mcp__ida-pro-mcp__set_type     │ 应用类型（函数/全局/局部/栈变量）          │          
  ├────────────────────────────────┼────────────────────────────────────────────┤          
  │ mcp__ida-pro-mcp__set_comments │ 在地址设置注释                             │          
  ├────────────────────────────────┼────────────────────────────────────────────┤          
  │ mcp__ida-pro-mcp__rename       │ 统一重命名函数、全局变量、局部变量和栈变量 │          
  └────────────────────────────────┴────────────────────────────────────────────┘          
  函数与代码定义                                                                           
  ┌───────────────────────────────┬──────────────────────────────┐                         
  │            工具名             │             功能             │                         
  ├───────────────────────────────┼──────────────────────────────┤                         
  │ mcp__ida-pro-mcp__define_func │ 在地址定义函数               │                         
  ├───────────────────────────────┼──────────────────────────────┤                         
  │ mcp__ida-pro-mcp__define_code │ 将字节转换为地址处的代码指令 │                         
  ├───────────────────────────────┼──────────────────────────────┤                         
  │ mcp__ida-pro-mcp__undefine    │ 取消定义项目，转换回原始字节 │                         
  └───────────────────────────────┴──────────────────────────────┘                         
  栈变量工具                                                                               
  ┌─────────────────────────────────┬────────────┐                                         
  │             工具名              │    功能    │                                         
  ├─────────────────────────────────┼────────────┤                                         
  │ mcp__ida-pro-mcp__stack_frame   │ 获取栈变量 │                                         
  ├─────────────────────────────────┼────────────┤                                         
  │ mcp__ida-pro-mcp__declare_stack │ 创建栈变量 │                                         
  ├─────────────────────────────────┼────────────┤                                         
  │ mcp__ida-pro-mcp__delete_stack  │ 删除栈变量 │                                         
  └─────────────────────────────────┴────────────┘                                         
  导出工具                                                                                 
  ┌────────────────────────────────┬────────────────────────┐                              
  │             工具名             │          功能          │                              
  ├────────────────────────────────┼────────────────────────┤                              
  │ mcp__ida-pro-mcp__export_funcs │ 以各种格式导出函数数据 │                              
  └────────────────────────────────┴────────────────────────┘                              
  Python 执行                                                                              
  ┌───────────────────────────┬─────────────────────────────────────────────────────┐      
  │          工具名           │                        功能                         │      
  ├───────────────────────────┼─────────────────────────────────────────────────────┤      
  │ mcp__ida-pro-mcp__py_eval │ 在 IDA 上下文中执行 Python 代码（访问所有 IDA API） │      
  └───────────────────────────┴─────────────────────────────────────────────────────┘      
  数字转换                                                                                 
  工具名: mcp__ida-pro-mcp__int_convert                                                    
  功能: 将数字转换为不同格式（十六进制、十进制、二进制、ASCII）                            
  ---                                                                                      
  总计: <span class="hljs-number">34</span> 个 MCP 工具可用
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MCP (Model Context Protocol) 技术理解 - 第四篇]]></title>    <link>https://juejin.cn/post/7605145921617723444</link>    <guid>https://juejin.cn/post/7605145921617723444</guid>    <pubDate>2026-02-11T07:34:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605145921617723444" data-draft-id="7605106957133873186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MCP (Model Context Protocol) 技术理解 - 第四篇"/> <meta itemprop="keywords" content="后端,MCP,AIGC"/> <meta itemprop="datePublished" content="2026-02-11T07:34:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MCP (Model Context Protocol) 技术理解 - 第四篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:34:44.000Z" title="Wed Feb 11 2026 07:34:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在第三篇文章中，我们讲了<strong>MCP服务端的三个核心原语</strong>。在上一篇我其实忘记解释原语到底是什么，这里补充一下吧。</p>
<p><strong>原语</strong>指的是<strong>最基本的、不可再分的操作单元</strong>，是构建更复杂功能的基础构建块（building blocks）。我们讲的服务端的三个核心原语，其实就是MCP服务器能提供的三种<strong>基本交互模式</strong>。那么类比到其他方面，比如<strong>HTTP 的原语</strong>：GET、POST、PUT、DELETE（基本操作），数据库的基本原语是CRUD等等。</p>
<p>那么这一篇我们就开始讲<strong>客户端的核心原语</strong></p>
<p>如果你对前面的内容感兴趣，可以点击这里跳转</p>
<p><a href="https://juejin.cn/post/7604037348607082534" target="_blank" title="https://juejin.cn/post/7604037348607082534">MCP (Model Context Protocol) 技术理解 - 第一篇</a></p>
<p><a href="https://juejin.cn/post/7603721514204495881" target="_blank" title="https://juejin.cn/post/7603721514204495881">MCP (Model Context Protocol) 技术理解 - 第二篇</a></p>
<p><a href="https://juejin.cn/post/7605042079668518927" target="_blank" title="https://juejin.cn/post/7605042079668518927">MCP (Model Context Protocol) 技术理解 - 第三篇</a></p>
<h2 data-id="heading-1">MCP客户端是什么</h2>
<p>其实我们在前面的架构讲解的时候有讲过MCP的客户端是什么，但是这里就顺带再讲一遍吧。</p>
<p>MCP 客户端由AI应用程序实例化，用于与特定的 MCP 服务器通信。AI应用（例如 Cursor或者Claude Code）负责管理整体用户体验并协调多个客户端。每个客户端处理与一个服务器的直接通信。<strong>理清这里非常重要，不要把AI应用(host宿主)和MCP客户端混为一谈噢</strong></p>
<p>根本区别就是host是用户与之交互的应用程序，而客户端是实现服务器连接的协议级组件</p>
<h2 data-id="heading-2">MCP客户端的核心原语</h2>
<p>上面讲了概念，我们现在再来讲讲客户端的核心原语有什么，一般有下面的三种：</p>

























<table><thead><tr><th>特征</th><th>解释</th><th>例子</th></tr></thead><tbody><tr><td><strong>Elicitation</strong></td><td>信息获取使服务器能够在交互过程中向用户请求特定信息，为服务器按需收集信息提供了一种结构化的方法。</td><td>服务器在预订旅行时可能会询问用户对飞机座位、房间类型或联系电话的偏好，以完成预订。</td></tr><tr><td><strong>Roots</strong></td><td>根目录允许客户端指定服务器应该关注哪些目录，并通过协调机制传达预期范围。</td><td>旅行预订服务器可以被授予对特定目录的访问权限，从而可以从中读取用户的日历。</td></tr><tr><td><strong>Sampling</strong></td><td>采样允许服务器通过客户端请求 LLM 完成，从而实现代理工作流。这种方法使客户端完全掌控用户权限和安全措施。</td><td>旅行预订服务器可以向 LLM 发送航班列表，并请求 LLM 为用户选择最佳航班。</td></tr></tbody></table>
<h3 data-id="heading-3">Elicitation</h3>
<p>Elicitation，翻译过来意思是引导。它的作用和它的翻译意思一样，<strong>为服务器提供了一种结构化的方法，使其能够按需收集必要信息</strong>。服务器无需预先获取所有信息，也无需在数据缺失时失败，而是可以暂停操作，向用户请求特定输入。这创造了更灵活的交互方式，服务器能够适应用户需求，而不是遵循僵化的模式</p>
<p>这是它的时序图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b36919872052408f8d2f7f9979504516~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400084&amp;x-signature=uFewuwc%2B2AlYvnuQplAxkKB4RNI%3D" alt="image.png" loading="lazy"/></p>
<p>该流程支持动态信息收集。服务器可以根据需要请求特定数据，用户通过相应的用户界面提供信息，服务器则根据新获取的上下文继续处理数据。</p>
<p><strong>举个例子来说明白</strong>，我们使用claude code的时候，如果你的prompts不够清晰明了，CC会问你是否要xx，或者问xx这样做您满意吗？逐渐引导到你想要的结果。</p>
<p>又说到最近很火的千问送奶茶活动，你说的prompt是“我要喝xx的xx款奶茶”，但是它不知道你要大杯还是中杯，几分糖，所以会返回不同规格的同款奶茶给你(同家奶茶店，但是不同地点，大杯或中杯)，等你选定再返回给千问下单。</p>
<p>来个数据流示意？</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  method<span class="hljs-punctuation">:</span> <span class="hljs-string">"elicitation/requestInput"</span><span class="hljs-punctuation">,</span>
  params<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    message<span class="hljs-punctuation">:</span> <span class="hljs-string">"Please confirm your Barcelona vacation booking details:"</span><span class="hljs-punctuation">,</span>
    schema<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      type<span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
      properties<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        confirmBooking<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          type<span class="hljs-punctuation">:</span> <span class="hljs-string">"boolean"</span><span class="hljs-punctuation">,</span>
          description<span class="hljs-punctuation">:</span> <span class="hljs-string">"Confirm the booking (Flights + Hotel = $3,000)"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        seatPreference<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          type<span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
          enum<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"window"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"aisle"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"no preference"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
          description<span class="hljs-punctuation">:</span> <span class="hljs-string">"Preferred seat type for flights"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        roomType<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          type<span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
          enum<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"sea view"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"city view"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"garden view"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
          description<span class="hljs-punctuation">:</span> <span class="hljs-string">"Preferred room type at hotel"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        travelInsurance<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          type<span class="hljs-punctuation">:</span> <span class="hljs-string">"boolean"</span><span class="hljs-punctuation">,</span>
          default<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
          description<span class="hljs-punctuation">:</span> <span class="hljs-string">"Add travel insurance ($150)"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      required<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"confirmBooking"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">Roots</h3>
<p>Roots,直译过来是根的意思，也就是根目录。<strong>根目录是客户端向服务器传达文件系统访问边界的一种机制</strong>。它们由文件 URI 组成，指示服务器可以操作的目录，帮助服务器了解可用文件和文件夹的范围。虽然根目录传达了预期的边界，但它们并不强制执行安全限制。实际的安全措施必须在操作系统层面通过文件权限和/或沙箱机制来实施</p>
<p>那么Roots可以规定MCP服务端可以访问的文件，要求不能越过越过这条边界(但是不能强制要求，因为服务器运行的代码是客户端无法控制的)。</p>
<p>下面是Roots的结构：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///Users/agent/travel-planning"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Travel Planning Workspace"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>根目录是文件系统路径，始终使用<code>file://</code>URI 方案。它们帮助服务器理解项目边界、工作区组织结构和可访问目录。根目录列表会随着用户使用不同的项目或文件夹而动态更新，服务器会在<code>roots/list_changed</code>边界发生变化时收到通知。</p>
<p>不理解？我们来一个示例：</p>
<p>旅行社agent需要处理多个客户的行程，因此可以利用Roots来组织文件系统访问。可以考虑创建一个工作区，其中包含用于旅行计划各个方面的不同目录。客户端向旅行规划服务器提供文件系统根目录：</p>
<ul>
<li><code>file:///Users/agent/travel-planning</code>- 包含所有旅行文件的主工作区</li>
<li><code>file:///Users/agent/travel-templates</code>- 可重复使用的行程模板和资源</li>
<li><code>file:///Users/agent/client-documents</code>- 客户护照和旅行证件</li>
</ul>
<p>当agent创建巴塞罗那行程时，运行良好的服务器会遵守这些边界——访问模板、保存新行程以及引用指定根目录下的客户文档。服务器通常通过使用根目录的相对路径或利用遵循根目录边界的文件搜索工具来访问根目录中的文件。如果代理打开一个类似这样的归档文件夹<code>file:///Users/agent/archive/2023-trips</code>，客户端会通过更新根列表<code>roots/list_changed</code></p>
<h3 data-id="heading-5">Sampling</h3>
<p>Sampling，直译过来是采样。采样允许服务器通过客户端请求语言模型补全，从而实现代理行为，同时保持安全性和用户控制。服务器可以请求已拥有 AI 模型访问权限的客户端代表其处理这些任务。这种方法使客户端完全掌控用户权限和安全措施。由于采样请求发生在其他操作（例如数据分析工具）的上下文中，并作为独立的模型调用进行处理，因此它们能够清晰地划分不同上下文，从而更有效地利用上下文窗口。</p>
<p>不理解？来个例子，平时使用Cursor的时候，如果要执行某个文件命令又或者执行maven命令，如果你没有设置Agent全自动运行，那么Agent在运行前的时候肯定会先来问你，是否执行这个命令或者skip(跳过)。</p>
<p>下面是采样的时序图，该流程通过多重人为干预检查点确保安全性。用户可以在请求返回服务器之前，查看并修改初始请求和生成的响应。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21af1ba41de74c089a2745e44b686c9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771400084&amp;x-signature=cURyREPjSGK0swIBflPojzDxLBg%3D" alt="image.png" loading="lazy"/></p>
<p>下面是请求参数示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  messages<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      role<span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      content<span class="hljs-punctuation">:</span> <span class="hljs-string">"Analyze these flight options and recommend the best choice:\n"</span> +
               <span class="hljs-string">"[47 flights with prices, times, airlines, and layovers]\n"</span> +
               <span class="hljs-string">"User preferences: morning departure, max 1 layover"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  modelPreferences<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    hints<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
      name<span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-sonnet-4-20250514"</span>  <span class="hljs-comment">// Suggested model</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    costPriority<span class="hljs-punctuation">:</span> <span class="hljs-number">0.3</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// Less concerned about API cost</span>
    speedPriority<span class="hljs-punctuation">:</span> <span class="hljs-number">0.2</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// Can wait for thorough analysis</span>
    intelligencePriority<span class="hljs-punctuation">:</span> <span class="hljs-number">0.9</span>  <span class="hljs-comment">// Need complex trade-off evaluation</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  systemPrompt<span class="hljs-punctuation">:</span> <span class="hljs-string">"You are a travel expert helping users find the best flights based on their preferences"</span><span class="hljs-punctuation">,</span>
  maxTokens<span class="hljs-punctuation">:</span> <span class="hljs-number">1500</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Sampling本质就是想实现人机协同。采样请求可能需要用户明确同意。客户端可以说明服务器想要分析的内容及其原因。用户可以批准、拒绝或修改请求。</p>
<h2 data-id="heading-6">小结</h2>
<p>这篇我们运用了很多例子来讲解MCP客户端三种原语，相信大家都有不错的体感。下一篇，我们会讲解MCP实战开发。</p>
<p>如果你觉得MCP技术讲解系列非常不错，可以点赞+收藏+关注，谢谢。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[慎用mysqldump与GTID自动定位：一次备份数据"丢失"的排查]]></title>    <link>https://juejin.cn/post/7605145921617707060</link>    <guid>https://juejin.cn/post/7605145921617707060</guid>    <pubDate>2026-02-11T07:34:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605145921617707060" data-draft-id="7605114376803467304" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="慎用mysqldump与GTID自动定位：一次备份数据&quot;丢失&quot;的排查"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-11T07:34:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GreatSQL"/> <meta itemprop="url" content="https://juejin.cn/user/2859169627508573"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            慎用mysqldump与GTID自动定位：一次备份数据"丢失"的排查
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2859169627508573/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GreatSQL
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-11T07:34:08.000Z" title="Wed Feb 11 2026 07:34:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">慎用mysqldump与GTID自动定位：一次备份数据"丢失"的排查</h2>
<h4 data-id="heading-1">本文摘要</h4>
<p>导入<code>mysqldump</code>的备份数据，并通过<code>MASTER_AUTO_POSITION=1</code>配置从节点，启动复制后，出现1032错误（行不存在）。经排查发现，MySQL 5.7.38的mysqldump备份文件内部存在逻辑矛盾：其记录的起始复制位置与GTID集存在时间差，导致使用<code>MASTER_AUTO_POSITION=1</code>配置从节点时，会丢失备份期间的数据。而mysqldump5.7.36之前和mysqldump8.0.31之后的版本不存在此问题。</p>
<p>本文记录完整的复现、分析和解决方案。</p>
<h3 data-id="heading-2">背景</h3>
<p>某业务系统使用的是MySQL 5.7.38，计划将数据库替换为国产数据库GreatSQL，使用mysqldump从MySQL 5.7.38备份了一份数据，导入到GreatSQL之后，将GreatSQL配置为MySQL 5.7.38的从库，系统运行一段时间后，<code>SHOW SLAVE STATUS</code>检查复制状态，发现复制链路报错， Last_Errno: 1032。</p>
<p>搭建了MySQL 5.7.38和GreatSQL对该场景进行了模拟。</p>
<h3 data-id="heading-3">安装MySQL 5.7.38</h3>
<pre><code class="hljs language-Bash" lang="Bash">$ <span class="hljs-built_in">cd</span> /gdb/mysqldb
$ tar -xvf  mysql-5.7.38-linux-glibc2.12-x86_64.tar.gz
$ <span class="hljs-built_in">mv</span> mysql-5.7.38-linux-glibc2.12-x86_64 mysql-5.7.38
$ <span class="hljs-built_in">mkdir</span> -p /gdb/mysqldb/5738/{data,tmp,binlog}
<span class="hljs-variable">$chown</span> -R  greatsql:greatsql   /gdb/mysqldb
$ ./mysqld --initialize-insecure    --user=greatsql --basedir=/gdb/mysqldb/mysql-5.7.38 --datadir=/gdb/mysqldb/5738/data
...<span class="hljs-comment">#输出省略</span>
password ! Please consider switching off the --initialize-insecure option.
</code></pre>
<h4 data-id="heading-4">创建用户</h4>
<p>在MySQL中创建用户：</p>
<pre><code class="hljs language-Bash" lang="Bash">mysql&gt;CREATE USER admin@<span class="hljs-string">'%'</span> IDENTIFIED WITH MYSQL_NATIVE_PASSWORD BY <span class="hljs-string">'admin'</span> ;
mysql&gt;GRANT ALL PRIVILEGES ON . TO admin@<span class="hljs-string">'%'</span>  WITH GRANT OPTION;
mysql&gt;FLUSH PRIVILEGES;
</code></pre>
<h4 data-id="heading-5">创建测试库及测试表</h4>
<p>在MySQL中创建测试库及测试表：</p>
<pre><code class="hljs language-Bash" lang="Bash">mysql&gt;CREATE DATABASE sbtest;
Query OK, 1 row affected (0.01 sec)
mysql&gt;USE sbtest;
Reading table information <span class="hljs-keyword">for</span> completion of table and column names
You can turn off this feature to get a quicker startup with -A
Database changed
mysql&gt;CREATE TABLE t_keep_alive( name varchar(20),  create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP);
Query OK, 0 rows affected (0.08 sec)
</code></pre>
<h4 data-id="heading-6">使用 Sysbench 构造数据</h4>
<pre><code class="hljs language-Bash" lang="Bash">$ sysbench /usr/local/share/sysbench/oltp_read_write.lua  --mysql-db=sbtest --mysql-host=192.168.18.2 --mysql-port=5738 --mysql-user=admin  --mysql-password=admin --tables=3 --table_size=3000000 --report-interval=2 --threads=4 --db-driver=mysql --skip-trx=off --db-ps-mode=<span class="hljs-built_in">disable</span> --create-secondary=off --time=0 --simple-ranges=0 --sum-ranges=0 --order-ranges=0 --distinct-ranges=0 --mysql-ignore-errors=9001,9002,9000,1062 prepare
WARNING: Both event and time limits are disabled, running an endless <span class="hljs-built_in">test</span>
sysbench 1.1.0-df89d34 (using bundled LuaJIT 2.1.0-beta3)

Initializing worker threads...

Creating table <span class="hljs-string">'sbtest2'</span>...
Creating table <span class="hljs-string">'sbtest1'</span>...
Creating table <span class="hljs-string">'sbtest3'</span>...
Inserting 3000000 records into <span class="hljs-string">'sbtest2'</span>
Inserting 3000000 records into <span class="hljs-string">'sbtest3'</span>
Inserting 3000000 records into <span class="hljs-string">'sbtest1'</span>
</code></pre>
<h4 data-id="heading-7">插入数据脚本</h4>
<p>计划在备份期间，每秒插入一条测试数据</p>
<pre><code class="hljs language-Bash" lang="Bash">$ more t_keep.sh 
<span class="hljs-comment">#!/bin/bash</span>
USER=<span class="hljs-string">"admin"</span>
PASSWORD=<span class="hljs-string">"admin"</span>
HOST=<span class="hljs-string">"192.168.18.2"</span>
PORT=5738
DBNAME=<span class="hljs-string">"sbtest"</span>
<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> 
<span class="hljs-keyword">do</span>
  /gdb/mysqldb/mysql-5.7.38/bin/mysql -u<span class="hljs-string">"<span class="hljs-variable">$USER</span>"</span> -p<span class="hljs-string">"<span class="hljs-variable">$PASSWORD</span>"</span> -h<span class="hljs-string">"<span class="hljs-variable">$HOST</span>"</span> -P<span class="hljs-string">"<span class="hljs-variable">$PORT</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$DBNAME</span>"</span>  -e <span class="hljs-string">"INSERT INTO t_keep_alive(name) SELECT SUBSTRING(UUID(), 1, 8) ;SELECT sleep(1);"</span>
<span class="hljs-keyword">done</span>
</code></pre>
<p>GTID信息</p>
<pre><code class="hljs language-Bash" lang="Bash">sysbench 插入数据后：

mysql&gt;SHOW MASTER STATUS;
+---------------+----+---------------------------------------------+
| File          | Position  | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+---------------+--+---------------------------------------------+
| binlog.000004 | 643592650 |    |  | e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3366 |
+---------------+---+---------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

备份完成：

mysql&gt;SHOW MASTER STATUS;
+---------------+-----------+----+---------------------------------------------+
| File          | Position  | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set|
+---------------+------+---------------------------------------------+
| binlog.000004 | 643622680 |   | | e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3471 |
+---------------+-----------+---+---------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)
</code></pre>
<h4 data-id="heading-8">开始插入数据</h4>
<pre><code class="hljs language-Bash" lang="Bash">$ bash t_keep.sh 
mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.
+----------+
| <span class="hljs-built_in">sleep</span>(1) |
+----------+
|        0 |
+----------+
mysql: [Warning] Using a password on the <span class="hljs-built_in">command</span> line interface can be insecure.
+----------+
| <span class="hljs-built_in">sleep</span>(1) |
+----------+
|        0 |
+----------+
</code></pre>
<h4 data-id="heading-9">备份数据</h4>
<pre><code class="hljs language-Shell" lang="Shell">/gdb/mysqldb/mysql-5.7.38/bin/mysqldump -uadmin -h192.168.18.2 -P5738 -padmin --single-transaction --set-gtid-purged=ON --master-data=2 --routines --events --triggers --databases sbtest    --force &gt; /tmp/sbtest.sql
</code></pre>
<h4 data-id="heading-10">停止数据写入</h4>
<p>备份完成后，kill 掉写入数据的t_keep.sh 进程</p>
<h4 data-id="heading-11">GreatSQL导入备份文件</h4>
<pre><code class="hljs language-Bash" lang="Bash">$ <span class="hljs-built_in">du</span> -sh sbtest.sql 
1.7G    sbtest.sql

登录GreatSQL数据库，将备份文件导入到GreatSQL数据库
GreatSQL&gt;SOURCE /tmp/sbtest.sql;
</code></pre>
<h3 data-id="heading-12">基于GTID模式配置从库</h3>
<p>将GreatSQL配置为基于GTID模式的MySQL从库</p>
<pre><code class="hljs language-Bash" lang="Bash">GreatSQL&gt;CHANGE MASTER TO MASTER_HOST=<span class="hljs-string">'192.168.18.2'</span>,MASTER_USER=<span class="hljs-string">"ADMIN"</span>,MASTER_PASSWORD=<span class="hljs-string">'ADMIN'</span>,MASTER_PORT=5738,MASTER_AUTO_POSITION=1;
Query OK, 0 rows affected, 2 warnings (0.02 sec)

GreatSQL&gt;SHOW MASTER STATUS;
+---------------+--+---------------------------------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                           |
+---------------+--+---------------------------------------------+
| binlog.000001 |      154 |   |   | e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3466 |
+---------------+--+---------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

GreatSQL&gt;START SLAVE;
Query OK, 0 rows affected (0.00 sec)
</code></pre>
<h3 data-id="heading-13">主从数据对比</h3>
<p>gtid信息对比：对比主库和从库的gtid信息，两个库是一致的，都是1-3537</p>
<pre><code class="hljs language-Bash" lang="Bash">主库:
mysql&gt;SHOW MASTER STATUS;
+---------------+------------------+---------------------------------------------+
| File          | Position  | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+---------------+------------+---------------------------------------------+
| binlog.000004 | 643641556 |   |   | e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3537 |
+---------------+-----+---------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)
从库:
GreatSQL&gt;SHOW MASTER STATUS;
+---------------+---+------------------+---------------------------------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                           |
+---------------+--+------------------+---------------------------------------------+
| binlog.000001 |   154 |      |    | e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3537 |
+---------------+---+------------------+---------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)
</code></pre>
<p>表数据对比：t_keep_alive表数据不一致，主库比从库多</p>
<pre><code class="hljs language-Bash" lang="Bash">主库:
mysql&gt;SELECT count(*) FROM t_keep_alive;
+----------+
| count(*) |
+----------+
|      171 |
+----------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)

从库:
GreatSQL&gt;SELECT count(*) FROM t_keep_alive;
+----------+
| count(*) |
+----------+
|      120 |
+----------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.01 sec)

差异数据分析：从库11:10:36到11:11:37之间，没有数据写入从库。在主库更新备份期间产生的数据，
从库就会出现1032错误，SQL线程状态变为NO
| 41f01fcf | 2026-01-12 11:10:33 | 2026-01-12 11:10:33 |
| 428b22d3 | 2026-01-12 11:10:34 | 2026-01-12 11:10:34 |
| 43266c4c | 2026-01-12 11:10:35 | 2026-01-12 11:10:35 |
| 43c105c5 | 2026-01-12 11:10:36 | 2026-01-12 11:10:36 |

| 68155846 | 2026-01-12 11:11:37 | 2026-01-12 11:11:37 |
| 68b0b70c | 2026-01-12 11:11:38 | 2026-01-12 11:11:38 |
| 694b88d8 | 2026-01-12 11:11:39 | 2026-01-12 11:11:39 |
</code></pre>
<h3 data-id="heading-14">基于LOG_FILE+LOG_POS搭建主从</h3>
<pre><code class="hljs language-Bash" lang="Bash">GreatSQL&gt; STOP SLAVE;
Query OK, 0 rows affected (0.01 sec)

GreatSQL&gt; RESET SLAVE all;
Query OK, 0 rows affected (0.01 sec)

GreatSQL&gt; DROP DATABASE sbtest;
Query OK, 4 rows affected (0.92 sec)

GreatSQL&gt; RESET MASTER;
Query OK, 0 rows affected (0.01 sec)

GreatSQL&gt; SOURCE /tmp/sbtest.sql;


GreatSQL&gt; SHOW MASTER STATUS;
+---------------+------+---------------------------------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set|
+---------------+------+---------------------------------------------+
| binlog.000001 |      154 |   |  | e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3466 |
+---------------+------+---------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

GreatSQL&gt; SELECT *  FROM  t_keep_alive;
...........
| 43c105c5 | 2026-01-12 11:10:36 | 2026-01-12 11:10:36 |
+----------+---------------------+---------------------+
49 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

GreatSQL&gt; RESET MASTER;
Query OK, 0 rows affected (0.02 sec)

GreatSQL&gt; SHOW MASTER STATUS;
+---------------+----------+--------------+------------------+-------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+---------------+----------+--------------+------------------+-------------------+
| binlog.000001 |      154 |              |                  |                   |
+---------------+----------+--------------+------------------+-------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)

GreatSQL&gt; CHANGE MASTER   TO MASTER_HOST=<span class="hljs-string">'192.168.18.2'</span>,MASTER_USER=<span class="hljs-string">"ADMIN"</span>,MASTER_PASSWORD=<span class="hljs-string">'ADMIN'</span>,MASTER_PORT=5738,MASTER_LOG_FILE=<span class="hljs-string">'BINLOG.000004'</span>, MASTER_LOG_POS=643606664;

Query OK, 0 rows affected, 2 warnings (0.02 sec)

GreatSQL&gt; START SLAVE;
Query OK, 0 rows affected (0.00 sec)

GreatSQL&gt; SELECT * FROM t_keep_alive;
........
| 92abaf1c | 2026-01-12 11:12:48 | 2026-01-12 11:12:48 |
+----------+---------------------+---------------------+
171 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)


GreatSQL&gt; SHOW MASTER STATUS;
+---------------+--+------------------------------------------------+
| File          | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set    |
+---------------+--+------------------------------------------------+
| binlog.000001 |      154 |    |  | e9ceeaef-ed3d-11f0-893c-00163ed468c9:3416-3537 |
+---------------+--+------------------------------------------------+
1 row <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)
</code></pre>
<ul>
<li>通过<code>LOG_FILE、LOG_POS</code>配置主从同步，gtid同步范围为:3416-3537,</li>
<li>通过<code>master_auto_position</code>配置主从同步，gtid同步范围为:3467-3537。</li>
</ul>
<h3 data-id="heading-15">问题分析</h3>
<p>查看备份文件</p>
<pre><code class="hljs language-Bash" lang="Bash">--
-- Position to start replication or point-in-time recovery from
--
文件的开头部分
-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="hljs-string">'binlog.000004'</span>, MASTER_LOG_POS=643606664;
--
-- Current Database: `sbtest`
--
CREATE DATABASE /*!32312 IF NOT EXISTS*/ `sbtest` /*!40100 DEFAULT CHARACTER SET utf8 */;

USE `sbtest`;

--
-- Table structure <span class="hljs-keyword">for</span> table `sbtest1`

....... 略

UNLOCK TABLES;
--
-- Dumping events <span class="hljs-keyword">for</span> database <span class="hljs-string">'sbtest'</span>
--

--
-- Dumping routines <span class="hljs-keyword">for</span> database <span class="hljs-string">'sbtest'</span>
--

--
-- GTID state at the end of the backup 
--
-- 文件结尾部分
SET @@GLOBAL.GTID_PURGED=<span class="hljs-string">'e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3466'</span>;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2026-01-12 11:11:36
SET @@GLOBAL.GTID_PURGED=<span class="hljs-string">'e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3466'</span>;
</code></pre>
<p>备份文件认为1-3466这些事务的数据已经写入到数据库。</p>
<p>实际情况情况呢？</p>
<p>解析备份文件LOG_FILE、LOG_POS相邻的数据。</p>
<p>解析binlog.000004 ，MASTER_LOG_POS=643606664后的下一个事务是<code>'e9ceeaef-ed3d-11f0-893c-00163ed468c9:3416'</code></p>
<pre><code class="hljs language-Bash" lang="Bash">SET @@SESSION.GTID_NEXT= <span class="hljs-string">'e9ceeaef-ed3d-11f0-893c-00163ed468c9:3416'</span>/*!*/;
<span class="hljs-comment"># at 643606729</span>
<span class="hljs-comment">#260112 11:10:37 server id 425738  end_log_pos 643606803 CRC32 0x7f5398a1</span>
</code></pre>
<p><code>LOG_FILE、LOG_POS</code>  对应的下一个事务是'e9ceeaef-ed3d-11f0-893c-00163ed468c9:3416'，这种同步方式是从3416开始同步数据。</p>
<p>而通过MASTER_AUTO_POSITION=1的方式同步数据，由于备份文件最后是</p>
<p><code>SET @@GLOBAL.GTID_PURGED='e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3466';</code> (MySQL 5.7.38的mysqldump在备份完成时才获取gtid信息) ，这条语句写入数据库后，数据库认为<code>1-3466</code>的数据已经写入到数据库了，这些数据不需要进行同步。</p>
<p>配置MASTER_AUTO_POSITION=1后，从3467开始同步新的数据。两种同步方式差异就是备份期间产生的51条数据(3467-3416=51 )，在主库UPDATE备份期间产生的数据，从库就会出现1032错误，导致主从复制链路失败。</p>
<h3 data-id="heading-16">问题总结</h3>
<p>1、使用MySQL 5.7.38的mysqldump进行数据备份，备份数据导入从库，通过MASTER_AUTO_POSITION=1配置主从后，主从数据库数据不一致，从库开始从备份完成时生成GTID信息开始同步，主库备份期间产生的数据没有同步到从库。备份参数<code>--single-transaction</code>在备份开始前,先执行<code>START TRANSACTION</code>命令,以此来获得备份的一致性，备份程序应该获取此时的GTID信息。</p>
<p>2、通过LOG_FILE、LOG_POS方式搭建从库可以正常进行主从数据同步。</p>
<p>3、使用MySQL 5.7.30、MySQL 8.0.32、GreatSQL8.0.32 的mysqldump程序进行备份，程序获取的LOG_FILE、LOG_POS和GTID信息都在备份文件头记录，这两者对应的日志文件位置是一样的，使用GTID搭建主从后，数据是一致的。MySQL 5.7.38的mysqldump程序MASTER_LOG_FILE和MASTER_LOG_POS在备份文件头，GTID_PURGED在文件尾。</p>
<pre><code class="hljs language-Bash" lang="Bash">用 MySQL 5.7.30、 MySQL 8.0.32、GreatSQL8.0.32 进行备份测试， 备份的时候GTID和文件点位都在备份文件头
SET @@GLOBAL.GTID_PURGED=<span class="hljs-string">'e9ceeaef-ed3d-11f0-893c-00163ed468c9:1-3537'</span>;
-- Position to start replication or point-in-time recovery from
--
-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="hljs-string">'binlog.000004'</span>, MASTER_LOG_POS=643641556;
</code></pre>
<p>4、经过测试验证，mysqldump5.7.36之前和mysqldump8.0.31之后的版本不存在此问题。</p>
<h3 data-id="heading-17">参考文章</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F1915277%3FshareByChannel%3Dlink" target="_blank" title="https://cloud.tencent.com/developer/article/1915277?shareByChannel=link" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/a…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbugs.mysql.com%2Fbug.php%3Fid%3D105761" target="_blank" title="https://bugs.mysql.com/bug.php?id=105761" ref="nofollow noopener noreferrer">bugs.mysql.com/bug.php?id=…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>