<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Python异步编程：为什么90%的开发者都用错了这3个关键点？]]></title>    <link>https://juejin.cn/post/7598480267218485282</link>    <guid>https://juejin.cn/post/7598480267218485282</guid>    <pubDate>2026-01-25T00:19:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598480267218485282" data-draft-id="7598588085596602408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python异步编程：为什么90%的开发者都用错了这3个关键点？"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-25T00:19:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python异步编程：为什么90%的开发者都用错了这3个关键点？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T00:19:46.000Z" title="Sun Jan 25 2026 00:19:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Python异步编程：为什么90%的开发者都用错了这3个关键点？</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>异步编程已经成为现代Python开发中不可或缺的一部分，尤其是在I/O密集型和高并发场景下。随着<code>asyncio</code>库的成熟和Python对异步支持的不断增强，越来越多的开发者开始尝试利用异步编程来提升性能。然而，在实践中，许多开发者并未真正理解异步编程的核心概念，导致代码效率低下、难以维护甚至出现难以调试的问题。</p>
<p>本文将深入探讨Python异步编程中最容易被误解或错误使用的3个关键点：<strong>事件循环的理解与使用</strong>、<strong>协程的正确调度</strong>以及<strong>资源管理与线程安全</strong>。通过分析这些常见误区，帮助开发者更好地掌握异步编程的精髓。</p>
<hr/>
<h3 data-id="heading-2">1. 事件循环：不仅仅是“后台任务调度器”</h3>
<h4 data-id="heading-3">误区：事件循环是一个黑匣子</h4>
<p>许多开发者将事件循环（Event Loop）简单地视为一个“后台任务调度器”，认为只要将任务丢给<code>asyncio.run()</code>或<code>loop.run_until_complete()</code>就能自动实现异步执行。这种理解过于肤浅，忽略了事件循环的核心作用：<strong>协调和管理所有协程的执行顺序和资源分配</strong>。</p>
<h4 data-id="heading-4">深入解析</h4>
<ul>
<li><strong>事件循环的本质</strong>：事件循环是单线程的，它通过轮询I/O事件和协程的状态来决定下一步执行哪个任务。它的核心是“非阻塞”和“协作式多任务”。</li>
<li><strong>常见错误</strong>：
<ol>
<li><strong>阻塞事件循环</strong>：在协程中调用同步阻塞操作（如<code>time.sleep()</code>或CPU密集型计算），导致整个事件循环被卡住。正确的做法是使用<code>await asyncio.sleep()</code>或将CPU密集型任务交给<code>loop.run_in_executor()</code>。</li>
<li><strong>滥用多个事件循环</strong>：在同一个线程中创建多个事件循环（如手动调用<code>asyncio.new_event_loop()</code>）会导致不可预测的行为。通常，一个线程只需要一个事件循环。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-5">最佳实践</h4>
<ul>
<li>始终使用<code>asyncio.run()</code>作为入口点（Python 3.7+），避免手动管理事件循环的生命周期。</li>
<li>对于需要并行执行的I/O操作，优先使用<code>asyncio.gather()</code>或<code>asyncio.create_task()</code>，而不是手动操作事件循环。</li>
</ul>
<hr/>
<h3 data-id="heading-6">2. 协程的正确调度：从“Fire-and-Forget”到结构化并发</h3>
<h4 data-id="heading-7">误区：“启动即忘”的协程管理</h4>
<p>许多开发者习惯直接调用<code>asyncio.create_task()</code>而不保存返回的Task对象，导致无法跟踪任务状态或处理异常。这种“Fire-and-Forget”模式会引发以下问题：</p>
<ol>
<li><strong>无法捕获异常</strong>：未被等待的Task如果抛出异常，可能不会触发任何错误处理逻辑。</li>
<li><strong>资源泄漏</strong>：未完成的任务可能持有资源（如数据库连接），但无法被及时清理。</li>
</ol>
<h4 data-id="heading-8">深入解析</h4>
<ul>
<li><strong>结构化并发的重要性</strong>：异步代码应该像同步代码一样具有明确的任务边界和生命周期管理。Python 3.11引入的<code>TaskGroup</code>（通过<code>asyncio.TaskGroup</code>）正是为了解决这一问题。</li>
<li><strong>常见错误场景</strong>：
<ol>
<li><strong>未处理的Task异常</strong>：如果一个Task未被显式等待，其异常会被静默丢弃（除非调用<code>.exception()</code>或<code>.result()</code>）。</li>
<li><strong>取消传播问题</strong>：直接取消父Task不会自动取消子Task，需要手动管理取消逻辑。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-9">最佳实践</h4>
<ul>
<li>使用<code>asyncio.TaskGroup</code>（Python 3.11+）或第三方库（如<code>trio</code>）实现结构化并发：
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> asyncio.TaskGroup() <span class="hljs-keyword">as</span> tg:
        tg.create_task(task1())
        tg.create_task(task2())
    <span class="hljs-comment"># 所有任务完成后继续执行</span>
</code></pre>
</li>
<li>对于旧版本Python，至少要通过<code>asyncio.gather(return_exceptions=True)</code>捕获所有任务的异常。</li>
</ul>
<hr/>
<h3 data-id="heading-10">3. 资源管理与线程安全：“异步上下文”不是万能的</h3>
<h4 data-id="heading-11">误区：认为异步代码天然线程安全</h4>
<p>由于异步编程基于协程的单线程模型，许多开发者误以为不需要考虑线程安全问题。然而，在以下场景中仍然存在风险：</p>
<ol>
<li><strong>混合同步与异步代码</strong>：例如在协程中调用同步数据库驱动（如psycopg2），可能导致死锁或竞争条件。</li>
<li><strong>共享状态访问</strong>：即使是单线程环境，如果多个协程同时修改共享变量（如全局字典），也可能因上下文切换导致数据不一致。</li>
</ol>
<h4 data-id="heading-12">深入解析</h4>
<ul>
<li><strong>GIL的限制</strong>：虽然GIL避免了真正的并行执行，但协程的切换是显式的（通过<code>await</code>），因此共享状态的修改仍需要同步机制（如<code>asyncio.Lock</code>）。</li>
<li><strong>常见陷阱案例</strong>：
<ol>
<li><strong>阻塞I/O破坏异步性</strong>：在协程中使用同步Redis客户端会导致整个事件循环阻塞；应改用异步客户端（如<code>aioredis</code>）。</li>
<li><strong>未受保护的共享状态</strong>：即使是无竞争的全局变量修改也需要锁保护（例如计数器递增操作）。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-13">最佳实践</h4>
<ul>
<li><strong>严格分离同步与异步代码边界</strong>：使用适配器模式将同步代码封装为异步接口（如通过线程池执行）。</li>
<li><strong>显式同步机制选择原则</strong>：
<ul>
<li><code>asyncio.Lock</code>: 适用于单进程内的协程间互斥。</li>
<li><code>threading.Lock</code>: 仅用于与同步代码交互的场景。</li>
<li><code>multiprocessing.Lock</code>: 跨进程共享状态时使用。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-14">总结</h3>
<p>Python异步编程的强大之处在于其高效和非阻塞的特性，但同时也对开发者的设计能力提出了更高要求。本文分析的三个关键点——事件循环、协程调度和资源管理——是大多数问题的根源所在。要真正掌握异步编程，必须理解其底层原理并遵循结构化并发的最佳实践：</p>
<ol>
<li><strong>尊重事件循环的单线程本质</strong>，避免阻塞操作。</li>
<li><strong>采用结构化并发模式管理任务生命周期</strong>。</li>
<li><strong>明确区分同步与异步边界并正确使用锁机制</strong>.</li>
</ol>
<p>只有将这些原则融入日常开发习惯才能真正发挥出Python异步编程的全部潜力！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（63）如何在Spring中集成Hibernate？]]></title>    <link>https://juejin.cn/post/7598588085596667944</link>    <guid>https://juejin.cn/post/7598588085596667944</guid>    <pubDate>2026-01-25T00:49:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598588085596667944" data-draft-id="7598588085596651560" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（63）如何在Spring中集成Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-25T00:49:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（63）如何在Spring中集成Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T00:49:17.000Z" title="Sun Jan 25 2026 00:49:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Spring中集成Hibernate通常涉及以下几个步骤：</p>
<ol>
<li><strong>添加必要的依赖项</strong></li>
<li><strong>配置数据源</strong></li>
<li><strong>配置Hibernate的SessionFactory</strong></li>
<li><strong>配置事务管理器</strong></li>
<li><strong>定义实体类和DAO</strong></li>
<li><strong>编写服务层代码</strong></li>
</ol>
<p>下面将详细说明每个步骤，并结合代码示例进行说明。</p>
<h3 data-id="heading-0">1. 添加必要的依赖项</h3>
<p>在你的Maven <code>pom.xml</code> 文件中添加Spring和Hibernate的依赖。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Core --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring ORM --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-orm<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Hibernate Core --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.32.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Transaction --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-tx<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- C3P0 Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mchange<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>c3p0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.5.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置数据源</h3>
<p>在Spring的Java配置类或XML配置文件中配置数据源。</p>
<h4 data-id="heading-2">Java配置方式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.jdbc.datasource.DriverManagerDataSource;

<span class="hljs-keyword">import</span> javax.sql.DataSource;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-type">DriverManagerDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DriverManagerDataSource</span>();
        dataSource.setDriverClassName(<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>);
        dataSource.setUrl(<span class="hljs-string">"jdbc:mysql://localhost:3306/mydb"</span>);
        dataSource.setUsername(<span class="hljs-string">"myuser"</span>);
        dataSource.setPassword(<span class="hljs-string">"mypassword"</span>);
        <span class="hljs-keyword">return</span> dataSource;
    }
}
</code></pre>
<h3 data-id="heading-3">3. 配置Hibernate的SessionFactory</h3>
<p>配置Hibernate的<code>SessionFactory</code>，包括Hibernate的属性和数据源。</p>
<h4 data-id="heading-4">Java配置方式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.orm.hibernate5.LocalSessionFactoryBean;
<span class="hljs-keyword">import</span> org.springframework.orm.hibernate5.HibernateTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;

<span class="hljs-keyword">import</span> javax.sql.DataSource;
<span class="hljs-keyword">import</span> java.util.Properties;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> LocalSessionFactoryBean <span class="hljs-title function_">sessionFactory</span><span class="hljs-params">(DataSource dataSource)</span> {
        <span class="hljs-type">LocalSessionFactoryBean</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalSessionFactoryBean</span>();
        sessionFactory.setDataSource(dataSource);
        sessionFactory.setPackagesToScan(<span class="hljs-string">"com.example.model"</span>);
        sessionFactory.setHibernateProperties(hibernateProperties());
        <span class="hljs-keyword">return</span> sessionFactory;
    }

    <span class="hljs-keyword">private</span> Properties <span class="hljs-title function_">hibernateProperties</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        properties.put(<span class="hljs-string">"hibernate.dialect"</span>, <span class="hljs-string">"org.hibernate.dialect.MySQL5Dialect"</span>);
        properties.put(<span class="hljs-string">"hibernate.show_sql"</span>, <span class="hljs-string">"true"</span>);
        properties.put(<span class="hljs-string">"hibernate.format_sql"</span>, <span class="hljs-string">"true"</span>);
        properties.put(<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>, <span class="hljs-string">"update"</span>);
        <span class="hljs-keyword">return</span> properties;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> HibernateTransactionManager <span class="hljs-title function_">transactionManager</span><span class="hljs-params">(SessionFactory sessionFactory)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateTransactionManager</span>(sessionFactory);
    }
}
</code></pre>
<h3 data-id="heading-5">4. 配置事务管理器</h3>
<p>在Spring配置中启用事务管理，并配置事务管理器。</p>
<h4 data-id="heading-6">Java配置方式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.EnableTransactionManagement;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionConfig</span> {
    <span class="hljs-comment">// 配置类中已经包含了事务管理器的配置</span>
}
</code></pre>
<h3 data-id="heading-7">5. 定义实体类和DAO</h3>
<h4 data-id="heading-8">实体类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;

<span class="hljs-meta">@Entity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-keyword">private</span> String email;

    <span class="hljs-comment">// getters and setters</span>
}
</code></pre>
<h4 data-id="heading-9">DAO类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Repository;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDao</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SessionFactory sessionFactory;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span> {
        sessionFactory.getCurrentSession().save(user);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> sessionFactory.getCurrentSession().get(User.class, id);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory.getCurrentSession().createQuery(<span class="hljs-string">"from User"</span>, User.class).list();
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> findById(id);
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            sessionFactory.getCurrentSession().delete(user);
        }
    }
}
</code></pre>
<h3 data-id="heading-10">6. 编写服务层代码</h3>
<p>服务层通常用于封装业务逻辑，并调用DAO层方法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserDao userDao;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(User user)</span> {
        userDao.save(user);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userDao.findById(id);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userDao.findAll();
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        userDao.delete(id);
    }
}
</code></pre>
<h3 data-id="heading-11">测试</h3>
<p>可以编写一个简单的单元测试来验证配置是否正确。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;

<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceTest</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUserService</span><span class="hljs-params">()</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setName(<span class="hljs-string">"John Doe"</span>);
        user.setEmail(<span class="hljs-string">"john.doe@example.com"</span>);

        userService.saveUser(user);

        <span class="hljs-type">User</span> <span class="hljs-variable">retrievedUser</span> <span class="hljs-operator">=</span> userService.getUserById(user.getId());
        <span class="hljs-keyword">assert</span> retrievedUser != <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">assert</span> <span class="hljs-string">"John Doe"</span>.equals(retrievedUser.getName());
        <span class="hljs-keyword">assert</span> <span class="hljs-string">"john.doe@example.com"</span>.equals(retrievedUser.getEmail());

        userService.deleteUser(user.getId());
    }
}
</code></pre>
<p>通过这些步骤和代码示例，你可以在Spring中成功集成Hibernate，并进行基本的CRUD操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（64）如何在Java EE中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7598574507346886691</link>    <guid>https://juejin.cn/post/7598574507346886691</guid>    <pubDate>2026-01-25T00:50:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598574507346886691" data-draft-id="7598588085596684328" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（64）如何在Java EE中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-25T00:50:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（64）如何在Java EE中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T00:50:04.000Z" title="Sun Jan 25 2026 00:50:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Java EE中使用Hibernate涉及多个步骤，包括配置项目依赖、设置数据源、配置Hibernate、定义实体类、创建DAO层、创建服务层，以及编写应用逻辑。下面是详细的实现步骤和代码示例：</p>
<h3 data-id="heading-0">1. 添加必要的依赖项</h3>
<p>在<code>pom.xml</code>文件中添加Hibernate、JPA和其他相关依赖项。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Hibernate Core --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.32.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- JPA API --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.persistence<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.persistence-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- C3P0 Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mchange<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>c3p0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.5.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置数据源</h3>
<p>在<code>persistence.xml</code>中配置数据源和Hibernate属性。</p>
<h4 data-id="heading-2"><code>persistence.xml</code></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">persistence</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/persistence"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
             <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/persistence http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd"</span>
             <span class="hljs-attr">version</span>=<span class="hljs-string">"2.2"</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">persistence-unit</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"examplePU"</span> <span class="hljs-attr">transaction-type</span>=<span class="hljs-string">"JTA"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">jta-data-source</span>&gt;</span>java:/comp/env/jdbc/MyDataSource<span class="hljs-tag">&lt;/<span class="hljs-name">jta-data-source</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"org.hibernate.dialect.MySQLDialect"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"update"</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">persistence-unit</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">persistence</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">3. 配置Hibernate的SessionFactory</h3>
<p>在<code>persistence.xml</code>中已经配置了数据源和Hibernate属性，不需要再单独配置<code>SessionFactory</code>。</p>
<h3 data-id="heading-4">4. 定义实体类</h3>
<p>定义一个简单的实体类，例如<code>User</code>。</p>
<h4 data-id="heading-5"><code>User.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "username", nullable = false)</span>
    <span class="hljs-keyword">private</span> String username;

    <span class="hljs-meta">@Column(name = "password", nullable = false)</span>
    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }
}
</code></pre>
<h3 data-id="heading-6">5. 创建DAO层</h3>
<p>创建一个数据访问对象（DAO）类，用于访问数据库。</p>
<h4 data-id="heading-7"><code>UserDAO.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.EntityManager;
<span class="hljs-keyword">import</span> javax.persistence.PersistenceContext;
<span class="hljs-keyword">import</span> javax.transaction.Transactional;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDAO</span> {

    <span class="hljs-meta">@PersistenceContext</span>
    <span class="hljs-keyword">private</span> EntityManager entityManager;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span> {
        entityManager.persist(user);
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> entityManager.find(User.class, id);
    }

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> entityManager.createQuery(<span class="hljs-string">"SELECT u FROM User u"</span>, User.class).getResultList();
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(User user)</span> {
        entityManager.merge(user);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> findById(id);
        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
            entityManager.remove(user);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">6. 创建服务层</h3>
<p>创建一个服务类，用于处理业务逻辑。</p>
<h4 data-id="heading-9"><code>UserService.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.ejb.Stateless;
<span class="hljs-keyword">import</span> javax.inject.Inject;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Stateless</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">private</span> UserDAO userDAO;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        userDAO.save(user);
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userDAO.findById(id);
    }

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userDAO.findAll();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        userDAO.update(user);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        userDAO.delete(id);
    }
}
</code></pre>
<h3 data-id="heading-10">7. 编写应用逻辑</h3>
<p>利用上述服务类来编写业务逻辑，例如在Servlet中使用。</p>
<h4 data-id="heading-11"><code>UserServlet.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.inject.Inject;
<span class="hljs-keyword">import</span> javax.servlet.ServletException;
<span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;
<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;
<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@WebServlet("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> {

    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">private</span> UserService userService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        List&lt;User&gt; users = userService.getAllUsers();
        req.setAttribute(<span class="hljs-string">"users"</span>, users);
        req.getRequestDispatcher(<span class="hljs-string">"/userList.jsp"</span>).forward(req, resp);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException {
        <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"username"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">"password"</span>);

        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();
        user.setUsername(username);
        user.setPassword(password);

        userService.createUser(user);

        resp.sendRedirect(req.getContextPath() + <span class="hljs-string">"/users"</span>);
    }
}
</code></pre>
<h3 data-id="heading-12">总结</h3>
<p>以上步骤展示了如何在Java EE项目中使用Hibernate，从配置依赖到编写完整的CRUD操作。通过遵循这些步骤，你可以在Java EE应用中有效地利用Hibernate进行ORM操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 定时任务利器：BackgroundScheduler 从入门到源码]]></title>    <link>https://juejin.cn/post/7598447519824658473</link>    <guid>https://juejin.cn/post/7598447519824658473</guid>    <pubDate>2026-01-24T16:13:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598447519824658473" data-draft-id="7598699872551829540" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 定时任务利器：BackgroundScheduler 从入门到源码 "/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-24T16:13:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 定时任务利器：BackgroundScheduler 从入门到源码 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T16:13:59.000Z" title="Sat Jan 24 2026 16:13:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关键词：APScheduler、BackgroundScheduler、定时任务、非阻塞、线程池、触发器、任务持久化<br/>
适用版本：APScheduler 3.x / 4.x（Python 3.8+）</p>
</blockquote>
<hr/>
<ol start="0">
<li>开场 30 秒<br/>
写 Web 项目时，你是不是也遇到过这样的需求：</li>
</ol>
<ul>
<li>每 30 分钟刷新一次缓存</li>
<li>每天 2:00 清理临时文件</li>
<li>用户下单后 15 分钟未支付则自动关闭订单</li>
</ul>
<p>如果再用 <code>while True + sleep</code> 手写线程，不仅费电，还容易翻车。<br/>
<code>APScheduler</code> 官方给出的「后台调度器」——<code>BackgroundScheduler</code>，30 行代码就能让定时任务在<strong>独立线程</strong>里乖乖跑，<strong>主线程完全不被阻塞</strong>。今天这篇博客带你从安装、配置、触发器、持久化、线程模型一路讲到源码，包教包会。</p>
<hr/>
<ol>
<li>安装 &amp; Hello World</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">pip install apscheduler
</code></pre>
<p>最小可运行示例（每 3 秒打印一次时间）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> apscheduler.schedulers.background <span class="hljs-keyword">import</span> BackgroundScheduler
<span class="hljs-keyword">import</span> time, datetime

<span class="hljs-keyword">def</span> <span class="hljs-title function_">tick</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'Tick! The time is: %s'</span> % datetime.datetime.now())

scheduler = BackgroundScheduler()
scheduler.add_job(tick, <span class="hljs-string">'interval'</span>, seconds=<span class="hljs-number">3</span>)
scheduler.start()

<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:                 <span class="hljs-comment"># 主线程完全空闲，可以干别的</span>
        time.sleep(<span class="hljs-number">2</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'Main thread is free...'</span>)
<span class="hljs-keyword">except</span> (KeyboardInterrupt, SystemExit):
    scheduler.shutdown()
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-csharp" lang="csharp">Main thread <span class="hljs-keyword">is</span> free...
Tick! The time <span class="hljs-keyword">is</span>: <span class="hljs-number">2026</span><span class="hljs-number">-01</span><span class="hljs-number">-24</span> <span class="hljs-number">14</span>:<span class="hljs-number">21</span>:<span class="hljs-number">12</span>
Main thread <span class="hljs-keyword">is</span> free...
Tick! The time <span class="hljs-keyword">is</span>: <span class="hljs-number">2026</span><span class="hljs-number">-01</span><span class="hljs-number">-24</span> <span class="hljs-number">14</span>:<span class="hljs-number">21</span>:<span class="hljs-number">15</span>
...
</code></pre>
<p><strong>结论</strong>：调度任务发生在<strong>后台线程</strong>，主线程继续处理业务逻辑，实现真正的「非阻塞」。</p>
<hr/>
<ol start="2">
<li>架构鸟瞰图（3 大核心 + 1 个仓库）</li>
</ol>
<pre><code class="hljs language-sql" lang="sql">┌<span class="hljs-comment">--------------┐      add_job()       ┌-------------┐</span>
│  Scheduler   │<span class="hljs-comment">--------------------►│ JobStore    │  ← 保存任务元数据</span>
│  (调度器)     │                     └<span class="hljs-comment">-------------┘</span>
└<span class="hljs-comment">------┬-------┘</span>
       │submit
       ▼
┌<span class="hljs-comment">--------------┐      run_job()       ┌-------------┐</span>
│  Executor    │<span class="hljs-comment">--------------------►│  业务函数    │</span>
│ (线程<span class="hljs-operator">/</span>进程池)  │                     └<span class="hljs-comment">-------------┘</span>
└<span class="hljs-comment">--------------┘</span>
       ▲
       │<span class="hljs-keyword">trigger</span>
┌<span class="hljs-comment">--------------┐</span>
│  <span class="hljs-keyword">Trigger</span>     │  决定「下一次」何时触发
└<span class="hljs-comment">--------------┘</span>
</code></pre>
<ul>
<li><strong>Scheduler</strong>：大脑，负责任务生命周期、事件循环。</li>
<li><strong>Trigger</strong>：闹钟，有三种口味：
<ul>
<li><code>date</code> 只闹一次</li>
<li><code>interval</code> 固定间隔</li>
<li><code>cron</code> 类 Linux crontab 表达式</li>
</ul>
</li>
<li><strong>Executor</strong>：干活的，把任务丢进<strong>线程池</strong>（默认）或<strong>进程池</strong>。</li>
<li><strong>JobStore</strong>：仓库，默认放内存，也可换成 MySQL、Redis、MongoDB 实现<strong>宕机续跑</strong>。</li>
</ul>
<hr/>
<ol start="3">
<li>触发器深度拆解</li>
</ol>
<p>3.1 date——一次性任务</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> apscheduler.triggers.date <span class="hljs-keyword">import</span> DateTrigger
trigger = DateTrigger(run_date=<span class="hljs-string">'2026-02-14 15:30:00'</span>)
scheduler.add_job(tick, trigger)
</code></pre>
<p>3.2 interval——循环间隔</p>
<pre><code class="hljs language-python" lang="python">scheduler.add_job(tick, <span class="hljs-string">'interval'</span>, hours=<span class="hljs-number">2</span>, minutes=<span class="hljs-number">30</span>, seconds=<span class="hljs-number">15</span>,
                  start_date=<span class="hljs-string">'2026-01-24 14:00:00'</span>,
                  end_date=<span class="hljs-string">'2026-12-31 23:59:59'</span>)
</code></pre>
<p>3.3 cron——最强日历</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 每周六 05:30 &amp; 20:30 运行</span>
scheduler.add_job(tick, <span class="hljs-string">'cron'</span>,
                  day_of_week=<span class="hljs-string">'sat'</span>,
                  hour=<span class="hljs-string">'5,20'</span>,
                  minute=<span class="hljs-number">30</span>,
                  timezone=<span class="hljs-string">'Asia/Shanghai'</span>)
</code></pre>
<p>支持标准 crontab 写法：<code>* */3 1-5 2-6</code>。</p>
<hr/>
<ol start="4">
<li>Executor：线程 or 进程？<br/>
默认 <code>ThreadPoolExecutor(max_workers=10)</code>，IO 密集型足够。<br/>
如果任务是 CPU 密集型，换进程池：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> apscheduler.executors.pool <span class="hljs-keyword">import</span> ProcessPoolExecutor
executors = {
    <span class="hljs-string">'default'</span>: ProcessPoolExecutor(<span class="hljs-number">4</span>)   <span class="hljs-comment"># 4 核并行</span>
}
scheduler = BackgroundScheduler(executors=executors)
</code></pre>
<blockquote>
<p>注意：进程池要求函数<strong>可序列化</strong>，即在 <code>if __name__ == '__main__':</code> 里定义。</p>
</blockquote>
<hr/>
<ol start="5">
<li>JobStore：让任务「重启不丢」<br/>
内存仓库存放在 <code>dict</code>，进程重启灰飞烟灭。<br/>
生产环境请把任务落库，以 MySQL 为例：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> apscheduler.jobstores.sqlalchemy <span class="hljs-keyword">import</span> SQLAlchemyJobStore
jobstores = {
    <span class="hljs-string">'default'</span>: SQLAlchemyJobStore(url=<span class="hljs-string">'mysql+pymysql://user:pwd@127.0.0.1/apscheduler'</span>)
}
scheduler = BackgroundScheduler(jobstores=jobstores)
</code></pre>
<ul>
<li>调度器启动时会自动把未完成任务<strong>加载回来</strong>；</li>
<li>配合 <code>misfire_grace_time</code> 可补偿因宕机错过的执行。</li>
</ul>
<hr/>
<ol start="6">
<li>常用配置参数速查表<br/>
| 参数 | 说明 | 示例 |
|----|------|------|
| <code>coalesce</code> | 宕机期间积压多次，合并为一次执行 | <code>coalesce=True</code> |
| <code>max_instances</code> | 同一任务并发实例数 | <code>max_instances=3</code> |
| <code>misfire_grace_time</code> | 容错窗口（秒） | <code>misfire_grace_time=600</code> |
| <code>replace_existing</code> | 重复 <code>add_job</code> 是否覆盖 | <code>replace_existing=True</code> |</li>
</ol>
<hr/>
<ol start="7">
<li>源码走马观花（3.10 版本）<br/>
7.1 启动流程<br/>
<code>scheduler.start()</code> →<br/>
<code>_real_add_job()</code> 写 JobStore →<br/>
<code>_main_loop()</code> 在一个<strong>守护线程</strong>里循环：</li>
<li>计算下一次触发时间（<code>trigger.get_next_fire_time</code>）</li>
<li>等待或立即提交到 Executor</li>
<li>任务执行完成回调 <code>_run_job_success()</code> 更新下次触发</li>
</ol>
<p>7.2 线程模型</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># BackgroundScheduler 继承 BaseScheduler</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BackgroundScheduler</span>(<span class="hljs-title class_ inherited__">BaseScheduler</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>(<span class="hljs-params">self, *a, **kw</span>):
        self._main_thread = threading.Thread(target=self._main_loop, daemon=<span class="hljs-literal">True</span>)
        self._main_thread.start()
</code></pre>
<p>守护线程意味着：主线程退出时，调度线程<strong>不会阻止进程结束</strong>，符合“后台”语义。</p>
<hr/>
<ol start="8">
<li>实战：Flask 后台更新缓存</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask
<span class="hljs-keyword">from</span> apscheduler.schedulers.background <span class="hljs-keyword">import</span> BackgroundScheduler

app = Flask(__name__)
scheduler = BackgroundScheduler()

CACHE = {}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">refresh_cache</span>():
    CACHE[<span class="hljs-string">'ts'</span>] = datetime.datetime.now().isoformat()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'[JOB] cache refreshed at'</span>, CACHE[<span class="hljs-string">'ts'</span>])

scheduler.add_job(refresh_cache, <span class="hljs-string">'interval'</span>, seconds=<span class="hljs-number">30</span>)
scheduler.start()

<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():
    <span class="hljs-keyword">return</span> <span class="hljs-string">f'Cache ts: <span class="hljs-subst">{CACHE.get(<span class="hljs-string">"ts"</span>, <span class="hljs-string">"N/A"</span>)}</span>'</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run()
</code></pre>
<p>Flask 主线程专注处理 HTTP 请求，缓存刷新在后台悄悄完成，完美解耦。</p>
<hr/>
<ol start="9">
<li>常见踩坑 FAQ<br/>
| 现象 | 原因 | 解决 |
|----|------|------|
| 任务不执行 | 主线程瞬间结束 | 加 <code>while True</code> 或 <code>join()</code> |
| 重复执行 | 多进程启动时每个进程都 <code>start()</code> | 保证只在 master 进程 <code>start</code> |
| 函数内日志不打印 | Executor 线程里未配置 logger | 给 APScheduler 单独配 <code>logging</code> |
| 修改任务时间不生效 | 默认 <code>replace_existing=False</code> | <code>add_job(..., replace_existing=True)</code> |</li>
</ol>
<hr/>
<ol start="10">
<li>小结 &amp; 思维导图</li>
<li>BackgroundScheduler = <strong>非阻塞</strong> + <strong>线程池</strong> + <strong>可持久化</strong></li>
<li>三步走：选 Trigger → 选 Executor → 选 JobStore</li>
<li>生产环境务必配置<strong>时区</strong>、<strong>misfire_grace_time</strong> 与<strong>数据库仓库</strong></li>
<li>源码精髓：守护线程 <code>_main_loop</code> 驱动事件表，Executor 负责任务执行</li>
</ol>
<blockquote>
<p>把这篇收藏起来，下次再写「定时脚本」时，直接 <code>pip install apscheduler</code>，30 秒上线，准点下班！</p>
</blockquote>
<hr/>
<p>参考文献<br/>
51CTO《使用 Python BackgroundScheduler 的完整流程》<br/>
CSDN《Python任务调度库之apscheduler使用详解》<br/>
CSDN《BackgroundScheduler 使用原创》<br/>
CSDN《Python任务调度框架APScheduler详解》<br/>
CSDN《python调度框架APScheduler使用详解》</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第二十三章(Next配置文件)]]></title>    <link>https://juejin.cn/post/7598614012184641563</link>    <guid>https://juejin.cn/post/7598614012184641563</guid>    <pubDate>2026-01-24T22:11:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598614012184641563" data-draft-id="7598614012184625179" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第二十三章(Next配置文件)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2026-01-24T22:11:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第二十三章(Next配置文件)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T22:11:22.000Z" title="Sat Jan 24 2026 22:11:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">next.config.js配置</h2>
<p>本章会讲解Next.js的配置文件<code>next.config.js</code>的配置项。注：本章不会讲所有的配置项，只会讲使用率<code>50%</code>的配置项，以及项目中真实使用的配置项。</p>
<p>查看完整版配置项观看: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fapi-reference%2Fconfig%2Fnext-config-js%2FadapterPath" target="_blank" title="https://nextjs.org/docs/app/api-reference/config/next-config-js/adapterPath" ref="nofollow noopener noreferrer">next.config.js配置</a></p>
<h4 data-id="heading-1">根据不同环境进行配置</h4>
<p>例如我想在开发环境配置 XXX，或者生产环境配置YYY，那么我们可以使用<code>next/constants</code>来判断当前环境。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//Next.js next/constants内置的常量</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PHASE_EXPORT</span> = <span class="hljs-string">"phase-export"</span>; <span class="hljs-comment">// 导出静态站点</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PHASE_PRODUCTION_BUILD</span> = <span class="hljs-string">"phase-production-build"</span>; <span class="hljs-comment">// 生产环境构建</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PHASE_PRODUCTION_SERVER</span> = <span class="hljs-string">"phase-production-server"</span>; <span class="hljs-comment">// 生产环境服务器</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PHASE_DEVELOPMENT_SERVER</span> = <span class="hljs-string">"phase-development-server"</span>; <span class="hljs-comment">// 开发环境服务器</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PHASE_TEST</span> = <span class="hljs-string">"phase-test"</span>; <span class="hljs-comment">// 测试环境</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PHASE_INFO</span> = <span class="hljs-string">"phase-info"</span>; <span class="hljs-comment">// 信息</span>
</code></pre>
<p>我们要根据不同环境配置，需要返回一个函数，而不是直接返回一个对象，在函数中会接受一个参数<code>phase</code>，这个参数是Next.js的环境，我们可以根据这个参数来判断当前环境。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">//next.config.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PHASE_DEVELOPMENT_SERVER</span>, <span class="hljs-variable constant_">PHASE_TYPE</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/constants'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> (<span class="hljs-attr">phase</span>: <span class="hljs-variable constant_">PHASE_TYPE</span>): <span class="hljs-function"><span class="hljs-params">NextConfig</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
     <span class="hljs-attr">reactCompiler</span>: <span class="hljs-literal">false</span>,
  }

  <span class="hljs-keyword">if</span> (phase === <span class="hljs-variable constant_">PHASE_DEVELOPMENT_SERVER</span>) {
    nextConfig.<span class="hljs-property">reactCompiler</span> = <span class="hljs-literal">true</span> <span class="hljs-comment">// 开发环境使用reactCompiler</span>
  }

  <span class="hljs-comment">//if() 其他环境.....</span>

  <span class="hljs-keyword">return</span> nextConfig
}
</code></pre>
<h4 data-id="heading-2">Next.js配置端口号</h4>
<p>这是Next.js很迷的一个操作，通过一般脚手架或者其他项目都会在配置文件进行配置端口号，但是Next.js却没有，而是在启动命令中进行配置。(默认是3000端口)</p>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"next dev -p 8888"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 开发环境端口号</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"next build"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"next start -p 9999 "</span> <span class="hljs-comment">// 生产环境端口号</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<h4 data-id="heading-3">Next.js导出静态站点</h4>
<p>需要在<code>next.config.js</code>文件中配置<code>output</code>为<code>export</code>，表示导出静态站点。<code>distDir</code>表示导出目录，默认为<code>out</code>。</p>
<p>具体用法请查看: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs-docs-henna-six.vercel.app%2Ftutorials%2Fssg" target="_blank" title="https://nextjs-docs-henna-six.vercel.app/tutorials/ssg" ref="nofollow noopener noreferrer">静态导出SSG</a></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">output</span>: <span class="hljs-string">"export"</span>, <span class="hljs-comment">// 导出静态站点</span>
  <span class="hljs-attr">distDir</span>: <span class="hljs-string">"dist"</span>, <span class="hljs-comment">// 导出目录</span>
  <span class="hljs-attr">trailingSlash</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 添加尾部斜杠，生成 /about/index.html 而不是 /about.html</span>
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<h4 data-id="heading-4">Next.js配置图片优化</h4>
<p>Next.js<code>Image</code>组件默认只允许加载本地图片，如果需要加载远程图片，需要配置<code>next.config.js</code>文件。</p>
<p>详细用法请查看: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs-docs-henna-six.vercel.app%2Ftutorials%2Fimage" target="_blank" title="https://nextjs-docs-henna-six.vercel.app/tutorials/image" ref="nofollow noopener noreferrer">图片优化</a></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">remotePatterns</span>: [
      {
        <span class="hljs-attr">protocol</span>: <span class="hljs-string">'https'</span>, <span class="hljs-comment">// 协议</span>
        <span class="hljs-attr">hostname</span>: <span class="hljs-string">'eo-img.521799.xyz'</span>, <span class="hljs-comment">// 主机名</span>
        <span class="hljs-attr">pathname</span>: <span class="hljs-string">'/i/pc/**'</span>, <span class="hljs-comment">// 路径</span>
        <span class="hljs-attr">port</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// 端口</span>
      },
    ],
    <span class="hljs-attr">formats</span>: [<span class="hljs-string">'image/avif'</span>, <span class="hljs-string">'image/webp'</span>], <span class="hljs-comment">//默认是 ['image/webp']</span>
    <span class="hljs-attr">deviceSizes</span>: [<span class="hljs-number">640</span>, <span class="hljs-number">750</span>, <span class="hljs-number">828</span>, <span class="hljs-number">1080</span>, <span class="hljs-number">1200</span>, <span class="hljs-number">1920</span>, <span class="hljs-number">2048</span>, <span class="hljs-number">3840</span>], <span class="hljs-comment">// 设备尺寸</span>
    <span class="hljs-attr">imageSizes</span>: [<span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">48</span>, <span class="hljs-number">64</span>, <span class="hljs-number">96</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">384</span>], <span class="hljs-comment">// 图片尺寸</span>
  },
};
</code></pre>
<h4 data-id="heading-5">自定义响应标头</h4>
<p>例如配置<code>CORS</code>跨域，或者是自定义响应标头等，只要是http支持的响应头都可以配置。</p>
<p>HTTP响应头参考: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTTP%2FHeaders" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers" ref="nofollow noopener noreferrer">HTTP响应头</a></p>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
     <span class="hljs-attr">headers</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> [
         {
          <span class="hljs-attr">source</span>: <span class="hljs-string">'/:path*'</span>, <span class="hljs-comment">// 匹配路径 所有路径 也支持精准匹配 例如/api/user 包括支持动态路由等 /api/user/:id </span>
          <span class="hljs-attr">headers</span>: [
            {
              <span class="hljs-attr">key</span>: <span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-comment">//允许跨域</span>
              <span class="hljs-attr">value</span>: <span class="hljs-string">'*'</span> <span class="hljs-comment">// 允许所有域名访问</span>
            },
            {
              <span class="hljs-attr">key</span>: <span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-comment">//允许的请求方法</span>
              <span class="hljs-attr">value</span>: <span class="hljs-string">'GET, POST, PUT, DELETE, OPTIONS'</span> <span class="hljs-comment">// 允许的请求方法</span>
            },
            {
              <span class="hljs-attr">key</span>: <span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-comment">//允许的请求头</span>
              <span class="hljs-attr">value</span>: <span class="hljs-string">'Content-Type, Authorization'</span> <span class="hljs-comment">// 允许的请求头</span>
            }
          ]
         },
         {
          <span class="hljs-attr">source</span>: <span class="hljs-string">'/home'</span>, <span class="hljs-comment">// 精准匹配 /home 路径</span>
          <span class="hljs-attr">headers</span>: [
            {
              <span class="hljs-attr">key</span>: <span class="hljs-string">'X-Custom-Header'</span>, <span class="hljs-comment">//自定义响应头</span>
              <span class="hljs-attr">value</span>: <span class="hljs-string">'123456'</span> <span class="hljs-comment">// 值</span>
            },
          ]
         }
      ]
    }
  }
</code></pre>
<h4 data-id="heading-6">assetsPrefix配置</h4>
<p>assetsPrefix配置用于配置静态资源前缀，例如：部署到CDN后，静态资源路径会发生变化，需要配置这个配置项。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">assetsPrefix</span>: <span class="hljs-string">'https://cdn.example.com'</span>, <span class="hljs-comment">// 静态资源前缀</span>
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<p>未配置assetsPrefix时：</p>
<pre><code class="hljs language-txt" lang="txt">/_next/static/chunks/4b9b41aaa062cbbfeff4add70f256968c51ece5d.4d708494b3aed70c04f0.js
</code></pre>
<p>配置assetsPrefix后：</p>
<pre><code class="hljs language-txt" lang="txt">https://cdn.example.com/_next/static/chunks/4b9b41aaa062cbbfeff4add70f256968c51ece5d.4d708494b3aed70c04f0.js
</code></pre>
<h4 data-id="heading-7">basePath配置</h4>
<p>应用前缀：也就是跳转路径中增加前缀，例如前缀是<code>/docs</code>，那么跳转<code>/home</code>就需要跳转到<code>/docs/home</code>。访问根目录也需要增加前缀，例如访问<code>/</code>就需要跳转到<code>/docs</code>。这儿可以使用重定向来实现。访问<code>/</code>自动跳转到<code>/docs</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">basePath</span>: <span class="hljs-string">'/docs'</span>, <span class="hljs-comment">// 基础路径</span>
  <span class="hljs-title function_">redirects</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> [
      {
        <span class="hljs-attr">source</span>: <span class="hljs-string">'/'</span>, <span class="hljs-comment">// 源路径</span>
        <span class="hljs-attr">destination</span>: <span class="hljs-string">'/docs'</span>, <span class="hljs-comment">// 目标路径</span>
        <span class="hljs-attr">basePath</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否使用basePath 默认情况下 source 和 destination 都会自动加上 basePath 前缀 就变成了/docs/docs 所以这儿不需要增加</span>
        <span class="hljs-attr">permanent</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 是否永久重定向</span>
      },
    ]
  },
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<p>如果使用link跳转的话，无需增加<code>basePath</code>前缀，因为<code>Link</code>组件会自动增加<code>basePath</code>前缀。
当他跳转<code>/home</code>时，会自动跳转到<code>/docs/home</code>。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/link'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>小满zs Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/home"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>)
}
</code></pre>
<h4 data-id="heading-8">compress</h4>
<p>compress配置用于配置压缩，例如：压缩js/css/html等。默认情况是开启的，如果需要关闭，可以配置为false。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-attr">compress</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 压缩</span>
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<h4 data-id="heading-9">日志配置</h4>
<p>日志配置用于配置日志，例如：显示完整的URL等。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-attr">logging</span>:{
    <span class="hljs-attr">fetches</span>: {
      <span class="hljs-attr">fullUrl</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 显示完整的URL</span>
    },
  }
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<h4 data-id="heading-10">页面扩展</h4>
<p>默认情况下，Next.js 接受以下扩展名的文件：.tsx.js、 .js .ts、.jsx.md、.js.js。可以修改此设置以允许其他扩展名，例如 markdown（.md.md、.md .mdx）。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-attr">pageExtensions</span>: [<span class="hljs-string">'js'</span>, <span class="hljs-string">'jsx'</span>, <span class="hljs-string">'md'</span>, <span class="hljs-string">'mdx'</span>, <span class="hljs-string">'ts'</span>, <span class="hljs-string">'tsx'</span>],
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<h4 data-id="heading-11">devIndicators</h4>
<p>关闭调试指示器，默认情况下是开启的，如果需要关闭，可以配置为false。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-attr">devIndicators</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 关闭开发指示器</span>
  <span class="hljs-comment">// devIndicators:{</span>
  <span class="hljs-comment">//   position:'bottom-right', //也支持放入其他位置 bottom-right bottom-left top-right top-left</span>
  <span class="hljs-comment">// },</span>
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/365f45aca6c6429b98777ed11d5c453f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769897482&amp;x-signature=ImE2PAFfzWSnHx9mdvRAW4srFnw%3D" alt="image.png" width="100%" loading="lazy"/>
<h4 data-id="heading-12">generateEtags</h4>
<p>Next.js会为静态文件生成ETag，用于缓存控制。默认情况下是开启的，如果需要关闭，可以配置为false。</p>
<p>浏览器会根据ETag来判断文件是否发生变化，如果发生变化，则重新下载文件。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-attr">generateEtags</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 关闭生成ETag 默认开启</span>
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre>
<h4 data-id="heading-13">turbopack</h4>
<p>Next.js已内置turbopack进行打包编译等操作，所以允许透传配置项给turbopack。</p>
<p>一般情况下是不需要做太多优化的，因为它都内置了例如<code>tree-shaking</code>、<code>压缩</code> <code>按需编译</code> <code>语法降级</code> 等优化。</p>
<p>具体用法请查看: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fapi-reference%2Fconfig%2Fnext-config-js%2Fturbopack" target="_blank" title="https://nextjs.org/docs/app/api-reference/config/next-config-js/turbopack" ref="nofollow noopener noreferrer">turbopack</a></p>
<p>例如我们需要编译其他文件<code>less</code>配置如下:</p>
<pre><code class="hljs language-bash" lang="bash">npm i less-loader -D
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
    <span class="hljs-attr">turbopack</span>:{
     <span class="hljs-attr">rules</span>:{
          <span class="hljs-string">'*.less'</span>:{
          <span class="hljs-attr">loaders</span>:[<span class="hljs-string">'less-loader'</span>],
          <span class="hljs-attr">as</span>:<span class="hljs-string">'*.css'</span>,
        }
     }
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 常用调试工具大全-打造你的调试武器库]]></title>    <link>https://juejin.cn/post/7598712670153883657</link>    <guid>https://juejin.cn/post/7598712670153883657</guid>    <pubDate>2026-01-24T16:55:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598712670153883657" data-draft-id="7598333055544623144" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 常用调试工具大全-打造你的调试武器库"/> <meta itemprop="keywords" content="Debug"/> <meta itemprop="datePublished" content="2026-01-24T16:55:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 常用调试工具大全-打造你的调试武器库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T16:55:17.000Z" title="Sat Jan 24 2026 16:55:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>还记得你第一次使用<code>NSLog(@"Hello, World!")</code>的时刻吗？那是调试的起点。但随着应用复杂度呈指数级增长，我们需要的工具也经历了革命性进化：</p>
<ul>
<li><strong>第一代</strong>：基础输出（<code>NSLog</code>、<code>print</code>）</li>
<li><strong>第二代</strong>：图形化界面（Xcode调试器、Instruments）</li>
<li><strong>第三代</strong>：运行时动态调试（FLEX、Lookin）</li>
<li><strong>第四代</strong>：智能化监控（性能追踪、自动化检测）</li>
</ul>
<p>今天，一个成熟的iOS开发者工具箱中，<strong>至少需要掌握3-5种核心调试工具</strong>，它们就像外科医生的手术刀——精准、高效、各有所长。</p>
<h2 data-id="heading-0">一、运行时调试工具</h2>
<h3 data-id="heading-1"><strong>1. FLEX (Flipboard Explorer)</strong></h3>
<p>功能最全的运行时调试套件，集成后可以测试期间随时开启\关闭工具条，比如设置摇一摇后启动。</p>
<pre><code class="hljs language-swift" lang="swift">优点: 功能全面，无需连接电脑
缺点: 内存占用稍大
场景: 日常开发调试<span class="hljs-operator">、</span><span class="hljs-type">UI问题排查</span>
<span class="hljs-type">GitHub</span>: https:<span class="hljs-comment">//github.com/FLEXTool/FLEX?tab=readme-ov-file</span>
</code></pre>
<p>主要功能：</p>
<ul>
<li>手机上检查和修改层次结构中的视图。</li>
<li>查看对象内存分配，查看任何对象的属性和ivar，动态修改许多属性和ivar，动态调用实例和类方法。</li>
<li>查看详细的网络请求历史记录，包括时间、标头和完整响应。</li>
<li>查看系统日志消息（例如，来自NSLog）。</li>
<li>查看沙盒中的文件，查看所有的bundle和资源文件，浏览文件系统中的SQLite/Rerm数据库。</li>
<li>动态查看和修改NSUserDefaults值。</li>
</ul>
<h3 data-id="heading-2"><strong>2. Lookin</strong> - <strong>腾讯出品</strong></h3>
<p>3D视图层级工具，类Xcode Inspector和Reveal。相比Xcode中查看图层的优势有两个：</p>
<ul>
<li>独立于Xcode运行，不会被Xcode阻断，能显示view的被引用的属性名。</li>
<li>集成了'LookinServer'库的APP启动后，在Mac上启动<code>Lookin</code>后即可刷新显示当前图层。（真机需连接电脑后才展示）</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 集成步骤一：官网下载lookin；</span>
<span class="hljs-operator">-</span>  官网: https:<span class="hljs-comment">//lookin.work</span>
<span class="hljs-operator">-</span>  <span class="hljs-type">GitHub</span>: https:<span class="hljs-comment">//github.com/QMUI/LookinServer</span>

<span class="hljs-comment">// 集成步骤二：</span>
<span class="hljs-type">CocoaPods安装</span>:
<span class="hljs-comment">// 1.如果是OC工程</span>
pod '<span class="hljs-type">LookinServer</span>', :configurations <span class="hljs-operator">=&gt;</span> ['<span class="hljs-type">Debug</span>']
<span class="hljs-comment">// 2.如果是OC工程</span>
<span class="hljs-comment">// 在 iOS 项目的 Podfile 中 添加 “Swift” 这个 Subspec</span>
pod '<span class="hljs-type">LookinServer</span>', :subspecs <span class="hljs-operator">=&gt;</span> ['<span class="hljs-type">Swift</span>'], :configurations <span class="hljs-operator">=&gt;</span> ['<span class="hljs-type">Debug</span>']
<span class="hljs-comment">// 或者添加 “SwiftAndNoHook”这个 Subspec 也行</span>
pod '<span class="hljs-type">LookinServer</span>', :subspecs <span class="hljs-operator">=&gt;</span> ['<span class="hljs-type">SwiftAndNoHook</span>'], :configurations <span class="hljs-operator">=&gt;</span> ['<span class="hljs-type">Debug</span>']

</code></pre>
<h2 data-id="heading-3">二、网络调试工具</h2>
<h3 data-id="heading-4"><strong>1. Proxyman</strong> - <strong>现代网络调试神器</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 官网: https://proxyman.io</span>
<span class="hljs-comment">// 特点:</span>
<span class="hljs-operator">✅</span> 现代<span class="hljs-type">UI，操作流畅</span>
<span class="hljs-operator">✅</span> <span class="hljs-type">HTTPS解密（无需安装证书到系统）</span>
<span class="hljs-operator">✅</span> 重放<span class="hljs-operator">、</span>修改<span class="hljs-operator">、</span>拦截请求
<span class="hljs-operator">✅</span> <span class="hljs-type">Map</span> <span class="hljs-type">Local</span><span class="hljs-operator">/</span><span class="hljs-type">Map</span> <span class="hljs-type">Remote功能</span>
<span class="hljs-operator">✅</span> 脚本支持（<span class="hljs-type">JavaScript）</span>
<span class="hljs-operator">✅</span> 支持<span class="hljs-type">Apple</span> <span class="hljs-type">Silicon</span>

使用场景:
<span class="hljs-operator">•</span> <span class="hljs-type">API接口调试</span>
<span class="hljs-operator">•</span> 图片<span class="hljs-operator">/</span>资源请求优化
<span class="hljs-operator">•</span> 模拟慢速网络
<span class="hljs-operator">•</span> 修改响应数据测试
</code></pre>
<h3 data-id="heading-5"><strong>2. Charles</strong> - <strong>老牌网络代理</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 官网: https://www.charlesproxy.com</span>
<span class="hljs-comment">// 特点:</span>
<span class="hljs-operator">✅</span> 功能极其全面
<span class="hljs-operator">✅</span> 跨平台支持
<span class="hljs-operator">✅</span> 脚本功能强大（<span class="hljs-type">Charles</span> <span class="hljs-type">Proxy</span> <span class="hljs-type">Script）</span>
<span class="hljs-operator">✅</span> 带宽限制<span class="hljs-operator">、</span>断点调试
<span class="hljs-operator">✅</span> 支持<span class="hljs-type">HTTP</span><span class="hljs-operator">/</span><span class="hljs-number">2</span><span class="hljs-operator">、</span><span class="hljs-type">HTTP</span><span class="hljs-operator">/</span><span class="hljs-number">3</span>

设置步骤:
<span class="hljs-number">1</span>. 安装<span class="hljs-type">Charles</span>
<span class="hljs-number">2</span>. 在iOS设备设置代理
<span class="hljs-number">3</span>. 安装<span class="hljs-type">Charles根证书</span>
<span class="hljs-number">4</span>. 信任证书（设置<span class="hljs-operator">→</span>通用<span class="hljs-operator">→</span>关于<span class="hljs-operator">→</span>证书信任设置）

<span class="hljs-comment">// 常用功能:</span>
<span class="hljs-operator">•</span> <span class="hljs-type">Breakpoints（请求拦截修改）</span>
<span class="hljs-operator">•</span> <span class="hljs-type">Rewrite（规则重写）</span>
<span class="hljs-operator">•</span> <span class="hljs-type">Map</span> <span class="hljs-type">Local（本地文件映射）</span>
<span class="hljs-operator">•</span> <span class="hljs-type">Throttle（网络限速）</span>
</code></pre>
<h3 data-id="heading-6"><strong>3. mitmproxy</strong> - <strong>开源命令行工具</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 官网: https://mitmproxy.org</span>
<span class="hljs-comment"># 特点:</span>
✅ 完全开源免费
✅ 命令行操作，适合自动化
✅ 脚本扩展（Python）
✅ 支持透明代理

<span class="hljs-comment"># 安装:</span>
brew install mitmproxy

<span class="hljs-comment"># 使用:</span>
<span class="hljs-comment"># 启动代理</span>
mitmproxy --mode transparent --showhost

<span class="hljs-comment"># iOS设置:</span>
<span class="hljs-comment"># 1. 安装证书: mitm.it</span>
<span class="hljs-comment"># 2. 配置Wi-Fi代理</span>
</code></pre>
<h2 data-id="heading-7">三、UI/布局调试工具</h2>
<h3 data-id="heading-8"><strong>1. Reveal</strong> - <strong>专业的UI调试工具</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 官网: https://revealapp.com</span>
<span class="hljs-comment">// 特点:</span>
<span class="hljs-operator">✅</span> 实时3D视图层级
<span class="hljs-operator">✅</span> 详细的<span class="hljs-type">AutoLayout约束查看</span>
<span class="hljs-operator">✅</span> 内存图查看器
<span class="hljs-operator">✅</span> 支持<span class="hljs-type">SwiftUI预览</span>
<span class="hljs-operator">✅</span> 强大的筛选和搜索

<span class="hljs-comment">// 集成:</span>
<span class="hljs-comment">// 方式1: 通过Reveal Server框架</span>
pod '<span class="hljs-type">Reveal</span><span class="hljs-operator">-</span><span class="hljs-type">SDK</span>', :configurations <span class="hljs-operator">=&gt;</span> ['<span class="hljs-type">Debug</span>']

<span class="hljs-comment">// 方式2: LLDB加载（无需集成代码）</span>
(lldb) expr (void)[[<span class="hljs-type">NSClassFromString</span>(@<span class="hljs-string">"IBARevealLoader"</span>) <span class="hljs-keyword">class</span>] <span class="hljs-title class_">revealApplication</span>];

// 价格: 付费（提供免费试用）
</code></pre>
<h3 data-id="heading-9"><strong>2. InjectionIII</strong> - <strong>热重载神器</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// GitHub: https://github.com/johnno1962/InjectionIII</span>
<span class="hljs-comment">// 特点:</span>
<span class="hljs-operator">✅</span> 代码修改后实时生效
<span class="hljs-operator">✅</span> 无需重新编译运行
<span class="hljs-operator">✅</span> 支持<span class="hljs-type">Swift和Objective</span><span class="hljs-operator">-</span><span class="hljs-type">C</span>
<span class="hljs-operator">✅</span> 保留应用状态

<span class="hljs-comment">// 安装:</span>
# <span class="hljs-type">App</span> <span class="hljs-type">Store搜索</span> <span class="hljs-string">"InjectionIII"</span>

<span class="hljs-comment">// 配置:</span>
<span class="hljs-number">1</span>. 下载安装<span class="hljs-type">InjectionIII</span>
<span class="hljs-number">2</span>. 在<span class="hljs-type">AppDelegate中配置</span>:
<span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
<span class="hljs-type">Bundle</span>(path: <span class="hljs-string">"/Applications/InjectionIII.app/Contents/Resources/iOSInjection.bundle"</span>)<span class="hljs-operator">?</span>.load()
<span class="hljs-keyword">#endif</span>

<span class="hljs-number">3</span>. 项目添加文件监视:
<span class="hljs-comment">// 在InjectionIII App中添加项目路径</span>
</code></pre>
<h2 data-id="heading-10">四、性能调试工具</h2>
<h3 data-id="heading-11"><strong>1. Xcode Instruments</strong> - <strong>官方性能分析套件</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 核心工具集:</span>
<span class="hljs-operator">┌─────────────────────────────────────┐</span>
<span class="hljs-operator">│</span>          <span class="hljs-type">Xcode</span> <span class="hljs-type">Instruments</span>          <span class="hljs-operator">│</span>
<span class="hljs-operator">├─────────────────────────────────────┤</span>
<span class="hljs-operator">│</span> <span class="hljs-type">Time</span> <span class="hljs-type">Profiler</span>    # <span class="hljs-type">CPU使用分析</span>       <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> <span class="hljs-type">Allocations</span>      # 内存分配分析      <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> <span class="hljs-type">Leaks</span>           # 内存泄漏检测      <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> <span class="hljs-type">Network</span>         # 网络活动分析      <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> <span class="hljs-type">Energy</span> <span class="hljs-type">Log</span>      # 电量消耗分析      <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> <span class="hljs-type">Metal</span> <span class="hljs-type">System</span>    # <span class="hljs-type">GPU性能分析</span>       <span class="hljs-operator">│</span>
<span class="hljs-operator">│</span> <span class="hljs-type">SwiftUI</span>         # <span class="hljs-type">SwiftUI性能分析</span>   <span class="hljs-operator">│</span>
<span class="hljs-operator">└─────────────────────────────────────┘</span>

<span class="hljs-comment">// 使用技巧:</span>
<span class="hljs-number">1</span>. 录制时过滤系统调用:
   <span class="hljs-type">Call</span> <span class="hljs-type">Tree</span>: <span class="hljs-operator">✅</span> <span class="hljs-type">Hide</span> <span class="hljs-type">System</span> <span class="hljs-type">Libraries</span>
              <span class="hljs-operator">✅</span> <span class="hljs-type">Invert</span> <span class="hljs-type">Call</span> <span class="hljs-type">Tree</span>
              <span class="hljs-operator">✅</span> <span class="hljs-type">Flattern</span> <span class="hljs-type">Recursion</span>

<span class="hljs-number">2</span>. 内存图调试:
   <span class="hljs-type">Debug</span> <span class="hljs-type">Memory</span> <span class="hljs-type">Graph按钮</span>
   查看循环引用<span class="hljs-operator">、</span>内存泄漏

<span class="hljs-number">3</span>. 使用<span class="hljs-type">Markers</span>:
   <span class="hljs-keyword">import</span> os
   <span class="hljs-keyword">let</span> log <span class="hljs-operator">=</span> <span class="hljs-type">OSLog</span>(subsystem: <span class="hljs-string">"com.app"</span>, category: <span class="hljs-string">"performance"</span>)
   os_signpost(.begin, log: log, name: <span class="hljs-string">"Network Request"</span>)
   <span class="hljs-comment">// ... 操作</span>
   os_signpost(.end, log: log, name: <span class="hljs-string">"Network Request"</span>)
</code></pre>
<h3 data-id="heading-12"><strong>2. MetricKit</strong> - <strong>线上性能监控框架</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Apple官方性能数据收集框架</span>
<span class="hljs-keyword">import</span> MetricKit

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MetricKitManager</span>: <span class="hljs-title class_">MXMetricManagerSubscriber</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">MetricKitManager</span>()
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">init</span>() {
        <span class="hljs-keyword">let</span> manager <span class="hljs-operator">=</span> <span class="hljs-type">MXMetricManager</span>.shared
        manager.add(<span class="hljs-keyword">self</span>)
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didReceive</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">payloads</span>: [<span class="hljs-type">MXMetricPayload</span>]) {
        <span class="hljs-comment">// 接收性能数据</span>
        <span class="hljs-keyword">for</span> payload <span class="hljs-keyword">in</span> payloads {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"CPU: <span class="hljs-subst">\(payload.cpuMetrics)</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"内存: <span class="hljs-subst">\(payload.memoryMetrics)</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"启动时间: <span class="hljs-subst">\(payload.launchMetrics)</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"磁盘IO: <span class="hljs-subst">\(payload.diskIOMetrics)</span>"</span>)
        }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">didReceive</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">payloads</span>: [<span class="hljs-type">MXDiagnosticPayload</span>]) {
        <span class="hljs-comment">// 接收诊断数据（崩溃、卡顿等）</span>
    }
}

<span class="hljs-comment">// 需要用户授权，适合生产环境监控</span>
</code></pre>
<h3 data-id="heading-13"><strong>3. Tracy</strong> - <strong>腾讯开源的性能监控</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// GitHub: https://github.com/Tencent/tracy</span>
<span class="hljs-comment">// 特点:</span>
<span class="hljs-operator">✅</span> 卡顿监控（主线程阻塞检测）
<span class="hljs-operator">✅</span> 内存泄漏检测
<span class="hljs-operator">✅</span> 大对象分配监控
<span class="hljs-operator">✅</span> 网络性能监控
<span class="hljs-operator">✅</span> 崩溃收集

<span class="hljs-comment">// 集成:</span>
pod '<span class="hljs-type">Tracy</span>', :configurations <span class="hljs-operator">=&gt;</span> ['<span class="hljs-type">Debug</span>']

<span class="hljs-comment">// 使用:</span>
<span class="hljs-type">Tracy</span>.start()
<span class="hljs-comment">// 自动监控各种性能指标</span>
</code></pre>
<h2 data-id="heading-14">五、内存/崩溃调试工具</h2>
<h3 data-id="heading-15"><strong>1. MLeaksFinder</strong> - <strong>腾讯出品的内存泄漏检测</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// GitHub: https://github.com/Tencent/MLeaksFinder</span>
<span class="hljs-comment">// 特点:</span>
<span class="hljs-operator">✅</span> 自动检测视图控制器内存泄漏
<span class="hljs-operator">✅</span> 无需编写任何代码
<span class="hljs-operator">✅</span> 支持自定义白名单
<span class="hljs-operator">✅</span> 精准定位泄漏对象

<span class="hljs-comment">// 原理:</span>
<span class="hljs-comment">// 监听UIViewController的pop/dismiss</span>
<span class="hljs-comment">// 延迟检查是否仍然存在</span>

<span class="hljs-comment">// 集成:</span>
pod '<span class="hljs-type">MLeaksFinder</span>'

<span class="hljs-comment">// 自定义配置:</span>
<span class="hljs-comment">// 1. 添加白名单</span>
[<span class="hljs-type">NSClassFromString</span>(@<span class="hljs-string">"WhiteListClass"</span>) <span class="hljs-keyword">class</span>]

// 2. 忽略特定泄漏
[<span class="hljs-title class_">MLeaksFinder</span> <span class="hljs-title class_">addIgnoreClass</span>:[<span class="hljs-title class_">IgnoreClass</span> <span class="hljs-title class_">class</span>]]
</code></pre>
<h3 data-id="heading-16"><strong>2. FBRetainCycleDetector</strong> - <strong>Facebook循环引用检测</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// GitHub: https://github.com/facebook/FBRetainCycleDetector</span>
<span class="hljs-comment">// 特点:</span>
<span class="hljs-operator">✅</span> 检测<span class="hljs-type">Objective</span><span class="hljs-operator">-</span><span class="hljs-type">C对象的循环引用</span>
<span class="hljs-operator">✅</span> 支持检测<span class="hljs-type">NSTimer的强引用</span>
<span class="hljs-operator">✅</span> 可集成到单元测试中
<span class="hljs-operator">✅</span> <span class="hljs-type">Facebook内部广泛使用</span>

<span class="hljs-comment">// 使用:</span>
<span class="hljs-keyword">let</span> detector <span class="hljs-operator">=</span> <span class="hljs-type">FBRetainCycleDetector</span>()
detector.addCandidate(myObject)
<span class="hljs-keyword">let</span> cycles <span class="hljs-operator">=</span> detector.findRetainCycles()

<span class="hljs-comment">// 输出格式化的循环引用链</span>
<span class="hljs-keyword">for</span> cycle <span class="hljs-keyword">in</span> cycles {
    <span class="hljs-built_in">print</span>(<span class="hljs-type">FBRetainCycleDetectorFormatter</span>.format(cycle))
}
</code></pre>
<h3 data-id="heading-17"><strong>3. KSCrash</strong> - <strong>强大的崩溃收集框架</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// GitHub: https://github.com/kstenerud/KSCrash</span>
<span class="hljs-comment">// 特点:</span>
<span class="hljs-operator">✅</span> 捕获所有类型崩溃（<span class="hljs-type">OC异常</span><span class="hljs-operator">、</span><span class="hljs-type">C</span><span class="hljs-operator">++</span>异常<span class="hljs-operator">、</span><span class="hljs-type">Mach异常等）</span>
<span class="hljs-operator">✅</span> 生成完整的崩溃报告
<span class="hljs-operator">✅</span> 支持符号化
<span class="hljs-operator">✅</span> 可自定义上报服务器

<span class="hljs-comment">// 集成:</span>
pod '<span class="hljs-type">KSCrash</span>'

<span class="hljs-comment">// 配置:</span>
<span class="hljs-keyword">import</span> KSCrash

<span class="hljs-keyword">let</span> installation <span class="hljs-operator">=</span> makeEmailInstallation(<span class="hljs-string">"crash@company.com"</span>)
installation.addConditionalAlert(withTitle: <span class="hljs-string">"Crash Detected"</span>,
                                message: <span class="hljs-string">"The app crashed last time"</span>)
<span class="hljs-type">KSCrash</span>.shared().install()

<span class="hljs-comment">// 高级功能:</span>
<span class="hljs-comment">// 1. 用户数据记录</span>
<span class="hljs-type">KSCrash</span>.shared().userInfo <span class="hljs-operator">=</span> [<span class="hljs-string">"user_id"</span>: <span class="hljs-string">"123"</span>]

<span class="hljs-comment">// 2. 自定义日志</span>
<span class="hljs-type">KSCrash</span>.shared().log.error(<span class="hljs-string">"Something went wrong"</span>)

<span class="hljs-comment">// 3. 监控卡顿</span>
<span class="hljs-type">KSCrash</span>.shared().monitorDeadlock <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
</code></pre>
<h2 data-id="heading-18">六、日志调试工具</h2>
<h3 data-id="heading-19"><strong>1. CocoaLumberjack</strong> - <strong>专业日志框架</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// GitHub: https://github.com/CocoaLumberjack/CocoaLumberjack</span>
<span class="hljs-comment">// 特点:</span>
<span class="hljs-operator">✅</span> 高性能日志记录
<span class="hljs-operator">✅</span> 多日志级别（<span class="hljs-type">Error</span>, <span class="hljs-type">Warn</span>, <span class="hljs-type">Info</span>, <span class="hljs-type">Debug</span>, <span class="hljs-type">Verbose）</span>
<span class="hljs-operator">✅</span> 多种输出目标（<span class="hljs-type">Console</span>, <span class="hljs-type">File</span>, <span class="hljs-type">Database）</span>
<span class="hljs-operator">✅</span> 日志轮转和清理
<span class="hljs-operator">✅</span> 支持<span class="hljs-type">Swift和Objective</span><span class="hljs-operator">-</span><span class="hljs-type">C</span>

<span class="hljs-comment">// 集成:</span>
pod '<span class="hljs-type">CocoaLumberjack</span><span class="hljs-operator">/</span><span class="hljs-type">Swift</span>'

<span class="hljs-comment">// 配置:</span>
<span class="hljs-keyword">import</span> CocoaLumberjackSwift

<span class="hljs-comment">// 控制台日志</span>
<span class="hljs-type">DDLog</span>.add(<span class="hljs-type">DDOSLogger</span>.sharedInstance)

<span class="hljs-comment">// 文件日志</span>
<span class="hljs-keyword">let</span> fileLogger <span class="hljs-operator">=</span> <span class="hljs-type">DDFileLogger</span>()
fileLogger.rollingFrequency <span class="hljs-operator">=</span> <span class="hljs-number">60</span> <span class="hljs-operator">*</span> <span class="hljs-number">60</span> <span class="hljs-operator">*</span> <span class="hljs-number">24</span> <span class="hljs-comment">// 24小时</span>
fileLogger.logFileManager.maximumNumberOfLogFiles <span class="hljs-operator">=</span> <span class="hljs-number">7</span>
<span class="hljs-type">DDLog</span>.add(fileLogger)

<span class="hljs-comment">// 使用:</span>
<span class="hljs-type">DDLogError</span>(<span class="hljs-string">"错误信息"</span>)
<span class="hljs-type">DDLogWarn</span>(<span class="hljs-string">"警告信息"</span>)
<span class="hljs-type">DDLogInfo</span>(<span class="hljs-string">"普通信息"</span>)
<span class="hljs-type">DDLogDebug</span>(<span class="hljs-string">"调试信息"</span>)
<span class="hljs-type">DDLogVerbose</span>(<span class="hljs-string">"详细信息"</span>)

<span class="hljs-comment">// 上下文过滤:</span>
<span class="hljs-keyword">let</span> context <span class="hljs-operator">=</span> <span class="hljs-number">123</span>
<span class="hljs-type">DDLogDebug</span>(<span class="hljs-string">"带上下文的消息"</span>, context: context)
</code></pre>
<h3 data-id="heading-20"><strong>2. SwiftyBeaver</strong> - <strong>Swift专用日志框架</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// GitHub: https://github.com/SwiftyBeaver/SwiftyBeaver</span>
<span class="hljs-comment">// 特点:</span>
<span class="hljs-operator">✅</span> 纯<span class="hljs-type">Swift实现</span>
<span class="hljs-operator">✅</span> 彩色控制台输出
<span class="hljs-operator">✅</span> 多种目的地（<span class="hljs-type">Console</span>, <span class="hljs-type">File</span>, <span class="hljs-type">Cloud）</span>
<span class="hljs-operator">✅</span> 平台同步（macOS <span class="hljs-type">App）</span>
<span class="hljs-operator">✅</span> 支持emoji和格式化

<span class="hljs-comment">// 使用:</span>
<span class="hljs-keyword">import</span> SwiftyBeaver
<span class="hljs-keyword">let</span> log <span class="hljs-operator">=</span> <span class="hljs-type">SwiftyBeaver</span>.<span class="hljs-keyword">self</span>

<span class="hljs-comment">// 添加控制台目的地</span>
<span class="hljs-keyword">let</span> console <span class="hljs-operator">=</span> <span class="hljs-type">ConsoleDestination</span>()
console.format <span class="hljs-operator">=</span> <span class="hljs-string">"$DHH:mm:ss$d $L $M"</span>
log.addDestination(console)

<span class="hljs-comment">// 添加文件目的地</span>
<span class="hljs-keyword">let</span> file <span class="hljs-operator">=</span> <span class="hljs-type">FileDestination</span>()
file.logFileURL <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(fileURLWithPath: <span class="hljs-string">"/path/to/file.log"</span>)
log.addDestination(file)

<span class="hljs-comment">// 日志级别:</span>
log.verbose(<span class="hljs-string">"详细"</span>)    <span class="hljs-comment">// 灰色</span>
log.debug(<span class="hljs-string">"调试"</span>)      <span class="hljs-comment">// 绿色</span>
log.info(<span class="hljs-string">"信息"</span>)       <span class="hljs-comment">// 蓝色</span>
log.warning(<span class="hljs-string">"警告"</span>)    <span class="hljs-comment">// 黄色</span>
log.error(<span class="hljs-string">"错误"</span>)      <span class="hljs-comment">// 红色</span>
</code></pre>
<h3 data-id="heading-21"><strong>3. XCGLogger</strong> - <strong>功能丰富的日志框架</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// GitHub: https://github.com/DaveWoodCom/XCGLogger</span>
<span class="hljs-comment">// 特点:</span>
<span class="hljs-operator">✅</span> 高度可配置
<span class="hljs-operator">✅</span> 支持日志过滤
<span class="hljs-operator">✅</span> 自定义日志目的地
<span class="hljs-operator">✅</span> 自动日志轮转
<span class="hljs-operator">✅</span> 详细的文档

<span class="hljs-comment">// 使用:</span>
<span class="hljs-keyword">import</span> XCGLogger

<span class="hljs-keyword">let</span> log <span class="hljs-operator">=</span> <span class="hljs-type">XCGLogger</span>.default

<span class="hljs-comment">// 配置</span>
log.setup(level: .debug,
          showLogIdentifier: <span class="hljs-literal">false</span>,
          showFunctionName: <span class="hljs-literal">true</span>,
          showThreadName: <span class="hljs-literal">true</span>,
          showLevel: <span class="hljs-literal">true</span>,
          showFileNames: <span class="hljs-literal">true</span>,
          showLineNumbers: <span class="hljs-literal">true</span>,
          showDate: <span class="hljs-literal">true</span>)

<span class="hljs-comment">// 自定义过滤器</span>
log.filters <span class="hljs-operator">=</span> [
    <span class="hljs-type">Filter</span>.<span class="hljs-type">Level</span>(from: .debug),  <span class="hljs-comment">// 只显示.debug及以上</span>
    <span class="hljs-type">Filter</span>.<span class="hljs-type">Path</span>(include: [<span class="hljs-string">"ViewController"</span>], exclude: [<span class="hljs-string">"ThirdParty"</span>])
]

log.debug(<span class="hljs-string">"调试信息"</span>)
log.error(<span class="hljs-string">"错误信息"</span>)
</code></pre>
<h2 data-id="heading-22">七、自动化调试工具</h2>
<h3 data-id="heading-23"><strong>1. Fastlane</strong> - <strong>自动化工具集</strong></h3>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-comment"># 官网: https://fastlane.tools</span>
<span class="hljs-comment"># 特点:</span>
✅ 自动化构建、测试、部署
✅ 丰富的插件生态
✅ 与<span class="hljs-variable constant_">CI</span>/<span class="hljs-variable constant_">CD</span>深度集成
✅ 跨平台支持

<span class="hljs-comment"># 常用命令:</span>
fastlane screenshots    <span class="hljs-comment"># 自动截图</span>
fastlane beta          <span class="hljs-comment"># 发布测试版</span>
fastlane release       <span class="hljs-comment"># 发布正式版</span>
fastlane match         <span class="hljs-comment"># 证书管理</span>

<span class="hljs-comment"># 集成调试功能:</span>
lane <span class="hljs-symbol">:debug_build</span> <span class="hljs-keyword">do</span>
  <span class="hljs-comment"># 1. 设置调试配置</span>
  update_app_identifier(
    <span class="hljs-symbol">app_identifier:</span> <span class="hljs-string">"com.company.debug"</span>
  )
  
  <span class="hljs-comment"># 2. 启用调试功能</span>
  update_info_plist(
    <span class="hljs-symbol">plist_path:</span> <span class="hljs-string">"Info.plist"</span>,
    <span class="hljs-symbol">block:</span> <span class="hljs-built_in">proc</span> <span class="hljs-keyword">do</span> |<span class="hljs-params">plist</span>|
      plist[<span class="hljs-string">"FLEXEnabled"</span>] = <span class="hljs-literal">true</span>
      plist[<span class="hljs-string">"NSAllowsArbitraryLoads"</span>] = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">end</span>
  )
  
  <span class="hljs-comment"># 3. 构建</span>
  gym(
    <span class="hljs-symbol">scheme:</span> <span class="hljs-string">"Debug"</span>,
    <span class="hljs-symbol">export_method:</span> <span class="hljs-string">"development"</span>
  )
<span class="hljs-keyword">end</span>
</code></pre>
<h3 data-id="heading-24"><strong>2. slather</strong> - <strong>代码覆盖率工具</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># GitHub: https://github.com/SlatherOrg/slather</span>
<span class="hljs-comment"># 特点:</span>
✅ 生成代码覆盖率报告
✅ 支持多种输出格式（html, cobertura, json）
✅ 与CI集成
✅ 过滤第三方库代码

<span class="hljs-comment"># 安装:</span>
gem install slather

<span class="hljs-comment"># 使用:</span>
<span class="hljs-comment"># 1. 运行测试并收集覆盖率</span>
xcodebuild <span class="hljs-built_in">test</span> -scheme MyApp -destination <span class="hljs-string">'platform=iOS Simulator,name=iPhone 14'</span> -enableCodeCoverage YES

<span class="hljs-comment"># 2. 生成报告</span>
slather coverage --html --show --scheme MyApp MyApp.xcodeproj

<span class="hljs-comment"># 3. 在Jenkins中集成</span>
slather coverage --input-format profdata --cobertura-xml --output-directory build/reports MyApp.xcodeproj
</code></pre>
<h2 data-id="heading-25">八、特殊场景调试工具</h2>
<h3 data-id="heading-26"><strong>1. SparkInspector</strong> - <strong>实时对象监控</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 官网: https://sparkinspector.com</span>
<span class="hljs-comment">// 特点:</span>
<span class="hljs-operator">✅</span> 实时监控所有对象实例
<span class="hljs-operator">✅</span> 查看对象属性变化
<span class="hljs-operator">✅</span> 方法调用追踪
<span class="hljs-operator">✅</span> 内存泄漏检测

<span class="hljs-comment">// 集成:</span>
<span class="hljs-comment">// 1. 下载Spark Inspector应用</span>
<span class="hljs-comment">// 2. 集成框架到项目</span>
<span class="hljs-comment">// 3. 通过Spark Inspector连接调试</span>

<span class="hljs-comment">// 适用场景:</span>
<span class="hljs-operator">•</span> 复杂的对象关系调试
<span class="hljs-operator">•</span> 观察模式数据流
<span class="hljs-operator">•</span> 内存泄漏定位
</code></pre>
<h3 data-id="heading-27"><strong>3. LLDB</strong> - <strong>底层调试神器</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Xcode内置，但功能极其强大</span>
<span class="hljs-comment"># 常用命令:</span>

<span class="hljs-comment"># 1. 查看变量</span>
(lldb) po variable
(lldb) p variable
(lldb) v variable

<span class="hljs-comment"># 2. 修改变量</span>
(lldb) <span class="hljs-built_in">expr</span> variable = newValue

<span class="hljs-comment"># 3. 调用方法</span>
(lldb) <span class="hljs-built_in">expr</span> [self doSomething]
(lldb) <span class="hljs-built_in">expr</span> self.doSomething()

<span class="hljs-comment"># 4. 断点命令</span>
(lldb) breakpoint <span class="hljs-built_in">set</span> -n <span class="hljs-string">"[ClassName methodName]"</span>
(lldb) breakpoint <span class="hljs-built_in">command</span> add 1  <span class="hljs-comment"># 为断点1添加命令</span>
&gt; po <span class="hljs-variable">$arg1</span>
&gt; <span class="hljs-built_in">continue</span>
&gt; DONE

<span class="hljs-comment"># 5. 内存查看</span>
(lldb) memory <span class="hljs-built_in">read</span> 0x12345678
(lldb) memory write 0x12345678 0x42

<span class="hljs-comment"># 6. 自定义LLDB命令</span>
(lldb) <span class="hljs-built_in">command</span> regex rlook <span class="hljs-string">'s/(.+)/image lookup -rn %1/'</span>
(lldb) rlook methodName

<span class="hljs-comment"># 7. Swift特定命令</span>
(lldb) frame variable -L  <span class="hljs-comment"># 显示局部变量</span>
(lldb) <span class="hljs-built_in">type</span> lookup String <span class="hljs-comment"># 查看类型信息</span>
</code></pre>
<h2 data-id="heading-28">九、工具矩阵</h2>


















































<table><thead><tr><th>需求场景</th><th>推荐工具</th><th>理由</th></tr></thead><tbody><tr><td><strong>日常开发调试</strong></td><td>FLEX + Proxyman</td><td>功能全面，无需额外环境</td></tr><tr><td><strong>UI/布局问题</strong></td><td>Lookin + Reveal</td><td>3D视图，实时修改</td></tr><tr><td><strong>性能优化</strong></td><td>Xcode Instruments + Tracy</td><td>官方工具+线上监控</td></tr><tr><td><strong>内存泄漏</strong></td><td>MLeaksFinder + FBRetainCycleDetector</td><td>自动检测+深度分析</td></tr><tr><td><strong>网络调试</strong></td><td>Proxyman/Charles</td><td>功能专业，操作友好</td></tr><tr><td><strong>日志管理</strong></td><td>CocoaLumberjack + SwiftyBeaver</td><td>功能强大+美观输出</td></tr><tr><td><strong>自动化</strong></td><td>Fastlane + slather</td><td>流程自动化+质量监控</td></tr><tr><td><strong>底层调试</strong></td><td>LLDB + InjectionIII</td><td>深度控制+热重载</td></tr></tbody></table>
<h3 data-id="heading-29"><strong>团队规范建议</strong></h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># iOS团队调试工具规范</span>

<span class="hljs-section">## 必装工具（所有开发者）</span>
<span class="hljs-bullet">1.</span> Proxyman/Charles - 网络调试
<span class="hljs-bullet">2.</span> Lookin - UI调试  
<span class="hljs-bullet">3.</span> InjectionIII - 热重载

<span class="hljs-section">## 项目集成（Podfile）</span>
<span class="hljs-code">```ruby
target 'MyApp' do
  # 调试工具（仅Debug）
  pod 'FLEX', :configurations =&gt; ['Debug']
  pod 'CocoaLumberjack', :configurations =&gt; ['Debug']
  pod 'MLeaksFinder', :configurations =&gt; ['Debug']
end
</span></code></pre>
<h2 data-id="heading-30">总结</h2>
<p><strong>核心建议：</strong></p>
<ol>
<li><strong>不要过度依赖单一工具</strong> - 不同工具有不同适用场景</li>
<li><strong>掌握核心原理</strong> - 理解工具背后的工作原理比单纯使用更重要</li>
<li><strong>建立个人调试工具箱</strong> - 根据习惯组合适合自己的工具集</li>
<li><strong>关注新工具发展</strong> - iOS开发工具生态在持续进化</li>
<li><strong>重视自动化</strong> - 将重复调试工作自动化，提高效率</li>
</ol>
<p><strong>终极目标：</strong> 快速定位问题 → 深入分析原因 → 有效解决问题</p>
<p>这些工具大多数都有免费版本或开源版本，建议从最常用的几个开始，逐步建立自己的调试能力体系。</p>
<p><strong>掌握这些工具，不是为了炫耀技术，而是为了让你的代码更健壮，让你的用户更满意，让你自己在深夜加班时少掉几根头发。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VS code 类产物中 win11 终端字体内容和颜色 加粗不匹配问题]]></title>    <link>https://juejin.cn/post/7598465042968969256</link>    <guid>https://juejin.cn/post/7598465042968969256</guid>    <pubDate>2026-01-24T15:33:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598465042968969256" data-draft-id="7598465042968952872" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VS code 类产物中 win11 终端字体内容和颜色 加粗不匹配问题"/> <meta itemprop="keywords" content="Visual Studio Code"/> <meta itemprop="datePublished" content="2026-01-24T15:33:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小兵张健"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032405229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VS code 类产物中 win11 终端字体内容和颜色 加粗不匹配问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032405229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小兵张健
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T15:33:44.000Z" title="Sat Jan 24 2026 15:33:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我尝试了各种方式,换字体,改配置,结果还是乱的,有人知道怎么搞吗?跪求,Mac好像天然就没问题,急急急大佬们</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14b10c217d9d47408dc733826f98fdc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5YW15byg5YGl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769873624&amp;x-signature=8%2BcE%2BDM9fDLRxpbyU2flIgQkTvE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19391a06fd4541a788dae709478f1988~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5YW15byg5YGl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769873624&amp;x-signature=SPZ4lLxNZwqzVbtIoKoguPvPXqU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05cb66ebf33044c3921a2505f6115c4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5YW15byg5YGl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769873624&amp;x-signature=kiSbLkzH%2Fg1RsMF5GT4MTBzNm44%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/880692bad4204f7abd40edcd529d99bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5YW15byg5YGl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769873624&amp;x-signature=FyyOw2wyPEtzDbLo3paICY1gQVU%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI D2C(设计转代码)探索及使用体验]]></title>    <link>https://juejin.cn/post/7598447519824543785</link>    <guid>https://juejin.cn/post/7598447519824543785</guid>    <pubDate>2026-01-24T14:41:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598447519824543785" data-draft-id="7598447519824527401" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI D2C(设计转代码)探索及使用体验"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2026-01-24T14:41:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三金得鑫"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335130216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI D2C(设计转代码)探索及使用体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335130216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三金得鑫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T14:41:48.000Z" title="Sat Jan 24 2026 14:41:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hello，大家好，我是三金～</p>
<p>临近年底，需求多到让人怀疑人生，领导也是连续两周都在嫌我打螺丝有些慢了。为了提高开发效率，我把一些 UI 上的工作交给了内部提供的 D2C Agent，效果令人惊艳！</p>
<p>五个页面 + 业务逻辑实现，一共用了不到半小时！其中：</p>
<ul>
<li>D2C 产出初版代码花了十来分钟左右。UI 还原度可以达到 80% 以上，且由于在提示词中我已经加上了相关的业务逻辑，所以最终的功能完成度也能达到 90% 以上！</li>
<li>剩下十来分钟的时间，就是 AI 善后工程师（没错，就是本人）的 show time。主要是将一些样式细节和交互细节进行优化（感觉自己成了个边角料😭）。</li>
</ul>
<p>这速度、这效率简直让人可怕。难道前端真的要失业了吗？zeng～zeng～ 可怕😨</p>
<h3 data-id="heading-0">D2C 介绍</h3>
<p>话说回来，有些小伙伴可能还不曾了解过 D2C，这里我给大家再介绍一下相关概念：</p>
<p>D2C 全称 <strong>Design To Code</strong>，顾名思义，它是可以将设计稿直接转换为前端代码的技术。这种技术打破了前端开发人员的传统工作模式：</p>
<ul>
<li>不同图层之间“像素级别”的还原；</li>
<li>思考、决策应该使用哪种页面布局；</li>
<li>跨端应用中，如何实现响应式；</li>
<li>等等</li>
</ul>
<p>除此之外，D2C 在一定程度上更是打破了职责划分，设计师、产品甚至后端人员，都可以通过 D2C 技术实现前端代码。对于整个开发流程来说，这无异提高了开发效率、节省了大量的开发时间。</p>
<p>Screenshot-to-code 是在之前的文章中介绍过的一款 D2C 产品，如之前的文章所说，虽然它存在一定的局限性，但并不妨碍它在一些特定场景下能发挥出意想不到的作用。详细可以查看👉《<a href="https://juejin.cn/post/7592823500416761882" target="_blank" title="https://juejin.cn/post/7592823500416761882">虽然 V0 很强大，但是 ScreenshotToCode 依旧有市场</a>》。</p>
<h3 data-id="heading-1">原理</h3>
<p>没有细究过这个 Agent 的实现原理（再说细究了也不能发出来😄），只能猜测和 ScreenshotToCode 以及 Figma MCP 大差不差。</p>
<ul>
<li>在 ScreenshotToCode 中需要多模态模型，这是因为需要 AI 去分析理解这些图片，然后再生成代码。整个流程是：<strong>图片输入</strong> → <strong>LLM理解</strong> → <strong>直接输出代码。</strong></li>
<li>Figma MCP + CC（或者其他 AI 编辑器）可以将 Figma 设计图直接转为可用的 HTML/React/Vue/CSS 代码。<strong>先通过 MCP 将 Figma 设计稿转为结构化数据，再将数据交给 AI 进行代码转换</strong>。详见《<a href="https://juejin.cn/post/7597253913249038377" target="_blank" title="https://juejin.cn/post/7597253913249038377">D2C 的另一种选择—Figma MCP + Claude Code</a>》 。</li>
<li>还有一些早就存在的转换技术，这种并不需要借助 AI，比如 58 同城在 20 年 9 月开源的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpicassoui.58.com%2F" target="_blank" title="https://picassoui.58.com/" ref="nofollow noopener noreferrer">Picasso</a>。它的工作原理就是先解析 Sketch 设计文件，提取图层、样式、布局等信息，然后将其转换为内部DSL，并对其进行样式转换，包括单位转换（px→rem/rpx）、平台特定属性处理等，最后根据转换后的DSL生成对应平台的前端代码。</li>
</ul>
<h3 data-id="heading-2">总结</h3>
<p>从模式上来看，D2C 的方式有四种：</p>
<ul>
<li>早期类似 Picasso 这种，通过底层算法将设计稿先转为 DSL，再将 DSL 转为前端代码（但它只服务于安卓）。即<strong>先将设计稿转为特定数据结构，再将其转为代码</strong>。</li>
<li><strong>低代码平台</strong>其实也是 D2C 的一种，设计师或者产品可以通过托拉拽的方式进行一些页面设计，并导出对应代码。</li>
<li>再就是<strong>利用多模态模型理解和分析图片组成，再通过代码进行“复原”</strong> ，例如 ScreenshotToCode。</li>
<li>最后一种可以说是第一种方式的改进版，<strong>设计稿被转化为特定数据结构之后，通过 AI 来读取和分析这些图层数据，然后输出成用户指定的代码</strong>。比如通过 Figma MCP + Claude Code 实现设计稿还原。</li>
</ul>
<p>D2C 带来的<strong>收益</strong>是巨大的：</p>
<ul>
<li>打破了传统开发中的协作壁垒和角色边界：</li>
<li>传统开发中，从设计稿到代码，需要人工校对，整个过程可能会出现一些细微偏差。D2C 通过 AI 加持，实现了像素级别的还原，减少了沟通成本和开发成本。</li>
<li>甚至说产品经理可以在原型设计阶段，就通过 D2C 技术生成一份基础代码，前端只需要进行一些“善后”工作。</li>
<li>成倍增长的开发效率：还原设计稿的时间被大大缩短，前端开发人员可以将更多的精力投入到业务逻辑和细节调整上</li>
<li>打破技术栈的僵化边界：可以指定它用 Vue、React、Angular、小程序等框架进行开发。</li>
</ul>
<p>同时也带来一些<strong>挑战</strong>：</p>
<ul>
<li>高效的同时，可能会伴随着人员的减少。毕竟平时两三个人一周的活，有了 D2C 以后一个人两三天就搞定了；</li>
<li>前端的边界被模糊，前端人需要在专业能力和业务能力上投入更大的精力，需要向上承接业务逻辑整合，向下深入性能优化，角色更偏向“前端架构师”；</li>
</ul>
<p>当然这并不是说会取代前端工程师，而是将其从重复劳动中解放，更聚焦于：</p>
<ul>
<li>复杂系统设计与架构</li>
<li>性能优化与用户体验深化</li>
<li>工程化与基础设施搭建</li>
<li>跨端整合与新技术探索</li>
<li>等等</li>
</ul>
<p>AI 的迭代日新月异，不管是前端还是后端开发，都要紧跟步伐，这样才不会被技术更新所淘汰。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1.8GB 内存也能跑大模型！Ollama Docker 部署完整指南]]></title>    <link>https://juejin.cn/post/7598480267218157602</link>    <guid>https://juejin.cn/post/7598480267218157602</guid>    <pubDate>2026-01-24T13:05:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598480267218157602" data-draft-id="7598465042968690728" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1.8GB 内存也能跑大模型！Ollama Docker 部署完整指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-24T13:05:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1.8GB 内存也能跑大模型！Ollama Docker 部署完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T13:05:11.000Z" title="Sat Jan 24 2026 13:05:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>想在服务器上部署私有 AI 模型，但内存不够用？本文教你用 Docker + Swap 优化，让低配服务器也能流畅运行 Ollama 大模型。</p>
</blockquote>
<h2 data-id="heading-0">背景</h2>
<p>为什么选择 Docker 部署？</p>
<p>因为直接使用命令会报错，无法运行ollama。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffb57f08086847bfb1940e855e1ad8ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769864711&amp;x-signature=Xklf2G%2BpAmJv55iicHVXN9M4f6k%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">1. 简介</h2>
<h3 data-id="heading-2">1.1 为什么使用 Docker 部署？</h3>





























<table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td><strong>环境隔离</strong></td><td>不污染宿主机环境，依赖问题少</td></tr><tr><td><strong>一键部署</strong></td><td>容器化部署，跨平台一致性好</td></tr><tr><td><strong>易于管理</strong></td><td>重启、更新、迁移方便</td></tr><tr><td><strong>资源控制</strong></td><td>可限制内存、CPU 使用</td></tr><tr><td><strong>适合生产</strong></td><td>稳定可靠，推荐生产环境使用</td></tr></tbody></table>
<h3 data-id="heading-3">1.2 硬件要求</h3>

























<table><thead><tr><th>模型规模</th><th>内存要求</th><th>推荐配置</th></tr></thead><tbody><tr><td>0.5B-3B</td><td>2-4GB</td><td>最低 2GB 可用内存</td></tr><tr><td>7B-14B</td><td>8-16GB</td><td>最低 8GB 可用内存</td></tr><tr><td>30B+</td><td>32GB+</td><td>最低 32GB 可用内存</td></tr></tbody></table>
<h3 data-id="heading-4">1.3 低配服务器（&lt;2GB 内存）</h3>
<p>如果你的服务器内存不足（如 1GB-2GB），运行大模型会遇到以下错误：</p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-keyword">Error</span>: <span class="hljs-number">500</span> Internal <span class="hljs-built_in">Server</span> <span class="hljs-keyword">Error</span>: llama runner process has terminated: signal: killed
</code></pre>
<h4 data-id="heading-5">什么是 Swap？</h4>
<p>Swap 是 Linux 系统中的一块<strong>硬盘空间</strong>，当作"备用内存"使用。当物理内存（RAM）不够用时，系统会把暂时不用的数据从内存搬到 Swap 中，腾出物理内存给需要运行的程序。</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────┐
│  物理内存 (RAM)     =  你的办公桌（快速但小）    │
│  Swap (虚拟内存)    =  旁边的储物柜（慢但大）    │
│                                                 │
│  当办公桌放满东西时：                            │
│  把不常用的文件 → 放到储物柜 (Swap)             │
│  腾出空间 → 放置正在处理的文件                  │
└─────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-6">Swap 的作用</h4>





















<table><thead><tr><th>作用</th><th>说明</th></tr></thead><tbody><tr><td><strong>防止系统崩溃</strong></td><td>内存不足时，用 Swap 补充，避免进程被杀死</td></tr><tr><td><strong>运行大程序</strong></td><td>允许运行超出物理内存的程序（如大语言模型）</td></tr><tr><td><strong>内存回收</strong></td><td>把不活跃的内存页面移到 Swap，释放物理内存</td></tr></tbody></table>
<h4 data-id="heading-7">为什么需要 Swap？</h4>
<pre><code class="hljs language-diff" lang="diff">你的服务器配置：
<span class="hljs-deletion">- 物理内存：1.8GB</span>
<span class="hljs-deletion">- 想运行：3b 模型（需要 ~4GB 内存）</span>

没有 Swap：
1.8GB &lt; 4GB → 程序被杀死 ❌

有 5GB Swap：
1.8GB + 5GB = 6.8GB &gt; 4GB → 可以运行 ✅
</code></pre>
<blockquote>
<p><strong>注意</strong>：使用 Swap 会牺牲性能（硬盘速度约为内存的 1/100），但总比程序崩溃好。</p>
</blockquote>
<h4 data-id="heading-8">添加 Swap 虚拟内存</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建 4GB swap 文件</span>
<span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=/swapfile bs=1M count=4096
<span class="hljs-built_in">chmod</span> 600 /swapfile
mkswap /swapfile
swapon /swapfile

<span class="hljs-comment"># 永久生效</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'/swapfile none swap sw 0 0'</span> &gt;&gt; /etc/fstab

<span class="hljs-comment"># 验证</span>
free -h
</code></pre>
<h4 data-id="heading-9">不同内存配置的模型推荐</h4>






























<table><thead><tr><th>服务器内存</th><th>推荐模型</th><th>Swap 需求</th></tr></thead><tbody><tr><td>1GB</td><td>qwen2.5-coder:0.5b</td><td>建议 2GB</td></tr><tr><td>2GB</td><td>qwen2.5-coder:0.5b / 1.5b</td><td>建议 3GB</td></tr><tr><td>4GB</td><td>qwen2.5-coder:3b</td><td>不需要</td></tr><tr><td>8GB+</td><td>qwen2.5-coder:7b</td><td>不需要</td></tr></tbody></table>
<h4 data-id="heading-10">Swap 性能判断</h4>






























<table><thead><tr><th>Swap 使用量</th><th>状态</th><th>建议</th></tr></thead><tbody><tr><td>0-500MB</td><td>正常</td><td>无需处理</td></tr><tr><td>500MB-1GB</td><td>一般</td><td>注意性能</td></tr><tr><td>1GB-2GB</td><td>较慢</td><td>考虑换小模型</td></tr><tr><td>&gt;2GB</td><td>很慢</td><td>必须换小模型</td></tr></tbody></table>
<h4 data-id="heading-11">内存监控命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前内存和 Swap 状态</span>
free -h

<span class="hljs-comment"># 实时监控内存（每 1 秒刷新）</span>
watch -n 1 free -h

<span class="hljs-comment"># 查看 Docker 容器资源使用</span>
docker stats ollama

<span class="hljs-comment"># 查看容器内存限制</span>
docker inspect ollama | grep -i memory

<span class="hljs-comment"># 查看系统内存配置</span>
<span class="hljs-built_in">cat</span> /proc/sys/vm/overcommit_memory
<span class="hljs-comment"># 0 = 启发式过度分配（默认）</span>
<span class="hljs-comment"># 1 = 始终允许过度分配</span>
<span class="hljs-comment"># 2 = 严格控制，不允许过度分配</span>
</code></pre>
<h4 data-id="heading-12">运行模型时实时监控</h4>
<p>开启两个终端窗口：</p>
<p><strong>终端 1：运行模型</strong></p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it ollama ollama run qwen2.5-coder:0.5b
</code></pre>
<p><strong>终端 2：实时监控</strong></p>
<pre><code class="hljs language-bash" lang="bash">watch -n 1 <span class="hljs-string">'free -h &amp;&amp; echo "---" &amp;&amp; docker stats ollama --no-stream'</span>
</code></pre>
<h4 data-id="heading-13">常见问题排查</h4>
<p><strong>问题：模型运行时被杀死</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查容器内存限制</span>
docker inspect ollama | grep -i memory

<span class="hljs-comment"># 2. 如果有内存限制，重新创建容器</span>
docker <span class="hljs-built_in">rm</span> -f ollama
docker run -d \
  -p 11434:11434 \
  --name ollama \
  --restart always \
  --memory-swap=-1 \
  ollama/ollama:latest

<span class="hljs-comment"># 3. 启用内存过度分配</span>
<span class="hljs-built_in">echo</span> 1 | sudo <span class="hljs-built_in">tee</span> /proc/sys/vm/overcommit_memory
<span class="hljs-built_in">echo</span> <span class="hljs-string">'vm.overcommit_memory = 1'</span> | sudo <span class="hljs-built_in">tee</span> -a /etc/sysctl.conf
sudo sysctl -p

<span class="hljs-comment"># 4. 重启容器</span>
docker restart ollama
</code></pre>
<p><strong>问题：Swap 使用过高导致卡顿</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前 Swap 使用</span>
free -h

<span class="hljs-comment"># 如果 Swap 使用 &gt; 1GB，建议切换到更小的模型</span>
docker <span class="hljs-built_in">exec</span> -it ollama ollama run qwen2.5-coder:0.5b
</code></pre>
<hr/>
<h2 data-id="heading-14">2. 安装 Docker</h2>
<h3 data-id="heading-15">2.1 Ubuntu/Debian</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键安装 Docker</span>
curl -fsSL https://get.docker.com | sh

<span class="hljs-comment"># 将当前用户加入 docker 组（免 sudo）</span>
sudo usermod -aG docker <span class="hljs-variable">$USER</span>

<span class="hljs-comment"># 重新登录或执行以下命令使组权限生效</span>
newgrp docker

<span class="hljs-comment"># 验证安装</span>
docker --version
</code></pre>
<h3 data-id="heading-16">2.2 CentOS/RHEL</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 Docker</span>
sudo yum install -y docker

<span class="hljs-comment"># 启动 Docker 服务</span>
sudo systemctl start docker
sudo systemctl <span class="hljs-built_in">enable</span> docker

<span class="hljs-comment"># 将当前用户加入 docker 组</span>
sudo usermod -aG docker <span class="hljs-variable">$user</span>

<span class="hljs-comment"># 验证安装</span>
docker --version
</code></pre>
<h3 data-id="heading-17">2.3 验证 Docker 安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 运行测试容器</span>
docker run hello-world

<span class="hljs-comment"># 查看 Docker 版本</span>
docker --version
docker info
</code></pre>
<hr/>
<h2 data-id="heading-18">3. 部署 Ollama 容器</h2>
<h3 data-id="heading-19">3.1 拉取镜像</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 拉取最新版 Ollama 镜像</span>
docker pull ollama/ollama:latest

<span class="hljs-comment"># 或指定版本</span>
docker pull ollama/ollama:0.5.7
</code></pre>
<h3 data-id="heading-20">3.2 启动容器</h3>
<p><strong>CPU 模式（默认）：</strong></p>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
  -p 11434:11434 \
  --name ollama \
  --restart always \
  ollama/ollama:latest
</code></pre>
<p><strong>GPU 模式（需要 NVIDIA GPU）：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 首先安装 NVIDIA Container Toolkit</span>
distribution=$(. /etc/os-release;<span class="hljs-built_in">echo</span> $ID<span class="hljs-variable">$VERSION_ID</span>)
curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
curl -s -L https://nvidia.github.io/nvidia-docker/<span class="hljs-variable">$distribution</span>/nvidia-docker.list | \
  sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/nvidia-docker.list

sudo apt-get update
sudo apt-get install -y nvidia-container-toolkit
sudo systemctl restart docker

<span class="hljs-comment"># 启动带 GPU 的容器</span>
docker run -d \
  --gpus all \
  -p 11434:11434 \
  --name ollama \
  --restart always \
  ollama/ollama:latest
</code></pre>
<h3 data-id="heading-21">3.3 验证容器运行</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看容器状态</span>
docker ps

<span class="hljs-comment"># 查看容器日志</span>
docker logs -f ollama

<span class="hljs-comment"># 测试 API</span>
curl http://localhost:11434/api/tags
</code></pre>
<hr/>
<h2 data-id="heading-22">4. 模型管理</h2>
<h3 data-id="heading-23">4.1 拉取模型</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 拉取 qwen2.5-coder:3b</span>
docker <span class="hljs-built_in">exec</span> -it ollama ollama pull qwen2.5-coder:3b

<span class="hljs-comment"># 拉取其他模型</span>
docker <span class="hljs-built_in">exec</span> -it ollama ollama pull qwen2.5:7b
docker <span class="hljs-built_in">exec</span> -it ollama ollama pull deepseek-r1:7b
</code></pre>
<h3 data-id="heading-24">4.2 查看已安装模型</h3>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it ollama ollama list
</code></pre>
<h3 data-id="heading-25">4.3 运行模型（交互式）</h3>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it ollama ollama run qwen2.5-coder:3b
</code></pre>
<h3 data-id="heading-26">4.4 删除模型</h3>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it ollama ollama <span class="hljs-built_in">rm</span> qwen2.5-coder:3b
</code></pre>
<h3 data-id="heading-27">4.5 推荐模型</h3>



































<table><thead><tr><th>模型</th><th>用途</th><th>内存需求</th></tr></thead><tbody><tr><td><code>qwen2.5-coder:0.5b</code></td><td>代码生成（轻量）</td><td>~1GB</td></tr><tr><td><code>qwen2.5-coder:3b</code></td><td>代码生成（推荐）</td><td>~4GB</td></tr><tr><td><code>qwen2.5-coder:7b</code></td><td>代码生成（专业）</td><td>~8GB</td></tr><tr><td><code>qwen2.5:3b</code></td><td>通用对话</td><td>~4GB</td></tr><tr><td><code>qwen2.5:7b</code></td><td>通用对话（推荐）</td><td>~8GB</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-28">5. API 调用</h2>
<h3 data-id="heading-29">5.1 基础调用格式</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成文本</span>
curl http://localhost:11434/api/generate -d <span class="hljs-string">'{
  "model": "qwen2.5-coder:3b",
  "prompt": "用python写一个快速排序",
  "stream": false
}'</span>

<span class="hljs-comment"># 对话模式</span>
curl http://localhost:11434/api/chat -d <span class="hljs-string">'{
  "model": "qwen2.5-coder:3b",
  "messages": [
    {"role": "user", "content": "你好"}
  ],
  "stream": false
}'</span>
</code></pre>
<h3 data-id="heading-30">5.2 参数说明</h3>









































<table><thead><tr><th>参数</th><th>类型</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td>model</td><td>string</td><td>模型名称</td><td>-</td></tr><tr><td>prompt</td><td>string</td><td>输入文本</td><td>-</td></tr><tr><td>stream</td><td>boolean</td><td>是否流式输出</td><td>true</td></tr><tr><td>temperature</td><td>number</td><td>温度(0-1)，越高越随机</td><td>0.8</td></tr><tr><td>num_ctx</td><td>number</td><td>上下文长度</td><td>2048</td></tr></tbody></table>
<h3 data-id="heading-31">5.3 Python 调用示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests

API_URL = <span class="hljs-string">"http://localhost:11434/api/generate"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">call_ollama</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">str</span>, model: <span class="hljs-built_in">str</span> = <span class="hljs-string">"qwen2.5-coder:3b"</span></span>):
    response = requests.post(API_URL, json={
        <span class="hljs-string">"model"</span>: model,
        <span class="hljs-string">"prompt"</span>: prompt,
        <span class="hljs-string">"stream"</span>: <span class="hljs-literal">False</span>
    })
    <span class="hljs-keyword">return</span> response.json()[<span class="hljs-string">"response"</span>]

<span class="hljs-comment"># 使用</span>
result = call_ollama(<span class="hljs-string">"用python写一个快速排序"</span>)
<span class="hljs-built_in">print</span>(result)
</code></pre>
<h3 data-id="heading-32">5.4 JavaScript 调用示例</h3>
<h4 data-id="heading-33">浏览器环境（原生 Fetch）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 非流式响应</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callOllama</span>(<span class="hljs-params">prompt</span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"http://localhost:11434/api/generate"</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">"qwen2.5-coder:3b"</span>,
      <span class="hljs-attr">prompt</span>: prompt,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">false</span>
    })
  });

  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
  <span class="hljs-keyword">return</span> data.<span class="hljs-property">response</span>;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_">callOllama</span>(<span class="hljs-string">"用python写一个快速排序"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>);
</code></pre>
<h4 data-id="heading-34">流式响应（浏览器）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chatWithOllama</span>(<span class="hljs-params">prompt</span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"http://localhost:11434/v1/chat/completions"</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">"qwen2.5-coder:3b"</span>,
      <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: prompt }],
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>
    })
  });

  <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();
  <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();
  <span class="hljs-keyword">let</span> result = <span class="hljs-string">""</span>;

  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();
    <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value);
    <span class="hljs-keyword">const</span> lines = chunk.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\n"</span>).<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">line</span> =&gt;</span> line.<span class="hljs-title function_">trim</span>());

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
      <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"data: "</span>)) {
        <span class="hljs-keyword">const</span> data = line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>);
        <span class="hljs-keyword">if</span> (data === <span class="hljs-string">"[DONE]"</span>) <span class="hljs-keyword">continue</span>;
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);
          <span class="hljs-keyword">const</span> content = json.<span class="hljs-property">choices</span>?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>?.<span class="hljs-property">content</span>;
          <span class="hljs-keyword">if</span> (content) {
            result += content;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(content);  <span class="hljs-comment">// 实时输出</span>
          }
        } <span class="hljs-keyword">catch</span> (e) {
          <span class="hljs-comment">// 忽略解析错误</span>
        }
      }
    }
  }
  <span class="hljs-keyword">return</span> result;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_">chatWithOllama</span>(<span class="hljs-string">"用python写一个快速排序"</span>);
</code></pre>
<h4 data-id="heading-35">Node.js 环境</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">"axios"</span>);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callOllama</span>(<span class="hljs-params">prompt</span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(
    <span class="hljs-string">"http://localhost:11434/api/generate"</span>,
    {
      <span class="hljs-attr">model</span>: <span class="hljs-string">"qwen2.5-coder:3b"</span>,
      <span class="hljs-attr">prompt</span>: prompt,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">false</span>
    }
  );

  <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>.<span class="hljs-property">response</span>;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_">callOllama</span>(<span class="hljs-string">"用python写一个快速排序"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>);
</code></pre>
<h4 data-id="heading-36">带认证的调用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 如果设置了 API 密钥</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callOllamaWithAuth</span>(<span class="hljs-params">prompt</span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"http://localhost:11434/api/generate"</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,
      <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">"Bearer your_api_key_here"</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">"qwen2.5-coder:3b"</span>,
      <span class="hljs-attr">prompt</span>: prompt,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">false</span>
    })
  });

  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
  <span class="hljs-keyword">return</span> data.<span class="hljs-property">response</span>;
}
</code></pre>
<h3 data-id="heading-37">5.5 OpenAI 兼容格式（JavaScript）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 OpenAI SDK 调用 Ollama</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">OpenAI</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'openai'</span>;

<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">"http://localhost:11434/v1"</span>,
  <span class="hljs-attr">apiKey</span>: <span class="hljs-string">"ollama"</span>  <span class="hljs-comment">// 不需要真实 key</span>
});

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">prompt</span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> client.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-string">"qwen2.5-coder:3b"</span>,
    <span class="hljs-attr">messages</span>: [{ <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: prompt }]
  });

  <span class="hljs-keyword">return</span> response.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_">chat</span>(<span class="hljs-string">"用python写一个快速排序"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>);
</code></pre>
<h3 data-id="heading-38">5.6 外网调用示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 如果配置了外网访问（需要 HTTPS + API Key）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callOllamaRemote</span>(<span class="hljs-params">prompt</span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"https://your-domain.com/api/generate"</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,
      <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">"Bearer your_secure_password"</span>
    },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">"qwen2.5-coder:3b"</span>,
      <span class="hljs-attr">prompt</span>: prompt,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">false</span>
    })
  });

  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
  <span class="hljs-keyword">return</span> data.<span class="hljs-property">response</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-39">6. 容器管理</h2>
<h3 data-id="heading-40">6.1 查看容器状态</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看运行中的容器</span>
docker ps

<span class="hljs-comment"># 查看所有容器（包括停止的）</span>
docker ps -a

<span class="hljs-comment"># 查看容器详细信息</span>
docker inspect ollama
</code></pre>
<h3 data-id="heading-41">6.2 日志管理</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看实时日志</span>
docker logs -f ollama

<span class="hljs-comment"># 查看最近 100 行日志</span>
docker logs --<span class="hljs-built_in">tail</span> 100 ollama

<span class="hljs-comment"># 查看带时间戳的日志</span>
docker logs -t ollama
</code></pre>
<h3 data-id="heading-42">6.3 启停重启</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 停止容器</span>
docker stop ollama

<span class="hljs-comment"># 启动容器</span>
docker start ollama

<span class="hljs-comment"># 重启容器</span>
docker restart ollama

<span class="hljs-comment"># 删除容器（需先停止）</span>
docker <span class="hljs-built_in">rm</span> -f ollama
</code></pre>
<h3 data-id="heading-43">6.4 进入容器</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 进入容器 shell</span>
docker <span class="hljs-built_in">exec</span> -it ollama bash

<span class="hljs-comment"># 在容器中执行命令</span>
docker <span class="hljs-built_in">exec</span> -it ollama ollama list
</code></pre>
<hr/>
<h2 data-id="heading-44">7. 进阶配置</h2>
<h3 data-id="heading-45">7.1 持久化模型存储</h3>
<p>默认情况下，模型存储在容器内部，删除容器后模型会丢失。使用挂载卷持久化：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除旧容器</span>
docker <span class="hljs-built_in">rm</span> -f ollama

<span class="hljs-comment"># 重新创建，挂载本地目录</span>
docker run -d \
  -p 11434:11434 \
  -v ollama_data:/root/.ollama \
  --name ollama \
  --restart always \
  ollama/ollama:latest
</code></pre>
<h3 data-id="heading-46">7.2 资源限制</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 限制内存使用为 4GB</span>
docker run -d \
  -p 11434:11434 \
  --memory=4g \
  --name ollama \
  --restart always \
  ollama/ollama:latest

<span class="hljs-comment"># 限制 CPU 使用</span>
docker run -d \
  -p 11434:11434 \
  --cpus=2.0 \
  --name ollama \
  --restart always \
  ollama/ollama:latest
</code></pre>
<h3 data-id="heading-47">7.3 环境变量配置</h3>
<pre><code class="hljs language-bash" lang="bash">docker run -d \
  -p 11434:11434 \
  -e OLLAMA_HOST=0.0.0.0:11434 \
  -e OLLAMA_NUM_PARALLEL=4 \
  -e OLLAMA_DEBUG=0 \
  -v ollama_data:/root/.ollama \
  --name ollama \
  --restart always \
  ollama/ollama:latest
</code></pre>
<h3 data-id="heading-48">7.4 使用 Docker Compose</h3>
<p>创建 <code>docker-compose.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">ollama:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">ollama/ollama:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ollama</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"11434:11434"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">ollama_data:/root/.ollama</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">OLLAMA_HOST=0.0.0.0:11434</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">OLLAMA_NUM_PARALLEL=4</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-comment"># GPU 配置（需要 nvidia-docker）</span>
    <span class="hljs-comment"># deploy:</span>
    <span class="hljs-comment">#   resources:</span>
    <span class="hljs-comment">#     reservations:</span>
    <span class="hljs-comment">#       devices:</span>
    <span class="hljs-comment">#         - driver: nvidia</span>
    <span class="hljs-comment">#           count: all</span>
    <span class="hljs-comment">#           capabilities: [gpu]</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">ollama_data:</span>
</code></pre>
<p>启动：</p>
<pre><code class="hljs language-bash" lang="bash">docker-compose up -d
</code></pre>
<h3 data-id="heading-49">7.5 国内镜像加速</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用国内镜像源</span>
docker pull registry.cn-hangzhou.aliyuncs.com/ollama/ollama:latest

<span class="hljs-comment"># 或使用代理</span>
docker pull ollama/ollama:latest
</code></pre>
<hr/>
<h2 data-id="heading-50">8. 故障排查</h2>
<h3 data-id="heading-51">8.1 容器启动失败</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看容器日志</span>
docker logs ollama

<span class="hljs-comment"># 常见错误：GPU 配置问题</span>
<span class="hljs-comment"># 解决方案：删除容器，使用 CPU 模式重新创建</span>
docker <span class="hljs-built_in">rm</span> -f ollama
docker run -d -p 11434:11434 --name ollama --restart always ollama/ollama:latest
</code></pre>
<h3 data-id="heading-52">8.2 无法访问 API</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查容器是否运行</span>
docker ps

<span class="hljs-comment"># 检查端口是否正确映射</span>
docker port ollama

<span class="hljs-comment"># 测试容器内部 API</span>
docker <span class="hljs-built_in">exec</span> ollama curl http://localhost:11434/api/tags

<span class="hljs-comment"># 检查防火墙</span>
sudo ufw status  <span class="hljs-comment"># Ubuntu</span>
sudo firewall-cmd --list-all  <span class="hljs-comment"># CentOS</span>
</code></pre>
<h3 data-id="heading-53">8.3 模型加载慢</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看资源使用情况</span>
docker stats ollama

<span class="hljs-comment"># 检查磁盘 IO</span>
docker <span class="hljs-built_in">exec</span> ollama <span class="hljs-built_in">df</span> -h
</code></pre>
<h3 data-id="heading-54">8.4 内存不足</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看容器资源使用</span>
docker stats --no-stream

<span class="hljs-comment"># 使用更小的模型</span>
docker <span class="hljs-built_in">exec</span> -it ollama ollama pull qwen2.5-coder:0.5b

<span class="hljs-comment"># 或限制容器内存</span>
docker update --memory=4g ollama
</code></pre>
<hr/>
<h2 data-id="heading-55">9. 生产部署建议</h2>
<h3 data-id="heading-56">9.1 安全配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 绑定到本地地址</span>
docker run -d \
  -p 127.0.0.1:11434:11434 \
  --name ollama \
  ollama/ollama:latest

<span class="hljs-comment"># 使用反向代理（Nginx）配置 HTTPS</span>
</code></pre>
<h3 data-id="heading-57">9.2 监控配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 Prometheus + Grafana 监控</span>
docker run -d \
  --name prometheus \
  -p 9090:9090 \
  prom/prometheus

<span class="hljs-comment"># 配置 cAdvisor 监控容器</span>
docker run -d \
  --name cadvisor \
  -p 8080:8080 \
  google/cadvisor:latest
</code></pre>
<h3 data-id="heading-58">9.3 高可用配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用负载均衡</span>
<span class="hljs-comment"># 部署多个 Ollama 实例，通过 Nginx 负载均衡</span>

<span class="hljs-comment"># 使用健康检查</span>
docker run -d \
  --name ollama \
  --health-cmd=<span class="hljs-string">"curl -f http://localhost:11434/api/tags || exit 1"</span> \
  --health-interval=30s \
  --health-timeout=10s \
  --health-retries=3 \
  ollama/ollama:latest
</code></pre>
<hr/>
<h2 data-id="heading-59">10. 常用命令速查</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 拉取模型</span>
docker <span class="hljs-built_in">exec</span> -it ollama ollama pull qwen2.5-coder:3b

<span class="hljs-comment"># 查看模型列表</span>
docker <span class="hljs-built_in">exec</span> -it ollama ollama list

<span class="hljs-comment"># 运行模型</span>
docker <span class="hljs-built_in">exec</span> -it ollama ollama run qwen2.5-coder:3b

<span class="hljs-comment"># 查看日志</span>
docker logs -f ollama

<span class="hljs-comment"># 重启容器</span>
docker restart ollama

<span class="hljs-comment"># 进入容器</span>
docker <span class="hljs-built_in">exec</span> -it ollama bash

<span class="hljs-comment"># 删除容器</span>
docker <span class="hljs-built_in">rm</span> -f ollama

<span class="hljs-comment"># 测试 API</span>
curl http://localhost:11434/api/tags
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解决Chocolatey动态更新环境变量功能 RefreshEnv.cmd在新版 Windows 上的兼容性问题]]></title>    <link>https://juejin.cn/post/7598464972912787496</link>    <guid>https://juejin.cn/post/7598464972912787496</guid>    <pubDate>2026-01-24T13:24:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598464972912787496" data-draft-id="7598459769239158818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解决Chocolatey动态更新环境变量功能 RefreshEnv.cmd在新版 Windows 上的兼容性问题"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-24T13:24:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解决Chocolatey动态更新环境变量功能 RefreshEnv.cmd在新版 Windows 上的兼容性问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T13:24:49.000Z" title="Sat Jan 24 2026 13:24:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Windows 10/11 系统上运行 Chocolatey 的环境变量刷新脚本 <code>RefreshEnv.cmd</code> 时，有时会遇到以下错误：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-string">'wmic'</span> 不是内部或外部命令，也不是可运行的程序
或批处理文件。
Refreshing environment variables <span class="hljs-keyword">from</span> registry <span class="hljs-keyword">for</span> cmd.exe. Please wait...Finished..
</code></pre>
<h2 data-id="heading-0">问题分析</h2>
<h3 data-id="heading-1">wmic 是什么？</h3>
<p><code>wmic</code> (Windows Management Instrumentation Command-line) 是 Windows 的一个命令行工具，用于通过 WMI 接口查询和管理系统信息。它可以用来查看系统配置、管理进程和服务等。</p>
<h3 data-id="heading-2">为什么会报错？</h3>
<p>微软在 Windows 10 21H2 和 Windows 11 中开始弃用 <code>wmic</code>，计划在未来版本中完全移除它。在较新的 Windows 版本（如 Windows 10.0.26220）中，<code>wmic</code> 命令已经不可用。</p>
<h3 data-id="heading-3">脚本分析</h3>
<p><code>RefreshEnv.cmd</code> 脚本使用 <code>wmic</code> 来检测父进程，以便确定脚本是如何被调用的（是否被外部调用）。相关代码位于脚本开头的进程检测部分：</p>
<pre><code class="hljs language-batch" lang="batch">for /f "tokens=2 delims==" %%i in (
    'wmic Process WHERE "Name='!CmdExeName!' AND CommandLine LIKE '%%!uid!%%'" GET ParentProcessID /value'
) do (
    rem Get commandline of parent
    for /f "tokens=1,2,*" %%j in (
        'wmic Process WHERE "Handle='%%i'" GET CommandLine /value'
    ) do (
        ...
    )
)
</code></pre>
<h2 data-id="heading-4">解决方案</h2>
<h3 data-id="heading-5">思路</h3>
<p>用 PowerShell 的 <code>Get-CimInstance</code> 命令替代 <code>wmic</code> 命令。PowerShell 的 CIM cmdlets 是微软推荐的 wmic 替代方案。</p>
<h3 data-id="heading-6">实现步骤</h3>
<ol>
<li><strong>使用 Get-CimInstance 获取父进程 ID</strong></li>
</ol>
<pre><code class="hljs language-batch" lang="batch">REM Use PowerShell instead of wmic to get parent process ID
for /f "tokens=1" %%i in ('powershell -NoProfile -Command "$proc = Get-CimInstance Win32_Process | Where-Object { $_.Name -eq '!CmdExeName!' -and $_.CommandLine -like '*!uid!*' }; if ($proc) { $proc.ParentProcessId }"') do (
    set ParentPID=%%i
)
</code></pre>
<ol start="2">
<li><strong>使用 Get-CimInstance 获取父进程命令行</strong></li>
</ol>
<pre><code class="hljs language-batch" lang="batch">rem Get commandline of parent using PowerShell
for /f "tokens=*" %%l in ('powershell -NoProfile -Command "$proc = Get-CimInstance Win32_Process -Filter \"Handle = '!ParentPID!'\"; if ($proc) { $proc.CommandLine }"') do (
    set ParentCommandLine=%%l
)
</code></pre>
<ol start="3">
<li><strong>使用 Get-CimInstance 获取父进程路径</strong></li>
</ol>
<pre><code class="hljs language-batch" lang="batch">rem Get parent process path using PowerShell
for /f "tokens=*" %%p in ('powershell -NoProfile -Command "$proc = Get-CimInstance Win32_Process -Filter \"Handle = '!ParentPID!'\"; if ($proc) { $proc.ExecutablePath }"') do (
    set ParentPath=%%p
)
</code></pre>
<ol start="4">
<li><strong>保留原有的逻辑判断</strong></li>
</ol>
<pre><code class="hljs language-batch" lang="batch">rem Dequote parent path
set ParentPath=!ParentPath:"=!

rem Handle different invocations: C:\Windows\system32\cmd.exe , cmd.exe , cmd
for %%p in (!CmdPath! !CmdExeName! !CmdName!) do (
    if /i "!ParentPath!"=="%%p" set IsCmdParent=1
)

rem Check if we're running in cmd.exe with /c switch and this script path as argument
if !IsCmdParent!==1 (
    for /f "tokens=1,2,3*" %%a in ("!ParentCommandLine!") do (
        if /i "%%b"=="/c" (
            set ParentScriptPath=%%c
            set ParentScriptPath=!ParentScriptPath:"=!
            if "!ParentScriptPath!"=="%ScriptPath%" set IsExternal=1
        )
    )
)
</code></pre>
<h3 data-id="heading-7">部署方法</h3>
<p>由于 <code>RefreshEnv.cmd</code> 位于系统目录 <code>C:\ProgramData\chocolatey\bin\redirects\</code>，需要使用管理员权限进行修改。可以使用以下 PowerShell 命令进行部署：</p>
<pre><code class="hljs language-powershell" lang="powershell">Copy-Item '修复后的文件路径' 'C:\ProgramData\chocolatey\bin\redirects\RefreshEnv.cmd' -Force
</code></pre>
<h2 data-id="heading-8">结果</h2>
<p>修复后的 <code>RefreshEnv.cmd</code> 脚本可以正常运行，不再报 <code>wmic</code> 不可用的错误。环境变量刷新功能恢复正常。</p>
<h2 data-id="heading-9">总结</h2>
<ul>
<li><code>wmic</code> 在新版 Windows 中已被弃用，需要使用 PowerShell 的 CIM cmdlets 替代</li>
<li><code>Get-CimInstance Win32_Process</code> 可以完全替代 <code>wmic Process</code> 的功能</li>
<li>修改脚本时需要保留原有的逻辑判断，只替换数据获取方式</li>
<li>部署到系统目录需要管理员权限</li>
</ul>
<h2 data-id="heading-10">wmic 与 PowerShell 替代对照表</h2>

























<table><thead><tr><th>wmic 命令</th><th>PowerShell 替代</th></tr></thead><tbody><tr><td><code>wmic cpu get name</code></td><td><code>Get-CimInstance Win32_Processor | Select Name</code></td></tr><tr><td><code>wmic os get version</code></td><td><code>Get-CimInstance Win32_OperatingSystem | Select Version</code></td></tr><tr><td><code>wmic process get name</code></td><td><code>Get-Process | Select Name</code></td></tr><tr><td><code>wmic Process WHERE "Name='cmd.exe'" GET ParentProcessID /value</code></td><td><code>Get-CimInstance Win32_Process | Where-Object { $_.Name -eq 'cmd.exe' } | Select ParentProcessId</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-11">完整修改后的 RefreshEnv.cmd 文件</h2>
<pre><code class="hljs language-batch" lang="batch">@echo off
REM Code generously provided by @beatcracker: https://github.com/beatcracker/detect-batch-subshell

setlocal EnableDelayedExpansion

REM Dequote path to command processor and this script path
set ScriptPath=%~0
set CmdPath=%COMSPEC:"=%

REM Get command processor filename and filename with extension
for %%c in (!CmdPath!) do (
    set CmdExeName=%%~nxc
    set CmdName=%%~nc
)

REM Get this process' PID
REM Adapted from: http://www.dostips.com/forum/viewtopic.php?p=22675#p22675
set "uid="
for /l %%i in (1 1 128) do (
    set /a "bit=!random!&amp;1"
    set "uid=!uid!!bit!"
)

REM Use PowerShell instead of wmic to get parent process ID
for /f "tokens=1" %%i in ('powershell -NoProfile -Command "$proc = Get-CimInstance Win32_Process | Where-Object { $_.Name -eq '!CmdExeName!' -and $_.CommandLine -like '*!uid!*' }; if ($proc) { $proc.ParentProcessId }"') do (
    set ParentPID=%%i
)

if defined ParentPID (
    rem Get commandline of parent using PowerShell
    for /f "tokens=*" %%l in ('powershell -NoProfile -Command "$proc = Get-CimInstance Win32_Process -Filter \"Handle = '!ParentPID!'\"; if ($proc) { $proc.CommandLine }"') do (
        set ParentCommandLine=%%l
    )

    rem Get parent process path using PowerShell
    for /f "tokens=*" %%p in ('powershell -NoProfile -Command "$proc = Get-CimInstance Win32_Process -Filter \"Handle = '!ParentPID!'\"; if ($proc) { $proc.ExecutablePath }"') do (
        set ParentPath=%%p
    )

    rem Dequote parent path
    set ParentPath=!ParentPath:"=!

    rem Handle different invocations: C:\Windows\system32\cmd.exe , cmd.exe , cmd
    for %%p in (!CmdPath! !CmdExeName! !CmdName!) do (
        if /i "!ParentPath!"=="%%p" set IsCmdParent=1
    )

    rem Check if we're running in cmd.exe with /c switch and this script path as argument
    if !IsCmdParent!==1 (
        for /f "tokens=1,2,3*" %%a in ("!ParentCommandLine!") do (
            if /i "%%b"=="/c" (
                set ParentScriptPath=%%c
                set ParentScriptPath=!ParentScriptPath:"=!
                if "!ParentScriptPath!"=="%ScriptPath%" set IsExternal=1
            )
        )
    )
)

if !IsExternal!==1 (
    echo %~nx0 does not work when run from this process. If you're in PowerShell, please 'Import-Module $env:ChocolateyInstall\helpers\chocolateyProfile.psm1' and try again.
    exit 1
)

REM End code from @beatcracker
@echo off
REM
REM RefreshEnv.cmd
REM
REM Batch file to read environment variables from registry and
REM set session variables to these values.
REM
REM With this batch file, there should be no need to reload command
REM environment every time you want environment changes to propagate

REM echo "RefreshEnv.cmd only works from cmd.exe, please install the Chocolatey Profile to take advantage of refreshenv from PowerShell"
echo | set /p dummy="Refreshing environment variables from registry for cmd.exe. Please wait..."

goto main

REM Set one environment variable from registry key
:SetFromReg
    "%WinDir%\System32\Reg" QUERY "%~1" /v "%~2" &gt; "%TEMP%\_envset.tmp" 2&gt;NUL
    for /f "usebackq skip=2 tokens=2,*" %%A IN ("%TEMP%\_envset.tmp") do (
        set "tempvar=%%B"
        REM Remove double quotes from temporary value
        set "__tempvar=!tempvar:"=!"

        REM Only escape percentage signs when the value type
        REM is not defined as an expandable string.
        if /I NOT "%%~A"=="REG_EXPAND_SZ" (
            set "tempvar=!tempvar:%%=%%%%!"
        )

        REM If the dequoted string differs from the original string, the variable contains double quotes.
        REM Escape the | and &amp; in the variable to avoid errors.
        if NOT "!__tempvar!" == "!tempvar!" (
            set "tempvar=!tempvar:|=^|!"
            set "tempvar=!tempvar:&amp;=^&amp;!"
        )

        echo/set "%~3=!tempvar!"
    )
    goto :EOF

REM Get a list of environment variables from registry
:GetRegEnv
    "%WinDir%\System32\Reg" QUERY "%~1" &gt; "%TEMP%\_envget.tmp"
    for /f "usebackq skip=2" %%A IN ("%TEMP%\_envget.tmp") do (
        if /I not "%%~A"=="Path" (
            call :SetFromReg "%~1" "%%~A" "%%~A"
        )
    )
    goto :EOF

:main
    echo/@echo off &gt;"%TEMP%\_env.cmd"

    REM Slowly generating final file
    call :GetRegEnv "HKLM\System\CurrentControlSet\Control\Session Manager\Environment" &gt;&gt; "%TEMP%\_env.cmd"
    call :GetRegEnv "HKCU\Environment"&gt;&gt;"%TEMP%\_env.cmd" &gt;&gt; "%TEMP%\_env.cmd"

    REM Special handling for PATH - mix both User and System
    call :SetFromReg "HKLM\System\CurrentControlSet\Control\Session Manager\Environment" Path Path_HKLM &gt;&gt; "%TEMP%\_env.cmd"
    call :SetFromReg "HKCU\Environment" Path Path_HKCU &gt;&gt; "%TEMP%\_env.cmd"

    endlocal

    REM Caution: do not insert space-chars before &gt;&gt; redirection sign
    echo/set "Path=%%Path_HKLM%%;%%Path_HKCU%%" &gt;&gt; "%TEMP%\_env.cmd"

    REM Cleanup
    del /f /q "%TEMP%\_envset.tmp" 2&gt;nul
    del /f /q "%TEMP%\_envget.tmp" 2&gt;nul

    REM capture user / architecture
    SET "OriginalUserName=%USERNAME%"
    SET "OriginalArchitecture=%PROCESSOR_ARCHITECTURE%"

    REM Set these variables
    call "%TEMP%\_env.cmd"

    REM Cleanup
    del /f /q "%TEMP%\_env.cmd" 2&gt;nul

    REM reset user / architecture
    SET "USERNAME=%OriginalUserName%"
    SET "PROCESSOR_ARCHITECTURE=%OriginalArchitecture%"

    echo | set /p dummy="Finished."
    echo .
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让自定义对象像 list/dict 一样丝滑——Python `__xxitem__` 魔术方法全家桶实战]]></title>    <link>https://juejin.cn/post/7598699872541048851</link>    <guid>https://juejin.cn/post/7598699872541048851</guid>    <pubDate>2026-01-24T13:26:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598699872541048851" data-draft-id="7598447519824478249" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让自定义对象像 list/dict 一样丝滑——Python `__xxitem__` 魔术方法全家桶实战  "/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-24T13:26:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让自定义对象像 list/dict 一样丝滑——Python `__xxitem__` 魔术方法全家桶实战  
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T13:26:24.000Z" title="Sat Jan 24 2026 13:26:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>写 Python 这么久，你有没有想过：<br/>
<code>obj[1]</code>, <code>obj['name']</code>, <code>obj[1:10:2]</code>, <code>del obj[key]</code>…<br/>
这些语法为什么对 list、dict 有效，对自己写的类却报错？<br/>
答案藏在 7 个以 <code>item</code> 为核心的“魔术方法”里。今天 10 分钟带你一次配齐，写完就能让老板/面试官眼前一亮。</p>
<hr/>
<p>一、先记住一张“七龙珠”表</p>





















































<table><thead><tr><th>魔术方法</th><th>触发语法</th><th>用途</th><th>不写的后果</th></tr></thead><tbody><tr><td><code>__getitem__</code></td><td><code>obj[key]</code> / 切片</td><td>读元素</td><td>直接 TypeError</td></tr><tr><td><code>__setitem__</code></td><td><code>obj[key]=val</code></td><td>写元素</td><td>无法赋值</td></tr><tr><td><code>__delitem__</code></td><td><code>del obj[key]</code></td><td>删元素</td><td>无法删除</td></tr><tr><td><code>__len__</code></td><td><code>len(obj)</code></td><td>容器长度</td><td>list() 无限递归</td></tr><tr><td><code>__iter__</code></td><td><code>for i in obj:</code></td><td>迭代</td><td>list() 无限递归</td></tr><tr><td><code>__contains__</code></td><td><code>key in obj</code></td><td>成员测试</td><td>退回到暴力遍历</td></tr><tr><td><code>__missing__</code>*</td><td><code>dict[key]</code></td><td>缺失兜底</td><td>仅 dict 子类有效</td></tr></tbody></table>
<hr/>
<p>二、最小可运行模板（支持切片、负数索引、越界提示）<br/>
把下面 30 行代码粘到 IDE，直接跑通：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyList</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, init=(<span class="hljs-params"/>)</span>):
        self._data = <span class="hljs-built_in">list</span>(init)

    <span class="hljs-comment"># ---- 读 ----</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(idx, <span class="hljs-built_in">slice</span>):
            <span class="hljs-keyword">return</span> self._data[idx]
        <span class="hljs-keyword">if</span> -<span class="hljs-built_in">len</span>(self._data) &lt;= idx &lt; <span class="hljs-built_in">len</span>(self._data):
            <span class="hljs-keyword">return</span> self._data[idx]
        <span class="hljs-keyword">raise</span> IndexError(<span class="hljs-string">'MyList index out of range'</span>)

    <span class="hljs-comment"># ---- 写 ----</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__setitem__</span>(<span class="hljs-params">self, idx, value</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(idx, <span class="hljs-built_in">slice</span>):
            self._data[idx] = value
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">if</span> -<span class="hljs-built_in">len</span>(self._data) &lt;= idx &lt; <span class="hljs-built_in">len</span>(self._data):
            self._data[idx] = value
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">raise</span> IndexError(<span class="hljs-string">'MyList assignment index out of range'</span>)

    <span class="hljs-comment"># ---- 删 ----</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__delitem__</span>(<span class="hljs-params">self, idx</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(idx, <span class="hljs-built_in">slice</span>):
            <span class="hljs-keyword">del</span> self._data[idx]
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">if</span> -<span class="hljs-built_in">len</span>(self._data) &lt;= idx &lt; <span class="hljs-built_in">len</span>(self._data):
            <span class="hljs-keyword">del</span> self._data[idx]
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">raise</span> IndexError(<span class="hljs-string">'MyList deletion index out of range'</span>)

    <span class="hljs-comment"># ---- 长度 + 迭代 ----</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self._data)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">iter</span>(self._data)

    <span class="hljs-comment"># ---- 调试友好 ----</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">f'<span class="hljs-subst">{self.__class__.__name__}</span>(<span class="hljs-subst">{self._data}</span>)'</span>
</code></pre>
<p>测试一把：</p>
<pre><code class="hljs language-python" lang="python">m = MyList(<span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>))
<span class="hljs-built_in">print</span>(m)          <span class="hljs-comment"># MyList([0, 1, 2, 3, 4])</span>
<span class="hljs-built_in">print</span>(m[<span class="hljs-number">1</span>::<span class="hljs-number">2</span>])    <span class="hljs-comment"># [1, 3]</span>
m[<span class="hljs-number">2</span>] = <span class="hljs-number">99</span>
<span class="hljs-keyword">del</span> m[-<span class="hljs-number">1</span>]
<span class="hljs-built_in">print</span>(m, <span class="hljs-built_in">len</span>(m))  <span class="hljs-comment"># MyList([0, 1, 99, 3]) 4</span>
</code></pre>
<hr/>
<p>三、3 个高频进阶场景</p>
<ol>
<li>同时支持“序列”+“映射”风格</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Row</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, values, headers</span>):
        self._row = values
        self._<span class="hljs-built_in">dict</span> = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(headers, values))
    
    <span class="hljs-comment"># 展示接口</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, key</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(key, <span class="hljs-built_in">int</span>):
            <span class="hljs-keyword">return</span> self._row[key]
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(key, <span class="hljs-built_in">str</span>):
            <span class="hljs-keyword">return</span> self._<span class="hljs-built_in">dict</span>[key]
        <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">'key must be int or str'</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">f'Row(<span class="hljs-subst">{self._<span class="hljs-built_in">dict</span>}</span>)'</span>

<span class="hljs-comment"># 使用示例</span>
headers = [<span class="hljs-string">'id'</span>, <span class="hljs-string">'name'</span>, <span class="hljs-string">'age'</span>]
values  = [<span class="hljs-number">1</span>, <span class="hljs-string">'kimi'</span>, <span class="hljs-number">18</span>]
row = Row(values, headers)

<span class="hljs-built_in">print</span>(row[<span class="hljs-number">0</span>])      <span class="hljs-comment"># 1      ← 把行当列表</span>
<span class="hljs-built_in">print</span>(row[<span class="hljs-string">'name'</span>]) <span class="hljs-comment"># 'kimi' ← 把行当字典</span>
<span class="hljs-built_in">print</span>(row[<span class="hljs-number">1</span>:])     <span class="hljs-comment"># 抛 TypeError，因为切片没实现（可再扩展）</span>
</code></pre>
<ol start="2">
<li>让 dict 子类在 key 缺失时自动插入默认值</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoDict</span>(<span class="hljs-title class_ inherited__">dict</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__missing__</span>(<span class="hljs-params">self, key</span>):
        self[key] = []
        <span class="hljs-keyword">return</span> self[key]

d = AutoDict()
d[<span class="hljs-string">'users'</span>].append(<span class="hljs-string">'kimi'</span>)   <span class="hljs-comment"># 不会 KeyError</span>
</code></pre>
<ol start="3">
<li>多维数组下标 <code>matrix[1, 2]</code><br/>
把 <code>key</code> 当成 tuple 解包即可：</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, key</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(key, <span class="hljs-built_in">tuple</span>) <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(key) == <span class="hljs-number">2</span>:
        r, c = key
        <span class="hljs-keyword">return</span> self._data[r][c]
    ...
</code></pre>
<hr/>
<p>四、那些年我们踩过的坑</p>
<ul>
<li>只写 <code>__getitem__</code> 却忘了 <code>__len__</code> 与 <code>__iter__</code>，<code>list(myobj)</code> 会无限递归直到 RecursionError。</li>
<li><code>__setitem__</code> 里忘记对负数索引做“转正”处理，<code>-1</code> 被当成越界。</li>
<li>切片赋值左右长度不一致时，list 会自动伸缩；若想“定长”容器，需要主动拦截。</li>
<li>在 <code>__delitem__</code> 里把最后一个元素删光后，记得同步计数器，否则 <code>len()</code> 不一致。</li>
</ul>
<hr/>
<p>五、一行总结<br/>
集齐 <code>__xxitem__</code> 七龙珠，你的自定义对象就能在语义、性能、习惯上与 Python 原生容器“无感”互换；下次面试官问“如何让自己写的类支持切片？”直接把这篇链接甩给他。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js 页面导航深度解析：Link 组件的全面指南]]></title>    <link>https://juejin.cn/post/7598827845965463578</link>    <guid>https://juejin.cn/post/7598827845965463578</guid>    <pubDate>2026-01-24T13:26:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598827845965463578" data-draft-id="7598827845965447194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js 页面导航深度解析：Link 组件的全面指南"/> <meta itemprop="keywords" content="Next.js"/> <meta itemprop="datePublished" content="2026-01-24T13:26:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js 页面导航深度解析：Link 组件的全面指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T13:26:20.000Z" title="Sat Jan 24 2026 13:26:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Next.js 页面导航深度解析：Link 组件的全面指南</h2>
<h3 data-id="heading-1">一、Next.js 导航系统概述</h3>
<h4 data-id="heading-2">1.1 客户端导航 vs 服务器端导航</h4>
<p>Next.js 提供了两种主要的导航方式：客户端导航和服务器端导航。了解它们的区别是优化应用性能的关键。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 对比示例</span>
<span class="hljs-keyword">const</span> navigationComparison = {
  客户端导航: {
    特点: [
      <span class="hljs-string">'使用 Link 组件或 router.push()'</span>,
      <span class="hljs-string">'不刷新整个页面'</span>,
      <span class="hljs-string">'只更新变化的部分'</span>,
      <span class="hljs-string">'提供更快的用户体验'</span>,
      <span class="hljs-string">'支持预加载'</span>
    ],
    适用场景: <span class="hljs-string">'应用内部页面跳转'</span>
  },
  服务器端导航: {
    特点: [
      <span class="hljs-string">'使用传统的 &lt;a&gt; 标签'</span>,
      <span class="hljs-string">'刷新整个页面'</span>,
      <span class="hljs-string">'重新加载所有资源'</span>,
      <span class="hljs-string">'完整的页面重载'</span>,
      <span class="hljs-string">'SEO友好'</span>
    ],
    适用场景: <span class="hljs-string">'外部链接、首次访问'</span>
  }
};
</code></pre>
<h4 data-id="heading-3">1.2 导航系统架构图</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────┐
│          Next<span class="hljs-selector-class">.js</span> 导航系统工作流程            │
├─────────────────────────────────────────────┤
│  <span class="hljs-number">1</span>. 用户点击链接                           │
│  <span class="hljs-number">2</span>. Next<span class="hljs-selector-class">.js</span> 拦截点击事件                   │
│  <span class="hljs-number">3</span>. 检查链接是否在应用内部                  │
│  <span class="hljs-number">4</span>. 预加载目标页面资源                     │
│  <span class="hljs-number">5</span>. 获取页面数据 (getStaticProps等)        │
│  <span class="hljs-number">6</span>. 平滑过渡到新页面                       │
│  <span class="hljs-number">7</span>. 更新浏览器 URL (不刷新页面)            │
│  <span class="hljs-number">8</span>. 滚动位置管理                           │
└─────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-4">二、Link 组件深度解析</h3>
<h4 data-id="heading-5">2.1 Link 组件基础使用</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 基础链接</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/link'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Navigation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
      {/* 基本使用 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      
      {/* Next.js 13+ 语法 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/about"</span>&gt;</span>
        关于我们
      <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      
      {/* 自定义样式 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/products"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"nav-link"</span>&gt;</span>产品<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-6">2.2 Link 组件完整属性</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/link'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">CompleteLinkExample</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 1. href - 目标URL */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/dashboard"</span>&gt;</span>
        仪表板
      <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      
      {/* 2. as - URL映射（Next.js 12及之前） */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> 
        <span class="hljs-attr">href</span>=<span class="hljs-string">"/user/[id]/profile"</span> 
        <span class="hljs-attr">as</span>=<span class="hljs-string">"/user/123/profile"</span>
      &gt;</span>
        用户资料
      <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      
      {/* 3. prefetch - 预加载控制 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> 
        <span class="hljs-attr">href</span>=<span class="hljs-string">"/products"</span> 
        <span class="hljs-attr">prefetch</span>=<span class="hljs-string">{false}</span>  // <span class="hljs-attr">禁用预加载</span>
      &gt;</span>
        产品（不预加载）
      <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      
      {/* 4. replace - 替换当前历史记录 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> 
        <span class="hljs-attr">href</span>=<span class="hljs-string">"/login"</span> 
        <span class="hljs-attr">replace</span>  // <span class="hljs-attr">替换而不是push</span>
      &gt;</span>
        登录（替换历史）
      <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      
      {/* 5. scroll - 滚动控制 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> 
        <span class="hljs-attr">href</span>=<span class="hljs-string">"/contact"</span> 
        <span class="hljs-attr">scroll</span>=<span class="hljs-string">{false}</span>  // <span class="hljs-attr">保持滚动位置</span>
      &gt;</span>
        联系（不滚动到顶部）
      <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      
      {/* 6. shallow - 浅层路由 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> 
        <span class="hljs-attr">href</span>=<span class="hljs-string">"/?page=2"</span> 
        <span class="hljs-attr">shallow</span>  // <span class="hljs-attr">不运行数据获取方法</span>
      &gt;</span>
        下一页（浅层路由）
      <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      
      {/* 7. locale - 国际化支持 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> 
        <span class="hljs-attr">href</span>=<span class="hljs-string">"/about"</span> 
        <span class="hljs-attr">locale</span>=<span class="hljs-string">"en"</span>  // <span class="hljs-attr">切换到英文</span>
      &gt;</span>
        About in English
      <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      
      {/* 8. legacyBehavior - 向后兼容 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> 
        <span class="hljs-attr">href</span>=<span class="hljs-string">"/old-page"</span> 
        <span class="hljs-attr">legacyBehavior</span>  // <span class="hljs-attr">使用旧版行为</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">a</span>&gt;</span>旧版链接<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-7">三、动态路由导航</h3>
<h4 data-id="heading-8">3.1 带参数的动态路由</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/link'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">DynamicNavigation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> products = [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'笔记本电脑'</span>, <span class="hljs-attr">slug</span>: <span class="hljs-string">'laptop'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'智能手机'</span>, <span class="hljs-attr">slug</span>: <span class="hljs-string">'smartphone'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'平板电脑'</span>, <span class="hljs-attr">slug</span>: <span class="hljs-string">'tablet'</span> },
  ];
  
  <span class="hljs-keyword">const</span> categories = [
    { <span class="hljs-attr">id</span>: <span class="hljs-string">'electronics'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'电子产品'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-string">'clothing'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'服装'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-string">'books'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'图书'</span> },
  ];
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>产品导航<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        {products.map(product =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{product.id}</span>&gt;</span>
            {/* 字符串模板 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{</span>`/<span class="hljs-attr">products</span>/${<span class="hljs-attr">product.id</span>}`}&gt;</span>
              产品详情 - {product.name}
            <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
            
            {/* 对象语法 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{{</span>
              <span class="hljs-attr">pathname:</span> '/<span class="hljs-attr">products</span>/[<span class="hljs-attr">id</span>]',
              <span class="hljs-attr">query:</span> { 
                <span class="hljs-attr">id:</span> <span class="hljs-attr">product.id</span>,
                <span class="hljs-attr">name:</span> <span class="hljs-attr">product.name</span> 
              }
            }}&gt;</span>
              对象语法 - {product.name}
            <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>嵌套动态路由<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
        {categories.map(category =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{category.id}</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{</span>`/<span class="hljs-attr">shop</span>/${<span class="hljs-attr">category.id</span>}/<span class="hljs-attr">products</span>`}&gt;</span>
              {category.name}
            <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>多参数路由<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/blog/2024/react-tutorial"</span>&gt;</span>
        2024年React教程
      <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-9">3.2 查询参数导航</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/link'</span>;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/router'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">QueryNavigation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  
  <span class="hljs-comment">// 当前查询参数</span>
  <span class="hljs-keyword">const</span> currentPage = router.<span class="hljs-property">query</span>.<span class="hljs-property">page</span> || <span class="hljs-number">1</span>;
  <span class="hljs-keyword">const</span> currentSort = router.<span class="hljs-property">query</span>.<span class="hljs-property">sort</span> || <span class="hljs-string">'newest'</span>;
  <span class="hljs-keyword">const</span> currentCategory = router.<span class="hljs-property">query</span>.<span class="hljs-property">category</span> || <span class="hljs-string">'all'</span>;
  
  <span class="hljs-comment">// 生成分页链接</span>
  <span class="hljs-keyword">const</span> paginationLinks = [
    { <span class="hljs-attr">page</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'第一页'</span> },
    { <span class="hljs-attr">page</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'第二页'</span> },
    { <span class="hljs-attr">page</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'第三页'</span> },
  ];
  
  <span class="hljs-comment">// 排序选项</span>
  <span class="hljs-keyword">const</span> sortOptions = [
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'newest'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'最新'</span> },
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'popular'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'最受欢迎'</span> },
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'price-low'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'价格从低到高'</span> },
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'price-high'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'价格从高到低'</span> },
  ];
  
  <span class="hljs-comment">// 分类选项</span>
  <span class="hljs-keyword">const</span> categories = [
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'all'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'全部'</span> },
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'electronics'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'电子产品'</span> },
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'books'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'图书'</span> },
    { <span class="hljs-attr">value</span>: <span class="hljs-string">'clothing'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'服装'</span> },
  ];
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"filter-navigation"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>带查询参数的导航<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      
      {/* 分页导航 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"pagination"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>分页<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"pagination-links"</span>&gt;</span>
          {paginationLinks.map(({ page, label }) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span>
              <span class="hljs-attr">key</span>=<span class="hljs-string">{page}</span>
              <span class="hljs-attr">href</span>=<span class="hljs-string">{{</span>
                <span class="hljs-attr">pathname:</span> '/<span class="hljs-attr">products</span>',
                <span class="hljs-attr">query:</span> { 
                  <span class="hljs-attr">...router.query</span>,  // <span class="hljs-attr">保持其他查询参数</span>
                  <span class="hljs-attr">page:</span> <span class="hljs-attr">page</span> 
                }
              }}
              <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">page-link</span> ${<span class="hljs-attr">currentPage</span> == <span class="hljs-string">page</span> ? '<span class="hljs-attr">active</span>' <span class="hljs-attr">:</span> ''}`}
            &gt;</span>
              {label}
            <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {/* 排序导航 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"sorting"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>排序方式<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"sort-options"</span>&gt;</span>
          {sortOptions.map(({ value, label }) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span>
              <span class="hljs-attr">key</span>=<span class="hljs-string">{value}</span>
              <span class="hljs-attr">href</span>=<span class="hljs-string">{{</span>
                <span class="hljs-attr">pathname:</span> '/<span class="hljs-attr">products</span>',
                <span class="hljs-attr">query:</span> { 
                  <span class="hljs-attr">...router.query</span>,
                  <span class="hljs-attr">sort:</span> <span class="hljs-attr">value</span> 
                }
              }}
              <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">sort-link</span> ${<span class="hljs-attr">currentSort</span> === <span class="hljs-string">value</span> ? '<span class="hljs-attr">active</span>' <span class="hljs-attr">:</span> ''}`}
            &gt;</span>
              {label}
            <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {/* 分类导航 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"categories"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>分类筛选<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"category-links"</span>&gt;</span>
          {categories.map(({ value, label }) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span>
              <span class="hljs-attr">key</span>=<span class="hljs-string">{value}</span>
              <span class="hljs-attr">href</span>=<span class="hljs-string">{{</span>
                <span class="hljs-attr">pathname:</span> '/<span class="hljs-attr">products</span>',
                <span class="hljs-attr">query:</span> { 
                  <span class="hljs-attr">...router.query</span>,
                  <span class="hljs-attr">category:</span> <span class="hljs-attr">value</span> 
                }
              }}
              <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">category-link</span> ${<span class="hljs-attr">currentCategory</span> === <span class="hljs-string">value</span> ? '<span class="hljs-attr">active</span>' <span class="hljs-attr">:</span> ''}`}
            &gt;</span>
              {label}
            <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {/* 复杂查询参数示例 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"complex-query"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>复杂筛选<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Link</span>
          <span class="hljs-attr">href</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">pathname:</span> '/<span class="hljs-attr">products</span>',
            <span class="hljs-attr">query:</span> {
              <span class="hljs-attr">category:</span> '<span class="hljs-attr">electronics</span>',
              <span class="hljs-attr">minPrice:</span> <span class="hljs-attr">1000</span>,
              <span class="hljs-attr">maxPrice:</span> <span class="hljs-attr">5000</span>,
              <span class="hljs-attr">brand:</span> '<span class="hljs-attr">apple</span>,<span class="hljs-attr">samsung</span>',
              <span class="hljs-attr">inStock:</span> <span class="hljs-attr">true</span>,
              <span class="hljs-attr">sort:</span> '<span class="hljs-attr">price-low</span>',
              <span class="hljs-attr">page:</span> <span class="hljs-attr">1</span>
            }
          }}
          <span class="hljs-attr">className</span>=<span class="hljs-string">"complex-filter-link"</span>
        &gt;</span>
          查看高端电子产品
        <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-10">四、useRouter 编程式导航</h3>
<h4 data-id="heading-11">4.1 useRouter 基础使用</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/router'</span>;
<span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ProgrammaticNavigation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [navigationHistory, setNavigationHistory] = <span class="hljs-title function_">useState</span>([]);
  
  <span class="hljs-comment">// 获取路由信息</span>
  <span class="hljs-keyword">const</span> {
    pathname,      <span class="hljs-comment">// 当前路径</span>
    query,         <span class="hljs-comment">// 查询参数对象</span>
    asPath,        <span class="hljs-comment">// 实际路径（包含查询参数）</span>
    locale,        <span class="hljs-comment">// 当前语言</span>
    isReady,       <span class="hljs-comment">// 路由器是否就绪</span>
    isFallback,    <span class="hljs-comment">// 是否在fallback状态</span>
  } = router;
  
  <span class="hljs-comment">// 基本导航方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNavigation</span> = (<span class="hljs-params">path</span>) =&gt; {
    <span class="hljs-comment">// 1. push - 添加新历史记录</span>
    router.<span class="hljs-title function_">push</span>(path);
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReplace</span> = (<span class="hljs-params">path</span>) =&gt; {
    <span class="hljs-comment">// 2. replace - 替换当前历史记录</span>
    router.<span class="hljs-title function_">replace</span>(path);
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleBack</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 3. back - 返回上一页</span>
    router.<span class="hljs-title function_">back</span>();
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleForward</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 4. forward - 前进</span>
    router.<span class="hljs-title function_">forward</span>();
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReload</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 5. reload - 重新加载当前页</span>
    router.<span class="hljs-title function_">reload</span>();
  };
  
  <span class="hljs-comment">// 复杂导航示例</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">navigateWithData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 模拟API调用</span>
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/auth/login'</span>, {
        <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
        <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">username</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">password</span>: <span class="hljs-string">'pass'</span> })
      });
      
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
      
      <span class="hljs-keyword">if</span> (data.<span class="hljs-property">success</span>) {
        <span class="hljs-comment">// 导航到仪表板</span>
        <span class="hljs-keyword">await</span> router.<span class="hljs-title function_">push</span>({
          <span class="hljs-attr">pathname</span>: <span class="hljs-string">'/dashboard'</span>,
          <span class="hljs-attr">query</span>: { 
            <span class="hljs-attr">welcome</span>: <span class="hljs-string">'true'</span>,
            <span class="hljs-attr">userId</span>: data.<span class="hljs-property">userId</span> 
          }
        });
        
        <span class="hljs-comment">// 添加成功消息</span>
        router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/dashboard?message=login-success'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 显示错误</span>
        router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/login?error=invalid-credentials'</span>);
      }
    } <span class="hljs-keyword">catch</span> (error) {
      router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/login?error=network-error'</span>);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    }
  };
  
  <span class="hljs-comment">// 监听路由变化</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRouteChangeStart</span> = (<span class="hljs-params">url</span>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'路由开始变化到:'</span>, url);
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
      
      <span class="hljs-comment">// 记录导航历史</span>
      <span class="hljs-title function_">setNavigationHistory</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, {
        url,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
        <span class="hljs-attr">type</span>: <span class="hljs-string">'start'</span>
      }]);
    };
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRouteChangeComplete</span> = (<span class="hljs-params">url</span>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'路由变化完成:'</span>, url);
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
      
      <span class="hljs-title function_">setNavigationHistory</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, {
        url,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
        <span class="hljs-attr">type</span>: <span class="hljs-string">'complete'</span>
      }]);
    };
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRouteChangeError</span> = (<span class="hljs-params">err, url</span>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'路由变化错误:'</span>, err);
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    };
    
    <span class="hljs-comment">// 订阅路由事件</span>
    router.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'routeChangeStart'</span>, handleRouteChangeStart);
    router.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'routeChangeComplete'</span>, handleRouteChangeComplete);
    router.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'routeChangeError'</span>, handleRouteChangeError);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      router.<span class="hljs-property">events</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'routeChangeStart'</span>, handleRouteChangeStart);
      router.<span class="hljs-property">events</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'routeChangeComplete'</span>, handleRouteChangeComplete);
      router.<span class="hljs-property">events</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'routeChangeError'</span>, handleRouteChangeError);
    };
  }, [router]);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"programmatic-nav"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>编程式导航<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      
      {/* 加载指示器 */}
      {loading &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"loading-overlay"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"loading-spinner"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>页面加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
      
      {/* 路由信息显示 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"route-info"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>当前路由信息<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span>
          {JSON.stringify({
            pathname,
            query,
            asPath,
            locale,
            isReady,
            isFallback
          }, null, 2)}
        <span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {/* 导航控制按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"navigation-controls"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleNavigation('/about')}
          className="nav-button"
        &gt;
          前往关于页面
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> handleReplace('/profile')}
          className="nav-button replace"
        &gt;
          替换到个人资料
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleBack}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"nav-button back"</span>
        &gt;</span>
          返回
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleForward}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"nav-button forward"</span>
        &gt;</span>
          前进
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{navigateWithData}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"nav-button with-data"</span>
          <span class="hljs-attr">disabled</span>=<span class="hljs-string">{loading}</span>
        &gt;</span>
          {loading ? '登录中...' : '登录并导航'}
        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {/* 动态参数导航 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"dynamic-navigation"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>动态生成导航<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"dynamic-buttons"</span>&gt;</span>
          {['home', 'about', 'contact', 'products', 'blog'].map((page) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
              <span class="hljs-attr">key</span>=<span class="hljs-string">{page}</span>
              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.push(`/${page}`)}
              className={`dynamic-button ${pathname === `/${page}` ? 'active' : ''}`}
            &gt;
              {page.charAt(0).toUpperCase() + page.slice(1)}
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {/* 导航历史记录 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"navigation-history"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>导航历史记录<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
          {navigationHistory.slice(-5).map((item, index) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">history-item</span> ${<span class="hljs-attr">item.type</span>}`}&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"timestamp"</span>&gt;</span>
                {new Date(item.timestamp).toLocaleTimeString()}
              <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"url"</span>&gt;</span>{item.url}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"type"</span>&gt;</span>({item.type})<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-12">4.2 高级路由操作</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/router'</span>;
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AdvancedRouterOperations</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  
  <span class="hljs-comment">// 1. 预取页面</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">prefetchPages</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 预取重要页面</span>
    router.<span class="hljs-title function_">prefetch</span>(<span class="hljs-string">'/dashboard'</span>);
    router.<span class="hljs-title function_">prefetch</span>(<span class="hljs-string">'/profile'</span>);
    router.<span class="hljs-title function_">prefetch</span>(<span class="hljs-string">'/settings'</span>);
    
    <span class="hljs-comment">// 预取动态路由</span>
    router.<span class="hljs-title function_">prefetch</span>(<span class="hljs-string">'/products/[id]'</span>, <span class="hljs-string">'/products/123'</span>);
    router.<span class="hljs-title function_">prefetch</span>(<span class="hljs-string">'/blog/[slug]'</span>, <span class="hljs-string">'/blog/react-tutorial'</span>);
  };
  
  <span class="hljs-comment">// 2. 守卫导航</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">guardedNavigation</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">targetPath</span>) =&gt; {
    <span class="hljs-comment">// 检查是否允许离开当前页</span>
    <span class="hljs-keyword">const</span> allowNavigation = <span class="hljs-title function_">confirm</span>(<span class="hljs-string">'确定要离开当前页面吗？'</span>);
    
    <span class="hljs-keyword">if</span> (allowNavigation) {
      <span class="hljs-comment">// 保存当前状态</span>
      <span class="hljs-keyword">const</span> currentState = {
        <span class="hljs-attr">scrollY</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>,
        <span class="hljs-attr">formData</span>: <span class="hljs-title function_">getFormData</span>(),
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
      };
      
      <span class="hljs-comment">// 保存到sessionStorage</span>
      sessionStorage.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">`state:<span class="hljs-subst">${router.asPath}</span>`</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(currentState));
      
      <span class="hljs-comment">// 执行导航</span>
      <span class="hljs-keyword">await</span> router.<span class="hljs-title function_">push</span>(targetPath);
    }
  };
  
  <span class="hljs-comment">// 3. 恢复页面状态</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">restorePageState</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> savedState = sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">`state:<span class="hljs-subst">${router.asPath}</span>`</span>);
    
    <span class="hljs-keyword">if</span> (savedState) {
      <span class="hljs-keyword">const</span> { scrollY, formData, timestamp } = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(savedState);
      
      <span class="hljs-comment">// 恢复滚动位置</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>(<span class="hljs-number">0</span>, scrollY);
      
      <span class="hljs-comment">// 恢复表单数据</span>
      <span class="hljs-title function_">restoreFormData</span>(formData);
      
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`恢复 <span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>(timestamp).toLocaleString()}</span> 的状态`</span>);
    }
  };
  
  <span class="hljs-comment">// 4. 监听路由变化并恢复状态</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRouteChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">restorePageState</span>();
    };
    
    router.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'routeChangeComplete'</span>, handleRouteChange);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      router.<span class="hljs-property">events</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'routeChangeComplete'</span>, handleRouteChange);
    };
  }, [router]);
  
  <span class="hljs-comment">// 5. 自定义导航钩子</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">useNavigationGuard</span> = (<span class="hljs-params">shouldBlockNavigation</span>) =&gt; {
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleBeforeUnload</span> = (<span class="hljs-params">event</span>) =&gt; {
        <span class="hljs-keyword">if</span> (shouldBlockNavigation) {
          event.<span class="hljs-title function_">preventDefault</span>();
          event.<span class="hljs-property">returnValue</span> = <span class="hljs-string">'您有未保存的更改，确定要离开吗？'</span>;
        }
      };
      
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRouteChangeStart</span> = (<span class="hljs-params">url</span>) =&gt; {
        <span class="hljs-keyword">if</span> (shouldBlockNavigation &amp;&amp; url !== router.<span class="hljs-property">asPath</span>) {
          <span class="hljs-keyword">const</span> confirmed = <span class="hljs-title function_">confirm</span>(<span class="hljs-string">'您有未保存的更改，确定要离开吗？'</span>);
          
          <span class="hljs-keyword">if</span> (!confirmed) {
            <span class="hljs-comment">// 取消导航</span>
            router.<span class="hljs-property">events</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'routeChangeError'</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-string">'取消导航'</span>;
          }
        }
      };
      
      <span class="hljs-comment">// 添加事件监听器</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, handleBeforeUnload);
      router.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'routeChangeStart'</span>, handleRouteChangeStart);
      
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'beforeunload'</span>, handleBeforeUnload);
        router.<span class="hljs-property">events</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'routeChangeStart'</span>, handleRouteChangeStart);
      };
    }, [shouldBlockNavigation, router]);
  };
  
  <span class="hljs-comment">// 示例：获取表单数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getFormData</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 模拟获取表单数据</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">username</span>: <span class="hljs-string">'john_doe'</span>,
      <span class="hljs-attr">email</span>: <span class="hljs-string">'john@example.com'</span>
    };
  };
  
  <span class="hljs-comment">// 示例：恢复表单数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">restoreFormData</span> = (<span class="hljs-params">data</span>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'恢复表单数据:'</span>, data);
    <span class="hljs-comment">// 实际实现会填充表单字段</span>
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"advanced-router"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>高级路由操作<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{prefetchPages}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"prefetch-button"</span>&gt;</span>
        预取重要页面
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> guardedNavigation('/new-page')}
        className="guarded-nav-button"
      &gt;
        带确认的导航
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{restorePageState}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"restore-button"</span>&gt;</span>
        恢复页面状态
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-13">五、导航性能优化</h3>
<h4 data-id="heading-14">5.1 智能预加载策略</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/link'</span>;
<span class="hljs-keyword">import</span> { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">SmartPrefetchNavigation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [visibleLinks, setVisibleLinks] = <span class="hljs-title function_">useState</span>([]);
  <span class="hljs-keyword">const</span> [hoveredLink, setHoveredLink] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [connectionType, setConnectionType] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'4g'</span>);
  
  <span class="hljs-comment">// 检测网络连接</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'connection'</span> <span class="hljs-keyword">in</span> navigator) {
      <span class="hljs-keyword">const</span> connection = navigator.<span class="hljs-property">connection</span>;
      <span class="hljs-title function_">setConnectionType</span>(connection.<span class="hljs-property">effectiveType</span>);
      
      <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateConnection</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-title function_">setConnectionType</span>(connection.<span class="hljs-property">effectiveType</span>);
      };
      
      connection.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, updateConnection);
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'change'</span>, updateConnection);
    }
  }, []);
  
  <span class="hljs-comment">// 智能预加载策略</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getPrefetchStrategy</span> = (<span class="hljs-params">link</span>) =&gt; {
    <span class="hljs-comment">// 根据网络状况调整预加载策略</span>
    <span class="hljs-keyword">const</span> strategies = {
      <span class="hljs-string">'slow-2g'</span>: <span class="hljs-string">'none'</span>,        <span class="hljs-comment">// 慢速网络不预加载</span>
      <span class="hljs-string">'2g'</span>: <span class="hljs-string">'hover-only'</span>,       <span class="hljs-comment">// 2G网络只在悬停时预加载</span>
      <span class="hljs-string">'3g'</span>: <span class="hljs-string">'viewport'</span>,         <span class="hljs-comment">// 3G网络预加载视口内链接</span>
      <span class="hljs-string">'4g'</span>: <span class="hljs-string">'aggressive'</span>,       <span class="hljs-comment">// 4G网络积极预加载</span>
      <span class="hljs-string">'5g'</span>: <span class="hljs-string">'all'</span>              <span class="hljs-comment">// 5G网络预加载所有链接</span>
    };
    
    <span class="hljs-keyword">return</span> strategies[connectionType] || <span class="hljs-string">'viewport'</span>;
  };
  
  <span class="hljs-comment">// 视口检测</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(
      <span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> visible = entries
          .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> entry.<span class="hljs-property">isIntersecting</span>)
          .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> entry.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">link</span>);
        
        <span class="hljs-title function_">setVisibleLinks</span>(visible);
      },
      {
        <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'50px'</span>, <span class="hljs-comment">// 提前50px检测</span>
        <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.1</span>
      }
    );
    
    <span class="hljs-comment">// 观察所有链接</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'[data-link]'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> {
      observer.<span class="hljs-title function_">observe</span>(el);
    });
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> observer.<span class="hljs-title function_">disconnect</span>();
  }, []);
  
  <span class="hljs-comment">// 页面重要性评分</span>
  <span class="hljs-keyword">const</span> pageImportance = {
    <span class="hljs-string">'/'</span>: <span class="hljs-number">10</span>,           <span class="hljs-comment">// 首页最重要</span>
    <span class="hljs-string">'/products'</span>: <span class="hljs-number">8</span>,    <span class="hljs-comment">// 产品页重要</span>
    <span class="hljs-string">'/about'</span>: <span class="hljs-number">6</span>,       <span class="hljs-comment">// 关于页中等重要</span>
    <span class="hljs-string">'/contact'</span>: <span class="hljs-number">5</span>,     <span class="hljs-comment">// 联系页</span>
    <span class="hljs-string">'/blog'</span>: <span class="hljs-number">7</span>,        <span class="hljs-comment">// 博客页</span>
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">shouldPrefetch</span> = (<span class="hljs-params">href</span>) =&gt; {
    <span class="hljs-keyword">const</span> strategy = <span class="hljs-title function_">getPrefetchStrategy</span>(href);
    <span class="hljs-keyword">const</span> importance = pageImportance[href] || <span class="hljs-number">3</span>;
    
    <span class="hljs-keyword">switch</span> (strategy) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'all'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'aggressive'</span>:
        <span class="hljs-keyword">return</span> importance &gt;= <span class="hljs-number">5</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'viewport'</span>:
        <span class="hljs-keyword">return</span> visibleLinks.<span class="hljs-title function_">includes</span>(href);
      <span class="hljs-keyword">case</span> <span class="hljs-string">'hover-only'</span>:
        <span class="hljs-keyword">return</span> hoveredLink === href;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'none'</span>:
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  };
  
  <span class="hljs-keyword">const</span> navigationItems = [
    { <span class="hljs-attr">href</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'首页'</span>, <span class="hljs-attr">importance</span>: <span class="hljs-string">'高'</span> },
    { <span class="hljs-attr">href</span>: <span class="hljs-string">'/products'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'产品'</span>, <span class="hljs-attr">importance</span>: <span class="hljs-string">'高'</span> },
    { <span class="hljs-attr">href</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'关于'</span>, <span class="hljs-attr">importance</span>: <span class="hljs-string">'中'</span> },
    { <span class="hljs-attr">href</span>: <span class="hljs-string">'/contact'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'联系'</span>, <span class="hljs-attr">importance</span>: <span class="hljs-string">'中'</span> },
    { <span class="hljs-attr">href</span>: <span class="hljs-string">'/blog'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'博客'</span>, <span class="hljs-attr">importance</span>: <span class="hljs-string">'高'</span> },
    { <span class="hljs-attr">href</span>: <span class="hljs-string">'/faq'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'FAQ'</span>, <span class="hljs-attr">importance</span>: <span class="hljs-string">'低'</span> },
  ];
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"smart-navigation"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>智能预加载导航<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"network-status"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前网络: <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>{connectionType}<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>预加载策略: <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>{getPrefetchStrategy()}<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"smart-nav"</span>&gt;</span>
        {navigationItems.map(({ href, label, importance }) =&gt; (
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">key</span>=<span class="hljs-string">{href}</span>
            <span class="hljs-attr">data-link</span>=<span class="hljs-string">{href}</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"nav-item-container"</span>
            <span class="hljs-attr">onMouseEnter</span>=<span class="hljs-string">{()</span> =&gt;</span> setHoveredLink(href)}
            onMouseLeave={() =&gt; setHoveredLink(null)}
          &gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span>
              <span class="hljs-attr">href</span>=<span class="hljs-string">{href}</span>
              <span class="hljs-attr">prefetch</span>=<span class="hljs-string">{shouldPrefetch(href)}</span>
              <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">nav-link</span> <span class="hljs-attr">importance-</span>${<span class="hljs-attr">importance.toLowerCase</span>()}`}
            &gt;</span>
              {label}
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"prefetch-indicator"</span>&gt;</span>
                {shouldPrefetch(href) ? '✓ 预加载' : '✗ 不预加载'}
              <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        ))}
      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
      
      {/* 预加载状态显示 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"prefetch-status"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>预加载状态<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
          {navigationItems.map(({ href, label }) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{href}</span>&gt;</span>
              {label}: {shouldPrefetch(href) ? '正在预加载' : '等待触发'}
            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-15">5.2 导航缓存策略</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useEffect, useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/link'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationCacheStrategy</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  <span class="hljs-keyword">const</span> [cache, setCache] = <span class="hljs-title function_">useState</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>());
  <span class="hljs-keyword">const</span> [navigationStats, setNavigationStats] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">hits</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">misses</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">size</span>: <span class="hljs-number">0</span>
  });
  
  <span class="hljs-comment">// 缓存页面状态</span>
  <span class="hljs-keyword">const</span> cachePageState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">url, state</span>) =&gt;</span> {
    <span class="hljs-title function_">setCache</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> newCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(prev);
      
      <span class="hljs-comment">// 限制缓存大小</span>
      <span class="hljs-keyword">if</span> (newCache.<span class="hljs-property">size</span> &gt;= <span class="hljs-number">10</span>) {
        <span class="hljs-keyword">const</span> firstKey = newCache.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>;
        newCache.<span class="hljs-title function_">delete</span>(firstKey);
      }
      
      newCache.<span class="hljs-title function_">set</span>(url, {
        ...state,
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">expiry</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + (<span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>) <span class="hljs-comment">// 5分钟过期</span>
      });
      
      <span class="hljs-keyword">return</span> newCache;
    });
  }, []);
  
  <span class="hljs-comment">// 获取缓存的页面状态</span>
  <span class="hljs-keyword">const</span> getCachedPageState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">url</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> cached = cache.<span class="hljs-title function_">get</span>(url);
    
    <span class="hljs-keyword">if</span> (cached &amp;&amp; cached.<span class="hljs-property">expiry</span> &gt; <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()) {
      <span class="hljs-title function_">setNavigationStats</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
        ...prev,
        <span class="hljs-attr">hits</span>: prev.<span class="hljs-property">hits</span> + <span class="hljs-number">1</span>
      }));
      <span class="hljs-keyword">return</span> cached;
    }
    
    <span class="hljs-title function_">setNavigationStats</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
      ...prev,
      <span class="hljs-attr">misses</span>: prev.<span class="hljs-property">misses</span> + <span class="hljs-number">1</span>
    }));
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }, [cache]);
  
  <span class="hljs-comment">// 监听路由变化</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRouteChangeStart</span> = (<span class="hljs-params">url</span>) =&gt; {
      <span class="hljs-comment">// 保存当前页面状态</span>
      <span class="hljs-keyword">const</span> currentState = {
        <span class="hljs-attr">scrollY</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>,
        <span class="hljs-attr">formData</span>: <span class="hljs-title function_">collectFormData</span>(),
        <span class="hljs-attr">componentState</span>: <span class="hljs-title function_">collectComponentState</span>()
      };
      
      <span class="hljs-title function_">cachePageState</span>(router.<span class="hljs-property">asPath</span>, currentState);
    };
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRouteChangeComplete</span> = (<span class="hljs-params">url</span>) =&gt; {
      <span class="hljs-comment">// 尝试恢复缓存的状态</span>
      <span class="hljs-keyword">const</span> cachedState = <span class="hljs-title function_">getCachedPageState</span>(url);
      
      <span class="hljs-keyword">if</span> (cachedState) {
        <span class="hljs-comment">// 恢复滚动位置</span>
        <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>(<span class="hljs-number">0</span>, cachedState.<span class="hljs-property">scrollY</span>);
        });
        
        <span class="hljs-comment">// 恢复表单数据</span>
        <span class="hljs-title function_">restoreFormData</span>(cachedState.<span class="hljs-property">formData</span>);
        
        <span class="hljs-comment">// 恢复组件状态</span>
        <span class="hljs-title function_">restoreComponentState</span>(cachedState.<span class="hljs-property">componentState</span>);
        
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'从缓存恢复页面状态'</span>);
      }
    };
    
    router.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'routeChangeStart'</span>, handleRouteChangeStart);
    router.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'routeChangeComplete'</span>, handleRouteChangeComplete);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      router.<span class="hljs-property">events</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'routeChangeStart'</span>, handleRouteChangeStart);
      router.<span class="hljs-property">events</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'routeChangeComplete'</span>, handleRouteChangeComplete);
    };
  }, [router, cachePageState, getCachedPageState]);
  
  <span class="hljs-comment">// 收集表单数据（示例）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">collectFormData</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 实际实现中收集所有表单数据</span>
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">search</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input[type="search"]'</span>)?.<span class="hljs-property">value</span> || <span class="hljs-string">''</span>,
      <span class="hljs-attr">filters</span>: {}
    };
  };
  
  <span class="hljs-comment">// 收集组件状态（示例）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">collectComponentState</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">activeTab</span>: <span class="hljs-string">'description'</span>,
      <span class="hljs-attr">expandedItems</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>],
      <span class="hljs-attr">sortOrder</span>: <span class="hljs-string">'asc'</span>
    };
  };
  
  <span class="hljs-comment">// 恢复表单数据（示例）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">restoreFormData</span> = (<span class="hljs-params">formData</span>) =&gt; {
    <span class="hljs-comment">// 实际实现中恢复表单数据</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'恢复表单数据:'</span>, formData);
  };
  
  <span class="hljs-comment">// 恢复组件状态（示例）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">restoreComponentState</span> = (<span class="hljs-params">componentState</span>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'恢复组件状态:'</span>, componentState);
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"cache-strategy"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>导航缓存策略<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"cache-stats"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>缓存统计<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stats-grid"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stat-item"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stat-label"</span>&gt;</span>缓存命中<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stat-value"</span>&gt;</span>{navigationStats.hits}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stat-item"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stat-label"</span>&gt;</span>缓存未命中<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stat-value"</span>&gt;</span>{navigationStats.misses}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stat-item"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stat-label"</span>&gt;</span>命中率<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stat-value"</span>&gt;</span>
              {navigationStats.hits + navigationStats.misses &gt; 0
                ? `${((navigationStats.hits / (navigationStats.hits + navigationStats.misses)) * 100).toFixed(1)}%`
                : '0%'
              }
            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stat-item"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stat-label"</span>&gt;</span>缓存大小<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"stat-value"</span>&gt;</span>{cache.size} 页<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"cached-pages"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>已缓存的页面<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
          {Array.from(cache.entries()).map(([url, data]) =&gt; (
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{url}</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{url}</span>&gt;</span>
                {url} 
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"cache-age"</span>&gt;</span>
                  ({Math.round((Date.now() - data.timestamp) / 1000)}秒前)
                <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {/* 测试链接 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"test-links"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>测试缓存效果<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"link-group"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/page1"</span>&gt;</span>页面1<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/page2"</span>&gt;</span>页面2<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/page3"</span>&gt;</span>页面3<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/page4"</span>&gt;</span>页面4<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-16">六、导航动画与过渡效果</h3>
<h4 data-id="heading-17">6.1 页面过渡动画</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/link'</span>;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/router'</span>;
<span class="hljs-keyword">import</span> { motion, <span class="hljs-title class_">AnimatePresence</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'framer-motion'</span>;
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AnimatedNavigation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  <span class="hljs-keyword">const</span> [isAnimating, setIsAnimating] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 自定义导航处理</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleAnimatedNavigation</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">href</span>) =&gt; {
    <span class="hljs-title function_">setIsAnimating</span>(<span class="hljs-literal">true</span>);
    
    <span class="hljs-comment">// 等待动画完成</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">300</span>));
    
    <span class="hljs-comment">// 执行导航</span>
    <span class="hljs-keyword">await</span> router.<span class="hljs-title function_">push</span>(href);
    
    <span class="hljs-title function_">setIsAnimating</span>(<span class="hljs-literal">false</span>);
  };
  
  <span class="hljs-comment">// 页面过渡动画配置</span>
  <span class="hljs-keyword">const</span> pageVariants = {
    <span class="hljs-attr">initial</span>: {
      <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">x</span>: -<span class="hljs-number">100</span>,
      <span class="hljs-attr">scale</span>: <span class="hljs-number">0.95</span>
    },
    <span class="hljs-attr">enter</span>: {
      <span class="hljs-attr">opacity</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">scale</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">transition</span>: {
        <span class="hljs-attr">duration</span>: <span class="hljs-number">0.5</span>,
        <span class="hljs-attr">ease</span>: [<span class="hljs-number">0.43</span>, <span class="hljs-number">0.13</span>, <span class="hljs-number">0.23</span>, <span class="hljs-number">0.96</span>]
      }
    },
    <span class="hljs-attr">exit</span>: {
      <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>,
      <span class="hljs-attr">scale</span>: <span class="hljs-number">0.95</span>,
      <span class="hljs-attr">transition</span>: {
        <span class="hljs-attr">duration</span>: <span class="hljs-number">0.3</span>,
        <span class="hljs-attr">ease</span>: [<span class="hljs-number">0.43</span>, <span class="hljs-number">0.13</span>, <span class="hljs-number">0.23</span>, <span class="hljs-number">0.96</span>]
      }
    }
  };
  
  <span class="hljs-comment">// 链接悬停动画</span>
  <span class="hljs-keyword">const</span> linkVariants = {
    <span class="hljs-attr">rest</span>: { 
      <span class="hljs-attr">scale</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">color</span>: <span class="hljs-string">"#666"</span>
    },
    <span class="hljs-attr">hover</span>: { 
      <span class="hljs-attr">scale</span>: <span class="hljs-number">1.05</span>,
      <span class="hljs-attr">color</span>: <span class="hljs-string">"#0070f3"</span>,
      <span class="hljs-attr">transition</span>: {
        <span class="hljs-attr">duration</span>: <span class="hljs-number">0.2</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"spring"</span>,
        <span class="hljs-attr">stiffness</span>: <span class="hljs-number">400</span>,
        <span class="hljs-attr">damping</span>: <span class="hljs-number">17</span>
      }
    },
    <span class="hljs-attr">tap</span>: { 
      <span class="hljs-attr">scale</span>: <span class="hljs-number">0.95</span> 
    }
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"animated-navigation"</span>&gt;</span>
      {/* 加载动画遮罩 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">AnimatePresence</span>&gt;</span>
        {isAnimating &amp;&amp; (
          <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"navigation-overlay"</span>
            <span class="hljs-attr">initial</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">0</span> }}
            <span class="hljs-attr">animate</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">1</span> }}
            <span class="hljs-attr">exit</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">0</span> }}
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
              <span class="hljs-attr">className</span>=<span class="hljs-string">"loading-spinner"</span>
              <span class="hljs-attr">animate</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">rotate:</span> <span class="hljs-attr">360</span> }}
              <span class="hljs-attr">transition</span>=<span class="hljs-string">{{</span>
                <span class="hljs-attr">duration:</span> <span class="hljs-attr">1</span>,
                <span class="hljs-attr">repeat:</span> <span class="hljs-attr">Infinity</span>,
                <span class="hljs-attr">ease:</span> "<span class="hljs-attr">linear</span>"
              }}
            /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span>
        )}
      <span class="hljs-tag">&lt;/<span class="hljs-name">AnimatePresence</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"animated-nav"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">motion.ul</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"nav-list"</span>
          <span class="hljs-attr">initial</span>=<span class="hljs-string">"hidden"</span>
          <span class="hljs-attr">animate</span>=<span class="hljs-string">"visible"</span>
          <span class="hljs-attr">variants</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">hidden:</span> { <span class="hljs-attr">opacity:</span> <span class="hljs-attr">0</span> },
            <span class="hljs-attr">visible:</span> {
              <span class="hljs-attr">opacity:</span> <span class="hljs-attr">1</span>,
              <span class="hljs-attr">transition:</span> {
                <span class="hljs-attr">staggerChildren:</span> <span class="hljs-attr">0.1</span>
              }
            }
          }}
        &gt;</span>
          {['首页', '产品', '关于', '博客', '联系'].map((item, index) =&gt; {
            const href = item === '首页' ? '/' : `/${item}`;
            
            return (
              <span class="hljs-tag">&lt;<span class="hljs-name">motion.li</span>
                <span class="hljs-attr">key</span>=<span class="hljs-string">{item}</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">"nav-item"</span>
                <span class="hljs-attr">variants</span>=<span class="hljs-string">{{</span>
                  <span class="hljs-attr">hidden:</span> { <span class="hljs-attr">y:</span> <span class="hljs-attr">-20</span>, <span class="hljs-attr">opacity:</span> <span class="hljs-attr">0</span> },
                  <span class="hljs-attr">visible:</span> {
                    <span class="hljs-attr">y:</span> <span class="hljs-attr">0</span>,
                    <span class="hljs-attr">opacity:</span> <span class="hljs-attr">1</span>,
                    <span class="hljs-attr">transition:</span> {
                      <span class="hljs-attr">type:</span> "<span class="hljs-attr">spring</span>",
                      <span class="hljs-attr">stiffness:</span> <span class="hljs-attr">100</span>
                    }
                  }
                }}
                <span class="hljs-attr">whileHover</span>=<span class="hljs-string">"hover"</span>
                <span class="hljs-attr">whileTap</span>=<span class="hljs-string">"tap"</span>
              &gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
                  <span class="hljs-attr">variants</span>=<span class="hljs-string">{linkVariants}</span>
                  <span class="hljs-attr">className</span>=<span class="hljs-string">"nav-link-wrapper"</span>
                &gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> 
                    <span class="hljs-attr">href</span>=<span class="hljs-string">{href}</span>
                    <span class="hljs-attr">onClick</span>=<span class="hljs-string">{(e)</span> =&gt;</span> {
                      e.preventDefault();
                      handleAnimatedNavigation(href);
                    }}
                    className={`nav-link ${router.pathname === href ? 'active' : ''}`}
                  &gt;
                    {item}
                    
                    {/* 活动指示器 */}
                    {router.pathname === href &amp;&amp; (
                      <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
                        <span class="hljs-attr">className</span>=<span class="hljs-string">"active-indicator"</span>
                        <span class="hljs-attr">layoutId</span>=<span class="hljs-string">"activeIndicator"</span>
                        <span class="hljs-attr">initial</span>=<span class="hljs-string">{false}</span>
                        <span class="hljs-attr">transition</span>=<span class="hljs-string">{{</span>
                          <span class="hljs-attr">type:</span> "<span class="hljs-attr">spring</span>",
                          <span class="hljs-attr">stiffness:</span> <span class="hljs-attr">380</span>,
                          <span class="hljs-attr">damping:</span> <span class="hljs-attr">30</span>
                        }}
                      /&gt;</span>
                    )}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">motion.li</span>&gt;</span>
            );
          })}
        <span class="hljs-tag">&lt;/<span class="hljs-name">motion.ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
      
      {/* 页面内容区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">AnimatePresence</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">"wait"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{router.pathname}</span>
          <span class="hljs-attr">initial</span>=<span class="hljs-string">"initial"</span>
          <span class="hljs-attr">animate</span>=<span class="hljs-string">"enter"</span>
          <span class="hljs-attr">exit</span>=<span class="hljs-string">"exit"</span>
          <span class="hljs-attr">variants</span>=<span class="hljs-string">{pageVariants}</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">"page-content"</span>
        &gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>当前页面: {router.pathname === '/' ? '首页' : router.pathname.slice(1)}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
          
          {/* 面包屑导航 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span> 
            <span class="hljs-attr">className</span>=<span class="hljs-string">"breadcrumb"</span>
            <span class="hljs-attr">initial</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">0</span>, <span class="hljs-attr">y:</span> <span class="hljs-attr">10</span> }}
            <span class="hljs-attr">animate</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">1</span>, <span class="hljs-attr">y:</span> <span class="hljs-attr">0</span> }}
            <span class="hljs-attr">transition</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">delay:</span> <span class="hljs-attr">0.1</span> }}
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
            {router.pathname !== '/' &amp;&amp; (
              <span class="hljs-tag">&lt;&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span> / <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{router.pathname.slice(1)}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/&gt;</span>
            )}
          <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span>
          
          {/* 页面内容 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span> 
            <span class="hljs-attr">className</span>=<span class="hljs-string">"content"</span>
            <span class="hljs-attr">initial</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">0</span> }}
            <span class="hljs-attr">animate</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">1</span> }}
            <span class="hljs-attr">transition</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">delay:</span> <span class="hljs-attr">0.2</span> }}
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是 {router.pathname === '/' ? '首页' : router.pathname.slice(1)} 的内容。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            
            {/* 示例卡片 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"card-grid"</span>&gt;</span>
              {[1, 2, 3, 4].map((card) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">motion.div</span>
                  <span class="hljs-attr">key</span>=<span class="hljs-string">{card}</span>
                  <span class="hljs-attr">className</span>=<span class="hljs-string">"card"</span>
                  <span class="hljs-attr">initial</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">0</span>, <span class="hljs-attr">scale:</span> <span class="hljs-attr">0.8</span> }}
                  <span class="hljs-attr">animate</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">1</span>, <span class="hljs-attr">scale:</span> <span class="hljs-attr">1</span> }}
                  <span class="hljs-attr">transition</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">delay:</span> <span class="hljs-attr">0.1</span> * <span class="hljs-attr">card</span> }}
                  <span class="hljs-attr">whileHover</span>=<span class="hljs-string">{{</span> 
                    <span class="hljs-attr">scale:</span> <span class="hljs-attr">1.05</span>,
                    <span class="hljs-attr">boxShadow:</span> "<span class="hljs-attr">0</span> <span class="hljs-attr">10px</span> <span class="hljs-attr">30px</span> <span class="hljs-attr">rgba</span>(<span class="hljs-attr">0</span>, <span class="hljs-attr">0</span>, <span class="hljs-attr">0</span>, <span class="hljs-attr">0.1</span>)"
                  }}
                &gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>卡片 {card}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是卡片内容 {card}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span>
              ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">motion.div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">AnimatePresence</span>&gt;</span></span>
    &lt;/div&gt;
  );
}
</code></pre>
<h3 data-id="heading-18">七、移动端导航优化</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/link'</span>;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/router'</span>;
<span class="hljs-keyword">import</span> { 
  <span class="hljs-title class_">Home</span>, 
  <span class="hljs-title class_">ShoppingBag</span>, 
  <span class="hljs-title class_">Info</span>, 
  <span class="hljs-title class_">Book</span>, 
  <span class="hljs-title class_">Phone</span>,
  <span class="hljs-title class_">Menu</span>,
  X,
  <span class="hljs-title class_">ChevronLeft</span>,
  <span class="hljs-title class_">ChevronRight</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'lucide-react'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MobileOptimizedNavigation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [isMobileMenuOpen, setIsMobileMenuOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [touchStart, setTouchStart] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [touchEnd, setTouchEnd] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [showBottomNav, setShowBottomNav] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">const</span> [lastScrollY, setLastScrollY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  
  <span class="hljs-comment">// 移动端检测</span>
  <span class="hljs-keyword">const</span> [isMobile, setIsMobile] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkMobile</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">setIsMobile</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span> &lt;= <span class="hljs-number">768</span>);
    };
    
    <span class="hljs-title function_">checkMobile</span>();
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, checkMobile);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, checkMobile);
  }, []);
  
  <span class="hljs-comment">// 滑动检测</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTouchStart</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-title function_">setTouchStart</span>(e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientX</span>);
    };
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTouchMove</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-title function_">setTouchEnd</span>(e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">clientX</span>);
    };
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTouchEnd</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">if</span> (!touchStart || !touchEnd) <span class="hljs-keyword">return</span>;
      
      <span class="hljs-keyword">const</span> distance = touchStart - touchEnd;
      <span class="hljs-keyword">const</span> isLeftSwipe = distance &gt; <span class="hljs-number">50</span>;
      <span class="hljs-keyword">const</span> isRightSwipe = distance &lt; -<span class="hljs-number">50</span>;
      
      <span class="hljs-keyword">if</span> (isLeftSwipe) {
        <span class="hljs-comment">// 左滑 - 前进（如果历史记录存在）</span>
        router.<span class="hljs-title function_">forward</span>();
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isRightSwipe) {
        <span class="hljs-comment">// 右滑 - 后退</span>
        router.<span class="hljs-title function_">back</span>();
      }
      
      <span class="hljs-title function_">setTouchStart</span>(<span class="hljs-literal">null</span>);
      <span class="hljs-title function_">setTouchEnd</span>(<span class="hljs-literal">null</span>);
    };
    
    <span class="hljs-comment">// 监听滚动隐藏/显示底部导航</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleScroll</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> currentScrollY = <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>;
      
      <span class="hljs-keyword">if</span> (currentScrollY &gt; lastScrollY &amp;&amp; currentScrollY &gt; <span class="hljs-number">100</span>) {
        <span class="hljs-comment">// 向下滚动，隐藏底部导航</span>
        <span class="hljs-title function_">setShowBottomNav</span>(<span class="hljs-literal">false</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentScrollY &lt; lastScrollY || currentScrollY &lt;= <span class="hljs-number">100</span>) {
        <span class="hljs-comment">// 向上滚动或接近顶部，显示底部导航</span>
        <span class="hljs-title function_">setShowBottomNav</span>(<span class="hljs-literal">true</span>);
      }
      
      <span class="hljs-title function_">setLastScrollY</span>(currentScrollY);
    };
    
    <span class="hljs-keyword">if</span> (isMobile) {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchstart'</span>, handleTouchStart);
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchmove'</span>, handleTouchMove);
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'touchend'</span>, handleTouchEnd);
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll, { <span class="hljs-attr">passive</span>: <span class="hljs-literal">true</span> });
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (isMobile) {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'touchstart'</span>, handleTouchStart);
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'touchmove'</span>, handleTouchMove);
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'touchend'</span>, handleTouchEnd);
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, handleScroll);
      }
    };
  }, [isMobile, touchStart, touchEnd, lastScrollY, router]);
  
  <span class="hljs-comment">// 导航项配置</span>
  <span class="hljs-keyword">const</span> navItems = [
    { <span class="hljs-attr">href</span>: <span class="hljs-string">'/'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'首页'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-title class_">Home</span>, <span class="hljs-attr">mobileOnly</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">href</span>: <span class="hljs-string">'/products'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'产品'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-title class_">ShoppingBag</span>, <span class="hljs-attr">mobileOnly</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">href</span>: <span class="hljs-string">'/about'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'关于'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-title class_">Info</span>, <span class="hljs-attr">mobileOnly</span>: <span class="hljs-literal">false</span> },
    { <span class="hljs-attr">href</span>: <span class="hljs-string">'/blog'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'博客'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-title class_">Book</span>, <span class="hljs-attr">mobileOnly</span>: <span class="hljs-literal">true</span> },
    { <span class="hljs-attr">href</span>: <span class="hljs-string">'/contact'</span>, <span class="hljs-attr">label</span>: <span class="hljs-string">'联系'</span>, <span class="hljs-attr">icon</span>: <span class="hljs-title class_">Phone</span>, <span class="hljs-attr">mobileOnly</span>: <span class="hljs-literal">true</span> },
  ];
  
  <span class="hljs-comment">// 获取当前页面的图标</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getCurrentPageIcon</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> currentItem = navItems.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> 
      item.<span class="hljs-property">href</span> === router.<span class="hljs-property">pathname</span> || 
      (item.<span class="hljs-property">href</span> === <span class="hljs-string">'/'</span> &amp;&amp; router.<span class="hljs-property">pathname</span> === <span class="hljs-string">'/'</span>)
    );
    <span class="hljs-keyword">return</span> currentItem ? currentItem.<span class="hljs-property">icon</span> : <span class="hljs-title class_">Home</span>;
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">CurrentIcon</span> = <span class="hljs-title function_">getCurrentPageIcon</span>();
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mobile-optimized-nav"</span>&gt;</span>
      {/* 顶部导航栏（移动端） */}
      {isMobile &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mobile-header"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
            <span class="hljs-attr">className</span>=<span class="hljs-string">"menu-toggle"</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsMobileMenuOpen(!isMobileMenuOpen)}
            aria-label="菜单"
          &gt;
            {isMobileMenuOpen ? <span class="hljs-tag">&lt;<span class="hljs-name">X</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{24}</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">Menu</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{24}</span> /&gt;</span>}
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mobile-header-title"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">CurrentIcon</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{20}</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"page-title"</span>&gt;</span>
              {navItems.find(item =&gt; 
                item.href === router.pathname || 
                (item.href === '/' &amp;&amp; router.pathname === '/')
              )?.label || '页面'}
            <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          
          {/* 滑动指示器 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"swipe-indicator"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ChevronLeft</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{16}</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>滑动返回<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ChevronRight</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{16}</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
      )}
      
      {/* 移动端侧滑菜单 */}
      {isMobile &amp;&amp; isMobileMenuOpen &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mobile-menu-overlay"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mobile-menu"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mobile-menu-header"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>导航菜单<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsMobileMenuOpen(false)}
                className="close-menu"
              &gt;
                <span class="hljs-tag">&lt;<span class="hljs-name">X</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{24}</span> /&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mobile-menu-nav"</span>&gt;</span>
              {navItems.map(({ href, label, icon: Icon }) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Link</span>
                  <span class="hljs-attr">key</span>=<span class="hljs-string">{href}</span>
                  <span class="hljs-attr">href</span>=<span class="hljs-string">{href}</span>
                  <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setIsMobileMenuOpen(false)}
                  className={`mobile-menu-item ${router.pathname === href ? 'active' : ''}`}
                &gt;
                  <span class="hljs-tag">&lt;<span class="hljs-name">Icon</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{20}</span> /&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{label}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                  {router.pathname === href &amp;&amp; (
                    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"active-dot"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                  )}
                <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
              ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mobile-menu-footer"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-info"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-avatar"</span>&gt;</span>U<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-details"</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-name"</span>&gt;</span>访客用户<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-status"</span>&gt;</span>未登录<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"quick-actions"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"quick-action"</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>设置<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"quick-action"</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>帮助<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
      
      {/* 桌面端导航 */}
      {!isMobile &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"desktop-nav"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"desktop-nav-inner"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"nav-logo"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>我的网站<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"desktop-nav-items"</span>&gt;</span>
              {navItems
                .filter(item =&gt; !item.mobileOnly)
                .map(({ href, label }) =&gt; (
                  <span class="hljs-tag">&lt;<span class="hljs-name">Link</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{href}</span>
                    <span class="hljs-attr">href</span>=<span class="hljs-string">{href}</span>
                    <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">desktop-nav-item</span> ${<span class="hljs-attr">router.pathname</span> === <span class="hljs-string">href</span> ? '<span class="hljs-attr">active</span>' <span class="hljs-attr">:</span> ''}`}
                  &gt;</span>
                    {label}
                  <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
                ))}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"desktop-nav-actions"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"nav-action-button"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"nav-action-button primary"</span>&gt;</span>注册<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
      )}
      
      {/* 移动端底部导航 */}
      {isMobile &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">mobile-bottom-nav</span> ${<span class="hljs-attr">showBottomNav</span> ? '<span class="hljs-attr">visible</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">hidden</span>'}`}&gt;</span>
          {navItems
            .filter(item =&gt; !item.mobileOnly)
            .map(({ href, label, icon: Icon }) =&gt; (
              <span class="hljs-tag">&lt;<span class="hljs-name">Link</span>
                <span class="hljs-attr">key</span>=<span class="hljs-string">{href}</span>
                <span class="hljs-attr">href</span>=<span class="hljs-string">{href}</span>
                <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">bottom-nav-item</span> ${<span class="hljs-attr">router.pathname</span> === <span class="hljs-string">href</span> ? '<span class="hljs-attr">active</span>' <span class="hljs-attr">:</span> ''}`}
              &gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Icon</span> <span class="hljs-attr">size</span>=<span class="hljs-string">{22}</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bottom-nav-label"</span>&gt;</span>{label}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
      
      {/* 主内容区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">main-content</span> ${<span class="hljs-attr">isMobile</span> ? '<span class="hljs-attr">mobile</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">desktop</span>'}`}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"content-wrapper"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>响应式导航演示<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前设备: {isMobile ? '移动端' : '桌面端'}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
          
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"demo-section"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>导航特性演示<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"feature-grid"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"feature-card"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>滑动导航<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>在移动端尝试左右滑动来前进/后退<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"feature-card"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>智能隐藏<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>向下滚动时自动隐藏底部导航<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"feature-card"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>触控优化<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>大触摸目标和触觉反馈<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"feature-card"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>性能优化<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>移动端特有的性能优化策略<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"navigation-test"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>导航测试<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"test-buttons"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.back()}
                className="test-button"
              &gt;
                返回上一页
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
              
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.forward()}
                className="test-button"
              &gt;
                前进
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
              
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
                <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.reload()}
                className="test-button"
              &gt;
                重新加载
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-19">八、导航错误处理与调试</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/link'</span>;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/router'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NavigationDebugger</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
  <span class="hljs-keyword">const</span> [errors, setErrors] = <span class="hljs-title function_">useState</span>([]);
  <span class="hljs-keyword">const</span> [performanceMetrics, setPerformanceMetrics] = <span class="hljs-title function_">useState</span>([]);
  <span class="hljs-keyword">const</span> [debugMode, setDebugMode] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 导航错误处理</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRouteError</span> = (<span class="hljs-params">err, url</span>) =&gt; {
      <span class="hljs-keyword">const</span> error = {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'ROUTE_ERROR'</span>,
        url,
        <span class="hljs-attr">error</span>: err.<span class="hljs-title function_">toString</span>(),
        <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
        <span class="hljs-attr">userAgent</span>: navigator.<span class="hljs-property">userAgent</span>
      };
      
      <span class="hljs-title function_">setErrors</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [error, ...prev.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">9</span>)]); <span class="hljs-comment">// 保留最近10个错误</span>
      
      <span class="hljs-comment">// 发送错误到监控服务</span>
      <span class="hljs-title function_">logErrorToService</span>(error);
      
      <span class="hljs-comment">// 用户友好的错误处理</span>
      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">cancelled</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'导航被取消'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'导航错误:'</span>, err);
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">`无法加载页面: <span class="hljs-subst">${url}</span>\n错误: <span class="hljs-subst">${err.message}</span>`</span>);
      }
    };
    
    <span class="hljs-comment">// 性能监控</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRouteChangeStart</span> = (<span class="hljs-params">url</span>) =&gt; {
      <span class="hljs-keyword">const</span> startTime = performance.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">const</span> startMemory = performance.<span class="hljs-property">memory</span>?.<span class="hljs-property">usedJSHeapSize</span>;
      
      <span class="hljs-keyword">const</span> metric = {
        url,
        startTime,
        startMemory,
        <span class="hljs-attr">status</span>: <span class="hljs-string">'loading'</span>
      };
      
      <span class="hljs-title function_">setPerformanceMetrics</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> updated = [metric, ...prev.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">9</span>)];
        <span class="hljs-keyword">return</span> updated;
      });
    };
    
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRouteChangeComplete</span> = (<span class="hljs-params">url</span>) =&gt; {
      <span class="hljs-keyword">const</span> endTime = performance.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">const</span> endMemory = performance.<span class="hljs-property">memory</span>?.<span class="hljs-property">usedJSHeapSize</span>;
      
      <span class="hljs-title function_">setPerformanceMetrics</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> {
        <span class="hljs-keyword">if</span> (prev.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> prev;
        
        <span class="hljs-keyword">const</span> lastMetric = prev[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">const</span> duration = endTime - lastMetric.<span class="hljs-property">startTime</span>;
        <span class="hljs-keyword">const</span> memoryDiff = endMemory &amp;&amp; lastMetric.<span class="hljs-property">startMemory</span> 
          ? endMemory - lastMetric.<span class="hljs-property">startMemory</span> 
          : <span class="hljs-literal">null</span>;
        
        <span class="hljs-keyword">return</span> [{
          ...lastMetric,
          endTime,
          endMemory,
          duration,
          memoryDiff,
          <span class="hljs-attr">status</span>: <span class="hljs-string">'complete'</span>
        }, ...prev.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>)];
      });
    };
    
    <span class="hljs-comment">// 订阅事件</span>
    router.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'routeChangeError'</span>, handleRouteError);
    router.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'routeChangeStart'</span>, handleRouteChangeStart);
    router.<span class="hljs-property">events</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'routeChangeComplete'</span>, handleRouteChangeComplete);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      router.<span class="hljs-property">events</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'routeChangeError'</span>, handleRouteError);
      router.<span class="hljs-property">events</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'routeChangeStart'</span>, handleRouteChangeStart);
      router.<span class="hljs-property">events</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'routeChangeComplete'</span>, handleRouteChangeComplete);
    };
  }, [router]);
  
  <span class="hljs-comment">// 模拟错误发送到监控服务</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logErrorToService</span> = (<span class="hljs-params">error</span>) =&gt; {
    <span class="hljs-comment">// 实际项目中会发送到Sentry、LogRocket等服务</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'发送错误到监控服务:'</span>, error);
  };
  
  <span class="hljs-comment">// 测试错误导航</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">testErrorNavigation</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 故意导航到不存在的页面</span>
    router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/non-existent-page-12345'</span>);
  };
  
  <span class="hljs-comment">// 测试慢速导航</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">testSlowNavigation</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 模拟慢速加载</span>
    router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/slow-page'</span>);
  };
  
  <span class="hljs-comment">// 清理错误日志</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">clearErrors</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setErrors</span>([]);
  };
  
  <span class="hljs-comment">// 获取性能评分</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getPerformanceScore</span> = (<span class="hljs-params">duration</span>) =&gt; {
    <span class="hljs-keyword">if</span> (duration &lt; <span class="hljs-number">100</span>) <span class="hljs-keyword">return</span> { <span class="hljs-attr">score</span>: <span class="hljs-string">'优秀'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'green'</span> };
    <span class="hljs-keyword">if</span> (duration &lt; <span class="hljs-number">300</span>) <span class="hljs-keyword">return</span> { <span class="hljs-attr">score</span>: <span class="hljs-string">'良好'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'blue'</span> };
    <span class="hljs-keyword">if</span> (duration &lt; <span class="hljs-number">500</span>) <span class="hljs-keyword">return</span> { <span class="hljs-attr">score</span>: <span class="hljs-string">'一般'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'yellow'</span> };
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">score</span>: <span class="hljs-string">'较差'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span> };
  };
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"navigation-debugger"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"debugger-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>导航调试器<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"debug-controls"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setDebugMode(!debugMode)}
            className={`debug-toggle ${debugMode ? 'active' : ''}`}
          &gt;
            {debugMode ? '关闭调试' : '开启调试'}
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{clearErrors}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"clear-button"</span>&gt;</span>
            清理错误
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      
      {debugMode &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"debug-panels"</span>&gt;</span>
          {/* 错误面板 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"debug-panel error-panel"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>导航错误日志<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"error-controls"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{testErrorNavigation}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"test-error-button"</span>&gt;</span>
                测试错误导航
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{testSlowNavigation}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"test-slow-button"</span>&gt;</span>
                测试慢速导航
              <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            {errors.length === 0 ? (
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"no-errors"</span>&gt;</span>暂无错误<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            ) : (
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"error-list"</span>&gt;</span>
                {errors.map((error, index) =&gt; (
                  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"error-item"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"error-header"</span>&gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"error-type"</span>&gt;</span>{error.type}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"error-time"</span>&gt;</span>
                        {new Date(error.timestamp).toLocaleTimeString()}
                      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"error-url"</span>&gt;</span>URL: {error.url}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"error-message"</span>&gt;</span>错误: {error.error}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                ))}
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            )}
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          
          {/* 性能面板 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"debug-panel performance-panel"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>导航性能监控<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            
            {performanceMetrics.length === 0 ? (
              <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"no-metrics"</span>&gt;</span>暂无性能数据<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            ) : (
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"performance-metrics"</span>&gt;</span>
                {performanceMetrics
                  .filter(metric =&gt; metric.status === 'complete')
                  .map((metric, index) =&gt; {
                    const score = getPerformanceScore(metric.duration);
                    
                    return (
                      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"metric-item"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"metric-header"</span>&gt;</span>
                          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"metric-url"</span>&gt;</span>{metric.url}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">metric-score</span> ${<span class="hljs-attr">score.color</span>}`}&gt;</span>
                            {score.score} ({metric.duration.toFixed(1)}ms)
                          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"metric-details"</span>&gt;</span>
                          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"metric-detail"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>持续时间:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{metric.duration.toFixed(1)}ms<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                          {metric.memoryDiff &amp;&amp; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"metric-detail"</span>&gt;</span>
                              <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>内存变化:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                              <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>
                                {(metric.memoryDiff / 1024 / 1024).toFixed(2)} MB
                              <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                          )}
                        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    );
                  })}
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            )}
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"performance-summary"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>性能基准<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>优秀: <span class="hljs-symbol">&amp;lt;</span> 100ms<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>良好: 100-300ms<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>一般: 300-500ms<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>较差: <span class="hljs-symbol">&amp;gt;</span> 500ms<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          
          {/* 路由信息面板 */}
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"debug-panel route-info-panel"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>当前路由信息<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"route-info"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-item"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-label"</span>&gt;</span>路径名:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-value"</span>&gt;</span>{router.pathname}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-item"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-label"</span>&gt;</span>查询参数:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-value"</span>&gt;</span>
                  {JSON.stringify(router.query)}
                <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-item"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-label"</span>&gt;</span>实际路径:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-value"</span>&gt;</span>{router.asPath}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-item"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-label"</span>&gt;</span>语言:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-value"</span>&gt;</span>{router.locale}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-item"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-label"</span>&gt;</span>路由器就绪:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">info-value</span> ${<span class="hljs-attr">router.isReady</span> ? '<span class="hljs-attr">ready</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">not-ready</span>'}`}&gt;</span>
                  {router.isReady ? '是' : '否'}
                <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-item"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"info-label"</span>&gt;</span>Fallback状态:<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">info-value</span> ${<span class="hljs-attr">router.isFallback</span> ? '<span class="hljs-attr">fallback</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">normal</span>'}`}&gt;</span>
                  {router.isFallback ? '是' : '否'}
                <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
      
      {/* 导航测试链接 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"navigation-test-section"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>导航测试<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"test-links"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"test-link"</span>&gt;</span>
            首页
          <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/about"</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"test-link"</span>&gt;</span>
            关于页面
          <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> 
            <span class="hljs-attr">href</span>=<span class="hljs-string">{{</span>
              <span class="hljs-attr">pathname:</span> '/<span class="hljs-attr">user</span>/[<span class="hljs-attr">id</span>]',
              <span class="hljs-attr">query:</span> { <span class="hljs-attr">id:</span> '<span class="hljs-attr">123</span>' }
            }}
            <span class="hljs-attr">className</span>=<span class="hljs-string">"test-link"</span>
          &gt;</span>
            用户页面
          <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> 
            <span class="hljs-attr">href</span>=<span class="hljs-string">"/search?q=test&amp;sort=recent"</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"test-link"</span>
          &gt;</span>
            搜索页面
          <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> router.push('/dynamic/' + Date.now())}
            className="test-link"
          &gt;
            动态页面
          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-20">九、Link 组件最佳实践总结</h3>
<h4 data-id="heading-21">9.1 性能优化实践</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 最佳实践示例</span>
<span class="hljs-keyword">const</span> linkBestPractices = {
  <span class="hljs-number">1</span>: {
    实践: <span class="hljs-string">'智能预加载'</span>,
    代码示例: <span class="hljs-string">`
      // 只在需要时预加载
      &lt;Link 
        href="/dashboard" 
        prefetch={shouldPrefetch('/dashboard')}
      &gt;
        仪表板
      &lt;/Link&gt;
    `</span>,
    说明: <span class="hljs-string">'根据页面重要性和用户行为决定是否预加载'</span>
  },
  
  <span class="hljs-number">2</span>: {
    实践: <span class="hljs-string">'优先使用客户端导航'</span>,
    代码示例: <span class="hljs-string">`
      // 使用Link组件而不是&lt;a&gt;标签
      &lt;Link href="/products"&gt;
        &lt;a&gt;产品&lt;/a&gt;
      &lt;/Link&gt;
    `</span>,
    说明: <span class="hljs-string">'提供更快的页面切换体验'</span>
  },
  
  <span class="hljs-number">3</span>: {
    实践: <span class="hljs-string">'正确处理动态路由'</span>,
    代码示例: <span class="hljs-string">`
      // 使用对象语法
      &lt;Link href={{
        pathname: '/products/[id]',
        query: { id: product.id }
      }}&gt;
        {product.name}
      &lt;/Link&gt;
    `</span>,
    说明: <span class="hljs-string">'避免字符串拼接错误'</span>
  },
  
  <span class="hljs-number">4</span>: {
    实践: <span class="hljs-string">'实现渐进增强'</span>,
    代码示例: <span class="hljs-string">`
      // 为不支持JavaScript的客户端提供回退
      &lt;Link href="/about"&gt;
        &lt;a className="no-js-fallback"&gt;
          关于我们
        &lt;/a&gt;
      &lt;/Link&gt;
    `</span>,
    说明: <span class="hljs-string">'确保所有用户都能正常访问'</span>
  },
  
  <span class="hljs-number">5</span>: {
    实践: <span class="hljs-string">'监控导航性能'</span>,
    代码示例: <span class="hljs-string">`
      // 使用路由事件监听
      router.events.on('routeChangeComplete', (url) =&gt; {
        // 发送性能指标
        trackNavigationPerformance(url);
      });
    `</span>,
    说明: <span class="hljs-string">'持续优化导航体验'</span>
  }
};
</code></pre>
<h4 data-id="heading-22">9.2 常见问题与解决方案</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> commonProblemsAndSolutions = {
  问题<span class="hljs-number">1</span>: <span class="hljs-string">'Link组件不工作'</span>,
  解决方案: [
    <span class="hljs-string">'检查href属性是否正确'</span>,
    <span class="hljs-string">'确保在Next.js项目中使用'</span>,
    <span class="hljs-string">'验证页面文件是否存在'</span>,
    <span class="hljs-string">'检查是否有语法错误'</span>
  ],
  
  问题<span class="hljs-number">2</span>: <span class="hljs-string">'预加载太多页面'</span>,
  解决方案: [
    <span class="hljs-string">'使用prefetch={false}禁用不必要的预加载'</span>,
    <span class="hljs-string">'根据网络状况调整策略'</span>,
    <span class="hljs-string">'只预加载重要页面'</span>,
    <span class="hljs-string">'实现懒加载策略'</span>
  ],
  
  问题<span class="hljs-number">3</span>: <span class="hljs-string">'导航状态管理困难'</span>,
  解决方案: [
    <span class="hljs-string">'使用路由事件监听器'</span>,
    <span class="hljs-string">'实现导航守卫'</span>,
    <span class="hljs-string">'保存和恢复页面状态'</span>,
    <span class="hljs-string">'使用状态管理库'</span>
  ],
  
  问题<span class="hljs-number">4</span>: <span class="hljs-string">'移动端体验不佳'</span>,
  解决方案: [
    <span class="hljs-string">'实现响应式导航'</span>,
    <span class="hljs-string">'添加触控反馈'</span>,
    <span class="hljs-string">'优化加载状态'</span>,
    <span class="hljs-string">'使用骨架屏'</span>
  ],
  
  问题<span class="hljs-number">5</span>: <span class="hljs-string">'SEO问题'</span>,
  解决方案: [
    <span class="hljs-string">'确保重要链接使用&lt;a&gt;标签'</span>,
    <span class="hljs-string">'实现合理的链接结构'</span>,
    <span class="hljs-string">'使用语义化HTML'</span>,
    <span class="hljs-string">'添加结构化数据'</span>
  ]
};
</code></pre>
<h3 data-id="heading-23">十、总结</h3>
<p>Next.js 的导航系统提供了强大而灵活的功能，核心要点包括：</p>
<h4 data-id="heading-24">关键特性：</h4>
<ol>
<li><strong>Link 组件</strong>：实现客户端导航，支持预加载、滚动控制等高级功能</li>
<li><strong>useRouter 钩子</strong>：提供编程式导航和路由信息访问</li>
<li><strong>智能预加载</strong>：自动优化页面加载性能</li>
<li><strong>平滑过渡</strong>：支持页面切换动画</li>
<li><strong>错误处理</strong>：完善的导航错误处理和恢复机制</li>
</ol>
<h4 data-id="heading-25">最佳实践：</h4>
<ol>
<li>根据场景选择合适的导航方式</li>
<li>实现智能预加载策略</li>
<li>优化移动端导航体验</li>
<li>监控导航性能</li>
<li>处理边缘情况和错误</li>
</ol>
<h4 data-id="heading-26">性能优化：</h4>
<ol>
<li>合理使用预加载</li>
<li>实现导航缓存</li>
<li>优化首次加载</li>
<li>减少不必要的重渲染</li>
</ol>
<p>通过深入理解和合理应用 Next.js 的导航功能，可以构建出高性能、用户体验优秀的现代 Web 应用。无论是简单的网站还是复杂的企业级应用，Next.js 都能提供强大的导航解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Yank Note: 一款强大可扩展的本地 Markdown 笔记应用]]></title>    <link>https://juejin.cn/post/7598480267218272290</link>    <guid>https://juejin.cn/post/7598480267218272290</guid>    <pubDate>2026-01-24T13:43:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598480267218272290" data-draft-id="7598480267218255906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Yank Note: 一款强大可扩展的本地 Markdown 笔记应用"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-24T13:43:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Yank Note: 一款强大可扩展的本地 Markdown 笔记应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T13:43:25.000Z" title="Sat Jan 24 2026 13:43:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在信息爆炸的时代，寻找一款称心如意的笔记软件并不容易。既要功能强大，又要保障隐私；既要流畅易用，又希望有足够的扩展性。今天，我要向大家推荐一款可能满足你所有需求的开源神器——<strong>Yank Note</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f3b9199b82149018c8559a2deb4f03a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769867004&amp;x-signature=wTXK0FDpOFoNpFOuh6oIT2hhBb0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">❓什么是 Yank Note？</h2>
<p>Yank Note 是一款<strong>本地化、高性能、高扩展性、双栏式</strong>的开源 Markdown 笔记应用。它采用 AGPL-3.0 协议完全开源，所有数据默认存储在本地，让你完全掌控自己的数字资产。</p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpurocean%2Fyn" target="_blank" title="https://github.com/purocean/yn" ref="nofollow noopener noreferrer">github.com/purocean/yn</a></p>
<p>在线体验地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdemo.yank-note.com%2F" target="_blank" title="https://demo.yank-note.com/" ref="nofollow noopener noreferrer">demo.yank-note.com/</a></p>
<p>文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.yank-note.com%2Fgetting-started.html" target="_blank" title="https://help.yank-note.com/getting-started.html" ref="nofollow noopener noreferrer">help.yank-note.com/getting-sta…</a></p>
<p>软件下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpurocean%2Fyn%2Freleases" target="_blank" title="https://github.com/purocean/yn/releases" ref="nofollow noopener noreferrer">github.com/purocean/yn…</a></p>
<p>该项目目前在github上已有6.5k⭐️ star</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bff1677d69d54014a576b063d0d458f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769867004&amp;x-signature=jCNUeW3UFwKav6GtJzxwOpXWcjA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">✔️为什么选择 Yank Note？</h2>
<h3 data-id="heading-2">1. 🛡️ 安全感满满</h3>
<ul>
<li><strong>开源透明</strong>：代码完全开放，不用担心后门或隐私泄露</li>
<li><strong>本地存储</strong>：数据保存在本地，可自由选择云盘、Git 等同步方案</li>
<li><strong>端到端加密</strong>：支持单个文档加密，保护敏感信息</li>
<li><strong>历史版本</strong>：内置版本控制，随时回溯和恢复</li>
</ul>
<h3 data-id="heading-3">2. 💪 功能强大到令人惊喜</h3>
<p>Yank Note 远不止一个简单的 Markdown 编辑器：</p>
<p><strong>强大的编辑体验</strong></p>
<ul>
<li>基于 Monaco 编辑器（VS Code 同款内核），编辑流畅无卡顿</li>
<li>支持多光标编辑、语法自动补全、AI 智能补全</li>
<li>Markdown 格式化美化，保持代码整洁</li>
</ul>
<p><strong>丰富的文档能力</strong></p>
<ul>
<li>支持表格、脚注、目录、数学公式、代码高亮等扩展语法</li>
<li>内嵌图形绘制：Mermaid、Drawio、Tldraw、Echarts、PlantUML</li>
<li>支持容器块、宏替换、文档交叉链接等高级功能</li>
</ul>
<p><strong>意想不到的实用特性</strong></p>
<ul>
<li><strong>可运行代码块</strong>：直接运行 JavaScript、Python、PHP、Bash 等代码</li>
<li><strong>HTML 小工具</strong>：在文档中嵌入自定义的 Vue 组件</li>
<li><strong>待办列表</strong>：可视化任务进度，一键切换状态</li>
<li><strong>内置终端</strong>：快速切换工作目录执行命令</li>
<li><strong>图床集成</strong>：支持 PicGo 等图床服务</li>
</ul>
<h3 data-id="heading-4">3. 🚀 AI 智能赋能</h3>
<p>Yank Note 在 AI 时代也走在前列：</p>
<ul>
<li><strong>AI Copilot</strong>：支持文本补全、文本生成</li>
<li><strong>多模型支持</strong>：兼容 OpenAI、Ollama、Gemini、Kimi、通义千问等</li>
<li><strong>OpenCode AI Agent</strong>：智能编码辅助，提升开发效率</li>
</ul>
<h3 data-id="heading-5">4. 🔌 无限扩展可能</h3>
<p>通过插件系统，Yank Note 可以变得无所不能：</p>
<ul>
<li>官方提供 20+ 插件，涵盖主题、图形、AI、Git 等</li>
<li>支持自定义插件开发</li>
<li>活跃的社区不断贡献新功能</li>
</ul>
<h2 data-id="heading-6">🎯核心使用场景</h2>
<h3 data-id="heading-7">📚 学习笔记与知识管理</h3>
<p>无论是学习编程、记录读书笔记，还是整理专业知识，Yank Note 的 Markdown 支持和数学公式渲染都能完美胜任。文档交叉链接功能让你可以构建自己的知识图谱。</p>
<h3 data-id="heading-8">✍️ 专业文章写作</h3>
<p>支持目录生成、脚注、多种图形嵌入，让你的技术文章或专业报告更加美观专业。DOCX 导出功能方便与传统文档格式互通。</p>
<h3 data-id="heading-9">🛠️ 个人工具箱</h3>
<p>这是 Yank Note 最独特的地方！你可以：</p>
<ul>
<li>创建可运行的代码片段，测试算法或脚本</li>
<li>嵌入数据可视化图表，实时分析数据</li>
<li>制作 HTML 小工具，解决日常工作痛点</li>
<li>编写宏脚本，自动化重复操作</li>
</ul>
<h3 data-id="heading-10">🔐 密码与机密管理</h3>
<p>通过文档加密功能，安全保存账号密码、API Key 等敏感信息，只有掌握密码的人才能查看。</p>
<h2 data-id="heading-11">🔍 特色功能一览</h2>
<ol>
<li><strong>同步滚动</strong>：编辑区与预览区完美同步</li>
<li><strong>文件加密</strong>：<code>.c.md</code> 后缀文件自动加密保护</li>
<li><strong>粘贴即存图</strong>：直接从剪贴板插入图片</li>
<li><strong>表格编辑</strong>：双击表格单元格直接修改</li>
<li><strong>嵌套列表转脑图</strong>：可视化展示层级关系</li>
<li><strong>自定义属性</strong>：为元素添加任意 HTML 属性</li>
<li><strong>多仓库管理</strong>：分类管理不同项目笔记</li>
</ol>
<h2 data-id="heading-12">✨上手体验</h2>
<p>Yank Note 提供了全平台支持（Windows、macOS、Linux）。如果只是想体验，还可以访问</p>
<p>在线演示地址:<a href="https://link.juejin.cn?target=https%3A%2F%2Fdemo.yank-note.com%2F" target="_blank" title="https://demo.yank-note.com/" ref="nofollow noopener noreferrer">demo.yank-note.com/</a>。</p>
<h3 data-id="heading-13">🚀快速开始</h3>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpurocean%2Fyn%2Freleases" target="_blank" title="https://github.com/purocean/yn/releases" ref="nofollow noopener noreferrer">GitHub 发布页:https://github.com/purocean/yn/releases</a> 下载对应版本</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3f95bb1213d47999eb22e2bb8e62b82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769867004&amp;x-signature=Qe%2BBGzQJoi4SfE1cDjmpSjttzNQ%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>安装并启动应用</li>
<li>开始使用</li>
</ol>
<p><strong>git插件使用</strong></p>
<p>我使用的是git远程同步，以下是我使用的一些操作</p>
<ul>
<li>在git远程仓库创建项目（我使用的是阿里云的码云codeup），然后通过<code>git clone</code> 克隆到本地</li>
<li>在 yank note 中将clone下来的项目设置为仓库</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eb8911ad29b412e84d0b50bf0f66016~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769867004&amp;x-signature=ddwO3zOjl%2FZngkKqmFzJqWPUzlw%3D" alt="" loading="lazy"/></p>
<ul>
<li>安装git插件</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5bbf6fa776949eb951ba0c10621701c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769867004&amp;x-signature=oZo0jaVlpOUNypuqCW%2BdcoyeXfI%3D" alt="" loading="lazy"/></p>
<ul>
<li>设置git 快捷键</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/801cb53ecf044ed8ba5969f21a4ee20f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769867004&amp;x-signature=4kup1j9RYe2OKbujRT4qeAw5Jng%3D" alt="" loading="lazy"/></p>
<ul>
<li>编辑文档，使用快捷键推拉文档</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b29456c7bd0d4c9d9460012b300f38fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769867004&amp;x-signature=s2EqDE1yxXHivQ8XEnR9g6FdNW8%3D" alt="" loading="lazy"/></p>
<p><strong>图床设置</strong> 安装配置picgo即可</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/074b428fa8da420993b2c990728106d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769867004&amp;x-signature=%2FvQ0Lvtb127rYeQ9YXjwyJxfES4%3D" alt="" loading="lazy"/></p>
<p><strong>运行代码</strong></p>
<p>运行 PHP，nodejs，Python，bash 代码，代码块第一行需要包含以 --run-- 字符串，示例见下面截图，当然需要安装相关环境</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c05063e973d4b03981cd43d83699477~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769867004&amp;x-signature=jb2Tw4wy3usjBFJXqbGoKd5RC%2B8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">🔌Yank Note 扩展(插件)列表</h2>















































































































































































































































<table><thead><tr><th>名称</th><th>来源</th><th>需要高级版</th><th>说明</th></tr></thead><tbody><tr><td>AI Copilot</td><td>Yank Note</td><td>✔️</td><td>你的人工智能写作助手</td></tr><tr><td>OpenCode</td><td>Yank Note</td><td>✔️</td><td>唤起 OpenCode - 一款为终端打造的 AI 编程助手</td></tr><tr><td>Mermaid</td><td>Yank Note</td><td/><td>Mermaid 图形集成</td></tr><tr><td>Drawio</td><td>Yank Note</td><td/><td>Drawio 图形集成</td></tr><tr><td>Excalidraw</td><td>Yank Note</td><td>✔️</td><td>Excalidraw 集成</td></tr><tr><td>Graph View</td><td>Yank Note</td><td>✔️</td><td>显示仓库关系图谱</td></tr><tr><td>Reveal.js</td><td>Yank Note</td><td>✔️</td><td>Reveal.js 集成</td></tr><tr><td>Markmap</td><td>Yank Note</td><td>✔️</td><td>使用 Markmap 将您的 Markdown 可视化为思维导图。</td></tr><tr><td>Code Runner</td><td>Yank Note</td><td/><td>执行多种语言的代码：BASH/SH, PHP, Python, Node.js, BAT, Java, C 和更多。</td></tr><tr><td>Vue Repl</td><td>Yank Note</td><td>✔️</td><td>在 Yank Note 中构建并运行 Vue 交互式应用</td></tr><tr><td>Kroki</td><td>Yank Note</td><td>✔️</td><td>Kroki 图像扩展</td></tr><tr><td>tldraw</td><td>Yank Note</td><td>✔️</td><td>tldraw 集成</td></tr><tr><td>挖空</td><td>Yank Note</td><td>✔️</td><td>一个 Yank Note 扩展，允许您创建用于测验和学习的挖空内容。</td></tr><tr><td>GeoGebra</td><td>Yank Note</td><td/><td>GeoGebra 集成</td></tr><tr><td>拼写检查</td><td>Yank Note</td><td/><td>检查编辑器中的拼写</td></tr><tr><td>文本比较器</td><td>Yank Note</td><td>✔️</td><td>将两个文本文件并排比较</td></tr><tr><td>Markdown Prettier</td><td>Yank Note</td><td>✔️</td><td>Markdown 格式化</td></tr><tr><td>ECharts</td><td>Yank Note</td><td/><td>ECharts 图形集成</td></tr><tr><td>PDF Viewer</td><td>Yank Note</td><td>✔️</td><td>PDF 阅读器扩展</td></tr><tr><td>弹出预览</td><td>Yank Note</td><td>✔️</td><td>在新窗口中弹出预览</td></tr><tr><td>Git 推送</td><td>Yank Note</td><td/><td>运行 Git 提交并推送到远程仓库。注意：此插件不适用于 Mac App Store 中下载的 Yank Note。</td></tr><tr><td>Sublime Merge</td><td>Yank Note</td><td/><td>Sublime Merge 和 Yank Note 的集成</td></tr><tr><td>自动编号</td><td>Yank Note</td><td>✔️</td><td>自动为笔记中的列表项编号。</td></tr><tr><td>代码行高亮</td><td>Yank Note</td><td>✔️</td><td>聚焦特定的代码行。</td></tr><tr><td>Luckysheet</td><td>Yank Note</td><td/><td>Luckysheet 表格集成</td></tr><tr><td>Milkdown</td><td>Yank Note</td><td>✔️</td><td>所见即所得的 Markdown 编辑器</td></tr><tr><td>编辑器主题</td><td>Yank Note</td><td>✔️</td><td>更改编辑器的主题</td></tr><tr><td>NES 模拟器</td><td>Yank Note</td><td>✔️</td><td>在 Yank Note 中运行 NES 游戏</td></tr><tr><td>主题｜烟舍</td><td>Yanser</td><td/><td>来自烟舍的主题</td></tr><tr><td>区域翻转｜烟舍</td><td>Yanser</td><td/><td>翻转预览和编辑器｜翻转侧边栏和内容区</td></tr><tr><td>Vim Mode</td><td>zhyipeng</td><td/><td>Vim Mode 扩展</td></tr><tr><td>工具栏</td><td>andrew_asa</td><td/><td>yank工具栏</td></tr><tr><td>文本片段</td><td>zhyipeng</td><td/><td>快速输入文本片段</td></tr><tr><td>Docsify</td><td>zhyipeng</td><td/><td>一键配置 Docsify</td></tr><tr><td>数学扩展</td><td>Mirion</td><td/><td>面向数学用户的 Yank Note 扩展</td></tr><tr><td>自定义背景</td><td>Mirion</td><td/><td>现在你可以把 Yank Note 的背景设为你最喜欢的图片了！</td></tr><tr><td>字数统计</td><td>papudding</td><td/><td>统计汉字、标点等数量的插件</td></tr><tr><td>目录树</td><td>papudding</td><td/><td>聚焦到文件夹和显示目录树的插件</td></tr></tbody></table>
<h2 data-id="heading-15">📝总结</h2>
<p>如果你在寻找一款：</p>
<ul>
<li>✅ 完全开源、隐私安全</li>
<li>✅ 功能强大、扩展性强</li>
<li>✅ 流畅稳定、体验优秀</li>
<li>✅ 支持 AI、面向未来</li>
<li>✅ 本地优先、云同步可选</li>
</ul>
<p>的 Markdown 笔记应用，那么 <strong>Yank Note 绝对是你的不二之选</strong>。</p>
<p>它不仅仅是一个笔记工具，更是一个可以随需求成长的<strong>个人生产力平台</strong>。从简单的笔记记录到复杂的自动化工具，Yank Note 都能陪伴你的数字工作之旅。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从DEM到三维地形：用PLY、OBJ、glTF构建GIS可视化模型]]></title>    <link>https://juejin.cn/post/7598465042968674344</link>    <guid>https://juejin.cn/post/7598465042968674344</guid>    <pubDate>2026-01-24T12:37:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598465042968674344" data-draft-id="7598480267218141218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从DEM到三维地形：用PLY、OBJ、glTF构建GIS可视化模型"/> <meta itemprop="keywords" content="GIS"/> <meta itemprop="datePublished" content="2026-01-24T12:37:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="charlee44"/> <meta itemprop="url" content="https://juejin.cn/user/1117549770846872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从DEM到三维地形：用PLY、OBJ、glTF构建GIS可视化模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117549770846872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    charlee44
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T12:37:40.000Z" title="Sat Jan 24 2026 12:37:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文节选自新书<a href="https://link.juejin.cn?target=https%3A%2F%2Fitem.jd.com%2F14603137.html" target="_blank" title="https://item.jd.com/14603137.html" ref="nofollow noopener noreferrer">《GIS基础原理与技术实践》</a>第7章。很多人以为三维建模只能靠 3ds Max 或 Blender，但在 GIS 中，我们完全可以从 DEM 出发，用代码手动生成带颜色、带纹理、甚至符合现代 glTF 标准的三维地形模型。本文带你一步步实现 PLY 白模、OBJ 纹理贴图、glTF 资产封装，揭开三维 GIS 的底层逻辑。</p>
</blockquote>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/b3e8fba5b4f746daac3c750cb3266486~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769344621&amp;x-orig-sign=%2BJ6GqgmDvzArNfMKi3uFLn5qK7g%3D" alt="GIS基础原理与技术实践" loading="lazy"/></p>
<h2 data-id="heading-0">导言</h2>
<p>在前三章中，笔者详细论述了矢量、栅格和地形相关的知识，这三种数据也是GIS中最为基本的三种地理空间数据。不过，这三种传统的地理空间数据通常被认为是二维的，其处理方法也大多数基于二维平面空间。随着越来越复杂的地理空间信息的需求，GIS也在逐渐向三维方向发展，三维GIS成为了地理信息系统科学中炙手可热的研究方向。将三维模型作为基本的地理空间数据的观点目前可能还未进入学校的经典教材，但已经有这个趋势。在本章中，笔者也总结了一些与GIS相关的三维模型的知识，希望给读者以参考。</p>
<h3 data-id="heading-1">7.1 初识三维模型</h3>
<h4 data-id="heading-2">7.1.1 三维模型的数据载体</h4>
<p>随着计算机图形技术的发展，我们或多或少都会见过或者听说过三维模型。笔者始终记得小时候第一次在电视上看到三维动画《变形金刚：超能勇士》的震撼感受；而现在我们已经可以在手机上玩三维游戏《王者荣耀》，实时操作造型精美的英雄模型了。这些东西的背后都离不开三维模型数据，他们往往是通过像Autodesk 3D Max这样的三维建模软件制作出来的。</p>
<p>如同栅格数据和矢量数据一样，三维模型数据也有形形色色的数据格式。这些不同的数据格式有时来源于不同的三维建模软件；一些机构或者组织出于标准化的目的，也会定义某种通用的三维模型数据格式。这些不同格式的数据文件构成了三维模型的数据载体。常用的三维数据格式如下表7.1所示：</p>









































<table><thead><tr><th>名称</th><th>全称</th><th>特点</th></tr></thead><tbody><tr><td>PLY</td><td>Polygon File Format</td><td>描述最简单</td></tr><tr><td>OBJ</td><td>Wavefront .obj file</td><td>经典通用性高</td></tr><tr><td>3DS</td><td>3D Studio</td><td>广泛应用的经典格式</td></tr><tr><td>MAX</td><td>3D Studio Max</td><td>3DMax专属格式</td></tr><tr><td>glTF</td><td>Graphics Language Transmission Format</td><td>现代自由开放，适合OpenGL管线</td></tr><tr><td>FBX</td><td>Filmbox</td><td>现代而全面的格式，游戏引擎中常用</td></tr></tbody></table>
<p>对这些三维数据格式我们可以做一个大致的认识，因为后面可能会直接用到：</p>
<ol>
<li>PLY是一种最简单的三维数据格式，一般用其存储不带纹理的模型数据，可通过文本和二进制两种形式来描述。</li>
<li>OBJ是非常通用的三维模型数据格式，与PLY相比增加了对材质的描述，包括纹理信息。因此一个典型的OBJ格式的文件除了.obj文件，同时还会附带一个.mtl文件用于描述材质。而在材质文件中就可以指定纹理图片的地址。很长一段时间内由于其对三维模型文件的描述比较全面，通常用于不同三维建模软件的中转。</li>
<li>3DS和MAX属于著名三维建模软件Autodesk 3ds Max的专属的文件数据格式。理论上来说，3DS和MAX都属于商业三维数据格式，但是Autodesk 3ds Max在三维建模上的使用非常广泛，所以这两种数据格式也很常见。不同的是，3DS现在已经基本能够各种三维软件所识别，一些开源工具也能解析识别；Max则是Autodesk 3ds Max所专用，其他三维软件或者开源工具一般都不支持。Max还有一个笔者认为不太好的特点，就是版本迭代太快，低版本的Autodesk 3ds Max无法打开高版本的Max格式数据。</li>
<li>glTF是一种自由开放，无专利限制的，适合传输和加载3D模型和场景的文件格式。相比较前面介绍三维数据格式来说，glTF诞生的时间较晚，可以采用了更为现代的图形技术来封装和组织这个格式。Khronos Group制定和维护了glTF数据格式的标准，同时由于其也是OpenGL接口标准的指定者和维护者，因此glTF特别适合OpenGL系列（OpenGL，OpenGL ES，WebGL）的图形渲染流水线所需要进行的处理。这个特点意味着glTF足够轻量化。目前glTF有1.0和2.0两个版本，其中glTF2.0已经成为了ISO国际标准。</li>
<li>FBX同样也是Autodesk公司开发的一种通用三维数据格式。与glTF一样，FBX也是更为现代的三维数据格式，比如支持显示效果更为真实的PBR材质。FBX广泛应用于游戏开发领域，目前最火的三维游戏引擎Unity和Unreal都支持直接导入这种格式。Autodesk官方为FBX提供了开发包，支持解析和修改该格式数据文件。除此之外，也有一些开源第三方组件使用自己的方式兼容它。</li>
</ol>
<p>综合来说，PLY、OBJ和3DS都属于比较早期的三维模型数据格式，受限于当年的图形技术的认知；而Max、glTF和FBX则设计得更为现代，文件组织结构更为合理，能提供更为强大的可视化效果。例如，现代三维模型数据格式已经不仅仅是像早期三维模型数据格式那样只包含模型数据本身，还会包括材质、动画、灯光甚至相机等，其描述的对象可以是整个三维场景。</p>
<h4 data-id="heading-3">7.1.2 从地形来认识三维模型（PLY格式）</h4>
<p>如果没有三维图形的基础知识，上一小节的论述可能会让有的读者一头雾水。那么我们可以从GIS中的地形开始说起——在第6.3节中我们就已经使用过PLY格式的三维数据，将其表达成不规则三角网地形。但是，如图6.6所示的地形实在过于简陋，有没有办法给这个白模赋予着色信息，使其有更好的可视化效果呢？</p>
<p>一种最简单的可视化优化方案是，可以结合第6.5节中晕渲图的实现，创建一个带颜色信息的地形三维模型数据。如下例7.1所示：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">//例7.1 DEM数据转换PLY三维模型</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gdal_priv.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;array&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">VertexProperty</span> {
  <span class="hljs-type">double</span> x;
  <span class="hljs-type">double</span> y;
  <span class="hljs-type">double</span> z;
  <span class="hljs-type">uint8_t</span> red;
  <span class="hljs-type">uint8_t</span> green;
  <span class="hljs-type">uint8_t</span> blue;
};

<span class="hljs-type">size_t</span> vertexCount;
vector&lt;VertexProperty&gt; vertexData;
<span class="hljs-type">size_t</span> faceCount;
vector&lt;<span class="hljs-type">int</span>&gt; indices;

<span class="hljs-comment">//颜色查找表</span>
<span class="hljs-keyword">using</span> F_RGB = std::array&lt;<span class="hljs-type">double</span>, <span class="hljs-number">3</span>&gt;;
<span class="hljs-function">vector&lt;F_RGB&gt; <span class="hljs-title">tableRGB</span><span class="hljs-params">(<span class="hljs-number">256</span>)</span></span>;

<span class="hljs-comment">//生成渐变色</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Gradient</span><span class="hljs-params">(F_RGB&amp; start, F_RGB&amp; end, vector&lt;F_RGB&gt;&amp; RGBList)</span> </span>{
  F_RGB d;
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3</span>; i++) {
    d[i] = (end[i] - start[i]) / RGBList.<span class="hljs-built_in">size</span>();
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; RGBList.<span class="hljs-built_in">size</span>(); i++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">3</span>; j++) {
      RGBList[i][j] = start[j] + d[j] * i;
    }
  }
}

<span class="hljs-comment">//初始化颜色查找表</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InitColorTable</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-function">F_RGB <span class="hljs-title">blue</span><span class="hljs-params">({<span class="hljs-number">17</span>, <span class="hljs-number">60</span>, <span class="hljs-number">235</span>})</span></span>;   <span class="hljs-comment">//蓝色</span>
  <span class="hljs-function">F_RGB <span class="hljs-title">green</span><span class="hljs-params">({<span class="hljs-number">17</span>, <span class="hljs-number">235</span>, <span class="hljs-number">86</span>})</span></span>;  <span class="hljs-comment">//绿色</span>
  <span class="hljs-function">vector&lt;F_RGB&gt; <span class="hljs-title">RGBList</span><span class="hljs-params">(<span class="hljs-number">60</span>)</span></span>;
  <span class="hljs-built_in">Gradient</span>(blue, green, RGBList);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    tableRGB[i] = RGBList[i];
  }

  <span class="hljs-function">F_RGB <span class="hljs-title">yellow</span><span class="hljs-params">({<span class="hljs-number">235</span>, <span class="hljs-number">173</span>, <span class="hljs-number">17</span>})</span></span>;  <span class="hljs-comment">//黄色</span>
  RGBList.<span class="hljs-built_in">clear</span>();
  RGBList.<span class="hljs-built_in">resize</span>(<span class="hljs-number">60</span>);
  <span class="hljs-built_in">Gradient</span>(green, yellow, RGBList);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    tableRGB[i + <span class="hljs-number">60</span>] = RGBList[i];
  }

  <span class="hljs-function">F_RGB <span class="hljs-title">red</span><span class="hljs-params">({<span class="hljs-number">235</span>, <span class="hljs-number">60</span>, <span class="hljs-number">17</span>})</span></span>;  <span class="hljs-comment">//红色</span>
  RGBList.<span class="hljs-built_in">clear</span>();
  RGBList.<span class="hljs-built_in">resize</span>(<span class="hljs-number">60</span>);
  <span class="hljs-built_in">Gradient</span>(yellow, red, RGBList);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">60</span>; i++) {
    tableRGB[i + <span class="hljs-number">120</span>] = RGBList[i];
  }

  <span class="hljs-function">F_RGB <span class="hljs-title">white</span><span class="hljs-params">({<span class="hljs-number">235</span>, <span class="hljs-number">17</span>, <span class="hljs-number">235</span>})</span></span>;  <span class="hljs-comment">//紫色</span>
  RGBList.<span class="hljs-built_in">clear</span>();
  RGBList.<span class="hljs-built_in">resize</span>(<span class="hljs-number">76</span>);
  <span class="hljs-built_in">Gradient</span>(red, white, RGBList);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">76</span>; i++) {
    tableRGB[i + <span class="hljs-number">180</span>] = RGBList[i];
  }
}

<span class="hljs-comment">//根据高程选颜色</span>
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">GetColorIndex</span><span class="hljs-params">(<span class="hljs-type">double</span> z, <span class="hljs-type">double</span> min_z, <span class="hljs-type">double</span> max_z)</span> </span>{
  <span class="hljs-type">int</span> temp = (<span class="hljs-type">int</span>)<span class="hljs-built_in">floor</span>((z - min_z) * <span class="hljs-number">255</span> / (max_z - min_z) + <span class="hljs-number">0.6</span>);
  <span class="hljs-keyword">return</span> temp;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ReadDem</span><span class="hljs-params">()</span> </span>{
  string workDir = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  string demPath = workDir + <span class="hljs-string">"/../Data/Model/dem.tif"</span>;

  GDALDataset* dem = (GDALDataset*)<span class="hljs-built_in">GDALOpen</span>(demPath.<span class="hljs-built_in">c_str</span>(), GA_ReadOnly);
  <span class="hljs-keyword">if</span> (!dem) {
    cout &lt;&lt; <span class="hljs-string">"Can't Open Image!"</span> &lt;&lt; endl;
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-type">int</span> srcDemWidth = dem-&gt;<span class="hljs-built_in">GetRasterXSize</span>();
  <span class="hljs-type">int</span> srcDemHeight = dem-&gt;<span class="hljs-built_in">GetRasterYSize</span>();

  <span class="hljs-comment">//坐标信息</span>
  <span class="hljs-type">double</span> geoTransform[<span class="hljs-number">6</span>] = {<span class="hljs-number">0</span>};
  dem-&gt;<span class="hljs-built_in">GetGeoTransform</span>(geoTransform);
  <span class="hljs-type">double</span> srcDx = geoTransform[<span class="hljs-number">1</span>];
  <span class="hljs-type">double</span> srcDy = geoTransform[<span class="hljs-number">5</span>];
  <span class="hljs-type">double</span> startX = geoTransform[<span class="hljs-number">0</span>] + <span class="hljs-number">0.5</span> * srcDx;
  <span class="hljs-type">double</span> startY = geoTransform[<span class="hljs-number">3</span>] + <span class="hljs-number">0.5</span> * srcDy;
  <span class="hljs-type">double</span> endX = startX + (srcDemWidth - <span class="hljs-number">1</span>) * srcDx;
  <span class="hljs-type">double</span> endY = startY + (srcDemHeight - <span class="hljs-number">1</span>) * srcDy;

  <span class="hljs-type">size_t</span> demBufNum = (<span class="hljs-type">size_t</span>)srcDemWidth * srcDemHeight;
  <span class="hljs-function">vector&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">srcDemBuf</span><span class="hljs-params">(demBufNum, <span class="hljs-number">0</span>)</span></span>;

  <span class="hljs-type">int</span> depth = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>);
  dem-&gt;<span class="hljs-built_in">GetRasterBand</span>(<span class="hljs-number">1</span>)-&gt;<span class="hljs-built_in">RasterIO</span>(GF_Read, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, srcDemWidth, srcDemHeight,
                                  srcDemBuf.<span class="hljs-built_in">data</span>(), srcDemWidth, srcDemHeight,
                                  GDT_Float32, depth, srcDemWidth * depth);

  <span class="hljs-built_in">GDALClose</span>(dem);

  <span class="hljs-type">double</span> minZ = *(std::<span class="hljs-built_in">min_element</span>(srcDemBuf.<span class="hljs-built_in">begin</span>(), srcDemBuf.<span class="hljs-built_in">end</span>()));
  <span class="hljs-type">double</span> maxZ = *(std::<span class="hljs-built_in">max_element</span>(srcDemBuf.<span class="hljs-built_in">begin</span>(), srcDemBuf.<span class="hljs-built_in">end</span>()));

  vertexCount = (<span class="hljs-type">size_t</span>)srcDemWidth * srcDemHeight;
  vertexData.<span class="hljs-built_in">resize</span>(vertexCount);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yi = <span class="hljs-number">0</span>; yi &lt; srcDemHeight; yi++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xi = <span class="hljs-number">0</span>; xi &lt; srcDemWidth; xi++) {
      <span class="hljs-type">size_t</span> m = (<span class="hljs-type">size_t</span>)srcDemWidth * yi + xi;
      vertexData[m].x = startX + xi * srcDx;
      vertexData[m].y = startY + yi * srcDy;
      vertexData[m].z = srcDemBuf[m];

      <span class="hljs-type">int</span> index = <span class="hljs-built_in">GetColorIndex</span>(srcDemBuf[m], minZ, maxZ);
      vertexData[m].red = (<span class="hljs-type">uint8_t</span>)(tableRGB[index][<span class="hljs-number">0</span>] + <span class="hljs-number">0.5</span>);
      vertexData[m].green = (<span class="hljs-type">uint8_t</span>)(tableRGB[index][<span class="hljs-number">1</span>] + <span class="hljs-number">0.5</span>);
      vertexData[m].blue = (<span class="hljs-type">uint8_t</span>)(tableRGB[index][<span class="hljs-number">2</span>] + <span class="hljs-number">0.5</span>);
    }
  }

  faceCount = (<span class="hljs-type">size_t</span>)(srcDemHeight - <span class="hljs-number">1</span>) * (srcDemWidth - <span class="hljs-number">1</span>) * <span class="hljs-number">2</span>;
  <span class="hljs-comment">// indices.resize(faceCount);</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yi = <span class="hljs-number">0</span>; yi &lt; srcDemHeight - <span class="hljs-number">1</span>; yi++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xi = <span class="hljs-number">0</span>; xi &lt; srcDemWidth - <span class="hljs-number">1</span>; xi++) {
      <span class="hljs-type">size_t</span> m = (<span class="hljs-type">size_t</span>)srcDemWidth * yi + xi;
      indices.<span class="hljs-built_in">push_back</span>(m);
      indices.<span class="hljs-built_in">push_back</span>(m + srcDemWidth);
      indices.<span class="hljs-built_in">push_back</span>(m + srcDemWidth + <span class="hljs-number">1</span>);

      indices.<span class="hljs-built_in">push_back</span>(m + srcDemWidth + <span class="hljs-number">1</span>);
      indices.<span class="hljs-built_in">push_back</span>(m + <span class="hljs-number">1</span>);
      indices.<span class="hljs-built_in">push_back</span>(m);
    }
  }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">WriteDemModel</span><span class="hljs-params">()</span> </span>{
  string workDir = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  string demPath = workDir + <span class="hljs-string">"/../Data/Model/dst.ply"</span>;

  <span class="hljs-function">ofstream <span class="hljs-title">outfile</span><span class="hljs-params">(demPath)</span></span>;
  <span class="hljs-keyword">if</span> (!outfile) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"write file error %s\n"</span>, demPath.<span class="hljs-built_in">c_str</span>());
    <span class="hljs-keyword">return</span>;
  }

  outfile &lt;&lt; <span class="hljs-string">"ply\n"</span>;
  outfile &lt;&lt; <span class="hljs-string">"format ascii 1.0\n"</span>;
  outfile &lt;&lt; <span class="hljs-string">"comment CL generated\n"</span>;
  outfile &lt;&lt; <span class="hljs-string">"element vertex "</span> &lt;&lt; <span class="hljs-built_in">to_string</span>(vertexCount) &lt;&lt; <span class="hljs-string">'\n'</span>;
  outfile &lt;&lt; <span class="hljs-string">"property double x\n"</span>;
  outfile &lt;&lt; <span class="hljs-string">"property double y\n"</span>;
  outfile &lt;&lt; <span class="hljs-string">"property double z\n"</span>;
  outfile &lt;&lt; <span class="hljs-string">"property uchar red\n"</span>;
  outfile &lt;&lt; <span class="hljs-string">"property uchar green\n"</span>;
  outfile &lt;&lt; <span class="hljs-string">"property uchar blue\n"</span>;
  outfile &lt;&lt; <span class="hljs-string">"element face "</span> &lt;&lt; <span class="hljs-built_in">to_string</span>(faceCount) &lt;&lt; <span class="hljs-string">'\n'</span>;
  outfile &lt;&lt; <span class="hljs-string">"property list uchar int vertex_indices\n"</span>;
  outfile &lt;&lt; <span class="hljs-string">"end_header\n"</span>;

  outfile &lt;&lt; fixed;
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> vi = <span class="hljs-number">0</span>; vi &lt; vertexCount; vi++) {
    outfile &lt;&lt; vertexData[vi].x &lt;&lt; <span class="hljs-string">' '</span>;
    outfile &lt;&lt; vertexData[vi].y &lt;&lt; <span class="hljs-string">' '</span>;
    outfile &lt;&lt; vertexData[vi].z &lt;&lt; <span class="hljs-string">'\n'</span>;
    outfile &lt;&lt; (<span class="hljs-type">int</span>)vertexData[vi].red &lt;&lt; <span class="hljs-string">' '</span>;
    outfile &lt;&lt; (<span class="hljs-type">int</span>)vertexData[vi].green &lt;&lt; <span class="hljs-string">' '</span>;
    outfile &lt;&lt; (<span class="hljs-type">int</span>)vertexData[vi].blue &lt;&lt; <span class="hljs-string">'\n'</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> fi = <span class="hljs-number">0</span>; fi &lt; faceCount; fi++) {
    outfile &lt;&lt; <span class="hljs-number">3</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> ii = <span class="hljs-number">0</span>; ii &lt; <span class="hljs-number">3</span>; ii++) {
      <span class="hljs-type">int</span> id = indices[fi * <span class="hljs-number">3</span> + ii];
      outfile &lt;&lt; <span class="hljs-string">' '</span> &lt;&lt; id;
    }
    outfile &lt;&lt; <span class="hljs-string">'\n'</span>;
  }
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">GDALAllRegister</span>();  <span class="hljs-comment">//注册格式</span>

  <span class="hljs-built_in">InitColorTable</span>();

  <span class="hljs-built_in">ReadDem</span>();

  <span class="hljs-built_in">WriteDemModel</span>();

  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>我们将生成PLY格式的三维数据导入到开源三维软件MeshLab中，其显示的效果如下图7.1所示。可以看到虽然我们更换了一个地形数据，但是其展示的效果与第6.5节中晕渲图的效果比较类似。其实准确来说，二维晕渲图的可视化效果正是来自于三维渲染一定光照条件下的实现。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/550407a69ba044e1aeff73a1b66e8167~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769344622&amp;x-orig-sign=NeVaSufJgWfwxcqteR4M8CZBaFE%3D" alt="图7.1 带颜色信息的地形三维模型数据" loading="lazy"/></p>
<p>例6.4使用PLY数据格式来表达不规则三角网地形，而本例表达的则是规则格网地形。但是只要是保存为三维数据格式，其存储的数据信息都是相同的，都包含顶点信息和索引信息。其中顶点信息不再只包含位置信息了，还包含了每个顶点的颜色信息RGB，因此本例封装了一个顶点属性的结构体来表达一个顶点：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">VertexProperty</span> {
  <span class="hljs-type">double</span> x;
  <span class="hljs-type">double</span> y;
  <span class="hljs-type">double</span> z;
  <span class="hljs-type">uint8_t</span> red;
  <span class="hljs-type">uint8_t</span> green;
  <span class="hljs-type">uint8_t</span> blue;
};
</code></pre>
<p>我们生成PLY格式是文本格式，通过记事本打开也可以直接看到位置信息和颜色信息，如下图 7.2所示：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/62704e77153546eaacb76a4e0d05aa9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769344622&amp;x-orig-sign=1FjSX1OCtHvnLK3zbfbh3uPk2H4%3D" alt="图7.2 PLY格式文件中的位置信息和颜色信息" loading="lazy"/></p>
<p>通过这个简单的例子，就可以知道为什么需要三维模型数据分成顶点信息和索引信息来保存。在本例中，是将DEM每个方形格网转换成两个三角形，如果格网DEM为m行n列，这意味着存在(m-1)⋅(n-1)个格网，即2⋅(m-1)⋅(n-1)个三角形。如果我们以一个三角形顶点接着一个三角形顶点来描述三维模型文件，那么就需要6⋅(m-1)⋅(n-1)个顶点。但其实DEM中的顶点个数很明确，就是 m ⋅n个——这意味着至少存在这4到5倍的数据冗余。</p>
<p>先描述顶点信息，再描述索引信息，这样可以兼容一些共顶点的情况，因而可以最大化减少数据量，毕竟一个索引比一个顶点的数据量更少。如下图7.3所示，是本例生成的PLY格式文件中的索引信息。其中每一行代表一个面，3表示绘制的是三角形，后面三个数则表示顶点数据中每个顶点的索引编号。当然，PLY格式也可以将每个面描述成四边形或者多边形。但是目前大多数图形API或渲染引擎都将三角形作为绘制的基本图元，以三角形作为最小的绘制单位是效率最高的。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/374c17f194804f4ba943ae8116e5ce56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769344622&amp;x-orig-sign=z5y7KpuyFEQBV8WZ3HkrA6gIlUw%3D" alt="图7.3 PLY格式文件中的索引信息" loading="lazy"/></p>
<h4 data-id="heading-4">7.1.3 地形和影像组成三维模型（OBJ格式）</h4>
<p>在上一节中展示了基于地形的三维模型的可视化（图7.1），但这种效果其实是一种风格化的效果。所谓风格化效果，就是不一定写实，但是由于抓住了事物对象主要特征，我们可以很容易确信展示就是渲染的就是该事物对象，例如卡通风格就是一种典型的风格化效果。</p>
<p>与风格化效果相对应的就是写实效果，写实效果能够让用户有更为真实的感受。在这里，如果要让这个地形三维模型数据得到这种写实的效果，那么就可以利用我们在第5章介绍过的栅格影像（DOM），将其铺在地形三维模型的表面而不是使用顶点着色。问题在于，如何将这个影像铺在三维模型上呢？</p>
<p>这个时候我们就要用到除了位置和颜色之外的，另一种顶点属性信息：纹理坐标。在计算机图形中，影像/图片数据在被传输到GPU后，就被封装成一种名为“纹理”的数据对象。顶点的纹理坐标就是该顶点对应于这张纹理图片的位置，一个三角形面片有三个顶点，也就对应了纹理图片上的三个位置，从而可以让我们取得纹理上的颜色值。而三角形内部的顶点的颜色值，就直接从纹理上的三角形面片的区域取值内插得到。</p>
<p>在这里说的内插过程，有点像我们之前第5章中介绍的影像进行图像内插过程，但并不完全准确。这涉及到计算机图像渲染流水线中光栅化的过程，是一个很复杂的过程。本章我们只用关心三维模型数据本身，可视化的问题我们后面再介绍。在这里我们只需要知道，顶点信息可以附带纹理坐标信息，从而将纹理图片的颜色值映射到模型上。</p>
<p>如果我们要在一个三维模型中附带纹理和纹理坐标信息，那么使用PLY格式的三维模型数据就不是很方便了。如下例7.2所示，我们使用OBJ格式的三维模型数据，来表达带纹理和纹理坐标信息的地形：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">//例7.2 DEM数据转换OBJ三维模型</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gdal_priv.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;array&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">VertexProperty</span> {
  <span class="hljs-type">double</span> x;
  <span class="hljs-type">double</span> y;
  <span class="hljs-type">double</span> z;
  <span class="hljs-type">double</span> texCoordX;
  <span class="hljs-type">double</span> texCoordY;
};

<span class="hljs-type">size_t</span> vertexCount;
vector&lt;VertexProperty&gt; vertexData;
<span class="hljs-type">size_t</span> faceCount;
vector&lt;<span class="hljs-type">int</span>&gt; indices;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ReadDem</span><span class="hljs-params">()</span> </span>{
  string workDir = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  string demPath = workDir + <span class="hljs-string">"/../Data/Model/dem.tif"</span>;

  GDALDataset* dem = (GDALDataset*)<span class="hljs-built_in">GDALOpen</span>(demPath.<span class="hljs-built_in">c_str</span>(), GA_ReadOnly);
  <span class="hljs-keyword">if</span> (!dem) {
    cout &lt;&lt; <span class="hljs-string">"Can't Open Image!"</span> &lt;&lt; endl;
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-type">int</span> srcDemWidth = dem-&gt;<span class="hljs-built_in">GetRasterXSize</span>();
  <span class="hljs-type">int</span> srcDemHeight = dem-&gt;<span class="hljs-built_in">GetRasterYSize</span>();

  <span class="hljs-comment">//坐标信息</span>
  <span class="hljs-type">double</span> geoTransform[<span class="hljs-number">6</span>] = {<span class="hljs-number">0</span>};
  dem-&gt;<span class="hljs-built_in">GetGeoTransform</span>(geoTransform);
  <span class="hljs-type">double</span> srcDx = geoTransform[<span class="hljs-number">1</span>];
  <span class="hljs-type">double</span> srcDy = geoTransform[<span class="hljs-number">5</span>];
  <span class="hljs-type">double</span> startX = geoTransform[<span class="hljs-number">0</span>] + <span class="hljs-number">0.5</span> * srcDx;
  <span class="hljs-type">double</span> startY = geoTransform[<span class="hljs-number">3</span>] + <span class="hljs-number">0.5</span> * srcDy;
  <span class="hljs-type">double</span> endX = startX + (srcDemWidth - <span class="hljs-number">1</span>) * srcDx;
  <span class="hljs-type">double</span> endY = startY + (srcDemHeight - <span class="hljs-number">1</span>) * srcDy;

  <span class="hljs-type">size_t</span> demBufNum = (<span class="hljs-type">size_t</span>)srcDemWidth * srcDemHeight;
  <span class="hljs-function">vector&lt;<span class="hljs-type">float</span>&gt; <span class="hljs-title">srcDemBuf</span><span class="hljs-params">(demBufNum, <span class="hljs-number">0</span>)</span></span>;

  <span class="hljs-type">int</span> depth = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>);
  dem-&gt;<span class="hljs-built_in">GetRasterBand</span>(<span class="hljs-number">1</span>)-&gt;<span class="hljs-built_in">RasterIO</span>(GF_Read, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, srcDemWidth, srcDemHeight,
                                  srcDemBuf.<span class="hljs-built_in">data</span>(), srcDemWidth, srcDemHeight,
                                  GDT_Float32, depth, srcDemWidth * depth);

  <span class="hljs-built_in">GDALClose</span>(dem);

  <span class="hljs-type">double</span> minZ = *(std::<span class="hljs-built_in">min_element</span>(srcDemBuf.<span class="hljs-built_in">begin</span>(), srcDemBuf.<span class="hljs-built_in">end</span>()));
  <span class="hljs-type">double</span> maxZ = *(std::<span class="hljs-built_in">max_element</span>(srcDemBuf.<span class="hljs-built_in">begin</span>(), srcDemBuf.<span class="hljs-built_in">end</span>()));

  vertexCount = (<span class="hljs-type">size_t</span>)srcDemWidth * srcDemHeight;
  vertexData.<span class="hljs-built_in">resize</span>(vertexCount);
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yi = <span class="hljs-number">0</span>; yi &lt; srcDemHeight; yi++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xi = <span class="hljs-number">0</span>; xi &lt; srcDemWidth; xi++) {
      <span class="hljs-type">size_t</span> m = (<span class="hljs-type">size_t</span>)srcDemWidth * yi + xi;
      vertexData[m].x = startX + xi * srcDx;
      vertexData[m].y = startY + yi * srcDy;
      vertexData[m].z = srcDemBuf[m];
      vertexData[m].texCoordX = (<span class="hljs-type">double</span>)xi / (srcDemWidth - <span class="hljs-number">1</span>);
      vertexData[m].texCoordY = (<span class="hljs-type">double</span>)yi / (srcDemHeight - <span class="hljs-number">1</span>);
    }
  }

  faceCount = (<span class="hljs-type">size_t</span>)(srcDemHeight - <span class="hljs-number">1</span>) * (srcDemWidth - <span class="hljs-number">1</span>) * <span class="hljs-number">2</span>;
  <span class="hljs-comment">// indices.resize(faceCount);</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yi = <span class="hljs-number">0</span>; yi &lt; srcDemHeight - <span class="hljs-number">1</span>; yi++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xi = <span class="hljs-number">0</span>; xi &lt; srcDemWidth - <span class="hljs-number">1</span>; xi++) {
      <span class="hljs-type">size_t</span> m = (<span class="hljs-type">size_t</span>)srcDemWidth * yi + xi;
      indices.<span class="hljs-built_in">push_back</span>(m);
      indices.<span class="hljs-built_in">push_back</span>(m + srcDemWidth);
      indices.<span class="hljs-built_in">push_back</span>(m + srcDemWidth + <span class="hljs-number">1</span>);

      indices.<span class="hljs-built_in">push_back</span>(m + srcDemWidth + <span class="hljs-number">1</span>);
      indices.<span class="hljs-built_in">push_back</span>(m + <span class="hljs-number">1</span>);
      indices.<span class="hljs-built_in">push_back</span>(m);
    }
  }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">WriteDemModel</span><span class="hljs-params">()</span> </span>{
  string workDir = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  string demPath = workDir + <span class="hljs-string">"/../Data/Model/dst.obj"</span>;

  <span class="hljs-function">ofstream <span class="hljs-title">outfile</span><span class="hljs-params">(demPath)</span></span>;
  <span class="hljs-keyword">if</span> (!outfile) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"write file error %s\n"</span>, demPath.<span class="hljs-built_in">c_str</span>());
    <span class="hljs-keyword">return</span>;
  }

  outfile &lt;&lt; <span class="hljs-string">"mtllib dst.mtl\n"</span>;
  outfile &lt;&lt; fixed;
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> vi = <span class="hljs-number">0</span>; vi &lt; vertexCount; vi++) {
    outfile &lt;&lt; <span class="hljs-string">"v"</span> &lt;&lt; <span class="hljs-string">' '</span>;
    outfile &lt;&lt; vertexData[vi].x &lt;&lt; <span class="hljs-string">' '</span>;
    outfile &lt;&lt; vertexData[vi].y &lt;&lt; <span class="hljs-string">' '</span>;
    outfile &lt;&lt; vertexData[vi].z &lt;&lt; <span class="hljs-string">'\n'</span>;
  }

  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> vi = <span class="hljs-number">0</span>; vi &lt; vertexCount; vi++) {
    outfile &lt;&lt; <span class="hljs-string">"vt"</span> &lt;&lt; <span class="hljs-string">' '</span>;
    outfile &lt;&lt; vertexData[vi].texCoordX &lt;&lt; <span class="hljs-string">' '</span>;
    outfile &lt;&lt; vertexData[vi].texCoordY &lt;&lt; <span class="hljs-string">'\n'</span>;
  }

  outfile &lt;&lt; <span class="hljs-string">"usemtl dst\n"</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> fi = <span class="hljs-number">0</span>; fi &lt; faceCount; fi++) {
    outfile &lt;&lt; <span class="hljs-string">"f"</span>;

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> ii = <span class="hljs-number">0</span>; ii &lt; <span class="hljs-number">3</span>; ii++) {
      <span class="hljs-type">int</span> id = indices[fi * <span class="hljs-number">3</span> + ii] + <span class="hljs-number">1</span>;
      outfile &lt;&lt; <span class="hljs-string">' '</span> &lt;&lt; id &lt;&lt; <span class="hljs-string">'/'</span> &lt;&lt; id;
    }
    outfile &lt;&lt; <span class="hljs-string">'\n'</span>;
  }

  string mtlPath = workDir + <span class="hljs-string">"/../Data/Model/dst.mtl"</span>;
  <span class="hljs-function">ofstream <span class="hljs-title">mtlfile</span><span class="hljs-params">(mtlPath)</span></span>;
  <span class="hljs-keyword">if</span> (!mtlfile) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"write file error %s\n"</span>, mtlPath.<span class="hljs-built_in">c_str</span>());
    <span class="hljs-keyword">return</span>;
  }

  mtlfile &lt;&lt; <span class="hljs-string">"newmtl dst\n"</span>;
  mtlfile &lt;&lt; <span class="hljs-string">"illum 2\n"</span>;
  mtlfile &lt;&lt; <span class="hljs-string">"map_Ka tex.jpg\n"</span>;
  mtlfile &lt;&lt; <span class="hljs-string">"map_Kd tex.jpg\n"</span>;
  mtlfile &lt;&lt; <span class="hljs-string">"map_Ks tex.jpg\n"</span>;
  mtlfile &lt;&lt; <span class="hljs-string">"Ns 10.000\n"</span>;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">GDALAllRegister</span>();  <span class="hljs-comment">//注册格式</span>

  <span class="hljs-comment">//设置Proj数据</span>
  std::string projDataPath = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  projDataPath += <span class="hljs-string">"/share/proj"</span>;
  <span class="hljs-built_in">CPLSetConfigOption</span>(<span class="hljs-string">"PROJ_LIB"</span>, projDataPath.<span class="hljs-built_in">c_str</span>());

  <span class="hljs-built_in">ReadDem</span>();

  <span class="hljs-built_in">WriteDemModel</span>();

  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>程序运行完成之后，生成.obj格式后缀的三维模型文件，其数据内容与.ply格式后缀的三维模型文件差不多，都是由顶点数据和索引数据组成的，只不过两者的数据组织形式不同。OBJ格式的数据描述形式是先描述顶点位置信息，如下图7.4所示：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/6791c74b1db44b08b1f7b5ec39def32a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769344622&amp;x-orig-sign=KxnU3h20qKRKq5ulfw2GiMJZdDA%3D" alt="图7.4 OBJ格式文件中的位置信息" loading="lazy"/></p>
<p>接着描述顶点的纹理坐标信息，如下图7.5所示：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/2851642c8db94914b70217df1fbb47ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769344622&amp;x-orig-sign=QbhMKvEEecY9VMUrjsqTLmiEE7A%3D" alt="图7.5 OBJ格式文件中的纹理坐标信息" loading="lazy"/></p>
<p>最后是索引数据信息，如下图7.6所示。OBJ格式的索引数据的设计稍微复杂了一点，将索引划分成顶点位置数据的索引，以及顶点纹理坐标的索引。如果有顶点法向量数据，还可以加上顶点法向量数据的索引。但这里不用进行区分，直接都使用同一个索引值：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/b3746446c5164794ace99aa774a0eee3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769344622&amp;x-orig-sign=75aj9JKaIeXWeCfhD9McvSwP3i4%3D" alt="图7.6 OBJ格式文件中的顶点索引信息" loading="lazy"/></p>
<p>程序在生成.obj文件的同时，生成了一个后缀名为.mtl的文件。mtl是英文单词material（材质）的缩写，这个文件定义了OBJ格式文件的材质信息。在图7.4中我们可以看到，.obj文件在第一行描述信息就引用了这个.mtl：</p>
<pre><code class="hljs language-text" lang="text">mtllib dst.mtl
</code></pre>
<p>这一行描述信息表示dst.mtl文件是该.obj文件的材质文件。在这个材质文件中，描述了一些材质参数，其中就包括我们前面讲到的纹理图片文件，如下图7.7所示，tex.jpg文件就是我们使用的纹理：</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/8066bdb50de94eb7a73212038f0d1d58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769344622&amp;x-orig-sign=VWDPQ6dpTJygcwathMEhRT7FspQ%3D" alt="图7.7 OBJ格式的材质文件" loading="lazy"/></p>
<p>材质是三维可视化最为重要的概念之一，决定了物体对象以什么样的可视化效果渲染展示出来。例如，同一个物体的质感体现是金属、木头还是塑料，需要通过材质来进行定义。不过这个问题很复杂，目前我们只需要知道通常在材质中使用纹理，是材质的关键参数。</p>
<p>三维物体不会仅仅只包含一个材质，材质文件中可能会包含多个材质。每个材质通常与一段顶点索引数据相关联，表示这一段图元是通过该材质进行渲染的。如图7.6所示在描述顶点索引信息之前，使用了如下描述语句：</p>
<pre><code class="hljs language-text" lang="text">usemtl dst
</code></pre>
<p>这表示以下三角面图元是通过材质文件dst.mtl中的dst材质来进行渲染的。</p>
<p>最后，将生成OBJ格式的三维数据导入到开源三维软件MeshLab中，显示的三维渲染效果如下图7.8所示。可以看到相比例7.1的结果来说，具有更好的写实效果，可以看到突起的山峰以及峡谷的河流。这是因为使用了栅格影像（DOM）来作为纹理图片，而DOM影像通常由光学影像拍摄真实的地形拍摄而来，真实感效果更好。</p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/912cab2458f34493871d3469bf740461~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769344621&amp;x-orig-sign=6K36Q3S3jE7PNR5Txcc8iNg6%2FyM%3D" alt="图7.8 带纹理的地形三维模型数据" loading="lazy"/></p>
<h4 data-id="heading-5">7.1.4 认识现代三维模型数据（glTF格式）</h4>
<p>三维模型数据是进行三维可视化的初始载体。在进行图形渲染的起始阶段，会将硬盘中的三维模型数据读取到内存中，然后再传入显存做进一步处理。因此，三维数据格式总是会随着计算机图形技术的发展而发展，要么会出现更新的三维模型数据的格式，要么会在已有的三维模型数据上作扩展。</p>
<p>相比较前面介绍的PLY格式或者OBJ格式，glTF是一种更为现代的三维模型数据格式。这种现代性不仅仅是体现在时间上，更是体现在多方面的：</p>
<ul>
<li>现代三维数据格式包含的数据内容越来越多，大多数与三维场景渲染相关的信息都可以进行定义和保存。</li>
<li>现代三维数据格式数据定义的概念与三维渲染流程越来越适配，很多早期的三维数据格式并没有考虑到三维渲染。</li>
<li>现代三维数据格式往往会借用一些其他已经定义好的数据格式，是一个数据文件的复合体。</li>
<li>现代三维模型数据已经不单纯是一个数据资源，更是一个数据资产（asset）。</li>
</ul>
<p>glTF的英文全称是GL Transmission Format，从这个名称就可以看出这个三维数据格式的设计目的就是为了最大化数据传输的效率。这个数据传输不仅仅是指网络端到本地端数据传输，也包括本地数据与内存传输，以及内存到显存数据传输。对于数据处理这一类程序来说，CPU或者GPU的运算速度已经足够快了，数据传输反而是程序的性能瓶颈。因此，glTF的设计思路尽可能轻量化，最大程度减少3D资产的大小，节约解析和使用这些资产所需的运行时处理的时间。</p>
<p>glTF有glTF1.0和glTF2.0两个版本，本书描述的内容以glTF2.0规范为准。通常来说，glTF格式数据包含以下几个部分：</p>
<ol>
<li>三维场景数据描述：使用JSON来描述。JSON（JavaScript Object Notation）是一种轻量级的数据交换格式，易于人类阅读和编写，也易于机器解析和生成，提升网络传输效率。另外，JSON尤其适配三维场景这种树形结构数据的表达。</li>
<li>缓冲区数据：保存为二进制文件。缓冲区数据指的就是前面提到的顶点数据和顶点索引数据，其数据量通常比较大，以二进制的形式进行一次或者少数几次传输，可以最大化减少数据预处理以及数据传输的性能损耗。在OpenGL的图形渲染中，缓冲区数据读取后可以直接被其API接口调用。</li>
<li>资源文件：例如纹理数据可以使用jpg格式图片来表达，jpg格式图片压缩比较高，利于进行数据传输。另外还有一些三维图形专用的纹理格式，例如DXT和KTX2，也可以作为单独的文件被glTF使用。</li>
</ol>
<p>作为对照，这里还是使用将DEM数据转换成三维模型的例子，如下例7.3所示：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">//例7.3 DEM数据转换glTF三维模型</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gdal_priv.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fstream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iomanip&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;nlohmann/json.hpp&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> nlohmann;

<span class="hljs-type">size_t</span> pointNum = <span class="hljs-number">0</span>;
<span class="hljs-type">size_t</span> binBufNum = <span class="hljs-number">0</span>;
<span class="hljs-type">size_t</span> indicesNum = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CreateBinFile</span><span class="hljs-params">()</span> </span>{
  string workDir = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  string demPath = workDir + <span class="hljs-string">"/../Data/Model/dem.tif"</span>;

  GDALDataset *img = (GDALDataset *)<span class="hljs-built_in">GDALOpen</span>(demPath.<span class="hljs-built_in">c_str</span>(), GA_ReadOnly);
  <span class="hljs-keyword">if</span> (!img) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Can't Open Image!"</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-type">int</span> bufWidth = img-&gt;<span class="hljs-built_in">GetRasterXSize</span>();   <span class="hljs-comment">//图像宽度</span>
  <span class="hljs-type">int</span> bufHeight = img-&gt;<span class="hljs-built_in">GetRasterYSize</span>();  <span class="hljs-comment">//图像高度</span>
  <span class="hljs-type">int</span> bandNum = img-&gt;<span class="hljs-built_in">GetRasterCount</span>();    <span class="hljs-comment">//波段数</span>
  <span class="hljs-keyword">if</span> (bandNum != <span class="hljs-number">1</span>) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"DEM波段数不为1"</span>);
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-type">int</span> depth = <span class="hljs-built_in">GDALGetDataTypeSize</span>(img-&gt;<span class="hljs-built_in">GetRasterBand</span>(<span class="hljs-number">1</span>)-&gt;<span class="hljs-built_in">GetRasterDataType</span>()) /<span class="hljs-number">8</span>;  <span class="hljs-comment">//图像深度</span>

  <span class="hljs-comment">//获取地理坐标信息</span>
  <span class="hljs-type">double</span> padfTransform[<span class="hljs-number">6</span>];
  <span class="hljs-keyword">if</span> (img-&gt;<span class="hljs-built_in">GetGeoTransform</span>(padfTransform) == CE_Failure) {
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"获取仿射变换参数失败"</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-type">double</span> startX = padfTransform[<span class="hljs-number">0</span>];
  <span class="hljs-type">double</span> dX = padfTransform[<span class="hljs-number">1</span>];
  <span class="hljs-type">double</span> startY = padfTransform[<span class="hljs-number">3</span>];
  <span class="hljs-type">double</span> dY = padfTransform[<span class="hljs-number">5</span>];

  <span class="hljs-comment">//申请buf</span>
  <span class="hljs-type">size_t</span> imgBufNum = (<span class="hljs-type">size_t</span>)bufWidth * bufHeight * bandNum;
  <span class="hljs-type">float</span> *imgBuf = <span class="hljs-keyword">new</span> <span class="hljs-type">float</span>[imgBufNum];

  <span class="hljs-comment">//读取</span>
  img-&gt;<span class="hljs-built_in">RasterIO</span>(GF_Read, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, bufWidth, bufHeight, imgBuf, bufWidth, bufHeight,GDT_Float32, bandNum, <span class="hljs-literal">nullptr</span>, bandNum * depth,
bufWidth * bandNum * depth, depth);

  pointNum = (<span class="hljs-type">size_t</span>)bufWidth * bufHeight;
  <span class="hljs-type">size_t</span> position_texture_num = pointNum * <span class="hljs-number">5</span>;
  <span class="hljs-type">float</span> *position_texture = <span class="hljs-keyword">new</span> <span class="hljs-type">float</span>[position_texture_num];

  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yi = <span class="hljs-number">0</span>; yi &lt; bufHeight; yi++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xi = <span class="hljs-number">0</span>; xi &lt; bufWidth; xi++) {
      <span class="hljs-type">size_t</span> n = (<span class="hljs-type">size_t</span>)(bufWidth * <span class="hljs-number">5</span>) * yi + <span class="hljs-number">5</span> * xi;
      position_texture[n] = dX * xi;
      position_texture[n + <span class="hljs-number">1</span>] = dY * yi;
      <span class="hljs-type">size_t</span> m = (<span class="hljs-type">size_t</span>)(bufWidth * bandNum) * yi + bandNum * xi;
      position_texture[n + <span class="hljs-number">2</span>] = imgBuf[m];
      position_texture[n + <span class="hljs-number">3</span>] = <span class="hljs-built_in">float</span>(xi) / (bufWidth - <span class="hljs-number">1</span>);
      position_texture[n + <span class="hljs-number">4</span>] = <span class="hljs-built_in">float</span>(yi) / (bufHeight - <span class="hljs-number">1</span>);
    }
  }

  <span class="hljs-comment">//释放</span>
  <span class="hljs-keyword">delete</span>[] imgBuf;
  imgBuf = <span class="hljs-literal">nullptr</span>;

  string binPath = workDir + <span class="hljs-string">"/../Data/Model/new.bin"</span>;
  <span class="hljs-function">ofstream <span class="hljs-title">binFile</span><span class="hljs-params">(binPath, std::ios::binary)</span></span>;

  binFile.<span class="hljs-built_in">write</span>((<span class="hljs-type">char</span> *)position_texture, position_texture_num * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>));

  <span class="hljs-type">size_t</span> vertexBufNum = position_texture_num * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>);
  binBufNum = binBufNum + vertexBufNum;

  <span class="hljs-type">int</span> mod = vertexBufNum % <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint16_t</span>);
  <span class="hljs-keyword">if</span> (mod != <span class="hljs-number">0</span>) {
    <span class="hljs-type">int</span> spaceNum = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>) - mod;
    <span class="hljs-type">char</span> *space = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[spaceNum];
    binBufNum = binBufNum + <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>) * spaceNum;
    <span class="hljs-built_in">memset</span>(space, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>) * spaceNum);
    binFile.<span class="hljs-built_in">write</span>(space, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">char</span>) * spaceNum);
    <span class="hljs-keyword">delete</span>[] space;
    space = <span class="hljs-literal">nullptr</span>;
  }

  indicesNum = (<span class="hljs-type">size_t</span>)(bufWidth - <span class="hljs-number">1</span>) * (bufHeight - <span class="hljs-number">1</span>) * <span class="hljs-number">2</span> * <span class="hljs-number">3</span>;
  <span class="hljs-type">uint16_t</span> *indices = <span class="hljs-keyword">new</span> <span class="hljs-type">uint16_t</span>[indicesNum];

  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> yi = <span class="hljs-number">0</span>; yi &lt; bufHeight - <span class="hljs-number">1</span>; yi++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> xi = <span class="hljs-number">0</span>; xi &lt; bufWidth - <span class="hljs-number">1</span>; xi++) {
      <span class="hljs-type">uint16_t</span> m00 = (<span class="hljs-type">uint16_t</span>)(bufWidth * yi + xi);
      <span class="hljs-type">uint16_t</span> m01 = (<span class="hljs-type">uint16_t</span>)(bufWidth * (yi + <span class="hljs-number">1</span>) + xi);
      <span class="hljs-type">uint16_t</span> m11 = (<span class="hljs-type">uint16_t</span>)(bufWidth * (yi + <span class="hljs-number">1</span>) + xi + <span class="hljs-number">1</span>);
      <span class="hljs-type">uint16_t</span> m10 = (<span class="hljs-type">uint16_t</span>)(bufWidth * yi + xi + <span class="hljs-number">1</span>);

      <span class="hljs-type">size_t</span> n = (<span class="hljs-type">size_t</span>)(bufWidth - <span class="hljs-number">1</span>) * yi + xi;
      indices[n * <span class="hljs-number">6</span>] = m00;
      indices[n * <span class="hljs-number">6</span> + <span class="hljs-number">1</span>] = m01;
      indices[n * <span class="hljs-number">6</span> + <span class="hljs-number">2</span>] = m11;
      indices[n * <span class="hljs-number">6</span> + <span class="hljs-number">3</span>] = m11;
      indices[n * <span class="hljs-number">6</span> + <span class="hljs-number">4</span>] = m10;
      indices[n * <span class="hljs-number">6</span> + <span class="hljs-number">5</span>] = m00;
    }
  }

  binFile.<span class="hljs-built_in">write</span>((<span class="hljs-type">char</span> *)indices, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint16_t</span>) * indicesNum);
  binBufNum = binBufNum + <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint16_t</span>) * indicesNum;

  <span class="hljs-keyword">delete</span>[] position_texture;
  position_texture = <span class="hljs-literal">nullptr</span>;

  <span class="hljs-keyword">delete</span>[] indices;
  indices = <span class="hljs-literal">nullptr</span>;
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">GDALAllRegister</span>();
  <span class="hljs-built_in">CPLSetConfigOption</span>(<span class="hljs-string">"GDAL_FILENAME_IS_UTF8"</span>, <span class="hljs-string">"NO"</span>);  <span class="hljs-comment">//支持中文路径</span>

  <span class="hljs-comment">//设置Proj数据</span>
  std::string projDataPath = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  projDataPath += <span class="hljs-string">"/share/proj"</span>;
  <span class="hljs-built_in">CPLSetConfigOption</span>(<span class="hljs-string">"PROJ_LIB"</span>, projDataPath.<span class="hljs-built_in">c_str</span>());

  ordered_json gltf;

  gltf[<span class="hljs-string">"asset"</span>] = {{<span class="hljs-string">"generator"</span>, <span class="hljs-string">"CL"</span>}, {<span class="hljs-string">"version"</span>, <span class="hljs-string">"2.0"</span>}};

  gltf[<span class="hljs-string">"scene"</span>] = <span class="hljs-number">0</span>;
  gltf[<span class="hljs-string">"scenes"</span>] = {{{<span class="hljs-string">"nodes"</span>, {<span class="hljs-number">0</span>}}}};

  gltf[<span class="hljs-string">"nodes"</span>] = {{{<span class="hljs-string">"mesh"</span>, <span class="hljs-number">0</span>}}};

  ordered_json positionJson;
  positionJson[<span class="hljs-string">"POSITION"</span>] = <span class="hljs-number">1</span>;
  positionJson[<span class="hljs-string">"TEXCOORD_0"</span>] = <span class="hljs-number">2</span>;

  ordered_json primitivesJson;
  primitivesJson = {
      {{<span class="hljs-string">"attributes"</span>, positionJson}, {<span class="hljs-string">"indices"</span>, <span class="hljs-number">0</span>}, {<span class="hljs-string">"material"</span>, <span class="hljs-number">0</span>}}};

  gltf[<span class="hljs-string">"meshes"</span>] = {{{<span class="hljs-string">"primitives"</span>, primitivesJson}}};

  ordered_json pbrJson;
  pbrJson[<span class="hljs-string">"baseColorTexture"</span>][<span class="hljs-string">"index"</span>] = <span class="hljs-number">0</span>;

  gltf[<span class="hljs-string">"materials"</span>] = {{{<span class="hljs-string">"pbrMetallicRoughness"</span>, pbrJson}}};

  <span class="hljs-built_in">CreateBinFile</span>();

  gltf[<span class="hljs-string">"textures"</span>] = {{{<span class="hljs-string">"sampler"</span>, <span class="hljs-number">0</span>}, {<span class="hljs-string">"source"</span>, <span class="hljs-number">0</span>}}};

  gltf[<span class="hljs-string">"images"</span>] = {{{<span class="hljs-string">"uri"</span>, <span class="hljs-string">"tex.jpg"</span>}}};

  gltf[<span class="hljs-string">"samplers"</span>] = {{{<span class="hljs-string">"magFilter"</span>, <span class="hljs-number">9729</span>},
                       {<span class="hljs-string">"minFilter"</span>, <span class="hljs-number">9987</span>},
                       {<span class="hljs-string">"wrapS"</span>, <span class="hljs-number">33648</span>},
                       {<span class="hljs-string">"wrapT"</span>, <span class="hljs-number">33648</span>}}};

  gltf[<span class="hljs-string">"buffers"</span>] = {{{<span class="hljs-string">"uri"</span>, <span class="hljs-string">"new.bin"</span>}, {<span class="hljs-string">"byteLength"</span>, binBufNum}}};

  ordered_json indicesBufferJson;
  indicesBufferJson[<span class="hljs-string">"buffer"</span>] = <span class="hljs-number">0</span>;
  indicesBufferJson[<span class="hljs-string">"byteOffset"</span>] = pointNum * <span class="hljs-number">5</span> * <span class="hljs-number">4</span>;
  indicesBufferJson[<span class="hljs-string">"byteLength"</span>] = indicesNum * <span class="hljs-number">2</span>;
  indicesBufferJson[<span class="hljs-string">"target"</span>] = <span class="hljs-number">34963</span>;

  ordered_json positionBufferJson;
  positionBufferJson[<span class="hljs-string">"buffer"</span>] = <span class="hljs-number">0</span>;
  positionBufferJson[<span class="hljs-string">"byteStride"</span>] = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>) * <span class="hljs-number">5</span>;
  positionBufferJson[<span class="hljs-string">"byteOffset"</span>] = <span class="hljs-number">0</span>;
  positionBufferJson[<span class="hljs-string">"byteLength"</span>] = pointNum * <span class="hljs-number">5</span> * <span class="hljs-number">4</span>;
  positionBufferJson[<span class="hljs-string">"target"</span>] = <span class="hljs-number">34962</span>;

  gltf[<span class="hljs-string">"bufferViews"</span>] = {indicesBufferJson, positionBufferJson};

  ordered_json indicesAccessors;
  indicesAccessors[<span class="hljs-string">"bufferView"</span>] = <span class="hljs-number">0</span>;
  indicesAccessors[<span class="hljs-string">"byteOffset"</span>] = <span class="hljs-number">0</span>;
  indicesAccessors[<span class="hljs-string">"componentType"</span>] = <span class="hljs-number">5123</span>;
  indicesAccessors[<span class="hljs-string">"count"</span>] = indicesNum;
  indicesAccessors[<span class="hljs-string">"type"</span>] = <span class="hljs-string">"SCALAR"</span>;
  indicesAccessors[<span class="hljs-string">"max"</span>] = {<span class="hljs-number">18719</span>};
  indicesAccessors[<span class="hljs-string">"min"</span>] = {<span class="hljs-number">0</span>};

  ordered_json positionAccessors;
  positionAccessors[<span class="hljs-string">"bufferView"</span>] = <span class="hljs-number">1</span>;
  positionAccessors[<span class="hljs-string">"byteOffset"</span>] = <span class="hljs-number">0</span>;
  positionAccessors[<span class="hljs-string">"componentType"</span>] = <span class="hljs-number">5126</span>;
  positionAccessors[<span class="hljs-string">"count"</span>] = pointNum;
  positionAccessors[<span class="hljs-string">"type"</span>] = <span class="hljs-string">"VEC3"</span>;
  positionAccessors[<span class="hljs-string">"max"</span>] = {<span class="hljs-number">770</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">1261.151611328125</span>};
  positionAccessors[<span class="hljs-string">"min"</span>] = {<span class="hljs-number">0.0</span>, <span class="hljs-number">-2390</span>, <span class="hljs-number">733.5555419921875</span>};

  ordered_json textureAccessors;
  textureAccessors[<span class="hljs-string">"bufferView"</span>] = <span class="hljs-number">1</span>;
  textureAccessors[<span class="hljs-string">"byteOffset"</span>] = <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">float</span>) * <span class="hljs-number">3</span>;
  textureAccessors[<span class="hljs-string">"componentType"</span>] = <span class="hljs-number">5126</span>;
  textureAccessors[<span class="hljs-string">"count"</span>] = pointNum;
  textureAccessors[<span class="hljs-string">"type"</span>] = <span class="hljs-string">"VEC2"</span>;
  textureAccessors[<span class="hljs-string">"max"</span>] = {<span class="hljs-number">1</span>, <span class="hljs-number">1</span>};
  textureAccessors[<span class="hljs-string">"min"</span>] = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>};

  gltf[<span class="hljs-string">"accessors"</span>] = {indicesAccessors, positionAccessors, textureAccessors};

  string workDir = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">"GISBasic"</span>);
  string jsonFile = workDir + <span class="hljs-string">"/../Data/Model/new.gltf"</span>;
  <span class="hljs-function">ofstream <span class="hljs-title">binFile</span><span class="hljs-params">(jsonFile, std::ios::binary)</span></span>;

  <span class="hljs-function">std::ofstream <span class="hljs-title">outFile</span><span class="hljs-params">(jsonFile)</span></span>;
  outFile &lt;&lt; std::<span class="hljs-built_in">setw</span>(<span class="hljs-number">4</span>) &lt;&lt; gltf &lt;&lt; std::endl;
}
</code></pre>
<p>例7.3最终得到的glTF格式使的三维模型文件如下图7.9所示（也可以直接从本书的在线主页中获取）。.gltf后缀的文件就是用于三维场景数据描述的JSON文件，.bin后缀的文件就是储存缓存区数据的二进制文件，.jpg文件就是三维模型用到的纹理图片。一些在线网站（如<a href="https://link.juejin.cn?target=https%3A%2F%2Fgltf-viewer.donmccurdy.com%25EF%25BC%2589%25E6%258F%2590%25E4%25BE%259B%25E4%25BA%2586%25E5%25AF%25B9glTF%25E6%25A8%25A1%25E5%259E%258B%25E6%2595%25B0%25E6%258D%25AE%25E7%259A%2584%25E6%25B5%258F%25E8%25A7%2588%25EF%25BC%258C%25E5%258F%25AF%25E4%25BB%25A5%25E5%25BE%2597%25E5%2588%25B0%25E5%25A6%2582%25E5%259B%25BE7.8%25E6%2589%2580%25E7%25A4%25BA%25E7%259A%2584%25E6%25B8%25B2%25E6%259F%2593%25E6%2595%2588%25E6%259E%259C%25E3%2580%2582" target="_blank" title="https://gltf-viewer.donmccurdy.com%EF%BC%89%E6%8F%90%E4%BE%9B%E4%BA%86%E5%AF%B9glTF%E6%A8%A1%E5%9E%8B%E6%95%B0%E6%8D%AE%E7%9A%84%E6%B5%8F%E8%A7%88%EF%BC%8C%E5%8F%AF%E4%BB%A5%E5%BE%97%E5%88%B0%E5%A6%82%E5%9B%BE7.8%E6%89%80%E7%A4%BA%E7%9A%84%E6%B8%B2%E6%9F%93%E6%95%88%E6%9E%9C%E3%80%82" ref="nofollow noopener noreferrer">gltf-viewer.donmccurdy.com）提供了对glTF模型数据的浏览，可以得到如图7.8所示的渲染效果。</a></p>
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/22d9c457ad5a4565a96a8fe8c18bb106~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769344622&amp;x-orig-sign=N8wNBq4clhabz9Yfl7mhzbnbycw%3D" alt="图7.9 glTF格式三维模型文件" loading="lazy"/></p>
<p>在这里，我们就不继续介绍例7.3的转换过程了，因为其关键就在于glTF格式数据解析。在下一节中，我们会根据这个成果数据详细介绍glTF数据格式规范，加深对三维模型数据的认识。</p>
<hr/>
<p>本文节选自作者新书《GIS基础原理与技术实践》第7章。书中系统讲解 GIS 核心理论与多语言实战，适合开发者与高校师生。</p>
<p>📚 <strong>配套资源开源</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffafa1899%2FGISBasic" target="_blank" title="https://github.com/fafa1899/GISBasic" ref="nofollow noopener noreferrer">GitHub</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fcharlee44%2FGISBasic" target="_blank" title="https://gitcode.com/charlee44/GISBasic" ref="nofollow noopener noreferrer">GitCode</a>
🛒 <strong>支持正版</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fitem.jd.com%2F14603137.html" target="_blank" title="https://item.jd.com/14603137.html" ref="nofollow noopener noreferrer">京东</a>｜<a href="https://link.juejin.cn?target=https%3A%2F%2Fproduct.dangdang.com%2F29988568.html" target="_blank" title="https://product.dangdang.com/29988568.html" ref="nofollow noopener noreferrer">当当</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我的AI大模型转行心路历程......]]></title>    <link>https://juejin.cn/post/7598532592456187931</link>    <guid>https://juejin.cn/post/7598532592456187931</guid>    <pubDate>2026-01-24T12:40:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598532592456187931" data-draft-id="7598435950411579402" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的AI大模型转行心路历程......"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2026-01-24T12:40:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的AI大模型转行心路历程......
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T12:40:09.000Z" title="Sat Jan 24 2026 12:40:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我做后端开发五年，说得直白点，就是天天跟CRUD死磕，偶尔优化下接口性能、排查下线上bug，日子过得像上了发条的钟，稳是稳，但越往后越慌。</p>
<p>尤其是去年，公司业务收缩，我们组裁了两个人，留下的人要扛更多需求，每天加班改代码、改需求，改到最后我都快忘了写代码的初衷是啥。有天凌晨两点，我对着屏幕上的接口报错日志，突然就腻了！一辈子跟增删改查打交道，把重复的逻辑写一百遍，这不是我当初学编程想干的事。</p>
<p>第一次接触AI大模型，是公司想做个智能客服插件，让我配合算法组对接接口。那时候我对大模型的认知，就停留在“能聊天、能生成文字”的层面，觉得都是算法工程师的活，跟我这写业务代码的没关系。直到算法组的同事让我帮忙排查接口返回异常的问题，我才发现，这东西跟我以前接触的所有业务都不一样。</p>
<p>以前写代码，输入输出都是确定的，传什么参数就该返回什么结果，出问题了顺着逻辑链路查，总能找到bug。但大模型不是，同样的提问，两次返回的内容可能差很远，有时候逻辑通顺，有时候又前言不搭后语。我问算法同事这咋排查，他笑着说：“这就是调参的魅力，没有绝对的对错，只有更优的结果。”</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<p>那之后我就有点上头了。下班回家不刷剧了，翻出大学时快忘光的数学课本，重新啃线性代数、概率论，对着网上的开源项目照猫画虎，试着跑通第一个简单的LLM微调案例。刚开始真的挫败，环境配置能卡我大半天，依赖包冲突、显卡显存不够，每一步都踩坑。有次调了三天的参数，模型生成的内容还是乱七八糟，我气得差点把电脑关了...这比改十个线上bug还折磨人。</p>
<p>最迷茫的时候是辞职全职转行那一阵子。以前做后端，好歹是个有经验的老鸟，到哪都能找到工作。但转AI，我就是个新手，面试的时候被问“注意力机制原理”“Transformer结构细节”，我都答得磕磕绊绊，好几次面试完都觉得没戏。家里人也劝我，稳定点不好吗？非要折腾自己。</p>
<p>转机是我帮一个朋友的小公司做了个定制化知识库问答模型。他们是做五金批发的，想把产品手册、售后问题都灌进模型里，让客户能自己查答案。我从数据清洗、标注开始，一点点微调模型，中间改了无数次prompt，调了不知道多少组参数，终于在两周后，模型能准确回答客户关于产品规格、安装方法的问题了。当朋友发来客户反馈说“比人工客服回复还快还准”的时候，我突然就找到了那种久违的成就感！不是改完一个bug的轻松，而是创造出一个能解决实际问题的东西的满足。</p>
<p>现在我做AI大模型应用开发快一年了，每天还是要跟参数、prompt、数据打交道，偶尔也会因为模型不收敛、生成效果差而烦躁，甚至还有点怀念以前写CRUD那种确定性的踏实。但我再也没后悔过转行。</p>
<p>其实程序员转行AI，哪是追什么风口啊，更多是想从重复的劳动里跳出来，重新找到对技术的热情。以前写代码，是在既定的框架里修修补补。现在做模型，是在不确定里找最优解，虽然难，但每一次调参后的进步，每一次模型达到预期效果，都让我觉得，这才是编程该有的样子！</p>
<p>当然，我现在也还在不断补知识，毕竟AI这行更新迭代速度实在是太快了，今天学的东西可能明天就过时了。但比起五年前那个对着CRUD麻木的自己，我更喜欢现在这个虽然偶尔焦虑，但眼里有光的程序员。</p>
<p>另外，作为过来人我深知在这个转行过程中的迷茫，刚开始我也不知道从何开始，都是靠自己一步步摸爬滚打出来的。今天写这一篇文章也是想感慨一下自己的来时路，同时呢，也给天南地北的朋友们指条明路，让大家可以少走弯路，也趁着今天周末在家，我把我当时学大模型的一些学习路线、笔记素材、视频教程等资源都上传到我的网盘了，如果你现在还没有一个清晰的规划，可以参考一下我的。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用函数式接口@FunctionalInterface写出可组合的验证逻辑：从 Lambda 到责任链]]></title>    <link>https://juejin.cn/post/7598818096729309222</link>    <guid>https://juejin.cn/post/7598818096729309222</guid>    <pubDate>2026-01-24T11:09:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598818096729309222" data-draft-id="7598818096729292838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用函数式接口@FunctionalInterface写出可组合的验证逻辑：从 Lambda 到责任链"/> <meta itemprop="keywords" content="后端,Java,代码规范"/> <meta itemprop="datePublished" content="2026-01-24T11:09:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏渡苇"/> <meta itemprop="url" content="https://juejin.cn/user/729731453429159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用函数式接口@FunctionalInterface写出可组合的验证逻辑：从 Lambda 到责任链
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731453429159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏渡苇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T11:09:19.000Z" title="Sat Jan 24 2026 11:09:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>一句话总结</strong>：当你开始用接口来“描述行为”而不是“定义类”时，你就真正理解了函数式编程在 Java 中的意义。</p>
<h2 data-id="heading-0">一、问题引入：为什么我的验证规则要写成一个类？</h2>
<p>想象一下，你正在开发一个用户注册功能。你需要验证用户名不能是空白、长度要在4-20之间、还要符合正则表达式……</p>
<p>传统做法可能是这样：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">if</span> (username == <span class="hljs-literal">null</span> || username.trim().isEmpty()) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户名不能为空"</span>);
}
<span class="hljs-keyword">if</span> (username.length() &lt; <span class="hljs-number">4</span> || username.length() &gt; <span class="hljs-number">20</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户名长度应在4-20之间"</span>);
}
<span class="hljs-keyword">if</span> (!Pattern.matches(<span class="hljs-string">"[a-zA-Z0-9_]+"</span>, username)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"用户名只能包含字母、数字和下划线"</span>);
}
</code></pre>
<p>是不是看着就头大？更别说以后要加新规则了——每次都要复制粘贴一堆 if-else。</p>
<p>于是，聪明的你可能会想到：<strong>能不能把每个验证逻辑封装成一个“可复用的小单元”？</strong></p>
<p>这时候，你可能写出这样的代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotBlankRule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ValidationRule</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(String value)</span> { ... }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getErrorMessage</span><span class="hljs-params">()</span> { ... }
}
</code></pre>
<p>但等等……为了一个小小的验证逻辑，就要新建一个 <code>.java</code> 文件？这不就是“为了封装而封装”吗？</p>
<p><strong>有没有一种方式，能让我像传递参数一样，传递一段“验证逻辑”？</strong></p>
<p>答案是：<strong>有！而且 Java 8 就给了我们这个能力 —— 函数式接口（Functional Interface）</strong>。</p>
<h2 data-id="heading-1">二、什么是 @FunctionalInterface？</h2>
<p>简单说，<strong>函数式接口就是一个只包含一个抽象方法的接口</strong>。Java 8 引入了 <code>@FunctionalInterface</code> 注解来明确标识这一点。</p>
<p>比如：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@FunctionalInterface</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ValidationRule</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(String value)</span>;
    
    <span class="hljs-comment">// 默认方法不算抽象方法</span>
    <span class="hljs-keyword">default</span> String <span class="hljs-title function_">getErrorMessage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Validation failed"</span>;
    }
}
</code></pre>
<p>这个接口只有一个抽象方法 <code>validate</code>，所以它是一个函数式接口。</p>
<p>这意味着你可以用 <strong>Lambda 表达式</strong> 来实现它：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ValidationRule</span> <span class="hljs-variable">notBlank</span> <span class="hljs-operator">=</span> value -&gt; value != <span class="hljs-literal">null</span> &amp;&amp; !value.trim().isEmpty();
</code></pre>
<p>看！<strong>一行代码，就定义了一个完整的验证规则</strong>。不需要新建类，不需要继承，干净利落。</p>
<h2 data-id="heading-2">三、StringButler 实战：函数式接口如何改变 API 设计？</h2>
<p>在 StringButler 中，函数式接口的力量首先体现在其<strong>内部架构的优雅性</strong>上。</p>
<p>来，看看两个核心接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 验证规则</span>
<span class="hljs-meta">@FunctionalInterface</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ValidationRule</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(String value)</span>;
    <span class="hljs-keyword">default</span> String <span class="hljs-title function_">getErrorMessage</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"Validation failed"</span>; }
}

<span class="hljs-comment">// 转换规则</span>
<span class="hljs-meta">@FunctionalInterface</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TransformationRule</span> {
    String <span class="hljs-title function_">transform</span><span class="hljs-params">(String value)</span>;
}
</code></pre>
<p>所有的内置功能，如邮箱验证、长度检查、大小写转换、字符串替换等，都是这两个接口的具体实现。</p>
<p>例如，在 <code>AdvancedValidationTest.java</code> 中，对邮箱验证的测试：</p>
<pre><code class="hljs language-java" lang="java">assertTrue(StringButler.of(<span class="hljs-string">"test@example.com"</span>)
    .validate()
    .email() <span class="hljs-comment">// ← 这个方法内部创建了一个 EmailRule 实例</span>
    .validate()
    .isValid());
</code></pre>
<p>而 <code>EmailRule</code> 的实现简洁明了：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailRule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ValidationRule</span> {
    <span class="hljs-comment">// ... </span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(String value)</span> {
        <span class="hljs-comment">// 核心验证逻辑</span>
        <span class="hljs-keyword">return</span> EMAIL_PATTERN.matcher(value.trim()).matches();
    }
}
</code></pre>
<p><strong>这种设计带来了巨大的好处</strong>：</p>
<ul>
<li><strong>新增功能成本极低</strong>：想加一个 URL 验证？写一个 <code>UrlRule implements ValidationRule</code> 即可。</li>
<li><strong>逻辑高度解耦</strong>：验证逻辑、转换逻辑、链式调用器 (<code>ValidationChain</code>) 彼此独立，互不影响。</li>
<li><strong>天然支持组合</strong>：责任链模式 (<code>ValidationChain</code>) 可以轻松地将任意数量的 <code>ValidationRule</code> 组合在一起执行。</li>
</ul>
<h2 data-id="heading-3">四、函数式接口如何融入责任链？</h2>
<p>来看一下 StringButler 的验证链架构：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efa1c6164b6b4e4781646d3d6109cc93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5rih6IuH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769857759&amp;x-signature=jH62QnrX048umFFpyRhiyDQkeYc%3D" alt="" loading="lazy"/></p>
<p><strong>关键点</strong>：</p>
<ul>
<li><code>ValidationChain</code> 内部维护一个 <code>List&lt;ValidationRule&gt;</code></li>
<li>每次调用 <code>.notBlank()</code>、<code>.lengthBetween()</code> 等方法，都是往列表里添加一个实现了 <code>ValidationRule</code> 的对象</li>
<li>最终执行时，遍历列表，逐个调用 <code>rule.validate(value)</code></li>
</ul>
<p>而因为 <code>ValidationRule</code> 是函数式接口，<strong>你既可以传入预定义的规则类，也可以传入 Lambda 表达式</strong>！</p>
<h2 data-id="heading-4">五、优秀框架中的函数式设计</h2>
<h3 data-id="heading-5">1. Spring Framework</h3>
<p>Spring 的 <code>Predicate&lt;T&gt;</code>、<code>Function&lt;T, R&gt;</code> 被广泛用于 WebFlux、Stream 处理中。例如：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FunctionalWebConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="hljs-title function_">routerFunction</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 定义处理函数 (Handler Function)</span>
        <span class="hljs-comment">// 这是一个典型的函数：接受ServerRequest，返回Mono&lt;ServerResponse&gt;</span>
        <span class="hljs-comment">// 它应该是无副作用的（理想情况下）</span>
        Mono&lt;ServerResponse&gt; <span class="hljs-title function_">helloHandler</span><span class="hljs-params">(ServerRequest request)</span> {
            <span class="hljs-keyword">return</span> ServerResponse.ok().bodyValue(<span class="hljs-string">"Hello, "</span> + request.queryParam(<span class="hljs-string">"name"</span>).orElse(<span class="hljs-string">"World"</span>));
        }

        <span class="hljs-comment">// 定义路由规则</span>
        <span class="hljs-comment">// RouterFunctions.route 是一个高阶函数，它接受一个谓词（Predicate）和一个处理函数</span>
        <span class="hljs-comment">// 返回一个RouterFunction</span>
        <span class="hljs-keyword">return</span> route(GET(<span class="hljs-string">"/hello"</span>), <span class="hljs-built_in">this</span>::helloHandler) <span class="hljs-comment">// 使用方法引用</span>
               .andRoute(GET(<span class="hljs-string">"/greeting/{id}"</span>), <span class="hljs-built_in">this</span>::getGreetingById);
    }

    <span class="hljs-keyword">private</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">getGreetingById</span><span class="hljs-params">(ServerRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> request.pathVariable(<span class="hljs-string">"id"</span>);
        <span class="hljs-comment">// 模拟从数据库或其他服务获取数据</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">greeting</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Greeting for ID: "</span> + id;
        <span class="hljs-keyword">return</span> ServerResponse.ok().bodyValue(greeting);
    }
}
</code></pre>
<p>通过组合<code>route</code>函数，声明了“当收到GET /hello请求时，用<code>helloHandler</code>函数处理”这样的规则。代码非常清晰，关注点在于“路由规则是什么”，而不是“如何实现路由匹配的逻辑”。</p>
<h3 data-id="heading-6">2. Guava：函数式工具库的典范</h3>
<p>Guava是Google开源的Java核心库，其中<code>com.google.common.base.Function</code>接口（在Java 8之前）和大量工具类都体现了函数式思想。虽然Java 8之后<code>java.util.function</code>成为了标准，但Guava的设计理念依然极具参考价值。</p>
<p>示例1：<code>Functions</code>工具类与函数组合</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.base.Function;
<span class="hljs-keyword">import</span> com.google.common.base.Functions;

<span class="hljs-comment">// 定义两个简单的Function</span>
<span class="hljs-comment">// 1. 将字符串转换为大写</span>
Function&lt;String, String&gt; toUpperCase = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>&lt;String, String&gt;() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">apply</span><span class="hljs-params">(String input)</span> {
        <span class="hljs-keyword">return</span> input.toUpperCase();
    }
};

<span class="hljs-comment">// 2. 获取字符串的长度</span>
Function&lt;String, Integer&gt; getLength = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>&lt;String, Integer&gt;() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">apply</span><span class="hljs-params">(String input)</span> {
        <span class="hljs-keyword">return</span> input.length();
    }
};

<span class="hljs-comment">// 使用Functions.compose进行函数组合</span>
<span class="hljs-comment">// 创建一个新的Function: 先执行getLength，再对结果执行toUpperCase</span>
<span class="hljs-comment">// 注意：这里为了演示，我们假设getLength返回的是String（实际是Integer），这里用了一个转换</span>
<span class="hljs-comment">// 实际上，compose要求g的输出是f的输入类型</span>
Function&lt;String, String&gt; composedFunction = 
    Functions.compose(toUpperCase, getLength.andThen(Object::toString)); <span class="hljs-comment">// 这里用andThen适应类型</span>

<span class="hljs-comment">// 应用组合函数</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> composedFunction.apply(<span class="hljs-string">"hello world"</span>);
System.out.println(result); <span class="hljs-comment">// 输出: "11" (先求长度11，再转成字符串"11"，然后转成大写"11")</span>
</code></pre>
<ul>
<li><strong>函数组合</strong>：这是函数式编程的核心能力之一。通过组合简单的纯函数，可以构建出复杂的功能，而无需编写冗长的过程式代码。</li>
<li><strong>声明式编程</strong>：通过声明“先求长度，再转大写”的组合关系来定义逻辑，而不是一步步写出如何遍历字符串、计算长度、再转换大小写的指令。</li>
</ul>
<p>示例2：<strong><code>Optional</code>类的函数式使用</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.google.common.base.Optional;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptionalExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Optional&lt;String&gt; maybeName = Optional.of(<span class="hljs-string">"Alice"</span>);
        
        <span class="hljs-comment">// 函数式地处理Optional值</span>
        <span class="hljs-comment">// transform方法接受一个Function，对Optional中的值进行转换</span>
        Optional&lt;Integer&gt; nameLength = maybeName.transform(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>&lt;String, Integer&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">apply</span><span class="hljs-params">(String input)</span> {
                <span class="hljs-keyword">return</span> input.length();
            }
        });
        
        <span class="hljs-comment">// 如果值存在，打印长度</span>
        <span class="hljs-keyword">if</span> (nameLength.isPresent()) {
            System.out.println(nameLength.get()); <span class="hljs-comment">// 输出: 5</span>
        }
        
        <span class="hljs-comment">// 更函数式的写法：使用or/ orNull</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> maybeName.transform(String::toUpperCase).or(<span class="hljs-string">"DEFAULT"</span>);
        System.out.println(result); <span class="hljs-comment">// 输出: ALICE</span>
    }
}
</code></pre>
<p>Optional.transform方法接受一个Function作为参数，这是一个函数式接口的应用。</p>
<p><strong>避免副作用</strong>：<code>Optional</code>鼓励以无副作用的方式处理可能缺失的情况，而不是通过<code>if (obj != null)</code>这种命令式检查，后者容易遗漏或产生副作用。</p>
<p><strong>链式调用</strong>：<code>transform</code>的返回值仍是<code>Optional</code>，这使得可以进行链式调用，形成流畅的API，非常符合函数式风格。</p>
<h2 data-id="heading-7">六、注意：别滥用 Lambda！</h2>
<p>函数式接口虽好，但也有坑：</p>
<h3 data-id="heading-8">误区1：捕获外部可变状态</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 危险的Lambda：捕获可变状态</span>
List&lt;String&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
List&lt;String&gt; inputs = Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>);

inputs.stream()
    .map(input -&gt; {
        results.add(input.toUpperCase()); <span class="hljs-comment">// 修改外部状态！</span>
        <span class="hljs-keyword">return</span> input.length();
    })
    .count();

<span class="hljs-comment">// ✅ 函数式做法：无副作用</span>
List&lt;String&gt; results = inputs.stream()
    .map(String::toUpperCase)
    .collect(Collectors.toList()); <span class="hljs-comment">// 显式收集结果</span>
</code></pre>
<h3 data-id="heading-9">误区2：把复杂逻辑塞进 Lambda</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Bad! Lambda 不是万能胶水</span>
value -&gt; {
    <span class="hljs-comment">// 20行业务逻辑...</span>
}
</code></pre>
<p><strong>建议</strong>：复杂逻辑仍应封装成命名类，保持可读性和可测试性。</p>
<h3 data-id="heading-10">误区3：过度简洁，丧失可读性</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 过于"聪明"的写法</span>
Function&lt;String, Function&lt;String, Function&lt;String, String&gt;&gt;&gt; 
    tripleReplace = s1 -&gt; s2 -&gt; s3 -&gt; s -&gt; s.replace(s1, s2).replace(s3, <span class="hljs-string">""</span>);

<span class="hljs-comment">// StringButler的做法：清晰的链式调用</span>
StringButler.of(str)
    .transform()
    .replace(<span class="hljs-string">"old1"</span>, <span class="hljs-string">"new1"</span>)
    .replace(<span class="hljs-string">"old2"</span>, <span class="hljs-string">"new2"</span>)
    .replace(<span class="hljs-string">"old3"</span>, <span class="hljs-string">"new3"</span>)
    .transform();
</code></pre>
<h3 data-id="heading-11">误区4：异常处理黑洞</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ Lambda中的异常被吞没了</span>
list.stream()
    .map(str -&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> Integer.parseInt(str);
        } <span class="hljs-keyword">catch</span> (NumberFormatException e) {
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 静默处理异常</span>
        }
    });

<span class="hljs-comment">// ✅ StringButler的验证链：显式的错误收集</span>
StringButler.of(input)
    .validate()
    .numeric(<span class="hljs-literal">false</span>, <span class="hljs-string">"必须为整数"</span>) <span class="hljs-comment">// 验证失败会记录错误</span>
    .validate();
    
<span class="hljs-keyword">if</span> (!butler.isValid()) {
    <span class="hljs-type">String</span> <span class="hljs-variable">errors</span> <span class="hljs-operator">=</span> butler.getValidationErrors(); <span class="hljs-comment">// 获取所有错误</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationException</span>(errors);
}
</code></pre>
<h3 data-id="heading-12">正确姿势：函数式接口的“三要素”</h3>
<ol>
<li><strong>单一职责</strong>：一个接口只做一件事（如验证 or 转换）</li>
<li><strong>无副作用</strong>：<code>validate()</code> 不应该修改外部状态</li>
<li><strong>可组合</strong>：多个规则可以串联执行（责任链模式）</li>
</ol>
<h2 data-id="heading-13">七、实战技巧：何时该用@FunctionalInterface？</h2>
<h3 data-id="heading-14">场景1：策略模式（首选场景）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// StringButler中的BlankStrategy处理</span>
<span class="hljs-keyword">public</span> StringButler <span class="hljs-title function_">ifBlank</span><span class="hljs-params">(String defaultValue, BlankStrategy strategy)</span> {
    <span class="hljs-keyword">if</span> (isBlank(currentValue)) {
        <span class="hljs-keyword">switch</span> (strategy) {
            <span class="hljs-keyword">case</span> USE_DEFAULT: <span class="hljs-built_in">this</span>.currentValue = defaultValue; <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> THROW_EXCEPTION: <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(...);
            <span class="hljs-comment">// ...</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
}

<span class="hljs-comment">// 🚀 可以改造成函数式版本！</span>
<span class="hljs-meta">@FunctionalInterface</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BlankHandler</span> {
    String <span class="hljs-title function_">handle</span><span class="hljs-params">(String originalValue)</span>;
}

<span class="hljs-keyword">public</span> StringButler <span class="hljs-title function_">ifBlank</span><span class="hljs-params">(BlankHandler handler)</span> {
    <span class="hljs-keyword">if</span> (isBlank(currentValue)) {
        <span class="hljs-built_in">this</span>.currentValue = handler.handle(currentValue);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
}

<span class="hljs-comment">// 使用更灵活！</span>
StringButler.of(maybeBlank)
    .ifBlank(original -&gt; <span class="hljs-string">"default"</span>)  <span class="hljs-comment">// Lambda表达式</span>
    .ifBlank(String::toUpperCase)    <span class="hljs-comment">// 方法引用</span>
    .ifBlank(<span class="hljs-built_in">this</span>::customHandler);   <span class="hljs-comment">// 实例方法引用</span>
</code></pre>
<h3 data-id="heading-15">场景2：回调机制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// PatternCache中的缓存机制（实际代码简化版）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PatternCache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, Pattern&gt; CACHE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-comment">// 如果需要自定义缓存逻辑，可以传入函数式接口</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Pattern <span class="hljs-title function_">getPattern</span><span class="hljs-params">(String regex, 
                                     Function&lt;String, Pattern&gt; compiler)</span> {
        <span class="hljs-keyword">return</span> CACHE.computeIfAbsent(regex, compiler);
    }
}
</code></pre>
<h3 data-id="heading-16">场景3：条件执行</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在ValidationChain中的实际应用</span>
<span class="hljs-keyword">public</span> ValidationChain <span class="hljs-title function_">stopOnFirstFailure</span><span class="hljs-params">(<span class="hljs-type">boolean</span> stopOnFirstFailure)</span> {
    <span class="hljs-built_in">this</span>.stopOnFirstFailure = stopOnFirstFailure;
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
}

<span class="hljs-comment">// 🚀 可以扩展为更灵活的条件控制</span>
<span class="hljs-keyword">public</span> ValidationChain <span class="hljs-title function_">validateIf</span><span class="hljs-params">(Predicate&lt;String&gt; condition, 
                                  ValidationRule rule)</span> {
    <span class="hljs-keyword">if</span> (condition.test(currentValue)) {
        addRule(rule);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
}

<span class="hljs-comment">// 使用示例</span>
StringButler.of(input)
    .validate()
    .validateIf(str -&gt; str.length() &gt; <span class="hljs-number">10</span>, 
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LengthRule</span>(<span class="hljs-number">5</span>, <span class="hljs-number">20</span>))  <span class="hljs-comment">// 只有长度&gt;10时才验证5-20</span>
    .validate();
</code></pre>
<h2 data-id="heading-17">八、从“面向对象”到“面向行为”</h2>
<p>传统 OOP 强调“<strong>是什么</strong>”（is-a），而函数式编程强调“<strong>做什么</strong>”（does-a）。</p>
<ul>
<li><code>NotBlankRule</code> 是一个类 → 它“是一个”非空验证器</li>
<li><code>value -&gt; value != null</code> 是一个行为 → 它“做”的是非空判断</li>
</ul>
<p><strong>StringButler 的设计哲学是：优先暴露“行为”，而不是强制用户继承类。</strong></p>
<p>这正是现代 API 设计的趋势：<strong>灵活、轻量、组合优于继承</strong>。</p>
<h2 data-id="heading-18">九、结语</h2>
<p>通过 <code>@FunctionalInterface</code>，StringButler 实现了 <strong>高内聚、低耦合、易扩展</strong> 的字符串处理引擎。它不仅是一个工具库，更是一套<strong>设计思想的实践</strong>。</p>
<hr/>
<h3 data-id="heading-19">如果你喜欢这种“从代码看设计”的风格：</h3>
<ul>
<li><strong>GitHub 项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fiweidujiang%2Fstring-butler" target="_blank" title="https://github.com/iweidujiang/string-butler" ref="nofollow noopener noreferrer">github.com/iweidujiang…</a></li>
<li><strong>关注公众号【苏渡苇】</strong>：获取最新技术博文、源码解读、设计模式实战</li>
<li><strong>Star 项目</strong>：你的支持是我的动力！</li>
</ul>
<hr/>
<p><em>本文是《StringButler设计哲学与实战》系列的第二篇。</em></p>
<p><em>如果你对这个系列感兴趣，记得关注我的博客更新哦！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从Mybatis源码学会了什么]]></title>    <link>https://juejin.cn/post/7598477092197220390</link>    <guid>https://juejin.cn/post/7598477092197220390</guid>    <pubDate>2026-01-24T11:24:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598477092197220390" data-draft-id="7598818096729325606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从Mybatis源码学会了什么"/> <meta itemprop="keywords" content="MyBatis,源码阅读,Java"/> <meta itemprop="datePublished" content="2026-01-24T11:24:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员侠客行"/> <meta itemprop="url" content="https://juejin.cn/user/556801719828361"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从Mybatis源码学会了什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/556801719828361/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员侠客行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T11:24:46.000Z" title="Sat Jan 24 2026 11:24:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>摘要：MyBatis源码展现了优秀的设计模式和架构思想。其运用建造者模式创建复杂对象，动态代理实现Mapper接口，装饰器动态扩展功能等。架构上采用清晰分层设计，插件化扩展机制实现开闭原则，多级缓存提升性能，面向接口编程降低耦合。这些设计理念对日常业务开发也有很大借鉴价值。</p>
</blockquote>
<p>通过以下系列博文，我们熟悉了Mybatis源码实现的诸多细节，如Executor接口及其实现、缓存体系、自定义插件等。</p>
<ol>
<li>Mybatis入门到精通 一</li>
<li>Mybatis的Executor和缓存体系</li>
<li>Mybatis二级缓存实现详解</li>
<li>Mybatis执行Mapper过程详解</li>
<li>Mybatis插件原理及分页插件</li>
<li>Spring集成Mybatis原理详解</li>
</ol>
<p>这次，让我们跳出局部，看看Mybatis在设计和架构上，有哪些值得我们学习的地方。</p>
<blockquote>
<p>注：本文中源码来自mybatis 3.4.x版本，地址<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmybatis%2Fmybatis-3.git" target="_blank" title="https://github.com/mybatis/mybatis-3.git" ref="nofollow noopener noreferrer">github.com/mybatis/myb…</a></p>
</blockquote>
<h2 data-id="heading-0">一 设计模式</h2>
<h3 data-id="heading-1">1.1 建造者模式</h3>
<p>MyBatis 大量使用建造者模式解决「复杂对象初始化」问题，比如 <code>SqlSessionFactoryBuilder</code>、<code>XMLConfigBuilder</code>、<code>MapperBuilderAssistant</code> 等。</p>
<p>以<code>SqlSessionFactoryBuilder</code>为例，在创建SqlSessionFactory前需要先解析主配置文件，这个过程非常繁琐。使用建造者模式：</p>
<ul>
<li>分离「对象构建逻辑」和「对象使用逻辑」，让复杂对象创建流程清晰；</li>
<li>建造者可以分步骤校验配置正确性，避免无效对象产生；</li>
<li>多重载的 build 方法， 适配不同入参场景 。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlSessionFactoryBuilder</span> {

  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Reader reader)</span> {
    <span class="hljs-keyword">return</span> build(reader, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
  }

  <span class="hljs-comment">// 简化代码：reader就是配置文件的读取流</span>
  <span class="hljs-keyword">public</span> SqlSessionFactory <span class="hljs-title function_">build</span><span class="hljs-params">(Reader reader, String environment, Properties properties)</span> {
      <span class="hljs-type">XMLConfigBuilder</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLConfigBuilder</span>(reader, environment, properties);
      <span class="hljs-keyword">return</span> build(parser.parse());
    }
  }
</code></pre>
<h3 data-id="heading-2">1.2 工厂模式</h3>
<p>工厂模式隐藏对象创建细节，上层无需关心「具体实现类」，只依赖接口。例如</p>
<ul>
<li><code>SqlSessionFactory</code> 负责创建 <code>SqlSession</code>，提供了多个重载实现。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e1589661165422bbeaacfcd3622cf5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769858685&amp;x-signature=NgCQtOwAejTKgiA1riuBz7yQDG8%3D" alt="" loading="lazy"/></li>
<li>Executor、StatementHandler、ResultSetHandler、ParameterHandler只能由 <code>Configuration</code> 中的 <code>newExecutor</code> 等方法创建，根据配置选择不同实现类；同时应用自定义插件。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e0b2f646c541b98507f7392dfe3264~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769858685&amp;x-signature=FLCMuf%2Bm%2FZK8igsvYxDKN%2B%2Fb48w%3D" alt="" loading="lazy"/></li>
</ul>
<h3 data-id="heading-3">1.3 动态代理</h3>
<p>MyBatis 核心的特性之一是「Mapper 接口无需实现类」，底层通过 JDK 动态代理，实现接口方法调用触发SQL执行。详见 MapperProxyFactory，缓存方法元数据，避免重复解析。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 缓存mapper方法元数据，避免重复解析</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;Method, MapperMethod&gt; methodCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;Method, MapperMethod&gt;();
</code></pre>
<p>此外，插件原理也是动态代理，定义Interceptor接口声明代理逻辑、代理对象创建等。使用户可以自定义插件实现。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/528b1ca4573e463b953910ff59835bbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769858685&amp;x-signature=358hDpLBnMMbzIFpISHErQd536c%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">1.4 模板方法</h3>
<ul>
<li>模板方法将「不变的通用逻辑」抽离到父类，「可变的差异化逻辑」交给子类实现；</li>
<li>避免子类重复编写通用代码（如缓存检查、参数校验），降低代码冗余；</li>
<li>父类控制流程，子类只关注核心逻辑，符合「开闭原则」。</li>
</ul>
<p><code>BaseExecutor</code> 实现了模板方法模式，将 Executor 的通用流程（如参数处理、SQL 执行、结果集处理）抽象为模板方法，具体子类（SimpleExecutor/BatchExecutor/ReuseExecutor）只需实现差异化逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 模板方法，一级缓存使用逻辑</span>
<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">query</span><span class="hljs-params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException {
<span class="hljs-comment">// ...，会调用doQuer()</span>
    
}

<span class="hljs-comment">// 由子类实现</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> &lt;E&gt; List&lt;E&gt; <span class="hljs-title function_">doQuery</span><span class="hljs-params">(...)</span>
</code></pre>
<h3 data-id="heading-5">1.5 装饰模式</h3>
<p>用装饰模式替代继承，无需定义子类，就能给对象动态增加职责。</p>
<p>如通过CachingExecutor装饰，给BaseExecutor增加二级缓存能力。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">newExecutor</span><span class="hljs-params">(Transaction transaction, ExecutorType executorType)</span> {
    <span class="hljs-comment">// 对BaseExecutor子类进行装饰</span>
    <span class="hljs-keyword">if</span> (cacheEnabled) {
        executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CachingExecutor</span>(executor);
    }
    <span class="hljs-comment">// 省略...</span>
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55436ee6561e4086a6f22ab0f99fe184~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769858685&amp;x-signature=2ViPQW%2Be3Bj%2FA3eJBYIUsVLynlE%3D" alt="" loading="lazy"/>
如Cache接口体系，定义了很多装饰器，根据用户配置，实现功能特性自由组合。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4370c1549594655bf4cd6588979fa90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769858685&amp;x-signature=iisVJgb9y%2B0ITqMmYVtgw9RcpYI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">1.6 策略模式</h3>
<p>Executor接口可根据用户配置，运行时可切换SimpleExecutor、ReuseExecutor或BatchExecutor，实现不同的SQL执行策略。</p>
<p>RoutingStatementHandler 根据配置路由到不同的 StatementHandler实现。</p>
<h3 data-id="heading-7">1.7 注册中心</h3>
<p>源码中大量使用 Registry 模式来管理可扩展组件， 可以统一初始化、统一查找、统一生命周期；例如：</p>
<ul>
<li>TypeHandlerRegistry</li>
<li>MapperRegistry</li>
<li>LanguageDriverRegistry</li>
<li>CacheRegistry</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4501d4f189b746e4ac18bcf82e70135c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769858685&amp;x-signature=7hIqQH6GVL4WzTFCprSyyqcO2RQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">二 架构思维</h2>
<h3 data-id="heading-9">2.1 分层设计</h3>
<p>MyBatis的核心分层非常清晰，每层只做一件事，符合「单一职责原则」：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1018beec274e49498aa8eaa2b6947590~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769858685&amp;x-signature=NPmTEDNJDAPB78OdGE9BpRwaQpw%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>各层职责</strong>：
<ul>
<li>Mapper 层：用户接口，定义 SQL 操作；</li>
<li>SqlSession 层：会话入口，封装 Executor 调用；</li>
<li>Executor 层：执行器，处理缓存、事务、SQL 执行流程；</li>
<li>StatementHandler 层：处理 SQL 拼接、Statement 创建；</li>
<li>Parameter/ResultSetHandler 层：参数绑定、结果集映射；</li>
</ul>
</li>
<li><strong>架构思维</strong>：
<ul>
<li>分层降低耦合：修改结果集映射逻辑，不会影响 Executor 层；</li>
<li>每层依赖「接口」而非「实现」：比如 Executor 是接口，具体实现可替换；</li>
<li>分层便于测试：可单独测试 ParameterHandler 的参数绑定逻辑。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-10">2.2 插件化设计</h3>
<p>MyBatis 提供了插件扩展机制（Interceptor），允许开发者通过拦截器增强核心组件（Executor、StatementHandler、ParameterHandler、ResultSetHandler）的功能，实现如分页、日志、加密等。</p>
<ul>
<li><strong>核心设计</strong>：
<ul>
<li>定义 <code>Interceptor</code> 接口，开发者实现 <code>intercept</code> 方法即可拦截目标方法；</li>
<li>通过 <code>@Intercepts</code> 注解指定拦截的类和方法，无需修改源码；</li>
<li>拦截器链（InterceptorChain）通过动态代理层层包装目标对象，保证插件的有序执行；</li>
</ul>
</li>
<li><strong>架构思维</strong>：
<ul>
<li>「开闭原则」的良好体现：框架核心功能固定，扩展功能通过插件实现，无需修改源码；</li>
<li>「责任链模式」：多个插件按顺序执行，每个插件只处理自己的逻辑，互不干扰；</li>
<li>扩展点设计要「最小化」：只开放核心组件的关键方法，避免过度暴露内部逻辑。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-11">2.3 多级缓存</h3>
<p>MyBatis 实现了「一级缓存（SqlSession 级别）+ 二级缓存（Mapper 级别）」的多级缓存：</p>
<ul>
<li>一级缓存：BaseExecutor 中的 <code>localCache</code>（PerpetualCache），默认开启，SqlSession 关闭后失效；</li>
<li>二级缓存：CachingExecutor 包装普通 Executor，缓存数据存入 Mapper 对应的 Cache 对象，跨 SqlSession 共享；</li>
</ul>
<p>同时支持集成 Redis/Ehcache 等第三方缓存 。</p>
<h3 data-id="heading-12">2.4 面向接口编程</h3>
<p>MyBatis 全程贯彻「依赖倒置原则」，完全面向接口编程：接口定义「做什么」，实现类定义「怎么做」，替换实现类不影响上层逻辑；</p>
<ul>
<li>核心组件都是接口：<code>Executor</code>、<code>StatementHandler</code>、<code>ParameterHandler</code>、<code>ResultSetHandler</code>、<code>SqlSession</code> 等；</li>
<li>上层代码只依赖接口：比如 <code>SqlSession</code> 的 <code>selectList</code> 方法，底层调用的是 <code>Executor</code> 接口的 <code>query</code> 方法，无需关心具体是 SimpleExecutor 还是 BatchExecutor。</li>
</ul>
<h3 data-id="heading-13">2.5 约定优于配置</h3>
<p>MyBatis 大量使用约定来减少配置，通过约定可以显著降低配置量，提升开发体验。例如：</p>
<ul>
<li>Mapper 接口与 XML 文件同名同包；</li>
<li>方法名与 SQL ID 一致；</li>
<li>结果集字段与 JavaBean 属性自动映射；</li>
<li><code>StatementHandler</code>接口默认使用PreparedStatementHandler<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83667e2d1a8a40a4acf15f4a45aacf7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5L6g5a6i6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769858685&amp;x-signature=T50SsnLSHPkJvRQ8cbF46vRwAbo%3D" alt="" loading="lazy"/></li>
</ul>
<h3 data-id="heading-14">2.6 架构思维总结</h3>
<p>MyBatis源码体现了<strong>简单而不简陋</strong>的设计哲学：</p>
<ol>
<li>高内聚低耦合 - 模块职责清晰，依赖抽象</li>
<li>开闭原则 - 对扩展开放，对修改关闭</li>
<li>组合优于继承 - 装饰器、代理模式的应用</li>
<li>关注点分离 - SQL、映射、执行逻辑分离</li>
<li>性能优化 - 缓存、延迟加载、连接复用</li>
</ol>
<p>上述技巧和思维不仅适用于框架开发，在日常业务开发中也能直接落地。</p>
<ol>
<li>小型项目：学习其简洁的API设计</li>
<li>中型项目：借鉴其分层架构和模式应用</li>
<li>大型项目：参考其扩展机制和插件体系</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[腾讯CodeBuddy 2.0：从“副驾驶”到“全栈合伙人”的进化]]></title>    <link>https://juejin.cn/post/7598447519824379945</link>    <guid>https://juejin.cn/post/7598447519824379945</guid>    <pubDate>2026-01-24T11:43:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598447519824379945" data-draft-id="7598587406706769961" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="腾讯CodeBuddy 2.0：从“副驾驶”到“全栈合伙人”的进化"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-24T11:43:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            腾讯CodeBuddy 2.0：从“副驾驶”到“全栈合伙人”的进化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T11:43:03.000Z" title="Sat Jan 24 2026 11:43:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果说去年的AI编程工具还在比拼谁的补全速度更快、谁猜你的下一行代码更准，那么今年，腾讯云发布的 <strong>CodeBuddy Code 2.0</strong> 显然想把这场游戏提升到一个新的维度：它不想再只做你的副驾驶（Copilot），它想做你的工程合伙人。</p>
<p>最近科技圈里流传着一组来自腾讯内部的数据，相当耐人寻味。CodeBuddy团队自己用这套工具，在短短58天内完成了79个版本的迭代。而在这些迭代中，<strong>90%的新增代码完全由AI生成</strong>。这意味着，原本作为辅助角色的AI，已经开始反客为主，承担起了绝大部分的搬砖工作，让4名人类开发者真正回归到了架构设计和决策者的角色。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-24_19.11.29.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-24_19.11.29.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69be59ca7c2c4caaa2d029acd9295b62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769859783&amp;x-signature=%2BHKKDsY5EGQ2ll3uvhvFgx7FOqY%3D" alt="iShot_2026-01-24_19.11.29" loading="lazy"/></a></p>
<p>这听起来很性感，但CodeBuddy 2.0到底凭什么能做到这一点？细看这次的更新文档，我们会发现几个非常有意思的技术突破。</p>
<h3 data-id="heading-0">不再盲猜，先有“计划”</h3>
<p>以前我们用AI写代码，最头疼的是“上下文丢失”和“逻辑断层”。你让它写个复杂功能，它往往写着写着就跑偏了。</p>
<p>CodeBuddy 2.0 拿出的杀手锏是 <strong>Plan模式（计划模式）</strong>。这就好比你在带实习生，不会上来就让他写核心逻辑，而是先让他把任务拆解清楚。在Plan模式下，AI会先通过自然语言规划任务，把一个庞大的需求拆解成一个个原子操作。只有当规划路径被确认后，它才会动手。这种“先思考，后行动”的逻辑，让它在处理复杂工程任务时的可用性有了质的飞跃。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-24_19.11.34-1024x856.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-24_19.11.34-1024x856.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f009a7870d924e7b8473a5d058669b59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769859783&amp;x-signature=y%2BMVrj3gadNP30rTpFjBZpls%2BLU%3D" alt="iShot_2026-01-24_19.11.34" loading="lazy"/></a></p>
<p>配合这一模式的是 <strong>ACP协议</strong>。这是一个标准化的接口协议，它把核心的智能体能力与编辑器解耦了。这意味着CodeBuddy不仅仅是一个插件，它更像是一个独立运行的大脑，可以灵活地接入Zed等各种现代编辑器。</p>
<h3 data-id="heading-1">给AI装上“安全气囊”</h3>
<p>让AI接管命令行和文件系统，对于任何一个有经验的运维或架构师来说，听起来都有点心惊肉跳。万一AI“发疯”删库怎么办？</p>
<p>腾讯显然很清楚企业的痛点。他们在2.0版本中引入了基于 <strong>TencentOS</strong> 的容器化安全沙箱。简单来说，就是给AI划定了一个绝对隔离的虚拟游乐场。</p>
<p>在这个沙箱里，文件系统的读写、网络请求的发出，都受到严格的管控。默认情况下是“只读”的，任何涉及修改代码或执行敏感命令的操作，都需要经过权限校验。这种“最小权限原则”的设计，实际上是给AI戴上了镣铐，让它在拥有强大执行力的同时，不具备破坏生产环境的能力。</p>
<h3 data-id="heading-2">打开黑盒，拥抱生态</h3>
<p>这可能是CodeBuddy 2.0最像“极客”的一面。不同于市面上很多封装得严严实实的AI工具，CodeBuddy选择了极度开放。</p>
<p>首先是 <strong>SDK的开放</strong>。它允许开发者通过 <code>CodeBuddyAgent SDK</code> 和 API Key，直接把这种智能体能力集成到自己的业务系统中。如果你觉得官方的功能不够用，你甚至可以自己写一个“子智能体（Subagent）”来专门处理你们团队特殊的业务逻辑。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-24_19.11.43.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-24_19.11.43.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a65ab7c57584c03be1da04984ff3f35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769859783&amp;x-signature=f29H64dDlL%2F%2F80vJWt1uSjzPnrU%3D" alt="iShot_2026-01-24_19.11.43" loading="lazy"/></a></p>
<p>其次是 <strong>多模型支持</strong>。它不强制你绑定某一个模型，而是支持GLM-4.7、GPT-5.2 Codex等国内外主流模型。这种“模型中立”的态度，在如今的大厂产品中并不多见。</p>
<h3 data-id="heading-3">写在最后</h3>
<p>从单纯的代码补全，到支持CLI（命令行）、IDE和插件三端联动，再到开放SDK让企业自己定制，腾讯CodeBuddy 2.0的野心很明显：它不仅仅想做一个工具，而是想成为AI原生开发时代的“基础设施”。</p>
<p>当一个工具开始能够理解工程全貌、能够自我规划任务、并且在安全可控的前提下自主执行时，软件开发的门槛正在被重新定义。对于开发者而言，也许是时候改变一下工作流，试着学会如何管理一个“硅基同事”了。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 TypeScript + React Hooks 构建一个健壮的 Todo 应用]]></title>    <link>https://juejin.cn/post/7598827845965185050</link>    <guid>https://juejin.cn/post/7598827845965185050</guid>    <pubDate>2026-01-24T09:45:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598827845965185050" data-draft-id="7598818096729112614" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 TypeScript + React Hooks 构建一个健壮的 Todo 应用"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2026-01-24T09:45:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 TypeScript + React Hooks 构建一个健壮的 Todo 应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T09:45:50.000Z" title="Sat Jan 24 2026 09:45:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近我用 React 和 TypeScript 从零写了一个 Todo 应用，整个过程让我深刻体会到：<strong>类型系统不是束缚，而是保护</strong>。它让组件之间的协作更清晰，状态管理更可靠，连 localStorage 的读写都变得安全可控。下面分享我是怎么一步步搭建这个小项目的。</p>
<h2 data-id="heading-0">核心思路：状态集中 + 类型约束</h2>
<p>我把所有 todo 数据和操作逻辑封装在一个自定义 Hook <code>useTodos</code> 里，这样组件只需要“消费”状态和方法，不用关心实现细节。同时，用 TypeScript 接口明确约定数据结构，避免传错参数或访问不存在的属性。</p>
<p>首先定义 Todo 的结构：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// types/todo.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Todo</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span>;
}
</code></pre>
<p>这个接口就像一份契约——任何地方使用 Todo 数据，都必须包含这三个字段，且类型固定。</p>
<h2 data-id="heading-1">自定义 Hook：useTodos</h2>
<p>这是整个应用的核心。它用 <code>useState</code> 管理状态，并通过 <code>useEffect</code> 同步到 localStorage：</p>
<pre><code class="hljs language-ini" lang="ini">// hooks/useTodos.ts
export function useTodos() {
  const <span class="hljs-section">[todos, setTodos]</span> = useState&lt;Todo<span class="hljs-section">[]</span>&gt;(() =&gt; 
    getStorage&lt;Todo<span class="hljs-section">[]</span>&gt;(STORAGE_KEY, <span class="hljs-section">[]</span>)
  )<span class="hljs-comment">;</span>

  useEffect(() =&gt; {
    setStorage&lt;Todo<span class="hljs-section">[]</span>&gt;(STORAGE_KEY, todos)<span class="hljs-comment">;</span>
  }, <span class="hljs-section">[todos]</span>)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">addTodo</span> = (title: string) =&gt; {
    const newTodo: <span class="hljs-attr">Todo</span> = {
      id: +new Date(),
      title,
      completed: false
    }<span class="hljs-comment">;</span>
    setTodos(<span class="hljs-section">[...todos, newTodo]</span>)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>

  // toggleTodo 和 removeTodo 略...

  return { todos, addTodo, toggleTodo, removeTodo }<span class="hljs-comment">;</span>
}
</code></pre>
<p>注意这里用了泛型函数 <code>getStorage&lt;T&gt;</code> 和 <code>setStorage&lt;T&gt;</code>，确保读写 localStorage 时类型安全：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// utils/storages.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> getStorage&lt;T&gt;(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">defaultValue</span>: T): T {
  <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key);
  <span class="hljs-keyword">return</span> item ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(item) : defaultValue;
}
</code></pre>
<p>这样，即使从 localStorage 读出来的数据是字符串，TS 也能正确推断为 <code>Todo[]</code> 类型。</p>
<h2 data-id="heading-2">组件通信：靠 Props 接口对齐</h2>
<p>父组件 <code>App</code> 只负责组合，不处理逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// App.tsx</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { todos, addTodo, toggleTodo, removeTodo } = <span class="hljs-title function_">useTodos</span>();
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>TodoList<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoInput</span> <span class="hljs-attr">onAdd</span>=<span class="hljs-string">{addTodo}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span> <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span> <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{toggleTodo}</span> <span class="hljs-attr">onRemove</span>=<span class="hljs-string">{removeTodo}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>子组件通过 Props 接口明确声明自己需要什么：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// components/TodoList.tsx</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Props</span> {
  <span class="hljs-attr">todos</span>: <span class="hljs-title class_">Todo</span>[];
  <span class="hljs-attr">onToggle</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">onRemove</span>: <span class="hljs-function">(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">TodoList</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">Props</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ todos, onToggle, onRemove }</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      {todos.map(todo =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">TodoItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span> <span class="hljs-attr">todo</span>=<span class="hljs-string">{todo}</span> <span class="hljs-attr">onToggle</span>=<span class="hljs-string">{onToggle}</span> <span class="hljs-attr">onRemove</span>=<span class="hljs-string">{onRemove}</span> /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  );
};
</code></pre>
<p>这样，如果我在 <code>App</code> 里不小心传了错误类型的 <code>onToggle</code>，TypeScript 会立刻报错，而不是等到运行时才发现按钮点不动。</p>
<h2 data-id="heading-3">单个 Todo 项：细节处理</h2>
<p>在 <code>TodoItem</code> 中，根据 <code>completed</code> 状态动态设置样式：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">span</span> style={{ textDecoration: todo.completed ? <span class="hljs-string">'line-through'</span> : <span class="hljs-string">'none'</span> }}&gt;
  {todo<span class="hljs-selector-class">.title</span>}
&lt;/<span class="hljs-selector-tag">span</span>&gt;
</code></pre>
<p>因为 <code>todo</code> 的类型是 <code>Todo</code>，所以 <code>todo.completed</code> 一定是布尔值，不会出现 <code>undefined</code> 导致样式异常。</p>
<h2 data-id="heading-4">输入框：防错处理</h2>
<p><code>TodoInput</code> 还做了空值校验：</p>
<pre><code class="hljs language-scss" lang="scss">const handleAdd = () =&gt; {
  if (!value.trim()) return; <span class="hljs-comment">// 防止添加空任务</span>
  <span class="hljs-built_in">onAdd</span>(value);
  <span class="hljs-built_in">setValue</span>('');
};
</code></pre>
<p>配合 TS 的 <code>string</code> 类型，确保传给 <code>onAdd</code> 的一定是字符串，不会意外传入数字或 null。</p>
<h2 data-id="heading-5">总结：为什么值得用 TS？</h2>
<ul>
<li><strong>提前暴露问题</strong>：写代码时就知道哪里传参错了；</li>
<li><strong>自动文档</strong>：鼠标悬停就能看到函数签名和字段说明；</li>
<li><strong>重构安全</strong>：改一个接口，所有用到的地方都会提示更新；</li>
<li><strong>团队协作友好</strong>：别人看你的组件，一眼就知道要传什么。</li>
</ul>
<p>这个 Todo 应用虽然简单，但用 TS 写完后，感觉整个项目“稳”了很多。以后再做大项目，我肯定会首选 TypeScript —— 它不是增加负担，而是帮我们写出更干净、更可靠的代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥 在浏览器地址栏输入 URL 后，页面是怎么一步步显示出来的？]]></title>    <link>https://juejin.cn/post/7598480267217993762</link>    <guid>https://juejin.cn/post/7598480267217993762</guid>    <pubDate>2026-01-24T10:05:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598480267217993762" data-draft-id="7598490039488806947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥 在浏览器地址栏输入 URL 后，页面是怎么一步步显示出来的？"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2026-01-24T10:05:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="swipe"/> <meta itemprop="url" content="https://juejin.cn/user/858052674727959"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥 在浏览器地址栏输入 URL 后，页面是怎么一步步显示出来的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/858052674727959/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    swipe
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T10:05:32.000Z" title="Sat Jan 24 2026 10:05:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<blockquote>
<p>这是一个<strong>前端面试 100% 会被问到的问题</strong>，<br/>
但也是一个<strong>90% 的人答不完整的问题</strong>。</p>
</blockquote>
<p>你可能会说：</p>
<ul>
<li>“DNS 解析”</li>
<li>“请求 HTML”</li>
<li>“解析 DOM”</li>
<li>“渲染页面”</li>
</ul>
<p>👉 <strong>但如果继续追问：</strong></p>
<ul>
<li>CSS 为什么会阻塞渲染？</li>
<li>JS 为什么会卡住页面？</li>
<li>回流和重绘到底差在哪？</li>
<li>浏览器内核到底在干嘛？</li>
</ul>
<p>很多人就开始“凭感觉回答了”。</p>
<p>这篇文章，我会用<strong>尽量通俗、不堆术语的方式</strong>，带你完整走一遍：</p>
<blockquote>
<p><strong>从你敲下回车，到页面真正出现在屏幕上，中间到底发生了什么？</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、先给结论：浏览器做了哪几件大事？</h2>
<p>不讲细节，<strong>先给你一条完整主线</strong>👇</p>
<p><strong>输入 URL → 页面展示，大致分 9 步：</strong></p>
<ol>
<li>解析 URL（域名 / IP）</li>
<li>DNS 解析（域名 → IP）</li>
<li>向服务器请求 HTML（通常是 index.html）</li>
<li>解析 HTML，生成 DOM Tree</li>
<li>解析 CSS，生成 CSSOM Tree</li>
<li>DOM + CSSOM → Render Tree</li>
<li>Layout（计算位置和大小）</li>
<li>Paint（绘制像素）</li>
<li>Composite（图层合成，GPU 加速）</li>
</ol>
<p>你现在只需要记住一句话：</p>
<blockquote>
<p><strong>浏览器做的事情，本质上就是：<br/>
把“代码”一步步变成“像素”。</strong></p>
</blockquote>
<p>后面我们逐个拆。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8f04bae5442453b88f3edc9b05019c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769853932&amp;x-signature=J1qkoKVQw92FPLG04C%2F6rZpTGb8%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">二、URL、域名、IP、DNS：浏览器是怎么找到服务器的？</h2>
<h3 data-id="heading-2">1️⃣ IP 是什么？</h3>
<p>一句话：</p>
<blockquote>
<p><strong>IP 地址 = 服务器在互联网上的门牌号</strong></p>
</blockquote>
<p>比如：<br/>
<code>101.34.243.124</code></p>
<ul>
<li>公网 IP 在整个互联网中是唯一的</li>
<li>只要你知道 IP，就能直接访问服务器</li>
</ul>
<hr/>
<h3 data-id="heading-3">2️⃣ 那为什么还要域名？</h3>
<p>因为 IP：</p>
<ul>
<li>难记</li>
<li>不符合人类直觉</li>
</ul>
<p>所以就有了：</p>
<ul>
<li><code>google.com</code></li>
<li><code>baidu.com</code></li>
<li><code>juejin.cn</code></li>
</ul>
<p>👉 <strong>域名，本质上就是 IP 的“别名”</strong></p>
<hr/>
<h3 data-id="heading-4">3️⃣ DNS 到底在干嘛？</h3>
<p>DNS 只干一件事：</p>
<blockquote>
<p><strong>把「好记的域名」翻译成「真实的 IP 地址」</strong></p>
</blockquote>
<p>流程非常简单：</p>
<pre><code class="hljs">你输入 juejin.cn
↓
DNS 查询
↓
得到一个 IP
↓
浏览器去这个 IP 对应的服务器请求资源
</code></pre>
<hr/>
<h3 data-id="heading-5">4️⃣ 公网 IP 和私有 IP 的区别</h3>
<ul>
<li>
<p><strong>公网 IP</strong></p>
<ul>
<li>全网唯一</li>
<li>能被外部访问</li>
</ul>
</li>
<li>
<p><strong>私有 IP</strong></p>
<ul>
<li>只在局域网内有效</li>
<li>学校 / 公司 / 家庭常见</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85e52b58adfb4981974c82e59ffcb605~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769853932&amp;x-signature=PXe1%2BJwbunYuc5lP8RkfJOe07Po%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-6">三、为什么浏览器一上来就请求 index.html？</h2>
<p>你有没有想过一个问题：</p>
<blockquote>
<p><strong>我明明只输入了域名，<br/>
为什么服务器知道要返回 index.html？</strong></p>
</blockquote>
<p>原因很简单：</p>
<ul>
<li>浏览器访问服务器后</li>
<li><strong>默认请求一个入口文件</strong></li>
<li>这个文件几乎永远叫：<code>index.html</code></li>
</ul>
<p>所以你会发现：</p>
<ul>
<li>Vue / React 项目最终都会打包出 <code>index.html</code></li>
<li>服务器部署的，其实是一堆<strong>静态资源</strong></li>
<li><strong>HTML 是一切渲染的起点</strong></li>
</ul>
<hr/>
<h2 data-id="heading-7">四、浏览器内核到底是什么？为什么老爱被问？</h2>
<p>很多人会说：</p>
<ul>
<li>Chrome 是 Blink 内核</li>
<li>Firefox 是 Gecko</li>
<li>Safari 是 WebKit</li>
</ul>
<p>那<strong>内核到底是啥？</strong></p>
<p>一句话解释：</p>
<blockquote>
<p><strong>浏览器内核 = 负责解析 HTML / CSS / JS，并把页面渲染出来的核心模块</strong></p>
</blockquote>
<p>也叫：<strong>渲染引擎（Rendering Engine）</strong></p>
<p>常见关系👇</p>

























<table><thead><tr><th>浏览器</th><th>内核</th></tr></thead><tbody><tr><td>Chrome / Edge / Opera</td><td>Blink</td></tr><tr><td>Safari</td><td>WebKit</td></tr><tr><td>Firefox</td><td>Gecko</td></tr><tr><td>IE</td><td>Trident（已淘汰）</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c440a761a034de9969cac51f6993c38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769853932&amp;x-signature=av670HMlg8J%2Fu0Y78iKonDBiUjU%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-8">五、浏览器是如何一步步把页面“画”出来的？</h2>
<p>这一部分是<strong>整个问题的核心</strong>。</p>
<h3 data-id="heading-9">1️⃣ 解析 HTML → DOM Tree</h3>
<ul>
<li>HTML 会被拆成一个个标签</li>
<li>标签会被转换成节点</li>
<li>最终形成一棵 <strong>DOM 树</strong></li>
</ul>
<p>👉 DOM 树描述的是：<strong>页面的结构</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a04f12e9a5bf46639563f2ed78e01ac9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769853932&amp;x-signature=t6ZCS7IuHq%2BXN6WrD49%2FLOT08iw%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-10">2️⃣ 解析 CSS → CSSOM Tree</h3>
<ul>
<li>遇到 <code>&lt;link&gt;</code>，浏览器会下载 CSS</li>
<li>CSS 会被解析成 <strong>CSSOM 树</strong></li>
</ul>
<p>⚠️ <strong>重点来了：</strong></p>
<blockquote>
<p>CSS <strong>不会阻塞 DOM 的解析</strong><br/>
但 <strong>会阻塞页面的渲染</strong></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/378c447f89024015a6e40b7fceac7c96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769853932&amp;x-signature=JnT263Cl6QPKUveRMuKxB7Exp7k%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-11">3️⃣ DOM + CSSOM → Render Tree</h3>
<ul>
<li>Render Tree 只包含<strong>需要显示的节点</strong></li>
<li><code>display: none</code> 的元素不会进入渲染树</li>
</ul>
<p>👉 Render Tree 描述的是：<strong>页面真正要画什么</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cf580ed72314737b8147df11bca4fba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769853932&amp;x-signature=MqZtx1Suv2uDZR2bAuM0izzZDII%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-12">4️⃣ Layout：计算位置和大小</h3>
<blockquote>
<p><strong>Layout 阶段，浏览器会计算：<br/>
每个元素在哪？多大？</strong></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c35bf2c18ba4d799214a92f2279491a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769853932&amp;x-signature=aKN3YvkFo7TheBHKvL7zoGpYLKM%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-13">5️⃣ Paint：真正开始画了</h3>
<blockquote>
<p>把布局结果，转换为屏幕上的像素</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">6️⃣ Composite：图层合成（性能关键）</h3>
<ul>
<li>页面会被拆成多个图层</li>
<li>GPU 参与合成</li>
<li>transform / opacity / video 等会创建新图层</li>
</ul>
<p>👉 <strong>合理使用能提升性能，滥用会吃内存</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/839ac5204f8f49b3aaf3d4f51c5fbf59~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc3dpcGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769853932&amp;x-signature=xEQiWB9PtEt9Oyo975Wy2i7XFWE%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-15">六、回流 &amp; 重绘：为什么页面会卡？</h2>
<h3 data-id="heading-16">🔁 回流（Reflow）</h3>
<p>一句话：</p>
<blockquote>
<p><strong>元素的位置或尺寸发生变化</strong></p>
</blockquote>
<p>常见触发场景：</p>
<ul>
<li>改 width / height</li>
<li>改 position / display</li>
<li>DOM 结构变化</li>
<li>读取布局信息（如 <code>getComputedStyle</code>）</li>
</ul>
<p>⚠️ <strong>回流一定会触发重绘</strong></p>
<hr/>
<h3 data-id="heading-17">🎨 重绘（Repaint）</h3>
<p>一句话：</p>
<blockquote>
<p><strong>只改外观，不改布局</strong></p>
</blockquote>
<p>例如：</p>
<ul>
<li>color</li>
<li>background-color</li>
<li>box-shadow</li>
<li>opacity</li>
</ul>
<p>👉 成本比回流小得多</p>
<hr/>
<h3 data-id="heading-18">🚀 常见性能优化建议</h3>
<ul>
<li>一次性修改样式（class / cssText）</li>
<li>减少 DOM 操作</li>
<li>避免频繁读取布局信息</li>
<li>合理使用 <code>position: absolute / fixed</code></li>
<li>谨慎创建合成层</li>
</ul>
<hr/>
<h2 data-id="heading-19">七、最后用一句话总结</h2>
<blockquote>
<p><strong>浏览器渲染的本质就是：</strong><br/>
<strong>HTML → DOM → CSSOM → Render Tree → Layout → Paint → Composite</strong></p>
</blockquote>
<p>如果你真正理解了这条链路：</p>
<ul>
<li>白屏问题</li>
<li>页面卡顿</li>
<li>动画掉帧</li>
<li>script / link 阻塞</li>
<li>回流 &amp; 重绘优化</li>
</ul>
<p>都会变得<strong>非常清晰</strong>。</p>
<hr/>
<h2 data-id="heading-20">下篇预告</h2>
<p>这篇我们讲的是：</p>
<blockquote>
<p><strong>浏览器 &amp; 渲染引擎</strong></p>
</blockquote>
<p>但还有一个主角没登场：</p>
<blockquote>
<p>👉 <strong>JavaScript 引擎（V8）</strong></p>
</blockquote>
<p>下篇会聊：</p>
<ul>
<li>JS 是谁执行的？</li>
<li>JS 为什么会阻塞渲染？</li>
<li>浏览器内核和 JS 引擎的关系？</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript：为 JavaScript 注入类型安全的工程化力量]]></title>    <link>https://juejin.cn/post/7598499504171073574</link>    <guid>https://juejin.cn/post/7598499504171073574</guid>    <pubDate>2026-01-24T09:46:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598499504171073574" data-draft-id="7598499504171057190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript：为 JavaScript 注入类型安全的工程化力量"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2026-01-24T09:46:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript：为 JavaScript 注入类型安全的工程化力量
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T09:46:14.000Z" title="Sat Jan 24 2026 09:46:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>JavaScript 以其灵活、动态的特性成为 Web 开发的基石，但这种“自由”在大型项目中往往演变为隐患。当函数参数类型不明、对象结构随意扩展、变量用途模糊不清时，代码便如同没有护栏的悬崖——看似畅通无阻，实则危机四伏。TypeScript（TS）作为 JavaScript 的超集，通过引入<strong>静态类型系统</strong>，在保留 JS 灵活性的同时，为开发者构建起一道坚固的质量防线。</p>
<h2 data-id="heading-0">弱类型的代价：隐藏在“简单”背后的陷阱</h2>
<p>JavaScript 是动态弱类型语言，变量类型在运行时才确定。这使得以下代码合法却危险：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">function</span> <span class="hljs-keyword">add</span>(a, b) {
  <span class="hljs-keyword">return</span> a <span class="hljs-operator">+</span> b;
}
const <span class="hljs-keyword">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">add</span>(<span class="hljs-number">10</span>, <span class="hljs-string">'10'</span>); <span class="hljs-operator">/</span><span class="hljs-operator">/</span> "1010"（字符串拼接）
</code></pre>
<p>开发者本意是数值相加，却因传入字符串导致隐式类型转换，结果出乎意料。这类“二义性”错误在小型脚本中或许无伤大雅，但在复杂业务逻辑中，可能引发难以追踪的 bug。</p>
<h2 data-id="heading-1">TypeScript 的解法：编译期类型检查</h2>
<p>TypeScript 通过类型注解，在<strong>代码编写和编译阶段</strong>就捕获潜在错误：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">addTs</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> a + b;
}
<span class="hljs-keyword">const</span> result2 = <span class="hljs-title function_">addTs</span>(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>); <span class="hljs-comment">// 正确</span>
<span class="hljs-comment">// addTs(10, '10'); // 编译报错：Argument of type 'string' is not assignable to parameter of type 'number'.</span>
</code></pre>
<p>类型签名 <code>a: number</code> 明确约束了参数类型，编辑器会立即提示错误，无需等到运行时才发现问题。这种“早发现、早修复”的机制，极大提升了代码健壮性。</p>
<h2 data-id="heading-2">基础类型与类型推导</h2>
<p>TS 提供丰富的内置类型，并支持类型自动推导：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">b</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'hello'</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">arr</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">let</span> <span class="hljs-attr">user</span>: [<span class="hljs-built_in">number</span>, <span class="hljs-built_in">string</span>, <span class="hljs-built_in">boolean</span>] = [<span class="hljs-number">1</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-literal">true</span>]; <span class="hljs-comment">// 元组</span>
</code></pre>
<p>即使省略显式注解，TS 也能根据初始值推断类型：</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">count</span> = <span class="hljs-number">100</span><span class="hljs-comment">; // 自动推导为 number</span>
// <span class="hljs-attr">count</span> = <span class="hljs-string">'100'</span><span class="hljs-comment">; // 错误！不能将 string 赋值给 number</span>
</code></pre>
<p>这种“写得少，检查多”的体验，让开发者既能享受简洁语法，又不失类型安全。</p>
<h2 data-id="heading-3">接口与自定义类型：描述复杂结构</h2>
<p>对于对象，TS 提供 <code>interface</code> 和 <code>type</code> 来定义结构契约：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUser</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 只读属性</span>
  hobby?: <span class="hljs-built_in">string</span>;      <span class="hljs-comment">// 可选属性</span>
}

<span class="hljs-keyword">let</span> <span class="hljs-attr">user3</span>: <span class="hljs-title class_">IUser</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">10</span>,
  <span class="hljs-attr">id</span>: <span class="hljs-number">1001</span>
};
<span class="hljs-comment">// user3.id = 1002; // 错误！id 是只读的</span>
</code></pre>
<p>接口清晰表达了对象应具备的字段及其约束，不仅防止非法赋值，还为 IDE 提供精准的智能提示和文档查看能力。</p>
<h2 data-id="heading-4">联合类型与泛型：应对多样性与复用</h2>
<p>TS 支持联合类型处理多可能性：</p>
<pre><code class="hljs language-ini" lang="ini">type <span class="hljs-attr">ID</span> = string | number<span class="hljs-comment">;</span>
let id: <span class="hljs-attr">ID</span> = <span class="hljs-number">1001</span><span class="hljs-comment">;</span>
<span class="hljs-attr">id</span> = <span class="hljs-string">'user_001'</span><span class="hljs-comment">; // 合法</span>
</code></pre>
<p>而泛型则实现类型级别的参数化，提升组件复用性：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">arr2</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>];
<span class="hljs-comment">// 或简写为 string[]</span>
</code></pre>
<p>泛型让函数、类、接口能适用于多种类型，同时保持类型安全，是构建通用库的核心工具。</p>
<h2 data-id="heading-5">安全的未知类型：unknown vs any</h2>
<p>面对不确定的类型，TS 提供 <code>unknown</code> 作为更安全的替代方案：</p>
<pre><code class="hljs language-ini" lang="ini">let bb: <span class="hljs-attr">unknown</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
<span class="hljs-attr">bb</span> = <span class="hljs-string">'hello'</span><span class="hljs-comment">;</span>
// bb.toUpperCase()<span class="hljs-comment">; // 错误！需先类型检查</span>
if (typeof <span class="hljs-attr">bb</span> === <span class="hljs-string">'string'</span>) {
  console.log(bb.toUpperCase())<span class="hljs-comment">; // 安全调用</span>
}
</code></pre>
<p>相比之下，<code>any</code> 会完全绕过类型检查，虽可作为迁移旧代码的“救命稻草”，但应尽量避免在新项目中使用。</p>
<h2 data-id="heading-6">工程价值：不止于防错</h2>
<p>TypeScript 的优势远超错误预防：</p>
<ul>
<li><strong>智能提示</strong>：输入对象属性时自动补全；</li>
<li><strong>重构安全</strong>：重命名变量或函数时，所有引用同步更新；</li>
<li><strong>代码导航</strong>：一键跳转到类型定义或实现；</li>
<li><strong>文档内嵌</strong>：类型本身就是最好的文档；</li>
<li><strong>垃圾清理</strong>：未使用的变量、导入会高亮提示。</li>
</ul>
<p>这些特性显著提升开发效率，尤其在团队协作和长期维护中，价值倍增。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elpis 项目 Webpack 配置详解]]></title>    <link>https://juejin.cn/post/7598477092197105702</link>    <guid>https://juejin.cn/post/7598477092197105702</guid>    <pubDate>2026-01-24T09:52:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598477092197105702" data-draft-id="7598477092197089318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elpis 项目 Webpack 配置详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-24T09:52:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小居673"/> <meta itemprop="url" content="https://juejin.cn/user/64206909220720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elpis 项目 Webpack 配置详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/64206909220720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小居673
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T09:52:07.000Z" title="Sat Jan 24 2026 09:52:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Elpis 项目 Webpack 配置详解</h2>
<p>本指南详细介绍了 Elpis 项目的 Webpack 5 构建系统设置，涵盖了从基础配置到生产环境优化的核心逻辑。</p>
<h3 data-id="heading-1">🏗️ 1. 核心架构</h3>
<p>项目采用 分层配置 模式，通过 webpack-merge 组合配置：</p>
<p>webpack.base.js: 基础配置，包含入口、解析路径、公用 Loader 和插件。</p>
<p>webpack.prod.js: 生产环境配置，侧重于性能优化、代码分割和资源压缩。</p>
<p>webpack.dev.js: 开发环境配置，侧重于开发体验、热更新和调试支持。</p>
<h3 data-id="heading-2">📦 2. 基础配置说明 (webpack.base.js)</h3>
<h5 data-id="heading-3">2.1 动态多入口 (Multi-Entry)</h5>
<p>项目通过 glob 自动扫描 app/pages/ *<em>/entry.</em> .js：</p>
<p>自动化: 每增加一个页面只需按照命名规范创建入口文件，Webpack 会自动识别。</p>
<p>模板关联: 利用 HtmlWebpackPlugin 为每个入口生成对应的 .tpl 模板文件。</p>
<h5 data-id="heading-4">2.2 核心 Loader 规则</h5>
<p>Vue 支持: 使用 vue-loader 处理 .vue 文件。</p>
<p>JS 转译: babel-loader 处理 ES6+ 语法，范围锁定在 ./app/pages 以提升速度。</p>
<p>样式处理:</p>
<p>支持 css 和 less。</p>
<p>生产环境下样式会被提取到独立文件，开发环境下通过 style-loader 内联。</p>
<p>资产模块 (Asset Modules):</p>
<p>使用 Webpack 5 的 asset 类型（替代 url-loader）。</p>
<p>内联策略: 小于 8KB 的图片自动转为 Base64 以减少 HTTP 请求。</p>
<h5 data-id="heading-5">2.3 解析与快捷路径 (Resolve)</h5>
<p>别名配置: @pages: app/pages</p>
<p>@common: app/pages/common</p>
<p>@widgets: app/pages/widgets</p>
<p>@store: app/pages/store</p>
<h4 data-id="heading-6">🚀 3. 生产环境优化 (webpack.prod.js)</h4>
<h5 data-id="heading-7">3.1 构建加速 (Speed)</h5>
<p>多进程打包 (HappyPack): 利用多核 CPU 并行处理 JS 和 CSS 转译。</p>
<p>代码压缩: TerserWebpackPlugin 开启并行压缩，并移除生产环境的 console.log。</p>
<h5 data-id="heading-8">3.2 资源优化 (Asset Optimization)</h5>
<p>代码分割 (Code Splitting):</p>
<p>vendor: 独立打包第三方依赖（axios, lodash 等）。</p>
<p>common: 提取被多次引用的业务公共模块。</p>
<p>runtimeChunk: 提取 Webpack 运行时代码，确保长效缓存。</p>
<p>CSS 提取: 使用 MiniCssExtractPlugin 提取样式，配合 CSSMinimizerPlugin 进行压缩。</p>
<h5 data-id="heading-9">3.3 目录清理</h5>
<p>配置了 CleanWebpackPlugin，保证每次 build 产物目录都是干净的。</p>
<h4 data-id="heading-10">🌗 4. 开发环境 vs 生产环境深度对比</h4>
<p>特性 开发环境 (Development) 生产环境 (Production)</p>
<p>核心目标 极致的开发体验与调试效率 极致的性能加载与线上稳定性</p>
<p>Mode mode: "development" (不压缩，原始名) mode: "production" (Tree Shaking，代码混淆)</p>
<p>Source Map eval-cheap-module-source-map (代码映射，方便定位) 通常禁用或使用独立文件 (保护源码，减小体积)</p>
<p>HMR 热更新 开启。代码保存即生效，不刷新页面且保持状态 关闭。代码全量打包，生成版本化静态资源</p>
<p>样式处理 内联注入 ，构建速度快 提取独立 CSS 文件，并行下载并利用缓存
</p><p>文件指纹 通常不带 Hash，或仅带简单的 contenthash 强缓存策略：[chunkhash:8] 确保版本管理稳定</p>
<p>调试信息 保留所有的 console.log 和注释 自动清理：Terser 插件移除所有调试输出</p>
<p>网络请求 指向本地 DevServer (<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A9002" target="_blank" title="http://localhost:9002" ref="nofollow noopener noreferrer">http://localhost:9002</a>) 指向 CDN 或生产静态资源路径</p>
<h4 data-id="heading-11">🛠️ 5. 开发环境配置 (webpack.dev.js) 深度解析</h4>
<p>该文件是开发阶段的核心，其核心逻辑在于建立浏览器与本地服务器的通信实时链路。</p>
<h5 data-id="heading-12">5.1 核心代码逻辑拆解</h5>
<ol>
<li>
<h6 data-id="heading-13">动态注入 HMR 客户端</h6>
</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">Object.keys(baseConfig.entry).forEach((v) =&gt; {
  if (v !== "vendor") {
    const { HOST, PORT, HMR_PATH, TIMEOUT } = DEV_SERVER_CONFIG<span class="hljs-comment">;</span>
    baseConfig.entry<span class="hljs-section">[v]</span> = <span class="hljs-section">[
      baseConfig.entry[v]</span>,
      // 关键：向每个业务入口注入 HMR 运行时的客户端代码
      `webpack-hot-middleware/client?<span class="hljs-attr">path</span>=http://<span class="hljs-variable">${HOST}</span>:<span class="hljs-variable">${PORT}</span>/<span class="hljs-variable">${HMR_PATH}</span>?timeout=<span class="hljs-variable">${TIMEOUT}</span>&amp;reload=<span class="hljs-literal">true</span>`,
    ]<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
</code></pre>
<p>为什么要做这一步？ Webpack 默认打包出来的 JS 是静态的。为了实现热更新，我们需要在浏览器里运行一段“监听代码”，这段代码通过 EventSource 连接到开发服务器。注入后，浏览器就知道如何接收服务器发来的更新信号。</p>
<ol start="2">
<li>
<h6 data-id="heading-14">调试利器：Source Map</h6>
</li>
</ol>
<p>devtool: "eval-cheap-module-source-map", 原理：eval 将每个模块包裹在 eval 字符串中，构建极快；cheap 忽略列信息只保留行信息；module 负责把 Loader（如 vue-loader）处理前的源代码映射出来。 效果：你在浏览器 F12 看到的是原汁原味的 .vue 文件，而不是编译后的 JS。</p>
<ol start="3">
<li>
<h6 data-id="heading-15">HMR 核心插件</h6>
</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino">plugins: [
  <span class="hljs-keyword">new</span> <span class="hljs-built_in">HotModuleReplacementPlugin</span>(), <span class="hljs-comment">// 开启 HMR API</span>
]
</code></pre>
<p>这个插件会在全局注入 module.hot 对象。只有有了这个对象，vue-loader 等程序才能调用 module.hot.accept() 接口来实现局部替换。</p>
<h5 data-id="heading-16">🔥 6. 热更新 (HMR) 核心原理深度阐述</h5>
<p>HMR 的核心不是“刷新”，而是“补丁式替换”。</p>
<h6 data-id="heading-17">6.1 底层通信流程</h6>
<p>Server 端 (监视者): Webpack 以 watch 模式启动。当你保存文件，Webpack 重新编译。</p>
<p>它不会生成新的大文件，而是生成两个小补丁：一个 [hash].hot-update.json（描述哪些模块变了）和一个 [chunk].[hash].hot-update.js（具体的变化代码）。</p>
<p>Middleware (快递员): webpack-hot-middleware 通过一条长连接（EventSource/WebSocket）推送一个消息给浏览器：“新版本 Hash 是 XXX”。</p>
<p>Client 端 (接收者): 浏览器里的 HMR Runtime 收到 Hash。</p>
<p>比对：发现和当前 Hash 不同。</p>
<p>下载清单：先下 .json 文件确认有哪些模块更新了。</p>
<p>载入补丁：动态创建 
</p><p>Runtime (施工员):</p>
<p>查找接口：Webpack 运行环境会查找代码中是否定义了 module.hot.accept。</p>
<p>代码替换：如果定义了（Vue 和 React 的 Loader 都会自动帮你加上），它会把内存中旧的模块定义删掉，换成补丁里的新定义，并重新执行该模块。</p>
<h5 data-id="heading-18">🍕 7. 代码分割</h5>
<p>代码分割是 Webpack 优化中最关键的一环。核心目标是：不要让用户一次性下载一个超大的 JS 文件，而是将其拆分成多个小文件，按需加载或利用并发下载。</p>
<h6 data-id="heading-19">7.1 为什么要进行代码分割？</h6>
<p>利用并发下载：浏览器可以同时下载多个小文件，比下载一个大文件快。</p>
<p>缓存：将几乎不动的第三方库（Vue, Lodash）和经常变动的业务代码分开。当你改了业务代码，用户只需要重新下载几 KB 的业务包，而几十 MB 的第三方库依</p>
<p>然使用浏览器缓存。</p>
<p>按需加载：只加载当前页面需要的代码，减少首屏负担。</p>
<h6 data-id="heading-20">7.2 项目中的 SplitChunks 配置拆解</h6>
<p>在 webpack.base.js 的 optimization 中，配置了三个关键部分：</p>
<ol>
<li>
<h6 data-id="heading-21">vendor (第三方库)</h6>
</li>
</ol>
<p>配置: test: /[/]node_modules[/]/ 作用: 专门把从 node_modules 引入的所有库打包进 vendor.js。 策略: 这些库（如 Element Plus, Axios）版本通常是固定的，适合设置强缓存（Max-Age 一年）。</p>
<ol start="2">
<li>
<h6 data-id="heading-22">common (公用业务代码)</h6>
</li>
</ol>
<p>配置: minChunks: 2, minSize: 1 作用: 如果你写了一个 utils.js 工具函数，且被两个以上的页面入口 import 了，它就会被自动提取到 common.js 中。 优点: 防止重复打包。如果没有这一步，每个页面的 bundle 里都会包含一份一模一样的工具函数。</p>
<ol start="3">
<li>
<h6 data-id="heading-23">runtimeChunk: true (运行时代码)</h6>
</li>
</ol>
<p>作用: 这会生成一个类似 runtime~main.js 的微型文件。 深度原理解析: Webpack 打包时会给每个模块分配 ID。模块 A 引用模块 B 时，内部记录的是 ID。 问题: 如果不提取 runtime，模块 B 变了，模块 A 里的 ID 映射也会变，导致模块 A 的 Hash 也失效。 解决: 提取 runtime 后，所有的模块映射关系都存在这个小文件里。哪怕业务代码变了，只要模块依赖关系没变，其他文件的 Hash 就能保持稳定。</p>
<h6 data-id="heading-24">7.3 代码分割示意图 (前后对比)</h6>
<p>打包方式 产物结构 浏览器行为</p>
<p>不分割 main.js (2MB) 改一行代码，用户得重下 2MB。</p>
<p>分割后 vendor.js (1.8MB) + common.js (100KB) + page.js (10KB) 改一行代码，用户只重下 10KB。</p>
<h5 data-id="heading-25">⚡ 8. 建议优化方向</h5>
<p>更换现代化 Loader: 将 HappyPack 迁移至 thread-loader。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin协程进阶王炸之作-Kotlin的协程到底是什么]]></title>    <link>https://juejin.cn/post/7598499504171139110</link>    <guid>https://juejin.cn/post/7598499504171139110</guid>    <pubDate>2026-01-24T10:03:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598499504171139110" data-draft-id="7598435950411415562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin协程进阶王炸之作-Kotlin的协程到底是什么"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2026-01-24T10:03:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="马孔多的炼金术师"/> <meta itemprop="url" content="https://juejin.cn/user/4469974689386972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin协程进阶王炸之作-Kotlin的协程到底是什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4469974689386972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    马孔多的炼金术师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T10:03:38.000Z" title="Sat Jan 24 2026 10:03:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>kotlin</code>协程推出至今已成为 Android 开发人员的必备技能，但直到今天仍然有很多关于kotlin协程底层的争议。本篇文章围绕kotlin协程底层结合着一些基础讲解，希望可以探究明白kotlin到底是什么，当然，笔者知识有限而如果有不周错误之处希望大家指出。</p>
<p>很多语言中都有协程这一概念，很多人把这些不同语言的协程混为一谈，统称协程是 “<strong>轻量级线程</strong>” 。但深究其理，<strong>像 Go 那样具有独立栈的协程真正作为代码运行单元的</strong>协程才能说是轻量级线程，像kotlin这种语言层面实现的无栈协程，只能说是<strong>轻量级任务</strong>，kotlin协程是依靠<strong>状态机模拟栈</strong>实现的，完全不符合轻量级线程的定义，下面会详细说到。</p>
<h2 data-id="heading-0">协程的启动</h2>
<p>协程本质上 = Context + Job + Dispatcher + Continuation。其中<code>Job</code>和<code>Dispatcher</code>是<code>Context</code>的核心元素，这部分和协程作用域密切相关，放在<strong>作用域</strong>的内容中。<code>Continuation</code>(续体)是解决回调地狱的重要元素，放在解决<strong>回调地狱</strong>的内容中。这里先看一下协程的三种启动方式</p>
<ol start="0">
<li><code>runBlocking：</code> 启动一个新的协程并阻塞调用它的线程，直到里面的代码执行完毕,返回值是协程体中的最后一行。<strong>但是只能在当前线程运行事件循环</strong>，一般仅用在调试阶段，不会用于实际开发。</li>
<li><code>launch：</code> 启动一个协程但不会阻塞调用线程,必须要在协程作用域(<code>CoroutineScope</code>)中才能调用。无业务返回值(业务返回值的定义是<strong>函数或协程执行完成后，向调用方返回的、与具体业务逻辑相关的结果数据</strong>)，<code>launch</code>返回的<code>Job</code>是一个协程的句柄，下面协程作用域会详细说。</li>
<li><code>async:Deferred&lt;T&gt;</code> 启动一个协程但不会阻塞调用线程,必须要在协程作用域(<code>CoroutineScope</code>)中才能调用。以<code>Deferred</code>对象的形式返回协程任务。<code>Deferred</code>是<code>Job</code>的子接口，可以通过<code>await</code>方法得到协程体中最后一行的业务返回值。</li>
</ol>
<h2 data-id="heading-1">协程作用域</h2>
<p>协程作用域本质是一个<strong>管理协程的容器</strong>，<strong>核心作用就是规定其所管理协程的生命周期</strong>，避免内存泄漏或程序崩溃。通过<code>runBlocking</code>、<code>launch</code>和<code>async</code>启动的协程体等同于协程作用域，支持嵌套启动任意多的子协程，这也就是<strong>结构化并发</strong>，当父任务完成或者异常终止时，子任务也会相应地被处理。</p>
<h3 data-id="heading-2">内置作用域</h3>
<p>安卓开发有如下内置的作用域</p>
<ul>
<li>
<ol start="0">
<li><code>runBlocking</code>：阻塞式作用域（测试 / 主线程临时阻塞）</li>
</ol>
</li>
</ul>
<p><code>runBlocking</code> 不是普通的 <code>CoroutineScope</code>，但它会创建一个<strong>阻塞当前线程的协程作用域</strong>，直到作用域内所有协程执行完毕。因此仅用于<strong>测试代码</strong>或 <code>main</code> 函数，严禁在安卓主线程 / 生产代码中使用（会阻塞线程）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// runBlocking 构建的作用域，阻塞当前线程</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testRunBlockingScope</span><span class="hljs-params">()</span></span> = runBlocking {
    launch { <span class="hljs-comment">// 继承 runBlocking 的作用域</span>
        delay(<span class="hljs-number">1000</span>)
        Log.d(<span class="hljs-string">"scope"</span>, <span class="hljs-string">"runBlocking 内的协程"</span>)
    }
}
</code></pre>
<ul>
<li>
<ol start="2">
<li><code>GlobalScope</code>：全局作用域</li>
</ol>
</li>
</ul>
<p><code>GlobalScope</code> 是 Kotlin 提供的<strong>全局静态作用域</strong>，生命周期与应用进程绑定，无法自动取消，容易导致内存泄漏。启动的协程不受任何组件生命周期管理，即使页面销毁，协程仍会运行。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testGlobalScope</span><span class="hljs-params">()</span></span> {
    GlobalScope.launch { <span class="hljs-comment">// 全局作用域的协程</span>
        delay(<span class="hljs-number">1000</span>)
        Log.d(<span class="hljs-string">"scope"</span>, <span class="hljs-string">"GlobalScope 协程"</span>)
    }
}
</code></pre>
<ul>
<li>
<ol start="3">
<li>安卓官方库提供的与组件生命周期绑定的作用域，<strong>协程会随组件销毁自动取消</strong>，是安卓开发的首选</li>
</ol>
</li>
</ul>




















<table><thead><tr><th>作用域</th><th>绑定的组件</th><th>用途</th></tr></thead><tbody><tr><td><code>lifecycleScope</code></td><td><code>Activity</code>/<code>Fragment</code></td><td>执行与页面生命周期绑定的协程（比如请求数据、更新 UI）</td></tr><tr><td><code>viewModelScope</code></td><td><code>ViewModel</code></td><td>执行与 <code>ViewModel</code> 生命周期绑定的协程（比如数据请求，页面销毁后 <code>ViewModel</code> 仍存活时协程继续）</td></tr></tbody></table>
<h3 data-id="heading-3">自定义作用域</h3>
<p>除了系统内置的作用域外，我们还可以自定义协程作用域。我们可以理解协程作用域是为协程制定<strong>统一的运行规则</strong>（比如默认跑在哪个线程、异常怎么处理、什么时候全部取消），而 “自定义作用域” 就是我们自己来制定这些规则，想要自己制定规则，我们有必要继续深挖一下<strong>协程作用域</strong></p>
<p>协程作用域<code>CoroutineScope</code>本身是一个接口，源码极其简洁。<code>CoroutineScope</code>的核心只有一个属性<code>coroutineContext</code>。因此，<code>CoroutineScope</code>包含的“内容”本质上是 <code>coroutineContext</code>所封装的协程上下文元素。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CoroutineScope</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> coroutineContext: CoroutineContext
}
</code></pre>
<p><code>CoroutineContext</code>（协程上下文）是一个键值对集合，主要由如下几个元素组成。</p>
<ul>
<li>
<ol start="0">
<li><strong>Job（作业）：协程生命周期的管理者</strong></li>
</ol>
</li>
</ul>
<p><code>Job</code>是 <code>CoroutineContext</code>的核心元素之一，提供了<strong>控制协程生命周期（启动、取消、等待完成）、查询状态（是否活跃 / 完成 / 取消）的所有接口</strong>，协程构建器（<code>launch</code>/<code>async</code>）都会返回 <code>Job</code> 相关对象，Job的生命周期如下。</p>








































<table><thead><tr><th>状态</th><th>说明</th><th>对应属性</th></tr></thead><tbody><tr><td>New（新建）</td><td>协程已创建但未启动（仅手动创建 Job 时会出现，<code>launch</code> 会自动启动）</td><td><code>isActive = false</code></td></tr><tr><td>Active（活跃）</td><td>协程正在执行</td><td><code>isActive = true</code></td></tr><tr><td>Completing</td><td>协程执行完毕，但子 Job 还未完成（内部状态，对外表现为 Active）</td><td>-</td></tr><tr><td>Cancelling</td><td>协程被取消，正在执行收尾逻辑（如 <code>finally</code>）</td><td><code>isCancelled = true</code></td></tr><tr><td>Cancelled</td><td>协程已取消且收尾完成</td><td><code>isCompleted = true</code> + <code>isCancelled = true</code></td></tr><tr><td>Completed</td><td>协程正常执行完毕（无取消、无异常）</td><td><code>isCompleted = true</code> + <code>isCancelled = false</code></td></tr></tbody></table>
<p>对于<strong>可取消的<code>Job</code></strong>(有挂起点，如 <code>delay()</code>、<code>withContext()</code> )，可以直接调用<code>job.cancel()</code>取消，终止整个协程。</p>
<p>每个协程对应一个 <code>Job</code>，作用域的 <code>Job</code>通常作为“父 Job”，其管理的所有子协程（通过作用域启动的协程）会形成<strong>父子 Job 树</strong>，父 Job 取消时所有子 Job 会被级联取消（结构化并发的核心），并且<strong>普通<code>Job</code>会因子协程异常导致父级失效</strong>，前者是为了避免资源泄漏程序崩溃的有利设计，后者则完全不符合业务逻辑。</p>
<p>因此在<code>Job</code>的基础上诞生了一个特殊的子类<code>SupervisorJob</code>，重写了异常传播逻辑：当子协程抛出未捕获的异常时，异常仅终止当前子协程，不会传播到父 <code>SupervisorJob</code>，父级和其他子协程可以继续执行。</p>
<p>像上面安卓内置的**<code>lifecycleScope</code>和<code>viewModelScope</code>就用的是<code>SupervisorJob</code>**</p>
<ul>
<li>
<ol start="2">
<li><strong>Dispatcher（调度器）：协程运行的线程/线程池</strong></li>
</ol>
</li>
<li>
<p><code>Dispatcher</code>（调度器）决定了协程<strong>运行的线程或线程池</strong>。它是 <code>CoroutineContext</code>中最常用的元素之一，通过 <code>Dispatchers</code>工厂类创建。常见调度器如下</p>
<ul>
<li><code>Dispatchers.Main</code>：主线程（适用于 Android UI 更新、iOS 主线程等）；</li>
<li><code>Dispatchers.IO</code>：IO 线程池（适用于网络请求、文件读写、数据库操作等阻塞 IO 任务）；</li>
<li><code>Dispatchers.Default</code>：CPU 密集型线程池（适用于复杂计算、排序、解析等 CPU 密集型任务）；</li>
<li><code>Dispatchers.Unconfined</code>：无固定调度器（协程在当前线程启动，挂起后恢复时可能切换到其他线程，慎用）。</li>
</ul>
</li>
<li>
<ol start="3">
<li><strong>CoroutineExceptionHandler异常处理机制</strong></li>
</ol>
</li>
</ul>
<p><code>CoroutineExceptionHandler</code>用于<strong>处理作用域内未try-catch捕获的异常</strong>（仅对“根协程”有效，子协程的异常需通过其他方式处理）。当协程抛出未捕获的异常（如 <code>RuntimeException</code>）时，异常处理器会被触发，一般就用作日志记录。注意，<strong>对于try-catch捕获了的异常，是不会触发<code>CoroutineExceptionHandler</code>的。</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> handler = CoroutineExceptionHandler { _, e -&gt;
    println(<span class="hljs-string">"捕获异常: <span class="hljs-variable">$e</span>"</span>)
}
​
<span class="hljs-keyword">val</span> scope = CoroutineScope(
    SupervisorJob() +
    Dispatchers.IO +
    handler
)
<span class="hljs-comment">//会触发CoroutineExceptionHandler</span>
scope.launch {
    <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Oops!"</span>) <span class="hljs-comment">// 未被捕获的异常</span>
}
</code></pre>
<p>用<code>launch</code>启动协程遇到未捕捉的异常直接就触发<code>CoroutineExceptionHandler</code>了，但是对于<code>async</code>启动的协程，<code>async</code> 会<strong>暂存异常</strong>，直到调用 <code>.await()</code> 时才抛出。如果不<code>await</code>仍然不会触发<code>CoroutineExceptionHandler</code>。</p>
<pre><code class="hljs language-dart" lang="dart">val <span class="hljs-keyword">deferred</span> = <span class="hljs-keyword">async</span> { 
    <span class="hljs-keyword">throw</span> IOException() 
}
<span class="hljs-comment">//异常被暂存，不会触发 CoroutineExceptionHandler</span>
​
<span class="hljs-comment">// 必须await</span>
<span class="hljs-keyword">deferred</span>.<span class="hljs-keyword">await</span>() <span class="hljs-comment">// 异常未被捕获，向上传播</span>
</code></pre>
<ul>
<li>4.取消模型</li>
</ul>
<p>普通子协程的 Job 执行完任务才会自动结束，我们使用自定义的协程作用域并不能关联页面的生命周期，当用户退出某个耗时页面不希望再进行时，如果不手动取消该协程仍然会进行下去，因此一般补充一个取消的方法</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span> {
        job.cancel()
    }
</code></pre>
<p>综合以上几点，我们把以上的几个要点全部组装一起，就写出一个标准的Scope了</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UseCaseScope</span>(
    dispatcher: CoroutineDispatcher
) : CoroutineScope {
​
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> job = SupervisorJob()
​
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> coroutineContext =
        job +
        dispatcher +
        CoroutineName(<span class="hljs-string">"UseCaseScope"</span>)
​
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span> {
        job.cancel()
    }
}
</code></pre>
<h2 data-id="heading-4">解决回调地狱</h2>
<p>回调地狱，即多层回调嵌套的问题，例如获取用户信息 → 根据用户 ID 获取订单 → 根据订单 ID 获取商品详情，我们需要将下游函数嵌套在上游函数的回调中。对这样的代码很容易牵一发动全身，导致代码难以维护。Kotlin为解决这个问题采用了<strong>底层构建函数</strong><code>suspendCancellableCoroutine</code>，用于<strong>将基于回调（Callback）或 Future 的异步 API 封装成 <code>suspend</code> 函数</strong>，从而让传统异步代码能无缝融入协程世界。</p>
<p>要了解回调地狱的底层逻辑，还需要学习协程的底层逻辑，深入状态机和<code>continuation</code>续体。简单来说，状态机就是把代码拆成“状态”，按顺序一步步走。而<code>continuation</code>内部1.<strong>包装了跨挂起点仍然存活的局部变量</strong>和<strong>当前执行位置</strong>的对象，2.<strong>协程上下文（CoroutineContext）</strong> 3.<strong>恢复执行的逻辑（<code>resumeWith</code>方法）</strong> 。具体看下面例子</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 原始挂起函数</span>
<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fetchData</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">val</span> data1 = loadFromNetwork() <span class="hljs-comment">// 挂起点1（假设 loadFromNetwork 是挂起函数）</span>
    <span class="hljs-keyword">val</span> data2 = process(data1)    <span class="hljs-comment">// 普通代码（非挂起）</span>
    <span class="hljs-keyword">val</span> data3 = loadFromDb(data2) <span class="hljs-comment">// 挂起点2（假设 loadFromDb 是挂起函数）</span>
    <span class="hljs-keyword">return</span> data3
}
​
<span class="hljs-comment">//业务代码</span>
<span class="hljs-keyword">object</span> UserRepositoryCoroutine {
    <span class="hljs-comment">// 1. 封装验证输入为挂起函数</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadFromNetwork</span><span class="hljs-params">(input: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> suspendCancellableCoroutine { continuation -&gt;
            UserRepository.loadFromNetwork(input, <span class="hljs-keyword">object</span> : ValidateCallback {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLoadFromNetworkSuccess</span><span class="hljs-params">(input: <span class="hljs-type">String</span>)</span></span> {
                    continuation.resume(input) <span class="hljs-comment">// 成功了，恢复协程，返回结果</span>
                }
​
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLoadFromNetwork</span><span class="hljs-params">(msg: <span class="hljs-type">String</span>)</span></span> {
                    continuation.resumeWithException(IllegalArgumentException(msg))
                }
            })
        }
    }
​
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadFromDb</span><span class="hljs-params">(token: <span class="hljs-type">String</span>)</span></span>: UserInfo {
        <span class="hljs-keyword">return</span> suspendCancellableCoroutine { continuation -&gt;
            UserRepository.loadFromDb(token, <span class="hljs-keyword">object</span> : UserInfoCallback {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLoadFromDbSuccess</span><span class="hljs-params">(userInfo: <span class="hljs-type">UserInfo</span>)</span></span> {
                    continuation.resume(userInfo)
                }
​
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLoadFromDbError</span><span class="hljs-params">(msg: <span class="hljs-type">String</span>)</span></span> {
                    continuation.resumeWithException(SecurityException(msg))
                }
            })
        }
    }
​
}
</code></pre>
<p>上面挂起函数代码和业务代码经过编译器编译后会转换为类似如下的状态机逻辑。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FetchDataStateMachine</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> completion: Continuation&lt;String&gt;
) : Continuation&lt;String&gt; {
    <span class="hljs-keyword">var</span> state = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> data1: String? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">var</span> data2: String? = <span class="hljs-literal">null</span>
​
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">resumeWith</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
        <span class="hljs-keyword">val</span> outcome = invokeSuspend(result) <span class="hljs-comment">// 实际编译器生成的入口方法</span>
        <span class="hljs-keyword">if</span> (outcome === COROUTINE_SUSPENDED) <span class="hljs-keyword">return</span> <span class="hljs-comment">// 挂起时直接返回</span>
        
        <span class="hljs-comment">// 非挂起情况处理结果</span>
        completion.resumeWith(outcome)
    }
​
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">invokeSuspend</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span>: Any? {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">when</span> (state) {
                <span class="hljs-number">0</span> -&gt; {
                    state = <span class="hljs-number">1</span> 
                    <span class="hljs-keyword">val</span> r = loadFromNetwork(<span class="hljs-keyword">this</span>) <span class="hljs-comment">//传入当前状态机状态，检查是否挂起</span>
                    <span class="hljs-keyword">if</span> (r === COROUTINE_SUSPENDED) {
                        <span class="hljs-keyword">return</span> COROUTINE_SUSPENDED 
                    }
                   <span class="hljs-comment">// 调用挂起函数返回 COROUTINE_SUSPENDED,这里暂停执行释放线程，当前协程的                           Continuation 被保存起来，直到该挂起函数调用resume()，然后继续以                              Dispatcher选择的线程来执行它</span>
                }
                <span class="hljs-number">1</span> -&gt; {
                    data1 = result.getOrThrow()
                    data2 = process(data1!!)<span class="hljs-comment">//非挂起函数，继续执行</span>
                    state = <span class="hljs-number">2</span>
                    loadFromDb(data2!!, <span class="hljs-keyword">this</span>)
                    <span class="hljs-keyword">if</span> (r === COROUTINE_SUSPENDED) {
                        <span class="hljs-keyword">return</span> COROUTINE_SUSPENDED  
                    }
                    <span class="hljs-comment">// loadFromDb 挂起，同上</span>
                }
                <span class="hljs-number">2</span> -&gt; {
                    <span class="hljs-keyword">val</span> data3 = result.getOrThrow()
                    <span class="hljs-comment">// 最终返回结果，不再挂起</span>
                    data3 
                }
                <span class="hljs-keyword">else</span> -&gt; error(<span class="hljs-string">"Invalid state"</span>)
            }
        } <span class="hljs-keyword">catch</span> (e: Throwable) {
            CoroutineSingletons.RESUME_WITH_EXCEPTION
        }
    }
}
​
<span class="hljs-comment">//业务代码的状态机伪代码，以loadFromNetwork为例</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoadFromNetworkStateMachine</span>(
    initialValue: String,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> completion: Continuation&lt;String&gt; <span class="hljs-comment">// 这个 completion 是外层 fetchData 的 continuation</span>
) : ContinuationImpl {
    <span class="hljs-keyword">var</span> state = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> input: String? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> continuationFromSuspendCancellable: Continuation&lt;String&gt; <span class="hljs-comment">//代码里的那个 continuation</span>
​
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">invokeSuspend</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span>: Any? {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">when</span> (state) {
                <span class="hljs-number">0</span> -&gt; {
                    <span class="hljs-keyword">this</span>.input = initialValue
                    state = <span class="hljs-number">1</span>
                    <span class="hljs-comment">// 1. 创建一个 Continuation 给 suspendCancellableCoroutine 的 lambda</span>
                    <span class="hljs-keyword">val</span> myLocalContinuation = <span class="hljs-keyword">object</span> : Continuation&lt;String&gt; {
                        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">resumeWith</span><span class="hljs-params">(result: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
                            <span class="hljs-comment">// 2. 当这个 myLocalContinuation.resumeWith 被调用时</span>
                               <span class="hljs-comment">//其实就是你在外层回调里调用 continuation.resume(input) 触发的                                   这会再次进入 invokeSuspend，但 state 已经是 1 了</span>
                            invokeSuspend(result)
                        }
                    }
                    <span class="hljs-comment">// 3. 把 myLocalContinuation 传给 validateInput 的回调</span>
                    UserRepository.validateInput(<span class="hljs-keyword">this</span>.input, <span class="hljs-keyword">object</span> : ValidateCallback {
                        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLoadFromNetworkSuccess</span><span class="hljs-params">(input: <span class="hljs-type">String</span>)</span></span> {
                            <span class="hljs-comment">// 手动调用，它实际上调用的是 myLocalContinuation.resume(input)</span>
                            myLocalContinuation.resume(input)
                        }
                        <span class="hljs-comment">// ...</span>
                    })
                    <span class="hljs-keyword">return</span> COROUTINE_SUSPENDED
                }
                <span class="hljs-number">1</span> -&gt; {
                    <span class="hljs-comment">// 5. 当 myLocalContinuation.resume(input) 被调用后，程序会跳到这里</span>
                    <span class="hljs-keyword">val</span> result = result.getOrThrow()
                    <span class="hljs-comment">// 6. 将结果返回给最初调用 loadFromNetwork 的地方（也就是 fetchData 函数）</span>
                    completion.resume(result)
                    <span class="hljs-keyword">return</span> result
                }
                <span class="hljs-keyword">else</span> -&gt; error(<span class="hljs-string">"..."</span>)
            }
        } <span class="hljs-keyword">catch</span> (e: Throwable) {
            completion.resumeWithException(e)
        }
    }
}
</code></pre>
<p>从这里我们可以看出，Kotlin 协程的本质是<strong>编译器的语法糖</strong>—— 编译器会把包含挂起操作的 <code>suspend</code> 函数自动编译成一个<strong>有限状态机</strong>，每个挂起点都对应一个状态。</p>
<p><strong>因为JVM 不允许也无法安全地捕获和恢复线程调用栈，所以编译器把 suspend 函数转换成状态机，用 Continuation 对象模拟栈帧。</strong> 上面的代码完全是栈帧的操作，保存执行上下文（局部变量 + 执行位置）+ 控制执行流程的功能如出一辙。</p>
<p>而整个回调的过程的核心就是挂起函数返回<code>COROUTINE_SUSPENDED</code>，<code>if (outcome === COROUTINE_SUSPENDED) return</code>此时 <code>if</code>条件为真，于是 <code>resumeWith</code>自己也 <code>return</code>了。至此，整个协程的本次执行周期结束了。线程被释放，可以去执行其他任务（比如渲染UI、处理别的协程）。<strong>但是 <code>FetchDataStateMachine</code>对象并没有被销毁，</strong> 它作为一个 <code>Continuation</code>对象，其内部的状态（<code>state=1</code>, <code>data1=null</code>等）都被完整地保留了下来。</p>
<p>当挂起的回调函数成功时调用<code>continuation.resume(input)</code>，实际上是重新调用 <code>invokeSuspend(result)</code>以回到原来的协程域里继续执行下面的代码。这就是协程回调将异步代码 “伪装” 成同步代码的底层逻辑。</p>
<h2 data-id="heading-5">Kotlin的协程到底是什么</h2>
<p>在看完上面的内容基本了解了kotlin协程的底层逻辑后，我们大概知道kotlin协程的原理。开篇说了，kotlin实现的是语言层面的无栈协程，因此轻量级线程完全不适用于kotlin的协程，只能说是<strong>轻量级任务</strong>。Kotlin 协程的<strong>挂起、恢复、调度</strong>都是以<strong>函数</strong>（挂起函数 <code>suspend fun</code>）为基本单位的，协程的执行流程被拆解为多个挂起函数的调用链，而非像线程那样以 “整个执行体” 为单位调度，它真正的并发能力来自“挂起不占线程”，而不是线程池本身。</p>
<p><strong>但是！上面一切都围绕着挂起函数来说的，如果有 10,000 个协程任务，而且里面完全没有任何挂起点（纯 CPU 计算）， Kotlin 协程还能否像 Go 协程一样高效调度？</strong> 答案是<strong>不能。</strong> 此时10,000 个任务会被放入线程池队列由N 个工作线程（≈ CPU 核心数）执行，一个线程一次跑一个任务，跑完才能换下一个。这正是 Kotlin 协程不是轻量级线程的铁证。</p>
<p>最后总结一下，Kotlin 并没有改变 JVM 的线程模型，它只是通过语言层面的突破，让函数可以中途返回并在未来恢复执行，从而实现“挂起不占线程”，用少量线程复用大量 I/O 任务。一旦协程内部没有挂起点，它就会退化为普通线程池任务， 这也是 Kotlin 协程无法被视为“轻量级线程”的根本原因。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【技术专题】Scikit-learn Python机器学习 - 特征工程之特征预处理]]></title>    <link>https://juejin.cn/post/7598477092197056550</link>    <guid>https://juejin.cn/post/7598477092197056550</guid>    <pubDate>2026-01-24T09:16:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598477092197056550" data-draft-id="7598532592455680027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【技术专题】Scikit-learn Python机器学习 - 特征工程之特征预处理"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-24T09:16:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小锋java1234"/> <meta itemprop="url" content="https://juejin.cn/user/4152222342709933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【技术专题】Scikit-learn Python机器学习 - 特征工程之特征预处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4152222342709933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小锋java1234
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T09:16:15.000Z" title="Sat Jan 24 2026 09:16:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是锋哥。最近连载更新《Scikit-learn Python机器学习》技术专题。 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80fb5634d09745f6a8806c075a4416fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769850975&amp;x-signature=g%2BZ8pbJJ668Sr3dn9qOEKasZsX4%3D" alt="image.png" loading="lazy"/> 本课程主要讲解基于Scikit-learn的Python机器学习知识，包括机器学习概述，特征工程(数据集，特征抽取，特征预处理，特征降维等)，分类算法(K-临近算法，朴素贝叶斯算法，决策树等)，回归与聚类算法(线性回归，欠拟合，逻辑回归与二分类，K-means算法)等。 同时也配套视频教程<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV11reUzEEPH%2F" title="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV11reUzEEPH%2F" target="_blank">《Scikit-learn Python机器学习 视频教程》</a></p>
<p>特征预处理就是将原始数据转换为一组更具代表性、更适合模型训练的特征的过程。</p>
<p>真实世界的数据通常存在以下问题，直接影响机器学习模型的性能：</p>
<ol start="0">
<li><strong>量纲不同</strong>：特征的单位和尺度差异巨大（如年龄范围 0-100 vs. 薪资范围 0-100000）。很多模型（如 SVM、KNN、线性回归）基于距离计算，量纲不统一会使得大尺度的特征主导模型，导致小尺度的特征失效。</li>
<li><strong>分布异常</strong>：数据可能存在偏差（Skew），不符合模型假设的正态分布，影响模型性能。</li>
<li><strong>信息冗余</strong>：定性特征（如国家、品牌）无法直接被模型使用，需要转换为数值。</li>
<li><strong>存在缺失值</strong>：数据集中某些特征的值可能缺失，需要处理。</li>
</ol>
<h2 data-id="heading-0">处理缺失值：SimpleImputer</h2>
<p>我们处理缺失值，建议使用pandas。</p>
<pre><code class="hljs language-ini" lang="ini">pip install <span class="hljs-attr">pandas</span>==<span class="hljs-number">2.2</span>.<span class="hljs-number">3</span> -i https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre>
<p>推荐学习下锋哥的课程。python数据处理与分析Pandas2：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1wNZ1YnEvp%2F" target="_blank" title="https://www.bilibili.com/video/BV1wNZ1YnEvp/" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1wN…</a></p>
<p>Scikit-learn也提供了一些处理缺失值的方案。比如SimpleImputer</p>
<p>我们看一个示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> sklearn <span class="hljs-keyword">import</span> preprocessing
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.impute <span class="hljs-keyword">import</span> SimpleImputer
​
<span class="hljs-comment"># 创建示例数据，包含不同类型的问题</span>
data = {
    <span class="hljs-string">'age'</span>: [<span class="hljs-number">25</span>, <span class="hljs-number">30</span>, np.nan, <span class="hljs-number">45</span>, <span class="hljs-number">60</span>, <span class="hljs-number">30</span>, <span class="hljs-number">15</span>],  <span class="hljs-comment"># 数值，含缺失值</span>
    <span class="hljs-string">'salary'</span>: [<span class="hljs-number">50000</span>, <span class="hljs-number">54000</span>, <span class="hljs-number">60000</span>, np.nan, <span class="hljs-number">100000</span>, <span class="hljs-number">40000</span>, <span class="hljs-number">20000</span>],  <span class="hljs-comment"># 数值，尺度大，含缺失值</span>
    <span class="hljs-string">'country'</span>: [<span class="hljs-string">'USA'</span>, <span class="hljs-string">'UK'</span>, <span class="hljs-string">'China'</span>, <span class="hljs-string">'USA'</span>, <span class="hljs-string">'India'</span>, <span class="hljs-string">'China'</span>, <span class="hljs-string">'UK'</span>],  <span class="hljs-comment"># 分类型</span>
    <span class="hljs-string">'gender'</span>: [<span class="hljs-string">'M'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'M'</span>, <span class="hljs-string">'M'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'F'</span>]  <span class="hljs-comment"># 分类型</span>
}
​
df = pd.DataFrame(data)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"原始数据："</span>)
<span class="hljs-built_in">print</span>(df)
​
<span class="hljs-comment"># 策略通常为 mean（均值）, median（中位数）, most_frequent（众数）, constant（固定值）</span>
imputer = SimpleImputer(strategy=<span class="hljs-string">'mean'</span>)
​
<span class="hljs-comment"># 我们只对数值列进行填充</span>
numeric_features = [<span class="hljs-string">'age'</span>, <span class="hljs-string">'salary'</span>]
df_numeric = df[numeric_features]
​
<span class="hljs-comment"># fit 计算用于填充的值（这里是均值），transform 应用填充</span>
imputer.fit(df_numeric)
df[numeric_features] = imputer.transform(df_numeric)
​
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n处理缺失值后："</span>)
<span class="hljs-built_in">print</span>(df)
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-r" lang="r">原始数据：
    age    salary country gender
<span class="hljs-number">0</span>  <span class="hljs-number">25.0</span>   <span class="hljs-number">50000.0</span>     USA      M
<span class="hljs-number">1</span>  <span class="hljs-number">30.0</span>   <span class="hljs-number">54000.0</span>      UK      <span class="hljs-built_in">F</span>
<span class="hljs-number">2</span>   <span class="hljs-literal">NaN</span>   <span class="hljs-number">60000.0</span>   China      <span class="hljs-built_in">F</span>
<span class="hljs-number">3</span>  <span class="hljs-number">45.0</span>       <span class="hljs-literal">NaN</span>     USA      M
<span class="hljs-number">4</span>  <span class="hljs-number">60.0</span>  <span class="hljs-number">100000.0</span>   India      M
<span class="hljs-number">5</span>  <span class="hljs-number">30.0</span>   <span class="hljs-number">40000.0</span>   China      <span class="hljs-built_in">F</span>
<span class="hljs-number">6</span>  <span class="hljs-number">15.0</span>   <span class="hljs-number">20000.0</span>      UK      <span class="hljs-built_in">F</span>
​
处理缺失值后：
         age    salary country gender
<span class="hljs-number">0</span>  <span class="hljs-number">25.000000</span>   <span class="hljs-number">50000.0</span>     USA      M
<span class="hljs-number">1</span>  <span class="hljs-number">30.000000</span>   <span class="hljs-number">54000.0</span>      UK      <span class="hljs-built_in">F</span>
<span class="hljs-number">2</span>  <span class="hljs-number">34.166667</span>   <span class="hljs-number">60000.0</span>   China      <span class="hljs-built_in">F</span>
<span class="hljs-number">3</span>  <span class="hljs-number">45.000000</span>   <span class="hljs-number">54000.0</span>     USA      M
<span class="hljs-number">4</span>  <span class="hljs-number">60.000000</span>  <span class="hljs-number">100000.0</span>   India      M
<span class="hljs-number">5</span>  <span class="hljs-number">30.000000</span>   <span class="hljs-number">40000.0</span>   China      <span class="hljs-built_in">F</span>
<span class="hljs-number">6</span>  <span class="hljs-number">15.000000</span>   <span class="hljs-number">20000.0</span>      UK      <span class="hljs-built_in">F</span>
​
Process finished with exit code <span class="hljs-number">0</span>
</code></pre>
<h2 data-id="heading-1">归一化 (Normalization)：MinMaxScaler</h2>
<p>不同特征可能有不同的量纲和范围（如身高、体重、年龄），归一化使各特征在相同尺度上进行比较，避免某些特征因数值较大而主导模型。</p>
<p>我们将特征缩放至一个特定的范围（默认是 [0, 1]）。</p>
<p>归一化（Normalization）公式，也称为最小-最大归一化（Min-Max Normalization)</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86b5e488cc4149e581dec8b2fb4c7f2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769850975&amp;x-signature=3ir0c38yWr6GcocxbonwcAOkdbo%3D" alt="image.png" loading="lazy"/></p>
<p><strong>公式含义</strong> 这个公式将原始数据 X 从其原始范围转换到 [ 0,1] 的范围内。</p>
<p>公式各部分解释</p>
<p><img src="" alt="" loading="lazy"/> 工作原理 <img src="" alt="" loading="lazy"/> 特点 <img src="" alt="" loading="lazy"/> 应用场景 归一化在机器学习和数据挖掘中非常常用，特别是：</p>
<ul>
<li>特征缩放，使不同量纲的特征可比较</li>
<li>梯度下降算法中加速收敛</li>
<li>神经网络中防止梯度消失或爆炸</li>
<li>图像处理中的像素值标准化</li>
</ul>
<p>在Scikit-learn中，使用<code>MinMaxScaler</code>进行归一化操作。在初始化 <code>MinMaxScaler</code> 对象时，最重要的参数是：</p>
<ul>
<li>
<p><code>feature_range</code>: tuple <code>(min, max)</code>, 默认=(0, 1)</p>
<ul>
<li><strong>作用</strong>：指定你想要将数据缩放到的目标范围。</li>
<li><strong>示例</strong>：如果想缩放到 [-1, 1]，则设置 <code>feature_range=(-1, 1)</code>。</li>
</ul>
</li>
</ul>
<p>我们看一个示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> sklearn.impute <span class="hljs-keyword">import</span> SimpleImputer
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> MinMaxScaler
​
<span class="hljs-comment"># 创建示例数据，包含不同类型的问题</span>
data = {
    <span class="hljs-string">'age'</span>: [<span class="hljs-number">25</span>, <span class="hljs-number">30</span>, np.nan, <span class="hljs-number">45</span>, <span class="hljs-number">60</span>, <span class="hljs-number">30</span>, <span class="hljs-number">15</span>],  <span class="hljs-comment"># 数值，含缺失值</span>
    <span class="hljs-string">'salary'</span>: [<span class="hljs-number">50000</span>, <span class="hljs-number">54000</span>, <span class="hljs-number">60000</span>, np.nan, <span class="hljs-number">100000</span>, <span class="hljs-number">40000</span>, <span class="hljs-number">20000</span>],  <span class="hljs-comment"># 数值，尺度大，含缺失值</span>
    <span class="hljs-string">'country'</span>: [<span class="hljs-string">'USA'</span>, <span class="hljs-string">'UK'</span>, <span class="hljs-string">'China'</span>, <span class="hljs-string">'USA'</span>, <span class="hljs-string">'India'</span>, <span class="hljs-string">'China'</span>, <span class="hljs-string">'UK'</span>],  <span class="hljs-comment"># 分类型</span>
    <span class="hljs-string">'gender'</span>: [<span class="hljs-string">'M'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'M'</span>, <span class="hljs-string">'M'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'F'</span>]  <span class="hljs-comment"># 分类型</span>
}
​
df = pd.DataFrame(data)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"原始数据："</span>)
<span class="hljs-built_in">print</span>(df)
​
<span class="hljs-comment"># 策略通常为 mean（均值）, median（中位数）, most_frequent（众数）, constant（固定值）</span>
imputer = SimpleImputer(strategy=<span class="hljs-string">'mean'</span>)
​
<span class="hljs-comment"># 我们只对数值列进行填充</span>
numeric_features = [<span class="hljs-string">'age'</span>, <span class="hljs-string">'salary'</span>]
df_numeric = df[numeric_features]
​
<span class="hljs-comment"># fit 计算用于填充的值（这里是均值），transform 应用填充</span>
imputer.fit(df_numeric)
df[numeric_features] = imputer.transform(df_numeric)
​
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n处理缺失值后："</span>)
<span class="hljs-built_in">print</span>(df)
​
minmax_scaler = MinMaxScaler()
​
df_numeric = df[[<span class="hljs-string">'age'</span>, <span class="hljs-string">'salary'</span>]]
<span class="hljs-comment"># 根据数据训练生成模型</span>
minmax_scaler.fit(df_numeric)
<span class="hljs-comment"># 根据模型训练数据</span>
df_normalized = minmax_scaler.transform(df_numeric)
​
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n归一化后的数值特征（范围[0,1]）："</span>)
<span class="hljs-built_in">print</span>(df_normalized)
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-css" lang="css">归一化后的数值特征（范围<span class="hljs-selector-attr">[0,1]</span>）：
<span class="hljs-selector-attr">[[0.22222222 0.375     ]</span>
 <span class="hljs-selector-attr">[0.33333333 0.425     ]</span>
 <span class="hljs-selector-attr">[0.42592593 0.5       ]</span>
 <span class="hljs-selector-attr">[0.66666667 0.425     ]</span>
 <span class="hljs-selector-attr">[1.         1.        ]</span>
 <span class="hljs-selector-attr">[0.33333333 0.25      ]</span>
 <span class="hljs-selector-attr">[0.         0.        ]</span>]
</code></pre>
<h2 data-id="heading-2">标准化 (Standardization)：StandardScaler</h2>
<p>归一化是基于最大值和最小值的，因此异常值（outliers）会对归一化的结果产生较大影响。极端情况下，一个异常值可能会将整个特征的范围压缩到很小的范围，从而导致其他正常数据的表示能力下降。</p>
<p>所以我们引入能够尽可能降低异常值对数据处理结果影响的标准化计算操作。将特征缩放为<strong>均值为 0，方差为 1</strong> 的标准正态分布。</p>
<p>标准化（Standardization）公式是：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a202aa0230a4cf6957f423fbc88dd92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6ZSLamF2YTEyMzQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769850975&amp;x-signature=aWUAGZdpqRquY80SSWkY5S0MnUQ%3D" alt="image.png" loading="lazy"/></p>
<p>公式各部分详解</p>
<p><img src="" alt="" loading="lazy"/></p>
<p>工作原理</p>
<p>标准化将原始数据转换为均值为0、标准差为1的标准正态分布。具体来说：</p>
<p><img src="" alt="" loading="lazy"/></p>
<p>标准化的意义</p>
<ol start="0">
<li>
<p><strong>统一量纲</strong>：将不同量纲、不同范围的特征转换到同一尺度上</p>
</li>
<li>
<p><strong>中心化</strong>：转换后分布的中心在0点</p>
</li>
<li>
<p>标准化尺度</p>
<p>：转换后的值表示"偏离平均值多少个标准差"</p>
<ul>
<li>Z = 0：表示该数据点恰好等于均值</li>
<li>Z = 1：表示该数据点比均值高出一个标准差</li>
<li>Z = -2：表示该数据点比均值低两个标准差</li>
</ul>
</li>
</ol>
<p>在Scikit-learn中，使用<code>StandardScaler</code>进行标准化操作。</p>
<p>初始化 <code>StandardScaler</code> 对象时，有以下参数：</p>
<ul>
<li>
<p><code>with_mean</code>: boolean, 默认为 True</p>
<ul>
<li><strong>作用</strong>：是否对数据居中（减去均值）。如果设置为 False，则不会减去均值，计算过程变为 <code>x / σ</code>。对于稀疏矩阵，设置 <code>with_mean=False</code> 是推荐且默认的，因为居中会破坏矩阵的稀疏性。</li>
</ul>
</li>
<li>
<p><code>with_std</code>: boolean, 默认为 True</p>
<ul>
<li><strong>作用</strong>：是否将数据缩放到单位方差（除以标准差）。如果设置为 False，则计算过程变为 <code>x - μ</code>，只进行居中处理。</li>
</ul>
</li>
</ul>
<p>在调用 <code>fit</code> 或 <code>fit_transform</code> 之后，<code>StandardScaler</code> 对象会获得以下属性：</p>
<ul>
<li><code>mean_</code>：每个特征（列）在训练数据中的均值（μ）。</li>
<li><code>var_</code>：每个特征（列）在训练数据中的方差。</li>
<li><code>scale_</code>：每个特征（列）在训练数据中的标准差（σ）。这是实际应用于 <code>transform</code> 的缩放比例。</li>
<li><code>n_samples_seen_</code>：处理器在每个特征中处理的样本数（用于在线计算均值/方差）。</li>
<li><code>n_features_in_</code>：训练时使用的特征数量。</li>
<li><code>feature_names_in_</code>：训练时使用的特征名称（如果输入的是 Pandas DataFrame）。</li>
</ul>
<p>我们看一个示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> sklearn.impute <span class="hljs-keyword">import</span> SimpleImputer
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler
​
<span class="hljs-comment"># 创建示例数据，包含不同类型的问题</span>
data = {
    <span class="hljs-string">'age'</span>: [<span class="hljs-number">25</span>, <span class="hljs-number">30</span>, np.nan, <span class="hljs-number">45</span>, <span class="hljs-number">60</span>, <span class="hljs-number">30</span>, <span class="hljs-number">15</span>],  <span class="hljs-comment"># 数值，含缺失值</span>
    <span class="hljs-string">'salary'</span>: [<span class="hljs-number">50000</span>, <span class="hljs-number">54000</span>, <span class="hljs-number">60000</span>, np.nan, <span class="hljs-number">100000</span>, <span class="hljs-number">40000</span>, <span class="hljs-number">20000</span>],  <span class="hljs-comment"># 数值，尺度大，含缺失值</span>
    <span class="hljs-string">'country'</span>: [<span class="hljs-string">'USA'</span>, <span class="hljs-string">'UK'</span>, <span class="hljs-string">'China'</span>, <span class="hljs-string">'USA'</span>, <span class="hljs-string">'India'</span>, <span class="hljs-string">'China'</span>, <span class="hljs-string">'UK'</span>],  <span class="hljs-comment"># 分类型</span>
    <span class="hljs-string">'gender'</span>: [<span class="hljs-string">'M'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'M'</span>, <span class="hljs-string">'M'</span>, <span class="hljs-string">'F'</span>, <span class="hljs-string">'F'</span>]  <span class="hljs-comment"># 分类型</span>
}
​
df = pd.DataFrame(data)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"原始数据："</span>)
<span class="hljs-built_in">print</span>(df)
​
<span class="hljs-comment"># 策略通常为 mean（均值）, median（中位数）, most_frequent（众数）, constant（固定值）</span>
imputer = SimpleImputer(strategy=<span class="hljs-string">'mean'</span>)
​
<span class="hljs-comment"># 我们只对数值列进行填充</span>
numeric_features = [<span class="hljs-string">'age'</span>, <span class="hljs-string">'salary'</span>]
df_numeric = df[numeric_features]
​
<span class="hljs-comment"># fit 计算用于填充的值（这里是均值），transform 应用填充</span>
imputer.fit(df_numeric)
df[numeric_features] = imputer.transform(df_numeric)
​
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n处理缺失值后："</span>)
<span class="hljs-built_in">print</span>(df)
​
standard_scaler = StandardScaler()
​
df_numeric = df[[<span class="hljs-string">'age'</span>, <span class="hljs-string">'salary'</span>]]
<span class="hljs-comment"># 根据数据训练生成模型</span>
standard_scaler.fit(df_numeric)
<span class="hljs-comment"># 根据模型训练数据</span>
df_standardized = standard_scaler.transform(df_numeric)
​
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n标准化后的数值特征："</span>)
<span class="hljs-built_in">print</span>(df_standardized)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"标准化后的方差：<span class="hljs-subst">{df_standardized.std()}</span>"</span>)
</code></pre>
<p>运行输出：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[[-0.68032458 -0.17837652]</span>
 <span class="hljs-selector-attr">[-0.30923844  0.        ]</span>
 <span class="hljs-selector-attr">[ 0.          0.26756478]</span>
 <span class="hljs-selector-attr">[ 0.80401995  0.        ]</span>
 <span class="hljs-selector-attr">[ 1.91727835  2.05132995]</span>
 <span class="hljs-selector-attr">[-0.30923844 -0.62431781]</span>
 <span class="hljs-selector-attr">[-1.42249684 -1.51620039]</span>]
</code></pre>
<p>数学知识，什么是标准正太分布：</p>
<p>正态分布的概率密度函数显示为典型的钟形曲线，这一形状类似于寺庙中的大钟，因此也常被称为钟形曲线。作为一种连续分布，正态分布拥有完备的概率密度函数、累积分布函数、矩生成函数和特征函数等表达形式，并且具备明确的期望（即均值）、方差、偏度和峰度等数值特征。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[折线图的奇妙变奏：四种创意可视化方法]]></title>    <link>https://juejin.cn/post/7598465042968592424</link>    <guid>https://juejin.cn/post/7598465042968592424</guid>    <pubDate>2026-01-24T10:07:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598465042968592424" data-draft-id="7598480267218010146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="折线图的奇妙变奏：四种创意可视化方法"/> <meta itemprop="keywords" content="Python,数据可视化,数据分析"/> <meta itemprop="datePublished" content="2026-01-24T10:07:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            折线图的奇妙变奏：四种创意可视化方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T10:07:50.000Z" title="Sat Jan 24 2026 10:07:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>想象一下折线图就像一条普通的公路，它能带我们从A点到达B点。</p>
<p>但有时我们需要更特别的路线：<strong>环岛</strong>、<strong>盘山公路</strong>、<strong>波浪形赛道</strong>或<strong>螺旋上升</strong>的通道。</p>
<p>在数据可视化中，标准的折线图有时无法充分展示数据的特性，这时我们就需要一些创意变种。</p>
<p>今天将介绍四种特别的折线图变体，它们各有所长，能让你的数据故事更加生动。</p>
<h2 data-id="heading-0">1. 圆形折线图：时间的轮回</h2>
<p>如果把普通的折线图首尾相连，放在圆形坐标系中，就得到了圆形折线图。</p>
<p>它特别适合展示<strong>周期性数据</strong>，比如一天24小时的温度变化、一周七天的销售数据，或者一年四季的气候模式。</p>
<p>它的<strong>实现原理</strong>是：使用<strong>极坐标</strong>系统，将角度代表时间或类别，半径代表数值大小。</p>
<p>在<code>matplotlib</code>中，只需要创建一个极坐标子图，然后像普通折线图一样绘制即可。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 圆形折线图</span>
<span class="hljs-comment"># 数据准备</span>
hours = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">2</span> * np.pi, <span class="hljs-number">24</span>, endpoint=<span class="hljs-literal">False</span>)
values = [] <span class="hljs-comment"># ....</span>
<span class="hljs-comment"># 闭合数据</span>
values_cycle = np.concatenate((values, [values[<span class="hljs-number">0</span>]]))
hours_cycle = np.concatenate((hours, [hours[<span class="hljs-number">0</span>]]))
hour_labels = [<span class="hljs-string">f"<span class="hljs-subst">{h}</span>点"</span> <span class="hljs-keyword">for</span> h <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">24</span>)]

fig = plt.figure(figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># --- 左图：普通折线图 ---</span>
ax1 = fig.add_subplot(<span class="hljs-number">121</span>)
ax1.plot(<span class="hljs-built_in">range</span>(<span class="hljs-number">24</span>), values, marker=<span class="hljs-string">"o"</span>, color=<span class="hljs-string">"#FF6B6B"</span>)
<span class="hljs-comment"># 省略...</span>

<span class="hljs-comment"># --- 右图：圆形折线图 ---</span>
ax2 = fig.add_subplot(<span class="hljs-number">122</span>, projection=<span class="hljs-string">"polar"</span>)
ax2.plot(hours_cycle, values_cycle, linewidth=<span class="hljs-number">2</span>, color=<span class="hljs-string">"#FF6B6B"</span>)
<span class="hljs-comment"># 省略...</span>

plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2d09494c6a34965b87ebc8f9c565532~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769854070&amp;x-signature=vnNZTd0sfA2b9grSk73IrKMfJuc%3D" alt="" loading="lazy"/></p>
<p><strong>圆形折线图</strong>在这种场景下的优势在于 <strong>周期性的闭环感</strong>。</p>
<ul>
<li><strong>左图</strong>（普通）： 像把这一天的时间切断了，23:00 和 00:00 分隔在两端，看不出它们其实紧挨着。</li>
<li><strong>右图</strong>（圆形）： 完美闭合。你能直观地感受到“深夜”是一个连续的时间段。</li>
</ul>
<h2 data-id="heading-1">2. 斜率图：变化的快照</h2>
<p>想象一下比较两个人从起点到终点的跑步速度。</p>
<p><strong>斜率图</strong>就像两张快照：一张在起点，一张在终点，中间用直线连接。</p>
<p>线的斜率代表了变化的速率，陡峭的上坡表示大幅增长，平缓的线表示变化不大，下坡则表示下降。</p>
<p>它的<strong>实现原理</strong>：通常在两侧显示两个时间点或两种状态的数据，然后用直线连接对应的数据点。</p>
<p>线的<strong>斜率</strong>直观展示了变化的<strong>大小和方向</strong>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 斜率图</span>
<span class="hljs-comment"># 数据</span>
depts = [<span class="hljs-string">'销售部'</span>, <span class="hljs-string">'人事部'</span>, <span class="hljs-string">'技术部'</span>, <span class="hljs-string">'研发部'</span>, <span class="hljs-string">'市场部'</span>]
score_before = [<span class="hljs-number">65</span>, <span class="hljs-number">70</span>, <span class="hljs-number">88</span>, <span class="hljs-number">85</span>, <span class="hljs-number">60</span>]
score_after = [<span class="hljs-number">85</span>, <span class="hljs-number">68</span>, <span class="hljs-number">92</span>, <span class="hljs-number">80</span>, <span class="hljs-number">90</span>]

fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># --- 左图：普通折线图 ---</span>
x = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>] <span class="hljs-comment"># 代表前后两个时间点</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(depts)):
    ax1.plot(x, [score_before[i], score_after[i]], marker=<span class="hljs-string">'o'</span>, label=depts[i])
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># --- 右图：斜率图 ---</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(depts)):
    color = <span class="hljs-string">'green'</span> <span class="hljs-keyword">if</span> score_after[i] &gt; score_before[i] <span class="hljs-keyword">else</span> <span class="hljs-string">'red'</span>
    <span class="hljs-comment"># 绘制线条</span>
    ax2.plot([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>], [score_before[i], score_after[i]], color=color, marker=<span class="hljs-string">'o'</span>, linewidth=<span class="hljs-number">2</span>)
    <span class="hljs-comment"># 直接在点旁边标注文字，去除图例查找的负担</span>
    ax2.text(-<span class="hljs-number">0.05</span>, score_before[i], <span class="hljs-string">f"<span class="hljs-subst">{depts[i]}</span> <span class="hljs-subst">{score_before[i]}</span>"</span>, ha=<span class="hljs-string">'right'</span>, va=<span class="hljs-string">'center'</span>)
    ax2.text(<span class="hljs-number">1.05</span>, score_after[i], <span class="hljs-string">f"<span class="hljs-subst">{score_after[i]}</span>"</span>, ha=<span class="hljs-string">'left'</span>, va=<span class="hljs-string">'center'</span>)

<span class="hljs-comment"># 省略 ...</span>

plt.tight_layout()
plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59346670e0c84b9b924039e0cfe9876f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769854070&amp;x-signature=UAZtkxlX7viqsEPQCU0nSkhCe3k%3D" alt="" loading="lazy"/></p>
<p><strong>斜率图</strong>在这种场景下的优势在于 <strong>极简的变化趋势</strong>。</p>
<ul>
<li><strong>左图</strong>（普通）： 虽然也能看，但在坐标轴的干扰下，你需要盯着读数看。</li>
<li><strong>右图</strong>（斜率）： 去掉了多余的刻度线，只保留首尾。线条越陡峭，代表变化越剧烈。这就像是从“阅读说明书”变成了“看红绿灯”，一目了然。</li>
</ul>
<h2 data-id="heading-2">3. 凹凸图：排名的舞蹈</h2>
<p>想象一下赛跑中的名次变化：起跑时A领先，中途B反超，最后C冲刺夺冠。</p>
<p><strong>凹凸图</strong>就像记录这场比赛的名次变化表，每个时间点谁在前谁在后一目了然。</p>
<p>它的<strong>实现原理</strong>：通常展示多个项目在不同时间点的排名变化。</p>
<p>每个项目有一条线，线的上下位置代表排名高低。由于排名是相对的，所以这些线总会交叉，形成有趣的波浪形。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 凹凸图</span>
years = [<span class="hljs-number">2019</span>, <span class="hljs-number">2020</span>, <span class="hljs-number">2021</span>, <span class="hljs-number">2022</span>, <span class="hljs-number">2023</span>]
<span class="hljs-comment"># 排名数据</span>
ranks = {
    <span class="hljs-string">'品牌A'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],
    <span class="hljs-string">'品牌B'</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],
    <span class="hljs-string">'品牌C'</span>: [<span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>],
    <span class="hljs-string">'品牌D'</span>: [<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>]
}
colors = [<span class="hljs-string">'#1f77b4'</span>, <span class="hljs-string">'#ff7f0e'</span>, <span class="hljs-string">'#2ca02c'</span>, <span class="hljs-string">'#d62728'</span>]

fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># --- 左图：普通折线图 (模拟数值非常接近的情况) ---</span>
<span class="hljs-comment"># 假设排名对应的数值很接近，很难看清</span>
values_simulated = {
    <span class="hljs-string">'品牌A'</span>: [<span class="hljs-number">30</span>, <span class="hljs-number">31</span>, <span class="hljs-number">25</span>, <span class="hljs-number">20</span>, <span class="hljs-number">15</span>],
    <span class="hljs-string">'品牌B'</span>: [<span class="hljs-number">10</span>, <span class="hljs-number">15</span>, <span class="hljs-number">30</span>, <span class="hljs-number">32</span>, <span class="hljs-number">28</span>],
    <span class="hljs-string">'品牌C'</span>: [<span class="hljs-number">25</span>, <span class="hljs-number">12</span>, <span class="hljs-number">22</span>, <span class="hljs-number">28</span>, <span class="hljs-number">35</span>],
    <span class="hljs-string">'品牌D'</span>: [<span class="hljs-number">20</span>, <span class="hljs-number">22</span>, <span class="hljs-number">18</span>, <span class="hljs-number">15</span>, <span class="hljs-number">20</span>]
}

<span class="hljs-keyword">for</span> brand, val_list <span class="hljs-keyword">in</span> values_simulated.items():
    ax1.plot(years, val_list, marker=<span class="hljs-string">'o'</span>, label=brand)

<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># --- 右图：凹凸图 ---</span>
<span class="hljs-keyword">for</span> idx, (brand, rank_list) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(ranks.items()):
    ax2.plot(years, rank_list, marker=<span class="hljs-string">'o'</span>, markersize=<span class="hljs-number">15</span>, linewidth=<span class="hljs-number">4</span>, label=brand, color=colors[idx])
    <span class="hljs-comment"># 在圆点中写上名次</span>
    <span class="hljs-keyword">for</span> x, y <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(years, rank_list):
        ax2.text(x, y, <span class="hljs-built_in">str</span>(y), color=<span class="hljs-string">'white'</span>, ha=<span class="hljs-string">'center'</span>, va=<span class="hljs-string">'center'</span>, fontweight=<span class="hljs-string">'bold'</span>)

ax2.invert_yaxis() <span class="hljs-comment"># 关键：倒转Y轴，让第1名在最上面</span>
<span class="hljs-comment"># 省略 ...</span>

plt.tight_layout()
plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62b2a2137aa04b0ebb1c482599116031~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769854070&amp;x-signature=EjJjqCP3sDpGhked3Fzirlx%2FQbI%3D" alt="" loading="lazy"/></p>
<p><strong>凹凸图</strong>在这种场景下的优势在于 <strong>排名的更替</strong>。</p>
<ul>
<li><strong>左图</strong>（普通）： 我们通常画的是“数值”。如果四个品牌的市场份额很接近（比如20%和21%），线条会粘连在一起，很难看清谁第一谁第二。</li>
<li><strong>右图</strong>（凹凸）： Y轴不再是数值，而是“名次”。这里将排名均匀拉开，你可以清晰地看到品牌C是如何像黑马一样从最后一名杀到第一名的。</li>
</ul>
<h2 data-id="heading-3">4. 周期图：模式的放大镜</h2>
<p>想象一下观察一年的温度变化。</p>
<p>普通折线图会显示一条有365个点的波浪线，<strong>周期图</strong>则把这365天分成12个月，把每个月的31天叠加在一起比较，就像把一年的温度曲线切成12段，然后并排放在一起。</p>
<p>它的实现原理：将时间序列数据按照周期（天、周、月、年等）切分，然后将每个周期重叠绘制。</p>
<p>这样可以直观比较不同周期内的模式是否相似，以及每个周期相对于整体的表现。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 周期图</span>
months = [<span class="hljs-string">'1月'</span>, <span class="hljs-string">'2月'</span>, <span class="hljs-string">'3月'</span>, <span class="hljs-string">'4月'</span>, <span class="hljs-string">'5月'</span>, <span class="hljs-string">'6月'</span>, <span class="hljs-string">'7月'</span>, <span class="hljs-string">'8月'</span>, <span class="hljs-string">'9月'</span>, <span class="hljs-string">'10月'</span>, <span class="hljs-string">'11月'</span>, <span class="hljs-string">'12月'</span>]
<span class="hljs-comment"># 模拟长数据</span>
sales_2021 = [<span class="hljs-number">20</span>, <span class="hljs-number">25</span>, <span class="hljs-number">35</span>, <span class="hljs-number">50</span>, <span class="hljs-number">80</span>, <span class="hljs-number">100</span>, <span class="hljs-number">110</span>, <span class="hljs-number">105</span>, <span class="hljs-number">70</span>, <span class="hljs-number">50</span>, <span class="hljs-number">30</span>, <span class="hljs-number">25</span>]
sales_2022 = [<span class="hljs-number">22</span>, <span class="hljs-number">28</span>, <span class="hljs-number">40</span>, <span class="hljs-number">55</span>, <span class="hljs-number">85</span>, <span class="hljs-number">105</span>, <span class="hljs-number">115</span>, <span class="hljs-number">100</span>, <span class="hljs-number">75</span>, <span class="hljs-number">55</span>, <span class="hljs-number">35</span>, <span class="hljs-number">28</span>]
sales_2023 = [<span class="hljs-number">25</span>, <span class="hljs-number">30</span>, <span class="hljs-number">45</span>, <span class="hljs-number">60</span>, <span class="hljs-number">95</span>, <span class="hljs-number">120</span>, <span class="hljs-number">130</span>, <span class="hljs-number">115</span>, <span class="hljs-number">80</span>, <span class="hljs-number">60</span>, <span class="hljs-number">40</span>, <span class="hljs-number">35</span>]

fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># --- 左图：普通折线图 (线性时间轴) ---</span>
<span class="hljs-comment"># 把所有数据拼成一条长线</span>
all_sales = sales_2021 + sales_2022 + sales_2023
all_months_idx = <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(all_sales))

ax1.plot(all_months_idx, all_sales, color=<span class="hljs-string">'#3498db'</span>, linewidth=<span class="hljs-number">2</span>)
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># --- 右图：周期图 (叠加时间轴) ---</span>
ax2.plot(months, sales_2021, marker=<span class="hljs-string">'.'</span>, label=<span class="hljs-string">'2021年'</span>, color=<span class="hljs-string">'lightgrey'</span>, linewidth=<span class="hljs-number">2</span>, linestyle=<span class="hljs-string">'--'</span>)
ax2.plot(months, sales_2022, marker=<span class="hljs-string">'.'</span>, label=<span class="hljs-string">'2022年'</span>, color=<span class="hljs-string">'grey'</span>, linewidth=<span class="hljs-number">2</span>, linestyle=<span class="hljs-string">'--'</span>)
ax2.plot(months, sales_2023, marker=<span class="hljs-string">'o'</span>, label=<span class="hljs-string">'2023年'</span>, color=<span class="hljs-string">'#3498db'</span>, linewidth=<span class="hljs-number">3</span>)
<span class="hljs-comment"># 省略 ...</span>

plt.tight_layout()
plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b52a1c7bf5794b26a51995308fe4f4fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769854070&amp;x-signature=dPDaYKtuoZkRTsbBLi76VZ%2BUi54%3D" alt="" loading="lazy"/></p>
<p><strong>周期图</strong>在这种场景下的优势在于 <strong>季节性模式的识别</strong>。</p>
<ul>
<li><strong>左图</strong>（普通）： 一条长线连绵不断。想要对比2021年7月和2023年7月的数据，眼睛需要在图表左右两端来回横跳，非常累。</li>
<li><strong>右图</strong>（周期）： 就像把每年的数据“叠”在了一起。你可以直接看到，无论哪一年，7月都是最高峰，而12月都是低谷。规律一目了然。</li>
</ul>
<h2 data-id="heading-4">5. 总结</h2>
<p>每种折线图变体都有其独特的价值：</p>
<ul>
<li><strong>圆形折线图</strong>：适合展示周期性数据，首尾相接的设计强调循环</li>
<li><strong>斜率图</strong>：适合比较两个时间点的变化，直观展示变化幅度</li>
<li><strong>凹凸图</strong>：适合展示排名或相对位置的变化，竞争关系一目了然</li>
<li><strong>周期图</strong>：适合比较多个周期的模式，发现季节性规律</li>
</ul>
<p>实际情况下，选择哪种变体取决于你的数据特点和想要传达的信息。</p>
<p><strong>关键</strong>是要记住：可视化不是为了炫技，而是为了更好地讲述数据故事。下次当我们面对数据时，不妨思考一下，哪种"变形"的折线图能让你的故事更加动人。</p>
<p>完整的代码共享在：<a href="https://link.juejin.cn?target=https%3A%2F%2Furl11.ctfile.com%2Ff%2F45455611-8634430461-e0154d%3Fp%3D6872" target="_blank" title="https://url11.ctfile.com/f/45455611-8634430461-e0154d?p=6872" ref="nofollow noopener noreferrer">折线图的4个变种.ipynb</a> (访问密码: 6872)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae的过去与现在]]></title>    <link>https://juejin.cn/post/7598472744480997395</link>    <guid>https://juejin.cn/post/7598472744480997395</guid>    <pubDate>2026-01-24T09:42:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598472744480997395" data-draft-id="7598472744480882707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae的过去与现在"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-24T09:42:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="arriettyandray"/> <meta itemprop="url" content="https://juejin.cn/user/3353942203304611"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae的过去与现在
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3353942203304611/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    arriettyandray
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T09:42:24.000Z" title="Sat Jan 24 2026 09:42:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我和Trae的接触是在25年5月，业余时间想学习一下大模型，刚好掘金在推广Trae，想着也是学习，下着学习一下。于是在为数不多的时间里，有一段密集的使用时间，晚上就研究大模型和Trae的使用，也留下了几篇和Trae相关的文章。</p>
<h2 data-id="heading-0">Trae的过去</h2>
<ul>
<li>Trae搭建了我的小小Transformer模型</li>
<li>用贪吃蛇游戏来体验一下Trae</li>
</ul>
<p>我尝试使用Trae来搭建了小小Transformer模型以及使用Trae来完成贪吃蛇的游戏。在搭建Transformer模型时，简单的两句话，就让Trae完成了简单的模型搭建，速度的提供代码供我学习。而贪吃蛇的游戏更是可以建立新文件，直接写好简单Demo进行运行的小游戏。
而在贪吃蛇小游戏的测评时，我印象最深时它推出来的新功能，可以<strong>MCP进行第三方服务使用</strong>。我看过别人文章中在不同软件中添加MCP，生成很有意思的成果。例如旅游计划，瞬间将Trae的使用提升了一个Level。</p>
<h2 data-id="heading-1">Trae的现在</h2>
<p>如今，时隔8个月过去了，我再次下载Trae，它已经不是印象中简单的白红的小图标，而是一个炫酷的黑绿的一种迭代。我想再一次用贪吃蛇游戏来体验一下Trae，看看这次是否有不一样的惊喜。
下载打开，没想到加了一个<strong>SOLO</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06ed6c60aff84ce7b8335dc97a3e6b8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXJyaWV0dHlhbmRyYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769852544&amp;x-signature=cjOKgBU2w8YiSMYPnS3zQiNYQUk%3D" alt="image.png" loading="lazy"/>
一种全新的面貌在向我介绍。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e88bafe1a3124f79b3d534bdb202d9fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXJyaWV0dHlhbmRyYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769852544&amp;x-signature=EVWAh7BQCwlgNuDvK%2FAr3f1gE0g%3D" alt="image.png" loading="lazy"/>
而左上角还停留在我5月份的编码程序记录。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44f342a1227c4994a9ca9327d68a40e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXJyaWV0dHlhbmRyYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769852544&amp;x-signature=bXujSNmzVcTnr4Wba6w%2FBF2yeos%3D" alt="image.png" loading="lazy"/>
登录完成，欢迎使用全新SOLO模式！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe57e49d046c4a3e81c3c45357fbd0bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXJyaWV0dHlhbmRyYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769852544&amp;x-signature=UNVi%2F%2FPAh0MUiE80s1Du22cT7xI%3D" alt="image.png" loading="lazy"/>
它的任务栏里还是我5月的使用记录。</p>
<p>现在可以开始与SOLO Coder聊天了！</p>
<ul>
<li>在使用的时候，又被惊艳到了。直接分解任务，进行任务分解，然后完成每项任务。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7459c040775a4dc39faab42a82612366~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXJyaWV0dHlhbmRyYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769852544&amp;x-signature=6QnOW2%2F6J6Y%2FH%2FadPNbYuk3nMW0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>在我只是简单的编辑这篇文章的过程中，它已经完成贪吃蛇的游戏的制作。甚至存放文件的位置还是去年5月份使用它时用的位置。并且在完成后，它主动给我打开了浏览器，游戏已经跑起来了。画面比之前的画面与游戏感觉更好了！</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3730430b5670416db0fe0cb7b86867dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXJyaWV0dHlhbmRyYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769852544&amp;x-signature=ErCqUQLTRWquqQmDnBgKy3jtxuE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>来看一下最后的成品对比吧！</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd1aecef4f914b08b5011c60922706a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYXJyaWV0dHlhbmRyYXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769852544&amp;x-signature=gGQ618kv4oFPCXSIs6VRahX3h1A%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">Trae的未来</h2>
<p>通过两次使用贪吃蛇游戏来做对比，我感觉整个使用超级丝滑，成品出来的效果有了质的提升。虽然2025年仅有少数时间来用到Trae，但是我想未来使用Trae的时间会更多，期待它的每一次升级改变。
未来也许Trae会有很多变化，我希望我的26也能跟随Trae有不同的改变！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开源一个 markdown-it 插件：让你的博客支持 GitHub 用户悬浮卡片]]></title>    <link>https://juejin.cn/post/7598480413803757610</link>    <guid>https://juejin.cn/post/7598480413803757610</guid>    <pubDate>2026-01-24T10:20:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598480413803757610" data-draft-id="7598480413803741226" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开源一个 markdown-it 插件：让你的博客支持 GitHub 用户悬浮卡片"/> <meta itemprop="keywords" content="Markdown,开源,GitHub"/> <meta itemprop="datePublished" content="2026-01-24T10:20:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Joie"/> <meta itemprop="url" content="https://juejin.cn/user/3265984436383947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开源一个 markdown-it 插件：让你的博客支持 GitHub 用户悬浮卡片
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3265984436383947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Joie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T10:20:52.000Z" title="Sat Jan 24 2026 10:20:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开源一个 markdown-it 插件：让你的博客支持 GitHub 用户悬浮卡片</h2>
<h3 data-id="heading-1">前言</h3>
<p>在写技术博客或文档时，我们经常需要提到 GitHub 上的开发者，比如「这个方案参考了 @antfu 的实现」。但读者看到这个 @ 时，往往需要点击跳转才能了解这个人是谁。</p>
<p>能不能像 GitHub 那样，鼠标悬停就能看到用户信息呢？</p>
<p>于是我开发了这个插件：<strong>markdown-it-github-mention-card</strong></p>
<h3 data-id="heading-2">效果预览</h3>
<p>在 Markdown 中写入：</p>
<pre><code class="hljs language-markdown" lang="markdown">这个项目的灵感来自 {@antfu} 的开源作品。
</code></pre>
<p>渲染后，鼠标悬停在链接上，就会出现一个精美的用户信息卡片，包含：</p>
<ul>
<li>用户头像</li>
<li>用户名和简介</li>
<li>地理位置、公司信息</li>
<li>粉丝数、关注数、公开仓库数</li>
</ul>
<p>无需跳转页面，信息一目了然。</p>
<h3 data-id="heading-3">特性</h3>
<ul>
<li><strong>语法简洁</strong>：<code>{@username}</code> 即可，支持自定义显示文本</li>
<li><strong>悬浮卡片</strong>：调用 GitHub API 实时获取用户信息</li>
<li><strong>暗色模式</strong>：自动适配 <code>.dark</code> 主题类</li>
<li><strong>SSR/SSG 友好</strong>：完美支持 VitePress、Nuxt、Next.js 等框架</li>
<li><strong>TypeScript</strong>：完整的类型定义</li>
<li><strong>轻量无依赖</strong>：核心代码仅依赖 markdown-it</li>
</ul>
<h3 data-id="heading-4">安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm</span>
npm install markdown-it-github-mention-card

<span class="hljs-comment"># pnpm</span>
pnpm add markdown-it-github-mention-card

<span class="hljs-comment"># yarn</span>
yarn add markdown-it-github-mention-card
</code></pre>
<h3 data-id="heading-5">基础使用</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">MarkdownIt</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'markdown-it'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MarkdownItGitHubMentionCard</span>, { initHoverCard } <span class="hljs-keyword">from</span> <span class="hljs-string">'markdown-it-github-mention-card'</span>

<span class="hljs-keyword">const</span> md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarkdownIt</span>()
md.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">MarkdownItGitHubMentionCard</span>, {
  <span class="hljs-comment">// 可选：提高 GitHub API 速率限制</span>
  <span class="hljs-attr">githubToken</span>: <span class="hljs-string">'YOUR_GITHUB_TOKEN'</span>,
})

<span class="hljs-comment">// 渲染 Markdown</span>
<span class="hljs-keyword">const</span> html = md.<span class="hljs-title function_">render</span>(<span class="hljs-string">'{@antfu} 是 Vue 核心团队成员'</span>)
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#app'</span>).<span class="hljs-property">innerHTML</span> = html

<span class="hljs-comment">// 初始化悬浮卡片（浏览器端调用）</span>
<span class="hljs-title function_">initHoverCard</span>()
</code></pre>
<h3 data-id="heading-6">语法说明</h3>
<p>插件支持三种写法：</p>

























<table><thead><tr><th>语法</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>{@username}</code></td><td>基础用法</td><td><code>{@antfu}</code> → 显示 "antfu"</td></tr><tr><td><code>{@username|显示文本}</code></td><td>自定义文本</td><td><code>{@antfu|Anthony Fu}</code> → 显示 "Anthony Fu"</td></tr><tr><td><code>{@username|显示文本|链接}</code></td><td>自定义链接</td><td><code>{@antfu|博客|https://antfu.me}</code></td></tr></tbody></table>
<h3 data-id="heading-7">SSR/SSG 场景最佳实践</h3>
<p>在服务端渲染场景下，构建时和浏览器端环境分离，推荐以下方式：</p>
<p><strong>服务端（构建时）：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">MarkdownIt</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'markdown-it'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MarkdownItGitHubMentionCard</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'markdown-it-github-mention-card'</span>

<span class="hljs-keyword">const</span> md = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MarkdownIt</span>()
md.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">MarkdownItGitHubMentionCard</span>)
<span class="hljs-comment">// 服务端不传 token，避免暴露</span>

<span class="hljs-keyword">const</span> html = md.<span class="hljs-title function_">render</span>(<span class="hljs-string">'{@antfu}'</span>)
</code></pre>
<p><strong>客户端（浏览器）：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { initHoverCard } <span class="hljs-keyword">from</span> <span class="hljs-string">'markdown-it-github-mention-card'</span>

<span class="hljs-comment">// VitePress / Vite</span>
<span class="hljs-title function_">initHoverCard</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_GITHUB_TOKEN</span>)

<span class="hljs-comment">// Next.js</span>
<span class="hljs-title function_">initHoverCard</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">NEXT_PUBLIC_GITHUB_TOKEN</span>)
</code></pre>
<h3 data-id="heading-8">暗色模式</h3>
<p>插件内置暗色模式支持，当页面或父元素包含 <code>.dark</code> 类时，卡片自动切换暗色主题：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"dark"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 卡片自动适配暗色 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>与 VitePress、Tailwind CSS 等主流方案完美兼容。</p>
<h3 data-id="heading-9">在 VitePress 中使用</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// .vitepress/config.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MarkdownItGitHubMentionCard</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'markdown-it-github-mention-card'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">markdown</span>: {
    <span class="hljs-attr">config</span>: <span class="hljs-function">(<span class="hljs-params">md</span>) =&gt;</span> {
      md.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">MarkdownItGitHubMentionCard</span>)
    }
  }
}
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// .vitepress/theme/index.ts</span>
<span class="hljs-keyword">import</span> { initHoverCard } <span class="hljs-keyword">from</span> <span class="hljs-string">'markdown-it-github-mention-card'</span>
<span class="hljs-keyword">import</span> { onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">enhanceApp</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">'undefined'</span>) {
      <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">initHoverCard</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_GITHUB_TOKEN</span>)
      })
    }
  }
}
</code></pre>
<h3 data-id="heading-10">实现原理</h3>
<p>简单介绍一下核心实现：</p>
<ol>
<li>
<p><strong>Markdown 解析</strong>：通过 markdown-it 的 inline rule，匹配 <code>{@...}</code> 语法，生成带有 <code>data-github-user</code> 属性的 <code>&lt;a&gt;</code> 标签</p>
</li>
<li>
<p><strong>悬浮卡片</strong>：<code>initHoverCard()</code> 在浏览器端监听鼠标事件，当悬停在目标链接上时：</p>
<ul>
<li>调用 GitHub REST API 获取用户信息</li>
<li>动态创建卡片 DOM 并定位显示</li>
<li>内置请求缓存，避免重复请求</li>
</ul>
</li>
<li>
<p><strong>样式注入</strong>：首次调用时自动注入 CSS，支持亮/暗两套主题</p>
</li>
</ol>
<h3 data-id="heading-11">为什么不用 GitHub 官方的 Hover Card？</h3>
<p>GitHub 的 Hover Card 仅在 github.com 域名下生效，且需要登录状态。本插件：</p>
<ul>
<li>可在任意网站使用</li>
<li>无需用户登录 GitHub</li>
<li>可自定义样式和行为</li>
<li>适配各种 SSR/SSG 框架</li>
</ul>
<h3 data-id="heading-12">项目地址</h3>
<ul>
<li><strong>GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcassie-ye%2Fmarkdown-it-github-mention-card" target="_blank" title="https://github.com/cassie-ye/markdown-it-github-mention-card" ref="nofollow noopener noreferrer">cassie-ye/markdown-it-github-mention-card</a></li>
<li><strong>npm</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fmarkdown-it-github-mention-card" target="_blank" title="https://www.npmjs.com/package/markdown-it-github-mention-card" ref="nofollow noopener noreferrer">markdown-it-github-mention-card</a></li>
</ul>
<h3 data-id="heading-13">写在最后</h3>
<p>这是我开源的一个小工具，希望能帮助到有类似需求的同学。</p>
<p>如果觉得有用，欢迎：</p>
<ul>
<li>给项目点个 ⭐ Star</li>
<li>提 Issue 反馈问题或建议</li>
<li>提 PR 一起完善</li>
</ul>
<p>有任何问题欢迎在评论区交流讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS客户端开发基础知识——写文件避“坑”指南（二）]]></title>    <link>https://juejin.cn/post/7598818096729260070</link>    <guid>https://juejin.cn/post/7598818096729260070</guid>    <pubDate>2026-01-24T10:37:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598818096729260070" data-draft-id="7597588000613941311" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS客户端开发基础知识——写文件避“坑”指南（二）"/> <meta itemprop="keywords" content="iOS,数据库,性能优化"/> <meta itemprop="datePublished" content="2026-01-24T10:37:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zhangjiezhi_"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655922125"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS客户端开发基础知识——写文件避“坑”指南（二）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655922125/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zhangjiezhi_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T10:37:57.000Z" title="Sat Jan 24 2026 10:37:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>更多精彩文章，欢迎关注作者微信公众号：<strong>码工笔记</strong></p>
</blockquote>
<h2 data-id="heading-0">一、背景 &amp; 问题</h2>
<p><a href="https://juejin.cn/post/6885630755805626375" target="_blank" title="https://juejin.cn/post/6885630755805626375">上一篇文章</a>讲过，在iOS、macOS平台上，要保证新写入的文件内容成功落盘，需要调用<code>fcntl(fd, FULL_SYNC)</code>（注：开源chromium里也是这么做的[1]）：</p>
<blockquote>
<p><strong>FULL_SYNC</strong></p>
<p>Does the same thing as fsync(2) then asks the drive to flush all buffered data to the
permanent storage device (arg is ignored).  As this drains the entire queue of the device
and acts as a barrier, data that had been fsync'd on the same device before is guaranteed to
be persisted when this call returns.  This is currently implemented on HFS, MS-DOS (FAT),
Universal Disk Format (UDF) and APFS file systems.  The operation may take quite a while to
complete.  Certain FireWire drives have also been known to ignore the request to flush their
buffered data.</p>
</blockquote>
<p>从上面man page的描述可以看出，<code>FULL_SYNC</code>是将设备<code>unified buffer</code>里的数据全部强制落盘，因为buffer中的数据可能不只包含刚刚写入的，可能还包含了之前写入的数据，虽然达到了持久化的目的，但时间不可控，可能会耗时很长，严重影响应用性能。</p>
<p>有没有什么优化方式呢？</p>
<h2 data-id="heading-1">二、F_BARRIERFSYNC</h2>
<p>从应用开发者的角度，很多场景下并不需要这么强的落盘保证，大多数场景下，如果能保证写入顺序，也即先写入数据A，后写入数据B，如果后续读数据时读到了数据B，则A也一定存在，应用侧就可以自己做数据完整性检查了，从而可以做兜底逻辑。这样一来既能减少强制落盘对性能的影响，又能保证数据的完整性。</p>
<p><code>fcntl</code>的<code>F_BARRIERFSYNC</code>这个选项就是为了解决这个问题的。先看一下man page说明：</p>
<blockquote>
<p><strong>F_BARRIERFSYNC</strong></p>
<p>Does the same thing as fsync(2) then issues a barrier command to the drive (arg is ignored).
The barrier applies to I/O that have been flushed with fsync(2) on the same device before.
These operations are guaranteed to be persisted before any other I/O that would follow the
barrier, although no assumption should be made on what has been persisted or not when this
call returns.  After the barrier has been issued, operations on other FDs that have been
fsync'd before can still be re-ordered by the device, but not after the barrier.  This is
typically useful to guarantee valid state on disk when ordering is a concern but durability
is not.  A barrier can be used to order two phases of operations on a set of file
descriptors and ensure that no file can possibly get persisted with the effect of the second
phase without the effect of the first one. To do so, execute operations of phase one, then
fsync(2) each FD and issue a single barrier.  Finally execute operations of phase two.  This
is currently implemented on HFS and APFS. It requires hardware support, which Apple SSDs are
guaranteed to provide.</p>
</blockquote>
<p>调用此方法后，系统虽不能保证数据是否真正落盘成功，但能保证写入的顺序，也即如果后写入的数据成功落盘，则先写入的数据一定已经落盘。</p>
<blockquote>
<p>注：Apple的SSD都支持。</p>
</blockquote>
<p>Apple的官方建议[2]是：如果有强落盘需求，可以用FULL_SYNC，但这会导致性能下降及设备损耗，如果只需要保证写入顺序，则建议用F_BARRIERFSYNC。</p>
<blockquote>
<p><strong>Minimize explicit storage synchronization</strong></p>
<p>Writing data on iOS adds the data to a unified buffer cache that the system then writes to file storage. Forcing iOS to flush pending filesystem changes from the unified buffer can result in unnecessary writes to the disk, degrading performance and increasing wear on the device. When possible, avoid calling <code>fsync(_:)</code>, or using the <code>fcntl(_:_:)</code> <code>F_FULLFSYNC</code> operation to force a flush.</p>
<p>Some apps require a <em>write barrier</em> to ensure data persistence before subsequent operations can proceed. Most apps can use the <code>fcntl(_:_:)</code> <code>F_BARRIERFSYNC</code> for this.</p>
<p>Only use <code>F_FULLFSYNC</code> when your app requires a strong expectation of data persistence. Note that <code>F_FULLFSYNC</code> represents a best-effort guarantee that iOS writes data to the disk, but data can still be lost in the case of sudden power loss.</p>
</blockquote>
<h3 data-id="heading-2">三、例子：SQLite主线的问题和苹果的优化</h3>
<p>SQLite是移动端最常用的文件数据库，读写文件是其功能的基石。SQLite是如何实现落盘的呢？看看SQLite仓库主线逻辑[3]：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-id">#elif</span> HAVE_FULLFSYNC
  <span class="hljs-built_in">if</span>( fullSync ){
    rc = <span class="hljs-built_in">osFcntl</span>(fd, F_FULLFSYNC, <span class="hljs-number">0</span>);
  }else{
    rc = <span class="hljs-number">1</span>;
  }
  <span class="hljs-comment">/* If the FULLFSYNC failed, fall back to attempting an fsync().
  ** It shouldn't be possible for fullfsync to fail on the local
  ** file system (on OSX), so failure indicates that FULLFSYNC
  ** isn't supported for this file system. So, attempt an fsync
  ** and (for now) ignore the overhead of a superfluous fcntl call.
  ** It'd be better to detect fullfsync support once and avoid
  ** the fcntl call every time sync is called.
  */</span>
  <span class="hljs-built_in">if</span>( rc ) rc = <span class="hljs-built_in">fsync</span>(fd);

<span class="hljs-selector-id">#elif</span> <span class="hljs-built_in">defined</span>(__APPLE__)
  <span class="hljs-comment">/* fdatasync() on HFS+ doesn't yet flush the file size if it changed correctly
  ** so currently we default to the macro that redefines fdatasync to fsync
  */</span>
  rc = <span class="hljs-built_in">fsync</span>(fd);
</code></pre>
<p>如果开了<code>PRAGMA fullsync = ON</code>，也是使用了<code>F_FULLSYNC</code>来保证写入成功。没开的话是使用fsync，这里应该是有问题的。</p>
<p>那iOS的<code>libsqlite</code>是怎么做的呢？这个库苹果没有开源，只能逆向看一下，搜搜相关的几个方法，应该在这一段汇编这里：</p>
<pre><code class="hljs language-ini" lang="ini">                                    loc_1b0d62f40:
00000001b0d62f40 682240F9               ldr        x8, <span class="hljs-section">[x19, #0x40]</span>             <span class="hljs-comment">; CODE XREF=sub_1b0d62d34+444</span>
00000001b0d62f44 880000B4               cbz        x8, loc_1b0d62f54

00000001b0d62f48 080140F9               ldr        x8, <span class="hljs-section">[x8]</span>
00000001b0d62f4c 08A940B9               ldr        w8, <span class="hljs-section">[x8, #0xa8]</span>
00000001b0d62f50 28FDFF35               cbnz       w8, loc_1b0d62ef4

                                    loc_1b0d62f54:
00000001b0d62f54 280C0012               and        w8, w1, <span class="hljs-comment">#0xf                 ; CODE XREF=sub_1b0d62d34+528</span>
00000001b0d62f58 1F0D0071               cmp        w8, <span class="hljs-comment">#0x3</span>
00000001b0d62f5c A80A8052               mov        w8, <span class="hljs-comment">#0x55</span>
00000001b0d62f60 08019F1A               csel       w8, w8, wzr, eq
00000001b0d62f64 69024239               ldrb       w9, <span class="hljs-section">[x19, #0x80]</span>
00000001b0d62f68 3F011F72               tst        w9, <span class="hljs-comment">#0x2</span>
00000001b0d62f6c 69068052               mov        w9, <span class="hljs-comment">#0x33</span>
00000001b0d62f70 0101891A               csel       w1, w8, w9, eq
00000001b0d62f74 741A40B9               ldr        w20, <span class="hljs-section">[x19, #0x18]</span>
00000001b0d62f78 A1000034               cbz        w1, loc_1b0d62f8c

00000001b0d62f7c FF0300F9               str        xzr, <span class="hljs-section">[sp, #0x170 + var_170]</span>
00000001b0d62f80 E00314AA               mov        x0, x20
00000001b0d62f84 7B93C794               bl         0x1b3f47d70
00000001b0d62f88 60040034               cbz        w0, loc_1b0d63014

                                    loc_1b0d62f8c:
00000001b0d62f8c E00314AA               mov        x0, x20                      <span class="hljs-comment">; argument "fildes" for method imp___auth_stubs__fsync, CODE XREF=sub_1b0d62d34+580</span>
00000001b0d62f90 9C7A0494               bl         imp___auth_stubs__fsync      <span class="hljs-comment">; fsync</span>
00000001b0d62f94 00040034               cbz        w0, loc_1b0d63014
</code></pre>
<p>翻译成C语言伪代码：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// x19 is the context pointer (self/this)</span>
<span class="hljs-comment">// w1 is an input argument (flags)</span>

<span class="hljs-comment">// 1. Pre-check</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">SubObject</span>* <span class="hljs-title">obj</span> =</span> self-&gt;ptr_40;
<span class="hljs-keyword">if</span> (obj) {
    <span class="hljs-keyword">if</span> (obj-&gt;ptr_0-&gt;status_a8 != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">goto</span> loc_1b0d62ef4; <span class="hljs-comment">// Busy/Error path</span>
    }
}

<span class="hljs-comment">// 2. Determine Sync Command</span>
<span class="hljs-type">int</span> fd = self-&gt;file_descriptor; <span class="hljs-comment">// offset 0x18</span>
<span class="hljs-type">int</span> command = <span class="hljs-number">0</span>;

<span class="hljs-comment">// Check config flag at offset 0x80</span>
<span class="hljs-keyword">if</span> (self-&gt;flags_80 &amp; <span class="hljs-number">0x02</span>) {
    command = <span class="hljs-number">0x33</span>; <span class="hljs-comment">// F_FULLFSYNC (51)</span>
} 
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((w1 &amp; <span class="hljs-number">0x0F</span>) == <span class="hljs-number">3</span>) {
    command = <span class="hljs-number">0x55</span>; <span class="hljs-comment">// F_BARRIERFSYNC (85)</span>
}

<span class="hljs-comment">// 3. Try Specialized Sync</span>
<span class="hljs-type">int</span> result = <span class="hljs-number">-1</span>;
<span class="hljs-keyword">if</span> (command != <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// Likely fcntl(fd, command, 0)</span>
    result = unknown_func_1b3f47d70(fd, command, <span class="hljs-number">0</span>); 
    
    <span class="hljs-keyword">if</span> (result == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">goto</span> success; <span class="hljs-comment">// loc_1b0d63014</span>
    }
}

<span class="hljs-comment">// 4. Fallback to standard fsync</span>
<span class="hljs-comment">// Reached if command was 0 OR if specialized sync failed</span>
result = fsync(fd);

<span class="hljs-keyword">if</span> (result == <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">goto</span> success;
}

<span class="hljs-comment">// ... handle error ...</span>
</code></pre>
<p>可以看出这个逻辑中既有<code>F_FULLSYNC</code>又有<code>F_BARRIERFSYNC</code>。写了个简单demo验证了一下，<code>PRAGMA fullsync = ON</code>会用<code>F_FULLSYNC</code>，<code>PRAGMA fullsync = OFF</code>用的是<code>F_BARRIERFSYNC</code>。</p>
<p>所以，如果在苹果系统上使用自己编译的sqlite库时，需要注意把这个逻辑加上。</p>
<p>*<em>总之，在iOS/macOS平台写文件的场景，需要考虑好对性能、稳定性的需求，选用合适的系统机制。</em></p>
<h3 data-id="heading-3">参考资料</h3>
<ul>
<li>[1] <a href="https://link.juejin.cn?target=https%3A%2F%2Fchromium-review.googlesource.com%2Fc%2Fchromium%2Fsrc%2F%2B%2F1400159" target="_blank" title="https://chromium-review.googlesource.com/c/chromium/src/+/1400159" ref="nofollow noopener noreferrer">chromium-review.googlesource.com/c/chromium/…</a></li>
<li>[2] <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Fxcode%2Freducing-disk-writes" target="_blank" title="https://developer.apple.com/documentation/xcode/reducing-disk-writes" ref="nofollow noopener noreferrer">developer.apple.com/documentati…</a></li>
<li>[3] <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsqlite%2Fsqlite%2Fblob%2Fmaster%2Fsrc%2Fos_unix.c%23L3817" target="_blank" title="https://github.com/sqlite/sqlite/blob/master/src/os_unix.c#L3817" ref="nofollow noopener noreferrer">github.com/sqlite/sqli…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows 系统中 fnm 安装与配置指南]]></title>    <link>https://juejin.cn/post/7598465042968625192</link>    <guid>https://juejin.cn/post/7598465042968625192</guid>    <pubDate>2026-01-24T10:42:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598465042968625192" data-draft-id="7598480267218075682" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows 系统中 fnm 安装与配置指南"/> <meta itemprop="keywords" content="Node.js"/> <meta itemprop="datePublished" content="2026-01-24T10:42:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿虎儿"/> <meta itemprop="url" content="https://juejin.cn/user/3394908210857901"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows 系统中 fnm 安装与配置指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394908210857901/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿虎儿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T10:42:31.000Z" title="Sat Jan 24 2026 10:42:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Windows 系统中 fnm 安装与配置指南</h2>
<p>本文档介绍如何在 Windows 系统中安装 fnm (Fast Node Manager) 并配置 CMD、PowerShell 和 PowerShell 7 终端以自动加载 Node.js 环境。</p>
<h3 data-id="heading-1">前提条件</h3>
<ul>
<li>Windows 10 或更高版本</li>
<li>已安装 WinGet（Windows 包管理器）</li>
</ul>
<h3 data-id="heading-2">安装 fnm</h3>
<p>使用 WinGet 安装 fnm：</p>
<pre><code class="hljs language-powershell" lang="powershell">winget install Schniz.fnm
</code></pre>
<h3 data-id="heading-3">配置终端</h3>
<h4 data-id="heading-4">1. 配置 PowerShell 7</h4>
<p>PowerShell 7 使用独立的配置文件路径。需要创建以下配置文件：</p>
<pre><code class="hljs language-powershell" lang="powershell"># 创建 PowerShell 7 配置目录
New-Item -ItemType Directory -Path "$env:USERPROFILE\Documents\PowerShell" -Force

# 创建配置文件
New-Item -ItemType File -Path "$env:USERPROFILE\Documents\PowerShell\Microsoft.PowerShell_profile.ps1" -Force
</code></pre>
<p>在配置文件中添加以下内容：</p>
<pre><code class="hljs language-powershell" lang="powershell">fnm env --use-on-cd | Out-String | Invoke-Expression
</code></pre>
<p>可以通过以下命令一次性完成：</p>
<pre><code class="hljs language-powershell" lang="powershell">New-Item -ItemType Directory -Path 'C:\Users\leehoo\Documents\PowerShell' -Force
Set-Content -Path 'C:\Users\leehoo\Documents\PowerShell\Microsoft.PowerShell_profile.ps1' -Value 'fnm env --use-on-cd | Out-String | Invoke-Expression'
</code></pre>
<h4 data-id="heading-5">2. 配置 Windows PowerShell</h4>
<p>Windows PowerShell 使用以下配置文件路径：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">C:\Users\leehoo\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1</span>
</code></pre>
<p>如果文件不存在，创建它并添加以下内容：</p>
<pre><code class="hljs language-powershell" lang="powershell">fnm env --use-on-cd | Out-String | Invoke-Expression
</code></pre>
<h4 data-id="heading-6">3. 配置 CMD</h4>
<p>CMD 没有配置文件机制，需要通过注册表设置 AutoRun。</p>
<h5 data-id="heading-7">步骤 1：生成 fnm 初始化脚本</h5>
<pre><code class="hljs language-powershell" lang="powershell">fnm env --use-on-cd --shell cmd | ForEach-Object { '@' + $_ } | Out-File -FilePath "$env:APPDATA\fnm\fnm-init.cmd" -Encoding ASCII
</code></pre>
<h5 data-id="heading-8">步骤 2：设置注册表 AutoRun</h5>
<pre><code class="hljs language-powershell" lang="powershell">reg add 'HKCU\Software\Microsoft\Command Processor' /v AutoRun /t REG_SZ /d "call $env:APPDATA\fnm\fnm-init.cmd" /f
</code></pre>
<h3 data-id="heading-9">验证配置</h3>
<h4 data-id="heading-10">PowerShell 7 / Windows PowerShell</h4>
<p>重新打开 PowerShell 终端，运行：</p>
<pre><code class="hljs language-powershell" lang="powershell">node --version
npm --version
</code></pre>
<h4 data-id="heading-11">CMD</h4>
<p>重新打开 CMD 终端，运行：</p>
<pre><code class="hljs language-cmd" lang="cmd">node -v
npm -v
</code></pre>
<h3 data-id="heading-12">常用 fnm 命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 列出已安装的 Node.js 版本</span>
fnm list

<span class="hljs-comment"># 安装 Node.js 版本</span>
fnm install 20.10.0

<span class="hljs-comment"># 切换 Node.js 版本</span>
fnm use 20.10.0

<span class="hljs-comment"># 设置默认版本</span>
fnm default 20.10.0

<span class="hljs-comment"># 卸载版本</span>
fnm uninstall 20.10.0
</code></pre>
<h3 data-id="heading-13">注意事项</h3>
<ol>
<li>每次修改配置后，需要重新打开终端才能生效</li>
<li><code>--use-on-cd</code> 选项会在切换目录时自动检测并使用对应的 Node.js 版本（基于 .nvmrc 或 package.json）</li>
<li>CMD 的 AutoRun 设置会影响所有 CMD 窗口</li>
<li>如果需要移除 CMD 的 AutoRun 设置，运行：</li>
</ol>
<pre><code class="hljs language-powershell" lang="powershell">reg delete 'HKCU\Software\Microsoft\Command Processor' /v AutoRun /f
</code></pre>
<h3 data-id="heading-14">配置文件位置总结</h3>

























<table><thead><tr><th>终端</th><th>配置文件路径</th></tr></thead><tbody><tr><td>PowerShell 7</td><td><code>C:\Users\leehoo\Documents\PowerShell\Microsoft.PowerShell_profile.ps1</code></td></tr><tr><td>Windows PowerShell</td><td><code>C:\Users\leehoo\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1</code></td></tr><tr><td>CMD</td><td>注册表：<code>HKEY_CURRENT_USER\Software\Microsoft\Command Processor\AutoRun</code></td></tr><tr><td>fnm 初始化脚本</td><td><code>C:\Users\leehoo\AppData\Roaming\fnm\fnm-init.cmd</code></td></tr></tbody></table>
<h3 data-id="heading-15">故障排除</h3>
<h4 data-id="heading-16">CMD 中显示命令输出</h4>
<p>如果 CMD 启动时显示 SET 命令，确保 fnm-init.cmd 文件每行都以 <code>@</code> 开头：</p>
<pre><code class="hljs language-cmd" lang="cmd">@SET PATH=...
@SET FNM_MULTISHELL_PATH=...
</code></pre>
<h4 data-id="heading-17">Node.js 命令不可用</h4>
<ol>
<li>确认 fnm 已正确安装：<code>fnm --version</code></li>
<li>确认已安装 Node.js 版本：<code>fnm list</code></li>
<li>检查配置文件路径是否正确</li>
<li>重新打开终端</li>
</ol>
<h4 data-id="heading-18">PowerShell 配置不生效</h4>
<ol>
<li>检查配置文件是否存在</li>
<li>运行 <code>$PROFILE</code> 查看当前配置文件路径</li>
<li>手动加载配置：<code>. $PROFILE</code></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个开箱即用的鸿蒙异步任务同步队列——JSyncQueue]]></title>    <link>https://juejin.cn/post/7598490039488872483</link>    <guid>https://juejin.cn/post/7598490039488872483</guid>    <pubDate>2026-01-24T10:52:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598490039488872483" data-draft-id="7598464972912279592" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个开箱即用的鸿蒙异步任务同步队列——JSyncQueue"/> <meta itemprop="keywords" content="HarmonyOS,TypeScript,Android"/> <meta itemprop="datePublished" content="2026-01-24T10:52:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江澎涌"/> <meta itemprop="url" content="https://juejin.cn/user/1820446986338504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个开箱即用的鸿蒙异步任务同步队列——JSyncQueue
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1820446986338504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江澎涌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T10:52:18.000Z" title="Sat Jan 24 2026 10:52:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、简介</h2>
<p>在鸿蒙应用开发中，异步任务的顺序执行是一个常见需求。当多个异步任务需要按照特定顺序执行时，如果不加控制，可能会导致执行顺序混乱。</p>
<blockquote>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzincPower%2FJSyncQueue" target="_blank" title="https://github.com/zincPower/JSyncQueue" ref="nofollow noopener noreferrer">github.com/zincPower/J…</a></p>
</blockquote>
<p>JSyncQueue 提供了一个简洁的解决方案：</p>
<ul>
<li><strong>顺序执行保证</strong>：所有任务严格按照入队顺序执行，即使任务内部有异步操作也能保证顺序</li>
<li><strong>双模式支持</strong>：支持 "立即执行" 和 "延时执行"，满足不同场景需求</li>
<li><strong>双任务模式</strong>：支持 "Message 消息模式" 和 "Runnable 闭包模式"</li>
<li><strong>任务取消和管理</strong>：可随时取消指定任务或清空整个队列</li>
<li><strong>任务结果</strong>：通过 <code>getResult()</code> 获取任务执行结果，支持 <code>then/catch/finally</code></li>
<li><strong>可继承扩展</strong>：通过继承 JSyncQueue 并重写 <code>onHandleMessage</code> 方法，实现自定义消息处理逻辑</li>
</ul>
<p>项目架构如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3eb3539905d4a429dd6b7d2e6abbda2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769856738&amp;x-signature=R44uEHq%2BG5KYwgJOix0uUPZHg4o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、安装</h2>
<pre><code class="hljs language-bash" lang="bash">ohpm install jsyncqueue
</code></pre>
<h2 data-id="heading-2">三、快速开始</h2>
<h3 data-id="heading-3">3-1、基础使用</h3>
<p>可以直接使用 JSyncQueue 无需继承，但仅支持 Runnable 模式（post/postDelay）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSyncQueue</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'jsyncqueue'</span>

<span class="hljs-comment">// 创建队列</span>
<span class="hljs-keyword">const</span> queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSyncQueue</span>(<span class="hljs-string">"MyQueue"</span>)

<span class="hljs-comment">// 添加任务</span>
queue.<span class="hljs-title function_">post</span>(<span class="hljs-keyword">async</span> (taskId) =&gt; {
  <span class="hljs-comment">// 执行异步操作</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">someAsyncOperation</span>()
  <span class="hljs-keyword">return</span> result
}).<span class="hljs-title function_">getResult</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`任务完成: <span class="hljs-subst">${result}</span>`</span>)
}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`任务失败: <span class="hljs-subst">${error}</span>`</span>)
})
</code></pre>
<h3 data-id="heading-4">3-2、继承使用</h3>
<p>继承 JSyncQueue 后，既可以使用 Message 模式（sendMessage/sendMessageDelay）处理消息，也可以使用 Runnable 模式（post/postDelay）执行闭包。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSyncQueue</span>, <span class="hljs-title class_">Message</span>, <span class="hljs-title class_">Any</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'jsyncqueue'</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyQueue</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">JSyncQueue</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onHandleMessage</span>(<span class="hljs-attr">message</span>: <span class="hljs-title class_">Message</span>, <span class="hljs-attr">taskId</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">what</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"say_hello"</span>:
        <span class="hljs-keyword">const</span> name = message.<span class="hljs-property">data</span>[<span class="hljs-string">"name"</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-string">`你好，<span class="hljs-subst">${name}</span>！`</span>
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
    }
  }
}

<span class="hljs-comment">// 使用自定义队列</span>
<span class="hljs-keyword">const</span> queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyQueue</span>(<span class="hljs-string">"MyQueue"</span>)
queue.<span class="hljs-title function_">sendMessage</span>({
  <span class="hljs-attr">what</span>: <span class="hljs-string">"say_hello"</span>,
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"小明"</span> }
}).<span class="hljs-title function_">getResult</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result) <span class="hljs-comment">// 输出: 你好，小明！</span>
})
</code></pre>
<h2 data-id="heading-5">四、核心概念</h2>
<h3 data-id="heading-6">4-1、“立即执行” 和 “延时执行”</h3>

























<table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>post(runnable)</code></td><td>立即将闭包加入队列执行</td></tr><tr><td><code>postDelay(runnable, delay)</code></td><td>延时指定毫秒后将闭包加入队列执行</td></tr><tr><td><code>sendMessage(message)</code></td><td>立即将消息加入队列执行</td></tr><tr><td><code>sendMessageDelay(message, delay)</code></td><td>延时指定毫秒后将消息加入队列执行</td></tr></tbody></table>
<h3 data-id="heading-7">4-2、“Message 模式” 和 “Runnable 模式”</h3>
<p><strong>Runnable 模式</strong>：直接传入一个闭包函数，适合简单的一次性任务。</p>
<pre><code class="hljs language-typescript" lang="typescript">queue.<span class="hljs-title function_">post</span>(<span class="hljs-keyword">async</span> (taskId) =&gt; {
  <span class="hljs-comment">// 直接在闭包中编写执行逻辑</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">"任务结果"</span>
})
</code></pre>
<p><strong>Message 模式</strong>：发送消息到队列，由 <code>onHandleMessage</code> 方法处理，适合需要集中管理业务逻辑的场景。</p>
<pre><code class="hljs language-typescript" lang="typescript">queue.<span class="hljs-title function_">sendMessage</span>({
  <span class="hljs-attr">what</span>: <span class="hljs-string">"action_type"</span>,
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">key</span>: <span class="hljs-string">"value"</span> }
})
</code></pre>
<blockquote>
<p>注意：直接使用 JSyncQueue 实例时，Message 模式的消息不会被处理（<code>onHandleMessage</code> 默认返回 <code>undefined</code>）。需要继承 JSyncQueue 并重写 <code>onHandleMessage</code> 方法才能处理消息。</p>
</blockquote>
<h2 data-id="heading-8">五、API 文档</h2>
<h3 data-id="heading-9">5-1、JSyncQueue 类</h3>
<h4 data-id="heading-10">构造函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">constructor</span>(<span class="hljs-params">queueName: <span class="hljs-built_in">string</span></span>)
</code></pre>
<p>创建一个同步队列实例。</p>
<ul>
<li><code>queueName</code>: 队列名称，用于标识和调试</li>
</ul>
<h4 data-id="heading-11">方法</h4>



























































<table><thead><tr><th>方法</th><th>参数</th><th>返回值</th><th>说明</th></tr></thead><tbody><tr><td><code>post(runnable)</code></td><td><code>runnable: (taskId: number) =&gt; Promise&lt;Any&gt;</code></td><td><code>Task</code></td><td>立即执行闭包</td></tr><tr><td><code>postDelay(runnable, delay)</code></td><td><code>runnable: (taskId: number) =&gt; Promise&lt;Any&gt;</code>, <code>delay: number</code></td><td><code>Task</code></td><td>延时执行闭包，delay 单位为毫秒</td></tr><tr><td><code>sendMessage(message)</code></td><td><code>message: Message</code></td><td><code>Task</code></td><td>立即发送消息</td></tr><tr><td><code>sendMessageDelay(message, delay)</code></td><td><code>message: Message</code>, <code>delay: number</code></td><td><code>Task</code></td><td>延时发送消息，delay 单位为毫秒</td></tr><tr><td><code>cancel(taskId)</code></td><td><code>taskId: number</code></td><td><code>void</code></td><td>取消指定任务</td></tr><tr><td><code>clear()</code></td><td>-</td><td><code>void</code></td><td>清空队列中所有等待的任务</td></tr><tr><td><code>dumpInfo()</code></td><td>-</td><td><code>string</code></td><td>获取队列调试信息</td></tr><tr><td><code>onHandleMessage(message, taskId)</code></td><td><code>message: Message</code>, <code>taskId: number</code></td><td><code>Promise&lt;Any&gt;</code></td><td>消息处理方法，子类可重写</td></tr></tbody></table>
<h4 data-id="heading-12">属性</h4>




















<table><thead><tr><th>属性</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>queueName</code></td><td><code>string</code></td><td>队列名称（只读）</td></tr><tr><td><code>length</code></td><td><code>number</code></td><td>当前队列中的任务数量（只读）</td></tr></tbody></table>
<h3 data-id="heading-13">5-2、Message 接口</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Message</span> {
  <span class="hljs-attr">what</span>: <span class="hljs-built_in">string</span>   <span class="hljs-comment">// 消息类型</span>
  <span class="hljs-attr">data</span>: <span class="hljs-title class_">Any</span>      <span class="hljs-comment">// 消息数据</span>
}
</code></pre>
<h3 data-id="heading-14">5-3、Task 接口</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Task</span> {
  <span class="hljs-title function_">cancel</span>(): <span class="hljs-built_in">void</span>                  <span class="hljs-comment">// 取消任务</span>
  <span class="hljs-title function_">getResult</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt;       <span class="hljs-comment">// 获取任务结果</span>
  <span class="hljs-title function_">getTaskId</span>(): <span class="hljs-built_in">number</span>            <span class="hljs-comment">// 获取任务 ID</span>
}
</code></pre>
<h3 data-id="heading-15">5-4、异常类型</h3>
<h4 data-id="heading-16">JSyncQueueCancelException</h4>
<p>任务被取消时抛出的异常。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">JSyncQueueCancelException</span> {
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>
}
</code></pre>
<h4 data-id="heading-17">JSyncQueueException</h4>
<p>队列内部错误时抛出的异常。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">JSyncQueueException</span> {
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>
}
</code></pre>
<h2 data-id="heading-18">六、使用示例</h2>
<h3 data-id="heading-19">6-1、直接使用 JSyncQueue + post()</h3>
<p>适用于简单场景，直接使用闭包处理任务。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSyncQueue</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'jsyncqueue'</span>

<span class="hljs-keyword">const</span> queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSyncQueue</span>(<span class="hljs-string">"SimpleQueue"</span>)

<span class="hljs-comment">// 添加多个任务，它们会按顺序执行</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
  queue.<span class="hljs-title function_">post</span>(<span class="hljs-keyword">async</span> (taskId) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`开始执行任务 <span class="hljs-subst">${i}</span>`</span>)
    <span class="hljs-comment">// 模拟异步操作</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>))
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`完成任务 <span class="hljs-subst">${i}</span>`</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">`结果 <span class="hljs-subst">${i}</span>`</span>
  }).<span class="hljs-title function_">getResult</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`任务 <span class="hljs-subst">${i}</span> 返回: <span class="hljs-subst">${result}</span>`</span>)
  })
}
</code></pre>
<h3 data-id="heading-20">6-2、继承 JSyncQueue 自定义队列</h3>
<p>适用于需要集中管理业务逻辑的场景，继承后同样支持 Runnable 模式。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSyncQueue</span>, <span class="hljs-title class_">Message</span>, <span class="hljs-title class_">Any</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'jsyncqueue'</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserQueue</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">JSyncQueue</span> {
  <span class="hljs-keyword">private</span> userCount = <span class="hljs-number">0</span>

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onHandleMessage</span>(<span class="hljs-attr">message</span>: <span class="hljs-title class_">Message</span>, <span class="hljs-attr">taskId</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">what</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"register"</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">userCount</span>++
        <span class="hljs-keyword">const</span> name = message.<span class="hljs-property">data</span>[<span class="hljs-string">"name"</span>]
        <span class="hljs-comment">// 模拟异步注册操作</span>
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">simulateAsyncOperation</span>()
        <span class="hljs-keyword">return</span> <span class="hljs-string">`用户 <span class="hljs-subst">${name}</span> 注册成功，当前用户数: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.userCount}</span>`</span>

      <span class="hljs-keyword">case</span> <span class="hljs-string">"login"</span>:
        <span class="hljs-keyword">const</span> username = message.<span class="hljs-property">data</span>[<span class="hljs-string">"username"</span>]
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">simulateAsyncOperation</span>()
        <span class="hljs-keyword">return</span> <span class="hljs-string">`用户 <span class="hljs-subst">${username}</span> 登录成功`</span>

      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
    }
  }

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">simulateAsyncOperation</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>))
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> userQueue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserQueue</span>(<span class="hljs-string">"UserQueue"</span>)

userQueue.<span class="hljs-title function_">sendMessage</span>({
  <span class="hljs-attr">what</span>: <span class="hljs-string">"register"</span>,
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span> }
}).<span class="hljs-title function_">getResult</span>().<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>)

userQueue.<span class="hljs-title function_">sendMessage</span>({
  <span class="hljs-attr">what</span>: <span class="hljs-string">"login"</span>,
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">username</span>: <span class="hljs-string">"张三"</span> }
}).<span class="hljs-title function_">getResult</span>().<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>)

<span class="hljs-comment">// 继承后同样可以使用 post()</span>
userQueue.<span class="hljs-title function_">post</span>(<span class="hljs-keyword">async</span> (taskId) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"执行自定义闭包任务"</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-string">"闭包任务完成"</span>
}).<span class="hljs-title function_">getResult</span>().<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>)
</code></pre>
<h3 data-id="heading-21">6-3、延时执行示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSyncQueue</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'jsyncqueue'</span>

<span class="hljs-keyword">const</span> queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSyncQueue</span>(<span class="hljs-string">"DelayQueue"</span>)

<span class="hljs-comment">// 延时 1 秒后执行</span>
queue.<span class="hljs-title function_">postDelay</span>(<span class="hljs-keyword">async</span> (taskId) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"延时任务执行了"</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-string">"延时任务结果"</span>
}, <span class="hljs-number">1000</span>).<span class="hljs-title function_">getResult</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`延时任务返回: <span class="hljs-subst">${result}</span>`</span>)
})

<span class="hljs-comment">// 延时发送消息（需要继承实现 onHandleMessage）</span>
queue.<span class="hljs-title function_">sendMessageDelay</span>({
  <span class="hljs-attr">what</span>: <span class="hljs-string">"delayed_action"</span>,
  <span class="hljs-attr">data</span>: { <span class="hljs-attr">info</span>: <span class="hljs-string">"延时消息"</span> }
}, <span class="hljs-number">2000</span>)
</code></pre>
<h3 data-id="heading-22">6-4、任务取消示例</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSyncQueue</span>, <span class="hljs-title class_">Task</span>, <span class="hljs-title class_">JSyncQueueCancelException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'jsyncqueue'</span>

<span class="hljs-keyword">const</span> queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSyncQueue</span>(<span class="hljs-string">"CancelQueue"</span>)

<span class="hljs-comment">// 添加任务并保存引用</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">task</span>: <span class="hljs-title class_">Task</span> = queue.<span class="hljs-title function_">post</span>(<span class="hljs-keyword">async</span> (taskId) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"任务开始执行"</span>)
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">5000</span>))
  <span class="hljs-keyword">return</span> <span class="hljs-string">"任务完成"</span>
})

<span class="hljs-comment">// 监听任务结果</span>
task.<span class="hljs-title function_">getResult</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`任务成功: <span class="hljs-subst">${result}</span>`</span>)
}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: JSyncQueueCancelException</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`任务被取消: <span class="hljs-subst">${error.message}</span>`</span>)
})

<span class="hljs-comment">// 取消任务（两种方式）</span>
task.<span class="hljs-title function_">cancel</span>()                    <span class="hljs-comment">// 方式1：通过 Task 对象取消</span>
<span class="hljs-comment">// queue.cancel(task.getTaskId()) // 方式2：通过队列和任务ID取消</span>

<span class="hljs-comment">// 清空所有任务</span>
<span class="hljs-comment">// queue.clear()</span>
</code></pre>
<h3 data-id="heading-23">6-5、混合使用示例</h3>
<p>Message 和 Runnable 可以混合使用，它们都会按入队顺序执行。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">JSyncQueue</span>, <span class="hljs-title class_">Message</span>, <span class="hljs-title class_">Any</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'jsyncqueue'</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MixedQueue</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">JSyncQueue</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onHandleMessage</span>(<span class="hljs-attr">message</span>: <span class="hljs-title class_">Message</span>, <span class="hljs-attr">taskId</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`处理消息: <span class="hljs-subst">${message.what}</span>`</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">`消息 <span class="hljs-subst">${message.what}</span> 处理完成`</span>
  }
}

<span class="hljs-keyword">const</span> queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MixedQueue</span>(<span class="hljs-string">"MixedQueue"</span>)

<span class="hljs-comment">// 混合添加任务</span>
queue.<span class="hljs-title function_">post</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Runnable 1"</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-string">"R1"</span>
})

queue.<span class="hljs-title function_">sendMessage</span>({ <span class="hljs-attr">what</span>: <span class="hljs-string">"msg1"</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span> })

queue.<span class="hljs-title function_">post</span>(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Runnable 2"</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-string">"R2"</span>
})

queue.<span class="hljs-title function_">sendMessage</span>({ <span class="hljs-attr">what</span>: <span class="hljs-string">"msg2"</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span> })

<span class="hljs-comment">// 执行顺序：Runnable 1 -&gt; msg1 -&gt; Runnable 2 -&gt; msg2</span>
</code></pre>
<h2 data-id="heading-24">七、作者简介</h2>
<p>掘金：<a href="https://juejin.im/user/5c3033ef51882524ec3a88ba/posts" target="_blank" title="https://juejin.im/user/5c3033ef51882524ec3a88ba/posts">juejin.im/user/5c3033…</a></p>
<p>csdn：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_37625173" target="_blank" title="https://blog.csdn.net/weixin_37625173" ref="nofollow noopener noreferrer">blog.csdn.net/weixin_3762…</a></p>
<p>公众号：微信搜索 "江澎涌"</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[25 分钟把 IPv6“带偏”全网：Cloudflare这次玩大了！]]></title>    <link>https://juejin.cn/post/7598480413803823146</link>    <guid>https://juejin.cn/post/7598480413803823146</guid>    <pubDate>2026-01-24T11:00:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598480413803823146" data-draft-id="7598480413803806762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="25 分钟把 IPv6“带偏”全网：Cloudflare这次玩大了！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-24T11:00:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dcs"/> <meta itemprop="url" content="https://juejin.cn/user/3679404422861902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            25 分钟把 IPv6“带偏”全网：Cloudflare这次玩大了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3679404422861902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dcs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T11:00:45.000Z" title="Sat Jan 24 2026 11:00:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是一场**典型的“看起来只是删了几行配置，实际把闸门拆了”**的事故。</p>
<p>2026 年 1 月 22 日，Cloudflare 在美国迈阿密（Miami）的一个数据中心路由器上，因为<strong>自动化路由策略配置错误</strong>，把一部分原本只该在内部传播的 <strong>IPv6 BGP 前缀</strong>意外对外宣告了出去，形成 <strong>BGP Route Leak（路由泄漏）</strong>。事故持续 <strong>25 分钟</strong>，导致迈阿密骨干链路拥塞、部分客户流量丢包/延迟升高，同时还把一些外部网络的流量“误导”进迈阿密，最终被 Cloudflare 的防火墙过滤规则丢弃（峰值丢了约 12Gbps 入口流量）。</p>
<p>听起来像网络圈的“蝴蝶效应”：你只是在路由策略里挪了一块砖，结果半个街区的车流都改道了🚧。</p>
<hr/>
<h2 data-id="heading-0">什么是 Route Leak：</h2>
<p>不是“断网”，是“指错路”</p>
<p>路由泄漏的本质非常直白：<strong>某个 AS 告诉整个互联网：来我这走，我能带你到终点</strong>——但它其实不该这么说。</p>
<p>BGP 里有个“潜规则”：<strong>从上游（provider）和对等（peer）学到的路由，不能再转发给另一个 peer 或 provider</strong>，否则就违反所谓的 <em>valley-free routing</em>。一旦违反，流量会被吸到不该承载它的网络上，轻则拥塞、抖动，重则大范围不可达。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7171b214005482fa8a71c10b708fa31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769857245&amp;x-signature=%2FIvBJi4saYsQF4P0hPTTUvgoqXo%3D" alt="image.png" loading="lazy"/>
这次事故就是类似的“指路牌摆反了”：Cloudflare 在迈阿密把<strong>从一些 peer 学到的路由</strong>，又转手“推销”给了<strong>其他 peer 和 transit provider</strong>，属于 RFC7908 里提到的多种 route leak 类型混合体（简单理解：该往下游走的路，被错误地往上/平行扩散了）。</p>
<hr/>
<h2 data-id="heading-1">时间线：从合并代码到止血，只花了 25 分钟（但足够难受）</h2>
<p>这次节奏很“现代工程化”：代码合并 → 自动化跑配置 → 线上立刻出事 → 人肉回滚止血 → 再回滚代码。</p>









































<table><thead><tr><th><strong>Time (UTC)</strong></th><th><strong>Event</strong></th></tr></thead><tbody><tr><td>2026-01-22 19:52 UTC</td><td>触发路由策略 bug 的变更合并进网络自动化代码仓库</td></tr><tr><td>2026-01-22 20:25 UTC</td><td>自动化在迈阿密单台边缘路由器运行，开始向 transit/peer 异常宣告（IMPACT START）</td></tr><tr><td>2026-01-22 20:40 UTC</td><td>网络团队开始排查迈阿密的异常 BGP 广告</td></tr><tr><td>2026-01-22 20:44 UTC</td><td>事故升级，开始协同处置</td></tr><tr><td>2026-01-22 20:50 UTC</td><td>操作员手动回滚坏配置，并暂停该路由器的自动化（IMPACT STOP）</td></tr><tr><td>2026-01-22 21:47 UTC</td><td>触发泄漏的代码提交被回滚</td></tr><tr><td>2026-01-22 22:07 UTC</td><td>确认自动化恢复健康，可重新在迈阿密路由器运行</td></tr><tr><td>2026-01-22 22:40 UTC</td><td>迈阿密单台路由器解除自动化暂停</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">“删掉 Bogotá 的前缀”怎么删成了“全都放行”？</h2>
<p>事故起点其实很合理：Cloudflare 之前会把一部分 IPv6 流量经迈阿密转发到哥伦比亚波哥大（Bogotá）数据中心，但随着基础设施升级，这个绕路不需要了，于是要把 Bogotá 相关前缀从迈阿密撤掉。</p>
<p>变更 diff 大概长这样（看着很“无害”对吧？）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[edit policy-options policy-statement 6-COGENT-ACCEPT-EXPORT term ADV-SITELOCAL-GRE-RECEIVER from]</span>
-      prefix-list 6-BOG04-SITE-LOCAL<span class="hljs-comment">;</span>
<span class="hljs-section">[edit policy-options policy-statement 6-COMCAST-ACCEPT-EXPORT term ADV-SITELOCAL-GRE-RECEIVER from]</span>
-      prefix-list 6-BOG04-SITE-LOCAL<span class="hljs-comment">;</span>
<span class="hljs-section">[edit policy-options policy-statement 6-GTT-ACCEPT-EXPORT term ADV-SITELOCAL-GRE-RECEIVER from]</span>
-      prefix-list 6-BOG04-SITE-LOCAL<span class="hljs-comment">;</span>
<span class="hljs-section">[edit policy-options policy-statement 6-LEVEL3-ACCEPT-EXPORT term ADV-SITELOCAL-GRE-RECEIVER from]</span>
-      prefix-list 6-BOG04-SITE-LOCAL<span class="hljs-comment">;</span>
<span class="hljs-section">[edit policy-options policy-statement 6-PRIVATE-PEER-ANYCAST-OUT term ADV-SITELOCAL from]</span>
-      prefix-list 6-BOG04-SITE-LOCAL<span class="hljs-comment">;</span>
<span class="hljs-section">[edit policy-options policy-statement 6-PUBLIC-PEER-ANYCAST-OUT term ADV-SITELOCAL from]</span>
-      prefix-list 6-BOG04-SITE-LOCAL<span class="hljs-comment">;</span>
<span class="hljs-section">[edit policy-options policy-statement 6-PUBLIC-PEER-OUT term ADV-SITELOCAL from]</span>
-      prefix-list 6-BOG04-SITE-LOCAL<span class="hljs-comment">;</span>
<span class="hljs-section">[edit policy-options policy-statement 6-TELEFONICA-ACCEPT-EXPORT term ADV-SITELOCAL-GRE-RECEIVER from]</span>
-      prefix-list 6-BOG04-SITE-LOCAL<span class="hljs-comment">;</span>
<span class="hljs-section">[edit policy-options policy-statement 6-TELIA-ACCEPT-EXPORT term ADV-SITELOCAL-GRE-RECEIVER from]</span>
-      prefix-list 6-BOG04-SITE-LOCAL<span class="hljs-comment">;</span>
</code></pre>
<p>问题就出在：<strong>把 prefix-list 条件删掉后，策略项的匹配条件变得过于宽松</strong>，直接变成了“只要是 internal route-type，我就 accept，然后对外 export”。</p>
<pre><code class="hljs language-sql" lang="sql">policy<span class="hljs-operator">-</span>options policy<span class="hljs-operator">-</span>statement <span class="hljs-number">6</span><span class="hljs-operator">-</span>TELIA<span class="hljs-operator">-</span>ACCEPT<span class="hljs-operator">-</span>EXPORT {
    term ADV<span class="hljs-operator">-</span>SITELOCAL<span class="hljs-operator">-</span>GRE<span class="hljs-operator">-</span>RECEIVER {
        <span class="hljs-keyword">from</span> route<span class="hljs-operator">-</span>type internal;
        <span class="hljs-keyword">then</span> {
            community <span class="hljs-keyword">add</span> <span class="hljs-keyword">STATIC</span><span class="hljs-operator">-</span>ROUTE;
            community <span class="hljs-keyword">add</span> SITE<span class="hljs-operator">-</span><span class="hljs-keyword">LOCAL</span><span class="hljs-operator">-</span>ROUTE;
            community <span class="hljs-keyword">add</span> MIA01;
            community <span class="hljs-keyword">add</span> NORTH<span class="hljs-operator">-</span>AMERICA;
            accept;
        }
    }
}
</code></pre>
<p>这里有个 JunOS/JunOS EVO 的坑点：<code>route-type internal</code> 会匹配<strong>所有非 external 的路由类型</strong>，包括 IBGP 学到的内部路由。于是本来只想“内部可见”的 IPv6 前缀，被这条 export policy 直接放行对外广播了。</p>
<p>一句话：<strong>原来靠 prefix-list 当“门禁”，删了门禁后，剩下的条件相当于“只要你是小区住户，就能把快递站里的所有包裹搬出去”</strong>——策略写得再“优雅”，<code>accept</code> 一落地就成了事故开关🔘。</p>
<hr/>
<h2 data-id="heading-3">影响面：拥塞、丢包、延迟上升，还顺带“误伤”外部网络</h2>
<p>当迈阿密开始对外宣告这些不该宣告的 IPv6 前缀后，互联网路由收敛会让部分流量<strong>被吸到迈阿密</strong>。结果就是：</p>
<ul>
<li>迈阿密—亚特兰大骨干链路出现拥塞，导致一些 Cloudflare 客户流量出现更高的延迟/丢包</li>
<li>被泄漏的前缀所属网络（外部网络）的一部分流量也被引向迈阿密，但 Cloudflare 路由器的防火墙过滤器只允许 Cloudflare/客户相关前缀的流量，导致这部分流量被丢弃（峰值约 12Gbps）</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/962bbee0635c49b0b1bda64d680c21f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769857245&amp;x-signature=scBsrJ%2FJmNTgzZ%2FyLWPwKgfD%2Ffs%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b7aa229da4a45a6b753d0c3b19524fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769857245&amp;x-signature=TpUYoXL4dozUk3%2F8x7%2BEej6zYcs%3D" alt="image.png" loading="lazy"/></p>
<p>同时，路由泄漏的证据也能在路由收集器的历史数据里看到，比如这段 monocle 检索结果（注意 AS path 中 Cloudflare AS13335 出现在不该出现的位置上）：</p>
<pre><code class="hljs language-ruby" lang="ruby">➜  ~ monocle search --start-ts <span class="hljs-number">2026</span>-<span class="hljs-number">01</span>-22<span class="hljs-symbol">T20:</span><span class="hljs-number">24</span><span class="hljs-symbol">:</span>00Z --<span class="hljs-keyword">end</span>-ts <span class="hljs-number">2026</span>-<span class="hljs-number">01</span>-22<span class="hljs-symbol">T20:</span><span class="hljs-number">30</span><span class="hljs-symbol">:</span>00Z --as-path <span class="hljs-string">".*13335[ d$]32934$*"</span>
A|<span class="hljs-params">1769113609.854028</span>|<span class="hljs-number">2801</span><span class="hljs-symbol">:</span><span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">9000</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">6</span><span class="hljs-symbol">:</span><span class="hljs-number">4112</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">64112</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f077</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">64112 22850 174 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2801:14:9000::6:4112:1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>|<span class="hljs-number">22850</span><span class="hljs-symbol">:</span><span class="hljs-number">65151</span>|<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|pit.scl
A|<span class="hljs-params">1769113609.854028</span>|<span class="hljs-number">2801</span><span class="hljs-symbol">:</span><span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">9000</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">6</span><span class="hljs-symbol">:</span><span class="hljs-number">4112</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">64112</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f091</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">64112 22850 174 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2801:14:9000::6:4112:1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>|<span class="hljs-number">22850</span><span class="hljs-symbol">:</span><span class="hljs-number">65151</span>|<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|pit.scl
A|<span class="hljs-params">1769113609.854028</span>|<span class="hljs-number">2801</span><span class="hljs-symbol">:</span><span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">9000</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">6</span><span class="hljs-symbol">:</span><span class="hljs-number">4112</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">64112</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f16f</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">64112 22850 174 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2801:14:9000::6:4112:1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>|<span class="hljs-number">22850</span><span class="hljs-symbol">:</span><span class="hljs-number">65151</span>|<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|pit.scl
A|<span class="hljs-params">1769113609.854028</span>|<span class="hljs-number">2801</span><span class="hljs-symbol">:</span><span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">9000</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">6</span><span class="hljs-symbol">:</span><span class="hljs-number">4112</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">64112</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f17c</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">64112 22850 174 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2801:14:9000::6:4112:1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>|<span class="hljs-number">22850</span><span class="hljs-symbol">:</span><span class="hljs-number">65151</span>|<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|pit.scl
A|<span class="hljs-params">1769113609.854028</span>|<span class="hljs-number">2801</span><span class="hljs-symbol">:</span><span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">9000</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">6</span><span class="hljs-symbol">:</span><span class="hljs-number">4112</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">64112</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f26f</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">64112 22850 174 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2801:14:9000::6:4112:1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>|<span class="hljs-number">22850</span><span class="hljs-symbol">:</span><span class="hljs-number">65151</span>|<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|pit.scl
A|<span class="hljs-params">1769113609.854028</span>|<span class="hljs-number">2801</span><span class="hljs-symbol">:</span><span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">9000</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">6</span><span class="hljs-symbol">:</span><span class="hljs-number">4112</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">64112</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f27c</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">64112 22850 174 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2801:14:9000::6:4112:1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>|<span class="hljs-number">22850</span><span class="hljs-symbol">:</span><span class="hljs-number">65151</span>|<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|pit.scl
A|<span class="hljs-params">1769113609.854028</span>|<span class="hljs-number">2801</span><span class="hljs-symbol">:</span><span class="hljs-number">14</span><span class="hljs-symbol">:</span><span class="hljs-number">9000</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">6</span><span class="hljs-symbol">:</span><span class="hljs-number">4112</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">64112</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f33f</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">64112 22850 174 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2801:14:9000::6:4112:1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>|<span class="hljs-number">22850</span><span class="hljs-symbol">:</span><span class="hljs-number">65151</span>|<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|pit.scl
A|<span class="hljs-params">1769113583.095278</span>|<span class="hljs-number">2001</span><span class="hljs-symbol">:</span><span class="hljs-number">504</span><span class="hljs-symbol">:d</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-number">9544</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">49544</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f17c</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">49544 1299 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2001:504:d::4:9544:1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>|<span class="hljs-number">1299</span><span class="hljs-symbol">:</span><span class="hljs-number">25000</span> <span class="hljs-number">1299</span><span class="hljs-symbol">:</span><span class="hljs-number">25800</span> <span class="hljs-number">49544</span><span class="hljs-symbol">:</span><span class="hljs-number">16000</span> <span class="hljs-number">49544</span><span class="hljs-symbol">:</span><span class="hljs-number">16106</span>|<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|route-views.isc
A|<span class="hljs-params">1769113583.095278</span>|<span class="hljs-number">2001</span><span class="hljs-symbol">:</span><span class="hljs-number">504</span><span class="hljs-symbol">:d</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-number">9544</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">49544</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f27c</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">49544 1299 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2001:504:d::4:9544:1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>|<span class="hljs-number">1299</span><span class="hljs-symbol">:</span><span class="hljs-number">25000</span> <span class="hljs-number">1299</span><span class="hljs-symbol">:</span><span class="hljs-number">25800</span> <span class="hljs-number">49544</span><span class="hljs-symbol">:</span><span class="hljs-number">16000</span> <span class="hljs-number">49544</span><span class="hljs-symbol">:</span><span class="hljs-number">16106</span>|<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|route-views.isc
A|<span class="hljs-params">1769113583.095278</span>|<span class="hljs-number">2001</span><span class="hljs-symbol">:</span><span class="hljs-number">504</span><span class="hljs-symbol">:d</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">4</span><span class="hljs-symbol">:</span><span class="hljs-number">9544</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">49544</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f091</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">49544 1299 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2001:504:d::4:9544:1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>|<span class="hljs-number">1299</span><span class="hljs-symbol">:</span><span class="hljs-number">25000</span> <span class="hljs-number">1299</span><span class="hljs-symbol">:</span><span class="hljs-number">25800</span> <span class="hljs-number">49544</span><span class="hljs-symbol">:</span><span class="hljs-number">16000</span> <span class="hljs-number">49544</span><span class="hljs-symbol">:</span><span class="hljs-number">16106</span>|<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|route-views.isc
A|<span class="hljs-params">1769113584.324483</span>|<span class="hljs-number">2001</span><span class="hljs-symbol">:</span><span class="hljs-number">504</span><span class="hljs-symbol">:d</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">19</span><span class="hljs-symbol">:</span><span class="hljs-number">9524</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">199524</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f091</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">199524 1299 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2001:2035:0:2bfd::1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>||<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|route-views.isc
A|<span class="hljs-params">1769113584.324483</span>|<span class="hljs-number">2001</span><span class="hljs-symbol">:</span><span class="hljs-number">504</span><span class="hljs-symbol">:d</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">19</span><span class="hljs-symbol">:</span><span class="hljs-number">9524</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">199524</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f17c</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">199524 1299 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2001:2035:0:2bfd::1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>||<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|route-views.isc
A|<span class="hljs-params">1769113584.324483</span>|<span class="hljs-number">2001</span><span class="hljs-symbol">:</span><span class="hljs-number">504</span><span class="hljs-symbol">:d</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:</span><span class="hljs-number">19</span><span class="hljs-symbol">:</span><span class="hljs-number">9524</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>|<span class="hljs-params">199524</span>|2<span class="hljs-symbol">a03:</span><span class="hljs-number">2880</span><span class="hljs-symbol">:f27c</span><span class="hljs-symbol">:</span><span class="hljs-symbol">:/</span><span class="hljs-number">48</span>|<span class="hljs-params">199524 1299 3356 13335 32934</span>|<span class="hljs-variable constant_">IGP</span>|<span class="hljs-params">2001:2035:0:2bfd::1</span>|<span class="hljs-number">0</span>|<span class="hljs-params">0</span>||<span class="hljs-params"><span class="hljs-literal">false</span></span>||<span class="hljs-params"/>|route-views.isc
{trimmed}
</code></pre>
<hr/>
<h2 data-id="heading-4">别再迷信“自动化=不会错”</h2>
<p>这次事故最扎心的一点是：<strong>自动化没有坏，坏的是策略生成逻辑里那个“空条件”缺口</strong>。自动化把错误放大得更快、更一致、更“全自动”，所以也更需要“刹车系统”。</p>
<p>Cloudflare 的改进方向很有代表性，基本可以当成网络自动化团队的“安全 checklist”：</p>
<ul>
<li><strong>立刻修补</strong>路由策略自动化里导致错误放行的缺陷，并在同类风险点上补洞</li>
<li>在路由策略里加更强的<strong>基于 BGP community 的防护</strong>：对外 export policy 上明确拒绝“来自 peer/provider 的路由”</li>
<li>在 CI/CD 里做<strong>自动化策略评估</strong>：重点抓“空/错误的 policy term”（像这次就是删 prefix-list 后 term 还 accept）</li>
<li>提前告警：更早发现配置异常与自动化变更的负面效应</li>
<li>更长期的路由安全：验证并推进 **RFC9234（BGP Roles / Only-to-Customer）**等机制，从“协议能力”层面降低本地 AS route leak 的概率</li>
<li>促进 <strong>RPKI ASPA</strong> 之类能力的采用，让异常 AS path 更容易被自动拒绝</li>
</ul>
<hr/>
<h2 data-id="heading-5">结语</h2>
<p>网络世界最怕的不是“改配置”，是“改配置还以为没事”😅</p>
<p>这场 25 分钟的泄漏，杀伤力并不靠持续时间，而靠 <strong>BGP 的传播速度 + 流量的惯性</strong>。更现实的是：只要系统允许“内部路由被 accept 并 export”，那就等于把“内部车道”直接连到了高速入口——迟早会堵。</p>
<p>真正能让系统更稳的，不是“以后小心点”，而是工程化地把风险钉死：</p>
<ul>
<li>关键策略项不能出现“条件被删空但仍 accept”</li>
<li>对外 export 必须能识别并拒绝来自 peer/provider 的路由</li>
<li>自动化要配“策略单测 + 变更评估 + 审计与回滚”三件套</li>
</ul>
<p>毕竟，互联网的路由不是你家路口的指示牌，摆歪了，整座城市都可能跟着绕路。😵‍💫</p>
<hr/>
<p><strong>喜欢就奖励一个“👍”和“在看”呗~</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d74923daef14367b4a55b374fbd6168~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769857245&amp;x-signature=gbh6%2BpE3%2FQbTEF2hQ4qW36hB284%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你不知道的 TypeScript：联合类型与分布式条件类型]]></title>    <link>https://juejin.cn/post/7598532592456007707</link>    <guid>https://juejin.cn/post/7598532592456007707</guid>    <pubDate>2026-01-24T11:02:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598532592456007707" data-draft-id="7598020609281867810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你不知道的 TypeScript：联合类型与分布式条件类型"/> <meta itemprop="keywords" content="前端,TypeScript"/> <meta itemprop="datePublished" content="2026-01-24T11:02:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我不吃饼干"/> <meta itemprop="url" content="https://juejin.cn/user/3263006241480605"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你不知道的 TypeScript：联合类型与分布式条件类型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3263006241480605/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我不吃饼干
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T11:02:47.000Z" title="Sat Jan 24 2026 11:02:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 TypeScript 中，联合类型是非常常用的类型工具，但联合类型在条件类型中的分布式特性，估计会困扰很多人，因为它的行为非常的…不直观。</p>
<p>所以本文尽量用简单的语言和丰富的例子来让大家彻底搞懂联合类型与分布式条件类型，搞不懂也别打我。</p>
<h2 data-id="heading-0">联合类型</h2>
<p><strong>联合类型（Union Types）</strong> 表示一个值可以是几种类型之一。用竖线 <code>|</code> 来分隔每个类型，例如 <code>string | number</code> 表示一个值可以是 <code>string</code> 或 <code>number</code>。</p>
<p>联合类型的基础用法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 表示类型可以为 string 或 number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">StringOrNumber</span> = <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>;

<span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-title class_">StringOrNumber</span>;
value = <span class="hljs-string">"hello"</span>;  <span class="hljs-comment">// ✅</span>
value = <span class="hljs-number">42</span>;       <span class="hljs-comment">// ✅</span>
value = <span class="hljs-literal">true</span>;     <span class="hljs-comment">// ❌ 不能将类型“boolean”分配给类型“StringOrNumber”</span>

<span class="hljs-comment">// 多个类型的联合</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">ID</span> = <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> | <span class="hljs-built_in">symbol</span>;

<span class="hljs-comment">// 字面量类型的联合</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Status</span> = <span class="hljs-string">"pending"</span> | <span class="hljs-string">"success"</span> | <span class="hljs-string">"error"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">StyleType</span> = <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span>;
</code></pre>
<h2 data-id="heading-1">分布式条件类型</h2>
<h3 data-id="heading-2">什么是条件类型？</h3>
<p>条件类型（Conditional Types）的语法类似于 JavaScript 中的三元运算符：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title class_">SomeType</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">OtherType</span> ? <span class="hljs-title class_">TrueType</span> : <span class="hljs-title class_">FalseType</span>;
</code></pre>
<p>它表示：当 <code>extends</code> 左边的类型 <code>SomeType</code> 可以赋值给右侧的类型 <code>OtherType</code> 时，返回 <code>TrueType</code>，否则返回 <code>FalseType</code>。</p>
<p>用法示例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> A = <span class="hljs-built_in">string</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">'string'</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span> <span class="hljs-comment">// false</span>
<span class="hljs-keyword">type</span> B = <span class="hljs-string">'string'</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span> <span class="hljs-comment">// true</span>
<span class="hljs-keyword">type</span> C = <span class="hljs-built_in">number</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">number</span> ? <span class="hljs-built_in">boolean</span> : <span class="hljs-built_in">string</span> <span class="hljs-comment">// boolean</span>
</code></pre>
<p>实际应用中，条件类型常配合泛型一起使用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 判断一个类型是否为字符串类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">IsString</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;
<span class="hljs-keyword">type</span> A = <span class="hljs-title class_">IsString</span>&lt;<span class="hljs-built_in">string</span>&gt;;   <span class="hljs-comment">// true</span>
<span class="hljs-keyword">type</span> B = <span class="hljs-title class_">IsString</span>&lt;<span class="hljs-built_in">number</span>&gt;;   <span class="hljs-comment">// false</span>

<span class="hljs-comment">// 提取函数的返回类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyReturnType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; infer R ? R : <span class="hljs-built_in">never</span>;
<span class="hljs-keyword">type</span> R = <span class="hljs-title class_">MyReturnType</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span>&gt;;  <span class="hljs-comment">// string</span>
</code></pre>
<h3 data-id="heading-3">什么是分布式条件类型？</h3>
<blockquote>
<p>When conditional types act on a generic type, they become <em>distributive</em> when given a union type.</p>
</blockquote>
<p><strong>分布式条件类型（Distributive Conditional Types）</strong> 是指：当条件类型作用于泛型类型时，如果该泛型类型为联合类型，则条件类型将具有 <em>分布性</em>。</p>
<p>简单来说，就是条件类型会分别对联合类型的每个成员进行判断和处理，然后将所有结果重新组合成一个联合类型。我愿意把这理解为 <strong>TypeScript 类型系统中的 "forEach"</strong>。</p>
<p>假设我们有下面的类型 <code>ToArray</code>，可以看到它会把联合类型泛型当做一个整体处理。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ToArray</span>&lt;T&gt; = T[]
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">ToArray</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>&gt;; <span class="hljs-comment">// (string | number)[]</span>
</code></pre>
<p>而如果我们使用条件类型，可以看到此时联合类型的每一个成员会分别应用于条件类型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ToArray</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span> ? T[] : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 当 T 是联合类型时</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">ToArray</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>&gt;; <span class="hljs-comment">// string[] | number[]</span>

<span class="hljs-comment">// 分布过程：</span>
<span class="hljs-comment">// ToArray&lt;string | number&gt;</span>
<span class="hljs-comment">// =&gt;  ToArray&lt;string&gt; | ToArray&lt;number&gt;</span>
<span class="hljs-comment">// =&gt; (string extends any ? string[] : never) | (number extends any ? number[] : never)</span>
<span class="hljs-comment">// =&gt; string[] | number[]</span>
</code></pre>
<p>这里 <code>T extends any</code> 几乎永远为真（除了 <code>T</code> 为 <code>never</code> 的特殊情况），其主要作用是触发分布式条件类型。我们也可以写成 <code>T extends unknown</code> 或 <code>T extends T</code> 等形式来保证条件为真。</p>
<p>但是必须要注意一点：<code>extends</code> 的左边必须为单独的 <code>T</code>。</p>
<h3 data-id="heading-4">阻止分布式行为</h3>
<p>在某些场景下，我们希望在条件类型中使用联合类型，但不希望触发分布式行为，此时可以用方括号 <code>[]</code> 将 <code>extends</code> 关键字两侧的类型包裹起来。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ToArrayNonDist</span>&lt;<span class="hljs-title class_">Type</span>&gt; = [<span class="hljs-title class_">Type</span>] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">any</span>] ? <span class="hljs-title class_">Type</span>[] : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// 此时 ArrOfStrOrNum 不再是一个联合类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ArrOfStrOrNum</span> = <span class="hljs-title class_">ToArrayNonDist</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>&gt;; <span class="hljs-comment">// (string | number)[]</span>
</code></pre>
<p>我们将 <code>extends</code> 左边单独的类型参数（比如前面的 <code>T</code>）称为 <strong>Naked Type</strong> (裸类型，一般指没有被包装的类型)。只有 Naked Type 才会触发分布式条件类型，当它不再是 <code>Naked Type</code> 就不会触发分布式。</p>
<p>事实上，任何形式的包装都可以阻止分布式，例如：</p>
<ul>
<li><code>[T] extends [any]</code> - 用元组包装</li>
<li><code>Array&lt;T&gt; extends Array&lt;any&gt;</code> - 用泛型包装</li>
<li><code>{ value: T } extends { value: any }</code> - 用对象类型包装</li>
</ul>
<p>只要 <code>extends</code> 左边不是单独的联合类型，就不会触发分布式行为。</p>
<h2 data-id="heading-5">分布式条件类型简单实例</h2>
<h3 data-id="heading-6">Exclude</h3>
<p>实现 TypeScript 内置的 <code>Exclude&lt;T, U&gt;</code> 类型：从联合类型 <code>T</code> 中排除 <code>U</code> 中的类型，来构造一个新的类型。</p>
<p>利用分布式条件类型的特性，依次判断联合类型 <code>T</code> 的每个成员是否可以赋值给 <code>U</code>。如果可以赋值，则返回 <code>never</code>（将其从结果中剔除）；否则返回该成员本身（将其保留）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyExclude</span>&lt;T, U&gt; = T <span class="hljs-keyword">extends</span> U ? <span class="hljs-built_in">never</span> : T;

<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T1</span> = <span class="hljs-title class_">MyExclude</span>&lt;<span class="hljs-string">"a"</span> | <span class="hljs-string">"b"</span> | <span class="hljs-string">"c"</span>, <span class="hljs-string">"a"</span>&gt;; <span class="hljs-comment">// "b" | "c"</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T2</span> = <span class="hljs-title class_">MyExclude</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> | <span class="hljs-built_in">boolean</span>, <span class="hljs-built_in">string</span>&gt;; <span class="hljs-comment">// number | boolean</span>
</code></pre>
<h3 data-id="heading-7">Extract</h3>
<p>实现 TypeScript 内置的 <code>Extract&lt;T, U&gt;</code> 类型：从联合类型 <code>T</code> 中提取 <code>U</code> 中的类型，来构造一个新的类型。</p>
<p>与 <code>Exclude</code> 的逻辑完全相反：如果可以赋值给 <code>U</code>，则保留该成员；否则返回 <code>never</code> 将其剔除。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyExtract</span>&lt;T, U&gt; = T <span class="hljs-keyword">extends</span> U ? T : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T3</span> = <span class="hljs-title class_">MyExtract</span>&lt;<span class="hljs-string">"a"</span> | <span class="hljs-string">"b"</span> | <span class="hljs-string">"c"</span>, <span class="hljs-string">"a"</span> | <span class="hljs-string">"b"</span>&gt;; <span class="hljs-comment">// "a" | "b"</span>
<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T4</span> = <span class="hljs-title class_">MyExtract</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> | <span class="hljs-built_in">boolean</span>, <span class="hljs-built_in">number</span> | <span class="hljs-built_in">boolean</span>&gt;; <span class="hljs-comment">// number | boolean</span>
</code></pre>
<h3 data-id="heading-8">Flatten</h3>
<p>把联合类型中的每个数组元素都展平。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Flatten</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (infer U)[] ? U : T;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Nested</span> = <span class="hljs-built_in">string</span>[] | <span class="hljs-built_in">number</span>[];
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Flattened</span> = <span class="hljs-title class_">Flatten</span>&lt;<span class="hljs-title class_">Nested</span>&gt;; <span class="hljs-comment">// string | number</span>
</code></pre>
<h2 data-id="heading-9">实战：实现 Permutation（全排列）</h2>
<p>ok，学完 1+1，接下来我们开始学微积分了，笑：）</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftype-challenges%2Ftype-challenges%2Fblob%2Fmain%2Fquestions%2F00296-medium-permutation%2FREADME.zh-CN.md" target="_blank" title="https://github.com/type-challenges/type-challenges/blob/main/questions/00296-medium-permutation/README.zh-CN.md" ref="nofollow noopener noreferrer">Type Challenges - Permutation</a></p>
<p>实现联合类型的全排列，将联合类型转换成所有可能的全排列数组的联合类型。</p>
<p><code>type perm = Permutation&lt;'A' | 'B' | 'C'&gt;; // ['A', 'B', 'C'] | ['A', 'C', 'B'] | ['B', 'A', 'C'] | ['B', 'C', 'A'] | ['C', 'A', 'B'] | ['C', 'B', 'A']</code></p>
</blockquote>
<p>这是一道典型的分布式条件类型应用题。（谁会知道我为了这道醋包了这篇饺子）。</p>
<p>全排列问题的核心思路是递归（建议先理解 JavaScript 中的全排列实现）。</p>
<p>以 <code>'A' | 'B' | 'C'</code> 为例，递归的思路是：</p>
<ol>
<li>枚举第一个位置的元素（<code>A</code>、<code>B</code> 或 <code>C</code>）</li>
<li>对剩余元素递归求全排列</li>
<li>将当前元素与剩余元素的全排列组合</li>
</ol>
<p>具体来说：</p>
<ul>
<li>当第一个元素为 <code>A</code> 时，剩余元素为 <code>B | C</code>，递归计算 <code>Permutation&lt;'B' | 'C'&gt;</code></li>
<li>当第一个元素为 <code>B</code> 时，剩余元素为 <code>A | C</code>，递归计算 <code>Permutation&lt;'A' | 'C'&gt;</code></li>
<li>当第一个元素为 <code>C</code> 时，剩余元素为 <code>A | B</code>，递归计算 <code>Permutation&lt;'A' | 'B'&gt;</code></li>
</ul>
<p>这里的重点是：<strong>利用分布式条件类型会自动遍历联合类型的每个成员的特点，枚举首元素</strong>。</p>
<p>难点在于：如何获取"除当前元素外的剩余元素"？我们需要一个额外的泛型参数 <code>U</code> 来保存完整的联合类型。当分布式条件类型遍历时，<code>T</code> 是当前元素，<code>U</code> 是完整的联合类型，此时使用 <code>Exclude&lt;U, T&gt;</code> 就能得到剩余元素。</p>
<p>初步实现如下：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Permutation</span>&lt;T, U = T&gt; = 
  T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>
  ? [T, ...<span class="hljs-title class_">Permutation</span>&lt;<span class="hljs-title class_">Exclude</span>&lt;U, T&gt;&gt;]
  : []

<span class="hljs-keyword">type</span> R = <span class="hljs-title class_">Permutation</span>&lt;<span class="hljs-string">'A'</span> | <span class="hljs-string">'B'</span> | <span class="hljs-string">'C'</span>&gt;;
</code></pre>
<p>不幸的是，上面的实现会得到 <code>never</code>。原因是<strong>递归缺少终止条件</strong>。</p>
<p>当递归到最后，<code>T</code> 会变成空的联合类型（即 <code>never</code>），但我们没有特殊处理终止条件，只能得到 <code>never</code>。</p>
<p>我们需要添加一个终止条件判断：当 <code>T</code> 为空集时，不需要再处理直接返回 <code>[]</code>。</p>
<p>判断空集的条件是 <code>[T] extends [never]</code>。这里将 <code>T</code> 包裹在元组中，阻止了分布式行为，使其变成普通的类型检查。只有当 <code>T</code> 为空集时，这个条件才为真。</p>
<p>正确答案：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 生成联合类型的所有排列组合
 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Permutation</span>&lt;T, U = T&gt; = 
  [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">never</span>]
    ? []
    : T <span class="hljs-keyword">extends</span> U
      ? [T, ...<span class="hljs-title class_">Permutation</span>&lt;<span class="hljs-title class_">Exclude</span>&lt;U, T&gt;&gt;]
      : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> <span class="hljs-variable constant_">P1</span> = <span class="hljs-title class_">Permutation</span>&lt;<span class="hljs-string">"a"</span> | <span class="hljs-string">"b"</span> | <span class="hljs-string">"c"</span>&gt;;
<span class="hljs-comment">// =&gt; ["a", "b", "c"] | ["a", "c", "b"] | ["b", "a", "c"] | ["b", "c", "a"] | ["c", "a", "b"] | ["c", "b", "a"]</span>
</code></pre>
<h2 data-id="heading-10">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fdocs%2Fhandbook%2F2%2Feveryday-types.html%23union-types" target="_blank" title="https://www.typescriptlang.org/docs/handbook/2/everyday-types.html#union-types" ref="nofollow noopener noreferrer">TypeScript 联合类型</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.typescriptlang.org%2Fdocs%2Fhandbook%2F2%2Fconditional-types.html" target="_blank" title="https://www.typescriptlang.org/docs/handbook/2/conditional-types.html" ref="nofollow noopener noreferrer">TypeScript 条件类型</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftype-challenges%2Ftype-challenges" target="_blank" title="https://github.com/type-challenges/type-challenges" ref="nofollow noopener noreferrer">Type Challenges</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器指纹管理：如何在 Electron 应用中实现多账号隔离]]></title>    <link>https://juejin.cn/post/7598818096729079846</link>    <guid>https://juejin.cn/post/7598818096729079846</guid>    <pubDate>2026-01-24T08:53:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598818096729079846" data-draft-id="7598435950411235338" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器指纹管理：如何在 Electron 应用中实现多账号隔离"/> <meta itemprop="keywords" content="前端,架构,前端框架"/> <meta itemprop="datePublished" content="2026-01-24T08:53:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云舟吖"/> <meta itemprop="url" content="https://juejin.cn/user/360295546233959"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器指纹管理：如何在 Electron 应用中实现多账号隔离
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295546233959/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云舟吖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T08:53:16.000Z" title="Sat Jan 24 2026 08:53:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文将详细介绍如何在 Electron 应用中实现浏览器指纹管理，涵盖技术选型、架构设计、核心实现到踩坑经验。适合对浏览器自动化、指纹技术感兴趣的开发者阅读。</p>
</blockquote>
<h2 data-id="heading-0">为什么需要浏览器指纹管理</h2>
<p>在 RPA（Robotic Process Automation）自动化场景中，我们经常需要同时管理多个账号。然而，现代网站已经发展出越来越复杂的反爬虫和反自动化检测机制：</p>
<h3 data-id="heading-1">🔍 常见的检测手段</h3>






























<table><thead><tr><th>检测类型</th><th>检测方式</th><th>风险等级</th></tr></thead><tbody><tr><td><strong>浏览器指纹</strong></td><td>Canvas、WebGL、音频指纹等跨会话追踪</td><td>🔴 高</td></tr><tr><td><strong>自动化检测</strong></td><td><code>navigator.webdriver</code>、CDP 痕迹检测</td><td>🔴 高</td></tr><tr><td><strong>账号关联</strong></td><td>通过指纹识别同一设备上的多个账号</td><td>🔴 高</td></tr><tr><td><strong>会话污染</strong></td><td>多账号共享 Cookie/LocalStorage</td><td>🟡 中</td></tr></tbody></table>
<h3 data-id="heading-2">💡 业务痛点</h3>
<pre><code class="hljs language-markdown" lang="markdown">同一台电脑 + 多个账号 = 账号关联风险
<span class="hljs-code">         ↓
网站检测到相同指纹
         ↓
账号被封禁/限制
</span></code></pre>
<p>我们的目标很明确：<strong>在同一台电脑上运行多个具有完全独立指纹的浏览器实例</strong>，每个实例看起来就像来自不同的设备。</p>
<hr/>
<h2 data-id="heading-3">技术选型：为什么选择定制 Chromium</h2>
<h3 data-id="heading-4">方案对比</h3>



































<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>结论</th></tr></thead><tbody><tr><td><strong>Puppeteer Stealth</strong></td><td>易集成、轻量</td><td>指纹修改有限、易被检测</td><td>❌ 不够彻底</td></tr><tr><td><strong>Playwright</strong></td><td>跨浏览器、功能丰富</td><td>无原生指纹修改能力</td><td>❌ 能力不足</td></tr><tr><td><strong>fingerprint-chromium</strong></td><td>深度指纹修改、开源免费</td><td>需定制浏览器</td><td>✅ 最佳选择</td></tr><tr><td><strong>商业指纹浏览器</strong></td><td>功能完善</td><td>成本高、依赖第三方</td><td>❌ 成本考量</td></tr></tbody></table>
<h3 data-id="heading-5">选择 fingerprint-chromium 的理由</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fadryfish%2Ffingerprint-chromium" target="_blank" title="https://github.com/adryfish/fingerprint-chromium" ref="nofollow noopener noreferrer">fingerprint-chromium</a> 是基于 Ungoogled Chromium 的定制版本，它在浏览器底层实现了指纹修改能力：</p>
<ol>
<li><strong>Canvas/WebGL/音频指纹自动修改</strong> - 无需 JavaScript 注入</li>
<li><strong>navigator.webdriver 自动隐藏</strong> - 内置反自动化检测</li>
<li><strong>CDP 检测规避</strong> - 调用 <code>Runtime.enable</code> 不触发检测</li>
<li><strong>通过命令行参数配置</strong> - 灵活的指纹定制能力</li>
</ol>
<hr/>
<h2 data-id="heading-6">系统架构设计</h2>
<h3 data-id="heading-7">整体架构</h3>
<pre><code class="hljs language-css" lang="css">┌──────────────────────────────────────────────────────────────────────┐
│                           RPA 工作流引擎                               │
│                    （任务调度、步骤执行、状态管理）                       │
└──────────────────────────────────┬───────────────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────────────┐
│                          BrowserManager                              │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │  • 浏览器实例生命周期管理                                          │  │
│  │  • 多实例协调与资源控制                                            │  │
│  │  • Storage State 持久化（登录状态保存）                            │  │
│  │  • 指纹配置解析与覆盖                                             │  │
│  └────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────┬───────────────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────────────┐
│                      LocalFingerprintService                         │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │  • 指纹生成（基于种子的确定性算法）                                  │  │
│  │  • Chromium 进程管理                                             │  │
│  │  • CDP 连接管理                                                  │  │
│  │  • 端口动态分配                                                  │  │
│  └────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────┬───────────────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────────────┐
│                    Fingerprint Chromium (定制浏览器)                   │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │  • 通过命令行参数接收指纹配置                                      │  │
│  │  • <span class="hljs-selector-tag">Canvas</span>/WebGL/音频指纹自动修改                                  │  │
│  │  • navigator<span class="hljs-selector-class">.webdriver</span> 隐藏                                     │  │
│  │  • CDP 检测规避                                                 │  │
│  └────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-8">核心模块职责</h3>

























<table><thead><tr><th>模块</th><th>职责</th><th>关键能力</th></tr></thead><tbody><tr><td><strong>BrowserManager</strong></td><td>高层封装</td><td>生命周期管理、配置解析、会话持久化</td></tr><tr><td><strong>LocalFingerprintService</strong></td><td>核心实现</td><td>指纹生成、进程管理、端口分配</td></tr><tr><td><strong>FingerprintConfigValidator</strong></td><td>配置验证</td><td>参数校验、GPU/平台匹配、版本迁移</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">核心实现详解</h2>
<h3 data-id="heading-10">1. 指纹种子机制</h3>
<p>我们使用<strong>种子（Seed）机制</strong>确保指纹的确定性和一致性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基于 profileId 生成确定性种子</span>
<span class="hljs-keyword">const</span> fingerprintSeed = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-title function_">hashCode</span>(profileId)) % <span class="hljs-number">2147483647</span>

<span class="hljs-comment">// 使用种子确定性选择各项配置</span>
<span class="hljs-keyword">const</span> fingerprint = {
  <span class="hljs-attr">userAgent</span>: userAgents[fingerprintSeed % userAgents.<span class="hljs-property">length</span>],
  <span class="hljs-attr">viewport</span>: viewports[fingerprintSeed % viewports.<span class="hljs-property">length</span>],
  <span class="hljs-attr">language</span>: languages[fingerprintSeed % languages.<span class="hljs-property">length</span>],
  <span class="hljs-attr">timezone</span>: timezones[fingerprintSeed % timezones.<span class="hljs-property">length</span>],
  <span class="hljs-attr">gpu</span>: gpuConfigs[fingerprintSeed % gpuConfigs.<span class="hljs-property">length</span>],
  <span class="hljs-attr">cores</span>: coreOptions[fingerprintSeed % coreOptions.<span class="hljs-property">length</span>]
}
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>✅ 相同 profileId 始终生成相同指纹</li>
<li>✅ 支持自定义种子实现跨设备一致性</li>
<li>✅ 可通过配置覆盖任意指纹项</li>
</ul>
<h3 data-id="heading-11">2. 指纹覆盖机制</h3>
<p>用户可以通过配置覆盖自动生成的任意指纹项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// BrowserManager._extractFingerprintOverrides()</span>
<span class="hljs-title function_">_extractFingerprintOverrides</span>(<span class="hljs-params">rawConfig</span>) {
  <span class="hljs-keyword">const</span> cfg = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_normalizeFingerprintConfig</span>(rawConfig)
  <span class="hljs-keyword">const</span> overrides = { <span class="hljs-attr">rawConfig</span>: cfg }

  <span class="hljs-comment">// User Agent 配置</span>
  <span class="hljs-keyword">if</span> (cfg.<span class="hljs-property">uaMode</span> === <span class="hljs-string">'custom'</span> &amp;&amp; cfg.<span class="hljs-property">userAgent</span>?.<span class="hljs-title function_">trim</span>()) {
    overrides.<span class="hljs-property">userAgent</span> = cfg.<span class="hljs-property">userAgent</span>.<span class="hljs-title function_">trim</span>()
  }

  <span class="hljs-comment">// 语言配置（非自动模式时生效）</span>
  <span class="hljs-keyword">if</span> (cfg.<span class="hljs-property">languageAuto</span> === <span class="hljs-literal">false</span> &amp;&amp; cfg.<span class="hljs-property">language</span>?.<span class="hljs-title function_">trim</span>()) {
    overrides.<span class="hljs-property">language</span> = cfg.<span class="hljs-property">language</span>.<span class="hljs-title function_">trim</span>()
  }

  <span class="hljs-comment">// 时区配置</span>
  <span class="hljs-keyword">if</span> (cfg.<span class="hljs-property">timezoneAuto</span> === <span class="hljs-literal">false</span> &amp;&amp; cfg.<span class="hljs-property">timezone</span>?.<span class="hljs-title function_">trim</span>()) {
    overrides.<span class="hljs-property">timezone</span> = cfg.<span class="hljs-property">timezone</span>.<span class="hljs-title function_">trim</span>()
  }

  <span class="hljs-comment">// GPU 配置覆盖</span>
  <span class="hljs-keyword">if</span> (cfg.<span class="hljs-property">gpuVendor</span> || cfg.<span class="hljs-property">gpuRenderer</span>) {
    overrides.<span class="hljs-property">gpuVendor</span> = cfg.<span class="hljs-property">gpuVendor</span>
    overrides.<span class="hljs-property">gpuRenderer</span> = cfg.<span class="hljs-property">gpuRenderer</span>
  }

  <span class="hljs-comment">// CPU 核心数覆盖</span>
  <span class="hljs-keyword">if</span> (cfg.<span class="hljs-property">hardwareConcurrency</span> &gt; <span class="hljs-number">0</span>) {
    overrides.<span class="hljs-property">hardwareConcurrency</span> = cfg.<span class="hljs-property">hardwareConcurrency</span>
  }

  <span class="hljs-keyword">return</span> overrides
}
</code></pre>
<h3 data-id="heading-12">3. 动态 User-Agent 生成</h3>
<p>根据平台、品牌、版本动态生成一致的 User-Agent：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// LocalFingerprintService._generateUserAgent()</span>
<span class="hljs-title function_">_generateUserAgent</span>(<span class="hljs-params">platform, brand, brandVersion, platformVersion</span>) {
  <span class="hljs-comment">// Windows NT 版本映射</span>
  <span class="hljs-keyword">const</span> ntVersion = <span class="hljs-variable constant_">WINDOWS_NT_VERSION_MAP</span>[platformVersion] || <span class="hljs-string">'10.0'</span>

  <span class="hljs-comment">// 基础 UA 模板</span>
  <span class="hljs-keyword">let</span> ua
  <span class="hljs-keyword">if</span> (platform === <span class="hljs-string">'windows'</span>) {
    ua = <span class="hljs-string">`Mozilla/5.0 (Windows NT <span class="hljs-subst">${ntVersion}</span>; Win64; x64) `</span> +
         <span class="hljs-string">`AppleWebKit/537.36 (KHTML, like Gecko) `</span> +
         <span class="hljs-string">`Chrome/<span class="hljs-subst">${brandVersion}</span> Safari/537.36`</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (platform === <span class="hljs-string">'macos'</span>) {
    ua = <span class="hljs-string">`Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) `</span> +
         <span class="hljs-string">`AppleWebKit/537.36 (KHTML, like Gecko) `</span> +
         <span class="hljs-string">`Chrome/<span class="hljs-subst">${brandVersion}</span> Safari/537.36`</span>
  }

  <span class="hljs-comment">// 添加品牌后缀</span>
  <span class="hljs-keyword">if</span> (brand === <span class="hljs-string">'Edge'</span>) {
    ua += <span class="hljs-string">` Edg/<span class="hljs-subst">${brandVersion}</span>`</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (brand === <span class="hljs-string">'Opera'</span>) {
    ua += <span class="hljs-string">` OPR/<span class="hljs-subst">${brandVersion}</span>`</span>
  }

  <span class="hljs-keyword">return</span> ua
}
</code></pre>
<h3 data-id="heading-13">4. 命令行参数构建</h3>
<p>最终生成的指纹通过命令行参数传递给 Chromium：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// LocalFingerprintService.launch()</span>
<span class="hljs-keyword">const</span> chromiumArgs = [
  <span class="hljs-comment">// 调试端口</span>
  <span class="hljs-string">`--remote-debugging-port=<span class="hljs-subst">${debuggingPort}</span>`</span>,

  <span class="hljs-comment">// 用户数据目录（实现会话隔离）</span>
  <span class="hljs-string">`--user-data-dir=<span class="hljs-subst">${userDataDir}</span>`</span>,

  <span class="hljs-comment">// 指纹核心参数</span>
  <span class="hljs-string">`--fingerprint=<span class="hljs-subst">${fingerprintSeed}</span>`</span>,
  <span class="hljs-string">`--fingerprint-platform=<span class="hljs-subst">${platform}</span>`</span>,
  <span class="hljs-string">`--fingerprint-platform-version=<span class="hljs-subst">${platformVersion}</span>`</span>,
  <span class="hljs-string">`--fingerprint-brand=<span class="hljs-subst">${brand}</span>`</span>,
  <span class="hljs-string">`--fingerprint-brand-version=<span class="hljs-subst">${brandVersion}</span>`</span>,
  <span class="hljs-string">`--fingerprint-hardware-concurrency=<span class="hljs-subst">${cores}</span>`</span>,
  <span class="hljs-string">`--fingerprint-gpu-vendor=<span class="hljs-subst">${gpuVendor}</span>`</span>,
  <span class="hljs-string">`--fingerprint-gpu-renderer=<span class="hljs-subst">${gpuRenderer}</span>`</span>,

  <span class="hljs-comment">// 基本设置</span>
  <span class="hljs-string">`--lang=<span class="hljs-subst">${language}</span>`</span>,
  <span class="hljs-string">`--accept-lang=<span class="hljs-subst">${acceptLanguage}</span>`</span>,
  <span class="hljs-string">`--timezone=<span class="hljs-subst">${timezone}</span>`</span>,
  <span class="hljs-string">`--user-agent=<span class="hljs-subst">${userAgent}</span>`</span>,

  <span class="hljs-comment">// 窗口设置</span>
  <span class="hljs-string">`--window-size=<span class="hljs-subst">${viewport.width}</span>,<span class="hljs-subst">${viewport.height}</span>`</span>,

  <span class="hljs-comment">// 代理设置（可选）</span>
  ...(proxyServer ? [<span class="hljs-string">`--proxy-server=<span class="hljs-subst">${proxyServer}</span>`</span>] : [])
]
</code></pre>
<hr/>
<h2 data-id="heading-14">指纹配置能力矩阵</h2>
<h3 data-id="heading-15">可配置的指纹类型</h3>



















































































<table><thead><tr><th>指纹类型</th><th>命令行参数</th><th>配置方式</th><th>说明</th></tr></thead><tbody><tr><td><strong>指纹种子</strong></td><td><code>--fingerprint</code></td><td>自动/手动</td><td>核心参数，启用后大部分指纹功能生效</td></tr><tr><td><strong>User Agent</strong></td><td><code>--user-agent</code></td><td>自动/手动</td><td>修改 navigator.userAgent 及相关 API</td></tr><tr><td><strong>操作系统</strong></td><td><code>--fingerprint-platform</code></td><td>手动</td><td>windows / linux / macos</td></tr><tr><td><strong>平台版本</strong></td><td><code>--fingerprint-platform-version</code></td><td>自动/手动</td><td>如 10.0 (Win10)、14.0 (macOS 14)</td></tr><tr><td><strong>浏览器品牌</strong></td><td><code>--fingerprint-brand</code></td><td>自动/手动</td><td>Chrome / Edge / Opera / Vivaldi / Brave</td></tr><tr><td><strong>浏览器版本</strong></td><td><code>--fingerprint-brand-version</code></td><td>自动/手动</td><td>如 139.0.0.0</td></tr><tr><td><strong>CPU核心数</strong></td><td><code>--fingerprint-hardware-concurrency</code></td><td>自动/手动</td><td>2 / 4 / 6 / 8 / 12 / 16</td></tr><tr><td><strong>GPU厂商</strong></td><td><code>--fingerprint-gpu-vendor</code></td><td>自动/手动</td><td>NVIDIA / AMD / Intel / Apple</td></tr><tr><td><strong>GPU渲染器</strong></td><td><code>--fingerprint-gpu-renderer</code></td><td>自动/手动</td><td>具体 GPU 型号</td></tr><tr><td><strong>语言</strong></td><td><code>--lang</code></td><td>自动/手动</td><td>zh-CN / en-US 等</td></tr><tr><td><strong>时区</strong></td><td><code>--timezone</code></td><td>自动/手动</td><td>Asia/Shanghai 等</td></tr><tr><td><strong>代理服务器</strong></td><td><code>--proxy-server</code></td><td>手动</td><td>支持 HTTP/SOCKS5 协议</td></tr></tbody></table>
<h3 data-id="heading-16">自动处理的指纹</h3>
<p>以下指纹由 fingerprint-chromium 自动处理，无需配置：</p>

































<table><thead><tr><th>指纹类型</th><th>说明</th></tr></thead><tbody><tr><td><strong>Canvas 图像</strong></td><td>自动修改 Canvas 2D 渲染输出</td></tr><tr><td><strong>WebGL 图像</strong></td><td>自动修改 WebGL 渲染输出</td></tr><tr><td><strong>音频指纹</strong></td><td>自动修改 AudioContext 输出</td></tr><tr><td><strong>字体指纹</strong></td><td>修改系统字体列表</td></tr><tr><td><strong>ClientRects</strong></td><td>修改元素边界矩形</td></tr><tr><td><strong>WebRTC</strong></td><td>修改 WebRTC 相关指纹</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-17">实战：从配置到启动的完整流程</h2>
<h3 data-id="heading-18">流程图</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────┐    ┌─────────────────┐    ┌───────────────────┐
│  前端配置页   │───&gt;│ BrowserManager  │───&gt;│ LocalFingerprint  │
│  (Vue 组件)  │    │  <span class="hljs-selector-class">.openBrowser</span>() │    │   Service<span class="hljs-selector-class">.launch</span>()│
└─────────────┘    └────────┬────────┘    └─────────┬─────────┘
                           │                       │
                           ▼                       ▼
                  ┌─────────────────┐    ┌───────────────────┐
                  │ 解析指纹配置      │    │ 生成指纹参数        │
                  │ 提取覆盖值        │    │ 构建命令行参数      │
                  └────────┬────────┘    └─────────┬─────────┘
                           │                       │
                           ▼                       ▼
                  ┌─────────────────┐    ┌───────────────────┐
                  │ 加载 StorageState│   │ 启动 Chromium 进程  │
                  │ (恢复登录状态)    │    │ 等待端口就绪        │
                  └────────┬────────┘    └─────────┬─────────┘
                           │                       │
                           ▼                       ▼
                  ┌─────────────────────────────────────────┐
                  │     CDP 连接建立，返回 page 对象           │
                  └─────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-19">代码示例：打开浏览器</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 调用 BrowserManager 打开浏览器</span>
<span class="hljs-keyword">const</span> { browser, context, page } = <span class="hljs-keyword">await</span> browserManager.<span class="hljs-title function_">openBrowser</span>({
  <span class="hljs-attr">profileId</span>: <span class="hljs-string">'profile-1'</span>,
  <span class="hljs-attr">fingerprintConfig</span>: {
    <span class="hljs-attr">os</span>: <span class="hljs-string">'win10'</span>,
    <span class="hljs-attr">uaMode</span>: <span class="hljs-string">'auto'</span>,
    <span class="hljs-attr">languageAuto</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">language</span>: <span class="hljs-string">'en-US'</span>,
    <span class="hljs-attr">gpuAuto</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">gpuVendor</span>: <span class="hljs-string">'NVIDIA Corporation'</span>,
    <span class="hljs-attr">gpuRenderer</span>: <span class="hljs-string">'NVIDIA GeForce RTX 3060'</span>
  }
})

<span class="hljs-comment">// 2. 使用页面</span>
<span class="hljs-keyword">await</span> page.<span class="hljs-title function_">goto</span>(<span class="hljs-string">'https://example.com'</span>)

<span class="hljs-comment">// 3. 保存登录状态（可选）</span>
<span class="hljs-keyword">await</span> browserManager.<span class="hljs-title function_">saveStorageState</span>(<span class="hljs-string">'profile-1'</span>, browserId)

<span class="hljs-comment">// 4. 关闭浏览器</span>
<span class="hljs-keyword">await</span> browserManager.<span class="hljs-title function_">closeBrowser</span>(browserId)
</code></pre>
<hr/>
<h2 data-id="heading-20">踩坑记录与解决方案</h2>
<h3 data-id="heading-21">踩坑 1：平台覆盖不生效</h3>
<p><strong>问题</strong>：配置 <code>os: "win8"</code> 后，浏览器仍使用本机平台 (macOS)。</p>
<p><strong>原因分析</strong>：</p>
<ul>
<li><code>BrowserManager</code> 未正确提取 <code>platform</code> 字段</li>
<li><code>LocalFingerprintService</code> 只使用了 <code>process.platform</code></li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加 os 到 platform 的映射</span>
<span class="hljs-title function_">_mapPlatform</span>(<span class="hljs-params">osCode</span>) {
  <span class="hljs-keyword">const</span> mapping = {
    <span class="hljs-attr">win7</span>: <span class="hljs-string">'windows'</span>, <span class="hljs-attr">win8</span>: <span class="hljs-string">'windows'</span>, <span class="hljs-attr">win10</span>: <span class="hljs-string">'windows'</span>, <span class="hljs-attr">win11</span>: <span class="hljs-string">'windows'</span>,
    <span class="hljs-attr">mac13</span>: <span class="hljs-string">'macos'</span>, <span class="hljs-attr">mac14</span>: <span class="hljs-string">'macos'</span>, <span class="hljs-attr">mac15</span>: <span class="hljs-string">'macos'</span>,
    <span class="hljs-attr">linux</span>: <span class="hljs-string">'linux'</span>
  }
  <span class="hljs-keyword">return</span> mapping[osCode] || process.<span class="hljs-property">platform</span>
}

<span class="hljs-comment">// 修改 launch() 中调用顺序，先计算 targetPlatform</span>
<span class="hljs-keyword">const</span> targetPlatform = fingerprintOverrides?.<span class="hljs-property">platform</span> ||
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_mapPlatform</span>(fingerprintOverrides?.<span class="hljs-property">rawConfig</span>?.<span class="hljs-property">os</span>)
</code></pre>
<h3 data-id="heading-22">踩坑 2：User-Agent 与品牌不一致</h3>
<p><strong>问题</strong>：配置 Edge 品牌时，User-Agent 仍为 Chrome 格式。</p>
<p><strong>原因</strong>：<code>generateFingerprint()</code> 使用静态 User-Agent 列表，不考虑品牌配置。</p>
<p><strong>解决方案</strong>：新增 <code>_generateUserAgent()</code> 方法，根据平台、品牌、版本动态生成。</p>
<h3 data-id="heading-23">踩坑 3：GPU 与平台不匹配</h3>
<p><strong>问题</strong>：用户可能配置不匹配的 GPU（如 Windows 平台配置 Apple GPU）。</p>
<p><strong>解决方案</strong>：实现 GPU/平台自动修复：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// fingerprintConfigValidator.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">autoFixGpuPlatformMismatch</span>(<span class="hljs-params">config</span>) {
  <span class="hljs-keyword">const</span> platform = <span class="hljs-title function_">mapOsToPlatform</span>(config.<span class="hljs-property">os</span>)
  <span class="hljs-keyword">const</span> compatibility = <span class="hljs-variable constant_">GPU_PLATFORM_COMPATIBILITY</span>[platform]

  <span class="hljs-comment">// 检查 GPU 厂商是否与平台兼容</span>
  <span class="hljs-keyword">if</span> (!compatibility.<span class="hljs-property">vendors</span>.<span class="hljs-title function_">includes</span>(config.<span class="hljs-property">gpuVendor</span>)) {
    <span class="hljs-keyword">return</span> {
      ...config,
      <span class="hljs-attr">gpuVendor</span>: compatibility.<span class="hljs-property">defaultGpu</span>.<span class="hljs-property">vendor</span>,
      <span class="hljs-attr">gpuRenderer</span>: compatibility.<span class="hljs-property">defaultGpu</span>.<span class="hljs-property">renderer</span>,
      <span class="hljs-attr">_autoFixed</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">_fixReason</span>: <span class="hljs-string">`GPU 厂商 "<span class="hljs-subst">${config.gpuVendor}</span>" 与 <span class="hljs-subst">${platform}</span> 平台不匹配`</span>
    }
  }

  <span class="hljs-keyword">return</span> config
}
</code></pre>
<h3 data-id="heading-24">踩坑 4：代理认证问题</h3>
<p><strong>问题</strong>：带用户名密码的代理 URL 无法正常工作。</p>
<p><strong>解决方案</strong>：实现代理 URL 解析和认证处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// proxyAuthHelper.js</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parseProxyUrl</span>(<span class="hljs-params">proxyUrl</span>) {
  <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(proxyUrl)
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">server</span>: <span class="hljs-string">`<span class="hljs-subst">${url.protocol}</span>//<span class="hljs-subst">${url.host}</span>`</span>,
    <span class="hljs-attr">protocol</span>: url.<span class="hljs-property">protocol</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-string">':'</span>, <span class="hljs-string">''</span>),
    <span class="hljs-attr">host</span>: url.<span class="hljs-property">hostname</span>,
    <span class="hljs-attr">port</span>: url.<span class="hljs-property">port</span>,
    <span class="hljs-attr">username</span>: <span class="hljs-built_in">decodeURIComponent</span>(url.<span class="hljs-property">username</span>),
    <span class="hljs-attr">password</span>: <span class="hljs-built_in">decodeURIComponent</span>(url.<span class="hljs-property">password</span>)
  }
}

<span class="hljs-comment">// 使用 CDP 设置代理认证</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setupProxyAuth</span>(<span class="hljs-params">context, proxyConfig</span>) {
  <span class="hljs-keyword">if</span> (proxyConfig.<span class="hljs-property">username</span> &amp;&amp; proxyConfig.<span class="hljs-property">password</span>) {
    <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">route</span>(<span class="hljs-string">'**/*'</span>, <span class="hljs-keyword">async</span> (route) =&gt; {
      <span class="hljs-keyword">await</span> route.<span class="hljs-title function_">continue</span>({
        <span class="hljs-attr">headers</span>: {
          <span class="hljs-string">'Proxy-Authorization'</span>: <span class="hljs-string">`Basic <span class="hljs-subst">${btoa(
            <span class="hljs-string">`<span class="hljs-subst">${proxyConfig.username}</span>:<span class="hljs-subst">${proxyConfig.password}</span>`</span>
          )}</span>`</span>
        }
      })
    })
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-25">性能优化与最佳实践</h2>
<h3 data-id="heading-26">1. 低内存模式</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LOW_MEMORY_CONFIG</span> = {
  <span class="hljs-attr">lowMemoryMode</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">mediaCacheSizeMB</span>: <span class="hljs-number">128</span>,
  <span class="hljs-attr">mediaCacheDiskSizeMB</span>: <span class="hljs-number">512</span>,
  <span class="hljs-attr">enableVideoOptimizations</span>: <span class="hljs-literal">false</span>
}

<span class="hljs-comment">// 禁用重量级视频管道标志</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HEAVY_VIDEO_PIPELINE_FLAGS</span> = [
  <span class="hljs-string">'--enable-av1-decoder'</span>,
  <span class="hljs-string">'--enable-video-decoding-multiple-threads'</span>,
  <span class="hljs-string">'--enable-features=VaapiVideoDecoder,PlatformVideoDecoder'</span>
]
</code></pre>
<h3 data-id="heading-27">2. 会话隔离最佳实践</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 每个实例使用独立的用户数据目录</span>
<span class="hljs-keyword">const</span> userDataDir = path.<span class="hljs-title function_">join</span>(
  profilesDir,
  <span class="hljs-string">`profile-<span class="hljs-subst">${profileId}</span>-<span class="hljs-subst">${uniqueId}</span>`</span>
)

<span class="hljs-comment">// 登录数据白名单（仅持久化必要文件）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LOGIN_WHITELIST</span> = [
  <span class="hljs-string">'Default/Cookies'</span>,
  <span class="hljs-string">'Default/Login Data'</span>,
  <span class="hljs-string">'Default/Local Storage'</span>,
  <span class="hljs-string">'Default/Session Storage'</span>
]
</code></pre>
<h3 data-id="heading-28">3. 指纹一致性检查</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 确保指纹参数之间的一致性</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">validateFingerprintConsistency</span>(<span class="hljs-params">config</span>) {
  <span class="hljs-keyword">const</span> warnings = []

  <span class="hljs-comment">// Windows 平台应使用 Windows GPU</span>
  <span class="hljs-keyword">if</span> (config.<span class="hljs-property">platform</span> === <span class="hljs-string">'windows'</span> &amp;&amp;
      config.<span class="hljs-property">gpuVendor</span> === <span class="hljs-string">'Apple Inc.'</span>) {
    warnings.<span class="hljs-title function_">push</span>(<span class="hljs-string">'Windows 平台不应使用 Apple GPU'</span>)
  }

  <span class="hljs-comment">// 语言和时区应地理位置一致</span>
  <span class="hljs-keyword">if</span> (config.<span class="hljs-property">language</span> === <span class="hljs-string">'zh-CN'</span> &amp;&amp;
      config.<span class="hljs-property">timezone</span> === <span class="hljs-string">'America/New_York'</span>) {
    warnings.<span class="hljs-title function_">push</span>(<span class="hljs-string">'语言和时区地理位置不一致'</span>)
  }

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">valid</span>: warnings.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>, warnings }
}
</code></pre>
<h3 data-id="heading-29">4. 指纹验证</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 快速验证指纹是否生效</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">quickVerify</span>(<span class="hljs-params">page</span>) {
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> page.evaluate(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">webdriver</span>: navigator.<span class="hljs-property">webdriver</span>,
    <span class="hljs-attr">platform</span>: navigator.<span class="hljs-property">platform</span>,
    <span class="hljs-attr">userAgent</span>: navigator.<span class="hljs-property">userAgent</span>,
    <span class="hljs-attr">hardwareConcurrency</span>: navigator.<span class="hljs-property">hardwareConcurrency</span>,
    <span class="hljs-attr">languages</span>: navigator.<span class="hljs-property">languages</span>
  }))

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">passed</span>: result.<span class="hljs-property">webdriver</span> === <span class="hljs-literal">false</span>,
    <span class="hljs-attr">details</span>: result
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-30">总结</h2>
<h3 data-id="heading-31">核心能力回顾</h3>
<p>通过本文介绍的方案，我们实现了以下能力：</p>

































<table><thead><tr><th>能力</th><th>说明</th></tr></thead><tbody><tr><td><strong>多指纹实例</strong></td><td>同时运行多个具有独立指纹的浏览器</td></tr><tr><td><strong>指纹自定义</strong></td><td>支持自定义 UA、GPU、CPU、时区、平台等</td></tr><tr><td><strong>会话隔离</strong></td><td>每个实例独立的 Cookie 和 LocalStorage</td></tr><tr><td><strong>指纹一致性</strong></td><td>相同配置 ID 生成相同指纹</td></tr><tr><td><strong>登录持久化</strong></td><td>Storage State 机制保存登录状态</td></tr><tr><td><strong>配置验证</strong></td><td>自动验证和修复配置问题</td></tr></tbody></table>
<h3 data-id="heading-32">技术要点总结</h3>
<ol>
<li><strong>种子机制</strong> 是实现指纹确定性和一致性的关键</li>
<li><strong>分层架构</strong>（BrowserManager → LocalFingerprintService → Chromium）便于维护和扩展</li>
<li><strong>配置覆盖机制</strong> 允许用户灵活定制任意指纹项</li>
<li><strong>GPU/平台匹配验证</strong> 可以避免不合理的配置组合</li>
<li><strong>代理认证处理</strong> 需要单独解析 URL 并设置认证头</li>
</ol>
<h3 data-id="heading-33">延伸阅读</h3>
<p>如果你对浏览器指纹技术感兴趣，可以进一步了解：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fadryfish%2Ffingerprint-chromium" target="_blank" title="https://github.com/adryfish/fingerprint-chromium" ref="nofollow noopener noreferrer">fingerprint-chromium GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fadryfish%2Ffingerprint-chromium%2Fblob%2Fmain%2FREADME-ZH.md" target="_blank" title="https://github.com/adryfish/fingerprint-chromium/blob/main/README-ZH.md" ref="nofollow noopener noreferrer">fingerprint-chromium 中文文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fungoogled-software%2Fungoogled-chromium" target="_blank" title="https://github.com/ungoogled-software/ungoogled-chromium" ref="nofollow noopener noreferrer">Ungoogled Chromium</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fchromedevtools.github.io%2Fdevtools-protocol%2F" target="_blank" title="https://chromedevtools.github.io/devtools-protocol/" ref="nofollow noopener noreferrer">Chrome DevTools Protocol</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbrowserscan.net%2F" target="_blank" title="https://browserscan.net/" ref="nofollow noopener noreferrer">BrowserScan 指纹检测</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpixelscan.net%2F" target="_blank" title="https://pixelscan.net/" ref="nofollow noopener noreferrer">PixelScan 指纹检测</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[内卷时代，身体才是最大的红利]]></title>    <link>https://juejin.cn/post/7598480413803593770</link>    <guid>https://juejin.cn/post/7598480413803593770</guid>    <pubDate>2026-01-24T09:16:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598480413803593770" data-draft-id="7598480413803577386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="内卷时代，身体才是最大的红利"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-24T09:16:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小巫debug日记"/> <meta itemprop="url" content="https://juejin.cn/user/2875978145863901"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            内卷时代，身体才是最大的红利
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978145863901/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小巫debug日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T09:16:34.000Z" title="Sat Jan 24 2026 09:16:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">令人唏嘘的猝死新闻</h2>
<p>这几天IT圈发酵了一件事引发大家广泛讨论，网友也梳理了<strong>32岁程序员周末猝死时间线</strong>（如下图），看得让人唏嘘，尤其是他的爱人连续几天晚上催促他回家的消息，抢救过程中还有工作消息艾特...</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c796b98ba476499b91dfc115b99ec069~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5berZGVidWfml6XorrA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851575&amp;x-signature=U38FH9hCy00OVy5ROPB6UO25A7E%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">程序员是一份极度劳累的职业</h2>
<p>程序员猝死的新闻在我从业十余年期间听过不少，曾经github还有个开源项目——<strong>996.ICU，倡议众IT从业者维护自身劳动权益。</strong></p>
<blockquote>
<p>996.ICU 是指 工作 996， 生病 ICU” 。这是中国程序员之间的一种自嘲说法，意思是如果按照 996 的模式工作，那以后就得进 ICU 了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F996icu%2F996.ICU" target="_blank" title="https://github.com/996icu/996.ICU" ref="nofollow noopener noreferrer">github.com/996icu/996.…</a></p>
</blockquote>
<p>外行人可能会很诧异，为什么互联网发展这么多年了，还是会时常会听到程序员猝死的新闻，程序员的工作强度有这么大吗？</p>
<p>以我自身经历来谈谈程序员工作强度的情况，为什么说程序员是一份<strong>极度劳累</strong>的职业，你以为程序员的工作就是简单写写代码，那就是<strong>too young，too simple</strong>。程序员这份职业表面看起来高薪，但从业者应该知道这不过是外人看起来光鲜罢了。</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/647358bf7cda419b9e777348a28b9db5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5berZGVidWfml6XorrA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851575&amp;x-signature=q7NMb3vsQnACVJbXUYvQyiCqaNw%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>工作时间长与紧急响应</strong>：996加班文化、随时待命模糊工作和生活的边界。</li>
<li><strong>高强度脑力消耗与压力</strong>：认知密集型工作，多任务频繁打断（比如：大部分时间浪费在无意义会议和沟通对齐）</li>
<li><strong>技术与知识的快速迭代</strong>：技术栈、框架、工具更新极快，为了保持“竞争力”，需要持续学习新知识，无形中加剧了技术焦虑。</li>
<li><strong>工作流程与管理问题</strong>：“草台班子”造成的<strong>需求边界不清</strong>，管理层上传下达的一味**“求快”文化**，造成后期维护压力和风险。大量无效劳动和返工，陷入“<strong>忙、乱、累</strong>”恶性循环。</li>
<li><strong>久坐与健康风险</strong>：长时间面对电脑，保持固定姿势，导致颈椎、腰椎和视力问题；不良作息和缺少运动习惯引发亚健康问题（脂肪肝、三高等）。</li>
</ol>
<p>猝死跟职业不一定有强关联关系，工作曾有一段时间高强度工作，睡眠时长和质量不足，心脏就会受不了，后面我就放弃了无谓的卷。按养生的角度来看，长期损耗，精气神就会不足，我没见到过有哪个人一直都是精力充沛的，如果有一定是他/她有良好的作息习惯，坚持运动和养生。</p>
<h2 data-id="heading-2">写在最后</h2>
<p>内卷时代，单靠个体努力已经很难获得飞跃式的晋升，时代红利的窗口一过很多事情做起来只会更难并不代表正确，就像当年买房那批人，可能不是因为他们有多努力多么有眼光，而是做对了“选择”，或许我们也要客观地看待人生当中的“得与失”。</p>
<p>我们练武中有句话叫做<strong>跟自己身体沟通</strong>，跟<strong>自我觉察</strong>有类似点，身体提前预警就一定要关注，很多人拼到最后肯定也在拼体力，所以先照顾好自己，该放松的时候就放松，对自己对家人都是负责任的。</p>
<p>最后，引用剑来阿良的一句话：<strong>活着，就有希望</strong>。</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5713752efef242f28d66708258d1f576~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5berZGVidWfml6XorrA=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851575&amp;x-signature=3myPWkWZv9ca9zIRvSwTkLtvwkQ%3D" alt="" loading="lazy"/></p>
<p/>
<p/>
<p/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding 一周，我做了个桌面 Agent]]></title>    <link>https://juejin.cn/post/7598465042968477736</link>    <guid>https://juejin.cn/post/7598465042968477736</guid>    <pubDate>2026-01-24T09:19:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598465042968477736" data-draft-id="7598464972912590888" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding 一周，我做了个桌面 Agent"/> <meta itemprop="keywords" content="人工智能,前端,后端"/> <meta itemprop="datePublished" content="2026-01-24T09:19:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艾逗笔"/> <meta itemprop="url" content="https://juejin.cn/user/2682464100687230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding 一周，我做了个桌面 Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464100687230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艾逗笔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T09:19:53.000Z" title="Sat Jan 24 2026 09:19:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>复盘一下我vibe coding 一周，开发 WorkAny 的过程，很有意思。😂</p>
<h2 data-id="heading-0">开发过程</h2>
<ol>
<li>
<p>上周三在香港办卡，临时起意想做个桌面 Agent 项目，对标 cowork，晚上回到广州开始写代码</p>
</li>
<li>
<p>初期目标是快速发布，没时间去研究哪个 Agent 框架好用了，看很多人在用 claude agent sdk，先用这个吧</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6638cb4bb6047f9b704201c62ae3e50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=twU06G5cn6F9gF7Um5YEB85SkxE%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li>
<p>第一时间想到用 tauri，喜欢小而美，总觉得 electron 很重，不想用</p>
</li>
<li>
<p>不想自己写代码了，决定让 claude code 来写。之前的 claude 账号都被封了，用不上原版 cc，装了个 cc-switch，接上 OpenRouter 的 API 开始写</p>
</li>
<li>
<p>截了个 chatbot 的交互截图，让 cc 参考着先把基本的对话流程跑通，用 claude agent sdk，接上 OpenRouter，cc 很快写完了第一版</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d40f912af6048938b6c24d8b0e9d04a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=cNvyLxjsZ3MH81jp2x9lj1nHYyQ%3D" alt="" loading="lazy"/></p>
<ol start="6">
<li>tauri 本质是用 rust 的壳子套了个前端界面，不熟悉 rust，让 cc 用 hono 写API，rust 只做壳子，不做业务功能。API 作为 sidecar 打包进 app</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42bcbb34123943d7a370c427f8a3f02e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=mCeWv%2FlkhgYJTJeUEyCllpvNcj8%3D" alt="" loading="lazy"/></p>
<ol start="7">
<li>
<p>让 cc 在 API 引入 sqlite 实现本地存储，持久化任务数据，创建本地工作目录，保存任务输出文件</p>
</li>
<li>
<p>写了半天，看 OpenRouter 消耗了 110 刀，有点肉疼。买了个美国住宅 ip，付费上了原版 claude pro</p>
</li>
<li>
<p>截了个 Manus 的任务详情图，让 cc 参考写完工具调用的逻辑，中间是 chatbot 对话，右边用一个虚拟计算机的容器展示输入输出</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f659b49ba9d4069a565fd8c49e81e7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=KuCYbRKETYxXYA9JZtLl5DOPXMA%3D" alt="" loading="lazy"/></p>
<ol start="10">
<li>让 cc 接入 shadcn/ui，把样式做得好看一点，支持切换皮肤</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71722d5fd61045fea186b2b47117f5d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=l0qj52LJxdYjsve8hhqXbIAn6eQ%3D" alt="" loading="lazy"/></p>
<ol start="11">
<li>
<p>又写了一天，关键时候 claude pro 限频了，很影响心情，补差价上了 claude max 顶配版</p>
</li>
<li>
<p>让 cc 把自定义模型配置，mcp、skills 调用的逻辑都实现了，跑了几个生成 PPT、Excel、Doc、 网页的 case，效果不错</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e97af301a7d841929dc5d65a6cf455e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=jTZ45ZnICl8En5Ci1KmTZx%2B5hho%3D" alt="" loading="lazy"/></p>
<ol start="13">
<li>让 cc 把输出文件夹和中间过程的 artifacts 都在右边展示出来，写了个 artifact preview 容器，渲染各种类型的文件，可视化预览</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74a2bfa14d3a40c6b60b88d20d6701e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=h%2FPXsExTE%2BIRFGAYeR6ktWfjs6o%3D" alt="" loading="lazy"/></p>
<ol start="14">
<li>有些任务需要跑脚本完成，考虑到用户电脑可能没装代码运行环境，让 cc 引入 sandbox 来运行代码</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/811d03960c6043c68495da51d07e4492~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=F22XoHYbuDG9NdF1e%2FFhIf6wC4M%3D" alt="" loading="lazy"/></p>
<ol start="15">
<li>考虑到扩展性，需要支持不同类型的 Agent runtime 和 sandbox，让 cc 写了两个抽象类，统一接口调用。Agent runtime 支持 claude code、codex、deepagents，sandbox 支持 boxlite、codex-sandbox、claude-sandbox</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/708c2f2504cf4327a5ee3b543816e26d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=M8FGZZHJSIJaPqqZLMaw8dB%2BK1I%3D" alt="" loading="lazy"/></p>
<ol start="16">
<li>觉得 cc 写的代码有点乱，让 cc 引入 eslint 和 prettier 做了下格式化，把逻辑太多的文件做模块化拆分。再参考 ShipAny 的目录结构，调整了一下项目结构</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7d317c0f2f5454c9c04ae388af01f91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=Qgzjeq50lD63syn6vcNWykLDQrs%3D" alt="" loading="lazy"/></p>
<ol start="17">
<li>让 cc 写打包脚本，构建不同操作系统的安装包。把安装包发给一些朋友，开始内测了。根据内测用户的反馈，再让 cc 继续优化逻辑，解决问题，迭代功能</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5da0190b1724df1bdabb1ab39244608~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=X95HZi%2F0To8vUabtElEckAjjOps%3D" alt="" loading="lazy"/></p>
<ol start="18">
<li>
<p>有些用户电脑没装 node，没有 claude code，安装软件后跑不起来，让 cc 在构建脚本支持 flag 参数，把 node 和 cc 作为 sidecar 打包进 app，让用户能够开箱即用</p>
</li>
<li>
<p>Mac 用户安装 app 后提示文件损坏或有安全提示，让 cc 在构建脚本里面加上签名处理，用我的 Apple 开发者账户对打包的 Mac app 做签名</p>
</li>
<li>
<p>node 和 cc 都打包进 app 的版本，安装包 100 多 m，有点重。让 cc 在构建脚本实现默认不打包，在用户启动 app 的时候引导安装 node 和 cc，精简版安装包才 20 多 m，小巧精致</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8e99a9ff9544c87b874018539f66c97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=KF4HEfIKOkMN4a4XtTKetdb6lWk%3D" alt="" loading="lazy"/></p>
<ol start="21">
<li>app 基本功能实现得差不多了，让 cc 在 ShipAny 模板基础上写一个 WorkAny 的官网，放上演示图，部署上线</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ee57d70102b4b13b3d3a515b6c29f34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=CjmI9cmNXPHyD%2FuV1gx9kvrgtUE%3D" alt="" loading="lazy"/></p>
<ol start="22">
<li>WorkAny 开源发布，MVP 版本上线，用户拉源码本地构建，配个 API 直接用</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34802ec98531460c9f90a37c8e5e672c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=Hz10Ady75tV2J1hJtL17LulUffo%3D" alt="" loading="lazy"/></p>
<ol start="23">
<li>让 cc 写了个 github 构建脚本，在代码推送到 main 分支时，自动触发 github action 构建，一次性打包 Windows、Linux、Mac 三大平台的安装包，自动发布到 release，用户无需自行构建了</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/875ea5654cf0440a99411114e7500739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=o1MVFAKL6rojqV69qtgVm0S7n%2Fk%3D" alt="" loading="lazy"/></p>
<ol start="24">
<li>根据用户的反馈，问题丢给 cc 去修，想到什么新功能也告诉 cc 加上，自己只做测试，不写代码，看都不看一眼。🌚</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e68039517e54390a685a2850efe394e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=kzfb2Ui7VrDj2NWGWs%2BD%2FN%2B0nLA%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">几点感悟</h2>
<ol>
<li>第一次尝试全自动驾驶 vibe coding 做项目，爽感非常强烈，WorkAny 的代码 100% 由 cc 老弟完成，我只负责指挥，日常开三个窗口，让三个 cc 老弟同时干活，效率拉满</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f65c44ce406422bac53effa8da87ff1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=Jv4jeqybt1kQ7LxuVIw%2BL6OfZIU%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>AI 时代技术平权，人人都是建筑师，理解用户需求、好的产品 sense 和审美是做出好产品的关键</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/916b74cae2474ec9bb563a822ff21c6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=EtAg5iOc%2FgI0vnKj4e5%2BAfyUdqM%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li>
<p>技术广度和全局视野是最大的优势，可以精准提需求，指哪打哪，遇到问题能快速定位，防止 AI 走偏失控</p>
</li>
<li>
<p>以前总觉得手洗的衣服比洗衣机洗的干净，现在可以放心交给洗衣机了，又干净又快，能穿就行</p>
</li>
<li>
<p>优秀的程序员不会被 AI 淘汰，法拉利老了还是法拉利。🌝</p>
</li>
</ol>
<p>欢迎试用 WorkAny，感谢反馈与支持。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fworkany.ai" target="_blank" title="https://workany.ai" ref="nofollow noopener noreferrer">workany.ai</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/473bd81c6fe44fb5a4410778625065a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YCX56yU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851193&amp;x-signature=ZOLyD%2Bp9oO%2F%2BiqJdFH4wmuSKCGQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LlamaIndex 学习教程-概念篇]]></title>    <link>https://juejin.cn/post/7598587406706556969</link>    <guid>https://juejin.cn/post/7598587406706556969</guid>    <pubDate>2026-01-24T09:23:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598587406706556969" data-draft-id="7598480413803642922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LlamaIndex 学习教程-概念篇"/> <meta itemprop="keywords" content="人工智能,Python,前端"/> <meta itemprop="datePublished" content="2026-01-24T09:23:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="只与明月听"/> <meta itemprop="url" content="https://juejin.cn/user/386661153249102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LlamaIndex 学习教程-概念篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/386661153249102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    只与明月听
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T09:23:40.000Z" title="Sat Jan 24 2026 09:23:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一. 引言：为什么选择 LlamaIndex？</h2>
<p>有一句话描<code>RAG</code>非常到位： 从本质上讲，RAG（Retrieval-Augmented Generation）是一种旨在解决大语言模型（LLM）“知其然不知其所以然”问题的技术范式。它的核心是将模型内部学到的“<strong>参数化知识</strong>”（模型权重中固化的、模糊的“记忆”），与来自外部知识库的“<strong>非参数化知识</strong>”（精准、可随时更新的外部数据）相结合。</p>
<p>在软件工程领域上有个专业名字叫做：<code>Trade-off</code>，就是我们没有办法既要又要，没有最佳方案，只有最适合的，我们要做的就是在适合的场景，选择出最贴合业务的方案。比如在llm应用开发中，如何避免大模型乱回答，成本最小的就是prompt工程，选择合适的提示字让他回答出我们想要的回答，而不一上来就换模型，prompt做不到，就回去使用<code>RAG</code>，给他外挂一个知识库，当前两者都无法解决问题，微调才会成为一个值得考虑的选项。</p>
<p><code>LlamaIndex</code>是一个专注数据层的llm应用框架，其初衷就是为了简化<code>RAG</code>流程，更加专注于数据如何被组织、索引和检索，强调数据接入、索引结构和查询质量。</p>
<p>其实llm应用开发首选实际上是<code>langchain</code>，尤其是社区成熟度方面，<code>langchain</code>都不可避免的成为首选，但是做<code>RAG</code>的关键不是有没有接向量数据库，而是检索是否真的为模型提供了有用的上下文。<code>LlamaIndex</code>将<code>RAG</code>的复杂性前移到数据与检索层进行系统化抽象处理，因此<code>RAG</code>场景下<code>LlamaIndex</code>比langchain更自然和高效。</p>
<h3 data-id="heading-1">1.1 概览</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.llamaindex.ai%2Fpython%2Fframework%2Fgetting_started%2Fconcepts%2F" target="_blank" title="https://developers.llamaindex.ai/python/framework/getting_started/concepts/" ref="nofollow noopener noreferrer">文档入口地址</a></p>
<p>一个完善的<code>RAG</code>系统可以被简化为下面这三个步骤：</p>
<ol start="0">
<li>
<p>数据准备与清洗</p>
<p>当接收到用户输入的信息时，不会立马抛给llm，而是将收集到的信息，比如PDF、word和网页等，转换成标准化文本，按照语义段落或者句子切分，生成<code>Document</code>或者<code>Node</code>，这里的<code>Document</code>是<code>LlamaIndex</code>中的一个通用容器，用来封装各种数据源的数据，本质上是一个完整的数据单元。</p>
<pre><code class="hljs language-arduino" lang="arduino">from llama_index.core <span class="hljs-keyword">import</span> Document
documents = [<span class="hljs-built_in">Document</span>(text=<span class="hljs-string">"这是一个文档的文本。"</span>, metadata={<span class="hljs-string">"source"</span>: <span class="hljs-string">"file1.pdf"</span>})]
</code></pre>
<p>实际上就是将用户的输入构建成一个<code>LlamaIndex</code>可以处理的对象</p>
<p>而<code>Node</code>是从<code>Document</code>中抽出来的块，比如一个段落、句子等。</p>
</li>
<li>
<p>索引构建</p>
<p>使用嵌入模型将文本<code>Node</code>转为向量，默认就是<code>text-embedding-ada-002</code>，转化为向量后，就可以使用向量相似度来判断语义相关性，而不是靠关键词去匹配。</p>
<p>有了向量后，就可以将向量存储到向量数据库中，这是为了增加检索效率，而不是每次都去遍历全部文本</p>
</li>
<li>
<p>检索与增强</p>
<p>用户在系统输入问题，<code>LlamaIndex</code>使用同样的模型将问题转化为向量，然后用之前构建好的索引找出与查询向量最相似的K个<code>Node</code>；然后对 Top-K 的结果再用轻量 LLM 或 BERT 类模型重新排序 ，来提高检索的准确性和相关性。</p>
<p>有了相关的<code>Node</code>后，结合用户的问题和系统提示来拼接成一个增强的prompt，送给llm</p>
</li>
<li>
<p>生成与提示工程</p>
<p>问题经过检索和增强提示后，得到的prompt包含原始问题、检索得到的top-k和系统角色提示，llm接收到这个增强的提示词，在上下文的基础上生成回答。</p>
</li>
</ol>
<h2 data-id="heading-2">二. LlamaIndex 快速入门与实战</h2>
<h3 data-id="heading-3">2.1 环境准备</h3>
<ul>
<li>
<p>安装命令：<code>pip install llama-index</code></p>
</li>
<li>
<p>API Key 配置。</p>
<p>新建<code>.env</code>文件在根目录，然后写上你的key</p>
<p><code>DEEPSEEK_API_KEY=xxx</code></p>
</li>
</ul>
<h3 data-id="heading-4">2.2 最小化 RAG 示例</h3>
<pre><code class="hljs language-ini" lang="ini">from dotenv import load_dotenv
from llama_index.core import Document, VectorStoreIndex, Settings
from llama_index.embeddings.huggingface import HuggingFaceEmbedding
from llama_index.llms.deepseek import DeepSeek
​
​
<span class="hljs-comment"># 读取 .env 中的环境变量（例如 DEEPSEEK_API_KEY）</span>
load_dotenv()
​
<span class="hljs-comment"># 显式指定 LLM 和 Embedding，避免使用默认的 OpenAI</span>
<span class="hljs-attr">Settings.llm</span> = DeepSeek(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"deepseek-chat"</span>,  <span class="hljs-comment"># 如有需要可改成其它 DeepSeek 模型</span>
)
​
<span class="hljs-attr">Settings.embed_model</span> = HuggingFaceEmbedding(
    <span class="hljs-attr">model_name</span>=<span class="hljs-string">"BAAI/bge-small-zh-v1.5"</span>  <span class="hljs-comment"># 适合中文的向量模型</span>
)
​
<span class="hljs-attr">documents</span> = [
    Document(
        text=<span class="hljs-string">"LlamaIndex 是一个用于构建 RAG 应用的数据框架。"</span>,
        metadata={<span class="hljs-string">"source"</span>: <span class="hljs-string">"intro"</span>},
    ),
    Document(
        text=<span class="hljs-string">"RAG 的核心思想是通过检索外部知识来增强 LLM 的回答能力。"</span>,
        metadata={<span class="hljs-string">"source"</span>: <span class="hljs-string">"rag"</span>},
    ),
]
​
​
<span class="hljs-attr">index</span> = VectorStoreIndex.from_documents(documents)
<span class="hljs-attr">query_engine</span> = index.as_query_engine()
​
<span class="hljs-attr">response</span> = query_engine.query(<span class="hljs-string">"什么是 RAG？"</span>)
​
print(response)
</code></pre>
<p>这里先加载定义在环境变量中的key，显示的指定模型。然后定义了文档数据数组，由<code>Document</code>对象构成，前面也介绍过，<code>Document</code>对象就是一个基本的数据单元。<code>VectorStoreIndex.from_documents(documents)</code>这行代码就是构建向量索引，和用户的输入做相似度检测。</p>
<p>一开始我以为将文本转化成向量，是一个有一个统一的标准，后来了解才发现不是这样的，将文本转化成向量，这是一种通用的思想，用一个多维数字向量来表示这段文字，但是具体使用多少维度的向量、那些语义更加接近，这都是向量模型来决定的，比如我们这个实例中选用的就是<code>model_name="BAAI/bge-small-zh-v1.5"</code>，还有个问题需要注意：这里的模型和我们最后的llm模型是两码事，<code>BAAI/bge-small-zh-v1.5</code>模型是<code>embedding</code>模型，将我们的用户输入和文档转换成向量，做相似度匹配的，而llm模型才是最终的推理模型。</p>
<p>构建好向量索引后，就可以借此来构建查询引擎，<code>index.as_query_engine()</code>，<code>query_engine</code>的职责就是将用户的输入构建成向量来和文档向量做相似度匹配，将检索到的内容和问题一起给llm总结回答。</p>
<p>最后调用<code>query_engine.query</code>来发起查询。</p>
<h2 data-id="heading-5">三. RAG 流程的五大阶段</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.llamaindex.ai%2Fpython%2Fframework%2Funderstanding%2Frag%2F" target="_blank" title="https://developers.llamaindex.ai/python/framework/understanding/rag/" ref="nofollow noopener noreferrer">文档地址</a></p>
<h3 data-id="heading-6">3.1 阶段一：加载 (Loading)</h3>
<p>加载阶段是整个RAG流程的第一步，将用户输入的数据引入系统，转化为<code>LlamaIndex</code>可以理解和处理的结构。这里主要有两个核心概念</p>
<ul>
<li>
<p><strong>Document / Node</strong>：数据容器和原子数据块的抽象。</p>
<p>这里前面已经介绍过了，<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.llamaindex.ai%2Fpython%2Fframework%2Fmodule_guides%2Floading%2Fdocuments_and_nodes%2F" target="_blank" title="https://developers.llamaindex.ai/python/framework/module_guides/loading/documents_and_nodes/" ref="nofollow noopener noreferrer">文档</a>也很清晰，<code>Document</code>本身就是一个原始的数据容器，用于存储加载的文本和内容，比如：</p>
<pre><code class="hljs language-ini" lang="ini">from llama_index import Document
​
<span class="hljs-attr">doc</span> = Document(
    <span class="hljs-attr">text</span>=<span class="hljs-string">"LlamaIndex 是一个连接 LLM 与外部数据的框架。"</span>,
    <span class="hljs-attr">metadata</span>={<span class="hljs-string">"source"</span>: <span class="hljs-string">"官方文档"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"tutorial"</span>}
)
​
</code></pre>
<p>而<code>Node</code>是从<code>Document</code>切分出来的最小单元信息，通常是按照段落、句子或者语义进行切分的，是向量化和索引的基本粒度。</p>
<pre><code class="hljs language-ini" lang="ini">from llama_index.node_parser import SimpleNodeParser
​
<span class="hljs-attr">parser</span> = SimpleNodeParser()
<span class="hljs-attr">nodes</span> = parser.get_nodes_from_documents([doc])
</code></pre>
<p>这里就是将<code>Document</code> 切分成的多个 <code>Node</code></p>
</li>
<li>
<p><strong>Data Connectors (LlamaHub)</strong> ：数据源连接器集合。</p>
<p>就是一个类似于数据接口库，可以快速从各种外部数据源加载文档。有一个说法就是：LlamaHub的设计是<code>LlamaIndex</code>可以工程化的核心设计之一，就是因为他实现了所有的<code>Reader</code>都遵循统一模式：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">reader</span> = SomeReader(...)
<span class="hljs-attr">documents</span> = reader.load_data()
<span class="hljs-comment"># -&gt; List[Document]</span>
</code></pre>
<p>也就是说不管读取任何数据，最终都会输出一个统一的<code>Document</code>的列表。</p>
<p>读取<code>Notion</code>数据库</p>
<pre><code class="hljs language-ini" lang="ini">from llama_index.readers.notion import NotionReader
​
<span class="hljs-attr">reader</span> = NotionReader(
    <span class="hljs-attr">notion_token</span>=<span class="hljs-string">"YOUR_TOKEN"</span>,
    <span class="hljs-attr">database_id</span>=<span class="hljs-string">"DATABASE_ID"</span>
)
​
<span class="hljs-attr">documents</span> = reader.load_data()
</code></pre>
<p>读取word/PDF</p>
<pre><code class="hljs language-ini" lang="ini">from llama_index import SimpleDirectoryReader
​
<span class="hljs-attr">reader</span> = SimpleDirectoryReader(
    <span class="hljs-attr">input_files</span>=[<span class="hljs-string">"design.pdf"</span>, <span class="hljs-string">"api.docx"</span>]
)
​
<span class="hljs-attr">documents</span> = reader.load_data()
</code></pre>
<p>读取github</p>
<pre><code class="hljs language-ini" lang="ini">from llama_index.readers.github import GithubRepositoryReader
​
<span class="hljs-attr">reader</span> = GithubRepositoryReader(
    <span class="hljs-attr">owner</span>=<span class="hljs-string">"openai"</span>,
    <span class="hljs-attr">repo</span>=<span class="hljs-string">"openai-python"</span>,
    <span class="hljs-attr">use_parser</span>=<span class="hljs-literal">True</span>
)
​
<span class="hljs-attr">documents</span> = reader.load_data()
</code></pre>
<p><code>LlamaIndex</code>用过这种设计，是的所有的<code>Reader</code>统一返回<code>Document</code>数组，使得不同的数据源能够以零适配成本接入同一RAG与Agent管道</p>
</li>
</ul>
<h3 data-id="heading-7">3.2 阶段二：索引 (Indexing)</h3>
<p>索引的目标只有一个，即将不可检索的原始文本，转换为可高效检索的结构化表示，这一步由三个核心抽象类来协作完成：</p>
<ul>
<li>
<p><strong>NodeParser</strong>：负责将 <code>Document</code> 切分为 Node 的工具。</p>
<p>他的职责主要有下面几个：负责切分<code>Document</code>，控制chunk的大小，保留上下级关系和维护metadata中的继承关系。</p>
<p>看下这个实例：</p>
<pre><code class="hljs language-ini" lang="ini">from llama_index.core.node_parser import SentenceSplitter
​
<span class="hljs-attr">parser</span> = SentenceSplitter(
    <span class="hljs-attr">chunk_size</span>=<span class="hljs-number">512</span>,
    <span class="hljs-attr">chunk_overlap</span>=<span class="hljs-number">50</span>
)
​
<span class="hljs-attr">nodes</span> = parser.get_nodes_from_documents(documents)
</code></pre>
<p><code>SentenceSplitter</code>是<code>LlamaIndex</code>核心库中提供基于语义、句子边界的文档分割器，而不是简单的按照字符数硬切割，他的核心特点就是优先以自然句子为分割边界，比如段落中的分隔符，句号、逗号和感叹号等，避免切割到句子中间导致语义断裂；同时还兼顾预设的分块大小限制，在语义完整和分块尺寸之间做平衡，这个也是<code>LlamaIndex</code>中最常用、最推荐的文档分割器。</p>
<p><code>SentenceSplitter</code>的两个参数，<code>chunk_size</code>就是写个文本块(chunk)的最大令牌数限制，通常根据llm上下文窗口的大小设定的；<code>chunk_overlap</code>是相邻两个文本块之间的重叠令牌数量，目的就是为了保持文本上下文的连续性，避免因为分块导致的语义断层。</p>
<p>最终输出的<code>nodes</code>就是一个<code>Node</code>的列表</p>
</li>
<li>
<p><strong>Embeddings</strong>：将文本转化为向量表示。</p>
<p>这里就是使用模型将<code>Node</code>数组转换为向量，比如之前的例子：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Settings.embed_model</span> = HuggingFaceEmbedding(
    <span class="hljs-attr">model_name</span>=<span class="hljs-string">"BAAI/bge-small-zh-v1.5"</span>  <span class="hljs-comment"># 适合中文的向量模型</span>
)
</code></pre>
</li>
<li>
<p><strong>Index</strong>：可查询的数据结构。</p>
<p>这里的<code>Index</code>是一种将<code>Node</code>组织为可查询结构的数据结构，<code>LlamaIndex</code>提供了很多种索引类型，</p>
<ul>
<li><code>VectorStoreIndex</code> 将文本块转为高维稠密向量（Embedding），基于语义相似性检索，这里的语义相似度检索就是余弦相似度检索，通过计算向量的夹角来对比匹配的相关内容，实现懂意图的语义检索。这个适合绝大多数的<code>RAG</code>场景，也是最通用的一个<code>Index</code>索引类型</li>
<li><code>SummaryIndex</code> 无复杂检索逻辑，直接将全量文档 / Node 输入 LLM 进行总结或问答 ，配置极简、无需嵌入模型、保留文本完整上下文，适合超短文档（几百字内）的场景。</li>
<li><code>KeywordTableIndex</code> 从文档中提取核心关键词，构建「关键词 - 文档块」映射表，基于字面关键词匹配检索 ， 适合关键词明确的短文档检索 ，比如基于产品编号、订单号查询</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">3.3 阶段三：存储 (Storing)</h3>
<p>存储阶段是将构建好的索引数据持久化的环节，主要基于这两个类来实现的：</p>
<ul>
<li>
<p><strong>StorageContext</strong>：持久化索引的机制。</p>
<p><code>StorageContext</code>是专门用于封装、管理所有索引相关存储组件的上下文容器，也是实现索引持久化、从存储中加载索引的核心机制。</p>
<p>看下文档中给的例子：</p>
<pre><code class="hljs language-ini" lang="ini">from llama_index.storage.storage_context import StorageContext
from llama_index.vector_stores import ChromaVectorStore
from llama_index import VectorStoreIndex
​
<span class="hljs-comment"># 初始化向量存储（Chroma）</span>
<span class="hljs-attr">vector_store</span> = ChromaVectorStore(collection_name=<span class="hljs-string">"my_docs"</span>)
​
<span class="hljs-comment"># 创建 StorageContext</span>
<span class="hljs-attr">storage_context</span> = StorageContext.from_defaults(vector_store=vector_store)
​
<span class="hljs-comment"># 使用 StorageContext 构建 Index</span>
<span class="hljs-attr">index</span> = VectorStoreIndex.from_documents(
    documents,
    <span class="hljs-attr">storage_context</span>=storage_context
)
​
<span class="hljs-comment"># 持久化 Index</span>
index.storage_context.persist()
</code></pre>
<p><code>ChromaVectorStore</code>是<code>LlamaIndex</code>对开源向量库<code>Chroma</code>的封装，<code>ChromaVectorStore(collection_name="my_docs")</code>就是创建一个名字叫做<code>my_docs</code>的集合，用来存储向量；<code>StorageContext.from_defaults(vector_store=vector_store)</code>就是快速创建一个<code>StorageContext</code>，后续在构建索引的时候，传入创建的<code>storage_context</code>，这样就知道向量要存储的地方；而<code>VectorStoreIndex</code>就是前面介绍的将文本转换为向量的<code>Index</code>类型， 最终返回的<code>index</code> 是一个可以用来 <code>as_query_engine()</code> / <code>as_retriever()</code> 的索引对象 ；<code>index.storage_context</code>就是前面传递的<code>storage_context</code>，<code>persist()</code>方法就是将向量存储到磁盘中；这样下次程序启动时，可以重新创建同样的<code>ChromaVectorStore</code>，就不用在从原始的<code>Document</code>中重新创建索引。</p>
</li>
<li>
<p><strong>Vector Store</strong>：向量数据库</p>
<p>向量数据库就是用来做向量的插入和删除操作，然后持久化存储向量，后续避免重复创建，同时也会做相速度搜索。</p>
<p>常见的有</p>
<ul>
<li>Chroma 一个开源的向量数据库，支持本地嵌入，可以快速部署</li>
<li>Pinecone 运行量数据库，支持高性能检索和自动扩容</li>
<li>FAISS 本地向量数据库，适合大规模快速计算</li>
</ul>
</li>
</ul>
<h3 data-id="heading-9">3.4 阶段四：查询 (Querying)</h3>
<p>这个是对用户真正产生价值的阶段，就是在已有索引的基础上，检索最相关的上下文，结合用户问题，生成可控、可追溯的回答。</p>
<ul>
<li>
<p><strong>Retriever</strong></p>
<p>根据一些指定的策略来检索相关的<code>Node</code>，主要有这样一些策略</p>
<ul>
<li>Similarity Search 基于向量相速度</li>
<li>Top-K 返回最相似的K个Node</li>
<li>Metadata Filter 按照metadata过滤</li>
<li>Hybrid Search 向量加关键字</li>
</ul>
</li>
<li>
<p><strong>Response Synthesizer</strong></p>
<p>将检索到的上下文和查询结合，生成最终答案。它关注的问题是如何组织上下文，如何调用llm和如何避免幻觉。</p>
<p>在 LlamaIndex 中，查询阶段通过 Retriever 精准召回相关 Node，再由 Response Synthesizer 组织上下文并生成回答，实现了检索与生成的清晰解耦，是 RAG 系统可控性与质量的核心保障。</p>
</li>
</ul>
<h3 data-id="heading-10">3.5 阶段五：评估 (Evaluation)</h3>
<p>当构建一个<code>RAG</code>系统后，一个很核心的问题就是如何科学的评估它的表现，如何量化的追踪、迭代并提升<code>RAG</code>应用的性能，当系统出现幻觉时如何快速的定位问题，这都是对于开发者来说非常关键的。</p>
<p>文档对于<code>RAG</code>系统的评估主要聚焦于解决三个核心问题：</p>
<ul>
<li>
<p>检索质量</p>
<p>检索是否把与问题最相关的信息找出来，有没有遗漏关键信息，有这么几个衡量指标：Recall@K，在检索返回的前<code>k</code>个文档块中是否包含至少一个于query相关的正确文档，衡量检索的召回能力</p>
</li>
<li>
<p>生成质量</p>
<p>生成质量主要有这么几个评估维度：回答事实一致性，主要看生成的内容是否严格基于检索上下文，而非模型自身的幻觉补全；回答相关性：看回答是否真正解决了用户的问题，是否存在看似合理但答非所问的情况；覆盖度与简洁性：是否遗漏相关信息，或者引入与问题无关的冗余内容</p>
</li>
<li>
<p>端到端RAG性能</p>
<p>端到端关注的问题是：从用户提问到最终答案，系统整体是否看起来像一个可靠的专家，这里需要关注一些最终答案的正确率、可用性，错误类型分布和响应时间与成本等。当系统出现幻觉或者错误时，可以反向拆解定位问题究竟出现在检索层、生成层，还是两者的协同策略上，从而指导下一轮的优化。</p>
</li>
</ul>
<p>这里都是一些概念性的东西，自己看的时候也是混个眼熟，终归还是要落到代码环节。后面做一个菜谱的智能问题系统实战，应该对RAG有个更加深入的理解。这里推荐一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fdatawhalechina.github.io%2Fall-in-rag%2F%23%2F" target="_blank" title="https://datawhalechina.github.io/all-in-rag/#/" ref="nofollow noopener noreferrer">教程</a>，我也是通读了一遍，但是这种好文章看几遍都不为过，应该是阿里搞得社区，很不错。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Wireshark、Fiddler、Charles抓包工具详细使用指南]]></title>    <link>https://juejin.cn/post/7598464972912623656</link>    <guid>https://juejin.cn/post/7598464972912623656</guid>    <pubDate>2026-01-24T09:25:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598464972912623656" data-draft-id="7598464972912607272" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Wireshark、Fiddler、Charles抓包工具详细使用指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-24T09:25:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是谁的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2390811467846089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Wireshark、Fiddler、Charles抓包工具详细使用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2390811467846089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是谁的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T09:25:35.000Z" title="Sat Jan 24 2026 09:25:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>抓包工具</strong></p>
<h2 data-id="heading-0">1.1      常用抓包工具</h2>
<p>常用的抓包工具有：Wireshark、Fiddler、Charles。此外，Sniffmaster作为一款全平台抓包工具，支持HTTPS、TCP和UDP协议，可在iOS/Android/Mac/Windows设备上实现无需代理、越狱或root的抓包操作。</p>
<p>Wireshark、Fiddler、Charles的优缺点：</p>
<p>①Wireshark是一种在网络层上工作的抓包工具，不仅自带大量的协议分析器，而且可以通过编写Wireshark插件来识别自定义的协议。虽然Wireshark功能强大，但是却并不能解决所有的抓包问题，其原因在于：Wireshark工作在网络层；如果计算机配置了IPSec传输层加密，则在网络层的流量都已经被加密，什么也看不到。当今大量网络接口使用HTTPS加密，Wireshark不能抓取到HTTPS流量的明文内容。</p>
<p>②Fiddler和Charles工作在应用层上，作为其他程序的HTTP代理服务器。它可以直接抓取并分析HTTP流量，也可以作为“中间人”抓取并分析HTTPS流量。</p>
<h2 data-id="heading-1">1.2      参考资料</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fkristin%2Fp%2F8445141.html" target="_blank" title="https://www.cnblogs.com/kristin/p/8445141.html" ref="nofollow noopener noreferrer">www.cnblogs.com/kristin/p/8…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fsb%255C%255C_%255C%255C_%255C%255C_itfk%2Farticle%2Fdetails%2F45250771" target="_blank" title="https://blog.csdn.net/sb%5C%5C_%5C%5C_%5C%5C_itfk/article/details/45250771" ref="nofollow noopener noreferrer">blog.csdn.net/sb\\_\\_\\_…</a></p>
<h2 data-id="heading-2">2.1      wireshark使用</h2>
<h2 data-id="heading-3">2.1.1  抓取数据包</h2>
<ol>
<li>选择抓包网口，选择抓包网口有两种方式</li>
</ol>
<p>l  第一种，启动wireshark后，直接双击以太网，就会开始抓包。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edd30c3b78ee4bedb24e1e84abe245ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=hdQy4%2BKSqIpAyAvngExoOC9I%2B54%3D" alt="" loading="lazy"/></p>
<p>l  第二种，启动wireshark后，点击捕获—&gt;&gt;选项。在弹出框中选择网卡以及配置过滤条件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0739fec9620469fbde20b2f7616ce09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=%2BZwbQ2MPEx9efEt9TmTv9GGo3CU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6babb79bea514dbaa77310ba073ff48c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=8vzFN6mgrFKyEAcXz7l6nK2OyAg%3D" alt="" loading="lazy"/></p>
<ol>
<li>停止抓包，点击停止后，可以将捕获的数据包保存。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82292e776a2c4288a61460b54c078923~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=8JSOVqM3%2FFfsn%2BkpkTVq9Arkuww%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4843c120792449a88a93ec4624a112ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=NYvvB1poutTj4oLilLJUOd4HaYs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">2.1.2  常用过滤、分析</h2>
<p>捕获的数据包比较多，可以通过一些语法进行筛选。</p>
<ol>
<li>根据ip地址进行筛选，语法如下ip.addr==192.168.0.121。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78e84a52fa79405fac476cd4515dc7b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=NAaC3agc5130gtuLg7nlKixUK9M%3D" alt="" loading="lazy"/></p>
<ol>
<li>根据http.request过滤所有http请求</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d21768103a74b0abb8250c81b7fdd86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=judQyl1wPT3FGFc3w1GCT2rDDlw%3D" alt="" loading="lazy"/></p>
<ol>
<li>根据关键字查询</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95374a42daa748d7a35b849077b5ccc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=0W3HFqRDGWLYanaLPtZWTJnPvuQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">2.1.3 查看捕获的数据</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/562deb583fa44814be662fc07540029e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=g0GtfsOmd0zWaIwshSjKK%2BPuRbo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">2.2      Fiddler使用</h2>
<h2 data-id="heading-7">2.2.1  抓取数据包</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab4f8e38c14c482ebc68a8a242628967~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=UxQY8U0A3dnZTNvI0YSuN5p4c%2Bc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">2.2.2  搜索会话</h2>
<p>按住ctrl+F,输入关键字，点击find session，进行搜索</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6aa9b1158ff64b64b1926bf19c318e14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=NN%2BB0xBTeNemHvImfxTOjlCyB5I%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">2.2.3  查看会话</h2>
<p>选择一个会话，根据结果的请求/响应的不同数据类型，显示会话。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce7b04e25f1e428fa5fa500079aae0e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=%2FQ3EjL4SnyS3Znk%2FKujhPj1TRMs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">2.2.4  设置代理</h2>
<ol>
<li>Tools-&gt; Fiddler Options</li>
</ol>
<p>选中"Allow remote computers to connect". 是允许别的机器把HTTP/HTTPS请求发送到Fiddler上来</p>
<p>记住这个端口号是:8888，通过ipconfig查看本机的ip，如本机ip为192.168.2.11</p>
<ol>
<li>在手机上进行代理设置</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51f6f245c75b4478a02334501e870b50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=WtVddGOwjqey30fIxcipm6kTgqg%3D" alt="" loading="lazy"/></p>
<ol>
<li>下载Fiddler的安全证书</li>
</ol>
<p>使用android手机的浏览器打开：<a href="https://link.juejin.cn?target=http%3A%2F%2F192.168.2.11%3A8888%25EF%25BC%258C" target="_blank" title="http://192.168.2.11:8888%EF%BC%8C" ref="nofollow noopener noreferrer">http://192.168.2.11:8888，</a> 点"FiddlerRoot certificate"，然后安装证书。</p>
<p>安装完成后，就可以在fiddler上看到手机的HTTP请求</p>
<h2 data-id="heading-11">2.2.5  抓取HTTPS数据包</h2>
<p>l  Fiddler抓取HTTPS数据包过程原理：</p>
<p>l  fiddler接到客户端的https请求，fiddler将请求转发给服务器</p>
<p>l  服务器生成公钥证书，返回给fiddler；fiddler拦截下真的公钥证书，并生成伪造的公钥证书给客户端；</p>
<p>l  客户端使用伪造的公钥证书加密共享密钥发送给fiddler，fiddler使用伪造的私钥解密获取共享密钥</p>
<p>l  fiddler将解密后的共享密钥，使用真正的公钥加密发送给服务器端，服务器使用共享密钥与fiddler通信</p>
<p>l  fiddler使用共享密钥与客户端通信</p>
<ol>
<li>设置抓取HTTPS，PC机安装根证书：</li>
</ol>
<p>Tools-&gt;options-&gt;HTTPS-&gt;capture https connects-&gt;decrypt https traffic-&gt;ignore server certificate errors(unsafe)-&gt;actions-&gt;trust root certificate-&gt;确定-&gt;OK</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd09bcb28794422595e6621010ee9a98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=0SYYQUgA3v3WlLwkMYbyLCDP2BQ%3D" alt="" loading="lazy"/></p>
<ol>
<li>安装根证书后，可以点击Actions-&gt;open windows certificate manager查看安装到系统的根证书</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9a5dbda63fb4b95810198411714a0dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oiR5piv6LCB55qE56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769851535&amp;x-signature=Xe06AzrHK9b7JxtS%2BXxSRzXIduM%3D" alt="" loading="lazy"/></p>
<p>对于需要无需代理的HTTPS抓包，Sniffmaster提供了暴力抓包模式，直接解密HTTPS流量，支持指定APP过滤和双向验证爆破。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[苹果iOS应用上架App Store完整流程与注意事项指南]]></title>    <link>https://juejin.cn/post/7598827845965201434</link>    <guid>https://juejin.cn/post/7598827845965201434</guid>    <pubDate>2026-01-24T09:52:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598827845965201434" data-draft-id="7598532592455860251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="苹果iOS应用上架App Store完整流程与注意事项指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-24T09:52:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="我是谁的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2390811467846089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            苹果iOS应用上架App Store完整流程与注意事项指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2390811467846089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    我是谁的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T09:52:01.000Z" title="Sat Jan 24 2026 09:52:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>苹果iOS上架是指将开发者开发的应用程序提交到苹果公司的App Store中，经过审核后使应用程序能够在App Store中正式上架并供用户下载使用。下面将详细介绍iOS上架的流程和注意事项。</p>
<p>一、开发阶段</p>
<p>在开发阶段，开发者需要遵循苹果公司的相关规定和要求进行开发。具体包括：</p>
<p>1.使用Apple官方提供的开发工具Xcode进行开发。</p>
<p>2.遵循苹果公司的人机交互设计指南，设计符合用户体验的应用程序。</p>
<p>3.遵循苹果公司的编码规范，编写符合规范的代码。</p>
<p>4.遵循苹果公司的隐私政策和数据保护要求，保护用户隐私。</p>
<p>5.在应用程序中集成Apple提供的支付和广告服务。</p>
<p>二、提交应用程序</p>
<p>在开发完成后，开发者需要将应用程序提交到苹果公司的App Store中进行审核。具体操作如下：</p>
<p>1.注册成为苹果开发者。</p>
<p>2.在Apple开发者网站中创建App ID，并为应用程序申请证书和描述文件。开发者也可以使用AppUploader工具进行iOS证书的申请和管理，简化证书创建流程。</p>
<p>3.在Xcode中打包应用程序并生成IPA文件。此外，AppUploader支持在Windows、Linux或Mac系统中直接上传IPA文件到App Store，无需Mac电脑，操作更便捷。</p>
<p>4.在Apple开发者网站中创建App Store Connect记录，并上传IPA文件。</p>
<p>5.填写应用程序的相关信息，包括名称、描述、图标、截图、价格等。</p>
<p>6.提交应用程序进行审核。</p>
<p>三、审核阶段</p>
<p>苹果公司的审核过程通常需要1-2周时间，审核过程中开发者需要注意以下事项：</p>
<p>1.遵循苹果公司的审核指南，确保应用程序符合规定和要求。</p>
<p>2.避免使用未经授权的第三方库和插件。</p>
<p>3.避免使用未经授权的商标和版权内容。</p>
<p>4.避免应用程序中存在功能缺陷和安全漏洞。</p>
<p>5.避免应用程序中存在欺诈和诈骗行为。</p>
<p>四、上架阶段</p>
<p>若应用程序审核通过，开发者可以在App Store中正式上架应用程序。具体操作如下：</p>
<p>1.在App Store Connect中设置应用程序的状态为“已上架”。</p>
<p>2.在App Store中搜索应用程序并确认应用程序的信息和价格。</p>
<p>3.用户可以下载和使用应用程序，开发者可以通过App Store Connect查看应用程序的下载量和收益。</p>
<p>总之，苹果iOS上架是一个需要遵循苹果公司相关规定和要求的过程，开发者需要保证应用程序的品质和安全性，确保用户能够获得良好的使用体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue使用<Suspense/>实现图片加载组件]]></title>    <link>https://juejin.cn/post/7598532592455761947</link>    <guid>https://juejin.cn/post/7598532592455761947</guid>    <pubDate>2026-01-24T09:10:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598532592455761947" data-draft-id="7598641282324480027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue使用&lt;Suspense/&gt;实现图片加载组件"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-24T09:10:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="咸鱼翻身更入味"/> <meta itemprop="url" content="https://juejin.cn/user/1031760609546968"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue使用&lt;Suspense/&gt;实现图片加载组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1031760609546968/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    咸鱼翻身更入味
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T09:10:50.000Z" title="Sat Jan 24 2026 09:10:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是Suspense？</h2>
<p><strong>Suspense</strong>是<strong>Vue</strong>的内置组件，能让你管理组件加载时的等待、出错和最终渲染逻辑。</p>
<p>主要配合<strong>异步组件</strong>、<code>async/await</code> 版的 <code>setup()</code> 使用。</p>
<p>它提供两个插槽：</p>
<ul>
<li><code>default</code>（默认插槽）：要渲染的异步内容</li>
<li><code>fallback</code>：等待异步内容加载时显示的兜底内容</li>
</ul>
<h2 data-id="heading-1">话不多说，上代码：</h2>
<h3 data-id="heading-2">第一步，实现图片异步组件</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;img 
    :src="props.src" 
    :alt="props.alt" 
    :style="{ 
      width: setWidth, 
      height: setHeight, 
      borderRadius: rounded, 
      objectFit: 'cover'
    }"
    /&gt;
&lt;/template&gt;
// =================================== 此处为计算属性逻辑 ================================
&lt;script setup lang="ts"&gt;
import { computed, ref } from "vue";

// 图片形状可选项
type ShapeOption = "circle" | "square" | "roundRect";

interface ILazyImage {
  src: string;
  width:string|number;
  height:string|number;
  delay?:number;//延迟执行？
  timeout?:number;//超时时间？
  shape?:ShapeOption;//图片形状
  alt?:string;
}

const props = defineProps&lt;ILazyImage&gt;();

//计算超时
const timeoutSet = computed(() =&gt; {
    let time = Number(props.timeout) || 5;
    return time * 1000;
});

//计算延迟
const delayTime = computed(() =&gt; {
    let time = Number(props.delay) || 0.1;
    return time * 1000;
});


//计算宽度
const setWidth = computed(() =&gt; {
    const val = parseFloat(props.width)
    if(!val) return '100px'
    return val  + "px";
});

//计算高度
const setHeight = computed(() =&gt; {
    const val = parseFloat(props.Height)
    if(!val) return '100px'
    return val  + "px";
});

// 计算圆角
const rounded = computed(() =&gt; {
    switch (props.shape) {
        case "circle":
            return "50%";
        case "square":
            return "0";
        case "roundRect":
            return "10px";
        default:
            return "10px";
    }
});

//========================实现异步加载图片==================================

const loadImage = (src: string) =&gt; {
    return new Promise((resolve, reject) =&gt; {
    // 创建一个AbortController，用于取消请求
        const controller = new AbortController();
        const signal = controller.signal;

        const timeoutId = setTimeout(() =&gt; {
        // 超时时取消请求
            controller.abort();
            reject(new Error("图片加载超时"));
        }, timeoutSet.value);

        setTimeout(() =&gt; {
            const image = new Image();
            image.src = src;
            image.onload = () =&gt; {
                clearTimeout(timeoutId);
                resolve(src);
            };
            image.onerror = () =&gt; {
                clearTimeout(timeoutId);
                reject(new Error("图片加载失败"));
            };
        }, delayTime.value);
    });
};

// 执行图片加载（async/await 触发 Suspense 等待）
await loadImage(props.src);

&lt;/script&gt;
</code></pre>
<h3 data-id="heading-3">第二步：实现懒加载组件</h3>
<ul>
<li><code>default</code>（默认插槽）：要渲染的异步内容</li>
<li><code>fallback</code>：等待异步内容加载时显示的兜底内容</li>
<li>使用<code>v-bind()</code>绑定属性</li>
</ul>
<p>在 <code>&lt;Suspense&gt;&lt;/Suspense&gt;</code>中直接使用异步组件即可，<code>&lt;template #fallback&gt;&lt;/template&gt;</code>则是加载时显示</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;div&gt;
        &lt;Suspense&gt;
            &lt;template #default&gt;
                &lt;div class="image"&gt;
                    &lt;Image v-bind="{ ...props }"&gt;&lt;/Image&gt;
                &lt;/div&gt;
            &lt;/template&gt;
            &lt;template #fallback&gt;
                &lt;div class="skeleton"&gt;&lt;/div&gt;
            &lt;/template&gt;
        &lt;/Suspense&gt;
    &lt;/div&gt;
&lt;/template&gt;

&lt;script setup lang="ts"&gt;
import { computed } from "vue";
import Image from "./Image.vue";
// 图片形状可选项
type ShapeOption = "circle" | "square" | "roundRect";

interface ILazyImage {
  src: string;
  width:string|number;
  height:string|number;
  delay?:number;//延迟执行？
  timeout?:number;//超时时间？
  shape?:ShapeOption;//图片形状
  alt?:string;
}

const props = defineProps&lt;ILazyImage&gt;();

//计算超时
const timeoutSet = computed(() =&gt; {
    let time = Number(props.timeout) || 5;
    return time * 1000;
});

//计算延迟
const delayTime = computed(() =&gt; {
    let time = Number(props.delay) || 0.1;
    return time * 1000;
});


//计算宽度
const setWidth = computed(() =&gt; {
    const val = parseFloat(props.width)
    if(!val) return '100px'
    return val  + "px";
});

//计算高度
const setHeight = computed(() =&gt; {
    const val = parseFloat(props.Height)
    if(!val) return '100px'
    return val  + "px";
});

// 计算骨架屏动画：遮罩宽度（取容器宽度的 40%） 
const setSeletonWidth = computed(() =&gt; { 
    // 提取宽度数值（兼容 px 单位） 
    const widthNum = parseFloat(setWidth.value) || 100; 
    return `${widthNum * 0.4}px`;
}); 


// 骨架屏动画起始位置（从容器左侧外 30% 开始）
const setSeletonStartRight = computed(() =&gt; { 
    const widthNum = parseFloat(setWidth.value) || 100; 
    return `-${widthNum * 1.3}px`;  // 起始在容器左侧外
});

// 骨架屏动画结束位置（到容器右侧外 30%） 
const setSeletonEndRight = computed(() =&gt; { 
    const widthNum = parseFloat(setWidth.value) || 100; return `${widthNum * 1.3}px`;
    // 结束在容器右侧外
});

// 计算圆角
const rounded = computed(() =&gt; {
    switch (props.shape) {
        case "circle":
            return "50%";
        case "square":
            return "0";
        case "roundRect":
            return "10px";
        default:
            return "10px";
    }
});
&lt;/script&gt;

&lt;style scoped&gt;
.image {
    overflow: hidden;
}

.skeleton {
    width: v-bind(setWidth);
    height: v-bind(setHeight);
    background-color: #dfe4ea;
    overflow: hidden;
    position: relative;

    border-radius: v-bind(rounded);
}

.skeleton::before {
    content: "";
    display: block;
    background-color: #ced6e0;
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
    position: absolute;
    top: 0;
    right: v-bind(setSeletonStartRight);
    width: v-bind(setSeletonWidth);
    height: v-bind(setHeight);
    transform: skewX(-30deg);
    animation: ping 1s infinite ease-out;
    filter: blur(10px);
}

@keyframes ping {
    from {
        right: v-bind(setSeletonStartRight);
    }

    to {
        right: v-bind(setSeletonEndRight);
    }
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-4">补充</h3>
<ul>
<li>
<p>代码内有些重复的内容，可使用另外的<code>ts</code>来声明或实现。</p>
</li>
<li>
<p>其中可能有些变量或实现过程有误，此文章仅供参考。</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[loadtest-自动获取网站性能极限]]></title>    <link>https://juejin.cn/post/7598480413803724842</link>    <guid>https://juejin.cn/post/7598480413803724842</guid>    <pubDate>2026-01-24T10:02:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598480413803724842" data-draft-id="7598447519824232489" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="loadtest-自动获取网站性能极限"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2026-01-24T10:02:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮皮强是只皮皮虾"/> <meta itemprop="url" content="https://juejin.cn/user/2623854603679966"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            loadtest-自动获取网站性能极限
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2623854603679966/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮皮强是只皮皮虾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T10:02:29.000Z" title="Sat Jan 24 2026 10:02:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>传统压力测试工具操作复杂，对于一些简单的场景想要快速知道服务器的性能极限，为扩容或者选购服务器提供一些数据参考我开发了这款工具。这个工具已经在以往的很多小项目中为我快速定位系统瓶颈提供了不少帮助。现在我将它开源出来，希望也能帮助到在接单做外包的小伙伴。</p>
</blockquote>
<h2 data-id="heading-0">项目简介</h2>
<p>loadtest 是一个用 Go 语言编写的轻量级负载测试工具，它可以根据目标 URL 的响应时间自动调整并发数，对目标网站进行高效的压力测试。</p>
<h2 data-id="heading-1">功能特点</h2>
<ul>
<li><strong>自动调整并发数</strong>：根据目标 URL 的响应时间自动增加或减少并发数，确保测试结果更加准确。</li>
<li><strong>实时统计监控</strong>：每 5 秒输出一次测试统计信息，包括请求数、成功数、失败数和平均响应时间。</li>
<li><strong>灵活的配置选项</strong>：支持自定义初始并发数、最大并发数和目标延迟时间。</li>
<li><strong>多平台支持</strong>：提供了 Windows、macOS 和 Linux 等多个平台的可执行文件。</li>
<li><strong>详细的日志记录</strong>：所有测试数据都会记录到日志文件中，方便后续分析。</li>
</ul>
<h2 data-id="heading-2">安装方法</h2>
<h3 data-id="heading-3">从预编译二进制文件安装</h3>
<p>可以从项目的 <code>release</code>  页面直接下载对应平台的可执行文件：</p>
<ul>
<li>Windows: <code>loadtest-windows-amd64.exe</code> 或 <code>loadtest-windows-arm64.exe</code></li>
<li>macOS: <code>loadtest-darwin-amd64</code> 或 <code>loadtest-darwin-arm64</code></li>
<li>Linux: <code>loadtest-linux-amd64</code>、<code>loadtest-linux-arm64</code> 或 <code>loadtest-linux-armv7</code></li>
</ul>
<h3 data-id="heading-4">从源代码编译</h3>
<ol>
<li>确保已安装 Go 1.16 或更高版本</li>
<li>克隆代码仓库</li>
<li>执行 <code>make</code> 命令编译</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> &lt;仓库地址&gt;
<span class="hljs-built_in">cd</span> loadtest
make
</code></pre>
<h2 data-id="heading-5">使用方法</h2>
<h3 data-id="heading-6">基本用法</h3>
<pre><code class="hljs language-bash" lang="bash">./loadtest -url=&lt;目标URL&gt; [选项]
</code></pre>
<h3 data-id="heading-7">命令行参数说明</h3>









































<table><thead><tr><th>参数</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>-url</code></td><td>string</td><td>空</td><td>目标 URL（必填）</td></tr><tr><td><code>-initial-concurrency</code></td><td>int</td><td>10</td><td>初始并发数</td></tr><tr><td><code>-max-concurrency</code></td><td>int</td><td>1000</td><td>最大并发数</td></tr><tr><td><code>-target-latency</code></td><td>duration</td><td>100ms</td><td>目标延迟时间</td></tr><tr><td><code>-log</code></td><td>string</td><td>loadtest.log</td><td>日志文件路径</td></tr></tbody></table>
<h3 data-id="heading-8">示例</h3>
<ol>
<li>基本测试</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">./loadtest -url=https://www.baidu.com
</code></pre>
<ol start="2">
<li>自定义配置</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">./loadtest -url=https://www.baidu.com -initial-concurrency=20 -max-concurrency=500 -target-latency=200ms
</code></pre>
<ol start="3">
<li>自定义日志文件</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">./loadtest -url=https://www.baidu.com -<span class="hljs-built_in">log</span>=my_test.log
</code></pre>
<h2 data-id="heading-9">测试输出</h2>
<p>运行测试后，会在控制台显示以下信息：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">Load</span> <span class="hljs-string">testing</span> <span class="hljs-string">started.</span> <span class="hljs-string">Logs</span> <span class="hljs-string">are</span> <span class="hljs-string">written</span> <span class="hljs-string">to</span> <span class="hljs-string">loadtest.log</span>
<span class="hljs-attr">Initial concurrency:</span> <span class="hljs-number">10</span><span class="hljs-string">,</span> <span class="hljs-attr">Max concurrency:</span> <span class="hljs-number">1000</span><span class="hljs-string">,</span> <span class="hljs-attr">Target latency:</span> <span class="hljs-string">100ms</span>
<span class="hljs-string">Press</span> <span class="hljs-string">Ctrl+C</span> <span class="hljs-string">to</span> <span class="hljs-string">stop</span>
</code></pre>
<p>按下 Ctrl+C 停止测试后，会输出最终统计结果：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Final Results:</span>
<span class="hljs-attr">Total Requests:</span> <span class="hljs-number">12345</span>
<span class="hljs-attr">Successful:</span> <span class="hljs-number">12300</span>
<span class="hljs-attr">Failed:</span> <span class="hljs-number">45</span>
<span class="hljs-attr">Average Response Time:</span> <span class="hljs-number">85.</span><span class="hljs-string">23ms</span>
<span class="hljs-attr">Success Rate:</span> <span class="hljs-number">99.63</span><span class="hljs-string">%</span>
<span class="hljs-attr">Final Concurrency Level:</span> <span class="hljs-number">150</span>
</code></pre>
<h2 data-id="heading-10">日志文件</h2>
<p>所有测试数据都会记录到指定的日志文件中，每 5 秒输出一次统计信息，格式如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">2023/01/01 12:00:00 Total - Requests:</span> <span class="hljs-number">1000</span><span class="hljs-string">,</span> <span class="hljs-attr">Success:</span> <span class="hljs-number">995</span><span class="hljs-string">,</span> <span class="hljs-attr">Failures:</span> <span class="hljs-number">5</span><span class="hljs-string">,</span> <span class="hljs-attr">Avg Time:</span> <span class="hljs-string">80ms</span>
<span class="hljs-attr">2023/01/01 12:00:00 Recent - Requests:</span> <span class="hljs-number">200</span><span class="hljs-string">,</span> <span class="hljs-attr">Success:</span> <span class="hljs-number">199</span><span class="hljs-string">,</span> <span class="hljs-attr">Failures:</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-attr">Avg Time:</span> <span class="hljs-string">78ms</span>
</code></pre>
<h2 data-id="heading-11">技术实现</h2>
<h3 data-id="heading-12">核心架构</h3>
<ul>
<li>采用工作协程池的设计模式，通过调整协程数量来控制并发数</li>
<li>使用上下文（Context）来管理协程的生命周期</li>
<li>使用读写锁保证统计数据的准确性</li>
</ul>
<h3 data-id="heading-13">自动调整算法</h3>
<ul>
<li>如果响应时间低于目标延迟的一半，就会增加 10% 的并发数</li>
<li>如果响应时间过高，就会保持当前并发数（未来可以扩展为减少并发数）</li>
<li>并发数不会超过设定的最大值</li>
</ul>
<h2 data-id="heading-14">GitHub</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fycq3%2Floadtest%2Freleases" target="_blank" title="https://github.com/ycq3/loadtest/releases" ref="nofollow noopener noreferrer">github.com/ycq3/loadte…</a>
国内镜像
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fpipiqiang%2Floadtest" target="_blank" title="https://gitcode.com/pipiqiang/loadtest" ref="nofollow noopener noreferrer">gitcode.com/pipiqiang/l…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥 Vue3 实现超丝滑打字机效果组件（可复用、高定制）]]></title>    <link>https://juejin.cn/post/7598532592455516187</link>    <guid>https://juejin.cn/post/7598532592455516187</guid>    <pubDate>2026-01-24T07:04:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598532592455516187" data-draft-id="7598499504170614822" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥 Vue3 实现超丝滑打字机效果组件（可复用、高定制）"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-24T07:04:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小马_xiaoen"/> <meta itemprop="url" content="https://juejin.cn/user/4438063859920414"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥 Vue3 实现超丝滑打字机效果组件（可复用、高定制）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4438063859920414/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小马_xiaoen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T07:04:17.000Z" title="Sat Jan 24 2026 07:04:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>在前端开发中，打字机效果能极大提升页面的交互趣味性和视觉体验，比如 AI 聊天回复、个性化介绍页等场景都非常适用。本文将分享一个基于 Vue3 + Composition API 开发的<strong>高性能、高定制化</strong>打字机组件，支持打字/删除循环、光标闪烁、自定义样式等核心功能，且代码结构清晰、易于扩展。</p>
<h2 data-id="heading-0">🎯 组件特性</h2>
<ul>
<li>✅ 自定义打字速度、删除速度、循环延迟</li>
<li>✅ 支持光标显示/隐藏、闪烁效果开关</li>
<li>✅ 打字完成后自动删除（可选）+ 循环播放</li>
<li>✅ 完全自定义样式（字体、颜色、大小等）</li>
<li>✅ 暴露控制方法（开始/暂停），支持手动干预</li>
<li>✅ 无第三方依赖，纯原生 Vue3 实现</li>
<li>✅ 性能优化：组件卸载自动清理定时器，避免内存泄漏
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/430e5abc5ccf4784b4debc3857893d87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6amsX3hpYW9lbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769843056&amp;x-signature=3g31BSS0j3jO4WQZhc%2Fz50kXXjI%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ul>
<h2 data-id="heading-1">📝 完整组件代码</h2>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"typewriter-container"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"fontsConStyle"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 打字文本 - 逐字符渲染 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"typewriter-text"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> 
        <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(char, index) in displayedText"</span> 
        <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span> 
        <span class="hljs-attr">class</span>=<span class="hljs-string">"character"</span>
        <span class="hljs-attr">:data-index</span>=<span class="hljs-string">"index"</span>
      &gt;</span>
        {{ char }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 光标 - 精准控制显示/闪烁 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span> 
      <span class="hljs-attr">v-if</span>=<span class="hljs-string">"showCursor &amp;&amp; isCursorVisible"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"cursor"</span>
      <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ 'blink': showBlinkCursor }"</span>
      <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">"true"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref, onMounted, onBeforeUnmount, computed, watch, watchEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-comment">// 组件 Props 定义（带完整校验）</span>
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-comment">// 要显示的文本内容</span>
  <span class="hljs-attr">text</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-string">""</span>
  },
  <span class="hljs-comment">// 打字速度（ms/字符）</span>
  <span class="hljs-attr">speed</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-number">80</span>,
    <span class="hljs-attr">validator</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> value &gt; <span class="hljs-number">0</span>
  },
  <span class="hljs-comment">// 是否显示光标</span>
  <span class="hljs-attr">showCursor</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-comment">// 光标是否闪烁</span>
  <span class="hljs-attr">blinkCursor</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-comment">// 是否自动开始打字</span>
  <span class="hljs-attr">autoStart</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-comment">// 是否循环播放</span>
  <span class="hljs-attr">loop</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>
  },
  <span class="hljs-comment">// 循环延迟（打字完成后等待时间）</span>
  <span class="hljs-attr">loopDelay</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-number">1000</span>,
    <span class="hljs-attr">validator</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> value &gt;= <span class="hljs-number">0</span>
  },
  <span class="hljs-comment">// 容器样式（自定义字体、颜色等）</span>
  <span class="hljs-attr">fontsConStyle</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> ({
      <span class="hljs-attr">fontSize</span>: <span class="hljs-string">"2rem"</span>,
      <span class="hljs-attr">fontFamily</span>: <span class="hljs-string">"'Courier New', monospace"</span>,
      <span class="hljs-attr">color</span>: <span class="hljs-string">"#333"</span>,
      <span class="hljs-attr">lineHeight</span>: <span class="hljs-string">"1.5"</span>
    })
  },
  <span class="hljs-comment">// 是否开启删除效果</span>
  <span class="hljs-attr">deleteEffect</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>
  },
  <span class="hljs-comment">// 删除速度（ms/字符）</span>
  <span class="hljs-attr">deleteSpeed</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-number">30</span>,
    <span class="hljs-attr">validator</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> value &gt; <span class="hljs-number">0</span>
  },
  <span class="hljs-comment">// 字符入场动画开关</span>
  <span class="hljs-attr">charAnimation</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span>
  }
});

<span class="hljs-comment">// 响应式状态</span>
<span class="hljs-keyword">const</span> displayedText = <span class="hljs-title function_">ref</span>(<span class="hljs-string">""</span>);    <span class="hljs-comment">// 当前显示的文本</span>
<span class="hljs-keyword">const</span> currentIndex = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);      <span class="hljs-comment">// 当前字符索引</span>
<span class="hljs-keyword">const</span> isPlaying = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);     <span class="hljs-comment">// 是否正在播放</span>
<span class="hljs-keyword">const</span> isDeleting = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);    <span class="hljs-comment">// 是否正在删除</span>
<span class="hljs-keyword">const</span> isCursorVisible = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>);<span class="hljs-comment">// 光标是否显示</span>

<span class="hljs-comment">// 定时器标识（用于清理）</span>
<span class="hljs-keyword">let</span> intervalId = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> timeoutId = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> cursorTimer = <span class="hljs-literal">null</span>;

<span class="hljs-comment">// 计算属性：控制光标闪烁状态</span>
<span class="hljs-keyword">const</span> showBlinkCursor = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> props.<span class="hljs-property">blinkCursor</span> &amp;&amp; 
         !isDeleting.<span class="hljs-property">value</span> &amp;&amp;
         (displayedText.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> === props.<span class="hljs-property">text</span>.<span class="hljs-property">length</span> || displayedText.<span class="hljs-property">value</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>);
});

<span class="hljs-comment">// 工具函数：清除所有定时器</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">clearAllTimers</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (intervalId) <span class="hljs-built_in">clearInterval</span>(intervalId);
  <span class="hljs-keyword">if</span> (timeoutId) <span class="hljs-built_in">clearTimeout</span>(timeoutId);
  <span class="hljs-keyword">if</span> (cursorTimer) <span class="hljs-built_in">clearInterval</span>(cursorTimer);
  intervalId = <span class="hljs-literal">null</span>;
  timeoutId = <span class="hljs-literal">null</span>;
  cursorTimer = <span class="hljs-literal">null</span>;
};

<span class="hljs-comment">// 核心方法：开始打字</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">startTyping</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 重置状态</span>
  <span class="hljs-title function_">clearAllTimers</span>();
  isPlaying.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  isDeleting.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  currentIndex.<span class="hljs-property">value</span> = <span class="hljs-number">0</span>;
  displayedText.<span class="hljs-property">value</span> = <span class="hljs-string">""</span>;
  isCursorVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  
  <span class="hljs-comment">// 打字逻辑</span>
  intervalId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (currentIndex.<span class="hljs-property">value</span> &lt; props.<span class="hljs-property">text</span>.<span class="hljs-property">length</span>) {
      displayedText.<span class="hljs-property">value</span> = props.<span class="hljs-property">text</span>.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, currentIndex.<span class="hljs-property">value</span> + <span class="hljs-number">1</span>);
      currentIndex.<span class="hljs-property">value</span>++;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 打字完成</span>
      <span class="hljs-built_in">clearInterval</span>(intervalId);
      isPlaying.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
      
      <span class="hljs-comment">// 循环逻辑</span>
      <span class="hljs-keyword">if</span> (props.<span class="hljs-property">loop</span>) {
        <span class="hljs-keyword">if</span> (props.<span class="hljs-property">deleteEffect</span>) {
          timeoutId = <span class="hljs-built_in">setTimeout</span>(startDeleting, props.<span class="hljs-property">loopDelay</span>);
        } <span class="hljs-keyword">else</span> {
          timeoutId = <span class="hljs-built_in">setTimeout</span>(startTyping, props.<span class="hljs-property">loopDelay</span>);
        }
      }
    }
  }, props.<span class="hljs-property">speed</span>);
};

<span class="hljs-comment">// 核心方法：开始删除</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">startDeleting</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">clearAllTimers</span>();
  isDeleting.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  
  intervalId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (currentIndex.<span class="hljs-property">value</span> &gt; <span class="hljs-number">0</span>) {
      currentIndex.<span class="hljs-property">value</span>--;
      displayedText.<span class="hljs-property">value</span> = props.<span class="hljs-property">text</span>.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, currentIndex.<span class="hljs-property">value</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 删除完成</span>
      <span class="hljs-built_in">clearInterval</span>(intervalId);
      isDeleting.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
      
      <span class="hljs-comment">// 循环打字</span>
      <span class="hljs-keyword">if</span> (props.<span class="hljs-property">loop</span>) {
        timeoutId = <span class="hljs-built_in">setTimeout</span>(startTyping, props.<span class="hljs-property">loopDelay</span>);
      } <span class="hljs-keyword">else</span> {
        isCursorVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 非循环模式下删除完成隐藏光标</span>
      }
    }
  }, props.<span class="hljs-property">deleteSpeed</span>);
};

<span class="hljs-comment">// 监听文本变化：自动重启打字（适配动态文本场景）</span>
<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">text</span>, <span class="hljs-function">(<span class="hljs-params">newText</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (newText &amp;&amp; props.<span class="hljs-property">autoStart</span>) {
    <span class="hljs-title function_">startTyping</span>();
  }
}, { <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> });

<span class="hljs-comment">// 初始化光标闪烁（非闪烁模式下固定显示）</span>
<span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">showCursor</span> &amp;&amp; !cursorTimer) {
    cursorTimer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (!showBlinkCursor.<span class="hljs-property">value</span>) {
        isCursorVisible.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        isCursorVisible.<span class="hljs-property">value</span> = !isCursorVisible.<span class="hljs-property">value</span>;
      }
    }, <span class="hljs-number">500</span>);
  }
});

<span class="hljs-comment">// 组件挂载：自动开始打字</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">autoStart</span> &amp;&amp; props.<span class="hljs-property">text</span>) {
    <span class="hljs-title function_">startTyping</span>();
  }
});

<span class="hljs-comment">// 组件卸载：清理所有定时器（避免内存泄漏）</span>
<span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">clearAllTimers</span>();
});

<span class="hljs-comment">// 暴露组件方法（供父组件调用）</span>
<span class="hljs-title function_">defineExpose</span>({
  <span class="hljs-attr">start</span>: startTyping,        <span class="hljs-comment">// 手动开始</span>
  <span class="hljs-attr">pause</span>: clearAllTimers,     <span class="hljs-comment">// 暂停</span>
  <span class="hljs-attr">restart</span>: <span class="hljs-function">() =&gt;</span> {           <span class="hljs-comment">// 重启</span>
    <span class="hljs-title function_">clearAllTimers</span>();
    <span class="hljs-title function_">startTyping</span>();
  },
  isPlaying,                 <span class="hljs-comment">// 当前播放状态</span>
  isDeleting                 <span class="hljs-comment">// 当前删除状态</span>
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 容器样式 - 适配行内/块级显示 */</span>
<span class="hljs-selector-class">.typewriter-container</span> {
  <span class="hljs-attribute">display</span>: inline-flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">font-size</span>: inherit;
  <span class="hljs-attribute">line-height</span>: inherit;
  <span class="hljs-attribute">font-family</span>: inherit;
  <span class="hljs-attribute">white-space</span>: pre-wrap; <span class="hljs-comment">/* 支持换行符 */</span>
  <span class="hljs-attribute">word-break</span>: break-all; <span class="hljs-comment">/* 防止长文本溢出 */</span>
}

<span class="hljs-comment">/* 文本容器 */</span>
<span class="hljs-selector-class">.typewriter-text</span> {
  <span class="hljs-attribute">display</span>: inline;
  <span class="hljs-attribute">font-size</span>: inherit;
  <span class="hljs-attribute">line-height</span>: inherit;
  <span class="hljs-attribute">font-family</span>: inherit;
  <span class="hljs-attribute">color</span>: inherit;
}

<span class="hljs-comment">/* 字符样式 - 入场动画 */</span>
<span class="hljs-selector-class">.character</span> {
  <span class="hljs-attribute">display</span>: inline-block;
  <span class="hljs-attribute">animation</span>: typeIn <span class="hljs-number">0.1s</span> ease-out forwards;
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
}

<span class="hljs-comment">/* 字符入场动画 */</span>
<span class="hljs-keyword">@keyframes</span> typeIn {
  <span class="hljs-number">0%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">5px</span>);
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  }
  <span class="hljs-number">100%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">0</span>);
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
  }
}

<span class="hljs-comment">/* 光标样式 - 垂直居中优化 */</span>
<span class="hljs-selector-class">.cursor</span> {
  <span class="hljs-attribute">display</span>: inline-block;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">1.2em</span>; <span class="hljs-comment">/* 匹配字体高度 */</span>
  <span class="hljs-attribute">background-color</span>: currentColor;
  <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">2px</span>;
  <span class="hljs-attribute">vertical-align</span>: middle;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
}

<span class="hljs-comment">/* 光标闪烁动画 */</span>
<span class="hljs-selector-class">.cursor</span><span class="hljs-selector-class">.blink</span> {
  <span class="hljs-attribute">animation</span>: blink <span class="hljs-number">1s</span> infinite step-end;
}

<span class="hljs-keyword">@keyframes</span> blink {
  <span class="hljs-number">0%</span>, <span class="hljs-number">100%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
  <span class="hljs-number">50%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
}

<span class="hljs-comment">/* 禁用字符动画的样式 */</span>
:<span class="hljs-built_in">deep</span>(.character) {
  <span class="hljs-attribute">animation</span>: none <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span> <span class="hljs-meta">!important</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-2">🚀 核心优化点说明</h2>
<h3 data-id="heading-3">1. 功能增强</h3>
<ul>
<li>新增 <code>charAnimation</code> 属性：可开关字符入场动画，适配不同场景</li>
<li>支持动态文本：监听 <code>text</code> 属性变化，文本更新自动重启打字</li>
<li>优化光标逻辑：非闪烁模式下光标固定显示，避免闪烁干扰</li>
<li>新增 <code>restart</code> 方法：支持手动重启打字效果</li>
<li>文本换行支持：添加 <code>white-space: pre-wrap</code>，兼容带换行符的文本</li>
</ul>
<h3 data-id="heading-4">2. 性能优化</h3>
<ul>
<li>定时器统一管理：所有定时器集中清理，避免内存泄漏</li>
<li>减少不必要渲染：通过 <code>watchEffect</code> 精准控制光标定时器创建/销毁</li>
<li>样式优化：使用 <code>currentColor</code> 继承文本颜色，光标颜色与文本一致</li>
<li>边界处理：添加 <code>word-break: break-all</code>，防止长文本溢出</li>
</ul>
<h3 data-id="heading-5">3. 代码健壮性</h3>
<ul>
<li>完善 Prop 校验：所有数值类型添加范围校验，避免非法值</li>
<li>状态重置：每次开始打字前重置所有状态，避免多轮执行冲突</li>
<li>注释完善：关键逻辑添加注释，提升代码可读性</li>
</ul>
<h2 data-id="heading-6">📖 使用示例</h2>
<h3 data-id="heading-7">基础使用</h3>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Typewriter</span> 
    <span class="hljs-attr">text</span>=<span class="hljs-string">"Hello Vue3! 这是一个超丝滑的打字机效果组件✨"</span>
    <span class="hljs-attr">speed</span>=<span class="hljs-string">"50"</span>
  /&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Typewriter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/Typewriter.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-8">高级使用（循环+删除效果）</h3>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Typewriter</span> 
      <span class="hljs-attr">ref</span>=<span class="hljs-string">"typewriterRef"</span>
      <span class="hljs-attr">text</span>=<span class="hljs-string">"Vue3 打字机组件 | 支持循环删除 | 自定义样式"</span>
      <span class="hljs-attr">:speed</span>=<span class="hljs-string">"60"</span>
      <span class="hljs-attr">:deleteSpeed</span>=<span class="hljs-string">"40"</span>
      <span class="hljs-attr">:loop</span>=<span class="hljs-string">"true"</span>
      <span class="hljs-attr">:deleteEffect</span>=<span class="hljs-string">"true"</span>
      <span class="hljs-attr">:loopDelay</span>=<span class="hljs-string">"1500"</span>
      <span class="hljs-attr">:fontsConStyle</span>=<span class="hljs-string">"{
        fontSize: '1.5rem',
        color: '#409eff',
        fontFamily: '微软雅黑'
      }"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleRestart"</span>&gt;</span>重启打字<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Typewriter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/Typewriter.vue'</span>;

<span class="hljs-keyword">const</span> typewriterRef = <span class="hljs-title function_">ref</span>();

<span class="hljs-comment">// 手动重启打字</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRestart</span> = (<span class="hljs-params"/>) =&gt; {
  typewriterRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">restart</span>();
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-9">🎨 样式自定义说明</h2>






























<table><thead><tr><th>属性</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td>fontSize</td><td>字体大小</td><td>2rem</td></tr><tr><td>fontFamily</td><td>字体</td><td>'Courier New', monospace</td></tr><tr><td>color</td><td>文本颜色</td><td>#333</td></tr><tr><td>lineHeight</td><td>行高</td><td>1.5</td></tr></tbody></table>
<p>你可以通过 <code>fontsConStyle</code> 属性完全自定义组件样式，例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">fontsConStyle</span>: {
  <span class="hljs-attr">fontSize</span>: <span class="hljs-string">"18px"</span>,
  <span class="hljs-attr">color</span>: <span class="hljs-string">"#e6a23c"</span>,
  <span class="hljs-attr">fontWeight</span>: <span class="hljs-string">"bold"</span>,
  <span class="hljs-attr">background</span>: <span class="hljs-string">"#f5f7fa"</span>,
  <span class="hljs-attr">padding</span>: <span class="hljs-string">"10px 15px"</span>,
  <span class="hljs-attr">borderRadius</span>: <span class="hljs-string">"8px"</span>
}
</code></pre>
<h2 data-id="heading-10">🛠️ 扩展方向</h2>
<ol>
<li><strong>自定义字符动画</strong>：通过 Prop 传入动画类名，支持不同的字符入场效果</li>
<li><strong>分段打字</strong>：支持数组形式的文本，分段打字+间隔</li>
<li><strong>速度渐变</strong>：实现打字速度由快到慢/由慢到快的效果</li>
<li><strong>暂停/继续</strong>：扩展暂停后继续打字的功能（记录当前索引）</li>
<li><strong>结合 AI 流式响应</strong>：对接 AI 接口的流式返回，实时更新打字文本</li>
</ol>
<h2 data-id="heading-11">📌 总结</h2>
<p>这个打字机组件基于 Vue3 Composition API 开发，具备<strong>高复用性、高定制性</strong>的特点，核心优化点如下：</p>
<ol>
<li>完善的定时器管理，避免内存泄漏</li>
<li>精准的状态控制，支持打字/删除/循环全流程</li>
<li>灵活的样式自定义，适配不同业务场景</li>
<li>暴露控制方法，支持父组件手动干预</li>
</ol>
<p>组件可直接集成到 Vue3 项目中，适用于 AI 聊天、个人主页、产品介绍等需要打字机效果的场景，开箱即用！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue2 的响应式原理]]></title>    <link>https://juejin.cn/post/7598459769238749218</link>    <guid>https://juejin.cn/post/7598459769238749218</guid>    <pubDate>2026-01-24T07:38:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598459769238749218" data-draft-id="7598465042968117288" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue2 的响应式原理"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-24T07:38:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户10063310408"/> <meta itemprop="url" content="https://juejin.cn/user/2103809314920539"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue2 的响应式原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2103809314920539/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户10063310408
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T07:38:28.000Z" title="Sat Jan 24 2026 07:38:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue2 的响应式原理</h2>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4ed082d9906441ba83afeb720cb4552~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTAwNjMzMTA0MDg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769845458&amp;x-signature=hmrnTglCoUxxl2vkDQrLyVzPR%2Bg%3D" alt="1.png" width="100%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4cf6543721648579871f5d6f8935ba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTAwNjMzMTA0MDg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769845458&amp;x-signature=GdWyigDgLiINj6aM5wIYO5QFgdE%3D" alt="Vue2 生命周期.png" width="100%" loading="lazy"/>
<h2 data-id="heading-1">Object.defineProperty</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, prop, descriptor)
  obj：必需。要定义或修改的属性的对象。
  prop：必需。要定义或修改的属性的属性名。
  descriptor：必需。要定义或修改的属性的描述符。
</code></pre>
<p><strong>存取器 getter/setter</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> obj = {}
<span class="hljs-keyword">var</span> value = <span class="hljs-string">'hello'</span>

<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">'key'</span>, {
  <span class="hljs-comment">// 当获取 obj['key'] 值的时候触发该函数。</span>
  <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> value
  },
  <span class="hljs-comment">// 当设置 obj['key'] 值的时候触发该函数。</span>
  <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">newValue</span>) {
    value = newValue
  }
})
</code></pre>
<p>​		注意：不要在 getter 中获取该属性的值，也不要在 setter 中设置该属性的值，否则会发生栈溢出。</p>
<h2 data-id="heading-2">实现数据代理和劫持</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span> = options
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initData</span>()
  }

  <span class="hljs-title function_">initData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// TODO：this.$options.data 还可能是一个函数。</span>
    <span class="hljs-keyword">const</span> data = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_data</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">data</span>)
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 数据代理逻辑。</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxyGetter</span>(<span class="hljs-params"/>) {
          <span class="hljs-keyword">return</span> data[keys[i]]
        },
        <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxySetter</span>(<span class="hljs-params">newValue</span>) {
          data[keys[i]] = newValue
        }
      })
      <span class="hljs-comment">// 数据劫持逻辑。</span>
      <span class="hljs-keyword">let</span> value = data[keys[i]]
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(data, keys[i], {
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveGetter</span>(<span class="hljs-params"/>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`获取了 data 的 <span class="hljs-subst">${keys[i]}</span> 值。`</span>)
          <span class="hljs-keyword">return</span> value
        },
        <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveSetter</span>(<span class="hljs-params">newValue</span>) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`设置了 data 的 <span class="hljs-subst">${keys[i]}</span> 值。`</span>)
          value = newValue
        }
      })
    }
  }
}
</code></pre>
<h2 data-id="heading-3">实现数据代理和递归劫持</h2>
<p>​		首先将数据递归劫持逻辑抽离到 observe 工厂函数中；然后新定义一个 Observer 类，为后续的工作做铺垫。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span> = options
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initData</span>()
  }

  <span class="hljs-title function_">initData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// TODO：this.$options.data 还可能是一个函数。</span>
    <span class="hljs-keyword">const</span> data = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_data</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">data</span>)
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 数据代理逻辑。</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxyGetter</span>(<span class="hljs-params"/>) {
          <span class="hljs-keyword">return</span> data[keys[i]]
        },
        <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxySetter</span>(<span class="hljs-params">newValue</span>) {
          data[keys[i]] = newValue
        }
      })
    }

    <span class="hljs-title function_">observe</span>(data)
  }
}

<span class="hljs-comment">// 观察 data 数据。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
  <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>(data)
}

<span class="hljs-comment">// TODO：数组的观察逻辑暂时还没实现。</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">walk</span>(data)
  }

  <span class="hljs-title function_">walk</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">defineReactive</span>(data, keys[i], data[keys[i]])
    }
  }
}

<span class="hljs-comment">// 定义 obj 对象的 key 属性的响应式。</span>
<span class="hljs-comment">// 这里利用了闭包，使得 value 变量一直没有被垃圾回收。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, value</span>) {
  <span class="hljs-comment">// 深度优先遍历。</span>
  <span class="hljs-title function_">observe</span>(value)

  <span class="hljs-comment">// 数据劫持逻辑。</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveGetter</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`获取了 <span class="hljs-subst">${key}</span> 值。`</span>)
      <span class="hljs-keyword">return</span> value
    },
    <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveSetter</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`设置了 <span class="hljs-subst">${key}</span> 值。`</span>)
      <span class="hljs-title function_">observe</span>(newValue)
      value = newValue
    }
  })
}
</code></pre>
<h2 data-id="heading-4">实现 watch 监听</h2>
<p>​		下面是 Vue 中的 watch 选项与 $watch 方法的实现原理。（暂时只实现了对 vm.$options.data 对象的第一层属性的监听。）</p>
<p>​		每个响应式属性都有一个属于自己的“筐”。在该响应式属性被其他回调函数依赖的时候，Vue 会通过这个“筐”的 depend 方法把这些回调函数添加到这个“筐”的 subs 属性中。在该响应式属性的值发生变化的时候，Vue 会通过这个“筐”的 notify 方法把这个“筐”的 subs 属性中的这些回调函数取出来全部执行。</p>
<p>​		在 Vue 中，“筐”被抽象成了 Dep 实例，回调函数被包装成了 Watcher 实例。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span> = options
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initData</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initWatch</span>()
  }

  <span class="hljs-title function_">initData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// TODO：this.$options.data 还可能是一个函数。</span>
    <span class="hljs-keyword">const</span> data = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_data</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">data</span>)
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 数据代理逻辑。</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxyGetter</span>(<span class="hljs-params"/>) {
          <span class="hljs-keyword">return</span> data[keys[i]]
        },
        <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxySetter</span>(<span class="hljs-params">newValue</span>) {
          data[keys[i]] = newValue
        }
      })
    }

    <span class="hljs-title function_">observe</span>(data)
  }

  <span class="hljs-title function_">initWatch</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> watch = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">watch</span>
    <span class="hljs-keyword">if</span> (watch) {
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(watch)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-variable language_">this</span>.$watch(keys[i], watch[keys[i]])
      }
    }
  }

  $watch(exp, cb) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>, exp, cb)
  }
}

<span class="hljs-comment">// 观察 data 数据。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
  <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>(data)
}

<span class="hljs-comment">// TODO：数组的观察逻辑暂时还没实现。</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">walk</span>(data)
  }

  <span class="hljs-title function_">walk</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">defineReactive</span>(data, keys[i], data[keys[i]])
    }
  }
}

<span class="hljs-comment">// 定义 obj 对象的 key 属性的响应式。</span>
<span class="hljs-comment">// 这里利用了闭包，使得 value 变量 和 dep 常量一直没有被垃圾回收。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, value</span>) {
  <span class="hljs-keyword">const</span> dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()

  <span class="hljs-comment">// 深度优先遍历。</span>
  <span class="hljs-title function_">observe</span>(value)

  <span class="hljs-comment">// 数据劫持逻辑。</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveGetter</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 订阅逻辑。</span>
      dep.<span class="hljs-title function_">depend</span>()
      <span class="hljs-keyword">return</span> value
    },
    <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveSetter</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-keyword">if</span> (value === newValue) {
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-comment">// 发布逻辑。</span>
      dep.<span class="hljs-title function_">notify</span>()
      <span class="hljs-title function_">observe</span>(newValue)
      value = newValue
    }
  })
}

<span class="hljs-comment">// “筐”被抽象成了 Dep 实例。</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dep</span> {
  <span class="hljs-comment">// 响应式属性当前要订阅的 watcher。</span>
  <span class="hljs-keyword">static</span> target = <span class="hljs-literal">null</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 响应式属性已订阅的 watcher 列表。</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span> = []
  }

  <span class="hljs-title function_">depend</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>)
    }
  }

  <span class="hljs-title function_">notify</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">watcher</span> =&gt;</span> {
      watcher.<span class="hljs-title function_">run</span>()
    })
  }
}

<span class="hljs-comment">// 回调函数被包装成了 Watcher 实例。</span>
<span class="hljs-comment">// TODO：暂时只实现了对 vm.$options.data 对象的第一层属性的监听。</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Watcher</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">vm, exp, cb</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span> = exp
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span> = cb
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
  }

  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-variable language_">this</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span>]
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>
  }

  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>)
  }
}
</code></pre>
<p>​		在 Vue 中：1、被包装成 Watcher 实例的回调函数是被异步调用的；2、在该回调函数被异步调用之后和实际执行之前的这个过程中，如果触发该回调函数的响应式属性的值又被修改了，那么这些后续的修改操作将无法再次触发该回调函数的调用。所以 Watcher 类的实现原理，实际如下代码所示：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 回调函数被包装成了 Watcher 实例。</span>
<span class="hljs-comment">// TODO：暂时只实现了对 vm.$options.data 对象的第一层属性的监听。</span>
<span class="hljs-keyword">const</span> watcherQueue = []
<span class="hljs-keyword">let</span> watcherId = <span class="hljs-number">0</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Watcher</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">vm, exp, cb</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = ++watcherId
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span> = exp
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span> = cb
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
  }

  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-variable language_">this</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span>]
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>
  }

  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (watcherQueue.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-comment">// 类似于 JavaScript 中的防抖逻辑。</span>
      <span class="hljs-keyword">return</span>
    }
    watcherQueue.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>)
    <span class="hljs-keyword">const</span> index = watcherQueue.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>)
      watcherQueue.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
    })
  }
}
</code></pre>
<h2 data-id="heading-5">仍然存在的问题</h2>
<p>​		至此，基本实现了 Vue 中基于发布订阅的 watch 监听逻辑。但目前仍然存在以下问题：1、<strong>对象的新增属性</strong>没有被添加数据劫持逻辑；2、<strong>数组元素</strong>的数据劫持逻辑还存在问题。因此在对对象的新增属性和数组元素添加监听逻辑时也会存在问题。</p>
<h2 data-id="heading-6">实现 $set 方法</h2>
<p>​		在 Vue 中，如果响应式属性的值是一个对象（包括数组），那么在该响应式属性上就会被挂载一个 _ ob _ 属性，该 _ ob _ 属性的值是一个 Observer 实例，该 Observer 实例的 dep 属性的值是一个 Dep 实例，该 Dep 实例是和 defineReactive 方法的闭包中的 Dep 实例不同的与该响应式属性绑定的另外一个“筐”。</p>
<p>​		当响应式属性的值是一个对象（包括数组）时，Vue 会把触发该响应式属性的 getter 的 watchers 额外收集一份在该响应式属性的 _ ob _ 属性的 dep 属性的 subs 属性中。这样开发者就可以通过代码<strong>命令式</strong>地去触发这个响应式属性的 watchers 了。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8574cad12415492f9c8c28397d6197ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTAwNjMzMTA0MDg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769845458&amp;x-signature=1nJlxfUZ7RgKeXJnED%2FuQjKbOZ8%3D" alt="2.png" width="100%" loading="lazy"/>
<p><strong>$set 方法的实现思路基本如下：</strong></p>
<p>​		1、在创建 Observer 对象的实例去观察响应式属性时，同时也创建一个 Dep 对象的实例。先将该 Dep 对象的实例挂载到该 Observer 对象的实例上，然后把该 Observer 对象的实例挂载到它自己观察的响应式属性上。</p>
<p>​		2、当响应式属性的 getter 被触发时，把与该响应式属性绑定的“筐”的 depend 方法调用一遍。响应式属性的值为对象或数组时，有两个筐；响应式属性的值不为对象和数组时，有一个筐。</p>
<p>​		3、当用户调用 $set 方法时，如果 target 为对象，则 Vue 先调用 defineReactive 方法把设置的属性也定义为响应式，然后调用 target._ ob _.dep.notify 方法触发 target 的 watchers。（target 为数组的情况暂时未实现。）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span> = options
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initData</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initWatch</span>()
  }

  <span class="hljs-title function_">initData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// TODO：this.$options.data 还可能是一个函数。</span>
    <span class="hljs-keyword">const</span> data = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_data</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">data</span>)
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 数据代理逻辑。</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxyGetter</span>(<span class="hljs-params"/>) {
          <span class="hljs-keyword">return</span> data[keys[i]]
        },
        <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxySetter</span>(<span class="hljs-params">newValue</span>) {
          data[keys[i]] = newValue
        }
      })
    }

    <span class="hljs-title function_">observe</span>(data)
  }

  <span class="hljs-title function_">initWatch</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> watch = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">watch</span>
    <span class="hljs-keyword">if</span> (watch) {
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(watch)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-variable language_">this</span>.$watch(keys[i], watch[keys[i]])
      }
    }
  }

  $watch(exp, cb) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>, exp, cb)
  }

  <span class="hljs-comment">// TODO：暂时只实现了 target 为对象的情况，target 为数组的情况还未实现。</span>
  $set(target, key, value) {
    <span class="hljs-title function_">defineReactive</span>(target, key, value)
    <span class="hljs-comment">// 触发依赖 target 的 watchers。</span>
    target.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
  }
}

<span class="hljs-comment">// 观察 data 数据。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
  <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>(data)
}

<span class="hljs-comment">// TODO：数组的观察逻辑暂时还没实现。</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dep</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(data, <span class="hljs-string">'__ob__'</span>, {
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>
    })
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">walk</span>(data)
  }

  <span class="hljs-title function_">walk</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">defineReactive</span>(data, keys[i], data[keys[i]])
    }
  }
}

<span class="hljs-comment">// 定义 obj 对象的 key 属性的响应式。</span>
<span class="hljs-comment">// 这里利用了闭包，使得 value 变量 和 dep 常量一直没有被垃圾回收。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, value</span>) {
  <span class="hljs-keyword">const</span> dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()

  <span class="hljs-comment">// 深度优先遍历。</span>
  <span class="hljs-keyword">const</span> objKeyOb = <span class="hljs-title function_">observe</span>(value)

  <span class="hljs-keyword">if</span> (objKeyOb &amp;&amp; obj[key] &amp;&amp; obj[key].<span class="hljs-property">__ob__</span>) {
    objKeyOb.<span class="hljs-property">dep</span> = obj[key].<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>
  }

  <span class="hljs-comment">// 数据劫持逻辑。</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveGetter</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 订阅逻辑。</span>
      dep.<span class="hljs-title function_">depend</span>()
      <span class="hljs-keyword">if</span> (objKeyOb) {
        objKeyOb.<span class="hljs-property">dep</span>.<span class="hljs-title function_">depend</span>()
      }
      <span class="hljs-keyword">return</span> value
    },
    <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveSetter</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-keyword">if</span> (value === newValue) {
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-comment">// 发布逻辑。</span>
      dep.<span class="hljs-title function_">notify</span>()
      <span class="hljs-keyword">const</span> objKeyOb = <span class="hljs-title function_">observe</span>(newValue)
      <span class="hljs-keyword">if</span> (objKeyOb &amp;&amp; obj[key] &amp;&amp; obj[key].<span class="hljs-property">__ob__</span>) {
        objKeyOb.<span class="hljs-property">dep</span> = obj[key].<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>
      }
      value = newValue
    }
  })
}

<span class="hljs-comment">// “筐”被抽象成了 Dep 实例。</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dep</span> {
  <span class="hljs-comment">// 响应式属性当前要订阅的 watcher。</span>
  <span class="hljs-keyword">static</span> target = <span class="hljs-literal">null</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 响应式属性已订阅的 watcher 列表。</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span> = []
  }

  <span class="hljs-title function_">depend</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>)
    }
  }

  <span class="hljs-title function_">notify</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">watcher</span> =&gt;</span> {
      watcher.<span class="hljs-title function_">run</span>()
    })
  }
}

<span class="hljs-comment">// 回调函数被包装成了 Watcher 实例。</span>
<span class="hljs-comment">// TODO：暂时只实现了对 vm.$options.data 对象的第一层属性的监听。</span>
<span class="hljs-keyword">const</span> watcherQueue = []
<span class="hljs-keyword">let</span> watcherId = <span class="hljs-number">0</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Watcher</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">vm, exp, cb</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = ++watcherId
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span> = exp
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span> = cb
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
  }

  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-variable language_">this</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span>]
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>
  }

  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (watcherQueue.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-comment">// 类似于 JavaScript 中的防抖逻辑。</span>
      <span class="hljs-keyword">return</span>
    }
    watcherQueue.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>)
    <span class="hljs-keyword">const</span> index = watcherQueue.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>)
      watcherQueue.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
    })
  }
}
</code></pre>
<h2 data-id="heading-7">实现数组方法的重写</h2>
<p><strong>Vue 对数组的处理思路基本如下：</strong></p>
<p>​		1、对数组本身不使用 Object.defineProperty 方法进行数据劫持，对数组元素依次使用 observe 方法进行数据观察。因此，<strong>数组元素不具有响应性，数组元素的属性仍然具有响应性</strong>。</p>
<p>​		2、对数组的 push、pop、shift、unshift、splice、sort、reverse 实例方法进行重写。在这些重写的实例方法中，Vue 先调用数组的原始同名实例方法，然后再调用 this._ ob _.dep.notify 方法去触发该数组的 watchers。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span> = options
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initData</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initWatch</span>()
  }

  <span class="hljs-title function_">initData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// TODO：this.$options.data 还可能是一个函数。</span>
    <span class="hljs-keyword">const</span> data = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_data</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">data</span>)
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 数据代理逻辑。</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxyGetter</span>(<span class="hljs-params"/>) {
          <span class="hljs-keyword">return</span> data[keys[i]]
        },
        <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxySetter</span>(<span class="hljs-params">newValue</span>) {
          data[keys[i]] = newValue
        }
      })
    }

    <span class="hljs-title function_">observe</span>(data)
  }

  <span class="hljs-title function_">initWatch</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> watch = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">watch</span>
    <span class="hljs-keyword">if</span> (watch) {
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(watch)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-variable language_">this</span>.$watch(keys[i], watch[keys[i]])
      }
    }
  }

  $watch(exp, cb) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>, exp, cb)
  }

  $set(target, key, value) {
    <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(target)
    <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Array]'</span>) {
      <span class="hljs-keyword">const</span> arratProto = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
      <span class="hljs-title function_">observe</span>(value)
      arratProto.<span class="hljs-property">splice</span>.<span class="hljs-title function_">call</span>(target, key, <span class="hljs-number">1</span>, value)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Object]'</span>) {
      <span class="hljs-title function_">defineReactive</span>(target, key, value)
    }
    <span class="hljs-comment">// 触发依赖 target 的 watchers。</span>
    target.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
  }
}

<span class="hljs-comment">// 观察 data 数据。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
  <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>(data)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dep</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(data, <span class="hljs-string">'__ob__'</span>, {
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>
    })
    <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Array]'</span>) {
      data.<span class="hljs-property">__proto__</span> = arrayMethods
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">observeArray</span>(data)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Object]'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">walk</span>(data)
    }
  }

  <span class="hljs-title function_">walk</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">defineReactive</span>(data, keys[i], data[keys[i]])
    }
  }

  <span class="hljs-title function_">observeArray</span>(<span class="hljs-params">array</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; array.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">observe</span>(array[i])
    }
  }
}

<span class="hljs-comment">// 定义 obj 对象的 key 属性的响应式。</span>
<span class="hljs-comment">// 这里利用了闭包，使得 value 变量 和 dep 常量一直没有被垃圾回收。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, value</span>) {
  <span class="hljs-keyword">const</span> dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()

  <span class="hljs-comment">// 深度优先遍历。</span>
  <span class="hljs-keyword">const</span> objKeyOb = <span class="hljs-title function_">observe</span>(value)

  <span class="hljs-keyword">if</span> (objKeyOb &amp;&amp; obj[key] &amp;&amp; obj[key].<span class="hljs-property">__ob__</span>) {
    objKeyOb.<span class="hljs-property">dep</span> = obj[key].<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>
  }

  <span class="hljs-comment">// 数据劫持逻辑。</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveGetter</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 订阅逻辑。</span>
      dep.<span class="hljs-title function_">depend</span>()
      <span class="hljs-keyword">if</span> (objKeyOb) {
        objKeyOb.<span class="hljs-property">dep</span>.<span class="hljs-title function_">depend</span>()
      }
      <span class="hljs-keyword">return</span> value
    },
    <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveSetter</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-keyword">if</span> (value === newValue) {
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-comment">// 发布逻辑。</span>
      dep.<span class="hljs-title function_">notify</span>()
      <span class="hljs-keyword">const</span> objKeyOb = <span class="hljs-title function_">observe</span>(newValue)
      <span class="hljs-keyword">if</span> (objKeyOb &amp;&amp; obj[key] &amp;&amp; obj[key].<span class="hljs-property">__ob__</span>) {
        objKeyOb.<span class="hljs-property">dep</span> = obj[key].<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>
      }
      value = newValue
    }
  })
}

<span class="hljs-comment">// “筐”被抽象成了 Dep 实例。</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dep</span> {
  <span class="hljs-comment">// 响应式属性当前要订阅的 watcher。</span>
  <span class="hljs-keyword">static</span> target = <span class="hljs-literal">null</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 响应式属性已订阅的 watcher 列表。</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span> = []
  }

  <span class="hljs-title function_">depend</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>)
    }
  }

  <span class="hljs-title function_">notify</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">watcher</span> =&gt;</span> {
      watcher.<span class="hljs-title function_">run</span>()
    })
  }
}

<span class="hljs-comment">// 回调函数被包装成了 Watcher 实例。</span>
<span class="hljs-comment">// TODO：暂时只实现了对 vm.$options.data 对象的第一层属性的监听。</span>
<span class="hljs-keyword">const</span> watcherQueue = []
<span class="hljs-keyword">let</span> watcherId = <span class="hljs-number">0</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Watcher</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">vm, exp, cb</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = ++watcherId
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span> = exp
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span> = cb
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
  }

  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-variable language_">this</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span>]
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>
  }

  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (watcherQueue.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-comment">// 类似于 JavaScript 中的防抖逻辑。</span>
      <span class="hljs-keyword">return</span>
    }
    watcherQueue.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>)
    <span class="hljs-keyword">const</span> index = watcherQueue.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>)
      watcherQueue.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
    })
  }
}

<span class="hljs-keyword">const</span> mutationMethods = [<span class="hljs-string">'push'</span>, <span class="hljs-string">'pop'</span>, <span class="hljs-string">'shift'</span>, <span class="hljs-string">'unshift'</span>, <span class="hljs-string">'splice'</span>, <span class="hljs-string">'sort'</span>, <span class="hljs-string">'reverse'</span>]
<span class="hljs-keyword">const</span> arrayProto = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
<span class="hljs-keyword">const</span> arrayMethods = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(arrayProto)
mutationMethods.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">method</span> =&gt;</span> {
  arrayMethods[method] = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'push'</span> || method === <span class="hljs-string">'unshift'</span> || method === <span class="hljs-string">'splice'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>.<span class="hljs-title function_">observeArray</span>(args)
    }
    <span class="hljs-keyword">const</span> result = arrayProto[method].<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
    <span class="hljs-keyword">return</span> result
  }
})
</code></pre>
<h2 data-id="heading-8">实现 computed 计算属性</h2>
<p><strong>Vue 中 computed 计算属性的特性：</strong></p>
<p>​		1、计算属性不存在于 data 选项中，因此计算属性需要单独进行初始化。</p>
<p>​		2、计算属性的值是一个函数运行之后的返回值。</p>
<p>​		3、计算属性的值“只能取，不能存”，即计算属性的 setter 无效。</p>
<p>​		4、计算属性所依赖的响应式属性的值，一旦发生变化，便会引起该计算属性的值，一同发生变化。</p>
<p>​		5、计算属性是<strong>惰性</strong>的：计算属性所依赖的响应式属性的值发生变化时，不会立即引起该计算属性的值一同发生变化，而是等到该计算属性的值被获取时才会使得 Vue 对它的值进行重新计算。</p>
<p>​		6、计算属性是<strong>缓存</strong>的：如果计算属性所依赖的响应式属性的值没有发生变化，即使多次获取该计算属性的值，Vue 也不会对该计算属性的值进行重新计算。</p>
<p><strong>注：对于计算属性 A 依赖计算属性 B 的情况，下面的代码好像已经实现了，但还需进一步的测试验证。</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span> = options
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initData</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initComputed</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initWatch</span>()
  }

  <span class="hljs-title function_">initData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// TODO：this.$options.data 还可能是一个函数。</span>
    <span class="hljs-keyword">const</span> data = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_data</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">data</span>)
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 数据代理逻辑。</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxyGetter</span>(<span class="hljs-params"/>) {
          <span class="hljs-keyword">return</span> data[keys[i]]
        },
        <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxySetter</span>(<span class="hljs-params">newValue</span>) {
          data[keys[i]] = newValue
        }
      })
    }

    <span class="hljs-title function_">observe</span>(data)
  }

  <span class="hljs-title function_">initComputed</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> computed = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">computed</span>
    <span class="hljs-keyword">if</span> (computed) {
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(computed)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">const</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>, computed[keys[i]], <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}, { <span class="hljs-attr">lazy</span>: <span class="hljs-literal">true</span> })
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
          <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">computedGetter</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (watcher.<span class="hljs-property">dirty</span>) {
              watcher.<span class="hljs-title function_">get</span>()
              watcher.<span class="hljs-property">dirty</span> = <span class="hljs-literal">false</span>
            }
            watcher.<span class="hljs-property">deps</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
              dep.<span class="hljs-title function_">depend</span>()
            })
            <span class="hljs-keyword">return</span> watcher.<span class="hljs-property">value</span>
          },
          <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">computedSetter</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'请不要给计算属性赋值!'</span>)
          }
        })
      }
    }
  }

  <span class="hljs-title function_">initWatch</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> watch = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">watch</span>
    <span class="hljs-keyword">if</span> (watch) {
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(watch)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-variable language_">this</span>.$watch(keys[i], watch[keys[i]])
      }
    }
  }

  $watch(exp, cb) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>, exp, cb)
  }

  $set(target, key, value) {
    <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(target)
    <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Array]'</span>) {
      <span class="hljs-keyword">const</span> arratProto = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
      <span class="hljs-title function_">observe</span>(value)
      arratProto.<span class="hljs-property">splice</span>.<span class="hljs-title function_">call</span>(target, key, <span class="hljs-number">1</span>, value)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Object]'</span>) {
      <span class="hljs-title function_">defineReactive</span>(target, key, value)
    }
    <span class="hljs-comment">// 触发依赖 target 的 watchers。</span>
    target.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
  }
}

<span class="hljs-comment">// 观察 data 数据。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
  <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>(data)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dep</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(data, <span class="hljs-string">'__ob__'</span>, {
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>
    })
    <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Array]'</span>) {
      data.<span class="hljs-property">__proto__</span> = arrayMethods
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">observeArray</span>(data)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Object]'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">walk</span>(data)
    }
  }

  <span class="hljs-title function_">walk</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">defineReactive</span>(data, keys[i], data[keys[i]])
    }
  }

  <span class="hljs-title function_">observeArray</span>(<span class="hljs-params">array</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; array.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">observe</span>(array[i])
    }
  }
}

<span class="hljs-comment">// 定义 obj 对象的 key 属性的响应式。</span>
<span class="hljs-comment">// 这里利用了闭包，使得 value 变量 和 dep 常量一直没有被垃圾回收。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, value</span>) {
  <span class="hljs-keyword">const</span> dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()

  <span class="hljs-comment">// 深度优先遍历。</span>
  <span class="hljs-keyword">const</span> objKeyOb = <span class="hljs-title function_">observe</span>(value)

  <span class="hljs-keyword">if</span> (objKeyOb &amp;&amp; obj[key] &amp;&amp; obj[key].<span class="hljs-property">__ob__</span>) {
    objKeyOb.<span class="hljs-property">dep</span> = obj[key].<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>
  }

  <span class="hljs-comment">// 数据劫持逻辑。</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveGetter</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 订阅逻辑。</span>
      dep.<span class="hljs-title function_">depend</span>()
      <span class="hljs-keyword">if</span> (objKeyOb) {
        objKeyOb.<span class="hljs-property">dep</span>.<span class="hljs-title function_">depend</span>()
      }
      <span class="hljs-keyword">return</span> value
    },
    <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveSetter</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-keyword">if</span> (value === newValue) {
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-comment">// 发布逻辑。</span>
      dep.<span class="hljs-title function_">notify</span>()
      <span class="hljs-keyword">const</span> objKeyOb = <span class="hljs-title function_">observe</span>(newValue)
      <span class="hljs-keyword">if</span> (objKeyOb &amp;&amp; obj[key] &amp;&amp; obj[key].<span class="hljs-property">__ob__</span>) {
        objKeyOb.<span class="hljs-property">dep</span> = obj[key].<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>
      }
      value = newValue
    }
  })
}

<span class="hljs-comment">// “筐”被抽象成了 Dep 实例。</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dep</span> {
  <span class="hljs-comment">// 响应式属性当前要订阅的 watcher。</span>
  <span class="hljs-keyword">static</span> target = <span class="hljs-literal">null</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 响应式属性已订阅的 watcher 列表。</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span> = []
  }

  <span class="hljs-title function_">depend</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>) {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>.<span class="hljs-title function_">addDep</span>(<span class="hljs-variable language_">this</span>)
    }
  }

  <span class="hljs-title function_">addSub</span>(<span class="hljs-params">watcher</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">indexOf</span>(watcher) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">push</span>(watcher)
  }

  <span class="hljs-title function_">notify</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">watcher</span> =&gt;</span> {
      watcher.<span class="hljs-title function_">update</span>()
    })
  }
}

<span class="hljs-comment">// 回调函数被包装成了 Watcher 实例。</span>
<span class="hljs-comment">// TODO：暂时只实现了对 vm.$options.data 对象的第一层属性的监听。</span>
<span class="hljs-keyword">const</span> watcherQueue = []
<span class="hljs-keyword">let</span> watcherId = <span class="hljs-number">0</span>
<span class="hljs-keyword">const</span> targetStack = []
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Watcher</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">vm, exp, cb, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = ++watcherId
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span> = exp
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span> = cb
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deps</span> = []
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dirty</span> = !!options.<span class="hljs-property">lazy</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
    }
  }

  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-variable language_">this</span>
    targetStack.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>)
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span> === <span class="hljs-string">'function'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span>]
    }
    targetStack.<span class="hljs-title function_">pop</span>()
    <span class="hljs-keyword">if</span> (targetStack.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = targetStack[targetStack.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>
    }
  }

  <span class="hljs-title function_">addDep</span>(<span class="hljs-params">dep</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">deps</span>.<span class="hljs-title function_">indexOf</span>(dep) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deps</span>.<span class="hljs-title function_">push</span>(dep)
    dep.<span class="hljs-title function_">addSub</span>(<span class="hljs-variable language_">this</span>)
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dirty</span> = <span class="hljs-literal">true</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">run</span>()
    }
  }

  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (watcherQueue.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-comment">// 类似于 JavaScript 中的防抖逻辑。</span>
      <span class="hljs-keyword">return</span>
    }
    watcherQueue.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>)
    <span class="hljs-keyword">const</span> index = watcherQueue.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 更新 this.value(watcher.value) 的值。</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>)
      watcherQueue.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
    })
  }
}

<span class="hljs-keyword">const</span> mutationMethods = [<span class="hljs-string">'push'</span>, <span class="hljs-string">'pop'</span>, <span class="hljs-string">'shift'</span>, <span class="hljs-string">'unshift'</span>, <span class="hljs-string">'splice'</span>, <span class="hljs-string">'sort'</span>, <span class="hljs-string">'reverse'</span>]
<span class="hljs-keyword">const</span> arrayProto = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
<span class="hljs-keyword">const</span> arrayMethods = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(arrayProto)
mutationMethods.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">method</span> =&gt;</span> {
  arrayMethods[method] = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'push'</span> || method === <span class="hljs-string">'unshift'</span> || method === <span class="hljs-string">'splice'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>.<span class="hljs-title function_">observeArray</span>(args)
    }
    <span class="hljs-keyword">const</span> result = arrayProto[method].<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
    <span class="hljs-keyword">return</span> result
  }
})
</code></pre>
<h2 data-id="heading-9">Vue 模板响应式更新的原理</h2>
<p>​		Vue 对模板的响应式更新，就是如同代码中的 initRenderWatch 方法这样做的。在 Vue 中，响应式更新模板的 watcher 被称为 render watcher，该 watcher 的求值函数比代码中的 initRenderWatch 方法中的 watcher 的求值函数复杂的多。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span> = options
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initData</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initComputed</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initWatch</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initRenderWatch</span>()
  }

  <span class="hljs-title function_">initData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// TODO：this.$options.data 还可能是一个函数。</span>
    <span class="hljs-keyword">const</span> data = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_data</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">data</span>)
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 数据代理逻辑。</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxyGetter</span>(<span class="hljs-params"/>) {
          <span class="hljs-keyword">return</span> data[keys[i]]
        },
        <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxySetter</span>(<span class="hljs-params">newValue</span>) {
          data[keys[i]] = newValue
        }
      })
    }

    <span class="hljs-title function_">observe</span>(data)
  }

  <span class="hljs-title function_">initComputed</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> computed = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">computed</span>
    <span class="hljs-keyword">if</span> (computed) {
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(computed)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">const</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>, computed[keys[i]], <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}, { <span class="hljs-attr">lazy</span>: <span class="hljs-literal">true</span> })
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
          <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">computedGetter</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (watcher.<span class="hljs-property">dirty</span>) {
              watcher.<span class="hljs-title function_">get</span>()
              watcher.<span class="hljs-property">dirty</span> = <span class="hljs-literal">false</span>
            }
            watcher.<span class="hljs-property">deps</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
              dep.<span class="hljs-title function_">depend</span>()
            })
            <span class="hljs-keyword">return</span> watcher.<span class="hljs-property">value</span>
          },
          <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">computedSetter</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'请不要给计算属性赋值!'</span>)
          }
        })
      }
    }
  }

  <span class="hljs-title function_">initWatch</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> watch = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">watch</span>
    <span class="hljs-keyword">if</span> (watch) {
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(watch)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-variable language_">this</span>.$watch(keys[i], watch[keys[i]])
      }
    }
  }

  <span class="hljs-title function_">initRenderWatch</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(
      <span class="hljs-variable language_">this</span>,
      <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#app'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`&lt;p&gt;<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>&lt;/p&gt;`</span>
      },
      <span class="hljs-function">() =&gt;</span> {}
    )
  }

  $watch(exp, cb) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>, exp, cb)
  }

  $set(target, key, value) {
    <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(target)
    <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Array]'</span>) {
      <span class="hljs-keyword">const</span> arrayProto = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
      <span class="hljs-title function_">observe</span>(value)
      arrayProto.<span class="hljs-property">splice</span>.<span class="hljs-title function_">call</span>(target, key, <span class="hljs-number">1</span>, value)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Object]'</span>) {
      <span class="hljs-title function_">defineReactive</span>(target, key, value)
    }
    <span class="hljs-comment">// 触发依赖 target 的 watchers。</span>
    target.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
  }
}

<span class="hljs-comment">// 观察 data 数据。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
  <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>(data)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dep</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(data, <span class="hljs-string">'__ob__'</span>, {
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>
    })
    <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Array]'</span>) {
      data.<span class="hljs-property">__proto__</span> = arrayMethods
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">observeArray</span>(data)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Object]'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">walk</span>(data)
    }
  }

  <span class="hljs-title function_">walk</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">defineReactive</span>(data, keys[i], data[keys[i]])
    }
  }

  <span class="hljs-title function_">observeArray</span>(<span class="hljs-params">array</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; array.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">observe</span>(array[i])
    }
  }
}

<span class="hljs-comment">// 定义 obj 对象的 key 属性的响应式。</span>
<span class="hljs-comment">// 这里利用了闭包，使得 value 变量 和 dep 常量一直没有被垃圾回收。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, value</span>) {
  <span class="hljs-keyword">const</span> dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()

  <span class="hljs-comment">// 深度优先遍历。</span>
  <span class="hljs-keyword">const</span> objKeyOb = <span class="hljs-title function_">observe</span>(value)

  <span class="hljs-keyword">if</span> (objKeyOb &amp;&amp; obj[key] &amp;&amp; obj[key].<span class="hljs-property">__ob__</span>) {
    objKeyOb.<span class="hljs-property">dep</span> = obj[key].<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>
  }

  <span class="hljs-comment">// 数据劫持逻辑。</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveGetter</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 订阅逻辑。</span>
      dep.<span class="hljs-title function_">depend</span>()
      <span class="hljs-keyword">if</span> (objKeyOb) {
        objKeyOb.<span class="hljs-property">dep</span>.<span class="hljs-title function_">depend</span>()
      }
      <span class="hljs-keyword">return</span> value
    },
    <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveSetter</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-keyword">if</span> (value === newValue) {
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-comment">// 发布逻辑。</span>
      dep.<span class="hljs-title function_">notify</span>()
      <span class="hljs-keyword">const</span> objKeyOb = <span class="hljs-title function_">observe</span>(newValue)
      <span class="hljs-keyword">if</span> (objKeyOb &amp;&amp; obj[key] &amp;&amp; obj[key].<span class="hljs-property">__ob__</span>) {
        objKeyOb.<span class="hljs-property">dep</span> = obj[key].<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>
      }
      value = newValue
    }
  })
}

<span class="hljs-comment">// “筐”被抽象成了 Dep 实例。</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dep</span> {
  <span class="hljs-comment">// 响应式属性当前要订阅的 watcher。</span>
  <span class="hljs-keyword">static</span> target = <span class="hljs-literal">null</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 响应式属性已订阅的 watcher 列表。</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span> = []
  }

  <span class="hljs-title function_">depend</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>) {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>.<span class="hljs-title function_">addDep</span>(<span class="hljs-variable language_">this</span>)
    }
  }

  <span class="hljs-title function_">addSub</span>(<span class="hljs-params">watcher</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">indexOf</span>(watcher) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">push</span>(watcher)
  }

  <span class="hljs-title function_">notify</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">watcher</span> =&gt;</span> {
      watcher.<span class="hljs-title function_">update</span>()
    })
  }
}

<span class="hljs-comment">// 回调函数被包装成了 Watcher 实例。</span>
<span class="hljs-comment">// TODO：暂时只实现了对 vm.$options.data 对象的第一层属性的监听。</span>
<span class="hljs-keyword">const</span> watcherQueue = []
<span class="hljs-keyword">let</span> watcherId = <span class="hljs-number">0</span>
<span class="hljs-keyword">const</span> targetStack = []
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Watcher</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">vm, exp, cb, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = ++watcherId
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span> = exp
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span> = cb
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deps</span> = []
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dirty</span> = !!options.<span class="hljs-property">lazy</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
    }
  }

  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-variable language_">this</span>
    targetStack.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>)
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span> === <span class="hljs-string">'function'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span>]
    }
    targetStack.<span class="hljs-title function_">pop</span>()
    <span class="hljs-keyword">if</span> (targetStack.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = targetStack[targetStack.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>
    }
  }

  <span class="hljs-title function_">addDep</span>(<span class="hljs-params">dep</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">deps</span>.<span class="hljs-title function_">indexOf</span>(dep) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deps</span>.<span class="hljs-title function_">push</span>(dep)
    dep.<span class="hljs-title function_">addSub</span>(<span class="hljs-variable language_">this</span>)
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dirty</span> = <span class="hljs-literal">true</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">run</span>()
    }
  }

  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (watcherQueue.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-comment">// 类似于 JavaScript 中的防抖逻辑。</span>
      <span class="hljs-keyword">return</span>
    }
    watcherQueue.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>)
    <span class="hljs-keyword">const</span> index = watcherQueue.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 更新 this.value(watcher.value) 的值。</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>)
      watcherQueue.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
    })
  }
}

<span class="hljs-keyword">const</span> mutationMethods = [<span class="hljs-string">'push'</span>, <span class="hljs-string">'pop'</span>, <span class="hljs-string">'shift'</span>, <span class="hljs-string">'unshift'</span>, <span class="hljs-string">'splice'</span>, <span class="hljs-string">'sort'</span>, <span class="hljs-string">'reverse'</span>]
<span class="hljs-keyword">const</span> arrayProto = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
<span class="hljs-keyword">const</span> arrayMethods = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(arrayProto)
mutationMethods.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">method</span> =&gt;</span> {
  arrayMethods[method] = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'push'</span> || method === <span class="hljs-string">'unshift'</span> || method === <span class="hljs-string">'splice'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>.<span class="hljs-title function_">observeArray</span>(args)
    }
    <span class="hljs-keyword">const</span> result = arrayProto[method].<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
    <span class="hljs-keyword">return</span> result
  }
})
</code></pre>
<p><strong>Vue 对模板响应式更新的处理思路基本如下：</strong></p>
<p>​		1、**模板编译：**如果传入了 template 或者 DOM，那么在 Vue 实例化的过程中，Vue 首先会把模板字符串转化成渲染函数（vm.$options.render）。</p>
<p>​		2、**虚拟 DOM：**Vue 借助这个渲染函数去响应式更新模板的时候，如果 Vue 直接去操作 DOM，那么会极大的消耗浏览器的性能。于是 Vue 引入 Virtual-DOM (虚拟 DOM），借助它来实现对 DOM 的按需更新。</p>
<h2 data-id="heading-10">实现模板编译</h2>
<p>​		如果传入了 template 或者 DOM，那么在 Vue 实例化的过程中，Vue 首先会把模板字符串转化成渲染函数（vm.$options.render），这个过程就是 Vue 的<strong>模板编译</strong>。</p>
<p>​		Vue 模板编译的整体逻辑主要分为三个步骤：1、<strong>解析器：<strong>将</strong>模板字符串</strong>转换成 <strong>AST</strong>。2、**优化器：**对 <strong>AST</strong> 进行静态节点标记。主要是为了优化渲染性能。（这里不做介绍）3、**代码生成器：**将 <strong>AST</strong> 转换成 <strong>render</strong> 函数。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/669c30a84927493da076d122abfcb96b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTAwNjMzMTA0MDg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769845458&amp;x-signature=xg0tLK%2Fl2Rn13BQiwckuL9Kht1s%3D" alt="5.png" width="100%" loading="lazy"/>
<h3 data-id="heading-11"><strong>AST</strong></h3>
<p>​		AST，即抽象语法树，是源代码语法结构的抽象表示。<a href="https://link.juejin.cn?target=https%3A%2F%2Fastexplorer.net%2F" target="_blank" title="https://astexplorer.net/" ref="nofollow noopener noreferrer">JS AST 在线生成</a></p>
<p>​		Vue 中 AST 的代码示例如下：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">children</span>: [{…}], <span class="hljs-comment">// 叶子节点没有 children 属性。</span>
  <span class="hljs-attr">parent</span>: {}, <span class="hljs-comment">// 根节点的 parent 属性的值为 undefined。</span>
  <span class="hljs-attr">tag</span>: <span class="hljs-string">"div"</span>, <span class="hljs-comment">// 元素节点的专属属性。</span>
  <span class="hljs-attr">type</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// 1：元素节点。2：带变量的文本节点。3：纯文本节点。</span>
  <span class="hljs-attr">expression</span>:<span class="hljs-string">'"姓名：" + _s(name)'</span>, <span class="hljs-comment">// 文本节点的专属属性。如果 type 值是 3，则 expression 值为 ''。</span>
  <span class="hljs-attr">text</span>:<span class="hljs-string">'姓名：{{name}}'</span> <span class="hljs-comment">// 文本节点的专属属性。text 值为文本节点编译前的字符串。</span>
}
</code></pre>
<h3 data-id="heading-12"><strong>解析器（parser）</strong></h3>
<p>​		源代码被解析成 AST 的过程一般包含两个步骤：词法分析和语法分析。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/824e21f1c88f4557b2834a36a61baafe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MTAwNjMzMTA0MDg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769845458&amp;x-signature=IVeFpVM4K6V3h91piHvEpQJaIgE%3D" alt="6.png" width="100%" loading="lazy"/>
<p>​		Vue 中的解析器对模板字符串进行解析时，是每产生一个 token 便会立即对该 token 进行处理，即词法分析和语法分析同时进行，或者说没有词法分析只有语法分析。</p>
<p>​		下面以最单纯的 HTML 模板为例，阐述 Vue 中的解析器将模板字符串转换成 AST 的原理。（v-model、v-bind、v-if、v-for、@click 以及 HTML 中的单标签元素、DOM 属性、HTML 注释等情况都不予以考虑。）</p>
<p>​		**解析思路：**以 &lt; 为标识符，代表开始标签或结束标签。使用栈结构去维护当前模板被解析到的层级。如果是开始标签，代表 AST 的层级 push 了一层；如果是结束标签，代表  AST  的层级 pop 了一层。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">template</span>) {
  <span class="hljs-keyword">let</span> root = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">let</span> currentParent
  <span class="hljs-keyword">const</span> stack = []

  <span class="hljs-comment">// 跳过空白字符串。</span>
  template = template.<span class="hljs-title function_">trim</span>()

  <span class="hljs-keyword">while</span> (template) {
    <span class="hljs-keyword">const</span> ltIndex = template.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'&lt;'</span>)
    <span class="hljs-comment">// ltIndex === -1 的情况不会出现。</span>
    <span class="hljs-comment">// ltIndex &gt; 0 标签前面有文本节点。</span>
    <span class="hljs-comment">// ltIndex === 0 &amp;&amp; template[ltIndex + 1] !== '/' 开始标签。</span>
    <span class="hljs-comment">// ltIndex === 0 &amp;&amp; template[ltIndex + 1] === '/' 结束标签。</span>
    <span class="hljs-keyword">if</span> (ltIndex &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// type：1-元素节点；2-带变量的文本节点；3-纯文本节点。</span>
      <span class="hljs-keyword">const</span> text = template.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, ltIndex)
      <span class="hljs-keyword">const</span> element = <span class="hljs-title function_">parseText</span>(text)
      element.<span class="hljs-property">parent</span> = currentParent
      <span class="hljs-keyword">if</span> (!currentParent.<span class="hljs-property">children</span>) {
        currentParent.<span class="hljs-property">children</span> = []
      }
      currentParent.<span class="hljs-property">children</span>.<span class="hljs-title function_">push</span>(element)
      template = template.<span class="hljs-title function_">slice</span>(ltIndex)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ltIndex === <span class="hljs-number">0</span> &amp;&amp; template[ltIndex + <span class="hljs-number">1</span>] !== <span class="hljs-string">'/'</span>) {
      <span class="hljs-keyword">const</span> gtIndex = template.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'&gt;'</span>)
      <span class="hljs-keyword">const</span> element = {
        <span class="hljs-attr">parent</span>: currentParent, <span class="hljs-comment">// 根节点的 parent 属性值为 undefined。</span>
        <span class="hljs-attr">tag</span>: template.<span class="hljs-title function_">slice</span>(ltIndex + <span class="hljs-number">1</span>, gtIndex), <span class="hljs-comment">// 只考虑开始标签中没有任何属性的情况。</span>
        <span class="hljs-attr">type</span>: <span class="hljs-number">1</span>
      }
      <span class="hljs-keyword">if</span> (currentParent) {
        <span class="hljs-keyword">if</span> (!currentParent.<span class="hljs-property">children</span>) {
          currentParent.<span class="hljs-property">children</span> = []
        }
        currentParent.<span class="hljs-property">children</span>.<span class="hljs-title function_">push</span>(element)
      } <span class="hljs-keyword">else</span> {
        root = element
      }
      currentParent = element
      stack.<span class="hljs-title function_">push</span>(element)
      template = template.<span class="hljs-title function_">slice</span>(gtIndex + <span class="hljs-number">1</span>)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ltIndex === <span class="hljs-number">0</span> &amp;&amp; template[ltIndex + <span class="hljs-number">1</span>] === <span class="hljs-string">'/'</span>) {
      <span class="hljs-keyword">const</span> gtIndex = template.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'&gt;'</span>)
      <span class="hljs-comment">// parse 函数执行完毕后 stack 值被设置为 []。</span>
      stack.<span class="hljs-title function_">pop</span>()
      <span class="hljs-comment">// parse 函数执行完毕后 currentParent 值被设置为 undefined。</span>
      currentParent = stack[stack.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]
      <span class="hljs-comment">// parse 函数执行完毕后 template 值被设置为 ''。</span>
      template = template.<span class="hljs-title function_">slice</span>(gtIndex + <span class="hljs-number">1</span>)
    }
  }

  <span class="hljs-keyword">return</span> root
}

<span class="hljs-comment">// 以 {{ 和 }} 为标识符，把 text 中的 '姓名：{{name}}' 转换成 '"姓名：" + _s(name)'。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parseText</span>(<span class="hljs-params">text</span>) {
  <span class="hljs-keyword">const</span> originText = text
  <span class="hljs-keyword">const</span> tokens = []
  <span class="hljs-comment">// type：2-带变量的文本节点；3-纯文本节点。</span>
  <span class="hljs-keyword">let</span> type = <span class="hljs-number">3</span>

  <span class="hljs-keyword">while</span> (text) {
    <span class="hljs-keyword">const</span> start = text.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'{{'</span>)
    <span class="hljs-keyword">const</span> end = text.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'}}'</span>)
    <span class="hljs-keyword">if</span> (start !== -<span class="hljs-number">1</span>) {
      type = <span class="hljs-number">2</span>
      <span class="hljs-keyword">if</span> (start &gt; <span class="hljs-number">0</span>) {
        tokens.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(text.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, start)))
      }
      <span class="hljs-keyword">const</span> exp = text.<span class="hljs-title function_">slice</span>(start + <span class="hljs-number">2</span>, end)
      tokens.<span class="hljs-title function_">push</span>(<span class="hljs-string">`_s(<span class="hljs-subst">${exp}</span>)`</span>)
      text = text.<span class="hljs-title function_">slice</span>(end + <span class="hljs-number">2</span>)
    } <span class="hljs-keyword">else</span> {
      tokens.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(text))
      text = <span class="hljs-string">''</span>
    }
  }

  <span class="hljs-keyword">const</span> element = {
    <span class="hljs-attr">parent</span>: <span class="hljs-literal">null</span>,
    type,
    <span class="hljs-attr">expression</span>: type === <span class="hljs-number">2</span> ? tokens.<span class="hljs-title function_">join</span>(<span class="hljs-string">' + '</span>) : <span class="hljs-string">''</span>,
    <span class="hljs-attr">text</span>: originText
  }

  <span class="hljs-keyword">return</span> element
}
</code></pre>
<h3 data-id="heading-13">render</h3>
<p>​		本小结生成的 render 函数的函数体字符串是这样的：</p>
<p>​				<strong>'with (this) { return _c("div", {}, [_c("p", {}, [_v("姓名：" + _s(name))])]) }'。</strong></p>
<p>​		其中 _c 函数的第三个参数的空值是 []，不是 undefined。</p>
<h3 data-id="heading-14"><strong>代码生成器（codegenerator）</strong></h3>
<p>​		**生成思路：**1、遍历 AST，对 AST 中的每个节点进行处理。2、遇到元素节点生成 <strong>_c("标签名", 属性对象, 后代数组)</strong> 格式的字符串。（后代数组为空时为 []，而不是 undefined。）3、遇到纯文本节点生成 <strong>_v("文本字符串")</strong> 格式的字符串。4、遇到带变量的文本节点生成 <strong>_v(_s(变量名))</strong> 格式的字符串。5、为了让字符串中的变量能够在 render 函数中被正常取值，在遍历完 AST 后， 将生成的字符串整体外包一层 <strong>with(this)</strong>。6、将经过 with(this) 包装处理后的字符串作为函数体，生成一个 <strong>render 函数</strong>，并将这个 render 函数挂载到 <strong>vm.$options</strong> 上。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 将 AST 转换为 render 函数的函数体的字符串。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">ast</span>) {
  <span class="hljs-keyword">const</span> code = <span class="hljs-title function_">genNode</span>(ast)
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">render</span>: <span class="hljs-string">`with (this) { return <span class="hljs-subst">${code}</span> }`</span>
  }
}

<span class="hljs-comment">// 转换节点。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genNode</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">genElement</span>(node)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">genText</span>(node)
  }
}

<span class="hljs-comment">// 转换元素节点。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genElement</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">const</span> children = <span class="hljs-title function_">genChildren</span>(node)
  <span class="hljs-comment">// children 的空值是 '[]'，不是 'undefined'。</span>
  <span class="hljs-keyword">const</span> code = <span class="hljs-string">`_c(<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(node.tag)}</span>, {}, <span class="hljs-subst">${children}</span>)`</span>
  <span class="hljs-keyword">return</span> code
}

<span class="hljs-comment">// 转换文本节点。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genText</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`_v(<span class="hljs-subst">${node.expression}</span>)`</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-number">3</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`_v(<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(node.text)}</span>)`</span>
  }
}

<span class="hljs-comment">// 转换元素节点的子节点列表中的子节点。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genChildren</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-comment">// node.children 的空值为 undefined。</span>
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">children</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'['</span> + node.<span class="hljs-property">children</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> <span class="hljs-title function_">genNode</span>(child)).<span class="hljs-title function_">join</span>(<span class="hljs-string">', '</span>) + <span class="hljs-string">']'</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'[]'</span>
  }
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span> = options
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initData</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initComputed</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initWatch</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initRenderFunction</span>()
    <span class="hljs-comment">// this.initRenderWatch()</span>
  }

  <span class="hljs-title function_">initData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// TODO：this.$options.data 还可能是一个函数。</span>
    <span class="hljs-keyword">const</span> data = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_data</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">data</span>)
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 数据代理逻辑。</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxyGetter</span>(<span class="hljs-params"/>) {
          <span class="hljs-keyword">return</span> data[keys[i]]
        },
        <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxySetter</span>(<span class="hljs-params">newValue</span>) {
          data[keys[i]] = newValue
        }
      })
    }

    <span class="hljs-title function_">observe</span>(data)
  }

  <span class="hljs-title function_">initComputed</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> computed = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">computed</span>
    <span class="hljs-keyword">if</span> (computed) {
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(computed)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">const</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>, computed[keys[i]], <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}, { <span class="hljs-attr">lazy</span>: <span class="hljs-literal">true</span> })
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
          <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">computedGetter</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (watcher.<span class="hljs-property">dirty</span>) {
              watcher.<span class="hljs-title function_">get</span>()
              watcher.<span class="hljs-property">dirty</span> = <span class="hljs-literal">false</span>
            }
            watcher.<span class="hljs-property">deps</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
              dep.<span class="hljs-title function_">depend</span>()
            })
            <span class="hljs-keyword">return</span> watcher.<span class="hljs-property">value</span>
          },
          <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">computedSetter</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'请不要给计算属性赋值!'</span>)
          }
        })
      }
    }
  }

  <span class="hljs-title function_">initWatch</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> watch = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">watch</span>
    <span class="hljs-keyword">if</span> (watch) {
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(watch)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-variable language_">this</span>.$watch(keys[i], watch[keys[i]])
      }
    }
  }

  <span class="hljs-title function_">initRenderFunction</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> template
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">template</span>) {
      template = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">template</span>
    } <span class="hljs-keyword">else</span> {
      template = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>).<span class="hljs-property">outerHtml</span>
    }
    <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(template)
    <span class="hljs-keyword">const</span> code = <span class="hljs-title function_">generate</span>(ast).<span class="hljs-property">render</span>
    <span class="hljs-comment">// eslint-disable-next-line no-new-func</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">render</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(code)
  }

  <span class="hljs-title function_">initRenderWatch</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(
      <span class="hljs-variable language_">this</span>,
      <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#app'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`&lt;p&gt;<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>&lt;/p&gt;`</span>
      },
      <span class="hljs-function">() =&gt;</span> {}
    )
  }

  $watch(exp, cb) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>, exp, cb)
  }

  $set(target, key, value) {
    <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(target)
    <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Array]'</span>) {
      <span class="hljs-keyword">const</span> arratProto = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
      <span class="hljs-title function_">observe</span>(value)
      arratProto.<span class="hljs-property">splice</span>.<span class="hljs-title function_">call</span>(target, key, <span class="hljs-number">1</span>, value)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Object]'</span>) {
      <span class="hljs-title function_">defineReactive</span>(target, key, value)
    }
    <span class="hljs-comment">// 触发依赖 target 的 watchers。</span>
    target.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
  }
}

<span class="hljs-comment">// 观察 data 数据。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
  <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>(data)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dep</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(data, <span class="hljs-string">'__ob__'</span>, {
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>
    })
    <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Array]'</span>) {
      data.<span class="hljs-property">__proto__</span> = arrayMethods
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">observeArray</span>(data)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Object]'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">walk</span>(data)
    }
  }

  <span class="hljs-title function_">walk</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">defineReactive</span>(data, keys[i], data[keys[i]])
    }
  }

  <span class="hljs-title function_">observeArray</span>(<span class="hljs-params">array</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; array.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">observe</span>(array[i])
    }
  }
}

<span class="hljs-comment">// 定义 obj 对象的 key 属性的响应式。</span>
<span class="hljs-comment">// 这里利用了闭包，使得 value 变量 和 dep 常量一直没有被垃圾回收。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, value</span>) {
  <span class="hljs-keyword">const</span> dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()

  <span class="hljs-comment">// 深度优先遍历。</span>
  <span class="hljs-keyword">const</span> objKeyOb = <span class="hljs-title function_">observe</span>(value)

  <span class="hljs-keyword">if</span> (objKeyOb &amp;&amp; obj[key] &amp;&amp; obj[key].<span class="hljs-property">__ob__</span>) {
    objKeyOb.<span class="hljs-property">dep</span> = obj[key].<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>
  }

  <span class="hljs-comment">// 数据劫持逻辑。</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveGetter</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 订阅逻辑。</span>
      dep.<span class="hljs-title function_">depend</span>()
      <span class="hljs-keyword">if</span> (objKeyOb) {
        objKeyOb.<span class="hljs-property">dep</span>.<span class="hljs-title function_">depend</span>()
      }
      <span class="hljs-keyword">return</span> value
    },
    <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveSetter</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-keyword">if</span> (value === newValue) {
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-comment">// 发布逻辑。</span>
      dep.<span class="hljs-title function_">notify</span>()
      <span class="hljs-keyword">const</span> objKeyOb = <span class="hljs-title function_">observe</span>(newValue)
      <span class="hljs-keyword">if</span> (objKeyOb &amp;&amp; obj[key] &amp;&amp; obj[key].<span class="hljs-property">__ob__</span>) {
        objKeyOb.<span class="hljs-property">dep</span> = obj[key].<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>
      }
      value = newValue
    }
  })
}

<span class="hljs-comment">// “筐”被抽象成了 Dep 实例。</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dep</span> {
  <span class="hljs-comment">// 响应式属性当前要订阅的 watcher。</span>
  <span class="hljs-keyword">static</span> target = <span class="hljs-literal">null</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 响应式属性已订阅的 watcher 列表。</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span> = []
  }

  <span class="hljs-title function_">depend</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>) {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>.<span class="hljs-title function_">addDep</span>(<span class="hljs-variable language_">this</span>)
    }
  }

  <span class="hljs-title function_">addSub</span>(<span class="hljs-params">watcher</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">indexOf</span>(watcher) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">push</span>(watcher)
  }

  <span class="hljs-title function_">notify</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">watcher</span> =&gt;</span> {
      watcher.<span class="hljs-title function_">update</span>()
    })
  }
}

<span class="hljs-comment">// 回调函数被包装成了 Watcher 实例。</span>
<span class="hljs-comment">// TODO：暂时只实现了对 vm.$options.data 对象的第一层属性的监听。</span>
<span class="hljs-keyword">const</span> watcherQueue = []
<span class="hljs-keyword">let</span> watcherId = <span class="hljs-number">0</span>
<span class="hljs-keyword">const</span> targetStack = []
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Watcher</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">vm, exp, cb, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = ++watcherId
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span> = exp
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span> = cb
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deps</span> = []
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dirty</span> = !!options.<span class="hljs-property">lazy</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
    }
  }

  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-variable language_">this</span>
    targetStack.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>)
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span> === <span class="hljs-string">'function'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span>]
    }
    targetStack.<span class="hljs-title function_">pop</span>()
    <span class="hljs-keyword">if</span> (targetStack.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = targetStack[targetStack.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>
    }
  }

  <span class="hljs-title function_">addDep</span>(<span class="hljs-params">dep</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">deps</span>.<span class="hljs-title function_">indexOf</span>(dep) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deps</span>.<span class="hljs-title function_">push</span>(dep)
    dep.<span class="hljs-title function_">addSub</span>(<span class="hljs-variable language_">this</span>)
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dirty</span> = <span class="hljs-literal">true</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">run</span>()
    }
  }

  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (watcherQueue.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-comment">// 类似于 JavaScript 中的防抖逻辑。</span>
      <span class="hljs-keyword">return</span>
    }
    watcherQueue.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>)
    <span class="hljs-keyword">const</span> index = watcherQueue.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 更新 this.value(watcher.value) 的值。</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>)
      watcherQueue.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
    })
  }
}

<span class="hljs-keyword">const</span> mutationMethods = [<span class="hljs-string">'push'</span>, <span class="hljs-string">'pop'</span>, <span class="hljs-string">'shift'</span>, <span class="hljs-string">'unshift'</span>, <span class="hljs-string">'splice'</span>, <span class="hljs-string">'sort'</span>, <span class="hljs-string">'reverse'</span>]
<span class="hljs-keyword">const</span> arrayProto = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
<span class="hljs-keyword">const</span> arrayMethods = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(arrayProto)
mutationMethods.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">method</span> =&gt;</span> {
  arrayMethods[method] = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'push'</span> || method === <span class="hljs-string">'unshift'</span> || method === <span class="hljs-string">'splice'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>.<span class="hljs-title function_">observeArray</span>(args)
    }
    <span class="hljs-keyword">const</span> result = arrayProto[method].<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
    <span class="hljs-keyword">return</span> result
  }
})
</code></pre>
<h2 data-id="heading-15">实现虚拟 DOM</h2>
<h3 data-id="heading-16"><strong>什么是虚拟 DOM？</strong></h3>
<p>​		真实 DOM。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</code></pre>
<p>​		虚拟 DOM。</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">tag</span>: <span class="hljs-string">'ul'</span>,
  <span class="hljs-attr">attrs</span>: {},
  <span class="hljs-attr">children</span>: [
    {
      <span class="hljs-attr">tag</span>: <span class="hljs-string">'li'</span>,
      <span class="hljs-attr">attrs</span>: {},
      <span class="hljs-attr">children</span>: [
        {
          <span class="hljs-attr">tag</span>: <span class="hljs-literal">null</span>,
          <span class="hljs-attr">attrs</span>: {},
          <span class="hljs-attr">children</span>: [], <span class="hljs-comment">// children 的空值为 []。</span>
          <span class="hljs-attr">text</span>: <span class="hljs-string">'1'</span>
        }
      ]
    },
    ......
  ]
}
</code></pre>
<h3 data-id="heading-17"><strong>虚拟 DOM 有什么用？</strong></h3>
<p>​		1、**性能优化：**当数据发生变化时，Vue 会先在内存中构建虚拟 DOM 树，然后通过比较新旧虚拟 DOM 树的差异，最终只更新必要的部分到真实 DOM 树中。虚拟 DOM 的使用减少了 Vue 操作真实 DOM 的次数，从而提高了 Vue 渲染页面的性能。</p>
<p>​		2、**跨平台能力：**虚拟 DOM 是一个与平台无关的抽象层，它的使用使得 Vue 可以在浏览器、移动端和服务端（例如服务端渲染时）等多个环境中运行。</p>
<h3 data-id="heading-18"><strong>由渲染函数生成虚拟 DOM</strong></h3>
<p>​		定义一个简单的 VNode 类，并实现渲染函数中的 _c、_v、_s 函数。然后运行 vm.$options.render.call(vm) 即可得到虚拟 DOM。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">VNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tag, attrs, children, text</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">attrs</span> = attrs
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span> = children <span class="hljs-comment">// children 的空值为 []。</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = text
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elm</span> = <span class="hljs-literal">undefined</span>
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  ......

  <span class="hljs-title function_">_c</span>(<span class="hljs-params">tag, attrs, children</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(tag, attrs, children)
  }

  <span class="hljs-title function_">_v</span>(<span class="hljs-params">text</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(undefind, undefind, undefind, text)
  }

  <span class="hljs-title function_">_s</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span> || value === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>(value)
    }
  }

  ......
}
</code></pre>
<h3 data-id="heading-19"><strong>实现 Diff 和 Patch</strong></h3>
<p>​		在 Vue2 中，Diff 和 Patch 是虚拟 DOM 算法的两个关键步骤：1、**Diff（差异计算）：**Diff 是指将新旧虚拟 DOM 树进行比较，进而找出它们之间的差异；2、**Patch（补丁应用）：**Patch 是指将这些差异映射到真实 DOM 树上，使得真实 DOM 树与新的虚拟 DOM 树保持一致。</p>
<p>​		通过 Diff 和 Patch 的配合，Vue 可以凭借较少次数的真实 DOM 操作来实现高效地页面更新。</p>
<p>​		注意，Vue2 中的虚拟 DOM 算法是基于全量比较的，即每次页面更新都会对整个虚拟 DOM 树进行比较，这在大型应用中可能会导致性能问题。为了解决这个问题，Vue3 引入了基于静态分析的编译优化，使用了更高效的增量更新算法。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span> = options
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span> = <span class="hljs-literal">undefined</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_vnode</span> = <span class="hljs-literal">undefined</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_watcher</span> = <span class="hljs-literal">undefined</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initData</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initComputed</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initWatch</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initRenderFunction</span>()
    <span class="hljs-variable language_">this</span>.$mount(options.<span class="hljs-property">el</span>)
  }

  ......

  <span class="hljs-title function_">initRenderFunction</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> template
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">template</span>) {
      template = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">template</span>
    } <span class="hljs-keyword">else</span> {
      template = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>).<span class="hljs-property">outerHtml</span>
    }
    <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(template)
    <span class="hljs-keyword">const</span> code = <span class="hljs-title function_">generate</span>(ast).<span class="hljs-property">render</span>
    <span class="hljs-comment">// eslint-disable-next-line no-new-func</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">render</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(code)
  }

  ......

  $mount(el) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(el)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_watcher</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(
      <span class="hljs-variable language_">this</span>,
      <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_update</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">render</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>))
      },
      <span class="hljs-function">() =&gt;</span> {}
    )
  }

  ......

  <span class="hljs-title function_">_update</span>(<span class="hljs-params">vnode</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_vnode</span>) {
      <span class="hljs-title function_">patch</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_vnode</span>, vnode)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">patch</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>, vnode)
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_vnode</span> = vnode
  }

  ......
}
</code></pre>
<p>​		Vue 对虚拟 DOM 进行 patch 的逻辑基于 <strong>snabbdom</strong> 算法。patch 函数接受两个参数：旧的虚拟 DOM 和新的虚拟 DOM。（以下代码不考虑节点的属性和节点的 key。）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">oldVnode, newVnode</span>) {
  <span class="hljs-keyword">const</span> el = oldVnode.<span class="hljs-property">elm</span>
  <span class="hljs-keyword">const</span> parent = el.<span class="hljs-property">parentNode</span>

  <span class="hljs-keyword">const</span> isRealElement = oldVnode.<span class="hljs-property">nodeType</span>
  <span class="hljs-keyword">if</span> (isRealElement) {
    parent.<span class="hljs-title function_">replaceChild</span>(<span class="hljs-title function_">createElement</span>(newVnode), oldVnode)
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">if</span> (!newVnode) {
    parent.<span class="hljs-title function_">removeChild</span>(el)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isChange</span>(newVnode, oldVnode)) {
    newVnode.<span class="hljs-property">elm</span> = <span class="hljs-title function_">createElement</span>(newVnode)
    parent.<span class="hljs-title function_">replaceChild</span>(newVnode.<span class="hljs-property">elm</span>, el)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isChange</span>(newVnode, oldVnode)) {
    <span class="hljs-comment">// 渲染性能的提升就在这里。</span>
    newVnode.<span class="hljs-property">elm</span> = el
    <span class="hljs-keyword">const</span> newLength = newVnode.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>
    <span class="hljs-keyword">const</span> oldLength = oldVnode.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; newLength || i &lt; oldLength; i++) {
      <span class="hljs-keyword">if</span> (i &gt;= oldLength) {
        el.<span class="hljs-title function_">appendChild</span>(<span class="hljs-title function_">createElement</span>(newVnode.<span class="hljs-property">children</span>[i]))
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">patch</span>(oldVnode.<span class="hljs-property">children</span>[i], newVnode.<span class="hljs-property">children</span>[i])
      }
    }
  }
}

<span class="hljs-comment">// 由虚拟 DOM 创建真实 DOM。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-params">vnode</span>) {
  <span class="hljs-comment">// 文本节点。</span>
  <span class="hljs-keyword">if</span> (!vnode.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(vnode.<span class="hljs-property">text</span>)
    vnode.<span class="hljs-property">elm</span> = el
    <span class="hljs-keyword">return</span> el
  }

  <span class="hljs-comment">// 元素节点。</span>
  <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(vnode.<span class="hljs-property">tag</span>)
  vnode.<span class="hljs-property">elm</span> = el
  <span class="hljs-comment">// 在父子真实 DOM 之间建立关系。</span>
  vnode.<span class="hljs-property">children</span>.<span class="hljs-title function_">map</span>(createElement).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">subEl</span> =&gt;</span> {
    el.<span class="hljs-title function_">appendChild</span>(subEl)
  })
  <span class="hljs-keyword">return</span> el
}

<span class="hljs-comment">// 判断新的虚拟 DOM 相对于旧的虚拟 DOM 是否发生了变化。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isChange</span>(<span class="hljs-params">newVnode, oldVnode</span>) {
  <span class="hljs-keyword">return</span> newVnode.<span class="hljs-property">tag</span> !== oldVnode.<span class="hljs-property">tag</span> || newVnode.<span class="hljs-property">text</span> !== oldVnode.<span class="hljs-property">text</span>
}
</code></pre>
<h3 data-id="heading-20"><strong>虚拟 DOM 代码总结</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span> = options
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span> = <span class="hljs-literal">undefined</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_vnode</span> = <span class="hljs-literal">undefined</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_watcher</span> = <span class="hljs-literal">undefined</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initData</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initComputed</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initWatch</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initRenderFunction</span>()
    <span class="hljs-variable language_">this</span>.$mount(options.<span class="hljs-property">el</span>)
  }

  <span class="hljs-title function_">initData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// TODO：this.$options.data 还可能是一个函数。</span>
    <span class="hljs-keyword">const</span> data = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_data</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">data</span>)
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-comment">// 数据代理逻辑。</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
        <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxyGetter</span>(<span class="hljs-params"/>) {
          <span class="hljs-keyword">return</span> data[keys[i]]
        },
        <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxySetter</span>(<span class="hljs-params">newValue</span>) {
          data[keys[i]] = newValue
        }
      })
    }

    <span class="hljs-title function_">observe</span>(data)
  }

  <span class="hljs-title function_">initComputed</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> computed = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">computed</span>
    <span class="hljs-keyword">if</span> (computed) {
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(computed)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">const</span> watcher = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>, computed[keys[i]], <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {}, { <span class="hljs-attr">lazy</span>: <span class="hljs-literal">true</span> })
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">this</span>, keys[i], {
          <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
          <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">computedGetter</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">if</span> (watcher.<span class="hljs-property">dirty</span>) {
              watcher.<span class="hljs-title function_">get</span>()
              watcher.<span class="hljs-property">dirty</span> = <span class="hljs-literal">false</span>
            }
            watcher.<span class="hljs-property">deps</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> {
              dep.<span class="hljs-title function_">depend</span>()
            })
            <span class="hljs-keyword">return</span> watcher.<span class="hljs-property">value</span>
          },
          <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">computedSetter</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'请不要给计算属性赋值!'</span>)
          }
        })
      }
    }
  }

  <span class="hljs-title function_">initWatch</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> watch = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">watch</span>
    <span class="hljs-keyword">if</span> (watch) {
      <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(watch)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-variable language_">this</span>.$watch(keys[i], watch[keys[i]])
      }
    }
  }

  <span class="hljs-title function_">initRenderFunction</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> template
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">template</span>) {
      template = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">template</span>
    } <span class="hljs-keyword">else</span> {
      template = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">el</span>).<span class="hljs-property">outerHtml</span>
    }
    <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(template)
    <span class="hljs-keyword">const</span> code = <span class="hljs-title function_">generate</span>(ast).<span class="hljs-property">render</span>
    <span class="hljs-comment">// eslint-disable-next-line no-new-func</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">render</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(code)
  }

  $watch(exp, cb) {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(<span class="hljs-variable language_">this</span>, exp, cb)
  }

  $set(target, key, value) {
    <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(target)
    <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Array]'</span>) {
      <span class="hljs-keyword">const</span> arrayProto = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
      <span class="hljs-title function_">observe</span>(value)
      arrayProto.<span class="hljs-property">splice</span>.<span class="hljs-title function_">call</span>(target, key, <span class="hljs-number">1</span>, value)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Object]'</span>) {
      <span class="hljs-title function_">defineReactive</span>(target, key, value)
    }
    <span class="hljs-comment">// 触发依赖 target 的 watchers。</span>
    target.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
  }

  $mount(el) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(el)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_watcher</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(
      <span class="hljs-variable language_">this</span>,
      <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_update</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$options</span>.<span class="hljs-property">render</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>))
      },
      <span class="hljs-function">() =&gt;</span> {}
    )
  }

  <span class="hljs-title function_">_update</span>(<span class="hljs-params">vnode</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_vnode</span>) {
      <span class="hljs-title function_">patch</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">_vnode</span>, vnode)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">patch</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">$el</span>, vnode)
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_vnode</span> = vnode
  }

  <span class="hljs-title function_">_c</span>(<span class="hljs-params">tag, attrs, children</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(tag, attrs, children)
  }

  <span class="hljs-title function_">_v</span>(<span class="hljs-params">text</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VNode</span>(undefind, undefind, undefind, text)
  }

  <span class="hljs-title function_">_s</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">null</span> || value === <span class="hljs-literal">undefined</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(value)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>(value)
    }
  }
}

<span class="hljs-comment">// 观察 data 数据。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">observe</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
  <span class="hljs-keyword">if</span> (type !== <span class="hljs-string">'[object Object]'</span> &amp;&amp; type !== <span class="hljs-string">'[object Array]'</span>) {
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Observer</span>(data)
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Observer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dep</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(data, <span class="hljs-string">'__ob__'</span>, {
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>
    })
    <span class="hljs-keyword">const</span> type = <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(data)
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Array]'</span>) {
      data.<span class="hljs-property">__proto__</span> = arrayMethods
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">observeArray</span>(data)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'[object Object]'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">walk</span>(data)
    }
  }

  <span class="hljs-title function_">walk</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(data)
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; keys.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">defineReactive</span>(data, keys[i], data[keys[i]])
    }
  }

  <span class="hljs-title function_">observeArray</span>(<span class="hljs-params">array</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; array.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-title function_">observe</span>(array[i])
    }
  }
}

<span class="hljs-comment">// 定义 obj 对象的 key 属性的响应式。</span>
<span class="hljs-comment">// 这里利用了闭包，使得 value 变量 和 dep 常量一直没有被垃圾回收。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">defineReactive</span>(<span class="hljs-params">obj, key, value</span>) {
  <span class="hljs-keyword">const</span> dep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dep</span>()

  <span class="hljs-comment">// 深度优先遍历。</span>
  <span class="hljs-keyword">const</span> objKeyOb = <span class="hljs-title function_">observe</span>(value)

  <span class="hljs-keyword">if</span> (objKeyOb &amp;&amp; obj[key] &amp;&amp; obj[key].<span class="hljs-property">__ob__</span>) {
    objKeyOb.<span class="hljs-property">dep</span> = obj[key].<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>
  }

  <span class="hljs-comment">// 数据劫持逻辑。</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, key, {
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">get</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveGetter</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 订阅逻辑。</span>
      dep.<span class="hljs-title function_">depend</span>()
      <span class="hljs-keyword">if</span> (objKeyOb) {
        objKeyOb.<span class="hljs-property">dep</span>.<span class="hljs-title function_">depend</span>()
      }
      <span class="hljs-keyword">return</span> value
    },
    <span class="hljs-attr">set</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">reactiveSetter</span>(<span class="hljs-params">newValue</span>) {
      <span class="hljs-keyword">if</span> (value === newValue) {
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-comment">// 发布逻辑。</span>
      dep.<span class="hljs-title function_">notify</span>()
      <span class="hljs-keyword">const</span> objKeyOb = <span class="hljs-title function_">observe</span>(newValue)
      <span class="hljs-keyword">if</span> (objKeyOb &amp;&amp; obj[key] &amp;&amp; obj[key].<span class="hljs-property">__ob__</span>) {
        objKeyOb.<span class="hljs-property">dep</span> = obj[key].<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>
      }
      value = newValue
    }
  })
}

<span class="hljs-comment">// “筐”被抽象成了 Dep 实例。</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dep</span> {
  <span class="hljs-comment">// 响应式属性当前要订阅的 watcher。</span>
  <span class="hljs-keyword">static</span> target = <span class="hljs-literal">null</span>

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 响应式属性已订阅的 watcher 列表。</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span> = []
  }

  <span class="hljs-title function_">depend</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>) {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span>.<span class="hljs-title function_">addDep</span>(<span class="hljs-variable language_">this</span>)
    }
  }

  <span class="hljs-title function_">addSub</span>(<span class="hljs-params">watcher</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">indexOf</span>(watcher) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">push</span>(watcher)
  }

  <span class="hljs-title function_">notify</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">subs</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">watcher</span> =&gt;</span> {
      watcher.<span class="hljs-title function_">update</span>()
    })
  }
}

<span class="hljs-comment">// 回调函数被包装成了 Watcher 实例。</span>
<span class="hljs-comment">// TODO：暂时只实现了对 vm.$options.data 对象的第一层属性的监听。</span>
<span class="hljs-keyword">const</span> watcherQueue = []
<span class="hljs-keyword">let</span> watcherId = <span class="hljs-number">0</span>
<span class="hljs-keyword">const</span> targetStack = []
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Watcher</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">vm, exp, cb, options = {}</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = ++watcherId
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span> = vm
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span> = exp
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span> = cb
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deps</span> = []
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dirty</span> = !!options.<span class="hljs-property">lazy</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
    }
  }

  <span class="hljs-title function_">get</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-variable language_">this</span>
    targetStack.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>)
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span> === <span class="hljs-string">'function'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">exp</span>]
    }
    targetStack.<span class="hljs-title function_">pop</span>()
    <span class="hljs-keyword">if</span> (targetStack.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = targetStack[targetStack.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title class_">Dep</span>.<span class="hljs-property">target</span> = <span class="hljs-literal">null</span>
    }
  }

  <span class="hljs-title function_">addDep</span>(<span class="hljs-params">dep</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">deps</span>.<span class="hljs-title function_">indexOf</span>(dep) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deps</span>.<span class="hljs-title function_">push</span>(dep)
    dep.<span class="hljs-title function_">addSub</span>(<span class="hljs-variable language_">this</span>)
  }

  <span class="hljs-title function_">update</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lazy</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">dirty</span> = <span class="hljs-literal">true</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">run</span>()
    }
  }

  <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (watcherQueue.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>) !== -<span class="hljs-number">1</span>) {
      <span class="hljs-comment">// 类似于 JavaScript 中的防抖逻辑。</span>
      <span class="hljs-keyword">return</span>
    }
    watcherQueue.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>)
    <span class="hljs-keyword">const</span> index = watcherQueue.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 更新 this.value(watcher.value) 的值。</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">get</span>()
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cb</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">vm</span>)
      watcherQueue.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>)
    })
  }
}

<span class="hljs-keyword">const</span> mutationMethods = [<span class="hljs-string">'push'</span>, <span class="hljs-string">'pop'</span>, <span class="hljs-string">'shift'</span>, <span class="hljs-string">'unshift'</span>, <span class="hljs-string">'splice'</span>, <span class="hljs-string">'sort'</span>, <span class="hljs-string">'reverse'</span>]
<span class="hljs-keyword">const</span> arrayProto = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
<span class="hljs-keyword">const</span> arrayMethods = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(arrayProto)
mutationMethods.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">method</span> =&gt;</span> {
  arrayMethods[method] = <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'push'</span> || method === <span class="hljs-string">'unshift'</span> || method === <span class="hljs-string">'splice'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>.<span class="hljs-title function_">observeArray</span>(args)
    }
    <span class="hljs-keyword">const</span> result = arrayProto[method].<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">__ob__</span>.<span class="hljs-property">dep</span>.<span class="hljs-title function_">notify</span>()
    <span class="hljs-keyword">return</span> result
  }
})

<span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">template</span>) {
  <span class="hljs-keyword">let</span> root = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">let</span> currentParent
  <span class="hljs-keyword">const</span> stack = []

  <span class="hljs-comment">// 跳过空白字符串。</span>
  template = template.<span class="hljs-title function_">trim</span>()

  <span class="hljs-keyword">while</span> (template) {
    <span class="hljs-keyword">const</span> ltIndex = template.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'&lt;'</span>)
    <span class="hljs-comment">// ltIndex === -1 的情况不会出现。</span>
    <span class="hljs-comment">// ltIndex &gt; 0 标签前面有文本节点。</span>
    <span class="hljs-comment">// ltIndex === 0 &amp;&amp; template[ltIndex + 1] !== '/' 开始标签。</span>
    <span class="hljs-comment">// ltIndex === 0 &amp;&amp; template[ltIndex + 1] === '/' 结束标签。</span>
    <span class="hljs-keyword">if</span> (ltIndex &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-comment">// type：1-元素节点；2-带变量的文本节点；3-纯文本节点。</span>
      <span class="hljs-keyword">const</span> text = template.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, ltIndex)
      <span class="hljs-keyword">const</span> element = <span class="hljs-title function_">parseText</span>(text)
      element.<span class="hljs-property">parent</span> = currentParent
      <span class="hljs-keyword">if</span> (!currentParent.<span class="hljs-property">children</span>) {
        currentParent.<span class="hljs-property">children</span> = []
      }
      currentParent.<span class="hljs-property">children</span>.<span class="hljs-title function_">push</span>(element)
      template = template.<span class="hljs-title function_">slice</span>(ltIndex)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ltIndex === <span class="hljs-number">0</span> &amp;&amp; template[ltIndex + <span class="hljs-number">1</span>] !== <span class="hljs-string">'/'</span>) {
      <span class="hljs-keyword">const</span> gtIndex = template.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'&gt;'</span>)
      <span class="hljs-keyword">const</span> element = {
        <span class="hljs-attr">parent</span>: currentParent, <span class="hljs-comment">// 根节点的 parent 属性值为 undefined。</span>
        <span class="hljs-attr">tag</span>: template.<span class="hljs-title function_">slice</span>(ltIndex + <span class="hljs-number">1</span>, gtIndex), <span class="hljs-comment">// 只考虑开始标签中没有任何属性的情况。</span>
        <span class="hljs-attr">type</span>: <span class="hljs-number">1</span>
      }
      <span class="hljs-keyword">if</span> (currentParent) {
        <span class="hljs-keyword">if</span> (!currentParent.<span class="hljs-property">children</span>) {
          currentParent.<span class="hljs-property">children</span> = []
        }
        currentParent.<span class="hljs-property">children</span>.<span class="hljs-title function_">push</span>(element)
      } <span class="hljs-keyword">else</span> {
        root = element
      }
      currentParent = element
      stack.<span class="hljs-title function_">push</span>(element)
      template = template.<span class="hljs-title function_">slice</span>(gtIndex + <span class="hljs-number">1</span>)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ltIndex === <span class="hljs-number">0</span> &amp;&amp; template[ltIndex + <span class="hljs-number">1</span>] === <span class="hljs-string">'/'</span>) {
      <span class="hljs-keyword">const</span> gtIndex = template.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'&gt;'</span>)
      <span class="hljs-comment">// parse 函数执行完毕后 stack 值被设置为 []。</span>
      stack.<span class="hljs-title function_">pop</span>()
      <span class="hljs-comment">// parse 函数执行完毕后 currentParent 值被设置为 undefined。</span>
      currentParent = stack[stack.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]
      <span class="hljs-comment">// parse 函数执行完毕后 template 值被设置为 ''。</span>
      template = template.<span class="hljs-title function_">slice</span>(gtIndex + <span class="hljs-number">1</span>)
    }
  }

  <span class="hljs-keyword">return</span> root
}

<span class="hljs-comment">// 以 {{ 和 }} 为标识符，把 text 中的 '姓名：{{name}}' 转换成 '"姓名：" + _s(name)'。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parseText</span>(<span class="hljs-params">text</span>) {
  <span class="hljs-keyword">const</span> originText = text
  <span class="hljs-keyword">const</span> tokens = []
  <span class="hljs-comment">// type：2-带变量的文本节点；3-纯文本节点。</span>
  <span class="hljs-keyword">let</span> type = <span class="hljs-number">3</span>

  <span class="hljs-keyword">while</span> (text) {
    <span class="hljs-keyword">const</span> start = text.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'{{'</span>)
    <span class="hljs-keyword">const</span> end = text.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'}}'</span>)
    <span class="hljs-keyword">if</span> (start !== -<span class="hljs-number">1</span>) {
      type = <span class="hljs-number">2</span>
      <span class="hljs-keyword">if</span> (start &gt; <span class="hljs-number">0</span>) {
        tokens.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(text.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, start)))
      }
      <span class="hljs-keyword">const</span> exp = text.<span class="hljs-title function_">slice</span>(start + <span class="hljs-number">2</span>, end)
      tokens.<span class="hljs-title function_">push</span>(<span class="hljs-string">`_s(<span class="hljs-subst">${exp}</span>)`</span>)
      text = text.<span class="hljs-title function_">slice</span>(end + <span class="hljs-number">2</span>)
    } <span class="hljs-keyword">else</span> {
      tokens.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(text))
      text = <span class="hljs-string">''</span>
    }
  }

  <span class="hljs-keyword">const</span> element = {
    <span class="hljs-attr">parent</span>: <span class="hljs-literal">null</span>,
    type,
    <span class="hljs-attr">expression</span>: type === <span class="hljs-number">2</span> ? tokens.<span class="hljs-title function_">join</span>(<span class="hljs-string">' + '</span>) : <span class="hljs-string">''</span>,
    <span class="hljs-attr">text</span>: originText
  }

  <span class="hljs-keyword">return</span> element
}

<span class="hljs-comment">// 将 AST 转换为 render 函数的函数体的字符串。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">ast</span>) {
  <span class="hljs-keyword">const</span> code = <span class="hljs-title function_">genNode</span>(ast)
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">render</span>: <span class="hljs-string">`with (this) { return <span class="hljs-subst">${code}</span> }`</span>
  }
}

<span class="hljs-comment">// 转换节点。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genNode</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">genElement</span>(node)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">genText</span>(node)
  }
}

<span class="hljs-comment">// 转换元素节点。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genElement</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">const</span> children = <span class="hljs-title function_">genChildren</span>(node)
  <span class="hljs-comment">// children 的空值是 '[]'，不是 'undefined'。</span>
  <span class="hljs-keyword">const</span> code = <span class="hljs-string">`_c(<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(node.tag)}</span>, {}, <span class="hljs-subst">${children}</span>)`</span>
  <span class="hljs-keyword">return</span> code
}

<span class="hljs-comment">// 转换文本节点。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genText</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`_v(<span class="hljs-subst">${node.expression}</span>)`</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node.<span class="hljs-property">type</span> === <span class="hljs-number">3</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`_v(<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(node.text)}</span>)`</span>
  }
}

<span class="hljs-comment">// 转换元素节点的子节点列表中的子节点。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">genChildren</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-comment">// node.children 的空值为 undefined。</span>
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">children</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'['</span> + node.<span class="hljs-property">children</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> <span class="hljs-title function_">genNode</span>(child)).<span class="hljs-title function_">join</span>(<span class="hljs-string">', '</span>) + <span class="hljs-string">']'</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'[]'</span>
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">VNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">tag, attrs, children, text</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">attrs</span> = attrs
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">children</span> = children <span class="hljs-comment">// children 的空值为 []。</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = text
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">elm</span> = <span class="hljs-literal">undefined</span>
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">patch</span>(<span class="hljs-params">oldVnode, newVnode</span>) {
  <span class="hljs-keyword">const</span> el = oldVnode.<span class="hljs-property">elm</span>
  <span class="hljs-keyword">const</span> parent = el.<span class="hljs-property">parentNode</span>

  <span class="hljs-keyword">const</span> isRealElement = oldVnode.<span class="hljs-property">nodeType</span>
  <span class="hljs-keyword">if</span> (isRealElement) {
    parent.<span class="hljs-title function_">replaceChild</span>(<span class="hljs-title function_">createElement</span>(newVnode), oldVnode)
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">if</span> (!newVnode) {
    parent.<span class="hljs-title function_">removeChild</span>(el)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isChange</span>(newVnode, oldVnode)) {
    newVnode.<span class="hljs-property">elm</span> = <span class="hljs-title function_">createElement</span>(newVnode)
    parent.<span class="hljs-title function_">replaceChild</span>(newVnode.<span class="hljs-property">elm</span>, el)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isChange</span>(newVnode, oldVnode)) {
    <span class="hljs-comment">// 渲染性能的提升就在这里。</span>
    newVnode.<span class="hljs-property">elm</span> = el
    <span class="hljs-keyword">const</span> newLength = newVnode.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>
    <span class="hljs-keyword">const</span> oldLength = oldVnode.<span class="hljs-property">children</span>.<span class="hljs-property">length</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; newLength || i &lt; oldLength; i++) {
      <span class="hljs-keyword">if</span> (i &gt;= oldLength) {
        el.<span class="hljs-title function_">appendChild</span>(<span class="hljs-title function_">createElement</span>(newVnode.<span class="hljs-property">children</span>[i]))
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">patch</span>(oldVnode.<span class="hljs-property">children</span>[i], newVnode.<span class="hljs-property">children</span>[i])
      }
    }
  }
}

<span class="hljs-comment">// 由虚拟 DOM 创建真实 DOM。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createElement</span>(<span class="hljs-params">vnode</span>) {
  <span class="hljs-comment">// 文本节点。</span>
  <span class="hljs-keyword">if</span> (!vnode.<span class="hljs-property">tag</span>) {
    <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(vnode.<span class="hljs-property">text</span>)
    vnode.<span class="hljs-property">elm</span> = el
    <span class="hljs-keyword">return</span> el
  }

  <span class="hljs-comment">// 元素节点。</span>
  <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(vnode.<span class="hljs-property">tag</span>)
  vnode.<span class="hljs-property">elm</span> = el
  <span class="hljs-comment">// 在父子真实 DOM 之间建立关系。</span>
  vnode.<span class="hljs-property">children</span>.<span class="hljs-title function_">map</span>(createElement).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">subEl</span> =&gt;</span> {
    el.<span class="hljs-title function_">appendChild</span>(subEl)
  })
  <span class="hljs-keyword">return</span> el
}

<span class="hljs-comment">// 判断新的虚拟 DOM 相对于旧的虚拟 DOM 是否发生了变化。</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isChange</span>(<span class="hljs-params">newVnode, oldVnode</span>) {
  <span class="hljs-keyword">return</span> newVnode.<span class="hljs-property">tag</span> !== oldVnode.<span class="hljs-property">tag</span> || newVnode.<span class="hljs-property">text</span> !== oldVnode.<span class="hljs-property">text</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 macOS 上做 OCR：从截屏到可点词的实践笔记]]></title>    <link>https://juejin.cn/post/7598435950411104266</link>    <guid>https://juejin.cn/post/7598435950411104266</guid>    <pubDate>2026-01-24T07:38:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598435950411104266" data-draft-id="7598477092196859942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 macOS 上做 OCR：从截屏到可点词的实践笔记"/> <meta itemprop="keywords" content="前端,Swift,macOS"/> <meta itemprop="datePublished" content="2026-01-24T07:38:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叶落阁主"/> <meta itemprop="url" content="https://juejin.cn/user/2189882891714206"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 macOS 上做 OCR：从截屏到可点词的实践笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882891714206/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叶落阁主
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T07:38:57.000Z" title="Sat Jan 24 2026 07:38:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d8cd3b852604356a96eadaa418e61b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-26JC96ZiB5Li7:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769847467&amp;x-signature=uQbt8ybj06GKRFQ%2FadI%2FOtsfDfw%3D" alt="Screenshot 2026-01-24 at 15.37.26.png" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>最近在写一个 macOS 平台的快速翻译软件 SnapTra Translator，核心体验是“按住快捷键，把鼠标悬停在文字上就能看到翻译气泡”。这背后离不开 OCR：先把屏幕上一小块区域截下来，再用 Vision 把文字识别出来，最后根据光标位置选中最接近的单词。</p>
<p>这篇文章把我在项目里的实践整理成一份“可落地”的 macOS OCR 指南：既讲思路，也给关键代码和避坑点。</p>
<h3 data-id="heading-1">你能得到什么</h3>
<ul>
<li>一个 macOS OCR 的完整链路：截屏 → 识别 → 选词 → 调试</li>
<li>可直接复用的关键代码段（Vision + ScreenCaptureKit）</li>
<li>真实项目里的设计取舍与坑位</li>
</ul>
<h3 data-id="heading-2">为什么选择 Vision + ScreenCaptureKit</h3>
<p>在 macOS 上做 OCR，本质是：</p>
<ol>
<li>拿到屏幕图像（需要屏幕录制权限）</li>
<li>把图像喂给 Vision 的文本识别</li>
<li>根据识别结果的 bounding box 做交互（比如“光标附近取词”）</li>
</ol>
<p>Vision 是系统级 OCR，稳定、轻量、无需额外模型；ScreenCaptureKit 是更现代的截屏方式，能更好控制采样区域与性能。</p>
<h3 data-id="heading-3">SnapTra 的 OCR 链路概览</h3>
<p>我在 SnapTra Translator 里采用了“光标周围小范围截屏”的策略：</p>
<ul>
<li>每次翻译只截取鼠标附近一块固定大小区域（默认 520x140）</li>
<li>OCR 结果返回每行文本，再进一步切成更细的单词 token</li>
<li>将 token 的 bounding box 与鼠标位置比对，选中最接近的词</li>
</ul>
<p>这套链路让它能做到“点哪翻哪”，而不是整屏 OCR。</p>
<h3 data-id="heading-4">关键实现：截屏</h3>
<p>下面是项目里截取光标周围画面的核心逻辑，使用 <code>ScreenCaptureKit</code> 获取一张 <code>CGImage</code>：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScreenCaptureService</span> {
    <span class="hljs-keyword">let</span> captureSize <span class="hljs-operator">=</span> <span class="hljs-type">CGSize</span>(width: <span class="hljs-number">520</span>, height: <span class="hljs-number">140</span>)

    <span class="hljs-keyword">func</span> <span class="hljs-title function_">captureAroundCursor</span>() <span class="hljs-keyword">async</span> -&gt; (image: <span class="hljs-type">CGImage</span>, region: <span class="hljs-type">CaptureRegion</span>)<span class="hljs-operator">?</span> {
        <span class="hljs-keyword">let</span> mouseLocation <span class="hljs-operator">=</span> <span class="hljs-type">NSEvent</span>.mouseLocation
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> screen <span class="hljs-operator">=</span> <span class="hljs-type">NSScreen</span>.screens.first(where: { <span class="hljs-type">NSMouseInRect</span>(mouseLocation, <span class="hljs-variable">$0</span>.frame, <span class="hljs-literal">false</span>) }) <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        }
        <span class="hljs-keyword">let</span> rectInScreen <span class="hljs-operator">=</span> captureRect(for: mouseLocation, in: screen.frame, size: captureSize)
        <span class="hljs-keyword">let</span> cgRect <span class="hljs-operator">=</span> convertToDisplayLocalCoordinates(rectInScreen, screen: screen)

        <span class="hljs-keyword">let</span> display <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> getDisplay(for: displayID)
        <span class="hljs-keyword">let</span> filter <span class="hljs-operator">=</span> <span class="hljs-type">SCContentFilter</span>(display: display, excludingWindows: [])
        <span class="hljs-keyword">let</span> configuration <span class="hljs-operator">=</span> makeConfiguration(for: cgRect, scaleFactor: screen.backingScaleFactor)
        <span class="hljs-keyword">let</span> image <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">SCScreenshotManager</span>.captureImage(contentFilter: filter, configuration: configuration)
        <span class="hljs-keyword">return</span> (image, <span class="hljs-type">CaptureRegion</span>(rect: rectInScreen, screen: screen, displayID: displayID, scaleFactor: scaleFactor))
    }
}
</code></pre>
<p>这段代码的重点是：只抓一个小矩形区域，不做整屏截图，性能会好很多。</p>
<h3 data-id="heading-5">关键实现：OCR 识别</h3>
<p>Vision 的识别部分非常直接：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OCRService</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">recognizeWords</span>(<span class="hljs-params">in</span> <span class="hljs-params">image</span>: <span class="hljs-type">CGImage</span>, <span class="hljs-params">language</span>: <span class="hljs-type">String</span>) <span class="hljs-keyword">async</span> <span class="hljs-keyword">throws</span> -&gt; [<span class="hljs-type">RecognizedWord</span>] {
        <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.detached(priority: .userInitiated) {
            <span class="hljs-keyword">let</span> request <span class="hljs-operator">=</span> <span class="hljs-type">VNRecognizeTextRequest</span>()
            request.recognitionLevel <span class="hljs-operator">=</span> .accurate
            request.usesLanguageCorrection <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">#available</span>(<span class="hljs-keyword">macOS</span> <span class="hljs-number">13.0</span>, <span class="hljs-operator">*</span>) {
                request.revision <span class="hljs-operator">=</span> <span class="hljs-type">VNRecognizeTextRequestRevision3</span>
                request.automaticallyDetectsLanguage <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
            } <span class="hljs-keyword">else</span> {
                request.recognitionLanguages <span class="hljs-operator">=</span> [language]
            }

            <span class="hljs-keyword">let</span> handler <span class="hljs-operator">=</span> <span class="hljs-type">VNImageRequestHandler</span>(cgImage: image)
            <span class="hljs-keyword">try</span> handler.perform([request])
            <span class="hljs-keyword">return</span> <span class="hljs-type">OCRService</span>.extractWords(from: request.results <span class="hljs-operator">??</span> [])
        }.value
    }
}
</code></pre>
<p>几个小点：</p>
<ul>
<li><code>recognitionLevel = .accurate</code> 适合需要高精度的翻译场景</li>
<li>开启 <code>usesLanguageCorrection</code> 能提升英文识别的可读性</li>
<li>在 macOS 13+ 用 <code>automaticallyDetectsLanguage</code>，可以更自然地识别混合文本</li>
</ul>
<h3 data-id="heading-6">关键实现：从行到“词”</h3>
<p>Vision 返回的通常是“文本行”，但翻译场景需要更细粒度。</p>
<p>SnapTra 里我做了两步：</p>
<ol>
<li>先按英文字符拆分 token</li>
<li>对 CamelCase 做进一步切分（比如 <code>ApplePay</code> → <code>Apple</code> + <code>Pay</code>）</li>
</ol>
<p>同时，我没有直接使用 Vision 的 <code>boundingBox(for:)</code>，因为它对自定义分词并不稳定，而是用“字符比例”计算 box，保证稳定性。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 始终使用字符比例计算边界框，确保稳定性</span>
<span class="hljs-comment">// Vision 的 boundingBox(for:) 对自定义分词（CamelCase）支持不稳定</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">boundingBoxByCharacterRatio</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">textBox</span>: <span class="hljs-type">CGRect</span>, <span class="hljs-params">text</span>: <span class="hljs-type">String</span>, <span class="hljs-params">for</span> <span class="hljs-params">range</span>: <span class="hljs-type">Range</span>&lt;<span class="hljs-type">String</span>.<span class="hljs-type">Index</span>&gt;) -&gt; <span class="hljs-type">CGRect</span>? {
    <span class="hljs-keyword">let</span> totalCount <span class="hljs-operator">=</span> text.count
    <span class="hljs-keyword">let</span> startOffset <span class="hljs-operator">=</span> text.distance(from: text.startIndex, to: range.lowerBound)
    <span class="hljs-keyword">let</span> endOffset <span class="hljs-operator">=</span> text.distance(from: text.startIndex, to: range.upperBound)
    <span class="hljs-keyword">let</span> startFraction <span class="hljs-operator">=</span> <span class="hljs-type">CGFloat</span>(startOffset) <span class="hljs-operator">/</span> <span class="hljs-type">CGFloat</span>(totalCount)
    <span class="hljs-keyword">let</span> endFraction <span class="hljs-operator">=</span> <span class="hljs-type">CGFloat</span>(endOffset) <span class="hljs-operator">/</span> <span class="hljs-type">CGFloat</span>(totalCount)
    <span class="hljs-keyword">let</span> x <span class="hljs-operator">=</span> textBox.minX <span class="hljs-operator">+</span> textBox.width <span class="hljs-operator">*</span> startFraction
    <span class="hljs-keyword">let</span> width <span class="hljs-operator">=</span> textBox.width <span class="hljs-operator">*</span> (endFraction <span class="hljs-operator">-</span> startFraction)
    <span class="hljs-keyword">return</span> <span class="hljs-type">CGRect</span>(x: x, y: textBox.minY, width: width, height: textBox.height)
}
</code></pre>
<h3 data-id="heading-7">如何“点词”：用鼠标位置选中最相关的词</h3>
<p>OCR 的输出是多个单词加 bounding box。为了实现“鼠标指哪翻哪”，我做了两件事：</p>
<ul>
<li>只保留 bounding box 包含鼠标位置的词</li>
<li>如果有多个候选，取中心点离鼠标最近的</li>
</ul>
<p>这样可以在密集文本里也保持稳定体验。</p>
<h3 data-id="heading-8">权限与系统设置：屏幕录制是前置条件</h3>
<p>只要涉及屏幕截图，就需要 Screen Recording 权限。项目里通过 <code>CGPreflightScreenCaptureAccess()</code> 判断当前权限，并提供快捷跳转系统设置：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">requestAndOpenScreenRecording</span>() {
    <span class="hljs-type">CGRequestScreenCaptureAccess</span>()
    openPrivacyPane(anchor: <span class="hljs-string">"Privacy_ScreenCapture"</span>)
}
</code></pre>
<p>体验上，我会在权限状态变化后自动刷新，并在未授权时提示用户。</p>
<h3 data-id="heading-9">调试手段：把 OCR 区域画出来</h3>
<p>“看不到”是 OCR 调试最大的阻力。SnapTra 里做了一个 Debug OCR Region 开关：</p>
<ul>
<li>红框显示当前截屏区域</li>
<li>绿框显示每个识别出来的单词边界</li>
</ul>
<p>这可以直观观察“截屏区域是否对齐”、“识别结果是否偏移”，非常推荐在早期就加上。</p>
<h3 data-id="heading-10">常见坑位与建议</h3>
<ol>
<li>不要整屏 OCR：性能会很差，体验会卡</li>
<li>识别结果的坐标系是归一化坐标，转到屏幕坐标要注意 y 轴翻转</li>
<li>语言设置不要死板：混合语言场景很常见</li>
<li>分词策略比你想象的重要：翻译工具对词粒度很敏感</li>
</ol>
<h3 data-id="heading-11">落地小结</h3>
<p>如果你要做一个“屏幕取词 + 翻译”的 macOS 工具，推荐的最小链路是：</p>
<ol>
<li>用 ScreenCaptureKit 截取鼠标附近小区域</li>
<li>用 Vision 识别文本</li>
<li>自己做分词与 box 细化</li>
<li>用鼠标位置选词</li>
<li>加一个 Debug OCR Region 视图，调试效率直接翻倍</li>
</ol>
<h3 data-id="heading-12">最后</h3>
<p>我在 SnapTra Translator 里踩过的坑、做过的取舍，都尽量写在上面了。OCR 看似简单，但真正落地到“手感很好”的产品，细节真的很多。</p>
<p>如果你也在做 macOS OCR 或翻译工具，欢迎交流想法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nuxt配置代理 和 请求接口]]></title>    <link>https://juejin.cn/post/7598532592455598107</link>    <guid>https://juejin.cn/post/7598532592455598107</guid>    <pubDate>2026-01-24T07:45:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598532592455598107" data-draft-id="7598021984300564507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nuxt配置代理 和 请求接口"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-24T07:45:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江湖文人"/> <meta itemprop="url" content="https://juejin.cn/user/3044986347066480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nuxt配置代理 和 请求接口
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044986347066480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江湖文人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T07:45:07.000Z" title="Sat Jan 24 2026 07:45:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><pre><code class="hljs language-md" lang="md">一、安装

npm install @nuxtjs/axios @nuxtjs/proxy -S


// nuxt.config.js
{
  ...
  modules: [
<span class="hljs-code">    '@nuxtjs/axios',
    '@nuxtjs/proxy'
  ],
  axios: {
    // 是否可以跨域
    proxy: true,
    // retry: { retries: 3 },
    // baseUrl: process.env._ENV == 'production' ? 'xxx' : 'xxx'
  },
  proxy: {
    '/api': {
      target: 'http://localhost:4000',
      pathRewrite: {
        '^/api': ''
      }
    }
  }
}
</span></code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98cd743e377f40e5a93881b1cfe4db13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5rmW5paH5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769845507&amp;x-signature=PBKKKb9%2FmIDChl2Sf1im1oRX2Xc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">登录&amp;获取个人信息</h2>
<p>axiaos在项目中一定会进行二次封装的。封装的内容可能有所不同。</p>
<pre><code class="hljs language-ts" lang="ts">登录 我的 新闻
</code></pre>
<p>点击登录，它就跳转到登录页，那在登录页我就可以输入账号或者密码。当然，在正儿八经的项目里面，可能会有扫码登录或者验证码等等。所以我们先做个简易版的，先把逻辑走通先。就是用户名和密码登录。如果说它输入内容登录上了以后，就需要把token记录上。</p>
<p>存储之后，如果说他已经登录了，那点击到我的，它可以展示这个登录账号的一个头像或者昵称等等信息。如果说没有登录，点到我的，它会跳转到登录页，</p>
<p>当然新闻的话呢，是不需要登录的。就是登录没邓旒都可以进入到新闻页。</p>
<pre><code class="hljs language-html" lang="html">/pages/index.vue

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">nuxt-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/login"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">nuxt-link</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">nuxt-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/my"</span>&gt;</span>我的<span class="hljs-tag">&lt;/<span class="hljs-name">nuxt-link</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">nuxt-link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/news"</span>&gt;</span>新闻<span class="hljs-tag">&lt;/<span class="hljs-name">nuxt-link</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'IndexPage'</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>登录页</p>
<pre><code class="hljs language-html" lang="html">// login.vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>登录页<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"userName"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"userPwd"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"login"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">userName</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">userPwd</span>: <span class="hljs-string">''</span>
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">login</span>(<span class="hljs-params"/>) {
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>然后安装包</p>
<pre><code class="hljs language-ts" lang="ts">cnpm install <span class="hljs-meta">@nuxtjs</span>/axios <span class="hljs-meta">@nuxtjs</span>/proxy -<span class="hljs-title class_">Ss</span>
</code></pre>
<p>到config里面去配置：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// nuxt.config.js</span>

{
  ...
  <span class="hljs-attr">modules</span>: [
    <span class="hljs-string">'@nuxtjs/axios'</span>,
    <span class="hljs-string">'@nuxtjs/proxy'</span>
  ],
  <span class="hljs-attr">axios</span>: {
    <span class="hljs-attr">proxy</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-comment">// 代理的地址</span>
  <span class="hljs-attr">proxy</span>: {
    <span class="hljs-string">'/api'</span>: {
      <span class="hljs-comment">// 一般这里填域名 </span>
      <span class="hljs-attr">target</span>: <span class="hljs-string">'http://testapi.xxx.cn/'</span>
    }
  }
}
</code></pre>
<p>然后就可以写接口了：</p>
<pre><code class="hljs language-html" lang="html">// login.vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>登录页<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"userName"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"userPwd"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"login"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">userName</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">userPwd</span>: <span class="hljs-string">''</span>
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">login</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.$axios({
        <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/u/loginByJson'</span>,
        <span class="hljs-attr">method</span>: <span class="hljs-string">'post'</span>
      })
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>这里需要<code>qs</code>一下：</p>
<pre><code class="hljs language-ts" lang="ts">cnpm install qs -S
</code></pre>
<pre><code class="hljs language-html" lang="html">// login.vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>登录页<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"userName"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"userPwd"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"login"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">userName</span>: <span class="hljs-string">''</span>,
      <span class="hljs-attr">userPwd</span>: <span class="hljs-string">''</span>
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">login</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">let</span> data = qs.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">username</span>:  <span class="hljs-variable language_">this</span>.<span class="hljs-property">userName</span>,
        <span class="hljs-attr">password</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">userPwd</span>
      })
      <span class="hljs-variable language_">this</span>.$axios({
        <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/u/loginByJson'</span>,
        <span class="hljs-attr">method</span>: <span class="hljs-string">'post'</span>,
        data
      }).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)
      })
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><code>qs</code>用来处理<code>url</code>查询字符串的序列化和解析。</p>
<h2 data-id="heading-1">解析</h2>
<p>将url查询字符串转为js对象：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> qs <span class="hljs-keyword">from</span> <span class="hljs-string">'qs'</span>;

<span class="hljs-keyword">const</span> query = <span class="hljs-string">'?name=张三&amp;age=21'</span>;
<span class="hljs-keyword">const</span> result = qs.<span class="hljs-title function_">parse</span>(query, { <span class="hljs-attr">ignoreQueryPrefix</span>: <span class="hljs-literal">true</span> });

<span class="hljs-comment">// 结果：{ name: '张三', age: '21' }</span>
</code></pre>
<h2 data-id="heading-2">序列化</h2>
<p>将js对象转换为url查询字符串</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">21</span>,
  <span class="hljs-attr">hobbies</span>: [<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>]
}
<span class="hljs-keyword">const</span> queryString = qs.<span class="hljs-title function_">stringify</span>(obj);
<span class="hljs-comment">// 结果 'name=张三&amp;age=21$hobbies=1$hobbies=2'</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 嵌套对象</span>
qs.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">a</span>: { <span class="hljs-attr">b</span>: { <span class="hljs-attr">c</span>: <span class="hljs-string">'value'</span> } } });
<span class="hljs-comment">// 结果：'a[b][c]=value'</span>

<span class="hljs-comment">// 支持数组索引</span>
qs.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">a</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] });
<span class="hljs-comment">// 结果：'a[0]=1&amp;a[1]=2&amp;a[2]=3'</span>
</code></pre>
<pre><code class="hljs language-js" lang="js">qs.<span class="hljs-title function_">stringify</span>(obj, {
  <span class="hljs-attr">encode</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 是否编码（默认true）</span>
  <span class="hljs-attr">arrayFormat</span>: <span class="hljs-string">'brackets'</span>,  <span class="hljs-comment">// 数组格式：indices/brackets/repeat</span>
  <span class="hljs-attr">skipNulls</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// 跳过null值</span>
  <span class="hljs-attr">allowDots</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// 使用点号表示嵌套：a.b.c=value</span>
});
</code></pre>
<p>在请求中，为什么还要用一下<code>qs.stringify()</code>为了将对象正确地格式化为<code>application/x-www-form-urlencoded</code>格式。</p>
<p>解决axios默认行为问题。</p>
<p>axios默认情况下：</p>
<ul>
<li>
<p>当data是对象时，会自动序列化为<code>application/json</code>（json格式）。</p>
</li>
<li>
<p>有些后端接口要求<code>application/x-www-form-urlencoded</code>格式。</p>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">qs.<span class="hljs-title function_">stringfy</span>({
  <span class="hljs-attr">username</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-attr">password</span>: <span class="hljs-string">'123'</span>
})

<span class="hljs-comment">// 结果 'username=%E5%BC%A0%E4%B8%89&amp;password=123456'</span>
</code></pre>
<p>请求头: <code>Content-Type: application/x-www-form-urlencoded</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe768935ba6d4a9899712e363259e175~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5rmW5paH5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769845507&amp;x-signature=0chyQXy2On6ti7NL7MP6xv0nK2A%3D" alt="image.png" loading="lazy"/></p>
<p>登录成功后有一个token:</p>
<p>然后就需要把token给存储起来。下一步做的事就是如果我登录成功了，肯定要把token存进去，存到vuex里面，并且做到持久化存储。</p>
<p>点击我的，会显示个人信息在里边。获取个人信息。获取个人信息，需要把token携带过去。就有这样一个参数。这个时候就要针对axios进行二次封装了。</p>
<p>那么封装的内容就要在plugins里面。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// nuxt.config.ts</span>

{
  ...
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-string">'~/plugins/axios'</span>
  ],
  ...
}
</code></pre>
<p><code>plugins/axios.js</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// axios.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ({ $axios, store }) =&gt; {
  <span class="hljs-comment">// Request拦截器，设置token</span>
  $axios.<span class="hljs-title function_">onRequest</span>(<span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    
  })
  $axios.<span class="hljs-title function_">onRequest</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    
  })
  $axios.<span class="hljs-title function_">onResponse</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
  })
}
</code></pre>
<p>二次封装封装的点特别多，比如说我们可以封装它的一个<code>request</code>拦截器去设置一个<code>token</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51ea19431e6b4507a7eab5416861f344~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5rmW5paH5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769845507&amp;x-signature=7w91I4SUDcFkOEhoI%2FB84jryV94%3D" alt="image.png" loading="lazy"/></p>
<p>在store下面设置vuex：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> state = {
  <span class="hljs-attr">token</span>: <span class="hljs-string">''</span>
}

<span class="hljs-comment">// 因为要做服务端，服务端因为没有localstorage\cookie等,所以需要安装 cnpm install cookie-universal-nuxt -S</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> mutations = {
  <span class="hljs-title function_">setToken</span>(<span class="hljs-params">state, token</span>) {
    state.<span class="hljs-property">token</span> = token
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$cookies</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'token'</span>, token);
  },
  <span class="hljs-title function_">getToken</span>(<span class="hljs-params">state</span>) {
    <span class="hljs-comment">// 这里用中间件读取到token，然后在这个方法里面去设置token</span>
    state.<span class="hljs-property">token</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'token'</span>);
  }
}
</code></pre>
<p>并且要把cookie-universal-nuxt配置到modules里面：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// nuxt.config.js</span>
{
  ...
  <span class="hljs-attr">modules</span>: [
   <span class="hljs-string">'cookie-universal-nuxt'</span>
  ]
}
</code></pre>
<p>设置完成后，回到任何一个地方，它都有。然后我们需要认证守卫。</p>
<p>在这里我们需要把中间件创建一下，先在根目录创建<code>middleware</code>文件夹，然后在这下面创建一个<code>auth.js</code>文件，</p>
<pre><code class="hljs language-js" lang="js"/></pre>
<p>在my页面做middleware：</p>
<pre><code class="hljs language-html" lang="html">// my.vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我的<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span>{
  <span class="hljs-attr">middleware</span>: <span class="hljs-string">'auth'</span>
}
&lt;/scirpt&gt;
</span></code></pre>
<p><code>middleware</code>在<code>my</code>页面生效。这是我们读取出来的<code>store</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// middleware/auth.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ({ store }) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(store.<span class="hljs-property">state</span>);
}
</code></pre>
<p>然后获取token的值，我们已经持久化存到cookie了，可以commit去提交那个<code>getToken</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// middleware/auth.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ({ store }) =&gt; {
  store.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'getToken'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(store.<span class="hljs-property">state</span>);
}
</code></pre>
<p>然后就可以读取得到<code>token</code>了。</p>
<p>如果没有token的，就让他跳转到登录页：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// middleware/auth.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ({ store, redirect }) =&gt; {
  store.<span class="hljs-title function_">commit</span>(<span class="hljs-string">'getToken'</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(store.<span class="hljs-property">state</span>);
  <span class="hljs-keyword">if</span> (!store.<span class="hljs-property">state</span>.<span class="hljs-property">token</span>) {
    <span class="hljs-title function_">redirect</span>(<span class="hljs-string">'/login'</span>)
  }
}
</code></pre>
<pre><code class="hljs language-html" lang="html">// login.vue

methods: {
  ...mapMutations(['setToken']),
  login() {
    let data = qs.stringify({
      username: this.userName,
      password: this.userPwd
    });
    
    this.$axios({
      url: '/api/u/loginByJson',
      method: 'post',
      data
    }).then(res =&gt; {
      this.setToken(res.data.accessToken)
      this.$router.push({
        name: 'index'
      })
    })
  }
}
</code></pre>
<p>如果没有登录，那么点击我的就会进入登录页，登录也填入账号和密码，点击登录，就会请求登录接口，然后获得token，token就会设置到cookie里面，再点击我的，就会可以查看自己的信息了，然后state.token会在中间件里又把本地cookie里面的token设置回去给它（完成持久性）。</p>
<p>做完之后，在我的页面，想要获得到个人信息，用户信息，所以在<code>my.vue</code>就可以做文章了：</p>
<pre><code class="hljs language-html" lang="html">// my.vue

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我的<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/javascript"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">middleware</span>: <span class="hljs-string">'auth'</span>,
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">asyncData</span>(<span class="hljs-params">{ $axios }</span>) {
    <span class="hljs-keyword">let</span> res = <span class="hljs-keyword">await</span> $axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/member/getInfo'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>请求的axios要全局封装，一定要带token：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// axios.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ({ $axios }) =&gt; {
  <span class="hljs-comment">// Request拦截器，设置token</span>
  $axios.<span class="hljs-title function_">onRequest</span>(<span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    config.<span class="hljs-property">headers</span>[<span class="hljs-string">'Authorization'</span>] = store.<span class="hljs-property">state</span>.<span class="hljs-property">token</span>;
  })
  <span class="hljs-comment">// Error拦截器：出现错误的时候被调用</span>
  $axios.<span class="hljs-title function_">onRequest</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-title function_">consolelog</span>(<span class="hljs-number">222</span>, error);
  })
  $axios.<span class="hljs-title function_">onResponse</span>(<span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">333</span>, response)
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
  })
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ReentrantLock和AQS源码解析]]></title>    <link>https://juejin.cn/post/7598465042968199208</link>    <guid>https://juejin.cn/post/7598465042968199208</guid>    <pubDate>2026-01-24T07:51:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598465042968199208" data-draft-id="7596186565270290447" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ReentrantLock和AQS源码解析"/> <meta itemprop="keywords" content="源码"/> <meta itemprop="datePublished" content="2026-01-24T07:51:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="XRay"/> <meta itemprop="url" content="https://juejin.cn/user/3966693685869288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ReentrantLock和AQS源码解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3966693685869288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    XRay
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T07:51:46.000Z" title="Sat Jan 24 2026 07:51:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文源码基于JDK 1.8</p>
<p>在 Java 中，Dong Lea 大师为我们提供了大量并发编程工具类，它们都在 JDK 的 java.util.concurrent 包下，其目录结构如下：</p>
<img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ec594e8d6f5f4d75a4f5eec212cebcaa~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=580&amp;h=648&amp;s=81240&amp;e=png&amp;b=fefee6" alt="image.png" width="50%" loading="lazy"/>
<p>current 包中包含很多我们常用的并发工具类，如：ConcurrentHashMap、CopyOnWriteArrayList、ArrayBlockingQueue、LinkedBlockingQueue、ThreadPoolExecutor 等。</p>
<p>其中还包含了 2 个子包： atomic 和 locks 。atomic 包下有 AtomicBoolean、AtomicInteger、atomicReference 等 CAS 原子变量类， locks 包下有 ReentrantLock、ReentrantReadWriteLock、AbstractQueuedSynchronizer 等锁及锁的底层实现基础框架。这些类的实现主要是依赖于 volatile 及 CAS ，从整体上来看 concurrent 包的整体实现图如下图所示：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ec7cb609de1c454f84a53677d1d7db7b~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=822&amp;h=480&amp;s=42818&amp;e=png&amp;b=fdfdfd" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-0">Lock</h4>
<p>锁能够解决多个线程同时访问共享资源造成的同步问题，在 Lock 接口出现之前， Java 主要是靠 synchronized 关键字来实现锁功能， Java SE5 之后并发包中增加了 Lock 接口，它提供了与 synchronized 一样的锁功能。它虽然没有使用 synchronize 关键字那么便捷，但是它拥有获取和释放锁的可操作性，还有可中断地获取锁以及超时获取锁等多种 synchronized 关键字所不具备的同步特性。</p>
<p>Lock 是一个接口，里面有 6 个方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Lock</span> {

    <span class="hljs-comment">// 获取锁，无返回值，如果没有拿到锁将无法进行线程调度并处于休眠状态直到拿到锁</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">// 和上面不同的地方是获取锁的过程能够响应中断</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException;

    <span class="hljs-comment">// 获取锁，有返回值，能拿到锁立即返回 true ；否则返回 false ;</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">// 在超时时间内并且没有被中断的情况下如果锁是空闲的就能拿到锁</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> time, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException;

    <span class="hljs-comment">// 释放锁</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">// 返回跟锁实例绑定的Condition实例</span>
    Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span>;
}
</code></pre>
<h4 data-id="heading-1">ReentrantLock</h4>
<p>ReentrantLock 实现了 Lock 接口，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span>, java.io.Serializable {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sync sync;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReentrantLock</span><span class="hljs-params">()</span> {
        sync = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NonfairSync</span>();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReentrantLock</span><span class="hljs-params">(<span class="hljs-type">boolean</span> fair)</span> {
        sync = fair ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">FairSync</span>() : <span class="hljs-keyword">new</span> <span class="hljs-title class_">NonfairSync</span>();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
        sync.lock();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        sync.acquireInterruptibly(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sync.nonfairTryAcquire(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span>
            <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-keyword">return</span> sync.tryAcquireNanos(<span class="hljs-number">1</span>, unit.toNanos(timeout));
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> {
        sync.release(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sync.newCondition();
    }

}
</code></pre>
<p>从上面的代码可以看到里面的方法都是通过 sync 来实现的，如果调用 ReentrantLock 无参的构造方法，sync 就是 NonfairSync 的实例；如果使用 new ReentrantLock(true) ，则 sync 就是 FairSync 的实例。</p>
<p>他们俩分别是非公平锁和公平锁，由此可知 ReentrantLock 默认是非公平锁， NonfairSync 和 FairSync 的代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReentrantLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span>, java.io.Serializable {

    <span class="hljs-comment">/**
     * Sync object for non-fair locks
     */</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NonfairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">7316153563782823691L</span>;

        <span class="hljs-comment">/**
         * Performs lock. Try immediate barge, backing up to normal
         * acquire on failure.
         */</span>
        <span class="hljs-comment">// Android-removed: @ReservedStackAccess from OpenJDK 9, not available on Android.</span>
        <span class="hljs-comment">// @ReservedStackAccess</span>
        <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>))
                setExclusiveOwnerThread(Thread.currentThread());
            <span class="hljs-keyword">else</span>
                acquire(<span class="hljs-number">1</span>);
        }

        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-comment">// 调用 nonfairTryAcquire() 方法</span>
            <span class="hljs-keyword">return</span> nonfairTryAcquire(acquires);
        }
    }

    <span class="hljs-comment">/**
     * Sync object for fair locks
     */</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FairSync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sync</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">3000897897090466540L</span>;

        <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
            acquire(<span class="hljs-number">1</span>);
        }

        <span class="hljs-comment">/**
         * Fair version of tryAcquire. Don't grant access unless
         * recursive call or no waiters or is first.
         */</span>
        <span class="hljs-comment">// Android-removed: @ReservedStackAccess from OpenJDK 9, not available on Android.</span>
        <span class="hljs-comment">// @ReservedStackAccess</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
            <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
            <span class="hljs-comment">// 锁没有被线程持有</span>
            <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 等待队列中是否有前驱节点</span>
                <span class="hljs-keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;
                        compareAndSetState(<span class="hljs-number">0</span>, acquires)) {
                    setExclusiveOwnerThread(current);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            }
            <span class="hljs-comment">// 锁已经被某个线程持有，则判断该线程是否是当前线程</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (current == getExclusiveOwnerThread()) {
                <span class="hljs-comment">// 再次获取，计数加 1</span>
                <span class="hljs-type">int</span> <span class="hljs-variable">nextc</span> <span class="hljs-operator">=</span> c + acquires;
                <span class="hljs-keyword">if</span> (nextc &lt; <span class="hljs-number">0</span>)
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Maximum lock count exceeded"</span>);
                setState(nextc);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }


    <span class="hljs-comment">/**
     * Base of synchronization control for this lock. Subclassed
     * into fair and nonfair versions below. Uses AQS state to
     * represent the number of holds on the lock.
     */</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">5179523762034025860L</span>;

        <span class="hljs-comment">/**
         * Performs {<span class="hljs-doctag">@link</span> Lock#lock}. The main reason for subclassing
         * is to allow fast path for nonfair version.
         */</span>
        <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span>;

        <span class="hljs-comment">/**
         * Performs non-fair tryLock. tryAcquire is implemented in
         * subclasses, but both need nonfair try for trylock method.
         */</span>
        <span class="hljs-comment">// Android-removed: @ReservedStackAccess from OpenJDK 9, not available on Android.</span>
        <span class="hljs-comment">// @ReservedStackAccess</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">nonfairTryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Thread</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> Thread.currentThread();
            <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState();
            <span class="hljs-comment">// 锁没有被线程持有，那么当前线程可以去获取锁</span>
            <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, acquires)) {
                    setExclusiveOwnerThread(current);
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
                }
            }
            <span class="hljs-comment">// 锁已经被某个线程持有，则判断该线程是否是当前线程</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (current == getExclusiveOwnerThread()) {
                <span class="hljs-comment">// 再次获取，计数加1</span>
                <span class="hljs-type">int</span> <span class="hljs-variable">nextc</span> <span class="hljs-operator">=</span> c + acquires;
                <span class="hljs-keyword">if</span> (nextc &lt; <span class="hljs-number">0</span>) <span class="hljs-comment">// overflow</span>
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Maximum lock count exceeded"</span>);
                setState(nextc);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-comment">// Android-removed: @ReservedStackAccess from OpenJDK 9, not available on Android.</span>
        <span class="hljs-comment">// @ReservedStackAccess</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-comment">//计数减1</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> getState() - releases;
            <span class="hljs-keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();
            <span class="hljs-type">boolean</span> <span class="hljs-variable">free</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-comment">//计数为0时，当前线程释放锁</span>
            <span class="hljs-keyword">if</span> (c == <span class="hljs-number">0</span>) {
                free = <span class="hljs-literal">true</span>;
                setExclusiveOwnerThread(<span class="hljs-literal">null</span>);
            }
            setState(c);
            <span class="hljs-comment">//计数不为0时，返回false</span>
            <span class="hljs-keyword">return</span> free;
        }

        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldExclusively</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// While we must in general read state before owner,</span>
            <span class="hljs-comment">// we don't need to do so to check if current thread is owner</span>
            <span class="hljs-keyword">return</span> getExclusiveOwnerThread() == Thread.currentThread();
        }

        <span class="hljs-keyword">final</span> ConditionObject <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionObject</span>();
        }

        <span class="hljs-comment">// Methods relayed from outer class</span>

        <span class="hljs-keyword">final</span> Thread <span class="hljs-title function_">getOwner</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> getState() == <span class="hljs-number">0</span> ? <span class="hljs-literal">null</span> : getExclusiveOwnerThread();
        }

        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getHoldCount</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> isHeldExclusively() ? getState() : <span class="hljs-number">0</span>;
        }

        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLocked</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> getState() != <span class="hljs-number">0</span>;
        }

        <span class="hljs-comment">/**
         * Reconstitutes the instance from a stream (that is, deserializes it).
         */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span>
                <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException {
            s.defaultReadObject();
            setState(<span class="hljs-number">0</span>); <span class="hljs-comment">// reset to unlocked state</span>
        }
    }
}
</code></pre>
<p>可以看到 NonfairSync 和 FairSync 均继承自 Sync 类，Sync 类是 ReentrantLock 类中的抽象静态内部类， Sync 类继承自 AbstractQueuedSynchronizer 类，Sync 类中的 lock() 方法是一个抽象方法，子类必须重写。 NonfairSync 和 FairSync 类中分别对 lock() 方法进行了不同的重写实现。其区别是 NonfairSync 中的 lock() 方法会先使用 CAS 尝试获取锁，如果成功了，设置当前线程为拥有独占访问权限的线程，如果 CAS 不成功，再调用 AQS 中的 acquire(1) ，而 FairSync 中的 lock() 方法直接调用了 acquire(1) ， acquire() 方法来自 AbstractQueuedSynchronizer ，代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
        <span class="hljs-comment">// 先使用 tryAcquire(arg) 获取锁，公平锁和非公平锁分别对</span>
        <span class="hljs-comment">// tryAcquire() 进行了不同的重写，addWaiter() 会将当前线程</span>
        <span class="hljs-comment">// 对应的 Node 加入等待双向链表，acquireQueued()可以对排队</span>
        <span class="hljs-comment">// 中的线程进行获取锁的操作</span>
        <span class="hljs-keyword">if</span> (!tryAcquire(arg) &amp;&amp;
                acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
            selfInterrupt();
    }
}
</code></pre>
<p>其中 tryAcquire() 方法在 NonfairSync 和 FairSync 类中也有不同的重写实现，主要区别是 FairSync 中会先判断等待队列中是否有前驱节点，如果有前驱节点说明有线程比当前线程更早获取锁，根据公平性，当前线程获取锁失败。</p>
<p>以上就是 ReentrantLock 中公平锁与非公平锁的区别。</p>
<p>直接从名字就可以看出来， ReentrantLock 是可重入锁。从代码中也可以看到，tryAcquire() 和 nonfairTryAcquire() 方法中判断如果当前线程已经持有了锁，计数加 1 。在 tryRelease() 中计数减1，直到计数为 0 才释放锁，所以使用 ReentrantLock 重复对一个线程加锁并不会导致死锁。</p>
<h4 data-id="heading-2">AbstractQueuedSynchronizer</h4>
<p>Sync 类继承自 AbstractQueuedSynchronizer 类，AbstractQueuedSynchronizer 是什么呢？源码中有十分具体的解释：</p>
<pre><code class="hljs language-java" lang="java">Provides a framework <span class="hljs-keyword">for</span> implementing blocking locks and related <span class="hljs-title function_">synchronizers</span> <span class="hljs-params">(semaphores, events, etc)</span> that
rely on first-in-first-out (FIFO) wait queues. This <span class="hljs-keyword">class</span> <span class="hljs-title class_">is</span> designed to be a useful basis <span class="hljs-keyword">for</span> most kinds of
synchronizers that rely on a single atomic <span class="hljs-type">int</span> value to represent state. Subclasses must define the <span class="hljs-keyword">protected</span>
methods that change <span class="hljs-built_in">this</span> state, and which define what that state means in terms of <span class="hljs-built_in">this</span> object being acquired
or released. Given these, the other methods in <span class="hljs-built_in">this</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">carry</span> out all queuing and blocking mechanics.
Subclasses can maintain other state fields, but only the atomically updated <span class="hljs-type">int</span> value manipulated using
methods getState, setState and compareAndSetState is tracked with respect to synchronization

Subclasses should be defined as non-<span class="hljs-keyword">public</span> internal helper classes that are used to implement the
synchronization properties of their enclosing class. Class AbstractQueuedSynchronizer does not implement
any synchronization interface. Instead it defines methods such as acquireInterruptibly that can be invoked
as appropriate by concrete locks and related synchronizers to implement their <span class="hljs-keyword">public</span> methods.

This <span class="hljs-keyword">class</span> <span class="hljs-title class_">supports</span> either or both a <span class="hljs-keyword">default</span> exclusive mode and a shared mode. When acquired in exclusive
mode, attempted acquires by other threads cannot succeed. Shared mode acquires by multiple threads <span class="hljs-title function_">may</span>
<span class="hljs-params">(but need not)</span> succeed. This <span class="hljs-keyword">class</span> <span class="hljs-title class_">does</span> not <span class="hljs-string">"understand"</span> these differences except in the mechanical sense
that when a shared mode acquire succeeds, the next waiting <span class="hljs-title function_">thread</span> <span class="hljs-params">(<span class="hljs-keyword">if</span> one exists)</span> must also determine whether
it can acquire as well. Threads waiting in the different modes share the same FIFO queue. Usually,
implementation subclasses support only one of these modes, but both can come into play <span class="hljs-keyword">for</span> example in a
ReadWriteLock. Subclasses that support only exclusive or only shared modes need not define the methods supporting the unused mode.
</code></pre>
<p>AbstractQueuedSynchronizer 是用来实现锁和相关同步器（信号量、事件等）的基础框架，它的实现主要依赖一个 atomic int 成员变量表示的同步状态和一个 FIFO 队列构成的等待队列。子类必须重写 AQS 的 protected 修饰的用来改变同步状态的方法， AQS 的其他几个方法实现了排队和阻塞机制。子类可以维护其他状态字段，但是建议更新同步状态使用 getState() 、 setState() 以及 compareAndSetState() 这三个方法。</p>
<p>子类应定义为非公共内部帮助类用于实现其封闭类的同步属性，AQS 自身没有实现任何同步接口，它定义了 acquireInterruptibly() 这类方法，它可以被具体的锁和相关同步器里面的公共方法调用。</p>
<p>该类支持默认的独占式获取同步状态和共享式获取同步状态的两者或者之一，这样就可以方便的实现不同类型的同步组件。</p>
<p><strong>什么是独占锁？什么是共享锁？</strong><br/>
独占锁也叫排它锁，是指该锁一次只能被一个线程持有，如果别的线程想要获取锁，只有等到持有锁的线程释放锁。<strong>获得排它锁的线程既能读取数据又能修改数据</strong>，与之对立的就是共享锁。共享锁是指该锁可被多个线程所持有。如果线程T对数据A加上共享锁后，则其他线程只能对A再加共享锁，不能加排它锁。<strong>获得共享锁的线程只能读数据，不能修改数据</strong>。</p>
<p>AQS 使用了模板方法设计模式，子类必须重写 AQS 的 protected 修饰的用来改变同步状态的方法，还要在自己的 public 方法中调用 acquireInterruptibly() 这类模板方法。例如 AQS 中的tryAcquire(int arg)方法就是一个被 protected 修饰的用来改变同步状态的方法，在前面的代码中可以看到 ReentrantLock 的 FairSync 和 NonfairSync 对 tryAcquire(int arg) 方法进行了对不同的重写，而 acquireInterruptibly(int arg) 则被 ReentrantLock 中的 lockInterruptibly() 的 public 方法调用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
    sync.acquireInterruptibly(<span class="hljs-number">1</span>);
}
</code></pre>
<p>其中 AQS 可以重写的方法如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Attempts to acquire in exclusive mode. This method should query
 * if the state of the object permits it to be acquired in the
 * exclusive mode, and if so to acquire it.
 * 独占式获取同步状态。该方法应该查询是否允许独占式获取同步状态，如果可以就使用CAS获取同步状态
 */</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}

<span class="hljs-comment">/**
 * Attempts to set the state to reflect a release in exclusive
 * mode.
 *
 * &lt;p&gt;This method is always invoked by the thread performing release.
 * 独占式释放锁，等待获取同步状态的线程将有机会获取同步状态
 */</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}

<span class="hljs-comment">/**
 * Attempts to acquire in shared mode. This method should query if
 * the state of the object permits it to be acquired in the shared
 * mode, and if so to acquire it.
 *
 * &lt;p&gt;This method is always invoked by the thread performing
 * acquire. If this method reports failure, the acquire method
 * may queue the thread, if it is not already queued, until it is
 * signalled by a release from some other thread.
 *
 * &lt;p&gt;The default implementation throws {<span class="hljs-doctag">@link</span>
 * UnsupportedOperationException}.
 * 共享式获取同步状态，返回值大于等于0表示获取成功，反之获取失败
 */</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">tryAcquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}

<span class="hljs-comment">/**
 * Attempts to set the state to reflect a release in shared mode.
 *
 * &lt;p&gt;This method is always invoked by the thread performing release.
 *
 * &lt;p&gt;The default implementation throws
 * {<span class="hljs-doctag">@link</span> UnsupportedOperationException}.
 * 共享式释放同步状态
 */</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryReleaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}

<span class="hljs-comment">/**
 * Returns {<span class="hljs-doctag">@code</span> true} if synchronization is held exclusively with
 * respect to the current (calling) thread. This method is invoked
 * upon each call to a non-waiting {<span class="hljs-doctag">@link</span> ConditionObject} method.
 * (Waiting methods instead invoke {<span class="hljs-doctag">@link</span> #release}.)
 * 同步器是否被当前线程独占
 */</span>
<span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldExclusively</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnsupportedOperationException</span>();
}
</code></pre>
<p>AQS 提供的模板方法如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Acquires in exclusive mode, ignoring interrupts. Implemented
 * by invoking at least once {<span class="hljs-doctag">@link</span> #tryAcquire},
 * returning on success. Otherwise the thread is queued, possibly
 * repeatedly blocking and unblocking, invoking {<span class="hljs-doctag">@link</span>
 * #tryAcquire} until success. This method can be used
 * to implement method {<span class="hljs-doctag">@link</span> Lock#lock}.
 * 独占式获取同步状态，如果成功直接结束，如果失败线程将会进入同步队列中等待，该方法会调用重写的
 * tryAcquire()方法
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (!tryAcquire(arg) &amp;&amp;
            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
        selfInterrupt();
}

<span class="hljs-comment">/**
 * Acquires in exclusive mode, aborting if interrupted.
 * Implemented by first checking interrupt status, then invoking
 * at least once {<span class="hljs-doctag">@link</span> #tryAcquire}, returning on
 * success. Otherwise the thread is queued, possibly repeatedly
 * blocking and unblocking, invoking {<span class="hljs-doctag">@link</span> #tryAcquire}
 * until success or the thread is interrupted. This method can be
 * used to implement method {<span class="hljs-doctag">@link</span> Lock#lockInterruptibly}.
 * 与acquire(int arg)相同，但该方法可以响应中断，被中断时抛出InterruptedException
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireInterruptibly</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span>
        <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-keyword">if</span> (Thread.interrupted())
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();
    <span class="hljs-keyword">if</span> (!tryAcquire(arg))
        doAcquireInterruptibly(arg);
}

<span class="hljs-comment">/**
 * Attempts to acquire in exclusive mode, aborting if interrupted,
 * and failing if the given timeout elapses. Implemented by first
 * checking interrupt status, then invoking at least once {<span class="hljs-doctag">@link</span>
 * #tryAcquire}, returning on success. Otherwise, the thread is
 * queued, possibly repeatedly blocking and unblocking, invoking
 * {<span class="hljs-doctag">@link</span> #tryAcquire} until success or the thread is interrupted
 * or the timeout elapses. This method can be used to implement
 * method {<span class="hljs-doctag">@link</span> Lock#tryLock(long, TimeUnit)}.
 * 在InterruptedException(int arg)基础上增加了超时限制，如果当前线程在超时时间内
 * 没有获取到同步状态，将会返回false，获取到了返回true
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquireNanos</span><span class="hljs-params">(<span class="hljs-type">int</span> arg, <span class="hljs-type">long</span> nanosTimeout)</span>
        <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-keyword">if</span> (Thread.interrupted())
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();
    <span class="hljs-keyword">return</span> tryAcquire(arg) ||
            doAcquireNanos(arg, nanosTimeout);
}


<span class="hljs-comment">/**
 * Acquires in shared mode, ignoring interrupts. Implemented by
 * first invoking at least once {<span class="hljs-doctag">@link</span> #tryAcquireShared},
 * returning on success. Otherwise the thread is queued, possibly
 * repeatedly blocking and unblocking, invoking {<span class="hljs-doctag">@link</span>
 * #tryAcquireShared} until success.
 * 共享式的获取同步状态，如果当前线程没有获取到同步状态，将会进入同步队列中
 * 等待，与独占式获取的主要区别是在同一时刻可以有多个线程获取同步状态
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (tryAcquireShared(arg) &lt; <span class="hljs-number">0</span>)
        doAcquireShared(arg);
}

<span class="hljs-comment">/**
 * Acquires in shared mode, aborting if interrupted. Implemented
 * by first checking interrupt status, then invoking at least once
 * {<span class="hljs-doctag">@link</span> #tryAcquireShared}, returning on success. Otherwise the
 * thread is queued, possibly repeatedly blocking and unblocking,
 * invoking {<span class="hljs-doctag">@link</span> #tryAcquireShared} until success or the thread
 * is interrupted.
 * 与acquireShared(int arg)相同，该方法响应中断
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquireSharedInterruptibly</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span>
        <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-keyword">if</span> (Thread.interrupted())
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();
    <span class="hljs-keyword">if</span> (tryAcquireShared(arg) &lt; <span class="hljs-number">0</span>)
        doAcquireSharedInterruptibly(arg);
}

<span class="hljs-comment">/**
 * Attempts to acquire in shared mode, aborting if interrupted, and
 * failing if the given timeout elapses. Implemented by first
 * checking interrupt status, then invoking at least once {<span class="hljs-doctag">@link</span>
 * #tryAcquireShared}, returning on success. Otherwise, the
 * thread is queued, possibly repeatedly blocking and unblocking,
 * invoking {<span class="hljs-doctag">@link</span> #tryAcquireShared} until success or the thread
 * is interrupted or the timeout elapses.
 * 在acquireSharedInterruptibly(int arg)基础上增加了超时限制
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquireSharedNanos</span><span class="hljs-params">(<span class="hljs-type">int</span> arg, <span class="hljs-type">long</span> nanosTimeout)</span>
        <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-keyword">if</span> (Thread.interrupted())
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterruptedException</span>();
    <span class="hljs-keyword">return</span> tryAcquireShared(arg) &gt;= <span class="hljs-number">0</span> ||
            doAcquireSharedNanos(arg, nanosTimeout);
}

<span class="hljs-comment">/**
 * Releases in exclusive mode. Implemented by unblocking one or
 * more threads if {<span class="hljs-doctag">@link</span> #tryRelease} returns true.
 * This method can be used to implement method {<span class="hljs-doctag">@link</span> Lock#unlock}.
 * 独占式的释放同步状态，该方法会在释放同步状态之后，将队头节点
 * 的线程唤醒
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">release</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (tryRelease(arg)) {
        <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> head;
        <span class="hljs-keyword">if</span> (h != <span class="hljs-literal">null</span> &amp;&amp; h.waitStatus != <span class="hljs-number">0</span>)
            unparkSuccessor(h);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">/**
 * Releases in shared mode. Implemented by unblocking one or more
 * threads if {<span class="hljs-doctag">@link</span> #tryReleaseShared} returns true.
 * 共享式的释放同步状态
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">releaseShared</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> {
    <span class="hljs-keyword">if</span> (tryReleaseShared(arg)) {
        doReleaseShared();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-comment">/**
 * Returns the first (longest-waiting) thread in the queue, or
 * {<span class="hljs-doctag">@code</span> null} if no threads are currently queued.
 *
 * &lt;p&gt;In this implementation, this operation normally returns in
 * constant time, but may iterate upon contention if other threads are
 * concurrently modifying the queue.
 * 获取等待在同步队列上的线程集合
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Thread <span class="hljs-title function_">getFirstQueuedThread</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// handle only fast path, else relay</span>
    <span class="hljs-keyword">return</span> (head == tail) ? <span class="hljs-literal">null</span> : fullGetFirstQueuedThread();
}
</code></pre>
<p>AQS 提供的模板方法可以分为3类：</p>
<ol>
<li>独占式获取与释放同步状态；</li>
<li>共享式获取与释放同步状态；</li>
<li>查询同步队列中等待线程情况；</li>
</ol>
<p>源码中有一个例子可以帮助我们理解如何使用 AQS 实现自己的同步锁，这个例子是一个不可重入互斥锁类，用 0 表示解锁状态，1 表示表示锁定状态：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Mutex</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Lock</span>, java.io.Serializable {

    <span class="hljs-comment">// Our internal helper class</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> {
        <span class="hljs-comment">// Reports whether in locked state</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldExclusively</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> getState() == <span class="hljs-number">1</span>;
        }

        <span class="hljs-comment">// Acquires the lock if state is zero</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> acquires)</span> {
            <span class="hljs-keyword">assert</span> acquires == <span class="hljs-number">1</span>; <span class="hljs-comment">// Otherwise unused</span>
            <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) {
                setExclusiveOwnerThread(Thread.currentThread());
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-comment">// Releases the lock by setting state to zero</span>
        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> releases)</span> {
            <span class="hljs-keyword">assert</span> releases == <span class="hljs-number">1</span>; <span class="hljs-comment">// Otherwise unused</span>
            <span class="hljs-keyword">if</span> (getState() == <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();
            setExclusiveOwnerThread(<span class="hljs-literal">null</span>);
            setState(<span class="hljs-number">0</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-comment">// Provides a Condition</span>
        Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConditionObject</span>();
        }

        <span class="hljs-comment">// Deserializes properly</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream s)</span>
                <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException {
            s.defaultReadObject();
            setState(<span class="hljs-number">0</span>); <span class="hljs-comment">// reset to unlocked state</span>
        }
    }

    <span class="hljs-comment">// The sync object does all the hard work. We just forward to it.</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Sync</span> <span class="hljs-variable">sync</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> {
        sync.acquire(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sync.tryAcquire(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> {
        sync.release(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> Condition <span class="hljs-title function_">newCondition</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sync.newCondition();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLocked</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sync.isHeldExclusively();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasQueuedThreads</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sync.hasQueuedThreads();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lockInterruptibly</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        sync.acquireInterruptibly(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span>
            <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-keyword">return</span> sync.tryAcquireNanos(<span class="hljs-number">1</span>, unit.toNanos(timeout));
    }

}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MutexDemo</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Mutex</span> <span class="hljs-variable">mutex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Mutex</span>();

    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increase</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">10000</span>; j++) {
            count++; <span class="hljs-comment">//count++不具备原子性</span>
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            mutex.lock();
            <span class="hljs-keyword">try</span> {
                increase();
            } <span class="hljs-keyword">finally</span> {
                mutex.unlock();
            }

        });
        thread1.start();


        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            mutex.lock();
            <span class="hljs-keyword">try</span> {
                increase();
            } <span class="hljs-keyword">finally</span> {
                mutex.unlock();
            }

        });
        thread2.start();

        <span class="hljs-keyword">try</span> {
            thread1.join();
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }

        <span class="hljs-keyword">try</span> {
            thread2.join();
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }

        System.out.println(<span class="hljs-string">"the count is： "</span> + count);
    }

}
</code></pre>
<p>打印结果为：</p>
<pre><code class="hljs language-java" lang="java">the count is： <span class="hljs-number">20000</span>
</code></pre>
<p>由于 count++ 不具备原子性，它是先把 count 加 1 然后再写入新的 count 值。如果不添加锁，打印出来的值很大可能小于20000。</p>
<p>从这个例子可以看到，使用AQS可以很方便地实现同步组件。</p>
<h4 data-id="heading-3">ReentrantLock 的优势</h4>
<p><code>ReentrantLock</code> 提供了比 <code>synchronized</code> 关键字更灵活的锁定机制，可以在以下情况下优先于 <code>synchronized</code> 使用：</p>
<ol>
<li><strong>需要显式的锁定和解锁</strong>： <code>ReentrantLock</code> 允许你显式地获取和释放锁，提供了比 <code>synchronized</code> 更细粒度的控制。<strong>你可以在不同的方法或代码块中获取和释放同一个锁，而不像 <code>synchronized</code> 必须在同一个代码块中释放</strong>。</li>
<li><strong>需要尝试锁定</strong>： 使用 <code>ReentrantLock</code> 时可以调用 <code>tryLock()</code> 方法，尝试获取锁而不会一直阻塞。如果锁被其他线程持有，<code>tryLock()</code> 可以返回 <code>false</code>，允许你根据情况采取其他操作。</li>
<li><strong>需要可中断的锁</strong>： <code>ReentrantLock</code> 提供了 <code>lockInterruptibly()</code> 方法，使得线程可以在等待获取锁时响应中断请求。<code>synchronized</code> 则无法响应中断，线程只能一直阻塞，直到获取锁。</li>
<li><strong>需要公平锁</strong>： <code>ReentrantLock</code> 提供了公平锁的机制（通过构造方法 <code>new ReentrantLock(true)</code>），这意味着锁将按照线程请求的顺序进行分配，而 <code>synchronized</code> 是非公平的，线程获取锁的顺序可能无法预测。</li>
<li><strong>需要多条件等待</strong>： <code>ReentrantLock</code> 支持多个 <code>Condition</code> 对象，允许线程基于不同的条件来等待和通知，增强了灵活性。相比之下，<code>synchronized</code> 只能使用单个 <code>wait()</code> 和 <code>notify()</code> 机制来进行线程间的通信。</li>
<li><strong>性能需求</strong>： 在某些高并发场景下，<code>ReentrantLock</code> 的性能可能会优于 <code>synchronized</code>。它的实现更加优化，减少了锁争用的开销。</li>
</ol>
<p>总的来说，<code>ReentrantLock</code> 适用于需要更灵活锁定机制、更多控制权或者更复杂并发控制场景的情况。对于简单的同步需求，<code>synchronized</code> 关键字依然是首选，因为它更简洁，且在绝大多数场景中性能表现良好。</p>
<p>假设我们有一个任务系统，其中多个线程尝试执行一项关键任务。我们希望：</p>
<ol>
<li>线程在等待获取锁时有一个超时时间，如果超过这个时间未能获取锁，则执行其他操作或退出。</li>
<li>线程在等待锁时可以被中断，而不必一直等待。</li>
</ol>
<p>在这种情况下，<code>synchronized</code> 无法提供这样的灵活性，但 <code>ReentrantLock</code> 可以通过 <code>tryLock()</code> 和 <code>lockInterruptibly()</code> 方法来实现。</p>
<p>看如下代码示例：使用 <code>ReentrantLock</code> 实现超时和响应中断</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CriticalTask</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();

    <span class="hljs-comment">// 任务方法，尝试在超时内获取锁</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performTask</span><span class="hljs-params">(String threadName)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 尝试在 2 秒内获取锁，超时则返回 false</span>
            <span class="hljs-keyword">if</span> (lock.tryLock(<span class="hljs-number">2</span>, TimeUnit.SECONDS)) {
                <span class="hljs-keyword">try</span> {
                    System.out.println(threadName + <span class="hljs-string">" 成功获取锁，正在执行任务..."</span>);
                    <span class="hljs-comment">// 模拟任务执行</span>
                    Thread.sleep(<span class="hljs-number">1000</span>);
                    System.out.println(threadName + <span class="hljs-string">" 任务完成"</span>);
                } <span class="hljs-keyword">finally</span> {
                    lock.unlock(); <span class="hljs-comment">// 释放锁</span>
                    System.out.println(threadName + <span class="hljs-string">" 已释放锁"</span>);
                }
            } <span class="hljs-keyword">else</span> {
                System.out.println(threadName + <span class="hljs-string">" 获取锁超时，无法执行任务"</span>);
            }
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            System.out.println(threadName + <span class="hljs-string">" 被中断，任务中止"</span>);
        }
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">CriticalTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CriticalTask</span>();

        <span class="hljs-comment">// 创建两个线程，模拟并发任务执行</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">t1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; task.performTask(<span class="hljs-string">"线程1"</span>));
        <span class="hljs-type">Thread</span> <span class="hljs-variable">t2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; task.performTask(<span class="hljs-string">"线程2"</span>));

        t1.start();
        t2.start();

        <span class="hljs-comment">// 中断线程t1以模拟中断情况</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">500</span>);
            t1.interrupt(); <span class="hljs-comment">// 中断t1</span>
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>
<p>这里 tryLock(2, TimeUnit.SECONDS) 线程尝试获取锁，但如果在 2 秒内未能获取锁，则会返回 false，从而避免线程永久等待锁的情况。synchronized 无法实现这种超时机制。并且我们在代码中模拟了线程 t1 被中断的情况。如果一个线程在等待锁时被中断，ReentrantLock 的 lockInterruptibly() 方法可以捕获 InterruptedException，从而中止操作并及时响应。synchronized 无法响应中断，线程只能一直阻塞直到锁被释放。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[容器运维：不同平台下 Docker/Podman 网问题配置速查]]></title>    <link>https://juejin.cn/post/7598472744480686099</link>    <guid>https://juejin.cn/post/7598472744480686099</guid>    <pubDate>2026-01-24T08:02:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598472744480686099" data-draft-id="7598480413803446314" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="容器运维：不同平台下 Docker/Podman 网问题配置速查"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-24T08:02:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            容器运维：不同平台下 Docker/Podman 网问题配置速查
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T08:02:45.000Z" title="Sat Jan 24 2026 08:02:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言与核心概念</h2>
<p>在特定的网络环境下，配置 Registry Mirror（镜像加速）与 HTTP/HTTPS Proxy（网络代理）是保障容器服务稳定运行的基础工作。本手册旨在提供一套标准化的操作流程，覆盖主流操作系统及特殊网络设备。</p>
<h3 data-id="heading-1">1.1 范围与分组原则</h3>
<p>我们将配置场景分为两大类：</p>
<ul>
<li><strong>镜像加速 (Registry Mirror)</strong>：仅针对 <code>docker pull</code> 操作，作用于 Daemon 层面，通常不涉及鉴权。</li>
<li><strong>通用代理 (HTTP Proxy)</strong>：影响 <code>docker build</code>、<code>docker push</code> 及容器运行时的外网访问。</li>
</ul>
<h3 data-id="heading-2">1.2 安全与合规提示</h3>
<blockquote>
<p><strong>⚠️ 警告</strong></p>
<ul>
<li>
<p><strong>证书信任</strong>：配置私有源或公司代理时，必须确保 CA 证书已导入宿主机及 Docker 信任区。</p>
</li>
<li>
<p><strong>凭证泄露</strong>：严禁将包含账号密码的代理 URL（如 <code>user:pass@proxy</code>）提交到公共代码仓库。</p>
</li>
<li>
<p><strong>NO_PROXY</strong>：务必排除 <code>localhost</code>、<code>127.0.0.1</code> 及内部域名，防止内部流量误走代理导致服务不可达。</p>
</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-3">2. Linux (Systemd) 官方 Docker Engine</h2>
<blockquote>
<p><strong>适用范围</strong>：Ubuntu, Debian, CentOS, Fedora, RHEL, Arch Linux 等标准生产环境。</p>
</blockquote>
<h3 data-id="heading-4">2.1 配置 Registry Mirror (daemon.json)</h3>
<p>镜像源配置位于 <code>/etc/docker/daemon.json</code>。如果文件不存在，请新建。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"registry-mirrors"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"https://mirror.example.com"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"https://docker.company-mirror.com"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"insecure-registries"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"debug"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>

</code></pre>
<h3 data-id="heading-5">2.2 配置 HTTP/HTTPS 代理 (Systemd Override)</h3>
<p>为了让 Docker Daemon 能够通过代理拉取镜像或执行构建，<strong>切勿直接修改</strong> <code>/lib/systemd/system/docker.service</code>，应使用 Systemd Drop-in 机制。</p>
<ol>
<li><strong>创建配置目录</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">mkdir</span> -p /etc/systemd/system/docker.service.d

</code></pre>
<ol start="2">
<li><strong>创建代理配置文件</strong>
编辑 <code>/etc/systemd/system/docker.service.d/proxy.conf</code>：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[Service]</span>
<span class="hljs-attr">Environment</span>=<span class="hljs-string">"HTTP_PROXY=http://192.168.1.100:7890"</span>
<span class="hljs-attr">Environment</span>=<span class="hljs-string">"HTTPS_PROXY=http://192.168.1.100:7890"</span>
<span class="hljs-attr">Environment</span>=<span class="hljs-string">"NO_PROXY=localhost,127.0.0.1,docker-registry.somecorporation.com"</span>

</code></pre>
<ol start="3">
<li><strong>重载并重启</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart docker

</code></pre>
<ol start="4">
<li><strong>验证配置</strong>
运行 <code>docker info</code>，检查输出中的 "Registry Mirrors" 和 "HTTP Proxy" 字段。</li>
</ol>
<hr/>
<h2 data-id="heading-6">3. Podman 配置差异</h2>
<p>Podman 采用无守护进程（Daemonless）架构，其配置逻辑与 Docker 有显著不同。</p>
<h3 data-id="heading-7">3.1 Docker vs Podman 配置对比</h3>






























<table><thead><tr><th>配置项</th><th>Docker</th><th>Podman</th></tr></thead><tbody><tr><td><strong>配置文件格式</strong></td><td>JSON (<code>daemon.json</code>)</td><td>TOML (<code>registries.conf</code>)</td></tr><tr><td><strong>系统级路径</strong></td><td><code>/etc/docker/daemon.json</code></td><td><code>/etc/containers/registries.conf</code></td></tr><tr><td><strong>用户级路径</strong></td><td>不支持 (依赖 Daemon)</td><td><code>~/.config/containers/registries.conf</code></td></tr><tr><td><strong>代理生效方式</strong></td><td>Systemd Service 注入</td><td>直接读取 Shell 环境变量 (CLI)</td></tr></tbody></table>
<h3 data-id="heading-8">3.2 Podman 镜像源配置</h3>
<p>编辑 <code>registries.conf</code>：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># 配置 docker.io 的镜像加速</span>
<span class="hljs-section">[[registry]]</span>
<span class="hljs-attr">prefix</span> = <span class="hljs-string">"docker.io"</span>
<span class="hljs-attr">location</span> = <span class="hljs-string">"docker.io"</span>

<span class="hljs-section">[[registry.mirror]]</span>
<span class="hljs-attr">location</span> = <span class="hljs-string">"mirror.example.com"</span>

<span class="hljs-section">[[registry.mirror]]</span>
<span class="hljs-attr">location</span> = <span class="hljs-string">"docker.mirrors.ustc.edu.cn"</span>

<span class="hljs-comment"># 允许短名称搜索 (如 podman pull alpine)</span>
<span class="hljs-attr">unqualified-search-registries</span> = [<span class="hljs-string">"docker.io"</span>]

</code></pre>
<hr/>
<h2 data-id="heading-9">4. Windows (Docker Desktop) &amp; WSL2</h2>
<h3 data-id="heading-10">4.1 Docker Desktop (GUI)</h3>
<p>Docker Desktop 屏蔽了底层复杂性，推荐优先通过 GUI 配置。</p>
<ol>
<li><strong>设置代理 (Proxy)</strong>：</li>
</ol>
<ul>
<li>进入 <strong>Settings</strong> -&gt; <strong>Resources</strong> -&gt; <strong>Proxies</strong>。</li>
<li>开启 "Manual proxy configuration"。</li>
<li>填入 <code>http://127.0.0.1:7890</code> (假设使用本机 Windows 代理软件)。</li>
</ul>
<ol start="2">
<li><strong>设置镜像 (Docker Engine)</strong>：</li>
</ol>
<ul>
<li>进入 <strong>Settings</strong> -&gt; <strong>Docker Engine</strong>。</li>
<li>在 JSON 编辑器中添加 <code>"registry-mirrors"</code> 字段，内容同 Linux 组配置。</li>
</ul>
<blockquote>
<p><strong>注意</strong>：如果在 WSL2 命令行直接使用 <code>docker</code> 命令（连接 Desktop 后端），上述 GUI 配置会自动生效。</p>
</blockquote>
<h3 data-id="heading-11">4.2 WSL2 原生发行版 (非 Desktop)</h3>
<p>如果你在 WSL2 (Ubuntu/Debian) 内独立安装了 Docker Engine，需注意网络互通问题。</p>
<ul>
<li><strong>网络代理指向</strong>：WSL2 无法直接通过 <code>127.0.0.1</code> 访问 Windows 上的代理。必须使用 <code>host.docker.internal</code>。</li>
<li><strong>Systemd 支持</strong>：确保 <code>/etc/wsl.conf</code> 中已启用 <code>systemd=true</code>。</li>
</ul>
<p>配置示例 (<code>/etc/systemd/system/docker.service.d/proxy.conf</code>)：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[Service]</span>
<span class="hljs-comment"># 注意：host.docker.internal 需要 WSL2 版本支持或手动配置 hosts</span>
<span class="hljs-attr">Environment</span>=<span class="hljs-string">"HTTP_PROXY=http://host.docker.internal:7890"</span>
<span class="hljs-attr">Environment</span>=<span class="hljs-string">"HTTPS_PROXY=http://host.docker.internal:7890"</span>
<span class="hljs-attr">Environment</span>=<span class="hljs-string">"NO_PROXY=localhost,127.0.0.1,*.internal,172.16.0.0/12"</span>

</code></pre>
<hr/>
<h2 data-id="heading-12">5. 特殊环境：NAS 与 路由器</h2>
<h3 data-id="heading-13">5.1 Synology 群晖 (DSM)</h3>
<p>群晖 DSM 对 Docker 路径进行了定制，且升级可能重置配置。</p>
<ul>
<li>
<p><strong>图形界面配置 (推荐)</strong>：</p>
</li>
<li>
<p>打开 <strong>Container Manager</strong> (DSM 7.2+) 或 Docker 套件。</p>
</li>
<li>
<p><strong>Registry</strong>：在设置中选中 Docker Hub -&gt; Edit，启用 "Registry Mirrors" 并填入 URL。</p>
</li>
<li>
<p><strong>Proxy</strong>：通常需在控制面板的网络设置中全局配置。</p>
</li>
<li>
<p><strong>配置文件路径 (SSH)</strong>：</p>
</li>
<li>
<p>标准路径 (DSM 7.2+)：<code>/var/packages/ContainerManager/etc/dockerd.json</code></p>
</li>
<li>
<p>旧版路径：<code>/var/packages/Docker/etc/dockerd.json</code></p>
</li>
<li>
<p>*修改后需重启套件：<code>synopkg restart ContainerManager*</code></p>
</li>
</ul>
<h3 data-id="heading-14">5.2 OpenWrt</h3>
<p>OpenWrt 使用 <code>procd</code> 管理服务。需修改 <code>/etc/init.d/dockerd</code> 脚本。</p>
<p><strong>注入代理环境变量：</strong>
在 <code>start_service()</code> 函数中添加 <code>procd_set_param env</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-function"><span class="hljs-title">start_service</span></span>() {
    procd_open_instance
    procd_set_param <span class="hljs-built_in">command</span> /usr/bin/dockerd
    
    <span class="hljs-comment"># 添加以下行配置代理</span>
    procd_set_param <span class="hljs-built_in">env</span> HTTP_PROXY=http://192.168.1.5:7890
    procd_set_param <span class="hljs-built_in">env</span> HTTPS_PROXY=http://192.168.1.5:7890
    procd_set_param <span class="hljs-built_in">env</span> NO_PROXY=localhost,127.0.0.1
    
    procd_close_instance
}

</code></pre>
<p>*配置完成后重启服务：<code>/etc/init.d/dockerd restart*</code></p>
<hr/>
<h2 data-id="heading-15">6. 验证脚本与故障排查</h2>
<h3 data-id="heading-16">6.1 自动化验证脚本 (Ubuntu/Linux)</h3>
<p>使用以下脚本检测配置是否生效：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"&gt;&gt;&gt; 检查 Docker 服务状态..."</span>
systemctl is-active docker || { <span class="hljs-built_in">echo</span> <span class="hljs-string">"Docker 未运行"</span>; <span class="hljs-built_in">exit</span> 1; }

<span class="hljs-built_in">echo</span> <span class="hljs-string">"&gt;&gt;&gt; 检查 Proxy 环境变量..."</span>
<span class="hljs-comment"># 获取 dockerd 进程的环境变量</span>
PID=$(pgrep -n dockerd)
<span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$PID</span>"</span> ]; <span class="hljs-keyword">then</span> <span class="hljs-built_in">echo</span> <span class="hljs-string">"无法找到 dockerd 进程"</span>; <span class="hljs-built_in">exit</span> 1; <span class="hljs-keyword">fi</span>
sudo <span class="hljs-built_in">cat</span> /proc/<span class="hljs-variable">$PID</span>/environ | <span class="hljs-built_in">tr</span> <span class="hljs-string">'\0'</span> <span class="hljs-string">'\n'</span> | grep -E <span class="hljs-string">'HTTP_PROXY|HTTPS_PROXY|NO_PROXY'</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"&gt;&gt;&gt; 检查 Registry Mirrors..."</span>
docker info --format <span class="hljs-string">'{{json .RegistryConfig.Mirrors}}'</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"&gt;&gt;&gt; 网络连通性测试..."</span>
docker pull hello-world

</code></pre>
<h3 data-id="heading-17">6.2 常见故障排查</h3>
<ol>
<li><strong>JSON 语法错误</strong>：</li>
</ol>
<ul>
<li>现象：Docker 无法启动。</li>
<li>解决：使用 <code>jq . /etc/docker/daemon.json</code> 验证语法，注意末尾逗号。</li>
</ul>
<ol start="2">
<li><strong>代理不可达</strong>：</li>
</ol>
<ul>
<li>现象：Pull 超时。</li>
<li>解决：确保宿主机能 <code>ping</code> 通代理 IP。检查防火墙（ufw/iptables）是否拦截。</li>
</ul>
<ol start="3">
<li><strong>DNS 解析失败</strong>：</li>
</ol>
<ul>
<li>现象：报错 <code>lookup ... no such host</code>。</li>
<li>解决：检查 <code>/etc/resolv.conf</code> 或在 <code>daemon.json</code> 中添加 <code>"dns": ["8.8.8.8"]</code>。</li>
</ul>
<h3 data-id="heading-18">6.3 配置文件路径速查表</h3>





























<table><thead><tr><th>文件用途</th><th>典型路径</th></tr></thead><tbody><tr><td><strong>Docker 镜像配置</strong></td><td><code>/etc/docker/daemon.json</code></td></tr><tr><td><strong>Docker 代理配置</strong></td><td><code>/etc/systemd/system/docker.service.d/proxy.conf</code></td></tr><tr><td><strong>Podman 系统配置</strong></td><td><code>/etc/containers/registries.conf</code></td></tr><tr><td><strong>Podman 用户配置</strong></td><td><code>~/.config/containers/registries.conf</code></td></tr><tr><td><strong>TLS 证书目录</strong></td><td><code>/etc/docker/certs.d/&lt;domain&gt;/ca.crt</code></td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GitHub Issues 集成]]></title>    <link>https://juejin.cn/post/7598532592455630875</link>    <guid>https://juejin.cn/post/7598532592455630875</guid>    <pubDate>2026-01-24T07:55:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598532592455630875" data-draft-id="7598827845964988442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GitHub Issues 集成"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2026-01-24T07:55:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="newbe36524"/> <meta itemprop="url" content="https://juejin.cn/user/2682464104098654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GitHub Issues 集成
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464104098654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    newbe36524
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T07:55:22.000Z" title="Sat Jan 24 2026 07:55:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零构建 GitHub Issues 集成：HagiCode 的前端直连实践</h2>
<blockquote>
<p>本文记录了在 HagiCode 平台中集成 GitHub Issues 的全过程。我们将探讨如何通过"前端直连 + 后端最小化"的架构，在保持后端轻量的同时，实现安全的 OAuth 认证与高效的 Issues 同步。</p>
</blockquote>
<h3 data-id="heading-1">背景：为什么要集成 GitHub？</h3>
<p>HagiCode 作为一个 AI 辅助开发平台，核心价值在于连接想法与实现。但在实际使用中，我们发现用户在 HagiCode 中完成了 Proposal（提案）后，往往需要手动将内容复制到 GitHub Issues 中进行项目跟踪。</p>
<p>这带来了几个明显的痛点：</p>
<ol>
<li><strong>工作流割裂</strong>：用户需要在两个系统之间来回切换，体验不仅不流畅，还容易导致关键信息在复制粘贴的过程中丢失。</li>
<li><strong>协作不便</strong>：团队其他成员习惯在 GitHub 上查看任务，无法直接看到 HagiCode 中的提案进展。</li>
<li><strong>重复劳动</strong>：每当提案更新，就要人工去 GitHub 更新对应的 Issue，增加不必要的维护成本。</li>
</ol>
<p>为了解决这个问题，我们决定引入 <strong>GitHub Issues Integration</strong> 功能，打通 HagiCode 会话与 GitHub 仓库的连接，实现"一键同步"。</p>
<h3 data-id="heading-2">关于 HagiCode</h3>
<blockquote>
<p>嘿，介绍一下我们正在做的东西</p>
</blockquote>
<p>我们正在开发 <strong>HagiCode</strong> —— 一款 AI 驱动的代码智能助手，让开发体验变得更智能、更便捷、更有趣。</p>
<p><strong>智能</strong> —— AI 全程辅助，从想法到代码，让编码效率提升数倍。<strong>便捷</strong> —— 多线程并发操作，充分利用资源，开发流程顺畅无阻。<strong>有趣</strong> —— 游戏化机制和成就系统，让编码不再枯燥，充满成就感。</p>
<p>项目正在快速迭代中，如果你对技术写作、知识管理或者 AI 辅助开发感兴趣，欢迎来 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FHagiCode-org%2Fsite" target="_blank" title="https://github.com/HagiCode-org/site" ref="nofollow noopener noreferrer">GitHub</a> 看看～</p>
<hr/>
<h3 data-id="heading-3">技术选型：前端直连 vs 后端代理</h3>
<p>在设计集成方案时，摆在我们面前的有两条路：传统的"后端代理模式"和更激进的"前端直连模式"。</p>
<h4 data-id="heading-4">方案对比</h4>
<p>在传统的<strong>后端代理模式</strong>中，前端所有的请求都要先经过我们的后端，再由后端去调用 GitHub API。这虽然逻辑集中，但给后端带来了不小的负担：</p>
<ol>
<li><strong>后端臃肿</strong>：需要编写专门的 GitHub API 客户端封装，还要处理 OAuth 的复杂状态机。</li>
<li><strong>Token 风险</strong>：用户的 GitHub Token 必须存储在后端数据库中，虽然可以加密，但毕竟增加了安全风险面。</li>
<li><strong>开发成本</strong>：需要数据库迁移来存储 Token，还需要维护一套额外的同步服务。</li>
</ol>
<p>而<strong>前端直连模式</strong>则要轻量得多。在这个方案中，我们只利用后端来处理最敏感的"密钥交换"环节（OAuth callback），获取到 Token 后，直接存在浏览器的 localStorage 里。后续创建 Issue、更新评论等操作，直接由前端发 HTTP 请求到 GitHub。</p>






























<table><thead><tr><th align="left">对比维度</th><th align="left">后端代理模式</th><th align="left">前端直连模式</th></tr></thead><tbody><tr><td align="left"><strong>后端复杂度</strong></td><td align="left">需要完整的 OAuth 服务和 GitHub API 客户端</td><td align="left">仅需一个 OAuth 回调端点</td></tr><tr><td align="left"><strong>Token 管理</strong></td><td align="left">需加密存储在数据库，有泄露风险</td><td align="left">存储在浏览器，仅用户自己可见</td></tr><tr><td align="left"><strong>实施成本</strong></td><td align="left">需数据库迁移、多服务开发</td><td align="left">主要是前端工作量</td></tr><tr><td align="left"><strong>用户体验</strong></td><td align="left">逻辑统一，但服务器延迟可能稍高</td><td align="left">响应极快，直接与 GitHub 交互</td></tr></tbody></table>
<p>考虑到我们要的是快速集成和最小化后端改动，<strong>最终我们采用了"前端直连模式"</strong>。这就像给浏览器发了一张"临时通行证"，拿到证之后，浏览器就可以自己去 GitHub 办事了，不需要每次都找后端管理员批准。</p>
<hr/>
<h3 data-id="heading-5">核心设计：数据流与安全</h3>
<p>在确定架构后，我们需要设计具体的数据流。整个同步流程的核心在于如何安全地获取 Token 并高效地利用它。</p>
<h4 data-id="heading-6">整体架构图</h4>
<p>整个系统可以抽象为三个角色：浏览器（前端）、HagiCode 后端、GitHub。</p>
<pre><code class="hljs language-text" lang="text">+--------------+        +--------------+        +--------------+
|  前端 React  |        |    后端      |        |    GitHub    |
|              |        |   ASP.NET    |        |    REST API  |
|  +--------+  |        |              |        |              |
|  |  OAuth |--+--------&gt; /callback    |        |              |
|  |  流程  |  |        |              |        |              |
|  +--------+  |        |              |        |              |
|              |        |              |        |              |
|  +--------+  |        |  +--------+  |        |  +--------+  |
|  |GitHub  |  +------------&gt;Session |  +----------&gt; Issues |  |
|  |API     |  |        |  |Metadata|  |        |  |        |  |
|  |直连    |  |        |  +--------+  |        |  +--------+  |
|  +--------+  |        |              |        |              |
+--------------+        +--------------+        +--------------+
</code></pre>
<p><strong>关键点在于</strong>：只有 OAuth 的一小步（获取 code 换 token）需要经过后端，之后的粗活累活（创建 Issue）都是前端直接跟 GitHub 打交道。</p>
<h4 data-id="heading-7">同步数据流详解</h4>
<p>当用户点击 HagiCode 界面上的"Sync to GitHub"按钮时，会发生一系列复杂的动作：</p>
<pre><code class="hljs language-text" lang="text">用户点击 "Sync to GitHub"
         │
         ▼
1. 前端检查 localStorage 获取 GitHub Token
         │
         ▼
2. 格式化 Issue 内容（将 Proposal 转换为 Markdown）
         │
         ▼
3. 前端直接调用 GitHub API 创建/更新 Issue
         │
         ▼
4. 调用 HagiCode 后端 API 更新 Session.metadata (存储 Issue URL 等信息)
         │
         ▼
5. 后端通过 SignalR 广播 SessionUpdated 事件
         │
         ▼
6. 前端接收事件，更新 UI 显示"已同步"状态
</code></pre>
<h4 data-id="heading-8">安全设计</h4>
<p>安全问题始终是集成第三方服务的重中之重。我们做了以下考量：</p>
<ol>
<li><strong>防 CSRF 攻击</strong>：在 OAuth 跳转时，生成随机的 <code>state</code> 参数并存入 sessionStorage。回调时严格验证 state，防止请求被伪造。</li>
<li><strong>Token 存储隔离</strong>：Token 仅存储在浏览器的 <code>localStorage</code> 中，利用同源策略（Same-Origin Policy），只有 HagiCode 的脚本才能读取，避免了服务器端数据库泄露波及用户。</li>
<li><strong>错误边界</strong>：针对 GitHub API 常见的错误（如 401 Token 过期、422 验证失败、429 速率限制），设计了专门的错误处理逻辑，给用户以友好的提示。</li>
</ol>
<hr/>
<h3 data-id="heading-9">实践：代码实现细节</h3>
<p>纸上得来终觉浅，咱们来看看具体的代码是怎么实现的。</p>
<h4 data-id="heading-10">1. 后端最小化改动</h4>
<p>后端只需要做两件事：存储同步信息、处理 OAuth 回调。</p>
<p><strong>数据库变更</strong>
我们只需要在 <code>Sessions</code> 表增加一个 <code>Metadata</code> 列，用来存储 JSON 格式的扩展信息。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 添加 metadata 列到 Sessions 表</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> "Sessions" <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> "Metadata" text <span class="hljs-keyword">NULL</span>;
</code></pre>
<p><strong>实体与 DTO 定义</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// src/HagiCode.DomainServices.Contracts/Entities/Session.cs</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Session</span> : <span class="hljs-title">AuditedAggregateRoot</span>&lt;<span class="hljs-title">SessionId</span>&gt;
{
    <span class="hljs-comment">// ... 其他属性 ...</span>

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> JSON metadata for storing extension data like GitHub integration</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span>? Metadata { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}

<span class="hljs-comment">// DTO 定义，方便前端序列化</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">GitHubIssueMetadata</span>
{
    <span class="hljs-keyword">public</span> required <span class="hljs-built_in">string</span> Owner { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> required <span class="hljs-built_in">string</span> Repo { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> IssueNumber { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> required <span class="hljs-built_in">string</span> IssueUrl { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> DateTime SyncedAt { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">string</span> LastSyncStatus { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-string">"success"</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SessionMetadata</span>
{
    <span class="hljs-keyword">public</span> GitHubIssueMetadata? GitHubIssue { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
}
</code></pre>
<h4 data-id="heading-11">2. 前端 OAuth 流程</h4>
<p>这是连接的入口。我们使用标准的 Authorization Code Flow。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/HagiCode.Client/src/services/githubOAuth.ts</span>

<span class="hljs-comment">// 生成授权 URL 并跳转</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateAuthUrl</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">generateRandomString</span>(); <span class="hljs-comment">// 生成防 CSRF 的随机串</span>
  sessionStorage.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'hagicode_github_state'</span>, state);
  
  <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>({
    <span class="hljs-attr">client_id</span>: clientId,
    <span class="hljs-attr">redirect_uri</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span> + <span class="hljs-string">'/settings?tab=github&amp;oauth=callback'</span>,
    <span class="hljs-attr">scope</span>: [<span class="hljs-string">'repo'</span>, <span class="hljs-string">'public_repo'</span>].<span class="hljs-title function_">join</span>(<span class="hljs-string">' '</span>),
    <span class="hljs-attr">state</span>: state,
  });
  
  <span class="hljs-keyword">return</span> <span class="hljs-string">`https://github.com/login/oauth/authorize?<span class="hljs-subst">${params.toString()}</span>`</span>;
}

<span class="hljs-comment">// 在回调页面处理 Code 换取 Token</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">exchangeCodeForToken</span>(<span class="hljs-params">code: <span class="hljs-built_in">string</span>, state: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">GitHubToken</span>&gt; {
  <span class="hljs-comment">// 1. 验证 State 防止 CSRF</span>
  <span class="hljs-keyword">const</span> savedState = sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'hagicode_github_state'</span>);
  <span class="hljs-keyword">if</span> (state !== savedState) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Invalid state parameter'</span>);

  <span class="hljs-comment">// 2. 调用后端 API 进行 Token 交换</span>
  <span class="hljs-comment">// 注意：这里必须经过后端，因为需要 ClientSecret，不能暴露在前端</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/GitHubOAuth/callback'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ code, state, <span class="hljs-attr">redirectUri</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span> + <span class="hljs-string">'/settings?tab=github&amp;oauth=callback'</span> }),
  });

  <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Failed to exchange token'</span>);
  
  <span class="hljs-keyword">const</span> token = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
  
  <span class="hljs-comment">// 3. 存入 LocalStorage</span>
  <span class="hljs-title function_">saveToken</span>(token);
  <span class="hljs-keyword">return</span> token;
}
</code></pre>
<h4 data-id="heading-12">3. GitHub API 客户端封装</h4>
<p>有了 Token 之后，我们就需要一个强有力的工具来调 GitHub API。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/HagiCode.Client/src/services/githubApiClient.ts</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GITHUB_API_BASE</span> = <span class="hljs-string">'https://api.github.com'</span>;

<span class="hljs-comment">// 核心请求封装</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> githubApi&lt;T&gt;(<span class="hljs-attr">endpoint</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">options</span>: <span class="hljs-title class_">RequestInit</span> = {}): <span class="hljs-title class_">Promise</span>&lt;T&gt; {
  <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'gh_token'</span>);
  <span class="hljs-keyword">if</span> (!token) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Not connected to GitHub'</span>);
  
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${GITHUB_API_BASE}</span><span class="hljs-subst">${endpoint}</span>`</span>, {
    ...options,
    <span class="hljs-attr">headers</span>: {
      ...options.<span class="hljs-property">headers</span>,
      <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>,
      <span class="hljs-title class_">Accept</span>: <span class="hljs-string">'application/vnd.github.v3+json'</span>, <span class="hljs-comment">// 指定 API 版本</span>
    },
  });
  
  <span class="hljs-comment">// 错误处理逻辑</span>
  <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'GitHub Token 失效，请重新连接'</span>);
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">403</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'无权访问该仓库或超出速率限制'</span>);
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> === <span class="hljs-number">422</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Issue 验证失败，可能标题重复'</span>);
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`GitHub API Error: <span class="hljs-subst">${response.statusText}</span>`</span>);
  }
  
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}

<span class="hljs-comment">// 创建 Issue</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createIssue</span>(<span class="hljs-params">owner: <span class="hljs-built_in">string</span>, repo: <span class="hljs-built_in">string</span>, data: { title: <span class="hljs-built_in">string</span>, body: <span class="hljs-built_in">string</span>, labels: <span class="hljs-built_in">string</span>[] }</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">githubApi</span>(<span class="hljs-string">`/repos/<span class="hljs-subst">${owner}</span>/<span class="hljs-subst">${repo}</span>/issues`</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data),
  });
}
</code></pre>
<h4 data-id="heading-13">4. 内容格式化与同步</h4>
<p>最后一步，就是把 HagiCode 的 Session 数据转换成 GitHub Issue 的格式。这有点像"翻译"工作。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 将 Session 对象转换为 Markdown 字符串</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">formatIssueForSession</span>(<span class="hljs-params">session: Session</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">let</span> content = <span class="hljs-string">`# <span class="hljs-subst">${session.title}</span>\n\n`</span>;
  content += <span class="hljs-string">`**&gt; HagiCode Session:** #<span class="hljs-subst">${session.code}</span>\n`</span>;
  content += <span class="hljs-string">`**&gt; Status:** <span class="hljs-subst">${session.status}</span>\n\n`</span>;
  content += <span class="hljs-string">`## Description\n\n<span class="hljs-subst">${session.description || <span class="hljs-string">'No description provided.'</span>}</span>\n\n`</span>;
  
  <span class="hljs-comment">// 如果是 Proposal 类型，添加额外字段</span>
  <span class="hljs-keyword">if</span> (session.<span class="hljs-property">type</span> === <span class="hljs-string">'proposal'</span>) {
    content += <span class="hljs-string">`## Chief Complaint\n\n<span class="hljs-subst">${session.chiefComplaint || <span class="hljs-string">''</span>}</span>\n\n`</span>;
    <span class="hljs-comment">// 添加一个深链接，方便从 GitHub 跳回 HagiCode</span>
    content += <span class="hljs-string">`---\n\n**[View in HagiCode](hagicode://sessions/<span class="hljs-subst">${session.id}</span>)**\n`</span>;
  }
  
  <span class="hljs-keyword">return</span> content;
}

<span class="hljs-comment">// 点击同步按钮的主逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSync</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">session: Session</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> repoInfo = <span class="hljs-title function_">parseRepositoryFromUrl</span>(session.<span class="hljs-property">repoUrl</span>); <span class="hljs-comment">// 解析仓库 URL</span>
    <span class="hljs-keyword">if</span> (!repoInfo) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Invalid repository URL'</span>);

    toast.<span class="hljs-title function_">loading</span>(<span class="hljs-string">'正在同步到 GitHub...'</span>);
    
    <span class="hljs-comment">// 1. 格式化内容</span>
    <span class="hljs-keyword">const</span> issueBody = <span class="hljs-title function_">formatIssueForSession</span>(session);
    
    <span class="hljs-comment">// 2. 调用 API</span>
    <span class="hljs-keyword">const</span> issue = <span class="hljs-keyword">await</span> githubApiClient.<span class="hljs-title function_">createIssue</span>(repoInfo.<span class="hljs-property">owner</span>, repoInfo.<span class="hljs-property">repo</span>, {
      <span class="hljs-attr">title</span>: <span class="hljs-string">`[HagiCode] <span class="hljs-subst">${session.title}</span>`</span>,
      <span class="hljs-attr">body</span>: issueBody,
      <span class="hljs-attr">labels</span>: [<span class="hljs-string">'hagicode'</span>, <span class="hljs-string">'proposal'</span>, <span class="hljs-string">`status:<span class="hljs-subst">${session.status}</span>`</span>],
    });
    
    <span class="hljs-comment">// 3. 更新 Session Metadata (保存 Issue 链接)</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">SessionsService</span>.<span class="hljs-title function_">patchApiSessionsSessionId</span>(session.<span class="hljs-property">id</span>, {
      <span class="hljs-attr">metadata</span>: {
        <span class="hljs-attr">githubIssue</span>: {
          <span class="hljs-attr">owner</span>: repoInfo.<span class="hljs-property">owner</span>,
          <span class="hljs-attr">repo</span>: repoInfo.<span class="hljs-property">repo</span>,
          <span class="hljs-attr">issueNumber</span>: issue.<span class="hljs-property">number</span>,
          <span class="hljs-attr">issueUrl</span>: issue.<span class="hljs-property">html_url</span>,
          <span class="hljs-attr">syncedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
        }
      }
    });

    toast.<span class="hljs-title function_">success</span>(<span class="hljs-string">'同步成功！'</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);
    toast.<span class="hljs-title function_">error</span>(<span class="hljs-string">'同步失败，请检查 Token 或网络'</span>);
  }
};
</code></pre>
<hr/>
<h3 data-id="heading-14">总结与展望</h3>
<p>通过这套"前端直连"方案，我们用最少的后端代码实现了 GitHub Issues 的无缝集成。</p>
<h4 data-id="heading-15">收获</h4>
<ol>
<li><strong>开发效率高</strong>：后端改动极小，主要是数据库加一个字段和一个简单的 OAuth 回调接口，大部分逻辑都在前端完成。</li>
<li><strong>安全性好</strong>：Token 不经过服务器数据库，降低了泄露风险。</li>
<li><strong>用户体验佳</strong>：直接从前端发起请求，响应速度快，不需要经过后端中转。</li>
</ol>
<h4 data-id="heading-16">注意事项</h4>
<p>在实际部署时，有几个坑大家要注意：</p>
<ul>
<li><strong>OAuth App 设置</strong>：记得在 GitHub OAuth App 设置里填正确的 <code>Authorization callback URL</code>（通常是 <code>http://localhost:3000/settings?tab=github&amp;oauth=callback</code>）。</li>
<li><strong>速率限制</strong>：GitHub API 对未认证请求限制较严，但用 Token 后通常足够（5000次/小时）。</li>
<li><strong>URL 解析</strong>：用户输入的 Repo URL 千奇百怪，记得正则要匹配 <code>.git</code> 后缀、SSH 格式等情况。</li>
</ul>
<h4 data-id="heading-17">后续增强</h4>
<p>目前的功能还是单向同步（HagiCode -&gt; GitHub）。未来我们计划通过 GitHub Webhooks 实现双向同步，比如在 GitHub 里关闭 Issue，HagiCode 这边的会话状态也能自动更新。这需要我们在后端暴露一个 Webhook 接收端点，这也是下一步要做的有趣工作。</p>
<p>希望这篇文章能给你的第三方集成开发带来一点灵感！如果有问题，欢迎在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FHagiCode-org%2Fsite" target="_blank" title="https://github.com/HagiCode-org/site" ref="nofollow noopener noreferrer">HagiCode GitHub</a> 上提 Issue 讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Post List、mockjs与axios实战学习笔记]]></title>    <link>https://juejin.cn/post/7598472744480653331</link>    <guid>https://juejin.cn/post/7598472744480653331</guid>    <pubDate>2026-01-24T07:57:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598472744480653331" data-draft-id="7598472744480636947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Post List、mockjs与axios实战学习笔记"/> <meta itemprop="keywords" content="前端,JavaScript,axios"/> <meta itemprop="datePublished" content="2026-01-24T07:57:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="UIUV"/> <meta itemprop="url" content="https://juejin.cn/user/1036168457093483"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Post List、mockjs与axios实战学习笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1036168457093483/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    UIUV
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T07:57:31.000Z" title="Sat Jan 24 2026 07:57:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Post List、mockjs与axios实战学习笔记</h2>
<p>在现代前端开发中，数据请求、模拟数据与状态管理是核心环节。本文基于React+Vite技术栈，结合实战代码，系统梳理Post List数据渲染、axios请求封装、mockjs模拟接口三大模块的相关知识，剖析其技术原理、实现逻辑与开发规范，为前端项目的数据层搭建提供参考。</p>
<h2 data-id="heading-1">一、整体技术背景与核心流程</h2>
<p>本文实战场景为移动端React项目的首页帖子列表（Post List）功能，核心目标是实现“前端请求-模拟数据-状态管理-页面渲染”的完整闭环。在前后端分离架构下，后端接口开发往往滞后于前端页面开发，此时需通过mockjs模拟接口返回数据，同时借助axios封装统一的请求逻辑，再通过Zustand管理全局状态，最终将数据渲染至页面。</p>
<p>核心技术栈：React 18+Vite 5+TypeScript+axios+mockjs+Zustand+TailwindCSS，各技术分工如下：</p>
<ul>
<li><strong>axios</strong>：负责发起HTTP请求，处理请求拦截、响应拦截、错误捕获等逻辑；</li>
<li><strong>mockjs</strong>：在开发环境模拟后端接口，生成随机测试数据，实现前端独立开发；</li>
<li><strong>Zustand</strong>：轻量级全局状态管理库，存储帖子列表数据与加载方法，实现组件间数据共享；</li>
<li><strong>Vite</strong>：通过插件集成mock服务，配置路径别名，优化开发体验；</li>
<li><strong>TypeScript</strong>：定义接口类型（Post、User），实现类型安全，避免数据异常。</li>
</ul>
<p>完整数据流转流程：页面加载时触发useEffect调用loadMore方法 → Zustand调用封装好的fetchPosts接口 → axios发起GET请求 → mockjs拦截请求并返回模拟数据 → axios接收响应并处理 → Zustand更新posts状态 → 页面从状态中读取数据并渲染。</p>
<h2 data-id="heading-2">二、axios：HTTP请求封装与实战</h2>
<h3 data-id="heading-3">2.1 axios核心特性</h3>
<p>axios是一款基于Promise的HTTP客户端，支持浏览器端与Node.js环境，具备以下核心优势：</p>
<ul>
<li>支持请求/响应拦截器，可统一处理请求头、token验证、错误提示等；</li>
<li>自动转换JSON数据，无需手动解析响应体；</li>
<li>支持取消请求、超时设置、请求重试等高级功能；</li>
<li>兼容性良好，可适配不同浏览器与Node.js版本；</li>
<li>支持TypeScript类型推导，与TS项目无缝集成。</li>
</ul>
<h3 data-id="heading-4">2.2 基础配置与封装规范</h3>
<p>在实际项目中，需对axios进行统一封装，避免重复代码，便于维护。核心封装要点包括：基础路径设置、请求头配置、错误统一处理、类型定义等。</p>
<h4 data-id="heading-5">2.2.1 基础配置实现</h4>
<p>代码中对axios的基础配置如下，位于<code>src/api/config.ts</code>（或对应文件）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
<span class="hljs-comment">// 接口地址都以/api开始</span>
axios.<span class="hljs-property">defaults</span>.<span class="hljs-property">baseURL</span> = <span class="hljs-string">'http://localhost:5173/api'</span>
<span class="hljs-comment">// 生产环境可切换为真实后端地址</span>
<span class="hljs-comment">// axios.defaults.baseURL = 'http://douyin.com:5173/api'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> axios;
</code></pre>
<p>关键配置说明：</p>
<ul>
<li><code>baseURL</code>：设置请求基础路径，后续请求URL可省略基础部分，简化代码。开发环境指向本地Vite服务（配合mockjs），生产环境切换为后端真实接口地址；</li>
<li>可扩展配置：如设置超时时间（<code>timeout: 5000</code>）、默认请求头（<code>headers: {'Content-Type': 'application/json'}</code>）等。</li>
</ul>
<h4 data-id="heading-6">2.2.2 接口函数封装</h4>
<p>针对具体业务接口，封装独立的请求函数，便于复用与维护。以帖子列表请求为例，代码位于<code>src/api/posts.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'./config'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Post</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchPosts</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
    page: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>,
    limit: <span class="hljs-built_in">number</span> = <span class="hljs-number">10</span>,
</span>) =&gt; {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/posts'</span>, {
            <span class="hljs-attr">params</span>: {
                page,
                limit,
            }
        });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'获取帖子列表成功'</span>, response);
        <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取帖子列表失败'</span>, error);
        <span class="hljs-keyword">throw</span> error;
    }
};
</code></pre>
<p>封装要点与最佳实践：</p>
<ul>
<li><strong>TypeScript类型约束</strong>：导入Post类型，明确返回数据结构，实现类型安全。参数page、limit设置默认值，避免调用时传参遗漏；</li>
<li><strong>异步处理</strong>：使用async/await语法，替代Promise.then()，代码更简洁易读；</li>
<li><strong>错误捕获</strong>：通过try/catch捕获请求异常，打印错误日志便于排查问题，同时通过throw error向上层抛出异常，由调用方决定后续处理（如提示用户）；</li>
<li><strong>参数传递</strong>：GET请求通过params属性传递查询参数（page、limit），axios会自动将其拼接为URL查询字符串（如<code>/api/posts?page=1&amp;limit=10</code>）；POST请求可通过data属性传递请求体。</li>
</ul>
<h4 data-id="heading-7">2.3 进阶扩展：请求/响应拦截器</h4>
<p>实际项目中，需通过拦截器实现全局统一逻辑，例如请求时添加token、响应时统一处理错误状态码等。以下为常见拦截器配置示例，可集成到axios基础配置中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 请求拦截器</span>
axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
    <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
        <span class="hljs-comment">// 给每个请求添加token</span>
        <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>);
        <span class="hljs-keyword">if</span> (token) {
            config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
        }
        <span class="hljs-keyword">return</span> config;
    },
    <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-comment">// 请求发起前的错误处理（如参数验证失败）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
    }
);

<span class="hljs-comment">// 响应拦截器</span>
axios.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
    <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
        <span class="hljs-comment">// 统一处理响应数据，只返回data部分</span>
        <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
    },
    <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
        <span class="hljs-comment">// 统一处理错误状态码</span>
        <span class="hljs-keyword">const</span> status = error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span>;
        <span class="hljs-keyword">switch</span> (status) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">401</span>:
                <span class="hljs-comment">// 未授权，跳转登录页</span>
                <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">404</span>:
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'接口不存在'</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">500</span>:
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'服务器内部错误'</span>);
                <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
    }
);
</code></pre>
<p>拦截器的核心价值在于“集中处理”，减少重复代码，提升项目可维护性。</p>
<h2 data-id="heading-8">三、mockjs：前端模拟接口与测试数据生成</h2>
<h3 data-id="heading-9">3.1 mockjs的核心作用</h3>
<p>在前后端分离开发模式中，前端开发常依赖后端接口，但后端接口开发、联调往往需要一定时间。此时mockjs可实现以下功能：</p>
<ul>
<li>模拟后端接口，拦截前端请求，返回自定义模拟数据，使前端无需等待后端接口完成即可独立开发；</li>
<li>生成大量随机测试数据，覆盖不同场景（如分页、异常状态），便于测试页面渲染效果；</li>
<li>与真实接口格式一致，开发完成后只需切换baseURL即可无缝对接后端，无需修改业务代码。</li>
</ul>
<h3 data-id="heading-10">3.2 Vite集成mock服务</h3>
<p>Vite通过<code>vite-plugin-mock</code>插件集成mock服务，实现开发环境下的接口模拟。配置步骤如下：</p>
<h4 data-id="heading-11">3.2.1 安装依赖</h4>
<pre><code class="hljs language-css" lang="css">npm install mockjs vite-plugin-mock <span class="hljs-attr">--save-dev</span>
</code></pre>
<h4 data-id="heading-12">3.2.2 Vite配置文件修改</h4>
<p>在<code>vite.config.ts</code>中配置mock服务，指定mock文件路径：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>
<span class="hljs-keyword">import</span> tailwindcss <span class="hljs-keyword">from</span> <span class="hljs-string">'@tailwindcss/vite'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>
<span class="hljs-keyword">import</span> { viteMockServe } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-mock'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">react</span>(), 
    <span class="hljs-title function_">tailwindcss</span>(), 
    <span class="hljs-title function_">viteMockServe</span>({
      <span class="hljs-attr">mockPath</span>: <span class="hljs-string">'mock'</span>, <span class="hljs-comment">// 指定mock文件存放目录</span>
      <span class="hljs-attr">localEnabled</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开发环境启用mock</span>
      <span class="hljs-attr">prodEnabled</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 生产环境禁用mock</span>
    })
  ],
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>), <span class="hljs-comment">// 路径别名，简化导入</span>
    }
  }
});
</code></pre>
<p>关键配置说明：</p>
<ul>
<li><code>mockPath</code>：指定mock配置文件的存放目录（本文为项目根目录下的mock文件夹）；</li>
<li><code>localEnabled</code>：控制开发环境是否启用mock服务，设为true即可在开发时使用模拟接口；</li>
<li><code>prodEnabled</code>：生产环境需禁用mock，避免模拟数据干扰真实接口。</li>
</ul>
<h3 data-id="heading-13">3.3 mockjs语法与接口模拟实现</h3>
<h4 data-id="heading-14">3.3.1 mock文件结构规范</h4>
<p>在mock目录下创建<code>posts.js</code>文件，用于定义帖子列表接口的模拟规则。mockjs的核心语法包括“数据模板定义”与“接口配置”两部分。</p>
<h4 data-id="heading-15">3.3.2 数据模板定义：生成随机测试数据</h4>
<p>mockjs通过特定语法生成随机数据，支持中文、数字、日期、图片等多种类型，核心语法如下：</p>
<ul>
<li><code>'属性名|规则': 值</code>：定义数据生成规则，如<code>'list|45': []</code>表示生成长度为45的list数组；</li>
<li>占位符<code>@xxx</code>：生成随机数据，如<code>@ctitle(8,20)</code>生成8-20字的中文标题，<code>@integer(1,30)</code>生成1-30的随机整数；</li>
<li>自定义函数：可通过函数返回动态数据，如tags字段通过<code>() =&gt; Mock.Random.pick(tags,2)</code>从标签数组中随机选取2个。</li>
</ul>
<p>帖子列表模拟数据生成代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Mock</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'mockjs'</span>
<span class="hljs-keyword">const</span> tags = [<span class="hljs-string">'前端'</span>,<span class="hljs-string">'后端'</span>,<span class="hljs-string">'职场'</span>,<span class="hljs-string">'AI'</span>,<span class="hljs-string">'副业'</span>,<span class="hljs-string">'面经'</span>,<span class="hljs-string">'算法'</span>];
<span class="hljs-keyword">const</span> posts = <span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>({
    <span class="hljs-string">'list|45'</span>:[ <span class="hljs-comment">// 生成45条帖子数据</span>
        {
            <span class="hljs-attr">title</span>: <span class="hljs-string">'@ctitle(8,20)'</span>, <span class="hljs-comment">// 中文标题（8-20字）</span>
            <span class="hljs-attr">brief</span>: <span class="hljs-string">'@ctitle(20,100)'</span>, <span class="hljs-comment">// 中文摘要（20-100字）</span>
            <span class="hljs-attr">totalComments</span>: <span class="hljs-string">'@integer(1,30)'</span>, <span class="hljs-comment">// 评论数（1-30）</span>
            <span class="hljs-attr">totalLikes</span>: <span class="hljs-string">'@integer(0,500)'</span>, <span class="hljs-comment">// 点赞数（0-500）</span>
            <span class="hljs-attr">publishedAt</span>: <span class="hljs-string">'@datetime("yyyy-MM-dd HH:mm:ss")'</span>, <span class="hljs-comment">// 发布时间</span>
            <span class="hljs-attr">user</span>: {
                <span class="hljs-attr">id</span>: <span class="hljs-string">'@integer(1,100)'</span>,
                <span class="hljs-attr">name</span>: <span class="hljs-string">'@cname()'</span>, <span class="hljs-comment">// 中文姓名</span>
                <span class="hljs-attr">avatar</span>: <span class="hljs-string">'@image(300x200)'</span> <span class="hljs-comment">// 随机图片（300x200）</span>
            },
            <span class="hljs-attr">tags</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Mock</span>.<span class="hljs-property">Random</span>.<span class="hljs-title function_">pick</span>(tags,<span class="hljs-number">2</span>), <span class="hljs-comment">// 随机2个标签</span>
            <span class="hljs-attr">thumbnail</span>: <span class="hljs-string">'@image(300x200)'</span>, <span class="hljs-comment">// 缩略图</span>
            <span class="hljs-attr">pics</span>: [
                <span class="hljs-string">'@image(300x200)'</span>,
                <span class="hljs-string">'@image(300x200)'</span>,
                <span class="hljs-string">'@image(300x200)'</span>,
            ],
            <span class="hljs-attr">id</span>: <span class="hljs-string">'@integer(1,1000000)'</span>, <span class="hljs-comment">// 唯一ID</span>
        }
    ]
}).<span class="hljs-property">list</span>; <span class="hljs-comment">// 提取list数组</span>
</code></pre>
<h4 data-id="heading-16">3.3.3 接口配置：拦截请求并返回数据</h4>
<p>通过配置url、method、response，实现对指定接口的拦截与响应。核心逻辑包括请求参数解析、分页处理、响应格式返回：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
    {
        url: <span class="hljs-string">'/api/posts'</span>, <span class="hljs-comment">// 匹配前端请求的URL（需与axios请求路径一致）</span>
        method: <span class="hljs-string">'get'</span>, <span class="hljs-comment">// 请求方法（GET/POST等）</span>
        <span class="hljs-comment">// response函数：处理请求并返回响应数据</span>
        response: ({ query }, res) =&gt; {
            console.<span class="hljs-built_in">log</span>(query); <span class="hljs-comment">// 打印请求参数（page、limit）</span>
            <span class="hljs-type">const</span> { page = <span class="hljs-string">'1'</span> , limit = <span class="hljs-string">'10'</span> } = query;
            <span class="hljs-comment">// 将字符串参数转换为数字（前端传参可能为字符串，需处理类型）</span>
            <span class="hljs-type">const</span> currentPage = <span class="hljs-built_in">Number</span>(page, <span class="hljs-number">10</span>);
            <span class="hljs-type">const</span> size = <span class="hljs-built_in">parseInt</span>(limit, <span class="hljs-number">10</span>);
            
            <span class="hljs-comment">// 参数合法性校验</span>
            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">isNaN</span>(currentPage) || <span class="hljs-built_in">isNaN</span>(size) || currentPage &lt; <span class="hljs-number">1</span> || size &lt; <span class="hljs-number">1</span>){
                <span class="hljs-keyword">return</span> {
                    code: <span class="hljs-number">400</span>,
                    msg: <span class="hljs-string">'Invalid page or pageSize'</span>,
                    data: null
                };
            }

            <span class="hljs-comment">// 分页逻辑计算</span>
            <span class="hljs-type">const</span> total = posts.length; <span class="hljs-comment">// 总数据量</span>
            <span class="hljs-type">const</span> start = (currentPage - <span class="hljs-number">1</span>) * size; <span class="hljs-comment">// 起始索引</span>
            <span class="hljs-type">const</span> end = start + size; <span class="hljs-comment">// 结束索引</span>
            <span class="hljs-type">const</span> paginatedData = posts.<span class="hljs-built_in">slice</span>(start, end); <span class="hljs-comment">// 截取当前页数据</span>

            <span class="hljs-comment">// 返回响应结果（与后端接口格式一致）</span>
            <span class="hljs-keyword">return</span> {
                code: <span class="hljs-number">200</span>,
                msg: <span class="hljs-string">'success'</span>,
                items: paginatedData,
                pagination: {
                    current: currentPage,
                    limit: size,
                    total,
                    totalPages: Math.<span class="hljs-built_in">ceil</span>(total / size), <span class="hljs-comment">// 总页数</span>
                }
            };
        }
    }
];
</code></pre>
<p>接口模拟关键要点：</p>
<ul>
<li><strong>URL匹配</strong>：url需与axios请求的URL完全一致（含baseURL前缀），确保请求被正确拦截；</li>
<li><strong>参数处理</strong>：GET请求参数从query中获取，需注意类型转换（前端传参可能为字符串，需转为数字），同时进行合法性校验，返回对应错误信息；</li>
<li><strong>分页逻辑</strong>：通过slice方法截取当前页数据，计算总页数，返回分页信息，便于前端实现分页加载；</li>
<li><strong>响应格式统一</strong>：与后端约定好响应格式（code、msg、data/items、pagination），确保切换真实接口时无需修改前端逻辑。</li>
</ul>
<h3 data-id="heading-17">3.4 mockjs进阶用法扩展</h3>
<ul>
<li><strong>多种请求方法支持</strong>：可配置POST、PUT、DELETE等方法的接口，POST请求参数从body中获取（<code>({ body }, res) =&gt; {}</code>）；</li>
<li><strong>动态数据生成</strong>：可根据请求参数动态生成数据，如根据用户ID返回对应用户的帖子；</li>
<li><strong>异常场景模拟</strong>：除了正常响应，还可模拟401（未授权）、404（接口不存在）、500（服务器错误）等状态，测试前端错误处理逻辑。</li>
</ul>
<h2 data-id="heading-18">四、Post List：数据状态管理与页面渲染</h2>
<h3 data-id="heading-19">4.1 TypeScript类型定义</h3>
<p>为实现类型安全，需定义Post、User接口，明确数据结构。代码位于<code>src/types/index.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span>{
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    avatar?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 可选属性（?表示）</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Post</span>{
    <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">brief</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 简介</span>
    <span class="hljs-attr">publishedAt</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 发布时间</span>
    totalLikes?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 点赞数（可选）</span>
    totalComments?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 评论数（可选）</span>
    <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span>; <span class="hljs-comment">// 关联User接口</span>
    <span class="hljs-attr">tags</span>: <span class="hljs-built_in">string</span>[]; <span class="hljs-comment">// 标签数组</span>
    thumbnail?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 缩略图（可选）</span>
    pics?: <span class="hljs-built_in">string</span>[]; <span class="hljs-comment">// 图片数组（可选）</span>
}
</code></pre>
<p>类型定义要点：</p>
<ul>
<li>必填属性直接定义类型，可选属性添加<code>?</code>；</li>
<li>关联接口（如Post中的user属性关联User），实现数据结构的嵌套约束；</li>
<li>所有接口类型需与mock数据、后端接口返回数据保持一致，避免类型不匹配错误。</li>
</ul>
<h3 data-id="heading-20">4.2 Zustand全局状态管理</h3>
<p>Zustand是一款轻量级状态管理库，相比Redux更简洁，无需Provider包裹，适合中小型项目。本文用其存储帖子列表数据、轮播图数据及加载方法。</p>
<h4 data-id="heading-21">4.2.1 状态定义与实现</h4>
<p>代码位于<code>src/store/home.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">"zustand"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">SlideData</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/components/SlideShow"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Post</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/types"</span>;
<span class="hljs-keyword">import</span> { fetchPosts } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/api/posts"</span>;

<span class="hljs-comment">// 定义状态接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">HomeState</span> {
    <span class="hljs-attr">banners</span>: <span class="hljs-title class_">SlideData</span>[]; <span class="hljs-comment">// 轮播图数据</span>
    <span class="hljs-attr">posts</span>: <span class="hljs-title class_">Post</span>[]; <span class="hljs-comment">// 帖子列表数据</span>
    <span class="hljs-attr">loadMore</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;; <span class="hljs-comment">// 加载更多方法（分页加载）</span>
}

<span class="hljs-comment">// 创建状态管理实例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useHomeStore = create&lt;<span class="hljs-title class_">HomeState</span>&gt;(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
    <span class="hljs-comment">// 初始轮播图数据</span>
    <span class="hljs-attr">banners</span>: [{
      <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">"React 生态系统"</span>,
      <span class="hljs-attr">image</span>: <span class="hljs-string">"https://images.unsplash.com/photo-1633356122544-f134324a6cee?q=80&amp;w=2070&amp;auto=format&amp;fit=crop"</span>,
    },
    {
      <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">"移动端开发最佳实践"</span>,
      <span class="hljs-attr">image</span>: <span class="hljs-string">"https://img.36krcdn.com/hsossms/20260114/v2_1ddcc36679304d3390dd9b8545eaa57f@5091053@ai_oswg1012730oswg1053oswg495_img_png~tplv-1marlgjv7f-ai-v3:600:400:600:400:q70.jpg?x-oss-process=image/format,webp"</span>,
    },
    {
      <span class="hljs-attr">id</span>: <span class="hljs-number">3</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">"百度上线七猫漫剧，打的什么主意？"</span>,
      <span class="hljs-attr">image</span>: <span class="hljs-string">"https://img.36krcdn.com/hsossms/20260114/v2_8dc528b02ded4f73b29b7c1019f8963a@5091053@ai_oswg1137571oswg1053oswg495_img_png~tplv-1marlgjv7f-ai-v3:600:400:600:400:q70.jpg?x-oss-process=image/format,webp"</span>,
    }],
    <span class="hljs-comment">// 初始帖子列表为空</span>
    <span class="hljs-attr">posts</span>: [],
    <span class="hljs-comment">// 加载更多方法（异步）</span>
    <span class="hljs-attr">loadMore</span>: <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> { items } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchPosts</span>();
      <span class="hljs-comment">// 更新状态：将新获取的帖子数据追加到posts中（分页加载逻辑）</span>
      <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">posts</span>: [...state.<span class="hljs-property">posts</span>, ...items] }));
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(items);
    }
}));
</code></pre>
<p>状态管理核心逻辑：</p>
<ul>
<li><strong>状态接口定义</strong>：通过HomeState接口约束状态的结构与类型，确保状态数据合规；</li>
<li><strong>初始状态</strong>：banners设置初始轮播图数据，posts初始为空数组；</li>
<li><strong>异步方法</strong>：loadMore为异步方法，调用fetchPosts获取帖子数据，通过set方法更新状态。set方法支持函数参数，可获取当前状态，实现数据追加（分页加载核心逻辑）。</li>
</ul>
<h3 data-id="heading-22">4.3 页面渲染与数据联动</h3>
<p>首页组件（<code>src/pages/Home.tsx</code>）从状态中读取数据，渲染轮播图、帖子列表，并在组件加载时触发数据加载。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"@/components/Header"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SlideShow</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"@/components/SlideShow"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Card</span>, <span class="hljs-title class_">CardHeader</span>, <span class="hljs-title class_">CardTitle</span>, <span class="hljs-title class_">CardContent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/components/ui/card"</span>;
<span class="hljs-keyword">import</span> { useHomeStore } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/store/home"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 从状态中解构数据与方法</span>
    <span class="hljs-keyword">const</span> { banners, posts, loadMore } = <span class="hljs-title function_">useHomeStore</span>();
    
    <span class="hljs-comment">// 组件挂载时触发加载更多（获取第一页数据）</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">loadMore</span>();
    }, []); <span class="hljs-comment">// 空依赖数组，仅在组件挂载时执行一次</span>
    
    <span class="hljs-keyword">return</span> ( 
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"首页"</span> <span class="hljs-attr">showBackButton</span>=<span class="hljs-string">{true}</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"p-4 space-y-4 "</span>&gt;</span>
            {/* 轮播图组件，传入banners数据 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">SlideShow</span> <span class="hljs-attr">slides</span>=<span class="hljs-string">{banners}</span> /&gt;</span>
            {/* 欢迎卡片 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">Card</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">CardHeader</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">CardTitle</span>&gt;</span>欢迎来到React Mobile<span class="hljs-tag">&lt;/<span class="hljs-name">CardTitle</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">CardHeader</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">CardContent</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-muted-foreground"</span>&gt;</span>这是内容区域<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">CardContent</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
            {/* 帖子列表网格布局 */}
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"grid grid-cols-2 gap-4"</span>&gt;</span>
                {/* 遍历posts数据渲染帖子卡片（当前为占位，可替换为真实帖子组件） */}
                {posts.map((post) =&gt; (
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{post.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-32 bg-white rounded-lg shadow-sm flex items-center justify-center border "</span>&gt;</span>
                        {post.title}
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                ))}
                {/* 原占位数据，可删除，替换为真实数据渲染 */}
                {/* {[1,2,...,25].map((i,index) =&gt; (...))} */}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/&gt;</span></span>
    );
}
</code></pre>
<p>页面渲染关键要点：</p>
<ul>
<li><strong>状态订阅</strong>：通过useHomeStore钩子订阅状态，当posts、banners发生变化时，组件会自动重新渲染；</li>
<li><strong>数据加载时机</strong>：通过useEffect在组件挂载时调用loadMore，获取第一页帖子数据；</li>
<li><strong>列表渲染</strong>：使用map遍历posts数组渲染列表，需指定唯一key（post.id），避免React渲染警告。原代码中的占位数据可替换为真实帖子组件，展示帖子标题、缩略图等信息；</li>
<li><strong>样式与布局</strong>：通过TailwindCSS实现网格布局（grid-cols-2）、间距控制（space-y-4、gap-4），适配移动端展示。</li>
</ul>
<h2 data-id="heading-23">五、核心技术整合与实战总结</h2>
<h3 data-id="heading-24">5.1 技术整合关键点</h3>
<ul>
<li><strong>接口一致性</strong>：mock数据格式、TypeScript接口、后端接口文档三者必须保持一致，这是实现“无缝切换”的核心前提；</li>
<li><strong>分层设计</strong>：请求层（axios）、模拟数据层（mockjs）、状态层（Zustand）、视图层（页面组件）分层清晰，便于维护与扩展；</li>
<li><strong>类型安全</strong>：全程使用TypeScript定义类型，从请求参数、响应数据到状态管理、组件Props，避免数据异常导致的bug；</li>
<li><strong>开发效率</strong>：mockjs使前端独立开发，无需依赖后端，Vite插件集成简化配置，Zustand减少状态管理冗余代码，整体提升开发效率。</li>
</ul>
<h3 data-id="heading-25">5.2 常见问题与解决方案</h3>
<ul>
<li><strong>mock请求拦截失败</strong>：检查mock文件路径是否与vite.config.ts中mockPath配置一致，URL是否与axios请求路径完全匹配，确保localEnabled设为true；</li>
<li><strong>类型不匹配错误</strong>：检查TypeScript接口定义与mock数据、响应数据是否一致，确保可选属性、嵌套结构正确；</li>
<li><strong>分页逻辑异常</strong>：确认page、limit参数类型转换正确，分页计算公式（start = (currentPage-1)*size）无误，slice方法截取范围正确；</li>
<li><strong>状态更新后组件不渲染</strong>：确保通过Zustand的set方法更新状态，且组件正确订阅状态（使用useHomeStore钩子解构数据）。</li>
</ul>
<h3 data-id="heading-26">5.3 生产环境部署注意事项</h3>
<ul>
<li>切换axios的baseURL为后端真实接口地址，禁用mock服务（prodEnabled: false）；</li>
<li>完善错误处理逻辑，添加用户可感知的错误提示（如Toast组件），替代控制台打印；</li>
<li>优化请求性能，如添加请求缓存、防抖节流（针对下拉加载更多）、超时重连等；</li>
<li>校验后端接口返回数据，处理异常状态码，确保生产环境数据稳定性。</li>
</ul>
<h2 data-id="heading-27">六、扩展学习与进阶方向</h2>
<ul>
<li><strong>axios进阶</strong>：学习请求取消（如页面卸载时取消未完成请求）、请求重试、上传下载进度监控等高级功能；</li>
<li><strong>mockjs扩展</strong>：使用mockjs结合JSON5语法编写更复杂的模拟规则，集成mock数据持久化（如localStorage）；</li>
<li><strong>状态管理深化</strong>：学习Zustand的中间件（如日志、持久化），对比Redux、Pinia等状态管理库的适用场景；</li>
<li><strong>分页与无限滚动</strong>：基于当前分页逻辑，实现下拉加载更多、上拉刷新功能，集成第三方组件（如react-infinite-scroll-component）；</li>
<li><strong>接口联调与测试</strong>：学习使用Postman、Swagger等工具测试后端接口，实现前端与后端的高效联调。</li>
</ul>
<p>本文通过实战代码拆解，系统讲解了Post List功能开发中axios、mockjs的核心用法及状态管理、页面渲染的完整流程。掌握这些知识，可快速搭建前端项目的数据层架构，实现前后端分离模式下的高效开发。在实际项目中，需结合业务需求灵活扩展，不断优化代码质量与用户体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[pythontutor - 代码可视化探索：链表、异常与控制流的动态演示]]></title>    <link>https://juejin.cn/post/7598499504170893350</link>    <guid>https://juejin.cn/post/7598499504170893350</guid>    <pubDate>2026-01-24T08:12:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598499504170893350" data-draft-id="7598818096728866854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="pythontutor - 代码可视化探索：链表、异常与控制流的动态演示"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-24T08:12:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="pe7er"/> <meta itemprop="url" content="https://juejin.cn/user/905653310988445"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            pythontutor - 代码可视化探索：链表、异常与控制流的动态演示
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653310988445/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    pe7er
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-24T08:12:21.000Z" title="Sat Jan 24 2026 08:12:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-24
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PythonTutor 是什么</h2>
<p>PythonTutor 是一个用于展示代码执行过程的可视化学习工具。它关注的不是程序最终输出的结果，而是代码在运行过程中每一步是如何执行的、变量和对象在内存中如何变化。</p>
<hr/>
<h3 data-id="heading-1">PythonTutor 的核心价值</h3>
<p>PythonTutor 会逐行执行代码，并实时展示：</p>
<ul>
<li>当前正在执行的代码行</li>
<li>变量在不同阶段的取值变化</li>
<li>对象在内存中的分配情况</li>
<li>引用关系、指针指向和调用栈结构</li>
</ul>
<p>这种方式可以帮助开发者真正理解程序的执行逻辑，而不仅仅是“跑通代码”。</p>
<hr/>
<h3 data-id="heading-2">可视化变量和内存结构</h3>
<p>在很多语言中，变量本质上是对对象的引用。仅通过日志或打印输出，很难直观理解多个变量是否指向同一个对象。</p>
<p>PythonTutor 会将这些关系以图形形式展示出来，尤其适合理解以下概念：</p>
<ul>
<li>引用与对象的关系</li>
<li>链表和指针结构</li>
<li>对象共享与副作用</li>
<li>栈与堆内存的变化</li>
</ul>
<hr/>
<h3 data-id="heading-3">Java 链表示例</h3>
<p>下面是一个完整、可直接运行的 Java 单向链表示例，适合放入 PythonTutor 的 Java 模式中观察指针和对象的变化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2765da14261b4fabbfb1dd97a3dd4005~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGU3ZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769847968&amp;x-signature=vyg7qoH%2FTmKLIYXokTHMZz1AXeo%3D" alt="链表虚拟化.gif" loading="lazy"/></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Objects;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedListDemo</span> {

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> {
        <span class="hljs-type">int</span> value;
        Node next;

        Node(<span class="hljs-type">int</span> value) {
            <span class="hljs-built_in">this</span>.value = value;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">head</span> <span class="hljs-operator">=</span> buildList();
        printList(head);

        head = delete(head, <span class="hljs-number">2</span>);
        printList(head);

        System.out.println(<span class="hljs-string">"是否包含 3: "</span> + contains(head, <span class="hljs-number">3</span>));
        System.out.println(<span class="hljs-string">"是否包含 5: "</span> + contains(head, <span class="hljs-number">5</span>));

        head = reverse(head);
        printList(head);
    }

    <span class="hljs-keyword">static</span> Node <span class="hljs-title function_">buildList</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">n1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">Node</span> <span class="hljs-variable">n2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(<span class="hljs-number">2</span>);
        <span class="hljs-type">Node</span> <span class="hljs-variable">n3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(<span class="hljs-number">3</span>);
        <span class="hljs-type">Node</span> <span class="hljs-variable">n4</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(<span class="hljs-number">4</span>);

        n1.next = n2;
        n2.next = n3;
        n3.next = n4;

        <span class="hljs-keyword">return</span> n1;
    }

    <span class="hljs-keyword">static</span> Node <span class="hljs-title function_">delete</span><span class="hljs-params">(Node head, <span class="hljs-type">int</span> target)</span> {
        <span class="hljs-keyword">if</span> (head == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">if</span> (head.value == target) {
            <span class="hljs-keyword">return</span> head.next;
        }

        <span class="hljs-type">Node</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> head;
        <span class="hljs-keyword">while</span> (current.next != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (current.next.value == target) {
                current.next = current.next.next;
                <span class="hljs-keyword">break</span>;
            }
            current = current.next;
        }
        <span class="hljs-keyword">return</span> head;
    }

    <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(Node head, <span class="hljs-type">int</span> target)</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> head;
        <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (current.value == target) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
            current = current.next;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">static</span> Node <span class="hljs-title function_">reverse</span><span class="hljs-params">(Node head)</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">Node</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> head;

        <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">Node</span> <span class="hljs-variable">nextTemp</span> <span class="hljs-operator">=</span> current.next;
            current.next = prev;
            prev = current;
            current = nextTemp;
        }
        <span class="hljs-keyword">return</span> prev;
    }

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printList</span><span class="hljs-params">(Node head)</span> {
        <span class="hljs-type">Node</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> head;
        <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) {
            System.out.print(current.value + <span class="hljs-string">" -&gt; "</span>);
            current = current.next;
        }
        System.out.println(<span class="hljs-string">"null"</span>);
    }
}
</code></pre>
<p>复制下面的内容在浏览器地址访问</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">https:</span>//pythontutor.com/render.html#code=import%<span class="hljs-number">20</span>java.util.Objects%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>Apublic%<span class="hljs-number">20</span><span class="hljs-keyword">class</span>%<span class="hljs-number">20L</span>inkedListDemo%<span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>//%<span class="hljs-number">20%</span>E5%<span class="hljs-number">8</span>D%<span class="hljs-number">95%</span>E9%<span class="hljs-number">93%</span>BE%E8%A1%A8%E8%<span class="hljs-number">8</span>A%<span class="hljs-number">82%</span>E7%<span class="hljs-number">82%</span>B9%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20s</span>tatic%<span class="hljs-number">20</span><span class="hljs-keyword">class</span>%<span class="hljs-number">20</span>Node%<span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20i</span>nt%<span class="hljs-number">20</span>value%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>Node%<span class="hljs-number">20</span><span class="hljs-keyword">next</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>Node%<span class="hljs-number">28i</span>nt%<span class="hljs-number">20</span>value%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>this.value%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>value%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">private</span>%<span class="hljs-number">20</span>Node%<span class="hljs-number">20</span>head%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>//%<span class="hljs-number">20%</span>E5%B0%BE%E6%<span class="hljs-number">8</span>F%<span class="hljs-number">92%</span>E6%B3%<span class="hljs-number">95%</span>E6%B7%BB%E5%<span class="hljs-number">8</span>A%A0%E8%<span class="hljs-number">8</span>A%<span class="hljs-number">82%</span>E7%<span class="hljs-number">82%</span>B9%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">public</span>%<span class="hljs-number">20</span>void%<span class="hljs-number">20</span>add%<span class="hljs-number">28i</span>nt%<span class="hljs-number">20</span>value%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>Node%<span class="hljs-number">20</span>newNode%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span><span class="hljs-built_in">new</span>%<span class="hljs-number">20</span>Node%<span class="hljs-number">28</span>value%<span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20i</span>f%<span class="hljs-number">20%</span><span class="hljs-number">28</span>head%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">3</span>D%<span class="hljs-number">20</span>null%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>head%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>newNode%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">return</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>Node%<span class="hljs-number">20</span>cur%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>head%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">while</span>%<span class="hljs-number">20%</span><span class="hljs-number">28</span>cur.<span class="hljs-keyword">next</span>%<span class="hljs-number">20</span>!%<span class="hljs-number">3</span>D%<span class="hljs-number">20</span>null%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>cur%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>cur.<span class="hljs-keyword">next</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>cur.<span class="hljs-keyword">next</span>%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>newNode%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>//%<span class="hljs-number">20%</span>E5%<span class="hljs-number">88%</span>A0%E9%<span class="hljs-number">99%</span>A4%E6%<span class="hljs-number">8</span>C%<span class="hljs-number">87%</span>E5%AE%<span class="hljs-number">9</span>A%E5%<span class="hljs-number">80%</span>BC%E7%<span class="hljs-number">9</span>A%<span class="hljs-number">84%</span>E8%<span class="hljs-number">8</span>A%<span class="hljs-number">82%</span>E7%<span class="hljs-number">82%</span>B9%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">public</span>%<span class="hljs-number">20</span>void%<span class="hljs-number">20</span>remove%<span class="hljs-number">28i</span>nt%<span class="hljs-number">20</span>value%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20i</span>f%<span class="hljs-number">20%</span><span class="hljs-number">28</span>head%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">3</span>D%<span class="hljs-number">20</span>null%<span class="hljs-number">29%</span><span class="hljs-number">20</span><span class="hljs-keyword">return</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20i</span>f%<span class="hljs-number">20%</span><span class="hljs-number">28</span>head.value%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">3</span>D%<span class="hljs-number">20</span>value%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>head%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>head.<span class="hljs-keyword">next</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">return</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>Node%<span class="hljs-number">20</span>cur%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>head%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">while</span>%<span class="hljs-number">20%</span><span class="hljs-number">28</span>cur.<span class="hljs-keyword">next</span>%<span class="hljs-number">20</span>!%<span class="hljs-number">3</span>D%<span class="hljs-number">20</span>null%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20i</span>f%<span class="hljs-number">20%</span><span class="hljs-number">28</span>cur.<span class="hljs-keyword">next</span>.value%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">3</span>D%<span class="hljs-number">20</span>value%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>cur.<span class="hljs-keyword">next</span>%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>cur.<span class="hljs-keyword">next</span>.<span class="hljs-keyword">next</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">return</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>cur%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>cur.<span class="hljs-keyword">next</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>//%<span class="hljs-number">20%</span>E5%<span class="hljs-number">88%</span>A4%E6%<span class="hljs-number">96%</span>AD%E6%<span class="hljs-number">98%</span>AF%E5%<span class="hljs-number">90%</span>A6%E5%<span class="hljs-number">8</span>C%<span class="hljs-number">85%</span>E5%<span class="hljs-number">90%</span>AB%E6%<span class="hljs-number">9</span>F%<span class="hljs-number">90%</span>E4%B8%AA%E5%<span class="hljs-number">80%</span>BC%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">public</span>%<span class="hljs-number">20</span><span class="hljs-type">boolean</span>%<span class="hljs-number">20</span>contains%<span class="hljs-number">28i</span>nt%<span class="hljs-number">20</span>value%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>Node%<span class="hljs-number">20</span>cur%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>head%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">while</span>%<span class="hljs-number">20%</span><span class="hljs-number">28</span>cur%<span class="hljs-number">20</span>!%<span class="hljs-number">3</span>D%<span class="hljs-number">20</span>null%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20i</span>f%<span class="hljs-number">20%</span><span class="hljs-number">28</span>Objects.<span class="hljs-keyword">equals</span>%<span class="hljs-number">28</span>cur.value,%<span class="hljs-number">20</span>value%<span class="hljs-number">29%</span><span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">return</span>%<span class="hljs-number">20</span><span class="hljs-literal">true</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>cur%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>cur.<span class="hljs-keyword">next</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">return</span>%<span class="hljs-number">20</span><span class="hljs-literal">false</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>//%<span class="hljs-number">20%</span>E6%<span class="hljs-number">89%</span><span class="hljs-number">93%</span>E5%<span class="hljs-number">8</span>D%B0%E9%<span class="hljs-number">93%</span>BE%E8%A1%A8%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">public</span>%<span class="hljs-number">20</span>void%<span class="hljs-number">20</span>print%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>Node%<span class="hljs-number">20</span>cur%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>head%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">while</span>%<span class="hljs-number">20%</span><span class="hljs-number">28</span>cur%<span class="hljs-number">20</span>!%<span class="hljs-number">3</span>D%<span class="hljs-number">20</span>null%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.print%<span class="hljs-number">28</span>cur.value%<span class="hljs-number">20%</span><span class="hljs-number">2</span>B%<span class="hljs-number">20%</span><span class="hljs-number">22%</span><span class="hljs-number">20</span>-%<span class="hljs-number">3</span>E%<span class="hljs-number">20%</span><span class="hljs-number">22%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>cur%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>cur.<span class="hljs-keyword">next</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22</span>null%<span class="hljs-number">22%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>//%<span class="hljs-number">20%</span>E5%<span class="hljs-number">8</span>F%<span class="hljs-number">8</span>D%E8%BD%AC%E9%<span class="hljs-number">93%</span>BE%E8%A1%A8%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">public</span>%<span class="hljs-number">20</span>void%<span class="hljs-number">20</span>reverse%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>Node%<span class="hljs-number">20</span>prev%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>null%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>Node%<span class="hljs-number">20</span>cur%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>head%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">while</span>%<span class="hljs-number">20%</span><span class="hljs-number">28</span>cur%<span class="hljs-number">20</span>!%<span class="hljs-number">3</span>D%<span class="hljs-number">20</span>null%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>Node%<span class="hljs-number">20</span>nextTemp%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>cur.<span class="hljs-keyword">next</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>cur.<span class="hljs-keyword">next</span>%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>prev%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>prev%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>cur%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>cur%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>nextTemp%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>head%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>prev%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>//%<span class="hljs-number">20%</span>E6%B5%<span class="hljs-number">8</span>B%E8%AF%<span class="hljs-number">95%</span>E5%<span class="hljs-number">85%</span>A5%E5%<span class="hljs-number">8</span>F%A3%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">public</span>%<span class="hljs-number">20s</span>tatic%<span class="hljs-number">20</span>void%<span class="hljs-number">20</span>main%<span class="hljs-number">28S</span>tring%<span class="hljs-number">5</span>B%<span class="hljs-number">5</span>D%<span class="hljs-number">20</span>args%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20L</span>inkedListDemo%<span class="hljs-number">20l</span>ist%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span><span class="hljs-built_in">new</span>%<span class="hljs-number">20L</span>inkedListDemo%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20l</span>ist.add%<span class="hljs-number">281%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20l</span>ist.add%<span class="hljs-number">282%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20l</span>ist.add%<span class="hljs-number">283%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20l</span>ist.add%<span class="hljs-number">284%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22%</span>E5%<span class="hljs-number">8</span>E%<span class="hljs-number">9</span>F%E5%A7%<span class="hljs-number">8</span>B%E9%<span class="hljs-number">93%</span>BE%E8%A1%A8%<span class="hljs-number">3</span>A%<span class="hljs-number">22%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20l</span>ist.print%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22%</span>E5%<span class="hljs-number">88%</span>A0%E9%<span class="hljs-number">99%</span>A4%<span class="hljs-number">202%</span><span class="hljs-number">3</span>A%<span class="hljs-number">22%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20l</span>ist.remove%<span class="hljs-number">282%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20l</span>ist.print%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22%</span>E6%<span class="hljs-number">98%</span>AF%E5%<span class="hljs-number">90%</span>A6%E5%<span class="hljs-number">8</span>C%<span class="hljs-number">85%</span>E5%<span class="hljs-number">90%</span>AB%<span class="hljs-number">203%</span><span class="hljs-number">3</span>A%<span class="hljs-number">20%</span><span class="hljs-number">22%</span><span class="hljs-number">20%</span><span class="hljs-number">2</span>B%<span class="hljs-number">20l</span>ist.contains%<span class="hljs-number">283%</span><span class="hljs-number">29%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22%</span>E6%<span class="hljs-number">98%</span>AF%E5%<span class="hljs-number">90%</span>A6%E5%<span class="hljs-number">8</span>C%<span class="hljs-number">85%</span>E5%<span class="hljs-number">90%</span>AB%<span class="hljs-number">205%</span><span class="hljs-number">3</span>A%<span class="hljs-number">20%</span><span class="hljs-number">22%</span><span class="hljs-number">20%</span><span class="hljs-number">2</span>B%<span class="hljs-number">20l</span>ist.contains%<span class="hljs-number">285%</span><span class="hljs-number">29%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22%</span>E5%<span class="hljs-number">8</span>F%<span class="hljs-number">8</span>D%E8%BD%AC%E9%<span class="hljs-number">93%</span>BE%E8%A1%A8%<span class="hljs-number">3</span>A%<span class="hljs-number">22%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20l</span>ist.reverse%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20l</span>ist.print%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">7</span>D&amp;cumulative=<span class="hljs-literal">false</span>&amp;curInstr=<span class="hljs-number">0&amp;</span>heapPrimitives=nevernest&amp;mode=display&amp;origin=opt-frontend.js&amp;py=java&amp;rawInputLstJSON=%<span class="hljs-number">5</span>B%<span class="hljs-number">5</span>D&amp;textReferences=<span class="hljs-literal">false</span>
</code></pre>
<h3 data-id="heading-4">Java 中的 try catch finally 示例</h3>
<p>这个示例适合用来观察异常发生时控制流的变化，以及 finally 代码块一定会被执行的特性。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TryCatchDemo</span> {

    <span class="hljs-comment">// 模拟一个需要手动释放的资源</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FakeResource</span> {
        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">open</span>()</span> {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"资源已打开"</span>);
        }

        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">use</span>()</span> {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"正在使用资源"</span>);
            <span class="hljs-comment">// 人为制造异常</span>
            <span class="hljs-built_in">int</span> x = <span class="hljs-number">10</span> / <span class="hljs-number">0</span>;
        }

        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">close</span>()</span> {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"资源已释放"</span>);
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        FakeResource resource = <span class="hljs-keyword">new</span> FakeResource();

        <span class="hljs-keyword">try</span> {
            resource.open();
            resource.use();
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"这行代码不会被执行"</span>);
        } <span class="hljs-keyword">catch</span> (ArithmeticException e) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"捕获到异常: "</span> + e.getMessage());
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 无论是否发生异常，都会执行</span>
            resource.close();
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"finally 块执行完成"</span>);
        }
    }
}
</code></pre>
<p>在 PythonTutor 中可以清楚看到：</p>
<ul>
<li>异常发生后直接跳转到 catch</li>
<li>try 中剩余代码不再执行</li>
<li>finally 始终会被执行</li>
</ul>
<p>复制下面的内容在浏览器地址访问</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">https:</span>//pythontutor.com/render.html#code=<span class="hljs-keyword">public</span>%<span class="hljs-number">20</span><span class="hljs-keyword">class</span>%<span class="hljs-number">20</span>TryCatchDemo%<span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>//%<span class="hljs-number">20%</span>E6%A8%A1%E6%<span class="hljs-number">8</span>B%<span class="hljs-number">9</span>F%E4%B8%<span class="hljs-number">80%</span>E4%B8%AA%E9%<span class="hljs-number">9</span>C%<span class="hljs-number">80%</span>E8%A6%<span class="hljs-number">81%</span>E6%<span class="hljs-number">89%</span><span class="hljs-number">8</span>B%E5%<span class="hljs-number">8</span>A%A8%E9%<span class="hljs-number">87%</span><span class="hljs-number">8</span>A%E6%<span class="hljs-number">94%</span>BE%E7%<span class="hljs-number">9</span>A%<span class="hljs-number">84%</span>E8%B5%<span class="hljs-number">84%</span>E6%BA%<span class="hljs-number">90%</span><span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20s</span>tatic%<span class="hljs-number">20</span><span class="hljs-keyword">class</span>%<span class="hljs-number">20</span>FakeResource%<span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>void%<span class="hljs-number">20</span>open%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22%</span>E8%B5%<span class="hljs-number">84%</span>E6%BA%<span class="hljs-number">90%</span>E5%B7%B2%E6%<span class="hljs-number">89%</span><span class="hljs-number">93%</span>E5%BC%<span class="hljs-number">80%</span><span class="hljs-number">22%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>void%<span class="hljs-number">20us</span>e%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22%</span>E6%AD%A3%E5%<span class="hljs-number">9</span>C%A8%E4%BD%BF%E7%<span class="hljs-number">94%</span>A8%E8%B5%<span class="hljs-number">84%</span>E6%BA%<span class="hljs-number">90%</span><span class="hljs-number">22%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>//%<span class="hljs-number">20%</span>E4%BA%BA%E4%B8%BA%E5%<span class="hljs-number">88%</span>B6%E9%<span class="hljs-number">80%</span>A0%E5%BC%<span class="hljs-number">82%</span>E5%B8%B8%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20i</span>nt%<span class="hljs-number">20</span>x%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">2010%</span><span class="hljs-number">20</span>/%<span class="hljs-number">200%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>void%<span class="hljs-number">20</span>close%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22%</span>E8%B5%<span class="hljs-number">84%</span>E6%BA%<span class="hljs-number">90%</span>E5%B7%B2%E9%<span class="hljs-number">87%</span><span class="hljs-number">8</span>A%E6%<span class="hljs-number">94%</span>BE%<span class="hljs-number">22%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">public</span>%<span class="hljs-number">20s</span>tatic%<span class="hljs-number">20</span>void%<span class="hljs-number">20</span>main%<span class="hljs-number">28S</span>tring%<span class="hljs-number">5</span>B%<span class="hljs-number">5</span>D%<span class="hljs-number">20</span>args%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>FakeResource%<span class="hljs-number">20</span>resource%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span><span class="hljs-built_in">new</span>%<span class="hljs-number">20</span>FakeResource%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">try</span>%<span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>resource.open%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>resource.use%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22%</span>E8%BF%<span class="hljs-number">99%</span>E8%A1%<span class="hljs-number">8</span>C%E4%BB%A3%E7%A0%<span class="hljs-number">81%</span>E4%B8%<span class="hljs-number">8</span>D%E4%BC%<span class="hljs-number">9</span>A%E8%A2%AB%E6%<span class="hljs-number">89%</span>A7%E8%A1%<span class="hljs-number">8</span>C%<span class="hljs-number">22%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">20</span><span class="hljs-keyword">catch</span>%<span class="hljs-number">20%</span><span class="hljs-number">28</span>ArithmeticException%<span class="hljs-number">20</span>e%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22%</span>E6%<span class="hljs-number">8</span>D%<span class="hljs-number">95%</span>E8%<span class="hljs-number">8</span>E%B7%E5%<span class="hljs-number">88%</span>B0%E5%BC%<span class="hljs-number">82%</span>E5%B8%B8%<span class="hljs-number">3</span>A%<span class="hljs-number">20%</span><span class="hljs-number">22%</span><span class="hljs-number">20%</span><span class="hljs-number">2</span>B%<span class="hljs-number">20</span>e.getMessage%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">20</span><span class="hljs-keyword">finally</span>%<span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>//%<span class="hljs-number">20%</span>E6%<span class="hljs-number">97%</span>A0%E8%AE%BA%E6%<span class="hljs-number">98%</span>AF%E5%<span class="hljs-number">90%</span>A6%E5%<span class="hljs-number">8</span>F%<span class="hljs-number">91%</span>E7%<span class="hljs-number">94%</span><span class="hljs-number">9</span>F%E5%BC%<span class="hljs-number">82%</span>E5%B8%B8%EF%BC%<span class="hljs-number">8</span>C%E9%<span class="hljs-number">83%</span>BD%E4%BC%<span class="hljs-number">9</span>A%E6%<span class="hljs-number">89%</span>A7%E8%A1%<span class="hljs-number">8</span>C%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>resource.close%<span class="hljs-number">28%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22</span><span class="hljs-keyword">finally</span>%<span class="hljs-number">20%</span>E5%<span class="hljs-number">9</span>D%<span class="hljs-number">97%</span>E6%<span class="hljs-number">89%</span>A7%E8%A1%<span class="hljs-number">8</span>C%E5%AE%<span class="hljs-number">8</span>C%E6%<span class="hljs-number">88%</span><span class="hljs-number">90%</span><span class="hljs-number">22%</span><span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">7</span>D&amp;cumulative=<span class="hljs-literal">false</span>&amp;curInstr=<span class="hljs-number">0&amp;</span>heapPrimitives=nevernest&amp;mode=display&amp;origin=opt-frontend.js&amp;py=java&amp;rawInputLstJSON=%<span class="hljs-number">5</span>B%<span class="hljs-number">5</span>D&amp;textReferences=<span class="hljs-literal">false</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">Java 中的 switch case （命中穿透）示例</h3>
<p>下面这个示例将 break 删除了，适合观察分支匹配和 break 对流程的影响。</p>
<pre><code class="hljs language-csharp" lang="csharp">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SwitchDemo</span> {

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
            <span class="hljs-built_in">int</span> day = <span class="hljs-number">1</span>;

            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"day = "</span> + day);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"开始执行 switch"</span>);

            <span class="hljs-keyword">switch</span> (day) {
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"命中 case 1：星期一"</span>);
                    <span class="hljs-comment">// break;</span>
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"命中 case 2：星期二"</span>);
                    <span class="hljs-comment">// break;</span>
                <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"命中 case 3：星期三"</span>);
                    <span class="hljs-comment">// break;</span>
                <span class="hljs-literal">default</span>:
                    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"命中 default：未知日期"</span>);
                    <span class="hljs-comment">// break;</span>
            }

            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"switch 执行结束"</span>);
        }
    }
</code></pre>
<p>通过可视化可以看到：</p>
<ul>
<li>switch 表达式只计算一次</li>
<li>第一个匹配的 case 就会被执行</li>
<li>缺少break 会导致命中穿透。</li>
</ul>
<p>复制下面的内容在浏览器地址访问</p>
<pre><code class="hljs language-sql" lang="sql">https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>pythontutor.com<span class="hljs-operator">/</span>render.html#code<span class="hljs-operator">=</span>public<span class="hljs-operator">%</span><span class="hljs-number">20</span>class<span class="hljs-operator">%</span><span class="hljs-number">20</span>SwitchDemo<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">7</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>public<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-keyword">static</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>void<span class="hljs-operator">%</span><span class="hljs-number">20</span>main<span class="hljs-operator">%</span><span class="hljs-number">28</span>String<span class="hljs-operator">%</span><span class="hljs-number">5</span>B<span class="hljs-operator">%</span><span class="hljs-number">5</span>D<span class="hljs-operator">%</span><span class="hljs-number">20</span>args<span class="hljs-operator">%</span><span class="hljs-number">29</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">7</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-type">int</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-keyword">day</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>D<span class="hljs-operator">%</span><span class="hljs-number">201</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>System.out.println<span class="hljs-operator">%</span><span class="hljs-number">28</span><span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-keyword">day</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>D<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">2</span>B<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-keyword">day</span><span class="hljs-operator">%</span><span class="hljs-number">29</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>System.out.println<span class="hljs-operator">%</span><span class="hljs-number">28</span><span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-operator">%</span>E5<span class="hljs-operator">%</span>BC<span class="hljs-operator">%</span><span class="hljs-number">80</span><span class="hljs-operator">%</span>E5<span class="hljs-operator">%</span>A7<span class="hljs-operator">%</span><span class="hljs-number">8</span>B<span class="hljs-operator">%</span>E6<span class="hljs-operator">%</span><span class="hljs-number">89</span><span class="hljs-operator">%</span>A7<span class="hljs-operator">%</span>E8<span class="hljs-operator">%</span>A1<span class="hljs-operator">%</span><span class="hljs-number">8</span>C<span class="hljs-operator">%</span><span class="hljs-number">20</span>switch<span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-operator">%</span><span class="hljs-number">29</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>switch<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">28</span><span class="hljs-keyword">day</span><span class="hljs-operator">%</span><span class="hljs-number">29</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">7</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-keyword">case</span><span class="hljs-operator">%</span><span class="hljs-number">201</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>A<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>System.out.println<span class="hljs-operator">%</span><span class="hljs-number">28</span><span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-operator">%</span>E5<span class="hljs-operator">%</span><span class="hljs-number">91</span><span class="hljs-operator">%</span>BD<span class="hljs-operator">%</span>E4<span class="hljs-operator">%</span>B8<span class="hljs-operator">%</span>AD<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-keyword">case</span><span class="hljs-operator">%</span><span class="hljs-number">201</span><span class="hljs-operator">%</span>EF<span class="hljs-operator">%</span>BC<span class="hljs-operator">%</span><span class="hljs-number">9</span>A<span class="hljs-operator">%</span>E6<span class="hljs-operator">%</span><span class="hljs-number">98</span><span class="hljs-operator">%</span><span class="hljs-number">9</span>F<span class="hljs-operator">%</span>E6<span class="hljs-operator">%</span><span class="hljs-number">9</span>C<span class="hljs-operator">%</span><span class="hljs-number">9</span>F<span class="hljs-operator">%</span>E4<span class="hljs-operator">%</span>B8<span class="hljs-operator">%</span><span class="hljs-number">80</span><span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-operator">%</span><span class="hljs-number">29</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>break<span class="hljs-operator">%</span><span class="hljs-number">3</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-keyword">case</span><span class="hljs-operator">%</span><span class="hljs-number">202</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>A<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>System.out.println<span class="hljs-operator">%</span><span class="hljs-number">28</span><span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-operator">%</span>E5<span class="hljs-operator">%</span><span class="hljs-number">91</span><span class="hljs-operator">%</span>BD<span class="hljs-operator">%</span>E4<span class="hljs-operator">%</span>B8<span class="hljs-operator">%</span>AD<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-keyword">case</span><span class="hljs-operator">%</span><span class="hljs-number">202</span><span class="hljs-operator">%</span>EF<span class="hljs-operator">%</span>BC<span class="hljs-operator">%</span><span class="hljs-number">9</span>A<span class="hljs-operator">%</span>E6<span class="hljs-operator">%</span><span class="hljs-number">98</span><span class="hljs-operator">%</span><span class="hljs-number">9</span>F<span class="hljs-operator">%</span>E6<span class="hljs-operator">%</span><span class="hljs-number">9</span>C<span class="hljs-operator">%</span><span class="hljs-number">9</span>F<span class="hljs-operator">%</span>E4<span class="hljs-operator">%</span>BA<span class="hljs-operator">%</span><span class="hljs-number">8</span>C<span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-operator">%</span><span class="hljs-number">29</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>break<span class="hljs-operator">%</span><span class="hljs-number">3</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-keyword">case</span><span class="hljs-operator">%</span><span class="hljs-number">203</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>A<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>System.out.println<span class="hljs-operator">%</span><span class="hljs-number">28</span><span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-operator">%</span>E5<span class="hljs-operator">%</span><span class="hljs-number">91</span><span class="hljs-operator">%</span>BD<span class="hljs-operator">%</span>E4<span class="hljs-operator">%</span>B8<span class="hljs-operator">%</span>AD<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-keyword">case</span><span class="hljs-operator">%</span><span class="hljs-number">203</span><span class="hljs-operator">%</span>EF<span class="hljs-operator">%</span>BC<span class="hljs-operator">%</span><span class="hljs-number">9</span>A<span class="hljs-operator">%</span>E6<span class="hljs-operator">%</span><span class="hljs-number">98</span><span class="hljs-operator">%</span><span class="hljs-number">9</span>F<span class="hljs-operator">%</span>E6<span class="hljs-operator">%</span><span class="hljs-number">9</span>C<span class="hljs-operator">%</span><span class="hljs-number">9</span>F<span class="hljs-operator">%</span>E4<span class="hljs-operator">%</span>B8<span class="hljs-operator">%</span><span class="hljs-number">89</span><span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-operator">%</span><span class="hljs-number">29</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>break<span class="hljs-operator">%</span><span class="hljs-number">3</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-keyword">default</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>A<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>System.out.println<span class="hljs-operator">%</span><span class="hljs-number">28</span><span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-operator">%</span>E5<span class="hljs-operator">%</span><span class="hljs-number">91</span><span class="hljs-operator">%</span>BD<span class="hljs-operator">%</span>E4<span class="hljs-operator">%</span>B8<span class="hljs-operator">%</span>AD<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-keyword">default</span><span class="hljs-operator">%</span>EF<span class="hljs-operator">%</span>BC<span class="hljs-operator">%</span><span class="hljs-number">9</span>A<span class="hljs-operator">%</span>E6<span class="hljs-operator">%</span><span class="hljs-number">9</span>C<span class="hljs-operator">%</span>AA<span class="hljs-operator">%</span>E7<span class="hljs-operator">%</span><span class="hljs-number">9</span>F<span class="hljs-operator">%</span>A5<span class="hljs-operator">%</span>E6<span class="hljs-operator">%</span><span class="hljs-number">97</span><span class="hljs-operator">%</span>A5<span class="hljs-operator">%</span>E6<span class="hljs-operator">%</span><span class="hljs-number">9</span>C<span class="hljs-operator">%</span><span class="hljs-number">9</span>F<span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-operator">%</span><span class="hljs-number">29</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>break<span class="hljs-operator">%</span><span class="hljs-number">3</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">7</span>D<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span>System.out.println<span class="hljs-operator">%</span><span class="hljs-number">28</span><span class="hljs-operator">%</span><span class="hljs-number">22</span>switch<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span>E6<span class="hljs-operator">%</span><span class="hljs-number">89</span><span class="hljs-operator">%</span>A7<span class="hljs-operator">%</span>E8<span class="hljs-operator">%</span>A1<span class="hljs-operator">%</span><span class="hljs-number">8</span>C<span class="hljs-operator">%</span>E7<span class="hljs-operator">%</span>BB<span class="hljs-operator">%</span><span class="hljs-number">93</span><span class="hljs-operator">%</span>E6<span class="hljs-operator">%</span><span class="hljs-number">9</span>D<span class="hljs-operator">%</span><span class="hljs-number">9</span>F<span class="hljs-operator">%</span><span class="hljs-number">22</span><span class="hljs-operator">%</span><span class="hljs-number">29</span><span class="hljs-operator">%</span><span class="hljs-number">3</span>B<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">20</span><span class="hljs-operator">%</span><span class="hljs-number">7</span>D<span class="hljs-operator">%</span><span class="hljs-number">0</span>A<span class="hljs-operator">%</span><span class="hljs-number">7</span>D<span class="hljs-operator">&amp;</span>cumulative<span class="hljs-operator">=</span><span class="hljs-literal">false</span><span class="hljs-operator">&amp;</span>curInstr<span class="hljs-operator">=</span><span class="hljs-number">0</span><span class="hljs-operator">&amp;</span>heapPrimitives<span class="hljs-operator">=</span>nevernest<span class="hljs-operator">&amp;</span>mode<span class="hljs-operator">=</span>display<span class="hljs-operator">&amp;</span>origin<span class="hljs-operator">=</span>opt<span class="hljs-operator">-</span>frontend.js<span class="hljs-operator">&amp;</span>py<span class="hljs-operator">=</span>java<span class="hljs-operator">&amp;</span>rawInputLstJSON<span class="hljs-operator">=</span><span class="hljs-operator">%</span><span class="hljs-number">5</span>B<span class="hljs-operator">%</span><span class="hljs-number">5</span>D<span class="hljs-operator">&amp;</span>textReferences<span class="hljs-operator">=</span><span class="hljs-literal">false</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">while 循环与 continue、break 示例</h3>
<p>这个示例非常适合在 PythonTutor 中观察循环变量的变化，以及 continue 和 break 对流程的影响。</p>
<pre><code class="hljs language-arduino" lang="arduino">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WhileDemo</span> {

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
            <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;

            <span class="hljs-keyword">while</span> (i &lt; <span class="hljs-number">5</span>) {
                i++;

                <span class="hljs-keyword">if</span> (i == <span class="hljs-number">2</span>) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">if</span> (i == <span class="hljs-number">4</span>) {
                    <span class="hljs-keyword">break</span>;
                }

                System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"当前 i = "</span> + i);
            }
        }
    }
</code></pre>
<p>在可视化过程中可以看到：</p>
<ul>
<li>continue 会跳过本轮循环剩余代码</li>
<li>break 会直接跳出整个循环</li>
<li>i 的变化过程清晰可见</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">https:</span>//pythontutor.com/render.html#code=<span class="hljs-keyword">public</span>%<span class="hljs-number">20</span><span class="hljs-keyword">class</span>%<span class="hljs-number">20</span>WhileDemo%<span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">public</span>%<span class="hljs-number">20s</span>tatic%<span class="hljs-number">20</span>void%<span class="hljs-number">20</span>main%<span class="hljs-number">28S</span>tring%<span class="hljs-number">5</span>B%<span class="hljs-number">5</span>D%<span class="hljs-number">20</span>args%<span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20i</span>nt%<span class="hljs-number">20i</span>%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">200%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">while</span>%<span class="hljs-number">20%</span><span class="hljs-number">28i</span>%<span class="hljs-number">20%</span><span class="hljs-number">3</span>C%<span class="hljs-number">205%</span><span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20i</span>%<span class="hljs-number">2</span>B%<span class="hljs-number">2</span>B%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20i</span>f%<span class="hljs-number">20%</span><span class="hljs-number">28i</span>%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">3</span>D%<span class="hljs-number">202%</span><span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span><span class="hljs-keyword">continue</span>%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20i</span>f%<span class="hljs-number">20%</span><span class="hljs-number">28i</span>%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">3</span>D%<span class="hljs-number">204%</span><span class="hljs-number">29%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20</span>break%<span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20S</span>ystem.out.println%<span class="hljs-number">28%</span><span class="hljs-number">22%</span>E5%BD%<span class="hljs-number">93%</span>E5%<span class="hljs-number">89%</span><span class="hljs-number">8</span>D%<span class="hljs-number">20i</span>%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20%</span><span class="hljs-number">22%</span><span class="hljs-number">20%</span><span class="hljs-number">2</span>B%<span class="hljs-number">20i</span>%<span class="hljs-number">29%</span><span class="hljs-number">3</span>B%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">20%</span><span class="hljs-number">7</span>D%<span class="hljs-number">0</span>A%<span class="hljs-number">7</span>D&amp;cumulative=<span class="hljs-literal">false</span>&amp;curInstr=<span class="hljs-number">0&amp;</span>heapPrimitives=nevernest&amp;mode=display&amp;origin=opt-frontend.js&amp;py=java&amp;rawInputLstJSON=%<span class="hljs-number">5</span>B%<span class="hljs-number">5</span>D&amp;textReferences=<span class="hljs-literal">false</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">Python 中的变量引用示例</h3>
<p>下面是一个可以直接运行的 Python 示例，用于理解变量和对象之间的关系。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1fd3fb4232544e19b72e4ae4e82f81f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGU3ZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769847968&amp;x-signature=vIOfQFqi5nAE9%2F2VPiQAgpDPA5Q%3D" alt="python 虚拟化.gif" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss">    <span class="hljs-selector-tag">a</span> = <span class="hljs-selector-attr">[1, 2, 3]</span>
    <span class="hljs-selector-tag">b</span> = <span class="hljs-selector-tag">a</span>

    <span class="hljs-built_in">print</span>("a:", a)
    <span class="hljs-built_in">print</span>("b:", b)

    <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.append</span>(<span class="hljs-number">4</span>)

    <span class="hljs-built_in">print</span>("修改 b 之后")
    <span class="hljs-built_in">print</span>("a:", a)
    <span class="hljs-built_in">print</span>("b:", b)
</code></pre>
<p>在 PythonTutor 中可以直观看到：</p>
<ul>
<li>a 和 b 指向同一个列表对象</li>
<li>对 b 的修改会同步影响 a</li>
<li>内存中只存在一个列表实例</li>
</ul>
<p>复制下面的内容在浏览器地址访问</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">https:</span>//pythontutor.com/render.html#code=a%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20%</span><span class="hljs-number">5</span>B1,%<span class="hljs-number">202</span>,%<span class="hljs-number">203%</span><span class="hljs-number">5</span>D%<span class="hljs-number">0</span>Ab%<span class="hljs-number">20%</span><span class="hljs-number">3</span>D%<span class="hljs-number">20</span>a%<span class="hljs-number">0</span>A%<span class="hljs-number">0</span>Aprint%<span class="hljs-number">28%</span><span class="hljs-number">22</span>a%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>,%<span class="hljs-number">20</span>a%<span class="hljs-number">29%</span><span class="hljs-number">0</span>Aprint%<span class="hljs-number">28%</span><span class="hljs-number">22</span>b%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>,%<span class="hljs-number">20</span>b%<span class="hljs-number">29%</span><span class="hljs-number">0</span>A%<span class="hljs-number">0</span>Ab.append%<span class="hljs-number">284%</span><span class="hljs-number">29%</span><span class="hljs-number">0</span>A%<span class="hljs-number">0</span>Aprint%<span class="hljs-number">28%</span><span class="hljs-number">22%</span>E4%BF%AE%E6%<span class="hljs-number">94%</span>B9%<span class="hljs-number">20</span>b%<span class="hljs-number">20%</span>E4%B9%<span class="hljs-number">8</span>B%E5%<span class="hljs-number">90%</span><span class="hljs-number">8</span>E%<span class="hljs-number">22%</span><span class="hljs-number">29%</span><span class="hljs-number">0</span>Aprint%<span class="hljs-number">28%</span><span class="hljs-number">22</span>a%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>,%<span class="hljs-number">20</span>a%<span class="hljs-number">29%</span><span class="hljs-number">0</span>Aprint%<span class="hljs-number">28%</span><span class="hljs-number">22</span>b%<span class="hljs-number">3</span>A%<span class="hljs-number">22</span>,%<span class="hljs-number">20</span>b%<span class="hljs-number">29&amp;</span>cumulative=<span class="hljs-literal">false</span>&amp;curInstr=<span class="hljs-number">0&amp;</span>heapPrimitives=nevernest&amp;mode=display&amp;origin=opt-frontend.js&amp;py=<span class="hljs-number">311&amp;</span>rawInputLstJSON=%<span class="hljs-number">5</span>B%<span class="hljs-number">5</span>D&amp;textReferences=<span class="hljs-literal">false</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">适合使用 PythonTutor 的场景</h3>
<p>PythonTutor 特别适合用于：</p>
<ul>
<li>学习基础语法和控制流程</li>
<li>理解异常处理逻辑</li>
<li>掌握循环与分支的执行细节</li>
<li>学习数据结构和引用模型</li>
</ul>
<p>它并不是调试大型项目的工具，而是帮助建立正确执行认知的学习辅助工具。</p>
<hr/>
<h3 data-id="heading-9">总结</h3>
<p>PythonTutor 通过可视化的方式，把隐藏在运行时内部的执行过程完整呈现出来。无论是链表、异常处理、分支判断还是循环控制，都可以通过图形化的方式被清晰理解，是学习和教学中非常有价值的工具。</p>
<h3 data-id="heading-10">扩展</h3>
<p>IDEA 插件社区里有一个插件<code>Java Visualizer</code>可以在 IDEA 里调试时使用类似的效果，单只能下一步，不能往回走，非常好用！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3345f9fcf3014fa3b4f0cad9211466c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGU3ZXI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769847968&amp;x-signature=TU%2FOMtKSZ73XRM1yia3E%2FCjljNM%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>