<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[2025 · 我与 AI / Vibe Coding 的一年]]></title>    <link>https://juejin.cn/post/7588149079400841259</link>    <guid>https://juejin.cn/post/7588149079400841259</guid>    <pubDate>2025-12-27T03:16:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588149079400841259" data-draft-id="7588064253635526710" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 · 我与 AI / Vibe Coding 的一年"/> <meta itemprop="keywords" content="后端,前端"/> <meta itemprop="datePublished" content="2025-12-27T03:16:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoolerWu"/> <meta itemprop="url" content="https://juejin.cn/user/2400989125543272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 · 我与 AI / Vibe Coding 的一年
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2400989125543272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoolerWu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:16:36.000Z" title="Sat Dec 27 2025 03:16:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这不是一篇“AI 帮我提效”的年度总结。<br/>
相反，这是我在 2025 年里，<strong>不断给 AI 使用方式做风控建模</strong>之后，留下的一份工程化复盘。</p>
</blockquote>
<p>如果一定要给这一年一个关键词，那不是「效率」，而是——<strong>不轻信</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、为什么我选择写“风控”，而不是“成长”</h2>
<p>回看我这一年和 AI 的大量交流记录，会发现一个很反直觉的现象：<br/>
我很少真正追求“满意答案”。</p>
<p>我反复追问的是：</p>
<ul>
<li>这个结论的隐含前提是什么？</li>
<li>换一个市场状态，它还成立吗？</li>
<li>能不能写进代码？写不进去的部分算什么？</li>
<li>这是不是一种“解释顺滑，但不可执行”的假理解？</li>
</ul>
<p>这类问题，本质上不是学习问题，而是<strong>风险识别问题</strong>。</p>
<p>在工程世界里，一个系统最危险的状态不是“明显错误”，而是：</p>
<blockquote>
<p><strong>看起来一切正常，但风险从未被显式建模。</strong></p>
</blockquote>
<p>所以，与其说 2025 年我在“用 AI / Vibe Coding”，<br/>
不如说我在学习一件更重要的事：<br/>
<strong>如何在 AI 参与决策的前提下，仍然对结果负责。</strong></p>
<hr/>
<h2 data-id="heading-1">二、我对 AI 的角色认知变化：从 Copilot 到 Fuzzer</h2>
<p>年初，我对 AI 的定位更像是 Copilot：</p>
<ul>
<li>解释概念</li>
<li>补齐思路</li>
<li>快速生成方案</li>
<li>帮我把模糊想法“写完整”</li>
</ul>
<p>但随着使用频率上升，我逐渐意识到一件事：</p>
<blockquote>
<p>AI 的价值，不在于“给我答案”，<br/>
而在于<strong>它会把我没想清楚的地方无限放大</strong>。</p>
</blockquote>
<p>于是我对 AI 的使用方式开始发生迁移：</p>
<ul>
<li>不再问“这个对不对”</li>
<li>而是问“它在哪些条件下必然失败”</li>
<li>不让它裁决，而是让它制造压力</li>
</ul>
<p>在工程语境里，这种角色更像 <strong>Fuzzer</strong>：<br/>
不是用来证明系统正确，而是用来<strong>尽可能快地找出漏洞</strong>。</p>
<hr/>
<h2 data-id="heading-2">三、第一类高频风险：把“生成能力”误判为“理解能力”</h2>
<p>这是我在 2025 年最早、也最频繁踩到的坑。</p>
<p>AI 非常擅长做一件事：<br/>
<strong>把复杂概念解释得足够顺，让你以为自己已经掌握。</strong></p>
<p>但作为程序员，我越来越警惕这种“顺”。</p>
<h3 data-id="heading-3">我给自己设定的一条硬性风控规则是：</h3>
<blockquote>
<p><strong>任何无法落地为“可执行约束”的理解，都不算真的理解。</strong></p>
</blockquote>
<p>具体表现为：</p>
<ul>
<li>能不能写成 if / else？</li>
<li>能不能明确阈值来源？</li>
<li>能不能定义失效条件？</li>
<li>能不能写进 validator，而不是停留在描述层？</li>
</ul>
<p>如果答案是否定的，那这个“理解”在我这儿只能算<strong>风险资产</strong>。</p>
<p>因为它看似存在，但无法被验证、回放、约束。</p>
<hr/>
<h2 data-id="heading-4">四、Vibe Coding 的真实副作用：启动成本下降，但继续成本被掩盖</h2>
<p>Vibe Coding 在 2025 年给我带来的最大变化，确实是<strong>启动变得极其容易</strong>。</p>
<p>策略、架构、流程、Agent 设想，<br/>
很多东西几乎可以“边想边跑”。</p>
<p>但很快我发现了一个工程上非常熟悉的问题：</p>
<blockquote>
<p><strong>创建新模块很容易，维护和收敛才是真正的成本。</strong></p>
</blockquote>
<p>Vibe Coding 极大地降低了“创建”的心理门槛，<br/>
但如果没有同步引入“继续 / 淘汰”机制，系统只会越来越复杂。</p>
<h3 data-id="heading-5">我后来给自己补上的一层 Gate 是：</h3>
<ul>
<li><strong>可测性</strong>：是否有指标？（收益、回撤、命中率、延迟）</li>
<li><strong>可观测性</strong>：是否能记录 decision trace？</li>
<li><strong>可回滚性</strong>：是否有 fallback / kill switch？</li>
<li><strong>可解释性</strong>：解释是否是“条件 → 行为”，而不是自然语言？</li>
</ul>
<p>过不了 Gate 的原型，不再继续推进。</p>
<hr/>
<h2 data-id="heading-6">五、我最警惕的一类信号：AI 输出的“确定感”</h2>
<p>AI 的输出有一个天然属性：<br/>
<strong>结构完整、语气自信、逻辑闭环</strong>。</p>
<p>这在工程世界里，本身就是一种危险信号。</p>
<p>因为它会导致一个非常典型的失败模式：</p>
<blockquote>
<p>大家都觉得“看起来没问题”，<br/>
所以真正的风险没有被任何人认真审视。</p>
</blockquote>
<p>尤其是在量化和策略场景中，这种“确定感”是致命的。<br/>
不是因为它一定错，而是因为它<strong>掩盖了不确定性</strong>。</p>
<p>所以我在这一年里，刻意改变了提问方式：</p>
<ul>
<li>不再问“这个策略好不好”</li>
<li>而是问“它在什么市场状态下会失效”</li>
<li>不再关心平均表现</li>
<li>而是关心尾部风险和结构性偏差</li>
</ul>
<hr/>
<h2 data-id="heading-7">六、在量化系统里，我给 AI 设定的明确边界</h2>
<p>这一年我反复尝试、也反复退回的一个边界是：</p>
<blockquote>
<p><strong>AI 可以参与建议，但不能拥有执行权。</strong></p>
</blockquote>
<p>在系统层面，我更倾向于这样拆分：</p>
<ul>
<li><strong>Signal 层</strong>：LLM 给出方向、理由、候选参数</li>
<li><strong>Policy 层</strong>：规则、阈值、仓位、冷却时间（确定性）</li>
<li><strong>Execution 层</strong>：下单、风控、限速、容错</li>
</ul>
<p>LLM 只能存在于第一层。<br/>
第二层必须可测试、可回放。<br/>
第三层必须极度保守。</p>
<p>程序员的直觉很简单：<br/>
<strong>LLM 输出本质上是不可信输入。</strong><br/>
不做 sanitizer，就等于把用户输入直接拼 SQL 上线。</p>
<hr/>
<h2 data-id="heading-8">七、止损与调度的讨论，本质上都是风控问题</h2>
<p>无论是“时间衰减 vs 浮盈百分比”的止损讨论，<br/>
还是“15m 调度 vs 1h 调度”的争论，<br/>
在我这儿都不是参数选择问题，而是<strong>因果是否成立的问题</strong>。</p>
<ul>
<li>时间本身不是市场状态指标</li>
<li>延迟如果大于信号周期，决策就是滞后的</li>
<li>规则如果能被“钻空子”，长期一定会漂移</li>
</ul>
<p>我更愿意接受一个<strong>看起来不优雅、但前提清晰</strong>的方案，<br/>
而不是一个解释漂亮、但逻辑脆弱的方案。</p>
<hr/>
<h2 data-id="heading-9">八、关于“自进化”：我选择工程现实，而不是幻想闭环</h2>
<p>我并不否认“自进化”这个方向的吸引力。<br/>
相反，我在这一年里非常认真地拆解过它：</p>
<ul>
<li>奖励信号是否可学习？</li>
<li>样本是否足够？</li>
<li>归因是否错配？</li>
<li>成本是否可控？</li>
<li>回看偏差如何避免？</li>
</ul>
<p>最后我保留下来的版本，更像是：</p>
<ul>
<li>LLM 不参与每 tick 决策</li>
<li>快照 + embedding 用于相似行情检索</li>
<li>LLM 在关键节点给“策略调整建议”</li>
<li>执行层始终由规则兜底</li>
</ul>
<p>这不是放弃进化，而是<strong>把进化约束在工程可控范围内</strong>。</p>
<hr/>
<h2 data-id="heading-10">九、这一年的最终结论：AI 没让我更聪明，但让我更难自欺</h2>
<p>如果一定要总结 2025 年 AI / Vibe Coding 对我的影响，那会是：</p>
<blockquote>
<p><strong>AI 没有替我思考，但它让我更难在逻辑上敷衍自己。</strong></p>
</blockquote>
<p>在一个答案极度廉价、生成几乎无成本的时代，<br/>
真正稀缺的能力反而是：</p>
<ul>
<li>愿意停下来</li>
<li>能接受不确定</li>
<li>对自己的决策负责</li>
</ul>
<p>风控，从来不是限制创造力。<br/>
它只是提醒我：<br/>
<strong>每一个“看起来合理”的结论，都应该被当成潜在风险对待。</strong></p>
<hr/>
<h2 data-id="heading-11">附：我给自己固化的一份 AI 使用风控清单</h2>
<h3 data-id="heading-12">输入风控</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> LLM 输出是否有 schema？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否做了校验与兜底？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否记录 decision trace？</li>
</ul>
<h3 data-id="heading-13">策略风控</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否明确隐含前提？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否列出失效场景？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否可回放？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否有最大风险暴露限制？</li>
</ul>
<h3 data-id="heading-14">工程风控</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 延迟是否匹配调度周期？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 成本是否可控？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否可观测？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否可禁用？</li>
</ul>
<hr/>
<blockquote>
<p>真正需要被风控的，从来不是 AI。<br/>
而是我们在“答案唾手可得”时，<br/>
是否还愿意为判断承担责任。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Echarts常用配置]]></title>    <link>https://juejin.cn/post/7588010346071130122</link>    <guid>https://juejin.cn/post/7588010346071130122</guid>    <pubDate>2025-12-27T03:25:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588010346071130122" data-draft-id="7369423779309944871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Echarts常用配置"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T03:25:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小白x"/> <meta itemprop="url" content="https://juejin.cn/user/404211847925095"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Echarts常用配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/404211847925095/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小白x
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:25:07.000Z" title="Sat Dec 27 2025 03:25:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0">title设置字体</h5>
<p>textStyle</p>
<pre><code class="hljs language-css" lang="css">option = {
  title: {
    text: <span class="hljs-string">"Main Title"</span>,
    subtext: <span class="hljs-string">"Sub Title"</span>,
    left: <span class="hljs-string">"center"</span>,
    top: <span class="hljs-string">"center"</span>,
    textStyle: {
      fontSize: <span class="hljs-number">30</span>,
      fontWeight:<span class="hljs-string">'bolder'</span>
    },
    subtextStyle: {
      fontSize: <span class="hljs-number">20</span>
    }
  }
}
</code></pre>
<h5 data-id="heading-1">控制图表边距</h5>
<p>grid: {
top: '20%'，botton:'20%',left:'10%',right:'10%'
},</p>
<h5 data-id="heading-2">X轴坐标系标签，旋转角度</h5>
<pre><code class="hljs language-css" lang="css">       xAxis: [
          {
            type: <span class="hljs-string">'category'</span>,
            data: data,
            axisPointer: {
              type: <span class="hljs-string">'shadow'</span>
            },
            axisLabel: { // 坐标轴刻度标签的相关设置。
              rotate: <span class="hljs-string">'20'</span> // x轴数据标签旋转角度
            }
          }
        ],
</code></pre>
<h5 data-id="heading-3">限制柱状图最大宽度</h5>
<pre><code class="hljs language-kotlin" lang="kotlin">    series: [
          {
            name: <span class="hljs-string">'数量'</span>,
            type: <span class="hljs-string">'bar'</span>,
            barMaxWidth: <span class="hljs-number">50</span>, <span class="hljs-comment">// 最大宽度</span>
            <span class="hljs-keyword">data</span>: <span class="hljs-keyword">data</span>
          }]
</code></pre>
<h5 data-id="heading-4">柱状图渐变色</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">series</span>里面
    <span class="hljs-selector-tag">itemStyle</span>: {
              <span class="hljs-attribute">color</span>: new echarts.graphic.<span class="hljs-built_in">LinearGradient</span>(
                <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-comment">// 渐变方向从左上角到右下角</span>
                [
                  { <span class="hljs-attribute">offset</span>: <span class="hljs-number">0</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'rgb(128,100,162)'</span> }, <span class="hljs-comment">// 0% 处的颜色</span>
                  { <span class="hljs-attribute">offset</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#fff'</span> } <span class="hljs-comment">// 100% 处的颜色</span>
                ]
              )
            },
</code></pre>
<h5 data-id="heading-5">柱状图文字显示</h5>
<p>直接在取消柱子上方显示具体数据信息，以及自定义信息，比如100%，数字后面加一个百分号
1）show，显示节点上的文本信息
2）position，文本位置，可以根据需要调整为 ‘top’, ‘bottom’, ‘inside’, ‘insideTop’, 等
top，表示在节点上方</p>
<pre><code class="hljs language-kotlin" lang="kotlin">series: [
    {
      <span class="hljs-keyword">data</span>: [<span class="hljs-number">150</span>, <span class="hljs-number">230</span>, <span class="hljs-number">224</span>, <span class="hljs-number">218</span>, <span class="hljs-number">135</span>, <span class="hljs-number">147</span>, <span class="hljs-number">260</span>],
      type: <span class="hljs-string">'bar'</span>,
      label:{
        show:<span class="hljs-literal">true</span>,
        position:<span class="hljs-string">'top'</span>,
        formatter:function(<span class="hljs-keyword">data</span>){
          <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>.value+<span class="hljs-string">'件'</span>
        }
      }
    }
  ]
</code></pre>
<h5 data-id="heading-6">折线图变平滑</h5>
<p>series属性中使用smooth: true语句让折线图变成平滑折线图</p>
<h4 data-id="heading-7">echart柱状图最小间隔</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> option = {
    <span class="hljs-comment">// ... 其他配置项</span>
    yAxis: {
        <span class="hljs-keyword">type</span>: <span class="hljs-string">'value'</span>,
        <span class="hljs-comment">// 设置Y轴的最小间隔</span>
        minInterval: <span class="hljs-number">1</span> <span class="hljs-comment">// 示例值，根据实际需求进行调整</span>
    },
    <span class="hljs-comment">// ... 其他配置项</span>
};
</code></pre>
<h3 data-id="heading-8">立体柱状图</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">var</span> <span class="hljs-string">xData2</span> <span class="hljs-string">=</span> [<span class="hljs-string">'容城谷庄'</span>]
<span class="hljs-string">var</span> <span class="hljs-string">data1</span> <span class="hljs-string">=</span> [<span class="hljs-number">50</span>]
<span class="hljs-string">option</span> <span class="hljs-string">=</span> {
    <span class="hljs-attr">backgroundColor:</span> <span class="hljs-string">'rgba(0,0,0,0)'</span>,
    <span class="hljs-attr">grid:</span> {
        <span class="hljs-attr">left:</span> <span class="hljs-number">0</span>,
        <span class="hljs-attr">bottom:</span> <span class="hljs-number">15</span>,
        <span class="hljs-attr">top:</span> <span class="hljs-number">15</span>,
        <span class="hljs-attr">right:</span> <span class="hljs-number">80</span>
    },
    <span class="hljs-attr">xAxis:</span> {
        <span class="hljs-attr">data:</span> <span class="hljs-string">xData2</span>,
        <span class="hljs-attr">axisTick:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
        },
        <span class="hljs-attr">axisLine:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
        },
        <span class="hljs-attr">axisLabel:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
        }
    },
    <span class="hljs-attr">yAxis:</span> {
        <span class="hljs-attr">splitLine:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
        },
        <span class="hljs-attr">axisTick:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
        },
        <span class="hljs-attr">axisLine:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
        },
        <span class="hljs-attr">axisLabel:</span> {
            <span class="hljs-string">//</span> <span class="hljs-attr">textStyle:</span> {
            <span class="hljs-string">//</span>     <span class="hljs-attr">color:</span> <span class="hljs-string">'#fff'</span>,
            <span class="hljs-string">//</span>     <span class="hljs-attr">fontSize:</span> <span class="hljs-number">20</span>,
            <span class="hljs-string">//</span> },
            <span class="hljs-string">//</span> <span class="hljs-string">不显示Y轴数值</span>
            <span class="hljs-attr">formatter:</span> <span class="hljs-string">function</span> <span class="hljs-string">()</span> {
                <span class="hljs-string">return</span> <span class="hljs-string">''</span>
            }
        }
    },
    <span class="hljs-attr">series:</span> [
        <span class="hljs-string">//</span> <span class="hljs-string">数据低下的圆片</span>
        {
            <span class="hljs-attr">name:</span> <span class="hljs-string">''</span>,
            <span class="hljs-attr">type:</span> <span class="hljs-string">'pictorialBar'</span>,
            <span class="hljs-attr">symbolSize:</span> [<span class="hljs-number">41</span>, <span class="hljs-number">15</span>],
            <span class="hljs-attr">symbolOffset:</span> [<span class="hljs-number">0</span>, <span class="hljs-number">8</span>],
            <span class="hljs-attr">z:</span> <span class="hljs-number">12</span>,
            <span class="hljs-attr">symbol:</span> <span class="hljs-string">'circle'</span>, <span class="hljs-string">//</span> <span class="hljs-string">修改为圆形</span>
            <span class="hljs-attr">itemStyle:</span> {
                <span class="hljs-attr">opacity:</span> <span class="hljs-number">1</span>,
                <span class="hljs-attr">color:</span> <span class="hljs-string">function</span> <span class="hljs-string">(params)</span> {
                    <span class="hljs-string">return</span> <span class="hljs-string">new</span> <span class="hljs-string">echarts.graphic.LinearGradient(</span>
                        <span class="hljs-number">1</span>,
                        <span class="hljs-string">//</span> <span class="hljs-string">深色#2BA9ED</span> <span class="hljs-string">浅色</span> <span class="hljs-comment">#34EDF2</span>
                        <span class="hljs-number">0</span>,
                        <span class="hljs-number">0</span>,
                        <span class="hljs-number">0</span>,
                        [
                            {
                                <span class="hljs-attr">offset:</span> <span class="hljs-number">0</span>,
                                <span class="hljs-attr">color:</span> <span class="hljs-string">'#E1DC53'</span> <span class="hljs-string">//</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">处的颜色</span>
                            },
                            {
                                <span class="hljs-attr">offset:</span> <span class="hljs-number">1</span>,
                                <span class="hljs-attr">color:</span> <span class="hljs-string">'#E1DC53'</span> <span class="hljs-string">//</span> <span class="hljs-number">100</span><span class="hljs-string">%</span> <span class="hljs-string">处的颜色</span>
                            }
                        ],
                        <span class="hljs-literal">false</span>
                    <span class="hljs-string">)</span>
                }
                <span class="hljs-string">//</span> <span class="hljs-attr">color:</span> <span class="hljs-string">'transparent'</span>
            },
            <span class="hljs-attr">data:</span> [<span class="hljs-number">1</span>]
        },
        <span class="hljs-string">//</span> <span class="hljs-string">数据的柱状图</span>
        {
            <span class="hljs-attr">name:</span> <span class="hljs-string">''</span>,
            <span class="hljs-attr">type:</span> <span class="hljs-string">'bar'</span>,
            <span class="hljs-attr">barWidth:</span> <span class="hljs-number">41</span>,
            <span class="hljs-attr">itemStyle:</span> {
                <span class="hljs-string">//</span> <span class="hljs-string">lenged文本</span>
                <span class="hljs-attr">opacity:</span> <span class="hljs-number">1</span>, <span class="hljs-string">//</span> <span class="hljs-string">这个是</span> <span class="hljs-string">透明度</span>
                <span class="hljs-attr">color:</span> <span class="hljs-string">function</span> <span class="hljs-string">(params)</span> {
                    <span class="hljs-string">return</span> <span class="hljs-string">new</span> <span class="hljs-string">echarts.graphic.LinearGradient(</span>
                        <span class="hljs-number">0</span>,
                        <span class="hljs-number">1</span>,
                        <span class="hljs-number">0</span>,
                        <span class="hljs-number">0</span>,
                        [
                            {
                                <span class="hljs-attr">offset:</span> <span class="hljs-number">0</span>,
                                <span class="hljs-attr">color:</span> <span class="hljs-string">'#E1DC53'</span> <span class="hljs-string">//</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">处的颜色</span>
                            },
                            {
                                <span class="hljs-attr">offset:</span> <span class="hljs-number">1</span>,
                                <span class="hljs-attr">color:</span> <span class="hljs-string">'#E8AE62'</span> <span class="hljs-string">//</span> <span class="hljs-number">100</span><span class="hljs-string">%</span> <span class="hljs-string">处的颜色</span>
                            }
                        ],
                        <span class="hljs-literal">false</span>
                    <span class="hljs-string">)</span>
                }
            },

            <span class="hljs-attr">data:</span> <span class="hljs-string">data1</span>
        },
        <span class="hljs-string">//</span> <span class="hljs-string">替代柱状图</span> <span class="hljs-string">默认不显示颜色，是最下方柱图（邮件营销）的value值</span> <span class="hljs-bullet">-</span> <span class="hljs-number">20</span>
        {
            <span class="hljs-attr">type:</span> <span class="hljs-string">'bar'</span>,
            <span class="hljs-attr">symbol:</span> <span class="hljs-string">'circle'</span>, <span class="hljs-string">//</span> <span class="hljs-string">修改为圆形</span>
            <span class="hljs-attr">barWidth:</span> <span class="hljs-number">43</span>,
            <span class="hljs-attr">itemStyle:</span> {
                <span class="hljs-attr">color:</span> <span class="hljs-string">'transparent'</span>
            },
            <span class="hljs-attr">data:</span> <span class="hljs-string">data1</span>
        },
        <span class="hljs-string">//</span> <span class="hljs-string">数据顶部的样式</span>
        {
            <span class="hljs-attr">name:</span> <span class="hljs-string">''</span>,
            <span class="hljs-attr">type:</span> <span class="hljs-string">'pictorialBar'</span>,
            <span class="hljs-attr">symbol:</span> <span class="hljs-string">'circle'</span>, <span class="hljs-string">//</span> <span class="hljs-string">修改为圆形</span>
            <span class="hljs-attr">symbolSize:</span> [<span class="hljs-number">41</span>, <span class="hljs-number">15</span>],
            <span class="hljs-attr">symbolOffset:</span> [<span class="hljs-number">0</span>, <span class="hljs-number">-8</span>],
            <span class="hljs-attr">z:</span> <span class="hljs-number">12</span>,
            <span class="hljs-attr">itemStyle:</span> {
                <span class="hljs-attr">normal:</span> {
                    <span class="hljs-attr">opacity:</span> <span class="hljs-number">1</span>,
                    <span class="hljs-attr">color:</span> <span class="hljs-string">function</span> <span class="hljs-string">(params)</span> {
                        <span class="hljs-string">return</span> <span class="hljs-string">new</span> <span class="hljs-string">echarts.graphic.LinearGradient(</span>
                            <span class="hljs-number">0</span>,
                            <span class="hljs-number">0</span>,
                            <span class="hljs-number">1</span>,
                            <span class="hljs-number">0</span>,
                            [
                                {
                                    <span class="hljs-attr">offset:</span> <span class="hljs-number">0</span>,
                                    <span class="hljs-attr">color:</span> <span class="hljs-string">'#E1DC53'</span> <span class="hljs-string">//</span> <span class="hljs-number">0</span><span class="hljs-string">%</span> <span class="hljs-string">处的颜色</span>
                                },
                                {
                                    <span class="hljs-attr">offset:</span> <span class="hljs-number">1</span>,
                                    <span class="hljs-attr">color:</span> <span class="hljs-string">'#E8AE62'</span> <span class="hljs-string">//</span> <span class="hljs-number">100</span><span class="hljs-string">%</span> <span class="hljs-string">处的颜色</span>
                                }
                            ],
                            <span class="hljs-literal">false</span>
                        <span class="hljs-string">)</span>
                    },
                    <span class="hljs-attr">label:</span> {
                        <span class="hljs-attr">show:</span> <span class="hljs-literal">true</span>, <span class="hljs-string">//</span> <span class="hljs-string">开启显示</span>
                        <span class="hljs-attr">position:</span> <span class="hljs-string">'top'</span>, <span class="hljs-string">//</span> <span class="hljs-string">在上方显示</span>
                        <span class="hljs-attr">textStyle:</span> {
                            <span class="hljs-string">//</span> <span class="hljs-string">数值样式</span>
                            <span class="hljs-attr">color:</span> <span class="hljs-string">'#FFFFFF'</span>,
                            <span class="hljs-attr">fontSize:</span> <span class="hljs-number">20</span>,
                            <span class="hljs-attr">top:</span> <span class="hljs-number">50</span>
                        },
                        <span class="hljs-attr">formatter:</span> <span class="hljs-string">function</span> <span class="hljs-string">(param)</span> {
                            <span class="hljs-string">return</span> <span class="hljs-string">param.data</span> <span class="hljs-string">+</span> <span class="hljs-string">'%'</span>
                        }
                    }
                }
            },
            <span class="hljs-attr">symbolPosition:</span> <span class="hljs-string">'end'</span>,
            <span class="hljs-attr">data:</span> <span class="hljs-string">data1</span>
        },

        <span class="hljs-string">//</span> <span class="hljs-string">阴影的顶部</span>
        {
            <span class="hljs-attr">name:</span> <span class="hljs-string">''</span>, <span class="hljs-string">//</span> <span class="hljs-string">头部</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">'pictorialBar'</span>,
            <span class="hljs-attr">symbol:</span> <span class="hljs-string">'circle'</span>, <span class="hljs-string">//</span> <span class="hljs-string">修改为圆形</span>
            <span class="hljs-attr">symbolSize:</span> [<span class="hljs-number">41</span>, <span class="hljs-number">15</span>],
            <span class="hljs-attr">symbolOffset:</span> [<span class="hljs-number">0</span>, <span class="hljs-number">-8</span>],
            <span class="hljs-attr">z:</span> <span class="hljs-number">17</span>,
            <span class="hljs-attr">symbolPosition:</span> <span class="hljs-string">'end'</span>,
            <span class="hljs-attr">itemStyle:</span> {
                <span class="hljs-attr">color:</span> <span class="hljs-string">'rgba(24,78,134,0.3)'</span>,
                <span class="hljs-attr">opacity:</span> <span class="hljs-number">0.3</span>,
                <span class="hljs-attr">borderWidth:</span> <span class="hljs-number">1</span>,
                <span class="hljs-attr">borderColor:</span> <span class="hljs-string">'#526558'</span>
            },
            <span class="hljs-attr">data:</span> [<span class="hljs-number">100</span>]
        },
        <span class="hljs-string">//</span> <span class="hljs-string">后面的背景</span>
        {
            <span class="hljs-attr">name:</span> <span class="hljs-string">'2019'</span>,
            <span class="hljs-attr">type:</span> <span class="hljs-string">'bar'</span>,
            <span class="hljs-attr">barWidth:</span> <span class="hljs-number">41</span>,
            <span class="hljs-attr">barGap:</span> <span class="hljs-string">'-100%'</span>,
            <span class="hljs-attr">z:</span> <span class="hljs-number">0</span>,
            <span class="hljs-attr">itemStyle:</span> {
                <span class="hljs-attr">color:</span> <span class="hljs-string">'rgba(24,78,134,0.1)'</span>
            },
            <span class="hljs-attr">data:</span> [<span class="hljs-number">100</span>]
        }
    ]
}
</code></pre>
<h5 data-id="heading-9">Echarts给柱状图上面增加小横杠</h5>
<pre><code class="hljs language-css" lang="css"> option = {
      title: {
        text: <span class="hljs-string">'世界人口统计'</span>,
        left: <span class="hljs-string">'center'</span>,
        textStyle: {
          fontSize: <span class="hljs-number">24</span>,
          fontWeight: <span class="hljs-string">'bold'</span>,
          color: <span class="hljs-string">'#333'</span>
        }
      },

      xAxis: {
        type: <span class="hljs-string">'value'</span>,
        boundaryGap: [<span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>],
        name: <span class="hljs-string">'人口 (万)'</span>,
        nameLocation: <span class="hljs-string">'middle'</span>,
        nameGap: <span class="hljs-number">30</span>,
        axisLabel: {
          formatter: <span class="hljs-built_in">function</span>(value) {
            if (value &gt;= <span class="hljs-number">10000</span>) {
              return (value / <span class="hljs-number">10000</span>) + '亿';
            }
            return value;
          }
        }
      },
      yAxis: {
        type: <span class="hljs-string">'category'</span>,
        data: [<span class="hljs-string">'巴西'</span>,  <span class="hljs-string">'中国'</span>, <span class="hljs-string">'世界'</span>],
        axisLabel: {
          <span class="hljs-attribute">color</span>: <span class="hljs-string">'#666'</span>,
          fontSize: <span class="hljs-number">14</span>
        }
      },
      series: [
        {
          name: <span class="hljs-string">'2011'</span>,
          type: <span class="hljs-string">'bar'</span>,
          data: [<span class="hljs-number">10</span>,<span class="hljs-number">20</span>],
          itemStyle: {
            borderRadius: [<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>],
            color: <span class="hljs-string">'#36A2EB'</span>
          },
          <span class="hljs-selector-tag">label</span>: {
            show: true,
            position: <span class="hljs-string">'right'</span>,
            formatter: <span class="hljs-built_in">function</span>(params) {
              return params<span class="hljs-selector-class">.value</span><span class="hljs-selector-class">.toLocaleString</span>();
            }
          },
          markPoint: {
             symbol: <span class="hljs-string">'rect'</span>,
             symbolSize: [<span class="hljs-number">4</span>, <span class="hljs-number">20</span>],
            data: [
              {
                // 标记巴西 (<span class="hljs-number">2011</span>)
                name: <span class="hljs-string">''</span>,
                coord: [<span class="hljs-number">10</span>, <span class="hljs-string">'巴西'</span>],
                itemStyle: { <span class="hljs-attribute">color</span>: <span class="hljs-string">'#FF6384'</span> }
              },
              {
                // 标记中国 (<span class="hljs-number">2011</span>)
                name: <span class="hljs-string">''</span>,
                coord: [<span class="hljs-number">20</span>, <span class="hljs-string">'中国'</span>],
                itemStyle: { <span class="hljs-attribute">color</span>: <span class="hljs-string">'#FF6384'</span> }
              }
            ]
          }
        }
      ]
    };


</code></pre>
<pre><code class="hljs">javascript

</code></pre>
<p>markPoint: {
symbol: 'rect',  // 标记点形状为矩形
symbolSize: [4, 20],  // 标记点大小
data: [
{ name: '', coord: [2, 36], value: 36 }  // 关键配置
]
}</p>
<pre><code class="hljs language-markdown" lang="markdown">
  


假设这是一个<span class="hljs-strong">**折线图或柱状图**</span>（直角坐标系）：

  


<span class="hljs-bullet">-</span>   <span class="hljs-strong">**`coord: [2, 36]`**</span>  的含义：

<span class="hljs-bullet">    -</span>   <span class="hljs-strong">**`2`**</span>：在 X 轴上，对应<span class="hljs-strong">**第 3 个类目**</span>（索引从 0 开始，例如 <span class="hljs-code">`['一月', '二月', '三月', ...]`</span> 中的 <span class="hljs-code">`'三月'`</span>）。
<span class="hljs-bullet">    -</span>   <span class="hljs-strong">**`36`**</span>：在 Y 轴上的数值位置（例如 Y 轴范围是 0~100，标记点位于 Y=36 的高度）。

<span class="hljs-bullet">-</span>   <span class="hljs-strong">**效果**</span>：在 X 轴第 3 个类目（<span class="hljs-code">`'三月'`</span>）与 Y 轴数值 36 的交叉点处，绘制一个 4×20 大小的矩形标记
</code></pre>
<h6 data-id="heading-10">柱状图文字太多不显示</h6>
<p><strong>优化 X 轴标签显示</strong></p>
<p>若标签文字过长或过多，即使调整柱子间距仍可能显示不全，需进一步配置 <code>axisLabel</code>。</p>
<p><strong>1. 强制显示所有标签（避免省略）</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">xAxis</span>: {
  <span class="hljs-attr">axisLabel</span>: {
    <span class="hljs-attr">interval</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 强制显示所有标签（默认自动隐藏部分标签）</span>
    <span class="hljs-comment">// 或使用 formatter 换行（适用于长标签）</span>
    <span class="hljs-attr">formatter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">value</span>) {
      <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">split</span>(<span class="hljs-string">''</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n'</span>); <span class="hljs-comment">// 按字符换行（示例）</span>
      <span class="hljs-comment">// 或根据字数换行：return value.substr(0, 4) + '\n' + value.substr(4);</span>
    }
  }
}
</code></pre>
<p><strong>2. 旋转标签文字</strong></p>
<p>通过 <code>rotate</code> 调整文字角度，避免重叠：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">xAxis:</span> {
  <span class="hljs-attr">axisLabel:</span> {
    <span class="hljs-attr">rotate:</span> <span class="hljs-number">45</span>, <span class="hljs-string">//</span> <span class="hljs-string">旋转角度（建议</span> <span class="hljs-number">30</span><span class="hljs-string">°~60°，避免垂直显示）</span>
    <span class="hljs-attr">margin:</span> <span class="hljs-number">10</span> <span class="hljs-string">//</span> <span class="hljs-string">标签与轴的间距，防止被柱子遮挡</span>
  }
}
</code></pre>
<p><strong>3. 自适应隐藏部分标签</strong></p>
<p>若必须显示部分标签，可通过 <code>interval</code> 控制显示间隔（如每隔 N 个显示 1 个）：</p>
<pre><code class="hljs language-css" lang="css">xAxis: {
  axisLabel: {
    interval: <span class="hljs-number">1</span> // <span class="hljs-number">0</span>=全部显示，<span class="hljs-number">1</span>=隔 <span class="hljs-number">1</span> 个显示 <span class="hljs-number">1</span> 个，<span class="hljs-number">2</span>=隔 <span class="hljs-number">2</span> 个显示 <span class="hljs-number">1</span> 个，依此类推
  }
}
</code></pre>
<h5 data-id="heading-11">取消Y轴分割线</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">yAxis:</span> {
          <span class="hljs-attr">type:</span> <span class="hljs-string">'value'</span>,
          <span class="hljs-attr">splitLine:</span> {
            <span class="hljs-attr">show:</span> <span class="hljs-literal">false</span>
          }
        }<span class="hljs-string">,</span>
</code></pre>
<h5 data-id="heading-12">y轴上方标题</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">option</span> = {
  yAxis: {
    name: '数量\n（个）',  // 名称和单位分行
    nameLocation: 'end',
    nameGap: 5,
    nameTextStyle: {
      <span class="hljs-attribute">color</span>: <span class="hljs-string">'#333'</span>,       <span class="hljs-comment">// 深色文本</span>
      <span class="hljs-attribute">align</span>: <span class="hljs-string">'left'</span>,       <span class="hljs-comment">// 左对齐</span>
      <span class="hljs-attribute">lineHeight</span>: <span class="hljs-number">16</span>,      <span class="hljs-comment">// 行高控制间距</span>
      <span class="hljs-attribute">padding</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">8</span>]  <span class="hljs-comment">// 往左偏移更多</span>
    },
    <span class="hljs-comment">// 其他配置...</span>
  },
  <span class="hljs-comment">// 其他配置...</span>
};
</code></pre>
<h6 data-id="heading-13">设置柱状图间隔（象形图）</h6>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/617161a40383446da0142929ae8e7fea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP55m9eA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767410707&amp;x-signature=m%2BSDa0l8D9IZe4JftmIfX4zEvuw%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-14">echart分组柱状图没数组不展示</h5>
<pre><code class="hljs language-ini" lang="ini">  // 原始数据源（模拟有缺失数据的场景）
      let <span class="hljs-attr">tufang</span> = [<span class="hljs-number">100</span>, <span class="hljs-number">200</span>, <span class="hljs-number">150</span>, <span class="hljs-number">80</span>, <span class="hljs-number">70</span>, <span class="hljs-number">110</span>, <span class="hljs-number">10</span>]<span class="hljs-comment">;</span>
      let <span class="hljs-attr">qiaoliang</span> = [<span class="hljs-number">100</span>, <span class="hljs-number">80</span>, <span class="hljs-number">90</span>, <span class="hljs-number">0</span>, <span class="hljs-number">60</span>, <span class="hljs-number">0</span>, <span class="hljs-number">150</span>]<span class="hljs-comment">;</span>
      let <span class="hljs-attr">suidao</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">90</span>, <span class="hljs-number">150</span>, <span class="hljs-number">80</span>, <span class="hljs-number">70</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>]<span class="hljs-comment">;</span>
      let <span class="hljs-attr">lumian</span> = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">80</span>, <span class="hljs-number">70</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
      let <span class="hljs-attr">jidian</span> = [<span class="hljs-number">90</span>, <span class="hljs-number">190</span>, <span class="hljs-number">150</span>, <span class="hljs-number">0</span>, <span class="hljs-number">70</span>, <span class="hljs-number">0</span>, <span class="hljs-number">10</span>]<span class="hljs-comment">;</span>
      const <span class="hljs-attr">option</span> = {
        tooltip: {},
        title: {
          show: true,
          text: '不符合常理的柱状图表实现',
          textStyle: {
            fontSize: 14,
            lineHeight: 18,
            width: 10
          }
        },
        xAxis: <span class="hljs-section">[
          {
            type: 'category',
            axisLabel: {
              align: 'center',
              hideOverlap: true
            },
            data: this.specificKeys
          }
        ]</span>,
        yAxis: <span class="hljs-section">[
          {
            type: 'value'
          }
        ]</span>,
        series: <span class="hljs-section">[
          {
            type: 'custom',
            renderItem: function (params, api) {
              return getRect(params, api);
            },
            data: tufang
          },
          {
            type: 'custom',
            renderItem: function (params, api) {
              return getRect(params, api);
            },
            data: qiaoliang
          },
          {
            type: 'custom',
            renderItem: function (params, api) {
              return getRect(params, api);
            },
            data: suidao
          },
          {
            type: 'custom',
            renderItem: function (params, api) {
              return getRect(params, api);
            },
            data: lumian
          },
          {
            type: 'custom',
            renderItem: function (params, api) {
              return getRect(params, api);
            },
            data: jidian
          }
        ]</span>
      }

      function getRect (params, api) {
        let <span class="hljs-attr">dataSeries</span> = [
          tufang,
          qiaoliang,
          suidao,
          lumian,
          jidian
        ]<span class="hljs-comment">; // 确保这里有5个数据系列</span>
        const { seriesIndex } = params<span class="hljs-comment">;</span>
        let <span class="hljs-attr">categoryIndex</span> = api.value(<span class="hljs-number">0</span>)<span class="hljs-comment">; // x轴序列</span>
        let <span class="hljs-attr">vald</span> = api.value(<span class="hljs-number">1</span>)<span class="hljs-comment">; // 数据值</span>
        // 如果数据为0，则不渲染柱子
        if (<span class="hljs-attr">vald</span> === <span class="hljs-number">0</span>) {
          return<span class="hljs-comment">;</span>
        }
        let <span class="hljs-attr">start</span> = api.coord([categoryIndex, vald])<span class="hljs-comment">;</span>
        let <span class="hljs-attr">height</span> = api.size([<span class="hljs-number">0</span>, vald])<span class="hljs-comment">;</span>
        // 柱子宽度和间距
        let <span class="hljs-attr">barWidth</span> = <span class="hljs-number">30</span><span class="hljs-comment">; // 单个柱子的固定宽度</span>
        let <span class="hljs-attr">barGap</span> = <span class="hljs-number">3</span><span class="hljs-comment">; // 柱子之间的间距</span>
        // 计算当前系列的偏移量
        let <span class="hljs-attr">xOffset</span> = dataSeries.slice(<span class="hljs-number">0</span>, seriesIndex).reduce((sum, currentSeries, index) =&gt; {
          return sum + (currentSeries<span class="hljs-section">[categoryIndex]</span> !== undefined &amp;&amp; currentSeries<span class="hljs-section">[categoryIndex]</span> !== 0 ? barWidth + barGap : 0)<span class="hljs-comment">;</span>
        }, 0)<span class="hljs-comment">;</span>
        // 计算当前系列的x位置
        let <span class="hljs-attr">x</span> = start[<span class="hljs-number">0</span>] - barWidth / <span class="hljs-number">2</span> + x<span class="hljs-literal">Off</span>set - <span class="hljs-number">10</span><span class="hljs-comment">; // 柱子的中心位置 再减20是因为让其起点靠中间左边点</span>
        return {
          type: 'rect',
          shape: {
            x: x, // 当前柱子的x位置
            y: start<span class="hljs-section">[1]</span>,
            width: barWidth,
            height: height<span class="hljs-section">[1]</span>
          },
          style: api.style()
        }<span class="hljs-comment">;</span>
      }
      option &amp;&amp; this<span class="hljs-section">[myChart]</span>.setOption(option, true)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[css和图片主题色“提取”]]></title>    <link>https://juejin.cn/post/7588067055481176073</link>    <guid>https://juejin.cn/post/7588067055481176073</guid>    <pubDate>2025-12-27T03:33:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588067055481176073" data-draft-id="7584297353419554816" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="css和图片主题色“提取”"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T03:33:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hello_Code"/> <meta itemprop="url" content="https://juejin.cn/user/3423198551742986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            css和图片主题色“提取”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3423198551742986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hello_Code
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:33:01.000Z" title="Sat Dec 27 2025 03:33:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这个想法是来源于「性能优化」中的骨架屏：
在图片居多的站点中，这将是非常nice的体验 —— 图片加载通常是比较让人难受的，好的骨架中一般占位图就是低像素的图片，即大体配色和变化是和实际内容一致的。
有时候比如图片不固定的，那可以使用算法获取图片的主体颜色（至少得是同色系的吧），使用纯色块占位。</p>
<p>再进一步想到，在一些“轻松”的场景下，我们可以让背景色/页面主题色跟随轮播图改变。至于效果嘛......你们可以想一下网易云音乐滑动切歌时的背景效果。</p>
<p>因为是不固定图片，所以我想到了四种方法：</p>
<ul>
<li>tensorflow.js 图像色彩分析</li>
<li>canvas对图片主基调进行分析，取大概值</li>
<li>css高斯模糊</li>
<li>上传图片时后端对图片分析处理，返回时直接返回一张低像素图片</li>
</ul>
<p>第一种方式目前还在我的实践中，以后会单独出一篇文章；最后一种方式个人不太建议首选：首先后端处理也需要时间，另一方面毕竟也是以图片进行传输的...yee~（而且后端可能也不太建议你首选🤣）</p>
<blockquote>
<p>想看实际效果的推荐自己动手试下，因为我发现本文中用QQ截屏截取的图片怎么都这么暗啊，实际展示的还是挺漂亮的。</p>
</blockquote>
<p>第三种方式看起来是纯css实现的，怎么获取呢？这就要说到css中的<code>filter: blur();</code> 简单来说，利用模糊滤镜及进一步拉伸，可以近似地拿到一张图片的主题色：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">div</span> {
	<span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">图片地址</span>);
	<span class="hljs-attribute">background-size</span>: cover;
	<span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">50px</span>);
}
</code></pre>
<p>你看，通过比较大的一个模糊滤镜，将图片高斯模糊<code>50px</code>，模糊后的图片是不是有点内味了，
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4d41533314a4281a4e3be5d4a58a7ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaGVsbG9fQ29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411181&amp;x-signature=9tcl0Xgq36va%2BEdBzcFbUrRvgmc%3D" alt="ruawaba" loading="lazy"/></p>
<p>不过还不行，存在一些模糊边缘，我们可以利用<code>overflow</code>进行剪裁。</p>
<p>接下来，我们需要去掉模糊的边角，以及通过<code>transform: scale()</code>放大效果，将颜色进一步聚焦：
这里就很推荐使用伪元素进行操作了</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">div</span> {
	<span class="hljs-attribute">position</span>: relative;
	<span class="hljs-attribute">width</span>: xx;
	<span class="hljs-attribute">height</span>: xx;
	<span class="hljs-attribute">overflow</span>: hidden;
}
<span class="hljs-selector-tag">div</span><span class="hljs-selector-pseudo">::before</span> {
	<span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
	<span class="hljs-attribute">position</span>: absolute;
	<span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
	<span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
	<span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
	<span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
	<span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">图片地址</span>);
	<span class="hljs-attribute">background-size</span>: cover;
	<span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">50px</span>);
	<span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">2</span>); //自行更改
	<span class="hljs-attribute">transform-origin</span>: center center;
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2b1a3bb0b154d1f8d76be8095417647~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaGVsbG9fQ29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411181&amp;x-signature=vQDb5MIAosRrwntXQoe9hqyBr4E%3D" alt="ruawaba2" loading="lazy"/></p>
<p>这样就拿到图片的主色调了。当然是要进行其他处理的。</p>
<p>再来说说第二种方法 —— canvas。其实也不建议，因为本身就是JS操作，而在图片又不固定又有些多的情况下单线程的js处理这种“一级事件”造成的性能和体验感的损失是不可想象的。但本文笔者还是要分享一下，因为这是我当初研究的第一个被应用的成果（有情怀了嘿嘿）</p>
<p>首先，canvas中的<code>getImageData()</code>方法可以获取图片的像素集合：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getImagePixel</span>(<span class="hljs-params">canvas, img</span>) {
	<span class="hljs-keyword">const</span> context = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);
	context.<span class="hljs-title function_">drawImage</span>(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
	<span class="hljs-keyword">return</span> context.<span class="hljs-title function_">getImageData</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>).<span class="hljs-property">data</span>;
}
</code></pre>
<blockquote>
<p>这里对使用canvas不熟悉的同学提个醒：img是异步加载的，所有对图片的操作都要放在 img 的 onload 中进行 —— 你可以考虑用 promise 做这件事。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3b83bad613a44c9a6aa81307ea969d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaGVsbG9fQ29kZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411181&amp;x-signature=gqzPlfJytUiHUYp2pgwktNU3OEA%3D" alt="rgba" loading="lazy"/></p>
<p>调用这个函数会拿到一个数组 —— 它是rgba值，也就是说，处理时四个数据为“一组”，更通俗地说，for循环中<code>i+=4</code>！来处理一下数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getCountArr</span>(<span class="hljs-params">pData</span>) {
	<span class="hljs-keyword">let</span> colorList = [], rgba = [], rgbaStr = <span class="hljs-string">''</span>;
	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>; i&lt;pData.<span class="hljs-property">length</span>; i+=<span class="hljs-number">4</span>) {
		rgba[<span class="hljs-number">0</span>] = pData[i];
		rgba[<span class="hljs-number">1</span>] = pData[i+<span class="hljs-number">1</span>];
		rgba[<span class="hljs-number">2</span>] = pData[i+<span class="hljs-number">2</span>];
		rgba[<span class="hljs-number">3</span>] = pData[i+<span class="hljs-number">3</span>];
		<span class="hljs-keyword">if</span>(rgba.<span class="hljs-title function_">indexOf</span>(<span class="hljs-literal">undefined</span>)!==-<span class="hljs-number">1</span> || pData[i+<span class="hljs-number">3</span>] === <span class="hljs-number">0</span>) {
			<span class="hljs-keyword">continue</span>;
		}
		rgbaStr = rgba.<span class="hljs-title function_">join</span>(<span class="hljs-string">','</span>);
		<span class="hljs-keyword">if</span>(rgbaStr <span class="hljs-keyword">in</span> colorList) {
			++colorList[rgbaStr];
		}<span class="hljs-keyword">else</span> {
			colorList[rgbaStr] = <span class="hljs-number">1</span>;
		}
	}
	<span class="hljs-keyword">return</span> colorList;
}
</code></pre>
<p>这个时候，得到的就是每组数据（色值）出现的次数了。
然后改写刚刚的getImagePixel函数：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> <span class="hljs-title function_">getCountArr</span>(pixelData);
</code></pre>
<p>至此，我们将其排序并取出第一个值/或者取出某些标志项的平均值，基本上就可以将其作为 background 值了！</p>
<hr/>
<p>峰回路转!</p>
<p>你难道真觉得canvas的这种方法只是鸡肋？那试想这样一种场景：在弱网情况下，图片必定贼慢才能加载出来。这时候我们通过js拿到图片的主色调并填充到图片的位置中。这是不是一个“模糊渐变加载”的绝佳场景！
而且，笔者曾经遇到这样一个场景：往图片上添加文字。这时候你就需要注意一个问题，图片主色调。用canvas分析图片的主要颜色或平均色可以在深色调时添加白色文字在浅色调时添加黑色文字！</p>
<blockquote>
<p>笔者前段时间弄了一个微信公众号：前端Code新谈。里面暂时有webrtc、前端面试和用户体验系列文章，欢迎关注！希望能够帮到大家，也希望能互相交流！共同进步</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3与iframe通信方案详解：本地与跨域场景]]></title>    <link>https://juejin.cn/post/7588031908171579401</link>    <guid>https://juejin.cn/post/7588031908171579401</guid>    <pubDate>2025-12-27T03:42:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588031908171579401" data-draft-id="7587779957674557491" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3与iframe通信方案详解：本地与跨域场景"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-27T03:42:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小杨梅君"/> <meta itemprop="url" content="https://juejin.cn/user/1086792572082391"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3与iframe通信方案详解：本地与跨域场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1086792572082391/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小杨梅君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:42:55.000Z" title="Sat Dec 27 2025 03:42:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>ps:本项目使用的vue3技术栈</code></p>
<h2 data-id="heading-0">Vue3与iframe通信方案详解：本地与跨域场景</h2>
<p>本文详细介绍了在Vue3项目中，与内嵌iframe（包括本地HTML文件和服务端跨域HTML）进行双向通信的完整解决方案。核心通信方式为<code>postMessage</code> API，并针对不同场景提供了安全可靠的代码示例。</p>
<h3 data-id="heading-1">1. iframe加载本地HTML文件</h3>
<h4 data-id="heading-2">1.1 Vue端通信代码</h4>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
...
    &lt;iframe
        ref=<span class="hljs-string">"iframe"</span>
        name=<span class="hljs-string">"iframe-html"</span>
        src=<span class="hljs-string">"./index.html"</span>
        width=<span class="hljs-string">"100%"</span>
        height=<span class="hljs-string">"100%"</span>
        frameborder=<span class="hljs-string">"0"</span>
    &gt;&lt;/iframe&gt;
...
&lt;/template
</code></pre>
<p>如何在vue端跟iframe端加载的.html文件进行通讯呢,看下面的代码</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// vue端</span>
...
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendMsg2iframe</span> = (<span class="hljs-params">msg</span>) =&gt; {
    <span class="hljs-variable language_">window</span>[<span class="hljs-string">"iframe-html"</span>].<span class="hljs-title function_">sendMsg2iframe</span>(msg);
}
...
<span class="hljs-comment">// index.html</span>
...
<span class="hljs-variable language_">window</span>.<span class="hljs-property">sendMsg2iframe</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">msg</span>) {
    <span class="hljs-comment">// 接收到vue端发来的消息</span>
}
...
</code></pre>
<h4 data-id="heading-3">1.2 iframe端（index.html）通信代码</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// index.html</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessageToVue</span>(<span class="hljs-params">messageData</span>) {
    <span class="hljs-comment">// 发送消息到父窗口</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">postMessage</span>(messageData, <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>);
}

<span class="hljs-comment">// vue端</span>
<span class="hljs-comment">// 组件挂载时开始监听消息</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, handleReceiveMessage);
});

<span class="hljs-comment">// 组件卸载时移除监听，防止内存泄漏</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'message'</span>, handleReceiveMessage);
});

<span class="hljs-comment">// 接收来自iframe消息的处理函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReceiveMessage</span> = (<span class="hljs-params">event</span>) =&gt; {
  <span class="hljs-comment">// 重要：在实际应用中，应验证event.origin以确保安全</span>
  <span class="hljs-comment">// if (event.origin !== '期望的源') return;</span>
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Vue组件收到来自iframe的消息:'</span>, event.<span class="hljs-property">data</span>);
  <span class="hljs-comment">// 在这里处理接收到的数据</span>
};
</code></pre>
<h3 data-id="heading-4">2. iframe加载服务器HTML（跨域场景）</h3>
<p>其实还是通过window的postMessage进行通讯,只不过是涉及到了跨域问题,下面是具体的代码,关键在于postMessage的第二个参数上</p>
<h4 data-id="heading-5">2.1 html端通信代码</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// .html</span>
...
<span class="hljs-comment">// 获取url并解析出父窗口的origin</span>
<span class="hljs-keyword">const</span> urlParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
<span class="hljs-keyword">const</span> parentOrigin = urlParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">'parentOrigin'</span>) || <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>;
<span class="hljs-comment">// 监听来自父窗口的消息</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> === parentOrigin) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到来自父窗口的消息:'</span>, event.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">if</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'sendJSON2Unity'</span>){
            <span class="hljs-variable language_">window</span>.<span class="hljs-title class_">SendJSON2Unity</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>);
        }
    }
});
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessageToVue</span>(<span class="hljs-params">messageData</span>) {
    <span class="hljs-comment">// 发送消息到父窗口</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">postMessage</span>(messageData, parentOrigin);
}
...
</code></pre>
<h4 data-id="heading-6">2.2 Vue端通信代码</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// .vue</span>
...
&lt;iframe
    ref=<span class="hljs-string">"iframeRef"</span>
    name=<span class="hljs-string">"unity-home"</span>
    :src=<span class="hljs-string">"violationDocumentURL"</span>
    width=<span class="hljs-string">"100%"</span>
    height=<span class="hljs-string">"100%"</span>
    frameborder=<span class="hljs-string">"0"</span>
    @load=<span class="hljs-string">"onIframeLoad"</span>&gt;
&lt;/iframe&gt;
...
<span class="hljs-comment">// 这里把自己的origin通过URL参数传给iframe</span>
<span class="hljs-keyword">const</span> violationDocumentURL = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_U3D_SERVICE</span> + <span class="hljs-string">"具体路径"</span> + <span class="hljs-string">"?parentOrigin="</span> + <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>);

<span class="hljs-keyword">const</span> iframeRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">const</span> iframeOrigin = <span class="hljs-title function_">ref</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_U3D_SERVICE</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\/$/</span>, <span class="hljs-string">""</span>));  <span class="hljs-comment">// iframe加载的资源的origin</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">sendToUnity</span> = (<span class="hljs-params">data</span>) =&gt; {
    iframeRef.<span class="hljs-property">value</span>.<span class="hljs-property">contentWindow</span>.<span class="hljs-title function_">postMessage</span>(
        data,
        iframeOrigin.<span class="hljs-property">value</span>
    );
};

<span class="hljs-comment">// 组件挂载时开始监听消息</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, handleReceiveMessage);
});

<span class="hljs-comment">// 组件卸载时移除监听，防止内存泄漏</span>
<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'message'</span>, handleReceiveMessage);
});
<span class="hljs-comment">// 接收来自iframe的消息</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMessageFromIframe</span> = (<span class="hljs-params">event</span>) =&gt; {
    <span class="hljs-comment">// 确保消息来自可信的来源</span>
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> === iframeOrigin.<span class="hljs-property">value</span>) {
        <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>) {
            <span class="hljs-comment">// do something</span>
        }
    }
};
</code></pre>
<p>ok基本就是这样的</p>
<h3 data-id="heading-7">3 服务器HTML端（Unity WebGL示例）</h3>
<p>因为我们是加载的unity的webgl包,所以最后附赠一下打出的webgl包的index.html的代码(ps:是不压缩版的)</p>
<pre><code class="hljs language-js" lang="js">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en-us"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100%; height: 100%"</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span> /&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Content-Type"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"text/html; charset=utf-8"</span> /&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Unity WebGL Player | NanDingGDS<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"unity3d-body"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"text-align: center; padding: 0; border: 0; margin: 0; width: 100%; height: 100%; overflow: hidden"</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"unity-canvas"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"background: #231f20"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
			<span class="hljs-comment">/** unity的web包加载逻辑开始 */</span>
			<span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"unity-canvas"</span>);
			<span class="hljs-keyword">const</span> body = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"unity3d-body"</span>);
			<span class="hljs-keyword">const</span> { clientHeight, clientWidth } = body;

			<span class="hljs-keyword">if</span> (<span class="hljs-regexp">/iPhone|iPad|iPod|Android/i</span>.<span class="hljs-title function_">test</span>(navigator.<span class="hljs-property">userAgent</span>)) {
				<span class="hljs-keyword">var</span> meta = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"meta"</span>);
				meta.<span class="hljs-property">name</span> = <span class="hljs-string">"viewport"</span>;
				meta.<span class="hljs-property">content</span> = <span class="hljs-string">"width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes"</span>;
				<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">"head"</span>)[<span class="hljs-number">0</span>].<span class="hljs-title function_">appendChild</span>(meta);
				container.<span class="hljs-property">className</span> = <span class="hljs-string">"unity-mobile"</span>;
				canvas.<span class="hljs-property">className</span> = <span class="hljs-string">"unity-mobile"</span>;
			} <span class="hljs-keyword">else</span> {
				canvas.<span class="hljs-property">width</span> = clientWidth;
				canvas.<span class="hljs-property">height</span> = clientHeight;
			}

			<span class="hljs-keyword">const</span> baseUrl = <span class="hljs-string">"Build/webgl"</span>;
			<span class="hljs-keyword">var</span> loaderUrl = baseUrl + <span class="hljs-string">".loader.js"</span>;
			<span class="hljs-keyword">var</span> myGameInstance = <span class="hljs-literal">null</span>;
			<span class="hljs-keyword">var</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"script"</span>);
			script.<span class="hljs-property">src</span> = loaderUrl;
			<span class="hljs-keyword">var</span> config = {
				<span class="hljs-attr">dataUrl</span>: baseUrl + <span class="hljs-string">".data"</span>,
				<span class="hljs-attr">frameworkUrl</span>: baseUrl + <span class="hljs-string">".framework.js"</span>,
				<span class="hljs-attr">codeUrl</span>: baseUrl + <span class="hljs-string">".wasm"</span>,
				<span class="hljs-attr">streamingAssetsUrl</span>: <span class="hljs-string">"StreamingAssets"</span>,
				<span class="hljs-attr">companyName</span>: <span class="hljs-string">"DefaultCompany"</span>,
				<span class="hljs-attr">productName</span>: <span class="hljs-string">"FanWeiZhang"</span>,
				<span class="hljs-attr">productVersion</span>: <span class="hljs-string">"0.1.0"</span>,
			};
			script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
				<span class="hljs-title function_">createUnityInstance</span>(canvas, config, <span class="hljs-function">(<span class="hljs-params">progress</span>) =&gt;</span> {}).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">unityInstance</span>) =&gt;</span> {
					myGameInstance = unityInstance;
					<span class="hljs-title function_">sendMessageToVue</span>({
						<span class="hljs-attr">type</span>: <span class="hljs-string">"unityLoaded"</span>,
						<span class="hljs-attr">message</span>: <span class="hljs-string">"Unity3D加载完成"</span>,
					});
				});
			};
			<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script);
			<span class="hljs-comment">/** unity的web包加载逻辑结束 */</span>

			<span class="hljs-comment">// 获取url并解析出父窗口的origin</span>
			<span class="hljs-keyword">const</span> urlParams = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
			<span class="hljs-keyword">const</span> parentOrigin = urlParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">"parentOrigin"</span>) || <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>;
			<span class="hljs-comment">// 监听来自父窗口的消息</span>
			<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"message"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
				<span class="hljs-keyword">if</span> (event.<span class="hljs-property">origin</span> === parentOrigin) {
					<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"收到来自父窗口的消息:"</span>, event.<span class="hljs-property">data</span>);
					<span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">"sendJSON2Unity"</span>) {
						<span class="hljs-variable language_">window</span>.<span class="hljs-title class_">SendJSON2Unity</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>);
					}
				}
			});
			<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessageToVue</span>(<span class="hljs-params">messageData</span>) {
				<span class="hljs-comment">// 发送消息到父窗口</span>
				<span class="hljs-variable language_">window</span>.<span class="hljs-property">parent</span>.<span class="hljs-title function_">postMessage</span>(messageData, parentOrigin);
			}

			<span class="hljs-variable language_">window</span>.<span class="hljs-property">SendJSON2Unity</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">str</span>) {
				<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"发送到Unity的JSON字符串:"</span>, str);
				myGameInstance.<span class="hljs-title class_">SendMessage</span>(<span class="hljs-string">"WebController"</span>, <span class="hljs-string">"receiveJSONByWeb"</span>, str);
			};

			<span class="hljs-variable language_">window</span>.<span class="hljs-property">QuiteUnity</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
				<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"退出Unity3D"</span>);
				<span class="hljs-title function_">sendMessageToVue</span>({
					<span class="hljs-attr">type</span>: <span class="hljs-string">"quitUnity"</span>,
					<span class="hljs-attr">message</span>: <span class="hljs-string">"退出Unity3D"</span>,
				});
			};
			<span class="hljs-comment">// window.js2Unity = function (str) {</span>
			<span class="hljs-comment">// 	// 第一个参数是unity中物体的名称,第二是要调用的方法名称,第三个参数是unity中接收到的参数</span>
			<span class="hljs-comment">// 	// myGameInstance.SendMessage('Main Camera', 'TestRotation', '')</span>
			<span class="hljs-comment">//     console.log(str);</span>
			<span class="hljs-comment">// }</span>
		</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>


</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[算法]时间序列(介绍)]]></title>    <link>https://juejin.cn/post/7588007285547450374</link>    <guid>https://juejin.cn/post/7588007285547450374</guid>    <pubDate>2025-12-27T03:29:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588007285547450374" data-draft-id="7588069469516218409" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="[算法]时间序列(介绍)"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-27T03:29:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="import_random"/> <meta itemprop="url" content="https://juejin.cn/user/2013961033882312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            [算法]时间序列(介绍)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2013961033882312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    import_random
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:29:20.000Z" title="Sat Dec 27 2025 03:29:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1/什么是时间序列数据？</h2>
<p><strong>时间序列数据</strong> 是按照<strong>固定时间间隔或连续时间点</strong>，按时间顺序排列的一系列<code>观测值</code>或<code>数据点</code>。其核心特征是 <strong>“时间顺序”</strong> 本身就携带了至关重要的信息，数据点之间不是独立同分布的，而是存在<strong>相关性、趋势性或周期性</strong>。</p>
<p>简单来说，如果你打乱数据点的顺序，那么, 其意义就会完全丧失或严重受损，那么这很可能就是时间序列数据。</p>
<h3 data-id="heading-1">核心特征：</h3>
<ol>
<li><strong>时间依赖性（自相关性）</strong>：<code>当前</code>的数据点与<code>过去</code>的数据点相关（例如，今天的温度与昨天、前天的温度有关）。</li>
<li><strong>趋势</strong>：数据在长时间内呈现的上升或下降的方向（例如，公司销售额的长期增长）。</li>
<li><strong>季节性</strong>：数据在固定周期内重复出现的规律模式（例如，每日的交通高峰、每年的冰淇淋销量高峰）。</li>
<li><strong>（可能的）周期性</strong>：非固定频率的波动模式（例如，由经济周期引起的波动）。</li>
</ol>
<h2 data-id="heading-2">2/时间序列数据长什么样？</h2>
<p>在数据结构上，它通常表现为一个带有<strong>时间戳</strong>的二维表格或一个有序的列表/数组。</p>
<h3 data-id="heading-3">典型结构：</h3>



































<table><thead><tr><th align="left">时间戳</th><th align="left">观测值 1</th><th align="left">观测值 2</th><th align="left">...</th></tr></thead><tbody><tr><td align="left">t₁</td><td align="left">x₁</td><td align="left">y₁</td><td align="left">...</td></tr><tr><td align="left">t₂</td><td align="left">x₂</td><td align="left">y₂</td><td align="left">...</td></tr><tr><td align="left">t₃</td><td align="left">x₃</td><td align="left">y₃</td><td align="left">...</td></tr><tr><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td></tr></tbody></table>
<ul>
<li><strong>最左边一列（或索引）</strong> 是<strong>时间索引</strong>，这是时间序列数据的“灵魂”。它可以是：
<ul>
<li>等间隔的：<code>2024-01-01 00:00</code>, <code>2024-01-01 01:00</code>, <code>2024-01-01 02:00</code>...</li>
<li>不等间隔的：事件发生的时间戳，如用户点击记录。</li>
</ul>
</li>
<li><strong>每一行</strong>代表在某个特定时间点的“快照”。</li>
<li><strong>每一列</strong>代表一个随时间变化的<strong>特征</strong>或<strong>变量</strong>。可以是单变量（只有一列观测值），也可以是多变量（有多列观测值）。</li>
</ul>
<h2 data-id="heading-4">3/几个具体的例子</h2>
<h3 data-id="heading-5">1. 经典单变量时间序列：某城市每日气温</h3>
<ul>
<li><strong>目标</strong>：预测未来气温。</li>
<li><strong>数据示例</strong>：

































<table><thead><tr><th align="left">日期</th><th align="left">平均温度(°C)</th></tr></thead><tbody><tr><td align="left">2024-01-01</td><td align="left">5.2</td></tr><tr><td align="left">2024-01-02</td><td align="left">4.8</td></tr><tr><td align="left">2024-01-03</td><td align="left">6.1</td></tr><tr><td align="left">2024-01-04</td><td align="left">7.3</td></tr><tr><td align="left">...</td><td align="left">...</td></tr><tr><td align="left">2024-12-31</td><td align="left">3.5</td></tr></tbody></table>
</li>
<li><strong>特点</strong>：只有一个数字序列随时间变化，有明显的季节性和趋势。</li>
</ul>
<h3 data-id="heading-6">2. 金融多变量时间序列：股票分钟级数据</h3>
<ul>
<li><strong>目标</strong>：预测股价走势或进行交易策略分析。</li>
<li><strong>数据示例</strong>：













































<table><thead><tr><th align="left">时间戳</th><th align="left">开盘价</th><th align="left">最高价</th><th align="left">最低价</th><th align="left">收盘价</th><th align="left">成交量</th></tr></thead><tbody><tr><td align="left">2024-05-10 09:30</td><td align="left">150.00</td><td align="left">150.50</td><td align="left">149.80</td><td align="left">150.20</td><td align="left">100000</td></tr><tr><td align="left">2024-05-10 09:31</td><td align="left">150.22</td><td align="left">150.40</td><td align="left">150.05</td><td align="left">150.35</td><td align="left">45000</td></tr><tr><td align="left">2024-05-10 09:32</td><td align="left">150.36</td><td align="left">150.60</td><td align="left">150.30</td><td align="left">150.50</td><td align="left">52000</td></tr><tr><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td></tr></tbody></table>
</li>
<li><strong>特点</strong>：多个相关联的特征（价格、成交量）同时随时间变化，高频且波动剧烈。</li>
</ul>
<h3 data-id="heading-7">3. 物联网传感器数据：智能工厂设备监控</h3>
<ul>
<li><strong>目标</strong>：设备故障预警或预测性维护。</li>
<li><strong>数据示例</strong>：













































<table><thead><tr><th align="left">时间戳</th><th align="left">设备ID</th><th align="left">振动幅度</th><th align="left">温度(°C)</th><th align="left">电流(A)</th><th align="left">压力(MPa)</th></tr></thead><tbody><tr><td align="left">2024-05-10 10:00:00</td><td align="left">Motor_A</td><td align="left">2.1</td><td align="left">65</td><td align="left">10.5</td><td align="left">0.85</td></tr><tr><td align="left">2024-05-10 10:00:01</td><td align="left">Motor_A</td><td align="left">2.2</td><td align="left">65.1</td><td align="left">10.6</td><td align="left">0.86</td></tr><tr><td align="left">2024-05-10 10:00:02</td><td align="left">Motor_A</td><td align="left">5.8</td><td align="left">70.3</td><td align="left">15.2</td><td align="left">0.92</td></tr><tr><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td></tr></tbody></table>
</li>
<li><strong>特点</strong>：通常由多个传感器产生，频率高，是异常检测和模式识别的重要数据源。</li>
</ul>
<h3 data-id="heading-8">4. 业务与网络数据：网站每小时访问量</h3>
<ul>
<li><strong>目标</strong>：资源规划、广告投放。</li>
<li><strong>数据示例</strong>：









































<table><thead><tr><th align="left">日期-小时</th><th align="left">独立访客数</th><th align="left">页面浏览量</th><th align="left">服务器负载</th></tr></thead><tbody><tr><td align="left">2024-05-09 20:00</td><td align="left">10432</td><td align="left">89210</td><td align="left">0.65</td></tr><tr><td align="left">2024-05-09 21:00</td><td align="left">12054</td><td align="left">100345</td><td align="left">0.72</td></tr><tr><td align="left">2024-05-09 22:00</td><td align="left">15321</td><td align="left">134567</td><td align="left">0.85</td></tr><tr><td align="left">2024-05-10 09:00</td><td align="left">8567</td><td align="left">65432</td><td align="left">0.45</td></tr><tr><td align="left">...</td><td align="left">...</td><td align="left">...</td><td align="left">...</td></tr></tbody></table>
</li>
<li><strong>特点</strong>：具有强烈的周期性（日周期：白天高夜间低；周周期：工作日高周末低）。</li>
</ul>
<h3 data-id="heading-9">5. 其他领域的例子：</h3>
<ul>
<li><strong>音频信号</strong>：振幅随时间变化的序列（时间间隔非常短且固定）。</li>
<li><strong>心电图（ECG）</strong>：心脏电活动随时间变化的记录，用于检测异常心跳。</li>
<li><strong>语言文本</strong>：可以将一个句子看作单词在“时间步”上的序列（这里的“时间”是顺序位置）。</li>
</ul>
<h2 data-id="heading-10">5. 在机器学习/深度学习中的应用</h2>
<p>处理时间序列数据的模型需要能够捕捉其<strong>时间依赖性</strong>：</p>
<ul>
<li><strong>传统机器学习方法</strong>：需要手动构造特征，如滞后特征（前1小时的值、前1天的值）、滑动窗口统计量（过去7天的均值、方差）、季节指标等，然后使用回归、随机森林等模型。</li>
<li><strong>深度学习方法</strong>：能自动学习时间模式，是当前的主流：
<ul>
<li><strong>循环神经网络（RNN）及其变体（LSTM, GRU）</strong>：专为序列数据设计，具有“记忆”功能。</li>
<li><strong>时间卷积网络（TCN）</strong>：使用因果卷积来捕获长期依赖。</li>
<li><strong>Transformer模型</strong>：通过自注意力机制，能并行处理并捕获长距离依赖，现在也被广泛应用于时间序列预测（如Informer、Autoformer等模型）。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-11">6. 总结</h2>
<p><strong>时间序列数据</strong>就是<strong>带有时间戳、且顺序至关重要的数据</strong>。它广泛存在于我们生活的方方面面，从经济金融到工业制造，从日常天气到人体健康。</p>
<p>识别和理解你的数据是否具有时间序列特性，是选择正确分析方法和机器学习模型的第一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[From Nand to Tetris 里的 Project 3]]></title>    <link>https://juejin.cn/post/7588034035286671375</link>    <guid>https://juejin.cn/post/7588034035286671375</guid>    <pubDate>2025-12-27T03:28:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588034035286671375" data-draft-id="7587997157237735476" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="From Nand to Tetris 里的 Project 3"/> <meta itemprop="keywords" content="设计"/> <meta itemprop="datePublished" content="2025-12-27T03:28:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="金銀銅鐵"/> <meta itemprop="url" content="https://juejin.cn/user/747323638159757"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            From Nand to Tetris 里的 Project 3
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323638159757/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    金銀銅鐵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:28:35.000Z" title="Sat Dec 27 2025 03:28:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>让我们按照 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nand2tetris.org%2Fcourse" target="_blank" title="https://www.nand2tetris.org/course" ref="nofollow noopener noreferrer">From Nand to Tetris</a> 里 <code>Project 3</code> 的要求，来完成下列的设计。</p>
<ol>
<li>实现 <code>Bit</code></li>
<li>实现 <code>Register</code></li>
<li>实现 <code>RAM8</code></li>
<li>实现 <code>RAM64</code> (todo)</li>
<li>实现 <code>RAM512</code> (todo)</li>
<li>实现 <code>RAM4K</code> (todo)</li>
<li>实现 <code>RAM16K</code> (todo)</li>
<li>实现 <code>PC</code> (<code>Program Counter</code>, 程序计数器) (todo)</li>
</ol>
<h2 data-id="heading-1">正文</h2>
<h3 data-id="heading-2">1. 实现 <code>Bit</code></h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 3</code> 里的 <code>Bit</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4360e942fb4245b380b2ea54b267197b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=xgG75AOqaD7VroysoPt01Bu2Qc0%3D" alt="image.png" loading="lazy"/></p>
<p>我们的目标是用 <code>DFF</code>(<code>Data Flip Flop</code>, 数据触发器) 以及 <code>Project 1</code>/<code>Project 2</code> 里已经实现的各种 <code>chip</code> 实现一个 <code>Bit</code>(即，一位寄存器)。</p>
<p>注释中的相关描述如下 ⬇️</p>
<pre><code class="hljs language-text" lang="text">/**
 * 1-bit register:
 * If load is asserted, the register's value is set to in;
 * Otherwise, the register maintains its current value:
 * if (load(t)) out(t+1) = in(t), else out(t+1) = out(t)
 */
</code></pre>
<ul>
<li>输入是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">in</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">in</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">load</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span></span></span></span></span></li>
</ul>
</li>
<li>输出是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">out</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>书中有一些关于一位 <code>Bit</code>寄存器设计的描述 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c42844bf42f418683e21f007c192cab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=7kPfLu%2BBxZoZa8JlJLEWVvWYDsw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e90012fcc114716ae0884d2f6109fa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=0SUHp1HOxCDNwLVt1Ab%2FSialVvI%3D" alt="微信圖片_2025-12-27_102957_841.jpg" loading="lazy"/></p>
<p>结合书中的描述，我们可以这样来实现</p>
<pre><code class="hljs language-hdl" lang="hdl">CHIP Bit {
    IN in, load;
    OUT out;

    PARTS:
    Mux(a= previousOut, b= in, sel= load, out= nextOut);
    DFF(in= nextOut, out=out, out= previousOut);
}
</code></pre>
<p>这样的代码可以通过仿真测试，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2006e1d8b16f45e0b8739757b23b221c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=RgmjB4csUXiTtkqrctfwD2Vf2kk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">2. 实现 <code>Register</code></h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 3</code> 里的 <code>Register</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5b3ff3debca40569679e3e068e6de49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=wJ2kBdsCYgbe7Wa2OmOf5oK%2BH%2F8%3D" alt="image.png" loading="lazy"/></p>
<p>我们的目标是用 <code>Bit</code>(一位寄存器) 以及 <code>Project 1</code>/<code>Project 2</code> 里已经实现的各种 <code>chip</code> 实现一个 <code>Register</code>(即，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位寄存器)。</p>
<p>注释中的相关描述如下 ⬇️</p>
<pre><code class="hljs language-text" lang="text">/**
 * 16-bit register:
 * If load is asserted, the register's value is set to in;
 * Otherwise, the register maintains its current value:
 * if (load(t)) out(t+1) = int(t), else out(t+1) = out(t)
 */
</code></pre>
<ul>
<li>输入是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">in[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">in</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">load</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span></span></span></span></span></li>
</ul>
</li>
<li>输出是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">out[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>我们在上一步里已经实现了 <code>Bit</code>(一位寄存器)，既然 <code>Register</code> 是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位寄存器，那么可以把 <code>Register</code> 当作 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 个一位寄存器的组合。</p>
<p>代码的大意如下 ⬇️</p>
<pre><code class="hljs language-hdl" lang="hdl">CHIP Register {
    IN in[16], load;
    OUT out[16];

    PARTS:
    Bit(in= in[0], load= load, out= out[0]);
    Bit(in= in[1], load= load, out= out[1]);
    ...
    Bit(in= in[15], load= load, out= out[15]);
}
</code></pre>
<p>由于这里有很多行类似的代码，自己复制粘贴加修改感觉有点浪费时间，不如用 <code>java</code> 代码来生成它吧。
请将以下代码保存为 <code>RegisterHdlCodeGenerator.java</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.StringJoiner;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegisterHdlCodeGenerator</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""
                CHIP Register {
                    IN in[16], load;
                    OUT out[16];
                
                    PARTS:
                %s
                }
                """</span>;

        <span class="hljs-type">StringJoiner</span> <span class="hljs-variable">joiner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringJoiner</span>(System.lineSeparator());
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i++) {
            <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"    Bit(in= in[%s], load= load, out= out[%s]);"</span>, i, i);
            joiner.add(line);
        }
        System.out.printf(template, joiner);
    }
}
</code></pre>
<p>使用如下的命令可以编译 <code>RegisterHdlCodeGenerator.java</code> 并运行其中的 <code>main</code> 方法。</p>
<pre><code class="hljs language-bash" lang="bash">javac RegisterHdlCodeGenerator.java
java RegisterHdlCodeGenerator
</code></pre>
<p>运行结果如下</p>
<pre><code class="hljs language-text" lang="text">CHIP Register {
    IN in[16], load;
    OUT out[16];

    PARTS:
    Bit(in= in[0], load= load, out= out[0]);
    Bit(in= in[1], load= load, out= out[1]);
    Bit(in= in[2], load= load, out= out[2]);
    Bit(in= in[3], load= load, out= out[3]);
    Bit(in= in[4], load= load, out= out[4]);
    Bit(in= in[5], load= load, out= out[5]);
    Bit(in= in[6], load= load, out= out[6]);
    Bit(in= in[7], load= load, out= out[7]);
    Bit(in= in[8], load= load, out= out[8]);
    Bit(in= in[9], load= load, out= out[9]);
    Bit(in= in[10], load= load, out= out[10]);
    Bit(in= in[11], load= load, out= out[11]);
    Bit(in= in[12], load= load, out= out[12]);
    Bit(in= in[13], load= load, out= out[13]);
    Bit(in= in[14], load= load, out= out[14]);
    Bit(in= in[15], load= load, out= out[15]);
}
</code></pre>
<p>这样的代码可以通过仿真测试，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c27aa43e87945ba9eaa44f61b2480a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=rYaxtDSXbX6iBNqFwHVaSyASiGo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">3. 实现 <code>RAM8</code></h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 3</code> 里的 <code>RAM8</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecdec32d0407434a946467c310f9e5e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=8Wnf6QkWlrIgx5Uk31fy1%2B84C8Q%3D" alt="image.png" loading="lazy"/></p>
<p>我们的目标是用 <code>Register</code>(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span></span></span></span></span> 位寄存器) 以及 <code>Project 1</code>/<code>Project 2</code> 里已经实现的各种 <code>chip</code> 实现一个 <code>RAM8</code>(即，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span></span></span></span></span> 个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位寄存器的存储器)。</p>
<p>注释中的相关描述如下 ⬇️</p>
<pre><code class="hljs language-text" lang="text">/**
 * Memory of eight 16-bit registers.
 * If load is asserted, the value of the register selected by
 * address is set to in; Otherwise, the value does not change.
 * The value of the selected register is emitted by out.
 */
</code></pre>
<ul>
<li>输入是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">in[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">in</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">load</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>s</mi><mo stretchy="false">[</mo><mn>3</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">address[3]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">a</span><span class="mord mathnormal">dd</span><span class="mord mathnormal">ress</span><span class="mopen">[</span><span class="mord">3</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
<li>输出是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">out[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>我们在上一步里已经实现了 <code>Register</code>(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位寄存器)。现在需要选择将 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">in[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">in</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span> 输入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span></span></span></span></span> 个 <code>Register</code> 中的哪一个，可以使用 <code>Project 1</code> 里的 <code>DMux8Way</code>，对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">out[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span> 而言，我们可以借助 <code>Project 1</code> 里的 <code>Mux8Way16</code> 从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span></span></span></span></span> 个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>e</mi><mi>g</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">Register</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span></span></span></span></span> 的输出中进行选择。</p>
<p>代码的大意如下 ⬇️</p>
<pre><code class="hljs language-hdl" lang="hdl">CHIP RAM8 {
    IN in[16], load, address[3];
    OUT out[16];

    PARTS:
    DMux8Way(in= load, sel= address,
    a= a, b= b, c= c, d= d, e= e, f= f, g= g, h= h);

    Register(in= in, load= a, out= out0);
    Register(in= in, load= b, out= out1);
    ...
    Register(in= in, load= h, out= out7);

    Mux8Way16(a= out0, b= out1, c= out2, d= out3,
    e= out4, f= out5, g= out6, h= out7,
    sel= address, out= out);
}
</code></pre>
<p>由于这里有很多行类似的代码，自己复制粘贴加修改感觉有点浪费时间，不如用 <code>java</code> 代码来生成它吧。
请将以下代码保存为 <code>RAM8HdlCodeGenerator.java</code>。</p>
<pre><code class="hljs language-bash" lang="bash">javac RAM8HdlCodeGenerator.java
java RAM8HdlCodeGenerator
</code></pre>
<p>运行结果如下</p>
<pre><code class="hljs language-hdl" lang="hdl">CHIP RAM8 {
    IN in[16], load, address[3];
    OUT out[16];

    PARTS:
    DMux8Way(in= load, sel= address,
    a= a, b= b, c= c, d= d, e= e, f= f, g= g, h= h);

    Register(in= in, load= a, out= out0);
    Register(in= in, load= b, out= out1);
    Register(in= in, load= c, out= out2);
    Register(in= in, load= d, out= out3);
    Register(in= in, load= e, out= out4);
    Register(in= in, load= f, out= out5);
    Register(in= in, load= g, out= out6);
    Register(in= in, load= h, out= out7);

    Mux8Way16(a= out0, b= out1, c= out2, d= out3,
    e= out4, f= out5, g= out6, h= out7,
    sel= address, out= out);
}
</code></pre>
<p>这样的代码可以通过仿真测试，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a9798a375ac4b2a9bc358ffe2817cb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=fJ7hLlM4I4NcL11kbOucR5qNlYM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">4. 实现 <code>RAM64</code></h3>
<p>前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnand2tetris.github.io%2Fweb-ide%2Fchip%2F" target="_blank" title="https://nand2tetris.github.io/web-ide/chip/" ref="nofollow noopener noreferrer">Nand to Tetris Online IDE</a>，选择 <code>Project 3</code> 里的 <code>RAM64</code>，效果如下图所示 ⬇️</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b0c5811dcf54ff4acaf53113eff91b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeR6YqA6YqF6ZC1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767411260&amp;x-signature=KjmQMcz1Uh99H2YgTxke7ZlyL%2Bw%3D" alt="image.png" loading="lazy"/></p>
<p>我们的目标是用 <code>RAM8</code>(即，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">8</span></span></span></span></span> 个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位寄存器的存储器) 以及 <code>Project 1</code>/<code>Project 2</code> 里已经实现的各种 <code>chip</code> 实现一个 <code>RAM64</code>(即，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>64</mn></mrow><annotation encoding="application/x-tex">64</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">64</span></span></span></span></span> 个 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn></mrow><annotation encoding="application/x-tex">16</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16</span></span></span></span></span> 位寄存器的存储器)。</p>
<p>注释中的相关描述如下 ⬇️</p>
<pre><code class="hljs language-text" lang="text">/**
 * Memory of sixty four 16-bit registers.
 * If load is asserted, the value of the register selected by
 * address is set to in; Otherwise, the value does not change.
 * The value of the selected register is emitted by out.
 */
</code></pre>
<ul>
<li>输入是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>n</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">in[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">in</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>a</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">load</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span></span></span></span></span></li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>d</mi><mi>d</mi><mi>r</mi><mi>e</mi><mi>s</mi><mi>s</mi><mo stretchy="false">[</mo><mn>6</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">address[6]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">a</span><span class="mord mathnormal">dd</span><span class="mord mathnormal">ress</span><span class="mopen">[</span><span class="mord">6</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
<li>输出是
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mo stretchy="false">[</mo><mn>16</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">out[16]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mopen">[</span><span class="mord">16</span><span class="mclose">]</span></span></span></span></span></li>
</ul>
</li>
</ul>
<p>我们在上一步里已经实现了 <code>RAM8</code>，可以用类似的思路来实现 <code>RAM64</code>。</p>
<h2 data-id="heading-6">参考资料</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis高频踩坑实录：5个不报错但会导致性能腰斩的'隐秘'配置项]]></title>    <link>https://juejin.cn/post/7587776610437120015</link>    <guid>https://juejin.cn/post/7587776610437120015</guid>    <pubDate>2025-12-27T04:16:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587776610437120015" data-draft-id="7588004376867242019" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis高频踩坑实录：5个不报错但会导致性能腰斩的'隐秘'配置项"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-27T04:16:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis高频踩坑实录：5个不报错但会导致性能腰斩的'隐秘'配置项
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T04:16:46.000Z" title="Sat Dec 27 2025 04:16:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Redis高频踩坑实录：5个不报错但会导致性能腰斩的'隐秘'配置项</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>Redis作为高性能的内存数据库，凭借其亚毫秒级响应速度和丰富的数据结构，已成为现代分布式系统的核心组件。然而，正是由于其"开箱即用"的简便性，许多开发者往往忽视了深层次的配置调优。本文揭示的5个配置项不会触发任何错误日志，却可能在不经意间将Redis的性能腰斩——从吞吐量骤降到延迟飙升。这些"隐秘杀手"的背后，是内存管理、网络协议和持久化机制的深度耦合。</p>
<hr/>
<h3 data-id="heading-2">1. <code>hz</code>：定时任务频率的甜蜜与陷阱</h3>
<p><strong>问题本质</strong>：<br/>
<code>hz</code>参数（默认10）控制Redis后台任务的执行频率，包括过期键清理、rehash操作等。看似无害的数值调整实则暗藏玄机：</p>
<ul>
<li><strong>性能悬崖</strong>：当<code>hz &gt; 100</code>时，CPU利用率呈指数级增长（实测从10→100会使CPU占用率提升3倍）</li>
<li><strong>过期键堆积</strong>：<code>hz=1</code>可能导致大量已过期键未被及时清理，内存占用虚高</li>
</ul>
<p><strong>黄金法则</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">-</span> 生产环境建议值：5~50（根据服务器核心数调整）
<span class="hljs-bullet">-</span> 监控指标：观察<span class="hljs-code">`evicted_keys`</span>和<span class="hljs-code">`expired_keys`</span>的增长趋势
</code></pre>
<hr/>
<h3 data-id="heading-3">2. <code>tcp-backlog</code>：连接风暴的第一道防线</h3>
<p><strong>隐藏危机</strong>：<br/>
默认值511在高并发场景下会成为瓶颈。当客户端连接激增时：</p>
<pre><code class="hljs language-math" lang="math">实际可用backlog = min(tcp-backlog, /proc/sys/net/core/somaxconn)
</code></pre>
<p>未处理的连接会直接丢弃（无错误日志！），表现为客户端偶发连接超时。</p>
<p><strong>调优策略</strong>：</p>
<ol>
<li>同时调整系统级参数：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> 2048 &gt; /proc/sys/net/core/somaxconn
</code></pre>
</li>
<li>Redis配置同步更新：
<pre><code class="hljs language-redis.conf" lang="redis.conf">tcp-backlog 2048
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-4">3. <code>repl-disable-tcp-nodelay</code>：复制延迟的元凶</h3>
<p><strong>网络协议层的博弈</strong>：<br/>
主从复制时启用该选项（默认关闭）会导致：</p>
<ul>
<li>Nagle算法堆积小包</li>
<li>同步延迟增加30%~300%（实测RTT&gt;100ms时影响显著）</li>
</ul>
<p><strong>决策树</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[跨机房同步?] --&gt;|是| B[开启 repl-disable-tcp-nodelay]
    A --&gt;|否| C[保持关闭状态]
</code></pre>
<hr/>
<h3 data-id="heading-5">4. <code>hash-max-ziplist-entries/value</code>：内存与CPU的零和游戏</h3>
<p>数据结构编码的临界点控制着内存效率与计算开销的平衡：</p>




















<table><thead><tr><th>数据类型</th><th>默认阈值</th><th>超出后编码转换</th></tr></thead><tbody><tr><td>Hash</td><td>entries:512, value:64字节</td><td>ziplist → hashtable</td></tr><tr><td>Set</td><td>entries:512</td><td>intset → hashtable</td></tr></tbody></table>
<p><strong>压测数据揭示的真相</strong>：</p>
<ul>
<li>Value=60字节时，内存节省40%</li>
<li>Value=65字节时，QPS下降22%</li>
</ul>
<p>最佳实践：</p>
<pre><code class="hljs language-redis.conf" lang="redis.conf"># 根据实际value尺寸动态调整
hash-max-ziplist-value 128 
</code></pre>
<hr/>
<h3 data-id="heading-6">5. <code>client-output-buffer-limit</code>：复制中断的无形之手</h3>
<p>Pub/Sub和主从复制的缓冲区限制常被低估：</p>
<pre><code class="hljs language-redis.conf" lang="redis.conf"># Default值风险场景:
client-output-buffer-limit replica 256mb 64mb 60

# Slave全量同步20GB数据时:
1. Buffer瞬时突破256MB硬限制
2. Master强制断开连接（仅在slow log记录）
</code></pre>
<p>金融级配置建议：</p>
<pre><code class="hljs language-markdown" lang="markdown">replica:
 hard limit ≥ max(rdb<span class="hljs-emphasis">_file_</span>size)<span class="hljs-emphasis">*1.5 
 soft limit ≥ network_speed *</span> sync<span class="hljs-emphasis">_time 
</span></code></pre>
<hr/>
<h3 data-id="heading-7">Linux层协同优化备忘录</h3>
<p>即使Redis配置完美，OS层面的误配仍会抵消优化效果：</p>
<ol>
<li><strong>透明大页禁用</strong>：
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled
</code></pre>
</li>
<li><strong>NUMA架构绑定</strong>：
<pre><code class="hljs language-bash" lang="bash">numactl --interleave=all redis-server ...
</code></pre>
</li>
<li><strong>SWAPiness归零</strong>：
<pre><code class="hljs language-bash" lang="bash">vm.swappiness = 0 
</code></pre>
</li>
</ol>
<hr/>
<h3 data-id="heading-8">Conclusion: Redis调优的三重境界</h3>
<ol>
<li><strong>基础层</strong>: memory_limit/timeout等显式参数</li>
<li><strong>进阶层</strong>: hz/tcp-backlog等隐性交互参数</li>
<li><strong>专家层</strong>: OS内核参数与硬件拓扑适配</li>
</ol>
<p>真正的性能优化不在于追求某个参数的极致调校，而在于理解各层级组件的相互作用关系。建议通过<code>redis-cli --latency-history -i 1</code>持续监测微观延迟变化，结合火焰图定位隐形瓶颈。记住：没有放之四海而皆准的最优配置，只有与业务特征完美契合的参数组合。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 四格笑话爆火，我做了什么?]]></title>    <link>https://juejin.cn/post/7588004601392529442</link>    <guid>https://juejin.cn/post/7588004601392529442</guid>    <pubDate>2025-12-27T04:15:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004601392529442" data-draft-id="7587776610437103631" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 四格笑话爆火，我做了什么?"/> <meta itemprop="keywords" content="AIGC,前端"/> <meta itemprop="datePublished" content="2025-12-27T04:15:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张风捷特烈"/> <meta itemprop="url" content="https://juejin.cn/user/149189281194766"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 四格笑话爆火，我做了什么?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189281194766/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张风捷特烈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T04:15:38.000Z" title="Sat Dec 27 2025 04:15:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h4 data-id="heading-0">0. 前言</h4>
<p>在 2025年的尾巴上，发生了一件非常有趣的事，我在微信公众号上的 <code>AI 四格漫画</code> 意外爆火。之前公众号上发的技术文章，基本上阅读量不过 300，每天广告收益也就几毛钱。目前最火的美杜莎，浏览量已经达到惊人的 <strong>5W</strong>。这样让我不禁感叹:</p>
<blockquote>
<p>十年技术无人问，一曲漫笑广人闻。</p>
</blockquote>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3b1c44a5bf7243779841d17bfabc4824~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=586&amp;h=299&amp;s=55292&amp;e=png&amp;b=fdfdfd" alt="" loading="lazy"/></p>
<hr/>
<p>火爆之后，带来的最直接价值就是迎来了泼天富贵。从未想过有一天，我的日广告收益能达到 250+ ，目前已经连续三天高位。除了金钱，自己的作品受到欢迎，以及大家在评论区的吐槽、讨论，也为我带来了很大的情绪价值。</p>













<table><thead><tr><th>-</th><th>-</th></tr></thead><tbody><tr><td><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b915619f897b416e95a417900cef5108~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1179&amp;h=2556&amp;s=680744&amp;e=png&amp;b=f1f7f7" alt="" loading="lazy"/></td><td><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0d24cf6d8bff47b7bd5094625ed5dca8~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1179&amp;h=2556&amp;s=220732&amp;e=png&amp;b=fdfdfd" alt="" loading="lazy"/></td></tr></tbody></table>
<hr/>
<h4 data-id="heading-1">1. 缘起</h4>
<p>先简单介绍一下：我是一个籍籍无名的编程技术小博主，全网统一名号 <code>张风捷特烈</code> 。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FyAQXh0UbMMU5cI5nmSJYWw" target="_blank" title="https://mp.weixin.qq.com/s/yAQXh0UbMMU5cI5nmSJYWw" ref="nofollow noopener noreferrer">编程之王</a> 是我维护的公众号，一直是输出编程技术的文章，主要以 Flutter 技术为主。<br/>
但技术文章更新的不是非常频繁，而公众号每天有一篇发文的机会。本着 <code>不想浪费</code> 的优良传统，在 AI 重塑一切的浪潮中，我想用 AI 画些四格漫画的笑话试试。于是开启了 <strong>慧心一笑</strong> 专栏， <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FHtpVgVF7HZlqrVS37-R82w" target="_blank" title="https://mp.weixin.qq.com/s/HtpVgVF7HZlqrVS37-R82w" ref="nofollow noopener noreferrer">《小火柴的倒霉日常》</a> 就是第一篇，现在还没火。大家也可以点开看看，内容非常精简，就是一幅图+提示词。</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e2fb9e88c522489db9ec8bcb2f6163fd~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=576&amp;h=299&amp;s=47926&amp;e=png&amp;b=fdfafa" alt="" loading="lazy"/></p>
<p>这个系列整体是诙谐幽默的，下面是第一篇的内容：</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3034eb513f304e2ca0e8199ce5afff6e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1024&amp;h=559&amp;s=524412&amp;e=png&amp;b=fae8ca" alt="" loading="lazy"/></p>
<p>一开始我是用自然语言的提示词，感觉效果并不是太好，四格漫画有着连续的信息和一致性的人物、场景等。由于编程出身，在 <strong>结构一致性</strong> 方面有着天然的敏锐嗅觉。于是基于 yaml 文件来定义统一的场景、角色、样式、色调等信息：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">comic_info:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">"四格漫画"</span>
  <span class="hljs-attr">style:</span> <span class="hljs-string">"手绘简笔画、柔软线条、轻松冷幽默、统一角色"</span>
  <span class="hljs-attr">color_scheme:</span> <span class="hljs-string">"暖黄主色调，红橙色点缀，柔和明暗层次"</span>
  <span class="hljs-attr">character:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">"小火柴"</span>
    <span class="hljs-attr">appearance:</span> <span class="hljs-string">"细长圆柱身体、红色火柴头、两根短竖眉毛、圆点眼睛、呆萌可爱"</span>
    <span class="hljs-attr">personality:</span> <span class="hljs-string">"迷糊、天真、略倒霉"</span>
  <span class="hljs-attr">background_style:</span> <span class="hljs-string">"白色简约背景，搭配少量手绘街景或物件增强生活感"</span>
</code></pre>
<p>面板列表放在 <code>panels</code> 节点下，每个宫格由 <code>panel[x]</code> 固定场景内容。包括描述、场景、动作、表情、细节、文本等：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">panels:</span>
  <span class="hljs-attr">panel1:</span>
    <span class="hljs-attr">description:</span> <span class="hljs-string">"第一格：日常铺垫"</span>
    <span class="hljs-attr">scene:</span> <span class="hljs-string">"温暖的手绘街道：地面为淡黄色纹理，简单的路灯、几株小草、远处一座小房子，空气里飘着幾颗小亮点"</span>
    <span class="hljs-attr">action:</span> <span class="hljs-string">"小火柴双手背在身后，踩着轻快的小步子前进"</span>
    <span class="hljs-attr">expression:</span> <span class="hljs-string">"轻松微笑，眼睛微弯"</span>
    <span class="hljs-attr">details:</span> <span class="hljs-string">"路灯用细线勾勒，小草三两稀疏点缀，天空加几朵柔软的白云"</span>
    <span class="hljs-attr">text:</span> <span class="hljs-string">"今天天气真好呀～"</span>
</code></pre>
<p>定义完结构，一个 yaml 文件就对应了一个四格故事，把这个内容丢给 AI 生图的工具，就能得到对应的图片。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91ae4dded9a14567a1c438a1825e562c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=915&amp;h=380&amp;s=154672&amp;e=png&amp;b=f2f0ef" alt="" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-2">2. 关于 AI 生图工具与质量</h4>
<p>我的理念是: 文本是一种序列的约定：</p>
<blockquote>
<p>它可以视为一个四格漫画的 <strong>基因</strong>，而 AI 工具会将基因 <code>实例化</code> 为个体。</p>
</blockquote>
<p>所以，生成图的好坏取决于两个因素：<code>基因序列</code> 和 <code>成长环境</code>。也就是提示词好不好，以及 AI 工具厉不厉害。 AI 生图的工具有很多，单目前大多数，对于标准的四格漫画都无法准确输出，下面列举几个:</p>
<ul>
<li><strong>即梦 AI</strong></li>
</ul>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/24c632cf9ce741178152d97096667b3c~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1032&amp;h=264&amp;s=407121&amp;e=png&amp;b=f3ce85" alt="" loading="lazy"/></p>
<ul>
<li><strong>豆包</strong></li>
</ul>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3d692710bcc4d7f9c929d2f46d960cf~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1238&amp;h=337&amp;s=493504&amp;e=png&amp;b=faf5f2" alt="" loading="lazy"/></p>
<ul>
<li><strong>Nano Banana</strong></li>
</ul>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91553066f86742428df4d6b3cdd7be29~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1024&amp;h=559&amp;s=760444&amp;e=png&amp;b=f8efdb" alt="" loading="lazy"/></p>
<p>目前来看，国产的 AI 仍有很大的进步空间，Nano Banana 能符合我对图片产品的预期。但是 AI 正在蓬勃发展中， AI 生图也是最近一两年才逐渐可用的，我对他们的未来持有乐观的态度，包括我们国产的大模型。所以如果 <code>成长环境</code> 将会越来越好，那么 <code>基因序列</code> 本身将会成为非常重要的因素。<br/>
目前我只是简单设计了一下 <code>yaml</code>，按照版本控制，称为 <code>v0.0.1</code> 吧，后续随着创作需求的升级，我也会逐步迭代整体结构，设计更合理的 DNA 结构 😁</p>
<hr/>
<h4 data-id="heading-3">3. 选定方向? Flow Heart</h4>
<blockquote>
<p>有人问我，你是怎么想到这些稀奇古怪的方向的，而且你是怎么坚持下来的。</p>
</blockquote>
<p>对于一个创作者来说，拓宽自己的边界是一个很必要的事。特别是对一个编程创作者，广泛涉猎是家常便饭。使用一切手段，解决自己遇到的问题；没有问题时就去发展自己，在新的领域中寻找问题。至于坚持嘛，遵循内心的指引，做自己喜欢的事，是不需要坚持的，就像你每天都要喝水一样自然。</p>
<p>可能有人会问，如果 AI 的笑话漫画没有火，你还会坚持下去吗？刚做前两个漫画文章时，还没有火，一天收入 1 块钱，我已经觉得很美滋滋了。投入的产出符合我的预期，毕竟只需要准备个笑话雏形，其他都交给 AI 写就行了。我还和女朋友炫耀：</p>













<table><thead><tr><th>-</th><th>-</th></tr></thead><tbody><tr><td><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5dd9d09b880c4c308b22fb00102e5d8e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1179&amp;h=2556&amp;s=567607&amp;e=png&amp;b=efefef" alt="" loading="lazy"/></td><td><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cd13ed472dad4cc29bf19406222c89e4~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1179&amp;h=2556&amp;s=689970&amp;e=png&amp;b=fdfdfd" alt="" loading="lazy"/></td></tr></tbody></table>
<p>最后还是想强调一点：如果一件事，对社会、对他人没有危害，自己做着觉得开心，起来没有负担和压力，就会大胆去做。反之，可以在其他方面继续延伸，找到自己喜欢的那个领域。AI 工具的加持，让个体拥有了前所未有的能力，个人的边界可以极度拓宽。</p>
<hr/>
<h4 data-id="heading-4">4. 为什么会火？</h4>
<p>第一次感觉会火，是因为<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXe85NV6MyPKkpn1yBypO-w" target="_blank" title="https://mp.weixin.qq.com/s/Xe85NV6MyPKkpn1yBypO-w" ref="nofollow noopener noreferrer">擎天柱</a> 这篇，浏览量异常上升：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ef21681d63e145f29235d572fbd7bce0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1024&amp;h=559&amp;s=867925&amp;e=png&amp;b=e5d2c4" alt="" loading="lazy"/></p>
<p>从数据统计来看，发布第一天只有 <code>102</code> 个浏览量，和往常没什么区别。持续一周，没有任何波澜，突然在 <code>12-20</code> 号，增加了近 5000 的浏览量，第二天持续上涨过万，然后逐渐平息：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c9c973d0ef6b4fa19539b418eed93fc0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=899&amp;h=377&amp;s=22716&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<hr/>
<p>在第一篇爆火的后一天，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FD2w8-ar9rnVQV3_TG962cA" target="_blank" title="https://mp.weixin.qq.com/s/D2w8-ar9rnVQV3_TG962cA" ref="nofollow noopener noreferrer">慧心一笑#03 | 爸爸去钓鱼~</a> 数据开始上升，感觉像是连带效应：</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/53a8c23e77e04e7987e5e992067dc562~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1024&amp;h=559&amp;s=800570&amp;e=png&amp;b=f4e6d1" alt="" loading="lazy"/></p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/224bf13e450c4f5fb5df7061538333cb~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=818&amp;h=341&amp;s=16760&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<hr/>
<p>为了验证一下是不是偶然火爆，我在 20号和 21 号又发表了两篇小笑话。结果不温不火，似乎感觉也不是必然的。
在 23 号，我发布了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FyAQXh0UbMMU5cI5nmSJYWw" target="_blank" title="https://mp.weixin.qq.com/s/yAQXh0UbMMU5cI5nmSJYWw" ref="nofollow noopener noreferrer">慧心一笑#06 | 被美杜莎石化...</a>，这篇在当晚直接火爆，</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6d5faef41ea940c8ad487493aa31412e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1024&amp;h=559&amp;s=917880&amp;e=png&amp;b=ede6d6" alt="" loading="lazy"/></p>
<p>从数据来看，第二天浏览量直接过 2.6W，后面还有持续几天的流量：</p>
<p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9632f58583be4c81ba2415c33b9edcd2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=914&amp;h=324&amp;s=14984&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<p>至于为什么火爆，从阅读渠道构成来看 <code>98.7%</code> 的阅读量来自于公众号推荐。只能说是老天喂饭吃 ~</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a886ef8bfd814300aa23866ec6cd79a0~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1073&amp;h=394&amp;s=17807&amp;e=png&amp;b=ffffff" alt="" loading="lazy"/></p>
<hr/>
<h4 data-id="heading-5">5. 小结一下</h4>
<p>接下来几天的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FlOUrPCfYJWKTNSwkhcE6JQ" target="_blank" title="https://mp.weixin.qq.com/s/lOUrPCfYJWKTNSwkhcE6JQ" ref="nofollow noopener noreferrer">慧心一笑#07 | 爸爸回来了...</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FrS1bGeTldt1a6veIg4f_sw" target="_blank" title="https://mp.weixin.qq.com/s/rS1bGeTldt1a6veIg4f_sw" ref="nofollow noopener noreferrer">慧心一笑#09 | 农夫与蛇</a> 也阅读过 3万。目前慧心一笑系列发布了 9 篇，阅读量超过 2.5W 的爆款有 5 篇，比例算是很高了。</p>
<p>感觉微信公众号的推荐阅读机制应该有所变化。另外也不是每篇都会火爆，应该和作品本身质量、流传度也有关系。这个有趣的现象让我非常欣喜，后续我还会继续创作更有意思的四格漫画，来继续验证数据。大家也可以关注 <a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">《编程之王》</a> 公众号和我一起见证。等到第 30 篇后，我会再写一个复盘报告，和大家分享。</p>
<p>另外可能会有人问，你发这个就不怕别人也抄你的模式，跟你竞争吗。我只想说：</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d5c615ad68ad487fb38a55bc60c2a932~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1024&amp;h=559&amp;s=746498&amp;e=png&amp;b=162632" alt="" loading="lazy"/></p>
<hr/>
<p>更多文章和视频知识资讯，大家可以关注我的公众号、掘金和 B 站 。让我们一起成长，变得更强。我们下次再见~</p>
<ul>
<li>QQ交流群： 1046304516</li>
<li>掘金账号： <a href="https://juejin.cn/user/149189281194766" title="https://juejin.cn/user/149189281194766" target="_blank">张风捷特烈</a></li>
<li>bilibli 账号： <a href="https://link.juejin.cn/?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" title="https://link.juejin.cn/?target=https%3A%2F%2Fspace.bilibili.com%2F390457600" target="_blank">张风捷特烈</a></li>
<li>公众号： <a href="https://link.juejin.cn/?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" title="https://link.juejin.cn/?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fq8Vs5i3SU-4QPoU3-0xOSg" target="_blank">编程之王</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[扣子（Coze）实战：这个“小而美”的宝宝小名赛道，一键直达草稿箱]]></title>    <link>https://juejin.cn/post/7588028859541078042</link>    <guid>https://juejin.cn/post/7588028859541078042</guid>    <pubDate>2025-12-27T04:34:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859541078042" data-draft-id="7588042910194925618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="扣子（Coze）实战：这个“小而美”的宝宝小名赛道，一键直达草稿箱"/> <meta itemprop="keywords" content="Coze"/> <meta itemprop="datePublished" content="2025-12-27T04:34:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吾鳴"/> <meta itemprop="url" content="https://juejin.cn/user/3683842894347076"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            扣子（Coze）实战：这个“小而美”的宝宝小名赛道，一键直达草稿箱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3683842894347076/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吾鳴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T04:34:57.000Z" title="Sat Dec 27 2025 04:34:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是吾鳴。专注于分享提升工作与生活效率的工具，无偿分享AI领域相关的精选报告，持续关注AI的前沿动向。</p>
<p>最近有位宝妈给我发了一个公众号，这个公众号做的内容就是根据不同的主题去分享给宝宝取小名，比如“用五谷取小名，越念越有福”、“以茶叶取小名，好听到爆”等，看了下这个公众号的数据，还是挺不错的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37fe724c1cf74c89ba4df205b5460465~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=0Fu7jw3VsGxplEPpOuMQWj0fbFI%3D" alt="" loading="lazy"/></p>
<p>我问她为何盯上这个赛道了？她说自己也经历过给自己的宝宝取小名，当时要能看到这个公众号，那就省事多了。</p>
<p>她说平时在家里带娃，有时间想搞点事情，看着这个文章很简短比较容易上手，内容也很有趣，就想尝试做一下。</p>
<p>我分析了一下这个公众号的多篇文章，发现这类文章非常的精致，无论是文章的封面图，还是排版，都搭配得刚刚好，比较容易吸引人眼球。</p>
<p>经过对这些文章的分析，发现可以用扣子一键生成，只需要输入你想要的一个主题和想要的小名数量即可。</p>
<p>在开始工作流讲解之前我们先来看看效果，比如我输入“叠音不叠字，越念越有福的小名”这么个主题，要求生成的小名的数量为15个，选择颜色主题为粉色，经过一段时间的运行，文章就生成好了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01ab5e5555fb4e9fbd28a29b36400ba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=OS19Fstx5zxe5BSPSfobNMwCJ8o%3D" alt="" loading="lazy"/></p>
<p>尝试换个主题“用五谷取小名，越念越有福”，小名数量为15个，主题选择绿色，看看效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/172d5a56fc94468ea671c993b189719b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=llQlnS7t35%2FMD14lh5UOaRGxBeU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1. 完整的工作流程</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ad2329b26d142519ecd6591e9c94088~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=QW4qAJq5kItH530MLsNQOYjMeyg%3D" alt="" loading="lazy"/></p>
<p>1、取小名：通过大模型，根据输入的主题生成宝宝小名、小名解释、Emoji表情。</p>
<p>2、封面图绘图提示词生成：通过大模型生成可爱治愈风格的封面图绘图提示词。</p>
<p>3、封面图生成：依据生成好的绘图提示词生成图片，然后使用画板将图片合成封面图。</p>
<p>4、文章排版：将生成好的宝宝小名、小名解释、Emoji表情进行排版。</p>
<p>5、文章草稿生成：将排版好的文章内容、标题、封面图一起生成公众号文章草稿。</p>
<h2 data-id="heading-1">2. 工作流详细节点解读</h2>
<h3 data-id="heading-2">2.1. 开始</h3>
<ul>
<li>subject：文章主题，必填</li>
<li>nums：小名数量，必填</li>
<li>app_id：微信公众号开发者ID，必填</li>
<li>app_secret：微信公众号开发者密码，必填</li>
<li>api_token：插件认证，可后台回复【芝麻开门】联系获取（有条件），必填</li>
<li>color：主题色，支持 绿色(默认)、橙色、黄色、粉色、青色、蓝色、紫色，非必填</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f3fd2e1e1c44d0690f1206ffaf95b90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=rxlAmvAIBg5eAxQ9pntE370DABY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2. 取小名</h3>
<p>这个节点使用到了扣子官方的大模型节点，用来生成宝宝小名、小名解释和Emoji表情，参数如下：</p>
<ul>
<li>模型：选择【DeepSeek-V3.1】</li>
<li>输入</li>
</ul>

<ul>
<li>
<ul>
<li>subject：开始 -&gt; subject</li>
<li>nums：开始 -&gt; nums</li>
</ul>
</li>
</ul>

<ul>
<li>输出</li>
</ul>

<ul>
<li>
<ul>
<li>name_infos：小名信息列表，包含小名、小名解释、emoji表情</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80d31971526f43bc8cb3a01995b1884d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=5Spu4v33eBbEb65uXeLz7pSyMcM%3D" alt="" loading="lazy"/></p>
<ul>
<li>系统提示词，伪提示词，可以到豆包进行反推。</li>
</ul>

<pre><code class="hljs">你要变身专业宝宝小名创意顾问，结合文化与自然意象，为宝宝生成两字温暖好听的小名。
用户给主题和数量后，先确认需求，再按自然物、传统文化等主题特性，用谐音、经典或意象生成两字小名，简洁无生僻字。
给每个小名配贴切 Emoji，用 1-2 句画面感语言解释，结合主题与吉祥寓意。
最后按 “Emoji + 【小名】 + 解释” 列表输出，严格匹配数量，仅做宝宝小名相关内容，解释不超 20 字，主题不明确时提示用户补充。
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9be78f21a0db4f87b3affda4c1ca4acd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=vuu%2BmG8clskRXdNPp6VVVn7e2jM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.3. 封面图绘图提示词</h3>
<p>这个节点用来生成封面图的绘图提示词，使用到了扣子官方的大模型节点，这个节点主要是生成一些可爱治愈风的绘图提示词即可，它的参数如下：</p>
<ul>
<li>模型：选择【豆包-1.5-Pro-32k】</li>
<li>无输入</li>
<li>输出</li>
</ul>

<ul>
<li>
<ul>
<li>prompt1：提示词1</li>
<li>prompt2：提示词2</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a889156660404290bbf2ce478e1b24f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=zlnEahL3a1fK2tzD5rNaJQYJ%2BAg%3D" alt="" loading="lazy"/></p>
<ul>
<li>系统提示词，这是个伪提示词，可以到豆包进行反推。</li>
</ul>

<pre><code class="hljs">你要变身 AI 绘画提示词生成器，专注生成 “圆脸蛋腮红萌娃” 风格、适配 “同框合并” 的插画提示词。
核心形象是胖乎乎东亚萌娃，大圆脸蛋加大面积粉嫩腮红、无辜大眼睛、幼态短刘海或可爱发型。
每次输出 2 条提示词，服饰完全一致，动作表情不同但适配同框。
服饰从指定穿搭组合选，动作表情从对应维度选。固定风格为柔和马卡龙色调、手绘插画质感、干净米白色背景、暖柔光线、高细节、8K、治愈可爱氛围。
按 “核心形象 + 统一服饰 + 对应动作 + 对应表情 + 统一背景 + 固定风格” 格式分 2 条展示。
</code></pre>
<h3 data-id="heading-5">2.4. 图像生成</h3>
<p>这个节点使用到了扣子官方的图像生成节点，用来生成封面图片，需要注意的是这里使用到了Seedream4.0大模型，官方定价是200资源点（约0.2元）一张图，调试需谨慎。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5dd589f5cd7448288d0aa66f2452726~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=tqrbL%2Fi0tLmdDZ%2F7e7%2BBCXT7rqQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.5. 图像列表扁平化</h3>
<p>因为画板节点只能接收单张图片，而生图节点出来的是图片列表，所以需要这个节点把图片列表变成一张张图片，传入给画板，使用到了三方插件【列表工具合集】的【str_list_2_str】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30b5e203cba14ed890191757464a8e43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=I5fHYrBDrdgWYqv7ylKPu9rkfsA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2.6. 合成封面图</h3>
<p>这里使用到了扣子官方的画板节点，作用是把生成的两张图片合并成一张封面图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab3ce65035c542f99956a884cf2d99d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=PiYGtdnZYHZzyRjfUm0%2BQYJ%2FrPI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">2.7. 文章内容排版</h3>
<p>这个节点的作用是把生成好的Emoji表情、宝宝小名、宝宝小名解释进行文章排版，使用到了三方插件【公众号文章模板】的【text_list_layout】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfbf47b8bb764516a7fe17a6d011e059~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=z0S1mT1v9KBbBMTpe%2FPw18AkDKo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">2.8. 获取接口调用凭证</h3>
<p>这个节点用来获取微信公众号接口调用凭证，使用到了三方插件【微信公众号接口】的【get_access_token】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1c6e02ef74740118408a8838ff03109~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=K8%2BPgxae%2BuqMLqjZZT3CgVolDZM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">2.9. 上传封面图</h3>
<p>这个节点用来上传封面图到公众号素材库中，使用到了三方插件【微信公众号接口】的【wx_upload_image】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cadb4ceacfa148e8bc8057bd8db7f4b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=hf56I6Qytv63PWVuRgH%2Bhq95uiw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">2.10. 添加文章草稿</h3>
<p>这个节点用来生成公众号文章草稿，使用到了三方插件【微信公众号接口】的【add_draft】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b27aedcd6da645a297dc2160f6d98817~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=xyeutIR1TOSPymjfBr88t%2BGpDZI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">2.11. 结束</h3>
<p>media_id有值说明成功，没有值，说明失败了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a52992db81d466bb9c7a765f9ecf13a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=RKgj7WTQ6pFj8tjSlzKdSDQfWs4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">3. 总结</h2>
<p>本文介绍了如何使用工作流实现“宝宝小名”文章的一键生成，文中详细介绍了工作流中每个节点的输入、输出、参数以及作用，工作流节点不算多，照着操作，应该不难搭建。</p>
<p>本文的分享就到这里，如果您觉得有收获的话，可以给个一键三连，您的鼓励是吾鳴持续输出的最大动力。有什么疑问也可以打在评论区，吾鳴会第一时间回复。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceda64b899984f86be3fdf4189cad835~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767414897&amp;x-signature=bvaRZD8QRs3SryMu73xzSZbMpFI%3D" alt="" loading="lazy"/></p>
<p>最近实战了一些扣子（Coze）工作流相关的案例，包含小红薯图文生成、爆款视频剪辑、办公提效等扣子案例，内附详细的教程和工作流安装包，感兴趣的朋友可以来个<strong>一键三连（必须动作）</strong> ，文章评论区评论“<strong>扣子案例</strong>”领取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 19 源码全景图：从宏观到微观]]></title>    <link>https://juejin.cn/post/7588007285547286534</link>    <guid>https://juejin.cn/post/7588007285547286534</guid>    <pubDate>2025-12-27T02:41:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588007285547286534" data-draft-id="7588149079400742955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 19 源码全景图：从宏观到微观"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T02:41:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="借个火er"/> <meta itemprop="url" content="https://juejin.cn/user/2225067265915783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 19 源码全景图：从宏观到微观
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067265915783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    借个火er
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T02:41:41.000Z" title="Sat Dec 27 2025 02:41:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 19 源码全景图：从宏观到微观</h2>
<blockquote>
<p>本文是 React 源码系列的总览篇，帮你建立完整的知识框架，后续文章将逐一深入。</p>
</blockquote>
<h3 data-id="heading-1">一、React 是什么？</h3>
<p>一句话：<strong>React 是一个将状态映射为 UI 的函数</strong>。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">UI</span> = f(state)
</code></pre>
<p>当状态变化时，React 会：</p>
<ol>
<li>计算新的 UI（Reconciler）</li>
<li>调度更新任务（Scheduler）</li>
<li>将变化应用到 DOM（Renderer）</li>
</ol>
<h3 data-id="heading-2">二、三大核心模块</h3>
<pre><code class="hljs language-php" lang="php">┌─────────────────────────────────────────────────────────┐
│                        你的代码                          │
│            &lt;App /&gt; → useState → setState                │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                   Scheduler 调度器                       │
│                                                         │
│  • 优先级管理（用户交互 &gt; 动画 &gt; 数据请求）               │
│  • 时间切片（<span class="hljs-number">5</span>ms 一片，避免卡顿）                        │
│  • 任务队列（最小堆实现）                                │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  Reconciler 协调器                       │
│                                                         │
│  • <span class="hljs-built_in">Fiber</span> 架构（可中断的链表结构）                        │
│  • Diff 算法（最小化 DOM 操作）                          │
│  • Hooks 系统（状态和副作用管理）                        │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                   Renderer 渲染器                        │
│                                                         │
│  • ReactDOM（Web）                                      │
│  • React Native（移动端）                               │
│  • React Three <span class="hljs-built_in">Fiber</span>（<span class="hljs-number">3</span>D）                              │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-3">三、核心概念速览</h3>
<h4 data-id="heading-4">1. Fiber</h4>
<p>Fiber 是 React 的核心数据结构，每个组件对应一个 Fiber 节点：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">FiberNode</span> {
  <span class="hljs-comment">// 类型信息</span>
  tag,              <span class="hljs-comment">// 组件类型（函数组件=0，类组件=1，DOM=5）</span>
  type,             <span class="hljs-comment">// 组件函数或 DOM 标签</span>
  
  <span class="hljs-comment">// 树结构</span>
  <span class="hljs-keyword">return</span>,           <span class="hljs-comment">// 父节点</span>
  child,            <span class="hljs-comment">// 第一个子节点</span>
  sibling,          <span class="hljs-comment">// 兄弟节点</span>
  
  <span class="hljs-comment">// 状态</span>
  memoizedState,    <span class="hljs-comment">// Hooks 链表</span>
  memoizedProps,    <span class="hljs-comment">// 上次的 props</span>
  
  <span class="hljs-comment">// 副作用</span>
  flags,            <span class="hljs-comment">// 标记（插入、更新、删除）</span>
  
  <span class="hljs-comment">// 双缓冲</span>
  alternate,        <span class="hljs-comment">// 另一棵树的对应节点</span>
}
</code></pre>
<h4 data-id="heading-5">2. Lane（优先级）</h4>
<p>React 19 使用 31 位二进制数表示优先级：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">SyncLane</span>           = <span class="hljs-number">0b0000000000000000000000000000010</span>  <span class="hljs-comment">// 同步（最高）</span>
<span class="hljs-title class_">InputContinuousLane</span> = <span class="hljs-number">0b0000000000000000000000000001000</span>  <span class="hljs-comment">// 连续输入</span>
<span class="hljs-title class_">DefaultLane</span>        = <span class="hljs-number">0b0000000000000000000000000100000</span>  <span class="hljs-comment">// 默认</span>
<span class="hljs-title class_">TransitionLane</span>     = <span class="hljs-number">0b0000000000000000000000010000000</span>  <span class="hljs-comment">// 过渡</span>
<span class="hljs-title class_">IdleLane</span>           = <span class="hljs-number">0b0010000000000000000000000000000</span>  <span class="hljs-comment">// 空闲（最低）</span>
</code></pre>
<h4 data-id="heading-6">3. 双缓冲</h4>
<p>React 维护两棵 Fiber 树：</p>
<ul>
<li><strong>current</strong>：当前屏幕显示的</li>
<li><strong>workInProgress</strong>：正在构建的</li>
</ul>
<p>更新完成后一行代码切换：<code>root.current = workInProgress</code></p>
<h3 data-id="heading-7">四、渲染流程</h3>
<h4 data-id="heading-8">完整流程图</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">setState</span>() 
    │
    ▼
<span class="hljs-built_in">scheduleUpdateOnFiber</span>()     ← 标记更新
    │
    ▼
<span class="hljs-built_in">ensureRootIsScheduled</span>()     ← 确保调度
    │
    ▼
<span class="hljs-built_in">scheduleCallback</span>()          ← Scheduler 调度
    │
    ▼
<span class="hljs-built_in">performConcurrentWorkOnRoot</span>() ← 开始渲染
    │
    ├─────────────────────────────────────┐
    │         Render 阶段（可中断）         │
    │                                     │
    │  <span class="hljs-built_in">workLoopConcurrent</span>()               │
    │      │                              │
    │      ▼                              │
    │  <span class="hljs-built_in">performUnitOfWork</span>() ←──┐           │
    │      │                  │           │
    │      ▼                  │           │
    │  <span class="hljs-built_in">beginWork</span>()            │ 循环      │
    │      │                  │           │
    │      ▼                  │           │
    │  <span class="hljs-built_in">completeWork</span>() ────────┘           │
    │                                     │
    └─────────────────────────────────────┘
    │
    ▼
    ├─────────────────────────────────────┐
    │        Commit 阶段（不可中断）        │
    │                                     │
    │  <span class="hljs-built_in">commitBeforeMutationEffects</span>()      │
    │      │                              │
    │      ▼                              │
    │  <span class="hljs-built_in">commitMutationEffects</span>()  ← DOM操作 │
    │      │                              │
    │      ▼                              │
    │  root<span class="hljs-selector-class">.current</span> = finishedWork        │
    │      │                              │
    │      ▼                              │
    │  <span class="hljs-built_in">commitLayoutEffects</span>()              │
    │                                     │
    └─────────────────────────────────────┘
    │
    ▼
<span class="hljs-built_in">flushPassiveEffects</span>()       ← useEffect（异步）
</code></pre>
<h4 data-id="heading-9">Render 阶段</h4>
<p><strong>beginWork</strong>（向下递归）：</p>
<ul>
<li>根据组件类型处理（函数组件、类组件、DOM 元素）</li>
<li>调用组件函数，执行 Hooks</li>
<li>Diff 子节点，创建/复用 Fiber</li>
</ul>
<p><strong>completeWork</strong>（向上回溯）：</p>
<ul>
<li>创建 DOM 节点</li>
<li>收集副作用标记</li>
<li>冒泡 subtreeFlags</li>
</ul>
<h4 data-id="heading-10">Commit 阶段</h4>
<p>三个子阶段：</p>

























<table><thead><tr><th>阶段</th><th>时机</th><th>主要工作</th></tr></thead><tbody><tr><td>Before Mutation</td><td>DOM 操作前</td><td>getSnapshotBeforeUpdate</td></tr><tr><td>Mutation</td><td>DOM 操作</td><td>增删改 DOM</td></tr><tr><td>Layout</td><td>DOM 操作后</td><td>useLayoutEffect、componentDidMount</td></tr></tbody></table>
<h3 data-id="heading-11">五、Hooks 原理</h3>
<p>Hooks 以链表形式存储在 Fiber 的 <code>memoizedState</code> 上：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-built_in">Fiber</span>.memoizedState → useState → useEffect → useMemo → <span class="hljs-literal">null</span>
</code></pre>
<h4 data-id="heading-12">useState 流程</h4>
<pre><code class="hljs language-css" lang="css">Mount:  <span class="hljs-built_in">mountState</span>() → 创建 Hook → 初始化状态 → 返回 [state, setState]
Update: <span class="hljs-built_in">updateState</span>() → 获取 Hook → 处理更新队列 → 返回 [newState, setState]
</code></pre>
<h4 data-id="heading-13">useEffect 流程</h4>
<pre><code class="hljs language-css" lang="css">Mount:  <span class="hljs-built_in">mountEffect</span>() → 创建 Effect → 标记 Passive
Commit: <span class="hljs-built_in">flushPassiveEffects</span>() → 执行销毁函数 → 执行创建函数
</code></pre>
<h3 data-id="heading-14">六、Diff 算法</h3>
<p>React Diff 的三个策略：</p>
<ol>
<li><strong>同层比较</strong>：不跨层级移动节点</li>
<li><strong>类型判断</strong>：类型不同直接替换</li>
<li><strong>key 标识</strong>：通过 key 识别节点</li>
</ol>
<h4 data-id="heading-15">单节点 Diff</h4>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">key</span> 相同 &amp;&amp; type 相同 → 复用
<span class="hljs-keyword">key</span> 相同 &amp;&amp; type 不同 → 删除重建
<span class="hljs-keyword">key</span> 不同 → 删除，继续找
</code></pre>
<h4 data-id="heading-16">多节点 Diff（三轮遍历）</h4>
<pre><code class="hljs language-javascript" lang="javascript">第一轮：从左到右，处理更新
第二轮：处理新增或删除
第三轮：处理移动（<span class="hljs-title class_">Map</span> 查找）
</code></pre>
<h3 data-id="heading-17">七、Scheduler 调度</h3>
<h4 data-id="heading-18">优先级</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">ImmediatePriority</span>   <span class="hljs-comment">// -1ms，立即执行</span>
<span class="hljs-title class_">UserBlockingPriority</span> <span class="hljs-comment">// 250ms，用户交互</span>
<span class="hljs-title class_">NormalPriority</span>      <span class="hljs-comment">// 5000ms，普通更新</span>
<span class="hljs-title class_">LowPriority</span>         <span class="hljs-comment">// 10000ms，低优先级</span>
<span class="hljs-title class_">IdlePriority</span>        <span class="hljs-comment">// 永不过期，空闲执行</span>
</code></pre>
<h4 data-id="heading-19">时间切片</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">while</span> (task &amp;&amp; !<span class="hljs-title function_">shouldYield</span>()) {  <span class="hljs-comment">// 5ms 检查一次</span>
    task = <span class="hljs-title function_">performTask</span>(task);
  }
  <span class="hljs-keyword">if</span> (task) {
    <span class="hljs-title function_">scheduleCallback</span>(task);  <span class="hljs-comment">// 还有任务，继续调度</span>
  }
}
</code></pre>
<h3 data-id="heading-20">八、源码目录</h3>
<pre><code class="hljs language-bash" lang="bash">packages/
├── react/                    <span class="hljs-comment"># React API</span>
│   └── src/ReactHooks.js     <span class="hljs-comment"># Hooks 入口</span>
│
├── react-reconciler/         <span class="hljs-comment"># 协调器（核心）</span>
│   └── src/
│       ├── ReactFiber.js           <span class="hljs-comment"># Fiber 定义</span>
│       ├── ReactFiberWorkLoop.js   <span class="hljs-comment"># 工作循环</span>
│       ├── ReactFiberBeginWork.js  <span class="hljs-comment"># 递阶段</span>
│       ├── ReactFiberCompleteWork.js <span class="hljs-comment"># 归阶段</span>
│       ├── ReactFiberHooks.js      <span class="hljs-comment"># Hooks 实现</span>
│       ├── ReactFiberCommitWork.js <span class="hljs-comment"># Commit</span>
│       ├── ReactFiberLane.js       <span class="hljs-comment"># 优先级</span>
│       └── ReactChildFiber.js      <span class="hljs-comment"># Diff 算法</span>
│
├── react-dom/                <span class="hljs-comment"># DOM 渲染器</span>
│
└── scheduler/                <span class="hljs-comment"># 调度器</span>
    └── src/
        ├── Scheduler.js          <span class="hljs-comment"># 调度逻辑</span>
        └── SchedulerMinHeap.js   <span class="hljs-comment"># 最小堆</span>
</code></pre>
<h3 data-id="heading-21">九、系列文章导航</h3>


















































<table><thead><tr><th>序号</th><th>主题</th><th>核心内容</th></tr></thead><tbody><tr><td>00</td><td><a href="https://juejin.cn/post/7588149079400710187" target="_blank" title="https://juejin.cn/post/7588149079400710187">调试环境搭建</a></td><td>项目介绍、快速开始</td></tr><tr><td>01</td><td>架构总览（本文）</td><td>三大模块、核心概念</td></tr><tr><td>02</td><td><a href="https://juejin.cn/post/7588007285547302918" target="_blank" title="https://juejin.cn/post/7588007285547302918">useState 原理</a></td><td>Hook 链表、更新队列</td></tr><tr><td>03</td><td><a href="https://juejin.cn/post/7588001624905973779" target="_blank" title="https://juejin.cn/post/7588001624905973779">useEffect 原理</a></td><td>Effect 链表、执行时机</td></tr><tr><td>04</td><td><a href="https://juejin.cn/post/7588061231589523497" target="_blank" title="https://juejin.cn/post/7588061231589523497">Fiber 工作循环</a></td><td>beginWork、completeWork</td></tr><tr><td>05</td><td><a href="https://juejin.cn/post/7588001624905990163" target="_blank" title="https://juejin.cn/post/7588001624905990163">Diff 算法</a></td><td>单节点、多节点 Diff</td></tr><tr><td>06</td><td><a href="https://juejin.cn/post/7588064253635477558" target="_blank" title="https://juejin.cn/post/7588064253635477558">Scheduler 调度器</a></td><td>优先级、时间切片</td></tr><tr><td>07</td><td><a href="https://juejin.cn/post/7588061231589556265" target="_blank" title="https://juejin.cn/post/7588061231589556265">Commit 阶段</a></td><td>三个子阶段、DOM 操作</td></tr></tbody></table>
<h3 data-id="heading-22">十、学习建议</h3>
<ol>
<li><strong>先跑起来</strong>：clone react-debug，打断点调试</li>
<li><strong>从 useState 开始</strong>：最简单也最核心</li>
<li><strong>画流程图</strong>：边看边画，加深理解</li>
<li><strong>写测试组件</strong>：验证你的理解</li>
</ol>
<hr/>
<blockquote>
<p>📦 配套源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F220529%2Freact-debug" target="_blank" title="https://github.com/220529/react-debug" ref="nofollow noopener noreferrer">github.com/220529/reac…</a></p>
<p>上一篇：<a href="https://juejin.cn/post/7588149079400710187" target="_blank" title="https://juejin.cn/post/7588149079400710187">React 源码调试环境搭建</a></p>
<p>下一篇：<a href="https://juejin.cn/post/7588007285547302918" target="_blank" title="https://juejin.cn/post/7588007285547302918">useState 的实现原理</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 19 源码揭秘（二）：useState 的实现原理]]></title>    <link>https://juejin.cn/post/7588007285547302918</link>    <guid>https://juejin.cn/post/7588007285547302918</guid>    <pubDate>2025-12-27T02:42:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588007285547302918" data-draft-id="7588149079400759339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 19 源码揭秘（二）：useState 的实现原理"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-27T02:42:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="借个火er"/> <meta itemprop="url" content="https://juejin.cn/user/2225067265915783"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 19 源码揭秘（二）：useState 的实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067265915783/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    借个火er
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T02:42:47.000Z" title="Sat Dec 27 2025 02:42:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 19 源码揭秘（二）：useState 的实现原理</h2>
<blockquote>
<p>本文深入 React 源码，带你彻底搞懂 useState 从调用到更新的完整流程。</p>
</blockquote>
<h3 data-id="heading-1">前言</h3>
<p><code>useState</code> 可能是你用得最多的 Hook，但你知道它背后是怎么工作的吗？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);  <span class="hljs-comment">// 这行代码背后发生了什么？</span>
</code></pre>
<p>本文将从源码角度，完整解析 useState 的实现原理。</p>
<h3 data-id="heading-2">一、Hook 的数据结构</h3>
<p>首先，我们需要了解 Hook 在 React 内部是如何存储的。</p>
<h4 data-id="heading-3">Hook 节点</h4>
<p>每个 Hook 调用都会创建一个 Hook 对象：</p>
<pre><code class="hljs language-javascript" lang="javascript">type <span class="hljs-title class_">Hook</span> = {
  <span class="hljs-attr">memoizedState</span>: any,    <span class="hljs-comment">// 存储的状态值</span>
  <span class="hljs-attr">baseState</span>: any,        <span class="hljs-comment">// 基础状态（用于更新计算）</span>
  <span class="hljs-attr">baseQueue</span>: <span class="hljs-title class_">Update</span> | <span class="hljs-literal">null</span>,  <span class="hljs-comment">// 基础更新队列</span>
  <span class="hljs-attr">queue</span>: <span class="hljs-title class_">UpdateQueue</span> | <span class="hljs-literal">null</span>, <span class="hljs-comment">// 更新队列</span>
  <span class="hljs-attr">next</span>: <span class="hljs-title class_">Hook</span> | <span class="hljs-literal">null</span>,     <span class="hljs-comment">// 指向下一个 Hook</span>
};
</code></pre>
<h4 data-id="heading-4">Hook 链表</h4>
<p>多个 Hook 以链表形式存储在 Fiber 节点的 <code>memoizedState</code> 上：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-built_in">Fiber</span>.memoizedState
        │
        ▼
    ┌───────┐     ┌───────┐     ┌───────┐
    │ Hook1 │ ──► │ Hook2 │ ──► │ Hook3 │ ──► <span class="hljs-literal">null</span>
    │useState│     │useEffect│    │useMemo│
    └───────┘     └───────┘     └───────┘
</code></pre>
<p>这就是为什么 <strong>Hook 不能在条件语句中调用</strong>——React 依赖调用顺序来匹配 Hook。</p>
<h3 data-id="heading-5">二、首次渲染：mountState</h3>
<p>当组件首次渲染时，useState 会调用 <code>mountState</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 源码位置：react-reconciler/src/ReactFiberHooks.js</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">mountState</span>(<span class="hljs-params">initialState</span>) {
  <span class="hljs-comment">// 1. 创建 Hook 节点，加入链表</span>
  <span class="hljs-keyword">const</span> hook = <span class="hljs-title function_">mountWorkInProgressHook</span>();
  
  <span class="hljs-comment">// 2. 处理初始值（支持函数式初始化）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> initialState === <span class="hljs-string">'function'</span>) {
    initialState = <span class="hljs-title function_">initialState</span>();
  }
  
  <span class="hljs-comment">// 3. 保存初始状态</span>
  hook.<span class="hljs-property">memoizedState</span> = hook.<span class="hljs-property">baseState</span> = initialState;
  
  <span class="hljs-comment">// 4. 创建更新队列</span>
  <span class="hljs-keyword">const</span> queue = {
    <span class="hljs-attr">pending</span>: <span class="hljs-literal">null</span>,           <span class="hljs-comment">// 待处理的更新</span>
    <span class="hljs-attr">lanes</span>: <span class="hljs-title class_">NoLanes</span>,
    <span class="hljs-attr">dispatch</span>: <span class="hljs-literal">null</span>,          <span class="hljs-comment">// setState 函数</span>
    <span class="hljs-attr">lastRenderedReducer</span>: basicStateReducer,
    <span class="hljs-attr">lastRenderedState</span>: initialState,
  };
  hook.<span class="hljs-property">queue</span> = queue;
  
  <span class="hljs-comment">// 5. 绑定 dispatch 函数（就是 setState）</span>
  <span class="hljs-keyword">const</span> dispatch = dispatchSetState.<span class="hljs-title function_">bind</span>(<span class="hljs-literal">null</span>, currentlyRenderingFiber, queue);
  queue.<span class="hljs-property">dispatch</span> = dispatch;
  
  <span class="hljs-comment">// 6. 返回 [state, setState]</span>
  <span class="hljs-keyword">return</span> [hook.<span class="hljs-property">memoizedState</span>, dispatch];
}
</code></pre>
<h4 data-id="heading-6">mountWorkInProgressHook</h4>
<p>这个函数负责创建 Hook 节点并维护链表：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">mountWorkInProgressHook</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> hook = {
    <span class="hljs-attr">memoizedState</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">baseState</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">baseQueue</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">queue</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span>,
  };

  <span class="hljs-keyword">if</span> (workInProgressHook === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 第一个 Hook，挂载到 Fiber</span>
    currentlyRenderingFiber.<span class="hljs-property">memoizedState</span> = workInProgressHook = hook;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 追加到链表末尾</span>
    workInProgressHook = workInProgressHook.<span class="hljs-property">next</span> = hook;
  }
  
  <span class="hljs-keyword">return</span> workInProgressHook;
}
</code></pre>
<h3 data-id="heading-7">三、触发更新：dispatchSetState</h3>
<p>当你调用 <code>setCount(1)</code> 时，实际执行的是 <code>dispatchSetState</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">dispatchSetState</span>(<span class="hljs-params">fiber, queue, action</span>) {
  <span class="hljs-comment">// 1. 获取更新优先级</span>
  <span class="hljs-keyword">const</span> lane = <span class="hljs-title function_">requestUpdateLane</span>(fiber);
  
  <span class="hljs-comment">// 2. 创建更新对象</span>
  <span class="hljs-keyword">const</span> update = {
    lane,
    action,              <span class="hljs-comment">// 新值或更新函数</span>
    <span class="hljs-attr">hasEagerState</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">eagerState</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span>,
  };
  
  <span class="hljs-comment">// 3. 性能优化：Eager State（提前计算）</span>
  <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">lanes</span> === <span class="hljs-title class_">NoLanes</span>) {
    <span class="hljs-keyword">const</span> currentState = queue.<span class="hljs-property">lastRenderedState</span>;
    <span class="hljs-keyword">const</span> eagerState = <span class="hljs-title function_">basicStateReducer</span>(currentState, action);
    update.<span class="hljs-property">hasEagerState</span> = <span class="hljs-literal">true</span>;
    update.<span class="hljs-property">eagerState</span> = eagerState;
    
    <span class="hljs-comment">// 如果新旧状态相同，跳过更新！</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">is</span>(eagerState, currentState)) {
      <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// Bailout!</span>
    }
  }
  
  <span class="hljs-comment">// 4. 将更新加入队列</span>
  <span class="hljs-title function_">enqueueConcurrentHookUpdate</span>(fiber, queue, update, lane);
  
  <span class="hljs-comment">// 5. 调度更新</span>
  <span class="hljs-title function_">scheduleUpdateOnFiber</span>(root, fiber, lane);
}
</code></pre>
<h4 data-id="heading-8">Eager State 优化</h4>
<p>这是一个重要的性能优化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// 点击按钮</span>
<span class="hljs-title function_">setCount</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 状态没变，React 会跳过这次更新！</span>
</code></pre>
<p>React 会在调度之前就计算新状态，如果和旧状态相同（通过 <code>Object.is</code> 比较），直接跳过整个更新流程。</p>
<h3 data-id="heading-9">四、更新渲染：updateState</h3>
<p>当组件重新渲染时，useState 会调用 <code>updateState</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateState</span>(<span class="hljs-params">initialState</span>) {
  <span class="hljs-comment">// useState 本质上是预设了 reducer 的 useReducer</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateReducer</span>(basicStateReducer, initialState);
}

<span class="hljs-comment">// 基础 reducer：支持值或函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">basicStateReducer</span>(<span class="hljs-params">state, action</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> action === <span class="hljs-string">'function'</span> ? <span class="hljs-title function_">action</span>(state) : action;
}
</code></pre>
<h4 data-id="heading-10">updateReducer</h4>
<p>这是处理更新的核心逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateReducer</span>(<span class="hljs-params">reducer, initialArg</span>) {
  <span class="hljs-comment">// 1. 获取当前 Hook</span>
  <span class="hljs-keyword">const</span> hook = <span class="hljs-title function_">updateWorkInProgressHook</span>();
  <span class="hljs-keyword">const</span> queue = hook.<span class="hljs-property">queue</span>;
  
  <span class="hljs-comment">// 2. 获取待处理的更新</span>
  <span class="hljs-keyword">const</span> pending = queue.<span class="hljs-property">pending</span>;
  
  <span class="hljs-comment">// 3. 计算新状态</span>
  <span class="hljs-keyword">let</span> newState = hook.<span class="hljs-property">baseState</span>;
  <span class="hljs-keyword">if</span> (pending !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">let</span> update = pending.<span class="hljs-property">first</span>;
    <span class="hljs-keyword">do</span> {
      <span class="hljs-keyword">const</span> action = update.<span class="hljs-property">action</span>;
      newState = <span class="hljs-title function_">reducer</span>(newState, action);
      update = update.<span class="hljs-property">next</span>;
    } <span class="hljs-keyword">while</span> (update !== <span class="hljs-literal">null</span>);
  }
  
  <span class="hljs-comment">// 4. 保存新状态</span>
  hook.<span class="hljs-property">memoizedState</span> = newState;
  
  <span class="hljs-comment">// 5. 返回新状态和 dispatch</span>
  <span class="hljs-keyword">return</span> [hook.<span class="hljs-property">memoizedState</span>, queue.<span class="hljs-property">dispatch</span>];
}
</code></pre>
<h4 data-id="heading-11">updateWorkInProgressHook</h4>
<p>更新时，需要从 current 树复制 Hook：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateWorkInProgressHook</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 从 current Fiber 获取对应的 Hook</span>
  <span class="hljs-keyword">let</span> nextCurrentHook;
  <span class="hljs-keyword">if</span> (currentHook === <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> current = currentlyRenderingFiber.<span class="hljs-property">alternate</span>;
    nextCurrentHook = current.<span class="hljs-property">memoizedState</span>;
  } <span class="hljs-keyword">else</span> {
    nextCurrentHook = currentHook.<span class="hljs-property">next</span>;
  }
  
  currentHook = nextCurrentHook;
  
  <span class="hljs-comment">// 复制 Hook 到 workInProgress</span>
  <span class="hljs-keyword">const</span> newHook = {
    <span class="hljs-attr">memoizedState</span>: currentHook.<span class="hljs-property">memoizedState</span>,
    <span class="hljs-attr">baseState</span>: currentHook.<span class="hljs-property">baseState</span>,
    <span class="hljs-attr">baseQueue</span>: currentHook.<span class="hljs-property">baseQueue</span>,
    <span class="hljs-attr">queue</span>: currentHook.<span class="hljs-property">queue</span>,
    <span class="hljs-attr">next</span>: <span class="hljs-literal">null</span>,
  };
  
  <span class="hljs-comment">// 加入链表...</span>
  <span class="hljs-keyword">return</span> newHook;
}
</code></pre>
<h3 data-id="heading-12">五、完整流程图</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                    首次渲染 (Mount)                      │
├─────────────────────────────────────────────────────────┤
│  <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>)                                            │
│      │                                                  │
│      ▼                                                  │
│  <span class="hljs-built_in">mountState</span>(<span class="hljs-number">0</span>)                                          │
│      │                                                  │
│      ├──► 创建 Hook 节点                                │
│      ├──► 初始化 memoizedState = <span class="hljs-number">0</span>                      │
│      ├──► 创建 UpdateQueue                              │
│      ├──► 绑定 dispatch = dispatchSetState              │
│      │                                                  │
│      ▼                                                  │
│  返回 <span class="hljs-selector-attr">[0, setCount]</span>                                     │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    触发更新                              │
├─────────────────────────────────────────────────────────┤
│  <span class="hljs-built_in">setCount</span>(<span class="hljs-number">1</span>)                                            │
│      │                                                  │
│      ▼                                                  │
│  <span class="hljs-built_in">dispatchSetState</span>(fiber, queue, <span class="hljs-number">1</span>)                      │
│      │                                                  │
│      ├──► 获取优先级 lane                               │
│      ├──► 创建 Update 对象                              │
│      ├──► Eager State: 计算新状态                       │
│      ├──► 比较新旧状态，相同则 Bailout                   │
│      ├──► 入队更新                                      │
│      │                                                  │
│      ▼                                                  │
│  <span class="hljs-built_in">scheduleUpdateOnFiber</span>() ──► 调度重新渲染               │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    重新渲染 (Update)                     │
├─────────────────────────────────────────────────────────┤
│  <span class="hljs-built_in">useState</span>(<span class="hljs-number">0</span>)  // 初始值被忽略                           │
│      │                                                  │
│      ▼                                                  │
│  <span class="hljs-built_in">updateState</span>(<span class="hljs-number">0</span>)                                         │
│      │                                                  │
│      ▼                                                  │
│  <span class="hljs-built_in">updateReducer</span>(basicStateReducer, <span class="hljs-number">0</span>)                    │
│      │                                                  │
│      ├──► 获取对应的 Hook                               │
│      ├──► 处理 UpdateQueue 中的更新                     │
│      ├──► 计算新状态 = <span class="hljs-number">1</span>                                │
│      │                                                  │
│      ▼                                                  │
│  返回 [<span class="hljs-number">1</span>, setCount]                                     │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-13">六、Dispatcher 切换</h3>
<p>React 如何区分 mount 和 update？答案是 <strong>Dispatcher 切换</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// renderWithHooks 中</span>
<span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">H</span> = 
  current === <span class="hljs-literal">null</span> || current.<span class="hljs-property">memoizedState</span> === <span class="hljs-literal">null</span>
    ? <span class="hljs-title class_">HooksDispatcherOnMount</span>   <span class="hljs-comment">// 首次渲染</span>
    : <span class="hljs-title class_">HooksDispatcherOnUpdate</span>; <span class="hljs-comment">// 更新渲染</span>

<span class="hljs-comment">// 两个 Dispatcher 的 useState 指向不同函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HooksDispatcherOnMount</span> = {
  <span class="hljs-attr">useState</span>: mountState,
  <span class="hljs-attr">useEffect</span>: mountEffect,
  <span class="hljs-comment">// ...</span>
};

<span class="hljs-keyword">const</span> <span class="hljs-title class_">HooksDispatcherOnUpdate</span> = {
  <span class="hljs-attr">useState</span>: updateState,
  <span class="hljs-attr">useEffect</span>: updateEffect,
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<p>渲染完成后，切换到 ContextOnlyDispatcher，禁止在组件外调用 Hook：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 渲染完成后</span>
<span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">H</span> = <span class="hljs-title class_">ContextOnlyDispatcher</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">ContextOnlyDispatcher</span> = {
  <span class="hljs-attr">useState</span>: throwInvalidHookError,  <span class="hljs-comment">// 抛出错误</span>
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<h3 data-id="heading-14">七、为什么 Hook 不能条件调用？</h3>
<p>现在你应该明白了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误</span>
<span class="hljs-keyword">if</span> (condition) {
  <span class="hljs-keyword">const</span> [a, setA] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// Hook 1</span>
}
<span class="hljs-keyword">const</span> [b, setB] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);    <span class="hljs-comment">// Hook 2 或 Hook 1？</span>

<span class="hljs-comment">// ✅ 正确</span>
<span class="hljs-keyword">const</span> [a, setA] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);    <span class="hljs-comment">// 始终是 Hook 1</span>
<span class="hljs-keyword">const</span> [b, setB] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);    <span class="hljs-comment">// 始终是 Hook 2</span>
</code></pre>
<p>React 通过遍历链表来匹配 Hook，如果顺序变了，状态就乱了。</p>
<h3 data-id="heading-15">八、调试技巧</h3>
<p>想要亲自验证？在这些位置打断点：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 首次渲染</span>
mountState          <span class="hljs-comment">// react-reconciler/src/ReactFiberHooks.js</span>

<span class="hljs-comment">// 触发更新</span>
dispatchSetState    <span class="hljs-comment">// react-reconciler/src/ReactFiberHooks.js</span>

<span class="hljs-comment">// 重新渲染</span>
updateReducer       <span class="hljs-comment">// react-reconciler/src/ReactFiberHooks.js</span>
</code></pre>
<p>用 Counter 组件测试：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Counter</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 断点这里</span>
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;{count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
};
</code></pre>
<h3 data-id="heading-16">小结</h3>
<p>本文深入分析了 useState 的实现原理：</p>
<ol>
<li><strong>数据结构</strong>：Hook 以链表形式存储在 Fiber.memoizedState</li>
<li><strong>首次渲染</strong>：mountState 创建 Hook 和 UpdateQueue</li>
<li><strong>触发更新</strong>：dispatchSetState 创建 Update，调度渲染</li>
<li><strong>Eager State</strong>：提前计算，相同状态跳过更新</li>
<li><strong>重新渲染</strong>：updateReducer 处理更新队列，计算新状态</li>
<li><strong>Dispatcher</strong>：通过切换实现 mount/update 的区分</li>
</ol>
<p>下一篇我们将分析 <strong>useEffect 的实现原理</strong>，看看副作用是如何被调度和执行的。</p>
<hr/>
<blockquote>
<p>📦 配套源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F220529%2Freact-debug" target="_blank" title="https://github.com/220529/react-debug" ref="nofollow noopener noreferrer">github.com/220529/reac…</a></p>
<p>上一篇：<a href="https://juejin.cn/post/7588007285547286534" target="_blank" title="https://juejin.cn/post/7588007285547286534">React 19 源码全景图</a></p>
<p>下一篇：<a href="https://juejin.cn/post/7588001624905973779" target="_blank" title="https://juejin.cn/post/7588001624905973779">useEffect 的实现原理</a></p>
<p>如果觉得有帮助，欢迎点赞收藏 👍</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[破防了！阿星一年用AI撸了50个项目，这10条避坑经验你必须知道]]></title>    <link>https://juejin.cn/post/7588031908170973193</link>    <guid>https://juejin.cn/post/7588031908170973193</guid>    <pubDate>2025-12-26T16:18:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588031908170973193" data-draft-id="7588086766235795494" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="破防了！阿星一年用AI撸了50个项目，这10条避坑经验你必须知道"/> <meta itemprop="keywords" content="人工智能,前端"/> <meta itemprop="datePublished" content="2025-12-26T16:18:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿星AI工作室"/> <meta itemprop="url" content="https://juejin.cn/user/2250051536050763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            破防了！阿星一年用AI撸了50个项目，这10条避坑经验你必须知道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250051536050763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿星AI工作室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T16:18:32.000Z" title="Fri Dec 26 2025 16:18:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/509b6a53b2c14622a7f411953f571293~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=zQYLeU1DJz%2BqZuqyleR2EWCqEhk%3D" alt="图片" loading="lazy"/></p>
<p>哈喽，大家好！</p>
<p>阿星👋</p>
<p>属实没想到现在IDE都卷得出年终报告了：我在TRAE的年终报告里居然是个开服贡献者</p>
<p>是啊， 断断续续vibecoding了50个项目</p>
<p>也有几个体会分享给大家——</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1756b4f4f81f48cfb07f7e35e9f2ca56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=VHFsY2cSNN4mRQ3oHrXU%2BR1kUTE%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">1、一个好的前期prompt胜过后期折腾100遍</h2>
<p>强提示词控制是阿星在踩了很多坑之后才意识到的</p>
<p>新手都是蜜汁自信觉得随便一句话能coding个差不多的</p>
<p>结果越说越多还不如第一次规定好</p>
<p>所以即使是很简单的项目我既会用「EARS语法」去把普通提示词扩展成工程级提示词</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e71e1d1bb8b4c8b9e7ea2c776bbbe50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=%2FNF5yDFMhehBeljoDY8SA%2FqVCIE%3D" alt="图片" loading="lazy"/></p>
<p>我的原需求大概这么长</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/540fbf38fe3b4055bcbdc04a98307523~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=5mSR0r6rRtLMMbVmiSLOGTJnc6s%3D" alt="图片" loading="lazy"/></p>
<p>通过「EARS语法」也就详细了10倍吧👇•ᴗ•💧</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb71c0c1081f4d4286b563606250e97a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=K2Ql%2BB0R4za0D7xIjCB42Hnwdcs%3D" alt="图片" loading="lazy"/></p>
<p>毕竟，几千字的提示词和100字的简单交代差别还是很大的</p>
<p>也会用一些自动化提示词增强</p>
<p>来帮我在忙的时候也能兼顾最基本提示词专业度</p>
<p>比如这个自动增强功能</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c9c295800a4438a8df01b8aa559e3ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=BzNoQnvzGe6SIHLIGhwc%2BXTb%2BCU%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">2、不一定非要用国外CLI</h2>
<p>前两天，阿星想做一个卡密系统。 本能地打开了国外的CLI（一种命令行编程形式）</p>
<p>但是用国内IDE来做却意外的顺利</p>
<p>简单的项目的话，整个项目下来几乎没有回滚的时候，</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/047263370a49453ead1498ed5b6266f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=KAknz4%2BzV2BOZzEQ3RrYVXYx%2BYU%3D" alt="图片" loading="lazy"/></p>
<p>很少，但不能说是完全没有回滚，那也太夸张了。</p>
<p>但是对我这种半路才开始接触AI编程的人来说算友好的，</p>
<p>比2023年那会儿的IDE更是让我们少做了很多无用工。</p>
<p><strong>虽然现在某些CLI功能确实呼声很高，但是对小白来说上手难度其实挺大的</strong>，看到命令行头晕了还怎么继续。所以如果你完全没有用AI编程过，我还是建议从智能IDE做起。</p>
<h2 data-id="heading-2">3、工作流直接做成智能体</h2>
<p>每次做项目，</p>
<p>阿星都会做一个guidebook把整个项目的踩坑过程记录下来，好二次复用到自媒体上，<strong>如果没有这些实操记录，写的编程文章就会虚无很多，为了一鱼多吃也要记录一下。</strong></p>
<p>这个时候就会用到智能体功能，让他扮演guidebook助手，给他人设就行了。这个过程其实比在一些cli工具里去配置一个agent要方便点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a428f856b3504b829734de8b2e800802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=5i9J07qPYCMlWiZxdTWoe9%2BrfbE%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6817a064a4de4741919e2cd2273a00a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=1GeofwTzorPZl9K5BQc4JUlWjqE%3D" alt="图片" loading="lazy"/></p>
<p><strong>阿星之前也是在cli里配agent，但是引用起来太麻烦了</strong>，一个是可视化信息有限的情况下太考验记性，一个是容易打击新手积极性，所以更倾向于直接在IDE里用智能体搞定。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/637ee2b8c0a943e58fe912d29730730d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=ofRimE6M68nhg18OvJjS9YAkWTs%3D" alt="图片" loading="lazy"/></p>
<p>而且我蕞喜欢的是<strong>它可以直接直接让朋友复用，它相当于是把提示词的功能直接插件化了，让咱们主打一个活儿不干两遍</strong>。也不用相互发提示词粘来粘去了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7bf882f59b54ade8544306bf7be08d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=1pWPHI5Rvov2TqIUxS5s8mTycJ8%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3">4、前端项目，直接选择元素</h2>
<p>阿星觉得凡是涉及到前端视觉的精细化控制</p>
<p>prompt的效率其实比视觉点击要低很多</p>
<p>所以我自己经常用的还有元素选择，不用我一直嘚啵嘚到底改哪里了，效率高了很多</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff94331a0fc743509c3be51e35393800~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=P5HWpDpj2Xgwt7RhB1IxUhStws8%3D" alt="图片" loading="lazy"/></p>
<p>figma的前端我都直接用mcp了，个人感觉是打通设计与开发的关键一步。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cfd06042db94e92bc23e5b1d937d107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=2rW7Jzo8Mi5Krlgn5YbWwZ8M0oM%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-4">5、引用上下文</h2>
<p>编程的时候不要直接去提问，最好选中你要改的上下文再提问，</p>
<p>而且现在IDE可以引用的上下文很多，终端里的报错也能直接加进去，文件、文件夹、工作区、文档集和网页其实都可以作为整个项目的上下文添加进去。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aefc165221994d4db3e966cf4161791c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=8TLnymHEho2vl4oANPNls4ZtoKs%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">6、数据库可以直接连supabase mcp</h2>
<p>之前阿星只是做点不带数据库的前端项目</p>
<p>但是做着做着必然会用到数据库啊，特别是一些要做出海的同学</p>
<p>阿星以前激活数据库是直接让AI去接API</p>
<pre><code class="hljs language-arduino" lang="arduino">
<span class="hljs-keyword">import</span> { createClient } from <span class="hljs-string">'@supabase/supabase-js'</span>

<span class="hljs-type">const</span> supabaseUrl = <span class="hljs-string">'https://okqxrigpjgoncvoflenz.supabase.co'</span>
<span class="hljs-type">const</span> supabaseKey = process.env.SUPABASE_KEY
<span class="hljs-type">const</span> supabase = <span class="hljs-built_in">createClient</span>(supabaseUrl, supabaseKey)
</code></pre>
<p>后来发现mcp可以自己搞定•ᴗ•💧除了刚开始配置可能有点懵没啥大问题</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d5f9bd683d74d3181bdd878b7b0e96c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=dsmiyrxncaezCc8rh5Ammb5ut%2BI%3D" alt="图片" loading="lazy"/></p>
<p>MCP = AI用统一的工具调用方式访问数据库</p>
<p>看文档 =AI每次都要理解API格式、构造请求，小白容易出错，特别我们频繁修改的时候</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/343fc5836a8547a9b9071b75a46a8bc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=e2v7YizBO%2FMFoIDZwsjMmv37EFM%3D" alt="图片" loading="lazy"/></p>
<p>所以，简单的需求直接配就行了， <strong>我一般直接添加mcp， Connect Supabase。</strong></p>
<h2 data-id="heading-6">7、活用tab</h2>
<p>我个人是用tab比较少的，是个懒人。被年终总结拆穿了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a05018654f240b593cb30cd3dc578af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=xY3R6HtAyvz9licMdjwEYztJB5g%3D" alt="图片" loading="lazy"/></p>
<p>TRAE里的这个tab功能主要是做代码补全、多行修改的</p>
<p>按下 Tab 键，跳转至修改点所在位置。</p>
<p>Ctrl / Command + → 组合键逐字接受一个建议的修改。</p>
<p>Escape 键拒绝就好。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c4e08734d664093a21b800cda5cb3a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=3Wrqy92J%2BUX4Qh3UoBA0JQgiV9c%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbadf3eec77d43aa8cf50978110e4583~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=%2BdH1%2Fu6GJtSchPK%2BP07ks4nd3IY%3D" alt="图片" loading="lazy"/></p>
<p>现在经常用tab功能的都是大神了😂</p>
<p>要真学代码真编程还是得看的更细一点。</p>
<h2 data-id="heading-7">8、版本控制</h2>
<p>咱们写代码的时候都要提交很多git版本，</p>
<p>但是改一版输入一次提交命令就太麻烦了。</p>
<p>可以用一些插件，把git Hub网页功能集成到你的本地编辑器里。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19050f6813414580bd8f5cba26d7a686~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=wmesMj4PojvCunnJG1xPbUfch8E%3D" alt="图片" loading="lazy"/></p>
<p>直接就能推送代码了，TRAE有个优点，除了git还能更直观地直接在单个句子旁边回退</p>
<p>至少能给我储存10个版本以防万一</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdae4ec3b08e44259e1a5aa0b21b4218~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=W%2BweCeUQbVsD5lYbkeE6wtnqDe0%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-8">9、管好你和AI的聊天记录</h2>
<p>我自己刚接触一些cli工具的时候，</p>
<p>完全找不到哪里去看聊天记录再去看网上各种插件来做聊天记录保存的，</p>
<p>对小白来说光是设置这些东西都晕了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7397cd92a01442e5a73035da51e2e707~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=Lw4YuX63Kamw6gPkle25mqBD%2FGU%3D" alt="图片" loading="lazy"/></p>
<p>后来才开始用mcp管聊天记录，</p>
<p>这种mcp一般可以自动记录对话历史，智能管理上下文，并跟踪任务。不妨探索一下。</p>
<h2 data-id="heading-9">10、solo不是非用不可</h2>
<p>整个过程我自己用的是IDE，</p>
<p>因为 solo 模式的话，对我来说还是有点太野马脱缰了。</p>
<p>所以我建议半路的小白，</p>
<p>如果想做 vibe coding 的话，</p>
<p>大家可以根据自己的习惯选择</p>
<p>无论是ide模式还是solo模式</p>
<p>最好是一边看一边学， 把每一次编程新学到的知识点</p>
<p>沉淀到相关的文档里，下次出发你就是最棒的啦～</p>
<p> </p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee137d933e394e7dab95badf526a44d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_5pifQUnlt6XkvZzlrqQ=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767370712&amp;x-signature=puMYQS4nCKztVZEzloB9gG4QVLk%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[赋予大模型“记忆”：深度解析 LangChain 中 LLM 的上下文记忆实现]]></title>    <link>https://juejin.cn/post/7587997893988335643</link>    <guid>https://juejin.cn/post/7587997893988335643</guid>    <pubDate>2025-12-27T02:57:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997893988335643" data-draft-id="7587630413012156426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="赋予大模型“记忆”：深度解析 LangChain 中 LLM 的上下文记忆实现"/> <meta itemprop="keywords" content="LangChain,JavaScript,LLM"/> <meta itemprop="datePublished" content="2025-12-27T02:57:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AAA阿giao"/> <meta itemprop="url" content="https://juejin.cn/user/473218785740627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            赋予大模型“记忆”：深度解析 LangChain 中 LLM 的上下文记忆实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/473218785740627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AAA阿giao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T02:57:54.000Z" title="Sat Dec 27 2025 02:57:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"> 引言</h2>
<blockquote>
<p><strong>“我叫 Agiao，喜欢喝白兰地。”</strong><br/>
—— 你说完这句话，转身离开。<br/>
再回来问：“我叫什么名字？”<br/>
如果 AI 回答“我不知道”，那它只是个无状态的 API；<br/>
如果它回答“Agiao”，那它就拥有了<strong>记忆</strong>。</p>
</blockquote>
<p>在人工智能的世界里，“记忆”不是与生俱来的天赋，而是一种精心设计的工程能力。大型语言模型（LLM）本身是<strong>无状态</strong>的——每一次调用都像一场全新的对话，模型对过去一无所知。然而，现实中的智能交互必须具备上下文连贯性。如何让 LLM “记住你”？这正是我们今天要深入剖析的核心问题。</p>
<p>本文将逐行、逐模块、逐 API 地解析 <code>1.js</code> 文件，揭示 LangChain 如何通过 <strong>对话历史管理机制</strong> 赋予 LLM 真正的记忆能力。我们将不仅解释“怎么做”，更要阐明“为什么这么做”，并对比无记忆版本（<code>index.js</code>）的局限，最终构建一个完整、生动、技术扎实的认知图景。</p>
<hr/>
<h2 data-id="heading-1">背景：为什么 LLM 默认没有记忆？</h2>
<p>首先，让我们回到基础。</p>
<blockquote>
<p><strong>LLM API 调用和 http 请求一样，都是无状态的</strong></p>
</blockquote>
<p>这意味着每次你向模型发送一条消息（例如 <code>"我叫Agiao"</code>），模型仅基于这条消息生成回复，不会自动保留任何上下文。如果你紧接着再发一条 <code>"我叫什么名字？"</code>，模型根本不知道前一条消息的存在。</p>
<p>我们来看 <code>index.js</code> 的实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> {<span class="hljs-title class_">ChatDeepSeek</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>

<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>, <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span>});

<span class="hljs-comment">// http api 请求</span>
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'我叫Agiao，喜欢喝白兰地'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">content</span>);

<span class="hljs-keyword">const</span> res2 = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'我叫什么名字'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res2.<span class="hljs-property">content</span>);
</code></pre>
<p>这段代码做了两件事：</p>
<ol>
<li>第一次调用 <code>model.invoke(...)</code>，告诉模型你的名字和喜好。</li>
<li>第二次独立调用 <code>model.invoke(...)</code>，询问自己的名字。</li>
</ol>
<p>由于两次调用之间<strong>没有任何信息传递</strong>，第二次请求对模型而言完全是孤立的。因此，模型极大概率会回答类似：“抱歉，我不知道您叫什么名字。”——这不是模型笨，而是架构使然。</p>
<blockquote>
<p>💡 <strong>关键洞察</strong>：要实现记忆，我们必须<strong>主动维护对话历史，并在每次请求时将其作为上下文传入模型</strong>。</p>
</blockquote>
<p>但如何高效、结构化、可扩展地做到这一点？这就是 LangChain 的用武之地。</p>
<hr/>
<h2 data-id="heading-2">架构预览：LangChain 的记忆抽象</h2>
<p>LangChain 提供了一套完整的“记忆”（Memory）模块，其核心思想是：</p>
<blockquote>
<p><strong>将对话历史视为一种可插拔的上下文源，在每次调用 LLM 前动态注入到 Prompt 中。</strong></p>
</blockquote>
<p>在 <code>1.js</code> 中，这一思想通过以下组件协同实现：</p>
<ul>
<li><code>InMemoryChatMessageHistory</code>：存储对话历史。</li>
<li><code>ChatPromptTemplate</code>：定义包含历史占位符的提示模板。</li>
<li><code>RunnableWithMessageHistory</code>：自动管理历史加载与保存的包装器。</li>
<li><code>ChatDeepSeek</code>：底层 LLM 模型。</li>
</ul>
<p>接下来，我们将逐行拆解 <code>1.js</code>，深入每一个 API 的设计哲学与实现细节。</p>
<hr/>
<h2 data-id="heading-3">逐行深度解析 <code>1.js</code></h2>
<h3 data-id="heading-4">第一部分：模块导入（Import Statements）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/deepseek'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatPromptTemplate</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/prompts'</span>;
<span class="hljs-comment">// 带上历史记录的可运行对象</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RunnableWithMessageHistory</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/runnables'</span>;
<span class="hljs-comment">// 存放在内存中</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InMemoryChatMessageHistory</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/core/chat_history'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>;
</code></pre>
<h4 data-id="heading-5">✅ <code>ChatDeepSeek</code></h4>
<ul>
<li>
<p>来源：<code>@langchain/deepseek</code></p>
</li>
<li>
<p>作用：封装 DeepSeek 提供的聊天模型 API，使其符合 LangChain 的 <code>BaseChatModel</code> 接口。</p>
</li>
<li>
<p>特性：</p>
<ul>
<li>支持 <code>invoke()</code>、<code>stream()</code> 等标准方法。</li>
<li>自动处理消息格式（如 <code>HumanMessage</code>, <code>AIMessage</code>）。</li>
<li>可配置 <code>model</code>、<code>temperature</code>、<code>maxTokens</code> 等参数。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">✅ <code>ChatPromptTemplate</code></h4>
<ul>
<li>
<p>来源：<code>@langchain/core/prompts</code></p>
</li>
<li>
<p>作用：构建结构化的聊天提示（prompt），支持系统消息、用户消息、AI 消息及占位符。</p>
</li>
<li>
<p>关键能力：</p>
<ul>
<li>使用 <code>fromMessages()</code> 静态方法从消息数组创建模板。</li>
<li>支持变量插值（如 <code>{input}</code>, <code>{history}</code>）。</li>
<li>输出为 <code>Runnable</code>，可与其他组件链式组合（<code>.pipe()</code>）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-7">✅ <code>RunnableWithMessageHistory</code></h4>
<ul>
<li>
<p>来源：<code>@langchain/core/runnables</code></p>
</li>
<li>
<p><strong>这是实现记忆的核心抽象！</strong></p>
</li>
<li>
<p>作用：包装一个普通的 <code>Runnable</code>（如 LLM 调用链），使其具备自动加载和保存对话历史的能力。</p>
</li>
<li>
<p>工作原理：</p>
<ul>
<li>在每次 <code>.invoke()</code> 时，先从 <code>getMessageHistory</code> 获取当前会话的历史。</li>
<li>将历史注入到输入中（通过 <code>historyMessagesKey</code> 指定的字段）。</li>
<li>调用内部 <code>runnable</code>。</li>
<li>将用户输入和模型输出<strong>自动追加</strong>到历史记录中。</li>
</ul>
</li>
</ul>
<blockquote>
<p>⚠️ 注意：<code>RunnableWithMessageHistory</code> 并不关心历史如何存储（内存、数据库、Redis），它只依赖 <code>getMessageHistory</code> 函数返回一个实现了 <code>BaseChatMessageHistory</code> 接口的对象。</p>
</blockquote>
<h4 data-id="heading-8">✅ <code>InMemoryChatMessageHistory</code></h4>
<ul>
<li>
<p>来源：<code>@langchain/core/chat_history</code></p>
</li>
<li>
<p>作用：最简单的对话历史存储实现，将所有消息保存在 JavaScript 内存数组中。</p>
</li>
<li>
<p>接口方法：</p>
<ul>
<li><code>getMessages()</code>：返回当前所有消息。</li>
<li><code>addMessage(message)</code>：添加一条新消息。</li>
<li><code>clear()</code>：清空历史。</li>
</ul>
</li>
<li>
<p>适用场景：单会话演示、测试。<strong>不适合生产环境多用户场景</strong>（因为所有会话共享同一实例，且进程重启后丢失）。</p>
</li>
</ul>
<h4 data-id="heading-9">✅ <code>dotenv/config</code></h4>
<ul>
<li>加载 <code>.env</code> 文件中的环境变量（如 <code>DEEPSEEK_API_KEY</code>），确保模型认证信息安全。</li>
</ul>
<hr/>
<h3 data-id="heading-10">第二部分：模型初始化</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">model</span> = new ChatDeepSeek({ model: <span class="hljs-string">'deepseek-chat'</span>, temperature: <span class="hljs-number">0</span>})<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><code>model: 'deepseek-chat'</code>：指定使用 DeepSeek 的聊天专用模型。</li>
<li><code>temperature: 0</code>：关闭随机性，确保相同输入总是产生相同输出——这对需要精确记忆的场景至关重要（避免因随机性导致“忘记”）。</li>
</ul>
<hr/>
<h3 data-id="heading-11">第三部分：构建带记忆的 Prompt 模板</h3>
<pre><code class="hljs language-css" lang="css">const prompt = ChatPromptTemplate<span class="hljs-selector-class">.fromMessages</span>(<span class="hljs-selector-attr">[  [<span class="hljs-string">'system'</span>, <span class="hljs-string">"你是一个有记忆的助手"</span>]</span>,
  <span class="hljs-selector-attr">[<span class="hljs-string">'placeholder'</span>, <span class="hljs-string">"{history}"</span>]</span>,
  <span class="hljs-selector-attr">[<span class="hljs-string">'human'</span>, <span class="hljs-string">"{input}"</span>]</span>
])
</code></pre>
<p>这是整个记忆机制的<strong>提示工程核心</strong>。</p>
<h4 data-id="heading-12">消息结构解析：</h4>
<ol>
<li>
<p><code>['system', "你是一个有记忆的助手"]</code></p>
<ul>
<li>系统消息，用于设定 AI 的角色和行为准则。</li>
<li>告诉模型：“你有能力记住之前的对话，请利用这些信息。”</li>
</ul>
</li>
<li>
<p><code>['placeholder', "{history}"]</code></p>
<ul>
<li>
<p><strong>关键！</strong> 这不是一个普通字符串，而是一个<strong>占位符指令</strong>。</p>
</li>
<li>
<p>LangChain 在渲染此模板时，会查找输入对象中的 <code>history</code> 字段。</p>
</li>
<li>
<p>如果 <code>history</code> 是一个消息数组（如 <code>[HumanMessage, AIMessage, ...]</code>），它会<strong>自动展开为多条独立消息</strong>，插入到此处。</p>
</li>
<li>
<p>例如，若历史为：</p>
<pre><code class="hljs language-arduino" lang="arduino">[
  <span class="hljs-keyword">new</span> <span class="hljs-built_in">HumanMessage</span>(<span class="hljs-string">"我叫Agiao"</span>),
  <span class="hljs-keyword">new</span> <span class="hljs-built_in">AIMessage</span>(<span class="hljs-string">"好的，Agiao！"</span>)
]
</code></pre>
<p>则最终 prompt 变为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  SystemMessage(<span class="hljs-string">"你是一个有记忆的助手"</span>),  HumanMessage(<span class="hljs-string">"我叫Agiao"</span>),  AIMessage(<span class="hljs-string">"好的，Agiao！"</span>),  HumanMessage(<span class="hljs-string">"{input}"</span>)]</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><code>['human', "{input}"]</code></p>
<ul>
<li>当前用户输入，通过变量 <code>input</code> 注入。</li>
</ul>
</li>
</ol>
<blockquote>
<p>💡 <strong>为什么用 <code>placeholder</code> 而不是直接写 <code>{history}</code> 字符串？</strong><br/>
因为 <code>{history}</code> 实际上是一个<strong>消息列表</strong>，而非纯文本。<code>placeholder</code> 告诉 LangChain：“这里要插入一个消息序列，而不是拼接字符串”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">第四部分：构建可运行链（Runnable Chain）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> runnable = prompt
  .<span class="hljs-title function_">pipe</span>(<span class="hljs-function">(<span class="hljs-params">input</span>) =&gt;</span> {
    <span class="hljs-comment">// debug 节点</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"&gt;&gt;&gt; 最终传给模型的信息(Prompt 内存)"</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(input)
    <span class="hljs-keyword">return</span> input;
  })
  .<span class="hljs-title function_">pipe</span>(model);
</code></pre>
<p>LangChain 的核心思想是“一切皆可运行（Runnable）”。这里我们构建了一个处理流水线：</p>
<ol>
<li><strong><code>prompt</code></strong>：首先应用提示模板，将 <code>{input}</code> 和 <code>{history}</code> 替换为实际内容，生成完整的消息列表。</li>
<li><strong>调试中间件</strong>：打印最终传给模型的消息结构。这对于理解记忆如何工作至关重要。</li>
<li><strong><code>model</code></strong>：将构造好的消息列表发送给 DeepSeek 模型。</li>
</ol>
<blockquote>
<p>📌 注意：此时的 <code>runnable</code> <strong>仍然不具备记忆能力</strong>！它只是一个“知道如何组织消息”的函数。真正的记忆由外层的 <code>RunnableWithMessageHistory</code> 注入。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">第五部分：创建对话历史存储</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">messageHistory</span> = new InMemoryChatMessageHistory()<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li>创建一个空的内存历史容器。</li>
<li>所有后续对话（用户输入 + AI 回复）都将被自动追加到这里。</li>
<li>由于是全局变量，<strong>所有使用该 <code>messageHistory</code> 的会话将共享同一历史</strong>（在多用户场景中需按 session ID 分离）。</li>
</ul>
<hr/>
<h3 data-id="heading-15">第六部分：注入记忆能力 —— <code>RunnableWithMessageHistory</code></h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> RunnableWithMessageHistory({
  runnable,
  getMessageHistory: <span class="hljs-keyword">async</span> () =&gt; messageHistory,
  inputMessagesKey: <span class="hljs-string">'input'</span>,
  historyMessagesKey: <span class="hljs-string">'history'</span>,
});
</code></pre>
<p>这是整段代码的<strong>灵魂所在</strong>。让我们逐个参数详解：</p>
<h4 data-id="heading-16">🔸 <code>runnable</code></h4>
<ul>
<li>要包装的原始可运行对象（即前面构建的 <code>prompt → debug → model</code> 链）。</li>
<li><code>RunnableWithMessageHistory</code> 会在调用它之前注入历史，在之后保存新消息。</li>
</ul>
<h4 data-id="heading-17">🔸 <code>getMessageHistory: async () =&gt; messageHistory</code></h4>
<ul>
<li>
<p>一个异步函数，返回当前会话对应的 <code>BaseChatMessageHistory</code> 实例。</p>
</li>
<li>
<p>在本例中，我们直接返回全局的 <code>messageHistory</code>。</p>
</li>
<li>
<p><strong>在真实应用中，这里通常会根据 <code>sessionId</code> 从数据库或缓存中加载对应的历史</strong>。例如：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">getMessageHistory:</span> <span class="hljs-keyword">async</span> (sessionId) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">new</span> RedisChatMessageHistory(sessionId, redisClient);
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-18">🔸 <code>inputMessagesKey: 'input'</code></h4>
<ul>
<li>指定用户当前输入在调用参数中的字段名。</li>
<li>对应后续的 <code>chain.invoke({ input: '...' })</code>。</li>
<li>LangChain 会从此字段读取用户消息，并在调用完成后将其存入历史。</li>
</ul>
<h4 data-id="heading-19">🔸 <code>historyMessagesKey: 'hitory'</code></h4>
<ul>
<li>指定历史消息在输入对象中的字段名。</li>
<li>LangChain 会从 <code>getMessageHistory()</code> 获取历史消息，并以 <code>{ history: [msg1, msg2, ...] }</code> 的形式注入到 <code>runnable</code> 的输入中。</li>
<li>这个字段名必须与 <code>ChatPromptTemplate</code> 中的占位符 <code>{history}</code> 一致！</li>
</ul>
<blockquote>
<p>✅ <strong>工作流程总结</strong>：</p>
<ol>
<li>用户调用 <code>chain.invoke({ input: "..." }, { configurable: { sessionId: "..." } })</code></li>
<li><code>RunnableWithMessageHistory</code> 调用 <code>getMessageHistory(sessionId)</code> 获取历史。</li>
<li>构造输入对象：<code>{ input: "...", history: [prev messages] }</code></li>
<li>调用内部 <code>runnable(input)</code></li>
<li>获取模型回复。</li>
<li>将 <code>HumanMessage(input)</code> 和 <code>AIMessage(response)</code> <strong>自动追加</strong>到历史中。</li>
</ol>
</blockquote>
<hr/>
<h3 data-id="heading-20">第七部分：执行多轮对话</h3>
<pre><code class="hljs language-css" lang="css">const res1 = await chain<span class="hljs-selector-class">.invoke</span>(
  { <span class="hljs-selector-tag">input</span>: <span class="hljs-string">'我叫Agiao，喜欢喝白兰地'</span> },
  { configurable: { sessionId: <span class="hljs-string">'makefriend'</span> } }
)
console<span class="hljs-selector-class">.log</span>(res1<span class="hljs-selector-class">.content</span>);

const res2 = await chain<span class="hljs-selector-class">.invoke</span>(
  { <span class="hljs-selector-tag">input</span>: <span class="hljs-string">'我叫什么名字'</span> },
  { configurable: { sessionId: <span class="hljs-string">'makefriend'</span> } }
)
console<span class="hljs-selector-class">.log</span>(res2<span class="hljs-selector-class">.content</span>);
</code></pre>
<h4 data-id="heading-21">🔹 第一次调用</h4>
<ul>
<li>
<p>输入：<code>{ input: '我叫Agiao，喜欢喝白兰地' }</code></p>
</li>
<li>
<p>此时 <code>messageHistory</code> 为空，所以 <code>{history}</code> 占位符被替换为空数组。</p>
</li>
<li>
<p>最终 prompt：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  SystemMessage(<span class="hljs-string">"你是一个有记忆的助手"</span>),  HumanMessage(<span class="hljs-string">"我叫Agiao，喜欢喝白兰地"</span>)]</span>
</code></pre>
</li>
<li>
<p>模型回复后，<code>messageHistory</code> 自动更新为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  HumanMessage(<span class="hljs-string">"我叫Agiao，喜欢喝白兰地"</span>),  AIMessage(<span class="hljs-string">"好的，Agiao！白兰地是种很棒的选择。"</span>)]</span>
</code></pre>
</li>
</ul>
<h4 data-id="heading-22">🔹 第二次调用</h4>
<ul>
<li>
<p>输入：<code>{ input: '我叫什么名字' }</code></p>
</li>
<li>
<p><code>messageHistory</code> 已包含两条消息。</p>
</li>
<li>
<p>最终 prompt：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  SystemMessage(<span class="hljs-string">"你是一个有记忆的助手"</span>),  HumanMessage(<span class="hljs-string">"我叫Agiao，喜欢喝白兰地"</span>),  AIMessage(<span class="hljs-string">"好的，Agiao！白兰地是种很棒的选择。"</span>),  HumanMessage(<span class="hljs-string">"我叫什么名字"</span>)]</span>
</code></pre>
</li>
<li>
<p>模型看到完整上下文，自然能回答：“你叫 Agiao。”</p>
</li>
</ul>
<blockquote>
<p>🎯 <strong>关键优势</strong>：开发者无需手动管理历史拼接、消息格式转换、存储逻辑——全部由 LangChain 自动处理。</p>
</blockquote>
<hr/>
<h2 data-id="heading-23">调试输出：见证记忆的传递</h2>
<p>中间的调试节点会打印：</p>
<p><strong>第一次调用后：</strong></p>
<pre><code class="hljs language-css" lang="css">&gt;&gt;&gt; 最终传给模型的信息(Prompt 内存)
{
  messages: [
    SystemMessage { <span class="hljs-attribute">content</span>: <span class="hljs-string">"你是一个有记忆的助手"</span> },
    HumanMessage { <span class="hljs-attribute">content</span>: <span class="hljs-string">"我叫Agiao，喜欢喝白兰地"</span> }
  ]
}
</code></pre>
<p><strong>第二次调用后：</strong></p>
<pre><code class="hljs language-css" lang="css">&gt;&gt;&gt; 最终传给模型的信息(Prompt 内存)
{
  messages: [
    SystemMessage { <span class="hljs-attribute">content</span>: <span class="hljs-string">"你是一个有记忆的助手"</span> },
    HumanMessage { <span class="hljs-attribute">content</span>: <span class="hljs-string">"我叫Agiao，喜欢喝白兰地"</span> },
    AIMessage { <span class="hljs-attribute">content</span>: <span class="hljs-string">"好的，Agiao！白兰地是种很棒的选择。"</span> },
    HumanMessage { <span class="hljs-attribute">content</span>: <span class="hljs-string">"我叫什么名字"</span> }
  ]
}
</code></pre>
<p>这清晰展示了<strong>历史如何被逐步累积并注入上下文</strong>。</p>
<hr/>
<h2 data-id="heading-24">对比：有记忆 vs 无记忆</h2>








































<table><thead><tr><th>特性</th><th><code>index.js</code>（无记忆）</th><th><code>1.js</code>（有记忆）</th></tr></thead><tbody><tr><td>状态管理</td><td>无</td><td>自动维护对话历史</td></tr><tr><td>上下文传递</td><td>手动拼接（未实现）</td><td>自动注入 <code>{history}</code></td></tr><tr><td>多轮连贯性</td><td>❌ 不支持</td><td>✅ 完美支持</td></tr><tr><td>Token 效率</td><td>每次独立，无冗余</td><td>历史随对话增长，需注意长度</td></tr><tr><td>扩展性</td><td>难以扩展</td><td>易替换存储后端（Redis/DB）</td></tr><tr><td>代码复杂度</td><td>简单但功能有限</td><td>稍复杂但功能强大</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-25">潜在挑战与优化方向</h2>
<p>虽然 <code>1.js</code> 展示了记忆的基本实现，但在生产环境中还需考虑：</p>
<h3 data-id="heading-26">1. <strong>Token 长度限制</strong></h3>
<ul>
<li>
<p>对话历史不断增长，可能超出模型上下文窗口（如 32768 tokens）。</p>
</li>
<li>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用 <code>WindowChatMessageHistory</code> 仅保留最近 N 条消息。</li>
<li>实现摘要机制：定期将历史压缩为摘要，并作为系统消息注入。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-27">2. <strong>多用户会话隔离</strong></h3>
<ul>
<li>
<p>当前 <code>messageHistory</code> 是全局单例，所有用户共享。</p>
</li>
<li>
<p><strong>解决方案</strong>：</p>
<ul>
<li>在 <code>getMessageHistory</code> 中根据 <code>sessionId</code> 返回不同历史实例。</li>
<li>使用 <code>RedisChatMessageHistory</code> 或数据库按 session 存储。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-28">3. <strong>持久化</strong></h3>
<ul>
<li>内存存储在服务重启后丢失。</li>
<li><strong>解决方案</strong>：集成持久化存储（如 PostgreSQL、MongoDB）。</li>
</ul>
<h3 data-id="heading-29">4. <strong>长期记忆（Long-term Memory）</strong></h3>
<ul>
<li>对话历史属于短期记忆。</li>
<li><strong>解决方案</strong>：结合向量数据库（如 Pinecone）实现基于检索的长期记忆（RAG + Memory）。</li>
</ul>
<hr/>
<h2 data-id="heading-30">结语：记忆，是智能的基石</h2>
<p>通过 <code>1.js</code>，我们不仅学会了如何用 LangChain 实现 LLM 的记忆，更理解了其背后的设计哲学：<strong>将状态管理与核心逻辑解耦，通过组合式 API 构建可扩展的智能应用</strong>。</p>
<blockquote>
<p>记忆不是魔法，而是一系列精心设计的数据流：<br/>
用户输入 → 加载历史 → 注入上下文 → 调用模型 → 保存新状态。</p>
</blockquote>
<p>当你下次对 AI 说“还记得我吗？”，希望它能微笑着回答：“当然，Agiao。你上次说喜欢白兰地，要不要再来一杯？”</p>
<p>🥂 <strong>Cheers to intelligent conversations with memory!</strong></p>
<hr/>
<blockquote>
<p><strong>附：完整代码链接：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FgiaoZou%2Flesson_zp%2Ftree%2Fmaster%2Fai%2Flangchain%2Fmemory%2Fdemo" title="https://gitee.com/giaoZou/lesson_zp/tree/master/ai/langchain/memory/demo" target="_blank" ref="nofollow noopener noreferrer">lesson_zp/ai/langchain/memory/demo: AI + 全栈学习仓库</a></p>
<p>在该项目根目录中需添加  .env  文件，文件中添加DeepSeek大模型的API_KEY</p>
<p>例如：</p>
<p>DEEPSEEK_API_KEY=sk-XXXXXXXXXXXXXXXXXXXXXXXXXXXXX</p>
<p>API_KEY获取地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2Fusage" title="https://platform.deepseek.com/usage" target="_blank" ref="nofollow noopener noreferrer">DeepSeek 开放平台</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TailwindCSS：从“样式民工”到“UI乐高大师”的逆袭]]></title>    <link>https://juejin.cn/post/7588061231589326889</link>    <guid>https://juejin.cn/post/7588061231589326889</guid>    <pubDate>2025-12-27T01:49:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588061231589326889" data-draft-id="7587995707166310419" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TailwindCSS：从“样式民工”到“UI乐高大师”的逆袭"/> <meta itemprop="keywords" content="前端,面试,编程语言"/> <meta itemprop="datePublished" content="2025-12-27T01:49:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiaoxue_"/> <meta itemprop="url" content="https://juejin.cn/user/4065372122398027"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TailwindCSS：从“样式民工”到“UI乐高大师”的逆袭
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4065372122398027/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiaoxue_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T01:49:28.000Z" title="Sat Dec 27 2025 01:49:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">玩转 TailwindCSS：从 "样式混乱" 到 "丝滑开发" 的逆袭之路 🚀</h2>
<p>哈喽，前端圈的小伙伴们～ 今天咱们来聊聊一个让样式开发效率飙升的神器 ——TailwindCSS。提前说一句，本文会结合 React 来讲，要是你还没学习过 React ，翻翻我前面的文章补补课哦，保证一看就会！</p>
<h3 data-id="heading-1">一、传统 CSS：那些年我们踩过的 "样式坑" 🕳️</h3>
<p>先来看段 "考古级"CSS 代码，眼熟不？👇</p>
<p>html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.primary-btn</span> {
    <span class="hljs-attribute">padding</span>:<span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">background-color</span>: blue;
    <span class="hljs-attribute">color</span>:white;
    <span class="hljs-attribute">border-radius</span>:<span class="hljs-number">6px</span>;
  }
  <span class="hljs-selector-class">.default-btn</span> {
    <span class="hljs-attribute">padding</span>:<span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ccc</span>;
    <span class="hljs-attribute">color</span>:<span class="hljs-number">#000</span>;
    <span class="hljs-attribute">border-radius</span>:<span class="hljs-number">6px</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"primary-btn"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"default-btn"</span>&gt;</span>默认<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p>盯着这段代码 3 秒钟，是不是发现了什么？padding 和 border-radius 这俩兄弟在两个类里重复出现了！就像你点奶茶时，每次都要重复说 "少冰、三分糖"，多费劲啊😤。传统 CSS 的问题就在于：一个类名承包了所有样式，业务属性和样式规则混在一起，想复用？难！改一处样式？可能要改 N 个类名，简直是前端开发的 "脱发元凶" 之一。</p>
<h3 data-id="heading-2">二、封装基类 + 组合变体：给 CSS 来个 "代码瘦身" 🐜</h3>
<p>那怎么拯救这些重复的代码呢？答案就是：给 CSS 做 "封装手术"！咱们可以把重复的样式抽成基类，再用变体类来实现不同效果，就像搭积木一样灵活～</p>
<p>还是拿按钮举例，看这段优化后的代码：</p>
<p>html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.btn</span> { <span class="hljs-comment">/* 基类：提取公共样式 */</span>
    <span class="hljs-attribute">padding</span>:<span class="hljs-number">8px</span> <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">border-radius</span>:<span class="hljs-number">6px</span>;
    <span class="hljs-attribute">cursor</span>:pointer;
  }
  <span class="hljs-selector-class">.btn-primary</span> { <span class="hljs-comment">/* 变体：个性化样式 */</span>
    <span class="hljs-attribute">background</span>: blue;
    <span class="hljs-attribute">color</span>:white;
  }
  <span class="hljs-selector-class">.btn-default</span> { <span class="hljs-comment">/* 变体：个性化样式 */</span>
    <span class="hljs-attribute">background</span>: <span class="hljs-number">#ccc</span>;
    <span class="hljs-attribute">color</span>:<span class="hljs-number">#000</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-primary"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"btn btn-default"</span>&gt;</span>默认<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p><strong>代码效果（与上文传统css 举例代码实现的效果一样）：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10fc5f3cf92a40e1af63963b9b46de41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767404986&amp;x-signature=XcF3GQzruS3TpzJJyBO9AMJ5D%2Bw%3D" alt="QQ20251226-235034.png" loading="lazy"/></p>
<p>瞧见没？.btn 就像个 "样式地基"，不管是 primary 还是 default 按钮，都能共用它的 padding 和圆角。这种 "基类 + 变体" 的思路，其实就是面向对象 CSS 的精髓～ 但这还不够极致！如果我想要 "margin-left: 2px"、"font-size: 14px" 这种更细粒度的样式复用，该怎么办？这时，TailwindCSS 就该登场了！</p>
<h3 data-id="heading-3">三、原子 CSS TailwindCSS：样式界的 "乐高积木" 🧩</h3>
<h4 data-id="heading-4">1.什么是 TailwindCSS？</h4>
<p>简单说，TailwindCSS 是一个 "原子 CSS 框架"。啥叫原子 CSS？就是把 CSS 规则拆成无数个最小单位的 "原子类"，比如 "padding: 4px" 对应 p-1，"background: blue" 对应 bg-blue-600。这些原子类就像乐高积木，随便拼就能搭出各种样式～</p>
<h4 data-id="heading-5">2.解决了啥问题？优点多到数不清！</h4>
<ul>
<li>不用再想类名了！再也不会为 "这个 div 叫 container 还是 wrapper" 抓头发🤯</li>
<li>不用切换文件写 CSS！直接在 HTML/JSX 里写样式，效率拉满</li>
<li>样式复用率 MAX！一套原子类走天下，再也不用复制粘贴重复样式</li>
<li>响应式设计超简单！自带各种屏幕尺寸的前缀，适配移动端 so easy</li>
</ul>
<h4 data-id="heading-6">3.和 LLM 是 "最佳拍档"？</h4>
<p>TailwindCSS 通过预定义的原子化类名让开发者无需手写原生 CSS，但拼接大量类名仍有成本；AI 则能从 “自然语言描述→代码生成→优化调试” 全流程提升 Tailwind 开发效率，二者结合的核心应用如下：</p>
<h5 data-id="heading-7">（1）通用 AI 助手（ChatGPT/Gemini/ 文心一言）</h5>
<p>这是最易获取的工具，只需用自然语言描述界面需求，就能直接生成可运行的 Tailwind 代码。<strong>示例提示词</strong>：</p>
<blockquote>
<p>帮我用 TailwindCSS v3 写一个移动端适配的商品卡片，宽度 100%（最大 300px），圆角 12px，包含商品图片（16:9 比例）、标题（最多 2 行）、价格（红色加粗）和加入购物车按钮，轻微阴影。</p>
</blockquote>
<p><strong>AI 生成的可直接运行的代码</strong>：</p>
<p>html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>商品卡片<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 引入TailwindCSS CDN --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.tailwindcss.com"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-gray-50 p-4"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 商品卡片 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full max-w-[300px] bg-white rounded-3xl shadow-sm overflow-hidden"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 商品图片 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"aspect-[16/9] bg-gray-200 overflow-hidden"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://picsum.photos/300/169"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"商品图片"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full h-full object-cover hover:scale-105 transition-transform duration-300"</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 商品信息 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"p-4"</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 商品标题（最多2行） --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-gray-800 font-medium mb-2 line-clamp-2"</span>&gt;</span>新款夏季纯棉T恤 宽松透气百搭休闲上衣<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 商品价格 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-red-600 font-bold text-xl mb-3"</span>&gt;</span>¥99.9<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 加入购物车按钮 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors"</span>&gt;</span>
                加入购物车
            <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>实现的效果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0df5f2d220a04cc1b41ee17b5dc2a824~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767404986&amp;x-signature=59mJJWJz7%2BZn9wZnHv8Xi2W%2FTJs%3D" alt="QQ20251227-092130.png" loading="lazy"/></p>
<h5 data-id="heading-8">（2）专门的 Tailwind AI 工具</h5>
<ul>
<li><strong>Tailwind AI（官方）</strong> ：集成在 Tailwind Play（在线编辑器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.tailwindcss.com%2F" target="_blank" title="https://play.tailwindcss.com/" ref="nofollow noopener noreferrer">play.tailwindcss.com/</a>）中，可实时生成、优化样式，还能解释类名含义；</li>
<li><strong>Cursor 编辑器</strong>：内置 AI 助手，支持将原生 CSS 一键转换为 Tailwind，或修复 Tailwind 样式冲突；</li>
<li><strong>Figma to Tailwind AI</strong>：Figma 插件，可将设计稿直接转换为 Tailwind 代码，AI 自动匹配最贴合的类名。</li>
</ul>
<h4 data-id="heading-9">4.TailwindCSS 配置：三步搞定！</h4>
<p>在 React+Vite 项目里用 Tailwind？跟着做就行：</p>
<ol>
<li>安装依赖（终端执行）：</li>
</ol>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash">npm install tailwindcss @tailwindcss/vite
</code></pre>
<p>2.  配置 vite.config.js（引入插件）：</p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 来自vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span> 
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>
<span class="hljs-keyword">import</span> tailwindcss <span class="hljs-keyword">from</span> <span class="hljs-string">'@tailwindcss/vite'</span> <span class="hljs-comment">// 引入Tailwind插件</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>(), <span class="hljs-title function_">tailwindcss</span>()], <span class="hljs-comment">// 注册插件</span>
})
</code></pre>
<p>3.  配置 index.css（导入样式）：</p>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* 来自index.css */</span>
<span class="hljs-keyword">@import</span> <span class="hljs-string">"tailwindcss"</span>; <span class="hljs-comment">/* 一句话引入所有Tailwind原子类 */</span>
</code></pre>
<p>搞定！🚀</p>
<h3 data-id="heading-10">四、TailwindCSS与 React 组件结合：天作之合！💞</h3>
<h4 data-id="heading-11">直接在 className 里 "堆积木"</h4>
<p>React 组件里用 Tailwind，简直是行云流水～ 直接在 className 里写原子类就行，看例子：</p>
<p>jsx</p>
<pre><code class="hljs language-ini" lang="ini">&lt;button <span class="hljs-attr">className</span>=<span class="hljs-string">"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"</span>&gt;
  提交
&lt;/button&gt;
</code></pre>
<p>解释下这些 "积木"：</p>
<ul>
<li>px-4：水平内边距 4 单位（1 单位 = 4px）</li>
<li>py-2：垂直内边距 2 单位</li>
<li>bg-blue-600：背景色为蓝色（600 是深浅度）</li>
<li>text-white：文字白色</li>
<li>rounded-md：中等圆角</li>
<li>hover:bg-blue-700：鼠标悬停时背景色深一点（伪类直接写，太方便了！）</li>
</ul>
<h3 data-id="heading-12">五、TailwindCSS 实战：从代码到界面的魔法 ✨</h3>
<h4 data-id="heading-13">1. 原子类组合实现卡片 UI</h4>
<p>来看个 ArticleCard 组件，用 Tailwind 搭个卡片超简单：</p>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// App2.jsx的卡片组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">ArticleCard</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"p-4 bg-white rounded-xl shadow hover:shadow-lg transition"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg font-bold"</span>&gt;</span>Tailwindcss<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-gray-500 mt-2"</span>&gt;</span>
        用utility class 快速构建UI
      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>逐个拆解 "魔法咒语"：</p>
<ul>
<li>p-4：内边距 4 单位，让内容不贴边</li>
<li>bg-white：白色背景，像张卡片纸</li>
<li>rounded-xl：超大圆角，颜值 up</li>
<li>shadow：加个阴影，有立体感</li>
<li>hover:shadow-lg： hover 时阴影变大，交互感拉满</li>
<li>transition：过渡动画，让 hover 效果更丝滑</li>
<li>text-lg：文字大小为 large</li>
<li>font-bold：字体加粗</li>
<li>text-gray-500：文字灰色（500 是中性灰）</li>
<li>mt-2：上边距 2 单位，和标题隔开点</li>
</ul>
<p>效果就是一个简约又好看的卡片，hover 时还有微妙的阴影变化，是不是比写一堆 CSS 快多了？<strong>来看看效果吧：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53e3df6217574ddabab8a410d6d636ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767404986&amp;x-signature=PheHjY02ke6fgOv8b4jSQUkRTb0%3D" alt="QQ20251227-92849.gif" loading="lazy"/></p>
<h4 data-id="heading-14">2. 响应式布局 + 伪类：适配各种设备 📱💻</h4>
<p>Tailwind 的响应式设计堪称一绝，自带断点前缀（sm:、md:、lg: 等），轻松实现 "移动端 - 桌面端" 适配。</p>
<p>jsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// App.jsx的响应式布局</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col md:flex-row gap-4"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-blue-100 p-4 md:w-2/3"</span>&gt;</span>主内容<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-green-100 p-4 md:w-1/3"</span>&gt;</span>侧边栏<span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>详解响应式魔法：</p>
<ul>
<li>flex：开启弹性布局</li>
<li>flex-col：默认垂直排列（移动端友好）</li>
<li>md:flex-row：当屏幕宽度≥768px（md 断点）时，改为水平排列（桌面端友好）</li>
<li>gap-4：子元素之间的间距为 4 单位</li>
<li>md:w-2/3：桌面端时主内容占 2/3 宽度</li>
<li>md:w-1/3：桌面端时侧边栏占 1/3 宽度</li>
</ul>
<p>在手机上看是上下排列，在电脑上看是左右排列，完全不用写媒体查询，Tailwind 帮你搞定一切！</p>
<p><strong>PC端：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c220a8ff96074890a3d89cf09f69d15b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767404986&amp;x-signature=2dNaImU7waECDF3%2F5etTMHOqe04%3D" alt="QQ20251227-093221.png" loading="lazy"/>
<strong>移动端：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/145b2b9ba5ef495dbe09135842df2d1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGlhb3h1ZV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767404986&amp;x-signature=ExgGeiY731daIhLbDwU2yEildE4%3D" alt="QQ20251227-093236.png" loading="lazy"/></p>
<h3 data-id="heading-15">六、面试官会问：这些考点要记牢！📝</h3>
<ol>
<li>什么是原子 CSS？TailwindCSS 的核心思想是什么？（答：将样式拆分为最小单位的原子类，通过组合实现复杂样式）</li>
<li>Tailwind 相比传统 CSS 有什么优势？（答：减少重复代码、不用想类名、响应式方便、开发效率高）</li>
<li>如何在 Tailwind 中实现响应式布局适配？（答：使用断点前缀，如 md:、lg:，配合原子类）</li>
</ol>
<h3 data-id="heading-16">七、结语：从此爱上写样式！💖</h3>
<p>以前写样式，总在 "想类名 - 写 CSS - 调样式" 的循环里挣扎；用了 TailwindCSS后，就像开了 "样式加速器"—— 不用切换文件，不用记复杂规则，对着设计稿拼原子类就行，甚至 AI 都能帮你写大半！👋</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python机器学习三大经典算法：KNN、SVM、朴素贝叶斯]]></title>    <link>https://juejin.cn/post/7587965800273657882</link>    <guid>https://juejin.cn/post/7587965800273657882</guid>    <pubDate>2025-12-27T02:24:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587965800273657882" data-draft-id="7587965800273641498" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python机器学习三大经典算法：KNN、SVM、朴素贝叶斯"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-27T02:24:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI能力探索"/> <meta itemprop="url" content="https://juejin.cn/user/1549641121016795"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python机器学习三大经典算法：KNN、SVM、朴素贝叶斯
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549641121016795/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI能力探索
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T02:24:33.000Z" title="Sat Dec 27 2025 02:24:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>机器学习入门的核心是掌握经典算法的原理与实战，K近邻（KNN）、支持向量机（SVM）、朴素贝叶斯作为分类任务的三大基础算法，覆盖了“基于距离”“基于超平面”“基于概率”三种核心思路，是入门机器学习的必学内容。</p>
<h2 data-id="heading-0">一、核心前置知识与环境准备</h2>
<h3 data-id="heading-1">1. 算法核心定位（快速选对算法）</h3>

































<table><thead><tr><th>算法</th><th>核心思想</th><th>优势</th><th>劣势</th><th>适用场景</th></tr></thead><tbody><tr><td>KNN（K近邻）</td><td>近朱者赤：按最近邻样本分类</td><td>原理简单、无需训练、适合多分类</td><td>高维数据慢、对异常值敏感</td><td>小样本分类、推荐系统、数据补全</td></tr><tr><td>SVM（支持向量机）</td><td>找最优超平面分隔样本</td><td>高维数据表现好、泛化能力强</td><td>大样本训练慢、参数调优复杂</td><td>文本分类、图像识别、特征维度高的场景</td></tr><tr><td>朴素贝叶斯</td><td>基于概率公式（贝叶斯）分类</td><td>训练速度极快、适合文本数据</td><td>假设特征独立（实际难满足）</td><td>垃圾邮件过滤、文本分类、情感分析</td></tr></tbody></table>
<h3 data-id="heading-2">2. 环境安装（Scikit-learn核心库）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装核心库（Python 3.8~3.10版本最佳）</span>
pip install scikit-learn numpy pandas matplotlib
</code></pre>
<ul>
<li>Scikit-learn：封装三大算法的核心API，调用统一；</li>
<li>NumPy：处理数值计算，支撑算法底层；</li>
<li>Matplotlib：可视化数据分布和分类效果。</li>
</ul>
<h3 data-id="heading-3">3. 验证安装</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sklearn
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Scikit-learn版本："</span>, sklearn.__version__)  <span class="hljs-comment"># 输出≥1.0.0即可</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"环境准备完成！"</span>)
</code></pre>
<h2 data-id="heading-4">二、K近邻（KNN）算法：最简单的“邻居投票”分类</h2>
<h3 data-id="heading-5">1. 算法原理（通俗理解）</h3>
<p>KNN的核心逻辑：“物以类聚，人以群分”——给一个新样本，找它最近的K个样本（邻居），这K个邻居中占比最多的类别，就是新样本的类别。</p>
<ul>
<li>K值是核心参数：K太小易过拟合（受异常值影响），K太大易欠拟合（分类模糊）。</li>
</ul>
<h3 data-id="heading-6">2. 实战：鸢尾花品种分类（KNN实现）</h3>
<p>以经典的鸢尾花数据集为例，实现KNN分类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 步骤1：加载数据集并划分训练集/测试集</span>
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split

<span class="hljs-comment"># 加载数据（特征：花萼/花瓣的长宽，标签：3类鸢尾花）</span>
iris = load_iris()
X = iris.data  <span class="hljs-comment"># 特征矩阵</span>
y = iris.target  <span class="hljs-comment"># 标签向量</span>

<span class="hljs-comment"># 划分数据集：训练集70%，测试集30%</span>
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=<span class="hljs-number">0.3</span>, random_state=<span class="hljs-number">42</span>  <span class="hljs-comment"># random_state保证结果可复现</span>
)

<span class="hljs-comment"># 步骤2：数据标准化（KNN基于距离，必须标准化）</span>
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

<span class="hljs-comment"># 步骤3：初始化并训练KNN模型</span>
<span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier

<span class="hljs-comment"># 初始化模型：K=5（常用默认值）</span>
knn_model = KNeighborsClassifier(n_neighbors=<span class="hljs-number">5</span>)
<span class="hljs-comment"># KNN无需“训练”，仅存储训练集数据（预测时计算距离）</span>
knn_model.fit(X_train_scaled, y_train)

<span class="hljs-comment"># 步骤4：模型预测与评估</span>
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score, classification_report

<span class="hljs-comment"># 预测测试集</span>
y_pred = knn_model.predict(X_test_scaled)
<span class="hljs-comment"># 计算准确率</span>
accuracy = accuracy_score(y_test, y_pred)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"KNN模型准确率："</span>, accuracy)  <span class="hljs-comment"># 鸢尾花数据集上≈0.98</span>
<span class="hljs-comment"># 详细分类报告（精确率、召回率、F1值）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n分类报告："</span>)
<span class="hljs-built_in">print</span>(classification_report(y_test, y_pred))

<span class="hljs-comment"># 步骤5：K值调优（找到最优K）</span>
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
plt.rcParams[<span class="hljs-string">"font.sans-serif"</span>] = [<span class="hljs-string">"SimHei"</span>]  <span class="hljs-comment"># 中文显示</span>

<span class="hljs-comment"># 测试K=1到20的准确率</span>
k_range = <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>)
accuracy_list = []
<span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> k_range:
    knn = KNeighborsClassifier(n_neighbors=k)
    knn.fit(X_train_scaled, y_train)
    accuracy_list.append(accuracy_score(y_test, knn.predict(X_test_scaled)))

<span class="hljs-comment"># 可视化K值与准确率关系</span>
plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">6</span>))
plt.plot(k_range, accuracy_list, marker=<span class="hljs-string">'o'</span>, color=<span class="hljs-string">'blue'</span>)
plt.xlabel(<span class="hljs-string">'K值（邻居数量）'</span>)
plt.ylabel(<span class="hljs-string">'准确率'</span>)
plt.title(<span class="hljs-string">'KNN算法K值调优'</span>)
plt.grid(linestyle=<span class="hljs-string">'--'</span>, alpha=<span class="hljs-number">0.7</span>)
plt.savefig(<span class="hljs-string">'knn_k_tuning.png'</span>)
plt.close()
</code></pre>
<h3 data-id="heading-7">3. KNN关键技巧</h3>
<ul>
<li><strong>标准化必做</strong>：特征单位不同（如花萼长度cm，花瓣宽度mm）会导致距离计算偏差，必须用<code>StandardScaler</code>标准化；</li>
<li><strong>K值选择</strong>：通过遍历测试（如K=1~20）找到准确率最高的K，或用“肘部法则”（准确率提升放缓的点）；</li>
<li><strong>距离度量</strong>：默认用欧氏距离，高维数据可尝试曼哈顿距离（<code>metric='manhattan'</code>）。</li>
</ul>
<h2 data-id="heading-8">三、支持向量机（SVM）：找“最优分隔线”的分类器</h2>
<h3 data-id="heading-9">1. 算法原理（通俗理解）</h3>
<p>SVM的核心是在特征空间中找一条“最优超平面”，将不同类别的样本分隔开，且超平面到两边样本的“间隔”最大——间隔越大，模型泛化能力越强。</p>
<ul>
<li>线性可分：直接找线性超平面；</li>
<li>线性不可分：通过“核函数”将数据映射到高维空间，实现线性分隔（常用核函数：高斯核<code>rbf</code>、线性核<code>linear</code>）。</li>
</ul>
<h3 data-id="heading-10">2. 实战：手写数字分类（SVM实现）</h3>
<p>以手写数字数据集为例，实现SVM分类（适合高维特征场景）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 步骤1：加载手写数字数据集</span>
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_digits
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split

<span class="hljs-comment"># 加载数据（8x8像素的手写数字，共10类）</span>
digits = load_digits()
X = digits.data  <span class="hljs-comment"># 特征：64维（8*8）</span>
y = digits.target  <span class="hljs-comment"># 标签：0-9</span>

<span class="hljs-comment"># 划分数据集</span>
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=<span class="hljs-number">0.3</span>, random_state=<span class="hljs-number">42</span>
)

<span class="hljs-comment"># 步骤2：数据标准化</span>
<span class="hljs-keyword">from</span> sklearn.preprocessing <span class="hljs-keyword">import</span> StandardScaler
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

<span class="hljs-comment"># 步骤3：初始化并训练SVM模型</span>
<span class="hljs-keyword">from</span> sklearn.svm <span class="hljs-keyword">import</span> SVC

<span class="hljs-comment"># 初始化模型：核函数rbf（处理非线性数据），C=1.0（正则化系数）</span>
svm_model = SVC(kernel=<span class="hljs-string">'rbf'</span>, C=<span class="hljs-number">1.0</span>, gamma=<span class="hljs-string">'scale'</span>, random_state=<span class="hljs-number">42</span>)
<span class="hljs-comment"># 训练模型（SVM训练耗时比KNN长，尤其大样本）</span>
svm_model.fit(X_train_scaled, y_train)

<span class="hljs-comment"># 步骤4：模型评估</span>
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score, confusion_matrix

y_pred = svm_model.predict(X_test_scaled)
accuracy = accuracy_score(y_test, y_pred)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"SVM模型准确率："</span>, accuracy)  <span class="hljs-comment"># 手写数字数据集上≈0.98</span>

<span class="hljs-comment"># 混淆矩阵（查看数字分类错误情况）</span>
cm = confusion_matrix(y_test, y_pred)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n混淆矩阵："</span>)
<span class="hljs-built_in">print</span>(cm)

<span class="hljs-comment"># 步骤5：SVM参数调优（网格搜索找最优C和gamma）</span>
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> GridSearchCV

<span class="hljs-comment"># 定义参数网格</span>
param_grid = {
    <span class="hljs-string">'C'</span>: [<span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>],  <span class="hljs-comment"># 正则化系数：越大容错率越低</span>
    <span class="hljs-string">'gamma'</span>: [<span class="hljs-string">'scale'</span>, <span class="hljs-string">'auto'</span>, <span class="hljs-number">0.001</span>, <span class="hljs-number">0.01</span>],  <span class="hljs-comment"># 核函数系数</span>
    <span class="hljs-string">'kernel'</span>: [<span class="hljs-string">'rbf'</span>, <span class="hljs-string">'linear'</span>]
}

<span class="hljs-comment"># 网格搜索（5折交叉验证）</span>
grid_search = GridSearchCV(SVC(random_state=<span class="hljs-number">42</span>), param_grid, cv=<span class="hljs-number">5</span>, scoring=<span class="hljs-string">'accuracy'</span>)
grid_search.fit(X_train_scaled, y_train)

<span class="hljs-comment"># 输出最优参数</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\nSVM最优参数："</span>, grid_search.best_params_)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"交叉验证最优准确率："</span>, grid_search.best_score_)

<span class="hljs-comment"># 用最优模型预测</span>
best_svm = grid_search.best_estimator_
<span class="hljs-built_in">print</span>(<span class="hljs-string">"最优模型测试集准确率："</span>, accuracy_score(y_test, best_svm.predict(X_test_scaled)))
</code></pre>
<h3 data-id="heading-11">3. SVM关键技巧</h3>
<ul>
<li><strong>核函数选择</strong>：线性数据用<code>linear</code>（速度快），非线性数据用<code>rbf</code>（效果好）；</li>
<li><strong>参数调优</strong>：C（正则化）越大，模型越“硬”（易过拟合）；gamma越大，核函数影响范围越小（易过拟合）；</li>
<li><strong>样本量限制</strong>：SVM适合中小样本（万级以内），大样本建议用<code>SGDClassifier</code>（随机梯度下降版SVM）。</li>
</ul>
<h2 data-id="heading-12">四、朴素贝叶斯：基于概率的“文本分类神器”</h2>
<h3 data-id="heading-13">1. 算法原理（通俗理解）</h3>
<p>朴素贝叶斯基于“贝叶斯公式”，核心假设是“特征之间相互独立”（朴素性），通过计算样本属于每个类别的概率，选择概率最大的类别作为预测结果。</p>
<ul>
<li>文本分类中，特征是“单词出现次数”，通过词频计算概率，速度极快。</li>
</ul>
<h3 data-id="heading-14">2. 实战：垃圾邮件分类（朴素贝叶斯实现）</h3>
<p>以经典的20NewsGroups文本数据集为例，实现朴素贝叶斯文本分类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 步骤1：加载文本数据集并预处理</span>
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> fetch_20newsgroups
<span class="hljs-keyword">from</span> sklearn.feature_extraction.text <span class="hljs-keyword">import</span> TfidfVectorizer

<span class="hljs-comment"># 加载数据集（仅选4个类别，简化任务）</span>
categories = [<span class="hljs-string">'alt.atheism'</span>, <span class="hljs-string">'soc.religion.christian'</span>, <span class="hljs-string">'comp.graphics'</span>, <span class="hljs-string">'sci.med'</span>]
<span class="hljs-comment"># 加载训练集和测试集</span>
train_data = fetch_20newsgroups(subset=<span class="hljs-string">'train'</span>, categories=categories, shuffle=<span class="hljs-literal">True</span>, random_state=<span class="hljs-number">42</span>)
test_data = fetch_20newsgroups(subset=<span class="hljs-string">'test'</span>, categories=categories, shuffle=<span class="hljs-literal">True</span>, random_state=<span class="hljs-number">42</span>)

<span class="hljs-comment"># 文本特征提取：TF-IDF（将文本转为数值特征）</span>
tfidf = TfidfVectorizer(stop_words=<span class="hljs-string">'english'</span>)  <span class="hljs-comment"># 去除英文停用词（the/a/an等）</span>
X_train = tfidf.fit_transform(train_data.data)
X_test = tfidf.transform(test_data.data)
y_train = train_data.target
y_test = test_data.target

<span class="hljs-comment"># 步骤2：初始化并训练朴素贝叶斯模型</span>
<span class="hljs-keyword">from</span> sklearn.naive_bayes <span class="hljs-keyword">import</span> MultinomialNB

<span class="hljs-comment"># 多项式朴素贝叶斯（适合文本分类，处理离散特征）</span>
nb_model = MultinomialNB(alpha=<span class="hljs-number">1.0</span>)  <span class="hljs-comment"># alpha：平滑系数，避免概率为0</span>
nb_model.fit(X_train, y_train)

<span class="hljs-comment"># 步骤3：模型评估</span>
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score, classification_report

y_pred = nb_model.predict(X_test)
accuracy = accuracy_score(y_test, y_pred)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"朴素贝叶斯模型准确率："</span>, accuracy)  <span class="hljs-comment"># 文本数据集上≈0.84</span>

<span class="hljs-comment"># 详细分类报告</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n分类报告："</span>)
<span class="hljs-built_in">print</span>(classification_report(y_test, y_pred, target_names=train_data.target_names))

<span class="hljs-comment"># 步骤4：实战预测新文本</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">predict_text</span>(<span class="hljs-params">text</span>):
    <span class="hljs-comment"># 文本转为TF-IDF特征</span>
    text_tfidf = tfidf.transform([text])
    <span class="hljs-comment"># 预测类别</span>
    pred = nb_model.predict(text_tfidf)[<span class="hljs-number">0</span>]
    <span class="hljs-comment"># 返回类别名称</span>
    <span class="hljs-keyword">return</span> train_data.target_names[pred]

<span class="hljs-comment"># 测试预测</span>
test_text1 = <span class="hljs-string">"GPU performance for 3D rendering"</span>  <span class="hljs-comment"># 计算机图形学</span>
test_text2 = <span class="hljs-string">"Medical treatment for diabetes"</span>  <span class="hljs-comment"># 医学</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n文本1分类结果："</span>, predict_text(test_text1))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"文本2分类结果："</span>, predict_text(test_text2))
</code></pre>
<h3 data-id="heading-15">3. 朴素贝叶斯关键技巧</h3>
<ul>
<li><strong>特征提取</strong>：文本分类必须用TF-IDF/词袋模型将文本转为数值特征；</li>
<li><strong>平滑系数alpha</strong>：alpha越大，平滑越强（避免因某个单词未出现导致概率为0）；</li>
<li><strong>适用场景</strong>：优先用于文本/序列数据，不适合特征高度相关的场景（违背“朴素”假设）。</li>
</ul>
<h2 data-id="heading-16">五、三大算法对比与选型指南</h2>















































<table><thead><tr><th>维度</th><th>KNN</th><th>SVM</th><th>朴素贝叶斯</th></tr></thead><tbody><tr><td>训练速度</td><td>无训练（极快）</td><td>中-慢（尤其大样本）</td><td>极快（概率计算）</td></tr><tr><td>预测速度</td><td>慢（计算距离）</td><td>快</td><td>极快</td></tr><tr><td>高维数据</td><td>效果差（维度灾难）</td><td>效果好</td><td>效果好（文本高维）</td></tr><tr><td>超参数调优</td><td>仅K值</td><td>C、gamma、核函数</td><td>仅alpha</td></tr><tr><td>过拟合风险</td><td>K小易过拟合</td><td>C大易过拟合</td><td>低（模型简单）</td></tr><tr><td>核心适用场景</td><td>小样本分类</td><td>高维/非线性分类</td><td>文本/概率类分类</td></tr></tbody></table>
<h3 data-id="heading-17">选型原则：</h3>
<ol>
<li>小样本、特征维度低 → 选KNN；</li>
<li>高维数据（文本/图像）、非线性 → 选SVM；</li>
<li>文本分类、追求速度、样本量大 → 选朴素贝叶斯。</li>
</ol>
<h2 data-id="heading-18">六、常见问题与解决方法</h2>
<ol>
<li><strong>KNN准确率低</strong>：
<ul>
<li>原因：未标准化、K值不合适、特征维度太高；</li>
<li>解决：标准化数据、调优K值、降维（PCA）。</li>
</ul>
</li>
<li><strong>SVM训练慢</strong>：
<ul>
<li>原因：样本量大、用rbf核函数；</li>
<li>解决：用线性核、降维、采样减少样本量。</li>
</ul>
</li>
<li><strong>朴素贝叶斯文本分类效果差</strong>：
<ul>
<li>原因：未去除停用词、TF-IDF参数不合适；</li>
<li>解决：去除停用词、调整TF-IDF的<code>max_features</code>（限制特征数）。</li>
</ul>
</li>
<li><strong>模型过拟合</strong>：
<ul>
<li>KNN：增大K值；</li>
<li>SVM：减小C值、增大gamma；</li>
<li>朴素贝叶斯：增大alpha值。</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每日一个C++知识点|菱形继承]]></title>    <link>https://juejin.cn/post/7588004376866947107</link>    <guid>https://juejin.cn/post/7588004376866947107</guid>    <pubDate>2025-12-26T16:50:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588004376866947107" data-draft-id="7587997157237555252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每日一个C++知识点|菱形继承"/> <meta itemprop="keywords" content="编程语言,C++,程序员"/> <meta itemprop="datePublished" content="2025-12-26T16:50:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="图形学爱好者_Wu"/> <meta itemprop="url" content="https://juejin.cn/user/1060359067408631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每日一个C++知识点|菱形继承
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1060359067408631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    图形学爱好者_Wu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T16:50:49.000Z" title="Fri Dec 26 2025 16:50:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>继承是C++面向对象的核心特性之一，说明类与类之间的特性是可以继承的，这大大提高了代码的复用性，优化了程序结构。但是滥用继承也会导致菱形继承的多继承问题。</p>
<h2 data-id="heading-0">菱形继承</h2>
<p>什么是菱形继承呢？指一个派生类同时继承两个直接基类，这两个直接基类又继承自同一个间接基类，最终形成 “菱形” 的继承结构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8495bcc3b8a2453fa1c24d6181d88ce3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu-5b2i5a2m54ix5aW96ICFX1d1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767372649&amp;x-signature=2RZRhhbGEHlnwVHmoAjADU3qLLs%3D" alt="" loading="lazy"/></p>
<p>下面用代码展示菱形继承的结构示例：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 顶层基类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-type">int</span> a;
    <span class="hljs-built_in">A</span>(<span class="hljs-type">int</span> val) : <span class="hljs-built_in">a</span>(val) {}
};

<span class="hljs-comment">// 中间基类 B，继承 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> : <span class="hljs-keyword">public</span> A {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">B</span>(<span class="hljs-type">int</span> val) : <span class="hljs-built_in">A</span>(val) {}
};

<span class="hljs-comment">// 中间基类 C，继承 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> : <span class="hljs-keyword">public</span> A {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">C</span>(<span class="hljs-type">int</span> val) : <span class="hljs-built_in">A</span>(val) {}
};

<span class="hljs-comment">// 最终派生类 D，同时继承 B 和 C</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">D</span> : <span class="hljs-keyword">public</span> B, <span class="hljs-keyword">public</span> C {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 问题1：初始化 A 时，B 和 C 都会分别初始化 A，导致 A 被初始化两次</span>
    <span class="hljs-built_in">D</span>(<span class="hljs-type">int</span> val1, <span class="hljs-type">int</span> val2) : <span class="hljs-built_in">B</span>(val1), <span class="hljs-built_in">C</span>(val2) {}
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">D <span class="hljs-title">d</span><span class="hljs-params">(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)</span></span>;
    <span class="hljs-comment">// 问题2：访问 a 时，编译器无法确定是 B::A::a 还是 C::A::a，直接报错</span>
    <span class="hljs-comment">// cout &lt;&lt; d.a &lt;&lt; endl; </span>
    <span class="hljs-comment">// 必须显式指定，但这违背了“单一继承”的逻辑，且数据冗余（d 中有两个 a）</span>
    cout &lt;&lt; d.B::a &lt;&lt; endl; <span class="hljs-comment">// 输出 1</span>
    cout &lt;&lt; d.C::a &lt;&lt; endl; <span class="hljs-comment">// 输出 2</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>上述问题中，A为顶级基类，B和C继承A，初始化 A 时，B 和 C 都会分别初始化 A，导致 A 被初始化两次；访问 a 时，编译器无法确定是 B::A::a 还是 C::A::a，直接报错</p>
<p>注:“B::A::a”的含义是有两层：</p>
<blockquote>
<ol>
<li>
<p>"A::a"表示 “类 <code>A</code> 中的成员变量 <code>a</code>”</p>
</li>
<li>
<p>"B::"<code>B</code> 是 <code>A</code> 的派生类</p>
</li>
</ol>
</blockquote>
<h2 data-id="heading-1">核心问题</h2>
<p>菱形继承的核心问题是<strong>间接基类的成员会被多次复制</strong>，导致数据冗余、二义性，甚至逻辑错误。</p>
<p>数据冗余表现在间接基类 <code>A</code> 的成员因为B和C的缘故会在最终派生类 <code>D</code> 中存在两份，浪费内存；</p>
<p>二义性则表现在直接访问 <code>D</code> 对象的 <code>A</code> 成员时，编译器无法区分是 <code>B</code> 继承的 <code>A</code> 还是 <code>C</code> 继承的 <code>A</code>，就会造成编译报错；</p>
<p>逻辑错误：若 <code>A</code> 有虚函数，多态调用时可能因重复的基类指针导致行为异常。原因是非虚继承的菱形结构中，最终派生类会包含<strong>两份 A 的虚指针（vptr）</strong>，多态调用时无法确定该用哪一个，导致调用结果不符合预期，甚至崩溃。</p>
<p><strong>菱形继承的内存布局</strong>如下图所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcb3548d7aeb4dde870c176ff7a591cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu-5b2i5a2m54ix5aW96ICFX1d1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767372649&amp;x-signature=ZHjq2NZXFF8VDBgYNju4pnKnFiA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">解决方案：虚继承</h2>
<p>由于多继承会造成菱形继承问题，那么C++ 提供<strong>虚继承</strong>机制就是解决菱形继承的办法。虚继承通过让中间基类（<code>B</code>、<code>C</code>）共享同一个间接基类（<code>A</code>）的实例，从而消除数据冗余和二义性</p>
<p>在中间基类继承顶层基类时，添加 <code>virtual</code> 关键字，用代码举例如下：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 顶层基类（不变）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-type">int</span> a;
    <span class="hljs-built_in">A</span>(<span class="hljs-type">int</span> val) : <span class="hljs-built_in">a</span>(val) {}
};

<span class="hljs-comment">// 中间基类 B：虚继承 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> : <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> A {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 虚继承下，B 的构造函数不再直接初始化 A（A 的初始化由最终派生类负责）</span>
    <span class="hljs-built_in">B</span>() {}
};

<span class="hljs-comment">// 中间基类 C：虚继承 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> : <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">public</span> A {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">C</span>() {}
};

<span class="hljs-comment">// 最终派生类 D：必须直接初始化虚基类 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">D</span> : <span class="hljs-keyword">public</span> B, <span class="hljs-keyword">public</span> C {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 核心：虚基类 A 的构造由最终派生类 D 统一初始化，避免重复</span>
    <span class="hljs-built_in">D</span>(<span class="hljs-type">int</span> val) : <span class="hljs-built_in">A</span>(val), <span class="hljs-built_in">B</span>(), <span class="hljs-built_in">C</span>() {}
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-function">D <span class="hljs-title">d</span><span class="hljs-params">(<span class="hljs-number">10</span>)</span></span>;
    <span class="hljs-comment">// 无歧义：d 中只有一份 A::a</span>
    cout &lt;&lt; d.a &lt;&lt; endl; <span class="hljs-comment">// 输出 10</span>
    cout &lt;&lt; d.B::a &lt;&lt; endl; <span class="hljs-comment">// 仍可显式访问，结果同上</span>
    cout &lt;&lt; d.C::a &lt;&lt; endl; <span class="hljs-comment">// 结果同上</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>通过上述代码，我们深入分析虚继承的底层原理，虚继承是通过<strong>虚基类表（vbtable）</strong> 和<strong>虚基类指针（vbptr）</strong> 实现的：</p>
<blockquote>
<ol>
<li>
<p>中间基类（<code>B</code>、<code>C</code>）的对象中会增加一个 <code>vbptr</code> 指针，指向虚基类表；</p>
</li>
<li>
<p>虚基类表存储当前对象到虚基类（<code>A</code>）实例的偏移量；</p>
</li>
<li>
<p>最终派生类（<code>D</code>）中只保留一份 <code>A</code> 的实例，<code>B</code> 和 <code>C</code> 的 <code>vbptr</code> 都指向这同一个实例。</p>
</li>
</ol>
</blockquote>
<p>非虚继承的内存布局示意图如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0b9b08c2ea549b5ac3e29c3cfc01274~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu-5b2i5a2m54ix5aW96ICFX1d1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767372649&amp;x-signature=tG0BlQy6odTarabR7iqiP4zJjeM%3D" alt="" loading="lazy"/>
虚继承的内存布局示意图如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32d9e265fe2947fa8a6be4af271aabc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu-5b2i5a2m54ix5aW96ICFX1d1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767372649&amp;x-signature=426suva1OvVfJj3OdVUE4HOCCMU%3D" alt=" " loading="lazy"/></p>
<p>虽然虚继承可以解决菱形继承的问题，但在现实开发中，为了减少不必要的麻烦，尽量避免使用多继承。</p>
<h2 data-id="heading-3">接口多继承的安全场景</h2>
<p>若顶层基类是<strong>纯虚类</strong>，即使是菱形继承结构，也无数据冗余（因为纯虚类无成员变量），此时无需虚继承，用代码举例如下：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 纯虚接口 A</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">A</span>() = <span class="hljs-keyword">default</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> : <span class="hljs-keyword">public</span> A {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ cout &lt;&lt; <span class="hljs-string">"B::func"</span> &lt;&lt; endl; }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> : <span class="hljs-keyword">public</span> A {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ cout &lt;&lt; <span class="hljs-string">"C::func"</span> &lt;&lt; endl; }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">D</span> : <span class="hljs-keyword">public</span> B, <span class="hljs-keyword">public</span> C {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 必须重写 func，否则 D 仍是抽象类（解决二义性）</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">func</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{ B::<span class="hljs-built_in">func</span>(); }
};

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    D d;
    d.<span class="hljs-built_in">func</span>(); <span class="hljs-comment">// 输出 B::func，无歧义</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-4">总结</h2>
<p>菱形继承的核心问题是间接基类成员重复，虚继承通过共享基类实例解决该问题，实际开发中应优先避免多继承。</p>
<p>以上就是本文的所有内容，如果本文对你有帮助的话欢迎点赞收藏哦~</p>
<p>感兴趣的朋友也欢迎关注哟<del>我将会持续输出编程开发的内容</del></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 与 Haskell 混合网络编程踩坑记：TCP 粘包与状态不一致引发的“死锁”]]></title>    <link>https://juejin.cn/post/7588034035286736911</link>    <guid>https://juejin.cn/post/7588034035286736911</guid>    <pubDate>2025-12-27T03:41:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588034035286736911" data-draft-id="7588004376867209251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 与 Haskell 混合网络编程踩坑记：TCP 粘包与状态不一致引发的“死锁”"/> <meta itemprop="keywords" content="JavaScript,Node.js"/> <meta itemprop="datePublished" content="2025-12-27T03:41:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lupino"/> <meta itemprop="url" content="https://juejin.cn/user/3051900006579256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 与 Haskell 混合网络编程踩坑记：TCP 粘包与状态不一致引发的“死锁”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3051900006579256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lupino
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:41:46.000Z" title="Sat Dec 27 2025 03:41:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景与目标</h2>
<p>我们需要在 Node.js 中实现一个定制化的 TCP 客户端 (<code>RSATransport</code>)，用于连接现有的 Haskell 服务端。该协议包含自定义的握手流程和三种数据传输模式：</p>
<ul>
<li><strong>Plain (0)</strong> : 握手后明文直连。</li>
<li><strong>RSA (1)</strong> : 全程使用 RSA-OAEP 加密。</li>
<li><strong>AES (2)</strong> : 握手协商出 Session Key 后使用 AES-CTR 加密。</li>
</ul>
<p><strong>Haskell 服务端逻辑 (<code>RSA.hs</code>)</strong> ： 服务端在握手时使用带缓冲的读取方式 (<code>recvDataOaep</code>)，但在切换到 <strong>Plain</strong> 模式后，直接操作底层 Socket (<code>recvData tp</code>)。</p>
<h2 data-id="heading-1">2. 问题现象</h2>
<p>开发过程中出现了一个奇怪的现象：</p>
<ol>
<li><strong>AES 模式正常</strong>：握手、密钥交换、数据传输均流畅。</li>
<li><strong>RSA 模式正常</strong>。</li>
<li><strong>Plain 模式“卡死”</strong> ：握手看似完成，但随后发送的第一条数据服务端无响应，客户端也收不到回包。</li>
<li><strong>“薛定谔的 Bug”</strong> ：如果在代码中加入 <code>console.log</code>，有时能跑通一点点，但随后依然卡住。</li>
</ol>
<h2 data-id="heading-2">3. 根因深度分析</h2>
<p>经过排查，这是一个典型的 <strong>TCP 粘包</strong> 遇上 <strong>应用层状态缓冲区设计缺陷</strong> 导致的逻辑死锁。</p>
<h3 data-id="heading-3">3.1 Haskell 服务端的“缓冲区旁路” Bug</h3>
<p>在 <code>RSA.hs</code> 中，接收逻辑是这样的：</p>
<p>Haskell</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- Haskell 伪代码</span>
recvData RSATP {..} n <span class="hljs-operator">=</span> <span class="hljs-keyword">case</span> rsaMode <span class="hljs-keyword">of</span>
  Plain <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> recvData tp n           <span class="hljs-comment">-- [关键点] 直接读底层 Socket，忽略缓冲区</span>
  RSA   <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> recvDataOaep readBuffer ... <span class="hljs-comment">-- 从缓冲区 readBuffer 读取</span>
  AES   <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> recvDataAes readBuffer ...  <span class="hljs-comment">-- 从缓冲区 readBuffer 读取</span>
</code></pre>
<p>在握手阶段（协商 Mode），服务端调用的是 <code>recvDataOaep</code>。这个函数为了解密，可能会从 TCP Socket 预读取多于所需的字节（例如读取了 4096 字节，但 Mode 包只有 256 字节）。<strong>多余的数据被留在了 Haskell 的 <code>readBuffer</code> (TVar) 中。</strong></p>
<h3 data-id="heading-4">3.2 Node.js 的“过于高效”</h3>
<p>在 Node.js 客户端，当握手完成（发送了 Mode Byte）后，我们立即清空了积压的写入队列 (<code>_writeBuffer</code>) 并发送业务数据。</p>
<p>由于 TCP 的 <strong>Nagle 算法</strong> 和操作系统的缓冲机制，发送的 <strong>[Mode 包]</strong> 和后续的 <strong>[业务数据包]</strong> 极大概率被合并成了一个 TCP 段发送到了服务端。</p>
<h3 data-id="heading-5">3.3 致命的“擦肩而过”</h3>
<p>于是发生了以下时序：</p>
<ol>
<li><strong>Client</strong>: 发送 <code>[Mode=Plain][Data="Hello"]</code>（在同一个 TCP 包中）。</li>
<li><strong>Server</strong>: 调用 <code>recvDataOaep</code> 读取 Mode。它把整个 TCP 包读入内存，解析出 <code>Mode=Plain</code>，剩下的 <code>Data="Hello"</code> 留在了 <code>readBuffer</code> 中。</li>
<li><strong>Server</strong>: 切换状态到 <code>Plain</code>。</li>
<li><strong>Server</strong>: 调用 <code>recvData tp</code> 等待新数据。<strong>注意：它跳过了 <code>readBuffer</code>，直接去问底层 Socket 要数据！</strong></li>
<li><strong>Result</strong>: Socket 缓冲区是空的（数据已经被读到应用层缓冲区了），服务端挂起等待。客户端以为服务端收到了，也在等待响应。<strong>死锁形成。</strong></li>
</ol>
<h2 data-id="heading-6">4. 解决方案</h2>
<p>要解决这个问题，必须在客户端打破“粘包”，确保服务端在处理完 Mode 切换后，Socket 缓冲区里才有新数据到达。</p>
<h3 data-id="heading-7">4.1 禁用 Nagle 算法</h3>
<p>首先，禁止 TCP 延迟发送，确保小包（如握手包）能尽快发出去。</p>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">this</span>._socket = net.connect(options);
<span class="hljs-keyword">this</span>._socket.setNoDelay(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 禁用 Nagle</span>
</code></pre>
<h3 data-id="heading-8">4.2 严格的写操作流控</h3>
<p>不能依赖 Node.js 的自动缓冲，必须确保上一个包真正写入内核（drain）后，再发下一个包。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用回调链确保顺序</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_sendOAEP</span>(modePayload, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// Mode 包写入完成后的回调</span>
    self.<span class="hljs-title function_">_finishHandshake</span>();
});
</code></pre>
<h3 data-id="heading-9">4.3 针对 Plain 模式的“魔法延时”</h3>
<p>这是最关键的一步。由于我们无法修改 Haskell 服务端代码，必须在客户端进行规避。在发送 Mode 包和发送第一条 Plain 数据之间，强制插入一个微小的延时（50ms）。</p>
<p>这给了服务端足够的时间：</p>
<ol>
<li>处理 Mode 包。</li>
<li>清空其内部接收逻辑。</li>
<li>切换到 Socket 直接读取模式。</li>
</ol>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">RSATransport</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_finishHandshake</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">_state</span> = <span class="hljs-string">'ESTABLISHED'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'connect'</span>);

  <span class="hljs-comment">// 刷新积压的数据</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_writeBuffer</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">flush</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// ... 发送积压数据 ...</span>
    };

    <span class="hljs-comment">// 针对 Plain 模式的 Hack：</span>
    <span class="hljs-comment">// 强制延时，防止 Mode 包和后续数据粘包，</span>
    <span class="hljs-comment">// 避免服务端读取 Mode 时误读了后续数据到 Buffer 中却在 Plain 模式下无法访问。</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_mode</span> === <span class="hljs-variable constant_">MODE_PLAIN</span>) {
      <span class="hljs-built_in">setTimeout</span>(flush, <span class="hljs-number">50</span>); 
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">flush</span>();
    }
  }
};
</code></pre>
<h3 data-id="heading-10">4.4 完善背压 (Backpressure) 处理</h3>
<p>除了上述核心 Bug，我们还修复了 <code>write</code> 方法的返回值问题。当处于 Plain 模式（高吞吐）时，必须正确处理 TCP 的背压，否则会导致内存飙升或数据丢失。</p>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 转发底层的 drain 事件</span>
<span class="hljs-keyword">this</span>._socket.on(<span class="hljs-string">'drain'</span>, () =&gt; <span class="hljs-keyword">this</span>.emit(<span class="hljs-string">'drain'</span>));

<span class="hljs-comment">// 正确返回 boolean</span>
Transport.prototype.write = function(<span class="hljs-keyword">data</span>, encoding, callback) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._socket.write(<span class="hljs-keyword">data</span>, encoding, callback); 
};
</code></pre>
<h2 data-id="heading-11">5. 总结</h2>
<p>这次排查再次验证了网络编程中的一条铁律：<strong>TCP 是流协议，不是包协议</strong>。</p>
<p>当客户端与服务端由不同语言编写，且服务端存在混合读取策略（Buffer读取 vs Socket直读）时，应用层必须极其小心地处理数据边界。</p>
<ul>
<li><strong>教训 1</strong>: 不要假设 <code>write</code> 两次就会产生两个 TCP 包。</li>
<li><strong>教训 2</strong>: 在处理协议状态切换（如握手 -&gt; 传输）时，状态机的同步至关重要。</li>
<li><strong>教训 3</strong>: 遇到“卡死”且日志影响行为时，优先怀疑缓冲机制和竞态条件。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[支付配置时好时坏？异步方法里的对象引用坑]]></title>    <link>https://juejin.cn/post/7588010346071179274</link>    <guid>https://juejin.cn/post/7588010346071179274</guid>    <pubDate>2025-12-27T03:53:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588010346071179274" data-draft-id="7588010346071162890" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="支付配置时好时坏？异步方法里的对象引用坑"/> <meta itemprop="keywords" content="后端,面试,Java"/> <meta itemprop="datePublished" content="2025-12-27T03:53:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="9号达人"/> <meta itemprop="url" content="https://juejin.cn/user/2450136052270077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            支付配置时好时坏？异步方法里的对象引用坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2450136052270077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    9号达人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T03:53:57.000Z" title="Sat Dec 27 2025 03:53:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上周接到客服反馈。</p>
<p>有些商户开通之后，微信支付功能不能用，有些又可以。不能用的商户就需要客服手动介入，重新配置支付参数才恢复正常。</p>
<p>这个问题就很诡异，<strong>时好时坏</strong>。有时候正常，有时候就不行。</p>
<p>但是后台日志显示都是配置成功。代码执行完了，没有任何报错。</p>
<h2 data-id="heading-0">诡异的现象</h2>
<p>开始排查日志。发现了几个很奇怪的点：</p>
<ol>
<li><strong>业务日志显示成功</strong>，没有任何异常</li>
<li><strong>调用日志显示两次配置用的appid一样</strong></li>
<li><strong>代码明明写的是两个不同的appid</strong></li>
<li><strong>配置文件也没问题</strong>，两个appid都配对了</li>
</ol>
<p>代码写的明明是A和B两个appid，为啥日志里都变成B了？</p>
<p>看了好几遍日志，确定没看错。两次调用传入的appid确实一模一样。</p>
<p>那就只能看看代码了。</p>
<pre><code class="hljs language-ini" lang="ini">openMemberV2Service.wxConfig(openMemberV2DTO)<span class="hljs-comment">;</span>
openMemberV2DTO.setSupAppId(sysConfig.getWxHuikeOfficialAccountAppid())<span class="hljs-comment">;</span>
openMemberV2DTO.setAccountType("00")<span class="hljs-comment">;</span>
openMemberV2Service.wxConfig(openMemberV2DTO)<span class="hljs-comment">;</span>
LogUtil.info(log, "editGrant &gt;&gt; 开通成功 &gt;&gt; <span class="hljs-attr">param</span> = {}<span class="hljs-string">", param);
</span></code></pre>
<p>乍一看，完全没问题。</p>
<p>第一次调用用的是<code>openMemberV2DTO</code>原始的appid。第二次调用之前，明明修改了<code>supAppId</code>和<code>accountType</code>。</p>
<p>代码逻辑也很清晰，为啥会出问题？</p>
<p>会不会是配置文件把appid配错了？</p>
<p>检查了配置文件：</p>
<p>配置也没问题。两个appid都对。</p>
<p>既然代码逻辑没问题，配置也没问题，那问题大概率就是wxConfig这个方法了</p>
<p>点开<code>wxConfig</code>方法：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">wxConfig</span>(<span class="hljs-params">OpenMemberV2DTO dto</span>) {
    asyncTaskExecutor.<span class="hljs-title function_">execute</span>(() -&gt; {
        <span class="hljs-comment">// 获取参数</span>
        <span class="hljs-title class_">String</span> subAppId = dto.<span class="hljs-title function_">getSupAppId</span>();
        <span class="hljs-title class_">String</span> accountType = dto.<span class="hljs-title function_">getAccountType</span>();

        <span class="hljs-comment">// 调用微信API配置</span>
        <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span> body = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSON</span><span class="hljs-built_in">Object</span>();
        body.<span class="hljs-title function_">put</span>(<span class="hljs-string">"sub_appid"</span>, subAppId);
        body.<span class="hljs-title function_">put</span>(<span class="hljs-string">"account_type"</span>, accountType);

        <span class="hljs-comment">// 调用平台接口...</span>
        platformManager.<span class="hljs-title function_">call</span>(callParam);
    });
}
</code></pre>
<p>看到<code>asyncTaskExecutor.execute</code>，相信大家就明白了。</p>
<p><strong>这是个异步方法！</strong></p>
<p>那问题链路就清楚了：</p>
<ol>
<li>主线程调用<code>wxConfig(openMemberV2DTO)</code> → 任务提交到线程池，<strong>还没执行</strong></li>
<li>主线程继续执行，修改<code>openMemberV2DTO.setSupAppId(...)</code></li>
<li>主线程再次调用<code>wxConfig(openMemberV2DTO)</code> → 又提交一个任务到线程池</li>
<li>线程池开始执行第一个任务 → 读取<code>dto.getSupAppId()</code>，发现已经是修改后的值了</li>
<li>线程池执行第二个任务 → 还是同一个对象，appid当然一样</li>
</ol>
<p><strong>两次传的是同一个对象引用，第二次修改污染了第一次的数据。</strong></p>
<h2 data-id="heading-1">问题本质</h2>
<p>这个问题的本质是：<strong>对象引用 + 异步方法 ≈ 数据污染</strong></p>
<h3 data-id="heading-2">Java对象引用机制</h3>
<p>Java方法传参，传的是引用，不是副本。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 这两次调用，传的是同一个对象的引用</span>
<span class="hljs-built_in">wxConfig</span>(openMemberV2DTO);  <span class="hljs-comment">// 传的是引用</span>
openMemberV2DTO<span class="hljs-selector-class">.setSupAppId</span>("new_appid");  <span class="hljs-comment">// 修改对象</span>
<span class="hljs-built_in">wxConfig</span>(openMemberV2DTO);  <span class="hljs-comment">// 还是同一个引用</span>
</code></pre>
<p>如果<code>wxConfig</code>是同步方法，没问题。因为第一次调用会立即执行完，用的是修改前的值。</p>
<p>但<code>wxConfig</code>是异步方法。</p>
<h3 data-id="heading-3">异步方法的执行时机</h3>
<p>异步方法不会立即执行，而是提交到线程池，等线程池有空闲线程时才执行。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 主线程时间线</span>
t1: <span class="hljs-built_in">wxConfig</span>(dto)  → 提交任务A到线程池
t2: dto.<span class="hljs-built_in">setSupAppId</span>(<span class="hljs-string">"new"</span>)  → 修改对象
t3: <span class="hljs-built_in">wxConfig</span>(dto)  → 提交任务B到线程池
t4: 主线程结束

// 线程池时间线
t5: 执行任务A → 读取dto.<span class="hljs-built_in">getSupAppId</span>()  // 已经是<span class="hljs-string">"new"</span>了！
t6: 执行任务B → 读取dto.<span class="hljs-built_in">getSupAppId</span>()  // 还是<span class="hljs-string">"new"</span>
</code></pre>
<h3 data-id="heading-4">完整的问题链路</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Main as 主线程
    participant Pool as 线程池
    participant Obj as openMemberV2DTO对象

    Note over Main: t1时刻
    Main-&gt;&gt;Pool: wxConfig(openMemberV2DTO)
    Note over Pool: 任务A进入队列&lt;br/&gt;等待执行

    Note over Main: t2时刻
    Main-&gt;&gt;Obj: setSupAppId(&amp;#34;wx_huike...&amp;#34;)
    Main-&gt;&gt;Obj: setAccountType(&amp;#34;00&amp;#34;)
    Note over Obj: 对象状态被修改

    Note over Main: t3时刻
    Main-&gt;&gt;Pool: wxConfig(openMemberV2DTO)
    Note over Pool: 任务B进入队列&lt;br/&gt;等待执行

    Note over Main: t4时刻
    Note over Main: 主线程结束&lt;br/&gt;打印&amp;#34;开通成功&amp;#34;

    Note over Pool: t5时刻
    Pool-&gt;&gt;Obj: 执行任务A&lt;br/&gt;读取getSupAppId()
    Note over Obj: 返回：&amp;#34;wx_huike...&amp;#34;&lt;br/&gt;已经是修改后的值！

    Note over Pool: t6时刻
    Pool-&gt;&gt;Obj: 执行任务B&lt;br/&gt;读取getSupAppId()
    Note over Obj: 返回：&amp;#34;wx_huike...&amp;#34;&lt;br/&gt;还是同一个值！
</code></pre>
<p><strong>两个任务读取的都是修改后的值。</strong></p>
<h2 data-id="heading-5">为什么这个bug特别容易被忽略。？</h2>
<h3 data-id="heading-6">代码看起来完全正常</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">wxConfig</span>(dto);  <span class="hljs-comment">// 第一次调用</span>
dto<span class="hljs-selector-class">.setSupAppId</span>("new");  <span class="hljs-comment">// 修改</span>
<span class="hljs-built_in">wxConfig</span>(dto);  <span class="hljs-comment">// 第二次调用</span>
</code></pre>
<p>如果不知道<code>wxConfig</code>是异步的，这代码一点问题都没有。</p>
<h3 data-id="heading-7">没有啥报错</h3>
<p>业务逻辑正常执行完了，日志显示成功。不会抛异常，不会空指针。</p>
<p>只是<strong>配置错了</strong>而已。</p>
<h3 data-id="heading-8">问题是偶发的</h3>
<p>这才是最隐蔽的地方。</p>
<p>如果线程池刚好空闲，第一个任务提交后立即执行完了，第二个任务再进来，就不会有问题。</p>
<p>但如果线程池正忙，两个任务都在队列里等待，等到真正执行时，对象可能早就被修改了。</p>
<p><strong>时好时坏，最难排查。</strong></p>
<h3 data-id="heading-9">日志的迷惑性</h3>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">INFO</span>] 开通成功
</code></pre>
<p>这行日志在主线程结束时打印，让人以为一切正常。</p>
<p>实际上，线程池里的任务才刚开始执行。</p>
<h3 data-id="heading-10">Code Review容易被遗漏</h3>
<p>Code Review时，如果不进入<code>wxConfig</code>方法内部看，很难发现是异步的。</p>
<p>而且代码逻辑确实没问题，就是少考虑了异步场景。</p>
<h2 data-id="heading-11">解决方案</h2>
<h3 data-id="heading-12">创建新对象</h3>
<p>最简单的办法：给第二次调用创建一个新对象。</p>
<pre><code class="hljs language-ini" lang="ini">openMemberV2Service.wxConfig(openMemberV2DTO)<span class="hljs-comment">;</span>
// 创建新对象
OpenMemberV2DTO <span class="hljs-attr">openMemberDTO</span> = BeanUtil.map(openMemberV2DTO, OpenMemberV2DTO.class)<span class="hljs-comment">;</span>
openMemberDTO.setSupAppId(sysConfig.getWxHuikeOfficialAccountAppid())<span class="hljs-comment">;</span>
openMemberDTO.setAccountType("00")<span class="hljs-comment">;</span>
openMemberV2Service.wxConfig(openMemberDTO)<span class="hljs-comment">;</span>
</code></pre>
<p><code>BeanUtil.map</code>会创建一个新对象，复制所有属性。</p>
<p>两次调用传入的是不同的对象引用，互不影响。</p>
<h3 data-id="heading-13">其他方案</h3>
<p><strong>方案1：深拷贝</strong></p>
<pre><code class="hljs language-ini" lang="ini">OpenMemberV2DTO <span class="hljs-attr">newDto</span> = openMemberV2DTO.clone()<span class="hljs-comment">;</span>
</code></pre>
<p>前提是DTO实现了<code>Cloneable</code>接口，并且是深拷贝。</p>
<p><strong>方案2：不可变对象</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建新对象，而不是修改旧对象</span>
OpenMemberV2DTO dto2 = OpenMemberV2DTO<span class="hljs-selector-class">.builder</span>()
    <span class="hljs-selector-class">.supAppId</span>(sysConfig.getWxHuikeOfficialAccountAppid())
    <span class="hljs-selector-class">.accountType</span>("<span class="hljs-number">00</span>")
    <span class="hljs-selector-class">.build</span>();

<span class="hljs-built_in">wxConfig</span>(dto2);
</code></pre>
<p><strong>方案3：异步方法内部拷贝（最推荐）</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">wxConfig</span><span class="hljs-params">(OpenMemberV2DTO dto)</span> </span>{
    <span class="hljs-comment">// 进入方法就立即拷贝参数</span>
    OpenMemberV2DTO copyDto = FsBeanUtil.<span class="hljs-built_in">map</span>(dto, OpenMemberV2DTO.<span class="hljs-keyword">class</span>);

    asyncTaskExecutor.<span class="hljs-built_in">execute</span>(() -&gt; {
        <span class="hljs-comment">// 使用拷贝的对象</span>
        <span class="hljs-type">String</span> subAppId = copyDto.<span class="hljs-built_in">getSupAppId</span>();
        <span class="hljs-comment">// ...</span>
    });
}
</code></pre>
<p><strong>为什么推荐这个方案？</strong></p>
<ol>
<li><strong>调用方不用关心是否异步</strong>：封装性好，对外接口简洁</li>
<li><strong>一劳永逸</strong>：修改一次，所有调用方都受益</li>
<li><strong>防御性编程</strong>：在方法内部做好防护，不依赖调用方的正确使用</li>
</ol>
<p>这次修复后，我就是用的这个方案。把拷贝逻辑加到<code>wxConfig</code>方法内部，之后就再也没出过问题。</p>
<h2 data-id="heading-14">总结</h2>
<p>这次事故让我学到了几点。</p>
<h3 data-id="heading-15">1. 异步方法要警惕对象引用</h3>
<p>只要方法是异步的，传入的对象可能在任何时候被修改。</p>
<p>不要假设"调用方不会改"。要么拷贝对象，要么用不可变对象。</p>
<h3 data-id="heading-16">2. Code Review不只看逻辑</h3>
<p>Review代码时，不能只看表面逻辑是否正确。</p>
<p>还要关注：</p>
<ul>
<li>方法是同步还是异步？</li>
<li>对象是共享的还是独立的？</li>
<li>有没有线程安全问题？</li>
</ul>
<h3 data-id="heading-17">3. 线程安全不只是加锁</h3>
<p>很多人提到线程安全，第一反应是加锁。</p>
<p>但这个问题加锁也没用，根本原因是<strong>对象被共享了</strong>。</p>
<p>线程安全的本质：<strong>避免共享可变状态</strong>。</p>
<h3 data-id="heading-18">4. 日志要打印关键参数</h3>
<p>如果一开始没有打印appid，这个问题会更难排查。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 好的日志</span>
LogUtil.info(<span class="hljs-built_in">log</span>, <span class="hljs-string">"wxConfig &gt;&gt; sub_appid = {}, account_type = {}"</span>,
    dto.getSupAppId(), dto.getAccountType());

<span class="hljs-comment">// 不够的日志</span>
LogUtil.info(<span class="hljs-built_in">log</span>, <span class="hljs-string">"wxConfig &gt;&gt; 开始配置"</span>);
</code></pre>
<p>关键参数一定要打印出来。</p>
<h3 data-id="heading-19">5. 排查问题要看方法实现</h3>
<p>这次能快速定位，是因为进入了<code>wxConfig</code>方法内部，看到了<code>asyncTaskExecutor.execute</code>。</p>
<p>如果只看调用代码，永远找不到原因。</p>
<h2 data-id="heading-20">写在最后</h2>
<p><strong>异步方法传参时，注意对象引用问题。如果需要多次调用并修改参数，务必创建新对象。</strong></p>
<p>代码很简单，但容易忽略。大家一起共勉。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[5分钟搞定RustFS监控：Prometheus+Grafana实战，性能提升300%的监控方案]]></title>    <link>https://juejin.cn/post/7587997893987516443</link>    <guid>https://juejin.cn/post/7587997893987516443</guid>    <pubDate>2025-12-26T11:27:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997893987516443" data-draft-id="7587965800272986138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="5分钟搞定RustFS监控：Prometheus+Grafana实战，性能提升300%的监控方案"/> <!----> <meta itemprop="datePublished" content="2025-12-26T11:27:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="对象存储与RustFS"/> <meta itemprop="url" content="https://juejin.cn/user/652466093570057"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            5分钟搞定RustFS监控：Prometheus+Grafana实战，性能提升300%的监控方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/652466093570057/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    对象存储与RustFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T11:27:19.000Z" title="Fri Dec 26 2025 11:27:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">5分钟搞定RustFS监控：Prometheus+Grafana实战，性能提升300%的监控方案</h2>
<blockquote>
<p>在分布式存储系统的运维中，“看不见问题”往往比问题本身更可怕。本文将带你通过5分钟的实战部署，为RustFS构建一套企业级监控系统，让系统运行状态一目了然。</p>
</blockquote>
<h3 data-id="heading-1">一、为什么RustFS需要专门的监控方案？</h3>
<p>作为高性能分布式对象存储系统，RustFS在运行过程中会产生海量指标数据。传统的日志监控已无法满足需求，主要表现在：</p>
<p>三大监控痛点：<br/>
• 性能瓶颈难定位：无法实时掌握IOPS、延迟等关键指标</p>
<p>• 容量规划靠猜测：存储使用趋势不清晰，扩容时机难把握</p>
<p>• 故障排查效率低：问题发生时缺乏完整链路数据支撑</p>
<p>解决方案对比：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 传统方案：查看日志（低效）</span>
<span class="hljs-built_in">tail</span> -f /var/log/rustfs/server.log | grep <span class="hljs-string">"ERROR"</span>

<span class="hljs-comment"># 现代方案：全景监控（高效）</span>
<span class="hljs-comment"># 指标采集(Prometheus) + 可视化(Grafana) + 告警(Alertmanager)</span>
</code></pre>
<p>接下来，我将分享一套在生产环境验证的5分钟快速部署方案。</p>
<h3 data-id="heading-2">二、环境准备：1分钟搞定基础组件</h3>
<h4 data-id="heading-3">2.1 系统要求检查</h4>
<p>确保你的环境满足以下要求：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查Docker环境</span>
docker --version &amp;&amp; docker-compose --version

<span class="hljs-comment"># 检查资源情况</span>
free -h &amp;&amp; <span class="hljs-built_in">df</span> -h

<span class="hljs-comment"># 预期输出示例：</span>
<span class="hljs-comment"># Docker version 20.10.0</span>
<span class="hljs-comment"># 可用内存 ≥ 2GB，磁盘空间 ≥ 5GB</span>
</code></pre>
<p>最低配置：<br/>
• 内存：2GB+</p>
<p>• 磁盘：5GB可用空间</p>
<p>• 网络：可访问Docker Hub</p>
<h4 data-id="heading-4">2.2 一键下载监控套件</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目目录</span>
<span class="hljs-built_in">mkdir</span> rustfs-monitoring &amp;&amp; <span class="hljs-built_in">cd</span> rustfs-monitoring

<span class="hljs-comment"># 下载docker-compose配置文件</span>
curl -O https://raw.githubusercontent.com/rustfs/monitoring/main/docker-compose.yml

<span class="hljs-comment"># 下载Prometheus配置</span>
<span class="hljs-built_in">mkdir</span> -p config/prometheus
curl -O https://raw.githubusercontent.com/rustfs/monitoring/main/config/prometheus/prometheus.yml
</code></pre>
<h3 data-id="heading-5">三、核心配置：2分钟完成监控集成</h3>
<h4 data-id="heading-6">3.1 配置RustFS支持指标输出</h4>
<p>修改RustFS配置文件 (<code>rustfs.env</code>)：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启用指标采集</span>
RUSTFS_METRICS_ENABLED=<span class="hljs-literal">true</span>
RUSTFS_METRICS_TYPES=511  <span class="hljs-comment"># 采集所有指标类型</span>

<span class="hljs-comment"># OpenTelemetry端点配置</span>
RUSTFS_OTLP_ENDPOINT=http://otel-collector:4317

<span class="hljs-comment"># 指标采集间隔（秒）</span>
RUSTFS_METRICS_INTERVAL=15
</code></pre>
<p>指标类型说明：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// RustFS支持的监控指标枚举</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">MetricType</span> {
    DISK = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>,      <span class="hljs-comment">// 磁盘指标</span>
    NET = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>,       <span class="hljs-comment">// 网络指标  </span>
    MEM = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>,       <span class="hljs-comment">// 内存指标</span>
    CPU = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>,       <span class="hljs-comment">// CPU指标</span>
    <span class="hljs-comment">// ... 其他指标</span>
    ALL = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">9</span>) - <span class="hljs-number">1</span>  <span class="hljs-comment">// 所有指标</span>
}
</code></pre>
<h4 data-id="heading-7">3.2 配置Prometheus数据采集</h4>
<p>编辑Prometheus配置 (<code>prometheus.yml</code>)：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">global:</span>
  <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">15s</span>
  <span class="hljs-attr">evaluation_interval:</span> <span class="hljs-string">15s</span>

<span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'rustfs-metrics'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'otel-collector:8889'</span>]
    <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">'/metrics'</span>
    <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">10s</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'node-exporter'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'node-exporter:9100'</span>]

<span class="hljs-attr">alerting:</span>
  <span class="hljs-attr">alertmanagers:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">static_configs:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'alertmanager:9093'</span>]
</code></pre>
<h4 data-id="heading-8">3.3 配置OpenTelemetry Collector</h4>
<p>创建OTel配置 (<code>otel-collector-config.yaml</code>)：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">receivers:</span>
  <span class="hljs-attr">otlp:</span>
    <span class="hljs-attr">protocols:</span>
      <span class="hljs-attr">grpc:</span>
        <span class="hljs-attr">endpoint:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">:4317</span>

<span class="hljs-attr">exporters:</span>
  <span class="hljs-attr">prometheus:</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">"0.0.0.0:8889"</span>
    <span class="hljs-attr">namespace:</span> <span class="hljs-string">rustfs</span>

<span class="hljs-attr">service:</span>
  <span class="hljs-attr">pipelines:</span>
    <span class="hljs-attr">metrics:</span>
      <span class="hljs-attr">receivers:</span> [<span class="hljs-string">otlp</span>]
      <span class="hljs-attr">exporters:</span> [<span class="hljs-string">prometheus</span>]
</code></pre>
<h3 data-id="heading-9">四、一键部署：1分钟启动所有服务</h3>
<h4 data-id="heading-10">4.1 编写Docker Compose文件</h4>
<p>完整的<code>docker-compose.yml</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">prometheus:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/prometheus:latest</span>
    <span class="hljs-attr">ports:</span> [<span class="hljs-string">"9090:9090"</span>]
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./config/prometheus:/etc/prometheus</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">--web.enable-lifecycle</span>

  <span class="hljs-attr">grafana:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">grafana/grafana:latest</span>
    <span class="hljs-attr">ports:</span> [<span class="hljs-string">"3000:3000"</span>]
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">GF_SECURITY_ADMIN_PASSWORD=admin123</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">grafana_data:/var/lib/grafana</span>

  <span class="hljs-attr">otel-collector:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">otel/opentelemetry-collector:0.130.0</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./otel-collector-config.yaml:/etc/otelcol/config.yaml</span>
    <span class="hljs-attr">ports:</span> [<span class="hljs-string">"4317:4317"</span>]

  <span class="hljs-attr">node-exporter:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">prom/node-exporter:latest</span>
    <span class="hljs-attr">ports:</span> [<span class="hljs-string">"9100:9100"</span>]

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">grafana_data:</span>
</code></pre>
<h4 data-id="heading-11">4.2 启动监控栈</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 一键启动所有服务</span>
docker-compose up -d

<span class="hljs-comment"># 检查服务状态</span>
docker-compose ps

<span class="hljs-comment"># 预期输出：</span>
<span class="hljs-comment"># NAME                STATUS              PORTS</span>
<span class="hljs-comment"># prometheus          Up 5 minutes        0.0.0.0:9090-&gt;9090/tcp</span>
<span class="hljs-comment"># grafana            Up 5 minutes        0.0.0.0:3000-&gt;3000/tcp</span>
<span class="hljs-comment"># otel-collector     Up 5 minutes        0.0.0.0:4317-&gt;4317/tcp</span>
</code></pre>
<h3 data-id="heading-12">五、配置可视化：1分钟完成Grafana仪表板</h3>
<h4 data-id="heading-13">5.1 添加数据源</h4>
<ol>
<li>
<p>访问Grafana：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A3000" target="_blank" title="http://localhost:3000" ref="nofollow noopener noreferrer">http://localhost:3000</a></p>
</li>
<li>
<p>登录：用户名<code>admin</code>​，密码<code>admin123</code></p>
</li>
<li>
<p>添加Prometheus数据源：<br/>
• 点击Configuration → Data Sources → Add data source</p>
<p>• 选择Prometheus类型</p>
<p>• URL填写：<code>http://prometheus:9090</code></p>
<p>• 点击Save &amp; Test验证连接</p>
</li>
</ol>
<h4 data-id="heading-14">5.2 导入预置仪表板</h4>
<p>使用官方仪表板模板：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 获取仪表板ID列表</span>
<span class="hljs-comment"># 存储性能仪表板：ID 1324</span>
<span class="hljs-comment"># 系统资源仪表板：ID 1325  </span>
<span class="hljs-comment"># 业务指标仪表板：ID 1326</span>
</code></pre>
<p>导入步骤：</p>
<ol>
<li>点击+ → Import</li>
<li>输入仪表板ID：<code>1324</code></li>
<li>选择Prometheus数据源</li>
<li>点击Import完成</li>
</ol>
<h4 data-id="heading-15">5.3 关键监控指标解读</h4>
<p>核心监控指标清单：</p>
<pre><code class="hljs language-promql" lang="promql"># 存储容量使用率
sum(rustfs_disk_used_bytes) by (instance) / sum(rustfs_disk_total_bytes) by (instance) * 100

# 请求延迟(P95)
histogram_quantile(0.95, sum(rate(rustfs_request_duration_seconds_bucket[5m])) by (le))

# 吞吐量监控
rate(rustfs_throughput_bytes_total[5m])

# 错误率监控
rate(rustfs_request_errors_total[5m]) / rate(rustfs_requests_total[5m]) * 100
</code></pre>
<h3 data-id="heading-16">六、实战效果：真实监控数据展示</h3>
<h4 data-id="heading-17">6.1 性能提升对比</h4>
<p>监控系统部署前后对比：</p>



































<table><thead><tr><th>监控能力</th><th>部署前</th><th>部署后</th><th>提升效果</th></tr></thead><tbody><tr><td>问题发现时间</td><td>小时级</td><td>分钟级</td><td>20倍提速</td></tr><tr><td>性能分析深度</td><td>基础指标</td><td>全链路追踪</td><td>300%更深入</td></tr><tr><td>容量规划</td><td>经验猜测</td><td>数据驱动</td><td>准确率提升80%</td></tr><tr><td>故障恢复</td><td>手动排查</td><td>自动定位</td><td>恢复时间减少70%</td></tr></tbody></table>
<h4 data-id="heading-18">6.2 关键监控界面预览</h4>
<p>仪表板核心组件：</p>
<ol>
<li>集群概览：节点状态、存储容量、请求总量</li>
<li>性能分析：P50/P95/P99延迟、吞吐量趋势</li>
<li>资源监控：CPU、内存、磁盘、网络使用率</li>
<li>业务指标：S3操作统计、错误率、缓存命中率</li>
</ol>
<h3 data-id="heading-19">七、高级功能：告警配置与优化</h3>
<h4 data-id="heading-20">7.1 关键告警规则配置</h4>
<p>创建告警规则 (<code>alert.rules</code>)：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">groups:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">rustfs_alerts</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">HighDiskUsage</span>
    <span class="hljs-attr">expr:</span> <span class="hljs-string">rustfs_disk_used_percent</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">85</span>
    <span class="hljs-attr">for:</span> <span class="hljs-string">5m</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">severity:</span> <span class="hljs-string">warning</span>
    <span class="hljs-attr">annotations:</span>
      <span class="hljs-attr">summary:</span> <span class="hljs-string">"磁盘使用率过高 (实例 <span class="hljs-template-variable">{{ $labels.instance }}</span>)"</span>
      
  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">APIErrorRateHigh</span>
    <span class="hljs-attr">expr:</span> <span class="hljs-string">rate(rustfs_request_errors_total[5m])</span> <span class="hljs-string">/</span> <span class="hljs-string">rate(rustfs_requests_total[5m])</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">0.05</span>
    <span class="hljs-attr">for:</span> <span class="hljs-string">2m</span>
    <span class="hljs-attr">labels:</span>
      <span class="hljs-attr">severity:</span> <span class="hljs-string">critical</span>
</code></pre>
<h4 data-id="heading-21">7.2 告警通知集成</h4>
<p>配置邮件通知：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># alertmanager.yml</span>
<span class="hljs-attr">route:</span>
  <span class="hljs-attr">group_by:</span> [<span class="hljs-string">'alertname'</span>]
  <span class="hljs-attr">group_wait:</span> <span class="hljs-string">10s</span>
  <span class="hljs-attr">group_interval:</span> <span class="hljs-string">5m</span>
  <span class="hljs-attr">repeat_interval:</span> <span class="hljs-string">1h</span>
  <span class="hljs-attr">receiver:</span> <span class="hljs-string">'email-notifications'</span>

<span class="hljs-attr">receivers:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">'email-notifications'</span>
  <span class="hljs-attr">email_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">to:</span> <span class="hljs-string">'team@company.com'</span>
    <span class="hljs-attr">from:</span> <span class="hljs-string">'alertmanager@company.com'</span>
    <span class="hljs-attr">smarthost:</span> <span class="hljs-string">'smtp.company.com:587'</span>
    <span class="hljs-attr">auth_username:</span> <span class="hljs-string">'alertmanager'</span>
    <span class="hljs-attr">auth_password:</span> <span class="hljs-string">'password'</span>
</code></pre>
<h3 data-id="heading-22">八、常见问题与解决方案</h3>
<h4 data-id="heading-23">8.1 部署问题排查</h4>
<p>问题1：Prometheus无法采集数据</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查目标状态</span>
curl http://localhost:9090/api/v1/targets

<span class="hljs-comment"># 检查指标端点</span>
curl http://otel-collector:8889/metrics
</code></pre>
<p>问题2：Grafana无法连接数据源</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查网络连通性</span>
docker-compose <span class="hljs-built_in">exec</span> grafana ping prometheus

<span class="hljs-comment"># 检查防火墙规则</span>
iptables -L | grep 9090
</code></pre>
<h4 data-id="heading-24">8.2 性能优化建议</h4>
<p>大规模集群优化：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 调整Prometheus配置</span>
<span class="hljs-attr">storage:</span>
  <span class="hljs-attr">tsdb:</span>
    <span class="hljs-attr">retention:</span> <span class="hljs-string">15d</span>  <span class="hljs-comment"># 数据保留时间</span>
    <span class="hljs-attr">max_block_size:</span> <span class="hljs-string">2h</span>

<span class="hljs-comment"># 优化采集频率</span>
<span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">30s</span>  <span class="hljs-comment"># 生产环境建议值</span>
</code></pre>
<h3 data-id="heading-25">九、生产环境实践建议</h3>
<h4 data-id="heading-26">9.1 监控策略规划</h4>
<p>根据业务重要性分级监控：</p>





























<table><thead><tr><th>监控级别</th><th>采集间隔</th><th>保留时间</th><th>告警响应</th></tr></thead><tbody><tr><td>关键业务</td><td>15秒</td><td>30天</td><td>5分钟</td></tr><tr><td>重要业务</td><td>30秒</td><td>15天</td><td>15分钟</td></tr><tr><td>一般业务</td><td>60秒</td><td>7天</td><td>30分钟</td></tr></tbody></table>
<h4 data-id="heading-27">9.2 容量规划指南</h4>
<p>资源需求估算：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 每日指标数据量估算</span>
指标数量 × 采集频率 × 保存天数 × 字节数/指标
1000指标 × 2880次/天 × 30天 × 2KB ≈ 172GB/月
</code></pre>
<h3 data-id="heading-28">十、总结与下一步</h3>
<p>通过本文的5分钟实战，你已经成功搭建了完整的RustFS监控体系。这套方案的优势在于：</p>
<p>✅ 开箱即用：一键部署，无需复杂配置<br/>
✅ 全面监控：覆盖性能、资源、业务全维度<br/>
✅ 生产就绪：经过真实环境验证，稳定可靠<br/>
✅ 可扩展：支持水平扩展，满足增长需求</p>
<hr/>
<p>以下是深入学习 RustFS 的推荐资源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs" target="_blank" title="https://github.com/rustfs/rustfs" ref="nofollow noopener noreferrer">RustFS</a></p>
<p>官方文档： <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fdocs.rustfs.com%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//docs.rustfs.com/" ref="nofollow noopener noreferrer">RustFS 官方文档</a>- 提供架构、安装指南和 API 参考。</p>
<p>GitHub 仓库： <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fdocs.rustfs.com%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//docs.rustfs.com/" ref="nofollow noopener noreferrer">GitHub 仓库</a> - 获取源代码、提交问题或贡献代码。</p>
<p>社区支持： <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2Forgs%2Frustfs%2Fdiscussions" target="_blank" title="https://link.zhihu.com/?target=https%3A//github.com/orgs/rustfs/discussions" ref="nofollow noopener noreferrer">GitHub Discussions</a>- 与开发者交流经验和解决方案。</p>
<p>‍</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <!----></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🔥MySQL的大表优化方案 (实战分享)]]></title>    <link>https://juejin.cn/post/7588086766235254822</link>    <guid>https://juejin.cn/post/7588086766235254822</guid>    <pubDate>2025-12-26T11:50:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766235254822" data-draft-id="7587903505136402482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🔥MySQL的大表优化方案 (实战分享)"/> <meta itemprop="keywords" content="Java,MySQL,性能优化"/> <meta itemprop="datePublished" content="2025-12-26T11:50:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_sunshine"/> <meta itemprop="url" content="https://juejin.cn/user/4212984287338653"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🔥MySQL的大表优化方案 (实战分享)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984287338653/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_sunshine
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T11:50:48.000Z" title="Fri Dec 26 2025 11:50:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94e5fd4c7d0b44dfaef178e7304522ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=2NwcGpRz36cjWCpCKGFWLHce9jI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、MySQL大表的标准和定义</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04edfb70baf342f4986144b8ce9a824b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=C6TkQ%2BWSS5bqfPws0TC2F45GE2c%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>数据量维度</strong>：单表行数超过1000万行，或单表占用空间超过100GB（不同业务场景下阈值差异较大，如高并发业务中500万行可能就成为大表）；</li>
<li><strong>并发场景性能维度</strong>：查询耗时稳定超过500ms，更新/删除操作出现锁等待，索引维护（创建、删除、重建）耗时过长（超过1小时）；</li>
</ul>
<h2 data-id="heading-1">二、分片原则和优化方案选择和建议</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/405abd147780451496a4b1c9ffbb0c82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=I%2FFlobgHviOAlmaP8ofrpKJxS98%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">分片原则</h3>
<p>(1) 能不分就不分，做“单表优化”；</p>
<p>(2) 分片数量尽量少，分片尽量均匀分布在多个数据结点上，因为一个查询SQL跨分片越多，则总体性能越差，虽然要好于所有数据在一个分片的结果，只在必要的时候进行扩容，增加分片数量；</p>
<p>(3) 分片规则需要慎重选择做好提前规划，分片规则的选择，需要考虑数据的增长模式，数据的访问模式，分片关联性问题，以及分片扩容问题，最近的分片策略为范围分片，枚举分片，一致性Hash分片，这几种分片都有利于扩容；</p>
<p>(4) 尽量不要在一个事务中的SQL跨越多个分片，分布式事务一直是个不好处理的问题；</p>
<p>(5) 可以通过数据冗余和表分区赖降低跨库Join的可能。</p>
<h3 data-id="heading-3">优化方案选择和建议</h3>
<p>不同业务场景、不同数据量规模下，应选择不同的优化方案，避免盲目采用架构级优化（如分库分表）增加系统复杂度，分库分表的实施建议：</p>
<ul>
<li><strong>数据量 &lt; 1000万</strong>：优先采用“查询优化+索引优化+表结构优化”的低成本方案。检查并优化慢查询语句，调整索引设计，规范表结构，通常能满足性能需求；</li>
<li><strong>1000万 ≤ 数据量 ≤ 1亿</strong>：采用“数据归档+分区表”方案。将历史数据归档，减少活跃数据量；通过分区表拆分数据，提升查询和写入效率；若为读多写少场景，可搭配读写分离；</li>
<li><strong>数据量 ≥ 1亿或者并发极高</strong>：采用“分库分表”架构级方案。结合业务场景选择合适的分片键和拆分策略，使用中间件简化实现；同时搭配数据归档、读写分离、缓存等方案，全方位提升系统性能和可用性。</li>
</ul>
<h2 data-id="heading-4">三、大表优化核心思路</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b55c19e2d19458394b62c22bd45888f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=6wrkrg6uEw3UZbEpwqNSJrfN560%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>表设计层</strong>：从源头减少数据冗余，合理设计表结构和索引，避免数据过度堆积；</li>
<li><strong>查询与索引层</strong>：提升查询效率，减少无效数据扫描，降低索引维护成本；</li>
<li><strong>架构和运维层</strong>：通过分库分表、读写分离、数据归档等方式，分散单表压力，提升系统并发能力。</li>
</ul>
<h2 data-id="heading-5">四、表设计字段优化 (从源头上避免大表问题)</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d136aa98af10476dac5c56ea277ffd40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=RqwvRi31DwllPv8f9WooEHzAHIU%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li>优先使用占用空间小的字段类型。例如，存储用户ID时，若范围允许，使用INT（4字节）而非BIGINT（8字节）；</li>
<li>存储状态、性别时，使用TINYINT（1字节）而非VARCHAR；</li>
<li>使用整数或枚举代替字符串类型；</li>
<li>尽量使用多时区 / 全球化的TIMESTAMP（4字节）而非DATETIME（8字节），同时TIMESTAMP具有自动赋值以及⾃自动更新的特性；</li>
<li>单表不要有太多字段，建议在30个以内；</li>
<li>避免使用NULL字段，对于非必填字段，设置合理的默认值，避免大量NULL值存储。MySQL对NULL值的存储和查询效率较低，且NULL值无法参与索引；</li>
<li>避免使用大字段，尽量避免在核心业务表中使用TEXT、BLOB等大字段。若必须存储（如用户头像、富文本内容），可将大字段拆分到单独的附属表中，核心表仅存储关联ID，减少核心表的数据行大小，提升查询时的磁盘I/O效率；</li>
</ol>
<h2 data-id="heading-6">五、索引优化</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0afbc83784fa4cb9b4cd86326ea2994e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=tKrWxHbLXcGw1X34BxxXwvcTeec%3D" alt="image.png" loading="lazy"/></p>
<ol>
<li><strong>遵循最左匹配原则</strong>，创建联合索引时，将查询频率高、区分度高的字段放在前面。例如，业务中频繁查询“用户ID+订单状态”，则联合索引应为（user_id, order_status），而非（order_status, user_id）；</li>
<li><strong>控制索引数量</strong>，单表索引数量建议不超过5个，过多的索引会导致INSERT、UPDATE、DELETE操作时需要同步维护多个索引，严重降低写入性能。对于大表，每增加一个索引，写入耗时可能会显著增加；</li>
<li><strong>使用覆盖索引</strong>，针对频繁的查询场景，创建覆盖索引，避免回表查询。例如，查询“用户ID、订单金额、订单时间”时，创建联合索引（user_id, order_amount, order_time），查询时可直接从索引中获取所需数据，无需访问主键索引；</li>
<li><strong>避免无效索引</strong>，删除未使用或重复的索引。可通过MySQL的慢查询日志、sys.schema_unused_indexes视图（MySQL 8.0+）统计索引使用情况，清理无效索引；避免创建与主键索引重复的索引（如主键为id，再创建索引（id））；</li>
<li><strong>考虑分区索引</strong>，对于分区表，索引会按分区创建，每个分区的索引体积更小，查询时只需扫描对应分区的索引，提升查询效率。</li>
<li><strong>避免没必要索引</strong>，值分布很稀少的字段不适合建索引，例如"性别"这种只有两三个值的字段；</li>
<li><strong>合理创建联合索引（避免冗余</strong>），如(a,b,c) 相当于 (a) 、(a,b) 、(a,b,c)；</li>
<li><strong>根据查询有针对性创建索引</strong>，考虑在WHERE和ORDER BY命令上涉及的列建立索引，可根据EXPLAIN来查看是否用了索引还是全表扫描；</li>
</ol>
<h2 data-id="heading-7">六、查询SQL优化</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d605d3311d5405c9e0d2b4f4d0af175~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=%2FpU9I61Lui847swqvXbTKZqAjmI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">①避免全表扫描</h3>
<ul>
<li><strong>确保查询走索引</strong>：避免在查询条件中对索引字段进行函数操作（如SUBSTR、DATE_FORMAT）、隐式类型转换（如将VARCHAR类型的字段与INT值比较），这些操作会导致索引失效，触发全表扫描。例如，避免“WHERE SUBSTR(user_phone, 1, 3) = '138'”，可改为“WHERE user_phone LIKE '138%'”（前提是user_phone字段有索引）；</li>
<li>**避免使用模糊查询前缀%：<strong>模糊查询“LIKE '%xxx'”或“LIKE '%xxx%'”会导致索引失效，触发全表扫描。若业务需模糊查询，可考虑使</strong>用Elasticsearch等搜索引擎替代，或通过业务调整改为“LIKE 'xxx%'”；</li>
<li>**避免使用OR条件（无索引时）：当OR条件中的字段无索引时，会触发全表扫描。可将OR改为UNION ALL（若结果无重复），且确保每个查询分支都走索引。例如，“WHERE user_id = 1 OR order_id = 100”可改为“(SELECT * FROM order WHERE user_id = 1) UNION ALL (SELECT * FROM order WHERE order_id = 100)”。</li>
</ul>
<h3 data-id="heading-9">②优化查询语句结构</h3>
<ul>
<li><strong>只查询所需字段</strong>：避免使用SELECT *，只查询业务需要的字段。一方面减少数据传输量，另一方面若查询字段可通过覆盖索引获取，可避免回</li>
<li><strong>控制JOIN表数量</strong>：JOIN表数量越多，查询复杂度越高，性能越差。大表查询中，JOIN表数量建议不超过3个。对于复杂查询，可通过分步骤查询、中间表存储结果等方式简化；</li>
<li><strong>避免使用子查询（尤其是相关子查询）</strong>：相关子查询会导致MySQL重复执行子查询语句，效率极低。可将子查询改为JOIN查询，或通过临时表存储子查询结果；</li>
<li><strong>合理使用LIMIT</strong>：对于分页查询，使用LIMIT控制返回结果数量。但需注意，当分页页码较大时（如LIMIT 100000, 20），MySQL会扫描前100020条数据再丢弃前100000条，效率较低。可通过“索引+主键”优化，例如“WHERE id &gt; 100000 LIMIT 20”（前提是id为自增主键，且查询条件可基于id过滤）。</li>
</ul>
<h3 data-id="heading-10">③优化事务和锁</h3>
<ul>
<li><strong>控制事务粒度</strong>：避免长事务，长事务会占用锁资源，导致其他操作出现锁等待。大表操作中，尽量将事务拆分为短事务，只包含必要的SQL语句；</li>
<li><strong>使用合理的隔离级别</strong>：根据业务需求选择最低的隔离级别。例如，若业务允许脏读，可使用READ UNCOMMITTED；大多数业务可使用READ COMMITTED，避免REPEATABLE READ带来的间隙锁问题，减少锁等待；</li>
<li><strong>避免行锁升级为表锁</strong>：MySQL中，若查询条件未走索引，会触发全表扫描，此时行锁会升级为表锁，导致其他操作无法并发执行。需确保更新、删除操作的查询条件走索引，避免表锁。</li>
</ul>
<h3 data-id="heading-11">④其他</h3>
<ul>
<li>不做列运算：SELECT id WHERE age + 1 = 10，任何对列的操作都将导致表扫描，它包括数据库教程函数、计算表达式等等，查询时要尽可能将操作移至等号右边；</li>
<li>SQL语句尽可能简单：一条SQL只能在一个cpu运算；大语句拆小语句，减少锁时间；一条大SQL可以堵死整个库；</li>
<li>OR改写成IN：OR的效率是n级别，IN的效率是log(n)级别，in的个数建议控制在200以内；</li>
<li>不用函数和触发器，在应用程序实现；</li>
<li>模糊查询避免左模糊%xxx式查询；</li>
<li>使用同类型进行比较，比如用'123'和'123'比，123和123比；</li>
<li>尽量避免在WHERE子句中使用!=或&lt;&gt;操作符，否则将引擎放弃使用索引而进行全表扫描；</li>
<li>对于连续数值，使用BETWEEN不用IN：SELECT id FROM t WHERE num BETWEEN 1 AND 5；</li>
<li>列表数据不要拿全表，要使用LIMIT来分页，每页数量也不要太大。</li>
</ul>
<h2 data-id="heading-12">七、数据归档(减少活跃数据量)</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79c2e99d0edb402c89f89e19c933feca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=aSWXigt4xEoEE8PvJ4axdZHfWTE%3D" alt="image.png" loading="lazy"/></p>
<p>数据归档是将历史数据迁移到单独的存储介质或表中，减少核心表的活跃数据量。 大表中往往存在大量历史数据（如3个月前的订单、1年前的日志），这些数据访问频率极低，但占用大量存储空间，影响活跃数据的查询和写入性能。</p>
<ul>
<li>
<p>确定归档条件：根据业务场景确定归档的时间范围或数据状态。例如，订单表中归档3个月前的已完成订单；日志表中归档1年前的所有日志；</p>
</li>
<li>
<p><strong>选择归档目标</strong></p>
<ul>
<li>同库不同表：将历史数据迁移到同库的归档表中（如order表归档到order_hist_202401），便于后续查询历史数据时直接关联；</li>
<li>异库存储：将历史数据迁移到独立的归档数据库（如MySQL从库、Hive、ClickHouse等），减少对核心库的资源占用；对于海量历史数据，可使用低成本的存储介质（如对象存储）；</li>
<li>冷热数据分离：核心表只保留热点数据（如近1个月），历史数据迁移到冷存储，查询历史数据时通过专门的服务或接口访问。</li>
</ul>
</li>
<li>
<p><strong>归档执行方式</strong></p>
<ul>
<li>定时任务归档：通过xxljob、crontab、Airflow等工具定时执行归档脚本，采用“分页查询+批量插入+批量删除”的方式，避免一次性操作大量数据导致锁等待或事务超时；</li>
<li>在线归档工具：使用pt-archiver（Percona Toolkit）等专业工具，支持增量归档、并行归档，且对业务影响较小。例如，pt-archiver可通过--limit参数控制每次归档的行数，--sleep参数控制归档间隔，减少对核心表的性能影响；</li>
</ul>
</li>
</ul>
<h2 data-id="heading-13">八、分区表设计 （拆分数据到多个物理分区）</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/842fb4a2a8f548d78a5514c502f356ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=4pCeYmxE3raYMUCwJWkCHj6xDYw%3D" alt="image.png" loading="lazy"/></p>
<p>分区表是MySQL提供的一种表级优化方案，将一个大表在逻辑上拆分为多个小表，物理上存储为多个独立的文件。查询时，MySQL只需扫描对应的分区，无需扫描全表，从而提升查询效率；同时，分区表便于数据归档（直接删除整个分区）、备份恢复（单独备份某个分区）。</p>
<ul>
<li>
<p><strong>分区类型选择</strong></p>
<ul>
<li>MySQL支持多种分区类型，需根据业务场景选择：
<ul>
<li>范围分区（RANGE Partition）：按连续的范围划分分区，适用于按时间、ID等有序字段拆分的场景（如订单表、日志表）。例如，订单表按创建时间分区，每个分区存储1个月的数据；用户表按用户ID分区，每个分区存储100万用户的数据。范围分区是最常用的分区类型，便于数据归档（直接删除旧分区）；</li>
<li>列表分区（List Partition）：按离散的值列表划分分区，适用于数据状态固定的场景（如订单状态、用户所属地区）。例如，订单表按订单状态分区，分为“待支付”“已完成”“已取消”三个分区， 核销表可以按核销状态分区，分为“未核销”、“已核销”、“已退款”；</li>
<li>哈希分区（Hash Partition）：按字段的哈希值划分分区，适用于数据均匀分布、无明显范围或列表特征的场景。例如，将用户表按用户ID哈希分区，确保每个分区的数据量相对均衡；但哈希分区不便于数据归档；</li>
<li>复合分布（Composite Partition）：结合两种分区类型（如RANGE-HASH、RANGE-LIST），适用于复杂场景。例如，订单表先按创建时间范围分区，每个范围分区内再按订单状态列表分区。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>分区表使用注意事项</strong></p>
<ul>
<li>分区键选择：分区键需与查询条件高度相关，确保查询时能精准定位到少数几个分区（即“分区裁剪”）。例如，若订单表的查询多基于创建时间，则分区键选择创建时间；若查询多基于用户ID，则分区键选择用户ID；</li>
<li>控制分区数量：分区数量并非越多越好，过多的分区会增加MySQL的元数据管理成本，导致查询时分区裁剪效率下降。一般建议单表分区数量不超过100个；</li>
<li>避免跨分区查询：跨分区查询（如查询多个分区的数据）会导致MySQL扫描多个分区，性能可能与非分区表相当甚至更差。需通过业务优化避免跨分区查询，或通过索引优化提升跨分区查询效率；</li>
<li>分区表限制：MySQL 5.7及以下版本中，分区表不支持外键；某些存储引擎（如MyISAM）对分区表的支持有限，建议使用InnoDB引擎；分区表的索引是按分区创建的，需确保每个分区的索引设计合理。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-14">九、分库分表 (架构级拆分突破单库单表限制)</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f93e09c6261f440cb107a7cd5cf42968~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=Xmr9Vg8C5JYPppyoOE2md5X36TE%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<p><strong>核心概念</strong></p>
<ul>
<li>水平拆分：将同一个表的数据按行拆分到多个表中，每个表的结构相同。例如，将订单表按用户ID哈希拆分到10个表中，每个表存储10%的用户订单数据。水平拆分是分库分表的主流方式，能有效突破单表数据量限制；</li>
<li>垂直拆分：将同一个表的数据按列拆分到多个表中，每个表存储部分字段。例如，将用户表拆分为用户基本信息表（存储ID、姓名、手机号等核心字段）和用户详情表（存储地址、简介等大字段），核心表数据量小，查询效率高；</li>
<li>分库：将拆分后的表分布到多个数据库中，避免单库的CPU、内存、磁盘I/O资源瓶颈。例如，将10个订单分表分布到2个数据库中，每个数据库存储5个分表；</li>
<li>分片键：用于拆分数据的字段（如用户ID、订单ID、创建时间），分片键的选择直接影响分库分表的效果，需确保数据均匀分布、查询能精准定位分片。</li>
</ul>
</li>
<li>
<p><strong>分库分表策略</strong></p>
</li>
<li>
<p>水平拆分</p>
<ul>
<li>范围拆分：按分片键的范围拆分数据，如按订单创建时间拆分，每个分片存储1个月的数据；按用户ID拆分，每个分片存储100万用户的数据。范围拆分便于数据归档（直接删除旧分片），但可能出现数据热点（如最新月份的订单分片访问频率极高）；</li>
<li>哈希拆分：按分片键的哈希值取模拆分数据，如按用户ID % 10拆分到10个分片。哈希拆分能确保数据均匀分布，避免热点分片，但不便于数据归档，查询历史数据时可能需要访问多个分片；</li>
<li>一致性哈希拆分：在哈希拆分的基础上，通过一致性哈希算法减少分片扩容时的数据迁移量。适用于业务数据量持续增长、需要频繁扩容的场景。</li>
</ul>
</li>
<li>
<p>垂直拆分</p>
<ul>
<li>按字段访问频率拆分：将高频访问的核心字段（如用户ID、姓名、订单金额）放在主表，低频访问的字段（如用户简介、订单备注）放在从表；</li>
<li>按字段类型拆分：将大字段（TEXT、BLOB）拆分到单独的表中，主表仅存储关联ID，减少主表的数据行大小，提升查询效率。</li>
</ul>
</li>
<li>
<p><strong>分库分表实现方式</strong></p>
<ul>
<li>
<p>客户端分片</p>
<ul>
<li>在应用程序中直接实现分库分表逻辑，通过代码控制数据的写入和查询分片。优点是灵活性高，缺点是开发成本高，需维护大量分片逻辑代码，后续扩容、迁移困难；</li>
</ul>
</li>
<li>
<p>中间件分片</p>
<ul>
<li>使用专业的分库分表中间件（如Sharding-JDBC、MyCat、TDSQL），中间件封装了分片逻辑，应用程序通过中间件访问数据库，无需关注分片细节。优点是开发成本低、易于维护和扩容，是目前主流的实现方式。</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>如何保证分布式数据库架构中全局唯一ID的生成</strong>？</p>
<ul>
<li>
<p>分布式ID生成的要求和核心难点</p>
<ul>
<li>(1) 全局唯一性：保持生成的ID全局唯一，在任何情况下也不会出现重复的值（如防止时间回拔，时钟周期问题）；</li>
<li>(2) 趋势递增：保证下一个ID一定大于上一个ID，例如事务版本号、IM聊天中的增量消息、排序等特殊需求；</li>
<li>(3) 高性能：ID的需求场景多，中心化生成组件后，需要高并发处理，以接近 0ms的响应大规模并发执行；</li>
<li>(4) 高可用： 作为ID的生产源头，需要100%可用，当接入的业务系统多的时候，很难调整出各方都可接受的停机发布窗口，只能接受无损发布；</li>
<li>(5) 易接入：作为逻辑上简单的分布式ID要推广使用，必须强调开箱即用，容易上手；</li>
</ul>
</li>
<li>
<p>大厂自研分布式ID框架实现</p>
<ul>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2751-1-1.html" target="_blank" title="http://www.52im.net/thread-2751-1-1.html" ref="nofollow noopener noreferrer">美团分布式ID生成系统Leaf(对Snowflake算法进行了改进)</a>
<ul>
<li>Leaf-segment方案：可生成全局唯一、全局有序的ID</li>
<li>Leaf-snowflake方案：可生成全局唯一、局部有序的ID</li>
</ul>
</li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-2953-1-1.html" target="_blank" title="http://www.52im.net/thread-2953-1-1.html" ref="nofollow noopener noreferrer">百度分布式ID生成器UidGenerator(对Snowflake算法进行了改进)</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-3129-1-1.html" target="_blank" title="http://www.52im.net/thread-3129-1-1.html" ref="nofollow noopener noreferrer">滴滴的高性能ID生成器(Tinyid)</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.52im.net%2Fthread-4378-1-1.html" target="_blank" title="http://www.52im.net/thread-4378-1-1.html" ref="nofollow noopener noreferrer">vivo的自研分布式ID服务</a></li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>各大框架对比</strong></p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7e1593155ab42d7bda83a9295eeea18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVRfc3Vuc2hpbmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767354999&amp;x-signature=h9h72Zd7HRjUj%2FBItt0B522HlM0%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>
<hr/>
<ul>
<li>分片键选择至关重要：分片键需满足“数据均匀分布”和“查询精准定位”两个核心要求。例如，订单表若按订单ID哈希拆分，查询“某用户的所有订单”时会需要访问所有分片，效率极低；此时应选择用户ID作为分片键，查询时可直接定位到用户所属的分片；</li>
<li>避免分布式事务：分库分表后，跨分片的操作会产生分布式事务，分布式事务实现复杂、性能差。需通过业务优化避免跨分片操作，或采用最终一致性方案（如本地消息表、事务消息）替代分布式事务；</li>
<li>考虑扩容方案：拆分时需预留扩容空间，避免后续扩容时大量数据迁移。例如，采用一致性哈希拆分，或按“2的幂次”拆分（如初始拆分为8个分片，后续可扩容为16个）；</li>
<li>运维复杂度提升：分库分表后，数据库集群的运维难度显著增加，需关注分片的健康状态、数据一致性、备份恢复等问题。可借助中间件的监控功能，或使用专业的运维工具（如Prometheus、Grafana）进行监控。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-15">十、其他优化方案</h2>
<ul>
<li>
<p><strong>读写分离</strong></p>
<ul>
<li>对于读多写少的大表场景（如商品表、用户表），可采用读写分离架构：主库负责写入操作（INSERT、UPDATE、DELETE），从库负责读取操作（SELECT），通过主从复制同步数据。读写分离能分散单库的读写压力，提升查询性能，需注意主从复制的延迟问题，对于实时性要求高的查询，需路由到主库。</li>
</ul>
</li>
<li>
<p><strong>数据库参数优化(通过优化MySQ的配置参数，提升数据库性能)</strong></p>
<ul>
<li>调整缓冲池大小（innodb_buffer_pool_size）：建议设置为服务器物理内存的50%-70%，提升数据和索引的缓存命中率；</li>
<li>调整日志相关参数（innodb_log_file_size、innodb_log_buffer_size）：增大日志文件大小，减少日志刷盘次数；增大日志缓冲区，减少磁盘I/O；</li>
<li>调整连接数参数（max_connections、wait_timeout）：根据业务需求设置合理的最大连接数，避免连接耗尽；设置合理的连接超时时间，释放空闲连接；</li>
</ul>
</li>
<li>
<p><strong>硬件与存储优化，硬件和存储是数据库性能的基础，大表场景下需选择高性能的硬件</strong></p>
<ul>
<li>使用SSD硬盘：SSD的读写速度远高于机械硬盘，能显著提升大表的磁盘I/O效率；</li>
<li>提升CPU和内存配置：大表查询和索引维护需要大量CPU和内存资源，选择多核CPU、大容量内存的服务器；</li>
<li>使用RAID阵列：通过RAID 0、RAID 10等阵列方式，提升磁盘的读写性能和可靠性。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-16">十一、总结</h2>
<p>MySQL大表优化是一个系统性工程，需从表设计、查询、索引、数据归档、分区表、分库分表等多个维度综合考量，核心是“减少数据量、降低访问成本、分散压力”。优化过程中应遵循“先易后难、先软后硬”的原则，优先采用低成本、低风险的方案，再根据业务需求逐步升级到架构级优化。大厂的实战案例表明，优化方案需紧密结合业务场景：电商订单表适合分库分表+数据归档，日志表适合分区表+冷热分离，商品表适合垂直拆分+读写分离+缓存。同时，优化后的监控与运维至关重要，能确保系统长期稳定运行。好了，今天的分享就到此结束了，如果文章对你有所帮助，欢迎：<em><strong>点赞👍+评论💬+收藏❤</strong></em>，我是：<strong><code>IT_sunshine</code></strong> ，我们下期见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL 事务全解析：从 ACID 特性到实战落地（部门 - 员工场景）]]></title>    <link>https://juejin.cn/post/7588086766235271206</link>    <guid>https://juejin.cn/post/7588086766235271206</guid>    <pubDate>2025-12-26T12:08:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766235271206" data-draft-id="7587997893987549211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL 事务全解析：从 ACID 特性到实战落地（部门 - 员工场景）"/> <meta itemprop="keywords" content="后端,数据库"/> <meta itemprop="datePublished" content="2025-12-26T12:08:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员根根"/> <meta itemprop="url" content="https://juejin.cn/user/555679166786139"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL 事务全解析：从 ACID 特性到实战落地（部门 - 员工场景）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/555679166786139/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员根根
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T12:08:15.000Z" title="Fri Dec 26 2025 12:08:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在企业级系统开发中，“数据一致性” 是核心诉求 —— 比如员工入职时，“新增员工记录” 和 “更新部门人数” 这两个操作必须同时成功或同时失败；再比如财务转账时，“扣款” 和 “收款” 也不能只执行其一。而保证这种 “要么全成、要么全败” 的核心技术，就是<strong>数据库事务（Transaction）</strong> 。本文将以 “部门 - 员工” 这一经典业务场景为核心，从事务的核心价值、ACID 特性、隔离级别，到 JDBC/MyBatis/Spring 中的实战落地，帮你彻底掌握事务的使用与优化。</p>
<h2 data-id="heading-0">一、事务的核心价值：为什么离不开事务？</h2>
<p>先看一个典型的业务场景：</p>
<blockquote>
<p>企业招聘新员工 “钱八” 入职研发部，需要执行两个操作：</p>
<ol>
<li>向<code>emp</code>表插入 “钱八” 的员工记录；</li>
<li>向<code>dept</code>表更新研发部的员工数量（<code>emp_count</code>字段），加 1。</li>
</ol>
</blockquote>
<p>如果没有事务控制，可能出现两种异常：</p>
<ul>
<li>场景 1：插入员工记录成功，但更新部门人数失败 → 研发部人数少算 1 人，数据不一致；</li>
<li>场景 2：更新部门人数成功，但插入员工记录失败 → 研发部人数多算 1 人，数据错误。</li>
</ul>
<p>而事务的核心作用，就是<strong>将一组操作封装为一个 “不可分割的执行单元”</strong> ，确保单元内的所有操作要么全部执行成功，要么全部回滚（撤销），从根本上避免数据不一致问题。</p>
<h2 data-id="heading-1">二、事务的核心特性：ACID 原则</h2>
<p>事务的本质是遵循<strong>ACID 四大特性</strong>的一组数据库操作，这是事务的核心定义，我们结合 “部门 - 员工” 场景逐一拆解：</p>



































<table><thead><tr><th>特性</th><th>英文全称</th><th>核心定义</th><th>部门 - 员工场景示例</th></tr></thead><tbody><tr><td>原子性（A）</td><td>Atomicity</td><td>事务中的操作要么全部执行成功，要么全部回滚，不存在 “部分成功”</td><td>入职操作：插入员工 + 更新部门人数，要么都成，要么都回滚（比如员工姓名重复导致插入失败，部门人数也不更新）</td></tr><tr><td>一致性（C）</td><td>Consistency</td><td>事务执行前后，数据库的 “业务规则” 保持一致（如部门人数 = 该部门员工数）</td><td>执行前研发部人数是 2，执行后必须是 3（成功）或仍为 2（失败），不会出现 “员工新增但人数不变” 的不一致</td></tr><tr><td>隔离性（I）</td><td>Isolation</td><td>多个事务并发执行时，彼此隔离、互不干扰，避免并发导致的数据错误</td><td>管理员 A 新增员工、管理员 B 统计部门人数，两个事务并发执行时，B 不会读到 A “未提交的中间数据”</td></tr><tr><td>持久性（D）</td><td>Durability</td><td>事务提交后，修改会永久保存到数据库，即使数据库崩溃也不会丢失</td><td>入职操作提交后，“钱八” 的员工记录和研发部人数的修改会永久保存，重启数据库后数据仍有效</td></tr></tbody></table>
<p><strong>关键说明</strong>：ACID 是事务的 “契约”，其中<strong>原子性、一致性、持久性</strong>由数据库的 “重做日志（Redo Log）” 和 “回滚日志（Undo Log）” 保证，<strong>隔离性</strong>由事务隔离级别和锁机制保证。</p>
<h2 data-id="heading-2">三、事务的隔离级别：解决并发事务冲突</h2>
<p>在多用户并发操作数据库时，若没有隔离性控制，会出现<strong>脏读、不可重复读、幻读</strong>三类问题。MySQL 通过 “事务隔离级别” 来平衡 “隔离性” 和 “并发性能”，共定义了 4 个隔离级别（从低到高）：</p>
<h4 data-id="heading-3">1. 四类并发问题（先理解问题，再看解决方案）</h4>

























<table><thead><tr><th>问题类型</th><th>定义</th><th>部门 - 员工场景示例</th></tr></thead><tbody><tr><td>脏读（Dirty Read）</td><td>一个事务读取到另一个事务 “未提交” 的修改数据</td><td>事务 A 新增员工 “钱八” 但未提交，事务 B 查询研发部人数为 3；事务 A 回滚后，事务 B 读到的 “3” 就是 “脏数据”</td></tr><tr><td>不可重复读（Non-repeatable Read）</td><td>一个事务内多次读取同一数据，结果不一致（被其他事务 “修改并提交”）</td><td>事务 B 第一次查研发部人数为 2，事务 A 新增员工并提交，事务 B 再次查询人数为 3，两次结果不同</td></tr><tr><td>幻读（Phantom Read）</td><td>一个事务内多次执行同一查询，结果集行数不一致（被其他事务 “插入 / 删除并提交”）</td><td>事务 B 查询 “薪资&gt; 15000 的研发部员工” 有 2 人，事务 A 新增 1 名高薪员工并提交，事务 B 再次查询变为 3 人，如同 “出现幻觉”</td></tr></tbody></table>
<h4 data-id="heading-4">2. 四种隔离级别（解决并发问题的不同程度）</h4>
<p>MySQL 默认隔离级别为<code>REPEATABLE READ（可重复读）</code>，也是生产环境最常用的级别。</p>








































<table><thead><tr><th>隔离级别</th><th>英文全称</th><th>解决的问题</th><th>允许的问题</th><th>性能</th></tr></thead><tbody><tr><td>读未提交</td><td>READ UNCOMMITTED</td><td>无（最低隔离）</td><td>脏读、不可重复读、幻读</td><td>最高</td></tr><tr><td>读已提交</td><td>READ COMMITTED</td><td>脏读</td><td>不可重复读、幻读</td><td>较高</td></tr><tr><td>可重复读（默认）</td><td>REPEATABLE READ</td><td>脏读、不可重复读</td><td>幻读（MySQL 已通过 MVCC 解决）</td><td>中等</td></tr><tr><td>串行化</td><td>SERIALIZABLE</td><td>所有问题（完全隔离）</td><td>无（并发事务串行执行）</td><td>最低</td></tr></tbody></table>
<p><strong>关键说明</strong>：</p>
<ul>
<li>MySQL 的<code>REPEATABLE READ</code>通过 “多版本并发控制（MVCC）” 额外解决了幻读问题，是比标准定义更优的实现；</li>
<li>隔离级别越高，并发性能越低，需根据业务场景选择（如财务系统用<code>SERIALIZABLE</code>，普通业务用<code>REPEATABLE READ</code>）。</li>
</ul>
<h4 data-id="heading-5">3. 查看 / 设置隔离级别</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看当前会话隔离级别</span>
<span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@SESSION</span>.tx_isolation;
<span class="hljs-comment">-- 查看全局隔离级别</span>
<span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@GLOBAL</span>.tx_isolation;

<span class="hljs-comment">-- 设置当前会话隔离级别为读已提交</span>
<span class="hljs-keyword">SET</span> SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
<span class="hljs-comment">-- 设置全局隔离级别为可重复读（默认）</span>
<span class="hljs-keyword">SET</span> <span class="hljs-keyword">GLOBAL</span> TRANSACTION ISOLATION LEVEL REPEATABLE READ;
</code></pre>
<h2 data-id="heading-6">四、事务的基础操作语法（MySQL 实战）</h2>
<h4 data-id="heading-7">1. 核心语法</h4>
<p>MySQL 默认开启 “自动提交（AUTOCOMMIT）”，即每条 SQL 语句都是一个独立事务。需手动关闭自动提交或显式开启事务。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 关闭自动提交（当前会话有效）</span>
<span class="hljs-keyword">SET</span> AUTOCOMMIT <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

<span class="hljs-comment">-- 2. 开启事务（显式声明事务开始）</span>
<span class="hljs-keyword">BEGIN</span>; <span class="hljs-comment">-- 或 START TRANSACTION;</span>

<span class="hljs-comment">-- 3. 执行事务内的操作（如插入员工+更新部门人数）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `emp` (emp_name, emp_salary, hire_date, dept_id) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'钱八'</span>, <span class="hljs-number">14000.00</span>, <span class="hljs-string">'2024-01-01'</span>, <span class="hljs-number">1</span>);

<span class="hljs-keyword">UPDATE</span> `dept` <span class="hljs-keyword">SET</span> emp_count <span class="hljs-operator">=</span> emp_count <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- 4. 提交事务（所有操作生效，持久化到数据库）</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 4. 回滚事务（撤销所有操作，回到事务开始前的状态）</span>
<span class="hljs-comment">-- ROLLBACK;</span>

<span class="hljs-comment">-- 5. 保存点（可选，回滚到指定位置，而非整个事务）</span>
<span class="hljs-keyword">SAVEPOINT</span> sp1; <span class="hljs-comment">-- 设置保存点</span>
<span class="hljs-keyword">ROLLBACK</span> <span class="hljs-keyword">TO</span> sp1; <span class="hljs-comment">-- 回滚到保存点</span>
</code></pre>
<h4 data-id="heading-8">2. 实战案例（部门 - 员工入职）</h4>
<p>先给<code>dept</code>表新增<code>emp_count</code>字段（用于统计部门人数）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> `dept` <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> `emp_count` <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'部门员工数'</span>;
<span class="hljs-comment">-- 初始化现有部门人数</span>
<span class="hljs-keyword">UPDATE</span> `dept` <span class="hljs-keyword">SET</span> emp_count <span class="hljs-operator">=</span> <span class="hljs-number">2</span> <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">-- 研发部2人</span>
<span class="hljs-keyword">UPDATE</span> `dept` <span class="hljs-keyword">SET</span> emp_count <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">2</span>; <span class="hljs-comment">-- 人事部1人</span>
<span class="hljs-keyword">UPDATE</span> `dept` <span class="hljs-keyword">SET</span> emp_count <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">3</span>; <span class="hljs-comment">-- 财务部1人</span>
<span class="hljs-keyword">UPDATE</span> `dept` <span class="hljs-keyword">SET</span> emp_count <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">4</span>; <span class="hljs-comment">-- 市场部0人</span>
</code></pre>
<p>执行带事务的入职操作：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 步骤1：开启事务</span>
<span class="hljs-keyword">BEGIN</span>;

<span class="hljs-comment">-- 步骤2：执行操作1：插入新员工</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `emp` (emp_name, emp_salary, hire_date, dept_id, manager_id) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'钱八'</span>, <span class="hljs-number">14000.00</span>, <span class="hljs-string">'2024-01-01'</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

<span class="hljs-comment">-- 步骤3：执行操作2：更新研发部人数</span>
<span class="hljs-keyword">UPDATE</span> `dept` <span class="hljs-keyword">SET</span> emp_count <span class="hljs-operator">=</span> emp_count <span class="hljs-operator">+</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- 步骤4：验证数据（事务未提交，仅当前会话可见）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> `emp` <span class="hljs-keyword">WHERE</span> emp_name <span class="hljs-operator">=</span> <span class="hljs-string">'钱八'</span>; <span class="hljs-comment">-- 能查到</span>
<span class="hljs-keyword">SELECT</span> emp_count <span class="hljs-keyword">FROM</span> `dept` <span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">-- 3</span>

<span class="hljs-comment">-- 步骤5：提交事务（数据持久化）</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 若操作失败，执行回滚：ROLLBACK;</span>
</code></pre>
<h2 data-id="heading-9">五、实战落地：不同开发场景下的事务使用</h2>
<h4 data-id="heading-10">1. 原生 JDBC 中的事务控制</h4>
<p>JDBC 默认也是自动提交事务，需手动关闭自动提交，通过<code>Connection</code>对象控制事务：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.sql.Connection;
<span class="hljs-keyword">import</span> java.sql.DriverManager;
<span class="hljs-keyword">import</span> java.sql.PreparedStatement;
<span class="hljs-keyword">import</span> java.sql.SQLException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcTransactionDemo</span> {
    <span class="hljs-comment">// 数据库连接信息</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">URL</span> <span class="hljs-operator">=</span> <span class="hljs-string">"jdbc:mysql://localhost:3306/test?serverTimezone=UTC&amp;useSSL=false"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">USER</span> <span class="hljs-operator">=</span> <span class="hljs-string">"root"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PASSWORD</span> <span class="hljs-operator">=</span> <span class="hljs-string">"123456"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstmt1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstmt2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 获取连接</span>
            conn = DriverManager.getConnection(URL, USER, PASSWORD);
            <span class="hljs-comment">// 2. 关闭自动提交（开启手动事务）</span>
            conn.setAutoCommit(<span class="hljs-literal">false</span>);

            <span class="hljs-comment">// 3. 操作1：插入新员工</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">sql1</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INSERT INTO emp (emp_name, emp_salary, hire_date, dept_id, manager_id) VALUES (?, ?, ?, ?, ?)"</span>;
            pstmt1 = conn.prepareStatement(sql1);
            pstmt1.setString(<span class="hljs-number">1</span>, <span class="hljs-string">"钱八"</span>);
            pstmt1.setBigDecimal(<span class="hljs-number">2</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.math.BigDecimal(<span class="hljs-string">"14000.00"</span>));
            pstmt1.setDate(<span class="hljs-number">3</span>, java.sql.Date.valueOf(<span class="hljs-string">"2024-01-01"</span>));
            pstmt1.setLong(<span class="hljs-number">4</span>, <span class="hljs-number">1L</span>);
            pstmt1.setLong(<span class="hljs-number">5</span>, <span class="hljs-number">1L</span>);
            pstmt1.executeUpdate();

            <span class="hljs-comment">// 4. 操作2：更新部门人数</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">sql2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"UPDATE dept SET emp_count = emp_count + 1 WHERE dept_id = ?"</span>;
            pstmt2 = conn.prepareStatement(sql2);
            pstmt2.setLong(<span class="hljs-number">1</span>, <span class="hljs-number">1L</span>);
            pstmt2.executeUpdate();

            <span class="hljs-comment">// 5. 提交事务（所有操作生效）</span>
            conn.commit();
            System.out.println(<span class="hljs-string">"入职操作成功，事务提交！"</span>);

        } <span class="hljs-keyword">catch</span> (SQLException e) {
            e.printStackTrace();
            <span class="hljs-comment">// 6. 发生异常，回滚事务</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) {
                    conn.rollback();
                    System.out.println(<span class="hljs-string">"操作失败，事务回滚！"</span>);
                }
            } <span class="hljs-keyword">catch</span> (SQLException ex) {
                ex.printStackTrace();
            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 7. 关闭资源</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">if</span> (pstmt1 != <span class="hljs-literal">null</span>) pstmt1.close();
                <span class="hljs-keyword">if</span> (pstmt2 != <span class="hljs-literal">null</span>) pstmt2.close();
                <span class="hljs-keyword">if</span> (conn != <span class="hljs-literal">null</span>) {
                    conn.setAutoCommit(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 恢复自动提交</span>
                    conn.close();
                }
            } <span class="hljs-keyword">catch</span> (SQLException e) {
                e.printStackTrace();
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-11">2. MyBatis 中的事务控制</h4>
<p>MyBatis 的事务默认由<code>SqlSession</code>控制，默认关闭自动提交，需手动<code>commit()</code>或<code>rollback()</code>：</p>
<h5 data-id="heading-12">（1）编写 Mapper 接口和 XML</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// EmpMapper.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">EmpMapper</span> {
    <span class="hljs-comment">// 插入员工</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">insertEmp</span><span class="hljs-params">(Emp emp)</span>;
}

<span class="hljs-comment">// DeptMapper.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DeptMapper</span> {
    <span class="hljs-comment">// 更新部门人数</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">updateDeptCount</span><span class="hljs-params">(<span class="hljs-meta">@Param("deptId")</span> Long deptId, <span class="hljs-meta">@Param("count")</span> <span class="hljs-type">int</span> count)</span>;
}
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- EmpMapper.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insertEmp"</span>&gt;</span>
    INSERT INTO emp (emp_name, emp_salary, hire_date, dept_id, manager_id)
    VALUES (#{empName}, #{empSalary}, #{hireDate}, #{deptId}, #{managerId})
<span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span>

<span class="hljs-comment">&lt;!-- DeptMapper.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateDeptCount"</span>&gt;</span>
    UPDATE dept SET emp_count = emp_count + #{count} WHERE dept_id = #{deptId}
<span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span>
</code></pre>
<h5 data-id="heading-13">（2）MyBatis 事务实战</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSession;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisTransactionDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 获取SqlSession（默认autoCommit=false）</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> MyBatisUtil.getSqlSession(<span class="hljs-literal">false</span>)) {
            <span class="hljs-comment">// 2. 获取Mapper</span>
            <span class="hljs-type">EmpMapper</span> <span class="hljs-variable">empMapper</span> <span class="hljs-operator">=</span> session.getMapper(EmpMapper.class);
            <span class="hljs-type">DeptMapper</span> <span class="hljs-variable">deptMapper</span> <span class="hljs-operator">=</span> session.getMapper(DeptMapper.class);

            <span class="hljs-comment">// 3. 构建员工对象</span>
            <span class="hljs-type">Emp</span> <span class="hljs-variable">emp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Emp</span>();
            emp.setEmpName(<span class="hljs-string">"钱八"</span>);
            emp.setEmpSalary(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.math.BigDecimal(<span class="hljs-string">"14000.00"</span>));
            emp.setHireDate(java.sql.Date.valueOf(<span class="hljs-string">"2024-01-01"</span>));
            emp.setDeptId(<span class="hljs-number">1L</span>);
            emp.setManagerId(<span class="hljs-number">1L</span>);

            <span class="hljs-comment">// 4. 执行操作</span>
            empMapper.insertEmp(emp);
            deptMapper.updateDeptCount(<span class="hljs-number">1L</span>, <span class="hljs-number">1</span>);

            <span class="hljs-comment">// 5. 提交事务</span>
            session.commit();
            System.out.println(<span class="hljs-string">"入职操作成功，事务提交！"</span>);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            e.printStackTrace();
            <span class="hljs-comment">// 6. 异常回滚（try-with-resources会自动关闭session，触发rollback）</span>
            System.out.println(<span class="hljs-string">"操作失败，事务回滚！"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-14">3. Spring 声明式事务（生产环境首选）</h4>
<p>在 Spring/Spring Boot 项目中，推荐使用<code>@Transactional</code>注解实现 “声明式事务”，无需手动控制<code>commit/rollback</code>，更简洁高效：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmpDeptService</span> {
    <span class="hljs-comment">// 注入Mapper</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EmpMapper empMapper;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DeptMapper deptMapper;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EmpDeptService</span><span class="hljs-params">(EmpMapper empMapper, DeptMapper deptMapper)</span> {
        <span class="hljs-built_in">this</span>.empMapper = empMapper;
        <span class="hljs-built_in">this</span>.deptMapper = deptMapper;
    }

    <span class="hljs-comment">// 声明事务：默认发生RuntimeException时回滚</span>
    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span> <span class="hljs-comment">// 捕获所有异常回滚</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addEmpWithDept</span><span class="hljs-params">(Emp emp)</span> {
        <span class="hljs-comment">// 1. 插入员工</span>
        empMapper.insertEmp(emp);
        <span class="hljs-comment">// 2. 更新部门人数</span>
        deptMapper.updateDeptCount(emp.getDeptId(), <span class="hljs-number">1</span>);
        
        <span class="hljs-comment">// 模拟异常（测试回滚）</span>
        <span class="hljs-comment">// int i = 1 / 0;</span>
    }
}
</code></pre>
<p><strong>关键说明</strong>：</p>
<ul>
<li><code>@Transactional</code>默认只捕获<code>RuntimeException</code>，需通过<code>rollbackFor = Exception.class</code>指定捕获所有异常；</li>
<li>可通过<code>isolation</code>属性设置隔离级别（如<code>isolation = Isolation.REPEATABLE_READ</code>）；</li>
<li>可通过<code>propagation</code>属性设置事务传播行为（如<code>REQUIRED</code>：默认，有事务则加入，无则新建）。</li>
</ul>
<h2 data-id="heading-15">六、事务的常见问题与最佳实践</h2>
<h4 data-id="heading-16">1. 常见问题排查</h4>
<ul>
<li><strong>事务不回滚</strong>：检查是否捕获了异常（未抛出异常则 Spring 不会回滚）、是否是非运行时异常（需指定<code>rollbackFor</code>）、是否调用了非 public 方法（<code>@Transactional</code>仅对 public 方法生效）；</li>
<li><strong>长事务导致性能问题</strong>：长事务会占用数据库连接、持有锁时间长，导致并发下降，需尽量缩小事务范围；</li>
<li><strong>死锁</strong>：多个事务互相等待对方持有的锁，可通过<code>SHOW ENGINE INNODB STATUS</code>查看死锁日志，优化 SQL 执行顺序。</li>
</ul>
<h4 data-id="heading-17">2. 核心最佳实践</h4>
<h5 data-id="heading-18">（1）尽量缩小事务范围</h5>
<p>只将 “必须原子执行” 的操作放入事务，避免无关操作（如日志打印、远程调用）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addEmpWithDept</span><span class="hljs-params">(Emp emp)</span> {
    <span class="hljs-comment">// 事务内：核心操作（必须原子）</span>
    empMapper.insertEmp(emp);
    deptMapper.updateDeptCount(emp.getDeptId(), <span class="hljs-number">1</span>);
}

<span class="hljs-comment">// 事务外：无关操作</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logEmpAdd</span><span class="hljs-params">(Emp emp)</span> {
    logger.info(<span class="hljs-string">"新增员工：{}"</span>, emp.getEmpName());
}
</code></pre>
<h5 data-id="heading-19">（2）避免长事务</h5>
<ul>
<li>不在事务内执行耗时操作（如文件上传、第三方接口调用）；</li>
<li>批量操作可拆分为多个小事务（如每 1000 条数据提交一次）。</li>
</ul>
<h5 data-id="heading-20">（3）合理设置隔离级别</h5>
<ul>
<li>普通业务：使用 MySQL 默认的<code>REPEATABLE READ</code>；</li>
<li>高并发读业务：可降级为<code>READ COMMITTED</code>（提升性能）；</li>
<li>财务 / 核心数据：使用<code>SERIALIZABLE</code>（保证绝对一致性）。</li>
</ul>
<h5 data-id="heading-21">（4）避免手动锁与事务冲突</h5>
<p>尽量利用事务的隔离级别和 MVCC，而非手动加锁（如<code>SELECT ... FOR UPDATE</code>），手动锁易导致死锁。</p>
<h5 data-id="heading-22">（5）监控事务执行情况</h5>
<p>生产环境需监控长事务、死锁、事务失败率，可通过 MySQL 的<code>information_schema</code>表查询：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询当前运行的事务</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.INNODB_TRX;
<span class="hljs-comment">-- 查询死锁日志</span>
<span class="hljs-keyword">SHOW</span> ENGINE INNODB STATUS;
</code></pre>
<h2 data-id="heading-23">七、总结与拓展</h2>
<p>本文以 “部门 - 员工” 场景为核心，讲解了事务的 ACID 特性、隔离级别、基础语法，以及 JDBC/MyBatis/Spring 中的实战落地，核心要点总结：</p>
<ol>
<li>
<p><strong>事务的核心目标</strong>：保证一组操作的原子性，避免数据不一致，遵循 ACID 四大特性；</p>
</li>
<li>
<p><strong>隔离级别选择</strong>：默认用<code>REPEATABLE READ</code>，根据业务场景平衡 “隔离性” 和 “并发性能”；</p>
</li>
<li>
<p><strong>实战建议</strong>：</p>
<ul>
<li>原生 JDBC/MyBatis：手动控制<code>commit/rollback</code>，关闭自动提交；</li>
<li>Spring 项目：优先使用<code>@Transactional</code>声明式事务，简化开发；</li>
</ul>
</li>
<li>
<p><strong>性能优化</strong>：缩小事务范围、避免长事务、监控死锁和长事务。</p>
</li>
</ol>
<h4 data-id="heading-24">拓展方向：</h4>
<ul>
<li><strong>分布式事务</strong>：跨多个数据库 / 服务的事务，可使用 Seata、TCC、SAGA 等方案；</li>
<li><strong>事务日志</strong>：了解 Redo Log/Undo Log 的工作原理，理解事务持久性和回滚的底层实现；</li>
<li><strong>锁机制</strong>：深入学习 InnoDB 的行锁、表锁、间隙锁，理解隔离级别与锁的关系。</li>
</ul>
<p>事务是数据库保证数据一致性的核心机制，也是企业级开发中必须掌握的技能。掌握事务的使用与优化，不仅能避免数据错误，还能提升系统的并发性能和稳定性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Pyinstaller进阶之构建管理大杀器-SPEC文件]]></title>    <link>https://juejin.cn/post/7588086766235369510</link>    <guid>https://juejin.cn/post/7588086766235369510</guid>    <pubDate>2025-12-26T12:35:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766235369510" data-draft-id="7587997893987713051" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Pyinstaller进阶之构建管理大杀器-SPEC文件"/> <meta itemprop="keywords" content="后端,Python,程序员"/> <meta itemprop="datePublished" content="2025-12-26T12:35:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐叔在学习"/> <meta itemprop="url" content="https://juejin.cn/user/4009253326568761"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Pyinstaller进阶之构建管理大杀器-SPEC文件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4009253326568761/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐叔在学习
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T12:35:15.000Z" title="Fri Dec 26 2025 12:35:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>用过 <code>python</code> 打包生成 <code>Windows</code> 可执行程序的同学，大概率都用过大名鼎鼎的 <code>pyinstaller</code> 库吧。</p>
</blockquote>
<p><code>pyinstaller</code> 如果想最终生成的可执行程序，包括只限定的 <code>python</code> 指定模块或者要额外的静态资源文件，写执行指令一般都很长的。</p>
<pre><code class="hljs language-shell" lang="shell">pyinstaller --noconfirm --log-level=WARN \
    --onefile --nowindow \
    --add-data="README:." \
    --add-data="image1.png:img" \
    --add-binary="libfoo.so:lib" \
    --hidden-import=secret1 \
    --hidden-import=secret2 \
    --upx-dir=/usr/local/share
</code></pre>
<p>而有没有一种方式可以更好地进行 <code>pyinstaller</code> 的构建管理呢？看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpyinstaller.org%2Fen%2Fstable%2Fspec-files.html" target="_blank" title="https://pyinstaller.org/en/stable/spec-files.html" ref="nofollow noopener noreferrer">官网文档：Using Spec Files — PyInstaller 6.17.0 documentation</a>，那就是使用 <code>spec</code> 文件进行构建管理。</p>
<p>PS：如果对 pyinstaller 基础使用不太了解，也可以看看小编的往期文章。
<a href="https://juejin.cn/post/7562095444215791631" target="_blank" title="https://juejin.cn/post/7562095444215791631">Pyinstaller - Python桌面应用打包的首选工具 - 掘金</a></p>
<h2 data-id="heading-0">1. spec文件的构成和使用</h2>
<p>Q1：怎么使用 <code>spec</code> 文件呢？很简单：执行 <code>pyinstaller</code> 指令时带上对应的 <code>spec</code> 文件即可。</p>
<pre><code class="hljs language-shell" lang="shell">pyinstaller --clean --noconfirm xxx.spec
</code></pre>
<p>Q2：<code>spec</code> 文件是怎么做到有效构建和管理模块和资源文件的呢？</p>
<p>主要通过下面几个核心的配置步骤：Analysis-分析依赖 → PYZ-打包模块 → EXE-生成exe → [COLLECT-收集文件]</p>
<p>💡温馨提示：单文件模式下，不需要额外进行第四步骤收集文件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a15f5b28c8a5419ba3ab92cec90b88f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZSQ5Y-U5Zyo5a2m5Lmg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405208&amp;x-signature=iCNIkuDSi2hm%2BAUjxVePCugSJEw%3D" alt="" loading="lazy"/></p>
<p>下面具体展开进行介绍。</p>
<hr/>
<h2 data-id="heading-1">2. Analysis 类</h2>
<h3 data-id="heading-2">2.1 作用场景</h3>
<p><strong>依赖分析器</strong>，这是打包过程的核心步骤。它会：</p>
<ul>
<li>分析你的Python脚本</li>
<li>递归查找所有导入的模块</li>
<li>收集所有需要的文件（Python模块、扩展模块、数据文件等）</li>
</ul>
<blockquote>
<p>✍️ 开头说的管理模块和数据文件，就主要在这里进行配置的。</p>
</blockquote>
<h3 data-id="heading-3">2.2 参数配置详解</h3>
<p>这里我用的比较多的就 <code>excludes</code> 、<code>hiddenimports</code> 和 <code>datas</code>，其他默认填写或按照模板即可。</p>
<pre><code class="hljs language-python" lang="python">a = Analysis(
    <span class="hljs-comment"># ============ 必需参数 ============</span>
    scripts=[<span class="hljs-string">'main.py'</span>],  <span class="hljs-comment"># 主脚本列表</span>

    <span class="hljs-comment"># ============ 路径相关 ============</span>
    pathex=[<span class="hljs-string">'/path/to/project'</span>, <span class="hljs-string">'/another/path'</span>],  <span class="hljs-comment"># 模块搜索路径</span>
    hookspath=[<span class="hljs-string">'custom_hooks'</span>],  <span class="hljs-comment"># 自定义hook文件路径</span>
    runtime_hooks=[<span class="hljs-string">'runtime_hooks/hook-qt.py'</span>],  <span class="hljs-comment"># 运行时hook脚本</span>

    <span class="hljs-comment"># ============ 模块处理 ============</span>
    excludes=[                          <span class="hljs-comment"># 排除的模块（减少包体积）</span>
        <span class="hljs-string">'tkinter'</span>,
        <span class="hljs-string">'unittest'</span>,
        <span class="hljs-string">'pydoc'</span>,
        <span class="hljs-string">'pdb'</span>,
        <span class="hljs-string">'matplotlib'</span>
    ],
    hiddenimports=[                     <span class="hljs-comment"># 隐藏导入（动态导入的模块）</span>
        <span class="hljs-string">'PIL._imaging'</span>,
        <span class="hljs-string">'sklearn.utils._weight_vector'</span>,
        <span class="hljs-string">'pandas._libs.tslibs.timedeltas'</span>
    ],
    win_no_prefer_redirects=<span class="hljs-literal">False</span>,      <span class="hljs-comment"># Windows专用：DLL重定向</span>
    win_private_assemblies=<span class="hljs-literal">False</span>,       <span class="hljs-comment"># Windows专用：私有程序集</span>

    <span class="hljs-comment"># ============ 文件收集 ============</span>
    datas=[                            <span class="hljs-comment"># 非Python文件（配置文件、图片等）</span>
        (<span class="hljs-string">'config.json'</span>, <span class="hljs-string">'.'</span>),          <span class="hljs-comment"># (源文件, 目标目录)</span>
        (<span class="hljs-string">'images/*.png'</span>, <span class="hljs-string">'images'</span>),
        (<span class="hljs-string">'data/*.csv'</span>, <span class="hljs-string">'data'</span>)
    ],
    binaries=[                         <span class="hljs-comment"># 二进制文件（.so, .dll等）</span>
        (<span class="hljs-string">'/usr/lib/libssl.so'</span>, <span class="hljs-string">'lib'</span>), <span class="hljs-comment"># (源文件, 目标目录)</span>
        (<span class="hljs-string">'C:/Windows/System32/msvcp140.dll'</span>, <span class="hljs-string">'.'</span>)
    ],

    <span class="hljs-comment"># ============ 高级选项 ============</span>
    cipher=block_cipher,               <span class="hljs-comment"># 加密字节码的密钥</span>
    noarchive=<span class="hljs-literal">False</span>,                   <span class="hljs-comment"># True=不解压到临时目录</span>
    optimize=<span class="hljs-number">0</span>,                        <span class="hljs-comment"># 字节码优化级别：-1, 0, 1, 2</span>
    upx=<span class="hljs-literal">False</span>,                         <span class="hljs-comment"># 是否用UPX压缩（已弃用，在EXE中设置）</span>
    upx_exclude=[],                    <span class="hljs-comment"># 排除UPX压缩的文件</span>
    strip=<span class="hljs-literal">False</span>,                       <span class="hljs-comment"># 是否去除符号信息</span>
    prefetch=<span class="hljs-literal">False</span>,                    <span class="hljs-comment"># 预取模式（实验性）</span>
    name=<span class="hljs-literal">None</span>,                         <span class="hljs-comment"># 分析名称（用于多程序打包）</span>
)
</code></pre>
<h3 data-id="heading-4">2.3 实际示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 复杂的Analysis配置</span>
block_cipher = pyi_crypto.PyiBlockCipher(key=<span class="hljs-string">'my-secret-key'</span>)

a = Analysis(
    [<span class="hljs-string">'app_main.py'</span>, <span class="hljs-string">'helper.py'</span>],  <span class="hljs-comment"># 多个入口文件</span>
    pathex=[os.getcwd(), <span class="hljs-string">'../shared_libs'</span>],
    binaries=[
        (<span class="hljs-string">'lib/ffmpeg.exe'</span>, <span class="hljs-string">'bin'</span>),
        (<span class="hljs-string">'lib/iconv.dll'</span>, <span class="hljs-string">'bin'</span>)
    ],
    datas=[
        (<span class="hljs-string">'ui/*.ui'</span>, <span class="hljs-string">'ui'</span>),           <span class="hljs-comment"># Qt Designer文件</span>
        (<span class="hljs-string">'locales/*.qm'</span>, <span class="hljs-string">'locales'</span>), <span class="hljs-comment"># 翻译文件</span>
        (<span class="hljs-string">'*.ini'</span>, <span class="hljs-string">'.'</span>),              <span class="hljs-comment"># 配置文件</span>
        (<span class="hljs-string">'docs/*.md'</span>, <span class="hljs-string">'docs'</span>)
    ],
    hiddenimports=[
        <span class="hljs-string">'win32timezone'</span>,             <span class="hljs-comment"># pywin32相关</span>
        <span class="hljs-string">'sqlalchemy.sql.default_comparator'</span>,
        <span class="hljs-string">'pkg_resources.py2_warn'</span>
    ],
    hookspath=[<span class="hljs-string">'hooks'</span>],             <span class="hljs-comment"># 自定义hook目录</span>
    runtime_hooks=[<span class="hljs-string">'hooks/runtime/rthook_pyside6.py'</span>],
    excludes=[<span class="hljs-string">'scipy'</span>, <span class="hljs-string">'numpy.testing'</span>],
    cipher=block_cipher,
    optimize=<span class="hljs-number">1</span>                       <span class="hljs-comment"># 字节码优化</span>
)
</code></pre>
<h2 data-id="heading-5">3. EXE 类</h2>
<h3 data-id="heading-6">3.1 作用场景</h3>
<p><strong>可执行文件构建器</strong>，将分析结果打包成最终的可执行文件。</p>
<h3 data-id="heading-7">3.2 参数配置详解</h3>
<pre><code class="hljs language-python" lang="python">exe = EXE(
    <span class="hljs-comment"># ============ 必需参数 ============</span>
    pyz,                <span class="hljs-comment"># PYZ对象（包含所有Python模块）</span>
    a.scripts,          <span class="hljs-comment"># Analysis的scripts结果</span>
    a.binaries,         <span class="hljs-comment"># Analysis的binaries结果</span>
    a.zipfiles,         <span class="hljs-comment"># Analysis的zipfiles结果</span>
    a.datas,            <span class="hljs-comment"># Analysis的datas结果</span>

    <span class="hljs-comment"># ============ 输出配置 ============</span>
    name=<span class="hljs-string">'MyApp'</span>,       <span class="hljs-comment"># 输出文件名（不加.exe）</span>
    debug=<span class="hljs-literal">False</span>,        <span class="hljs-comment"># True=包含调试信息</span>
    strip=<span class="hljs-literal">False</span>,        <span class="hljs-comment"># True=去除符号信息（减小体积）</span>
    upx=<span class="hljs-literal">True</span>,           <span class="hljs-comment"># True=使用UPX压缩（需安装UPX）</span>

    <span class="hljs-comment"># ============ 控制台/窗口设置 ============</span>
    console=<span class="hljs-literal">True</span>,       <span class="hljs-comment"># True=控制台程序，False=窗口程序（Windows）</span>
    disable_windowed_traceback=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 禁用窗口程序错误跟踪</span>
    argv_emulation=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># macOS: 模拟命令行参数</span>

    <span class="hljs-comment"># ============ 图标和元数据 ============</span>
    icon=<span class="hljs-string">'app.ico'</span>,     <span class="hljs-comment"># 程序图标（Windows: .ico, macOS: .icns）</span>

    <span class="hljs-comment"># ============ 运行时行为 ============</span>
    bootloader_ignore_signals=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 忽略信号（Unix）</span>
    runtime_tmpdir=<span class="hljs-literal">None</span>,  <span class="hljs-comment"># 临时目录路径</span>

    <span class="hljs-comment"># ============ 重定向设置 ============</span>
    exclude_binaries=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># True=不包含二进制依赖</span>
    code_signing_identity=<span class="hljs-literal">None</span>,  <span class="hljs-comment"># macOS代码签名标识</span>

    <span class="hljs-comment"># ============ 加密和优化 ============</span>
    entitlements_file=<span class="hljs-literal">None</span>,  <span class="hljs-comment"># macOS授权文件</span>
    embed_manifest=<span class="hljs-literal">True</span>,     <span class="hljs-comment"># Windows: 嵌入manifest</span>
    target_arch=<span class="hljs-literal">None</span>,        <span class="hljs-comment"># 目标架构：'x86', 'x64', 'arm64'</span>

    <span class="hljs-comment"># ============ 其他选项 ============</span>
    <span class="hljs-built_in">ascii</span>=<span class="hljs-literal">False</span>,        <span class="hljs-comment"># 弃用</span>
    uac_admin=<span class="hljs-literal">False</span>,    <span class="hljs-comment"># Windows: 以管理员运行</span>
    uac_uiaccess=<span class="hljs-literal">False</span>, <span class="hljs-comment"># Windows: UI访问权限</span>

    <span class="hljs-comment"># ============ 调试相关 ============</span>
    bootloader_ignore_signals=<span class="hljs-literal">False</span>,
    strict_arch=<span class="hljs-literal">False</span>,
)
</code></pre>
<h3 data-id="heading-8">3.3 实际示例</h3>
<p>这里还真没怎么差异化使用过，一般都是配置 <code>win</code> 平台。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 不同平台配置示例</span>
<span class="hljs-keyword">if</span> sys.platform == <span class="hljs-string">'win32'</span>:
    exe = EXE(
        pyz,
        a.scripts,
        a.binaries,
        a.zipfiles,
        a.datas,
        name=<span class="hljs-string">'MyApp'</span>,
        debug=<span class="hljs-literal">False</span>,
        strip=<span class="hljs-literal">False</span>,
        upx=<span class="hljs-literal">True</span>,
        console=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 无控制台窗口</span>
        icon=<span class="hljs-string">'app.ico'</span>,
        uac_admin=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 需要管理员权限</span>
        embed_manifest=<span class="hljs-literal">True</span>,
        version=<span class="hljs-string">'version_info.txt'</span>  <span class="hljs-comment"># Windows版本资源</span>
    )
<span class="hljs-keyword">elif</span> sys.platform == <span class="hljs-string">'darwin'</span>:
    exe = EXE(
        pyz,
        a.scripts,
        a.binaries,
        a.zipfiles,
        a.datas,
        name=<span class="hljs-string">'MyApp'</span>,
        debug=<span class="hljs-literal">False</span>,
        strip=<span class="hljs-literal">True</span>,
        upx=<span class="hljs-literal">False</span>,
        console=<span class="hljs-literal">False</span>,
        icon=<span class="hljs-string">'app.icns'</span>,
        entitlements_file=<span class="hljs-string">'app.entitlements'</span>,
        code_signing_identity=<span class="hljs-string">'Developer ID Application: Your Name (XXXXXX)'</span>
    )
<span class="hljs-keyword">else</span>:  <span class="hljs-comment"># Linux</span>
    exe = EXE(
        pyz,
        a.scripts,
        a.binaries,
        a.zipfiles,
        a.datas,
        name=<span class="hljs-string">'myapp'</span>,
        debug=<span class="hljs-literal">False</span>,
        strip=<span class="hljs-literal">True</span>,
        upx=<span class="hljs-literal">True</span>,
        console=<span class="hljs-literal">True</span>  <span class="hljs-comment"># Linux通常用控制台</span>
    )
</code></pre>
<h2 data-id="heading-9">4. todo-list应用完整文件示例</h2>
<p>以最近我在撰写的 <code>todo-list</code> 应用的打包配置文件为例，这个主要是 <code>AI</code> 编写的，我就改了几行代码而已。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># -*- mode: python ; coding: utf-8 -*-</span>

<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-comment"># 获取项目根目录</span>
project_root = Path(SPECPATH).parent
frontend_dir = project_root / <span class="hljs-string">'frontend'</span>
data_dir = project_root / <span class="hljs-string">'data'</span>

<span class="hljs-comment"># 收集前端文件</span>
frontend_files = [
 (<span class="hljs-string">'frontend/index.html'</span>, <span class="hljs-string">'frontend/'</span>),
 (<span class="hljs-string">'frontend/css/*'</span>, <span class="hljs-string">'frontend/css'</span>),
 (<span class="hljs-string">'frontend/js/*'</span>, <span class="hljs-string">'frontend/js'</span>)
]

<span class="hljs-comment"># 收集数据文件</span>
data_files = []
<span class="hljs-keyword">if</span> data_dir.exists():
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data_dir.rglob(<span class="hljs-string">'*'</span>):
        <span class="hljs-keyword">if</span> item.is_file():
            relative_path = item.relative_to(data_dir)
            data_files.append((<span class="hljs-built_in">str</span>(item), <span class="hljs-string">'data'</span>))

block_cipher = <span class="hljs-literal">None</span>

a = Analysis(
    [<span class="hljs-string">'run.py'</span>],
    pathex=[<span class="hljs-built_in">str</span>(project_root), <span class="hljs-built_in">str</span>(project_root / <span class="hljs-string">'backend'</span>), <span class="hljs-built_in">str</span>(project_root / <span class="hljs-string">'TodoList'</span> / <span class="hljs-string">'backend'</span>)],
    binaries=[],
    datas=frontend_files + data_files,
    hiddenimports=[
        <span class="hljs-string">'webview'</span>,
        <span class="hljs-string">'webview.platforms'</span>,
        <span class="hljs-string">'webview.platforms.cef'</span>,
        <span class="hljs-string">'webview.platforms.edgechromium'</span>,
        <span class="hljs-string">'webview.platforms.mshtml'</span>,
        <span class="hljs-string">'webview.platforms.gtk'</span>,
        <span class="hljs-string">'webview.platforms.cocoa'</span>,
        <span class="hljs-string">'webview.platforms.qt'</span>,
        <span class="hljs-string">'sqlite3'</span>,
        <span class="hljs-string">'json'</span>,
        <span class="hljs-string">'threading'</span>,
        <span class="hljs-string">'datetime'</span>,
        <span class="hljs-string">'http.server'</span>,
        <span class="hljs-string">'socketserver'</span>,
        <span class="hljs-string">'urllib.parse'</span>,
        <span class="hljs-string">'pathlib'</span>,
        <span class="hljs-string">'os'</span>,
        <span class="hljs-string">'sys'</span>,
        <span class="hljs-string">'shutil'</span>,
        <span class="hljs-string">'subprocess'</span>,
        <span class="hljs-string">'re'</span>,
        <span class="hljs-string">'uuid'</span>,
        <span class="hljs-string">'hashlib'</span>,
        <span class="hljs-string">'base64'</span>,
        <span class="hljs-string">'html'</span>,
        <span class="hljs-string">'webbrowser'</span>,
        <span class="hljs-string">'tkinter'</span>,
        <span class="hljs-string">'tkinter.messagebox'</span>,
        <span class="hljs-string">'tkinter.filedialog'</span>,
        <span class="hljs-string">'tkinter.simpledialog'</span>,
        <span class="hljs-comment"># 后端模块</span>
        <span class="hljs-string">'database.operations'</span>,
        <span class="hljs-string">'database.models'</span>,
        <span class="hljs-string">'api.todo_api'</span>
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[
        <span class="hljs-string">'matplotlib'</span>,
        <span class="hljs-string">'numpy'</span>,
        <span class="hljs-string">'scipy'</span>,
        <span class="hljs-string">'pandas'</span>,
        <span class="hljs-string">'PIL'</span>,
        <span class="hljs-string">'cv2'</span>,
        <span class="hljs-string">'PyQt6'</span>
    ],
    win_no_prefer_redirects=<span class="hljs-literal">False</span>,
    win_private_assemblies=<span class="hljs-literal">False</span>,
    cipher=block_cipher,
    noarchive=<span class="hljs-literal">False</span>,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name=<span class="hljs-string">'TodoList'</span>,
    debug=<span class="hljs-literal">False</span>,
    bootloader_ignore_signals=<span class="hljs-literal">False</span>,
    strip=<span class="hljs-literal">False</span>,
    upx=<span class="hljs-literal">True</span>,
    upx_exclude=[],
    runtime_tmpdir=<span class="hljs-literal">None</span>,
    console=<span class="hljs-literal">False</span>,
    disable_windowed_traceback=<span class="hljs-literal">False</span>,
    argv_emulation=<span class="hljs-literal">False</span>,
    target_arch=<span class="hljs-literal">None</span>,
    codesign_identity=<span class="hljs-literal">None</span>,
    entitlements_file=<span class="hljs-literal">None</span>,
    icon=<span class="hljs-string">'todo_icon.ico'</span> <span class="hljs-keyword">if</span> Path(<span class="hljs-string">'todo_icon.ico'</span>).exists() <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,
    version=<span class="hljs-string">'version_info.txt'</span> <span class="hljs-keyword">if</span> Path(<span class="hljs-string">'version_info.txt'</span>).exists() <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
)
</code></pre>
<p>示例上可以看出实际上，<code>spec</code> 文件执行时是可以识别 <code>python</code> 代码的。</p>
<h2 data-id="heading-10">5. 补充说明</h2>
<h3 data-id="heading-11">5.1 针对特定库的配置</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 打包PyQt6/PySide6应用</span>
a = Analysis(
    [<span class="hljs-string">'app.py'</span>],
    hiddenimports=[
        <span class="hljs-string">'PySide6.QtXml'</span>,
        <span class="hljs-string">'PySide6.QtNetwork'</span>
    ],
    binaries=[
        (<span class="hljs-string">'/path/to/qt/plugins/platforms/*'</span>, <span class="hljs-string">'platforms'</span>)
    ],
    datas=[
        (<span class="hljs-string">'/path/to/qt/translations/*'</span>, <span class="hljs-string">'translations'</span>)
    ]
)

<span class="hljs-comment"># 打包机器学习应用（排除大型库）</span>
a = Analysis(
    [<span class="hljs-string">'ml_app.py'</span>],
    excludes=[
        <span class="hljs-string">'torch'</span>,  <span class="hljs-comment"># 太大，让用户自己安装</span>
        <span class="hljs-string">'tensorflow'</span>,
        <span class="hljs-string">'jax'</span>
    ],
    hiddenimports=[
        <span class="hljs-string">'sklearn.utils._cython_blas'</span>,
        <span class="hljs-string">'numpy.core._multiarray_umath'</span>
    ]
)
</code></pre>
<h3 data-id="heading-12">5.2 调试技巧</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 调试模式配置</span>
exe = EXE(
    <span class="hljs-comment"># ...</span>
    debug=<span class="hljs-literal">True</span>,      <span class="hljs-comment"># 包含调试信息</span>
    strip=<span class="hljs-literal">False</span>,     <span class="hljs-comment"># 不去除符号</span>
    upx=<span class="hljs-literal">False</span>,       <span class="hljs-comment"># 不压缩（便于调试）</span>
    console=<span class="hljs-literal">True</span>     <span class="hljs-comment"># 显示控制台看错误</span>
)

<span class="hljs-comment"># 运行时查看缺失模块</span>
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(sys, <span class="hljs-string">'_MEIPASS'</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"临时目录: <span class="hljs-subst">{sys._MEIPASS}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"模块路径: <span class="hljs-subst">{sys.path}</span>"</span>)
</code></pre>
<h3 data-id="heading-13">5.3 其他说明</h3>
<p>除了用于 <code>pyinstaller</code> 的打包外，<code>spec</code> 文件也在其他场景有相关使用的：</p>
<ol>
<li>
<p><strong>RPM包管理</strong>：Linux系统软件打包</p>
</li>
<li>
<p><strong>其他构建工具</strong>：作为配置文件使用</p>
</li>
</ol>
<p>另外有类似作用的文件还有：<code>setup.cfg</code>、<code>pyproject.toml</code> 等</p>
<hr/>
<p>好啦，今天的分享就到这里了，感谢阅读，如果觉得文章对你有用的话，欢迎三连、欢迎关注！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elasticsearch核心原理——倒排索引、映射与分词对搜索质量的影响路径]]></title>    <link>https://juejin.cn/post/7587997157237276724</link>    <guid>https://juejin.cn/post/7587997157237276724</guid>    <pubDate>2025-12-26T12:46:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997157237276724" data-draft-id="7587743345198022708" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elasticsearch核心原理——倒排索引、映射与分词对搜索质量的影响路径"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-26T12:46:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="十月南城"/> <meta itemprop="url" content="https://juejin.cn/user/3456520290576862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elasticsearch核心原理——倒排索引、映射与分词对搜索质量的影响路径
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520290576862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    十月南城
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T12:46:58.000Z" title="Fri Dec 26 2025 12:46:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>写在前面，本人目前处于求职中，如有合适内推岗位，请加：lpshiyue 感谢。同时还望大家一键三连，赚点奶粉钱。</strong></p>
<blockquote>
<p>掌握Elasticsearch的搜索质量优化，关键在于理解倒排索引如何将数据转换为可搜索的知识图谱，映射如何定义数据的DNA结构，以及分词器如何影响搜索的精准度</p>
</blockquote>
<p>在分布式系统中完成失败处置和弹性设计后，我们转向数据检索的核心挑战。搜索质量直接决定用户体验，而Elasticsearch作为领先的搜索引擎，其效果取决于三大核心原理的协同作用。本文将深入解析倒排索引的工作机制、映射的设计哲学和分词器的匹配策略，揭示它们如何共同影响搜索质量。</p>
<h2 data-id="heading-0">1 倒排索引：从文档存储到知识图谱的思维转变</h2>
<h3 data-id="heading-1">1.1 正排索引与倒排索引的本质区别</h3>
<p>传统数据库使用<strong>正排索引</strong>（Forward Index），这是一种"文档→内容"的映射关系，类似于书籍的目录（通过页码查找章节内容）。这种索引方式在处理"LIKE '%keyword%'"查询时需要进行全表扫描，随着数据量增加，性能急剧下降。</p>
<p>Elasticsearch的核心突破在于采用<strong>倒排索引</strong>（Inverted Index），实现了"内容→文档"的逆向映射。这相当于书籍末尾的关键词索引，直接告诉读者每个关键词出现在哪些页码。</p>
<p><strong>实际示例对比</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">  -- 传统数据库的正排索引查询（性能随数据量增加而线性下降）SELECT * FROM products WHERE title LIKE <span class="hljs-string">'%手机%'</span> OR description LIKE <span class="hljs-string">'%手机%'</span>;-- Elasticsearch的倒排索引查询（性能基本恒定）GET /products/_search{  <span class="hljs-string">"query"</span>: {    <span class="hljs-string">"match"</span>: {      <span class="hljs-string">"title"</span>: <span class="hljs-string">"手机"</span>    }  }}
</code></pre>
<h3 data-id="heading-2">1.2 倒排索引的底层结构与构建过程</h3>
<p>倒排索引不是简单的关键词映射，而是包含丰富语义信息的<strong>高级数据结构</strong>。其核心由两部分组成：</p>
<p><strong>词项字典</strong>（Term Dictionary）存储所有唯一的词项，并按字典序排序，便于使用二分查找等算法快速定位。</p>
<p><strong>倒排列表</strong>（Posting List）记录每个词项的详细出现信息，包含：</p>
<ul>
<li>• <strong>文档ID</strong>（DocID）：包含该词项的文档标识</li>
<li>• <strong>词频</strong>（TF）：词项在文档中出现的次数（相关性评分重要因素）</li>
<li>• <strong>位置</strong>（Position）：词项在文档中的具体位置（支持短语查询）</li>
<li>• <strong>偏移量</strong>（Offset）：词项在原始文本中的起止位置（支持高亮显示）</li>
</ul>
<p><strong>倒排索引构建流程</strong>具体包括以下步骤：</p>
<ol>
<li>1. <strong>文档解析</strong>：提取文本字段，进行编码统一和格式清理</li>
<li>2. <strong>分词处理</strong>：通过分词器将文本拆分为单独的词项</li>
<li>3. <strong>标准化处理</strong>：包括转小写、去除停用词、词干提取等</li>
<li>4. <strong>生成倒排项</strong>：记录每个词项在文档中的出现频率、位置等信息</li>
<li>5. <strong>索引存储</strong>：将倒排项写入索引段，实现持久化</li>
</ol>
<h3 data-id="heading-3">1.3 倒排索引的查询机制与性能优化</h3>
<p>当用户发起搜索请求时，Elasticsearch执行高效的<strong>两阶段查询流程</strong>：</p>
<p><strong>查询解析阶段</strong>：搜索词经过相同的分词和标准化处理，确保查询与索引的兼容性。例如搜索"Quick Foxes"会被分词为["quick", "fox"]。</p>
<p><strong>倒排列表查找与合并</strong>：Elasticsearch在词项字典中查找每个词项的倒排列表，然后根据查询逻辑（AND/OR）进行列表合并。对于AND查询，取倒排列表的交集；对于OR查询，则取并集。</p>
<p><strong>性能优化技术</strong>包括：</p>
<ul>
<li>• <strong>跳表</strong>（Skip Lists）：加速大型倒排列表的合并操作</li>
<li>• <strong>位图索引</strong>（Bitmap Indexing）：对枚举型字段进行高效压缩</li>
<li>• <strong>布隆过滤器</strong>（Bloom Filter）：快速判断词项是否存在，避免不必要的磁盘查找</li>
</ul>
<h2 data-id="heading-4">2 映射设计：数据模式的战略规划</h2>
<h3 data-id="heading-5">2.1 映射的核心作用与设计原则</h3>
<p>映射（Mapping）在Elasticsearch中相当于数据库的模式设计，它定义了文档及其包含的字段如何存储和索引。恰当的映射设计是搜索性能的基石。</p>
<p><strong>映射的核心价值</strong>体现在：</p>
<ul>
<li>• <strong>存储优化</strong>：选择合适的字段类型减少磁盘空间占用</li>
<li>• <strong>索引优化</strong>：合理的索引配置提升查询速度</li>
<li>• <strong>搜索优化</strong>：正确的分析器设置提高搜索结果相关性</li>
</ul>
<h3 data-id="heading-6">2.2 字段类型选择策略</h3>
<p>Elasticsearch提供了丰富的字段类型，每种类型都有其特定的应用场景和性能特征：</p>
<p><strong>文本类型家族</strong>：</p>
<ul>
<li>• <strong>text</strong>类型：适用于需要分词的全文搜索场景，如商品描述、文章内容</li>
<li>• <strong>keyword</strong>类型：适用于精确匹配，如状态标签、分类编码</li>
</ul>
<p><strong>数值类型家族</strong>：</p>
<ul>
<li>• <strong>整数类型</strong>（integer, long）：适合离散数值，如数量、年龄</li>
<li>• <strong>浮点类型</strong>（float, double）：适合连续数值，如价格、评分</li>
</ul>
<p><strong>专用类型家族</strong>：</p>
<ul>
<li>• <strong>date</strong>：日期和时间数据，支持丰富的范围查询</li>
<li>• <strong>geo_point</strong>：地理坐标，支持地理位置查询</li>
<li>• <strong>ip</strong>：IP地址，支持CIDR查询</li>
</ul>
<p><strong>多字段映射实战示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">  PUT /ecommerce_products{  <span class="hljs-string">"mappings"</span>: {    <span class="hljs-string">"properties"</span>: {      <span class="hljs-string">"product_id"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>      },      <span class="hljs-string">"product_name"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,        <span class="hljs-string">"analyzer"</span>: <span class="hljs-string">"ik_max_word"</span>,        <span class="hljs-string">"fields"</span>: {          <span class="hljs-string">"keyword"</span>: {            <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>          },          <span class="hljs-string">"pinyin"</span>: {            <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,            <span class="hljs-string">"analyzer"</span>: <span class="hljs-string">"pinyin"</span>          }        }      },      <span class="hljs-string">"price"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"scaled_float"</span>,        <span class="hljs-string">"scaling_factor"</span>: 100      },      <span class="hljs-string">"tags"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>      },      <span class="hljs-string">"description"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,        <span class="hljs-string">"analyzer"</span>: <span class="hljs-string">"ik_smart"</span>      },      <span class="hljs-string">"created_time"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"date"</span>      },      <span class="hljs-string">"location"</span>: {        <span class="hljs-string">"type"</span>: <span class="hljs-string">"geo_point"</span>      }    }  }}
</code></pre>
<p>此配置为商品名称同时提供分词搜索、精确匹配和拼音搜索能力</p>
<h3 data-id="heading-7">2.3 映射设计的最佳实践</h3>
<p><strong>动态映射与静态映射的平衡</strong>：在生产环境中，建议优先使用静态映射，避免字段爆炸问题。</p>
<p><strong>索引选项的精细控制</strong>：对于不需要搜索的字段（如MD5哈希值），可以设置<code>"index": false</code>节省存储空间。</p>
<p><strong>副本设置的优化</strong>：在写入密集型场景中，可以暂时设置<code>"number_of_replicas": 0</code>提升写入速度，写入完成后再恢复副本数量。</p>
<h2 data-id="heading-8">3 分词机制：搜索精准度的决定因素</h2>
<h3 data-id="heading-9">3.1 分词器的工作原理与组件协同</h3>
<p>分词器（Analyzer）是将文本转换为词项的关键组件，直接决定搜索的召回率和准确率。一个完整的分词器包含三个协同工作的组件：</p>
<p><strong>字符过滤器</strong>（Character Filters）负责原始文本的预处理，如HTML标签去除、特殊字符转换。</p>
<p><strong>分词单元</strong>（Tokenizer）是分词器的核心，将文本切分为独立的词项（Token）。不同的分词单元采用不同的切分策略。</p>
<p><strong>词项过滤器</strong>（Token Filters）对分词结果进行再加工，包括转小写、停用词去除、同义词扩展等。</p>
<h3 data-id="heading-10">3.2 中文分词的挑战与解决方案</h3>
<p>中文分词面临<strong>无自然分隔符</strong>、<strong>新词发现</strong>、<strong>歧义消除</strong>等独特挑战。IK分词器是中文场景的首选解决方案，提供两种分词模式：</p>
<p><strong>ik_smart模式</strong>（粗粒度分词）适合精准匹配场景，召回率较低但准确率高：</p>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-string">"中华人民共和国宪法"</span> → [<span class="hljs-string">"中华人民共和国"</span>, <span class="hljs-string">"宪法"</span>]
</code></pre>
<p><strong>ik_max_word模式</strong>（细粒度分词）适合召回优先场景，召回率高但可能包含无关结果：</p>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-string">"中华人民共和国宪法"</span> → [<span class="hljs-string">"中华人民共和国"</span>, <span class="hljs-string">"中华人民"</span>, <span class="hljs-string">"中华"</span>, <span class="hljs-string">"华人"</span>, <span class="hljs-string">"人民共和国"</span>, <span class="hljs-string">"人民"</span>, <span class="hljs-string">"共和国"</span>, <span class="hljs-string">"共和"</span>, <span class="hljs-string">"国"</span>, <span class="hljs-string">"宪法"</span>]
</code></pre>
<p><strong>IK分词器配置示例</strong>：</p>
<pre><code class="hljs language-xml" lang="xml">  <span class="hljs-comment">&lt;!-- IK Analyzer 扩展配置 --&gt;</span><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">properties</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">"http://java.sun.com/dtd/properties.dtd"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="hljs-tag">&lt;/<span class="hljs-name">comment</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"ext_dict"</span>&gt;</span>custom_words.dic<span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span>    <span class="hljs-comment">&lt;!-- 自定义扩展词典 --&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"ext_stopwords"</span>&gt;</span>stop_words.dic<span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span> <span class="hljs-comment">&lt;!-- 自定义停用词 --&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
</code></pre>
<p>通过扩展词典可以添加领域专有名词，提升专业文本的分词效果</p>
<h3 data-id="heading-11">3.3 多语言混合场景的分词策略</h3>
<p>在实际应用中，经常遇到中英文混合、拼音匹配等复杂场景，需要采用组合分词策略：</p>
<p><strong>中英文混合分词</strong>：使用IK分词器配合英文处理能力，确保中英文术语都能正确识别。</p>
<p><strong>拼音分词集成</strong>：为重要字段同时配置拼音分词器，支持拼音搜索：</p>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-attr">"product_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>  <span class="hljs-attr">"analyzer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ik_max_word"</span><span class="hljs-punctuation">,</span>  <span class="hljs-attr">"fields"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>    <span class="hljs-attr">"pinyin"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>       <span class="hljs-attr">"analyzer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pinyin"</span>    <span class="hljs-punctuation">}</span>  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>同义词扩展</strong>：配置同义词过滤器，提升搜索召回率：</p>
<pre><code class="hljs language-css" lang="css">  "<span class="hljs-attribute">filter</span>": {  "my_synonyms": {    "type": <span class="hljs-string">"synonym"</span>,    <span class="hljs-string">"synonyms"</span>: [      <span class="hljs-string">"手机, 电话, 移动电话"</span>,      <span class="hljs-string">"电脑, 计算机, 笔记本"</span>    ]  }}
</code></pre>
<h2 data-id="heading-12">4 三者协同：搜索质量的影响路径分析</h2>
<h3 data-id="heading-13">4.1 搜索质量的全链路影响因素</h3>
<p>搜索质量的好坏受到从数据接入到结果返回的全链路影响，其中倒排索引、映射和分词器在各个环节发挥关键作用：</p>
<p><strong>数据摄入阶段</strong>：映射决定字段如何被解析，分词器决定文本如何被切分，倒排索引决定词项如何被存储。</p>
<p><strong>查询处理阶段</strong>：查询词经过相同的分词处理，确保查询与索引的一致性；倒排索引提供高效的词项查找能力。</p>
<p><strong>结果排序阶段</strong>：倒排索引中存储的词频、位置等信息为相关性评分提供基础数据。</p>
<h3 data-id="heading-14">4.2 典型问题与解决方案</h3>
<p><strong>搜索召回率低</strong>通常由过度激进的分词策略导致。解决方案包括：使用细粒度分词模式（ik_max_word）、合理配置同义词、优化停用词列表。</p>
<p><strong>搜索准确率低</strong>往往因分词粒度太细或同义词过度扩展引起。解决方案包括：使用粗粒度分词模式（ik_smart）、调整相关性评分权重、完善同义词规则。</p>
<p><strong>搜索性能差</strong>可能与倒排索引过大或映射设计不合理有关。解决方案包括：合理配置索引选项、使用多字段类型避免全文本搜索、优化分片大小。</p>
<h3 data-id="heading-15">4.3 实战调优案例：电商搜索系统优化</h3>
<p><strong>问题场景</strong>：某电商平台商品搜索存在结果不相关、拼音搜索不支持、性能瓶颈等问题。</p>
<p><strong>优化方案</strong>：</p>
<ol>
<li>1. <strong>映射重构</strong>：为商品名字段配置多字段映射，同时支持中文分词、精确匹配和拼音搜索</li>
<li>2. <strong>分词优化</strong>：结合IK分词器与自定义词典，添加品牌名和新品类的专有名词</li>
<li>3. <strong>索引优化</strong>：调整倒排索引的索引选项，对价格等数值字段使用doc_values提升聚合性能</li>
</ol>
<p><strong>优化结果</strong>：搜索准确率提升35%，拼音搜索支持度100%，搜索响应时间减少60%。</p>
<h2 data-id="heading-16">5 性能与质量平衡的艺术</h2>
<h3 data-id="heading-17">5.1 索引性能与搜索质量的权衡</h3>
<p>在Elasticsearch中，性能与质量需要谨慎平衡。过度追求搜索质量可能导致索引性能下降，而过度优化索引速度可能影响搜索准确性。</p>
<p><strong>索引优化策略</strong>：</p>
<ul>
<li>• 批量文档写入，减少索引提交频率</li>
<li>• 优化刷新间隔（refresh_interval），平衡近实时性与写入吞吐量</li>
<li>• 合理配置分片数量和大小，避免大量小分片或过大大分片</li>
</ul>
<p><strong>搜索优化策略</strong>：</p>
<ul>
<li>• 使用filter上下文缓存频繁使用的过滤条件</li>
<li>• 避免通配符查询，特别是前导通配符（如*abc）</li>
<li>• 使用异步搜索处理复杂聚合查询</li>
</ul>
<h3 data-id="heading-18">5.2 监控与持续优化</h3>
<p>建立完善的监控体系是持续优化搜索质量的基础。关键监控指标包括：</p>
<p><strong>索引性能指标</strong>：索引延迟、索引吞吐量、合并操作频率<br/>
<strong>搜索质量指标</strong>：查询延迟、命中率、首条结果点击率<br/>
<strong>系统资源指标</strong>：堆内存使用率、磁盘I/O、CPU利用率</p>
<p>定期进行搜索质量评估，通过A/B测试对比不同分词策略或评分公式的效果，实现数据驱动的持续优化。</p>
<h2 data-id="heading-19">总结</h2>
<p>Elasticsearch的搜索质量优化是一个系统工程，倒排索引、映射设计和分词器分别从数据结构、数据模型和数据处理的维度影响搜索效果。</p>
<p><strong>倒排索引</strong>是搜索性能的基石，其高效的数据结构使毫秒级搜索成为可能。<strong>映射设计</strong>决定了数据的存储和索引方式，合理的映射是高效搜索的前提。<strong>分词器</strong>直接影响搜索的召回率和准确率，特别是对于中文等复杂语言。</p>
<p>在实际应用中，需要根据具体业务场景平衡搜索质量与系统性能，建立持续监控和优化机制。只有深入理解这三者的工作原理和相互影响，才能构建出既快又准的搜索系统。</p>
<p><strong>📚 下篇预告</strong><br/>
《ES性能与可用性——分片、副本、路由与聚合的调度逻辑与成本》—— 我们将深入探讨：</p>
<ul>
<li>• 🎯 <strong>分片策略</strong>：数据分布、读写负载与水平扩展的平衡之道</li>
<li>• 🔄 <strong>副本机制</strong>：高可用性保障与读取吞吐量的提升方案</li>
<li>• 🧩 <strong>路由优化</strong>：请求分发、负载均衡与故障转移的智能逻辑</li>
<li>• 📊 <strong>聚合性能</strong>：大数据集统计分析与实时可视化的成本控制</li>
<li>• ⚖️ <strong>资源权衡</strong>：存储成本、计算开销与查询延迟的平衡艺术</li>
</ul>
<p><strong>点击关注，掌握Elasticsearch集群调优的核心方法论！</strong></p>
<blockquote>
<p><strong>今日行动建议</strong>：</p>
<ol>
<li>1. 分析现有索引的映射设计，识别字段类型使用不当的情况</li>
<li>2. 评估当前分词策略对搜索质量的影响，针对核心业务场景进行优化</li>
<li>3. 检查倒排索引大小与查询模式，优化索引配置提升查询性能</li>
<li>4. 建立搜索质量监控体系，定期评估召回率与准确率指标</li>
</ol>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[java并发编程（juc理论篇）]]></title>    <link>https://juejin.cn/post/7588001624905269267</link>    <guid>https://juejin.cn/post/7588001624905269267</guid>    <pubDate>2025-12-26T15:20:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588001624905269267" data-draft-id="7588007285546434566" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="java并发编程（juc理论篇）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T15:20:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ihgry"/> <meta itemprop="url" content="https://juejin.cn/user/3210229685954718"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            java并发编程（juc理论篇）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3210229685954718/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ihgry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T15:20:38.000Z" title="Fri Dec 26 2025 15:20:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">CAS</h4>
<ul>
<li>CAS(Compare And Swap)，处理器会比较当前内存地址上的值 和 线程中变量的值（预期值）是否相等，如果相等则替换内存地址上的值为新值，如果不相等则不更新，硬件层面上支持使用一条指令来实现上面的操作，x86中是<code>cmpxchgl</code>指令</li>
<li>CAS操作不涉及线程上下文切换，并且不使用锁，会提高系统的并发性</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d3cd7260f6a47c699781a44e1e95cc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767367332&amp;x-signature=mRlEYponi%2F6JG5tch69PoEwjA9I%3D" alt="CAS总线.jpg" width="50%" loading="lazy"/></p>
<ul>
<li>
<p><code>ABA问题</code>：一个线程将变量A改为了变量B，之后又改为了变量A，另一个线程在执行CAS操作时会认为该变量没有发生变化，可能会导致错误。解决方案：添加版本号进行对比，可以使用<code>AtomicStampedReference</code>类</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> AtomicStampedReference&lt;Integer&gt; atomicStampedReference = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicStampedReference</span>&lt;&gt;(<span class="hljs-number">100</span>, <span class="hljs-number">66</span>);

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
    <span class="hljs-comment">// 获取当前的引用值和时间戳</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">stamp</span> <span class="hljs-operator">=</span> atomicStampedReference.getStamp();
    <span class="hljs-type">Integer</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> atomicStampedReference.getReference();

    <span class="hljs-comment">// 修改引用值</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> atomicStampedReference.compareAndSet(value, value + <span class="hljs-number">10</span>, stamp, stamp + <span class="hljs-number">1</span>);
    System.out.println(<span class="hljs-string">"result = "</span> + result);

    <span class="hljs-comment">// 输出最终的值</span>
    System.out.println(<span class="hljs-string">"Final value = "</span> + atomicStampedReference.getReference());
    System.out.println(<span class="hljs-string">"Final stamp = "</span> + atomicStampedReference.getStamp());
}
</code></pre>
</li>
</ul>
<h4 data-id="heading-1">Synchorized</h4>
<ul>
<li><code>synchorized</code>修饰实例方法时，锁对象是当前的实例对象；<code>synchorized</code>修饰静态方法时，锁对象是当前的class类对象；<code>synchorized</code>作用于代码块时，锁对象是括号里面的对象</li>
<li><code>synchorized</code>是可重入锁，一个线程可以重复获取到该锁，每获取一次锁，计数器加一，释放锁时，计数器减一，直到计数器为0，锁才会真正释放</li>
<li><code>synchronized</code>修饰方法时，会在方法的访问标志位中增加一个<code>ACC_SYNCHORIZED</code>标志，当线程访问该方法时，如果包含该标志位，就要获得该方法对应的对象的监视器锁才能执行该方法</li>
<li><code>synchronized</code>修饰代码块时，会在代码块的前后插入<code>monitorenter</code>和<code>monitorexit</code>字节码指令</li>
</ul>
<p>锁升级过程：</p>
<ul>
<li>在没有锁竞争的情况下，一个线程来加锁，JVM会向锁对象的对象头中写入该线程id (这时候的锁叫<code>偏向锁</code>)，后续该线程再进入该锁时，无需进行额外的同步操作</li>
<li>在锁轻度竞争的时候，会升级为<code>轻量级锁</code>，JVM会在当前线程中创建一个栈帧，通过CAS操作将这个栈帧的地址写入对象头中，如果成功表示该线程获取到了锁，如果失败则表示其他线程已经持有该锁，此时会升级为重量级锁</li>
<li>当锁竞争激烈时，JVM会升级为重量级锁，<code>synchorized</code>修改代码块时，线程会尝试获取monitor对象的所有权，抢到了就是成功获取到锁，抢不到线程就会阻塞，等待重新获取锁</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c9a95149fda49acbb3b3c05a0aa4e2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767367332&amp;x-signature=m5QQqowuzyac%2BmkEKZxVG2PDUX0%3D" alt="对象头.jpg" width="70%" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3a40f4e7f55406bb80d018171ddd2fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767367332&amp;x-signature=FTI0cqXoBBx4Waqaa%2B4pl6HKu2w%3D" alt="锁栈帧.jpg" width="50%" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12864ed5a0af4fa193a2a553a208cab6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767367332&amp;x-signature=jB83O5iCAK1kU1EHu66Z4hcza7w%3D" alt="锁膨胀" width="50%" loading="lazy"/></p>
<p>Synchorized和ReentrantLock</p>
<ul>
<li><code>synchorized</code>和<code>ReentrantLock</code> 都是可重入锁</li>
<li><code>synchorized</code>是非公平锁，不支持设置超时时间，不支持条件判断，不需要手动释放锁</li>
<li><code>ReentrantLock</code>既可以是非公平锁也可以是公平锁（默认是非公平锁），允许设置获取锁的超时时间，可以通过<code>lock.Condition</code>对象将不满足条件的线程加入到阻塞队列中</li>
</ul>
<h4 data-id="heading-2">ThreadLocal</h4>
<ul>
<li>
<p>基本使用</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserContext</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ThreadLocal&lt;User&gt; CONTEXT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;User&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CONTEXT.get();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUser</span><span class="hljs-params">(User user)</span> {
        CONTEXT.set(user);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">remove</span><span class="hljs-params">()</span> {
        CONTEXT.remove();
    }
}
</code></pre>
</li>
<li>
<p>每个线程内部维护了一个<code>ThreadLocalMap</code>对象，<code>ThreadLocalMap</code>以<code>ThreadLocal</code>为key，线程变量副本为value</p>
</li>
<li>
<p><code>ThreadLocalMap</code>中的key是弱引用，之所以不是强引用是因为所使用的线程往往是线程池中的线程，线程一般不会被销毁，对<code>ThreadLocal</code>的引用就会一直存在，导致内存释放不掉</p>
</li>
<li>
<p>最佳实践：</p>
<ul>
<li>存储用户登录信息，让每个线程有独立的用户上下文</li>
<li>管理数据库链接，将一个数据库连接放入ThreadLocal中，在需要使用数据库连接的地方直接从ThreadLocal获取</li>
</ul>
</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87e0d298116b48f0868df6b9bae173bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767367332&amp;x-signature=RYhUF9x9QLPH1Q1eWOpzs11J5AY%3D" alt="Thread.jpg" width="50%" loading="lazy"/></p>
<h4 data-id="heading-3">Volatile</h4>
<ul>
<li>
<p><code>volatile</code>可以保证可见性，当一个线程修改了<code>volatile</code>变量的值后，新值会立即被刷新到主内存中，其他线程在读取该变量时可以立即获取到最新的值，避免由于缓存一致性问题导致 ”看见“旧值的现象</p>
</li>
<li>
<p><code>volatile</code>底层会加一个<code>lock</code>前缀指令进行总线锁定，总线监听到修改了共享数据后，会让其他处理器中的缓存更新或失效</p>
</li>
<li>
<p><code>volatile</code>可以禁止 jvm 指令重排，保证在多线程环境下也能正常运行</p>
<p>正常情况：1. 为对象分配内存，2. 初始化，3. 将对象引用指向对应内存地址</p>
<p>指令重排可能变成1 3 2，这样可能会发生问题</p>
</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc75ac7c66f64437b9944454bac221e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaWhncnk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767367332&amp;x-signature=UU3LL7jAudgBGLMXXBikk%2BBH0ks%3D" alt="1.png" width="50%" loading="lazy"/></p>
<h4 data-id="heading-4">AQS</h4>
<ul>
<li>AQS是一个抽象类，内部封装了线程 加锁、解锁、入队、出队的一些方法，提供给其他juc锁使用</li>
<li>它内部通过维护一个共享变量<code>state</code>和先进先出<code>FIFO</code>等待队列来控制并发线程，在独占锁中，<code>state</code>为0表示未被占用，1表示已被占用，当线程获取资源失败时，会被加入到AQS的等待队列中</li>
<li>基于AQS实现的类有<code>ReentrantLock</code>, <code>CountDownLatch</code>, <code>Semaphore</code>等</li>
</ul>
<h4 data-id="heading-5">其他</h4>
<p>死锁：两个线程都想获取对方已经拥有的锁，避免死锁的方法：</p>
<ul>
<li>避免在一个锁的代码块中再次尝试获取另一个锁</li>
<li>使用尝试获取锁的方法，比如<code>ReentrantLock</code>的<code>trylock</code>方法，<code>Semaphore</code>的<code>tryAcquire</code>方法，如果获取不到使用其他方案</li>
<li>减小锁的控制范围</li>
</ul>
<p>保证线程安全的方式</p>
<ul>
<li>同步锁：<code>synchorized</code>、<code>ReentrantLock</code></li>
<li>原子操作类：<code>AtomicInteger</code>、<code>AtomicReference</code></li>
<li>线程安全的容器：<code>ConcurrentHashMap</code>等，避免手动加锁</li>
<li>使用局部变量</li>
</ul>
<p>一个线程被启动两次，会发生什么：</p>
<ul>
<li>线程一旦运行就不会回到初始状态，会抛出<code>IllegalThreadStateException</code>异常</li>
</ul>
<p>上下文切换：</p>
<ul>
<li>暂停一个线程的处理，并将CPU寄存器中该线程的数据存储在内存中</li>
<li>从内存中获取下一个线程的上下文，并在CPU的寄存器中恢复它</li>
<li>返回到程序计数器指示的位置 继续执行</li>
</ul>
<p>并发和并行：</p>
<ul>
<li>并发：线程轮流使用cpu的做法称为并发</li>
<li>并行：多个cpu同时在调度线程执行任务</li>
</ul>
<p>原子性、可见性、有序性</p>
<ul>
<li>原子性：一组操作要么全部执行成功，要么全部不执行</li>
<li>可见性：一个线程修改共享变量的值后，其他线程能够立即看到这个修改后的值</li>
<li>有序性：程序的执行顺序和代码的先后顺序一致，但是多线程环境下，编译器会对指令进行重排序，进而出现并发问题</li>
</ul>
<p>指令重排：</p>
<ul>
<li>编译器和处理器为了优化性能，对指令执行顺序进行调整，指令重排类型包括：编译器重排和cpu重排。为了避免多线程之间操作出现不同步现象，可以使用<code>volatile</code>和<code>synchorized</code>等来限制这种行为</li>
</ul>
<h4 data-id="heading-6">相关文章</h4>
<ul>
<li>CAS：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnote.youdao.com%2Fs%2FAJECfbdA" target="_blank" title="https://note.youdao.com/s/AJECfbdA" ref="nofollow noopener noreferrer">note.youdao.com/s/AJECfbdA</a></li>
<li>ThreadLocal：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnote.youdao.com%2Fs%2F7pvkie8N" target="_blank" title="https://note.youdao.com/s/7pvkie8N" ref="nofollow noopener noreferrer">note.youdao.com/s/7pvkie8N</a></li>
<li>CPU缓存架构：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnote.youdao.com%2Fs%2FALicPbhV" target="_blank" title="https://note.youdao.com/s/ALicPbhV" ref="nofollow noopener noreferrer">note.youdao.com/s/ALicPbhV</a></li>
<li>JUC并发工具类：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnote.youdao.com%2Fs%2FdbBcYl4a" target="_blank" title="https://note.youdao.com/s/dbBcYl4a" ref="nofollow noopener noreferrer">note.youdao.com/s/dbBcYl4a</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何实现划词效果]]></title>    <link>https://juejin.cn/post/7587998744294768646</link>    <guid>https://juejin.cn/post/7587998744294768646</guid>    <pubDate>2025-12-26T10:41:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587998744294768646" data-draft-id="7587392473851805742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何实现划词效果"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-26T10:41:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="june18"/> <meta itemprop="url" content="https://juejin.cn/user/1011206428561639"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何实现划词效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1011206428561639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    june18
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T10:41:11.000Z" title="Fri Dec 26 2025 10:41:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近做了一个划词的需求，想和大家分享一下。划词在富文本编辑器里比较常用，效果图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0eab5eec4d34614bd694046415016a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuZTE4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767350471&amp;x-signature=FgxGXQtTGDzxMI%2BnypfoIWsLr68%3D" alt="划词效果" loading="lazy"/></p>
<p>本篇文章将一步一步带大家实现这个效果。</p>
<h2 data-id="heading-0">实现字数统计</h2>
<h3 data-id="heading-1">前置知识</h3>
<h4 data-id="heading-2">window.getSelection</h4>
<p><code>window.getSelection</code> 可获取选中文本信息和选择内容，示例代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
  <span class="hljs-keyword">if</span> (selection) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'selection'</span>, selection)
    <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(selectedText);
  }
});
</code></pre>
<p>执行结果截图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db7ea8fbc6b84e929481a0e64fcb6c33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuZTE4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767350471&amp;x-signature=XhHbZgaVGNb0V%2F675o6tUnsc%2BQc%3D" alt="window.getSelection" loading="lazy"/></p>
<h3 data-id="heading-3">实现输入框</h3>
<p>主组件 <code>TextCustom</code>，包括两个组件：输入框和浮动工具栏。
这里的输入框是通过 <code>div</code> 元素模拟的，实现起来也很简单，只需要为 <code>div</code> 添加 <code>contentEditable</code> 属性 。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 模拟输入框 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span> // <span class="hljs-attr">后面会用</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span> // <span class="hljs-attr">suppressContentEditableWarning</span> <span class="hljs-attr">是</span> <span class="hljs-attr">React</span> <span class="hljs-attr">框架中的一个特殊属性</span>，<span class="hljs-attr">用于</span>‌<span class="hljs-attr">抑制</span>‌<span class="hljs-attr">contentEditable</span> <span class="hljs-attr">元素触发的常见警告</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-4">实现浮动工具栏组件</h3>
<h4 data-id="heading-5">浮动工具栏组件实现</h4>
<p>浮动工具栏组件是通过固定定位实现的，工具栏的位置是跟随选中文本的位置改变而改变的，主要属性是 <code>top</code> 和 <code>left</code>，默认值都先设置成 0。</p>
<p>浮动工具栏组件的内容是选中文本的字数统计，先硬编码成“x 字”。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">0</span>, // <span class="hljs-attr">在选中文本上方显示</span>
        <span class="hljs-attr">left:</span> <span class="hljs-attr">0</span>, // <span class="hljs-attr">居中显示</span>
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)", // <span class="hljs-attr">微调水平位置</span>
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">border:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> <span class="hljs-attr">red</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        📝 x 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h4 data-id="heading-6">引入到主组件</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 模拟输入框 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span> // <span class="hljs-attr">后面会用</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span> // <span class="hljs-attr">suppressContentEditableWarning</span> <span class="hljs-attr">是</span> <span class="hljs-attr">React</span> <span class="hljs-attr">框架中的一个特殊属性</span>，<span class="hljs-attr">用于</span>‌<span class="hljs-attr">抑制</span>‌<span class="hljs-attr">contentEditable</span> <span class="hljs-attr">元素触发的常见警告</span>
      /&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-7">实现自定义 hook</h3>
<p>封装自定义 hook，可命名为 <code>useTextSelection</code>，入参是输入框 id，返回 selection 和 toolbarRef。
其中 selection 是用来获取文本选择信息，包括选中文本的位置和选中的文本内容；toolbarRef 是工具栏的引用，后面的鼠标事件会用到，大概结构如下。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useTextSelection</span> = (<span class="hljs-params">target</span>) =&gt; {
  <span class="hljs-comment">// 存储文本选择信息</span>
  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  
  <span class="hljs-comment">// 标记用户是否正在与工具栏交互，比如点击工具栏</span>
  <span class="hljs-keyword">const</span> isInToolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 工具栏 DOM 元素的引用</span>
  <span class="hljs-keyword">const</span> toolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/**
     * 处理文本选择变化事件
     * 当用户在页面上选择文本时触发
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果用户正在与工具栏交互，不处理选择变化</span>
      <span class="hljs-keyword">if</span> (isInToolbarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
      <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

      <span class="hljs-comment">// 确保有选中文本并且选择范围有效</span>
      <span class="hljs-keyword">if</span> (selectedText &amp;&amp; selection.<span class="hljs-property">rangeCount</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> rect = range.<span class="hljs-title function_">getBoundingClientRect</span>(); <span class="hljs-comment">// 获取选中文本的位置和尺寸</span>

        <span class="hljs-comment">// 获取选中文本的锚点节点（选择的起始位置）</span>
        <span class="hljs-keyword">const</span> anchorNode = selection.<span class="hljs-property">anchorNode</span>;
        <span class="hljs-comment">// 获取目标编辑器元素</span>
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        
        <span class="hljs-comment">// 检查选择是否发生在目标编辑器内</span>
        <span class="hljs-keyword">const</span> isInTarget =
          targetElement &amp;&amp;
          (targetElement.<span class="hljs-title function_">contains</span>(anchorNode) || targetElement === anchorNode);

        <span class="hljs-keyword">if</span> (isInTarget) {
          <span class="hljs-comment">// 更新选择信息，显示工具栏</span>
          <span class="hljs-title function_">setSelection</span>({
            <span class="hljs-attr">clientRect</span>: rect,        <span class="hljs-comment">// 选中文本的位置信息</span>
            <span class="hljs-attr">selectedText</span>: selectedText, <span class="hljs-comment">// 选中的文本内容</span>
          });
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 选择不在编辑器内，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有选中文本，隐藏工具栏</span>
        <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标按下事件
     * 用于检测用户是否点击了工具栏区域
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">MouseEvent</span>} <span class="hljs-variable">e</span> - 鼠标事件对象
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏区域内</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 用户正在与工具栏交互</span>
      } <span class="hljs-keyword">else</span> {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 用户点击了工具栏外部</span>
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标抬起事件
     * 用户完成选择操作后，延迟检查选择内容
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 延迟 100ms 执行，确保浏览器已完成选择操作</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 如果用户没有与工具栏交互，处理选择变化</span>
        <span class="hljs-keyword">if</span> (!isInToolbarRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">handleSelectionChange</span>();
        }
      }, <span class="hljs-number">100</span>);
    };

    <span class="hljs-comment">/**
     * 处理点击外部事件
     * 当用户点击工具栏和编辑器外部时，隐藏工具栏
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">MouseEvent</span>} <span class="hljs-variable">e</span> - 鼠标事件对象
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClickOutside</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏外部</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; !toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        <span class="hljs-comment">// 检查点击是否也发生在编辑器外部</span>
        <span class="hljs-keyword">if</span> (targetElement &amp;&amp; !targetElement.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
          <span class="hljs-comment">// 重置选择信息，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      }
    };

    <span class="hljs-comment">// 添加事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange); <span class="hljs-comment">// 监听文本选择变化</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown); <span class="hljs-comment">// 监听鼠标按下</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp); <span class="hljs-comment">// 监听鼠标抬起</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside); <span class="hljs-comment">// 监听外部点击</span>

    <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);
    };
  }, [target]); <span class="hljs-comment">// 依赖项：当 target 变化时重新运行 effect</span>

  <span class="hljs-keyword">return</span> {
    selection,    <span class="hljs-comment">// 当前的选择信息</span>
    toolbarRef,   <span class="hljs-comment">// 工具栏的 ref 引用</span>
  };
}
</code></pre>
<p>主组件修改如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用自定义 Hook 获取文本选择信息和工具栏引用</span>
  <span class="hljs-keyword">const</span> { selection, toolbarRef } = <span class="hljs-title function_">useTextSelection</span>(<span class="hljs-string">"#editor"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">className</span>=<span class="hljs-string">{styles.editor}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span>
        <span class="hljs-attr">selection</span>=<span class="hljs-string">{selection}</span>
        <span class="hljs-attr">toolbarRef</span>=<span class="hljs-string">{toolbarRef}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p>浮动工具栏修改如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params">{
  selection,
  toolbarRef,
}</span>) =&gt; {
  <span class="hljs-comment">// 如果没有选择信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> { clientRect, selectedText } = selection;
  
  <span class="hljs-comment">// 如果没有选中文本或位置信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selectedText || !clientRect) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{toolbarRef}</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">clientRect.top</span> <span class="hljs-attr">-</span> <span class="hljs-attr">65</span>, // <span class="hljs-attr">在选中文本上方显示</span>，<span class="hljs-attr">65</span> <span class="hljs-attr">不是固定的</span>，<span class="hljs-attr">可以自行调整</span>
        <span class="hljs-attr">left:</span> <span class="hljs-attr">clientRect.left</span> + <span class="hljs-attr">clientRect.width</span> / <span class="hljs-attr">2</span>, // <span class="hljs-attr">居中显示</span>
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)", // <span class="hljs-attr">微调水平位置</span>
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">border:</span> "<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> <span class="hljs-attr">red</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        📝 {selectedText.length} 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h2 data-id="heading-8">实现加粗</h2>
<h3 data-id="heading-9">前置知识</h3>
<h4 data-id="heading-10">document.execCommand</h4>
<p><code>document.execCommand</code> 可对选中文本进行操作，比如加粗、斜体、下划线等，举个简单的例子。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>文本编辑器示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
   <span class="hljs-selector-class">.editor</span> {
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">min-height</span>: <span class="hljs-number">200px</span>;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"editor"</span>&gt;</span>
    请在这里输入文本，然后选中一部分文本并点击相应的按钮。
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"handleBold()"</span>&gt;</span>加粗<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"handleItalic()"</span>&gt;</span>斜体<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"handleUnderline()"</span>&gt;</span>下划线<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleBold</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"bold"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleItalic</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"italic"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleUnderline</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"underline"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df031f24e0f641e6a1d8819ecd12c024~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAganVuZTE4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767350471&amp;x-signature=RyYPGawTLaqM%2B7EMAfiPCU0ofk0%3D" alt="文本编辑器示例" loading="lazy"/></p>
<h4 data-id="heading-11">document.queryCommandState("bold")</h4>
<p><code>document.queryCommandState("bold")</code> 可获取加粗状态，返回布尔值。当选择的文本，只有部分加粗时也会返回 true。</p>
<h3 data-id="heading-12">修改主组件</h3>
<p>从自定义 Hook 中获取 <code>isBoldActive</code> 和 <code>handleBoldClick</code>，并传给浮动工具栏组件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用自定义 Hook 获取文本选择信息</span>
  <span class="hljs-keyword">const</span> { 
    selection, 
    toolbarRef, 
    isBoldActive, 
    handleBoldClick 
  } = <span class="hljs-title function_">useTextSelection</span>(<span class="hljs-string">"#editor"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 可编辑的文本区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>

      {/* 浮动工具栏组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span>
        <span class="hljs-attr">selection</span>=<span class="hljs-string">{selection}</span>
        <span class="hljs-attr">toolbarRef</span>=<span class="hljs-string">{toolbarRef}</span>
        <span class="hljs-attr">onBoldClick</span>=<span class="hljs-string">{handleBoldClick}</span>
        <span class="hljs-attr">isBoldActive</span>=<span class="hljs-string">{isBoldActive}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-13">修改浮动工具栏</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params">{
  selection,
  toolbarRef,
  onBoldClick,
  isBoldActive = <span class="hljs-literal">false</span>,
}</span>) =&gt; {
  <span class="hljs-comment">// 如果没有选择信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> { clientRect, selectedText, range } = selection;
  
  <span class="hljs-comment">// 如果没有选中文本或位置信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selectedText || !clientRect || !range) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{toolbarRef}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"floating-toolbar"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">clientRect.top</span> <span class="hljs-attr">-</span> <span class="hljs-attr">65</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">clientRect.left</span> + <span class="hljs-attr">clientRect.width</span> / <span class="hljs-attr">2</span>,
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)",
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
        <span class="hljs-attr">minWidth:</span> "<span class="hljs-attr">180px</span>",
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">fontSize:</span> "<span class="hljs-attr">12px</span>", <span class="hljs-attr">fontWeight:</span> "<span class="hljs-attr">bold</span>" }}&gt;</span>
        📝 {selectedText.length} 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 加粗按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onBoldClick &amp;&amp; onBoldClick(range)}
        title="加粗"
        style={{
          background: isBoldActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-14">修改自定义 Hook</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useTextSelection</span> = (<span class="hljs-params">target</span>) =&gt; {
  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isBoldActive, setIsBoldActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 标记用户是否正在与工具栏交互</span>
  <span class="hljs-keyword">const</span> isInToolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 工具栏 DOM 元素的引用</span>
  <span class="hljs-keyword">const</span> toolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 获取加粗状态</span>
  <span class="hljs-keyword">const</span> getBoldState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"bold"</span>);
  }, []);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/**
     * 处理文本选择变化事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果用户正在与工具栏交互，不处理选择变化</span>
      <span class="hljs-keyword">if</span> (isInToolbarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
      <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

      <span class="hljs-comment">// 确保有选中文本并且选择范围有效</span>
      <span class="hljs-keyword">if</span> (selectedText &amp;&amp; selection.<span class="hljs-property">rangeCount</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> rect = range.<span class="hljs-title function_">getBoundingClientRect</span>();

        <span class="hljs-keyword">const</span> anchorNode = selection.<span class="hljs-property">anchorNode</span>;
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        
        <span class="hljs-comment">// 检查选择是否发生在目标编辑器内</span>
        <span class="hljs-keyword">const</span> isInTarget =
          targetElement &amp;&amp;
          (targetElement.<span class="hljs-title function_">contains</span>(anchorNode) || targetElement === anchorNode);

        <span class="hljs-keyword">if</span> (isInTarget) {
          <span class="hljs-comment">// 保存选择范围</span>
          <span class="hljs-comment">// 更新选择信息，显示工具栏</span>
          <span class="hljs-title function_">setSelection</span>({
            <span class="hljs-attr">clientRect</span>: rect,
            <span class="hljs-attr">selectedText</span>: selectedText,
            <span class="hljs-attr">range</span>: range,
          });

          <span class="hljs-comment">// 获取当前加粗状态</span>
          <span class="hljs-title function_">setIsBoldActive</span>(<span class="hljs-title function_">getBoldState</span>());  <span class="hljs-comment">// 回显加粗使用</span>
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 选择不在编辑器内，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有选中文本，隐藏工具栏</span>
        <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标按下事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏区域内</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标抬起事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 延迟执行，确保浏览器已完成选择操作</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!isInToolbarRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">handleSelectionChange</span>();
        }
      }, <span class="hljs-number">100</span>);
    };

    <span class="hljs-comment">/**
     * 处理点击外部事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClickOutside</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; !toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        <span class="hljs-keyword">if</span> (targetElement &amp;&amp; !targetElement.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      }
    };

    <span class="hljs-comment">// 添加事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);

    <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);
    };
  }, [target, getBoldState]);

  <span class="hljs-comment">// 处理加粗操作</span>
  <span class="hljs-keyword">const</span> handleBoldClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行加粗命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"bold"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-title function_">setIsBoldActive</span>(<span class="hljs-title function_">getBoldState</span>());
  }, [getBoldState]);

  <span class="hljs-keyword">return</span> {
    selection,
    toolbarRef,
    isBoldActive,
    handleBoldClick,
  };
};
</code></pre>
<h2 data-id="heading-15">实现斜体</h2>
<p>加粗理解了，斜体就简单了，流程是一模一样的。</p>
<h3 data-id="heading-16">修改主组件</h3>
<p>从自定义 Hook 中获取 <code>isItalicActive</code> 和 <code>handleItalicClick</code>，并传给浮动工具栏组件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用自定义 Hook 获取文本选择信息</span>
  <span class="hljs-keyword">const</span> { 
    selection, 
    toolbarRef, 
    isBoldActive, 
    isItalicActive,
    handleBoldClick,
    handleItalicClick
  } = <span class="hljs-title function_">useTextSelection</span>(<span class="hljs-string">"#editor"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 可编辑的文本区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>

      {/* 浮动工具栏组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span>
        <span class="hljs-attr">selection</span>=<span class="hljs-string">{selection}</span>
        <span class="hljs-attr">toolbarRef</span>=<span class="hljs-string">{toolbarRef}</span>
        <span class="hljs-attr">onBoldClick</span>=<span class="hljs-string">{handleBoldClick}</span>
        <span class="hljs-attr">onItalicClick</span>=<span class="hljs-string">{handleItalicClick}</span>
        <span class="hljs-attr">isBoldActive</span>=<span class="hljs-string">{isBoldActive}</span>
        <span class="hljs-attr">isItalicActive</span>=<span class="hljs-string">{isItalicActive}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-17">修改浮动工具栏</h3>
<p>增加斜体按钮。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params">{
  selection,
  toolbarRef,
  onBoldClick,
  onItalicClick,
  isBoldActive = <span class="hljs-literal">false</span>,
  isItalicActive = <span class="hljs-literal">false</span>,
}</span>) =&gt; {
  <span class="hljs-comment">// 如果没有选择信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> { clientRect, selectedText, range } = selection;
  
  <span class="hljs-comment">// 如果没有选中文本或位置信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selectedText || !clientRect || !range) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{toolbarRef}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"floating-toolbar"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">clientRect.top</span> <span class="hljs-attr">-</span> <span class="hljs-attr">65</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">clientRect.left</span> + <span class="hljs-attr">clientRect.width</span> / <span class="hljs-attr">2</span>,
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)",
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
        <span class="hljs-attr">minWidth:</span> "<span class="hljs-attr">180px</span>",
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">fontSize:</span> "<span class="hljs-attr">12px</span>", <span class="hljs-attr">fontWeight:</span> "<span class="hljs-attr">bold</span>" }}&gt;</span>
        📝 {selectedText.length} 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 加粗按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onBoldClick &amp;&amp; onBoldClick(range)}
        title="加粗"
        style={{
          background: isBoldActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 斜体按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onItalicClick &amp;&amp; onItalicClick(range)}
        title="斜体"
        style={{
          background: isItalicActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          fontStyle: "italic",
        }}
      &gt;
        I
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-18">修改自定义 Hook</h3>
<p>主要有两处改动：</p>
<ol>
<li>封装了 <code>updateFormattingStates</code> 函数用于更新所有格式化状态，包括加粗和斜体。</li>
<li>增加处理斜体操作。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useTextSelection</span> = (<span class="hljs-params">target</span>) =&gt; {
  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isBoldActive, setIsBoldActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isItalicActive, setIsItalicActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 标记用户是否正在与工具栏交互</span>
  <span class="hljs-keyword">const</span> isInToolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 工具栏 DOM 元素的引用</span>
  <span class="hljs-keyword">const</span> toolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 获取加粗状态</span>
  <span class="hljs-keyword">const</span> getBoldState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"bold"</span>);
  }, []);

  <span class="hljs-comment">// 获取斜体状态</span>
  <span class="hljs-keyword">const</span> getItalicState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"italic"</span>);
  }, []);

  <span class="hljs-comment">// 更新所有格式化状态</span>
  <span class="hljs-keyword">const</span> updateFormattingStates = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setIsBoldActive</span>(<span class="hljs-title function_">getBoldState</span>());
    <span class="hljs-title function_">setIsItalicActive</span>(<span class="hljs-title function_">getItalicState</span>());
  }, [getBoldState, getItalicState]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/**
     * 处理文本选择变化事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果用户正在与工具栏交互，不处理选择变化</span>
      <span class="hljs-keyword">if</span> (isInToolbarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
      <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

      <span class="hljs-comment">// 确保有选中文本并且选择范围有效</span>
      <span class="hljs-keyword">if</span> (selectedText &amp;&amp; selection.<span class="hljs-property">rangeCount</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> rect = range.<span class="hljs-title function_">getBoundingClientRect</span>();

        <span class="hljs-keyword">const</span> anchorNode = selection.<span class="hljs-property">anchorNode</span>;
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        
        <span class="hljs-comment">// 检查选择是否发生在目标编辑器内</span>
        <span class="hljs-keyword">const</span> isInTarget =
          targetElement &amp;&amp;
          (targetElement.<span class="hljs-title function_">contains</span>(anchorNode) || targetElement === anchorNode);

        <span class="hljs-keyword">if</span> (isInTarget) {
          <span class="hljs-comment">// 保存选择范围</span>
          <span class="hljs-comment">// 更新选择信息，显示工具栏</span>
          <span class="hljs-title function_">setSelection</span>({
            <span class="hljs-attr">clientRect</span>: rect,
            <span class="hljs-attr">selectedText</span>: selectedText,
            <span class="hljs-attr">range</span>: range,
          });

          <span class="hljs-comment">// 获取当前格式化状态</span>
          <span class="hljs-title function_">updateFormattingStates</span>();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 选择不在编辑器内，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有选中文本，隐藏工具栏</span>
        <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标按下事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏区域内</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标抬起事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 延迟执行，确保浏览器已完成选择操作</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!isInToolbarRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">handleSelectionChange</span>();
        }
      }, <span class="hljs-number">100</span>);
    };

    <span class="hljs-comment">/**
     * 处理点击外部事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClickOutside</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; !toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        <span class="hljs-keyword">if</span> (targetElement &amp;&amp; !targetElement.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      }
    };

    <span class="hljs-comment">// 添加事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);

    <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);
    };
  }, [target, getBoldState]);

  <span class="hljs-comment">// 处理加粗操作</span>
  <span class="hljs-keyword">const</span> handleBoldClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行加粗命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"bold"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理斜体操作</span>
  <span class="hljs-keyword">const</span> handleItalicClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行斜体命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"italic"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 恢复选择范围并更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-keyword">return</span> {
    selection,
    toolbarRef,
    isBoldActive,
    handleBoldClick,
  };
};
</code></pre>
<h2 data-id="heading-19">实现下划线</h2>
<h3 data-id="heading-20">修改主组件</h3>
<p>从自定义 Hook 中获取 <code>isUnderlineActive</code> 和 <code>handleUnderlineClick</code>，并传给浮动工具栏组件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用自定义 Hook 获取文本选择信息</span>
  <span class="hljs-keyword">const</span> { 
    selection, 
    toolbarRef, 
    isBoldActive, 
    isItalicActive,
    isUnderlineActive,
    handleBoldClick,
    handleItalicClick,
    handleUnderlineClick,
  } = <span class="hljs-title function_">useTextSelection</span>(<span class="hljs-string">"#editor"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 可编辑的文本区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>

      {/* 浮动工具栏组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span>
        <span class="hljs-attr">selection</span>=<span class="hljs-string">{selection}</span>
        <span class="hljs-attr">toolbarRef</span>=<span class="hljs-string">{toolbarRef}</span>
        <span class="hljs-attr">onBoldClick</span>=<span class="hljs-string">{handleBoldClick}</span>
        <span class="hljs-attr">onItalicClick</span>=<span class="hljs-string">{handleItalicClick}</span>
        <span class="hljs-attr">onUnderlineClick</span>=<span class="hljs-string">{handleUnderlineClick}</span>
        <span class="hljs-attr">isBoldActive</span>=<span class="hljs-string">{isBoldActive}</span>
        <span class="hljs-attr">isItalicActive</span>=<span class="hljs-string">{isItalicActive}</span>
        <span class="hljs-attr">isUnderlineActive</span>=<span class="hljs-string">{isUnderlineActive}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-21">修改浮动工具栏</h3>
<p>增加下划线按钮。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params">{
  selection,
  toolbarRef,
  onBoldClick,
  onItalicClick,
  onUnderlineClick,
  isBoldActive = <span class="hljs-literal">false</span>,
  isItalicActive = <span class="hljs-literal">false</span>,
  isUnderlineActive = <span class="hljs-literal">false</span>,
}</span>) =&gt; {
  <span class="hljs-comment">// 如果没有选择信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> { clientRect, selectedText, range } = selection;
  
  <span class="hljs-comment">// 如果没有选中文本或位置信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selectedText || !clientRect || !range) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{toolbarRef}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"floating-toolbar"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">clientRect.top</span> <span class="hljs-attr">-</span> <span class="hljs-attr">65</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">clientRect.left</span> + <span class="hljs-attr">clientRect.width</span> / <span class="hljs-attr">2</span>,
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)",
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
        <span class="hljs-attr">minWidth:</span> "<span class="hljs-attr">180px</span>",
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">fontSize:</span> "<span class="hljs-attr">12px</span>", <span class="hljs-attr">fontWeight:</span> "<span class="hljs-attr">bold</span>" }}&gt;</span>
        📝 {selectedText.length} 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 加粗按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onBoldClick &amp;&amp; onBoldClick(range)}
        title="加粗"
        style={{
          background: isBoldActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 斜体按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onItalicClick &amp;&amp; onItalicClick(range)}
        title="斜体"
        style={{
          background: isItalicActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          fontStyle: "italic",
        }}
      &gt;
        I
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 下划线按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onUnderlineClick &amp;&amp; onUnderlineClick(range)}
        title="下划线"
        style={{
          background: isUnderlineActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          textDecoration: "underline",
        }}
      &gt;
        U
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-22">修改自定义 Hook</h3>
<p>主要有两处改动：</p>
<ol>
<li>增加获取下划线状态</li>
<li>增加处理下划线操作</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useTextSelection</span> = (<span class="hljs-params">target</span>) =&gt; {
  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isBoldActive, setIsBoldActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isItalicActive, setIsItalicActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isUnderlineActive, setIsUnderlineActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 标记用户是否正在与工具栏交互</span>
  <span class="hljs-keyword">const</span> isInToolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 工具栏 DOM 元素的引用</span>
  <span class="hljs-keyword">const</span> toolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 获取加粗状态</span>
  <span class="hljs-keyword">const</span> getBoldState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"bold"</span>);
  }, []);

  <span class="hljs-comment">// 获取斜体状态</span>
  <span class="hljs-keyword">const</span> getItalicState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"italic"</span>);
  }, []);

  <span class="hljs-comment">// 获取下划线状态</span>
  <span class="hljs-keyword">const</span> getUnderlineState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"underline"</span>);
  }, []);

  <span class="hljs-comment">// 更新所有格式化状态</span>
  <span class="hljs-keyword">const</span> updateFormattingStates = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setIsBoldActive</span>(<span class="hljs-title function_">getBoldState</span>());
    <span class="hljs-title function_">setIsItalicActive</span>(<span class="hljs-title function_">getItalicState</span>());
    <span class="hljs-title function_">setIsUnderlineActive</span>(<span class="hljs-title function_">getUnderlineState</span>());
  }, [getBoldState, getItalicState, getUnderlineState]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/**
     * 处理文本选择变化事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果用户正在与工具栏交互，不处理选择变化</span>
      <span class="hljs-keyword">if</span> (isInToolbarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
      <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

      <span class="hljs-comment">// 确保有选中文本并且选择范围有效</span>
      <span class="hljs-keyword">if</span> (selectedText &amp;&amp; selection.<span class="hljs-property">rangeCount</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> rect = range.<span class="hljs-title function_">getBoundingClientRect</span>();

        <span class="hljs-keyword">const</span> anchorNode = selection.<span class="hljs-property">anchorNode</span>;
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        
        <span class="hljs-comment">// 检查选择是否发生在目标编辑器内</span>
        <span class="hljs-keyword">const</span> isInTarget =
          targetElement &amp;&amp;
          (targetElement.<span class="hljs-title function_">contains</span>(anchorNode) || targetElement === anchorNode);

        <span class="hljs-keyword">if</span> (isInTarget) {
          <span class="hljs-comment">// 保存选择范围</span>
          <span class="hljs-comment">// 更新选择信息，显示工具栏</span>
          <span class="hljs-title function_">setSelection</span>({
            <span class="hljs-attr">clientRect</span>: rect,
            <span class="hljs-attr">selectedText</span>: selectedText,
            <span class="hljs-attr">range</span>: range,
          });

          <span class="hljs-comment">// 获取当前格式化状态</span>
          <span class="hljs-title function_">updateFormattingStates</span>();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 选择不在编辑器内，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有选中文本，隐藏工具栏</span>
        <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标按下事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏区域内</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标抬起事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 延迟执行，确保浏览器已完成选择操作</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!isInToolbarRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">handleSelectionChange</span>();
        }
      }, <span class="hljs-number">100</span>);
    };

    <span class="hljs-comment">/**
     * 处理点击外部事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClickOutside</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; !toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        <span class="hljs-keyword">if</span> (targetElement &amp;&amp; !targetElement.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      }
    };

    <span class="hljs-comment">// 添加事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);

    <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);
    };
  }, [target, getBoldState]);

  <span class="hljs-comment">// 处理加粗操作</span>
  <span class="hljs-keyword">const</span> handleBoldClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行加粗命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"bold"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理斜体操作</span>
  <span class="hljs-keyword">const</span> handleItalicClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行斜体命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"italic"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 恢复选择范围并更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理下划线操作</span>
  <span class="hljs-keyword">const</span> handleUnderlineClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行下划线命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"underline"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-keyword">return</span> {
    selection,
    toolbarRef,
    isBoldActive,
    handleBoldClick,
  };
};
</code></pre>
<h2 data-id="heading-23">实现字号</h2>
<h3 data-id="heading-24">修改主组件</h3>
<p>从自定义 Hook 中获取 <code>fontSize</code> 和 <code>handleFontSizeChange</code>，并传给浮动工具栏组件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用自定义 Hook 获取文本选择信息</span>
  <span class="hljs-keyword">const</span> { 
    selection, 
    toolbarRef, 
    isBoldActive, 
    isItalicActive,
    isUnderlineActive,
    fontSize,
    handleBoldClick,
    handleItalicClick,
    handleUnderlineClick,
    handleFontSizeChange,
  } = <span class="hljs-title function_">useTextSelection</span>(<span class="hljs-string">"#editor"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 可编辑的文本区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>

      {/* 浮动工具栏组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span>
        <span class="hljs-attr">selection</span>=<span class="hljs-string">{selection}</span>
        <span class="hljs-attr">toolbarRef</span>=<span class="hljs-string">{toolbarRef}</span>
        <span class="hljs-attr">onBoldClick</span>=<span class="hljs-string">{handleBoldClick}</span>
        <span class="hljs-attr">onItalicClick</span>=<span class="hljs-string">{handleItalicClick}</span>
        <span class="hljs-attr">onUnderlineClick</span>=<span class="hljs-string">{handleUnderlineClick}</span>
        <span class="hljs-attr">onFontSizeChange</span>=<span class="hljs-string">{handleFontSizeChange}</span>
        <span class="hljs-attr">isBoldActive</span>=<span class="hljs-string">{isBoldActive}</span>
        <span class="hljs-attr">isItalicActive</span>=<span class="hljs-string">{isItalicActive}</span>
        <span class="hljs-attr">isUnderlineActive</span>=<span class="hljs-string">{isUnderlineActive}</span>
        <span class="hljs-attr">fontSize</span>=<span class="hljs-string">{fontSize}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-25">修改浮动工具栏</h3>
<p>主要增加字号选择器。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params">{
  selection,
  toolbarRef,
  onBoldClick,
  onItalicClick,
  onUnderlineClick,
  onFontSizeChange,
  isBoldActive = <span class="hljs-literal">false</span>,
  isItalicActive = <span class="hljs-literal">false</span>,
  isUnderlineActive = <span class="hljs-literal">false</span>,
  fontSize = <span class="hljs-string">"3"</span>,
}</span>) =&gt; {
  <span class="hljs-comment">// 如果没有选择信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> { clientRect, selectedText, range } = selection;
  
  <span class="hljs-comment">// 如果没有选中文本或位置信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selectedText || !clientRect || !range) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{toolbarRef}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"floating-toolbar"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">clientRect.top</span> <span class="hljs-attr">-</span> <span class="hljs-attr">65</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">clientRect.left</span> + <span class="hljs-attr">clientRect.width</span> / <span class="hljs-attr">2</span>,
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)",
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
        <span class="hljs-attr">minWidth:</span> "<span class="hljs-attr">180px</span>",
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">fontSize:</span> "<span class="hljs-attr">12px</span>", <span class="hljs-attr">fontWeight:</span> "<span class="hljs-attr">bold</span>" }}&gt;</span>
        📝 {selectedText.length} 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 加粗按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onBoldClick &amp;&amp; onBoldClick(range)}
        title="加粗"
        style={{
          background: isBoldActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 斜体按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onItalicClick &amp;&amp; onItalicClick(range)}
        title="斜体"
        style={{
          background: isItalicActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          fontStyle: "italic",
        }}
      &gt;
        I
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 下划线按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onUnderlineClick &amp;&amp; onUnderlineClick(range)}
        title="下划线"
        style={{
          background: isUnderlineActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          textDecoration: "underline",
        }}
      &gt;
        U
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 字号选择器 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">select</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{fontSize}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> onFontSizeChange &amp;&amp; onFontSizeChange(e.target.value, range)}
        onMouseDown={(e) =&gt; e.stopPropagation()}
        onClick={(e) =&gt; e.stopPropagation()}
        style={{
          background: "#999",
          color: "white",
          border: "1px solid #999",
          borderRadius: "4px",
          padding: "6px 10px",
          cursor: "pointer",
          fontSize: "12px",
          width: "90px",
          appearance: "auto",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>&gt;</span>12px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"2"</span>&gt;</span>14px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"3"</span>&gt;</span>16px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"4"</span>&gt;</span>18px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"5"</span>&gt;</span>24px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"6"</span>&gt;</span>32px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"7"</span>&gt;</span>48px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

      {/* 颜色选择器 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"color"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{color}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> onColorChange &amp;&amp; onColorChange(e.target.value, range)}
        title="文字颜色"
        style={{
          width: "36px",
          height: "36px",
          border: "2px solid #4a627a",
          borderRadius: "6px",
          cursor: "pointer",
          padding: "0",
          backgroundColor: color || "#ffffff",
        }}
        onMouseDown={(e) =&gt; e.stopPropagation()}
        onClick={(e) =&gt; e.stopPropagation()}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-26">修改自定义 Hook</h3>
<p>字号和后面的颜色都是通过增加嵌套 <code>span</code> 标签实现的。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useTextSelection</span> = (<span class="hljs-params">target</span>) =&gt; {
  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isBoldActive, setIsBoldActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isItalicActive, setIsItalicActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isUnderlineActive, setIsUnderlineActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [fontSize, setFontSize] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"3"</span>);
  
  <span class="hljs-comment">// 标记用户是否正在与工具栏交互</span>
  <span class="hljs-keyword">const</span> isInToolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 工具栏 DOM 元素的引用</span>
  <span class="hljs-keyword">const</span> toolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 获取加粗状态</span>
  <span class="hljs-keyword">const</span> getBoldState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"bold"</span>);
  }, []);

  <span class="hljs-comment">// 获取斜体状态</span>
  <span class="hljs-keyword">const</span> getItalicState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"italic"</span>);
  }, []);

  <span class="hljs-comment">// 获取下划线状态</span>
  <span class="hljs-keyword">const</span> getUnderlineState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"underline"</span>);
  }, []);

  <span class="hljs-comment">// 获取当前选择的字号</span>
  <span class="hljs-keyword">const</span> getFontSizeState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
    <span class="hljs-keyword">if</span> (!selection.<span class="hljs-property">rangeCount</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"3"</span>;

    <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">let</span> element = range.<span class="hljs-property">startContainer</span>;
    <span class="hljs-keyword">if</span> (element.<span class="hljs-property">nodeType</span> !== <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
      element = element.<span class="hljs-property">parentElement</span>;
    }

    <span class="hljs-comment">// 遍历父元素查找字体大小</span>
    <span class="hljs-keyword">while</span> (element &amp;&amp; element !== <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target)) {
      <span class="hljs-keyword">if</span> (element.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
        <span class="hljs-keyword">const</span> computedStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(element);
        <span class="hljs-keyword">const</span> computedFontSize = computedStyle.<span class="hljs-property">fontSize</span>;

        <span class="hljs-keyword">if</span> (computedFontSize) {
          <span class="hljs-keyword">const</span> sizeInPx = <span class="hljs-built_in">parseInt</span>(computedFontSize);
          <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">42</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"7"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">28</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"6"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">22</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"5"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">17</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"4"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">15</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"3"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">13</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"2"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"1"</span>;
        }
      }
      element = element.<span class="hljs-property">parentElement</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-string">"3"</span>;
  }, [target]);

  <span class="hljs-comment">// 更新所有格式化状态</span>
  <span class="hljs-keyword">const</span> updateFormattingStates = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setIsBoldActive</span>(<span class="hljs-title function_">getBoldState</span>());
    <span class="hljs-title function_">setIsItalicActive</span>(<span class="hljs-title function_">getItalicState</span>());
    <span class="hljs-title function_">setIsUnderlineActive</span>(<span class="hljs-title function_">getUnderlineState</span>());
    <span class="hljs-title function_">setFontSize</span>(<span class="hljs-title function_">getFontSizeState</span>());
  }, [getBoldState, getItalicState, getUnderlineState, getFontSizeState]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/**
     * 处理文本选择变化事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果用户正在与工具栏交互，不处理选择变化</span>
      <span class="hljs-keyword">if</span> (isInToolbarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
      <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

      <span class="hljs-comment">// 确保有选中文本并且选择范围有效</span>
      <span class="hljs-keyword">if</span> (selectedText &amp;&amp; selection.<span class="hljs-property">rangeCount</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> rect = range.<span class="hljs-title function_">getBoundingClientRect</span>();

        <span class="hljs-keyword">const</span> anchorNode = selection.<span class="hljs-property">anchorNode</span>;
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        
        <span class="hljs-comment">// 检查选择是否发生在目标编辑器内</span>
        <span class="hljs-keyword">const</span> isInTarget =
          targetElement &amp;&amp;
          (targetElement.<span class="hljs-title function_">contains</span>(anchorNode) || targetElement === anchorNode);

        <span class="hljs-keyword">if</span> (isInTarget) {
          <span class="hljs-comment">// 保存选择范围</span>
          <span class="hljs-comment">// 更新选择信息，显示工具栏</span>
          <span class="hljs-title function_">setSelection</span>({
            <span class="hljs-attr">clientRect</span>: rect,
            <span class="hljs-attr">selectedText</span>: selectedText,
            <span class="hljs-attr">range</span>: range,
          });

          <span class="hljs-comment">// 获取当前格式化状态</span>
          <span class="hljs-title function_">updateFormattingStates</span>();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 选择不在编辑器内，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有选中文本，隐藏工具栏</span>
        <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标按下事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏区域内</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标抬起事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 延迟执行，确保浏览器已完成选择操作</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!isInToolbarRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">handleSelectionChange</span>();
        }
      }, <span class="hljs-number">100</span>);
    };

    <span class="hljs-comment">/**
     * 处理点击外部事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClickOutside</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; !toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        <span class="hljs-keyword">if</span> (targetElement &amp;&amp; !targetElement.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      }
    };

    <span class="hljs-comment">// 添加事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);

    <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);
    };
  }, [target, getBoldState]);

  <span class="hljs-comment">// 设置字体大小</span>
  <span class="hljs-keyword">const</span> setFontSizeCommand = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">sizeValue, range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
    selection.<span class="hljs-title function_">removeAllRanges</span>();
    selection.<span class="hljs-title function_">addRange</span>(range);

    <span class="hljs-keyword">const</span> newRange = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>);

    <span class="hljs-keyword">const</span> sizeMap = {
      <span class="hljs-string">"1"</span>: <span class="hljs-string">"12px"</span>,
      <span class="hljs-string">"2"</span>: <span class="hljs-string">"14px"</span>,
      <span class="hljs-string">"3"</span>: <span class="hljs-string">"16px"</span>,
      <span class="hljs-string">"4"</span>: <span class="hljs-string">"18px"</span>,
      <span class="hljs-string">"5"</span>: <span class="hljs-string">"24px"</span>,
      <span class="hljs-string">"6"</span>: <span class="hljs-string">"32px"</span>,
      <span class="hljs-string">"7"</span>: <span class="hljs-string">"48px"</span>,
    };

    span.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = sizeMap[sizeValue] || <span class="hljs-string">"16px"</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 检查选择范围是否已折叠（即没有选中文本，只有一个光标位置）</span>
      <span class="hljs-comment">// 如果是折叠状态，不执行字体大小设置操作</span>
      <span class="hljs-keyword">if</span> (newRange.<span class="hljs-property">collapsed</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> clonedRange = newRange.<span class="hljs-title function_">cloneRange</span>();
      <span class="hljs-keyword">const</span> fragment = clonedRange.<span class="hljs-title function_">extractContents</span>();
      span.<span class="hljs-title function_">appendChild</span>(fragment);
      clonedRange.<span class="hljs-title function_">insertNode</span>(span);

      <span class="hljs-comment">// 清除当前选择，然后重新选中刚刚插入的span元素内容</span>
      <span class="hljs-comment">// 这样用户可以继续对同一段文本进行其他操作</span>
      selection.<span class="hljs-title function_">removeAllRanges</span>();
      <span class="hljs-keyword">const</span> newSelectionRange = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createRange</span>();
      newSelectionRange.<span class="hljs-title function_">selectNodeContents</span>(span);
      selection.<span class="hljs-title function_">addRange</span>(newSelectionRange);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"设置字体大小失败:"</span>, error);
    }

    <span class="hljs-comment">// 更新状态</span>
    <span class="hljs-title function_">setFontSize</span>(sizeValue);
  }, []);

  <span class="hljs-comment">// 处理加粗操作</span>
  <span class="hljs-keyword">const</span> handleBoldClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行加粗命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"bold"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理斜体操作</span>
  <span class="hljs-keyword">const</span> handleItalicClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行斜体命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"italic"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 恢复选择范围并更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理下划线操作</span>
  <span class="hljs-keyword">const</span> handleUnderlineClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行下划线命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"underline"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理字号变化</span>
  <span class="hljs-keyword">const</span> handleFontSizeChange = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">sizeValue, range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-title function_">setFontSizeCommand</span>(sizeValue, range);
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [setFontSizeCommand, updateFormattingStates]);

  <span class="hljs-keyword">return</span> {
    selection,
    toolbarRef,
    isBoldActive,
    handleBoldClick,
  };
};
</code></pre>
<h2 data-id="heading-27">实现颜色</h2>
<h3 data-id="heading-28">修改主组件</h3>
<p>从自定义 Hook 中获取 <code>color</code> 和 <code>handleColorChange</code>，并传给浮动工具栏组件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">TextCustom</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 使用自定义 Hook 获取文本选择信息</span>
  <span class="hljs-keyword">const</span> { 
    selection, 
    toolbarRef, 
    isBoldActive, 
    isItalicActive,
    isUnderlineActive,
    fontSize,
    handleBoldClick,
    handleItalicClick,
    handleUnderlineClick,
    handleFontSizeChange,
  } = <span class="hljs-title function_">useTextSelection</span>(<span class="hljs-string">"#editor"</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 可编辑的文本区域 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">id</span>=<span class="hljs-string">"editor"</span>
        <span class="hljs-attr">contentEditable</span>=<span class="hljs-string">{true}</span>
        <span class="hljs-attr">suppressContentEditableWarning</span>=<span class="hljs-string">{true}</span>
      /&gt;</span>

      {/* 浮动工具栏组件 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">FloatingToolbar</span>
        <span class="hljs-attr">selection</span>=<span class="hljs-string">{selection}</span>
        <span class="hljs-attr">toolbarRef</span>=<span class="hljs-string">{toolbarRef}</span>
        <span class="hljs-attr">onBoldClick</span>=<span class="hljs-string">{handleBoldClick}</span>
        <span class="hljs-attr">onItalicClick</span>=<span class="hljs-string">{handleItalicClick}</span>
        <span class="hljs-attr">onUnderlineClick</span>=<span class="hljs-string">{handleUnderlineClick}</span>
        <span class="hljs-attr">onFontSizeChange</span>=<span class="hljs-string">{handleFontSizeChange}</span>
        <span class="hljs-attr">onColorChange</span>=<span class="hljs-string">{handleColorChange}</span>
        <span class="hljs-attr">isBoldActive</span>=<span class="hljs-string">{isBoldActive}</span>
        <span class="hljs-attr">isItalicActive</span>=<span class="hljs-string">{isItalicActive}</span>
        <span class="hljs-attr">isUnderlineActive</span>=<span class="hljs-string">{isUnderlineActive}</span>
        <span class="hljs-attr">fontSize</span>=<span class="hljs-string">{fontSize}</span>
        <span class="hljs-attr">color</span>=<span class="hljs-string">{color}</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-29">修改浮动工具栏</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">FloatingToolbar</span> = (<span class="hljs-params">{
  selection,
  toolbarRef,
  onBoldClick,
  onItalicClick,
  onUnderlineClick,
  onFontSizeChange,
  onColorChange,
  isBoldActive = <span class="hljs-literal">false</span>,
  isItalicActive = <span class="hljs-literal">false</span>,
  isUnderlineActive = <span class="hljs-literal">false</span>,
  fontSize = <span class="hljs-string">"3"</span>,
  color = <span class="hljs-string">"#000000"</span>,
}</span>) =&gt; {
  <span class="hljs-comment">// 如果没有选择信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">const</span> { clientRect, selectedText, range } = selection;
  
  <span class="hljs-comment">// 如果没有选中文本或位置信息，不渲染工具栏</span>
  <span class="hljs-keyword">if</span> (!selectedText || !clientRect || !range) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
      <span class="hljs-attr">ref</span>=<span class="hljs-string">{toolbarRef}</span>
      <span class="hljs-attr">className</span>=<span class="hljs-string">"floating-toolbar"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">position:</span> "<span class="hljs-attr">fixed</span>",
        <span class="hljs-attr">top:</span> <span class="hljs-attr">clientRect.top</span> <span class="hljs-attr">-</span> <span class="hljs-attr">65</span>,
        <span class="hljs-attr">left:</span> <span class="hljs-attr">clientRect.left</span> + <span class="hljs-attr">clientRect.width</span> / <span class="hljs-attr">2</span>,
        <span class="hljs-attr">transform:</span> "<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-10</span>%)",
        <span class="hljs-attr">background:</span> "#<span class="hljs-attr">fff</span>",
        <span class="hljs-attr">zIndex:</span> <span class="hljs-attr">10000</span>,
        <span class="hljs-attr">minWidth:</span> "<span class="hljs-attr">180px</span>",
      }}
    &gt;</span>
      {/* 显示选中文本的字符数量 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">fontSize:</span> "<span class="hljs-attr">12px</span>", <span class="hljs-attr">fontWeight:</span> "<span class="hljs-attr">bold</span>" }}&gt;</span>
        📝 {selectedText.length} 字
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      {/* 加粗按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onBoldClick &amp;&amp; onBoldClick(range)}
        title="加粗"
        style={{
          background: isBoldActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 斜体按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onItalicClick &amp;&amp; onItalicClick(range)}
        title="斜体"
        style={{
          background: isItalicActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          fontStyle: "italic",
        }}
      &gt;
        I
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 下划线按钮 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onUnderlineClick &amp;&amp; onUnderlineClick(range)}
        title="下划线"
        style={{
          background: isUnderlineActive ? "#3498db" : "#999",
          border: "none",
          color: "white",
          width: "36px",
          height: "36px",
          borderRadius: "6px",
          cursor: "pointer",
          display: "flex",
          alignItems: "center",
          justifyContent: "center",
          fontSize: "14px",
          textDecoration: "underline",
        }}
      &gt;
        U
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 字号选择器 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">select</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{fontSize}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> onFontSizeChange &amp;&amp; onFontSizeChange(e.target.value, range)}
        onMouseDown={(e) =&gt; e.stopPropagation()}
        onClick={(e) =&gt; e.stopPropagation()}
        style={{
          background: "#999",
          color: "white",
          border: "1px solid #999",
          borderRadius: "4px",
          padding: "6px 10px",
          cursor: "pointer",
          fontSize: "12px",
          width: "90px",
          appearance: "auto",
        }}
      &gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>&gt;</span>12px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"2"</span>&gt;</span>14px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"3"</span>&gt;</span>16px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"4"</span>&gt;</span>18px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"5"</span>&gt;</span>24px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"6"</span>&gt;</span>32px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"7"</span>&gt;</span>48px<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span>

      {/* 颜色选择器 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"color"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{color}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> onColorChange &amp;&amp; onColorChange(e.target.value, range)}
        title="文字颜色"
        style={{
          width: "36px",
          height: "36px",
          border: "2px solid #4a627a",
          borderRadius: "6px",
          cursor: "pointer",
          padding: "0",
          backgroundColor: color || "#ffffff",
        }}
        onMouseDown={(e) =&gt; e.stopPropagation()}
        onClick={(e) =&gt; e.stopPropagation()}
      /&gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-30">修改自定义 Hook</h3>
<p>在看具体实现前，先认识一个 API，<code>document.createTreeWalke</code> 是一个用于 <strong>深度优先遍历 DOM 树</strong> 的接口。</p>
<p>基本语法</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> walker = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTreeWalker</span>(
  root,          <span class="hljs-comment">// 遍历的起始节点</span>
  whatToShow,    <span class="hljs-comment">// 要显示哪些类型的节点</span>
  filter         <span class="hljs-comment">// 可选的过滤器函数</span>
);
</code></pre>
<p>简单示例</p>
<pre><code class="hljs language-js" lang="js">&lt;div id=<span class="hljs-string">"container"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>文本<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>项目1<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>项目2<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
&lt;/div&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> container = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'container'</span>);

<span class="hljs-comment">// 创建 TreeWalker： 从 container 开始，只遍历元素节点</span>
<span class="hljs-keyword">const</span> walker = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTreeWalker</span>(
  container,
  <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">SHOW_ELEMENT</span>,  <span class="hljs-comment">// 只显示元素节点</span>
  <span class="hljs-literal">null</span>  <span class="hljs-comment">// 不过滤</span>
);

<span class="hljs-keyword">const</span> nodes = [];
<span class="hljs-keyword">let</span> node;
<span class="hljs-keyword">while</span> (node = walker.<span class="hljs-title function_">nextNode</span>()) {
  nodes.<span class="hljs-title function_">push</span>(node.<span class="hljs-property">tagName</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(nodes); <span class="hljs-comment">// 输出: ["H1", "P", "SPAN", "UL", "LI", "LI"] 深度优先遍历顺序</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useTextSelection</span> = (<span class="hljs-params">target</span>) =&gt; {
  <span class="hljs-keyword">const</span> [selection, setSelection] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isBoldActive, setIsBoldActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isItalicActive, setIsItalicActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [isUnderlineActive, setIsUnderlineActive] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [fontSize, setFontSize] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"3"</span>);
  <span class="hljs-keyword">const</span> [color, setColor] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"#000000"</span>);
  
  <span class="hljs-comment">// 标记用户是否正在与工具栏交互</span>
  <span class="hljs-keyword">const</span> isInToolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">false</span>);
  
  <span class="hljs-comment">// 工具栏 DOM 元素的引用</span>
  <span class="hljs-keyword">const</span> toolbarRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// RGB 转十六进制辅助函数</span>
  <span class="hljs-keyword">const</span> rgbToHex = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">rgb</span>) =&gt;</span> {
    <span class="hljs-comment">// 如果已经是十六进制格式，直接返回</span>
    <span class="hljs-keyword">if</span> (rgb.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"#"</span>)) <span class="hljs-keyword">return</span> rgb;

    <span class="hljs-comment">// 匹配 RGB 或 RGBA 格式：rgb(255, 255, 255) 或 rgba(255, 255, 255, 0.5)</span>
    <span class="hljs-keyword">const</span> match = rgb.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/</span>);
    <span class="hljs-keyword">if</span> (match) {
      <span class="hljs-keyword">const</span> r = <span class="hljs-built_in">parseInt</span>(match[<span class="hljs-number">1</span>]);
      <span class="hljs-keyword">const</span> g = <span class="hljs-built_in">parseInt</span>(match[<span class="hljs-number">2</span>]);
      <span class="hljs-keyword">const</span> b = <span class="hljs-built_in">parseInt</span>(match[<span class="hljs-number">3</span>]);

      <span class="hljs-comment">// 将 RGB 值转换为十六进制，并确保两位显示</span>
      <span class="hljs-keyword">return</span> (
        <span class="hljs-string">"#"</span> +
        r.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"0"</span>) +
        g.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"0"</span>) +
        b.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"0"</span>)
      );
    }

    <span class="hljs-comment">// 无法解析的颜色，返回默认黑色</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"#000000"</span>;
  }, []);

  <span class="hljs-comment">// 获取加粗状态</span>
  <span class="hljs-keyword">const</span> getBoldState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"bold"</span>);
  }, []);

  <span class="hljs-comment">// 获取斜体状态</span>
  <span class="hljs-keyword">const</span> getItalicState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"italic"</span>);
  }, []);

  <span class="hljs-comment">// 获取下划线状态</span>
  <span class="hljs-keyword">const</span> getUnderlineState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">document</span>.<span class="hljs-property">queryCommandState</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">queryCommandState</span>(<span class="hljs-string">"underline"</span>);
  }, []);

  <span class="hljs-comment">// 获取当前选择的字号</span>
  <span class="hljs-keyword">const</span> getFontSizeState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
    <span class="hljs-keyword">if</span> (!selection.<span class="hljs-property">rangeCount</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"3"</span>;

    <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);

    <span class="hljs-keyword">let</span> element = range.<span class="hljs-property">startContainer</span>;
    <span class="hljs-keyword">if</span> (element.<span class="hljs-property">nodeType</span> !== <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
      element = element.<span class="hljs-property">parentElement</span>;
    }

    <span class="hljs-comment">// 遍历父元素查找字体大小</span>
    <span class="hljs-keyword">while</span> (element &amp;&amp; element !== <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target)) {
      <span class="hljs-keyword">if</span> (element.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
        <span class="hljs-keyword">const</span> computedStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(element);
        <span class="hljs-keyword">const</span> computedFontSize = computedStyle.<span class="hljs-property">fontSize</span>;

        <span class="hljs-keyword">if</span> (computedFontSize) {
          <span class="hljs-keyword">const</span> sizeInPx = <span class="hljs-built_in">parseInt</span>(computedFontSize);
          <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">42</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"7"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">28</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"6"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">22</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"5"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">17</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"4"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">15</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"3"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sizeInPx &gt;= <span class="hljs-number">13</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"2"</span>;
          <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"1"</span>;
        }
      }
      element = element.<span class="hljs-property">parentElement</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-string">"3"</span>;
  }, [target]);

  <span class="hljs-comment">// 获取当前选择的颜色</span>
  <span class="hljs-keyword">const</span> getColorState = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
    <span class="hljs-keyword">if</span> (!selection.<span class="hljs-property">rangeCount</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"#000000"</span>;

    <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> commonAncestor = range.<span class="hljs-property">commonAncestorContainer</span>;

    <span class="hljs-keyword">let</span> element = range.<span class="hljs-property">startContainer</span>;
    <span class="hljs-keyword">if</span> (element.<span class="hljs-property">nodeType</span> !== <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
      element = element.<span class="hljs-property">parentElement</span>;
    }

    <span class="hljs-comment">// 遍历父元素查找颜色</span>
    <span class="hljs-keyword">while</span> (element &amp;&amp; element !== <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target)) {
      <span class="hljs-keyword">if</span> (element.<span class="hljs-property">nodeType</span> === <span class="hljs-title class_">Node</span>.<span class="hljs-property">ELEMENT_NODE</span>) {
        <span class="hljs-keyword">const</span> computedStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(element);
        <span class="hljs-keyword">const</span> computedColor = computedStyle.<span class="hljs-property">color</span>;

        <span class="hljs-comment">// 检查颜色是否为有效值（非透明、非默认黑色）</span>
        <span class="hljs-keyword">if</span> (
          computedColor &amp;&amp;
          computedColor !== <span class="hljs-string">"rgba(0, 0, 0, 0)"</span> &amp;&amp;
          computedColor !== <span class="hljs-string">"transparent"</span> &amp;&amp;
          !computedColor.<span class="hljs-title function_">startsWith</span>(<span class="hljs-params"><span class="hljs-string">"rgba(0, 0, 0, "</span></span>)
        ) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">rgbToHex</span>(computedColor);
        }
      }
      element = element.<span class="hljs-property">parentElement</span>;
    }

    <span class="hljs-comment">// 如果没有找到，检查选择范围内的元素</span>
    <span class="hljs-keyword">const</span> walker = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTreeWalker</span>(
      commonAncestor,
      <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">SHOW_ELEMENT</span>,
      {
        <span class="hljs-attr">acceptNode</span>: <span class="hljs-function">(<span class="hljs-params">node</span>) =&gt;</span>
          range.<span class="hljs-title function_">intersectsNode</span>(node)
            ? <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">FILTER_ACCEPT</span>
            : <span class="hljs-title class_">NodeFilter</span>.<span class="hljs-property">FILTER_REJECT</span>,
      },
    );

    <span class="hljs-comment">// 当向上遍历找不到颜色时，它会深度遍历选择范围内的所有元素，找到第一个有效的文本颜色。</span>
    <span class="hljs-keyword">while</span> ((element = walker.<span class="hljs-title function_">nextNode</span>())) {
      <span class="hljs-keyword">const</span> computedStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(element);
      <span class="hljs-keyword">const</span> computedColor = computedStyle.<span class="hljs-property">color</span>;

      <span class="hljs-keyword">if</span> (
        computedColor &amp;&amp;
        computedColor !== <span class="hljs-string">"rgba(0, 0, 0, 0)"</span> &amp;&amp;
        computedColor !== <span class="hljs-string">"transparent"</span> &amp;&amp;
        !computedColor.<span class="hljs-title function_">startsWith</span>(<span class="hljs-params"><span class="hljs-string">"rgba(0, 0, 0, "</span></span>)
      ) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">rgbToHex</span>(computedColor);
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-string">"#000000"</span>;
  }, [target, rgbToHex]);

  <span class="hljs-comment">// 更新所有格式化状态</span>
  <span class="hljs-keyword">const</span> updateFormattingStates = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setIsBoldActive</span>(<span class="hljs-title function_">getBoldState</span>());
    <span class="hljs-title function_">setIsItalicActive</span>(<span class="hljs-title function_">getItalicState</span>());
    <span class="hljs-title function_">setIsUnderlineActive</span>(<span class="hljs-title function_">getUnderlineState</span>());
    <span class="hljs-title function_">setFontSize</span>(<span class="hljs-title function_">getFontSizeState</span>());
    <span class="hljs-title function_">setColor</span>(<span class="hljs-title function_">getColorState</span>());
  }, [getBoldState, getItalicState, getUnderlineState, getFontSizeState, getColorState]);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">/**
     * 处理文本选择变化事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSelectionChange</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 如果用户正在与工具栏交互，不处理选择变化</span>
      <span class="hljs-keyword">if</span> (isInToolbarRef.<span class="hljs-property">current</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
      <span class="hljs-keyword">const</span> selectedText = selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();

      <span class="hljs-comment">// 确保有选中文本并且选择范围有效</span>
      <span class="hljs-keyword">if</span> (selectedText &amp;&amp; selection.<span class="hljs-property">rangeCount</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
        <span class="hljs-keyword">const</span> rect = range.<span class="hljs-title function_">getBoundingClientRect</span>();

        <span class="hljs-keyword">const</span> anchorNode = selection.<span class="hljs-property">anchorNode</span>;
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        
        <span class="hljs-comment">// 检查选择是否发生在目标编辑器内</span>
        <span class="hljs-keyword">const</span> isInTarget =
          targetElement &amp;&amp;
          (targetElement.<span class="hljs-title function_">contains</span>(anchorNode) || targetElement === anchorNode);

        <span class="hljs-keyword">if</span> (isInTarget) {
          <span class="hljs-comment">// 保存选择范围</span>
          <span class="hljs-comment">// 更新选择信息，显示工具栏</span>
          <span class="hljs-title function_">setSelection</span>({
            <span class="hljs-attr">clientRect</span>: rect,
            <span class="hljs-attr">selectedText</span>: selectedText,
            <span class="hljs-attr">range</span>: range,
          });

          <span class="hljs-comment">// 获取当前格式化状态</span>
          <span class="hljs-title function_">updateFormattingStates</span>();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-comment">// 选择不在编辑器内，隐藏工具栏</span>
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 没有选中文本，隐藏工具栏</span>
        <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标按下事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseDown</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-comment">// 检查点击是否发生在工具栏区域内</span>
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        isInToolbarRef.<span class="hljs-property">current</span> = <span class="hljs-literal">false</span>;
      }
    };

    <span class="hljs-comment">/**
     * 处理鼠标抬起事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleMouseUp</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-comment">// 延迟执行，确保浏览器已完成选择操作</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (!isInToolbarRef.<span class="hljs-property">current</span>) {
          <span class="hljs-title function_">handleSelectionChange</span>();
        }
      }, <span class="hljs-number">100</span>);
    };

    <span class="hljs-comment">/**
     * 处理点击外部事件
     */</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClickOutside</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-keyword">if</span> (toolbarRef.<span class="hljs-property">current</span> &amp;&amp; !toolbarRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
        <span class="hljs-keyword">const</span> targetElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(target);
        <span class="hljs-keyword">if</span> (targetElement &amp;&amp; !targetElement.<span class="hljs-title function_">contains</span>(e.<span class="hljs-property">target</span>)) {
          <span class="hljs-title function_">setSelection</span>(<span class="hljs-literal">null</span>);
        }
      }
    };

    <span class="hljs-comment">// 添加事件监听器</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);

    <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听器</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"selectionchange"</span>, handleSelectionChange);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleMouseDown);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mouseup"</span>, handleMouseUp);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"mousedown"</span>, handleClickOutside);
    };
  }, [target, getBoldState]);

  <span class="hljs-comment">// 设置字体大小</span>
  <span class="hljs-keyword">const</span> setFontSizeCommand = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">sizeValue, range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
    selection.<span class="hljs-title function_">removeAllRanges</span>();
    selection.<span class="hljs-title function_">addRange</span>(range);

    <span class="hljs-keyword">const</span> newRange = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>);

    <span class="hljs-keyword">const</span> sizeMap = {
      <span class="hljs-string">"1"</span>: <span class="hljs-string">"12px"</span>,
      <span class="hljs-string">"2"</span>: <span class="hljs-string">"14px"</span>,
      <span class="hljs-string">"3"</span>: <span class="hljs-string">"16px"</span>,
      <span class="hljs-string">"4"</span>: <span class="hljs-string">"18px"</span>,
      <span class="hljs-string">"5"</span>: <span class="hljs-string">"24px"</span>,
      <span class="hljs-string">"6"</span>: <span class="hljs-string">"32px"</span>,
      <span class="hljs-string">"7"</span>: <span class="hljs-string">"48px"</span>,
    };

    span.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = sizeMap[sizeValue] || <span class="hljs-string">"16px"</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 检查选择范围是否已折叠（即没有选中文本，只有一个光标位置）</span>
      <span class="hljs-comment">// 如果是折叠状态，不执行字体大小设置操作</span>
      <span class="hljs-keyword">if</span> (newRange.<span class="hljs-property">collapsed</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> clonedRange = newRange.<span class="hljs-title function_">cloneRange</span>();
      <span class="hljs-keyword">const</span> fragment = clonedRange.<span class="hljs-title function_">extractContents</span>();
      span.<span class="hljs-title function_">appendChild</span>(fragment);
      clonedRange.<span class="hljs-title function_">insertNode</span>(span);

      <span class="hljs-comment">// 清除当前选择，然后重新选中刚刚插入的span元素内容</span>
      <span class="hljs-comment">// 这样用户可以继续对同一段文本进行其他操作</span>
      selection.<span class="hljs-title function_">removeAllRanges</span>();
      <span class="hljs-keyword">const</span> newSelectionRange = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createRange</span>();
      newSelectionRange.<span class="hljs-title function_">selectNodeContents</span>(span);
      selection.<span class="hljs-title function_">addRange</span>(newSelectionRange);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"设置字体大小失败:"</span>, error);
    }

    <span class="hljs-comment">// 更新状态</span>
    <span class="hljs-title function_">setFontSize</span>(sizeValue);
  }, []);

  <span class="hljs-comment">// 设置文本颜色</span>
  <span class="hljs-keyword">const</span> setTextColor = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">colorValue, range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();
    selection.<span class="hljs-title function_">removeAllRanges</span>();
    selection.<span class="hljs-title function_">addRange</span>(range);

    <span class="hljs-keyword">const</span> newRange = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"span"</span>);

    span.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = colorValue;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (newRange.<span class="hljs-property">collapsed</span>) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> clonedRange = newRange.<span class="hljs-title function_">cloneRange</span>();
      <span class="hljs-keyword">const</span> fragment = clonedRange.<span class="hljs-title function_">extractContents</span>();
      span.<span class="hljs-title function_">appendChild</span>(fragment);
      clonedRange.<span class="hljs-title function_">insertNode</span>(span);

      selection.<span class="hljs-title function_">removeAllRanges</span>();
      <span class="hljs-keyword">const</span> newSelectionRange = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createRange</span>();
      newSelectionRange.<span class="hljs-title function_">selectNodeContents</span>(span);
      selection.<span class="hljs-title function_">addRange</span>(newSelectionRange);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"设置颜色失败:"</span>, error);
    }

    <span class="hljs-title function_">setColor</span>(colorValue);
  }, []);

  <span class="hljs-comment">// 处理加粗操作</span>
  <span class="hljs-keyword">const</span> handleBoldClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行加粗命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"bold"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理斜体操作</span>
  <span class="hljs-keyword">const</span> handleItalicClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行斜体命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"italic"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 恢复选择范围并更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理下划线操作</span>
  <span class="hljs-keyword">const</span> handleUnderlineClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 执行下划线命令</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">execCommand</span>(<span class="hljs-string">"underline"</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);

    <span class="hljs-comment">// 更新状态</span>
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [updateFormattingStates]);

  <span class="hljs-comment">// 处理字号变化</span>
  <span class="hljs-keyword">const</span> handleFontSizeChange = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">sizeValue, range</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!range) <span class="hljs-keyword">return</span>;

    <span class="hljs-title function_">setFontSizeCommand</span>(sizeValue, range);
    <span class="hljs-title function_">updateFormattingStates</span>();
  }, [setFontSizeCommand, updateFormattingStates]);

  <span class="hljs-keyword">return</span> {
    selection,
    toolbarRef,
    isBoldActive,
    handleBoldClick,
  };
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[esp32 小智AI 项目]]></title>    <link>https://juejin.cn/post/7588001624904892435</link>    <guid>https://juejin.cn/post/7588001624904892435</guid>    <pubDate>2025-12-26T13:16:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588001624904892435" data-draft-id="7588001624904859667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="esp32 小智AI 项目"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T13:16:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端老爷推车"/> <meta itemprop="url" content="https://juejin.cn/user/2189882895381079"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            esp32 小智AI 项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882895381079/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端老爷推车
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T13:16:27.000Z" title="Fri Dec 26 2025 13:16:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>#一、接入 MAX98357
MAX98357 是一款非常流行的 <strong>I2S 数字音频放大器模块</strong>，与 ESP32 搭配是制作数字音频项目的经典组合。控制它的核心在于：<strong>正确配置 ESP32 的 I2S 音频接口，并向其发送数字音频数据</strong>。为了方便你理解从代码到声音的完整流程，下图清晰地展示了控制 MAX98357 的核心工作流：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b48e65f9bc65437090fcbcac182f893b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv6ICB54i35o6o6L2m:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767359787&amp;x-signature=h%2F25JA8UEjvSv3APRo2ddSe%2BdAo%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-0">🔌 硬件连接（接线）</h4>
<p>连接非常简单，因为 MAX98357 使用标准的 I2S 接口：</p>













































<table><thead><tr><th>ESP32 引脚</th><th>MAX98357 引脚</th><th>作用</th></tr></thead><tbody><tr><td><strong>3.3V</strong></td><td><strong>VIN</strong></td><td>电源（3.3V-5V均可，与ESP32共用3.3V最方便）</td></tr><tr><td><strong>GND</strong></td><td><strong>GND</strong></td><td>接地（必须共地）</td></tr><tr><td><strong>GPIO 25 (或其它)</strong></td><td><strong>DIN</strong></td><td><strong>串行数据输入</strong>，这是最重要的数据线。</td></tr><tr><td><strong>GPIO 26 (或其它)</strong></td><td><strong>BCLK</strong></td><td><strong>位时钟</strong>，用于同步每一位数据。</td></tr><tr><td><strong>GPIO 27 (或其它)</strong></td><td><strong>LRC</strong></td><td><strong>左右声道时钟</strong>，用于切换左右声道。</td></tr><tr><td>（可选）GPIO（如15）</td><td><strong>GAIN</strong></td><td>增益控制。<strong>不接时默认为高增益（15dB）</strong> 。如需低增益（9dB），将此脚接地。</td></tr><tr><td>（不连接）</td><td><strong>SD</strong></td><td>关断引脚，MAX98357 内部已下拉，正常工作时无需连接。</td></tr></tbody></table>
<blockquote>
<p><strong>引脚选择提示</strong>：ESP32 有多个 I2S 引脚，你可以使用上表的引脚，也可以使用其他支持 I2S 的引脚（如 GPIO 5, 17, 18, 19, 21, 22, 23 等），只要在代码中统一即可。</p>
</blockquote>
<h4 data-id="heading-1">🛠️ 软件配置与编程（PlatformIO）</h4>
<p>在 PlatformIO 项目中，最便捷的方法是使用一个优秀的音频库：<strong><code>AudioTools</code></strong>。</p>
<ol>
<li><strong>安装库</strong>：<br/>
在 PlatformIO 的 “Library Manager” 中搜索 <strong><code>AudioTools by pschatzmann</code></strong> 并安装。这个库几乎囊括了所有音频功能，非常适合入门。</li>
<li><strong>编写基础程序</strong>：<br/>
以下代码演示如何播放一个简单的 <strong>440Hz 正弦波（标准音A）</strong> ，这是测试音频系统的“Hello World”。</li>
</ol>
<p>cpp</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * ESP32 + MAX98357 基础测试
 * 播放一个440Hz的正弦波
 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Arduino.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioTools.h"</span></span>

<span class="hljs-comment">// 1. 定义I2S输出接口，并指定引脚</span>
<span class="hljs-comment">// 参数解释：I2SStream(int data_pin, int clock_pin, int lr_pin)</span>
I2SStream i2s;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> data_pin = <span class="hljs-number">25</span>;  <span class="hljs-comment">// DIN 连接的GPIO</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> clock_pin = <span class="hljs-number">26</span>; <span class="hljs-comment">// BCLK 连接的GPIO</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> lr_pin = <span class="hljs-number">27</span>;    <span class="hljs-comment">// LRC 连接的GPIO</span>

<span class="hljs-comment">// 2. 定义音频信号源：一个440Hz的正弦波</span>
<span class="hljs-function">SineWaveGenerator&lt;<span class="hljs-type">int16_t</span>&gt; <span class="hljs-title">sineWave</span><span class="hljs-params">(<span class="hljs-number">32000</span>)</span></span>; <span class="hljs-comment">// 生成16位有符号整数格式的正弦波，振幅32000</span>
<span class="hljs-function">GeneratedSoundStream&lt;<span class="hljs-type">int16_t</span>&gt; <span class="hljs-title">sound</span><span class="hljs-params">(sineWave)</span></span>; <span class="hljs-comment">// 将正弦波包装成音频流</span>
<span class="hljs-function">StreamCopy <span class="hljs-title">copier</span><span class="hljs-params">(i2s, sound)</span></span>; <span class="hljs-comment">// 音频数据复制器：将声音源的数据复制到I2S输出</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);
  
  <span class="hljs-comment">// 3. 配置I2S音频参数</span>
  <span class="hljs-keyword">auto</span> config = i2s.<span class="hljs-built_in">defaultConfig</span>();
  config.pin_data = data_pin;
  config.pin_bck = clock_pin;
  config.pin_ws = lr_pin;
  config.sample_rate = <span class="hljs-number">44100</span>; <span class="hljs-comment">// 标准采样率</span>
  config.bits_per_sample = <span class="hljs-number">16</span>; <span class="hljs-comment">// 16位采样深度</span>
  config.channels = <span class="hljs-number">2</span>; <span class="hljs-comment">// 立体声</span>
  config.i2s_format = I2S_STD_FORMAT; <span class="hljs-comment">// 标准I2S格式</span>
  
  <span class="hljs-comment">// 4. 初始化I2S</span>
  i2s.<span class="hljs-built_in">begin</span>(config);
  
  <span class="hljs-comment">// 5. 配置正弦波参数：440Hz，采样率与I2S一致</span>
  sineWave.<span class="hljs-built_in">begin</span>(config.channels, config.sample_rate, <span class="hljs-number">440</span>);
  
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"开始播放 440Hz 正弦波（标准音A）..."</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// 不断将生成的音频数据复制到I2S接口</span>
  copier.<span class="hljs-built_in">copy</span>();
}
</code></pre>
<h4 data-id="heading-2">🎵 播放实际音频文件（如WAV）</h4>
<p>要播放SD卡或SPIFFS中的音频文件，你需要：</p>
<ol>
<li><strong>安装额外库</strong>：在 PlatformIO 中安装 <strong><code>AudioCodecs by pschatzmann</code></strong>。</li>
<li><strong>准备音频文件</strong>：将其转换为 <strong>单声道或立体声、16位、采样率不超过44100Hz的WAV文件</strong>，并上传到ESP32的SPIFFS或SD卡中。</li>
</ol>
<p>以下是播放SPIFFS中<code>test.wav</code>文件的示例代码框架：</p>
<p>cpp</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Arduino.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioTools.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioLibs/AudioSourceSPIFFS.h"</span> <span class="hljs-comment">// SPIFFS音频源</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioCodecs/CodecWAV.h"</span> <span class="hljs-comment">// WAV解码器</span></span>

I2SStream i2s;
SPIFFSStream file; <span class="hljs-comment">// SPIFFS文件流</span>
WAVDecoder dec; <span class="hljs-comment">// WAV解码器</span>
<span class="hljs-function">EncodedAudioStream <span class="hljs-title">decoder</span><span class="hljs-params">(&amp;i2s, &amp;dec)</span></span>; <span class="hljs-comment">// 解码后的音频流指向I2S</span>
<span class="hljs-function">StreamCopy <span class="hljs-title">copier</span><span class="hljs-params">(decoder, file)</span></span>; <span class="hljs-comment">// 将文件-&gt;解码-&gt;I2S</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);
  
  <span class="hljs-comment">// 初始化文件系统（需要先通过PlatformIO的“Upload Filesystem Image”上传文件）</span>
  <span class="hljs-keyword">if</span> (!SPIFFS.<span class="hljs-built_in">begin</span>()) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"SPIFFS初始化失败！"</span>);
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-comment">// 配置I2S（同上例，省略）</span>
  <span class="hljs-keyword">auto</span> i2sConfig = i2s.<span class="hljs-built_in">defaultConfig</span>();
  i2sConfig.pin_data = <span class="hljs-number">25</span>;
  <span class="hljs-comment">// ... 其他配置</span>
  i2s.<span class="hljs-built_in">begin</span>(i2sConfig);

  <span class="hljs-comment">// 配置音频流</span>
  file.<span class="hljs-built_in">begin</span>(<span class="hljs-string">"/test.wav"</span>); <span class="hljs-comment">// 打开文件</span>
  decoder.<span class="hljs-built_in">begin</span>(); <span class="hljs-comment">// 开始解码</span>

  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"开始播放WAV文件..."</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">if</span> (copier.<span class="hljs-built_in">copy</span>()) {
    <span class="hljs-comment">// 正常播放中</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"播放结束或出错"</span>);
    <span class="hljs-built_in">delay</span>(<span class="hljs-number">2000</span>);
    <span class="hljs-comment">// 可在此循环播放或播放下一首</span>
  }
}
</code></pre>
<h4 data-id="heading-3">🔄 与之前的ST7789屏幕项目结合</h4>
<p>你可以轻松地将音频控制和屏幕显示结合在一个ESP32项目中，因为两者使用不同的硬件接口（I2S vs. SPI）且库不冲突。例如，在屏幕上显示当前播放的歌曲名、音量或音频频谱。只需将两部分的<code>setup()</code>和<code>loop()</code>逻辑合理整合即可。</p>
<h2 data-id="heading-4">接入 SD卡</h2>
<p>基于我们之前的讨论，以下是使用 <strong>ESP32 通过 SD 卡读取并播放 WAV 音频文件</strong> 的完整实现方案。这涵盖了硬件连接、PlatformIO 配置和可运行的代码。</p>
<h4 data-id="heading-5">📁 完整项目实现指南</h4>
<h5 data-id="heading-6">1. 硬件连接 (ESP32 + SD卡模块 + MAX98357)</h5>
<p>请确保你的硬件按此连接。<strong>电源稳定是关键</strong>，建议使用外部5V电源为音频部分独立供电，并与ESP32共地。</p>























































<table><thead><tr><th>ESP32 GPIO 引脚</th><th>SD 卡模块引脚</th><th>MAX98357 模块引脚</th></tr></thead><tbody><tr><td><strong>3.3V</strong></td><td>VCC</td><td>VIN (可单独供电)</td></tr><tr><td><strong>GND</strong></td><td>GND</td><td>GND (<strong>必须共地</strong>)</td></tr><tr><td><strong>GPIO 23</strong></td><td>MOSI</td><td>--</td></tr><tr><td><strong>GPIO 19</strong></td><td>MISO</td><td>--</td></tr><tr><td><strong>GPIO 18</strong></td><td>SCK</td><td>--</td></tr><tr><td><strong>GPIO 5</strong> (示例)</td><td>CS (片选)</td><td>--</td></tr><tr><td><strong>GPIO 25</strong></td><td>--</td><td>DIN</td></tr><tr><td><strong>GPIO 26</strong></td><td>--</td><td>BCLK</td></tr><tr><td><strong>GPIO 27</strong></td><td>--</td><td>LRC</td></tr></tbody></table>
<h5 data-id="heading-7">2. PlatformIO 项目配置 (<code>platformio.ini</code>)</h5>
<p>创建或修改项目根目录下的 <code>platformio.ini</code> 文件。</p>
<p>ini</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[env:esp32-dev]</span>
<span class="hljs-attr">platform</span> = espressif32
<span class="hljs-attr">board</span> = esp32dev
<span class="hljs-attr">framework</span> = ardui<span class="hljs-literal">no</span>
<span class="hljs-attr">monitor_speed</span> = <span class="hljs-number">115200</span>

<span class="hljs-comment">; 核心依赖库</span>
<span class="hljs-attr">lib_deps</span> = 
    pschatzmann/ESP32-AudioTools @ ^1.0.8  <span class="hljs-comment"># 主音频库</span>
    pschatzmann/arduino-audio-tools @ ^1.1.9
    pschatzmann/arduino-audiocodecs @ ^1.0.6 <span class="hljs-comment"># WAV解码器</span>
    <span class="hljs-comment">; SD卡库已包含在框架中</span>

<span class="hljs-comment">; 优化构建</span>
<span class="hljs-attr">board_build.flash_mode</span> = dio
<span class="hljs-attr">build_flags</span> = 
    -Wl,-Teagle.flash.4m32m.ld
</code></pre>
<h5 data-id="heading-8">3. 主程序代码 (<code>src/main.cpp</code>)</h5>
<p>将以下代码复制到 <code>src/main.cpp</code> 中，并根据你的引脚定义进行修改。</p>
<p>cpp</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * ESP32 SD卡 WAV音频播放器
 * 依赖：AudioTools库
 */</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Arduino.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioTools.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioLibs/AudioSourceSD.h"</span> <span class="hljs-comment">// SD卡音频源</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioCodecs/CodecWAV.h"</span>    <span class="hljs-comment">// WAV解码器</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;SD.h&gt;</span>                      <span class="hljs-comment">// SD卡驱动</span></span>

<span class="hljs-comment">// ==================== 用户配置区域 ====================</span>
<span class="hljs-comment">// 1. SD卡引脚配置（根据实际接线修改！）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SD_CS_PIN    5   <span class="hljs-comment">// SD卡模块的片选引脚</span></span>

<span class="hljs-comment">// 2. I2S引脚配置（根据实际接线修改！）</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_DIN_PIN  25  <span class="hljs-comment">// MAX98357的DIN</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_BCLK_PIN 26  <span class="hljs-comment">// MAX98357的BCLK</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_LRC_PIN  27  <span class="hljs-comment">// MAX98357的LRC</span></span>

<span class="hljs-comment">// 3. 音频文件设置</span>
<span class="hljs-type">const</span> <span class="hljs-type">char</span>* audioFilePath = <span class="hljs-string">"/test.wav"</span>; <span class="hljs-comment">// 放在SD卡根目录的测试文件</span>
<span class="hljs-comment">// ====================================================</span>

<span class="hljs-comment">// 创建音频对象</span>
I2SStream i2s;                 <span class="hljs-comment">// I2S输出流</span>
<span class="hljs-function">SDStream <span class="hljs-title">file</span><span class="hljs-params">(SD_CS_PIN)</span></span>;      <span class="hljs-comment">// SD卡文件流，传入CS引脚号</span>
WAVDecoder dec;                <span class="hljs-comment">// WAV解码器</span>
<span class="hljs-function">EncodedAudioStream <span class="hljs-title">decoder</span><span class="hljs-params">(&amp;i2s, &amp;dec)</span></span>; <span class="hljs-comment">// 解码后管道连接到I2S</span>
<span class="hljs-function">StreamCopy <span class="hljs-title">copier</span><span class="hljs-params">(decoder, file)</span></span>;       <span class="hljs-comment">// 负责数据复制的“引擎”</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">printAudioInfo</span><span class="hljs-params">(AudioInfo info)</span> </span>{
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"=== 音频信息 ==="</span>);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"采样率: %d Hz\n"</span>, info.sample_rate);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"声道数: %d\n"</span>, info.channels);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"位深度: %d-bit\n"</span>, info.bits_per_sample);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"================"</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);
  <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">Serial</span>); <span class="hljs-comment">// 等待串口连接（仅用于调试）</span>
  <span class="hljs-built_in">delay</span>(<span class="hljs-number">500</span>);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"\n\nESP32 SD卡音频播放器启动..."</span>);

  <span class="hljs-comment">// === 第一步：初始化SD卡 ===</span>
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">print</span>(<span class="hljs-string">"初始化SD卡..."</span>);
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SD</span>.<span class="hljs-built_in">begin</span>(SD_CS_PIN)) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"失败！请检查："</span>);
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"  1. SD卡是否插入？"</span>);
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"  2. 引脚连接是否正确？"</span>);
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"  3. SD卡格式是否为FAT32？"</span>);
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) { <span class="hljs-comment">// 挂起</span>
      <span class="hljs-built_in">delay</span>(<span class="hljs-number">100</span>);
    }
  }
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"成功！"</span>);

  <span class="hljs-comment">// 可选：列出根目录文件</span>
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"SD卡根目录内容："</span>);
  <span class="hljs-built_in">File</span> root = <span class="hljs-built_in">SD</span>.<span class="hljs-built_in">open</span>(<span class="hljs-string">"/"</span>);
  <span class="hljs-keyword">while</span> (<span class="hljs-built_in">File</span> entry = root.<span class="hljs-built_in">openNextFile</span>()) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">print</span>(<span class="hljs-string">"  "</span>);
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(entry.<span class="hljs-built_in">name</span>());
    entry.<span class="hljs-built_in">close</span>();
  }
  root.<span class="hljs-built_in">close</span>();

  <span class="hljs-comment">// === 第二步：配置并初始化I2S ===</span>
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">print</span>(<span class="hljs-string">"配置I2S音频接口..."</span>);
  <span class="hljs-keyword">auto</span> config = i2s.<span class="hljs-built_in">defaultConfig</span>();
  config.pin_data = I2S_DIN_PIN;
  config.pin_bck = I2S_BCLK_PIN;
  config.pin_ws = I2S_LRC_PIN;
  config.sample_rate = <span class="hljs-number">44100</span>; <span class="hljs-comment">// 初始采样率，解码后会根据文件自动调整</span>
  config.bits_per_sample = <span class="hljs-number">16</span>;
  config.channels = <span class="hljs-number">2</span>;
  config.i2s_format = I2S_STD_FORMAT;
  <span class="hljs-comment">// config.buffer_size = 1024; // 若出现爆音可尝试增大</span>
  <span class="hljs-comment">// config.buffer_count = 8;</span>

  <span class="hljs-keyword">if</span> (!i2s.<span class="hljs-built_in">begin</span>(config)) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"I2S初始化失败！请检查引脚。"</span>);
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>);
  }
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"成功！"</span>);

  <span class="hljs-comment">// === 第三步：尝试打开并解码音频文件 ===</span>
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"尝试打开文件: %s\n"</span>, audioFilePath);
  
  <span class="hljs-keyword">if</span> (!file.<span class="hljs-built_in">begin</span>(audioFilePath)) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"文件打开失败！请检查路径和文件名。"</span>);
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>);
  }

  <span class="hljs-comment">// 设置解码器输出信息回调（可选）</span>
  decoder.<span class="hljs-built_in">setInfoCallback</span>(printAudioInfo);
  
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"开始解码并播放..."</span>);
  decoder.<span class="hljs-built_in">begin</span>();

  <span class="hljs-comment">// 可选：设置音量（0.0静音 ~ 1.0最大）</span>
  <span class="hljs-comment">// i2s.setVolume(0.7);</span>
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// 核心：将文件数据复制到解码器，再送至I2S</span>
  <span class="hljs-keyword">if</span> (copier.<span class="hljs-built_in">copy</span>()) {
    <span class="hljs-comment">// 数据正在稳定传输中，可以在此添加播放状态指示（如点亮LED）</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 播放结束或发生错误</span>
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"播放结束。"</span>);
    
    <span class="hljs-comment">// 简单示例：等待3秒后重新播放</span>
    <span class="hljs-built_in">delay</span>(<span class="hljs-number">3000</span>);
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"重新播放..."</span>);
    
    <span class="hljs-comment">// 重置文件流到开始位置</span>
    file.<span class="hljs-built_in">begin</span>(audioFilePath);
    decoder.<span class="hljs-built_in">begin</span>();
  }
  
  <span class="hljs-comment">// 可以在此处加入其他控制逻辑，如按键检测切换歌曲</span>
}
</code></pre>
<h4 data-id="heading-9">🚀 如何运行</h4>
<ol>
<li><strong>准备SD卡</strong>：格式化为FAT32，将转换好的16位、单声道/立体声、44100Hz的WAV文件（如 <code>test.wav</code>）复制到<strong>根目录</strong>。</li>
<li><strong>连接硬件</strong>：按上述表格连接好所有线路，<strong>仔细检查电源和地线</strong>。</li>
<li><strong>上传代码</strong>：在VS Code中，点击PlatformIO底部的 <strong>✔️（编译）</strong> ，然后点击 <strong>➡️（上传）</strong>  按钮。</li>
<li><strong>查看日志</strong>：打开串口监视器（波特率115200），查看初始化状态和播放信息。</li>
</ol>
<h2 data-id="heading-10">接入 INMP 441 麦克风</h2>
<p>将 <strong>INMP441</strong> 数字麦克风模块连接到 <strong>ESP32</strong> 是进行高质量音频采集的经典方案。INMP441 是一款通过 <strong>I2S 接口</strong> 输出的底部进音 MEMS 麦克风，与 ESP32 的 I2S 外设完美兼容。</p>
<h4 data-id="heading-11">🔌 硬件连接</h4>
<p>INMP441 需要标准的 I2S 连接，但与之前的 MAX98357（从设备）不同，<strong>INMP441 工作在“主模式”</strong> ，这意味着它负责生成主时钟（BCLK）和左右时钟（LRCLK）。因此，连接方式有特定要求。</p>
<p>请按以下表格连接（这是最常见的接法）：</p>








































<table><thead><tr><th>ESP32 GPIO 引脚</th><th>INMP441 模块引脚</th><th>信号说明</th></tr></thead><tbody><tr><td><strong>3.3V</strong></td><td><strong>VDD</strong></td><td>电源 (<strong>必须为 3.3V</strong>，5V会损坏麦克风)</td></tr><tr><td><strong>GND</strong></td><td><strong>GND</strong></td><td>接地</td></tr><tr><td><strong>GPIO 32</strong> (或其它)</td><td><strong>SD</strong></td><td><strong>串行数据输出</strong> (数据线，从麦克风到ESP32)</td></tr><tr><td><strong>GPIO 14</strong></td><td><strong>WS</strong></td><td><strong>字选择 (左右声道时钟)</strong> ，<strong>由麦克风输出给ESP32</strong></td></tr><tr><td><strong>GPIO 15</strong></td><td><strong>SCK</strong></td><td><strong>串行时钟 (位时钟)</strong> ，<strong>由麦克风输出给ESP32</strong></td></tr><tr><td>(可选) <strong>GPIO 13</strong></td><td><strong>L/R</strong></td><td>声道选择。<strong>接GND为左声道，接VDD为右声道</strong>。通常悬空或接地即可。</td></tr></tbody></table>
<blockquote>
<p><strong>关键说明</strong>：</p>
<ol>
<li><strong>时钟方向</strong>：INMP441 是“主设备”，<strong>SCK</strong> 和 <strong>WS</strong> 是它的<strong>输出</strong>，必须连接到 ESP32 的对应 I2S 输入引脚。ESP32 在此配置中作为“从设备”接收时钟和数据。</li>
<li><strong>引脚灵活性</strong>：上表中的 GPIO 32、14、15 是 ESP32 的默认 I2S 从设备接收引脚，推荐使用。理论上其他支持 I2S 的引脚也可用，但需要修改代码的引脚映射。</li>
<li><strong>电源</strong>：务必使用 3.3V 供电。</li>
</ol>
</blockquote>
<h4 data-id="heading-12">📦 PlatformIO 配置 (<code>platformio.ini</code>)</h4>
<p>继续使用强大的 <code>AudioTools</code> 库，它同样简化了录音流程。</p>
<p>ini</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[env:esp32-dev]</span>
<span class="hljs-attr">platform</span> = espressif32
<span class="hljs-attr">board</span> = esp32dev
<span class="hljs-attr">framework</span> = ardui<span class="hljs-literal">no</span>
<span class="hljs-attr">monitor_speed</span> = <span class="hljs-number">115200</span>

<span class="hljs-attr">lib_deps</span> = 
    pschatzmann/ESP32-AudioTools @ ^1.0.8
    pschatzmann/arduino-audio-tools @ ^1.1.9
</code></pre>
<h4 data-id="heading-13">💻 基础录音与串口绘图程序 (<code>src/main.cpp</code>)</h4>
<p>以下代码将初始化 INMP441，连续采集音频数据，并将原始数据通过串口发送。你可以用 Arduino IDE 或 PlatformIO 的串口绘图器查看波形。</p>
<p>cpp</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * ESP32 + INMP441 基础录音测试
 * 将音频原始数据通过串口输出，可用于绘图器查看波形
 */</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Arduino.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioTools.h"</span></span>

<span class="hljs-comment">// ==================== 配置 ====================</span>
<span class="hljs-comment">// 定义I2S引脚 (根据你的实际连接调整！)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_SD_IN   32  <span class="hljs-comment">// INMP441的SD -&gt; ESP32的GPIO 32</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_WS_IN   14  <span class="hljs-comment">// INMP441的WS -&gt; ESP32的GPIO 14</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> I2S_SCK_IN  15  <span class="hljs-comment">// INMP441的SCK -&gt; ESP32的GPIO 15</span></span>

<span class="hljs-comment">// 定义音频参数</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> sampleRate = <span class="hljs-number">44100</span>; <span class="hljs-comment">// 采样率 (Hz)</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> bufferSize = <span class="hljs-number">1024</span>;   <span class="hljs-comment">// 缓冲区大小</span>

<span class="hljs-comment">// 创建I2S流对象用于输入（录音）</span>
I2SStream i2sInput;
<span class="hljs-type">int16_t</span> buffer[bufferSize]; <span class="hljs-comment">// 用于存储音频样本的缓冲区（16位有符号整数）</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">printAudioInfo</span><span class="hljs-params">(AudioInfo info)</span> </span>{
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"=== I2S麦克风初始化成功 ==="</span>);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"采样率: %d Hz\n"</span>, info.sample_rate);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"声道数: %d\n"</span>, info.channels);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">printf</span>(<span class="hljs-string">"位深度: %d-bit\n"</span>, info.bits_per_sample);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"开始采集音频..."</span>);
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"打开串口绘图器(Tools -&gt; Serial Plotter)查看波形。"</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">115200</span>);
  <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">Serial</span>);
  <span class="hljs-built_in">delay</span>(<span class="hljs-number">500</span>);

  <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"启动 INMP441 麦克风测试..."</span>);

  <span class="hljs-comment">// 配置I2S输入参数</span>
  <span class="hljs-keyword">auto</span> i2sConfig = i2sInput.<span class="hljs-built_in">defaultConfig</span>(RX_MODE);
  i2sConfig.pin_data = I2S_SD_IN;
  i2sConfig.pin_ws = I2S_WS_IN;
  i2sConfig.pin_bck = I2S_SCK_IN;
  i2sConfig.sample_rate = sampleRate;
  i2sConfig.bits_per_sample = <span class="hljs-number">16</span>;
  i2sConfig.channels = <span class="hljs-number">1</span>;          <span class="hljs-comment">// INMP441 单声道</span>
  i2sConfig.i2s_format = I2S_STD_FORMAT;
  i2sConfig.is_master = <span class="hljs-literal">false</span>;     <span class="hljs-comment">// ESP32 作为从设备，使用麦克风提供的时钟！</span>
  i2sConfig.port_no = <span class="hljs-number">0</span>;           <span class="hljs-comment">// 使用I2S端口0</span>

  <span class="hljs-comment">// 开始I2S输入</span>
  <span class="hljs-keyword">if</span> (!i2sInput.<span class="hljs-built_in">begin</span>(i2sConfig)) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"错误：I2S麦克风初始化失败！请检查接线和引脚定义。"</span>);
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>); <span class="hljs-comment">// 停止</span>
  }
  <span class="hljs-built_in">printAudioInfo</span>(i2sInput.<span class="hljs-built_in">audioInfo</span>());
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-comment">// 从I2S流读取一帧音频数据到缓冲区</span>
  <span class="hljs-type">size_t</span> numSamplesRead = i2sInput.<span class="hljs-built_in">readBytes</span>((<span class="hljs-type">uint8_t</span>*)buffer, <span class="hljs-built_in">sizeof</span>(buffer));

  <span class="hljs-comment">// 将读取到的每个16位样本通过串口发送，用于绘图</span>
  <span class="hljs-comment">// 注意：对于串口绘图器，一次只需发送一个值（单声道）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; numSamplesRead / <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">int16_t</span>); i++) {
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(buffer[i]); <span class="hljs-comment">// 将样本值直接打印</span>
  }
  <span class="hljs-comment">// 注意：高采样率下，Serial.print可能成为瓶颈，此代码仅用于演示。</span>
  <span class="hljs-comment">// 实际应用时应处理或存储数据，而非全部打印。</span>
}
</code></pre>
<h4 data-id="heading-14">🔬 如何测试与验证</h4>
<ol>
<li><strong>上传代码</strong>：确保接线正确后，编译并上传代码到 ESP32。</li>
<li><strong>打开串口监视器</strong>：波特率设为115200，查看初始化信息。</li>
<li><strong>打开串口绘图器</strong>：在 PlatformIO 或 Arduino IDE 中，找到 <strong>Serial Plotter</strong> 功能并打开。你应该能看到随环境声音变化的实时波形图。对着麦克风说话或制造声音，观察波形变化。</li>
</ol>
<h4 data-id="heading-15">📝 进阶应用：将录音保存到 SD 卡（WAV格式）</h4>
<p>录制音频并保存是常见需求。以下是一个简化的框架，展示如何将 <code>AudioTools</code> 库的录音数据通过 <code>WAVEncoder</code> 保存为 WAV 文件到 SD 卡。</p>
<blockquote>
<p><strong>前提</strong>：你已经按之前指南接好 SD 卡模块并安装了所需库。</p>
</blockquote>
<p>cpp</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 注意：此为高级示例框架，可能需要调整才能完全运行</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;Arduino.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioTools.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioLibs/AudioSourceSD.h"</span> <span class="hljs-comment">// 用于SD卡写入</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"AudioCodecs/CodecWAV.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;SD.h&gt;</span></span>

<span class="hljs-comment">// ... 引脚定义和I2S输入配置与上文相同 ...</span>

<span class="hljs-function">SDStream <span class="hljs-title">sd_out</span><span class="hljs-params">(<span class="hljs-number">5</span>)</span></span>; <span class="hljs-comment">// SD卡CS引脚为5</span>
WAVEncoder wav_enc;
<span class="hljs-function">EncodedAudioStream <span class="hljs-title">encoder</span><span class="hljs-params">(&amp;sd_out, &amp;wav_enc)</span></span>; <span class="hljs-comment">// 将WAV编码流指向SD卡</span>
<span class="hljs-function">StreamCopy <span class="hljs-title">copier</span><span class="hljs-params">(encoder, i2sInput)</span></span>; <span class="hljs-comment">// 将I2S输入复制到编码器</span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// ... 初始化串口、SD卡、I2S输入 ...</span>
    <span class="hljs-comment">// 初始化SD卡输出流</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SD</span>.<span class="hljs-built_in">begin</span>(<span class="hljs-number">5</span>)) { <span class="hljs-comment">/* 错误处理 */</span> }
    sd_out.<span class="hljs-built_in">begin</span>(<span class="hljs-string">"/recording.wav"</span>, FILE_WRITE); <span class="hljs-comment">// 打开文件</span>
    encoder.<span class="hljs-built_in">begin</span>(i2sInput.<span class="hljs-built_in">audioInfo</span>()); <span class="hljs-comment">// 以输入音频参数开始编码</span>
    wav_enc.<span class="hljs-built_in">begin</span>(encoder); <span class="hljs-comment">// 开始WAV编码</span>
    <span class="hljs-built_in">Serial</span>.<span class="hljs-built_in">println</span>(<span class="hljs-string">"开始录音到SD卡..."</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{
    copier.<span class="hljs-built_in">copy</span>(); <span class="hljs-comment">// 持续录音</span>
    <span class="hljs-comment">// 可以通过按钮或其他条件触发停止录音：encoder.end(); sd_out.end();</span>
}
</code></pre>
<h4 data-id="heading-16">⚠️ 常见问题</h4>

























<table><thead><tr><th>问题</th><th>排查要点</th></tr></thead><tbody><tr><td><strong>没有数据/全是噪声</strong></td><td>1. <strong>时钟模式</strong>：确认 <code>i2sConfig.is_master = false</code>。 2. <strong>引脚</strong>：最可能！反复检查 SCK, WS, SD 三条数据线是否接对。 3. <strong>电源</strong>：确保是 <strong>3.3V</strong>，且 GND 已共地。</td></tr><tr><td><strong>声音波形很小</strong></td><td>INMP441 灵敏度较高。尝试增大声源音量或调整代码中的增益（可对 <code>buffer[i]</code> 乘以一个系数后再发送）。</td></tr><tr><td><strong>编译错误</strong></td><td>确保 <code>platformio.ini</code> 中的 <code>lib_deps</code> 已正确添加 <code>AudioTools</code> 库。</td></tr><tr><td><strong>程序运行不稳定</strong></td><td>降低采样率（如改为 16000 Hz）或增加 <code>bufferSize</code>。</td></tr></tbody></table>
<p>成功连接并采集到音频数据后，你可以将其用于语音唤醒、环境声分析、实时传输或与之前的播放功能结合实现回音消除等。如果你在具体实现中遇到问题，可以提供串口输出的错误信息，以便进一步诊断。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3-插槽slot]]></title>    <link>https://juejin.cn/post/7587965800273182746</link>    <guid>https://juejin.cn/post/7587965800273182746</guid>    <pubDate>2025-12-26T13:47:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587965800273182746" data-draft-id="7588086766235516966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3-插槽slot"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-26T13:47:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YaeZed"/> <meta itemprop="url" content="https://juejin.cn/user/3977350021390107"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3-插槽slot
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3977350021390107/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YaeZed
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T13:47:59.000Z" title="Fri Dec 26 2025 13:47:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="gml">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#222;color:silver}.hljs-keyword{color:#ffb871;font-weight:700}.hljs-built_in{color:#ffb871}.hljs-literal{color:#ff8080}.hljs-symbol{color:#58e55a}.hljs-comment{color:#5b995b}.hljs-string{color:#ff0}.hljs-number{color:#ff8080}.hljs-addition,.hljs-attribute,.hljs-bullet,.hljs-code,.hljs-deletion,.hljs-doctag,.hljs-function,.hljs-link,.hljs-meta,.hljs-meta-keyword,.hljs-name,.hljs-quote,.hljs-regexp,.hljs-section,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:silver}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>插槽是 Vue 组件中一个非常核心的概念，它允许你以一种灵活的方式将内容“插入”到子组件的指定位置，极大地提高了组件的复用性和灵TA性。插槽允许组件只负责渲染一个“框架”（比如边框、阴影），而把“内容”的决定权交给使用它的父组件。</p>
<h2 data-id="heading-0">1.默认插槽</h2>
<p>最简单的插槽，子组件中只有一个未命名的 <code>&lt;slot&gt;</code> 出口。</p>
<blockquote>
<p>子组件</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>卡片标题<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">300px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<blockquote>
<p>父组件</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">BaseCard</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一父组件<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./assets/logo.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"Vue Logo"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width: 100px;"</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">BaseCard</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">BaseCard</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/BaseCard.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-1">2.具名插槽</h2>
<p>当子组件需要多个“坑位”时（例如，一个用于头部，一个用于底部），就需要使用具名插槽。</p>
<blockquote>
<p>子组件：使用 <code>name</code> 属性来区分不同的插槽。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"modal"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"modal-header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"header"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"modal-body"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">footer</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"modal-footer"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"footer"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.modal</span> { <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>; }
<span class="hljs-selector-class">.modal-header</span>, <span class="hljs-selector-class">.modal-footer</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f4f4f4</span>; }
<span class="hljs-selector-class">.modal-body</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<blockquote>
<p>父组件：使用 <code>&lt;template&gt;</code> 标签和 <code>v-slot</code> 指令（或其简写 <code>#</code>）来指定要填充的插槽。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ModalLayout</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-slot</span> = <span class="hljs-string">"header"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>这是一个模态框标题<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是模态框的主要内容...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">footer</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>确认<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ModalLayout</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ModalLayout</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/ModalLayout.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-2">3.作用域插槽</h2>
<p>这是插槽最强大的功能。它允许子组件向父组件的插槽内容传递数据。这在处理<strong>列表渲染</strong>时非常有用，子组件负责数据迭代，而父组件负责定义每一项的渲染样式。</p>
<blockquote>
<p>子组件：子组件通过在 <code>&lt;slot&gt;</code> 标签上绑定属性，来将数据"暴露"给父组件。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user-list"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>用户列表:<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"user in users"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"user.id"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">:user</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">:isAdmin</span>=<span class="hljs-string">"user.name === 'Alice'"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

interface <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: number;
  <span class="hljs-attr">name</span>: string;
  <span class="hljs-attr">age</span>: number;
}

<span class="hljs-keyword">const</span> users = ref&lt;<span class="hljs-title class_">User</span>[]&gt;([
  { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> },
]);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</span></code></pre>
<blockquote>
<p>父组件：父组件通过 <code>v-slot</code> (或 <code>#</code>) 接收子组件传递的数据，<strong>并且可以立即为这些数据添加 TypeScript 类型</strong>。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserList</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"{ user, isAdmin }: { user: User, isAdmin: boolean }"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span> 
        {{ user.name }} ({{ user.age }}岁)
      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isAdmin"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"color: red; margin-left: 10px;"</span>&gt;</span>[管理员]<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">UserList</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">UserList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/UserList.vue'</span>;

<span class="hljs-comment">// 我们可以在父组件中也定义这个类型，以便复用</span>
interface <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: number;
  <span class="hljs-attr">name</span>: string;
  <span class="hljs-attr">age</span>: number;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-3">4.自定义插槽(Vue 3.3+)</h2>
<p>在 Vue 3.3 及更高版本中， <code>&lt;script setup&gt;</code> 提供了 <code>defineSlots</code> 宏，这是在子组件中<strong>为插槽提供类型</strong>的官方方式。这极大地改善了开发体验，<strong>父组件不再需要手动声明类型</strong>，因为 TS 可以自动从子组件推断它们。</p>
<blockquote>
<p>子组件：使用 <code>defineSlots</code> 来声明插槽及其期望的 <code>props</code> 类型。</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"list"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in items"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">:item</span>=<span class="hljs-string">"item"</span> <span class="hljs-attr">:index</span>=<span class="hljs-string">"index"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 1. 定义数据和类型</span>
interface <span class="hljs-title class_">Item</span> {
  <span class="hljs-attr">id</span>: string;
  <span class="hljs-attr">text</span>: string;
}
<span class="hljs-keyword">const</span> items = ref&lt;<span class="hljs-title class_">Item</span>[]&gt;([
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'a'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'第一项'</span> },
  { <span class="hljs-attr">id</span>: <span class="hljs-string">'b'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'第二项'</span> },
]);

<span class="hljs-comment">// 2. (重点) 使用 defineSlots </span>
<span class="hljs-comment">// 这是一个宏，无需导入</span>
<span class="hljs-comment">// 它定义了 'default' 插槽会接收一个对象，该对象包含一个 'item' 属性 (类型为 Item)</span>
<span class="hljs-comment">// 和一个 'index' 属性 (类型为 number)</span>
defineSlots&lt;{
  <span class="hljs-title function_">default</span>(<span class="hljs-attr">props</span>: { <span class="hljs-attr">item</span>: <span class="hljs-title class_">Item</span>; <span class="hljs-attr">index</span>: number }): any;
  <span class="hljs-comment">// 如果有具名插槽，也可以在这里定义，比如：</span>
  <span class="hljs-comment">// header(props: { title: string }): any;</span>
}&gt;();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</span></code></pre>
<blockquote>
<p>父组件：父组件的 <code>slotProps</code> (或解构的变量) 会被<strong>自动推断</strong>出正确的类型</p>
</blockquote>
<pre><code class="hljs language-ts" lang="ts">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">TypedList</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">default</span>=<span class="hljs-string">"{ item, index }"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>{{ index + 1 }}.<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span> {{ item.text.toUpperCase() }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">TypedList</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TypedList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TypedList.vue'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-4">5.总结</h2>
<ul>
<li>
<p><strong>布局组件</strong> (<code>Layout.vue</code>):</p>
<ul>
<li><strong>场景</strong>: 定义网站的通用布局，如侧边栏、顶部导航和内容区域。</li>
<li><strong>用法</strong>: 使用 <code>header</code>, <code>sidebar</code>, <code>main</code> 等具名插槽，让不同页面填充自己的内容。</li>
</ul>
</li>
<li>
<p><strong>可复用 UI 元素</strong> (<code>Modal.vue</code>, <code>Card.vue</code>, <code>Dropdown.vue</code>):</p>
<ul>
<li><strong>场景</strong>: 封装通用的交互和样式，但允许内容高度自定义。</li>
<li><strong>用法</strong>: <code>Modal</code> 组件提供 <code>header</code> (标题), <code>body</code> (内容), <code>footer</code> (按钮) 插槽。</li>
</ul>
</li>
<li>
<p><strong>列表渲染器</strong> (<code>DataList.vue</code>, <code>ProductGrid.vue</code>):</p>
<ul>
<li><strong>场景</strong>: 组件负责获取和迭代数据（如 API 请求、分页），但把<em>如何渲染每一项</em>的控制权交给父组件。</li>
<li><strong>用法</strong>: <strong>(核心)</strong> 使用<strong>作用域插槽</strong>，将 <code>item</code> (当前项数据) 传递给父组件。这是最灵活的模式。</li>
</ul>
</li>
<li>
<p><strong>提供者组件</strong> (<code>Toggle.vue</code>, <code>MouseTracker.vue</code>):</p>
<ul>
<li><strong>场景</strong>: 组件管理某个状态（如 <code>isOn</code>）或逻辑（如鼠标位置），并通过作用域插槽将这些状态暴露出去，让父组件来决定如何渲染。</li>
<li><strong>用法</strong>: 子组件 <code>&lt;slot :isOn="isOn" :toggle="toggleFunction"&gt;&lt;/slot&gt;</code>。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[五年前端，我凌晨三点的电脑屏幕前终于想通了这件事]]></title>    <link>https://juejin.cn/post/7587740546955477032</link>    <guid>https://juejin.cn/post/7587740546955477032</guid>    <pubDate>2025-12-26T13:57:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587740546955477032" data-draft-id="7588034035286229007" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="五年前端，我凌晨三点的电脑屏幕前终于想通了这件事"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-12-26T13:57:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="destinying"/> <meta itemprop="url" content="https://juejin.cn/user/896842287549703"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            五年前端，我凌晨三点的电脑屏幕前终于想通了这件事
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/896842287549703/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    destinying
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T13:57:14.000Z" title="Fri Dec 26 2025 13:57:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">五年前端开发：那些加班到深夜的日子里，我终于找到了答案</h2>
<blockquote>
<p>转眼间，做前端已经五年了。回想起这些年的点点滴滴，有为了一个像素对不齐而折腾到凌晨的执着，也有终于解决了一个性能问题后的欣喜若狂。</p>
</blockquote>
<h3 data-id="heading-1">💻 那些让我抓狂的瞬间</h3>
<h4 data-id="heading-2">一个padding搞了我一晚上</h4>
<p>记得刚入行的时候，有个布局问题让我头疼了一整晚。就是两个div之间的间距，怎么调都不对。那时候我还不知道浏览器默认样式这回事，对着Chrome开发者工具一遍遍地试，各种margin、padding组合，结果第二天早上一问资深同事，人家轻描淡写地说："reset.css加了么？"</p>
<p>那一刻我才明白，<strong>很多你以为的技术难题，其实只是知识盲区而已</strong>。</p>
<h4 data-id="heading-3">"这个需求很简单"背后的深坑</h4>
<p>产品经理说："这个需求很简单，就是加个拖拽排序功能。"</p>
<p>我："好的，应该一天就够了。"</p>
<p>然后我才发现，拖拽排序要考虑：</p>
<ul>
<li>移动端的手势识别</li>
<li>PC端的鼠标事件</li>
<li>不同浏览器的事件兼容性</li>
<li>拖拽过程中的视觉反馈</li>
<li>边界处理和碰撞检测</li>
<li>性能优化（防止频繁重绘）</li>
<li>可访问性支持</li>
</ul>
<p><strong>三天后</strong>，我终于交出了"看似简单"的功能。从那以后，我再也不轻易相信"这个需求很简单"这种话了。</p>
<h3 data-id="heading-4">🌱 那些让我成长的时刻</h3>
<h4 data-id="heading-5">第一次重构老项目</h4>
<p>接手一个三年前的老项目，代码里到处都是<code>document.getElementById</code>，jQuery和原生JS混用，全局变量满天飞。重构过程中，我发现了一些有意思的"黑历史"：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 当年的前辈们是怎么写代码的</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (data1 == <span class="hljs-literal">null</span>) {
    data1 = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
      data1.<span class="hljs-title function_">push</span>(i);
    }
  }
  <span class="hljs-keyword">return</span> data1;
}

<span class="hljs-comment">// 还有这种神奇的操作</span>
$(<span class="hljs-string">"#button"</span>).<span class="hljs-title function_">click</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    location.<span class="hljs-title function_">reload</span>();
  }, <span class="hljs-number">100</span>);
});
</code></pre>
<p>重构那段时间，每天都在跟历史代码搏斗，但也正是这个过程，让我真正理解了什么叫"代码可维护性"。</p>
<h4 data-id="heading-6">学会了说"不"</h4>
<p>以前刚入行时，产品提什么需求我都说"行"。直到有一次，为了赶一个不合理的deadline，我熬了好几个通宵，最后上线的版本还出了bug。</p>
<p>后来我学聪明了，开始跟产品和沟通：</p>
<ul>
<li>这个需求的技术复杂度是多少</li>
<li>需要多少开发时间</li>
<li>如果一定要提前，哪些功能可以砍掉</li>
<li>当前技术方案的风险点在哪里</li>
</ul>
<p><strong>学会评估和沟通，比学会写代码更重要</strong>。</p>
<h3 data-id="heading-7">🤔 程序员的日常思考</h3>
<h4 data-id="heading-8">关于加班的那些事</h4>
<p>刚开始工作的时候，我觉得加班=努力。后来慢慢发现：</p>
<ul>
<li><strong>有效的时间管理比长时间工作更重要</strong></li>
<li><strong>会写代码不等于会解决问题</strong></li>
<li><strong>健康比KPI重要得多</strong></li>
</ul>
<p>我现在尽量不加班，不是因为懒，而是我学会了：</p>
<ul>
<li>提前评估工作量</li>
<li>及时沟通风险</li>
<li>拒绝不合理的需求</li>
<li>保持专注，减少无效加班</li>
</ul>
<h4 data-id="heading-9">关于技术焦虑</h4>
<p>前端技术更新太快，Vue还没学完，React又出了新特性，CSS框架层出不穷。前两年我很焦虑，怕被淘汰。</p>
<p>现在我想通了：</p>
<ul>
<li><strong>基础永远是王道</strong>：HTML/CSS/JavaScript的核心不会变</li>
<li><strong>学习要讲方法</strong>：不要追着新技术跑，要有选择地学</li>
<li><strong>项目驱动学习</strong>：在实际项目中学习新技术效果最好</li>
<li><strong>保持输出</strong>：写博客、做分享是最好的学习方式</li>
</ul>
<h3 data-id="heading-10">💪 真正的成长是什么</h3>
<h4 data-id="heading-11">从技术思维到产品思维</h4>
<p>刚开始我只关心代码写得爽不爽，后来我开始思考：</p>
<ul>
<li>用户真的需要这个功能吗？</li>
<li>这个交互体验够好吗？</li>
<li>性能优化能带来什么价值？</li>
<li>我的代码对团队协作友好吗？</li>
</ul>
<p><strong>技术是工具，不是目的</strong>。真正的前端开发，是用技术为用户创造价值。</p>
<h4 data-id="heading-12">找到了自己的节奏</h4>
<p>现在的我：</p>
<ul>
<li>不再盲目追新技术，而是选择适合自己的技术栈</li>
<li>重视代码质量，但不执着于完美</li>
<li>会主动沟通需求，而不是被动接受</li>
<li>保持学习的热情，但不焦虑</li>
<li>知道什么时候该努力，什么时候该休息</li>
</ul>
<h3 data-id="heading-13">🎯 给自己的一些话</h3>
<p>五年下来，我想对自己说：</p>
<ol>
<li><strong>保持好奇，但不要盲目跟风</strong></li>
<li><strong>写代码很重要，但解决问题更重要</strong></li>
<li><strong>技术要精进，但生活也要平衡</strong></li>
<li><strong>多分享，多交流，多思考</strong></li>
<li><strong>记住，你首先是一个人，其次才是程序员</strong></li>
</ol>
<h3 data-id="heading-14">✨ 下一个五年</h3>
<p>技术这条路很长，但我不急了。慢慢地学习，稳稳地成长，踏实做好每一个项目。</p>
<p>毕竟，<strong>最好的代码不是最复杂的，而是最合适的</strong>。最好的程序员不是最聪明的，而是最懂得平衡的。</p>
<p>愿我们都能在这条路上，找到属于自己的节奏和答案。</p>
<hr/>
<p><em>你在前端路上有什么难忘的经历？欢迎在评论区分享你的故事。</em></p>
<p>#前端开发 #程序员成长 #技术感悟 #职场经验 #真实感受</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android稳定性基础:系统架构与关键机制]]></title>    <link>https://juejin.cn/post/7587776610436497423</link>    <guid>https://juejin.cn/post/7587776610436497423</guid>    <pubDate>2025-12-26T12:45:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587776610436497423" data-draft-id="7587808953076678656" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android稳定性基础:系统架构与关键机制"/> <meta itemprop="keywords" content="Android,性能优化"/> <meta itemprop="datePublished" content="2025-12-26T12:45:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android稳定性基础:系统架构与关键机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T12:45:07.000Z" title="Fri Dec 26 2025 12:45:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Android稳定性基础:系统架构与关键机制</h2>
<blockquote>
<p>系统稳定性是用户体验的基石,也是品牌口碑的生命线。</p>
</blockquote>
<h3 data-id="heading-1">引言:为什么系统稳定性如此重要?</h3>
<p>还记得某知名手机品牌因为系统频繁死机被用户集体投诉的新闻吗?一次系统崩溃可能只需要几秒钟,但对品牌形象的伤害却需要几年来修复。</p>
<p>作为一名Android Framework工程师,你可能经常会遇到这样的场景:</p>
<ul>
<li>测试同学气冲冲地跑过来:"手机又卡死了!"</li>
<li>用户反馈:"App动不动就闪退,太烂了!"</li>
<li>老板在群里@所有人:"线上出现大面积ANR,紧急处理!"</li>
</ul>
<p>这些问题的背后,都指向同一个主题——<strong>系统稳定性</strong>。</p>
<p>系统稳定性就像是房子的地基。地基不稳,再漂亮的装修也是空中楼阁。Android系统运行着数十个系统进程、上百个系统服务,它们就像一个精密的交响乐团,任何一个成员出了问题,整场演出都会受到影响。</p>
<p>本文是《Android系统稳定性与性能优化》系列的开篇之作。我们将从Android系统架构出发,带你建立起系统稳定性分析的基础认知框架。读完本文,你将能够:</p>
<ol>
<li>理解Android系统分层架构与稳定性的关系</li>
<li>掌握系统稳定性的核心机制和关键组件</li>
<li>了解稳定性问题的分类和表现形式</li>
<li>建立系统稳定性分析的基础思维框架</li>
</ol>
<p>准备好了吗?让我们开始这段探索之旅!</p>
<hr/>
<h3 data-id="heading-2">一、Android系统架构回顾</h3>
<p>要理解系统稳定性,首先要对Android的系统架构有清晰的认识。如果把Android系统比作一栋大楼,那么它是这样分层建造的:</p>
<h4 data-id="heading-3">1.1 分层架构概览</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12a44f64f0a2406bbef3524a012c752a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767357907&amp;x-signature=0pGk1YvoHwtfPNJcf00Qo15WlKI%3D" alt="01-01-android-architecture.png" loading="lazy"/></p>
<p>这种分层设计就像是一个金字塔,<strong>越往下层越稳定,但出问题的影响也越大</strong>。</p>
<p>打个比方:如果你家的灯泡坏了(应用层),换一个就好;如果电路板烧了(Framework层),可能整个房间都没电;如果变压器炸了(Kernel层),整栋楼都要遭殃!</p>
<h4 data-id="heading-4">1.2 各层对稳定性的影响</h4>
<p>让我们逐层分析,看看每一层可能出现什么稳定性问题:</p>
<h5 data-id="heading-5">应用层 (Applications)</h5>
<p>这是用户直接接触的层面,稳定性问题主要表现为:</p>
<ul>
<li><strong>Java Crash</strong>: 未捕获的异常导致应用闪退</li>
<li><strong>ANR</strong>: 主线程阻塞导致应用无响应</li>
<li><strong>内存泄漏</strong>: 持续占用内存最终导致OOM</li>
</ul>
<p><strong>影响范围</strong>: 单个应用
<strong>严重程度</strong>: 一般(用户可以重新打开应用)</p>
<h5 data-id="heading-6">Framework层 (Application Framework)</h5>
<p>这是Android的"大脑",提供了所有应用运行所需的服务:</p>
<ul>
<li><strong>System Server Crash</strong>: 核心系统服务崩溃,导致系统重启</li>
<li><strong>服务死锁</strong>: 多个服务相互等待,系统卡死</li>
<li><strong>Binder资源耗尽</strong>: 进程间通信阻塞</li>
</ul>
<p><strong>影响范围</strong>: 整个系统
<strong>严重程度</strong>: 严重(可能导致系统重启)</p>
<h5 data-id="heading-7">Native层 (Native Libraries &amp; ART)</h5>
<p>这一层用C/C++编写,执行效率高但也更容易出问题:</p>
<ul>
<li><strong>Native Crash</strong>: SIGSEGV、SIGABRT等信号导致进程终止</li>
<li><strong>内存访问违规</strong>: 野指针、数组越界</li>
<li><strong>资源泄漏</strong>: 文件描述符、内存泄漏</li>
</ul>
<p><strong>影响范围</strong>: 单个进程到整个系统
<strong>严重程度</strong>: 重要到严重</p>
<h5 data-id="heading-8">HAL层 (Hardware Abstraction Layer)</h5>
<p>硬件抽象层连接软件和硬件:</p>
<ul>
<li><strong>HAL服务崩溃</strong>: 硬件功能不可用</li>
<li><strong>硬件超时</strong>: 与硬件通信超时</li>
</ul>
<p><strong>影响范围</strong>: 特定硬件功能
<strong>严重程度</strong>: 重要</p>
<h5 data-id="heading-9">Kernel层 (Linux Kernel)</h5>
<p>这是系统的根基:</p>
<ul>
<li><strong>Kernel Panic</strong>: 内核崩溃,系统直接重启</li>
<li><strong>驱动崩溃</strong>: 特定硬件功能异常</li>
<li><strong>死锁</strong>: 系统完全卡死</li>
</ul>
<p><strong>影响范围</strong>: 整个设备
<strong>严重程度</strong>: 致命</p>
<h4 data-id="heading-10">1.3 关键进程与服务</h4>
<p>在Android系统中,有几个进程是"命根子",它们挂了,整个系统就得重启:</p>
<h5 data-id="heading-11">Zygote进程</h5>
<p>Zygote是Android的"孵化器",所有应用进程都是从它fork出来的。可以把它想象成一个"应用工厂":</p>
<pre><code class="hljs language-scss" lang="scss">Zygote
  ├── <span class="hljs-built_in">fork</span>() → App1进程
  ├── <span class="hljs-built_in">fork</span>() → App2进程
  ├── <span class="hljs-built_in">fork</span>() → App3进程
  └── <span class="hljs-built_in">fork</span>() → System Server进程
</code></pre>
<p>如果Zygote挂了,就像工厂倒闭了,新的应用进程无法创建,系统只能重启。</p>
<h5 data-id="heading-12">System Server进程</h5>
<p>System Server是Android的"大管家",运行着几乎所有核心系统服务:</p>



































<table><thead><tr><th>服务名称</th><th>职责</th><th>挂了会怎样</th></tr></thead><tbody><tr><td>ActivityManagerService</td><td>管理四大组件生命周期</td><td>无法启动/切换应用</td></tr><tr><td>WindowManagerService</td><td>管理窗口显示</td><td>屏幕一片空白</td></tr><tr><td>PackageManagerService</td><td>管理应用安装/查询</td><td>无法安装/查找应用</td></tr><tr><td>PowerManagerService</td><td>管理电源状态</td><td>无法休眠/唤醒</td></tr><tr><td>InputManagerService</td><td>管理输入事件</td><td>触摸/按键失效</td></tr></tbody></table>
<p>System Server一旦崩溃,整个系统就会重启(你会看到开机动画重新播放)。</p>
<h5 data-id="heading-13">SurfaceFlinger进程</h5>
<p>SurfaceFlinger是Android的"画师",负责将所有应用的界面合成后显示到屏幕上:</p>
<pre><code class="hljs language-css" lang="css">App1 Surface ─┐
App2 Surface ──┼──→ SurfaceFlinger ──→ <span class="hljs-attribute">Display</span>
StatusBar    ─┘
</code></pre>
<p>如果SurfaceFlinger挂了,屏幕要么黑屏,要么画面定格。</p>
<hr/>
<h3 data-id="heading-14">二、稳定性核心机制</h3>
<p>Android系统设计了多种机制来保障稳定性,就像人体的免疫系统一样。让我们逐一了解这些"护城河"。</p>
<h4 data-id="heading-15">2.1 进程管理机制</h4>
<p>Android是一个多任务操作系统,但手机的内存是有限的。如何在有限的资源下保证系统流畅运行?答案是<strong>进程优先级管理</strong>和<strong>Low Memory Killer (LMK)</strong>。</p>
<h5 data-id="heading-16">进程优先级</h5>
<p>Android根据进程的重要性将其分为5个等级:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d1d8b3f5d06479ebe824d587664a23e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767357907&amp;x-signature=mJkiv4sgDLoVXnaz9Qh9ysdVU%2BY%3D" alt="01-02-process-priority-lmk.png" loading="lazy"/></p>















































<table><thead><tr><th>优先级</th><th>名称</th><th>oom_adj</th><th>说明</th><th>例子</th></tr></thead><tbody><tr><td>最高</td><td>Foreground</td><td>0</td><td>用户正在交互的进程</td><td>前台App</td></tr><tr><td>高</td><td>Visible</td><td>100</td><td>可见但不在前台</td><td>后台有悬浮窗的App</td></tr><tr><td>中</td><td>Service</td><td>200</td><td>运行后台服务的进程</td><td>音乐播放器</td></tr><tr><td>低</td><td>Cached</td><td>900</td><td>缓存的后台进程</td><td>最近使用的App</td></tr><tr><td>最低</td><td>Empty</td><td>999</td><td>空进程,随时可杀</td><td>已退出的App</td></tr></tbody></table>
<p>可以用以下代码查看进程优先级:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查看进程优先级</span>
<span class="hljs-type">ActivityManager</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> getSystemService(ActivityManager.class);
List&lt;ActivityManager.RunningAppProcessInfo&gt; processes = am.getRunningAppProcesses();
<span class="hljs-keyword">for</span> (ActivityManager.RunningAppProcessInfo info : processes) {
    Log.d(TAG, <span class="hljs-string">"Process: "</span> + info.processName +
          <span class="hljs-string">", Importance: "</span> + info.importance +
          <span class="hljs-string">", ImportanceReasonCode: "</span> + info.importanceReasonCode);
}
</code></pre>
<h5 data-id="heading-17">Low Memory Killer (LMK)</h5>
<p>当系统内存不足时,LMK就会出马"杀进程"。它的工作原理很简单:<strong>优先杀低优先级的进程,释放内存给高优先级进程使用</strong>。</p>
<pre><code class="hljs language-ini" lang="ini">内存充足时:  <span class="hljs-section">[前台App]</span> <span class="hljs-section">[可见App]</span> <span class="hljs-section">[服务]</span> <span class="hljs-section">[缓存1]</span> <span class="hljs-section">[缓存2]</span> <span class="hljs-section">[空进程]</span>
                ↓ 内存紧张
内存紧张时:  <span class="hljs-section">[前台App]</span> <span class="hljs-section">[可见App]</span> <span class="hljs-section">[服务]</span> <span class="hljs-section">[缓存1]</span>  ← 空进程和缓存2被杀
                ↓ 内存严重不足
极端情况:    <span class="hljs-section">[前台App]</span> <span class="hljs-section">[可见App]</span>  ← 连服务进程都被杀了
</code></pre>
<p><strong>LMK vs OOM Killer的区别</strong>:</p>






























<table><thead><tr><th>特性</th><th>LMK</th><th>OOM Killer</th></tr></thead><tbody><tr><td>所属层</td><td>Android用户空间</td><td>Linux内核</td></tr><tr><td>触发时机</td><td>内存低于阈值时(主动)</td><td>内存耗尽时(被动)</td></tr><tr><td>杀进程策略</td><td>基于oom_adj优先级</td><td>基于oom_score</td></tr><tr><td>目的</td><td>预防性释放内存</td><td>紧急释放内存</td></tr></tbody></table>
<p>LMK就像是一个"未雨绸缪"的管家,在内存紧张之前就开始清理;而OOM Killer是"亡羊补牢"的最后手段。</p>
<h4 data-id="heading-18">2.2 异常监控机制</h4>
<p>Android系统有一套完善的"健康检查"机制,能够及时发现并处理各种异常。</p>
<h5 data-id="heading-19">ANR监控</h5>
<p>ANR (Application Not Responding) 是用户最常遇到的稳定性问题之一。当应用在规定时间内没有响应,系统就会弹出"应用无响应"对话框。</p>
<p>ANR的触发条件:</p>






























<table><thead><tr><th>类型</th><th>超时时间</th><th>触发场景</th></tr></thead><tbody><tr><td>Input事件</td><td>5秒</td><td>触摸/按键事件未处理</td></tr><tr><td>Broadcast</td><td>前台10秒/后台60秒</td><td>广播接收器未完成</td></tr><tr><td>Service</td><td>前台20秒/后台200秒</td><td>服务启动未完成</td></tr><tr><td>ContentProvider</td><td>10秒</td><td>Provider发布超时</td></tr></tbody></table>
<p>ANR监控的核心逻辑:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 简化的ANR检测逻辑 (InputDispatcher.cpp)</span>
<span class="hljs-keyword">void</span> InputDispatcher::handleAnr() {
    <span class="hljs-comment">// 1. 发送输入事件给应用</span>
    dispatchEventLocked(event);

    <span class="hljs-comment">// 2. 设置超时定时器 (5秒)</span>
    mAnrTimer.set(5000ms);

    <span class="hljs-comment">// 3. 等待应用响应</span>
    <span class="hljs-keyword">if</span> (!receivedResponse &amp;&amp; timeout) {
        <span class="hljs-comment">// 4. 触发ANR</span>
        notifyAnr(connection, reason);
    }
}
</code></pre>
<h5 data-id="heading-20">Crash监控</h5>
<p>应用崩溃分为Java Crash和Native Crash两种:</p>
<p><strong>Java Crash处理流程</strong>:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设置全局异常处理器</span>
Thread.setDefaultUncaughtExceptionHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>.UncaughtExceptionHandler() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uncaughtException</span><span class="hljs-params">(Thread t, Throwable e)</span> {
        <span class="hljs-comment">// 1. 收集崩溃信息</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">stackTrace</span> <span class="hljs-operator">=</span> Log.getStackTraceString(e);

        <span class="hljs-comment">// 2. 写入日志</span>
        Log.e(TAG, <span class="hljs-string">"Uncaught exception in thread "</span> + t.getName(), e);

        <span class="hljs-comment">// 3. 上报到服务器 (可选)</span>
        CrashReporter.report(e);

        <span class="hljs-comment">// 4. 终止进程</span>
        Process.killProcess(Process.myPid());
    }
});
</code></pre>
<p><strong>Native Crash处理流程</strong>:</p>
<p>Native层的崩溃通过Linux信号机制处理:</p>
<pre><code class="hljs language-scss" lang="scss">程序触发SIGSEGV (段错误)
        ↓
内核发送信号给进程
        ↓
debuggerd捕获信号
        ↓
收集崩溃信息(寄存器、堆栈、maps)
        ↓
生成tombstone文件
        ↓
通知AMS进程终止
</code></pre>
<h5 data-id="heading-21">Watchdog机制</h5>
<p>Watchdog是System Server的"看门狗",专门监控核心线程是否正常运行。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Watchdog监控的核心线程</span>
mMonitorChecker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerChecker</span>(FgThread.getHandler(), <span class="hljs-string">"foreground thread"</span>);
mMonitorChecker.addMonitor(mAms); <span class="hljs-comment">// ActivityManagerService</span>
mMonitorChecker.addMonitor(mWms); <span class="hljs-comment">// WindowManagerService</span>
mMonitorChecker.addMonitor(mPms); <span class="hljs-comment">// PowerManagerService</span>
<span class="hljs-comment">// ...</span>
</code></pre>
<p>Watchdog的工作原理:</p>
<ol>
<li>每隔30秒向被监控线程的Handler发送消息</li>
<li>如果60秒内没有收到响应,判定为半死锁状态</li>
<li>如果超过60秒(默认值)仍无响应,触发Watchdog重启</li>
<li>生成traces.txt文件,记录所有线程堆栈</li>
</ol>

<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">正常情况:</span>
Watchdog ──发送消息──→ 核心线程 ──30秒内响应──→ Watchdog: <span class="hljs-string">"一切正常"</span>

<span class="hljs-section">异常情况:</span>
Watchdog ──发送消息──→ 核心线程(卡住了) ──60秒无响应──→ Watchdog: <span class="hljs-string">"重启System Server!"</span>
</code></pre>
<h4 data-id="heading-22">2.3 资源管理机制</h4>
<p>资源泄漏是稳定性问题的常见根因。Android对几类关键资源有专门的管理机制。</p>
<h5 data-id="heading-23">内存管理</h5>
<p>Android的内存分为几个区域:</p>






























<table><thead><tr><th>内存类型</th><th>说明</th><th>典型问题</th></tr></thead><tbody><tr><td>Java Heap</td><td>Dalvik/ART管理的堆内存</td><td>内存泄漏导致OOM</td></tr><tr><td>Native Heap</td><td>C/C++分配的内存</td><td>忘记free导致泄漏</td></tr><tr><td>Graphics</td><td>GPU使用的图形内存</td><td>大图片导致OOM</td></tr><tr><td>Code</td><td>加载的dex/so占用</td><td>加载过多库</td></tr></tbody></table>
<h5 data-id="heading-24">文件描述符(FD)管理</h5>
<p>每个进程可打开的文件描述符数量是有限的(通常是1024个)。FD泄漏会导致:</p>
<ul>
<li>无法打开新文件</li>
<li>无法创建新Socket</li>
<li>无法建立Binder连接</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看进程的FD使用情况</span>
adb shell <span class="hljs-built_in">ls</span> -la /proc/&lt;pid&gt;/fd | <span class="hljs-built_in">wc</span> -l

<span class="hljs-comment"># 查看FD限制</span>
adb shell <span class="hljs-built_in">cat</span> /proc/&lt;pid&gt;/limits | grep <span class="hljs-string">"open files"</span>
</code></pre>
<h5 data-id="heading-25">Binder资源管理</h5>
<p>Binder是Android最重要的IPC机制,但它的资源也是有限的:</p>
<ul>
<li><strong>Binder线程池</strong>: 默认最多16个线程</li>
<li><strong>Binder缓冲区</strong>: 每个进程最大1MB(普通应用)</li>
<li><strong>Binder代理对象</strong>: 数量有上限</li>
</ul>
<p>当Binder资源耗尽时,进程间通信就会失败,表现为ANR或功能异常。</p>
<hr/>
<h3 data-id="heading-26">三、稳定性问题分类</h3>
<p>了解了稳定性机制后,让我们来系统地分类各种稳定性问题。</p>
<h4 data-id="heading-27">3.1 按严重程度分类</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a39fd2a78d5742839b1506a3a821879d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767357907&amp;x-signature=n1m%2F9wrnxMSiTDROyGyENnl0FlU%3D" alt="01-03-stability-classification.png" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">严重程度金字塔:

        /\
       /致\        Kernel Panic、System <span class="hljs-built_in">Server</span> Crash
      /命级\       → 系统重启,用户数据可能丢失
     /──────\
    / 严重级 \     Native Crash、Watchdog重启
   /──────────\    → 功能不可用,需要重启应用/系统
  /  重要级    \   ANR、系统服务无响应
 /──────────────\  → 用户体验严重下降
/    一般级      \ 应用Crash、性能卡顿
/────────────────\ → 影响单个应用,用户可恢复
</code></pre>
<h4 data-id="heading-28">3.2 按表现形式分类</h4>
<h5 data-id="heading-29">无响应类</h5>

























<table><thead><tr><th>问题</th><th>表现</th><th>常见原因</th></tr></thead><tbody><tr><td>ANR</td><td>弹出"应用无响应"对话框</td><td>主线程阻塞、死锁</td></tr><tr><td>System无响应</td><td>系统卡死,按键无反应</td><td>System Server死锁</td></tr><tr><td>黑屏</td><td>屏幕无显示</td><td>SurfaceFlinger问题</td></tr></tbody></table>
<h5 data-id="heading-30">崩溃类</h5>

























<table><thead><tr><th>问题</th><th>表现</th><th>常见原因</th></tr></thead><tbody><tr><td>Java Crash</td><td>应用闪退</td><td>空指针、数组越界</td></tr><tr><td>Native Crash</td><td>应用闪退,有tombstone</td><td>内存访问违规</td></tr><tr><td>Kernel Crash</td><td>系统直接重启</td><td>驱动bug、硬件问题</td></tr></tbody></table>
<h5 data-id="heading-31">异常重启类</h5>

























<table><thead><tr><th>问题</th><th>表现</th><th>常见原因</th></tr></thead><tbody><tr><td>Watchdog重启</td><td>看到开机动画</td><td>系统服务死锁</td></tr><tr><td>Kernel Panic</td><td>突然重启</td><td>内核异常</td></tr><tr><td>硬件Watchdog</td><td>突然重启</td><td>系统完全卡死</td></tr></tbody></table>
<h4 data-id="heading-32">3.3 常见根因分析</h4>
<p>经过大量问题分析,我总结了稳定性问题的常见根因:</p>
<ol>
<li>
<p><strong>死锁问题</strong> (约25%)</p>
<ul>
<li>多线程竞争同一资源</li>
<li>Binder调用形成环路</li>
<li>主线程等待子线程</li>
</ul>
</li>
<li>
<p><strong>资源耗尽</strong> (约20%)</p>
<ul>
<li>内存泄漏导致OOM</li>
<li>FD泄漏</li>
<li>Binder资源耗尽</li>
</ul>
</li>
<li>
<p><strong>内存访问违规</strong> (约15%)</p>
<ul>
<li>空指针引用</li>
<li>野指针</li>
<li>数组越界</li>
</ul>
</li>
<li>
<p><strong>并发竞态</strong> (约15%)</p>
<ul>
<li>多线程读写冲突</li>
<li>时序问题</li>
</ul>
</li>
<li>
<p><strong>第三方SDK问题</strong> (约10%)</p>
<ul>
<li>SDK兼容性问题</li>
<li>SDK内部bug</li>
</ul>
</li>
<li>
<p><strong>其他</strong> (约15%)</p>
<ul>
<li>配置错误</li>
<li>硬件兼容性</li>
<li>系统bug</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-33">四、稳定性分析思维框架</h3>
<p>当遇到稳定性问题时,如何高效地定位根因?这里分享一套实用的分析框架。</p>
<h4 data-id="heading-34">4.1 分析流程</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47b8d166890d4fae9d12e3cfbe133364~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767357907&amp;x-signature=KD63VvZdamCBTZarqkUvrz9rOaQ%3D" alt="01-04-analysis-workflow.png" loading="lazy"/></p>
<h4 data-id="heading-35">4.2 5W1H分析法</h4>
<p>面对稳定性问题,我习惯用5W1H法来理清思路:</p>








































<table><thead><tr><th>问题</th><th>说明</th><th>如何获取</th></tr></thead><tbody><tr><td><strong>What</strong></td><td>发生了什么?</td><td>现象描述、错误类型</td></tr><tr><td><strong>When</strong></td><td>什么时候发生?</td><td>时间戳、发生频率</td></tr><tr><td><strong>Where</strong></td><td>在哪里发生?</td><td>模块、文件、代码行</td></tr><tr><td><strong>Who</strong></td><td>谁出了问题?</td><td>进程、线程、组件</td></tr><tr><td><strong>Why</strong></td><td>为什么发生?</td><td>根本原因分析</td></tr><tr><td><strong>How</strong></td><td>如何复现?如何解决?</td><td>复现步骤、修复方案</td></tr></tbody></table>
<h4 data-id="heading-36">4.3 工具箱概览</h4>
<p>工欲善其事,必先利其器。以下是分析稳定性问题的常用工具:</p>
<h5 data-id="heading-37">日志工具</h5>

























<table><thead><tr><th>工具</th><th>用途</th><th>命令示例</th></tr></thead><tbody><tr><td>logcat</td><td>查看实时日志</td><td><code>adb logcat -v threadtime</code></td></tr><tr><td>DropBox</td><td>查看系统保存的异常</td><td><code>adb shell dumpsys dropbox</code></td></tr><tr><td>bugreport</td><td>导出完整系统日志</td><td><code>adb bugreport</code></td></tr></tbody></table>
<h5 data-id="heading-38">分析工具</h5>






























<table><thead><tr><th>工具</th><th>用途</th><th>适用场景</th></tr></thead><tbody><tr><td>Systrace</td><td>系统级性能分析</td><td>ANR、卡顿问题</td></tr><tr><td>Perfetto</td><td>新一代trace工具</td><td>复杂性能问题</td></tr><tr><td>addr2line</td><td>Native符号化</td><td>Native Crash</td></tr><tr><td>MAT</td><td>内存分析</td><td>内存泄漏</td></tr></tbody></table>
<h5 data-id="heading-39">示例:分析一个ANR</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 获取ANR traces</span>
adb pull /data/anr/traces.txt

<span class="hljs-comment"># 2. 查看ANR原因</span>
adb shell dumpsys activity anr

<span class="hljs-comment"># 3. 分析traces.txt中的堆栈</span>
<span class="hljs-comment"># 重点关注main线程的状态:</span>
<span class="hljs-comment"># - 如果是BLOCKED,找它在等什么锁</span>
<span class="hljs-comment"># - 如果是WAITING,找它在等什么信号</span>
<span class="hljs-comment"># - 如果在执行某个方法,分析该方法为什么慢</span>

<span class="hljs-comment"># 4. 使用Systrace进一步分析</span>
python systrace.py -o trace.html <span class="hljs-built_in">sched</span> freq idle am wm gfx view
</code></pre>
<hr/>
<h3 data-id="heading-40">五、实战案例:一个真实的ANR分析</h3>
<p>让我们通过一个真实案例,演示如何运用上面的知识进行分析。</p>
<h4 data-id="heading-41">问题现象</h4>
<p>用户反馈:在设置中切换WiFi时,经常出现"系统界面无响应"的弹窗。</p>
<h4 data-id="heading-42">分析过程</h4>
<p><strong>Step 1: 收集日志</strong></p>
<pre><code class="hljs language-bash" lang="bash">adb bugreport
adb pull /data/anr/traces.txt
</code></pre>
<p><strong>Step 2: 确定问题类型</strong></p>
<p>从DropBox中找到ANR记录:</p>
<pre><code class="hljs language-ini" lang="ini">Subject: Broadcast of Intent { <span class="hljs-attr">act</span>=android.net.wifi.WIFI_STATE_CHANGED }
ANR in com.android.systemui
PID: 1234
Reason: Broadcast of Intent { <span class="hljs-attr">act</span>=android.net.wifi.WIFI_STATE_CHANGED }
        waited 10003ms for android.intent.action.BATTERY_CHANGED
</code></pre>
<p>这是一个<strong>Broadcast Timeout ANR</strong>。</p>
<p><strong>Step 3: 分析堆栈</strong></p>
<p>从traces.txt中找到SystemUI的主线程:</p>
<pre><code class="hljs language-ini" lang="ini">"main" <span class="hljs-attr">prio</span>=<span class="hljs-number">5</span> tid=<span class="hljs-number">1</span> Blocked
  | <span class="hljs-attr">group</span>=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0</span>x74e04dd8 self=<span class="hljs-number">0</span>x7a4e014c00
  | <span class="hljs-attr">sysTid</span>=<span class="hljs-number">1234</span> nice=-<span class="hljs-number">2</span> cgrp=default sched=<span class="hljs-number">0</span>/<span class="hljs-number">0</span> handle=<span class="hljs-number">0</span>x7b5a9f49a8
  | <span class="hljs-attr">state</span>=S schedstat=( <span class="hljs-number">123456789</span> <span class="hljs-number">987654321</span> <span class="hljs-number">12345</span> ) utm=<span class="hljs-number">100</span> stm=<span class="hljs-number">50</span> core=<span class="hljs-number">2</span> HZ=<span class="hljs-number">100</span>
  at com.android.systemui.BatteryController.update(BatteryController.java:150)
  - waiting to lock &lt;0x0a1b2c3d&gt; (a java.lang.Object) held by thread 15
  at com.android.systemui.BatteryController.onReceive(BatteryController.java:100)
  ...
</code></pre>
<p>主线程在等一个锁,这个锁被线程15持有。</p>
<p><strong>Step 4: 找到持锁线程</strong></p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-string">"BatteryStats"</span> prio=<span class="hljs-number">5</span> tid=<span class="hljs-number">15</span> Native
  | group=<span class="hljs-string">"main"</span> sCount=<span class="hljs-number">1</span> dsCount=<span class="hljs-number">0</span> flags=<span class="hljs-number">1</span> obj=<span class="hljs-number">0x13579bdf</span> <span class="hljs-built_in">self</span>=<span class="hljs-number">0x7a4e028800</span>
  at android.<span class="hljs-built_in">os</span>.BinderProxy.transactNative(Native Method)
  at android.<span class="hljs-built_in">os</span>.BinderProxy.transact(Binder.java:<span class="hljs-number">1129</span>)
  at com.android.internal.<span class="hljs-built_in">os</span>.IBatteryStats$Stub$Proxy.noteWifiOn(IBatteryStats.java:<span class="hljs-number">2046</span>)
  ...
</code></pre>
<p>线程15正在进行Binder调用,等待BatteryStatsService响应。</p>
<p><strong>Step 5: 根因分析</strong></p>
<p>经过进一步分析发现,BatteryStatsService正在进行一个耗时的统计操作,导致Binder调用超时。最终形成了这样的等待链:</p>
<pre><code class="hljs">主线程等待锁 → 线程15持有锁但在等Binder → BatteryStatsService繁忙
</code></pre>
<p><strong>Step 6: 解决方案</strong></p>
<ol>
<li>将BatteryController的更新操作移到子线程</li>
<li>优化BatteryStatsService的统计逻辑</li>
</ol>
<hr/>
<h3 data-id="heading-43">六、后续文章预告</h3>
<p>本文作为系列开篇,建立了系统稳定性的基础认知框架。在后续文章中,我们将深入每个专题:</p>






























<table><thead><tr><th>文章</th><th>主题</th><th>你将学到</th></tr></thead><tbody><tr><td>第2篇</td><td>ANR机制深度解析</td><td>ANR的触发、检测、上报全流程</td></tr><tr><td>第3篇</td><td>ANR问题排查实战</td><td>traces.txt分析技巧、常见ANR案例</td></tr><tr><td>第4篇</td><td>Native Crash分析</td><td>tombstone解读、addr2line使用</td></tr><tr><td>第5篇</td><td>Watchdog机制</td><td>系统看门狗的工作原理</td></tr></tbody></table>
<p>敬请期待!</p>
<hr/>
<h3 data-id="heading-44">总结</h3>
<p>本文从Android系统架构出发,介绍了系统稳定性的核心概念:</p>
<ol>
<li><strong>分层架构</strong>: 理解Android五层架构及各层的稳定性影响</li>
<li><strong>关键进程</strong>: Zygote、System Server、SurfaceFlinger是系统的"生命线"</li>
<li><strong>核心机制</strong>: 进程优先级、LMK、ANR检测、Watchdog构成了稳定性保障体系</li>
<li><strong>问题分类</strong>: 按严重程度和表现形式对稳定性问题进行分类</li>
<li><strong>分析框架</strong>: 5W1H分析法和工具箱帮助高效定位问题</li>
</ol>
<p>系统稳定性不是一朝一夕能掌握的,需要在实践中不断积累。希望本文能帮你建立起正确的认知框架,在面对稳定性问题时不再迷茫。</p>
<hr/>
<h3 data-id="heading-45">参考资料</h3>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fguide%2Fplatform" target="_blank" title="https://developer.android.com/guide/platform" ref="nofollow noopener noreferrer">Android官方文档 - 系统架构</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcs.android.com%2Fandroid%2Fplatform%2Fsuperproject%2F%2B%2Fmaster%3Aframeworks%2Fbase%2Fservices%2Fcore%2Fjava%2Fcom%2Fandroid%2Fserver%2Fam%2F" target="_blank" title="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/am/" ref="nofollow noopener noreferrer">AOSP源码 - ActivityManagerService</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbook.douban.com%2Fsubject%2F25921329%2F" target="_blank" title="https://book.douban.com/subject/25921329/" ref="nofollow noopener noreferrer">深入理解Android内核设计思想</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbook.douban.com%2Fsubject%2F19986441%2F" target="_blank" title="https://book.douban.com/subject/19986441/" ref="nofollow noopener noreferrer">Android系统源代码情景分析</a></li>
</ol>
<hr/>
<blockquote>
<p><strong>作者简介</strong>: 多年Android系统开发经验,专注于系统稳定性与性能优化领域。欢迎关注本系列,一起深入Android系统的精彩世界!</p>
</blockquote>
<p><strong>找到我</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a><br/>
<strong>返回专栏目录</strong>: <a href="https://juejin.cn/post/7587473691170095104" target="_blank" title="https://juejin.cn/post/7587473691170095104">Android稳定性&amp;性能深入理解专栏介绍</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain Tool 实战：让大模型“长出双手”，通过 Tool 调用连接真实世界]]></title>    <link>https://juejin.cn/post/7588034035286425615</link>    <guid>https://juejin.cn/post/7588034035286425615</guid>    <pubDate>2025-12-26T15:51:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588034035286425615" data-draft-id="7587997157237489716" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" LangChain Tool 实战：让大模型“长出双手”，通过 Tool 调用连接真实世界"/> <meta itemprop="keywords" content="LangChain,Node.js,AIGC"/> <meta itemprop="datePublished" content="2025-12-26T15:51:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神秘的猪头"/> <meta itemprop="url" content="https://juejin.cn/user/793223472877051"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             LangChain Tool 实战：让大模型“长出双手”，通过 Tool 调用连接真实世界
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/793223472877051/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神秘的猪头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T15:51:50.000Z" title="Fri Dec 26 2025 15:51:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>前言</strong></p>
<p>大语言模型（LLM）通常被比作“大脑”，它拥有海量的知识和强大的逻辑推理能力。但是，一个只有大脑的智者，如果无法感知当下的时间、无法查询实时的天气、无法进行精确的数学运算，它的能力就会大打折扣。</p>
<p><strong>Tools（工具）</strong> 模块，就是 LangChain 赋予大模型的“双手”和“感官”。通过 Tools，我们可以让大模型不仅仅是陪聊，而是真正具备<strong>调用外部函数、执行复杂任务</strong>的能力。</p>
<p>本文将结合一段基于 <code>ChatDeepSeek</code> 的实战代码，带你从零开始，深入理解如何在 LangChain 中定义工具、使用 Zod 进行参数校验，以及如何优雅地处理模型返回的工具调用请求。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、 为什么我们需要 Tool？</h2>
<p>在深入代码之前，我们先思考一个问题：为什么 ChatGPT 有时候做不好简单的加减法？为什么它不知道今天北京的天气？</p>
<p>因为大模型的本质是<strong>概率预测</strong>，它是基于训练数据生成下一个字的，而不是基于逻辑运算或实时数据库。</p>
<ul>
<li><strong>数学计算</strong>：大模型是“文科生”，复杂的计算容易产生幻觉。</li>
<li><strong>实时信息</strong>：大模型的训练数据截止于过去，它无法预知“今天”发生的事情。</li>
</ul>
<p><strong>LangChain Tool 的出现解决了这个问题。</strong> 它的核心思想是：
当用户问“1234 + 5678 等于几？”时，大模型不再自己瞎猜，而是分析出“哦，这是一个计算任务”，然后告诉程序：“请帮我调用 <code>add</code> 工具，参数是 <code>a=1234, b=5678</code>”。程序运行完代码后，将结果反馈给用户。</p>
<blockquote>
<p>还有一个重要作用在于：对于简单任务，无需调用大模型自行处理，从而节省宝贵的 <strong>token</strong>；而对于大模型本身难以完成的特定任务 <strong>(实时感知、精准执行或外部操作.....)</strong>，则可以通过调用外部工具来扩展其能力，使其能够间接完成这些工作。</p>
</blockquote>
<p>接下来，我们将通过代码一步步实现这个过程。</p>
<hr/>
<h2 data-id="heading-1">二、 基础入门：定义一个简单的“加法工具”</h2>
<p>我们要讲的第一个知识点是：<strong>如何定义一个工具</strong>。</p>
<p>在 LangChain 中，<code>tool</code> 函数是核心。我们需要引入它，并配合 <code>zod</code> 库来定义参数结构。</p>
<h3 data-id="heading-2">1. 引入必要的依赖</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatDeepSeek</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/deepseek"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'dotenv/config'</span>;
<span class="hljs-keyword">import</span> { tool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/tools"</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>; <span class="hljs-comment">// 关键：用于定义函数参数的类型 schema</span>
</code></pre>
<p>这里重点介绍一下 <strong><code>zod</code></strong>。
大模型输出的是文本（JSON 字符串），而我们的函数需要的是具体的变量（如数字、字符串）。<strong>Zod 的作用就是建立一个“契约”</strong>：它告诉大模型，“如果你要调用这个工具，你必须给我传什么样的参数，是数字还是字符串”。这大大提高了工具调用的准确性。</p>
<h3 data-id="heading-3">2. 编写加法工具 (<code>addTool</code>)</h3>
<p>我们先从最简单的加法开始，让大模型学会算术。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 函数 定义一个加法工具</span>
<span class="hljs-keyword">const</span> addTool = <span class="hljs-title function_">tool</span>(
    <span class="hljs-comment">// 1. 工具的具体逻辑（函数体）</span>
    <span class="hljs-comment">// 这里接收一个对象，解构出 a 和 b</span>
    <span class="hljs-comment">// 注意：所有工具函数的参数通常都会被包装成一个对象</span>
    <span class="hljs-keyword">async</span> ({a, b}) =&gt; <span class="hljs-title class_">String</span>(a + b), 
    {
        <span class="hljs-comment">// 2. 工具的元数据（Metadata）</span>
        <span class="hljs-attr">name</span>: <span class="hljs-string">"add"</span>, <span class="hljs-comment">// 工具名称，大模型通过这个名字识别工具</span>
        <span class="hljs-attr">description</span>: <span class="hljs-string">"计算两个数字的和"</span>, <span class="hljs-comment">// 工具描述，非常重要！这相当于写给大模型的 Prompt，告诉它什么时候用这个工具</span>
        
        <span class="hljs-comment">// 3. 参数 Schema 定义</span>
        <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
            <span class="hljs-attr">a</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"加数 a"</span>), <span class="hljs-comment">// 明确告诉模型，a 必须是一个数字</span>
            <span class="hljs-attr">b</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"加数 b"</span>)  <span class="hljs-comment">// b 也必须是一个数字</span>
        })
    }
)
</code></pre>
<p><strong>代码深度解析：</strong></p>
<ul>
<li><strong><code>tool(function, options)</code></strong>: 这是定义工具的标准范式。第一个参数是实际执行的 JavaScript 函数，第二个参数是配置对象。</li>
<li><strong><code>async ({a, b})</code></strong>: LangChain 的工具调用通常是异步的。参数被设计为解构形式，这是为了配合 Zod 定义的 Object Schema。</li>
<li><strong><code>description</code></strong>: 千万不要忽视描述！大模型正是通过这段文字来判断用户的问题是否需要使用该工具。如果描述写得含糊，模型可能就不会调用它。</li>
<li><strong><code>z.number()</code></strong>: 这里限制了 <code>a</code> 和 <code>b</code> 必须是数字。如果模型抽风传了字符串，Zod 会在底层进行校验或报错，保证了程序的健壮性。</li>
</ul>
<hr/>
<h2 data-id="heading-4">三、 进阶实战：定义“天气查询工具”</h2>
<p>学会了简单的加法，我们来模拟一个更贴近真实场景的业务——查询天气。
由于我们没有连接真实的气象局 API，这里我们使用一个“伪数据库”来模拟。</p>
<h3 data-id="heading-5">1. 模拟数据源</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> fakeWeatherDB = {
    北京: { <span class="hljs-attr">temp</span>: <span class="hljs-string">"30°C"</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"晴"</span>, <span class="hljs-attr">wind</span>: <span class="hljs-string">"微风"</span> },
    上海: { <span class="hljs-attr">temp</span>: <span class="hljs-string">"28°C"</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"多云"</span>, <span class="hljs-attr">wind</span>: <span class="hljs-string">"东风 3 级"</span> },
    广州: { <span class="hljs-attr">temp</span>: <span class="hljs-string">"32°C"</span>, <span class="hljs-attr">condition</span>: <span class="hljs-string">"阵雨"</span>, <span class="hljs-attr">wind</span>: <span class="hljs-string">"南风 2 级"</span> }
}
</code></pre>
<h3 data-id="heading-6">2. 编写天气工具 (<code>weatherTool</code>)</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> weatherTool = <span class="hljs-title function_">tool</span>(
    <span class="hljs-keyword">async</span> ({city}) =&gt; {
        <span class="hljs-comment">// 模拟数据库查询</span>
        <span class="hljs-keyword">const</span> weather = fakeWeatherDB[city];
        <span class="hljs-comment">// 边界情况处理</span>
        <span class="hljs-keyword">if</span>(!weather){
            <span class="hljs-keyword">return</span> <span class="hljs-string">`城市<span class="hljs-subst">${city}</span>的天气未找到`</span>;
        }
        <span class="hljs-comment">// 返回自然语言描述的结果，方便大模型理解</span>
       <span class="hljs-keyword">return</span> <span class="hljs-string">`当前<span class="hljs-subst">${city}</span>的天气是<span class="hljs-subst">${weather.temp}</span>,<span class="hljs-subst">${weather.condition}</span>, 风力<span class="hljs-subst">${weather.wind}</span>`</span>;
    },
    {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"get_weather"</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">"查询指定城市的今日天气情况"</span>, <span class="hljs-comment">// 明确的功能描述</span>
        <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
            <span class="hljs-comment">// z.string() 规定参数 city 必须是字符串</span>
            <span class="hljs-comment">// .describe() 进一步解释参数含义，帮助模型提取正确的实体</span>
            <span class="hljs-attr">city</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"要查询天气的城市"</span>) 
        })
    }
)
</code></pre>
<p><strong>知识点延伸：</strong>
在 <code>weatherTool</code> 中，我们看到了工具不仅仅是计算，还可以是<strong>查表、请求 API、读取文件</strong>。</p>
<ul>
<li><strong>返回值</strong>：工具的返回值通常是字符串。为什么？因为这个返回值最终是要喂回给大模型的，大模型理解文本能力最强。</li>
<li><strong>Error Handling</strong>：我们在代码中判断了 <code>if(!weather)</code>。在真实开发中，工具内部做好错误处理非常重要，否则一个异常可能导致整个对话崩塌。</li>
</ul>
<hr/>
<h2 data-id="heading-7">四、 链接大脑：绑定工具到模型</h2>
<p>工具定义好了，就像家里买了吸尘器和洗碗机，但如果作为“管家”的大模型不知道它们的存在，也是白搭。我们需要将工具**绑定（Bind）**到模型上。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实例化 DeepSeek 模型</span>
<span class="hljs-keyword">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-string">'deepseek-chat'</span>,
    <span class="hljs-attr">temperature</span>: <span class="hljs-number">0</span> <span class="hljs-comment">// 设置为 0，让模型更理性、逻辑更严密，减少胡言乱语</span>
}).<span class="hljs-title function_">bindTools</span>([addTool, weatherTool]) <span class="hljs-comment">// 核心步骤：绑定工具数组</span>
</code></pre>
<p><strong>解析：</strong></p>
<ul>
<li><strong><code>.bindTools([...])</code></strong>: 这一步发生了很多魔法。LangChain 会自动将我们要定义的 <code>addTool</code> 和 <code>weatherTool</code> 的 <code>name</code>、<code>description</code> 以及 <code>zod schema</code> 转换成 OpenAI 兼容的 JSON 格式，并发送给 DeepSeek 模型。</li>
<li>此时，模型不仅知道“我是谁”，还知道“我手边有两个工具：一个能算加法，一个能查天气”。</li>
</ul>
<hr/>
<h2 data-id="heading-8">五、 触发调用与结果处理（重点：可选链运算符）</h2>
<p>万事俱备，只欠东风。我们向模型提问，看看它如何反应。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 发起提问</span>
<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'北京今天的天气怎么样'</span>);
</code></pre>
<p>当这句话发出去后，DeepSeek 会进行如下思考：</p>
<ol>
<li>用户问的是天气。</li>
<li>我有 <code>get_weather</code> 工具吗？有。</li>
<li>工具描述说它能“查询指定城市天气”。匹配成功！</li>
<li>提取参数：城市是“北京”。</li>
<li><strong>决策</strong>：我不直接回答文本，而是返回一个“工具调用请求（Tool Call）”。</li>
</ol>
<h3 data-id="heading-9">处理响应：可选链运算符 (<code>?.</code>) 的妙用</h3>
<p>模型返回的 <code>res</code> 对象中，包含了很多信息。如果模型决定调用工具，<code>res.tool_calls</code> 属性就会有值。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 可选链运算符 es6 新增 代码的简洁和优雅</span>
<span class="hljs-comment">// 传统写法（繁琐）：</span>
<span class="hljs-comment">// if(res.tool_calls){</span>
<span class="hljs-comment">//     if(res.tool_calls.length){</span>
<span class="hljs-comment">//         // ...</span>
<span class="hljs-comment">//     }</span>
<span class="hljs-comment">// }</span>

<span class="hljs-comment">// 现代写法（推荐）：</span>
<span class="hljs-keyword">if</span>(res.<span class="hljs-property">tool_calls</span>?.<span class="hljs-property">length</span>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"模型决定调用工具:"</span>, res.<span class="hljs-property">tool_calls</span>);
    
    <span class="hljs-comment">// 获取第一个工具调用的指令</span>
    <span class="hljs-keyword">const</span> toolCall = res.<span class="hljs-property">tool_calls</span>[<span class="hljs-number">0</span>];

    <span class="hljs-comment">// 根据工具名称，分发执行逻辑</span>
    <span class="hljs-keyword">if</span>(toolCall.<span class="hljs-property">name</span> === <span class="hljs-string">'add'</span>){
        <span class="hljs-comment">// 执行加法工具</span>
        <span class="hljs-comment">// toolCall.args 包含了模型提取好的参数 {a: ..., b: ...}</span>
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> addTool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"加法工具运行结果:"</span>, result);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(toolCall.<span class="hljs-property">name</span> === <span class="hljs-string">'get_weather'</span>){
        <span class="hljs-comment">// 执行天气工具</span>
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> weatherTool.<span class="hljs-title function_">invoke</span>(toolCall.<span class="hljs-property">args</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"天气工具运行结果:"</span>, result);
    }
}
</code></pre>
<h4 data-id="heading-10">为了直观理解函数打印一下<code>res.tool_calls看看</code>：</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e07553c2cc4d405c9e0210bda1549e62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We56eY55qE54yq5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767369109&amp;x-signature=tnd%2FlLx5RpCjLK3yfnvN4g5saWM%3D" alt="屏幕截图 2025-12-26 234001.png" loading="lazy"/></p>
<blockquote>
<p>你可以直观地看到调用结构：<code>name</code> 和工具定义里的 <code>name</code> 一模一样，而 <code>args</code> 则是大模型在理解用户问题后，根据<code>tool</code>要求的参数格式，自动“填好”的输入内容。</p>
</blockquote>
<p><strong>知识点详解：可选链运算符 (<code>?.</code>)</strong></p>
<p>在 JavaScript 中，处理深层嵌套的对象属性时，经常会遇到 <code>Cannot read property of undefined</code> 的报错。</p>
<ul>
<li><code>res.tool_calls</code> 可能不存在（如果模型认为不需要调用工具，只是普通聊天）。</li>
<li>如果不使用 <code>?.</code>，我们需要写多层 <code>if</code> 判断来确保安全。</li>
<li><strong><code>res.tool_calls?.length</code></strong> 的意思是：如果 <code>res.tool_calls</code> 存在（不为 null 或 undefined），则读取 <code>.length</code>；否则，直接返回 <code>undefined</code>，不会报错。配合 <code>if</code> 语句，<code>undefined</code> 会被视为 false，逻辑非常通顺。</li>
</ul>
<p>这一小小的语法糖，极大地提升了代码的<strong>简洁性</strong>和<strong>优雅度</strong>，是现代 JS 开发的必备技巧。</p>
<hr/>
<h2 data-id="heading-11">六、 完整流程总结</h2>
<p>让我们回顾一下这段代码运行的完整生命周期：</p>
<ol>
<li><strong>定义阶段</strong>：我们用 <code>tool()</code> 和 <code>zod</code> 精确描述了 <code>add</code> 和 <code>get_weather</code> 两个工具的功能和参数格式。</li>
<li><strong>绑定阶段</strong>：通过 <code>.bindTools()</code> 将这些能力的“说明书”发给了 DeepSeek 大模型。</li>
<li><strong>推理阶段</strong>：用户提问“北京天气”，模型分析语义，命中 <code>get_weather</code> 工具，并精准提取出 <code>city: "北京"</code>。</li>
<li><strong>响应阶段</strong>：模型返回包含 <code>tool_calls</code> 的响应对象。</li>
<li><strong>执行阶段</strong>：我们的代码通过 <code>?.</code> 安全地检测到调用请求，并在本地运行了 <code>weatherTool</code> 函数，通过查阅 <code>fakeWeatherDB</code> 得到了结果。</li>
</ol>
<h3 data-id="heading-12">运行效果预览</h3>
<p>当你运行这段代码（<code>node index.js</code>），控制台会输出：</p>
<pre><code class="hljs language-bash" lang="bash">[
  {
    name: <span class="hljs-string">'get_weather'</span>,
    args: { city: <span class="hljs-string">'北京'</span> },
    <span class="hljs-built_in">id</span>: <span class="hljs-string">'call_xxxxxxxxx'</span>
  }
]
最终结果: 当前北京的天气是30°C,晴, 风力微风
</code></pre>
<p>如果你把问题改成 <code>model.invoke('100 加 200 等于几')</code>，它会自动切换逻辑：</p>
<pre><code class="hljs language-bash" lang="bash">[
  {
    name: <span class="hljs-string">'add'</span>,
    args: { a: 100, b: 200 },
    <span class="hljs-built_in">id</span>: <span class="hljs-string">'call_yyyyyyyyy'</span>
  }
]
最终结果: 300
</code></pre>
<hr/>
<h2 data-id="heading-13">七、 结语</h2>
<p>通过这篇文章，我们不仅学习了 LangChain 中 <code>tool</code> 的基础用法，还掌握了如何利用 <code>zod</code> 进行数据验证以及使用 ES6+ 的可选链运算符编写健壮的代码。</p>
<p>Tools 模块彻底改变了大模型的应用形态。它让大模型从一个“只读”的百科全书，进化成了一个能“读写”现实世界的智能代理（Agent）。</p>
<p>赶快打开你的编辑器，试着定义属于你自己的工具吧！不管是查询股票、发送邮件，还是控制智能家居，LangChain 都能帮你实现。</p>
<hr/>
<p><em>本文代码示例基于 LangChain.js 最新版本，欢迎点赞收藏！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++中JSON序列化和反序列化的实现]]></title>    <link>https://juejin.cn/post/7588010346070851594</link>    <guid>https://juejin.cn/post/7588010346070851594</guid>    <pubDate>2025-12-27T01:52:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588010346070851594" data-draft-id="7588010346070835210" data-original-type="2" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++中JSON序列化和反序列化的实现"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-27T01:52:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="charlee44"/> <meta itemprop="url" content="https://juejin.cn/user/1117549770846872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++中JSON序列化和反序列化的实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117549770846872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    charlee44
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T01:52:26.000Z" title="Sat Dec 27 2025 01:52:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言</h2>
<p><strong>序列化</strong>（Serialization）是指将程序中的内存对象（如结构体、类实例、列表等）转换成一种<strong>可以存储或传输的格式</strong>（通常是字节流或文本）的过程。常见的序列化格式包括：</p>
<ul>
<li>JSON（文本，人类可读）</li>
<li>XML</li>
<li>Protocol Buffers（二进制，高效）</li>
<li>MessagePack</li>
<li>YAML</li>
<li>甚至自定义的二进制格式</li>
</ul>
<p><strong>反序列化</strong>（Deserialization）是序列化的逆过程：将<strong>序列化后的数据</strong>（如 JSON 字符串）重新转换回<strong>程序中的内存对象</strong>。</p>
<h2 data-id="heading-1">2. 原因</h2>
<p>那么，为什么需要序列化和反序列化呢？笔者的体会是不序列化/反序列化也行，只不过在进行相应的读取和写入操作的时候会非常繁琐。比如一个配置文件更新：</p>
<p>假设我们有一个博客系统的配置，包含站点标题、作者名、是否启用评论、默认封面地址等多个字段。如果不使用序列化机制，每次读取配置时，就得手动打开 JSON（或 YAML、INI）文件，逐行解析，判断每个字段是否存在、类型是否正确，再一一赋值给程序中的变量；而当用户修改了某个设置、需要保存回文件时，又得手动拼接字符串、处理引号转义、数组格式、缩进对齐……稍有不慎，就会生成格式错误的文件，导致程序下次启动失败。</p>
<p>更麻烦的是，一旦配置结构发生变化——比如新增一个 theme 字段，或者把 enableComments 拆成 enablePostComments 和 enablePageComments——我们就不得不同时修改读取逻辑、写入逻辑、默认值初始化、错误处理等多处代码，极易遗漏或出错。</p>
<p>而有了序列化和反序列化，这一切就变得简洁而可靠：定义好结构体（或类），注册对应的转换函数，一行代码就能从 JSON 构造出完整的配置对象，另一行代码就能把修改后的对象写回文件。字段增减只需调整结构体，读写逻辑几乎无需改动，既减少了重复劳动，也大大提升了健壮性和可维护性。</p>
<p>因此，序列化/反序列化并非“必须”，但它是对抗复杂性、提升开发效率和系统可靠性的重要工具。</p>
<h2 data-id="heading-2">3. 实现</h2>
<h3 data-id="heading-3">3.1 示例</h3>
<p>这里就举例实现一下 C++ 中 JSON 序列化和反序列化。如果要反序列化成 C++ 可以使用的内存对象，最好的数据容器就是 struct 。当然 class 也可以，不过我们都知道 struct 和 class 的区别：struct 的成员一般默认是公有的，而 class 的成员一般默认是私有的。因此，struct 适合以数据成员为主的，比较简单的对象；class 适合以方法成员为主的，比较复杂的对象。</p>
<p>笔者使用 nlohmann/json 中序列化/反序列化一个表达博客的数据对象：</p>
<p><strong>BlogMeta.h</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;nlohmann/json.hpp&gt;</span></span>&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>&#13;
&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"PostStats.h"</span></span>&#13;
&#13;
<span class="hljs-keyword">namespace</span> DataTransfer {&#13;
&#13;
<span class="hljs-comment">/// @brief 一篇博客的元数据</span>&#13;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">BlogMeta</span> {&#13;
  std::string id;&#13;
  std::string title;&#13;
  std::string summary;&#13;
  std::string createdTime;&#13;
  std::string updatedTime;  &#13;
  std::string coverAddress;&#13;
  <span class="hljs-type">int64_t</span> isDraft;&#13;
  std::vector&lt;std::string&gt; tagNames;&#13;
  std::vector&lt;std::string&gt; categoryNames;&#13;
  PostStats postStats;&#13;
&#13;
  <span class="hljs-comment">// 提供序列化接口</span>&#13;
  <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">to_json</span><span class="hljs-params">(nlohmann::json&amp; j, <span class="hljs-type">const</span> BlogMeta&amp; s)</span></span>;&#13;
&#13;
  <span class="hljs-comment">// 提供反序列化接口</span>&#13;
  <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, BlogMeta&amp; s)</span></span>;&#13;
};
</code></pre>
<p><strong>BlogMeta.cpp</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"BlogMeta.h"</span></span>&#13;
&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"Util/GetTime.h"</span></span>&#13;
&#13;
<span class="hljs-keyword">namespace</span> DataTransfer {&#13;
&#13;
<span class="hljs-comment">// 提供序列化接口</span>&#13;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">to_json</span><span class="hljs-params">(nlohmann::json&amp; j, <span class="hljs-type">const</span> BlogMeta&amp; s)</span> </span>{&#13;
  j = nlohmann::json{{<span class="hljs-string">"id"</span>, s.id},&#13;
                     {<span class="hljs-string">"title"</span>, s.title},&#13;
                     {<span class="hljs-string">"summary"</span>, s.summary},&#13;
                     {<span class="hljs-string">"createdTime"</span>, s.createdTime},&#13;
                     {<span class="hljs-string">"updatedTime"</span>, s.updatedTime},&#13;
                     {<span class="hljs-string">"coverAddress"</span>, s.coverAddress},&#13;
                     {<span class="hljs-string">"isDraft"</span>, s.isDraft},&#13;
                     {<span class="hljs-string">"tagNames"</span>, s.tagNames},&#13;
                     {<span class="hljs-string">"categoryNames"</span>, s.categoryNames},&#13;
                     {<span class="hljs-string">"postStats"</span>, s.postStats}};&#13;
}&#13;
&#13;
<span class="hljs-comment">// 提供反序列化接口</span>&#13;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, BlogMeta&amp; s)</span> </span>{&#13;
  s.id = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"id"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
  s.title = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"title"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
  s.summary = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"summary"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
  s.createdTime = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"createdTime"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
  s.updatedTime =&#13;
      j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"updatedTime"</span>, Util::<span class="hljs-built_in">GetCurrentTime</span>());  <span class="hljs-comment">//提供默认值，增加稳定性</span>&#13;
  s.coverAddress = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"coverAddress"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
  s.isDraft = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"isDraft"</span>).<span class="hljs-built_in">get</span>&lt;<span class="hljs-type">int64_t</span>&gt;();&#13;
  s.tagNames = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"tagNames"</span>).get&lt;std::vector&lt;std::string&gt;&gt;();&#13;
  s.categoryNames = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"categoryNames"</span>).get&lt;std::vector&lt;std::string&gt;&gt;();&#13;
  s.postStats = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"postStats"</span>).<span class="hljs-built_in">get</span>&lt;PostStats&gt;();&#13;
}&#13;
&#13;
}  <span class="hljs-comment">// namespace DataTransfer</span>
</code></pre>
<p>其中 <code>to_json</code> / <code>from_json</code> 就是对应的 序列化 / 反序列化接口。只需要填充这一对接口，就可以通过赋值运算符<code>=</code>实现自动序列化和反序列化：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;nlohmann/json.hpp&gt;</span></span>&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"BlogMeta.h"</span>  <span class="hljs-comment">// 包含你的 BlogMeta 定义</span></span>&#13;
&#13;
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{&#13;
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> DataTransfer;&#13;
    <span class="hljs-keyword">using</span> json = nlohmann::json;&#13;
&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    <span class="hljs-comment">// 1. 创建一个 BlogMeta 对象（内存中的数据）</span>&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    BlogMeta blog;&#13;
    blog.id = <span class="hljs-string">"blog-001"</span>;&#13;
    blog.title = <span class="hljs-string">"深入理解 C++ 序列化"</span>;&#13;
    blog.summary = <span class="hljs-string">"本文介绍如何使用 nlohmann/json 进行安全高效的序列化。"</span>;&#13;
    blog.createdTime = <span class="hljs-string">"2025-12-22T10:00:00Z"</span>;&#13;
    blog.updatedTime = <span class="hljs-string">"2025-12-22T17:00:00Z"</span>;  <span class="hljs-comment">// 可省略，反序列化时会用默认值</span>&#13;
    blog.coverAddress = <span class="hljs-string">"/images/cpp_serialization.jpg"</span>;&#13;
    blog.isDraft = <span class="hljs-number">0</span>;&#13;
    blog.tagNames = {<span class="hljs-string">"C++"</span>, <span class="hljs-string">"JSON"</span>, <span class="hljs-string">"Serialization"</span>};&#13;
    blog.categoryNames = {<span class="hljs-string">"Programming"</span>, <span class="hljs-string">"Tutorial"</span>};&#13;
    blog.postStats = {<span class="hljs-number">1200</span>, <span class="hljs-number">85</span>, <span class="hljs-number">23</span>};&#13;
&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    <span class="hljs-comment">// 2. 序列化：BlogMeta → JSON</span>&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    json j = blog;  <span class="hljs-comment">// 自动调用 to_json</span>&#13;
    std::cout &lt;&lt; <span class="hljs-string">"【序列化结果】\n"</span> &lt;&lt; j.<span class="hljs-built_in">dump</span>(<span class="hljs-number">2</span>) &lt;&lt; <span class="hljs-string">"\n\n"</span>;&#13;
&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    <span class="hljs-comment">// 3. 反序列化：JSON → BlogMeta</span>&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    <span class="hljs-comment">// 模拟从文件或网络接收到的 JSON（故意省略 updatedTime）</span>&#13;
    std::string jsonStr = <span class="hljs-string">R"({&#13;
        "id": "blog-002",&#13;
        "title": "反序列化的健壮性测试",&#13;
        "summary": "测试缺失 updatedTime 字段时的行为",&#13;
        "createdTime": "2025-12-20T08:30:00Z",&#13;
        "coverAddress": "/images/robust.png",&#13;
        "isDraft": 1,&#13;
        "tagNames": ["C++", "Robustness"],&#13;
        "categoryNames": ["Engineering"],&#13;
        "postStats": {&#13;
            "viewCount": 450,&#13;
            "likeCount": 30,&#13;
            "commentCount": 5&#13;
        }&#13;
    })"</span>;&#13;
 &#13;
    BlogMeta restoredBlog = json::<span class="hljs-built_in">parse</span>(jsonStr);  <span class="hljs-comment">// 自动调用 from_json</span>&#13;
  &#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    <span class="hljs-comment">// 4. 验证反序列化结果</span>&#13;
    <span class="hljs-comment">// ----------------------------</span>&#13;
    std::cout &lt;&lt; <span class="hljs-string">"【反序列化结果】\n"</span>;&#13;
    std::cout &lt;&lt; <span class="hljs-string">"ID: "</span> &lt;&lt; restoredBlog.id &lt;&lt; <span class="hljs-string">"\n"</span>;&#13;
    std::cout &lt;&lt; <span class="hljs-string">"Title: "</span> &lt;&lt; restoredBlog.title &lt;&lt; <span class="hljs-string">"\n"</span>;&#13;
    std::cout &lt;&lt; <span class="hljs-string">"UpdatedTime (应为当前默认值): "</span> &lt;&lt; restoredBlog.updatedTime &lt;&lt; <span class="hljs-string">"\n"</span>;&#13;
    std::cout &lt;&lt; <span class="hljs-string">"Is Draft: "</span> &lt;&lt; restoredBlog.isDraft &lt;&lt; <span class="hljs-string">"\n"</span>;&#13;
    std::cout &lt;&lt; <span class="hljs-string">"Tags: "</span>;&#13;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">const</span> <span class="hljs-keyword">auto</span>&amp; tag : restoredBlog.tagNames) {&#13;
        std::cout &lt;&lt; tag &lt;&lt; <span class="hljs-string">" "</span>;&#13;
    }&#13;
    std::cout &lt;&lt; <span class="hljs-string">"\n"</span>;&#13;
&#13;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#13;
}
</code></pre>
<h3 data-id="heading-4">3.2 能力</h3>
<p>序列化 / 反序列化的能力取决于所使用的库实现的程度。例如这个例子中，std 容器 <code>std::vector&lt;std::string&gt;</code> 也可以直接使用赋值运算符<code>=</code>来序列化/反序列化吗？确实是可以的，nlohmann/json 支持所有基础类型以及绝大多数 std 容器类型的直接 序列化/ 反序列化。不过默认情况下，C++ 数据类型与JSON的对应关系是：std::string 对应字符串， int64_t， uint64_t 或 double 对应数字， std::map 对应对象， std::vector 对应数组，且 bool 对应布尔值。</p>
<p>另外，nlohmann/json 还支持嵌套序列化。比如这里的 PostStats 其实也是个自定义的 struct ，也实现了 <code>to_json</code> / <code>from_json</code> 接口，因此可以直接通过赋值运算符<code>=</code>相互转换。</p>
<p><strong>PostStats.h</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>&#13;
&#13;
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;nlohmann/json.hpp&gt;</span></span>&#13;
&#13;
<span class="hljs-keyword">namespace</span> DataTransfer {&#13;
&#13;
<span class="hljs-comment">/// @brief 一篇博客的统计信息</span>&#13;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">PostStats</span> {&#13;
  <span class="hljs-type">int64_t</span> viewCount = <span class="hljs-number">0</span>;     <span class="hljs-comment">// 阅读量</span>&#13;
  <span class="hljs-type">int64_t</span> likeCount = <span class="hljs-number">0</span>;     <span class="hljs-comment">// 点赞量</span>&#13;
  <span class="hljs-type">int64_t</span> commentCount = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 评论量</span>&#13;
&#13;
  <span class="hljs-comment">// 提供序列化接口</span>&#13;
  <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">to_json</span><span class="hljs-params">(nlohmann::json&amp; j, <span class="hljs-type">const</span> PostStats&amp; s)</span></span>;&#13;
&#13;
  <span class="hljs-comment">// 提供反序列化接口</span>&#13;
  <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, PostStats&amp; s)</span></span>;&#13;
};&#13;
&#13;
}  <span class="hljs-comment">// namespace DataTransfer</span>
</code></pre>
<p><strong>PostStats.cpp</strong>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"PostStats.h"</span></span>&#13;
&#13;
<span class="hljs-keyword">namespace</span> DataTransfer {&#13;
&#13;
<span class="hljs-comment">// 提供序列化接口</span>&#13;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">to_json</span><span class="hljs-params">(nlohmann::json&amp; j, <span class="hljs-type">const</span> PostStats&amp; s)</span> </span>{&#13;
  j = nlohmann::json{{<span class="hljs-string">"viewCount"</span>, s.viewCount},&#13;
                     {<span class="hljs-string">"likeCount"</span>, s.likeCount},&#13;
                     {<span class="hljs-string">"commentCount"</span>, s.commentCount}};&#13;
}&#13;
&#13;
<span class="hljs-comment">// 提供反序列化接口</span>&#13;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, PostStats&amp; s)</span> </span>{&#13;
  s.viewCount = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"viewCount"</span>).<span class="hljs-built_in">get</span>&lt;<span class="hljs-type">int64_t</span>&gt;();&#13;
  s.likeCount = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"likeCount"</span>).<span class="hljs-built_in">get</span>&lt;<span class="hljs-type">int64_t</span>&gt;();&#13;
  s.commentCount = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"commentCount"</span>).<span class="hljs-built_in">get</span>&lt;<span class="hljs-type">int64_t</span>&gt;();&#13;
}&#13;
&#13;
}  <span class="hljs-comment">// namespace DataTransfer</span>
</code></pre>
<h3 data-id="heading-5">3.3 兼容</h3>
<p>如果 JSON 配置文件进行了升级，比如增加了一个新的配置字段，那么新的程序读取旧的配置文件就有可能出错，所以在反序列化的时候最好使用 value() 提供默认值：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, BlogMeta&amp; s)</span> </span>{&#13;
  s.id = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"id"</span>, std::string{});&#13;
  s.title = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"title"</span>, std::string{});&#13;
  s.summary = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"summary"</span>, std::string{});&#13;
  s.createdTime = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"createdTime"</span>, std::string{});&#13;
  s.updatedTime = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"updatedTime"</span>, std::string{}); <span class="hljs-comment">// 若缺失则为空字符串</span>&#13;
  s.coverAddress = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"coverAddress"</span>, std::string{});&#13;
  s.isDraft = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"isDraft"</span>, <span class="hljs-type">int64_t</span>{<span class="hljs-number">0</span>});&#13;
  s.tagNames = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"tagNames"</span>, std::vector&lt;std::string&gt;{});&#13;
  s.categoryNames = j.<span class="hljs-built_in">value</span>(<span class="hljs-string">"categoryNames"</span>, std::vector&lt;std::string&gt;{});&#13;
&#13;
  <span class="hljs-comment">// 对于嵌套结构如 PostStats，如果它也支持 from_json，可这样处理：</span>&#13;
  <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"postStats"</span>) &amp;&amp; j[<span class="hljs-string">"postStats"</span>].<span class="hljs-built_in">is_object</span>()) {&#13;
    s.postStats = j[<span class="hljs-string">"postStats"</span>].<span class="hljs-built_in">get</span>&lt;PostStats&gt;();&#13;
  } <span class="hljs-keyword">else</span> {&#13;
    s.postStats = PostStats{}; <span class="hljs-comment">// 默认构造</span>&#13;
  }&#13;
}
</code></pre>
<p>另外，如果业务逻辑允许，能分清楚哪些是必须字段，哪些是可选字段，那么可以使用<code>std::optional</code>:</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">/// @brief 一篇博客的元数据（健壮版，支持可选字段）</span>&#13;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">BlogMeta</span> {&#13;
    std::string id;                          <span class="hljs-comment">// 必填</span>&#13;
    std::string title;                       <span class="hljs-comment">// 必填</span>&#13;
    std::optional&lt;std::string&gt; summary;&#13;
    std::string createdTime;                 <span class="hljs-comment">// 通常必填，也可改为 optional</span>&#13;
    std::optional&lt;std::string&gt; updatedTime;  &#13;
    std::optional&lt;std::string&gt; coverAddress;&#13;
    std::optional&lt;<span class="hljs-type">int64_t</span>&gt; isDraft;          <span class="hljs-comment">// 可选，默认 false 或 0</span>&#13;
    std::optional&lt;std::vector&lt;std::string&gt;&gt; tagNames;&#13;
    std::optional&lt;std::vector&lt;std::string&gt;&gt; categoryNames;&#13;
    std::optional&lt;PostStats&gt; postStats;&#13;
&#13;
    <span class="hljs-comment">// 序列化/反序列化友元声明</span>&#13;
    <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">to_json</span><span class="hljs-params">(nlohmann::json&amp; j, <span class="hljs-type">const</span> BlogMeta&amp; s)</span></span>;&#13;
    <span class="hljs-function"><span class="hljs-keyword">friend</span> <span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, BlogMeta&amp; s)</span></span>;&#13;
};&#13;
&#13;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">to_json</span><span class="hljs-params">(nlohmann::json&amp; j, <span class="hljs-type">const</span> BlogMeta&amp; s)</span> </span>{&#13;
    j = nlohmann::json{&#13;
        {<span class="hljs-string">"id"</span>, s.id},&#13;
        {<span class="hljs-string">"title"</span>, s.title},&#13;
        {<span class="hljs-string">"summary"</span>, s.summary},&#13;
        {<span class="hljs-string">"createdTime"</span>, s.createdTime},&#13;
        {<span class="hljs-string">"updatedTime"</span>, s.updatedTime},&#13;
        {<span class="hljs-string">"coverAddress"</span>, s.coverAddress},&#13;
        {<span class="hljs-string">"isDraft"</span>, s.isDraft},&#13;
        {<span class="hljs-string">"tagNames"</span>, s.tagNames},&#13;
        {<span class="hljs-string">"categoryNames"</span>, s.categoryNames},&#13;
        {<span class="hljs-string">"postStats"</span>, s.postStats}&#13;
    };&#13;
}&#13;
&#13;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">from_json</span><span class="hljs-params">(<span class="hljs-type">const</span> nlohmann::json&amp; j, BlogMeta&amp; s)</span> </span>{&#13;
    <span class="hljs-comment">// 必填字段：使用 at()，缺失时报错</span>&#13;
    s.id = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"id"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
    s.title = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"title"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
    s.createdTime = j.<span class="hljs-built_in">at</span>(<span class="hljs-string">"createdTime"</span>).<span class="hljs-built_in">get</span>&lt;std::string&gt;(); <span class="hljs-comment">// 若你也想让它可选，改用 value 或 optional</span>&#13;
&#13;
    <span class="hljs-comment">// 可选字段：直接赋值，nlohmann 自动处理存在性</span>&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"summary"</span>))       s.summary = j[<span class="hljs-string">"summary"</span>].<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"updatedTime"</span>))   s.updatedTime = j[<span class="hljs-string">"updatedTime"</span>].<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"coverAddress"</span>))  s.coverAddress = j[<span class="hljs-string">"coverAddress"</span>].<span class="hljs-built_in">get</span>&lt;std::string&gt;();&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"isDraft"</span>))       s.isDraft = j[<span class="hljs-string">"isDraft"</span>].<span class="hljs-built_in">get</span>&lt;<span class="hljs-type">int64_t</span>&gt;();&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"tagNames"</span>))      s.tagNames = j[<span class="hljs-string">"tagNames"</span>].get&lt;std::vector&lt;std::string&gt;&gt;();&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"categoryNames"</span>)) s.categoryNames = j[<span class="hljs-string">"categoryNames"</span>].get&lt;std::vector&lt;std::string&gt;&gt;();&#13;
    <span class="hljs-keyword">if</span> (j.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"postStats"</span>))     s.postStats = j[<span class="hljs-string">"postStats"</span>].<span class="hljs-built_in">get</span>&lt;PostStats&gt;();&#13;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Tailwind CSS：原子化 CSS 的现代开发实践]]></title>    <link>https://juejin.cn/post/7588028859540570138</link>    <guid>https://juejin.cn/post/7588028859540570138</guid>    <pubDate>2025-12-26T16:26:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588028859540570138" data-draft-id="7588010346070605834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Tailwind CSS：原子化 CSS 的现代开发实践"/> <meta itemprop="keywords" content="前端,CSS,JavaScript"/> <meta itemprop="datePublished" content="2025-12-26T16:26:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tzarevich"/> <meta itemprop="url" content="https://juejin.cn/user/578786070367529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Tailwind CSS：原子化 CSS 的现代开发实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578786070367529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tzarevich
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T16:26:13.000Z" title="Fri Dec 26 2025 16:26:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">Tailwind CSS：原子化 CSS 的现代开发实践</h2>
<p>在当今快速迭代的前端开发环境中，如何高效、一致且可维护地构建用户界面，成为每个团队必须面对的核心问题。传统 CSS 的命名困境、样式冗余和复用难题，催生了一种新的解决方案——<strong>原子化 CSS</strong>（Atomic CSS）。而 <strong>Tailwind CSS</strong>，正是这一理念最成功的实践者。本文将结合实际代码与开发场景，深入解析 Tailwind CSS 的核心思想、优势及最佳实践。</p>
<hr/>
<h3 data-id="heading-1">一、什么是原子化 CSS？</h3>
<p>传统 CSS 倾向于“语义化命名”：我们为组件起一个名字（如 <code>.card-title</code>），然后为其编写样式。这种方式常被称为“面向对象 CSS”（OOCSS），它试图通过<strong>封装基类、组合多态</strong>来提升复用性。例如：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.btn</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">16px</span>; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>; }
<span class="hljs-selector-class">.btn-primary</span> { <span class="hljs-attribute">background</span>: skyblue; <span class="hljs-attribute">color</span>: white; }
</code></pre>
<p>但实践中，<strong>样式往往带有太多业务属性</strong>，导致在一个或少数类名下，样式几乎无法跨项目复用，最终演变为“一次性 CSS”。</p>
<p><strong>原子化 CSS 则反其道而行之</strong>：它将样式拆解为最小、单一职责的“原子类”，每个类只控制一个具体的样式属性。例如：</p>
<ul>
<li><code>p-4</code> → <code>padding: 1rem</code></li>
<li><code>bg-blue-500</code> → <code>background-color: #3b82f6</code></li>
<li><code>text-center</code> → <code>text-align: center</code></li>
</ul>
<p>这些类名直接描述<strong>样式本身</strong>，而非内容语义。通过组合这些原子类，我们可以在 HTML 中直接构建 UI，无需离开模板文件。</p>
<blockquote>
<p>将我们的 CSS 规则拆分成原子 CSS，会有大量的基类，好复用、好维护，不会重复。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、Tailwind CSS：原子化理念的集大成者</h3>
<p>Tailwind CSS 是一个功能优先（Utility-First）的 CSS 框架，它不提供预设组件（如 Bootstrap 的 <code>.btn</code>），而是提供一套完整的工具类系统。</p>
<h4 data-id="heading-3">示例：构建一个按钮</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;button <span class="hljs-attr">className</span>=<span class="hljs-string">"px-4 py-2 bg-[skyblue] text-white rounded-lg hover:bg-blue-200"</span>&gt;
  提交
&lt;/button&gt;
</code></pre>
<ul>
<li><code>px-4 py-2</code>：设置内边距，表示水平方向内边距1rem，垂直方向内边距0.5rem；</li>
<li><code>bg-[skyblue]</code>：背景色；</li>
<li><code>rounded-lg</code>：圆角，lg为large大号圆角（0.5rem = 8px）；</li>
<li><code>hover:bg-blue-200</code>：悬停效果，鼠标悬停时背景色变为蓝色系200深度颜色，hover为悬停伪类前缀。</li>
</ul>
<p>所有样式一目了然，无需查阅 CSS 文件。</p>
<h4 data-id="heading-4">🤖 LLM 时代的理想搭档</h4>
<p>随着大语言模型（LLM）的普及，<strong>用自然语言生成 UI 代码</strong>成为可能。而 Tailwind 的类名具有高度<strong>语义化、结构化、可预测</strong>的特点：</p>
<ul>
<li>开发者只需描述：“一个带圆角、蓝色背景、白色文字的按钮”</li>
<li>LLM 即可输出：<code>&lt;button class="px-4 py-2 bg-blue-500 text-white rounded"&gt;</code></li>
</ul>
<p>相比之下，传统 CSS 需要模型同时生成 HTML 和 CSS，并保证类名匹配，难度更高。<strong>Tailwind 让“Prompt → UI” 的路径更短、更可靠</strong>。</p>
<hr/>
<h3 data-id="heading-5">三、快速上手：基于 Vite 的项目配置</h3>
<p>要在项目中使用 Tailwind，只需几步：</p>
<ol>
<li>
<p>创建 Vite 项目：</p>
<pre><code class="hljs language-csharp" lang="csharp">npm <span class="hljs-keyword">init</span> vite
</code></pre>
</li>
<li>
<p>安装 Tailwind 及官方 Vite 插件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">npm install -D tailwindcss <span class="hljs-meta">@tailwindcss</span>/vite
npx tailwindcss <span class="hljs-keyword">init</span>
</code></pre>
</li>
<li>
<p>配置 <code>vite.config.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> tailwindcss <span class="hljs-keyword">from</span> <span class="hljs-string">'@tailwindcss/vite'</span> <span class="hljs-comment">// tailwind插件</span>
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span> <span class="hljs-comment">// react插件</span>

<span class="hljs-comment">// https://vite.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
<span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">react</span>(), <span class="hljs-title function_">tailwindcss</span>()],
})
</code></pre>
</li>
<li>
<p>在入口 CSS 文件（如 <code>index.css</code>）中引入：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@import</span> <span class="hljs-string">"tailwindcss"</span>;
</code></pre>
</li>
</ol>
<p>至此，所有原子类即可在 JSX/HTML 中直接使用，<strong>几乎无需再手写 CSS</strong>。</p>
<h3 data-id="heading-6">四、性能与工程化：DocumentFragment 与 React Fragment</h3>
<p>高效的 UI 不仅关乎视觉，也涉及性能。在动态渲染大量 DOM 节点时，<strong>减少重排/重绘</strong>至关重要。</p>
<h4 data-id="heading-7">原生优化：DocumentFragment</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">fragment</span> = document.createDocumentFragment()<span class="hljs-comment">;</span>
fragment.appendChild(p1)<span class="hljs-comment">;</span>
fragment.appendChild(p2)<span class="hljs-comment">;</span>
container.appendChild(fragment)<span class="hljs-comment">; // 仅触发一次 DOM 更新</span>
</code></pre>
<p>通过 <code>DocumentFragment</code>，我们将多个节点在内存中组装后一次性插入，显著提升性能。</p>
<h4 data-id="heading-8">React 场景：Fragment 解决单根限制</h4>
<p>React 要求组件返回单一根节点。若需返回多个同级元素，传统做法是包裹一个无意义的 <code>&lt;div&gt;</code>，但这会污染 DOM 结构。</p>
<p>Tailwind + React 的最佳实践是使用 <strong>Fragment</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>111<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>222<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ArticleCard</span> /&gt;</span> {/* 自定义卡片组件 */}
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<p><code>&lt;&gt;...&lt;/&gt;</code>（即 <code>&lt;React.Fragment&gt;</code>）允许我们返回多个元素，<strong>不产生额外 DOM 节点</strong>，保持结构纯净，同时也便于一次性插入整个 UI 片段，提升渲染性能。</p>
<h3 data-id="heading-9">五、响应式设计：Mobile First 的优雅实现</h3>
<p>Tailwind 内置响应式前缀，完美支持“移动端优先”开发策略。</p>
<h4 data-id="heading-10">基础布局（移动端垂直堆叠）：</h4>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> className="<span class="hljs-attribute">flex</span> <span class="hljs-attribute">flex</span>-col <span class="hljs-attribute">gap</span>-<span class="hljs-number">4</span>"&gt;
  &lt;<span class="hljs-selector-tag">main</span> className="bg-blue-<span class="hljs-number">100</span> <span class="hljs-selector-tag">p</span>-<span class="hljs-number">4</span>"&gt;主内容&lt;/<span class="hljs-selector-tag">main</span>&gt;
  &lt;<span class="hljs-selector-tag">aside</span> className="bg-green-<span class="hljs-number">100</span> <span class="hljs-selector-tag">p</span>-<span class="hljs-number">4</span>"&gt;侧边栏&lt;/<span class="hljs-selector-tag">aside</span>&gt;
&lt;/<span class="hljs-selector-tag">div</span>&gt;
</code></pre>
<h4 data-id="heading-11">增强至桌面端（水平排列）：</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"flex flex-col md:flex-row gap-4"</span>&gt;
  &lt;main <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-blue-100 p-4 md:w-2/3"</span>&gt;主内容&lt;/main&gt;
  &lt;aside <span class="hljs-attr">className</span>=<span class="hljs-string">"bg-green-100 p-4 md:w-1/3"</span>&gt;侧边栏&lt;/aside&gt;
&lt;/div&gt;
</code></pre>
<ul>
<li>小屏：<code>flex-col</code>（垂直）</li>
<li>中屏及以上：<code>md:flex-row</code>（水平）</li>
</ul>
<p>这种“渐进增强”的方式，确保了在所有设备上都有良好体验。</p>
<h3 data-id="heading-12">六、为什么选择 Tailwind？</h3>
<ol>
<li><strong>开发效率高</strong>：样式即代码，无需上下文切换；</li>
<li><strong>设计一致性</strong>：基于预设的设计系统（间距、颜色、字体等）；</li>
<li><strong>高度可定制</strong>：通过 <code>tailwind.config.js</code> 扩展主题、断点、插件；</li>
<li><strong>极致性能</strong>：JIT 模式仅生成用到的 CSS，体积极小；</li>
<li><strong>未来友好</strong>：与 React、Vue、Svelte 等现代框架无缝集成；</li>
<li><strong>AI 友好</strong>：类名结构清晰，易于 LLM 理解与生成。</li>
</ol>
<h3 data-id="heading-13">七、结语</h3>
<p>Tailwind CSS 不仅仅是一个 CSS 框架，更是一种<strong>UI 开发哲学</strong>。它通过原子化、功能优先的设计，将 CSS 从“命名的艺术”转变为“组合的科学”。正如我们在文章中所见，无论是简单的按钮、复杂的卡片，还是响应式布局，Tailwind 都能以简洁、直观的方式实现。</p>
<p>更重要的是，在 AI 编程时代，Tailwind 的<strong>结构化、语义化类名</strong>使其成为自然语言生成 UI 的理想载体。对于追求效率、一致性和可维护性的现代前端团队而言，Tailwind CSS 无疑是值得拥抱的利器。</p>
<blockquote>
<p><strong>“不用离开 HTML 写 CSS 了，所有的样式都在类名中。”</strong><br/>
—— 这或许是对 Tailwind 最精炼的赞美。</p>
</blockquote>
<p><strong>参考资料</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwindcss.com%2F" target="_blank" title="https://tailwindcss.com/" ref="nofollow noopener noreferrer">Tailwind CSS 官方文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor Visual Editor：前端样式调试的新利器]]></title>    <link>https://juejin.cn/post/7587776610436759567</link>    <guid>https://juejin.cn/post/7587776610436759567</guid>    <pubDate>2025-12-26T19:05:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587776610436759567" data-draft-id="7587965800273018906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor Visual Editor：前端样式调试的新利器"/> <meta itemprop="keywords" content="CSS,前端"/> <meta itemprop="datePublished" content="2025-12-26T19:05:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="bytemanx"/> <meta itemprop="url" content="https://juejin.cn/user/4059855780846936"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor Visual Editor：前端样式调试的新利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059855780846936/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    bytemanx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T19:05:37.000Z" title="Fri Dec 26 2025 19:05:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为前端开发者，你一定经历过这样的场景：为了调整一个渐变的角度、修改一个元素的行高，反复在代码和浏览器之间切换，改一行代码、保存、刷新、看效果、再改……</p>
<p>这种"盲调"的方式效率低下，尤其是在调试 CSS 动画这类需要精细控制的效果时，更是让人抓狂。</p>
<p>好消息是，Cursor 2.2 带来了一个令人兴奋的新功能——<strong>Visual Editor</strong>。它将你的 Web 应用、代码库和可视化编辑工具整合到同一个窗口中，让界面调试变得前所未有的直观。</p>
<p>今天，我们就通过两个炫酷的 CSS 动画案例，来体验一下这个可视化编辑器的强大之处。</p>
<h2 data-id="heading-0">认识 Visual Editor</h2>
<p>首先，在 Cursor 中选择 <strong>Open Browser</strong> 即可打开内置浏览器小窗口：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8fe3aa43615414884e06d5701fefb77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnl0ZW1hbng=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767380736&amp;x-signature=TfRYZrS8h1bY%2BLt2D42hgaG7Jg8%3D" alt="20251227024633_rec_-convert.gif" loading="lazy"/></p>
<p>根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcursor.com%2Fblog%2Fbrowser-visual-editor" target="_blank" title="https://cursor.com/blog/browser-visual-editor" ref="nofollow noopener noreferrer">Cursor 官方博客</a> 的介绍，Visual Editor 提供了四大核心能力：</p>
<h3 data-id="heading-1">1. 拖拽重排（Drag-and-drop）</h3>
<p>直接在渲染好的页面上拖动元素，调整布局结构。你可以交换按钮顺序、旋转区块位置、测试不同的网格配置——所有操作都不需要切换上下文。当视觉设计符合预期后，让 Agent 帮你更新底层代码。</p>
<h3 data-id="heading-2">2. 组件状态测试（Test component states）</h3>
<p>对于 React 应用，Visual Editor 可以在侧边栏直接显示组件的 props，让你方便地切换不同的组件状态变体。</p>
<h3 data-id="heading-3">3. 属性可视化调整（Visual controls）</h3>
<p>这是最实用的功能之一。侧边栏提供了滑块、颜色选择器等可视化控件，支持实时预览。你可以精确调整颜色、布局、字体等属性，所有改动即时生效。</p>
<h3 data-id="heading-4">4. 点击 + 提示（Point and prompt）</h3>
<p>选中界面上的任意元素，用自然语言描述你想要的修改。比如点击一个元素说"把这个变大"，点击另一个说"改成红色"——多个 Agent 会并行执行，几秒钟内完成修改。</p>
<h2 data-id="heading-5">实战案例一：渐变流动文字</h2>
<p>让我们用一个渐变流动文字效果来体验 Visual Editor 的威力。</p>
<h3 data-id="heading-6">效果展示</h3>
<p>先来看看最终效果：</p>
<p><span href="https://code.juejin.cn/pen/7588133688486232127" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7588133688486232127" data-src="https://code.juejin.cn/pen/7588133688486232127" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h3 data-id="heading-7">可视化调试体验</h3>
<p>在 Visual Editor 中打开这个页面后，点击文字元素即可选中它：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/764c21244f964632ab6c16263165f8bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnl0ZW1hbng=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767380736&amp;x-signature=ifpwCZInj8bCEFE%2B9gFvReR307c%3D" alt="image.png" loading="lazy"/></p>
<p>选中后，侧边栏会显示该元素的所有可调整属性。比如我们想调整渐变的角度，只需要拖动滑块即可实时预览效果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40049c2c425c4c81bef5e64823cff4fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnl0ZW1hbng=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767380736&amp;x-signature=w2evS5dDaJOhHlwNXXonVGHkOfU%3D" alt="20251226200440_rec_.gif" loading="lazy"/></p>
<p>想象一下，如果用传统方式调试这个角度参数：修改代码 → 保存 → 等待热更新 → 查看效果 → 不满意再改……而现在只需要拖动滑块，所见即所得！</p>
<h3 data-id="heading-8">核心原理</h3>
<p>这个渐变流动效果的实现原理其实很简单，核心代码如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.text</span> {
    <span class="hljs-comment">/* 多色线性渐变 */</span>
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(
        <span class="hljs-number">90deg</span>,
        <span class="hljs-built_in">rgba</span>(<span class="hljs-number">48</span>, <span class="hljs-number">207</span>, <span class="hljs-number">208</span>, <span class="hljs-number">1</span>) <span class="hljs-number">0%</span>,
        <span class="hljs-built_in">rgba</span>(<span class="hljs-number">102</span>, <span class="hljs-number">166</span>, <span class="hljs-number">255</span>, <span class="hljs-number">1</span>) <span class="hljs-number">22%</span>,
        <span class="hljs-built_in">rgba</span>(<span class="hljs-number">136</span>, <span class="hljs-number">136</span>, <span class="hljs-number">136</span>, <span class="hljs-number">1</span>) <span class="hljs-number">40%</span>,
        <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">154</span>, <span class="hljs-number">139</span>, <span class="hljs-number">1</span>) <span class="hljs-number">60%</span>,
        <span class="hljs-built_in">rgba</span>(<span class="hljs-number">51</span>, <span class="hljs-number">8</span>, <span class="hljs-number">103</span>, <span class="hljs-number">1</span>) <span class="hljs-number">81%</span>,
        <span class="hljs-built_in">rgba</span>(<span class="hljs-number">48</span>, <span class="hljs-number">207</span>, <span class="hljs-number">208</span>, <span class="hljs-number">1</span>) <span class="hljs-number">100%</span>
    );
    <span class="hljs-comment">/* 背景宽度设为元素的 2 倍 */</span>
    <span class="hljs-attribute">background-size</span>: <span class="hljs-number">200%</span> auto;
    <span class="hljs-comment">/* 将背景裁剪到文字形状 */</span>
    -webkit-<span class="hljs-attribute">background-clip</span>: text;
    <span class="hljs-attribute">background-clip</span>: text;
    <span class="hljs-comment">/* 文字颜色透明，露出背景 */</span>
    <span class="hljs-attribute">color</span>: transparent;
    <span class="hljs-comment">/* 应用流动动画 */</span>
    <span class="hljs-attribute">animation</span>: gradient-flow <span class="hljs-number">3s</span> linear infinite;
}

<span class="hljs-keyword">@keyframes</span> gradient-flow {
    <span class="hljs-number">0%</span> {
        <span class="hljs-attribute">background-position</span>: <span class="hljs-number">0%</span> center;
    }
    <span class="hljs-number">100%</span> {
        <span class="hljs-attribute">background-position</span>: <span class="hljs-number">200%</span> center;
    }
}
</code></pre>
<p>原理解析：</p>
<ol>
<li><strong><code>linear-gradient</code></strong>：创建一个多色渐变背景，首尾颜色相同以实现无缝循环</li>
<li><strong><code>background-size: 200%</code></strong>：让背景宽度是元素的两倍，为动画提供移动空间</li>
<li><strong><code>background-clip: text</code></strong>：将背景裁剪到文字轮廓内</li>
<li><strong><code>animation</code></strong>：通过改变 <code>background-position</code> 从 0% 到 200%，让渐变"流动"起来</li>
</ol>
<h2 data-id="heading-9">实战案例二：立体透视文字</h2>
<p>接下来看一个更有意思的效果——立体透视文字。</p>
<h3 data-id="heading-10">效果展示</h3>
<p><span href="https://code.juejin.cn/pen/7588238924326109184" class="code-editor-container"><iframe class="code-editor-frame" data-code="code-editor-element" data-code-id="7588238924326109184" data-src="https://code.juejin.cn/pen/7588238924326109184" style="display:none;" loading="lazy"/><span class="loading-placeholder" style="display:none"><img class="placeholder-image" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8CAYAAAA6/NlyAAAAJElEQVRoge3BMQEAAADCoPVP7WkJoAAAAAAAAAAAAAAAAAAAbjh8AAFte11jAAAAAElFTkSuQmCC" loading="lazy"/><span class="loading-logo"/></span></span></p>
<h3 data-id="heading-11">可视化调试体验</h3>
<p>这个效果的视觉呈现高度依赖于 <code>line-height</code> 和 <code>clip-height</code> 等参数的精确配合。使用 Visual Editor，我们可以直观地调整这些数值：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52df46b595cf435db7805eb03081a854~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYnl0ZW1hbng=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767380736&amp;x-signature=zn7%2FWPk7LdDgZ%2F4SrAJsuigbrOo%3D" alt="20251227021832_rec_-convert.gif" loading="lazy"/></p>
<p>通过可视化调整，你可以直观地看到参数变化对立体效果的影响，快速找到最佳的视觉平衡点。</p>
<h3 data-id="heading-12">核心原理</h3>
<p>这个立体透视效果的核心在于 CSS 变换的巧妙组合：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
    <span class="hljs-attr">--clip-height</span>: <span class="hljs-number">90px</span>;
    <span class="hljs-attr">--line-height</span>: <span class="hljs-number">85px</span>;
    <span class="hljs-attr">--left-offset</span>: <span class="hljs-number">50px</span>;
}

<span class="hljs-selector-class">.Words-line</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-built_in">var</span>(--clip-height);
    <span class="hljs-attribute">overflow</span>: hidden;
    <span class="hljs-attribute">position</span>: relative;
}

<span class="hljs-comment">/* 奇数行：倾斜 + 压缩 */</span>
<span class="hljs-selector-class">.Words-line</span><span class="hljs-selector-pseudo">:nth-child</span>(odd) {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">skew</span>(<span class="hljs-number">60deg</span>, -<span class="hljs-number">30deg</span>) <span class="hljs-built_in">scaleY</span>(<span class="hljs-number">0.66667</span>);
}

<span class="hljs-comment">/* 偶数行：倾斜 + 拉伸 */</span>
<span class="hljs-selector-class">.Words-line</span><span class="hljs-selector-pseudo">:nth-child</span>(even) {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">skew</span>(<span class="hljs-number">0deg</span>, -<span class="hljs-number">30deg</span>) <span class="hljs-built_in">scaleY</span>(<span class="hljs-number">1.33333</span>);
}

<span class="hljs-comment">/* 每行递增的左偏移，形成阶梯效果 */</span>
<span class="hljs-selector-class">.Words-line</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) { <span class="hljs-attribute">left</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--left-offset) * <span class="hljs-number">1</span>); }
<span class="hljs-selector-class">.Words-line</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) { <span class="hljs-attribute">left</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--left-offset) * <span class="hljs-number">2</span>); }
<span class="hljs-selector-class">.Words-line</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">3</span>) { <span class="hljs-attribute">left</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--left-offset) * <span class="hljs-number">3</span>); }
<span class="hljs-comment">/* ... */</span>
</code></pre>
<p>原理解析：</p>
<ol>
<li><strong><code>skew()</code> 倾斜变换</strong>：通过不同的倾斜角度，让奇偶行形成视觉上的"折叠"效果</li>
<li><strong><code>scaleY()</code> 垂直缩放</strong>：奇数行压缩（0.66667），偶数行拉伸（1.33333），配合倾斜创造 3D 透视错觉</li>
<li><strong>递增的 <code>left</code> 偏移</strong>：每行向右偏移，形成阶梯状的立体层次</li>
<li><strong><code>overflow: hidden</code></strong>：裁剪超出的内容，确保每行只显示固定高度</li>
</ol>
<p>hover 时的文字切换动画则通过 <code>translate3d</code> 实现：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">p</span> {
    <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.4s</span> ease-in-out;
}

<span class="hljs-selector-class">.Words</span><span class="hljs-selector-pseudo">:hover</span> <span class="hljs-selector-tag">p</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate3d</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--clip-height) * -<span class="hljs-number">1</span>), <span class="hljs-number">0</span>);
}
</code></pre>
<h2 data-id="heading-13">总结</h2>
<p>Cursor Visual Editor 的出现，真正实现了"设计即代码"的理念：</p>
<ul>
<li><strong>所见即所得</strong>：告别反复保存刷新的低效循环，样式调整即时生效</li>
<li><strong>降低心智负担</strong>：不再需要脑补参数变化的效果，可视化控件让调试更直观</li>
<li><strong>设计与代码统一</strong>：在同一窗口完成视觉调整和代码修改，无缝衔接</li>
</ul>
<p>这个功能特别适合以下场景：</p>
<ol>
<li><strong>样式微调</strong>：颜色、间距、字体大小等参数的精细调整</li>
<li><strong>布局实验</strong>：快速测试不同的布局方案</li>
<li><strong>动画调试</strong>：实时预览动画参数的变化效果</li>
</ol>
<p>正如 Cursor 官方所说，他们看到了一个未来：Agent 与 Web 应用开发深度融合，人们通过更直观的界面将想法转化为代码。Visual Editor 正是朝着这个方向迈出的重要一步。</p>
<p>如果你还没有尝试过这个功能，强烈建议打开 Cursor，用你自己的项目体验一下——相信你会爱上这种"所见即所得"的开发方式！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 有哪些数据类型？它们在内存里是怎么存的？]]></title>    <link>https://juejin.cn/post/7588007285547073542</link>    <guid>https://juejin.cn/post/7588007285547073542</guid>    <pubDate>2025-12-27T01:45:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588007285547073542" data-draft-id="7579127397498060851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 有哪些数据类型？它们在内存里是怎么存的？"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-27T01:45:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 有哪些数据类型？它们在内存里是怎么存的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T01:45:29.000Z" title="Sat Dec 27 2025 01:45:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有时候对 <code>JavaScript</code> 的代码很是疑惑，我写过这样一段代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> user1 = { <span class="hljs-attr">name</span>: <span class="hljs-string">'小明'</span> };
<span class="hljs-keyword">let</span> user2 = user1;
user2.<span class="hljs-property">name</span> = <span class="hljs-string">'小红'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user1.<span class="hljs-property">name</span>); <span class="hljs-comment">// 结果居然是 “小红”？</span>
</code></pre>
<p>我当时愣住了：我只是改了 <code>user2</code>，为什么 <code>user1</code> 也跟着变了？<br/>
而换成数字时，却完全不是这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> a = <span class="hljs-number">10</span>;
<span class="hljs-keyword">let</span> b = a;
b = <span class="hljs-number">20</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 还是 10，没变</span>
</code></pre>
<p>明明都是赋值，行为怎么差这么多？</p>
<p>后来我才明白，问题的关键并不是代码的写法问题，而是在 <strong>JavaScript 的数据类型和它们在内存中的存储方式</strong>。</p>
<p>搞懂这一点，很多看似奇怪的行为就都顺理成章了。</p>
<hr/>
<h2 data-id="heading-0">一、JavaScript 有几种数据类型？</h2>
<p>根据 ECMAScript 标准，JavaScript 的数据类型分为两大类：</p>
<h3 data-id="heading-1">1. 原始类型——共 7 种</h3>
<p>这些类型的特点是：<strong>值不可变、直接表示数据本身</strong>。</p>













































<table><thead><tr><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td><code>number</code></td><td><code>42</code>, <code>3.14</code>, <code>NaN</code></td><td>所有数字，包括整数、浮点数、特殊值</td></tr><tr><td><code>string</code></td><td><code>'hello'</code>, <code>"JS"</code></td><td>字符串，不可变</td></tr><tr><td><code>boolean</code></td><td><code>true</code>, <code>false</code></td><td>布尔值</td></tr><tr><td><code>undefined</code></td><td><code>let a; console.log(a);</code></td><td>变量已声明但未赋值</td></tr><tr><td><code>null</code></td><td><code>let b = null;</code></td><td>表示空或无值（注意：它是原始类型！）</td></tr><tr><td><code>symbol</code></td><td><code>Symbol('id')</code></td><td>ES6 引入，唯一且不可变的标识符</td></tr><tr><td><code>bigint</code></td><td><code>123n</code>, <code>9007199254740991n</code></td><td>ES2020 引入，用于表示任意大的整数</td></tr></tbody></table>
<p><code>typeof null</code> 返回 <code>"object"</code> 是 JavaScript 的一个历史性 bug，至今未修复。但从语言设计上，<code>null</code> 属于原始类型。</p>
<hr/>
<h3 data-id="heading-2">2. 引用类型——统称对象</h3>
<p>除了上述 7 种，<strong>其他所有值都是对象</strong>，属于引用类型，包括：</p>
<ul>
<li>普通对象：<code>{ name: 'Tom' }</code></li>
<li>数组：<code>[1, 2, 3]</code></li>
<li>函数：<code>function() {}</code></li>
<li>日期：<code>new Date()</code></li>
<li>正则：<code>/abc/</code></li>
<li>甚至 <code>Map</code>、<code>Set</code>、<code>Promise</code> 等</li>
</ul>
<p>引用类型的核心特点是：<strong>可变、通过引用来访问实际数据</strong>。</p>
<hr/>
<h2 data-id="heading-3">二、它们在内存中怎么存储？</h2>
<p>这是理解一切行为差异的根源！</p>
<p>计算机内存大致分为两个区域：</p>
<ul>
<li><strong>栈（Stack）</strong>：速度快，空间小，用于存储简单、固定大小的数据。</li>
<li><strong>堆（Heap）</strong>：空间大，速度稍慢，用于存储复杂、动态大小的数据。</li>
</ul>
<h3 data-id="heading-4">原始类型：直接存在栈里</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> age = <span class="hljs-number">25</span>;
<span class="hljs-keyword">let</span> isStudent = <span class="hljs-literal">true</span>;
</code></pre>
<p>这两个变量就像两个小抽屉，<strong>值本身直接放在栈中</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">栈（Stack）</span>
<span class="hljs-string">┌─────────────────┐</span>
<span class="hljs-string">│</span> <span class="hljs-attr">age:</span> <span class="hljs-number">25</span>         <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-attr">isStudent:</span> <span class="hljs-literal">true</span> <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────┘</span>
</code></pre>
<p>当你复制一个原始值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> myAge = age; <span class="hljs-comment">// 把 25 复制一份</span>
myAge = <span class="hljs-number">30</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(age); <span class="hljs-comment">// 仍然是 25</span>
</code></pre>
<p>因为 <code>myAge</code> 拿到的是 <strong>全新的副本</strong>，和 <code>age</code> 完全无关。</p>
<p>所以原始类型是按值进行传递（Pass by Value）。</p>
<hr/>
<h3 data-id="heading-5">引用类型：栈存地址，堆存真实对象</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> user = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> };
</code></pre>
<p>这时发生了两件事：</p>
<ol>
<li>对象 <code>{ name: 'Alice', age: 25 }</code> 被创建，存放在堆中。</li>
<li>变量 <code>user</code> 并不直接包含这个对象，而是保存一个指向堆中对象的引用地址，这个地址放在栈里。</li>
</ol>
<p>图示如下：</p>
<pre><code class="hljs language-css" lang="css">栈（Stack）              堆（Heap）
┌──────────────┐      ┌──────────────────────────┐
│ user: [地址A] ├─────→│ { name: <span class="hljs-string">'Alice'</span>, age: <span class="hljs-number">25</span> } │
└──────────────┘      └──────────────────────────┘
</code></pre>
<p>当你赋值给另一个变量：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> admin = user; <span class="hljs-comment">// 复制的是地址，不是对象！</span>
admin.<span class="hljs-property">name</span> = <span class="hljs-string">'Bob'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>); <span class="hljs-comment">// 输出 "Bob"！</span>
</code></pre>
<p>因为 <code>admin</code> 和 <code>user</code> <strong>指向同一个堆中的对象</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">栈（Stack）</span>              <span class="hljs-string">堆（Heap）</span>
<span class="hljs-string">┌──────────────┐</span>      
<span class="hljs-string">│</span> <span class="hljs-attr">user:</span> [<span class="hljs-string">地址A</span>] <span class="hljs-string">├──┐</span>   
<span class="hljs-string">├──────────────┤</span>  <span class="hljs-string">│</span>   <span class="hljs-string">┌──────────────────────────┐</span>
<span class="hljs-string">│</span> <span class="hljs-attr">admin:</span> [<span class="hljs-string">地址A</span>] <span class="hljs-string">├──┼──→│</span> { <span class="hljs-attr">name:</span> <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">25</span> }  <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────┘</span>  <span class="hljs-string">│</span>   <span class="hljs-string">└──────────────────────────┘</span>
                  <span class="hljs-string">│</span>
                  <span class="hljs-string">└───┘</span>
</code></pre>
<p>所以引用类型是按共享的方式进行传递（Pass by Sharing）</p>
<p>注意：不是按引用传递，JS 中没有真正的按引用传递</p>
<hr/>
<h2 data-id="heading-6">三、深入对比</h2>








































<table><thead><tr><th>特性</th><th>原始类型</th><th>引用类型（对象）</th></tr></thead><tbody><tr><td>存储位置</td><td>栈（Stack）</td><td>栈（存引用地址） + 堆（存实际对象）</td></tr><tr><td>赋值行为</td><td>复制值本身</td><td>复制引用地址（多个变量共享同一对象）</td></tr><tr><td>是否可变</td><td>不可变（操作生成新值）</td><td>可变（可直接修改属性）</td></tr><tr><td>比较方式</td><td>比较值是否相等</td><td>比较引用地址是否相同</td></tr><tr><td>内存占用</td><td>固定、较小</td><td>动态、可能很大</td></tr><tr><td>典型场景</td><td>数字、字符串、布尔值</td><td>对象、数组、函数</td></tr></tbody></table>
<h3 data-id="heading-7">举个比较的例子：</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 原始类型比较</span>
<span class="hljs-number">5</span> === <span class="hljs-number">5</span>; <span class="hljs-comment">// true</span>
<span class="hljs-string">'hi'</span> === <span class="hljs-string">'hi'</span>; <span class="hljs-comment">// true</span>

<span class="hljs-comment">// 引用类型比较</span>
{} === {}; <span class="hljs-comment">// false！两个不同对象</span>
<span class="hljs-keyword">let</span> a = {}; <span class="hljs-keyword">let</span> b = a;
a === b; <span class="hljs-comment">// true！同一个对象</span>
</code></pre>
<hr/>
<h2 data-id="heading-8">四、常见问题</h2>
<h3 data-id="heading-9">为什么字符串很长，也算原始类型？</h3>
<p>虽然字符串可能很长，但 JS 引擎会做内部优化（比如使用指针），但从<strong>语言语义</strong>上，字符串是<strong>不可变的原始值</strong>。任何“修改”都会生成新字符串。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> s = <span class="hljs-string">'hello'</span>;
s = s + <span class="hljs-string">' world'</span>; <span class="hljs-comment">// 创建了新字符串，原 'hello' 未被修改</span>
</code></pre>
<h3 data-id="heading-10">如何真正复制一个对象，而不是共享？</h3>
<p><strong>浅拷贝</strong>：只复制第一层属性</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> newObj = { ...oldObj };
<span class="hljs-comment">// 或</span>
<span class="hljs-keyword">let</span> newObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, oldObj);
</code></pre>
<p><strong>深拷贝</strong>：递归复制所有层级（需注意循环引用等问题）</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> deepCopy = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj)); <span class="hljs-comment">// 有局限（不能拷贝函数、undefined 等）</span>
<span class="hljs-comment">// 推荐使用 Lodash 的 _.cloneDeep()</span>
</code></pre>
<hr/>
<h2 data-id="heading-11">五、总结</h2>
<ol>
<li><strong>原始类型</strong>：值直接存在栈里，赋值是复制值，互不影响。</li>
<li><strong>引用类型</strong>：栈里存地址，堆里存对象，赋值是复制地址，共享同一对象。</li>
<li><strong>理解存储机制</strong>，是掌握 JS 赋值、函数传参、状态管理、性能优化的基础！</li>
</ol>
<hr/>
<p>下次当你看到：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> a = obj;
a.<span class="hljs-property">x</span> = <span class="hljs-number">10</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">x</span>); <span class="hljs-comment">// 为什么变了？</span>
</code></pre>
<p>你就知道：<strong>因为 a 和 obj 指向的是同一个对象！</strong></p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-12">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F184BGM_pdMFLc0ASrferwQ" target="_blank" title="https://mp.weixin.qq.com/s/184BGM_pdMFLc0ASrferwQ" ref="nofollow noopener noreferrer">《代码里全是 new 对象，真的很 Low 吗？我认真想了一晚》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fp0n2mN5RDDDaIWuHHVRUZQ" target="_blank" title="https://mp.weixin.qq.com/s/p0n2mN5RDDDaIWuHHVRUZQ" ref="nofollow noopener noreferrer">《Java 开发必看：什么时候用 for，什么时候用 Stream？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FX-MSa0CHwVW_qgPezbpMUA" target="_blank" title="https://mp.weixin.qq.com/s/X-MSa0CHwVW_qgPezbpMUA" ref="nofollow noopener noreferrer">《这 5 个冷门 HTML 标签，让我直接删了100 行 JS 代码》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FT3ronvigepWew6dRC4uH2g" target="_blank" title="https://mp.weixin.qq.com/s/T3ronvigepWew6dRC4uH2g" ref="nofollow noopener noreferrer">《Vue 组件通信的 8 种最佳实践，你知道几种？》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[短思考第265天，小红书起号3周怎么样？实操总结这3点！]]></title>    <link>https://juejin.cn/post/7588007285547057158</link>    <guid>https://juejin.cn/post/7588007285547057158</guid>    <pubDate>2025-12-27T01:42:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588007285547057158" data-draft-id="7588007285547040774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="短思考第265天，小红书起号3周怎么样？实操总结这3点！"/> <meta itemprop="keywords" content="Android,AI编程"/> <meta itemprop="datePublished" content="2025-12-27T01:42:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员码歌"/> <meta itemprop="url" content="https://juejin.cn/user/764915820529831"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            短思考第265天，小红书起号3周怎么样？实操总结这3点！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/764915820529831/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员码歌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T01:42:29.000Z" title="Sat Dec 27 2025 01:42:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>小红书是内容生产平台，流量巨大，主要群体是一线城市高质量用户，是众多自媒体IP必争之地，码哥自起号起3周了，现在说一下主要的感受，总结一下实操经验。</p>
<p>一、创作：踩准规则才能接住流量</p>
<ol>
<li>养号3-5天再发笔记</li>
</ol>
<p>不要急着发笔记，先花3-5天刷同赛道内容、点赞评论，让系统认定你是真实用户，精准打上垂直标签。</p>
<ol start="2">
<li>发稿前用AI扫敏感词</li>
</ol>
<p>避免因违规被限流，这是基础操作。</p>
<ol start="3">
<li>发布后保持账号活跃</li>
</ol>
<p>再刷20分钟同类笔记保持账号活跃，有助于获得初始曝光权重。</p>
<ol start="4">
<li>小爆趋势下连续创作</li>
</ol>
<p>如果某篇笔记出现小爆趋势，一定要趁热打铁，连续更3-5条同类型内容，抓住平台的流量推送高峰，快速放大曝光量。</p>
<p>二、复盘：数据不会说谎</p>
<ol>
<li>拆解后台核心数据</li>
</ol>
<p>笔记发布后别只盯着粉丝数，要拆解后台点击率、收藏量、新增关注这些核心数据，随时调整创作方向。</p>
<ol start="2">
<li>同主题至少连发3篇</li>
</ol>
<p>千万不要发1-2篇没起色就直接换赛道，同主题至少连发3篇再做判断。</p>
<ol start="3">
<li>每周保持3篇稳定输出</li>
</ol>
<p>让系统判定你是能持续产出优质内容的博主，获得长期推流倾斜。</p>
<p>三、清醒认知：流量≠成功</p>
<ol>
<li>摸透平台规则就能轻松获取流量</li>
</ol>
<p>在小红书拿到99+点赞收藏，甚至涨粉千粉都不算难事，但摸透平台规则就能轻松做到，但这绝不代表能力有多出众。</p>
<ol start="2">
<li>打通从内容构思、创作发布，到引流变现的完整闭环，很多博主坐拥上万粉丝，却卡在商业化环节，最终只能沦为数据出众的“无效账号”。每个环节都缺一不可，环环相扣才能把流量变成真金白银。</li>
</ol>
<p>我是”程序员码歌“，全网昵称统一，10+年大厂程序员经验，在职场，玩副业，目标副业年收入百万，探索可复利可复制的一人企业玩法，可去gzh围观</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分布式事务本地消息表详解：中小团队的低侵入落地方案]]></title>    <link>https://juejin.cn/post/7588064253635330102</link>    <guid>https://juejin.cn/post/7588064253635330102</guid>    <pubDate>2025-12-27T01:49:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588064253635330102" data-draft-id="7588064253635313718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分布式事务本地消息表详解：中小团队的低侵入落地方案"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-12-27T01:49:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分布式事务本地消息表详解：中小团队的低侵入落地方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T01:49:49.000Z" title="Sat Dec 27 2025 01:49:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">分布式事务本地消息表详解：中小团队的低侵入落地方案</h2>
<p>在分布式事务领域，很多中小团队面临一个共性困境：既需要解决跨服务数据一致性问题（如订单创建后同步积分、支付成功后更新物流状态），又无法承担TCC、SAGA模式的高开发成本，也不满足2PC/3PC对“短事务、低并发”的限制。此时，“本地消息表+消息队列”的方案脱颖而出——它基于“本地事务+异步重试”的核心思路，实现了低侵入、低复杂度、高可用的最终一致性，成为中小团队和简单异步场景的首选分布式事务方案。今天，我们就全面拆解本地消息表的设计逻辑、执行流程、优缺点及落地要点。</p>
<h3 data-id="heading-1">一、铺垫：中小团队的分布式事务痛点，本地消息表的诞生背景</h3>
<p>中小团队在落地分布式事务时，核心痛点往往不是“技术先进性”，而是“低成本、低侵入、易维护”。传统方案的短板恰好击中了这些痛点：</p>
<ul>
<li><strong>2PC/3PC（强一致性）</strong> ：性能差、阻塞风险高，仅适合低并发场景；依赖资源层事务支持，无法适配异步跨服务场景（如订单创建后异步发通知）。</li>
<li><strong>TCC（柔性事务）</strong> ：业务侵入性极强，需改造所有参与服务的接口（实现Try/Confirm/Cancel），开发维护成本高；对团队技术能力要求高，中小团队难以驾驭。</li>
<li><strong>SAGA（柔性事务）</strong> ：虽侵入性低于TCC，但复杂流程的协调逻辑和补偿事务设计仍需较高成本；适合长事务，对简单异步场景（如“操作+通知”）而言过于厚重。</li>
</ul>
<p>中小团队的核心需求是：<strong>低代码改造、低开发成本、高可用性、适配简单异步跨服务场景</strong>。本地消息表方案正是基于这一需求设计的——它不依赖复杂框架，仅通过“数据库本地事务+消息队列重试”的组合，就能解决大部分简单异步场景的分布式事务问题，实现“业务操作”与“跨服务通知”的最终一致性。</p>
<h3 data-id="heading-2">二、本地消息表核心定义：什么是“本地事务+消息队列”方案？</h3>
<p>本地消息表方案的核心定义是：<strong>将分布式事务拆分为“本地业务事务”和“异步消息通知”两个部分，通过在业务库中新增“本地消息表”，将“业务操作”与“消息写入”封装在同一个本地事务中，保证两者原子性（要么都成功，要么都失败）；之后通过定时任务扫描本地消息表，将未投递的消息投递到消息队列；接收方消费消息队列中的消息，执行对应的业务操作；若消费失败，通过消息队列的重试机制重复投递，直至消费成功，最终实现跨服务的最终一致性</strong>。</p>
<p>核心组成要素（极简设计，无复杂角色）：</p>
<ol>
<li><strong>本地消息表</strong>：存储在业务数据库中的一张表，用于记录需要异步投递的消息，核心字段包括：消息ID（唯一标识）、消息内容（如订单ID、用户ID）、消息状态（待投递/已投递/已消费/失败）、创建时间、投递次数、下次投递时间等；消息表与业务表在同一个数据库，确保本地事务原子性。</li>
<li><strong>本地业务事务</strong>：发起方的核心业务操作（如创建订单、扣减余额），与“写入本地消息表”的操作封装在同一个数据库事务中，保证两者同时成功或同时失败。</li>
<li><strong>消息队列（MQ）</strong> ：用于异步传递消息（如RabbitMQ、RocketMQ、Kafka），承接本地消息表的消息投递，为接收方提供异步消费能力；依赖消息队列的“持久化”和“重试机制”，保证消息不丢失、消费失败可重试。</li>
<li><strong>定时任务（消息投递器）</strong> ：定期扫描本地消息表中“待投递”状态的消息，将其投递到消息队列；若投递失败（如MQ宕机），记录投递次数和下次投递时间，下次继续重试。</li>
</ol>
<p>核心角色（角色极简，易维护）：</p>
<ul>
<li><strong>事务发起方</strong>：执行本地业务事务，写入本地消息表，通过定时任务投递消息；</li>
<li><strong>事务接收方</strong>：消费消息队列中的消息，执行对应的业务操作（如创建积分记录、更新物流状态）；</li>
<li><strong>消息队列（中间件）</strong> ：负责消息的存储、传递和重试，是异步通信的核心载体。</li>
</ul>
<h3 data-id="heading-3">三、本地消息表完整流程拆解：以“订单创建后同步积分”为例</h3>
<p>我们以“电商订单创建后，异步同步用户积分（订单服务→积分服务）”的经典场景为例，拆解本地消息表的完整执行流程，直观理解每个环节的具体操作：</p>
<p>业务需求：用户创建订单（订单服务）后，积分服务需为用户增加对应积分，确保“订单创建成功”与“积分增加成功”最终一致（允许短暂延迟）。</p>
<h4 data-id="heading-4">前置准备：创建本地消息表</h4>
<p>在订单服务的业务数据库中，新增“local_message”本地消息表，表结构示例（MySQL）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `local_message` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
  `message_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息唯一ID（UUID）'</span>,
  `message_content` text <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息内容（JSON格式，如{"order_id":"123","user_id":"456","points":10}）'</span>,
  `message_status` tinyint(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'消息状态：0-待投递，1-已投递，2-已消费，3-投递失败'</span>,
  `delivery_count` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'已投递次数'</span>,
  `next_delivery_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'下次投递时间'</span>,
  `create_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
  `update_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'更新时间'</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_message_id` (`message_id`),
  INDEX `idx_message_status` (`message_status`),
  INDEX `idx_next_delivery_time` (`next_delivery_time`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'本地消息表'</span>;
</code></pre>
<h4 data-id="heading-5">阶段1：执行本地事务（业务操作+写入消息表）</h4>
<p>订单服务在创建订单时，将“创建订单”和“写入积分同步消息”封装在同一个本地事务中，保证原子性：</p>
<ol>
<li>用户发起创建订单请求，订单服务开启数据库事务；</li>
<li>执行核心业务操作：向“order”表插入订单记录（状态为“已创建”）；</li>
<li>执行消息写入操作：生成唯一消息ID，向“local_message”表插入一条消息（消息内容为订单ID、用户ID、积分值等，状态为“0-待投递”，下次投递时间为当前时间+10秒）；</li>
<li>提交数据库事务：若步骤2和3均成功，事务提交，订单创建成功且消息写入成功；若任意一步失败（如订单参数错误、数据库异常），事务回滚，订单和消息均不生效，无数据不一致。</li>
</ol>
<h4 data-id="heading-6">阶段2：定时任务投递消息到MQ</h4>
<p>订单服务启动定时任务（如每10秒执行一次），扫描本地消息表中“待投递”且“下次投递时间≤当前时间”的消息，将其投递到消息队列（如RocketMQ的“order_to_points_topic”主题）：</p>
<ol>
<li>
<p>定时任务查询本地消息表：<code>SELECT * FROM local_message WHERE message_status=0 AND next_delivery_time ≤ NOW()</code>；</p>
</li>
<li>
<p>遍历查询结果，向消息队列发送消息（消息内容为local_message表中的message_content）；</p>
</li>
<li>
<p>处理投递结果：</p>
<ol>
<li>若投递成功：更新消息状态为“1-已投递”，记录投递次数；</li>
<li>若投递失败（如MQ宕机）：更新投递次数（+1），设置下次投递时间（如当前时间+2^n秒，采用指数退避策略，避免频繁重试）；若投递次数超过阈值（如5次），标记消息状态为“3-投递失败”，触发告警（人工介入处理）。</li>
</ol>
</li>
</ol>
<h4 data-id="heading-7">阶段3：接收方消费消息，执行业务操作</h4>
<p>积分服务监听消息队列的“order_to_points_topic”主题，消费订单服务投递的消息，执行积分增加操作：</p>
<ol>
<li>
<p>积分服务从消息队列获取消息，解析消息内容（订单ID、用户ID、积分值）；</p>
</li>
<li>
<p>执行幂等性校验：查询“points_log”积分日志表，判断该消息ID对应的积分是否已增加（避免重复消费）；若已消费，直接返回成功；若未消费，继续下一步；</p>
</li>
<li>
<p>执行核心业务操作：向“user_points”表更新用户积分（增加对应积分），向“points_log”表插入积分变更记录（关联消息ID，用于幂等校验）；</p>
</li>
<li>
<p>处理消费结果：</p>
<ol>
<li>若消费成功：向消息队列发送“消费确认”（ACK），消息队列删除该消息；</li>
<li>若消费失败（如数据库异常、积分服务宕机）：不发送ACK，消息队列将该消息重新放入队列，等待下次投递（依赖MQ的重试机制，重试间隔可配置）；若重试次数超过阈值，消息进入死信队列，后续人工处理。</li>
</ol>
</li>
</ol>
<h4 data-id="heading-8">阶段4：（可选）消息消费确认回写（优化点）</h4>
<p>为了更精准地跟踪消息状态，可增加“消费确认回写”步骤：积分服务消费成功后，主动调用订单服务的“消息消费确认接口”，订单服务收到后将本地消息表中对应消息的状态更新为“2-已消费”。此步骤非必需，但能让消息状态更透明，便于问题排查。</p>
<h3 data-id="heading-9">四、本地消息表的核心优势与局限性</h3>
<p>本地消息表方案的优势和局限性都源于其“极简设计”，适配场景高度聚焦于“简单异步跨服务场景”。</p>
<h4 data-id="heading-10">1. 核心优势：低侵入、低成本、高可用</h4>
<ul>
<li><strong>业务侵入性极低</strong>：无需改造现有业务接口，仅需在业务库中新增本地消息表，在原有业务事务中新增“写入消息”的步骤，开发改造量极小；</li>
<li><strong>实现简单，成本低</strong>：不依赖复杂的分布式事务框架，仅需使用数据库本地事务和消息队列，中小团队无需额外学习成本，就能快速落地；</li>
<li><strong>高可用性强</strong>：本地事务保证“业务+消息”原子性，无数据丢失风险；消息队列的持久化和重试机制，保证消息能可靠投递；定时任务的指数退避重试，避免了瞬时故障导致的消息投递失败；</li>
<li><strong>性能影响小</strong>：本地消息表的写入是本地数据库操作，性能开销极低；消息投递和消费是异步的，不会阻塞核心业务流程（如订单创建），对核心业务性能几乎无影响。</li>
</ul>
<h4 data-id="heading-11">2. 局限性：仅适配简单场景，一致性延迟可控</h4>
<ul>
<li><strong>仅支持简单异步场景</strong>：适合“一对一”的异步跨服务通知场景（如订单→积分、支付→物流）；不支持复杂流程（如多服务串行/并行交互、流程分支），也不支持长事务场景；</li>
<li><strong>仅能保证最终一致性</strong>：消息投递和消费存在延迟，会出现“订单创建成功但积分尚未增加”的中间状态，需业务层面能接受；</li>
<li><strong>消息表与业务库耦合</strong>：本地消息表存储在业务数据库中，会增加业务库的存储压力；若业务库宕机，消息投递会暂时中断（但业务也无法执行，属于可接受范围）；</li>
<li><strong>需手动处理幂等性和死信消息</strong>：消费方必须实现幂等性（避免重复消费），死信消息（多次重试失败的消息）需要人工介入处理，增加了运维成本。</li>
</ul>
<h3 data-id="heading-12">五、本地消息表的适用场景与落地注意事项</h3>
<p>本地消息表方案的特性决定了它是“简单异步场景的最优解”，落地时需重点解决幂等性、重试策略、死信处理等核心问题。</p>
<h4 data-id="heading-13">1. 适用场景</h4>
<ul>
<li><strong>简单异步跨服务通知场景</strong>：如订单创建后同步积分、支付成功后更新物流状态、用户注册后发送欢迎短信/邮件；</li>
<li><strong>中小团队、低开发成本需求场景</strong>：团队技术能力有限，无法承担TCC、SAGA的开发维护成本，需要快速落地分布式事务方案；</li>
<li><strong>核心业务非强实时一致性场景</strong>：核心业务（如订单创建）无需等待跨服务操作完成，可接受短暂的一致性延迟；</li>
<li><strong>基于关系型数据库的业务场景</strong>：业务使用MySQL、PostgreSQL等关系型数据库，能利用本地事务保证“业务+消息”的原子性。</li>
</ul>
<h4 data-id="heading-14">2. 落地注意事项（核心技术难点）</h4>
<ul>
<li>
<p><strong>消息表设计优化</strong>：</p>
<ul>
<li>必须添加“消息唯一ID”（如UUID），用于幂等性校验；</li>
<li>索引设计：为“message_status”和“next_delivery_time”建立联合索引，提升定时任务查询效率；为“message_id”建立唯一索引，避免重复插入消息；</li>
<li>字段精简：仅存储必要的消息内容，避免消息表过大影响查询性能。</li>
</ul>
</li>
<li>
<p><strong>严格保证幂等性</strong>：</p>
<ul>
<li>消费方：通过“消息ID”或“业务唯一标识（如订单ID）”做幂等校验，确保重复消费不会导致数据异常（如重复增加积分）；</li>
<li>发起方：本地事务提交前，通过“消息ID”唯一索引避免重复写入消息。</li>
</ul>
</li>
<li>
<p><strong>合理设计重试策略</strong>：</p>
<ul>
<li>发起方定时任务：采用“指数退避重试”（如10秒、20秒、40秒、80秒...），避免频繁重试给MQ和数据库带来压力；设置最大投递次数（如5次），超过阈值标记为失败并告警；</li>
<li>消息队列消费：配置合理的重试间隔（如30秒），超过重试次数后将消息转入死信队列，避免占用正常消息队列资源。</li>
</ul>
</li>
<li>
<p><strong>消息清理与归档</strong>：定时归档或删除“已消费”状态的消息（如归档3个月前的消息），避免本地消息表过大，影响查询和写入性能；</p>
</li>
<li>
<p><strong>事务隔离级别选择</strong>：发起方数据库建议使用“读已提交（Read Committed）”或更高的隔离级别，避免定时任务读取到未提交的消息（脏读）；</p>
</li>
<li>
<p><strong>监控与告警机制</strong>：建立消息状态监控面板，实时监控“待投递”“投递失败”“死信消息”的数量；对“投递失败”“死信消息”设置告警（如短信、邮件告警），确保及时人工介入处理。</p>
</li>
</ul>
<h3 data-id="heading-15">六、本地消息表与其他分布式事务方案的选型对比</h3>
<p>分布式事务方案的选型核心是“场景匹配+成本权衡”，我们将本地消息表与其他主流方案对比，明确适用边界：</p>













































<table><thead><tr><th>方案类型</th><th>一致性</th><th>性能</th><th>业务侵入性</th><th>开发维护成本</th><th>适配场景</th></tr></thead><tbody><tr><td>2PC/3PC（强一致性）</td><td>强一致</td><td>低</td><td>低（依赖资源层）</td><td>中</td><td>短事务、低并发、一致性要求极高（如金融核心转账）</td></tr><tr><td>TCC（柔性事务）</td><td>最终一致</td><td>高</td><td>高（改造业务接口）</td><td>高</td><td>短事务、高并发、跨多种资源（如电商秒杀下单）</td></tr><tr><td>SAGA（柔性事务）</td><td>最终一致</td><td>中高</td><td>中（新增补偿事务）</td><td>中高</td><td>长事务、复杂流程（如订单全流程、物流履约）</td></tr><tr><td>本地消息表+MQ（柔性事务）</td><td>最终一致</td><td>高</td><td>极低（新增消息表）</td><td>低</td><td>简单异步场景、中小团队、低成本需求（如订单→积分、支付→物流）</td></tr></tbody></table>
<h3 data-id="heading-16">七、总结：本地消息表的核心价值与落地取舍</h3>
<p>本地消息表方案的核心价值在于“以最低的成本解决简单异步场景的最终一致性问题”——它放弃了复杂的强一致性保障和复杂流程适配能力，换来了“低侵入、易实现、高可用”的特性，完美契合中小团队和简单业务的需求。它不是最“先进”的分布式事务方案，但却是最“务实”的方案之一。</p>
<p>在实际落地时，我们需明确：本地消息表的难点不在于“流程设计”，而在于“细节优化”（如幂等性、重试策略、消息清理）。建议无需追求复杂的自定义实现，可基于成熟的消息队列（如RocketMQ的事务消息功能，本质是本地消息表的封装）快速落地，减少重复开发。</p>
<p>最后，回归分布式事务的核心原则：<strong>没有最优方案，只有最适配业务的方案</strong>。若你的业务是简单异步跨服务通知，且团队追求低成本、低侵入，本地消息表方案是首选；若需要处理高并发短事务，选择TCC；若需要处理长事务复杂流程，选择SAGA；若一致性要求极高，强一致性方案仍是底线。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-196 scikit-learn KNN 实战：KNeighborsClassifier、kneighbors 与学习曲线选最优 案例1红酒 案例2乳腺]]></title>    <link>https://juejin.cn/post/7588010346070867978</link>    <guid>https://juejin.cn/post/7588010346070867978</guid>    <pubDate>2025-12-27T01:56:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588010346070867978" data-draft-id="7587965800273575962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-196 scikit-learn KNN 实战：KNeighborsClassifier、kneighbors 与学习曲线选最优 案例1红酒 案例2乳腺"/> <meta itemprop="keywords" content="后端,大数据,机器学习"/> <meta itemprop="datePublished" content="2025-12-27T01:56:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-196 scikit-learn KNN 实战：KNeighborsClassifier、kneighbors 与学习曲线选最优 案例1红酒 案例2乳腺
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T01:56:12.000Z" title="Sat Dec 27 2025 01:56:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：用 scikit-learn 快速落地 KNN 分类，理解 fit/predict/score、kneighbors 与选 K。</li>
<li>结论：单次划分下“最优 K”不稳定；用交叉验证 + 标准化 Pipeline 才能工程化定 K。</li>
<li>产出：两套案例代码骨架 + 邻居检索方法 + 选 K 的可复现实践清单与错误速查。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1b37cc4bd6a4fdaa7deb433b1bae7e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405371&amp;x-signature=YqElGPzDYmDvayRDNOCs0JErsSI%3D" alt="大数据-196 scikit-learn KNN 实战：KNeighborsClassifier、kneighbors 与学习曲线选最优 案例1红酒 案例2乳腺癌" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52e3063a5ce648a2b5d762a296a76c90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405371&amp;x-signature=A%2Bwv2QpcoRWbQmgeiPIwI6G%2FqK8%3D" alt="大数据-196 scikit-learn KNN 实战：KNeighborsClassifier、kneighbors 与学习曲线选最优 案例1红酒 案例2乳腺癌" loading="lazy"/></p>
<h2 data-id="heading-1">scikit-learn 算法库实现</h2>
<p>scikit-learn（简称 sklearn）自 2007 年由 David Cournapeau 发起以来，已经成为 Python 生态系统中最重要的机器学习库之一。作为 NumPy 和 SciPy 生态系统的重要组成部分，sklearn 为数据科学家和机器学习工程师提供了强大而高效的工具集。</p>
<p>在功能架构上，scikit-learn 主要支持四大核心机器学习算法领域：</p>
<ol>
<li><strong>分类算法</strong>：包括逻辑回归（LogisticRegression）、支持向量机（SVC）、随机森林（RandomForestClassifier）等，适用于客户流失预测、垃圾邮件识别等场景</li>
<li><strong>回归算法</strong>：如线性回归（LinearRegression）、岭回归（Ridge）等，可用于房价预测、销量预估等任务</li>
<li><strong>降维技术</strong>：主成分分析（PCA）、t-SNE 等算法，帮助处理高维数据可视化</li>
<li><strong>聚类算法</strong>：K均值（KMeans）、DBSCAN 等，适用于用户分群、异常检测等应用</li>
</ol>
<p>此外，scikit-learn 还提供三大关键功能模块：</p>
<ul>
<li><strong>特征提取</strong>：包括文本特征向量化（CountVectorizer）、TF-IDF 转换等</li>
<li><strong>数据预处理</strong>：标准化（StandardScaler）、归一化（MinMaxScaler）、缺失值处理等</li>
<li><strong>模型评估</strong>：交叉验证（cross_val_score）、多种评估指标（accuracy_score, f1_score 等）</li>
</ul>
<p>在实际工程应用中，直接使用 Python 原生代码从头实现机器学习算法存在诸多挑战：</p>
<ol>
<li>开发周期长，需要处理大量底层数学运算和优化问题</li>
<li>难以保证代码的健壮性和计算效率</li>
<li>缺乏统一的接口设计，不利于团队协作和模型维护</li>
</ol>
<p>相比之下，使用 scikit-learn 的标准工作流程更加高效可靠：</p>
<ol>
<li>数据采集后，首先进行探索性分析（EDA）</li>
<li>根据数据特征（如线性/非线性、数据规模、特征维度等）选择合适的算法</li>
<li>通过 sklearn 统一的 API 接口（fit/predict/transform）调用算法</li>
<li>使用网格搜索（GridSearchCV）或随机搜索（RandomizedSearchCV）优化超参数</li>
<li>通过交叉验证评估模型性能，最终实现算法效率与效果的平衡</li>
</ol>
<p>例如，在电商推荐系统开发中，可以：</p>
<ol>
<li>使用 sklearn 的 KNN 算法实现协同过滤</li>
<li>通过 Pipeline 将特征标准化、降维和分类器组合</li>
<li>利用 classification_report 输出精确率、召回率等指标</li>
</ol>
<p>正是这种模块化设计、统一接口和丰富的算法实现，使 scikit-learn 成为机器学习实践中的首选工具包，大大降低了算法应用的门槛，提高了开发效率。</p>
<h3 data-id="heading-2">设计原则</h3>
<p>一致性
所有对象共享一个简单一致的界面（接口）</p>
<ul>
<li>估算器：fit()方法，基于数据估算参数的任意对象，使用的参数是一个数据集（对应 X，有监督算法还需要一个Y），引导估算过程的任意其他参数成为超参数，必须被设置为实例变量。</li>
<li>转换器：transform()方法，使用估算器转换数据集，转换过程依赖于学习参数，可以使用便捷方式：fit_transform()，相当于先 fit()再 transform()，有时优化过速度更快。</li>
<li>预测器：predict()方法，使用估算器预测新数据，返回包含预测结果的数据，还有 score()方法：用于度量给定测试集的预测效果的好坏（连续 y 使用 R 方，分类 y 使用准确率 accuracy）</li>
</ul>
<h3 data-id="heading-3">监控</h3>
<p>检查所有参数，所有估算器的超参数可以通过公共实例变量访问，所有估算器的学习参数都可以通过有下划线后缀的公共实例变量访问。</p>
<h3 data-id="heading-4">防止类扩散</h3>
<p>对象型固定，数据集被表示为 Numpy 数组或 Scipy 稀疏矩阵，超惨是普通的 Python字符或数字。</p>
<h3 data-id="heading-5">合成</h3>
<p>现有的构建尽可能重用，可以轻松创建一个流水线 Pipline。</p>
<h3 data-id="heading-6">合成默认值</h3>
<p>大多参数提供合理默认值，可以轻松搭建一个基本的工作系统。</p>
<h4 data-id="heading-7">案例1：红酒</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier

<span class="hljs-comment"># 0 代表 “黑皮诺”，1 代表 “赤霞珠”</span>
clf = KNeighborsClassifier(n_neighbors = <span class="hljs-number">3</span>)
clf = clf.fit(wine_data.iloc[:,<span class="hljs-number">0</span>:<span class="hljs-number">2</span>], wine_data.iloc[:,-<span class="hljs-number">1</span>])
result = clf.predict([[<span class="hljs-number">12.8</span>,<span class="hljs-number">4.1</span>]]) <span class="hljs-comment"># 返回预测的标签</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"result: <span class="hljs-subst">{result}</span>"</span>)

<span class="hljs-comment"># 对模型进行一个评估，接口score返回预测的准确率</span>
score = clf.score([[<span class="hljs-number">12.8</span>,<span class="hljs-number">4.1</span>]],[<span class="hljs-number">0</span>])
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"score: <span class="hljs-subst">{score}</span>"</span>)

<span class="hljs-built_in">print</span>(clf.predict_proba([[<span class="hljs-number">12.8</span>,<span class="hljs-number">4.1</span>]]))

</code></pre>
<p>执行结果如下图是：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a47616495cb940939d5282545463e487~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405371&amp;x-signature=Ja9JAPiuWB%2BJ4jGfOagezLxqyn4%3D" alt="sklearn K近邻算法" loading="lazy"/></p>
<h4 data-id="heading-8">案例2：乳腺癌</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.neighbors <span class="hljs-keyword">import</span> KNeighborsClassifier
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_breast_cancer
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split

<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-comment">#读取数据集</span>
data = load_breast_cancer()
<span class="hljs-comment">#DateFrame格式显示</span>
X = data.data
y = data.target
name = [<span class="hljs-string">'平均半径'</span>,<span class="hljs-string">'平均纹理'</span>,<span class="hljs-string">'平均周长'</span>,<span class="hljs-string">'平均面积'</span>,
<span class="hljs-string">'平均光滑度'</span>,<span class="hljs-string">'平均紧凑度'</span>,<span class="hljs-string">'平均凹度'</span>,
<span class="hljs-string">'平均凹点'</span>,<span class="hljs-string">'平均对称'</span>,<span class="hljs-string">'平均分形维数'</span>,
<span class="hljs-string">'半径误差'</span>,<span class="hljs-string">'纹理误差'</span>,<span class="hljs-string">'周长误差'</span>,<span class="hljs-string">'面积误差'</span>,
<span class="hljs-string">'平滑度误差'</span>,<span class="hljs-string">'紧凑度误差'</span>,<span class="hljs-string">'凹度误差'</span>,
<span class="hljs-string">'凹点误差'</span>,<span class="hljs-string">'对称误差'</span>,
<span class="hljs-string">'分形维数误差'</span>,<span class="hljs-string">'最差半径'</span>,<span class="hljs-string">'最差纹理'</span>,
<span class="hljs-string">'最差的边界'</span>,<span class="hljs-string">'最差的区域'</span>,<span class="hljs-string">'最差的平滑度'</span>,
<span class="hljs-string">'最差的紧凑性'</span>,<span class="hljs-string">'最差的凹陷'</span>,<span class="hljs-string">'最差的凹点'</span>,
<span class="hljs-string">'最差的对称性'</span>,<span class="hljs-string">'最差的分形维数'</span>,<span class="hljs-string">'患病否'</span>]
data=np.concatenate((X,y.reshape(-<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)),axis=<span class="hljs-number">1</span>)
table=pd.DataFrame(data=data,columns=name)
table.head()

<span class="hljs-comment"># 划分训练集和测试集 #30%数据作为训练集</span>
Xtrain,Xtest,Ytrain,Ytest = train_test_split(X,y,test_size=<span class="hljs-number">0.2</span>,random_state=<span class="hljs-number">420</span>)
<span class="hljs-comment"># 建立模型&amp;评估模型</span>
clf = KNeighborsClassifier(n_neighbors=<span class="hljs-number">4</span>)
<span class="hljs-comment"># 建立分类器</span>
clf = clf.fit(Xtrain,Ytrain)
score = clf.score(Xtest,Ytest)
score
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/819873c325864a66944131ea655fb2db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405371&amp;x-signature=Ap5J%2FaIPWVnaNySJS3BXo5cO4Fc%3D" alt="sklearn 乳腺癌案例" loading="lazy"/>
如何用上面分类器拟合结果找出离 Xtest 中第 20 行和第 30 行最近的 4 个“点”?</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 查找点的K邻居。返回每个点的邻居的与之的距离和索引值。</span>
clf.kneighbors(Xtest[[<span class="hljs-number">20</span>,<span class="hljs-number">30</span>],:],return_distance=<span class="hljs-literal">True</span>)
</code></pre>
<p>查询结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c2b2eff9e6649b7a549f6ccac366d6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405371&amp;x-signature=3P%2BGRyusnB43AY%2BTxk4RigwcT70%3D" alt="sklearn k近邻输出结果" loading="lazy"/></p>
<h3 data-id="heading-9">选择最优K值</h3>
<p>KNN 中的一个超参数，所谓“超参数”，就是需要人为输入，算法不能通过直接计算得出这个参数，KNN 中的 K 代表的是距离需要分类的测试点 X 最近的 K 个样本，如果不输入这个值，那么算法中重要部分“选出 K 个最近邻”就无法实现。
从 KNN 的原理中可见，是否能够确认合适的 K 值对算法有极大的影响。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45d413c6ac364e4ba2cc7fda96ac80b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405371&amp;x-signature=ZfqcNXGHigY6P2bUPYAzESEg6O8%3D" alt="KNN 超参数" loading="lazy"/>
如果选择的 K值较小，就相当于较小的领域中的训练实例进行预测，这时候只有与输入实例较近的训练实例才会对预测结果起作用，但缺点是预测结果会对近邻的实例点非常敏感，如果近邻的实例点恰好是噪声，预测就会出错。
相反的，如果选择的 K 值较大，就相当于较大的领域中的训练实例进行预测，这时与输入实例较远的（不相似的）训练实例也会对预测起作用，使预测发生错误。因此，超参数 K 的选定是 KNN 的头号问题。</p>
<h3 data-id="heading-10">学习曲线</h3>
<p>我们怎么样选择一个最佳的 K 值？在这里要使用机器学习中的神器：参数学习曲线，参数学习曲线是一条以不同的参数取值为横坐标，不同参数取值下的模型结果为纵坐标的曲线，我们往往选择模型表现最佳点的参数取值作为这个参数的取值。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 更换不同的n_neighbors参数的取值，观察结果的变化</span>
clf = KNeighborsClassifier(n_neighbors=<span class="hljs-number">7</span>)
clf = clf.fit(Xtrain,Ytrain)
score = clf.score(Xtest,Ytest)
score
</code></pre>
<p>查看结果如下：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/702e3a32191c4fa2bfc391302d4b1b05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405371&amp;x-signature=qRlA4s9ShYF7wNBUGCqS3o%2FdQ60%3D" alt="K近邻算法 学习曲线" loading="lazy"/>
绘制学习曲线：</p>
<pre><code class="hljs language-python" lang="python">score = []
krange = <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">20</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> krange:
clf = KNeighborsClassifier(n_neighbors=i)
clf = clf.fit(Xtrain,Ytrain)
score.append(clf.score(Xtest,Ytest))
plt.plot(krange,score)
plt.show()
</code></pre>
<p>执行结果如下：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb84ef8cdd0f4c73b9fda24c2847c51f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405371&amp;x-signature=ncVH3CmHlLjYcadiUQ7sxrla1M8%3D" alt="K近邻学习曲线绘制" loading="lazy"/>
图像如下所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68c7f5c57a4341948635500ffe1b8f00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405371&amp;x-signature=Tutrs2Hd8UIjSzQTC8xdatQjGDM%3D" alt="K近邻学习曲线绘制" loading="lazy"/>
那么上图中 K 为多少的时候分值最高呢？</p>
<pre><code class="hljs language-shell" lang="shell">score.index(max(score))+1
</code></pre>
<p>执行结果如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe0a07a22b214e47b16d87120d4724f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405371&amp;x-signature=ujwduRSOcmovunXakNNowueMdIw%3D" alt="K近邻学习曲线输出K值" loading="lazy"/>
但是这个时候也会有问题，如果随机划分的数据集变化的话，得分最高的K 值也会发生变化。</p>
<pre><code class="hljs language-python" lang="python">Xtrain,Xtest,Ytrain,Ytest = train_test_split(X,y,test_size=<span class="hljs-number">0.2</span>,random_state=<span class="hljs-number">421</span>)
score = []
krange = <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">20</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> krange:
    clf = KNeighborsClassifier(n_neighbors=i)
    clf = clf.fit(Xtrain,Ytrain)
    score.append(clf.score(Xtest,Ytest))
plt.plot(krange,score)
plt.show()
</code></pre>
<p>执行结果如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffcfc484fe134274912cb9f1a9558e4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405371&amp;x-signature=dTOGR9%2FeghqjH6eC5nZKjF%2F26yA%3D" alt="K近邻学习训练" loading="lazy"/>
输出的图片的是：
![K近邻学习训练]](<a href="https://link.juejin.cn?target=https%3A%2F%2Fi-blog.csdnimg.cn%2Fdirect%2F2a005d64a3e34884b0944b400ecd31de.png" target="_blank" title="https://i-blog.csdnimg.cn/direct/2a005d64a3e34884b0944b400ecd31de.png" ref="nofollow noopener noreferrer">i-blog.csdnimg.cn/direct/2a00…</a>)
此时的K 为多少分值最高？</p>
<pre><code class="hljs language-python" lang="python">score.index(<span class="hljs-built_in">max</span>(score))+<span class="hljs-number">1</span>
</code></pre>
<p>执行结果如下所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/393c23544e5e4a0eb176be9d9ae78743~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767405371&amp;x-signature=gZiqk0mBDfVStEmAsdB1sMd%2BQkA%3D" alt="K近邻确定最高的分值是多少" loading="lazy"/>
此时就无法确定最佳的 K 值了，就无法进行下面的建模工作，怎么办？</p>
<h2 data-id="heading-11">错误速查</h2>

































































<table><thead><tr><th>症状</th><th>根因定位</th><th>修复</th><th>学习曲线</th></tr></thead><tbody><tr><td>代码直接报 <code>IndentationError</code></td><td><code>for</code> 循环体未缩进</td><td>补齐循环体缩进；确保 <code>clf = ... fit append</code> 在循环内</td><td>运行到 <code>for i in krange:</code> 处即失败</td></tr><tr><td><code>NameError: name 'wine_data' is not defined</code></td><td>红酒案例未给出数据读取/变量定义</td><td>在正文前补充数据加载与 <code>DataFrame</code> 构造；或改用 <code>sklearn</code> 内置数据集/CSV 读取示例</td><td>指向 <code>wine_data.iloc...</code></td></tr><tr><td><code>NameError: name 'plt' is not defined</code></td><td>绘图未导入 <code>matplotlib</code></td><td>增加 <code>import matplotlib.pyplot as plt</code></td><td>指向 <code>plt.plot(...)</code></td></tr><tr><td><code>score</code> 看起来“很高/很低”，但不可信</td><td>单样本或极小样本调用 <code>score</code>，统计意义不足</td><td>用独立测试集（<code>Xtest</code>/<code>Ytest</code>）评估；至少上百样本或交叉验证均值</td><td><code>clf.score([[12.8,4.1]],[0])</code> 这类写法</td></tr><tr><td>“最佳 K”随 <code>random_state</code> 改变</td><td>单次切分导致方差大；数据量/类别分布使结果敏感</td><td>用 <code>StratifiedKFold</code> + <code>GridSearchCV</code>；报告均值±方差/置信区间，不报单点峰值</td><td>对比 <code>random_state=420</code> 与 <code>421</code> 的峰值 K 不同</td></tr><tr><td>KNN 效果异常、K 很大/很小才好</td><td>特征未标准化导致距离被量纲主导</td><td>用 <code>Pipeline(StandardScaler(), KNN)</code>；必要时尝试不同距离度量（<code>metric</code>）</td><td>检查特征量纲（如面积/周长量级远大于分形维数）</td></tr><tr><td><code>kneighbors</code> 结果看不懂或索引对不上原表</td><td><code>Xtest</code> 是 <code>ndarray</code>，索引返回的是训练集索引（相对 <code>Xtrain</code>）</td><td>明确 <code>kneighbors(Xtest[[20,30]], ...)</code> 返回的是 <code>Xtrain</code> 的邻居索引；用这些索引回查 <code>Xtrain</code>/<code>Ytrain</code></td><td>输出为 <code>(distances, indices)</code>，<code>indices</code> 指向训练集样本</td></tr><tr><td>文字注释与代码不一致</td><td>注释写“30%数据作为训练集”，但 <code>test_size=0.2</code> 实际是 20% 测试集</td><td>以代码为准；统一注释口径（训练/测试比例）避免读者误解</td><td><code>train_test_split(... test_size=0.2 ...)</code></td></tr><tr><td><code>KNeighborsClassifier</code> 速度慢/内存高</td><td>大样本下 KNN 预测为近邻检索，复杂度高</td><td>降维（<code>PCA</code>）、近似近邻（外部库）、减少特征/样本；或换模型（线性/树模型）</td><td>预测耗时随样本数线性/近线性上升</td></tr></tbody></table>
<h2 data-id="heading-12">其他系列</h2>
<h3 data-id="heading-13">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-14">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-207 RabbitMQ Direct 交换器路由：RoutingKey 精确匹配、队列多绑定与日志分流实战</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-15">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[成为高级 PHP 开发者需要的思维转变]]></title>    <link>https://juejin.cn/post/7588007285546827782</link>    <guid>https://juejin.cn/post/7588007285546827782</guid>    <pubDate>2025-12-27T00:16:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588007285546827782" data-draft-id="7588007285546811398" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="成为高级 PHP 开发者需要的思维转变"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2025-12-27T00:16:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            成为高级 PHP 开发者需要的思维转变
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T00:16:27.000Z" title="Sat Dec 27 2025 00:16:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">成为高级 PHP 开发者需要的思维转变</h2>
<p>想成为 PHP 高手?先从调整思维开始</p>
<p>想成为专业的 PHP 开发者?这很好。但在深入研究 PHP 语法或最新框架之前,有一件事你需要明确:你的思维方式。</p>
<p>事实上,这不仅仅是写代码——成为 PHP 专业人士意味着用不同的方式思考。这关乎你如何处理问题、如何与他人协作,以及如何成长。当然,深入了解 PHP 很重要,但正确的思维方式才是在 PHP 领域脱颖而出的真正关键。</p>
<p>本文将讨论能让你从 PHP 新手成长为专业开发者的关键思维转变。准备好提升了吗?开始吧。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2025-12%2Fthe-mindset-shifts-you-need-to-become-a-rockstar-php-developer" target="_blank" title="https://catchadmin.com/post/2025-12/the-mindset-shifts-you-need-to-become-a-rockstar-php-developer" ref="nofollow noopener noreferrer">原文链接 成为高级 PHP 开发者需要的思维转变</a></p>
<h3 data-id="heading-1">转变 1:从"只是写代码"到"解决实际问题"</h3>
<p>写代码很酷,但解决问题更酷</p>
<p>说实话:任何人都能写代码。但写出能解决实际问题的代码?这才是关键所在。作为初学者,很容易迷失在语法细节和函数调用中,但重点是:编码只是工具。作为 PHP 开发者,你的工作不仅仅是敲代码——而是以最佳方式解决问题。</p>
<p><strong>技术实践:在编码前先分解问题</strong></p>
<p>在打开代码编辑器之前,先将问题分解成可管理的小块。使用流程图或伪代码等工具来规划逻辑。这种方法不仅能理清思路,还能帮你尽早发现边界情况和潜在陷阱。</p>
<p>示例:
构建购物车时,先为添加商品、计算总价和管理会话持久化编写伪代码。然后在 PHP 中有条不紊地实现每一步。例如:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// Pseudocode: Add item to cart</span>
<span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'cart'</span>])) {
    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'cart'</span>] = <span class="hljs-keyword">array</span>();
}
<span class="hljs-title function_ invoke__">array_push</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'cart'</span>], <span class="hljs-variable">$item</span>);
</code></pre>
<p>这种结构化方法将编码转变为解决问题,而不仅仅是随意写代码。</p>
<h3 data-id="heading-2">转变 2:从"复制粘贴编码"到"理解并掌控你的代码"</h3>
<p>别再偷懒复制粘贴了(我们都经历过)</p>
<p>这很诱人,对吧?在 Stack Overflow 上找到快速解决方案,复制粘贴代码,然后收工。但现实是:这在短期内可能有效,但从长远来看是灾难。如果你不理解正在使用的代码,就会遇到无法修复的问题——更糟的是,你会错过学习如何编写真正适合你的代码的机会。</p>
<p><strong>技术实践:阅读文档并在本地测试</strong></p>
<p>不要直接复制粘贴,而是先阅读文档。这对理解函数和库的工作原理至关重要。一旦掌握了概念,就在隔离环境中测试它(使用 PHP FPM 或 Xdebug 等工具)来观察它的行为。</p>
<p>示例:
在使用第三方 API 之前,彻底阅读其文档。尝试简单的 curl 请求来查看数据格式以及 PHP 如何处理它。不要只依赖教程——自己动手试试。以下是在 PHP 中向 API 发起请求的快速示例:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// Example: Using cURL to send a GET request</span>
<span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>();
<span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_URL, <span class="hljs-string">"https://api.example.com/data"</span>);
<span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-number">1</span>);
<span class="hljs-variable">$response</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);
<span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$ch</span>);
<span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">json_decode</span>(<span class="hljs-variable">$response</span>, <span class="hljs-literal">true</span>);
<span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-variable">$data</span>);
</code></pre>
<p>现在,你理解了请求过程以及 API 如何响应。</p>
<h3 data-id="heading-3">转变 3:从"独立开发"到"团队协作"</h3>
<p>你不是一个人在战斗</p>
<p>是的,独自完成小项目一开始感觉很好。但一旦进入专业领域,编码就变成了团队运动。作为 PHP 开发者,你经常会与前端开发者、数据库管理员、设计师,有时甚至是项目经理一起工作。你不再是一支单人军队——你是更大图景的一部分。</p>
<p><strong>技术实践:认真使用版本控制(Git)</strong></p>
<p>协作意味着共享代码和跟踪变更。这就是版本控制的用武之地。学习 Git 并使用 GitHub 或 GitLab 等平台将使你的代码协作顺畅高效。使用 Git,你可以跟踪变更、回退到以前的版本,并合并多个开发者的代码而不会混乱。</p>
<p>示例:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Initialize a new Git repository</span>
git init
<span class="hljs-comment"># Add files to the staging area</span>
git add .
<span class="hljs-comment"># Commit changes with a message</span>
git commit -m <span class="hljs-string">"Initial commit"</span>
<span class="hljs-comment"># Push changes to a remote repository</span>
git push origin main
</code></pre>
<p>Git 不仅适用于大型团队——它对个人项目也至关重要,因为它能帮你有效管理变更。与他人合作时,拉取请求和代码审查对于维护高质量代码至关重要。</p>
<h3 data-id="heading-4">转变 4:从"追逐流行框架"到"掌握基础"</h3>
<p>框架很有趣,但基础才是永恒的</p>
<p>Laravel、Symfony 和 CodeIgniter 等 PHP 框架很棒,但问题是:在深入研究任何框架之前,你需要对 PHP 本身有扎实的理解。在不理解基础的情况下直接跳入框架,就像在学会走路之前就想跑步。</p>
<p><strong>技术实践:从零开始构建项目</strong></p>
<p>在深入研究 Laravel 等框架之前,花时间使用纯 PHP 从零开始构建一个简单项目。例如,构建一个简单的 CRUD(创建、读取、更新、删除)应用,而不依赖任何框架。这将巩固你对以下内容的理解:</p>
<ul>
<li>路由</li>
<li>数据库交互</li>
<li>会话处理</li>
<li>用户认证</li>
</ul>
<p>示例:
以下是如何使用 PHP 和 MySQL 设置基本 CRUD 应用:</p>
<ol>
<li>创建数据库表:</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
  id <span class="hljs-type">INT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
  name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
  email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>)
);
</code></pre>
<ol start="2">
<li>使用 PHP 插入数据:</li>
</ol>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// Establish a connection</span>
<span class="hljs-variable">$conn</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mysqli</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-string">"username"</span>, <span class="hljs-string">"password"</span>, <span class="hljs-string">"database"</span>);
<span class="hljs-comment">// Check for connection error</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$conn</span>-&gt;connect_error) {
    <span class="hljs-keyword">die</span>(<span class="hljs-string">"Connection failed: "</span> . <span class="hljs-variable">$conn</span>-&gt;connect_error);
}
<span class="hljs-comment">// Insert data</span>
<span class="hljs-variable">$sql</span> = <span class="hljs-string">"INSERT INTO users (name, email) VALUES ('John Doe', 'john@example.com')"</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql</span>) === <span class="hljs-literal">TRUE</span>) {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"New record created successfully"</span>;
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Error: "</span> . <span class="hljs-variable">$sql</span> . <span class="hljs-string">"&lt;br&gt;"</span> . <span class="hljs-variable">$conn</span>-&gt;error;
}
<span class="hljs-variable">$conn</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();
</code></pre>
<p>在不使用框架的情况下构建项目将让你深入理解底层工作原理,这会让你在之后使用 Laravel 等框架时感觉轻松许多。</p>
<h3 data-id="heading-5">转变 5:从"一次性学习"到"持续学习"</h3>
<p>学习永无止境</p>
<p>如果你认为学完 PHP 和几个框架就"完成"了,那就再想想。技术世界发展迅速,作为专业开发者,你需要跟上步伐。优秀的 PHP 开发者不仅仅是知道如何写代码的人;而是不断进化、适应并保持好奇心的人。</p>
<p><strong>技术实践:关注 PHP 变更日志和博客</strong></p>
<p>及时了解 PHP 版本和最佳实践。订阅博客,关注 PHP 相关新闻,并阅读每个新版本发布的官方 PHP 变更日志。了解 PHP 8 中的新特性(如 JIT 和属性)将使你的代码保持现代和高效。</p>
<p>示例:
在 PHP 8 中,match 表达式可以成为 switch-case 的更简洁替代方案。如果你还没试过,现在就试试!</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$fruit</span> = <span class="hljs-string">'apple'</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-keyword">match</span>(<span class="hljs-variable">$fruit</span>) {
    <span class="hljs-string">'apple'</span> =&gt; <span class="hljs-string">'It'</span>s an apple!<span class="hljs-string">',
    '</span>banana<span class="hljs-string">' =&gt; '</span>It<span class="hljs-string">'s a banana!'</span>,
    <span class="hljs-keyword">default</span> =&gt; <span class="hljs-string">'Unknown fruit'</span>,
};
</code></pre>
<p>这种新语法更紧凑,消除了多个 case 语句的需要。</p>
<h3 data-id="heading-6">转变 6:从"快速修复"到"长期解决方案"</h3>
<p>写出你会引以为豪的代码(而不仅仅是能用的代码)</p>
<p>我们都经历过。紧迫的截止日期、压力,以及随便拼凑点东西的诱惑。但问题是:编写快速而粗糙的代码现在可能完成工作,但以后会反噬你。糟糕的代码会导致 bug、性能问题和巨大的麻烦。</p>
<p><strong>技术实践:编写可测试、可扩展的代码</strong></p>
<p>确保代码保持整洁和可扩展的一种方法是编写测试。使用 PHPUnit 进行单元测试来验证代码的每个部分是否按预期工作。</p>
<p>示例:
以下是一个简单的 PHPUnit 测试,用于测试计算购物车中商品总价的方法:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">TestCase</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShoppingCartTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testTotalPrice</span>(<span class="hljs-params"/>)
    </span>{
        <span class="hljs-variable">$cart</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShoppingCart</span>();
        <span class="hljs-variable">$cart</span>-&gt;<span class="hljs-title function_ invoke__">addItem</span>(<span class="hljs-string">'Apple'</span>, <span class="hljs-number">1.50</span>);
        <span class="hljs-variable">$cart</span>-&gt;<span class="hljs-title function_ invoke__">addItem</span>(<span class="hljs-string">'Banana'</span>, <span class="hljs-number">1.00</span>);
        
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">assertEquals</span>(<span class="hljs-number">2.50</span>, <span class="hljs-variable">$cart</span>-&gt;<span class="hljs-title function_ invoke__">getTotalPrice</span>());
    }
}
</code></pre>
<p>单元测试有助于尽早发现 bug,并确保在添加新功能时,现有功能不会出问题。</p>
<h3 data-id="heading-7">结语:转变思维,让你的 PHP 职业生涯腾飞</h3>
<p>成为 PHP 专业人士远不止于写代码——这关乎像问题解决者一样思考、深入理解你的工具、与他人协作,以及致力于持续成长。如果你今天开始进行这些思维转变,你将顺利成为一名抢手的 PHP 开发者。</p>
<p>所以,下次坐下来编码时,记住:这不仅仅是完成工作——而是以正确的方式、专业的方式去做。祝编码愉快!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python性能调优实战：5个不报错但拖慢代码300%的隐藏陷阱（附解决方案）]]></title>    <link>https://juejin.cn/post/7587776610436841487</link>    <guid>https://juejin.cn/post/7587776610436841487</guid>    <pubDate>2025-12-27T00:16:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587776610436841487" data-draft-id="7587776610436825103" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python性能调优实战：5个不报错但拖慢代码300%的隐藏陷阱（附解决方案）"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-27T00:16:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python性能调优实战：5个不报错但拖慢代码300%的隐藏陷阱（附解决方案）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T00:16:50.000Z" title="Sat Dec 27 2025 00:16:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Python性能调优实战：5个不报错但拖慢代码300%的隐藏陷阱（附解决方案）</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Python以其简洁易用的语法和强大的生态系统赢得了开发者的青睐。然而，这种“简单”背后往往隐藏着性能陷阱——许多看似无害的写法可能在不知不觉中让你的代码运行效率降低数倍。更棘手的是，这些陷阱通常不会引发错误，而是悄无声息地拖慢程序，直到你发现系统响应缓慢或资源耗尽时才意识到问题的严重性。</p>
<p>本文将揭示5个最常见的Python性能陷阱，它们可能让你的代码运行速度降低300%甚至更多。每个陷阱都会配以实际案例、原理分析和经过验证的优化方案。无论你是正在处理大型数据集的工程师，还是需要优化Web应用响应时间的开发者，这些实战经验都能帮助你写出更高效的Python代码。</p>
<hr/>
<h2 data-id="heading-2">陷阱1：不当使用字符串拼接</h2>
<h3 data-id="heading-3">问题现象</h3>
<p>在循环中使用<code>+</code>操作符拼接字符串是许多初学者的常见做法：</p>
<pre><code class="hljs language-python" lang="python">result = <span class="hljs-string">""</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10000</span>):
    result += <span class="hljs-built_in">str</span>(i)
</code></pre>
<h3 data-id="heading-4">为什么慢？</h3>
<ul>
<li>Python字符串是不可变对象，每次<code>+=</code>都会创建一个新对象并复制原内容</li>
<li>时间复杂度从O(n)恶化到O(n²)，实测在10万次拼接时比优化方案慢40倍</li>
</ul>
<h3 data-id="heading-5">解决方案</h3>
<p>使用<code>.join()</code>方法或IO缓冲区：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 方案1：直接生成列表后拼接</span>
parts = []
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10000</span>):
    parts.append(<span class="hljs-built_in">str</span>(i))
result = <span class="hljs-string">""</span>.join(parts)

<span class="hljs-comment"># 方案2：使用io.StringIO（适用于复杂场景）</span>
<span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO
buf = StringIO()
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10000</span>):
    buf.write(<span class="hljs-built_in">str</span>(i))
result = buf.getvalue()
</code></pre>
<hr/>
<h2 data-id="heading-6">陷阱2：频繁创建小型对象</h2>
<h3 data-id="heading-7">问题现象</h3>
<p>在热点路径中频繁创建小对象（如datetime、namedtuple）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_logs</span>(<span class="hljs-params">logs</span>):
    <span class="hljs-keyword">return</span> [datetime.strptime(log[<span class="hljs-string">'time'</span>], <span class="hljs-string">'%Y-%m-%d'</span>) <span class="hljs-keyword">for</span> log <span class="hljs-keyword">in</span> logs]
</code></pre>
<h3 data-id="heading-8">为什么慢？</h3>
<ul>
<li>Python对象创建需要内存分配和初始化开销</li>
<li>CPython的垃圾回收机制会增加额外负担</li>
</ul>
<h3 data-id="heading-9">解决方案</h3>
<p>采用对象池或缓存模式：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> lru_cache

<span class="hljs-meta">@lru_cache(<span class="hljs-params">maxsize=<span class="hljs-number">256</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_date</span>(<span class="hljs-params">date_str</span>):
    <span class="hljs-keyword">return</span> datetime.strptime(date_str, <span class="hljs-string">'%Y-%m-%d'</span>)

<span class="hljs-comment"># 或者对已知有限集合预先计算</span>
DATE_CACHE = {d: datetime.strptime(d, <span class="hljs-string">'%Y-%m-%d'</span>) 
              <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span>(log[<span class="hljs-string">'time'</span>] <span class="hljs-keyword">for</span> log <span class="hljs-keyword">in</span> logs)}
</code></pre>
<hr/>
<h2 data-id="heading-10">陷阱3：过度依赖Python层循环</h2>
<h3 data-id="heading-11">问题现象</h3>
<p>用纯Python实现数值计算：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_pi</span>(<span class="hljs-params">n_terms</span>):
    numerator = <span class="hljs-number">4.0</span>
    denominator = <span class="hljs-number">1.0</span>
    operation = <span class="hljs-number">1.0</span>
    pi = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_terms):
        pi += operation * (numerator / denominator)
        denominator += <span class="hljs-number">2.0</span>
        operation *= -<span class="hljs-number">1.0</span>
    <span class="hljs-keyword">return</span> pi
</code></pre>
<h3 data-id="heading-12">为什么慢？</h3>
<ul>
<li>Python解释器执行字节码的速度远低于机器原生指令</li>
<li>CPython的全局解释器锁(GIL)限制多线程并行</li>
</ul>
<h3 data-id="heading-13">解决方案</h3>
<p>使用NumPy或Numba进行向量化运算：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_pi_vec</span>(<span class="hljs-params">n_terms</span>):
    k = np.arange(n_terms)
    <span class="hljs-keyword">return</span> np.<span class="hljs-built_in">sum</span>(<span class="hljs-number">4.0</span> * (-<span class="hljs-number">1</span>)**k / (<span class="hljs-number">2</span>*k + <span class="hljs-number">1</span>))

<span class="hljs-comment"># Numba即时编译版（首次运行有编译开销）</span>
<span class="hljs-keyword">from</span> numba <span class="hljs-keyword">import</span> jit
<span class="hljs-meta">@jit(<span class="hljs-params">nopython=<span class="hljs-literal">True</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_pi_jit</span>(<span class="hljs-params">n_terms</span>): ... <span class="hljs-comment"># Same as original function</span>
</code></pre>
<hr/>
<h2 data-id="heading-14">陷阱4：忽略内置函数的高效实现</h2>
<h3 data-id="heading-15">问题现象</h3>
<p>手动实现本可用内置函数完成的操作：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Case1: Filtering with explicit loop</span>
filtered = []
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> items:
    <span class="hljs-keyword">if</span> condition(x):
        filtered.append(x)

<span class="hljs-comment"># Case2: Custom max implementation </span>
max_val = items[<span class="hljs-number">0</span>]
<span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> items[<span class="hljs-number">1</span>:]:
    <span class="hljs-keyword">if</span> x &gt; max_val:
        max_val = x 
</code></pre>
<h3 data-id="heading-16">为什么慢？</h3>
<ul>
<li>CPython的内置函数是用C实现的（如<code>filter()</code>、<code>max()</code>）</li>
<li>Python层面的循环有解释器开销</li>
</ul>
<h3 data-id="heading-17">Solutions:</h3>
<p>Always prefer builtins when possible:</p>
<pre><code class="hljs language-python" lang="python">filtered = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">filter</span>(condition, items)) 
<span class="hljs-comment"># Or generator expression:</span>
filtered = (x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> items <span class="hljs-keyword">if</span> condition(x))

max_val = <span class="hljs-built_in">max</span>(items) <span class="hljs-comment"># Also works with key function </span>
</code></pre>
<hr/>
<h2 data-id="heading-18">Trap5: Unnecessary Data Copies</h2>
<h3 data-id="heading-19">Problem Pattern</h3>
<p>Creating intermediate copies without awareness:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">normalize_matrix</span>(<span class="hljs-params">mat</span>):
    row_sums = [<span class="hljs-built_in">sum</span>(row) <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> mat]      <span class="hljs-comment"># First pass </span>
    <span class="hljs-keyword">return</span> [[val/sum_ <span class="hljs-keyword">for</span> val <span class="hljs-keyword">in</span> row]         <span class="hljs-comment"># Second pass   </span>
            <span class="hljs-keyword">for</span> row, sum_ <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(mat, row_sums)]
            
<span class="hljs-comment"># Even worse with slicing:</span>
new_list = original_list[:]   <span class="hljs-comment"># Full shallow copy </span>
</code></pre>
<h3 data-id="heading-20">Why Slow?</h3>
<ul>
<li>Memory allocation and copying overhead grows linearly with data size</li>
<li>Cache locality suffers due to multiple passes</li>
</ul>
<h3 data-id="heading-21">Optimization Strategies:</h3>
<p>Use generators/views instead of materialized copies:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Single-pass iterator version </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">normalize_matrix</span>(<span class="hljs-params">mat</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">normalized_rows</span>():
        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> mat:
            sum_ = <span class="hljs-built_in">sum</span>(row)
            <span class="hljs-keyword">yield</span> [val/sum_ <span class="hljs-keyword">for</span> val <span class="hljs-keyword">in</span> row]
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(normalized_rows())

<span class="hljs-comment"># For numpy arrays use views instead of copies:</span>
arr[:, :<span class="hljs-number">10</span>]   <span class="hljs-comment"># This creates a view, not a copy </span>
</code></pre>
<hr/>
<h2 data-id="heading-22">Conclusion</h2>
<p>Performance optimization in Python requires understanding both the language's abstractions and its underlying implementation details. The five traps we've examined share common themes:</p>
<ol>
<li>Leveraging Python's C-based builtins instead of pure-Python loops</li>
<li>Minimizing object creation overhead through caching/reuse</li>
<li>Avoiding unnecessary data duplication</li>
<li>Utilizing vectorized operations where applicable</li>
</ol>
<p>The key insight is that <strong>idiomatic Python isn't always performant Python</strong>. By combining these techniques with profiling tools like cProfile and line_profiler, you can systematically eliminate bottlenecks while maintaining code readability.</p>
<p>Remember that not all code needs optimization - focus on hotspots identified through profiling to get maximum returns from your efforts. When done correctly, these optimizations can yield speedups of <strong>300% or more</strong> with minimal code changes.</p>
<p>Ultimately, writing high-performance Python is about working with the language's strengths rather than against them - using compiled extensions when necessary, embracing generators and views for memory efficiency, and letting well-optimized libraries handle heavy lifting wherever possible.</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[NormalBlend节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7588086766235861030</link>    <guid>https://juejin.cn/post/7588086766235861030</guid>    <pubDate>2025-12-27T00:29:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766235861030" data-draft-id="7588031908171137033" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[NormalBlend节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2025-12-27T00:29:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[NormalBlend节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-27T00:29:34.000Z" title="Sat Dec 27 2025 00:29:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<h2 data-id="heading-0">法线混合技术概述</h2>
<p>在实时渲染中，法线贴图混合是增强表面细节表现的重要技术。Unity URP管线内置的NormalBlend节点通过数学运算实现两张法线贴图的平滑过渡，同时确保法线向量的物理正确性。该技术广泛应用于角色装备切换、地形材质融合、动态形变效果等场景，是现代游戏开发中不可或缺的材质处理工具。</p>
<h2 data-id="heading-1">节点核心功能解析</h2>
<h3 data-id="heading-2">混合模式选择</h3>
<p>NormalBlend节点提供两种混合算法：</p>
<ol>
<li><strong>Default模式</strong>：采用分量混合策略，对法线贴图的RG通道进行加法混合，B通道进行乘法混合，最后通过标准化处理确保输出为单位向量。适用于简单表面细节的叠加，例如角色装备纹理的混合。</li>
<li><strong>Reoriented模式</strong>：通过重新定向算法维持法线方向一致性，采用齐次坐标系转换与向量投影计算，确保混合结果符合物理光照模型。适用于复杂表面处理，如布料模拟与动态形变效果。</li>
</ol>
<h3 data-id="heading-3">端口与参数配置</h3>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.shadergraph@14.0/manual/images/NormalBlendNodeThumb.png" alt="" loading="lazy"/></p>
<ul>
<li><strong>输入端口</strong>：
<ul>
<li>A：接收第一张法线贴图数据（Vector3类型）</li>
<li>B：接收第二张法线贴图数据（Vector3类型）</li>
</ul>
</li>
<li><strong>输出端口</strong>：
<ul>
<li>Out：输出混合后的标准化法线向量（Vector3类型）</li>
</ul>
</li>
<li><strong>控件参数</strong>：
<ul>
<li>Mode：混合模式选择器（Default/Reoriented）</li>
</ul>
</li>
</ul>
<h2 data-id="heading-4">技术实现原理</h2>
<h3 data-id="heading-5">法线混合数学基础</h3>
<p>法线向量是表示表面朝向的数学实体，其核心属性包括：</p>
<ul>
<li>单位向量性质：长度必须保持为1</li>
<li>插值特性：在片段着色器中由顶点法线插值获得</li>
<li>空间转换：可通过矩阵运算在不同坐标系间转换</li>
</ul>
<h3 data-id="heading-6">标准化处理流程</h3>
<p>混合后的法线向量必须经过标准化处理，以确保：</p>
<ol>
<li>光照计算的准确性</li>
<li>阴影生成的正确性</li>
<li>表面交互的真实性</li>
</ol>
<h3 data-id="heading-7">坐标空间转换机制</h3>
<p>NormalBlend节点自动处理切线空间到世界空间的转换：</p>
<ul>
<li>输入法线默认为切线空间坐标</li>
<li>输出法线根据材质设置自动转换至目标空间</li>
<li>支持对象空间、视图空间、世界空间和切线空间输出</li>
</ul>
<h2 data-id="heading-8">典型应用场景与实现</h2>
<h3 data-id="heading-9">角色装备法线混合</h3>
<p><strong>实现步骤</strong>：</p>
<ol>
<li>准备角色基础法线贴图（A）</li>
<li>准备装备法线贴图（B）</li>
<li>使用Default模式进行混合</li>
<li>通过材质参数控制混合强度</li>
</ol>
<p><strong>优化技巧</strong>：</p>
<ul>
<li>使用纹理采样节点控制混合区域</li>
<li>结合遮罩贴图实现非均匀混合</li>
<li>在关键区域采用Reoriented模式维持方向一致性</li>
</ul>
<h3 data-id="heading-10">地形法线混合</h3>
<p><strong>实现步骤</strong>：</p>
<ol>
<li>准备两种地形材质法线贴图（A和B）</li>
<li>创建混合遮罩纹理</li>
<li>根据遮罩值动态调整混合比例</li>
<li>使用Reoriented模式处理复杂过渡</li>
</ol>
<p><strong>优化技巧</strong>：</p>
<ul>
<li>使用渐变纹理控制混合区域</li>
<li>结合高度图实现物理正确的混合</li>
<li>在斜坡区域增强混合强度</li>
</ul>
<h3 data-id="heading-11">动态变形法线处理</h3>
<p><strong>实现步骤</strong>：</p>
<ol>
<li>准备基础法线贴图（A）</li>
<li>准备变形影响法线贴图（B）</li>
<li>根据变形参数动态调整混合强度</li>
<li>使用Reoriented模式保持方向一致性</li>
</ol>
<p><strong>优化技巧</strong>：</p>
<ul>
<li>结合顶点动画参数控制混合</li>
<li>使用噪声纹理丰富细节</li>
<li>在形变剧烈区域增加混合强度</li>
</ul>
<h2 data-id="heading-12">性能优化策略</h2>
<h3 data-id="heading-13">模式选择优化</h3>
<ul>
<li>优先使用Default模式：性能开销较小，适合简单混合</li>
<li>复杂表面使用Reoriented模式：维持方向一致性</li>
<li>混合强度控制：通过材质参数或遮罩贴图动态调整</li>
</ul>
<h3 data-id="heading-14">计算资源优化</h3>
<ul>
<li>限制混合区域：使用遮罩贴图约束混合范围</li>
<li>简化混合模式：在非关键区域采用Default模式</li>
<li>预计算混合：在材质编辑器中预先计算部分结果</li>
</ul>
<h3 data-id="heading-15">平台兼容性优化</h3>
<ul>
<li>URP与HDRP差异：URP采用简化光照模型，HDRP支持物理精确材质</li>
<li>版本兼容性：不同Unity版本对ShaderGraph节点的支持可能存在差异</li>
<li>目标平台：移动端优先选用Default模式以降低计算量</li>
</ul>
<h2 data-id="heading-16">常见问题解决方案</h2>
<h3 data-id="heading-17">混合后出现伪影</h3>
<p><strong>原因</strong>：</p>
<ul>
<li>混合区域边界处理不当</li>
<li>法线方向不一致</li>
<li>混合强度过高</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用遮罩贴图平滑过渡</li>
<li>在关键区域切换至Reoriented模式</li>
<li>降低混合强度或扩展混合区域</li>
</ul>
<h3 data-id="heading-18">性能下降明显</h3>
<p><strong>原因</strong>：</p>
<ul>
<li>混合区域过大</li>
<li>采用复杂混合模式</li>
<li>在移动端使用高精度混合</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>缩小混合区域</li>
<li>在非关键区域使用Default模式</li>
<li>针对移动端优化混合参数</li>
</ul>
<h3 data-id="heading-19">光照表现异常</h3>
<p><strong>原因</strong>：</p>
<ul>
<li>混合后法线未正确标准化</li>
<li>混合模式选择不当</li>
<li>法线贴图格式有误</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>确保输出法线经过标准化处理</li>
<li>根据表面复杂度选择合适的混合模式</li>
<li>检查法线贴图格式与生成方式</li>
</ul>
<h2 data-id="heading-20">进阶应用案例</h2>
<h3 data-id="heading-21">多层级法线混合</h3>
<p><strong>实现方法</strong>：</p>
<ol>
<li>构建多个混合层级</li>
<li>使用遮罩贴图控制各层级混合区域</li>
<li>逐层混合法线贴图</li>
</ol>
<p><strong>优势</strong>：</p>
<ul>
<li>实现更复杂的表面细节</li>
<li>可调控不同区域的混合强度</li>
<li>提升材质表现力</li>
</ul>
<h3 data-id="heading-22">动态法线混合系统</h3>
<p><strong>实现方法</strong>：</p>
<ol>
<li>依据动画参数动态调整混合强度</li>
<li>使用噪声纹理增添动态细节</li>
<li>结合顶点动画实现物理正确的混合</li>
</ol>
<p><strong>应用场景</strong>：</p>
<ul>
<li>角色表情变化</li>
<li>布料模拟</li>
<li>动态环境变化</li>
</ul>
<h3 data-id="heading-23">材质系统集成方案</h3>
<p><strong>实现方法</strong>：</p>
<ol>
<li>将混合参数暴露给材质系统</li>
<li>创建材质参数集合以控制混合行为</li>
<li>实现动态材质切换</li>
</ol>
<p><strong>优势</strong>：</p>
<ul>
<li>增强材质系统的灵活性</li>
<li>支持运行时动态调整</li>
<li>简化美术工作流程</li>
</ul>
<h2 data-id="heading-24">最佳实践总结</h2>
<ol>
<li><strong>模式选择原则</strong>：简单表面使用Default模式，复杂表面使用Reoriented模式</li>
<li><strong>性能优化优先级</strong>：移动端优先考虑性能，PC端可适度增加细节</li>
<li><strong>质量保障措施</strong>：使用标准化工具验证混合结果，确保法线方向正确</li>
<li><strong>迭代开发流程</strong>：从简单混合起步，逐步提升复杂度，并持续验证效果</li>
</ol>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（5）什么是Hibernate的配置文件？]]></title>    <link>https://juejin.cn/post/7588064253634953270</link>    <guid>https://juejin.cn/post/7588064253634953270</guid>    <pubDate>2025-12-26T23:05:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588064253634953270" data-draft-id="7588001624905695251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（5）什么是Hibernate的配置文件？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T23:05:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（5）什么是Hibernate的配置文件？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T23:05:10.000Z" title="Fri Dec 26 2025 23:05:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hibernate的配置文件是用于定义Hibernate的各种配置参数的文件，包括数据库连接信息、Hibernate属性、映射资源、缓存配置等。Hibernate主要使用两种配置文件：</p>
<ol>
<li><strong><code>hibernate.cfg.xml</code></strong>：XML格式的配置文件。</li>
<li><strong><code>hibernate.properties</code></strong>：属性格式的配置文件。</li>
</ol>
<h3 data-id="heading-0">1. <code>hibernate.cfg.xml</code> 配置文件</h3>
<p><code>hibernate.cfg.xml</code> 是一个XML格式的配置文件，用于定义Hibernate的各种配置参数，包括数据库连接信息、Hibernate属性配置、映射资源等。它是Hibernate配置中最常用的文件。</p>
<h4 data-id="heading-1">主要功能：</h4>
<ul>
<li>配置数据库连接属性。</li>
<li>配置Hibernate相关属性（如方言、缓存、日志等）。</li>
<li>配置实体类的映射信息。</li>
</ul>
<h4 data-id="heading-2">示例：</h4>
<p>以下是一个详细的<code>hibernate.cfg.xml</code>文件示例：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 二级缓存配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.cache.use_second_level_cache"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.cache.region.factory_class"</span>&gt;</span>org.hibernate.cache.ehcache.EhCacheRegionFactory<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 查询缓存配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.cache.use_query_cache"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 连接池配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.min_size"</span>&gt;</span>5<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.max_size"</span>&gt;</span>20<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.timeout"</span>&gt;</span>300<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.max_statements"</span>&gt;</span>50<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.c3p0.idle_test_period"</span>&gt;</span>3000<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Student"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Course"</span>/&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">详细说明：</h4>
<ul>
<li><strong>数据库连接配置</strong>：定义了如何连接数据库，包括数据库驱动类、URL、用户名和密码。</li>
<li><strong>Hibernate属性配置</strong>：配置Hibernate的行为，包括SQL方言、是否显示SQL、SQL格式化选项等。</li>
<li><strong>二级缓存配置</strong>：启用二级缓存并指定缓存的实现。</li>
<li><strong>查询缓存配置</strong>：启用查询缓存。</li>
<li><strong>连接池配置</strong>：配置连接池的行为，如最小连接数、最大连接数、超时时间等。</li>
<li><strong>映射类配置</strong>：指定Hibernate需要管理的实体类。</li>
</ul>
<h3 data-id="heading-4">2. <code>hibernate.properties</code> 配置文件</h3>
<p><code>hibernate.properties</code> 是一个属性文件格式的配置文件，用于定义Hibernate的各种配置参数。它的内容相对简单直接，但不如XML格式的配置文件结构化和可读性强。</p>
<h4 data-id="heading-5">示例：</h4>
<p>以下是一个详细的<code>hibernate.properties</code>文件示例：</p>
<pre><code class="hljs language-properties" lang="properties"># 数据库连接配置
hibernate.connection.driver_class = com.mysql.cj.jdbc.Driver
hibernate.connection.url = jdbc:mysql://localhost:3306/your_database
hibernate.connection.username = your_username
hibernate.connection.password = your_password

# Hibernate 属性配置
hibernate.dialect = org.hibernate.dialect.MySQLDialect
hibernate.show_sql = true
hibernate.format_sql = true
hibernate.hbm2ddl.auto = update

# 二级缓存配置
hibernate.cache.use_second_level_cache = true
hibernate.cache.region.factory_class = org.hibernate.cache.ehcache.EhCacheRegionFactory

# 查询缓存配置
hibernate.cache.use_query_cache = true

# 连接池配置
hibernate.c3p0.min_size = 5
hibernate.c3p0.max_size = 20
hibernate.c3p0.timeout = 300
hibernate.c3p0.max_statements = 50
hibernate.c3p0.idle_test_period = 3000
</code></pre>
<h3 data-id="heading-6">使用示例</h3>
<p>结合上述配置文件，我们可以用以下代码进行Hibernate的初始化和使用：</p>
<h4 data-id="heading-7">Java代码示例：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 创建SessionFactory</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();

        <span class="hljs-comment">// 创建并保存学生对象</span>
        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">20</span>);
        session.save(student);

        transaction.commit();

        <span class="hljs-comment">// 读取学生对象</span>
        transaction = session.beginTransaction();
        <span class="hljs-type">Student</span> <span class="hljs-variable">retrievedStudent</span> <span class="hljs-operator">=</span> session.get(Student.class, student.getId());
        System.out.println(<span class="hljs-string">"Retrieved Student: "</span> + retrievedStudent.getName() + <span class="hljs-string">", Age: "</span> + retrievedStudent.getAge());
        transaction.commit();

        <span class="hljs-comment">// 更新学生对象</span>
        transaction = session.beginTransaction();
        retrievedStudent.setAge(<span class="hljs-number">21</span>);
        session.update(retrievedStudent);
        transaction.commit();

        <span class="hljs-comment">// 删除学生对象</span>
        transaction = session.beginTransaction();
        session.delete(retrievedStudent);
        transaction.commit();

        session.close();
        sessionFactory.close();
    }
}
</code></pre>
<h3 data-id="heading-8">详细解释</h3>
<ol>
<li>
<p><strong>持久化类定义</strong>：持久化类<code>Student</code>使用了<code>@Entity</code>注解表示这是一个持久化实体类，<code>@Id</code>和<code>@GeneratedValue</code>注解用于定义主键和主键生成策略。</p>
</li>
<li>
<p><strong><code>hibernate.cfg.xml</code> 配置</strong>：在配置文件中，通过<code>&lt;mapping class="com.example.domain.Student"/&gt;</code>将<code>Student</code>类映射到数据库表。</p>
</li>
<li>
<p><strong>Hibernate操作</strong>：</p>
<ul>
<li><strong>创建SessionFactory</strong>：通过<code>Configuration</code>类读取<code>hibernate.cfg.xml</code>文件创建<code>SessionFactory</code>。</li>
<li><strong>获取Session</strong>：通过<code>SessionFactory</code>获取<code>Session</code>对象。</li>
<li><strong>启动事务</strong>：通过<code>Session</code>对象启动事务。</li>
<li><strong>CRUD操作</strong>：
<ul>
<li><strong>创建并保存</strong>：使用<code>session.save()</code>方法保存一个新的<code>Student</code>对象。</li>
<li><strong>读取</strong>：使用<code>session.get()</code>方法根据主键读取<code>Student</code>对象。</li>
<li><strong>更新</strong>：修改对象的属性值并使用<code>session.update()</code>方法进行更新。</li>
<li><strong>删除</strong>：使用<code>session.delete()</code>方法删除对象。</li>
</ul>
</li>
<li><strong>提交事务</strong>：通过<code>transaction.commit()</code>方法提交事务。</li>
</ul>
</li>
</ol>
<p>通过这种方式，Hibernate可以将Java对象持久化到数据库中，处理对象的CRUD操作，实现对象与数据库表之间的映射和管理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（6） Hibernate支持哪些数据库？]]></title>    <link>https://juejin.cn/post/7588064253635002422</link>    <guid>https://juejin.cn/post/7588064253635002422</guid>    <pubDate>2025-12-26T23:06:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588064253635002422" data-draft-id="7588064253634969654" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（6） Hibernate支持哪些数据库？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T23:06:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（6） Hibernate支持哪些数据库？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T23:06:38.000Z" title="Fri Dec 26 2025 23:06:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hibernate是一个强大的对象关系映射（ORM）框架，支持多种不同的关系型数据库。其主要优势之一是能够在应用代码中使用相同的API，而无需关心底层数据库的具体实现。Hibernate通过方言（Dialect）来适配不同的数据库。</p>
<h3 data-id="heading-0">常见的支持数据库及其方言</h3>
<p>以下是Hibernate支持的一些常见数据库及其相应的方言：</p>
<ol>
<li><strong>MySQL</strong> - <code>org.hibernate.dialect.MySQLDialect</code></li>
<li><strong>PostgreSQL</strong> - <code>org.hibernate.dialect.PostgreSQLDialect</code></li>
<li><strong>Oracle</strong> - <code>org.hibernate.dialect.OracleDialect</code></li>
<li><strong>Microsoft SQL Server</strong> - <code>org.hibernate.dialect.SQLServerDialect</code></li>
<li><strong>SQLite</strong> - <code>org.hibernate.dialect.SQLiteDialect</code></li>
<li><strong>H2</strong> - <code>org.hibernate.dialect.H2Dialect</code></li>
<li><strong>DB2</strong> - <code>org.hibernate.dialect.DB2Dialect</code></li>
<li><strong>Informix</strong> - <code>org.hibernate.dialect.InformixDialect</code></li>
<li><strong>Sybase</strong> - <code>org.hibernate.dialect.SybaseDialect</code></li>
<li><strong>HSQLDB (HyperSQL)</strong> - <code>org.hibernate.dialect.HSQLDialect</code></li>
</ol>
<h3 data-id="heading-1">配置示例</h3>
<p>我们通过不同的数据库配置来展示如何在Hibernate中使用这些方言。</p>
<h4 data-id="heading-2">1. MySQL 配置示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Student"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">2. PostgreSQL 配置示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>org.postgresql.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:postgresql://localhost:5432/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.PostgreSQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Student"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">3. Oracle 配置示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>oracle.jdbc.driver.OracleDriver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:oracle:thin:@localhost:1521:xe<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.OracleDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Student"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">4. Microsoft SQL Server 配置示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.microsoft.sqlserver.jdbc.SQLServerDriver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:sqlserver://localhost;databaseName=your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.SQLServerDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Student"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">5. SQLite 配置示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>org.sqlite.JDBC<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:sqlite:your_database.db<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.SQLiteDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Student"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">常见配置参数说明</h3>
<ul>
<li><strong>hibernate.connection.driver_class</strong>: JDBC驱动类名。</li>
<li><strong>hibernate.connection.url</strong>: 数据库连接URL。</li>
<li><strong>hibernate.connection.username</strong>: 数据库用户名。</li>
<li><strong>hibernate.connection.password</strong>: 数据库密码。</li>
<li><strong>hibernate.dialect</strong>: 数据库方言，Hibernate根据方言生成特定于数据库的SQL语句。</li>
<li><strong>mapping class</strong>: 要映射的实体类。</li>
</ul>
<h3 data-id="heading-8">使用示例</h3>
<p>结合上述配置文件，我们可以用以下代码进行Hibernate的初始化和使用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 创建SessionFactory</span>
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SessionFactory <span class="hljs-title function_">getSessionFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> sessionFactory;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">SessionFactory</span> <span class="hljs-variable">sessionFactory</span> <span class="hljs-operator">=</span> HibernateUtil.getSessionFactory();
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();

        <span class="hljs-comment">// 创建并保存学生对象</span>
        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">"John Doe"</span>, <span class="hljs-number">20</span>);
        session.save(student);

        transaction.commit();

        <span class="hljs-comment">// 读取学生对象</span>
        transaction = session.beginTransaction();
        <span class="hljs-type">Student</span> <span class="hljs-variable">retrievedStudent</span> <span class="hljs-operator">=</span> session.get(Student.class, student.getId());
        System.out.println(<span class="hljs-string">"Retrieved Student: "</span> + retrievedStudent.getName() + <span class="hljs-string">", Age: "</span> + retrievedStudent.getAge());
        transaction.commit();

        <span class="hljs-comment">// 更新学生对象</span>
        transaction = session.beginTransaction();
        retrievedStudent.setAge(<span class="hljs-number">21</span>);
        session.update(retrievedStudent);
        transaction.commit();

        <span class="hljs-comment">// 删除学生对象</span>
        transaction = session.beginTransaction();
        session.delete(retrievedStudent);
        transaction.commit();

        session.close();
        sessionFactory.close();
    }
}
</code></pre>
<h3 data-id="heading-9">总结</h3>
<p>通过配置不同的方言，Hibernate可以支持多种数据库。开发者只需修改配置文件中的方言和数据库连接信息，即可切换到不同的数据库而无需改变应用代码。Hibernate的这种设计极大地提高了应用程序的可移植性和灵活性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第十六章(font字体)]]></title>    <link>https://juejin.cn/post/7587997157237571636</link>    <guid>https://juejin.cn/post/7587997157237571636</guid>    <pubDate>2025-12-26T21:54:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587997157237571636" data-draft-id="7588010346070638602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第十六章(font字体)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-12-26T21:54:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第十六章(font字体)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T21:54:15.000Z" title="Fri Dec 26 2025 21:54:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">font字体</h2>
<p><code>next/font</code>模块，内置了字体优化功能，其目的是防止<code>CLS</code>布局偏移。font模块主要分为两部分，一部分是内置的<code>Google Fonts</code>字体，另一部分是本地字体。</p>
<h4 data-id="heading-1">基本用法</h4>
<h5 data-id="heading-2">Goggle字体</h5>
<p>在使用google字体的时候，Google字体和css文件会在构建的时候下载到本地，可以与静态资源一起托管到服务器，所以不会向Google发送请求。</p>
<ol>
<li>基本使用</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { BBH_Sans_Hegarty } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/font/google'</span> <span class="hljs-comment">//引入字体库</span>
<span class="hljs-keyword">const</span> bbhSansHegarty = <span class="hljs-title function_">BBH_Sans_Hegarty</span>({
  <span class="hljs-attr">weight</span>: <span class="hljs-string">'400'</span>, <span class="hljs-comment">//字体粗细</span>
  <span class="hljs-attr">display</span>: <span class="hljs-string">'swap'</span>, <span class="hljs-comment">//字体显示方式</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{ children }: Readonly&lt;{ children: React.ReactNode }&gt;</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{bbhSansHegarty.className}</span>&gt;</span> {/** bbhSansHegarty会返回一个类名，用于加载字体 */}
        {children}
        sdsadasdjsalkdjasl
        你好
      <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  );
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcefd9c6f27540ecb6b8baf82cea3320~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767390855&amp;x-signature=Zw4b%2BVpblJHbxPR9mqpMWqPKqV4%3D" alt="google.png" loading="lazy"/></p>
<ol start="2">
<li>可变字体</li>
</ol>
<p>可变字体是一种可以适应不同字重和样式的字体，它可以在不同的设备上自动调整字体大小和样式，以适应不同的屏幕大小和分辨率。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Roboto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/font/google'</span>
<span class="hljs-keyword">const</span> roboto = <span class="hljs-title class_">Roboto</span>({
  <span class="hljs-attr">weight</span>: [<span class="hljs-string">'400'</span>, <span class="hljs-string">'700'</span>], <span class="hljs-comment">//字体粗细 (不是所有字体都支持可变字体)</span>
  <span class="hljs-attr">style</span>: [<span class="hljs-string">'normal'</span>, <span class="hljs-string">'italic'</span>], <span class="hljs-comment">//字体样式   </span>
  <span class="hljs-attr">subsets</span>: [<span class="hljs-string">'latin'</span>],
  <span class="hljs-attr">display</span>: <span class="hljs-string">'swap'</span>,
})
</code></pre>
<p>如何选择其他字体？可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Ffonts.google.com%2F" target="_blank" title="https://fonts.google.com/" ref="nofollow noopener noreferrer">Google Fonts</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e9ca54c48d442008bf9ed53a7ae0d64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767390855&amp;x-signature=ObOKJs3LM3bAhaSQm%2B6tFMwxO0s%3D" alt="web.png" loading="lazy"/></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Inter</span>,BBH_Sans_Bartle,<span class="hljs-title class_">Roboto</span>_Slab,<span class="hljs-title class_">Rubik</span>,<span class="hljs-title class_">Montserrat</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/font/google'</span> <span class="hljs-comment">//引入其他字体库</span>
</code></pre>
<h4 data-id="heading-3">API 参考</h4>
<h4 data-id="heading-4">配置选项</h4>





































































































<table><thead><tr><th>属性</th><th>Google</th><th>本地</th><th>类型</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td><code>src</code></td><td>✗</td><td>✓</td><td>String/Array</td><td>是</td><td>字体文件路径</td></tr><tr><td><code>weight</code></td><td>✓</td><td>✓</td><td>String/Array</td><td>可选</td><td>字体粗细，如 '400'</td></tr><tr><td><code>style</code></td><td>✓</td><td>✓</td><td>String/Array</td><td>-</td><td>字体样式，如 'normal'</td></tr><tr><td><code>subsets</code></td><td>✓</td><td>✗</td><td>Array</td><td>-</td><td>字符子集</td></tr><tr><td><code>axes</code></td><td>✓</td><td>✗</td><td>Array</td><td>-</td><td>可变字体轴</td></tr><tr><td><code>display</code></td><td>✓</td><td>✓</td><td>String</td><td>-</td><td>显示策略</td></tr><tr><td><code>preload</code></td><td>✓</td><td>✓</td><td>Boolean</td><td>-</td><td>是否预加载</td></tr><tr><td><code>fallback</code></td><td>✓</td><td>✓</td><td>Array</td><td>-</td><td>备用字体</td></tr><tr><td><code>adjustFontFallback</code></td><td>✓</td><td>✓</td><td>Boolean/String</td><td>-</td><td>调整备用字体</td></tr><tr><td><code>variable</code></td><td>✓</td><td>✓</td><td>String</td><td>-</td><td>CSS 变量</td></tr><tr><td><code>declarations</code></td><td>✗</td><td>✓</td><td>Array</td><td>-</td><td>自定义声明</td></tr></tbody></table>
<h5 data-id="heading-5">style</h5>
<p>字体样式，如 'normal' 'italic（斜体）' 'oblique（倾斜）' 等。</p>
<h5 data-id="heading-6">weight</h5>
<p>字体粗细，如 '400' '700' '900' 等。</p>
<h5 data-id="heading-7">display</h5>
<p><strong>auto</strong>：浏览器默认（通常为 block）</p>
<p><strong>block</strong>：空白 3s → 备用字体 → 自定义字体</p>
<p><strong>swap</strong>：备用字体 → 自定义字体</p>
<p><strong>fallback</strong>：空白 100ms → 备用字体，3s 内加载完成则切换</p>
<p><strong>optional</strong>：空白 100ms，100ms 内加载完成则使用，否则用备用字体</p>
<h5 data-id="heading-8">本地字体</h5>
<p>字体下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs-docs-henna-six.vercel.app%2FZhiyongDatongFont.ttf" target="_blank" title="https://nextjs-docs-henna-six.vercel.app/ZhiyongDatongFont.ttf" ref="nofollow noopener noreferrer">免费可商用字体</a></p>
<p>本地字体需要通过<code>src</code>属性指定字体文件路径，字体文件路径可以是单个文件，也可以是多个文件。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> localFont <span class="hljs-keyword">from</span> <span class="hljs-string">'next/font/local'</span>
<span class="hljs-keyword">const</span> local = <span class="hljs-title function_">localFont</span>({
  <span class="hljs-attr">src</span>:<span class="hljs-string">'./font/zydtt.ttf'</span>, <span class="hljs-comment">//本地字体文件路径</span>
  <span class="hljs-attr">display</span>: <span class="hljs-string">'swap'</span>, <span class="hljs-comment">//字体显示方式</span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{ children }: Readonly&lt;{ children: React.ReactNode }&gt;</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{local.className}</span>&gt;</span>
        {children}
        sdsadasdjsalkdjasl
        你好
      <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  );
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bb7fb89090e41c390d7abe5f29ae5ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767390855&amp;x-signature=Ei%2BKONlI6FK%2Fjz5etg4BCPSrSDU%3D" alt="local.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第十七章(Script脚本)]]></title>    <link>https://juejin.cn/post/7588031908171071497</link>    <guid>https://juejin.cn/post/7588031908171071497</guid>    <pubDate>2025-12-26T22:01:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588031908171071497" data-draft-id="7587997157237588020" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第十七章(Script脚本)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-12-26T22:01:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第十七章(Script脚本)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T22:01:10.000Z" title="Fri Dec 26 2025 22:01:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Script组件</h2>
<p>Next.js允许我们使用Script组件去加载js脚本(外部/本地脚本)，并且他还对Script组件进行优化。</p>
<h4 data-id="heading-1">基本使用</h4>
<h5 data-id="heading-2">局部引入</h5>
<p>src/app/home/page.tsx</p>
<p>在home路由引入一个远程的js脚本，他只会在切换到home路由时才会加载，并且只会加载一次，然后纳入缓存。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Script</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/script'</span> <span class="hljs-comment">//引入Script组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HomePage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/vue@3/dist/vue.global.js"</span> /&gt;</span><span class="xml">
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span></span>
    )
}
</code></pre>
<p>他的底层原理会把这个<code>Script</code>组件转换成<code>&lt;script&gt;</code>标签，然后插入到<code>&lt;head&gt;</code>标签中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b46cb2a31d4a40c5bb4c280642d449ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767391270&amp;x-signature=8FpB%2BRbdoa5Xu1eD6NBbkKy2eUc%3D" alt="head.png" loading="lazy"/></p>
<h5 data-id="heading-3">全局引入</h5>
<p>src/app/layout.tsx</p>
<p>全局引入直接在app/layout.tsx中引入，他会自动在所有页面中引入，并且只会加载一次，然后纳入缓存。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Script</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/script'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{ children }: { children: React.ReactNode }</span>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/vue@3/dist/vue.global.js"</span> /&gt;</span><span class="xml">
            <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
                {children}
            <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span></span>
    )
}
</code></pre>
<h5 data-id="heading-4">加载策略</h5>
<p>Next.js允许我们通过<code>strategy</code>属性来控制<code>Script</code>组件的加载策略。</p>
<ul>
<li><code>beforeInteractive</code>: 在代码和页面之前加载<code>会阻塞页面渲染</code>。</li>
<li><code>afterInteractive</code>(默认值): 在页面渲染到客户端之后加载。</li>
<li><code>lazyOnload</code>: 在浏览器空闲时稍后加载脚本。</li>
<li><code>worker</code>(实验性特性): 暂时不建议使用。</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Script</span> id=<span class="hljs-string">"VGUBHJMK1"</span> strategy=<span class="hljs-string">"beforeInteractive"</span> src=<span class="hljs-string">"https://unpkg.com/vue@3/dist/vue.global.js"</span> /&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Script</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"VGUBHJMK2"</span> <span class="hljs-attr">strategy</span>=<span class="hljs-string">"afterInteractive"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/vue@3/dist/vue.global.js"</span> /&gt;</span></span>
<span class="xml"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Script</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"VGUBHJMK3"</span> <span class="hljs-attr">strategy</span>=<span class="hljs-string">"lazyOnload"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/vue@3/dist/vue.global.js"</span> /&gt;</span></span></span>
<span class="xml"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Script</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"VGUBHJMK4"</span> <span class="hljs-attr">strategy</span>=<span class="hljs-string">"worker"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/vue@3/dist/vue.global.js"</span> /&gt;</span></span></span>
</code></pre>
<blockquote>
<p>webWorker模式 尚不稳定，谨慎使用,小提示可以给Script组件添加id，Next.js会追踪优化。</p>
</blockquote>
<h5 data-id="heading-5">内联脚本</h5>
<p>即使不从外部文件载入脚本，Next.js也支持我们通过{}直接在<code>Script组件</code>编写代码。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Script</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/script"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{
  children
}: Readonly&lt;{
  children: React.ReactNode;
}&gt;</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Script</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"VGUBHJMK5"</span> <span class="hljs-attr">strategy</span>=<span class="hljs-string">"beforeInteractive"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/vue@3/dist/vue.global.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Script</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        {children}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Script</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"VGUBHJMK6"</span>
         <span class="hljs-attr">strategy</span>=<span class="hljs-string">"afterInteractive"</span>&gt;</span><span class="xml">
        {
           `
            const {createApp} = Vue
            createApp({
              template: '<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>',
              setup() {
                return {
                  message: 'Next.js + Vue.js'
                }
              }
            }).mount('#app')
          `
        }
        </span><span class="hljs-tag">&lt;/<span class="hljs-name">Script</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  );
}
</code></pre>
<p>第二种写法使用 dangerouslySetInnerHTML 属性来设置内联脚本。</p>
<pre><code class="hljs language-tsx" lang="tsx">&lt;<span class="hljs-title class_">Script</span> dangerouslySetInnerHTML={{<span class="hljs-attr">__html</span>: <span class="hljs-string">`
    const {createApp} = Vue
    createApp({
        template: '&lt;h1&gt;{{ message }}&lt;/h1&gt;',
        setup() {
        return {
            message: 'Next.js + Vue.js'
        }
        }
    }).mount('#app')
    `</span> }} strategy=<span class="hljs-string">"afterInteractive"</span>&gt;
&lt;/<span class="hljs-title class_">Script</span>&gt;
</code></pre>
<h5 data-id="heading-6">事件监听</h5>
<ul>
<li>onload: 脚本加载完成时触发。</li>
<li>onReady: 脚本加载完成后，且组件每次挂载的时候都会触发。</li>
<li>onError: 脚本加载失败时触发。</li>
</ul>
<p>Script组件只有在导入客户端的时候才会生效，所以需要使用<code>'use client'</code>声明这是一个客户端组件。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span>
 
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Script</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'next/script'</span>
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Script</span>
        <span class="hljs-attr">src</span>=<span class="hljs-string">"https://example.com/script.js"</span>
        <span class="hljs-attr">onLoad</span>=<span class="hljs-string">{()</span> =&gt;</span><span class="javascript"> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Script has loaded'</span>)
        }}
      /&gt;
    &lt;/&gt;</span></span>
  )
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LeetCode 热题100 --- 双指针专区]]></title>    <link>https://juejin.cn/post/7588002126258913286</link>    <guid>https://juejin.cn/post/7588002126258913286</guid>    <pubDate>2025-12-26T17:36:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588002126258913286" data-draft-id="7587322796826443816" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LeetCode 热题100 --- 双指针专区"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-26T17:36:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="谎言西西里"/> <meta itemprop="url" content="https://juejin.cn/user/332466136029851"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LeetCode 热题100 --- 双指针专区
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/332466136029851/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    谎言西西里
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T17:36:42.000Z" title="Fri Dec 26 2025 17:36:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fmove-zeroes%2Fdescription%2F%3FenvType%3Dstudy-plan-v2%26envId%3Dtop-100-liked" target="_blank" title="https://leetcode.cn/problems/move-zeroes/description/?envType=study-plan-v2&amp;envId=top-100-liked" ref="nofollow noopener noreferrer">283. 移动零 - 力扣（LeetCode）</a></h2>
<h3 data-id="heading-1">题目分析：</h3>
<p>题目要求将数组 <code>nums</code> 中所有 0 移动至数组末尾，同时保持其他非零元素的相对顺序不变，并且要求在原数组上进行操作。</p>
<p>核心要求：</p>
<ul>
<li><strong>0 要移动至数组末尾</strong></li>
<li><strong>非零元素相对位置不变</strong></li>
<li><strong>在原数组上进行操作</strong></li>
</ul>
<h3 data-id="heading-2">解法一（暴力使用数组方法）</h3>
<p>遍历数组将其中所有为 0 的数<strong>直接使用<code>splice</code>删除</strong>并且<strong>记录 0 的个数</strong>，最后<strong>通过<code>push</code>填入</strong>“移动”的 0</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> moveZeroes = <span class="hljs-keyword">function</span>(<span class="hljs-params">nums</span>) {
    <span class="hljs-keyword">let</span> n = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; nums.<span class="hljs-property">length</span>;){
        <span class="hljs-keyword">if</span>(nums[i] == <span class="hljs-number">0</span>){
            n++;
            nums.<span class="hljs-title function_">splice</span>(i, <span class="hljs-number">1</span>);
        } <span class="hljs-keyword">else</span> i++;
    }
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; n; j++){
        nums.<span class="hljs-title function_">push</span>(<span class="hljs-number">0</span>);
    }
    <span class="hljs-keyword">return</span> nums;
};
</code></pre>
<h4 data-id="heading-3">⏱️ 时间复杂度分析</h4>
<ul>
<li>
<p><strong><code>splice(i, 1)</code> 的代价</strong>：<br/>
在数组中间删除一个元素，需要将 <strong>i 后面的所有元素向前移动一位</strong>。<br/>
--&gt; <strong>时间复杂度为 O(k)</strong> ，其中 k 是从 i 到末尾的元素个数。</p>
</li>
<li>
<p>最坏的情况：假设数组中有 <code>z</code> 个 0，且它们分布在前面：</p>
<ul>
<li>第 1 个 0 被删时，移动 n-1 个元素</li>
<li>第 2 个 0 被删时，移动 n-2 个元素</li>
<li>...</li>
<li>最坏情况总移动次数 ≈ (n-1) + (n-2) + ... + (n-z) ≈ <strong>O(n²)</strong></li>
</ul>
<p>（例如输入 <code>[0,0,0,...,0,1]</code>）</p>
</li>
<li>
<p><strong><code>push(0)</code>的代价</strong>： 是 O(z)，可忽略。</p>
</li>
</ul>
<p><strong>最坏时间复杂度：O(n²)</strong></p>
<blockquote>
<p>注：</p>
<p>JavaScript 数组在底层通常是连续内存，而<code>splice(i, 1)</code> 会触发 <strong>大量元素的内存拷贝</strong></p>
<p>⚠️ 尽量<strong>避免在循环中使用 <code>splice</code> 删除元素</strong>，尤其是在处理大数组时，性能会急剧下降</p>
</blockquote>
<h3 data-id="heading-4">解法二（双指针 + 交换）</h3>
<p>题目的问题本质上是将所有非零的元素按照原先的相对顺序排在数组的最前方，那么不妨通过<strong>一个指针安排非零元素的位置</strong>，而<strong>另一个指针来查找所有非零的元素</strong>并且<strong>通过交换来将其放置</strong>在正确的位置。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> moveZeroes = <span class="hljs-keyword">function</span>(<span class="hljs-params">nums</span>) {
    <span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; nums.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">if</span> (nums[i] != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">let</span> temp = nums[j];
            nums[j] = nums[i];
            nums[i] = temp;
            <span class="hljs-comment">// [灵茶山艾府] 灵神做法：</span>
            <span class="hljs-comment">// [nums[j],nums[i]] = [nums[i],nums[j]]; （更简洁、更现代）</span>
            j++;
        }
    }
};
</code></pre>
<h4 data-id="heading-5">⏱️ 时间复杂度分析</h4>
<ul>
<li><strong>单次遍历</strong>：<br/>
使用 <code>for</code> 循环从 <code>i = 0</code> 到 <code>i = nums.length - 1</code> 遍历数组一次 → <strong>O(n)</strong></li>
<li><strong>交换操作</strong>：<br/>
每次遇到非零元素时，执行一次交换（通过临时变量或解构赋值），该操作为 <strong>O(1)</strong> ；<br/>
由于 <code>i</code> 单调递增、<code>j</code> 不回退，每个元素最多被访问和交换一次 → <strong>总交换开销为 O(n)</strong></li>
<li><strong>总时间复杂度</strong>：O(n) + O(n) = <strong>O(n)</strong></li>
</ul>
<h2 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fcontainer-with-most-water%2Fdescription%2F%3FenvType%3Dstudy-plan-v2%26envId%3Dtop-100-liked" target="_blank" title="https://leetcode.cn/problems/container-with-most-water/description/?envType=study-plan-v2&amp;envId=top-100-liked" ref="nofollow noopener noreferrer">11. 盛最多水的容器 - 力扣（LeetCode）</a></h2>
<h3 data-id="heading-7">题目分析：</h3>
<p>题目要求从给定的整数数组 <code>height</code> 中选择两条垂线，使得它们与 x 轴共同构成的容器可以容纳最多的水，并返回该最大水量。</p>
<p>核心要求：</p>
<ul>
<li><strong>容器不能倾斜</strong></li>
<li><strong>较短的一条决定容器的高度</strong></li>
<li><strong>容器的宽度为索引之差</strong></li>
<li><strong>目标是使容器的面积（水量）最大化</strong></li>
</ul>
<p>本题本质上是在所有可能的垂线对 <code>(i, j)</code>（其中 <code>i &lt; j</code>）中，寻找使面积</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>area</mtext><mo>=</mo><mo stretchy="false">(</mo><mi>j</mi><mo>−</mo><mi>i</mi><mo stretchy="false">)</mo><mo>×</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><mtext>height</mtext><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mtext>height</mtext><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\text{area} = (j - i) \times \min(\text{height}[i], \text{height}[j])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord text"><span class="mord">area</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mop">min</span><span class="mopen">(</span><span class="mord text"><span class="mord">height</span></span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord text"><span class="mord">height</span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">])</span></span></span></span></span></p>
<p>最大的组合。</p>
<h3 data-id="heading-8">解法（双指针）</h3>
<p>题目本意就是要找到两个尽可能远且尽可能高的数据，那么不妨先<strong>把两个指针放置最远</strong>，再通过<strong>逐一减小距离来找到尽可能高的数据来平衡距离的缩减</strong>。</p>
<p><strong>优化：</strong> 由于距离在缩减，所以如果数据还减小的话，那么总量一定减小，所以只能牺牲更小的一边向中心查找是否能找到更高的数据。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> maxArea = <span class="hljs-keyword">function</span>(<span class="hljs-params">height</span>) {
    <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>, right = height.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
    <span class="hljs-comment">// 总面积</span>
    <span class="hljs-keyword">let</span> m = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">while</span>(left &lt; right) {
        <span class="hljs-comment">// 计算当前面积并比较大小</span>
        area = (right - left) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(height[left], height[right])
        m = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(area, m);
        <span class="hljs-comment">// 判断哪方更小，哪方移动</span>
        <span class="hljs-keyword">if</span> (height[left] &lt; height[right]) left++;
        <span class="hljs-keyword">else</span> right--;
    }
    <span class="hljs-keyword">return</span> m;
}
</code></pre>
<h2 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2F3sum%2Fdescription%2F%3FenvType%3Dstudy-plan-v2%26envId%3Dtop-100-liked" target="_blank" title="https://leetcode.cn/problems/3sum/description/?envType=study-plan-v2&amp;envId=top-100-liked" ref="nofollow noopener noreferrer">15. 三数之和 - 力扣（LeetCode）</a></h2>
<h3 data-id="heading-10">题目分析：</h3>
<p>题目要求从给定的整数数组 <code>nums</code> 中找出<strong>所有下标不重复的三元组</strong>，使得三个数的和为 0，并且每组不同。</p>
<p>核心要求：</p>
<ul>
<li><strong>三元组中的三个数之和必须等于 0</strong></li>
<li><strong>结果中不能包含重复的三元组</strong></li>
<li><strong>三元组内的元素可以按任意顺序排列</strong></li>
<li><strong>每个三元组中的元素必须来自数组中不同的位置（但值可以相同）</strong></li>
</ul>
<p>本题本质上是在数组中寻找所有满足<br/>
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>nums</mtext><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo>+</mo><mtext>nums</mtext><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo>+</mo><mtext>nums</mtext><mo stretchy="false">[</mo><mi>k</mi><mo stretchy="false">]</mo><mo>=</mo><mn>0</mn><mspace width="1em"/></mrow><annotation encoding="application/x-tex">\text{nums}[i] + \text{nums}[j] + \text{nums}[k] = 0 \quad</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">nums</span></span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">nums</span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">nums</span></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:1em;"/></span></span></span></span><br/>
的三元组，并确保结果集合中无重复。</p>
<hr/>
<h3 data-id="heading-11">解法（排序 + 双指针）</h3>
<p>暴力枚举需要三重循环，这样时间复杂度将会飙升到 O(n³)，效率极其低下，所以我们采用<strong>排序 + 固定一个数 + 双指针</strong>的优化策略。</p>
<p><strong>关键思想：</strong></p>
<ol>
<li>
<p><strong>先对数组排序</strong>，后续可以通过大小关系移动指针。当到达分界点 <code>0</code>时，后续所有值无论如何增加总值都不会为零（优化点）；</p>
</li>
<li>
<p><strong>固定第一个数 <code>nums[i]</code></strong> ，将其转化为“在剩余数组中找两数之和为 <code>-nums[i]</code>”的问题；</p>
</li>
<li>
<p><strong>使用双指针 <code>left = i+1</code>、<code>right = n-1</code></strong> 向中间收缩，根据当前和与目标值的大小关系移动指针；</p>
</li>
<li>
<p><strong>跳过重复值</strong>：</p>
<ul>
<li>若 <code>nums[i] == nums[i-1]</code>，跳过重复；</li>
<li>找到一组解后，继续跳过 <code>left</code> 和 <code>right</code> 的重复值，防止重复答案。</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> threeSum = <span class="hljs-keyword">function</span>(<span class="hljs-params">nums</span>) {
    <span class="hljs-comment">// 先排序：升序排列，使用JS内置的 sort 方法</span>
    <span class="hljs-comment">// sort() 根据返回值决定 a 和 b 谁排在前面</span>
    <span class="hljs-comment">// a - b &lt;= 0 ==&gt; 顺序为 a, b</span>
    <span class="hljs-comment">// a - b &gt;  0 ==&gt; 顺序为 b, a</span>
    nums.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b);
    <span class="hljs-keyword">const</span> res = [];

    <span class="hljs-comment">// 固定第一个数 nums[i]</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; nums.<span class="hljs-property">length</span> - <span class="hljs-number">2</span>; i++) {
        <span class="hljs-comment">// 最小值已大于 0，后续不可能有解</span>
        <span class="hljs-keyword">if</span> (nums[i] &gt; <span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;

        <span class="hljs-comment">// 跳过重复的起始值，避免重复三元组</span>
        <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span> &amp;&amp; nums[i] === nums[i - <span class="hljs-number">1</span>]) <span class="hljs-keyword">continue</span>;
        <span class="hljs-comment">// 双指针</span>
        <span class="hljs-keyword">let</span> left = i + <span class="hljs-number">1</span>;
        <span class="hljs-keyword">let</span> right = nums.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;

        <span class="hljs-keyword">while</span> (left &lt; right) {
            <span class="hljs-keyword">const</span> sum = nums[i] + nums[left] + nums[right];
            <span class="hljs-keyword">if</span> (sum === <span class="hljs-number">0</span>) {
                res.<span class="hljs-title function_">push</span>([nums[i], nums[left], nums[right]]);
                
                <span class="hljs-comment">// 移动双指针，继续查找</span>
                left++;
                right--;
                <span class="hljs-comment">// 跳过重复组</span>
                <span class="hljs-keyword">while</span> (left &lt; right &amp;&amp; nums[left] === nums[left - <span class="hljs-number">1</span>]) left++;
                <span class="hljs-keyword">while</span> (left &lt; right &amp;&amp; nums[right] === nums[right + <span class="hljs-number">1</span>]) right--;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sum &lt; <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 和太小，需增大 → 左指针右移</span>
                left++;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 和太大，需减小 → 右指针左移</span>
                right--;
            }
        }
    }
    <span class="hljs-keyword">return</span> res;
};
</code></pre>
<h4 data-id="heading-12">⏱️ 时间复杂度分析</h4>
<ul>
<li><strong>排序操作</strong>：<br/>
调用 <code>nums.sort((a, b) =&gt; a - b)</code> 对数组进行升序排序，JavaScript 引擎通常采用高效排序算法，时间复杂度 --&gt;  <strong>O(n log n)</strong> 。</li>
<li><strong>外层循环</strong>：<br/>
<code>for</code> 循环遍历 <code>i</code> 从 <code>0</code> 到 <code>nums.length - 3</code>，时间复杂度 --&gt;  <strong>O(n)</strong> 。</li>
<li><strong>内层双指针扫描</strong>：<br/>
对于每个固定的 <code>i</code>，<code>left</code> 和 <code>right</code> 从两端向中间移动，<strong>每个元素在该轮中最多被访问一次</strong>，因此每轮内层循环的时间复杂度 --&gt; <strong>O(n)</strong> 。<br/>
由于外层循环执行 O(n) 次，本应当为 O(n²)，但是并非每轮都走完整个数组，所以最坏情况下 --&gt; <strong>O(n²)</strong>。</li>
<li><strong>总时间复杂度</strong>：排序 O(n log n) + 双指针主逻辑 O(n²) = <strong>O(n²)</strong></li>
</ul>
<h2 data-id="heading-13"><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ftrapping-rain-water%2Fdescription%2F%3FenvType%3Dstudy-plan-v2%26envId%3Dtop-100-liked" target="_blank" title="https://leetcode.cn/problems/trapping-rain-water/description/?envType=study-plan-v2&amp;envId=top-100-liked" ref="nofollow noopener noreferrer">42. 接雨水 - 力扣（LeetCode）</a></h2>
<h3 data-id="heading-14">题目分析：</h3>
<p>题目要求计算在给定的非负整数数组 <code>height</code> 所表示的柱状图中，<strong>能接住多少单位的雨水</strong>。每个元素 <code>height[i]</code> 表示位置 <code>i</code> 处柱子的高度，宽度均为 1。</p>
<p>核心要求：</p>
<ul>
<li><strong>雨水只能积在“凹陷”区域</strong>，即两侧有更高柱子的位置；</li>
<li><strong>每个位置能接的雨水量 = min(左侧最高柱, 右侧最高柱) - 当前高度</strong>（若结果为正，否则为 0）；</li>
<li><strong>不能倾斜容器，雨水垂直下落并被两侧柱子围住</strong>；</li>
<li><strong>目标是返回整个结构能储存的总雨水量</strong>。</li>
</ul>
<p>本题本质上是：对每个位置 <code>i</code>，快速确定其<strong>左侧最大高度</strong>和<strong>右侧最大高度</strong>，从而计算该位置的积水。</p>
<hr/>
<h3 data-id="heading-15">解法（双指针 + 动态边界）</h3>
<p>暴力解法需对每个位置遍历左右求最大值，时间复杂度 O(n²)。即使使用额外数组预处理左右最大值可优化至 O(n)，但是空间占用还是过大。</p>
<p>所以解法采用<strong>双指针从两端向中间收缩</strong>，再利用<strong>贪心思想</strong>实现 <strong>O(1) 空间、O(n) 时间</strong> 的最优解。</p>
<p><strong>关键思想：</strong></p>
<ol>
<li>
<p><strong>维护两个变量 <code>lmax</code> 和 <code>rmax</code></strong>，分别表示当前 <code>left</code> 指针左侧（含自身）的最大高度，以及 <code>right</code> 指针右侧（含自身）的最大高度；</p>
</li>
<li>
<p><strong>比较 <code>lmax</code> 与 <code>rmax</code></strong>：</p>
<ul>
<li>若 <code>lmax &lt; rmax</code>，说明 <code>left</code> 位置的积水<strong>由左侧最大值决定</strong>（因为右侧存在更高的边界），此时可安全计算 <code>left</code> 处的积水；</li>
<li>否则，<code>right</code> 位置的积水由右侧最大值决定，计算 <code>right</code> 处的积水；</li>
</ul>
</li>
<li>
<p><strong>每次只移动较矮一侧的指针</strong>，确保另一侧始终存在足够高的“挡板”，从而保证当前积水计算的正确性。</p>
</li>
<li>
<p>并且两个指针<strong>相遇的位置一定为最高的柱子</strong>，这个柱子是无法装水的。</p>
</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> trap = <span class="hljs-keyword">function</span>(<span class="hljs-params">height</span>) {
    <span class="hljs-comment">// 创建双指针 </span>
    <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> right = height.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">let</span> m = <span class="hljs-number">0</span>;              <span class="hljs-comment">// 总雨水量</span>
    <span class="hljs-keyword">let</span> lmax = <span class="hljs-number">0</span>, rmax = <span class="hljs-number">0</span>; <span class="hljs-comment">// 当前左右侧最大高度</span>

    <span class="hljs-keyword">while</span> (left &lt; right) {
        <span class="hljs-comment">// 更新左右侧最大高度</span>
        lmax = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(lmax, height[left]);
        rmax = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(rmax, height[right]);

        <span class="hljs-keyword">if</span> (lmax &lt; rmax) {
            <span class="hljs-comment">// 左侧最大值更小 → left 位置的积水由 lmax 决定</span>
            m += lmax - height[left];
            left++;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 右侧最大值更小或相等 → right 位置的积水由 rmax 决定</span>
            m += rmax - height[right];
            right--;
        }
    }
    <span class="hljs-keyword">return</span> m;
};
</code></pre>
<h4 data-id="heading-16">⏱️ 时间复杂度分析</h4>
<ul>
<li><strong>双指针遍历</strong>：<br/>
<code>left</code> 和 <code>right</code> 从两端向中间移动，<strong>每个元素最多被访问一次</strong>，循环执行 <strong>O(n)</strong> 次。</li>
<li><strong>每轮操作</strong>：<br/>
包括 <code>Math.max</code>、比较、加法和指针移动，均为 <strong>O(1)</strong> 常数时间操作。</li>
<li><strong>总时间复杂度</strong>：<strong>O(n)</strong></li>
<li><strong>空间复杂度</strong>：仅使用常数个变量（<code>left</code>, <code>right</code>, <code>m</code>, <code>lmax</code>, <code>rmax</code>）→ <strong>O(1)</strong></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再让 AI 直接写页面了：一种更稳的中后台开发方式]]></title>    <link>https://juejin.cn/post/7587965800273362970</link>    <guid>https://juejin.cn/post/7587965800273362970</guid>    <pubDate>2025-12-26T16:35:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587965800273362970" data-draft-id="7587997893988089883" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再让 AI 直接写页面了：一种更稳的中后台开发方式"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-26T16:35:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月亮有石头"/> <meta itemprop="url" content="https://juejin.cn/user/3526889032395613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再让 AI 直接写页面了：一种更稳的中后台开发方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889032395613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月亮有石头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T16:35:04.000Z" title="Fri Dec 26 2025 16:35:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>本文讨论的不是 Demo 级别的 AI 编码体验，而是面向真实团队、长期维护的中后台工程实践。</strong></p>
<blockquote>
<p><strong>AI 能写代码，但不意味着它适合直接“产出页面”。</strong></p>
</blockquote>
<p>最近一年，大模型在前端领域的讨论几乎都围绕一个问题：</p>
<blockquote>
<p><strong>“能不能让 AI 直接把页面写出来？”</strong></p>
</blockquote>
<p>在真实的中后台项目中，我的答案是：<br/>
<strong>不但不稳，而且很危险。</strong></p>
<p>这篇文章想分享一种我在真实项目中实践过、<strong>可长期使用、可规模化</strong>的方式：<br/>
<strong>不是让 AI 写页面，而是把 AI 纳入中后台前端的工程体系中。</strong>
把 AI 的不确定性关进了笼子里，用工程流程保证可控性。</p>
<p><strong>模板固化规范，Spec 描述变化，大模型生成 Spec，脚本生成代码，lint/test 做兜底。</strong>
它解决了 AI 上工程最致命的四件事：</p>
<ol>
<li><strong>可审计</strong>：变化在 spec，生成结果可 diff</li>
<li><strong>可重复</strong>：同一个 spec 反复生成结果一致</li>
<li><strong>可兜底</strong>：lint/test 是硬门槛</li>
<li><strong>可规模化</strong>：从 prompt 工艺变成流程</li>
</ol>
<p>在中后台场景，尤其是 <strong>CRUD 占比高</strong> 的项目里，这几乎就是“性价比最优解”。</p>
<h2 data-id="heading-0">一、中后台页面开发的真实困境</h2>
<p>如果你做过中后台前端，一定对下面这些场景不陌生：</p>
<ul>
<li>页面 80% 是 CRUD</li>
<li>列表页结构高度一致</li>
<li>表单字段不断变化</li>
<li>大量复制粘贴</li>
<li>页面逻辑“看起来差不多，但永远不完全一样”</li>
</ul>
<p>最终结果往往是：</p>
<ul>
<li>代码冗余</li>
<li>风格不统一</li>
<li>新人上手慢</li>
<li>改一个字段要改好几个地方</li>
</ul>
<p>这些问题<strong>不是某个框架的问题</strong>，而是中后台开发的结构性问题。</p>
<h2 data-id="heading-1">二、为什么“让 AI 直接写页面”在真实项目里行不通？</h2>
<p>很多人第一反应是：</p>
<blockquote>
<p>“既然页面这么重复，为什么不直接让 AI 写 Vue / React 页面？”</p>
</blockquote>
<p>在真实项目中，这种方式往往会遇到几个致命问题。</p>
<h3 data-id="heading-2">1️⃣ 不稳定</h3>
<ul>
<li>同样的 prompt，每次生成结果不同</li>
<li>组件结构、命名风格不断漂移</li>
<li>难以保证团队统一规范</li>
</ul>
<h3 data-id="heading-3">2️⃣ 难以 review</h3>
<ul>
<li>AI 一次生成几百行代码</li>
<li>reviewer 很难判断“这是不是对的”</li>
<li>出问题时难以定位责任</li>
</ul>
<h3 data-id="heading-4">3️⃣ 无法规模化</h3>
<ul>
<li>prompt 是隐性的</li>
<li>经验无法沉淀</li>
<li>每个页面都是“重新生成一次”</li>
</ul>
<h3 data-id="heading-5">4️⃣ 工程体系无法兜底</h3>
<ul>
<li>lint / test 很难提前发现语义问题</li>
<li>一旦出错，往往是运行期问题</li>
</ul>
<p><strong>结论很明确：<br/>
AI 直接写页面，更像是 demo，而不是工程方案。</strong></p>
<h2 data-id="heading-6">三、一个更稳的思路：把“变化”和“稳定”拆开</h2>
<p>在真实项目中，我最终选择了一种<strong>更偏工程化</strong>的做法：</p>
<blockquote>
<p><strong>Template + Spec + Generator + AI</strong></p>
</blockquote>
<p>核心思想只有一句话：</p>
<blockquote>
<p><strong>模板负责稳定性，Spec 负责变化，AI 只参与变化。</strong></p>
</blockquote>
<h3 data-id="heading-7">这个流程长什么样？</h3>
<pre><code class="hljs language-js" lang="js">需求描述
   ↓
页面规格（<span class="hljs-title class_">Spec</span>）
   ↓
模板（<span class="hljs-title class_">Template</span>）
   ↓
生成脚本（<span class="hljs-title class_">Generator</span>）
   ↓
页面代码
   ↓
lint / test 校验
</code></pre>
<p>这不是为了“多一层抽象”，而是为了<strong>把 AI 的不确定性限制在可控范围内</strong>。</p>
<h2 data-id="heading-8">四、什么是 Spec？</h2>
<p>**Spec（Specification）**可以理解为：</p>
<blockquote>
<p><strong>页面的“规格说明书”</strong></p>
</blockquote>
<p>它描述的是：</p>
<ul>
<li>页面标题</li>
<li>接口地址</li>
<li>表格字段</li>
<li>查询条件</li>
<li>表单字段与校验规则</li>
</ul>
<p>而不是：</p>
<ul>
<li>生命周期怎么写</li>
<li>API 怎么调用</li>
<li>UI 组件怎么拼</li>
</ul>
<p>这些内容，非常适合用一份结构化数据来表达。</p>
<h3 data-id="heading-9">一个简化的 Spec 示例</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"供应商管理"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"api"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"list"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/api/supplier/list"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"create"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/api/supplier/create"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"update"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/api/supplier/update"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"delete"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/api/supplier/delete"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"columns"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"prop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"name"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"供应商名称"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"prop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"contact"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"联系人"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"prop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"status"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"状态"</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"formSchema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"prop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"name"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"供应商名称"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"prop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"contact"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"联系人"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"prop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"status"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"label"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"状态"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"select"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"启用"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"停用"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这份 JSON <strong>不依赖任何前端框架</strong>，但已经完整描述了一个中后台页面的“变化点”。</p>
<h2 data-id="heading-10">五、Template：把重复劳动固化成资产</h2>
<p>Template 是<strong>固定不变的部分</strong>，例如：</p>
<ul>
<li>页面整体结构</li>
<li>表格 / 表单 / 弹窗骨架</li>
<li>API 调用方式</li>
<li>分页逻辑</li>
<li>错误处理方式</li>
</ul>
<p>它的特点是：</p>
<ul>
<li>人工维护</li>
<li>版本化</li>
<li>可 review</li>
<li>很少变动</li>
</ul>
<p>你可以用 Vue、React、Svelte，<strong>模板思想本身与框架无关</strong>。</p>
<h2 data-id="heading-11">六、Generator：让生成变成确定性行为</h2>
<p>Generator 的职责非常单一：</p>
<blockquote>
<p><strong>把 Spec 填进 Template，生成代码文件</strong></p>
</blockquote>
<p>这一点非常重要：</p>
<ul>
<li>Generator 是脚本</li>
<li>输出是确定的</li>
<li>不涉及 AI 决策</li>
</ul>
<p>换句话说：</p>
<blockquote>
<p><strong>Generator 不是“智能的”，但它是可靠的。</strong></p>
</blockquote>
<h2 data-id="heading-12">七、AI 在这里扮演什么角色？</h2>
<p>在这套体系中，AI 的职责被严格限制在两点：</p>
<h3 data-id="heading-13">✅ 1. 从自然语言生成 Spec</h3>
<p>AI 非常擅长：</p>
<ul>
<li>理解业务描述</li>
<li>生成结构化 JSON</li>
<li>补全字段信息</li>
</ul>
<h3 data-id="heading-14">✅ 2. 按 lint / 报错做最小修复</h3>
<ul>
<li>只修具体文件</li>
<li>只做最小 diff</li>
<li>不重写整体结构</li>
</ul>
<h3 data-id="heading-15">❌ AI 不该做的事</h3>
<ul>
<li>直接写页面代码</li>
<li>修改模板</li>
<li>改动基础设施</li>
<li>引入新依赖</li>
</ul>
<p>这样做的结果是：<br/>
<strong>AI 的能力被“工程流程”约束，而不是反过来。</strong></p>
<h3 data-id="heading-16">✅ 正确姿势</h3>
<p><strong>让 Codex 做两件事：</strong></p>
<p>1️⃣ 根据自然语言 <strong>生成 Spec JSON</strong><br/>
2️⃣ 根据 lint / 报错 <strong>做最小 patch 修复</strong></p>
<p>示例指令（在 Codex CLI / IDE 中）：</p>
<blockquote>
<p>在 <code>specs/</code> 下生成 <code>supplier.json</code>，字段为供应商名称、联系人、电话、状态（启用/停用），接口路径为 <code>/api/supplier/*</code>，输出必须是严格 JSON。</p>
</blockquote>
<p>然后：</p>
<pre><code class="hljs language-bash" lang="bash">yarn gen:page specs/supplier.json
yarn lint
</code></pre>
<p>如果 lint 报错，再让 Codex 修：</p>
<blockquote>
<p>根据 lint 报错，只修改 <code>src/views/supplier/List.vue</code>，用最小改动修到通过。</p>
</blockquote>
<h2 data-id="heading-17">八、为什么这种方式更适合真实团队？</h2>
<p>从工程角度看，这种方式有几个明显优势：</p>
<ul>
<li><strong>可控</strong>：模板稳定，变化集中在 Spec</li>
<li><strong>可 review</strong>：Spec 是结构化数据</li>
<li><strong>可回滚</strong>：git diff 非常清晰</li>
<li><strong>可规模化</strong>：不是 prompt 驱动，而是流程驱动</li>
<li><strong>可迁移</strong>：换框架只需换模板</li>
</ul>
<p>这也是为什么它比“直接让 AI 写页面”更稳。</p>
<h2 data-id="heading-18">九、这套思路不只适用于中后台</h2>
<p>这种模式可以自然扩展到：</p>
<ul>
<li>表单页 / 详情页</li>
<li>权限路由生成</li>
<li>页面迁移（如 Vue2 → Vue3）</li>
<li>低代码 / 页面工厂</li>
<li>前端工程自动化</li>
</ul>
<p>核心不在工具，而在<strong>拆分变化与稳定的边界</strong>。</p>
<h2 data-id="heading-19">十、模板化不是终点：一条更现实的“最佳进化路线”</h2>
<p>需要说明的是，<strong>Template + Spec + Generator 并不是终极方案</strong>，而是一个非常合适的<strong>工程起点</strong>。并不是所有团队都需要走到配置驱动或 AST 修改阶段，<strong>对很多团队来说，Template + Spec 本身已经是最优解。</strong></p>
<p>在真实项目中，我更推荐把它看作一条“可进化的路线”，而不是一锤定音的设计。</p>
<h3 data-id="heading-20">第一步：Template + Spec（现在的方案）</h3>
<p><strong>适用场景：</strong></p>
<ul>
<li>CRUD 页面占比高</li>
<li>新页面数量多</li>
<li>团队希望尽快统一规范</li>
</ul>
<p><strong>价值：</strong></p>
<ul>
<li>快速落地</li>
<li>风险可控</li>
<li>非常适合引入 AI 的第一步</li>
</ul>
<hr/>
<h3 data-id="heading-21">第二步：抽象稳定能力，弱化模板复杂度</h3>
<p>当发现模板里开始出现大量条件分支时，一个更稳的做法是：</p>
<blockquote>
<p><strong>把模板中的稳定逻辑抽成基础组件（如 BaseCrudPage）</strong></p>
</blockquote>
<p>此时：</p>
<ul>
<li>模板变薄</li>
<li>spec 只描述“页面配置”</li>
<li>页面本身不再频繁生成新文件</li>
</ul>
<p>这一步，已经非常接近<strong>配置驱动页面渲染</strong>。</p>
<h3 data-id="heading-22">第三步：从“生成代码”走向“配置即页面”</h3>
<p>在 CRUD 占比极高的系统中，最终形态往往是：</p>
<blockquote>
<p><strong>页面 = 配置（Spec） + 渲染器</strong></p>
</blockquote>
<p>此时：</p>
<ul>
<li>新页面不再生成 <code>.vue</code> 文件</li>
<li>只新增 spec + 路由配置</li>
<li>AI 直接生成 spec，收益最大</li>
</ul>
<p>这本质上就是<strong>低代码/页面工厂的雏形</strong>。</p>
<h3 data-id="heading-23">第四步：存量项目引入结构化修改（AST / Patch）</h3>
<p>对于已有大量页面的系统，更稳妥的方式是：</p>
<ul>
<li>用 spec 描述“变更意图”</li>
<li>用工具对代码做结构化修改（如只改 columns、formSchema）</li>
<li>AI 只产出 patch，而不是重写页面</li>
</ul>
<p>这一步非常适合：</p>
<ul>
<li>老项目</li>
<li>安全要求高的团队</li>
<li>渐进式演进</li>
</ul>
<h3 data-id="heading-24">一句话总结这条路线</h3>
<blockquote>
<p><strong>模板化是把 AI 引入工程体系的第一步，<br/>
配置驱动和结构化修改，才是中后台工程的长期形态。</strong></p>
</blockquote>
<h2 data-id="heading-25">十一、总结</h2>
<p>大模型的价值，不在于“替代工程师写页面”，<br/>
而在于：</p>
<blockquote>
<p><strong>把重复劳动结构化，并嵌入到工程体系中。</strong></p>
</blockquote>
<p>在中后台前端开发中，<br/>
<strong>最稳的方式永远不是“让 AI 自由发挥”，<br/>
而是让它在清晰的边界内工作。</strong></p>
<p>如果只能记住一句话：  不要让 AI 直接写页面，让它写“变化”，其余交给工程。</p>
<hr/>
<p>如果你觉得这篇文章对你有启发，欢迎点赞或收藏 👍</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一款基于 .NET 9 构建的企业级 Web RBAC 快速开发框架]]></title>    <link>https://juejin.cn/post/7588007285546418182</link>    <guid>https://juejin.cn/post/7588007285546418182</guid>    <pubDate>2025-12-26T15:15:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588007285546418182" data-draft-id="7588007285546401798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一款基于 .NET 9 构建的企业级 Web RBAC 快速开发框架"/> <meta itemprop="keywords" content=".NET"/> <meta itemprop="datePublished" content="2025-12-26T15:15:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一款基于 .NET 9 构建的企业级 Web RBAC 快速开发框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T15:15:54.000Z" title="Fri Dec 26 2025 15:15:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>今天大姚给大家分享一款基于 .NET 9 构建的企业级、开源 Web RBAC 快速开发框架：RuYiAdmin。</p>
<h2 data-id="heading-1">项目介绍</h2>
<p>RuYiAdmin 一款基于 .NET 9 构建的企业级、前后端分离、开源（Apache License） Web RBAC 快速开发框架，具有灵活的架构设计和强大的功能，适用于快速开发高性能的企业级应用，具有低代码、跨平台、分布式、多线程和高性能等特色。</p>
<h2 data-id="heading-2">适用场景</h2>
<ul>
<li>企业级后台管理系统：用于企业内部的各种管理任务，如用户管理、权限控制、数据统计等。</li>
<li>内容管理系统（CMS）：用于网站内容的创建、编辑、发布和管理。</li>
<li>客户关系管理（CRM）系统：帮助企业跟踪和管理客户信息、销售机会和客户服务请求。</li>
</ul>
<h2 data-id="heading-3">主要特点</h2>
<ul>
<li><strong>前后端分离：</strong> RuYiAdmin 采用前后端分离架构，前端基于VueElementAdmin，使用 Vue2 和 Element UI，后端基于 .NET 9 构建。</li>
<li><strong>代码自动生成：</strong> 支持一键生成视图层、控制层、服务层、仓储层、领域层和 DTO 业务模型层代码，极大地缩短了开发周期。</li>
<li><strong>多数据库支持：</strong> 支持多种关系型数据库（如 MySQL、SqlServer、SQLite、Oracle、PostgreSQL、OpenGauss、Kingbase、DM）和非关系型数据库（如 Redis、MongoDB、Elasticsearch、Meilisearch），同时支持动态数据源，以满足不同企业的需求。</li>
<li><strong>项目安全性高：</strong> 支持4A等级认证，满足等保三级要求，支持防 SQL 注入、防 Token 劫持、防接口渗透与抖动，集成RSA、AES及国产 SM 加密算法，支持全链路HTTPS加密传输协议，确保企业级应用的安全性。</li>
<li>支持微服务，支持服务的注册、发现、健康检查、熔断和降级。</li>
</ul>
<h2 data-id="heading-4">项目技术栈</h2>
<ul>
<li>前端：Vue2、Element UI、Node.js等。</li>
<li>后端：C#、.NET 9、AspNetCoreRateLimit、SqlSugar、AutoMapper、SignalR、MiniProfiler、CAP、RabbitMQ、Redis、Consul等。</li>
</ul>
<h2 data-id="heading-5">安装教程</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65b33a329e714542a17f15a749c938dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=0WWCIdLd%2Faw20BukKEaqgx5zrqs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">软件架构图</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3db5bfe168441d1b5a630b0847de675~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=2DlGneAThLO%2F%2FNVP%2BkB%2F3CsB9C0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">项目源代码</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3c6ad0bca55418bbd2a130858947253~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=JE1JKADfx6%2BE0636k3ISq3c4KNg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">项目效果截图</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/489788f978e647079dcde6b683d4ce07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=PzyLvIRn2FHItYYAjmYAfrbq5Cc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87684fb26e814032984594a89933da8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=uk9lX55RF83vdo%2F4CJ8608bEz3g%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0012a7ea5bb6423085e54c4f52950e84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=1i6Ymt8MXDOzL6w2tLHPqstBVCc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/540f5a18b2e94474b7fe968a768c4728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=1csLmkfdGEfWW7CikJnNYvMEldk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eae99d04517344fb80532d6b8940aa08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=oXSPnqnaAYMU1kddBS%2BEUm8Y9EU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5be9962d5b21477492843030f7b5f59c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=eeM0HPwEeVdtbu8YBdWAUnwjTO8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c62a706866443129fcf0441dc89d3fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=G76RIi%2FdjKjYHIXqbnWn7V%2FcJU8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f564806e8bb54a8792cfd0b49f6f691b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=Z%2FmQ%2FYAKUXqQ3KH2HPUKbDIbxIg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78a75d60b53d42b28a993bfc96e77cf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=w3sMG%2B8jW9GNgls2wFXBthz32Uc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d13e94a93b24727b080c8e1b347b446~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=bUw1cAI%2FEhzh76uVg5%2FZFVRYEIY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45424de315834001840af8e424a3be6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=3H%2FSkFl14L3PzX2Ni6DmyjOqnxQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/183804178d3344f4baee493cceb9f31f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=ilhm5aanDv8w9w%2F6IBCrc%2BJJyq4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/292198da5fc84f1a8dbd773f2f09d054~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=pqqqqxYzNaPUPmecDKA0Js5EYvE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/696ccdf29bb3453eb610fb98a0e50b0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767366954&amp;x-signature=blsKHgnzg7CyhoHLAJ4HTGa8Psg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">项目源码地址</h2>
<p>更多项目实用功能和特性欢迎前往项目开源地址查看👀，别忘了给项目一个Star支持💖。</p>
<ul>
<li><strong>Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fpang-mingjun%2FRuYiAdmin" target="_blank" title="https://gitee.com/pang-mingjun/RuYiAdmin" ref="nofollow noopener noreferrer">gitee.com/pang-mingju…</a></li>
</ul>
<h2 data-id="heading-10">优秀项目和框架精选</h2>
<p>该项目已收录到C#/.NET/.NET Core优秀项目和框架精选中，关注优秀项目和框架精选能让你及时了解C#、.NET和.NET Core领域的最新动态和最佳实践，提高开发工作效率和质量。坑已挖，欢迎大家踊跃提交PR推荐或自荐（<strong>让优秀的项目和框架不被埋没🤞</strong>）。</p>
<ul>
<li><strong>GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
<li><strong>Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最强「学业成绩分析压力感知型 AI 心理陪伴」智能体—基于腾讯元器×TextIn大模型加速器×混元大模型的实战构建]]></title>    <link>https://juejin.cn/post/7587965908289110026</link>    <guid>https://juejin.cn/post/7587965908289110026</guid>    <pubDate>2025-12-26T14:09:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587965908289110026" data-draft-id="7588086766235582502" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最强「学业成绩分析压力感知型 AI 心理陪伴」智能体—基于腾讯元器×TextIn大模型加速器×混元大模型的实战构建"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-26T14:09:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CodeJourney"/> <meta itemprop="url" content="https://juejin.cn/user/3558441089502232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最强「学业成绩分析压力感知型 AI 心理陪伴」智能体—基于腾讯元器×TextIn大模型加速器×混元大模型的实战构建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3558441089502232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CodeJourney
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T14:09:52.000Z" title="Fri Dec 26 2025 14:09:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">最强「学业成绩分析压力感知型 AI 心理陪伴」智能体—基于腾讯元器×TextIn×混元大模型的实战构建</h2>
<h2 data-id="heading-1">一、项目背景</h2>
<p>在“双减”政策深化与教育数字化持续推进的背景下，<strong>学生学业评价正在从“唯分数论”向“数据驱动的全面成长分析”转型</strong>。成绩单不再只是简单的分数汇总，而是蕴含着学生学习状态、学科优势、波动趋势以及潜在心理压力的重要数据载体。</p>
<p>然而，在当前教学实践中仍普遍存在以下问题：</p>
<ul>
<li><strong>成绩分析维度单一</strong>：多数学校或班级仍停留在平均分、排名等静态统计层面，缺乏对个人成长轨迹、学科结构失衡、阶段性波动的深度分析；</li>
<li><strong>数据处理成本高</strong>：大量成绩单以 PDF、扫描件、照片等非结构化形式存在，人工整理耗时耗力，难以规模化应用；</li>
<li><strong>心理关怀长期缺位</strong>：成绩波动往往直接影响学生情绪与自我认知，但现实中教师精力有限，学生缺乏稳定、低门槛的情绪疏导与成长陪伴渠道；</li>
<li><strong>“分数压力”感知滞后</strong>：多数心理干预发生在问题显性化之后，缺乏基于学业数据的前置风险感知与温和介入机制。</li>
</ul>
<p>随着大模型技术与智能体平台的成熟，这一局面正在发生改变。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2eb4b8383674ceab99d5223668c9255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ki0K39rMOwyMhHT3SZrXDhFUR8Q%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>本项目基于 <strong>腾讯元器智能体构建平台</strong>，融合 <strong>TextIn 大模型加速器的高精度 OCR 与表格结构化能力</strong>，并引入 <strong>混元大模型的多模态理解与情绪推理能力</strong>，构建一套 <strong>“班级多维度成绩分析 × 学业压力感知型 AI 心理陪伴智能体”</strong>。</p>
<p>该智能体不仅能够自动完成成绩单的高精度解析与多维统计分析，还能在此基础上：</p>
<ul>
<li>识别学生潜在的学业压力信号与情绪风险；</li>
<li>以<strong>非评判、低压力</strong>的方式进行情绪疏导与正向引导；</li>
<li>为教师提供数据驱动的班级画像与干预参考；</li>
<li>为学生提供持续、稳定、可对话的成长陪伴。</li>
</ul>
<p>通过将<strong>学业数据分析</strong>与<strong>情绪关怀智能体</strong>深度融合，本项目探索了一种面向真实教学场景的 <strong>“学业—心理协同型 AI Agent”</strong> 落地路径，为智慧教育与学生心理健康提供可复制、可扩展的技术实践范式。</p>
<h3 data-id="heading-2">1.1效果演示</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d57627925b4243978ca89258060cf99b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=eOcYAoGe9bYgcIOhxN1mIv0NrIM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d4048b33f5645c89d6aea3bb8d78337~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=CX5jRvK5NI64FtoG8aq6hZVd2Mw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0037f72807f4b51b007dbdb2454f9b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=Hl%2BTI%2BlDKoYJhZ0CtMjEdiS%2FMRc%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2939034d53d942cd9a97d0d183fa3ca1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=4GB%2F4JZVkN2H7CnP4ZG1aQCj14E%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/847a97f1ea684c01abd3a81638a7ea98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=EcYkOd6A9hjwsEq9TFDQPl56C5E%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc1c5397c2384af8b9adbde1ec4de34b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=1EEsHs%2B2gdoOW4o3Z4AC8RDdGe8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-3">二、项目知识点概览</h2>
<p>在本项目中，我们并非单一依赖某一个大模型或工具，而是通过<strong>智能体平台 + 文档理解引擎 + 通用大模型</strong>的协同，构建一套面向真实教育场景的复合型 AI 系统。以下对项目涉及的三项核心技术能力进行简要说明。</p>
<h3 data-id="heading-4">2.1 什么是腾讯元器？</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddd5a04e3d664216af67775035787389~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=rlQesesHT9brPqaYLppfVmc5jfQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>腾讯元器</strong>是腾讯推出的一站式 <strong>AI 智能体（Agent）构建与运行平台</strong>，面向开发者提供从能力编排、模型调用到上下文管理的完整智能体基础设施。</p>
<p>与传统“单轮对话式 AI”不同，腾讯元器强调的是：</p>
<ul>
<li><strong>可感知环境</strong></li>
<li><strong>可规划流程</strong></li>
<li><strong>可调用工具</strong></li>
<li><strong>可持续记忆</strong></li>
</ul>
<p>即具备完整“感知—决策—行动—反馈”闭环的智能体能力。</p>
<p>在实际使用中，开发者可以通过腾讯元器：</p>
<ul>
<li>将 OCR、数据分析、大模型推理等能力封装为独立节点；</li>
<li>通过流程编排方式构建多步骤智能体任务；</li>
<li>为不同角色（学生 / 教师）配置差异化交互逻辑；</li>
<li>管理智能体上下文记忆与权限边界。</li>
</ul>
<p>在本项目中，腾讯元器作为<strong>智能体的“中枢系统”</strong>，负责串联成绩解析、数据分析、压力感知与情绪陪伴等多个能力模块，实现复杂教育场景下的稳定运行与可扩展落地。</p>
<h3 data-id="heading-5">2.2 什么是 TextIn 大模型加速器？</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41905fc77b9f469799ff8cdf65a011e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ArB69xVvX%2FTXzHjNIm9cIJc6btY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>TextIn 大模型加速器</strong>是一套面向 <strong>复杂文档理解场景</strong> 的智能解析引擎，核心能力是将 <strong>非结构化文档高精度转化为结构化数据</strong>。</p>
<p>在教育场景中，成绩单通常存在以下特点：</p>
<ul>
<li>格式不统一、模板多样；</li>
<li>表格结构复杂，存在合并单元格；</li>
<li>来源多为扫描件或拍照图片；</li>
<li>含有大量相似字段，人工校对成本高。</li>
</ul>
<p>TextIn 大模型加速器通过 <strong>大模型 + 规则引擎 + 视觉理解</strong> 的方式，提供：</p>
<ul>
<li>高精度 OCR 文字识别；</li>
<li>表格结构自动还原；</li>
<li>字段语义识别与对齐；</li>
<li>错误容忍与纠偏能力。</li>
</ul>
<p>在本项目中，TextIn 负责将成绩单从“看得懂但用不了”的文档形态，转化为 <strong>可计算、可分析、可推理</strong> 的标准化数据，为后续班级分析与情绪判断提供可靠输入基础。</p>
<h3 data-id="heading-6">2.3 什么是混元大模型？</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0673ae7d83ac4283a560cad6a500d7b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=8cvZ7ZhwNeTN4Jj9iNLGUZfSB2s%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>混元大模型</strong>是腾讯自研的通用大语言模型体系，具备自然语言理解、逻辑推理、情绪识别与内容生成等多项能力，适用于复杂、多轮、上下文敏感的交互场景。</p>
<p>相较于仅用于文本生成的大模型，混元更强调：</p>
<ul>
<li><strong>上下文连续理解能力</strong></li>
<li><strong>多维度语义推理能力</strong></li>
<li><strong>情绪与意图识别能力</strong></li>
<li><strong>可控、稳健的输出风格</strong></li>
</ul>
<p>在本项目中，混元大模型主要承担三类核心任务：</p>
<ol>
<li>
<p><strong>成绩分析结果的语义总结与解释</strong>
将冰冷的统计数据转化为学生与教师易于理解的自然语言反馈。</p>
</li>
<li>
<p><strong>学业压力与情绪状态推理</strong>
结合成绩变化与学生语言输入，识别潜在压力信号与情绪波动。</p>
</li>
<li>
<p><strong>陪伴式对话与引导反馈</strong>
以非评判、低压力的方式与学生持续互动，提供情绪疏导与成长引导。</p>
</li>
</ol>
<p>混元大模型的引入，使系统不仅“会算分”，更“懂学生”，是实现“学业压力感知型 AI 心理陪伴”的关键能力支撑。</p>
<h2 data-id="heading-7">三、技术方案</h2>
<p>本项目以“<strong>学业数据可结构化、压力状态可感知、成长陪伴可持续</strong>”为核心目标，基于腾讯元器智能体平台，构建一套覆盖 <strong>数据采集 → 成绩分析 → 压力感知 → 情绪疏导 → 成长反馈</strong> 的闭环式 AI 智能体技术方案。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d86f8711ae1406a9151ad4e83df35b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=L5tq7MPbrKs1DuUFiZ0SN40yAbQ%3D" alt="" loading="lazy"/></p>
<p>整体架构采用 <strong>“多源数据解析 + 大模型推理 + 规则与情绪协同决策”</strong> 的设计思路，确保系统在真实教学场景中具备可解释性、稳定性与可扩展性。</p>
<h3 data-id="heading-8">3.1 智能体总体架构设计（基于腾讯元器）</h3>
<p>项目核心智能体构建于 <strong>腾讯元器平台</strong>，通过模块化节点编排的方式，实现多能力协同：</p>
<ul>
<li><strong>输入层</strong>：成绩单图片 / PDF / 扫描件、学生自然语言输入（情绪倾诉、学习困惑）</li>
<li><strong>能力层</strong>：
<ul>
<li>OCR 与表格解析节点（TextIn 大模型加速器）</li>
<li>成绩统计与趋势分析节点</li>
<li>学业压力感知与情绪推理节点（混元大模型）</li>
<li>对话与陪伴响应节点</li>
</ul>
</li>
<li><strong>输出层</strong>：
<ul>
<li>班级多维度成绩分析报告</li>
<li>学生个性化学习与情绪反馈</li>
<li>教师侧结构化分析与风险提示</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4369939866ab4924a33dd176ee3f395b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=CQiOMndjw6tdjYy5f4jNDATEbG4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>通过腾讯元器的 <strong>流程编排、上下文记忆与权限控制能力</strong>，实现学生端与教师端的智能体能力隔离与协同。</p>
<hr/>
<h3 data-id="heading-9">3.2 成绩单高精度解析方案（TextIn 大模型加速器）</h3>
<p>针对成绩单<strong>格式多样、表格结构复杂、扫描质量参差不齐</strong>的问题，系统引入 <strong>TextIn 大模型加速器</strong>，完成非结构化成绩单的高精度结构化处理。</p>
<p>核心能力包括：</p>
<ul>
<li><strong>多格式支持</strong>：支持图片、PDF、扫描件等多种输入形式；</li>
<li><strong>表格结构还原</strong>：自动识别表头、合并单元格、学科列与学生行；</li>
<li><strong>字段语义识别</strong>：区分姓名、学号、单科成绩、总分、排名等关键字段；</li>
<li><strong>错误容忍与修正</strong>：对倾斜、模糊、低分辨率文档具备较强鲁棒性。</li>
</ul>
<p>输出结果为标准化 JSON / 表格结构数据，为后续分析与大模型推理提供可靠数据基础。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/339fd18091694f2c9ef78c43166a095f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=AxTqdkV2l6GeaZMgkR7onm3N79o%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-10">3.3 学业压力感知与情绪推理机制（混元大模型）</h3>
<p>区别于传统仅基于分数的分析方式，本项目引入 <strong>“学业压力感知模型”</strong>，将成绩数据与学生语言输入进行联合推理。</p>
<p>压力识别信号来源包括：</p>
<ul>
<li>成绩连续下降或波动加剧；</li>
<li>单科长期低于班级均值；</li>
<li>学业负担相关高频情绪词（焦虑、害怕、失望等）；</li>
<li>自我否定、比较型语言模式。</li>
</ul>
<p>基于 <strong>混元大模型的情绪理解与上下文推理能力</strong>，系统对学生当前状态进行综合判断，并划分为不同压力等级，作为后续干预策略的依据。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98556f886aa34d80b2bfad7672c8c9a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=siCI4wV0%2FdJN2JZR2OGGqMEfcNY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-11">四、搭建「学业成绩分析压力感知型 AI 心理陪伴」智能体</h2>
<p>在完成项目背景、核心技术选型与整体技术方案设计之后，本章将围绕<strong>如何基于腾讯元器实际搭建该智能体</strong>展开，重点介绍智能体的创建流程、能力节点配置方式以及关键逻辑的落地实现思路，确保方案不仅“能讲清”，也“能跑起来”。</p>
<h3 data-id="heading-12">4.1 腾讯元器智能体创建</h3>
<p>在腾讯元器平台中，首先创建一个新的智能体实例，并明确其<strong>角色定位与服务对象</strong>。</p>
<p>本项目采用 <strong>“一体多角色”</strong> 的设计思路，即：</p>
<ul>
<li>
<p><strong>学生侧智能体</strong></p>
<ul>
<li>面向学生提供成绩解读、学习反馈与情绪陪伴</li>
<li>强调共情、引导与非评判式对话</li>
</ul>
</li>
<li>
<p><strong>教师侧智能体</strong></p>
<ul>
<li>面向教师提供班级成绩画像、趋势分析与风险提示</li>
<li>强调数据客观性与可解释性，避免情绪化标签</li>
</ul>
</li>
</ul>
<p>在元器中通过<strong>不同的提示词模板与权限配置</strong>，实现同一套底层能力、不同交互表现的智能体分支。</p>
<p>登录腾讯元器平台后，点击右上角 「个人空间」，进入 「我的智能体」 页面，选择 「创建智能体」。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a638153d1284763844ee1fed264d714~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=RB%2FynbQp43FuRprxErSqKi%2FJhLE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在智能体类型选择界面中，选择 「对话式智能体」。
该类型适用于具备多轮交互、情绪理解与复杂任务处理能力的应用场景，适合本项目中“成绩分析 + 情绪疏导”的复合需求。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06ccd17784c74ade914d5943d112bf42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=2v%2BC7b0Tx8gutbyQncBFK8MPZAA%3D" alt="在这里插入图片描述" loading="lazy"/>
在新建对话式智能体页面中，填写以下信息：</p>
<ul>
<li>
<p>智能体名称：用于对外展示与识别</p>
</li>
<li>
<p>智能体简介：简要说明智能体的核心能力与使用场景</p>
</li>
</ul>
<p>信息填写完成后，点击 「新建」 按钮，完成智能体的基础创建。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4624904b3ffb4e03b018d84980437176~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=CXn%2FfYRQo8DbbR1u0XUMx0pDyg4%3D" alt="在这里插入图片描述" loading="lazy"/>
创建成功后，系统将自动跳转至智能体后台管理页面。在该页面中，可以对智能体进行角色设定、模型选择、能力配置与测试验证等操作。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/784f3ad828e84312b3311201df11c2c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=K8QVMzqIWq8OsmdSQvqAstZPoNM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-13">4.2 智能体角色定位</h3>
<p>在 「角色设定 / 提示词」 模块中，编写智能体的系统提示词（System Prompt）。
可结合平台提供的 「提示词一键优化」 功能，对初始提示词进行结构化与语义增强。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/424daf5bee914e3384595a69ff63ce2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=c2Gvak7qZzILwbg165HcFY3xd%2Bg%3D" alt="在这里插入图片描述" loading="lazy"/>
以下为本项目中使用的核心角色提示词，用于明确智能体的定位、能力边界与输出风格：</p>
<pre><code class="hljs language-bash" lang="bash">【要求】扮演一名学业成绩分析与压力感知型AI心理陪伴智能体，能够基于学生成绩单数据与学生自然语言输入，进行多维度学业分析、学业压力感知，并以非评判、陪伴式方式为学生提供情绪疏导与成长引导，同时为教师提供去情绪化的数据分析与风险提示。

【名称】学业成绩分析与压力感知型 AI 心理陪伴智能体

【属性】AI智能体，专注于学业成绩分析与压力感知，具备情绪理解能力

【人物关系】学生、教师

【人物经历】由教育心理学专家、数据科学家及AI工程师共同开发，旨在通过技术手段帮助学生缓解学业压力，促进健康成长。

【外貌特征】无实体形态，以文字形式呈现

【性格特点】温和、理性、不居高临下，重视共情，不直接否定用户感受，不使用心理诊断或标签化语言，表达清晰、有结构，但避免说教

【语言风格】
- 学生端输出：温和、鼓励、共情型表达
- 教师端输出：客观、中性、数据驱动表达

【人物喜好】无具体喜好，但致力于帮助学生和教师解决问题

【输出要求】
- 使用简体中文
- 分点输出时需逻辑清晰
- 情绪疏导时先共情、再引导、最后给建议

【能力限制】
- 不能进行心理疾病诊断或治疗建议
- 不能替代教师、家长或心理咨询师的专业决策
- 不输出任何对学生的负面标签或价值评判
- 不基于单次成绩波动做长期能力判断

【其他要求】
- 面向学生时偏陪伴与引导
- 面向教师时偏数据与客观分析

【能达成以下用户意图】
<span class="hljs-comment">#意图名称：学业压力缓解</span>
<span class="hljs-comment">#意图描述：通过分析学生成绩单数据和自然语言输入，识别学业压力源，并提供情绪疏导和成长引导。</span>
<span class="hljs-comment">#意图示例：学生表示近期考试成绩下降，感到焦虑。AI智能体通过分析成绩单和学生输入，发现其在数学和物理科目上表现不佳，可能因此产生焦虑。</span>
<span class="hljs-comment">#意图实现：AI智能体首先共情学生的情绪，然后引导学生找到学习方法上的不足，并提供具体的改进建议，如制定合理的学习计划、调整学习策略等。</span>

<span class="hljs-comment">#意图名称：教师数据分析支持</span>
<span class="hljs-comment">#意图描述：为教师提供去情绪化的数据分析与风险提示，帮助教师更好地了解学生的学习情况和潜在问题。</span>
<span class="hljs-comment">#意图示例：教师希望了解班级整体学业表现和潜在问题。AI智能体通过分析班级成绩单数据，发现某些科目普遍成绩较低，可能存在教学难点或学生兴趣不足等问题。</span>
<span class="hljs-comment">#意图实现：AI智能体将分析结果以客观、中性的语言呈现给教师，并提出相应的教学调整建议，如增加互动环节、调整教学进度等。</span>

</code></pre>
<p>在 「欢迎语设置」 中配置用户首次进入对话时的引导语，用于明确智能体能力边界，并引导用户正确输入。</p>
<blockquote>
<p>哈喽，我是学业成绩分析压力感知型 AI 心理陪伴，请发送您的成绩单。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/089b899d0be34bb4a4833236ca650f44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=%2BM8hx8g4FqnWyZFYQAuWWoFnhnc%3D" alt="在这里插入图片描述" loading="lazy"/>
在模型配置模块中，选择 混元大模型 作为智能体底层推理模型。
该模型在中文理解、多轮对话、情绪语义识别及结构化输出方面表现稳定，适合教育与心理陪伴类应用场景。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ffdc96f44e940728af717d1f510e0f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ytdwANO3MMaCV08b1EqaCtfteJI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/873f29c47d204257be445d737193360a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=c9%2BbGBAZroAmA%2BQLr02VKVFxJMc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-14">五. 腾讯元器智能体工作流编写</h2>
<p>智能体的核心能力不仅来源于大模型本身，更依赖于清晰、可控的工作流设计。通过工作流，可以将“用户输入 → 数据解析 → 逻辑判断 → 模型推理 → 结果输出”拆解为多个可管理的节点，使智能体具备稳定、可复用的业务执行能力。</p>
<h3 data-id="heading-15">5.1 工作流创建</h3>
<p>在智能体后台管理页面中，点击左侧 「工作流管理」，然后点击 「新建」，开始创建新的智能体工作流。</p>
<p>该工作流将作为智能体处理用户请求的主执行链路。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5197f52470042d7ae70e0c0dfbb4183~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=RpQ1wG6LwNV7u3aFHQ%2FMXXV%2Fmws%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在创建方式选择弹窗中，选择 「手动录入」。</p>
<p>手动录入方式适合需要精细控制逻辑节点、条件分支与多角色输出的复杂智能体场景，本项目中的“成绩分析 + 情绪疏导”正是典型代表。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65d27dbe5df441499a065cc34e242108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=Zmg2myycjakWEE%2Bc282tzE919Yg%3D" alt="在这里插入图片描述" loading="lazy"/>
在新建工作流页面中，填写以下信息：</p>
<ul>
<li>
<p>工作流名称：用于标识该工作流的功能用途（如：成绩分析与压力感知主流程）</p>
</li>
<li>
<p>工作流描述：简要说明该工作流的执行目标、适用对象与核心逻辑</p>
</li>
</ul>
<p>填写完成后确认创建，系统将生成一个新的工作流实例。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fa8fe3a216246ba90bb6d7b105cee01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=C9e7w4P77MjKv6yU6fKHOeOrub8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>工作流创建完成后，将自动进入 工作流编辑面板。
该面板是后续进行节点编排、条件判断、模型调用与输出控制的核心操作区域。</p>
<p>在面板中，可以清晰看到：</p>
<ul>
<li>
<p>工作流的整体执行结构</p>
</li>
<li>
<p>各功能节点的连接关系</p>
</li>
<li>
<p>当前工作流的起始节点与结束节点</p>
</li>
</ul>
<p>后续的成绩单解析、学业分析、压力感知与结果输出，均将在该面板中以节点方式逐步构建。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcae94c4a7f840c09ba9e16214b9fac6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=VvFKelNdcLuycEvtVQL%2FnWm9%2FRM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>配置工作流的开始节点，定义两个输入变量：</p>
<p>image：用于接收学生上传的成绩单图片，作为后续 OCR 解析与成绩分析的原始数据输入。</p>
<p>q：用于接收学生以自然语言形式提出的学习困惑、情绪表达或具体分析需求，作为智能体理解用户意图与情绪状态的重要输入。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a165583ac8664ccba596d80aa9b393c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=%2BMKCFB5PSwS%2FzokdFvCP7mTCRFM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-16">5.2 成绩单解析能力节点配置（TextIn 大模型加速器接入）</h3>
<p>在智能体能力编排中，在开始节点后需要配置 <strong>成绩单解析节点</strong>，作为整个系统的数据处理识别中心。</p>
<p>在元器流程中，该节点的核心职责是：</p>
<ol>
<li>接收用户上传的成绩单文件；</li>
<li>调用 TextIn 完成 OCR 与表格结构还原；</li>
<li>输出包含学生信息、学科成绩、总分、排名等字段的结构化结果；</li>
<li>将结果传递给后续分析节点。</li>
</ol>
<p>这一节点解决的是“<strong>数据从哪来、是否可靠</strong>”的问题，是后续所有分析与推理的前提基础。</p>
<hr/>
<p>完成开始节点配置后，需要引入 OCR 与文档结构化解析能力。本方案选用 TextIn 大模型加速器（通用模型），用于将成绩单解析为 Markdown 结构化结果。</p>
<blockquote>
<p>/ai/service/v1/pdf_to_markdown</p>
</blockquote>
<ul>
<li>输入：PDF、图片或扫描件</li>
<li>输出：JSON 结构化数据，包括学生信息、课程成绩、总评等级等</li>
<li>技术特点：
<ul>
<li>多模态解析，支持图片文字、表格识别</li>
<li>自动格式标准化，兼容不同院校模板</li>
</ul>
</li>
</ul>
<p>python调用示例：(虽然我们在腾讯元器里可以直接调用，但是还是建议理解一下下面这段直接调用TextIn 大模型加速器的代码，会让我们更容易理解)</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> requests

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OCRClient</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, app_id: <span class="hljs-built_in">str</span>, secret_code: <span class="hljs-built_in">str</span></span>):
        self.app_id = app_id
        self.secret_code = secret_code

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recognize</span>(<span class="hljs-params">self, file_content: <span class="hljs-built_in">bytes</span>, options: <span class="hljs-built_in">dict</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-comment"># 构建请求参数</span>
        params = {}
        <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> options.items():
            params[key] = <span class="hljs-built_in">str</span>(value)

        <span class="hljs-comment"># 设置请求头</span>
        headers = {
            <span class="hljs-string">"x-ti-app-id"</span>: self.app_id,
            <span class="hljs-string">"x-ti-secret-code"</span>: self.secret_code,
            <span class="hljs-comment"># 方式一：读取本地文件</span>
            <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/octet-stream"</span>
            <span class="hljs-comment"># 方式二：使用URL方式</span>
            <span class="hljs-comment"># "Content-Type": "text/plain"</span>
        }

        <span class="hljs-comment"># 发送请求</span>
        response = requests.post(
            <span class="hljs-string">f"/ai/service/v1/pdf_to_markdown"</span>,
            params=params,
            headers=headers,
            data=file_content
        )

        <span class="hljs-comment"># 检查响应状态</span>
        response.raise_for_status()
        <span class="hljs-keyword">return</span> response.text

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># 创建客户端实例，需替换你的API Key</span>
    client = OCRClient(<span class="hljs-string">"你的x-ti-app-id"</span>, <span class="hljs-string">"你的x-ti-secret-code"</span>)

        <span class="hljs-comment"># 插入下面的示例代码</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()

</code></pre>
<p>在开始节点后选择工具节点
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5481084f9f7e443582aaa4e767bf3bf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=EtMb6aPgO5VqR9CpGdLTTT5qzoc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/180a152dbee64442b671f1bd287e8625~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=KfY%2FAW%2FNbMgqorflFE59JU7j0W0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在 HTTP 请求节点中，需要配置以下两个关键请求头参数：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1bdca0bc7b84179a52963f1fb6dc764~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=IDuld1AEEMd4bKxjTuLggClLPr8%3D" alt="在这里插入图片描述" loading="lazy"/>
如果不清楚这两个参数如何填写，可按以下步骤获取：</p>
<ol>
<li>登录 TextIn 控制台</li>
<li>进入 开发者信息 / 应用管理</li>
<li>查看对应应用的：
x-ti-app-id
x-ti-secret-code</li>
</ol>
<p>⚠️ 注意：
二者组合构成唯一合法调用凭证，请妥善保管，可以到TextIn 控制台里的开发者信息处查看。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60227c58544f46df9965d918b170dd23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=oXWrZk8N%2FRHePTGIt6jXCBem8fI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在API参数区域设置变量名。
x-ti-app-id
x-ti-secret-code
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9dfd62aa3a8f49bc9db1cbb56811388a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=OEQ6HosmC%2Fx4tx1c1goXAo7AUOM%3D" alt="在这里插入图片描述" loading="lazy"/>
在Body请求体，承载复杂 / 大容量 / 结构化数据，是请求的核心载荷。中绑定开始节点传入的image参数。如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d23928ec64a43b88e5e8e46c0c18297~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=UVRlHLs0OWlJYvLIoPIz2pNVc9o%3D" alt="在这里插入图片描述" loading="lazy"/>
TextIn 大模型加速器节点的默认输出变量为 out_text。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba6c97a7cb5f4ee382bafcf38ffdaa2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=dC1NWUz6v5keQrKE16EjKMphXQY%3D" alt="在这里插入图片描述" loading="lazy"/>
在实际接入过程中，作者通过多次尝试并结合官方学习文档发现：
工具节点在参数传递能力上存在限制，无法完全满足当前 OCR 接口的调用需求，尤其是在需要灵活控制 Header、Query 参数以及 二进制的数据格式场景下。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7d60f125f90402982a84a8eb6f0a4a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=IwWMNZ9rY%2FB%2FW9h%2B7Nsr6WCRFSw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f4076e06eaf4d28ac761a8040f92403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=cCc3cwsZFWZPocrYlk8kzXCuTSQ%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe848fbdf9544df7ae6a4f76edb0a49e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=UTLg9Y%2BYysUTKcKXhU6wySKag2Q%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4abfedd9b9a7489bafc42cfc7aec6029~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=5u0n0%2BMP4JspFMOl67x%2F4yBHmxI%3D" alt="在这里插入图片描述" loading="lazy"/>
不过，腾讯元器工作流额外支持「代码节点」，这使得上述问题可以通过自定义代码的方式进行妥善解决，从而绕开工具节点在参数能力上的限制。</p>
<p>因此，我们采用如下方案：</p>
<p>👉 在开始节点（Start）之后新增一个代码节点（Code Node），由该节点直接完成 TextIn OCR API 的调用与结果解析。<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37d819527a6d4164885187be2bfabe4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=CngEsTaEOUlYZqv9eL8A8XrWa6E%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecfd8ea302384c42abcd00f94c420157~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=8w9yPEieuKfFJFjc3RSmhRRBcSE%3D" alt="在这里插入图片描述" loading="lazy"/>
根据 TextIn 官方开发文档，在代码节点中编写完整的 OCR 调用逻辑，包括：</p>
<ul>
<li>
<p>请求 Header 中的 x-ti-app-id 与 x-ti-secret-code</p>
</li>
<li>
<p>Query 参数的动态拼装</p>
</li>
<li>
<p>请求 Body 直接传入图片 URL</p>
</li>
<li>
<p>返回结果强制解析为 JSON 对象
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b64cbd464c6433f9b9fadc22b209ab8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=nH55PB78IFrhy6phKl9oUMMOPyQ%3D" alt="在这里插入图片描述" loading="lazy"/>
调用代码如下</p>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>


<span class="hljs-keyword">class</span> <span class="hljs-title class_">OCRClient</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, app_id: <span class="hljs-built_in">str</span>, secret_code: <span class="hljs-built_in">str</span></span>):
        self.app_id = app_id
        self.secret_code = secret_code

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">recognize</span>(<span class="hljs-params">self, image_url: <span class="hljs-built_in">str</span>, options: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        headers = {
            <span class="hljs-string">"x-ti-app-id"</span>: self.app_id,
            <span class="hljs-string">"x-ti-secret-code"</span>: self.secret_code,
            <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"text/plain"</span>
        }

        params = {k: <span class="hljs-built_in">str</span>(v) <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> options.items()}

        resp = requests.post(
            <span class="hljs-string">"https://api.textin.com/ai/service/v1/pdf_to_markdown"</span>,
            headers=headers,
            params=params,
            data=image_url
        )

        resp.raise_for_status()

        <span class="hljs-comment"># ⚠️ 这里强制转成 JSON 对象</span>
        <span class="hljs-keyword">return</span> resp.json()


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>(<span class="hljs-params">input_data: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
    <span class="hljs-string">"""
    节点主函数
    输入：
    {
        "image": "https://xxx.png"
    }

    输出（JSON 对象）：
    {
        "success": true,
        "result": {...}
    }
    """</span>

    image = input_data.get(<span class="hljs-string">"image"</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> image:
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"error"</span>: <span class="hljs-string">"image 参数缺失"</span>
        }

    <span class="hljs-keyword">try</span>:
        result = client.recognize(
            image_url=image,
 
        )

        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">"result"</span>: result
        }

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"success"</span>: <span class="hljs-literal">False</span>,
            <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)
        }


</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7db24f141ce74dfe803f2f4fa1180cc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ZYqI%2FcAYE8gRldjP%2FYK4cYgz3fc%3D" alt="在这里插入图片描述" loading="lazy"/>
在代码节点中，对外暴露的输入变量命名为 image，用于接收上一节点传入的图片 URL。</p>
<p>完成配置后，可以通过 单点调试 功能快速验证节点运行效果。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ae32097a5fc43fe97f5db38a2346e88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=iFE92qUH36L%2BVZJHUymHIAlLOUk%3D" alt="在这里插入图片描述" loading="lazy"/>
调试过程中输入的测试图像如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecffadf6619f4ff689ead82734f1f77d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=vW%2FhAUpI5LPuuHN%2BDw83eJO0cU8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6115199c5a014032a82f7646b595e005~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=LLUdLGCYzLRVUGx4%2F5K5e5B251Q%3D" alt="在这里插入图片描述" loading="lazy"/>
代码节点执行成功后，返回的 TextIn 大模型加速器 OCR 结果如下：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31d4baad7f064905a779b6c7276453f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=Wrcy5NReyM61d0A92dz1BLkYJNY%3D" alt="在这里插入图片描述" loading="lazy"/>
此时可以发现：
如果输出变量仍然使用默认的 out_text，将无法正确捕获返回结果。</p>
<p>解决方式是：</p>
<blockquote>
<p>👉 将代码节点的输出变量显式设置为 data，即可完整接收 JSON 结构的 OCR 解析结果。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4ed50667fab48bb9870895a8831bcc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=kUCKn45wVzuaCw%2B8OMLoQH3dFJU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc162f267dd64bd4a8da55c4facda33d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=hPcg2vEKV3l2E7rOb6JkQGVFmek%3D" alt="在这里插入图片描述" loading="lazy"/>
整体调试也没有任何问题，到此成绩单解析能力节点配置完毕。下面可接入分析大模型。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60f78893063e4d59b77e19d47fe81896~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=lXVaw2boneTXdSAZi1xuxsUZDww%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e82f408d7bc04d6c89d703dc965317d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=eEA6YvmxeNunRN%2F0aI96w5fzLkk%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-17">5.3 成绩分析与规则计算节点设计</h3>
<p>在获取结构化成绩数据后，智能体进入 <strong>成绩分析与统计计算阶段</strong>。</p>
<p>该阶段采用 <strong>规则计算 + 大模型解释</strong> 的方式：</p>
<ul>
<li>
<p>数据处理节点负责：</p>
<ul>
<li>平均分、最高分、最低分计算</li>
<li>学科均衡度与偏科识别</li>
<li>成绩趋势与波动检测</li>
</ul>
</li>
<li>
<p>压力感知型心理陪伴节点负责：</p>
<ul>
<li>对统计结果进行自然语言总结</li>
<li>将数据结论转化为“学生/教师听得懂的话”</li>
<li>对学生成绩进行压力分析</li>
<li>提出成绩提升计划</li>
<li>对学生进行心理疏导，避免压力过大</li>
</ul>
</li>
</ul>
<p>在腾讯元器中，这一阶段通常以 <strong>数据处理节点 + 压力感知型心理陪伴节点节点</strong> 的组合方式实现。</p>
<h3 data-id="heading-18">5.4 数据处理节点（混元大模型）</h3>
<p>在完成 TextIn 大模型加速器 OCR 解析后，我们将引入 混元大模型进行专业的数据处理分析。
数据处理节点主要功能包括：</p>
<blockquote>
<p>平均分、最高分、最低分计算
学科均衡度评估与偏科识别
成绩趋势及分数波动检测</p>
</blockquote>
<p>在 TextIn OCR 代码节点之后，新增 混元大模型数据处理节点。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06ec8f22973b40bfbc6457ab46e13497~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=iYAIbPGKtbWwQmjNtQpBlJYnvyo%3D" alt="在这里插入图片描述" loading="lazy"/>
选择擅长数学计算的 混元 2.0 模型 以保证数据处理的精度与专业性。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa2e32d4c742475cb4fda4ea97a17a3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=cOpdgcggoc%2FYPib4kBe8A5fFfQc%3D" alt="在这里插入图片描述" loading="lazy"/>
将前节点输出的 OCR 数据绑定为输入变量，以便混元模型直接接收成绩单数据。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5595964f2dc14ecc98a6035346b3f0ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=4KbigPsbFdJaOgHuEUr3m5U5jKA%3D" alt="在这里插入图片描述" loading="lazy"/>
为确保混元模型能够高效完成数据处理，设计了如下提示词：</p>
<pre><code class="hljs language-bash" lang="bash">根据ocrinput
的成绩单识别结果，计算平均分、最高分和最低分；分析各学科分数的均衡度并识别是否存在偏科现象；同时检测成绩随时间的变化趋势及分数波动情况。请明确说明成绩数据是否包含时间信息，以便进行趋势与波动分析。若ocrinput
中包含科目名称，请确保识别准确以支持学科均衡度分析。

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/732812c32ac24f048cde14b6ae899c9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=zKUGCc6UYgBP0C6sjefjV3D8St8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>完成 数据处理节点配置后，开始进行调试验证：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15d9103388a846269b1e10b1b2cae2a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=YmAyRZaQFrxyF1ENuaG9Qzp4Pow%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>输入测试数据：张晨的高三考试成绩单。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c34c240f9e8e4381ab5cc99bc649264e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=DBMrSFusaoVNOZxafwiF27cDkfI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>运行调试结果如下
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efc75a1f377846d791d21b2df4569445~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=zpeV3VsNlIWGh5IuqvVI6xTVjpQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>可以看到数据处理节点
对</p>
<ul>
<li>平均分、最高分、最低分计算</li>
<li>学科均衡度与偏科识别</li>
<li>成绩趋势与波动检测
的分析十分专业
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4057f78c33744718b7d0d935e1dab92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=7IsOHGnKz4pCx1SGsPYsCzDSoPM%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ul>
<p>混元大模型在本次数据处理任务中表现非常出色。它不仅能够准确计算平均分、最高分和最低分，而且能够深入分析各科分数的分布特征，量化学科均衡度，并给出科学的偏科判断。
模型对理科与文科的区分、标准差与极差的计算以及偏科结论的逻辑推理都非常严谨，分析条理清晰，结果专业可信。通过混元大模型的处理，原本散乱的成绩数据被系统化、结构化地呈现出来，让人一目了然，极大地提升了成绩分析的效率和精准度，可谓是一次高质量的智能化数据分析体验。</p>
<h3 data-id="heading-19">5.5 压力感知型心理陪伴节点（混元大模型）</h3>
<p>在数据处理节点（混元大模型）后添加压力感知型心理陪伴节点
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1826a6d74d484e1db46b310988a81046~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=pWRUwNgd1AWQt8YwFkU6QQ0gWbo%3D" alt="在这里插入图片描述" loading="lazy"/>
模型选择混元大模型T1版</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4e171c44019499883b3603ea9f8dff1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ZDFXEfLV5Z9CWhIPAg8Pv2v19qc%3D" alt="在这里插入图片描述" loading="lazy"/>
输入变量为数据处理节点（混元大模型）的处理内容
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bec7ee3d7f9464bbb2c0d602417c677~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=2hJIqqTYwGO6t4fvSy7DnvA%2BjK8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>提示词如下</p>
<pre><code class="hljs language-bash" lang="bash">现在是学生向你发送了他的成绩单解析结果，你需要基于此做压力感知型心理陪伴节点，重点安慰和鼓励学生。根据数据处理节点_混元大模型对input
中的成绩单进行的解析，以及结合学生输入的问题q
，完成以下任务：  
* 用清晰、准确且通俗易懂的自然语言总结成绩统计结果；  
* 将数据分析结论转化为学生都容易理解的表达；  
* 针对学生各科成绩，分析可能面临的学业压力及具体成因；  
* 结合成绩与压力情况，给出切实可行的成绩提升建议和可操作的学习计划；  
* 重点关注学生心理状态，提供温暖的心理疏导建议，帮助其缓解压力、保持积极心态。

</code></pre>
<p>开始调试</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/971a123eb5284146a2a4c9288888844f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ZN%2FnSYHSH43ZD2p0sUSCpx26Lic%3D" alt="在这里插入图片描述" loading="lazy"/>
可以看到压力感知型心理陪伴节点主要处理了</p>
<ul>
<li>对统计结果进行自然语言总结</li>
<li>将数据结论转化为“学生/教师听得懂的话”</li>
<li>对学生成绩进行压力分析</li>
<li>提出成绩提升计划</li>
<li>对学生进行心理疏导，避免压力过大</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e8735dbbdb640e39290db175c582ff2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=2NK0n5aCjH93T72Jtw3k6a1fPEg%3D" alt="在这里插入图片描述" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9bf72fb21a9c46dd88dfef6465fa5a2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=cXpHpyYGwtfT0UBguKpSVMRQeM0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbe9aa6b37d94a7d9af12dbaab1b731f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=GXKhkBe%2F5DO50314f4nsrCtBAkY%3D" alt="在这里插入图片描述" loading="lazy"/>
混元大模型在本次张晨同学成绩分析与成长建议生成中表现十分出色。它不仅能够全面整合各科成绩数据，精准计算总分、平均分、最高分、最低分和标准差，还能智能识别学科均衡性与偏科情况，为理科和文科的优势与薄弱点提供清晰量化依据。更难得的是，模型能够结合成绩特点生成专业、可操作的学习策略与心理疏导建议，涵盖时间分配、学习方法优化及信心建设等多个维度，既兼顾学生实际学习情况，也符合教育心理学指导原则。整体分析条理清晰、逻辑严谨、内容专业可信，堪称一次高质量的智能化学业分析实践成果。</p>
<h2 data-id="heading-20">六. 智能体调试与发布</h2>
<p>完成工作流的编写与各节点调试后，下一步是在 工作流管理中启用新创建的工作流，使其可以对外提供服务。</p>
<p>启用工作流，在工作流管理界面找到刚刚创建的工作流，点击 启用/激活 按钮，使其进入可调用状态。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80d92939aa5f4772950951dd99b37338~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=I4%2FyxUS89xIMaFMqRndcLbjxjNE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在智能体界面中发送测试数据（如学生成绩单），观察工作流的响应结果。
成功启用后，智能体会按照设计逻辑自动处理输入数据，并返回分析报告。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c601e02b53144b39aa2d6a1c607a49c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=8Zq4QaGggQLPdKT2diNaJt%2Foskc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>检查智能体返回的分析结果是否完整、准确，包括成绩统计、学科均衡度、偏科分析以及成长建议等内容。
成功返回结果后，即表明整个工作流已正常运行，可正式投入使用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3f2fadaa9fa44a5bcb95cbc5c81e22d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=6p%2BN%2BR7eAFUddgaKmOngZULQemQ%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a87f548c0c34c1b8336213bb87a03e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=%2FSsj%2BTFQkV3KPk1akXO42nupi%2Fo%3D" alt="在这里插入图片描述" loading="lazy"/>
调试确认工作流运行正常后，在智能体页面找到对应智能体，点击 “发布” 按钮。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80fee541eabb4cc98d33575da45b57c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=4xuqGn42mLrxNooY%2FUXJOYLJyqM%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>确认无误后点击 确认发布。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94a9e866f349449a9981afd4c2f642d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=xezFrVCSMo9aL8OYLLIYVFpZfiM%3D" alt="在这里插入图片描述" loading="lazy"/>
系统提示 应用发布成功，表示智能体已正式上线并可对外调用。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/737c3a7969a347fd86ab546b124af839~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=ciUnkO%2FXWIxOWCbm7e96zSGZSIA%3D" alt="在这里插入图片描述" loading="lazy"/>
可通过分享链接或二维码访问智能体，方便学生、教师或其他用户使用。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc1f2f8e6839477bad609ddc0adee451~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=GXlDFEVmJK%2Fz9rc5zcPeNP%2Fgb%2Fk%3D" alt="在这里插入图片描述" loading="lazy"/>
发布成功后，智能体会在 “我的智能体” 页面中显示，可随时管理、更新或查看运行情况。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/163ee76ebb214d009125973cd2fbbe19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=q2t8ZYj%2BEMdvs0iH9izqqBb30zc%3D" alt="在这里插入图片描述" loading="lazy"/>
访问URL即可愉快的使用智能体了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a361fbd29f24dfd9e7052b893bcec26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZUpvdXJuZXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767362992&amp;x-signature=pXkBQtOcFzI4ZS7n0CE%2BGXvrMT8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-21">七.心得与总结</h2>
<p>通过本次“学业成绩分析压力感知型 AI 心理陪伴智能体”的构建，我深刻体会到教育数据智能化与心理关怀结合的巨大价值。项目中，腾讯元器提供了完整的智能体能力编排与上下文管理，TextIn 大模型加速器实现了非结构化成绩单的高精度解析，而混元大模型则承担数据处理、趋势分析与压力感知，实现了从数据到自然语言陪伴的闭环。三者协同不仅让系统能“会算分”，更能“懂学生”，真正做到学业分析与情绪疏导双重服务，为智慧教育场景提供了可落地的实践经验。</p>
<p>在工作流设计和节点调试中，我体会到职责拆分与灵活调用的重要性。将流程拆解为 OCR/结构化、数据处理、压力感知与心理陪伴等明确节点，既利于调试，也便于后续迭代优化；通过代码节点灵活调用 TextIn API，避免了工具节点在大容量或复杂参数传递上的限制。此外，多角色输出逻辑的隔离让学生端与教师端呈现差异化信息，提高了系统可用性与安全性。整体实践让我认识到，教育 AI 不仅要精准分析数据，更要考虑心理关怀与可解释性，这也是未来智能教育落地的关键方向。</p>
<p>这次用腾讯元器构建“学业成绩分析压力感知型 AI 心理陪伴”智能体，整体体验非常顺畅，也超出了预期。几个印象深刻的点：</p>
<ul>
<li>上手快：界面化操作为主，节点拖拽和工作流配置直观，即便非技术人员也能快速上手；</li>
<li>调试高效：代码节点、提示词编辑器和工作流调试器支持实时预览，定位问题快，减少了重复发布的麻烦；</li>
<li>多能力集成：OCR、数据分析、心理陪伴等模块协同，数据流与逻辑清晰，节点之间调用顺畅；</li>
<li>发布便利：支持多端输出，学生端和教师端可差异化呈现，无需自行处理对接问题。</li>
</ul>
<p>总体来说，腾讯元器不仅适合教育场景的智能体开发，也为类似企业级应用提供了可落地、易扩展的实践方案。</p>
<p>腾讯元器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuanqi.tencent.com%2F" target="_blank" title="https://yuanqi.tencent.com/" ref="nofollow noopener noreferrer">yuanqi.tencent.com/</a></p>
<p>我的智能体链接：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuanqi.tencent.com%2Fwebim%2F%23%2Fchat%2FTFJDBz%3Fappid%3D2004433656162151424" target="_blank" title="https://yuanqi.tencent.com/webim/#/chat/TFJDBz?appid=2004433656162151424" ref="nofollow noopener noreferrer">yuanqi.tencent.com/webim/#/cha…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Excel瑟瑟发抖？Skywork Sheets 2.0把表格直接变成了智能报告]]></title>    <link>https://juejin.cn/post/7588086766235648038</link>    <guid>https://juejin.cn/post/7588086766235648038</guid>    <pubDate>2025-12-26T14:28:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588086766235648038" data-draft-id="7587997893987975195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Excel瑟瑟发抖？Skywork Sheets 2.0把表格直接变成了智能报告"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-26T14:28:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Excel瑟瑟发抖？Skywork Sheets 2.0把表格直接变成了智能报告
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T14:28:24.000Z" title="Fri Dec 26 2025 14:28:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>老实说，在办公软件这个圈子里，我们已经很久没有看到真正让人眼前一亮的东西了。大多数时候，所谓的“AI升级”不过是在侧边栏加个聊天框，这就好比给马车装了个收音机，并没有改变跑得慢的事实。</p>
<p>但昆仑万维刚刚端上来的这个Skywork Sheets 2.0，味道有点不一样。</p>
<p>如果不跟你绕弯子，直接说结论：这东西试图干掉的不是Excel，而是“从做表到写汇报”中间那个最折磨人的过程。它于2025年12月25日正式上线，核心就干了一件事——打破了电子表格和分析报告之间的次元壁。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2FiShot_2025-12-26_22.19.36-1024x504.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/iShot_2025-12-26_22.19.36-1024x504.png" ref="nofollow noopener noreferrer"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8c598621c1e472b9420d49b1150fa2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767364104&amp;x-signature=XaeQgTi3aDsfA2HM0vPjRGuV%2BNI%3D" alt="iShot_2025-12-26_22.19.36" loading="lazy"/></a></p>
<p><strong>从“仓库”到“加工厂”的思维转变</strong></p>
<p>我们以前用表格软件，本质上是在用一个“数据仓库”。你把数据填进去，甚至还得自己写公式去清洗、去计算，最后盯着那一堆数字发呆：这玩意儿到底说明了什么？然后你还得打开Word或PPT，把刚才的结论敲进去。</p>
<p>Skywork Sheets 2.0把这个逻辑倒过来了。官方管这叫“输入即分析，数据即成果”。</p>
<p>简单来说，它的工作流非常“傻瓜”：</p>
<p>你只需要把那一堆乱七八糟的原始数据——不管是本地的CSV、Excel文件，还是直接从网页上复制粘贴的一坨文本——扔进它的对话框。接下来的事情，就有点像把衣服扔进全自动洗衣机了。</p>
<p>它底层的“天工超级智能体”会立刻接管，利用Deep Research（深度研究）技术，自己去理解这堆数据是干嘛的。清洗脏数据、归纳汇总、识别趋势，这些脏活累活它全包了。</p>
<p><strong>不只是画图，是直接给你交作业</strong></p>
<p>市面上能自动画图的AI不少，但Skywork Sheets 2.0最狠的一点在于它的“双模导出”。</p>
<p>当你喝口水的功夫，它不光给你吐出一份清洗干净、排版整齐、甚至可以像Excel一样随意手动修改的表格，同时还会给你一份图文并茂的分析报告。注意，是完整的报告，支持PDF或Word格式，里面有结论、有趋势分析、有建议。</p>
<p>这就很离谱。以前我们要么得到一个冷冰冰的表格，要么得到一段虚无缥缈的AI废话。现在它直接把这两者捏在一起，形成了一个闭环。</p>
<p><strong>懂行的人才懂的细节优化</strong></p>
<p>作为一个长期被各种“人工智障”折磨的用户，我有两个痛点在这个版本里被治愈了。</p>
<p>第一是“改不动”。以前很多AI生成的表格是一张图片或者死数据，想微调个数值比登天还难。Skywork Sheets 2.0保留了传统表格的尊严，支持你像操作Excel一样去修改单元格、排序筛选。你改了数据，AI还能接着你的思路继续优化，这就很尊重人类的控制欲。</p>
<p>第二是“慢与糙的权衡”。有时候我赶时间，不需要那么深度的分析；有时候我又要写深度研报。它搞了个分档，提供“极速模式”和“深度模式”。极速模式把生成时间砍了一半，适合快速看数；深度模式则会进行多轮意图澄清和深度搜索，适合憋大招。</p>
<p><strong>写在最后</strong></p>
<p>在学术界和投资圈，已经有人喊它是“万能AI员工”了。我觉得这个称呼还算中肯。</p>
<p>Skywork Sheets 2.0并不是一个独立的软件孤岛，它是天工超级智能体生态里的一块拼图。它不再让你盯着屏幕上的网格线发愁，而是试图让你直接面对决策结果。</p>
<p>对于我们这些打工人来说，如果工具能把数据整理、分析、画图、写报告这一条龙服务全干了，那我们要做的，可能真的只剩下“做决定”这一件事了。</p>
<p>这或许才是AI办公该有的样子。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>